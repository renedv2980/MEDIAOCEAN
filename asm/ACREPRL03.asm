*          DATA SET ACREPRL03  AT LEVEL 090 AS OF 01/25/21                      
*PHASE ACRL03B                                                                  
*INCLUDE HEXIN                                                                  
*INCLUDE DATTIM                                                                 
*INCLUDE SCANNER                                                                
*                                                                               
* PID  LVl DATE    COMMENTS                                                     
* ---------------------------------                                             
* SMAN 033 10NOV11 PR000122 Estimate Phase 1                                    
* SMAN 034 11NOV11 BR45442L Fix to CFILTER                                      
* YNGX 035 14NOV11 BR18835D Fix to TSDAY and TSDTE keywords                     
* SMAN 036 16DEC11 PR002242 UK/US merge                                         
* SMAN 037 31JAN11 PR002625 Estimate currency keywords                          
* SMAN             Fixes from DCUR                                              
* JFOS 038 13DEC12 <PR003402> Estimated time keywords/filter                    
*                             FCON security on old est hours keywords           
*                                                                               
***** RE-LEVELLED ON MERGE WITH US - LVL STAMPS ABOVE OUT OF SYNC *****         
* JFOS 067 06SEP13 <DSPCA111>New 'Br'Ocean Invoices Status' filter              
* JFOS 067 22JAN14 <DSPCA528>Send download reports to BDE via MQ                
* JFOS 067 02APR14 <DSPCA273>Use Alt date to filter Br'O Estimates              
* JFOS     16APR14 <DSPCA233>Don't use TSAR if v.long recs (eg. NARALL)         
* YNGX 067 23SEP14 <PCA01185> Send download reports to USS server               
* YNGX 067 30OCT14 <PCA01322> NEW KEYWORDS AGEFAG and REFSER                    
* YNGX 067 02DEC14 PCA01326 keywords OG & OGN for other report types            
* MPEN 067 29JAN15 <PCA01536> Fix bug in lvl 70                                 
* YNGX 067 27JAN15 PCA01501 NEW KEYWORDS BGA, BGM, BGACC, COLIF, CATNAM         
* JFOS 067 11FEB15 <PCA01569> EXR - set COLXRATE to skip test for $$            
*                             And fix ancient bugs reported by US               
* JFOS 068 02NOV15            MERGED WITH US VERION                             
* YNGX 069 06JAN16 <FLX00297> Reinstate reading estimate on job                 
* YNGX 070 15MAR16 <PCA02359> MERGED WITH US VERION                             
* JSHA 071 20Apr16 <ITMF-6897>Dump in SETACT due to an empty list LIDEL         
* GHOA 073 25MAY17 SPEC-13111 backout Wasserman code and fix drill-down         
* GHOA 076 04MAY18 SPEC-23686 fix YTD keywords not working in G/L               
* GHOA 077 06JUL18 restore code before level 76, +YR is not working             
* GHOA 078 31JUL18 SPEC-26412 EDIHUB VIA MQ MESSAGING                           
* GHOA 079 07SEP18 SPEC-27424 fix bug when Sec Agy > spaces                     
* GHOA 083 12APR19 SPEC-34344 fix dump when request for line manager            
*                             and all of time for person scribe                 
* JSAY 084 09APR19 SPEC-33734 Ability to request a person scribe report         
*                             based on timesheet approved date.                 
* JSAY 084 09APR19 SPEC-33735 Ability to request a person scribe report         
*                             based on timesheet submitted date.                
* GHOA 085 13FEB20 SPEC-33366 Global format @DCHEK for CSI Billing              
*                             added format to ACSCRFMTS                         
* VGUP 086 30MAR20 SPEC-33366 Relink for format @DCHEK for CSI Billing          
*                             added format to ACSCRFMTS                         
* VGUP 087 02APR19 SPEC-43802 Relink due to new ACREPRLWRK                      
* GHOA 088 30APR20 SPEC-28298 New Setup: Cairnes Oniel for CSI                  
*                             change format @DCHEK in ACSCRFMTS                 
* GHOA 089 23Jul20 SPEC-46231 Relink due to new ACREPRLWRK                      
* GHOA 090 25Jan21 SPEC-53306 Increase buffer using MAXSRBQ                     
*                                                                               
         TITLE 'Initialize Scribe generator formats'                            
ACRL03   CSECT                                                                  
*=====================================================================*         
*  READ FORMAT RECORD                                                 *         
*=====================================================================*         
         SPACE 1                                                                
         PRINT NOGEN                                                            
         USING ACWORKD,RC                                                       
         USING ACRLD,RA                                                         
         USING ACRL2D,R7                                                        
FBUILD   DS    0D                                                               
         NMOD1 0,**FBLD**,R9,R8                                                 
         L     RC,RLBASEC                                                       
         L     R7,AACRL2D                                                       
         CLI   MODE,RUNFRST                                                     
         BNE   FBLD010                                                          
         BRAS  RE,FMTINIT                                                       
         B     FBLD920                                                          
         EJECT                                                                  
***********************************************************************         
*  REQUEST FIRST MODE, INITIALIZE AND BUILD FORMAT RECORD             *         
***********************************************************************         
         SPACE 1                                                                
         USING RESRECD,R2                                                       
         USING FMTRECD,R5                                                       
FBLD010  XC    SRTKEYLN(SRTFLDQ),SRTKEYLN                                       
         XC    JOBFLDH,JOBFLDH                                                  
         XC    JOBFLD,JOBFLD                                                    
         MVI   SORTSW,0            SET SORTING INDICATORS                       
         MVI   TSARSW,0            SET TSAR    INDICATORS                       
         MVI   RANKSW,0            SET RANKING INDICATORS                       
         MVI   GHISIND,0           Reset                                        
         XC    BFLKEYLN,BFLKEYLN                                                
** VIA Format                                                                   
         MVI   FMTLEVMX,0                                                       
         MVI   LEVKYWD,0           RESET TO ZERO                                
**                                                                              
         MVI   FCJOBBER,0          RESET TO ZERO                                
         MVI   ESTIND,0            RESET ESTIMATE READ INDICATOR                
         MVI   AGECOL#,0           NO PRODUCTION AGEING COLUMNS FOR NOW         
         MVI   THRSW,0             RESET                                        
         MVI   DWNOPT1,0           SET NOT TO DOWNLOAD                          
*&&UK                                                                           
         MVI   DWNOPT2,0           SET NOT TO DOWNLOAD                          
*&&                                                                             
*&&US                                                                           
         TM    DWNOPT2,DWNDSN      DON'T CLEAR THE DSN BIT, IF ON               
         BZ    FBLD010A                                                         
         MVI   DWNOPT2,DWNDSN      ONLY LEAVE THAT ON                           
         B     FBLD010B                                                         
FBLD010A MVI   DWNOPT2,0           SET NOT TO DOWNLOAD                          
*&&                                                                             
FBLD010B MVI   XCULFLAG,NO                                                      
         MVI   FCGTFILT,NO                                                      
         MVI   OFFSEC,NO                                                        
         MVI   FMTNUM,1            SET TO ONE                                   
         XC    FORMAT#,FORMAT#     SET TO ZERO                                  
         MVI   RECAPSW,0                                                        
         MVI   RECREAD1,0                                                       
         MVI   RECREAD2,0                                                       
         MVI   RECREAD3,0                                                       
         MVI   DWNFLDD,C' '        FIELD         SEPERATOR                      
         MVI   DWNTXTD,C'"'        TEXT          DELIMITOR                      
         MVI   DWNEOLD,X'5E'       END OF LINE   DELIMITOR                      
         MVI   DWNEORD,C':'        END OF REPORT DELIMITOR                      
*&&US                                                                           
         TM    REQIND,REQAUTH                                                   
         BZ    FBLD015                                                          
         GOTO1 =A(SETAUTH)                                                      
*&&                                                                             
         USING ACMD,R3                                                          
FBLD015  CLI   RLLANG,YES                                                       
         BE    FBLD020                                                          
         MVI   RLLANG,YES                                                       
         GOTO1 =A(LANGCONV)                                                     
*                                                                               
FBLD020  XC    RQACTSTR,RQACTSTR   CLEAR ACTIVITY START DATE                    
         MVC   RQACTEND,=X'FFFFFF' CLEAR ACTIVITY END   DATE                    
         XC    RACTSTR,RACTSTR                                                  
         L     R3,AMONACC                                                       
         OC    ACMASTR,ACMASTR                                                  
         BZ    FBLD024                                                          
         MVC   RACTSTR,ACMASTR     Save off activity start                      
         GOTO1 DATCON,DMCB,(2,ACMASTR),(1,RQACTSTR)                             
*                                                                               
FBLD024  CLI   QPROG,RECEIVABLE                                                 
         BE    FBLD028                                                          
         CLI   QPROG,PAYABLES                                                   
         BNE   FBLD030                                                          
         MVC   FCWCULOR,=C'SJ'     ALWAYS USE SJ WORKCODES                      
                                                                                
FBLD028  XC    ACMASTR,ACMASTR     Clear so ACMASTER doesn't filter             
         XC    ACMMSTR,ACMMSTR     MOA start date                               
*                                                                               
FBLD030  CLC   ACMAEND,=X'FFFFFF'                                               
         BE    FBLD034                                                          
         GOTO1 DATCON,DMCB,(2,ACMASTR),(1,RQACTEND)                             
         DROP  R3                                                               
*                                                                               
         USING RCPELD,RE                                                        
FBLD034  L     RE,=A(FMTTAB)                                                    
         MVC   RCPCODE,QAPPL       GET FORMAT FROM REQUEST CARD                 
         OI    RCPOPT1,RCPPROF     DEFAULT MAIN PROF, SINCE IT IS MAIN          
         AHI   RE,RCPLNQ                                                        
         MVI   0(RE),EOT           SET END                                      
         DROP  RE                                                               
                                                                                
         USING CPYELD,RE                                                        
         L     RE,ADCMPEL                                                       
*&&UK*&& MVC   CURCREQ,CPYCURR     DEFAULT CURRENCY CODE                        
*&&UK*&& CLI   QCURRY,ACQC2ND      2ND CURRECNY CODE                            
*&&UK*&& BNE   *+10                                                             
*&&UK*&& MVC   CURCREQ,CPYCURRS    USE 2ND CURRENCY CODE                        
         CLI   QPROG,GENERAL                                                    
         BNE   FBLD038                                                          
         CLC   QAPPL(8),=CL8'FPL1'                                              
         BE    FBLD038                                                          
         CLC   QAPPL(8),=CL8'FPL3'                                              
         BE    FBLD038                                                          
         CLI   CPYLN,CPYLN4Q                                                    
         BL    FBLD038                                                          
         OC    CPYGLMOA,CPYGLMOA                                                
         BZ    FBLD038                                                          
         OI    FCIND,FCNEWGL       Set to be on new GL                          
         MVC   GLMOS,CPYGLMOA                                                   
         CLI   NEWOFF,YES                                                       
         BNE   FBLD038                                                          
         MVI   FCRDOFA,YES                                                      
         DROP  RE                                                               
                                                                                
FBLD038  MVI   POSTLVL,POSTACC     POST ACCOUNT LEVEL                           
         MVI   FMTPONCE,FMTPON     Set on as default                            
         MVC   PIDCODE,SPACES                                                   
         MVI   RADPRTSZ,L'ADRADD1  ROW  ADDRESS   PRINT SIZE                    
         MVI   DWNROWPS,36         DOWN-LOAD ROW  PRINT SIZE                    
*                                                                               
         CLI   QPROG,PNL                                                        
         BNE   FBLD040                                                          
         CLI   QMTHD,C' '                                                       
         BNE   *+8                                                              
         MVI   QMTHD,C'1'          DEFAULT TO METHOD 1                          
*                                                                               
FBLD040  CLI   QPROG,MANPOWER                                                   
         BNE   FBLD050                                                          
         MVC   FCWCULOR,=C'SJ'     ALWAYS USE SJ WORKCODES                      
         MVI   FCPERSEC,FCPEREMP   OFFICE SECURITY BY EMPLOYEE(DEFAULT)         
         CLI   QMTHD,C' '                                                       
         BNE   *+8                                                              
         MVI   QMTHD,C'1'          DEFAULT TO METHOD 1                          
         CLI   QMTHD,C'A'                                                       
         BNH   FBLD050                                                          
         MVC   BYTE,QMTHD                                                       
         NI    BYTE,TURNOFF-X'F0'                                               
         SR    RF,RF                                                            
         IC    RF,BYTE                                                          
         BCTR  RF,0                                                             
         LA    RE,METHODS(RF)                                                   
         MVC   0(1,RE),QMTHD                                                    
*                                                                               
FBLD050  CLI   QOPT7,C' '                                                       
         BNH   *+8                 SET UP DEFAULTS                              
         OI    ESTIND,ESTJSTAT     NEED JOB STATUS                              
*                                                                               
         TM    DDLNKIND,DDLNKON+DDLNKTST                                        
         BZ    FBLD060                                                          
         OI    DWNOPT1,DWNGO+DWNROWS+DWNNODEC+DWNLEADM                          
         NI    DDLNKIND,TURNOFF-(DDLNKGBL+DDLNKQKR)                             
                                                                                
         USING RPFELD,R2                                                        
         L     R2,AIO2                                                          
         MVI   ELCODE,RPFELQ       X'C4' Profile element                        
         BAS   RE,GETEL                                                         
         BNE   FBLD052                                                          
         CLI   RPFLN,RPFLN2Q                                                    
         BL    FBLD052                                                          
         TM    RPFXMIT,RPFXQREP                                                 
         BZ    FBLD052                                                          
         OI    DDLNKIND,DDLNKQKR   Quick reports                                
                                                                                
FBLD052  CLI   RCRERUN,C'G'                                                     
         BNE   *+8                                                              
         OI    DDLNKIND,DDLNKGBL                                                
                                                                                
         USING ACMD,R4                                                          
         USING LP_D,R6                                                          
         L     R4,AMONACC                                                       
         CLI   QDRAFT,C' '         Draft already set?                           
         BH    FBLD052A                                                         
         NI    ACMINDS2,X'FF'-(ACMIDRAY+ACMIDRAN)                               
         TM    RPFOPT1,RPFODRFT    Draft only?                                  
         BZ    *+12                                                             
         OI    ACMINDS2,ACMIDRAY                                                
         B     FBLD052A                                                         
         OI    ACMINDS2,ACMIDRAN                                                
         TM    RPFOPT1,RPFIDRFT    Include draft?                               
         BZ    FBLD052A                                                         
         OI    ACMINDS2,ACMIDRAY                                                
*                                                                               
FBLD052A DS    0H                                                               
*&&US                                                                           
         CLI   QXJOB,C' '          Expense job option already set?              
         BH    FBLD053                                                          
         NI    ACMINDS2,X'FF'-(ACMIXJBY+ACMIXJBN)                               
         TM    RPFOPT4,RPFOEXPS    XJobs only?                                  
         BZ    *+12                                                             
         OI    ACMINDS2,ACMIXJBY                                                
         B     FBLD053                                                          
         OI    ACMINDS2,ACMIXJBN                                                
         TM    RPFOPT4,RPFIEXPS    Include Xjobs?                               
         BZ    FBLD053                                                          
         OI    ACMINDS2,ACMIXJBY                                                
*&&                                                                             
FBLD053  L     R6,ACMALP_D         R6=A(LP_D)                                   
         CLI   QOPT3,C'G'          Run as Global report                         
         BE    FBLD055                                                          
         TM    LP_FLAG,LP_FBTCH                                                 
         BZ    FBLD060                                                          
         L     RE,LP_ARUNP                                                      
                                                                                
         USING RUNFACSD,RE                                                      
         ICM   RE,7,RUNPARUN-RUNPARMD(RE)                                       
         BNZ   *+6                                                              
         DC    H'00'                                                            
                                                                                
         USING RUNQD,R3                                                         
         L     R3,RREQUEST                                                      
         CLC   RUNQPASS,=4C'0'     If password <> 0 then not RLP                
         BNE   FBLD060                                                          
         DROP  R3,RE                                                            
                                                                                
FBLD055  OI    DDLNKIND,DDLNKGBL   RLP Global report                            
         DROP  R4,R6                                                            
                                                                                
FBLD060  CLI   QOPT1,C' '              Are we downloading ?                     
         BNH   FBLD085                 No                                       
         MVI   DWNOPT1,DWNGO+DWNHEAD   Default download settings                
*                                                                               
         USING RPFELD,R2                                                        
         L     R2,AIO2                                                          
         MVI   ELCODE,RPFELQ       X'C4' Profile element                        
         BAS   RE,GETEL                                                         
         BNE   FBLD064                                                          
         CLI   RPFLN,RPFLN2Q                                                    
         BL    FBLD064                                                          
         TM    RPFXMIT,RPFXFTP                                                  
         BZ    *+8                                                              
         MVI   QOPT1,FTPDL                                                      
         TM    RPFXMIT,RPFXDSN                                                  
         BZ    *+8                                                              
         MVI   QOPT1,DSNDL                                                      
*&&US                                                                           
         TM    RPFXMIT,RPFXDSDN                                                 
         BZ    *+8                                                              
         OI    DWNOPT3,DWNFDSDN    DSN DOWNLOAD FILE                            
*&&                                                                             
*&&UK                                                                           
         TM    RPFXMIT,RPFXBDE                                                  
         BZ    *+8                                                              
         MVI   QOPT1,BDEDL                                                      
         TM    RPFXMIT,RPFXUSS                                                  
         BZ    *+8                                                              
         MVI   QOPT1,USSDL                                                      
*&&                                                                             
         TM    RPFXMIT2,RPFXEDI                                                 
         BZ    *+8                                                              
         MVI   QOPT1,EDIDL                                                      
*                                                                               
FBLD064  CLI   QOPT1,YES           Regular download ?                           
         BE    FBLD085             Yes                                          
*&&UK                                                                           
         CLI   QOPT1,BDEDL         BDE download                                 
         BNE   FBLD065                                                          
         MVI   DWNOPT1,DWNGO+DWNHEAD                                            
***      MVI   DWNOPT1,DWNGO+DWNCHOP+DWNTXT#                                    
         MVI   DWNOPT3,DWNTBDE                                                  
         B     FBLD070                                                          
*                                                                               
FBLD065  CLI   QOPT1,USSDL         USS download                                 
         BNE   FBLD065A                                                         
         MVI   DWNOPT1,DWNGO+DWNHEAD                                            
         MVI   DWNOPT3,DWNTUSS                                                  
         B     FBLD070                                                          
*&&                                                                             
FBLD065A CLI   QOPT1,EDIDL         EDIHUB download                              
         BNE   FBLD066                                                          
         MVI   DWNOPT1,DWNGO+DWNHEAD                                            
         MVI   DWNOPT3,DWNTEDI                                                  
         B     FBLD070                                                          
*                                                                               
FBLD066  CLI   QOPT1,FTPDL         EDICT (File Transfer Protocal)               
         BNE   FBLD068                                                          
         MVI   DWNOPT1,DWNGO+DWNCHOP+DWNTXT#                                    
         MVI   DWNOPT2,DWNFTP                                                   
         B     FBLD070                                                          
                                                                                
FBLD068  CLI   QOPT1,DSNDL         EDICT (File Transfer Protocal)               
         BNE   FBLD080                                                          
         MVI   DWNOPT1,DWNGO+DWNCHOP+DWNTXT#                                    
         MVI   DWNOPT2,DWNDSN                                                   
*&&US                                                                           
         TM    DWNOPT3,DWNFDSDN    DSN/DWN DOWNLOAD FILE?                       
         BZ    FBLD070                                                          
         MVI   DWNOPT1,DWNGO       TESTING REGULAR DOWNLOAD                     
         TM    RPFDNOPT,RPFDNCOL   NO COLUMN HEADINGS?                          
         BO    *+8                                                              
         OI    DWNOPT1,DWNHEAD                                                  
         TM    RPFDNOPT,RPFDNFXW   FIXED WIDTH FIELDS?                          
         BZ    *+8                                                              
         OI    DWNOPT1,DWNCHOP                                                  
*&&                                                                             
         DROP  R2                                                               
         USING REMOTED,RF                                                       
FBLD070  L     RF,REMOTEC                                                       
         NI    PIXOPT1,TURNOFF-PIXGO    Turn off print queue indexing           
         MVI   REMOTCLS,C'G'                                                    
         MVC   REMOTKEY+2(2),QPROG       CHANGE KEY TO ACTIVATE                 
         MVI   REMOTKEY+1,C'C'                                                  
         GOTO1 =A(SCANALPH),DMCB,(8,QAPPL)                                      
         BNE   FBLD900                                                          
         DROP  RF                                                               
*                                                                               
FBLD080  CLI   QOPT1,YMDDL             SPECIAL FOR BURSON                       
         BNE   *+8                                                              
         OI    DWNOPT1,DWNSPDTE                                                 
*                                                                               
         CLI   QOPT1,TAPEDL            SPECIAL FOR SEARS                        
         BNE   *+12                                                             
         MVI   DWNOPT1,DWNGO+DWNCHOP+DWNTXT#+DWNNODEC+DWNSPDTE                  
         MVI   DWNOPT2,DWN#PAD                                                  
*                                                                               
         CLI   QOPT1,AIUDL         SPECIAL FOR OACO                             
         BNE   *+8                                                              
         MVI   DWNOPT1,DWNGO+DWNCHOP+DWNTXT#+DWNNODEC+DWNSPDTE+DWNLEADM         
*                                                                               
         USING RCPELD,RE                                                        
FBLD085  L     RE,=A(FMTTAB)                                                    
         SR    RF,RF                                                            
         IC    RF,FMTNUM                                                        
         BCTR  RF,0                                                             
         MHI   RF,RCPLNQ                                                        
         AR    RE,RF                                                            
         CLI   0(RE),EOT                                                        
         BE    FBLD300             FINISH UP REST                               
         MVC   FMTCODE,RCPCODE     SET AND GET FORMAT                           
         MVC   FMTRCAP,RCPOPT1                                                  
         MVC   FMTMRGE#,RCPMRGE#                                                
         DROP  RE                                                               
*                                                                               
         L     R2,AIO2                                                          
         GOTO1 GETFORMT,DMCB,(2,FMTCODE)                                        
         BNE   FBLD900                                                          
*                                                                               
         GOTO1 =A(TRNSLATE)        LANGUAGE TRANSLATION                         
         CLI   FMTNUM,1                                                         
         BNE   FBLD090                                                          
         GOTO1 =A(SETCARD)         REQUEST  CARD DATA SET UP                    
*                                                                               
FBLD090  L     R2,AIO2                                                          
         GOTO1 =A(FMTSEC)          Format security                              
         CLI   ERROR#,0            SECURITY ERROR                               
         BNE   FBLD900                                                          
         GOTO1 =A(CKMSGERR)        CHECK  FORMAT FOR ERROR MESSAGES             
         BE    FBLD094             OK, SO NO ERRORS                             
         MVI   ERROR#,13           FORMAT CONTAINS ERROR MESSAGES               
         B     FBLD900                                                          
*                                                                               
FBLD094  XC    FMTKEYLN(FMTFLDQ),FMTKEYLN                                       
         LA    RE,FORMAT#                                                       
         TM    RECAPSW,RECANLYS    Anlysis instead of recaps                    
         BZ    FBLD098             No                                           
         LA    RE,ANLYRPT#         Yes, so count # of anlysis reports           
         MVI   FORMAT#+1,1         Always one in this case                      
                                                                                
FBLD098  LH    RF,0(,RE)           Keep count of number of formats              
         AHI   RF,1                                                             
         STH   RF,0(,RE)                                                        
*                                                                               
         L     R2,AIO2                                                          
         MVI   ELCODE,X'20'        GET REPORT NAME                              
         BAS   RE,GETEL                                                         
         BNE   FBLD100             NO NAME FOUND                                
         SR    R1,R1                                                            
         IC    R1,1(,R2)                                                        
         SHI   R1,3                                                             
         EXMVC R1,FMTNAME,2(R2)    SAVE NAME                                    
*                                                                               
FBLD100  L     R2,AIO2                                                          
         CLI   FMTNUM,1                MAIN FORMAT ?                            
         BNE   FBLD120                 NO SO ALREADY SET UP                     
*                                                                               
         USING RCPELD,R2                                                        
         MVI   ELCODE,RCPELQ       X'C8' RECAP DATA                             
         BAS   RE,GETEL                                                         
         BNE   FBLD112             NO RECAP ELEMENT FOUND                       
         OI    RECAPSW,RECAPON                                                  
         SR    R6,R6               SET TO MAIN REPORT                           
         TM    DDLNKIND,DDLNKON+DDLNKTST                                        
         BZ    FBLD102                                                          
         XI    RECAPSW,RECAPON+RECANLYS                                         
*                                                                               
SAVE     USING RCPELD,RE                                                        
*                                                                               
FBLD102  LA    RE,REQRECAP(R6)     POINT TO SAVED REQUEST INFO                  
         CLI   0(RE),NO            DO WE WISH TO IGNORE THIS RECAP ?            
         BE    FBLD106             YES, FORGET ABOUT IT                         
         LR    RE,R6               SET GROUP OF RECAP REPORTS                   
         MHI   RE,RCPLNQ                                                        
         A     RE,=A(FMTTAB)                                                    
         MVC   SAVE.RCPELD(RCPLNQ),RCPELD                                       
         STC   R6,SAVE.RCPSEQ      RE-SEQUENSE                                  
         TM    RCPOPT1,RCPPROF     FORMAT PROFILE                               
         BZ    *+8                                                              
         OI    RECAPSW,RECAPMIX    SET TO MIXED PROFILES                        
         AHI   RE,RCPLNQ                                                        
         MVI   0(RE),EOT           SET END                                      
         AHI   R6,1                ADD ANOTHER ?                                
*                                                                               
FBLD106  BAS   RE,NEXTEL                                                        
         BE    FBLD102                                                          
         SHI   R6,1                                                             
         BP    FBLD112                  Only realy wanted main format           
         NI    RECAPSW,TURNOFF-RECAPON  Turn off switch                         
         DROP  SAVE                                                             
*                                                                               
FBLD112  GOTO1 =A(SETLDGRS)        Initialize list of ledgers to use            
*                                                                               
         GOTO1 TABINIT                                                          
         CLI   ERROR#,0            ANY ERROR GENERATED                          
         BE    FBLD120                                                          
         MVI   MULTLDG,NO                                                       
         MVI   RCREQREP,YES                                                     
         B     FBLD900                                                          
*                                                                               
FBLD120  L     R2,ROWWRK                                                        
         MVI   0(R2),0             INITIALIZE TO ZERO (FOR NO INPUT)            
         L     R2,HEADWRK                                                       
         MVI   0(R2),0             INITIALIZE TO ZERO (FOR NO INPUT)            
         MVC   DTECOLLN,=AL2(DTECOL-DTED)        INITIALIZE TO 8                
         MVI   FMTDTIDX,((DATEDFT-DATEFMT)/DATELNQ)+1                           
         EJECT                                                                  
***********************************************************************         
*  BUILD COMPONENTS OF FORMAT                                         *         
***********************************************************************         
         SPACE 1                                                                
         USING CPRCNDRD,R3                                                      
         CLI   FMTNUM,1                                                         
         BNE   FBLD130                                                          
         CLI   QPROG,MANPOWER                                                   
         BNE   FBLD130                                                          
         GOTO1 =A(PAYTAB)          Build table of paycodes                      
*&&US*&& GOTO1 =A(TMSSTAT)         Check for time status filter                 
         L     R3,ACNDRBLK                                                      
         MVC   CPRAWRK,CDRBASE     A(Stored calendars)                          
         MVC   CPREXPC,ACNDRWRK    A(Expanded calendar)                         
         MVC   CPRYEARS,ACNDRLST   A(List of calendars processed)               
         TM    BUILT,BUILT1N       Did we already build this ?                  
         BO    FBLD130                                                          
         GOTOR =A(GET1N)           Build list of non-client codes               
         DROP  R3                                                               
*                                                                               
FBLD130  MVI   FMTPUT,HOLD         Initialize                                   
         OI    FMTSW,FMTFRATE      Set saying all rates are hidden              
         CLI   FMTNUM,1                                                         
         BE    *+8                                                              
         BAS   RE,SETFLTS          Set recap filters                            
         GOTOR =A(BLDPROF)         Process general profile                      
         GOTOR ADDICTAT,DMCB,FMTDICT2,WRDBASE,RLWORDS                           
         GOTOR =A(INITDATE)                                                     
*                                                                               
         MVI   CFKIND,0            Cashflow indicator-0 per format              
         BRAS  RE,CBUILD           Process columns                              
         BNE   FBLD900                                                          
*                                                                               
         BAS   RE,BLDROW           Process rows                                 
         BNE   FBLD900                                                          
         TM    POSTCTL,POSTBYDT    Posting by month ?                           
         BZ    FBLD136             No                                           
         TM    RECREAD2,RECALO$    Allocated dollars ?                          
         BZ    FBLD136             No                                           
         OI    FMTFLAG,FMTALO$     Set to post allocated $ by month             
*                                                                               
         USING ACQD,R3                                                          
FBLD136  BAS   RE,BLDHEAD          Process headings                             
         CLI   QPROG,CASH          CASH WRITER ?                                
         BNE   FBLD140             NO,   SKIP                                   
         L     R3,ADQSTACK         REQUEST CARD STACK                           
         CLI   ACQRECON,C' '                                                    
         BNH   FBLD140             USE WHAT EVER IS SET ALREADY                 
         NI    FMTROPT5,TURNOFF-(RPFXBRI+RPFOBRI)                               
         CLI   ACQRECON,YES        WANT RECONCILED PLUS ?                       
         BE    FBLD140             YES                                          
         CLI   ACQRECON,NO         DON'T WANT RECONCILED                        
         BNE   *+8                                                              
         OI    FMTROPT5,RPFXBRI    EXCLUDE RECONCILED ITEMS                     
         CLI   ACQRECON,ONLY       ONLY  WANT RECONCILED                        
         BNE   *+8                                                              
         OI    FMTROPT5,RPFOBRI    EXCLUDE RECONCILED ITEMS                     
         DROP  R3                                                               
*                                                                               
FBLD140  CLI   QPROG,PRODUCTION    PRODUCTION ?                                 
         BNE   FBLD152             NO,   SKIP                                   
         TM    FMTIND,FMTREVSG     FOUND KEYWORD THAT  REVERSES SIGN ?          
         BZ    FBLD152             NO,   SKIP                                   
         TM    FMTFLAG,FMTOKREV    FOUND REVERSE SIGNS OKAY KEYWORD ?           
         BZ    FBLD150             YES,  ALL     DONE                           
*                                  NO,   TURN    OFF   REVERSE SIGNS            
         USING ROWD,R3                                                          
         L     R3,FMTLROW                                                       
         ZIC   RF,FMT#ROWS                                                      
FBLD144  TM    ROWOPT,ROWNOREV                                                  
         BO    *+14                                                             
         SHI   R3,ROWLNQ                                                        
         BCT   RF,*-12                                                          
         DC    H'00'               HAD TO BE AT LEAST ONE KYWOKREV              
*                                                                               
         SHI   R3,ROWLNQ                                                        
         TM    ROWOPT,ROWNOREV                                                  
         BZ    FBLD146                                                          
         AHI   R3,ROWLNQ                                                        
         NI    ROWOPT,X'FF'-ROWNOREV                                            
         B     FBLD144                                                          
*                                                                               
FBLD146  AHI   R3,ROWLNQ                                                        
         OI    ROWOPT,ROWNOREV     TURN ON FOR THE REST OF ROWS                 
         SHI   R3,ROWLNQ                                                        
         BCT   RF,*-8                                                           
         B     FBLD152             YES,  ALL     DONE                           
*                                  NO,   TURN    OFF   REVERSE SIGNS            
         USING COLD,R3                                                          
FBLD150  L     R3,FMTCOL           ->    First column                           
         ZIC   RF,FMT#COLS               Number of columns                      
         NI    COLOPT2,TURNOFF-COLREVSG  Turn off reverse sign                  
         AHI   R3,COLLNQ           ->    Next column                            
         BCT   RF,*-8                    Work on next column                    
         NI    FMTIND,TURNOFF-FMTREVSG   Turn off reverse sign overall          
         DROP  R3                                                               
*                                                                               
         USING ROWD,R3                                                          
FBLD152  TM    FMTIND2,FMTYYMM         Was MONTH or YEAR keyword in use         
         BZ    FBLD170                                                          
         L     R3,FMTROW                                                        
         LLC   RF,FMT#ROWS                                                      
         SR    R1,R1                                                            
*                                                                               
         USING KYWD,R6                                                          
FBLD156  L     R6,ROWINDEX                                                      
         ICM   R1,3,KYWDD#         Get keyword dictionary #                     
         CHI   R1,AC#RSMOA         MOA keyword ?                                
         BE    FBLD160             Set split record controls on                 
         CHI   R1,AC#RSMTH         Month keyword ?                              
         BE    *+8                                                              
         CHI   R1,AC#RSRY1         Year keyword ?                               
         BNE   FBLD164                                                          
         CLI   ROWDATES,COLPDTE    PHIS attribute ?                             
         BNE   FBLD164                                                          
         OI    PHISIND,PHISMOA     Force payroll date processing                
         OI    GHISIND,GHISMOA                                                  
*                                                                               
FBLD160  OI    ROWKYIND,ROWKYSPL   Force multiple years/months to post          
         OI    SPLITIND,SPLITROW                                                
*                                                                               
FBLD164  AHI   R3,ROWLNQ                                                        
         BCT   RF,FBLD156                                                       
         DROP  R3,R6                                                            
*                                                                               
FBLD170  GOTO1 =A(GFILTER)         Global filter build                          
         CLI   ERROR#,0            Security error                               
         BNE   FBLD900                                                          
*                                                                               
         GOTO1 =A(CFILTER)         Column filter build                          
         TM    FMTIND2,FMTBUDON    Build budget information ?                   
         BZ    FBLD174                                                          
         MVC   FMTBDGT,PTRBUD      Start of budget table                        
         GOTO1 BUDBLD              Build budget information                     
         SR    RF,RF                                                            
         IC    RF,FMT#BUDS                                                      
         BCTR  RF,0                                                             
         MHI   RF,BUDLNQ                                                        
         L     RE,FMTBDGT          Start of budget tbl for this recap           
         AR    RE,RF                                                            
         ST    RE,PTRBUD           Start of budget tbl for next recap           
*                                                                               
FBLD174  CLI   AFLTCLI1,0                                                       
         BNE   *+8                                                              
         CLI   AFLTOFF,0                                                        
         BE    *+8                                                              
         OI    THRSW,THRGFP        GLOBAL FILTER                                
*&&DO                                                                           
         TM    AFLTACC,FLTMULT     Is there a profile of accounts               
         BZ    FBLD176             No                                           
         CLI   QPROG,EXPENSE       Unit ledger is included (default)            
         BE    FBLD176                                                          
         CLI   QPROG,PAYABLES                                                   
         BE    FBLD176                                                          
         CLI   QPROG,GENERAL                                                    
         BE    FBLD176                                                          
         OI    AFLTACC,FLTNOUL     No unit ledger                               
*&&                                                                             
FBLD176  TM    ESTIND,ESTRGES      Exception keyword used ?                     
         BZ    FBLD178             No                                           
         CLI   AFLTEXCR,0                                                       
         BNE   *+8                                                              
         MVI   AFLTEXCR,X'FF'                                                   
*                                                                               
* Table that determines if we preprocess cli/prd/job                            
*                                                                               
         USING CURD,R3                                                          
FBLD178  CLI   AFLTCLI1,0          cli/prd/job filter ?                         
         BE    *+8                 No                                           
         OI    CUROPT,KYWCPJ       Yes, turn them all on                        
                                                                                
         CLI   QPROG,PRODUCTION                                                 
         BNE   *+8                                                              
         NI    CUROPT,TURNOFF-KYWCPJ     Account has info so turn off           
                                                                                
         L     R3,CURBASE          Point to client entry                        
         MVI   CURFLAG,YES         Default                                      
         TM    CUROPT,KYWCLI       Client level ?                               
         BO    *+8                 Yes, client type keyword used                
         MVI   CURFLAG,NO          No                                           
                                                                                
         AHI   R3,CURLNQ           Point to product entry                       
         MVI   CURFLAG,YES         Default                                      
         TM    CUROPT,KYWPRD       Product level ?                              
         BO    *+8                 Yes, product type keyword used               
         MVI   CURFLAG,NO          No                                           
                                                                                
         AHI   R3,CURLNQ           Point to job entry                           
         MVI   CURFLAG,YES         Default                                      
         TM    CUROPT,KYWJOB       Job level ?                                  
         BO    *+8                 Yes, job type keyword used                   
         MVI   CURFLAG,NO          No                                           
*                                                                               
         AHI   R3,CURLNQ           Point to estimate entry                      
         MVI   CURFLAG,YES         Yes                                          
         TM    CUROPT,KYWEST       Parse estimate ?                             
         BO    *+8                                                              
         MVI   CURFLAG,NO                                                       
         DROP  R3                                                               
*                                                                               
         USING COLD,R3                                                          
         ZIC   R1,FMT#COLS                                                      
         L     R3,FMTCOL                                                        
FBLD200  TM    COLFLAGS,COLAMT     AMOUNT COLUMN ?                              
         BO    FBLD210                                                          
         TM    COLIND2,COLRATE     IS IT A RATE TYPE COLUMN ?                   
         BZ    FBLD212                                                          
*                                                                               
*&&US                                                                           
FBLD210  TM    CFKIND,CFKDDBAL+CFKDBBAL                                         
         BNZ   *+16                                                             
         TM    FMTFLAG,FMTCZERO    COL = ZERO CHECK ?                           
*&&                                                                             
*&&UK                                                                           
FBLD210  TM    FMTFLAG,FMTCZERO    COL = ZERO CHECK ?                           
*&&                                                                             
         BZ    *+8                                                              
         XI    COLOPT,COLCZERO     TURN ON IF OFF & VISA VERSA                  
         TM    COLOPT,COLFCAMT     FOREIGN CURRENCY COLUMN ?                    
         BZ    FBLD212                                                          
         TM    COLOPT,COLFCFLT     IS IT FILTERD OUT BY CURRENCY ?              
         BO    FBLD212                                                          
         CLI   COLTOTLV,X'FF'      IS IT ALREADY SET ?                          
         BE    *+10                                                             
         MVC   COLTOTLV,ROWHIGH    SET MAX TOTAL TO ROW                         
         CLI   ROWHIGH,0           SET AT ALL ?                                 
         BNE   *+8                                                              
         MVI   COLTOTLV,X'FF'      DON'T TOTAL ON ANY LEVEL                     
         OI    FCIND,FCISORT       SET TO FORCES SORT                           
*                                                                               
FBLD212  AHI   R3,COLLNQ                                                        
         BCT   R1,FBLD200                                                       
         DROP  R3                                                               
*                                                                               
         MVI   ROWHIGH,0           Reset                                        
         CLI   QPROG,MANPOWER      Person Scribe ?                              
         BNE   FBLD220             No                                           
         MVC   FMTDTED,ADATEHDS                                                 
         GOTO1 =A(SETCDTES)        Set calendar dates                           
         CLI   ERROR#,0                                                         
         BNE   FBLD900                                                          
*                                                                               
FBLD220  TM    FMTPOPT1,RPFMCASE   Mixed case ?                                 
         BO    FBLD224             Yes                                          
         L     RE,AUPCASE          No, so make format name upper                
         TR    FMTNAME,0(RE)                                                    
*                                                                               
FBLD224  CLI   QOPT8,C' '                                                       
         BE    FBLD230                                                          
         CLI   QOPT8,C'N'                                                       
         BE    FBLD230                                                          
         GOTO1 RQPRINT                                                          
*                                                                               
FBLD230  TM    DWNOPT1,DWNGO        Set to download                             
         BZ    FBLD234                                                          
         CLI   FMTNUM,1                                                         
         BH    FBLD234                                                          
         BAS   RE,BLDXDATA                                                      
*                                                                               
FBLD234  TM    DDLNKIND,DDLNKON+DDLNKTST    Running DDLINK                      
         BZ    FBLD238                                                          
         MVI   DWNOPT2,0           Reset to zero                                
         MVI   DWNOPT3,0           Reset to zero                                
                                                                                
FBLD238  SR    RF,RF                                                            
         IC    RF,FMTNUM                                                        
         LA    RF,1(,RF)           Increment the number of formats              
         LA    R5,FMTLNQ(,R5)      Next format area                             
         STC   RF,FMTNUM                                                        
         B     FBLD085                                                          
                                                                                
FBLD300  GOTO1 ASETACT,DMCB        SET BUFFER AND ADD FILTERS                   
                                                                                
         CLI   QOPT8,C' '          ANY FORMAT DESIGN REQUEST ?                  
         BE    FBLD320             No, skip                                     
         CLI   QOPT8,C'N'          Any format design request ?                  
         BE    FBLD320             No, skip                                     
         CLI   QOPT8,ONLY          Only format design request ?                 
         BNE   FBLD310             No, continue                                 
         MVI   ERROR#,REQDONE      This request has been completed              
         B     FBLD900             End this request                             
*                                  Generate request details again               
FBLD310  MVC   SVSKPSPC,SKIPSPEC   Save SKIPSPEC                                
         MVC   SVRCRQRP,RCREQREP   Save RCREQREP                                
         MVI   FORCEHED,YES        Force new page                               
         MVI   SKIPSPEC,C'R'       Validate request and print details           
         MVI   RCREQREP,YES        Generate request report                      
         GOTO1 ACREPORT                                                         
         MVC   SKIPSPEC,SVSKPSPC   Restore SKIPSPEC                             
         MVC   RCREQREP,SVRCRQRP   Restore RCREQREP                             
*                                                                               
FBLD320  CLI   MULTLDG,YES         Process multiple ledgers ?                   
         BNE   FBLD325             No                                           
         L     R4,ALEDGERS         Yes, so already set the 1st                  
         AHI   R4,2                Point to next ledger for next time           
         ST    R4,ALEDGERS                                                      
*                                                                               
FBLD325  GOTO1 =A(SORTADJ)                                                      
         BNE   FBLD900                                                          
         CLI   FORMAT#+1,1                                                      
         BE    FBLD330                                                          
         GOTO1 =A(RECAP)                                                        
*                                                                               
FBLD330  L     R5,AFORMATS                                                      
         LH    R1,FORMAT#                                                       
         L     RF,=A(CENTERIT)                                                  
*                                                                               
FBLD335  TM    FMTPOPT1,RPFLFJT    DO WE WANT IT LEFT JUSTIFIED?                
         BO    *+6                 YES, SKIP                                    
         BASR  RE,RF               CENTER REPORT                                
         AHI   R5,FMTLNQ                                                        
         BCT   R1,FBLD335                                                       
*                                                                               
         CLI   QPROG,PRODUCTION                                                 
         BNE   FBLD350                                                          
         CLI   ESTIND,0                                                         
         BE    *+8                                                              
         MVI   FCJOBBER,PROCACC    MAKE MONACC READ JOBBER                      
         CLI   FCJOBBER,0                                                       
         BE    FBLD350                                                          
         GOTO1 =A(JOBCOLS)                                                      
         BNE   FBLD900                                                          
*                                                                               
FBLD350  TM    FCIND,FCNEWGL                                                    
         BO    FBLD352             New General Ledger                           
         CLI   QPROG,PNL                                                        
         BNE   FBLD356                                                          
                                                                                
FBLD352  OI    POSTLVL,POSTHST                                                  
         NI    POSTLVL,TURNOFF-POSTDET                                          
*                                                                               
FBLD356  TM    GHISIND,GHISON      Do we process payroll histories ?            
         BZ    FBLD360             No                                           
         TM    POSTLVL,POSTHST     Process at history detial level ?            
         BZ    FBLD360             No                                           
         OI    POSTLVL,POSTDET     Yes, force to detail reporting level         
*                                                                               
FBLD360  TM    POSTLVL,POSTDET                                                  
         BZ    *+8                                                              
         NI    POSTLVL,TURNOFF-(POSTACC+POSTHST)                                
*                                                                               
         TM    POSTLVL,POSTHST                                                  
         BZ    *+8                                                              
         NI    POSTLVL,TURNOFF-(POSTACC+POSTDET)                                
*                                                                               
         L     R5,AFORMATS                                                      
         LH    R1,FORMAT#                                                       
         TM    FMTROPT5,RPFOSVTM   REPORT SAVED TIME SHEETS ONLY                
         BZ    FBLD370             GET OUT, ALL FORMATS MUST HAVE ON            
         AHI   R5,FMTLNQ                                                        
         BCT   R1,*-12                                                          
         NI    POSTLVL,TURNOFF-(POSTHST+POSTDET)                                
*                                                                               
FBLD370  CLC   FMTLEVMX,LEVMAX     MAKE SURE NOT PAST LOWEST LEVEL              
         BH    *+12                SET FMTLEVMX TO MAX INSTEAD                  
         CLI   FMTLEVMX,0          ANYTHING SET? IF NO THEN SET TO MAX          
         BNE   *+10                YES                                          
         MVC   FMTLEVMX,LEVMAX                                                  
*                                                                               
         CLI   ENDATE,X'FF'                                                     
         BE    FBLD380                                                          
         GOTO1 DATCON,DMCB,(3,ENDATE),(1,ENDATE)                                
*                                                                               
         USING ACMD,R2                                                          
FBLD380  TM    RECREAD2,RECALO$    DON'T LET MONACC FILTER MOA/TRANS            
         BZ    FBLD390             DATES IF NEED ALLOCATED DOLLARS              
         TM    POSTLVL,POSTDET                                                  
         BZ    FBLD390             ONLY IF PROCESSING TMS DETIALS               
         L     R2,AMONACC                                                       
         XC    ACMMSTR,ACMMSTR                                                  
         MVC   ACMMEND,=X'FFFFFF'                                               
         XC    ACMTSTR,ACMTSTR                                                  
         MVC   ACMTEND,=X'FFFFFF'                                               
         DROP  R2                                                               
                                                                                
FBLD390  TM    BUILT,BUILTSTU      BUILT STUDIO TABLE?                          
         BNZ   FBLD400             ALREADY BUILT                                
         TM    BUILD,BUILDSTU      BUILD STUDIO TABLE?                          
         BZ    FBLD400             NO                                           
         GOTO1 =A(STUDBLD)                                                      
         OI    BUILT,BUILTSTU                                                   
*                                                                               
FBLD400  TM    BUILT,BUILTOFF      BUILT OFFICE TABLE?                          
         BO    FBLD420             NO                                           
         GOTO1 =A(OFBUILD)                                                      
         OI    BUILT,BUILTOFF      BUILT OFFICE TABLE                           
*                                                                               
FBLD420  CLI   QPROG,MANPOWER                                                   
         BNE   FBLD430                                                          
         GOTO1 =A(SETCOST)                                                      
         GOTO1 =A(SETMTHD)                                                      
*                                                                               
FBLD430  CLI   QPROG,PNL                                                        
         BNE   FBLD440                                                          
         GOTO1 =A(SETMTHD)                                                      
*                                                                               
FBLD440  TM    RECAPSW,RECANLYS    Analysis reporting                           
         BZ    FBLD450                                                          
         BRAS  RE,REQSET           Set                                          
*                                                                               
FBLD450  TM    UPSI,UPSITABS       PRINT ROW/COL TABLES?                        
         BZ    FBLD900                                                          
         LH    R0,FORMAT#                                                       
         L     R5,AFORMATS                                                      
*                                                                               
FBLD460  GOTO1 =A(DUMPTAB)         DUMP OUT FORMAT DATA TABLES                  
         AHI   R5,FMTLNQ                                                        
         BCT   R0,FBLD460                                                       
*                                                                               
FBLD900  CLI   ERROR#,0            SET CC                                       
         BE    FBLD920                                                          
         MVI   MULTLDG,NO                                                       
         MVI   FCRDACC,C'N'        STOP READING ACCOUNT (UNRECOV ERR.)          
         MVI   FCRDTRNS,C'N'       STOP READING TRANS.  (UNRECOV ERR.)          
*                                                                               
FBLD920  XMOD1 1                                                                
         DROP  R5                                                               
         EJECT                                                                  
***********************************************************************         
*                                                                               
***********************************************************************         
RCAP     USING FMTRECD,R5                                                       
MAIN     USING FMTRECD,R6                                                       
SETFLTS  NTR1                                                                   
         L     R6,AFORMATS         RESET TO  MAIN FORMAT                        
         LA    R0,AFLTLNQ/4        NUMBER OF ENTRIES TO LOOK AT                 
         LA    R2,MAIN.AFLTLIST    START OF  FILTER LIST                        
         LA    R3,RCAP.AFLTLIST    RECAP FILTER LIST                            
*                                                                               
SETFLT10 TM    0(R2),FLTCARD                                                    
         BZ    SETFLT20                                                         
         MVC   0(4,R3),0(R2)       USE REQUEST CARD SET UP                      
*                                                                               
SETFLT20 LA    R2,4(,R2)                                                        
         LA    R3,4(,R3)                                                        
         BCT   R0,SETFLT10                                                      
         B     FMTXIT                                                           
         DROP  RCAP,MAIN                                                        
         EJECT                                                                  
***********************************************************************         
*                                                                               
***********************************************************************         
         USING RQTABD,R3                                                        
REQSET   NTR1                                                                   
         L     R3,AREQTAB          A(Request to process)                        
REQST010 CLI   0(R3),EOT                                                        
         JE    FMTXIT                                                           
         CLC   RQTYPE,QPROG        Match on reporting type                      
         JE    REQST020                                                         
REQST012 LA    R3,RQTLNQ(,R3)                                                   
         J     REQST010                                                         
                                                                                
         USING RQLISTD,R4                                                       
REQST020 LLC   R0,RQT#ITEM         Number of items in list                      
         SR    R4,R4                                                            
         ICM   R4,3,RQTLIST        Displacement to list                         
         A     R4,AREQLIST                                                      
REQST022 CLI   RQLUSED,YES                                                      
         BE    REQST028            Already set so okay as is                    
         SR    R1,R1                                                            
         ICM   R1,3,RQLITEM                                                     
         A     R1,AREQITEM         Point to item(s)                             
         GOTOR SETITEM                                                          
         BH    REQST030            A req'd item is not set                      
         BNE   REQST028                                                         
         MVI   RQLUSED,YES         Set on                                       
                                                                                
REQST028 LA    R4,RQLLNQ(,R4)      Next item                                    
         BRCT  R0,REQST022                                                      
         B     REQST012                                                         
                                                                                
REQST030 GOTOR REQNUSED                                                         
         B     REQST012                                                         
         J     FMTXIT                                                           
         EJECT                                                                  
***********************************************************************         
*                                                                               
***********************************************************************         
         USING RQD,R4                                                           
         USING ROWD,R2                                                          
         USING FMTRECD,R5                                                       
SETITEM  NTR1                                                                   
         LR    R4,R1               R1 = A(Items to examine)                     
         MVI   BYTE1,NO            Set to none used / found                     
                                                                                
SETITM10 CLI   0(R4),EOR           End of items                                 
         BE    SETITMX                                                          
         L     R2,FMTROW           A(Rows)                                      
         LA    R2,ROWLNQ(,R2)      Skip first row                               
         LLC   R0,FMT#ROWS                                                      
         BCTR  R0,0                                                             
                                                                                
SETITM20 CLC   RQKYWD,ROWDD#       Match on keyword #                           
         BE    SETITM28                                                         
         LA    R2,ROWLNQ(,R2)      Skip first row                               
         BRCT  R0,SETITM20                                                      
         TM    RQIND,RQREQ         Is this required?                            
         BO    SETITML                                                          
         B     SETITM40                                                         
                                                                                
SETITM28 MVC   RQNODE#,ROWNODE#                                                 
         MVI   BYTE1,YES           Set found one                                
         TM    RQLEN,RQCC          Conditional ?                                
         BZ    SETITM30                                                         
         MVC   BYTE,RQLEN                                                       
         BRAS  RE,CCSET            Conditional set                              
         BE    SETITM30                                                         
         MVI   BYTE1,NO            Turn off, can't resolve CC                   
         B     SETITMX                                                          
                                                                                
SETITM30 TM    RQPOS,RQCC          Conditional ?                                
         BZ    SETITM40                                                         
         MVC   BYTE,RQPOS                                                       
         BRAS  RE,CCSET            Conditional set                              
         BE    SETITM40                                                         
         MVI   BYTE1,NO            Turn off, can't resolve CC                   
         B     SETITMX                                                          
                                                                                
SETITM40 LLC   RF,RQLN                                                          
         AR    R4,RF                                                            
         B     SETITM10                                                         
                                                                                
SETITML  MVI   BYTE1,X'FF'         Set CC = High                                
                                                                                
SETITMX  CLI   BYTE1,YES           Set return condition code                    
         J     FMTXIT                                                           
         DROP  R2,R4,R5                                                         
         EJECT                                                                  
***********************************************************************         
* Come here to turn off the used bits in the reqtab entries when a              
* required field is not found in the rows.                                      
* R3 points to the current reqtab entry being processed                         
***********************************************************************         
                                                                                
         USING RQLISTD,R4                                                       
REQNUSED NTR1                                                                   
         LLC   R0,RQT#ITEM         Number of items in list                      
         SR    R4,R4                                                            
         ICM   R4,3,RQTLIST        Displacement to list                         
         A     R4,AREQLIST                                                      
REQNU10  MVI   RQLUSED,NO                                                       
         LA    R4,RQLLNQ(,R4)      Next item                                    
         BRCT  R0,REQNU10                                                       
         J     FMTXIT                                                           
         DROP  R4                                                               
         EJECT                                                                  
***********************************************************************         
*                                                                               
***********************************************************************         
         USING ROWD,R2                                                          
         USING CCLISTD,R3                                                       
         USING FMTRECD,R5                                                       
CCSET    NTR1                                                                   
         MVI   BYTE2,NO            Was this valid CC                            
         L     R3,ACCNLIST                                                      
CCSET10  CLI   0(R3),EOR                                                        
         BE    CCSETXIT                                                         
         CLC   CCLTYPE,QPROG                                                    
         BNE   CCSET11                                                          
         CLC   BYTE,CCLID#        Match on condition number                     
         BE    CCSET12                                                          
CCSET11  LA    R3,CCLLNQ(,R3)                                                   
         B     CCSET10             Next condition                               
                                                                                
CCSET12  TM    CCLIND,CCLACTV      Already processed                            
         BO    CCSETXIT            Done                                         
         OI    CCLIND,CCLACTV      Mark as processed                            
                                                                                
         USING CCND,R4                                                          
         SR    R4,R4                                                            
         ICM   R4,3,CCLITEM                                                     
         A     R4,ACCNTAB                                                       
                                                                                
CCSET22  CLI   0(R4),EOR           End of data                                  
         BE    CCSETXIT                                                         
         L     R2,FMTROW           A(Rows)                                      
         LA    R2,ROWLNQ(,R2)      Skip first row                               
         LLC   R0,FMT#ROWS                                                      
         BCTR  R0,0                                                             
                                                                                
CCSET30  CLC   CCNKYWD,ROWDD#      Match on keyword #                           
         BE    CCSET32                                                          
         LA    R2,ROWLNQ(,R2)      Skip first row                               
         BRCT  R0,CCSET30                                                       
         B     CCSET40                                                          
                                                                                
CCSET32  MVC   CCNNODE#,ROWNODE#                                                
         MVI   BYTE2,YES           Set as valid                                 
                                                                                
CCSET40  LLC   RF,CCNLN                                                         
         AR    R4,RF                                                            
         B     CCSET22             Next entry                                   
                                                                                
CCSETXIT CLI   BYTE2,YES                                                        
         J     FMTXIT                                                           
         DROP  R2,R3,R4,R5                                                      
         EJECT                                                                  
*=====================================================================*         
*   Build extended header information                                 *         
*=====================================================================*         
         USING FMTRECD,R5                                                       
BLDXDATA NTR1                                                                   
         L     R3,AHDRDATA         Location for HDR type data                   
         L     R2,AIO2                                                          
         AH    R2,DATADISP                                                      
*=====================================================================*         
*        Process Headers                                                        
*=====================================================================*         
                                                                                
         USING XTRELD,R2                                                        
NEWEL    USING XTRELD,R3                                                        
                                                                                
BLDXD10  CLI   0(R2),0             End of record                                
         BE    BLDXXIT                                                          
         CLI   0(R2),XTRELQ        X'C6' elements                               
         BNE   BLDXD80                                                          
         CLI   XTRTYPE,XTRHDR                                                   
         BNE   BLDXD20                                                          
         OI    DWNOPT3,DWNXHDR                                                  
         SR    RF,RF                                                            
         IC    RF,XTRLN              Element length                             
         BCTR  RF,0                                                             
         EXMVC RF,NEWEL.XTREL,XTREL  Save off element                           
         LA    R3,1(RF,R3)                                                      
         B     BLDXD80               Next                                       
*=====================================================================*         
*        Process Total trailers                                                 
*=====================================================================*         
                                                                                
BLDXD20  CLI   XTRTYPE,XTRRTOT                                                  
         BE    *+8                                                              
         CLI   XTRTYPE,XTRCTOT                                                  
         BNE   BLDXD30                                                          
         OI    DWNOPT3,DWNXTTR                                                  
         L     R3,ATTRDATA                                                      
         B     BLDXD32                                                          
*=====================================================================*         
*        Process Trailer                                                        
*=====================================================================*         
                                                                                
BLDXD30  CLI   XTRTYPE,XTRTRL      Extended trialer                             
         BNE   BLDXD80             No                                           
         L     R3,ATRLDATA                                                      
         OI    DWNOPT3,DWNXTRL     Trailer                                      
*                                                                               
BLDXD32  MVC   NEWEL.XTREL(XTRLNQ),XTREL    Save 1st part                       
         LA    R4,NEWEL.XTRSUBEL                                                
         SR    R1,R1                                                            
         IC    R1,XTRSUB#          Number of sub-elements                       
         LA    R2,XTRSUBEL                                                      
*                                                                               
         USING XTRSUBEL,R2                                                      
BLDXD40  TM    XTRSIND,XTRSROW+XTRSCOL    Row or column type                    
         BZ    BLDXD60                                                          
                                                                                
NEWSUB   USING XTRSUBEL,R4                                                      
                                                                                
BLDXD50  MVC   NEWSUB.XTRSUBEL(XTRSDATA-XTRSUBEL),XTRSUBEL                      
         MVC   NEWSUB.XTRSNUM,XTRSNUM                                           
         MVI   NEWSUB.XTRSUBLN,XTRSLN1Q+3   Adjust sub-element length           
         LA    R4,XTRSLN1Q+3(,R4)           Increase size to replace            
         ZIC   RF,XTRSUBLN                  with address of col or row          
         AR    R2,RF                        later                               
         ZIC   RF,NEWEL.XTRLN                                                   
         AHI   RF,3                Add three for adjustment                     
         STC   RF,NEWEL.XTRLN                                                   
         B     BLDXD70                                                          
*                                                                               
BLDXD60  SR    RF,RF                                                            
         IC    RF,XTRSUBLN                                                      
         SHI   RF,1                                                             
         BNM   *+6                                                              
         DC    H'00'                                                            
*                                                                               
         EXMVC RF,NEWSUB.XTRSUBEL,0(R2)                                         
         LA    R2,1(RF,R2)                                                      
         LA    R4,1(RF,R4)                                                      
*                                                                               
BLDXD70  BCT   R1,BLDXD40                                                       
         DROP  NEWSUB                                                           
*                                                                               
         LR    R3,R4                                                            
         B     BLDXD10                                                          
*                                                                               
BLDXD80  SR    RF,RF                                                            
         IC    RF,1(,R2)                                                        
         AR    R2,RF                                                            
         B     BLDXD10                                                          
         DROP  R2                                                               
*                                                                               
BLDXXIT  B     FMTXIT                                                           
         DROP  R5                                                               
         EJECT                                                                  
***********************************************************************         
*                  ADD ROW INFORMATION TO ROWTABLE                    *         
***********************************************************************         
         SPACE 1                                                                
         USING RRWELD,R2                                                        
         USING ROWD,R3                                                          
         USING COLD,R4                                                          
         USING FMTRECD,R5                                                       
         USING KYWD,R6                                                          
BLDROW   NTR1                                                                   
         MVI   BLDACT,ROWS                                                      
         L     RE,HEADWRK          LOAD BEGINING OF HEAD POOL                   
         ST    RE,POINTER          CURRENT POINTER TO HEAD POOL                 
         XC    TOTFORAD,TOTFORAD   GET ADDR. WHERE TO PRINT ROW TOTS            
*                                                                               
         L     R4,FMTCOL           POINT TO COLUMN INFO                         
         ZIC   R0,FMT#COLS         NUMBER OF COLUMNS                            
BLDROW05 TM    COLFLAGS,COLHIDE    IF HIDDEN SKIP                               
         BZ    BLDROW10            FOUND WHERE TO PRINT ROW INFO                
BLDROW07 AHI   R4,COLLNQ                                                        
         BCT   R0,BLDROW05                                                      
*                                                                               
         L     R4,FMTCOL                                                        
BLDROW10 MVC   TOTFORAD,COLPRT     MOVE START OF COLUMN PRINT ADDR.             
         MVC   TOTFORSZ,COLSIZE    SIZE OF COLUMN WE ARE PRINTING IN            
         LR    RE,R4               SAVE R4                                      
         SR    R1,R1                                                            
         SR    RF,RF                                                            
         IC    R1,COLSIZE                                                       
*                                                                               
BLDROW12 TM    COLOPT,COLCHUNK     IS FIRST COLUMN CHUNKED?                     
         BO    *+8                 YES                                          
         TM    FMTPOPT2,RPFEXCOL   EXTEND COLUMNS PRINTING OF MID/TOTS          
         BZ    BLDROW15                                                         
         CLC   COLNUM,FMT#COLS     ANY MORE COLUMNS?                            
         BE    BLDROW15            NO, SO LEAVE ALONE                           
         AHI   R4,COLLNQ           BUMP TO NEXT COLUMN                          
         TM    COLFLAGS,COLAMT     IF ACCUMULATED COLUMN GET OUT                
         BO    BLDROW15                                                         
         TM    COLFLAGS,COLHIDE                                                 
         BO    BLDROW12                                                         
         IC    RF,COLSIZE          GET THIS COLUMN SIZE AND                     
         AR    R1,RF               ADD TO PREVIOUS COLUMNS                      
         STC   R1,TOTFORSZ         SAVE SIZE TO PRINT TOTAL FOR IN              
         B     BLDROW12                                                         
*                                                                               
BLDROW15 LR    R4,RE               RESTORE R4                                   
         MVC   MINSZ,COLSRTSZ      MINIMUM SIZE WE CAN INDENT TO                
         L     R3,PTRROW           INITIALIZE ROW DATA FOR FORMAT               
         ST    R3,FMTROW                                                        
*                                                                               
         MVC   FMTKEYLN,=H'01'     Initialize sort key  length                  
         XC    FMTDATLN,FMTDATLN   Initialize sort data length                  
         MVI   ROWSTAGE,1          Add first row (STAGE 1)                      
         L     R2,=A(FIRSTROW)     First row is always company code             
         NI    RRWOPT,TURNOFF-RRWTOTSP       reset this option                  
         TM    FMTPOPT2,RPFTOTSP   Request total on seperate page ?             
         BZ    *+8                 No                                           
         OI    RRWOPT,RRWTOTSP     Yes                                          
         B     BLDROW30            Process first row                            
*                                                                               
BLDROW20 CLI   0(R2),RRWELQ        Is this element a row?                       
         BE    BLDROW30            Yes so process                               
         CLI   ROWSTAGE,2          Check where to get row elements              
         BE    BLDROW25            Add elements from pool                       
         BH    BLDROW99            Finished                                     
         MVI   ROWSTAGE,2          Increment for next stage                     
         L     R2,AIO2             Get elements from record (STAGE 2)           
         MVI   ELCODE,RRWELQ       Row element information                      
         BAS   RE,GETEL                                                         
         BE    BLDROW30            Found row elements, so process               
*                                                                               
BLDROW25 L     R2,ROWWRK           POOL OF COLUMN ROW ELEMENTS TO ADD           
         MVI   ROWSTAGE,3          SET FOR FINAL STAGE (STAGE 3)                
         B     BLDROW20                                                         
*                                                                               
BLDROW30 XC    ROWD(ROWLNQ),ROWD   CLEAR OUT EACH ROW                           
         ZIC   R1,FMT#ROWS                                                      
         AHI   R1,1                INCREMENT BY ONE                             
         STC   R1,ROWNUM                                                        
         STC   R1,FMT#ROWS         NUMBER OF ROWS                               
         MVC   ROWFLAGS,RRWOPT                                                  
         NI    ROWFLAGS,TURNOFF-ROWUNQ    Not unique                            
         NI    ROWFLAGS,TURNOFF-RRWNEWEL  Not required at this point            
         TM    RRWOPT2,RRWPGNO            PAGE NUMBER RESET?                    
         BZ    *+8                                                              
         OI    ROWOPT,ROWPGNO                                                   
         TM    RRWOPT2,RRWSHRT     SHORT WORKCODE NAME                          
         BZ    *+8                                                              
         OI    ROWOPT,ROWSHRT                                                   
*                                                                               
         TM    RRWOPT2,RRWAIDX                                                  
         BZ    *+12                                                             
         MVI   RRWTYPE,RRWLHEAD    Reset                                        
         OI    ROWDAIND,ROWIDXON   Set indexing for Accent download             
*&&US                                                                           
         TM    RRWOPT3,RRWXCOL                                                  
         BZ    *+8                                                              
         OI    ROWDAIND,ROWXCOL                                                 
*                                                                               
         TM    RRWOPT3,RRWBDR                                                   
         BZ    *+8                                                              
         OI    ROWDAIND,ROWBDR                                                  
*&&                                                                             
         TM    RRWOPT2,RRWLVL      LEVEL PORTION ONLY?                          
         BZ    *+12                                                             
         OI    ROWKYIND,ROWKYLVL                                                
         OI    ROWDAIND,ROWDALVL                                                
*                                                                               
         TM    RRWOPT2,RRWBTM                                                   
         BZ    *+8                                                              
         OI    ROWOPT,ROWPBTM                                                   
*                                                                               
         TM    RRWOPT2,RRWMERGE    Merge data if selected $COLS=ZERO            
         BZ    *+12                                                             
         OI    FMTFLAG2,FMTWIPE                                                 
         OI    ROWXPIND,ROWWIPE                                                 
*                                                                               
         MVC   ROWDATES,RRWDATES                                                
         CLI   RRWTYPE,ROWCOL      Row column element type                      
         BNE   BLDROW40                                                         
         ICM   R4,15,RRWNDATA      Point to original column                     
         ST    R4,ROWACOL                                                       
         L     R6,COLINDEX         Get data from DATAPOOL table                 
*                                                                               
         MVC   ROWDD#,COLDD#                                                    
         OC    KYWPRSE,KYWPRSE                                                  
         BNZ   *+8                                                              
         OI    ROWXPIND,ROWNOSRT   None sorted data                             
                                                                                
         TM    COLIND2,COLSTATC    Special "STATIC" keyword                     
         BZ    BLDROW32                                                         
         MVC   ROWPRFX,COLHEAD1    Yes so load in prefix area                   
*                                                                               
BLDROW32 TM    KYWIND5,KYWISDTE    Is it date type ?                            
         BZ    *+8                                                              
         OI    ROWDAIND,ROWDAYMD   Date type YYMMDD                             
                                                                                
         MVC   ROWDATES,COLDATES                                                
         MVC   ROWFILT,COLFILT                                                  
         MVC   ROWDTIDX,COLDTIDX                                                
         CLI   FMTRNK#1,C'C'           Is RANKON on a column ?                  
         BNE   BLDROW35                                                         
         CLC   COLNUM,FMTRNK#1+1                                                
         BNE   BLDROW35                                                         
         MVI   FMTRNK#1,C'R'           Rename to rank on a row                  
         MVC   FMTRNK#1+1(1),ROWNUM    New row number to rankon                 
*                                                                               
BLDROW35 CLI   FMTRNK#2,C'C'           Is RANKBY on a column ?                  
         BNE   BLDROW36                                                         
         CLC   COLNUM,FMTRNK#2+1                                                
         BNE   BLDROW36                                                         
         MVI   FMTRNK#2,C'R'           Rename to rank by a row                  
         MVC   FMTRNK#2+1(1),ROWNUM    NEW ROW NUMBER TO RANKBY                 
*                                                                               
BLDROW36 TM    COLOPT,COLUDEF      Is user field keyword ?                      
         BZ    BLDROW50            No                                           
         MVC   ROWUDSEQ,COLUDSEQ                                                
         OI    ROWOPT,ROWUDEF      Set user defined                             
         B     BLDROW50                                                         
*                                                                               
BLDROW40 MVC   NCROWS+1(1),FMT#ROWS        NUMBER OF NON-COLUMNS ROWS           
         MVI   NPRAMS,1                    DEFAULT TO 1                         
         XC    KEYWRD#,KEYWRD#     DICTIONARY KEYWORD #                         
         MVI   XDATA,0                                                          
*                                                                               
         TM    RRWOPT2,RRWDICT     DICTIONARY FORM ?                            
         BZ    *+10                NO                                           
         MVC   KEYWRD#,RRWNDATA                                                 
         CLI   RRWSPCL,RRWSPLV1    ACCOUNT LEVEL 1 OR HIGHER                    
         BL    *+10                                                             
         MVC   XDATA,RRWXDATA      NEED TO MACTH ON XTRA DATA                   
*                                                                               
         TM    RRWOPT2,RRWDICT     DICTIONARY FORM ?                            
         BO    BLDROW41            YES                                          
         MVC   P,SPACES                                                         
         SR    RF,RF                                                            
         IC    RF,RRWDATLN         LENGTH OF DATA                               
         BCTR  RF,0                                                             
         EXMVC RF,P,RRWNDATA                                                    
         GOTO1 =V(SCANNER),DMCB,(C'C',P),(3,ABLOCK)                             
         MVC   NPRAMS,DMCB+4       NUMBER OF PARAMETERS USED IN ROWDATA         
         L     RE,ABLOCK                                                        
         MVC   FINDDATA,12(RE)     GET ROW INFO FORM DATAPOOL                   
*                                                                               
BLDROW41 GOTO1 =A(KYWFIND)                                                      
         LTR   R6,R6                                                            
         BNZ   BLDROW42            FOUND KEYWORD IN TABLE                       
         CLI   ERROR#,0                                                         
         BNE   FMTXIT                                                           
         OI    ROWOPT,ROWUDEF      USER DEFINED                                 
         GOTO1 =A(USERDEF)         BUILD USER DEFINDED KEYWORD TABLE            
         BNE   BLDROWX                                                          
         MVC   ROWUDSEQ,UDEFSEQ#                                                
         CLI   RRWTYPE,ROWCOL      ROW COLUMN ELEMENT TYPE                      
         BNE   BLDROW42                                                         
         MVC   UDEFSRTS,COLSRTSZ+1 OVER RIDE SIZE                               
         MVC   UDEFDATS,COLDATSZ   OVER RIDE SIZE                               
*                                                                               
BLDROW42 MVC   ROWDD#,KYWDD#       Save off dictionary number                   
         TM    KYWIND6,KYWFNAME    Force to use both code/name                  
         BZ    *+8                                                              
         OI    ROWFLAGS,ROWNME     Force name to make both                      
         TM    KYWIND6,KYWNOCDE    Special option to not print code             
         BZ    *+8                                                              
         OI    ROWDAIND,ROWNOCDE   Yes                                          
                                                                                
         MVC   ROWDTIDX,FMTDTIDX   Default                                      
         MVC   ROWSEC#,KYWSECGP                                                 
         TM    DDLNKIND,DDLNKGBL   RLP Global report                            
         BO    BLDR42A             Let DDLINK handle this                       
         GOTOR VALFLDN,ROWSEC#                                                  
         BNL   BLDR42A                                                          
         MVI   RRWTYPE,ROWNOSEC    Suppress row, same as ROWNOSHW               
                                                                                
BLDR42A  TM    KYWIND5,KYWISDTE    Is date ?                                    
         BZ    BLDR42B             No                                           
         OI    ROWDAIND,ROWDAYMD              Date type YYMMDD                  
         TM    DDLNKIND,DDLNKINT+DDLNKTST     DDLINK initialized ?              
         BZ    BLDR42B                                                          
         MVI   ROWDTIDX,((DATEISO-DATEFMT)/DATELNQ)+1                           
         B     BLDR42F             Set all date to ISO format                   
                                                                                
         USING EDITD,R1                                                         
BLDR42B  SR    R1,R1                                                            
         ICM   R1,3,KYWEDIT                                                     
         BZ    BLDR42F                                                          
         A     R1,EDTBASE                                                       
         CLI   EDITTYPE,DATETYPE   Date type ?                                  
         BNE   BLDR42F             No                                           
         CLI   EDITDTE2,EDITYEAR                                                
         BNE   *+8                                                              
         MVI   RRWDTEFM,EDITYEAR   Over-ride to YYYY                            
         CLI   EDITDTE2,EDITMNTH                                                
         BNE   *+8                                                              
         MVI   RRWDTEFM,EDITMNTH   Over-ride to MMM                             
         CLI   RRWDTEFM,0          Is it set ?                                  
         BE    BLDR42F             No, so skip                                  
*                                                                               
         USING DATED,R1                                                         
         L     R1,ADATEFMT                                                      
         LA    RF,DATEFMT#         Number of entries                            
BLDR42D  CLC   DATEFORM,RRWDTEFM   Match on form type                           
         BE    BLDR42E                                                          
         AHI   R1,DATELNQ                                                       
         BCT   RF,BLDR42D                                                       
         DC    H'00'                                                            
*                                                                               
BLDR42E  SHI   RF,DATEFMT#+1                                                    
         LPR   RF,RF                                                            
         STC   RF,ROWDTIDX         Save off index                               
         DROP  R1                                                               
*                                                                               
BLDR42F  OC    KYWPRSE,KYWPRSE                                                  
         BNZ   *+8                                                              
         OI    ROWXPIND,ROWNOSRT   None sorted data                             
                                                                                
         TM    KYWIND3,KYWTRNS                                                  
         BZ    *+8                                                              
         NI    FMTPONCE,TURNOFF-FMTPON    Post once per account -> No           
                                                                                
         SR    R1,R1                                                            
         ICM   R1,3,KYWDD#                                                      
         CHI   R1,AC#RSA4C         Account Level keyword ?  A4C                 
         BE    BLDRW42A            No                                           
         CHI   R1,AC#RSA4N         Account Level keyword ?  A4N                 
         BE    BLDRW42A            No                                           
         CHI   R1,AC#RSACC         Account Level keyword ?  ACC                 
         BE    BLDRW42A            No                                           
         CHI   R1,AC#RSACN         Account Level keyword ?  ACN                 
         BNE   BLDRW42B            No                                           
*                                                                               
BLDRW42A CLI   FMTROWLV,0          Was it set already ?                         
         BNE   BLDRW42B            Yes                                          
         MVC   FMTROWLV,ROWNUM     No, so save                                  
*                                                                               
BLDRW42B CHI   R1,AC#RSUSF         Is it user field keyword ?                   
*&&US*&& BE    BLDRW42C                                                         
*&&US*&& CHI   R1,AC#RSUSC         Is it user field keyword ?                   
*&&US*&& BE    BLDRW42C                                                         
*&&US*&& CHI   R1,AC#AUUF          Is it Auth user field keyword ?              
         BNE   BLDROW43                                                         
*                                                                               
BLDRW42C MVC   ROWFILT,PTCCODES       AREA TO STORE FILTERS                     
         L     RE,ROWFILT                                                       
         SR    RF,RF                                                            
         IC    RF,RRWDATLN            GET DATA                                  
         AHI   RF,-3                  DATA = AL2(UF#),C'UF',C'UF',C'UF'         
         EXMVC RF,0(RE),RRWNDATA+2                                              
         LA    RE,1(RF,RE)                                                      
         MVI   0(RE),EOT                                                        
         LA    RE,1(,RE)                                                        
         ST    RE,PTCCODES                                                      
*                                                                               
         USING RHDELD,R7                                                        
BLDROW43 L     R7,POINTER          CURRENT POINTER TO HEAD ELEMENT POOL         
         MVI   TEMPTYPE,RHDLFTH                                                 
         CLI   RRWTYPE,C'L'                                                     
         BE    BLDROW44                                                         
*                                                                               
         MVI   TEMPTYPE,RHDRHTH                                                 
         CLI   RRWTYPE,C'R'                                                     
         BE    BLDROW44                                                         
*                                                                               
         MVI   TEMPTYPE,RHDCNTR                                                 
         CLI   RRWTYPE,C'C'                                                     
         BNE   BLDROW50                                                         
*                                                                               
BLDROW44 TM    RRWOPT2,RRWHIDE     ONLY STEREO SET THIS BIT                     
         BO    BLDROW50            DO NOT PRINT ROW DETIALS                     
         XC    RHDEL(20),RHDEL     CLEAR FOR MY MAX LENGTH +1                   
         MVI   RHDEL,RHDELQ        BUILD HEAD ELEMENT FROM ROW                  
         MVI   RHDLN,19            FIXED LENGTH FOR ROWHEAD TYPE                
         MVC   RHDTYPE,TEMPTYPE    MOVE IN LEFT,RIGHT,CENTER                    
         MVI   RHDSEQ,5                                                         
         CLI   RRWPSEQ,0           PRINT SEQUENSE FROM STEREO                   
         BE    *+10                                                             
         MVC   RHDSEQ,RRWPSEQ                                                   
         OI    RHDFRM,RHDROW       TURN ON ROW HEADING OPTION                   
         CLI   RRWPFXLN,0          IS   THERE A PREFIX ?                        
         BE    *+8                 NO                                           
         OI    RHDFRM,RHDPRFX      YES, HEADING PREFIX                          
         STCM  R3,15,RHDDATA       SAVE ROW ADDRESS IN HEAD ELEM                
         LA    R7,19(,R7)          BUMP TO NEXT LOC IN HEAD ELEM POOL           
         ST    R7,POINTER          SAVE NEW LOCATION                            
***********************************************************************         
*  BUILD HEAD ELEMENT FOR ADDRESS                                     *         
***********************************************************************         
         SPACE 1                                                                
         TM    ROWFLAGS,ROWADDR    IS ADDRESS FLAG SET                          
         BO    BLDROW48                                                         
*&&US*&& TM    ROWDAIND,ROWBDR     OR BDR ADDRESS                               
         BZ    BLDROW50                                                         
BLDROW48 XC    RHDEL(20),RHDEL     CLEAR FOR MY MAX LENGTH                      
         MVI   RHDEL,RHDELQ        BUILD HEAD ELEMENT FROM ROW                  
         MVI   RHDLN,19            FIXED LENGTH FOR ROWHEAD TYPE                
         MVC   RHDTYPE,TEMPTYPE    MOVE IN LEFT,RIGHT,CENTER                    
         MVI   RHDSEQ,5                                                         
         CLI   RRWPSEQ,0                                                        
         BE    *+10                                                             
         MVC   RHDSEQ,RRWPSEQ                                                   
         OI    RHDFRM,RHDADR+RHDROW   TURN ON ADDRESS                           
         CLI   RRWPFXLN,0             IS   THERE A PREFIX ?                     
         BE    *+8                    NO                                        
         OI    RHDFRM,RHDPRFX         YES, HEADING PREFIX                       
         STCM  R3,15,RHDDATA       SAVE ROW ADDRESS IN HEAD ELEM                
         AHI   R7,19               BUMP TO NEXT LOC IN HEAD ELEM POOL           
         ST    R7,POINTER          SAVE NEW LOCATION                            
*                                                                               
BLDROW50 MVI   OVERSZ,0                                                         
         BAS   RE,ADDREPL                                                       
*&&US                                                                           
         TM    KYWIND6,KYWADA            Average days allowed?                  
         BZ    *+16                      . NO                                   
         TM    CFKIND,CFKDDBAL+CFKDBBAL  Average days wanted?                   
         BZ    *+8                       . NO                                   
         BRAS  RE,CFADRCC                CASHFLOW ADAYS ROW/COL CHECK           
*&&                                                                             
         TM    KYWIND2,KYWFCSRT    SORTING BY FOREIGN CURRENCY CODE?            
         BZ    *+10                                                             
         MVC   ROWHIGH,ROWNUM      HIGHEST ROW WITH FOREIGN CURRENCY            
         TM    KYWIND1,KYWMRG      MERGEABLE DATA?                              
         BZ    *+12                                                             
         OI    FMTIND,FMTMERGE     SET TO RUN CODE                              
         OI    ROWKYIND,ROWKYMRG   SET TO MERGE ON THIS ROW                     
         TM    KYWIND4,KYWNOSQH                                                 
         BZ    *+8                                                              
         OI    ROWOPT,ROWNOSQH                                                  
         TM    DWNOPT1,DWNCHOP                                                  
         BZ    *+8                                                              
         OI    ROWOPT,ROWNOSQH     DON'T SQUISH IF DOWNLOADING                  
         TM    KYWIND4,KYWOKREV    OKAY TO REVERSE SIGNS ?                      
         BZ    *+12                                                             
         OI    ROWOPT,ROWNOREV     Mark row as no reverse for now               
         OI    ROWOPT,ROWREV       Keep track if marked as KYWOKREV             
         TM    KYWIND5,KYWRFILL    Currently only receivables                   
         BZ    *+8                                                              
         OI    ROWOPT,ROWFILL                                                   
*                                                                               
         CLI   QPROG,MANPOWER                                                   
         BNE   BLDROW51                                                         
         TM    KYWIND5,KYWMASK     REMOVE PERSON CODE WHEN PRINTING             
         BZ    BLDROW51                                                         
         SR    RE,RE                                                            
         IC    RE,LEV3LN           LEVEL 4 - LEVEL 3 FOR LENGTH                 
         SR    RF,RF                                                            
         IC    RF,LEV4LN                                                        
         SR    RF,RE                                                            
         TM    ROWKYIND,ROWKYLVL                                                
         BO    *+8                                                              
         TM    ROWDAIND,ROWDALVL                                                
         BZ    *+8                                                              
         IC    RF,LEV4LN                                                        
         AHI   RF,2                ADD TWO FOR UNIT/LEDGER                      
         STC   RF,ROWMASKL         SAVE MASKING LENGTH                          
*                                                                               
BLDROW51 CLI   FMTRNK#2,C'R'                                                    
         BNE   BLDROW52                                                         
         CLC   ROWNUM,FMTRNK#2+1   RANK BY ROW NUMBER                           
         BNE   BLDROW52                                                         
         MVC   FMTRNKBY,FMTKEYLN                                                
         LA    R1,PKLEN+2          BUMP UP BY ACCUM LENGTH PLUS TWO             
         AH    R1,FMTKEYLN                                                      
         STH   R1,FMTKEYLN         SAVE NEW LOCATION                            
*                                                                               
BLDROW52 CLI   RRWTYPE,ROWCOL      Is row made from column then                 
         BNE   BLDRW52A            No                                           
         TM    COLIND2,COLRATE     Is it a rate type column ?                   
         BZ    BLDRW52A            No                                           
         OI    ROWXPIND,ROWRATE    Yes, so mark it                              
         B     BLDROW53                                                         
                                                                                
BLDRW52A CLI   ROWDATES,0                                                       
         BE    BLDROW53                                                         
*                                                                               
BLDRW52C CLC   KYWOTHR,ROWDATES    MATCH LINK                                   
         BE    BLDRW52D                                                         
         SR    R1,R1                                                            
         ICM   R1,3,KYWLINK        SPECIAL LINK TO DUE/MOS DATE                 
         BNZ   *+6                                                              
         DC    H'00'                                                            
*                                                                               
         A     R1,KYWBASE                                                       
         LR    R6,R1               POINT TO NEW KEYWORD                         
         B     BLDRW52C                                                         
*                                                                               
BLDRW52D TM    KYWIND1,KYWUNQ      IS THERE UNIQUE DATA?                        
         BZ    *+8                                                              
         MVI   UNIFLAG,YES         SET TO PUT ON REC/TRANS                      
         CLI   KYWOTHR,KYWBMO      IS IT BILLED MOA                             
         BE    *+8                                                              
         CLI   KYWOTHR,KYWBIL      IS IT BILLED DATE                            
         BNE   BLDROW53                                                         
         OI    ROWKYIND,ROWKYSPL                                                
         OI    SPLITIND,SPLITROW                                                
         OI    SPLITIND,SPLIT77                                                 
*                                                                               
BLDROW53 ST    R6,ROWINDEX         ARRAY NUMBER INTO DATAPOOL                   
         TM    KYWIND3,KYWSPLT     SPLIT COLUMN DATA?                           
         BZ    BLDROW54                                                         
         GOTO1 =A(VALSPLT)                                                      
         BNE   BLDROW54                                                         
         OI    ROWKYIND,ROWKYSPL                                                
         OI    SPLITIND,SPLITROW                                                
*                                                                               
         TM    KYWIND5,KYWSPDR     SPLIT DEBITS ONLY?                           
         BZ    BLDROW54                                                         
         OI    ROWKYIND,ROWKYSDR                                                
*                                                                               
BLDROW54 TM    KYWIND1,KYWNME                                                   
         BZ    *+8                                                              
         OI    ROWKYIND,ROWNME                                                  
         TM    KYWIND1,KYWCDE                                                   
         BZ    *+8                                                              
         OI    ROWKYIND,ROWCDE                                                  
         TM    KYWIND1,KYWHXF                                                   
         BZ    *+8                                                              
         OI    ROWKYIND,ROWKYXFF                                                
         TM    KYWIND1,KYWUNQ                                                   
         BZ    *+8                                                              
         OI    ROWFLAGS,ROWUNQ                                                  
         TM    KYWIND5,KYW1SIDE    One side of postin is unique                 
         BZ    *+8                 No                                           
         OI    ROWFLAGS,ROW1SIDE   Yes, so set                                  
*                                                                               
         LH    RE,FMTKEYLN         DISPLACEMENT INTO KEY                        
         AHI   RE,1                MOVE UP ONE FOR RECAP                        
         STH   RE,ROWKYDSP         SAVE DISPLACEMENT OF KEY                     
         SR    RF,RF                                                            
         TM    ROWXPIND,ROWNOSRT   No data really in SORTKEY                    
         BO    BROW054A                                                         
         ICM   RF,3,KYWSRTQ        Get SORTKEY length                           
         CLI   OVERSZ,0            Over-ride size                               
         BE    BROW054A                                                         
         LLC   RF,OVERSZ           New SORTKEY length size                      
BROW054A AHI   RF,1                Add one for recap                            
         STCM  RF,3,ROWKYSZ                                                     
*                                                                               
         MVC   ROWTYPE,RRWTYPE     Save row type(COL,MID,HEAD)                  
         MVC   ROWPRTAD,TOTFORAD   Set row printing postition                   
         MVC   ROWPRTSZ,TOTFORSZ   Room to print in                             
         CLI   ROWTYPE,ROWCOL      Is row made from column then                 
         BNE   BLDROW58            No                                           
         STCM  R3,7,COLAROW+1      Save A(ROW) in column row pointer            
         TM    ROWXPIND,ROWNOSRT                                                
         BO    BROW055                                                          
         LH    RE,FMTKEYLN         Current sort key length                      
         AHI   RE,1                One for recap                                
         STH   RE,COLDSP           Displacement to data in sort key             
         TM    COLFLAGS,COLHIDE    Hidden column ?                              
         BZ    *+12                No                                           
         TM    ROWFLAGS,ROWTOTAL   Yes, so total on row ?                       
         BO    BLDROW58            Yes, so skip                                 
*                                                                               
BROW055  MVC   ROWPRTAD,COLPRT     PRINT TOTAL AT COLUMN                        
         MVC   ROWPRTSZ,COLSIZE    PRINT COLUMN SIZE IS COL SIZE                
         SR    R1,R1                                                            
         IC    R1,COLSIZE                                                       
         TM    COLOPT,COLCHUNK     SUPPER COLUMN TYPE ?                         
         BO    BLDRW54B            YES                                          
         OC    SVCOLPRT,SVCOLPRT   WAS COLUMN PRIOR TO THIS CHUNKED ?           
         BNZ   BLDRW54A                                                         
         TM    FMTPOPT2,RPFEXCOL   EXTEND COLUMN PAST LINE?                     
         BO    BLDRW54E            YES CHECK EXTEND COLUMN OPTION               
         B     BLDROW60                                                         
*                                                                               
BLDRW54A MVC   ROWPRTAD,SVCOLPRT   SAVE OFF FIRST OF CHUNK                      
         MVC   ROWPRTSZ,SVCOLSZ    SET TO 1ST CHUNKED COLUMN                    
         XC    SVCOLPRT,SVCOLPRT   RE-INITIALIZE                                
         B     BLDROW60                                                         
*                                                                               
BLDRW54B OC    SVCOLPRT,SVCOLPRT   DID WE SAVE A VALUE ALREADY ?                
         BZ    BLDRW54D            NO, SO NOT SET                               
         MVC   ROWPRTAD,SVCOLPRT   SAVE OFF 1ST OF CHUNK                        
         MVC   ROWPRTSZ,SVCOLSZ    SET TO 1ST CHUNKED COLUMN                    
         B     BLDROW60                                                         
*                                                                               
BLDRW54D TM    COLFLAGS,COLHIDE                                                 
         BO    BLDROW60            HIDDEN, DON'T SET YET                        
         MVC   SVCOLPRT,COLPRT                                                  
         MVC   ROWPRTAD,COLPRT     SAVE OFF FIRST COL OF CHUNK GROUP            
*                                                                               
NXT      USING COLD,RE                                                          
BLDRW54E SR    RF,RF                                                            
         LR    RE,R4               INITIALIZE RE TO CURRENT COL ENTRY           
*                                                                               
BLDRW54F CLC   NXT.COLNUM,FMT#COLS ANY  MORE COLUMNS?                           
         BE    BLDROW60            NO,  SO LEAVE ALONE                          
         STC   R1,SVCOLSZ          NEW SIZE                                     
         STC   R1,ROWPRTSZ         SET TO CURRENT SIZE CALCULATED               
         AHI   RE,COLLNQ           BUMP TO NEXT COLUMN                          
         TM    NXT.COLFLAGS,COLAMT IF AN AMOUNT COLUMN THEN                     
         BO    BLDROW60            THAT ENDS POSSIBLE PRINT AREA                
         TM    COLFLAGS,COLHIDE                                                 
         BO    BLDRW54F            IGNORE HIDDEN COLUMNS                        
         IC    RF,NXT.COLSIZE      GET  THIS COLUMN SIZE AND                    
         AR    R1,RF               ADD  TO PREVIOUS SIZE                        
         TM    FMTPOPT2,RPFEXCOL   EXTEND COLUMN PAST LINE?                     
         BO    BLDRW54F                                                         
         TM    NXT.COLOPT,COLCHUNK                                              
         BO    BLDRW54F            KEEP ADDING THE COLS SIZE TOGETHER           
         STC   R1,SVCOLSZ          LAST ONE FOR CHUNK GROUP                     
         STC   R1,ROWPRTSZ         SET TO CURRENT SIZE CALCULATED               
         B     BLDROW60            FINISHED                                     
         DROP  NXT                                                              
*                                                                               
BLDROW58 CLI   ROWTYPE,ROWMID      IS IT A MIDLINE?                             
         BNE   BLDROW60            NO                                           
         CLI   COLSIZE,5           MIN. ROOM FOR DATA TO FIT                    
         BNH   BLDROW60                                                         
         SR    R1,R1                                                            
         IC    R1,TOTFORSZ         SIZE TO PRINT "TOTAL FOR ..."                
         SHI   R1,DENTMID          INDENT FOR MIDLINE                           
         STC   R1,TOTFORSZ         SAVE NEW SIZE                                
         IC    R1,COLSIZE          ADJUST FIRST COLUMN BY SIZE                  
         SHI   R1,DENTMID          INDENT                                       
         STC   R1,COLSIZE          SAVE NEW COLUMN SIZE                         
         ICM   R1,15,TOTFORAD      LOAD ADDR. WHERE TO PRINT                    
         BZ    *+8                                                              
         AHI   R1,DENTMID          ADJUST BY INDENTING                          
         ST    R1,TOTFORAD         SAVE NEW ADJUSTMENT                          
         ST    R1,COLPRT           SAVE IN ADDRESS IN COL. PRINTING             
*                                                                               
BLDROW60 CLI   KYWREAD,KYWPRNP     READ PLANNING ESTIMATE # KEYWORD             
         BE    *+8                 YES, PROCESS IT                              
         CLI   KYWREAD,KYWPRNR     READ REVISION # KEYWORD                      
         BNE   BLDROW61            NO,  SKIP                                    
         CLI   ROWTYPE,ROWCOL      ROW  MADE FROM COLUMN ?                      
         BNE   BLDRW60A            YES, SKIP SINCE ALREADY DONE                 
         MVC   ROWPRNE#,COLJOBRC                                                
         B     BLDROW61                                                         
*                                  PROCESS PLANNING EST/REVISION #              
BLDRW60A GOTO1 =A(BLDPRN),DMCB,(R6),ROWPRNE#,RRWXDATA                           
*                                                                               
BLDROW61 DS    0H                                                               
         TM    DWNOPT1,DWNGO+DWNCHOP DOWN-LOADING WITH FIXED SIZE ?             
         BNO   *+10                  NO,  SKIP                                  
         MVC   ROWPRTSZ,DWNROWPS     YES, USE DEFAULT ROW PRINT SIZE            
*                                                                               
         TM    ROWXPIND,ROWNOSRT   Row is a none sort data type                 
         BO    BROW061             Yes                                          
         SR    R1,R1                                                            
         ICM   R1,3,ROWKYSZ                                                     
         TM    ROWOPT,ROWUDEF      USER DEFINED?                                
         BZ    *+10                                                             
         LLC   R1,UDEFSRTS         OVER RIDE SIZE                               
         AH    R1,FMTKEYLN         BUMP UP IN KEY OR DATA AREA                  
         STH   R1,FMTKEYLN         NEW DISPLACEMENT                             
*                                                                               
BROW061  CLI   FMTRNK#1,C'R'                                                    
         BNE   BROW061C                                                         
         CLC   ROWNUM,FMTRNK#1+1   RANK ON (VERT. TOTAL) ROW NUMBER             
         BNE   BROW061C                                                         
         MVC   FMTRNKON,FMTKEYLN                                                
         CLC   BFLKEYLN,FMTRNKON                                                
         BH    BROW061C                                                         
         MVC   BFLKEYLN,FMTRNKON   New BUFFALO key length                       
*                                                                               
BROW061C SR    R1,R1                                                            
         CLI   ROWDATES,0                                                       
         BNE   BLDROW65            IGNORE IF SET                                
         ICM   R1,3,KYWLINK        GET LINK TO NAME OR CODE                     
         BNZ   BLDROW62            IS THERE CORRISPONDING NAME/CODE?            
         TM    KYWIND1,KYWCDE+KYWNME        SPECIAL CASE                        
         BO    BLDROW65                                                         
         TM    KYWIND1,KYWCDE      IS CODE ON?                                  
         BZ    *+8                 NO                                           
         NI    ROWFLAGS,TURNOFF-ROWNME                                          
         TM    KYWIND1,KYWNME      IS NAME ON?                                  
         BZ    BLDROW65            NO                                           
         NI    ROWFLAGS,TURNOFF-ROWCDE                                          
         B     BLDROW65            NO                                           
*                                                                               
BLDROW62 LR    R6,R1                                                            
         A     R6,KYWBASE                                                       
         TM    ROWFLAGS,ROWCDE                                                  
         BZ    BLDROW63                                                         
         TM    KYWIND1,KYWCDE      IS CODE BIT SET?                             
         BZ    BLDROW63            NO, SO DON'T NEED                            
         OI    ROWDAIND,ROWDACDE                                                
         B     BLDROW64                                                         
*                                                                               
BLDROW63 CLC   =C'POAN',KYWCODE    Force name for POA keyword                   
         BNE   *+12                so that data is stored in RECXD area         
         OI    ROWKYIND,ROWCDE     of sort record instead of key sort           
         B     BLDROW64                                                         
         TM    ROWFLAGS,ROWNME     IS NAME BIT SET?                             
         BZ    BLDROW65            NO                                           
         TM    KYWIND1,KYWNME      IS NAME BIT SET?                             
         BZ    BLDROW65            NO, SO DON'T NEED                            
*                                                                               
BLDROW64 MVC   ROWDADSP,FMTDATLN   SAVE ALSO IN ROW INFO                        
         MVC   ROWDASZ,KYWSRTQ+1   SAVE SIZE OF FIELD                           
         TM    KYWIND1,KYWHXF                                                   
         BZ    *+8                                                              
         OI    ROWDAIND,ROWDAXFF                                                
         TM    KYWIND1,KYWUNQ                                                   
         BZ    *+8                                                              
         OI    ROWFLAGS,ROWUNQ                                                  
         XR    R1,R1                                                            
         ICM   R1,3,KYWSRTQ        SIZE OF FIELD USED                           
         TM    ROWOPT,ROWUDEF      USER DEFINED?                                
         BZ    *+10                                                             
         LLC   R1,UDEFDATS         OVER RIDE SIZE                               
         AH    R1,FMTDATLN         BUMP UP DISP FOR DATA                        
         STH   R1,FMTDATLN         SAVE                                         
*                                                                               
BLDROW65 MVI   ROWNREC,0           CLEAR OUT                                    
         MVI   ROWSTATE,ROWIDLE    IDLE THIS ROW (DO NOTHING)                   
         CLI   ROWTYPE,ROWMID                                                   
         BNE   *+8                                                              
         MVI   ROWSTATE,ROWPTMID   PRINT A MIDLINE                              
*                                                                               
         L     RE,PTRACM           CREATE ROW OF ACCUMULATORS                   
         ST    RE,ROWACM                                                        
         SR    R1,R1                                                            
         ICM   R1,1,FMT#ACMS       CLEAR OUT ACCUMS, FIRST TIME                 
         BZ    BLDROW70                                                         
*                                                                               
         ZAP   0(PKLEN,RE),PKZERO  ZERO IT OUT                                  
         AHI   RE,PKLEN                                                         
         BCT   R1,*-10                                                          
         ST    RE,PTRACM           STORE NEW ADDR.                              
*                                                                               
BLDROW70 ZIC   RF,RRWDATLN                                                      
         LA    R1,RRWNDATA(RF)     Point to end of data                         
         ICM   RF,1,RRWPFXLN       Prefix length                                
         BZ    BLDROW75            No prefix                                    
         L     RE,PTRFDATA         Free form data pool                          
         ST    RE,ROWPRFX          Save address location                        
         STC   RF,ROWPRFX          Save length in high order byte               
         BCTR  RF,0                                                             
         EXMVC RF,0(RE),0(R1)      Move in prefix                               
         LA    RE,1(RF,RE)         Bump up for next free form location          
         ST    RE,PTRFDATA         Save new address for free form POOL          
*                                                                               
BLDROW75 SR    R1,R1                                                            
         IC    R1,RRWLN                                                         
         AR    R2,R1                                                            
         AHI   R3,ROWLNQ           Bump up to next row                          
         B     BLDROW20                                                         
*                                                                               
BLDROW99 ST    R3,PTRROW           Save A(Free area for next row)               
         SHI   R3,ROWLNQ                                                        
         ST    R3,FMTLROW          Save A(Last row) for this format             
         SR    RF,RF                                                            
         ICM   RF,3,BFLKEYLN                                                    
         BZ    BLDROWX                                                          
         AHI   RF,RECXDQ           Add extra key data length                    
         STH   RF,BFLKEYLN         Increase size of buffalo key                 
*                                                                               
BLDROWX  CLI   ERROR#,0                                                         
         B     FMTXIT                                                           
         SPACE 1                                                                
SVCOLSZ  DS    XL1                                                              
SVCOLPRT DS    A                                                                
         EJECT                                                                  
***********************************************************************         
*        Add address to replace table entry                           *         
***********************************************************************         
         USING ROWD,R3                                                          
         USING UTABD,R2                                                         
ADDREPL  NTR1                                                                   
         ICM   R2,15,FMTCONS       Are there any of these                       
         BZ    ADRPLXIT            No, so exit                                  
*                                                                               
ADRPL10  CLI   0(R2),EOT           End of table                                 
         BE    ADRPLXIT            Yes                                          
         CLI   UTABTYPE,UTABROW    Is it a row?                                 
         BNE   ADRPL20             No, type column                              
         CLC   ROWNUM,UTABNUM      Match on row number                          
         BE    ADRPL50                                                          
         B     ADRPL80             Try next in list                             
*                                                                               
         USING COLD,R4                                                          
ADRPL20  CLI   UTABTYPE,UTABCOL   Is it a column ?                              
         BNE   ADRPL30                                                          
         ICM   R4,15,ROWACOL      Load col associated with row                  
         BZ    ADRPL30                                                          
         CLC   COLNUM,UTABNUM                                                   
         BE    ADRPL50                                                          
         B     ADRPL80                                                          
*                                                                               
ADRPL30  CLI   UTABTYPE,UTABXTRN   External table                               
         BNE   ADRPL80                                                          
                                                                                
         TM    TABIND,TABXTRN                                                   
         BO    *+6                                                              
         DC    H'00'               This bit needed to be on                     
                                                                                
         SR    RE,RE                                                            
         ICM   R4,15,ROWACOL      Load col associated with row                  
         BZ    *+10                                                             
         MVC   ROWXTRN#,COLXTRN#                                                
                                                                                
         USING SUBTABD,RE                                                       
         ICM   RE,1,ROWXTRN#                                                    
         BZ    ADRPL80             Not this row                                 
         BCTR  RE,0                                                             
         MHI   RE,SUBTLNQ                                                       
         A     RE,@SUBTAB                                                       
         L     R2,SUBDATA          A(Data)                                      
         MVC   OVERSZ,SUBMAXL      Adjustment of sort size                      
         DROP  RE                                                               
*                                                                               
ADRPL50  ST    R2,ROWCON                                                        
         TM    UTABHIND,UTABSUBT   Substitute table                             
         BZ    ADRPLXIT                                                         
         OI    ROWXPIND,ROWREPTB   Replacement table active                     
         LA    RE,UTABDHDR                                                      
         ST    RE,ROWCON                                                        
         B     ADRPLXIT                                                         
*                                                                               
ADRPL80  ICM   RF,15,UTABLEN       Length of entry                              
         BZ    ADRPLXIT                                                         
         AR    R2,RF                                                            
         B     ADRPL10                                                          
*                                                                               
ADRPLXIT B     FMTXIT                                                           
         DROP  R2,R3,R4,R5,R7                                                   
         EJECT                                                                  
         USING RHDELD,R2                                                        
         USING HEADD,R4                                                         
         USING FMTRECD,R5                                                       
         USING KYWD,R6                                                          
         USING ACRL2D,R7                                                        
BLDHEAD  NTR1                                                                   
         MVI   FMTFOOT,0           NO FOOTLINE DETECTED YET                     
         L     R2,AIO2                                                          
         MVI   ELCODE,RHDELQ       GET HEAD ELEMENTS                            
         BAS   RE,GETEL                                                         
         BE    BLDHD05                                                          
         L     R2,AIO2                                                          
         AHI   R2,ACCORFST                                                      
*                                                                               
BLDHD05  MVI   FMT#HEAD,0          INITIALIZE TO ZERO                           
         L     R4,PTRRHEAD         CURRENT LOC. TO PUT HEAD INFO                
         ST    R4,FMTHEAD          SAVE FOR FORMAT                              
         TM    FMTROPT1,RPFIDRFT+RPFODRFT                                       
         BZ    BLDHD10                                                          
         XC    HEADD(HEADLNQ),HEADD                                             
         MVI   FMT#HEAD,1          UP IT BY ONE                                 
         MVI   HEADNUM,1                                                        
         MVI   HEADLN,L'AC@DRFIT   DEFAULT LENGTH                               
         MVI   HEADFLAG,HEADFREE   FREE FORM DATA                               
         MVI   HEADTYPE,RHDRHTH    RIGHT HEADING                                
         MVC   HEADINDX,KYWBASE                                                 
         L     RE,PTRFDATA         FREE FORM POOL                               
         ST    RE,HEADPTR                                                       
         MVC   0(L'AC@DRFIT,RE),AC@DRFIT                                        
         LA    RE,L'AC@DRFIT+1(,RE)                                             
         ST    RE,PTRFDATA                                                      
         AHI   R4,HEADLNQ                                                       
*                                                                               
BLDHD10  CLI   0(R2),RHDELQ        IS IT A HEADING ELEMENT                      
         BE    BLDHD20             NO, SO BUILD HEAD INFO                       
         CLI   0(R2),0             IS IT END OF POOL?                           
         BE    BLDHD99             YES, FINISHED                                
         L     R2,HEADWRK                                                       
         B     BLDHD10                                                          
*                                                                               
BLDHD20  XC    HEADD(HEADLNQ),HEADD        CLEAR OUT AREA                       
         CLI   RHDTYPE,RHDLIST             LIST TYPE IGNORE                     
         BE    BLDHD52                                                          
         SR    R1,R1                                                            
         IC    R1,FMT#HEAD         CURRENT HEAD COUNT                           
         AHI   R1,1                HAVE ONE, INCREMENT                          
         STC   R1,FMT#HEAD         SAVE NEW AMOUNT                              
         STC   R1,HEADNUM          SEQ LABEL THIS HEAD INFO                     
*                                                                               
         MVC   HEADFLAG,RHDFRM     SAVE ELEM INFO (FREE FORM/DEFINED)           
         NI    HEADFLAG,TURNOFF-RHDDICT                                         
         MVC   HEADSEQ,RHDSEQ      SEQUENCE NUMBER                              
         TM    HEADFLAG,HEADROW    IS IT A ROW HEADING?                         
         BO    BLDHD22                                                          
         CLI   RHDPSEQ,0           STEREO OVERIDE PRINT SEQUNECE?               
         BE    BLDHD22                                                          
         MVC   HEADSEQ,RHDPSEQ                                                  
*                                                                               
BLDHD22  MVC   HEADTYPE,RHDTYPE    TITLE/RIGHT/LEFT/FOOT?                       
         CLI   RHDTYPE,RHDFTLN     IS IT A FOOTLINE?                            
         BNE   *+8                                                              
         OI    FMTFOOT,FMTFTON     YES FOOTLINE DETECTED                        
         IC    R1,RHDLN            DATA LENGTH FORM INPUT SCREEN                
         SHI   R1,RHDLNQ                                                        
*                                                                               
         TM    HEADFLAG,HEADDEF    IS IT A DEFINED TYPE?                        
         BO    BLDHD30             YES SO BRANCH                                
         TM    HEADFLAG,HEADROW    IS IT A ROW HEADING?                         
         BO    BLDHD35             YES SO BRANCH                                
***********************************************************************         
*              ADD FREE FORM TYPE HEADING                             *         
***********************************************************************         
         SPACE 1                                                                
         L     RE,PTRFDATA         FREE FORM DATA                               
         ST    RE,HEADPTR          CURR POINTER INTO FREE FORM TBL              
         MVI   HEADPTR,EDTMVC                                                   
         STC   R1,HEADLN           STORE LENGTH OF DATA FOR PRINTING            
         BCTR  R1,0                                                             
         EXMVC R1,0(RE),RHDDATA                                                 
         L     R6,KYWBASE                                                       
         LA    RE,1(R1,RE)         BUMP UP ADDRESS                              
         ST    RE,PTRFDATA         SAVE NEW CURRENT LOCATION                    
         B     BLDHD50                                                          
***********************************************************************         
*              ADD DEFINED TYPE HEADING                               *         
***********************************************************************         
         SPACE 1                                                                
BLDHD30  CLI   RHDTYPE,RHDFTLN     IS IT A FOOTLINE?                            
         BNE   *+8                                                              
         OI    FMTFOOT,FMTFTVAR    FOOTLINE IS A MACRO, IT MAY VARY             
         MVC   FINDDATA,SPACES     NO ITS A DEFINED HEADING TYPE                
         XC    KEYWRD#,KEYWRD#                                                  
         MVI   XDATA,0                                                          
         TM    RHDFRM,RHDDICT      DICTIONARY FORM ?                            
         BZ    BLDHD31             NO                                           
         MVC   KEYWRD#,RHDDATA                                                  
         B     BLDHD32                                                          
*                                                                               
BLDHD31  SHI   R1,2                ONE FOR "EX" AND ONE FOR "&"                 
         EXMVC R1,FINDDATA,RHDDATA+1                                            
*                                                                               
BLDHD32  GOTO1 =A(KYWFIND)                                                      
         LTR   R6,R6                                                            
         BNZ   *+6                 FOUND KEYWORD                                
         DC    H'00'               SOMETHING IS WRONG                           
*        BZ    FMTXIT                                                           
*                                                                               
         CLC   KYWDD#,=AL2(AC#RSBLK)                                            
         BNE   BLDHD40                                                          
         MVC   HEADLN,RHDXDATA     MOVE #  OF LINES TO SKIP                     
         B     BLDHD42                                                          
***********************************************************************         
*  ADD ROW TYPE HEADING                                               *         
***********************************************************************         
         SPACE 1                                                                
         USING ROWD,R3                                                          
BLDHD35  CLI   HEADTYPE,RHDCNTR    IS CENTER TYPE ROW?                          
         BNE   *+8                                                              
         MVI   HEADTYPE,C'M'       SORT THESE DIFFERENTLY                       
         ICM   R3,15,RHDDATA       POINT TO ROW DATA                            
         L     R6,ROWINDEX         KEYWORD ENTRY                                
         STCM  R3,7,HEADPTR+1      SAVE ROW ADDRESS IN HEAD INFO                
         MVI   HEADLN,55           ALLOW 55 CHARACTERS TO PRINT                 
         MVC   HEADOPTS,ROWFLAGS                                                
         NI    HEADOPTS,HEADNME+HEADCDE                                         
         CLI   HEADTYPE,RHDRHTH    RIGHT HEADING HAS RESTRICTION                
         BNE   BLDHD35A                                                         
         LH    RE,MAXINDNT         LENGTH OF AREA TO PRINT IN                   
         BCTR  RE,0                LESS ONE TO ADJUST                           
         STC   RE,HEADLN           SAVE LENGTH                                  
         SR    RF,RF                                                            
         ICM   RF,1,ROWPRFX        LENGTH OF ROW PREFIX, IF ANY                 
         BZ    BLDHD35A            NONE                                         
         SR    RE,RF               LENGTH LESS PREFIX LENGTH                    
         STC   RE,HEADLN           ADJUSTED LENGTH                              
*                                                                               
BLDHD35A TM    HEADFLAG,HEADADR    DO WE WANT AN ADDRESS?                       
         BO    BLDHD36                                                          
         MVC   HEADDISP,ROWKYDSP                                                
         B     BLDHD50                                                          
*                                                                               
BLDHD36  SR    R1,R1                                                            
         ICM   R1,3,KYWADDR        KEYWORD -> DATA FOR KEYWORD ADDRESS          
         BZ    BLDHD40             NO KEYWORD                                   
         L     R6,KYWBASE          INDEX TO ADDRESS ENTRY                       
         AR    R6,R1               POINT TO NEW     ENTRY                       
         OI    ROWXPIND,ROWXPADR   INDICATE ROW ADDRESS POINTER                 
         MVC   ROWXPSIZ,KYWSRTQ+1  NAME SIZE                                    
         MVC   ROWXPDSP,FMTDATLN   DISPLACEMENT INTO SORTREC                    
         B     BLDHD42                                                          
*                                                                               
         USING EDITD,R1                                                         
BLDHD40  MVI   HEADLN,55           ALLOW 55 CHARACTERS TO PRINT                 
         CLI   HEADTYPE,RHDRHTH    RIGHT HEADING HAS RESTRICTION                
         BNE   *+10                                                             
         MVC   HEADLN,MAXINDNT+1   STORE LENGTH FOR PRINTING                    
         ICM   R1,3,KYWEDIT        BASE OF EDIT TABLE                           
         BZ    BLDHD42                                                          
         A     R1,EDTBASE                                                       
         CLI   EDITTYPE,STORAGE    OVERRIDE PRINT LENGTH?                       
         BNE   BLDHD42                                                          
         OC    KYWSRTQ,KYWSRTQ                                                  
         BZ    *+10                                                             
         MVC   HEADLN,KYWSRTQ+1    LENGTH IF AREA TO PRINT IN                   
         CLI   EDITSIZE,0          OVERRIDE PRINT LENGTH?                       
         BE    *+10                                                             
         MVC   HEADLN,EDITSIZE     LENGTH IF AREA TO PRINT IN                   
         DROP  R1                                                               
*                                                                               
BLDHD42  OC    KYWPRSE,KYWPRSE     IS THERE A PARSE ROUTINE ?                   
         BZ    BLDHD50             NO, NO PARSE ROUTINE AVAILABLE               
         MVC   HEADDISP,FMTDATLN   NEXT AVAILABLE DISP FOR DATA                 
         SR    R1,R1                                                            
         ICM   R1,3,KYWSRTQ        BUMP UP LENGTH OF FIELD                      
         AH    R1,FMTDATLN                                                      
         STH   R1,FMTDATLN         SAVE NEW LOC OF AVAILABLE SPACE              
*                                                                               
BLDHD50  ST    R6,HEADINDX         SAVE A(KEYWORD)->SEND A DONATION NOW         
         AHI   R4,HEADLNQ          BUMP UP IN HEAD TBL INFO                     
*                                                                               
BLDHD52  SR    R1,R1                                                            
         IC    R1,RHDLN            GET NEXT ELEMENT                             
         AR    R2,R1                                                            
         B     BLDHD10             LOOP FOR NEXT ELEMENT                        
*                                                                               
BLDHD99  SR    R6,R6                                                            
         ICM   R6,1,FMT#HEAD       Any headings built ?                         
         BZ    FMTXIT              No                                           
         GOTO1 XSORT,DMCB,FMTHEAD,(R6),HEADLNQ,2,HEADTYPE-HEADD                 
         ST    R4,PTRRHEAD         Save for next format                         
*                                                                               
         L     R4,FMTHEAD                                                       
BLDHD99A CLI   HEADTYPE,C'M'                                                    
         BNE   *+8                                                              
         MVI   HEADTYPE,RHDCNTR    Restore original CHAR                        
         AHI   R4,HEADLNQ                                                       
         BCT   R6,BLDHD99A                                                      
*                                                                               
         B     FMTXIT                                                           
         DROP  R3,R4,R5                                                         
         EJECT ,                                                                
FMTXIT   XIT1                                                                   
         SPACE 3                                                                
         GETEL R2,DATADISP,ELCODE                                               
         SPACE 3                                                                
OVERSZ   DS    XL1                                                              
                                                                                
         LTORG                                                                  
         DROP  R8,R9                                                            
         EJECT                                                                  
FIRSTROW DC    X'C2'                          RRWEL                             
         DC    AL1(RRWNLNQ+6)                 RRWLN                             
         DC    AL1(0)                         RRWSEQ                            
         DC    AL1(RRWTOT+RRWCODE+RRWNEWEL)   RRWOPT                            
         DC    C'N'                           RRWTYPE                           
         DC    AL1(0)                         RRWOPT2                           
         DC    AL1(0)                         RRWDATES                          
         DC    AL1(0)                         RRWPSEQ                           
         DC    AL1(0)                         RRWSPCL                           
         DC    AL1(6)                         RRWDATLN                          
         DC    AL1(0)                         RRWPFXLN                          
         DC    AL1(0,0)                       SPARE                             
         DC    AL1(0)                         RRWXDATA                          
         DC    AL1(0,0,0)                     SPARE                             
         DC    CL6'1STROW'                    RRWNDATA                          
         DC    AL1(EOT)                                                         
         SPACE 3                                                                
         EJECT ,                                                                
***********************************************************************         
*  CASHFLOW AVERAGE DAYS ROW COLUMN COMPATABILITY                     *         
*        ON ENTRY - R1=ROW KYWDD#                                     *         
***********************************************************************         
*&&US                                                                           
         USING ROWD,R3                                                          
         USING COLD,R4                                                          
         USING FMTRECD,R5                                                       
CFADRCC  NTR1  BASE=*,LABEL=*                                                   
         L     R4,FMTCOL                 Point to column infor                  
         ZIC   R0,FMT#COLS               Number of columns                      
CFADRC20 CLC   COLDD#,=AL2(AC#RSADA)     Look for ADAYS column                  
         BE    CFADRC30                                                         
         CLC   COLDD#,=AL2(AC#RSBAV)     Look for BADAYS column                 
         BE    CFADRC30                                                         
CFADRC25 LA    R4,COLLNQ(,R4)                                                   
         BCT   R0,CFADRC20                                                      
         B     CFADRCCX                                                         
CFADRC30 ICM   RF,15,COLRTOTS            Supress column total                   
         LA    R1,1                                                             
         ZIC   RE,ROWNUM                                                        
         BCTR  RE,0                                                             
         SLL   R1,0(RE)                  Find row for column                    
         XR    RF,R1                     Isolate bit then test                  
         STCM  RF,15,COLRTOTS            If bit on supress total                
         B     CFADRC25                                                         
CFADRCCX XIT1                                                                   
         LTORG                                                                  
         DROP  R3,R4,R5                                                         
*&&                                                                             
         EJECT                                                                  
***********************************************************************         
*  RUN FIRST MODE, INITIALIZE AND SETUP ADDRESSABILITY                *         
***********************************************************************         
         SPACE 1                                                                
         USING ACWORKD,RC                                                       
         USING ACRLD,RA                                                         
         USING ACRL2D,R7                                                        
FMTINIT  NTR1  BASE=*,LABEL=*                                                   
         MVI   POSTCTL,0                                                        
         TM    DDLNKIND,DDLNKINT   DDLINK initialized ?                         
         BO    FMTINI03                                                         
         MVC   BUDBLD,=A(ABUDBLD)                                               
         MVC   SETBUFF,=A(ASETBUFF)                                             
*&&US*&& MVC   ABRNBLD,=A(BRNBUILD)                                             
*&&US*&& MVC   BRNDDCB,=A(BRNDWRK)                                              
         MVC   AGETCNDR,=A(GETCNDR)                                             
         MVC   GETFORMT,=A(GFORMAT)                                             
         MVC   ADATEFMT,=A(DATEFMT)                                             
         MVC   ASETACT,=A(SETACT)                                               
         LHI   R1,FMTLNQ                                                        
         STH   R1,FMTLEN                                                        
*                                                                               
         USING ACMD,R3                                                          
FMTINI03 L     R3,AMONACC                                                       
         MVC   ADDEL,ACMVHELO                                                   
         MVC   SECALPHA,ACMPFAGY   ALPHA AGENCY                                 
         SR    R1,R1                                                            
         IC    R1,RCLANG                                                        
         MHI   R1,16               LENGTH OF ENTRY OF FIRST TABLE               
         A     R1,AUPCASE          FIND CORRECT TABLE FOR UPPER CASE            
         MVC   AUPCASE,8(R1)       A(Upper case "TR" table)                     
         MVC   AMIXCASE,12(R1)     A(Mix   case "TR" table)                     
         L     RE,AMIXCASE                                                      
         MVI   0(RE),BLANK         Change x'00' to x'40'                        
                                                                                
         XC    CSTMTHDS,CSTMTHDS   NUMBER OF METHODS                            
*                                                                               
*&&UK*&& MVC   DATE#8,=CL8'DDMMMYY'                                             
*&&US                                                                           
         MVC   DATE#8,=CL8'MMMDD/YY'                                            
         CLI   RCLANG,LANGENG                                                   
         BE    *+10                                                             
         MVC   DATE#8,=CL8'DDMMMYY'                                             
*&&                                                                             
         CLI   RCLANG,LANGGER                                                   
         BNE   *+10                                                             
         MVC   DATE#8,=CL8'MM.DD.YY'                                            
         GOTO1 DATCON,DMCB,(4,RCDATE),(8,REQDATE)                               
         GOTO1 DATCON,DMCB,(4,RCDATE),(1,TDDATE)                                
         GOTO1 DATCON,DMCB,(4,RCDATE),(0,TODAYC)                                
         MVC   UPFRONT,SPACES                                                   
         EJECT                                                                  
***********************************************************************         
*  GET DESTINATION NAME AND ADDRESS FORM IDI RECORD                   *         
***********************************************************************         
         SPACE 1                                                                
         USING CTIREC,R2                                                        
         USING CPYELD,R3                                                        
         MVI   OFFADRLN,0          NO LINES OFF ADDRESS                         
         MVC   OFFNAME,SPACES      CLEAR ADDRESS AREA                           
         MVC   OFFADDR(2*L'OFFADDR),SPACES                                      
*                                                                               
         L     R2,AIO2                                                          
         L     R3,ADCMPEL                                                       
         TM    CPYSTAT5,CPYSNCST   NEW COST                                     
         BZ    *+8                                                              
         MVI   EXPSTAT,EXPNCOST                                                 
                                                                                
         XC    CTIKEY,CTIKEY                                                    
         MVI   CTIKTYP,CTIKTYPQ    IDI RECORD "I"                               
         MVC   CTIKNUM,ORIGINUM    ORIGIN ID                                    
         MVC   IOKEY(L'CTIKEY),CTIKEY                                           
         MVC   DESTID,SPACES                                                    
         L     R1,=AL4(IOREAD+IOCNTRL+IOAREA2)                                  
         GOTO1 AIO                                                              
         BNE   FMTINI15                                                         
*                                                                               
         LA    R2,CTIDATA          POINT TO FIRST ELEMENT                       
         SR    R1,R1                                                            
FMTINI05 CLI   0(R2),0                                                          
         BE    FMTINI15                                                         
*                                                                               
         USING CTDSCD,R2                                                        
         CLI   0(R2),CTDSCELQ      X'02'                                        
         BNE   FMTINI08                                                         
         IC    R1,1(,R2)                                                        
         AHI   R1,-(CTDSC-CTDSCD+1)                                             
         EXMVC R1,DESTID,CTDSC                                                  
         DROP  R2                                                               
*                                                                               
FMTINI08 CLI   0(R2),CTDSTELQ      X'30'                                        
         BE    FMTINI10                                                         
         IC    R1,1(,R2)           GET ELEMENT LENGHT                           
         AR    R2,R1                                                            
         B     FMTINI05            LOOP TO NEXT ELEMENT                         
*                                                                               
         USING CTDSTD,R2                                                        
FMTINI10 MVI   OFFADRLN,1                                                       
         MVC   OFFNAME,CTDSTNAM                                                 
         MVC   OFFADDR,CTDSTADD                                                 
         CLI   CTDSTLEN,166                                                     
         BNE   FMTINI15                                                         
         CLC   CTDSTAD2,SPACES                                                  
         BE    FMTINI15                                                         
         MVI   OFFADRLN,2                                                       
         MVC   OFFADDR+L'OFFADDR(L'OFFADDR),CTDSTAD2                            
*                                                                               
FMTINI15 L     R3,ADCMPEL                                                       
         MVC   FSCLMONB,CPYSFST                                                 
         SR    R1,R1                                                            
         ICM   R1,1,CPYSFST        Get month value - character form             
         BNZ   *+8                                                              
         MVI   FSCLMONB,C'1'       Default to January                           
                                                                                
         CLI   FSCLMONB,C'1'                                                    
         BL    FMTINI16                                                         
         NI    FSCLMONB,TURNOFF-X'F0'  Convert C'1' to C'9'                     
         MVC   FSCLMONP,FSCLMONB       Same in pack as in binary                
         B     FMTINI20                                                         
*                                                                               
FMTINI16 CLI   FSCLMONB,C'C'                                                    
         BNH   *+6                 JAN-SEP                                      
         DC    H'00'               What month is this ?                         
                                                                                
         SHI   R1,X'B1'                                                         
         STC   R1,FSCLMONP         Save off packed value                        
         SHI   R1,X'06'                                                         
         STC   R1,FSCLMONB         Save off binary value                        
***********************************************************************         
*  GET COMPANY NAME AND ADDRESS AND SAVE                                        
***********************************************************************         
         SPACE 1                                                                
FMTINI20 MVI   COMPNAME,C' '                     CLEAR OUT AREA                 
         MVC   COMPNAME+1(LNLEN-1),COMPNAME                                     
         L     R3,ADCMPNAM                                                      
         ZIC   R6,1(,R3)                                                        
         SHI   R6,3                                                             
         EXMVC R6,COMPNAME,2(R3)                                                
*                                                                               
         L     R3,ADCMPADD                                                      
         MVC   NADR,2(R3)          NUMBER OF LINES OF ADDRS.                    
         IC    R6,1(,R3)                                                        
         SHI   R6,4                                                             
         EXMVC R6,COMPADDR,3(R3)                                                
***********************************************************************         
*  GET SECURITY ALPHA CODE                                                      
***********************************************************************         
         SPACE 1                                                                
         USING CT5REC,R2                                                        
         LA    R2,IOKEY                                                         
         XC    CT5KEY,CT5KEY                                                    
         MVI   CT5KTYP,CT5KTYPQ    ACCESS RECORD                                
         MVC   CT5KALPH,SECALPHA   AGENCY ALPHA                                 
         L     R1,=AL4(IOREAD+IOCNTRL+IOAREA2)                                  
         GOTO1 AIO                                                              
         BNE   FMTINI40                                                         
*                                                                               
         SR    R1,R1                                                            
         L     R2,AIO2                                                          
         LA    R2,CT5DATA                                                       
*                                                                               
         USING CTSEAD,R2                                                        
FMTINI30 CLI   0(R2),0                                                          
         BE    FMTINI40                                                         
         CLI   CTSEAEL,CTSEAELQ    X'B8' SECURITY ALPHA                         
         BNE   *+10                                                             
         MVC   SECALPHA,CTSEAAID   SAVE OFF SECECT'S ALPHA AGENCY               
         IC    R1,1(,R2)                                                        
         AR    R2,R1                                                            
         B     FMTINI30                                                         
*                                                                               
         USING NMEKEYD,R3                                                       
FMTINI40 L     R3,=A(NMEKEYS)                                                   
FMTINI41 CLI   0(R3),EOT                                                        
         JE    FMTINI44                                                         
         SR    R2,R2                                                            
         ICM   R2,3,NMETAB                                                      
         AR    R2,RA                                                            
         NI    0(R2),TURNOFF-X'80' Turn off built bit                           
         L     RE,0(,R2)           A(Table)                                     
         SHI   RE,2                                                             
         XC    0(2,RE),0(RE)       Clear number of entries                      
         AHI   R3,NMEKEYQ                                                       
         J     FMTINI41                                                         
*                                                                               
FMTINI44 L     R3,=A(NMEKEY2)                                                   
FMTINI45 CLI   0(R3),EOT                                                        
         JE    FMTINI90                                                         
         SR    R2,R2                                                            
         ICM   R2,3,NMETAB                                                      
         AR    R2,RA                                                            
         NI    0(R2),TURNOFF-X'80' Turn off built bit                           
         L     RE,0(,R2)           A(Table)                                     
         SHI   RE,2                                                             
         XC    0(2,RE),0(RE)       Clear number of entries                      
         AHI   R3,NMEKEYQ                                                       
         J     FMTINI45                                                         
*                                                                               
FMTINI90 XIT1                                                                   
                                                                                
         LTORG                                                                  
         DROP  R2,R3,R7                                                         
         EJECT ,                                                                
***********************************************************************         
*  BUILD PROFILE INFORMATION IN FMTREC, FMTREC PASSED IN R5           *         
***********************************************************************         
         SPACE 1                                                                
         USING ACRL2D,R7                                                        
         USING FMTRECD,R5                                                       
BLDPROF  NTR1  BASE=*,LABEL=*                                                   
         MVI   FMTPGEWD+3,PGWDRL18         Max page width - Landscape           
         CLI   QPROG+1,LANDSCPE                                                 
         BE    *+8                                                              
         MVI   FMTPGEWD+3,PGWDRP18         Max page width - Portrait            
         MVI   FMTRNDTY,PENNY              Round to penny  (Default)            
         MVI   FMTPOPT1,RPFBOX             Print boxes     (Default)            
         MVI   FMTPIND,RPFEDCMA+RPFEDTRL   Edit amounts    (Default)            
         MVI   FMTULINE,DASH                                                    
         MVI   FMTPCT,TWODEC+1     % To two decimal places    (Default)         
         MVI   FMTFLAG,0                                                        
         MVI   FMTIND,0                                                         
         MVC   FMTF1(5),SPACES                                                  
*&&US*&& MVI   TIMESTA2,TIMEB      Default for B time only                      
*&&UK                                                                           
         MVI   TIMESTA2,0          Default for B,N and R time                   
         MVI   VATRGSTA,0                                                       
*&&                                                                             
         MVI   SPLITIND,0                                                       
         CLI   QPROG,PRODUCTION                                                 
         BNE   *+10                                                             
         MVC   FMTESTAT,QOPT7                                                   
*                                                                               
         MVI   BLTRNOPT,YES                                                     
         XC    BUFKRATE,BUFKRATE                                                
*                                                                               
         XC    FMTRNK#1,FMTRNK#1   No rank                    (Default)         
         XC    FMTRNK#2,FMTRNK#2   No rank                    (Default)         
         XC    FMTRNK#3,FMTRNK#3   No rank                    (Default)         
         MVI   FMTRNKTY,C'D'       Decending order            (Default)         
         MVC   FMTDICT1,=CL4'SU'                                                
         MVC   FMTDICT2,=CL4'LU'                                                
*                                                                               
         USING RPFELD,R2                                                        
         SR    RF,RF                                                            
         L     R2,AIO2                                                          
         AH    R2,DATADISP                                                      
BLDPRF00 CLI   0(R2),EOR                                                        
         BE    BLDPRF40                                                         
         CLI   0(R2),RPFELQ        Profile information element code             
         BE    BLDPRF02                                                         
         IC    RF,1(,R2)                                                        
         AR    R2,RF                                                            
         B     BLDPRF00                                                         
*                                                                               
BLDPRF02 MVC   FMTROPT,RPFROPT     Save report options                          
         MVC   FMTROPT1,RPFOPT1    Save report options 1                        
         MVC   FMTROPT2,RPFOPT2    Save report options 2                        
         MVC   FMTROPT3,RPFOPT3    Save report options 3                        
         MVC   FMTROPT4,RPFOPT4    Save report options 4                        
         MVC   FMTROPT5,RPFOPT5    Save report options 5                        
         MVC   FMTROPT6,RPFOPT6    Save report options 6                        
         MVI   FMTROPT7,0                                                       
         MVI   FMTROPT8,0                                                       
*&&UK*&& CLI   RPFLN,RPFLN2Q       Is element long enough                       
*&&UK*&& BL    BLDPF02A                                                         
         MVC   FMTROPT7,RPFOPT7    Save report options 7                        
         MVC   FMTROPT8,RPFOPT8    Save report options 8                        
         MVC   FMTROPT9,RPFOPT9    Save report options 9                        
                                                                                
BLDPF02A MVC   FMTPOPT1,RPFPOPT    Save report options 1                        
         MVC   FMTPOPT2,RPFPOPT2   Save report options 2                        
         MVC   FMTPOPT3,RPFPOPT3   Save report options 3                        
         MVC   FMTIND,RPFIND                                                    
*                                                                               
         CLI   QOPT1,C' '                                                       
         BNH   BLDPF02B                                                         
         CLI   RPFLN,RPFLN2Q                                                    
         BL    BLDPF02B                                                         
         TM    RPFDNOP2,RPFDNRPG                                                
         BZ    *+8                                                              
         OI    DWNOPT4,DWNNRQPG    NO REQUEST PAGE ON DOWNLOADING REP           
         TM    RPFDNOP2,RPFDSFTP                                                
         BZ    *+8                                                              
         OI    DWNOPT4,DWNMSFTP    SEND REPORT TO MS SFTP SERVER                
*                                                                               
BLDPF02B CLI   QPROG,PRODUCTION                                                 
         BNE   BLDPRF03                                                         
         CLI   QOPT7,BLANK                                                      
         BH    *+10                                                             
         MVC   FMTESTAT,RPFESTST   Estimate status                              
         CLI   FMTESTAT,BLANK                                                   
         BNH   *+8                                                              
         OI    ESTIND,ESTJSTAT     NEED JOB STATUS                              
*                                                                               
BLDPRF03 MVC   BLTRNOPT,RPFBLTRN                                                
         CLI   RPFLN,RPFLN2Q       New length ?                                 
         BL    *+10                                                             
         MVC   FMTOPTCH,RPFPITCH   Pitch over-ride                              
*                                                                               
         CLI   QFILTER1,C' '       Don't over-ride request                      
         BNE   *+10                Yes                                          
         MVC   FMTF1,RPFFLT1                                                    
         CLI   QFILTER2,C' '       Don't over-ride request                      
         BNE   *+10                Yes                                          
         MVC   FMTF2,RPFFLT2                                                    
         CLI   QFILTER3,C' '       Don't over-ride request                      
         BNE   *+10                Yes                                          
         MVC   FMTF3,RPFFLT3                                                    
         CLI   QFILTER4,C' '       Don't over-ride request                      
         BNE   *+10                Yes                                          
         MVC   FMTF4,RPFFLT4                                                    
         CLI   QFILTER5,C' '       Don't over-ride request                      
         BNE   *+10                Yes                                          
         MVC   FMTF5,RPFFLT5                                                    
*                                                                               
MAIN     USING FMTRECD,R6                                                       
         TM    FMTRCAP,FMTRPROF    Use own format profile ?                     
         BO    BLDPRF04            Yes                                          
         L     R6,AFORMATS         Point to main format data                    
         MVC   FMTROPT,MAIN.FMTROPT                                             
         MVC   FMTROPT1,MAIN.FMTROPT1                                           
         MVC   FMTROPT2,MAIN.FMTROPT2                                           
         MVC   FMTROPT3,MAIN.FMTROPT3                                           
         MVC   FMTROPT4,MAIN.FMTROPT4                                           
         MVC   FMTROPT5,MAIN.FMTROPT5                                           
         MVC   FMTROPT6,MAIN.FMTROPT6                                           
         MVC   FMTROPT7,MAIN.FMTROPT7                                           
         MVC   FMTROPT8,MAIN.FMTROPT8                                           
         MVC   BLTRNOPT,MAIN.BLTRNOPT      Billing options                      
         MVC   TIMESTA2,MAIN.TIMESTA2      Type of time (B,N,R)                 
*&&UK*&& MVC   VATRGSTA,MAIN.VATRGSTA      VAT region                           
         MVC   FMTF1(5),MAIN.FMTF1         Filters F1 - F5                      
         CLI   QPROG,PRODUCTION                                                 
         BNE   BLDPRF04                                                         
         CLI   QOPT7,BLANK                                                      
         BH    *+10                                                             
         MVC   FMTESTAT,MAIN.FMTESTAT      Estimate status                      
         CLI   FMTESTAT,BLANK                                                   
         BNH   *+8                                                              
         OI    ESTIND,ESTJSTAT     NEED JOB STATUS                              
         DROP  MAIN                                                             
*                                                                               
BLDPRF04 CLI   FMTNUM,1                                                         
         BNE   BLDPRF08                                                         
         CLI   RPFLN,RPFLN2Q       NEW LENGTH ?                                 
         BNE   BLDPF05A                                                         
         BAS   RE,FTPSET                                                        
                                                                                
         CLI   QOPT1,EDIDL         EDI type download                            
         BNE   *+8                                                              
         BAS   RE,EDISET           EXTRACT EDIHUB CODE                          
                                                                                
         CLI   QOPT1,FTPDL         FTP type download                            
         BNE   BLDPF04B                                                         
         OC    RPFEDNME,RPFEDNME                                                
         BZ    *+10                Was there an override ?                      
         MVC   DESTID,RPFEDNME     Yes                                          
                                                                                
BLDPF04B CLI   QOPT1,DSNDL                                                      
         BNE   *+10                                                             
         MVC   DESTID,RPFEDNME                                                  
                                                                                
BLDPF04D MVC   DWNFLDD,RPFFLDD     FIELD         SEPERATOR                      
         MVC   DWNTXTD,RPFTXTD     TEXT          DELIMITOR                      
         MVC   DWNEOLD,RPFEOLD     END OF LINE   DELIMITOR                      
         CLI   DWNEOLD,C' '                                                     
         BNE   *+8                                                              
         MVI   DWNEOLD,X'42'                                                    
         MVC   DWNEORD,RPFEORD     END OF REPORT DELIMITOR                      
*                                                                               
BLDPF05A MVC   AGEMTHD,RPFAGMTH    SAVE AGEING METHOD                           
         OI    AGEMTHD,X'40'       UPPER CASE WITH DEFAULT BLANK                
         CLI   QPROG,PRODUCTION    PRODUCTION LEDGER?                           
         BNE   *+8                                                              
         OI    FMTROPT2,RPFOCD$    SET TO FIND CASH DISCOUNT PRESENT?           
         CLI   QPROG,MANPOWER                                                   
         BNE   BLDPRF05                                                         
         CLI   RPFCLIOF,C'C'                                                    
         BNE   *+8                                                              
         MVI   FCPERSEC,FCPERCLI   CLIENT OFFICE ONLY                           
         CLI   RPFCLIOF,C'B'                                                    
         BNE   *+8                                                              
         MVI   FCPERSEC,FCPERBTH   CLIENT OR PERSON OFFICE                      
         CLI   FCPERSEC,FCPEREMP   PERSON OFFICE SET? DEFAULT                   
         BE    *+8                                                              
         MVI   OFFSEC,YES          No SO SPECIAL SECURITY IS ON                 
                                                                                
BLDPRF05 TM    DWNOPT1,DWNSPDTE                                                 
         BZ    *+8                                                              
         MVI   RPFDTFMT,1          Over-ride download profile to YYMMDD         
                                                                                
         USING DATED,R1                                                         
         TM    DWNOPT1,DWNGO                                                    
         BZ    BLDPRF7A                                                         
         LA    R0,DATEFMT#         Number of entries                            
         L     R1,ADATEFMT                                                      
BLDPRF06 CLC   DATEFORM,RPFDTFMT   MATCH FORMAT CODE                            
         BE    BLDPRF07                                                         
         LA    R1,DATELNQ(,R1)     BUMP UP TO NEXT ENTRY                        
         BCT   R0,BLDPRF06                                                      
         DC    H'00'               NEED TO ADD A TABLE ENTRY                    
         DROP  R1                                                               
*                                                                               
BLDPRF07 SHI   R0,DATEFMT#+1       Index into table                             
         LPR   R0,R0               Load positive value                          
         STC   R0,FMTDTIDX         Save off index                               
*                                                                               
BLDPRF7A MVC   RAD#LDWN,RPFNALDW   NUM  OF ADDR LINES TO DOWN-LOAD              
*&&UK                                                                           
         CLI   QOPT1,USSDL         USS download?                                
         BE    *+12                                                             
*&&                                                                             
         CLI   QOPT1,EDIDL         EDIHUB download?                             
         BNE   BLDPRF7B                                                         
         TM    RPFDNOPT,RPFDNDEC   NO DECIMALS?                                 
         BZ    *+8                                                              
         OI    DWNOPT1,DWNNODEC                                                 
         TM    RPFDNOPT,RPFDNCOL   NO COLUMN HEADINGS?                          
         BZ    *+8                                                              
         NI    DWNOPT1,TURNOFF-DWNHEAD                                          
         TM    RPFDNOPT,RPFDNROW   INCLUDE ROWS                                 
         BZ    *+8                                                              
         OI    DWNOPT1,DWNROWS                                                  
*                                                                               
BLDPRF7B CLI   QOPT1,DSNDL         DSN download?                                
         BE    *+8                 Yes                                          
         CLI   QOPT1,YES           Regular download?                            
         BE    *+8                 Yes                                          
         CLI   QOPT1,C'S'          Regular download?                            
         BNE   BLDPRF08            No                                           
         TM    RPFDNOPT,RPFDNDEC   NO DECIMALS?                                 
         BZ    *+8                                                              
         OI    DWNOPT1,DWNNODEC                                                 
         TM    RPFDNOPT,RPFDNPAD   PAD WITH LEADING ZEROS                       
         BZ    *+8                                                              
         OI    DWNOPT2,DWN#PAD                                                  
         TM    RPFDNOPT,RPFDNFXW   FIXED WIDTHS                                 
         BZ    *+8                                                              
         OI    DWNOPT1,DWNCHOP                                                  
         TM    RPFDNOPT,RPFDNCOL   NO COLUMN HEADINGS?                          
         BZ    *+8                                                              
         NI    DWNOPT1,TURNOFF-DWNHEAD                                          
         TM    RPFDNOPT,RPFDNROW   INCLUDE ROWS                                 
         BZ    *+8                                                              
         OI    DWNOPT1,DWNROWS                                                  
         TM    RPFDNOPT,RPFDNTOT   INCLUDE TOTALS                               
         BZ    *+8                                                              
         OI    DWNOPT2,DWNTOTS                                                  
         TM    RPFDNOPT,RPFDTXT#   DOWN-LOAD NUMBERS AS TEXT                    
         BZ    *+8                                                              
         OI    DWNOPT1,DWNTXT#                                                  
         TM    RPFDNOPT,RPFDDOWN   FORCE DOWNLOAD?                              
         BZ    *+8                                                              
         OI    DWNOPT3,DWNFDWN                                                  
         TM    RPFXMIT,RPFDLFJ$    Left justify amounts ?                       
         BZ    *+8                 No                                           
         OI    DWNOPT2,DWNLEFTJ    Yes                                          
*                                                                               
BLDPRF08 DS    0H                                                               
         MVC   FMT#ADRL,RPFNALPR   NUM  OF ADDR LINES TO PRINT                  
         TM    RPFIND,RPFACLVL                                                  
         BZ    *+8                                                              
         OI    FMTFLAG,FMTACLVL                                                 
*                                                                               
         CLI   BLTRNOPT,0                                                       
         BNE   *+8                                                              
         MVI   BLTRNOPT,YES                                                     
*                                                                               
         NI    FMTIND,FMTIERR+FMTIAGE0                                          
         TM    RPFIND,RPFIPRFX                                                  
         BZ    *+8                                                              
         OI    FCIND,FCIPRFIX      SET FOREIGN CURRENCY PREFIX ON               
*                                                                               
         TM    RPFIND,RPFIXNFC                                                  
         BZ    *+8                                                              
         OI    FCIND,FCIXNFC       EXCLUDE NON-FOREIGN CURRENCY TRANS           
         TM    FMTPOPT1,RPFMCASE   USED MIX CASE?                               
         BZ    BLDPRF09                                                         
         MVC   FMTDICT1,=CL4'SL'                                                
         MVC   FMTDICT2,=CL4'LL'                                                
*                                                                               
BLDPRF09 DS    0H                                                               
*&&UK                                                                           
         CLI   RPFEDOPT,0          Are any edit options set                     
         BE    BLDPRF10                                                         
*&&                                                                             
         MVC   FMTPIND,RPFEDOPT    SET EDITING OPTIONS                          
*&&UK                                                                           
         TM    RPFEDOPT,RPFEDLED   Print leading minus sign ?                   
         BZ    *+8                 So, skip                                     
         OI    DWNOPT1,DWNLEADM    Down-load leading minus                      
*&&                                                                             
BLDPRF10 CLI   RPFRKON,C'R'                                                     
         BNE   BLDPRF20                                                         
         SR    R1,R1                                                            
         IC    R1,RPFRKON+1                                                     
         AHI   R1,1                ADJUST FOR FORCED FIRST ROW                  
         STC   R1,RPFRKON+1                                                     
*                                                                               
BLDPRF20 MVC   FMTRNK#1,RPFRKON    RANK ON THIS ROWS TOTALS                     
         MVC   FMTRNK#2,RPFRKON    ACCTUALLY RANKBY (NOT IN VERSION)            
         MVC   FMTRNK#3,RPFRKCL    COLUMN TO RANK ON                            
         MVC   FMTRNKTY,RPFRKOR    RANKING ORDER (ACCENDING/DECENDING)          
         OC    FMTRNK#1,FMTRNK#1                                                
         BZ    BLDPRF22                                                         
         OI    RANKSW,RANKON                                                    
         OI    FMTSW,FMTRANK                                                    
*                                                                               
BLDPRF22 CLI   RPFPCTS,C'1'        One decimal place ?                          
         BH    *+16                No, must be two                              
         MVI   FMTPCT,ONEDEC+1     Force one                                    
         BE    *+8                 Yes                                          
         MVI   FMTPCT,ZERODEC+1    No so must be none                           
*                                                                               
         CLI   RPFRND,C'P'         Do we round to penny (2 dec)                 
         BE    BLDPRF40            Already default                              
         MVI   FMTRNDTY,DOLLAR     Round to dollar (0 dec)                      
         CLI   RPFRND,C'D'         Do we round to dollar                        
         BE    BLDPRF40            Yes                                          
         MVI   FMTRNDTY,THOUSAND   Round to thousand (0 dec)                    
         CLI   RPFRND,C'T'         Do we round to thousands                     
         BE    BLDPRF40            Yes                                          
         MVI   FMTRNDTY,MILLION    Round to millions (0 dec)                    
*                                                                               
BLDPRF40 TM    FMTROPT6,RPFSPBIL   Show prior bills                             
         BZ    *+8                                                              
         OI    RECREAD2,REC99WC    Pre-read 99 trans                            
*                                                                               
MAIN     USING FMTRECD,R6                                                       
         TM    DWNOPT1,DWNGO             Are we downloading ?                   
         BZ    BLDPRF50                  No                                     
         L     R6,AFORMATS               Point to main format data              
         OI    FMTPOPT1,RPFRDAT          Force redundant column data            
         OI    FMTPOPT1,RPFLFJT          Force left justification               
         NI    FMTPOPT1,TURNOFF-RPFBOX   and turn off boxes                     
         NI    FMTPOPT2,TURNOFF-(RPFSTRPE+RPFISHDE+RPFOSHDE)                    
         MVC   FMTDTIDX,MAIN.FMTDTIDX                                           
         DROP  MAIN                                                             
*                                                                               
BLDPRF50 DS    0H                                                               
*&&UK                                                                           
         XR    RF,RF                                                            
         L     RE,AIO2                                                          
         AH    RE,DATADISP                                                      
         USING RFLELD,RE                                                        
BLDPRF55 CLI   0(RE),EOR                                                        
         BE    BLDPRF99                                                         
         CLI   0(RE),RFLELQ                                                     
         BNE   BLDPRF60                                                         
         CLI   RFLTYPE,RFLXDATN                                                 
         BNE   *+8                                                              
         OI    FMTXDATA,FMTXNAME                                                
         CLI   RFLTYPE,RFLXDATV                                                 
         BNE   *+8                                                              
         OI    FMTXDATA,FMTXVALU                                                
BLDPRF60 IC    RF,1(,RE)                                                        
         AR    RE,RF                                                            
         B     BLDPRF55                                                         
         DROP  RE                                                               
*&&                                                                             
BLDPRF99 XIT1                                                                   
         DROP  R5,R7                                                            
         EJECT ,                                                                
***********************************************************************         
*  SET FTP VALUES FOR ++SUB and ++FIL                                 *         
***********************************************************************         
         USING ACRL2D,R7                                                        
FTPSET   NTR1                                                                   
         L     R7,AACRL2D                                                       
         MVC   DWNSUB,SPACES                                                    
         MVC   DWNFIL,SPACES                                                    
         MVC   DWNEXT,SPACES                                                    
         L     R2,AIO2                                                          
         AH    R2,DATADISP                                                      
                                                                                
         USING FFTELD,R2                                                        
FTPSET10 CLI   0(R2),EOR                                                        
         BE    FTPSETX                                                          
         CLI   0(R2),FFTELQ        X'DB' Free form element                      
         BNE   FTPSET15                                                         
         LA    R3,DWNSUB                                                        
         CLI   FFTTYPE,FFTTESUB                                                 
         BE    FTPSET20                                                         
         LA    R3,DWNFIL                                                        
         CLI   FFTTYPE,FFTTEFIL                                                 
         BE    FTPSET20                                                         
         LA    R3,DWNEXT                                                        
         CLI   FFTTYPE,FFTTEEXT                                                 
         BE    FTPSET20                                                         
                                                                                
FTPSET15 SR    RF,RF                                                            
         IC    RF,FFTLN                                                         
         AR    R2,RF                                                            
         B     FTPSET10                                                         
                                                                                
FTPSET20 SR    R5,R5                                                            
         IC    R5,FFTDLEN                                                       
         LA    R4,FFTDATA                                                       
         TM    FFTSEQ,X'80'        Macro involved                               
         BO    FTPSET22            Yes, so resolve                              
         BCTR  R5,0                                                             
         EXMVC R5,0(R3),FFTDATA                                                 
         B     FTPSET15                                                         
                                                                                
FTPSET22 DS    0H                                                               
         LR    R6,R4                                                            
         LR    R0,R5                                                            
         CLI   0(R6),C'+'          Concatinate                                  
         BNE   *+10                                                             
         AHI   R6,1                Bump up in string                            
         BCTR  R0,0                less 1 in length                             
                                                                                
         CLI   0(R6),C'&&'                                                      
         BNE   FTPSET28                                                         
         LA    RE,MACTAB           Macro table                                  
         AHI   R6,1                Bump past &                                  
         BCTR  R0,0                less 1 in length                             
                                                                                
FTPSET24 CLI   0(RE),EOT           End of table ?                               
         BE    FTPSET28            No match                                     
         SR    RF,RF                                                            
         IC    RF,1(,RE)           Get length of macro                          
         CR    R0,RF               Is the Macro larger than what's left         
         BL    FTPSET26            Yes, check next MACRO                        
         BCTR  RF,0                                                             
         EXCLC RF,0(R6),2(RE)                                                   
         BNE   FTPSET26                                                         
         LR    R5,R0               New length less + and/or &                   
         LR    R0,RF               Save off len of macro that matched           
         SR    R5,RF               R5 is what's left                            
         ZIC   RF,0(,RE)           Get routine #                                
         SLL   RF,2                                                             
         B     *(RF)                                                            
         B     FTPDNT              Date and time                                
                                                                                
FTPSET26 AHI   RE,MACTLNQ          Next table entry                             
         B     FTPSET24                                                         
                                                                                
FTPSET28 MVC   0(1,R3),0(R4)       Move in one character at a time              
         AHI   R3,1                                                             
         AHI   R4,1                                                             
                                                                                
FTPSET30 BCT   R5,FTPSET22                                                      
         B     FTPSET15                                                         
                                                                                
FTPSETX  XIT1                                                                   
         DROP  R2,R7                                                            
                                                                                
FTPDNT   GOTOR =V(DATTIM),DMCB,(X'02',0),(R3)                                   
         AR    R6,R0                                                            
         AHI   R6,1                One for excute                               
         SHI   R5,1                                                             
         BNP   FTPSET15            Next element                                 
         CLI   0(R6),C'+'                                                       
         BNE   FTPDNT10                                                         
         AHI   R6,1                Bump past concatination symbol               
         SHI   R5,1                                                             
         BNP   FTPSET15            Next element                                 
FTPDNT10 AHI   R3,14               Length of output - YYYYMMDDMMHHSS            
         LR    R4,R6               New location to start from                   
         B     FTPSET22                                                         
         EJECT ,                                                                
***********************************************************************         
*  SET EDIHUB CODE                                                              
***********************************************************************         
         USING ACMD,R3                                                          
         USING ACRL2D,R7                                                        
EDISET   NTR1                                                                   
         L     R3,AMONACC                                                       
         L     R7,AACRL2D                                                       
         MVC   EDIHUBID,SPACES                                                  
*                                                                               
         USING FFTELD,R2                                                        
         L     R2,AIO2                                                          
         MVI   ELCODE,FFTELQ       X'DB'                                        
         BRAS  RE,GETEL                                                         
EDISET04 BNE   EDISET10            No EDIHUB ID in profile                      
         CLI   FFTTYPE,FFTTEDID    EDIHUB ID                                    
         BE    *+12                Found                                        
         BRAS  RE,NEXTEL                                                        
         B     EDISET04                                                         
         MVC   EDIHUBID,FFTEDIID                                                
         B     EDISETX                                                          
                                                                                
EDISET10 L     R1,ADOFFLST         Point to office list                         
         CLI   0(R1),0             Any limit set?                               
         BE    EDISET20            No, get EDIHUB ID from company               
*                                                                               
         USING OFFALD,R1                                                        
         L     R1,ACMAOFL                                                       
         MVC   HALF,OFFANEWA       Two chars office                             
         CLI   NEWOFF,YES          Two character office?                        
         BE    EDISET14            Yes                                          
         MVC   HALF,OFFAOLDA       Single char office                           
         CLI   OFFAOLDA,C'*'       Is it an office list?                        
         BNE   *+14                Yes - OK                                     
         MVC   HALF(1),OFFAOLDA+1                                               
         MVI   HALF+1,C' '                                                      
         DROP  R1                                                               
*                                                                               
EDISET14 CLC   HALF,SPACES         Test for limited access                      
         BNH   EDISET20                                                         
         USING OFFRECD,R1          READ OFFICE RECORD                           
         LA    R1,IOKEY                                                         
         MVC   OFFKEY,SPACES                                                    
         MVI   OFFKTYP,OFFKTYPQ    OFFICE RECORD TYPE                           
         MVC   OFFKCPY,RCCOMPFL    COMPANY CODE                                 
         MVC   OFFKOFF,HALF        OFFICE CODE FORM ID RECORD                   
         DROP  R1                                                               
         L     R1,=AL4(IOREAD+IOACFIL+IOAREA3)                                  
         GOTO1 AIO                                                              
         BNE   EDISET20            NO OFFICE RECORD                             
*                                                                               
         L     R2,AIO3                                                          
         MVI   ELCODE,FFTELQ       X'DB'                                        
         BRAS  RE,GETEL                                                         
EDISET18 BNE   EDISET20            No EDIHUB ID on office record                
         CLI   FFTTYPE,FFTTEDID    EDIHUB ID                                    
         BE    *+12                Found                                        
         BRAS  RE,NEXTEL                                                        
         B     EDISET18                                                         
         MVC   EDIHUBID,FFTEDIID                                                
         B     EDISETX                                                          
*                                                                               
EDISET20 L     R2,ADCOMP                                                        
         MVI   ELCODE,FFTELQ       X'DB'                                        
         BRAS  RE,GETEL                                                         
EDISET24 BE    *+6                                                              
         DC    H'0'                There must be one on company                 
         CLI   FFTTYPE,FFTTEDID    EDIHUB ID                                    
         BE    *+12                Found                                        
         BRAS  RE,NEXTEL                                                        
         B     EDISET24                                                         
         MVC   EDIHUBID,FFTEDIID                                                
         B     EDISETX                                                          
                                                                                
EDISETX  XIT1                                                                   
         DROP  R2,R3,R7                                                         
***********************************************************************         
* Macro table and literals                                                      
***********************************************************************         
MACTAB   DC    AL1(1,8)                                                         
         DC    CL8'DATETIME'                                                    
MACTLNQ  EQU   *-MACTAB                                                         
         DC    AL1(EOT)                                                         
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*  ADD COLUMN INFORMATION TO COLTABLE                                 *         
***********************************************************************         
                                                                                
         USING RCLELD,R2                                                        
         USING COLD,R3                                                          
         USING FMTRECD,R5                                                       
         USING ACRL2D,R7                                                        
         USING LCBLD,R8                                                         
CBUILD   NMOD1 LCBLDQ,**CBLD**,R9,CLEAR=YES                                     
         LR    R8,RC               R8 = Local working storage                   
         L     RC,RLBASEC                                                       
         L     R7,AACRL2D                                                       
         TM    FMTPOPT3,RPFTEDIT   Time sheet edit reporting ?                  
         BZ    *+10                No                                           
         GOTO1 =A(DUMMYCOL)        This adds a dummy column to force            
*                                        each record to print a line            
         TM    DDLNKIND,DDLNKON+DDLNKTST                                        
         JZ    CBLD001                                                          
         LH    R2,DATADISP                                                      
*        GOTO1 PRNTBL,DMCB,=C'Before',AIO2,C'DUMP',(R2),=CL2'1R'                
         GOTOR XPANDCOL                                                         
*        GOTO1 PRNTBL,DMCB,=C'After',AIO2,C'DUMP',(R2),=CL2'1R'                 
                                                                                
CBLD001  L     R2,AIO2                                                          
         MVI   ELCODE,RCLELQ       Column information element, X'C2'            
         BRAS  RE,GETEL                                                         
         BE    CBLD02                                                           
         MVI   ERROR#,2                                                         
         B     CBUILDX                                                          
*                                                                               
CBLD02   MVI   BLDACT,COLS                                                      
         MVI   HIGHSEQ,0           Set to highest sequence # so far             
         L     RE,ROWWRK           Pool of row elements to be created           
         MVI   0(RE),0             Mark end of pool                             
         ST    RE,POINTER          Current pointer to element pool              
         L     R3,PTRCOL           A(Current column location in table)          
         ST    R3,FMTCOL           Store in format record                       
*                                                                               
         LA    R0,SPACES           Clear out 3 lines worth                      
         SR    R1,R1                                                            
         ICM   R1,8,SPACES         Pad character blank                          
         L     RE,PTRCHEAD         Point to column head entry                   
         ST    RE,FMTCHEAD         Store address in format record               
         LA    RF,STDPGWD*3                                                     
         MVCL  RE,R0                                                            
*                                                                               
         L     RE,XPSAVE           Load & save print line addresses             
         ST    RE,PTRCSPWK                                                      
         L     RE,PTRBXCOL         Point to box heading information             
         MVI   0(RE),BLANK         Clear to blank                               
         MVC   1(STDPGWD-1,RE),0(RE)                                            
         MVI   0(RE),C'L'          Move in left side to mark box                
         ST    RE,FMTBOXCL         Save addreess for next format                
*                                                                               
CBLD05   CLI   0(R2),RCLELQ        Is it a column element ?                     
         BNE   CBLD99              No, so finished                              
         L     R7,AACRL2D                                                       
         ST    R2,ACURCOL          A(Current column working on)                 
         XC    COLD(COLLNQ),COLD   Clear out new column entry                   
         XC    KEYWRD#,KEYWRD#     Dictionary keyword #                         
         MVI   XDATA,0                                                          
         TM    RCLOPT2,RCLDICT     Translated ?                                 
         BZ    *+10                No                                           
         MVC   KEYWRD#,RCLNDATA    Yes, so use dictionary # instead             
         CLI   RCLSPCL,RCLSPLV1    Account level 1 or higher                    
         BL    *+10                                                             
         MVC   XDATA,RCLXDATA      Need to match on xtra data                   
         L     RE,AHEADCOL         Column heading area                          
*&&UK*&& AHI   RE,HEADEND-HEAD_A                                                
*&&US*&& AHI   RE,99*3                                                          
         ST    RE,COLHEAD3         Save work area for heads 1,2 & 3             
         ST    RE,AHEADCOL         Next column heading area                     
         MVI   NPRAMS,1            Default to 1                                 
         TM    RCLOPT2,RCLDICT     Expanded form ?                              
         BO    CBLD08              No                                           
         MVC   P,SPACES            Scan screen input from element               
         IC    RF,RCLDATLN         Length of data                               
         BCTR  RF,0                                                             
         EXMVC RF,P,RCLNDATA                                                    
         GOTO1 =V(SCANNER),DMCB,(C'C',P),(6,ABLOCK),C',=,:'                     
         MVC   NPRAMS,DMCB+4                                                    
*                                                                               
CBLD08   MVC   COLNUM,RCLSEQ       Move in sequence number                      
         MVC   COLFLAGS,RCLOPT     Move in column   type                        
         NI    COLFLAGS,TURNOFF-RCLNOTOT-RCLMERGE-RCLNEWEL-RCLPCT               
         TM    RCLOPT,RCLNOTOT                                                  
         BZ    *+8                                                              
         MVI   COLTOTLV,X'FF'      Suppress printing totals for column          
         MVC   COLDATES,RCLDATES                                                
         TM    RCLOPT3,RCLUNLNA+RCLUNLNB+RCLUNLNN                               
         BNZ   CBLD10                       Already set by user                 
         TM    FMTPOPT3,RPFNOUL+RPFTPUL                                         
         BNZ   *+8                                                              
         OI    RCLOPT3,RCLUNLNB    Underline below - default                    
         TM    FMTPOPT3,RPFNOUL                                                 
         BZ    *+8                                                              
         OI    RCLOPT3,RCLUNLNN    No underline                                 
         TM    FMTPOPT3,RPFTPUL                                                 
         BZ    *+8                                                              
         OI    RCLOPT3,RCLUNLNA    Underline above                              
         TM    FMTPOPT3,RPFDBUL    Double underline ?                           
         BZ    *+8                 No                                           
         OI    RCLOPT3,RCLUNLDB    Yes                                          
*                                                                               
CBLD10   MVI   COLULINE,DASH       Default underline                            
         TM    RCLOPT3,RCLUNLDB    Double underline ?                           
         BZ    *+8                                                              
         MVI   COLULINE,C'='                                                    
*                                                                               
         TM    RCLOPT4,RCLRJUST    Right justify data                           
         BZ    *+8                 No                                           
         OI    COLIND4,COLRIGHT    Yes                                          
*                                                                               
         CLI   QPROG,MANPOWER      Person scribe ?                              
         BNE   CBLD12                                                           
         NI    RCLDTEFG,TURNOFF-RCLCNDR                                         
         CLI   COLDATES,COLTDTE    Period end date                              
         BNE   CBLD12                                                           
         TM    COLFLAGS,COLAMT     Specialized keyword "YEAR" & "MONTH"         
         BZ    CBLD11              Yes                                          
         OI    COLIND1,COLCNDR     No, set to use calendar                      
         B     CBLD12                                                           
*                                                                               
CBLD11   OI    POSTCTL,POSTMYP     Post YEAR, MONTH by period date              
*                                                                               
CBLD12   ZAP   COLDUB,PKZERO                                                    
         L     R4,ABLOCK                                                        
         MVC   COLKYWD,SPACES                                                   
         OC    KEYWRD#,KEYWRD#                                                  
         BNZ   *+10                                                             
         MVC   FINDDATA,12(R4)     Get column information from COLDATA          
         XC    COLSTART,COLSTART                                                
         MVC   COLEND,=X'FFFFFF'                                                
         XC    COLALTST,COLALTST                                                
         MVC   COLALTEN,=X'FFFFFF'                                              
*                                                                               
         TM    RCLOPT2,RCLJOBR     Jobber type column?                          
         BZ    *+8                                                              
         OI    COLFLAGS,COLJOBR                                                 
*                                                                               
         TM    RCLOPT4,RCLNJEST    Non-Jobber type column?                      
         BZ    *+8                                                              
         OI    COLFLAGS,COLNJEST                                                
*                                                                               
         TM    RCLOPT5,RCLNJESR    Non-Jobber hours/rates column                
         BZ    *+8                                                              
         OI    COLIND5,COLNJESR                                                 
*&&UK                                                                           
         TM    RCLOPT5,RCLXRATE    EXR column - don't treat as $$               
         BZ    *+8                                                              
         OI    COLIND6,COLXRATE                                                 
*&&                                                                             
         TM    RCLOPT2,RCLSHRT                                                  
         BZ    *+8                                                              
         OI    COLOPT2,COLSHRT                                                  
*                                                                               
         TM    RCLOPT2,RCLCZERO    Eliminate record if COL=ZERO                 
         BZ    *+12                                                             
         OI    COLOPT,COLCZERO                                                  
         OI    FMTFLAG,FMTCZERO    Mark option as on                            
*                                                                               
         TM    COLFLAGS,COLCALC    Is it a calculated column                    
         BZ    CBLD14              No                                           
         MVC   COLEDOPT,RCLEDOPT   Initialize column edit options               
         CLI   COLEDOPT,0                                                       
         BNE   *+10                                                             
         MVC   COLEDOPT,FMTPIND                                                 
         TM    RCLEDOPT,RCLEDABS   Absolute bits on ? (Two bits)                
         BNO   *+8                          No                                  
         NI    COLEDOPT,TURNOFF-RCLEDABS    Yes                                 
         NI    COLEDOPT,TURNOFF-RCLEDCMN-RCLEDZRN                               
         TM    RCLOPT,RCLPCT       Percentage column ?                          
         BZ    *+8                 No,  skip                                    
         OI    COLEDOPT,COLPCT     Yes, turn bit on                             
*                                                                               
         TM    RCLOPT3,RCLUNLNA    Underline above the amount                   
         BZ    *+8                                                              
         OI    COLIND3,COLULA                                                   
         TM    RCLOPT3,RCLUNLNB    Underline below the amount                   
         BZ    *+8                                                              
         OI    COLIND3,COLULB                                                   
         TM    RCLOPT3,RCLUNLNN    No underline                                 
         BZ    *+8                                                              
         OI    COLIND3,COLULN                                                   
*                                                                               
         OI    COLIND2,COLRNDBF    Round before processing a record             
         TM    RCLOPT3,RCLKPSIG    Keep significance when adding to tot         
         BZ    *+8                 No                                           
         NI    COLIND2,TURNOFF-COLRNDBF                                         
         MVC   COLKYWD,=CL6'EQUTED'                                             
         MVC   COLXTRA,PTPSTACK    Save start of stack                          
                                                                                
         TM    COLFLAGS,COLAMT     Is it accumulated column ?                   
         BZ    CBLD13              No, so must be calculated date col.          
         SR    RF,RF                                                            
         IC    RF,RCLDATLN                                                      
         TM    DDLNKIND,DDLNKON                                                 
         BZ    CBLD12B                                                          
         L     RE,AEQUTION                                                      
         ST    RE,COLEQUTN         Save off address of area                     
         BCTR  RF,0                                                             
         EXMVC RF,0(RE),RCLNDATA   Save off value                               
         AHI   RE,MAXEQLN          Max length allowed                           
         ST    RE,AEQUTION                                                      
         AHI   RF,1                                                             
                                                                                
CBLD12B  GOTO1 =A(POLISH),DMCB,((RF),RCLNDATA),PTPSTACK                         
         MVC   PTPSTACK,DMCB                                                    
         L     R6,AKYWCALC         A(Column calculation keyword)                
         B     CBLD160                                                          
*                                                                               
CBLD13   GOTO1 =A(DTECALC)                                                      
         OI    COLFLAGS,COLAMT     Date 1 - Date 2                              
         OI    COLIND3,COLCALDT    Set on so we know about it                   
         MVI   COLDCMLS,0          Default to 0 decimals                        
         MVI   COL#DEC,2           Default to 2 decimals                        
         MVI   COLROUND,62         Round to whole $                             
         MVI   COLTOTLV,X'FF'      Don't total on this column                   
         L     R6,AKYWCALD         Displacement into table                      
         B     CBLD160                                                          
*                                                                               
CBLD14   DS    0H                                                               
*&&UK                                                                           
         CLI   RCLSPCL,RCLSPMAP    Mapping to other column (UK)                 
         BE    CBLD14B1            Yes                                          
*&&                                                                             
         TM    COLFLAGS,COLAMT     Do we need to add date params                
         BZ    CBLD150             No                                           
         CLI   RCLXDATA,0                                                       
         BE    CBLD14A                                                          
         CLI   RCLSPCL,0                                                        
         BNE   CBLD14A                                                          
         MVC   COLCLVL,RCLXDATA                                                 
         MVC   COLXLNK,RCLDTEFM                                                 
                                                                                
CBLD14A  MVC   COLEDOPT,RCLEDOPT                                                
         CLI   COLEDOPT,0                                                       
         BNE   *+10                                                             
         MVC   COLEDOPT,FMTPIND                                                 
         TM    RCLEDOPT,RCLEDABS   Absolute bits on ?                           
         BNO   *+8                          No                                  
         NI    COLEDOPT,TURNOFF-RCLEDABS    Yes                                 
         NI    COLEDOPT,TURNOFF-RCLEDCMN-RCLEDZRN                               
         TM    RCLOPT,RCLPCT                                                    
         BZ    *+8                                                              
         OI    COLEDOPT,COLPCT                                                  
*                                                                               
         TM    RCLOPT3,RCLUNLNA    Underline above the amount                   
         BZ    *+8                                                              
         OI    COLIND3,COLULA                                                   
         TM    RCLOPT3,RCLUNLNB    Underline below the amount                   
         BZ    *+8                                                              
         OI    COLIND3,COLULB                                                   
         TM    RCLOPT3,RCLUNLNN    No underline                                 
         BZ    *+8                                                              
         OI    COLIND3,COLULN                                                   
*                                                                               
         OI    COLIND2,COLRNDBF    Round before processing a record             
         TM    RCLOPT3,RCLKPSIG    Keep significance when adding to tot         
         BZ    *+8                 No                                           
         NI    COLIND2,TURNOFF-COLRNDBF                                         
*                                                                               
         CLI   RCLSPCL,0           Special routine                              
         BE    CBLD150             No,  skip                                    
         CLI   RCLSPCL,RCLSPEXR    Exchange rate  (UK)                          
         BE    CBLD14B                  or                                      
         CLI   RCLSPCL,RCLSPSGN        SIGN()     type column ?                 
         BE    CBLD14B                  or                                      
         CLI   RCLSPCL,RCLSPCME        CUME()     type column ?                 
         BNE   CBLD150             No,  skip                                    
         OI    FMTFLAG2,FMTSUM     Format has CUME() keyword                    
*                                                                               
CBLD14B  OI    COLFLAGS,COLCALC    Make calculated column                       
CBLD14B1 MVC   COLXTRA,PTPSTACK    Save start of stack                          
                                                                                
         LA    R0,8                Max is eight                                 
         AHI   R4,12                                                            
CBLD14C  CLI   0(R4),C'('          Find parenthisis                             
         BE    CBLD14D                                                          
         AHI   R4,1                Bump up                                      
         BCT   R0,CBLD14C                                                       
         DC    H'00'                                                            
*                                                                               
         USING EQD,RF                                                           
CBLD14D  GOTO1 =A(POLISH),DMCB,(9,(R4)),PTPSTACK                                
         L     RF,DMCB             END OF STACK                                 
         ST    RF,PTPSTACK         SAVE                                         
*                                                                               
         CLI   RCLSPCL,RCLSPEXR    EXCHANGE RATE FUNCTION                       
         BNE   CBLD14E                                                          
         BCTR  RF,0                BUMP BACK FOR END MARKER                     
         SHI   RF,(EQLNQ*2)        BUMP TO PREVIOUS OPERATOR/OPERAND            
         MVI   EQTYPE,EQFRGN       CHANGE OPERATOR TO EXRATE FUNCTION           
         MVC   EQCOL#,COLNUM       SAVE COLUMN NUMBER                           
         MVI   COLACM,X'FF'        SPECIAL INICATOR                             
         OI    COLOPT,COLFCAMT     MARK COLUMN FOR FOREIGN CURR.                
         MVI   COLTOTLV,X'FF'      DON'T TOTAL ON THIS COLUMN                   
         L     R6,AKYWCALF         POINT TO KEYWORD IN TABLE                    
         B     CBLD160                                                          
*                                                                               
CBLD14E  CLI   RCLSPCL,RCLSPSGN    Sign() Function                              
         BNE   CBLD14F                                                          
         MVI   COLTOTLV,X'FF'      DON'T TOTAL ON THIS COLUMN                   
         L     R6,AKYWSIGN                                                      
         B     CBLD160                                                          
                                                                                
CBLD14F  CLI   RCLSPCL,RCLSPCME    RUNNING TOTAL FUNCTION                       
         BNE   CBLD14G                                                          
         BCTR  RF,0                REMOVE END OF EQUATION MARKER                
         XC    EQD(EQLNQ),EQD                                                   
         MVI   EQTYPE,EQSUM        CUME() / SUM()                               
         MVC   EQCOL#,COLNUM                                                    
         LA    RF,EQLNQ(,RF)       MOVE TO NEW LOCATION                         
*                                                                               
         USING OPD,RF                                                           
         XC    OPD(OPLNQ),OPD                                                   
         MVI   OPTYPE,OPREG        OPERATOR                                     
         MVI   OPSYMBOL,C'+'       ADDITION                                     
         MVI   OPROUT#,OPADD                                                    
         LA    RF,OPLNQ(,RF)       MOVE TO NEW LOCATION                         
*                                                                               
         USING EQD,RF                                                           
         MVI   EQTYPE,EQEND        MARK NEW END                                 
         AHI   RF,1                                                             
         ST    RF,PTPSTACK         SAVE                                         
         L     R6,AKYWCUME         POINT TO KEYWORD IN TABLE                    
         B     CBLD160                                                          
*&&US                                                                           
CBLD14G  DS    0H                                                               
*&&                                                                             
*&&UK                                                                           
CBLD14G  CLI   RCLSPCL,RCLSPMAP    TYMAP() function                             
         BNE   CBLD160                                                          
         OI    POSTLVL,POSTDET     SET TO PROCESS TRANSACTIONS                  
         L     R6,AKYWTYMP         USED IN GETTYMP ON RL06                      
         B     CBLD160                                                          
*&&                                                                             
         DROP  RF                                                               
*                                                                               
CBLD150  TM    COLFLAGS,COLJOBR    IS IT A JOBBER TYPE COLUMN?                  
         BZ    CBLD153                                                          
*                                                                               
         MVC   WORK,SPACES                                                      
         SR    RF,RF                                                            
         IC    RF,RCLDATLN                                                      
         BCTR  RF,0                                                             
         EXMVC RF,WORK,RCLNDATA                                                 
*                                                                               
         TM    RCLOPT2,RCLDICT     DICTIONARY FORM ?                            
         BZ    CBLD152                                                          
         MVI   WORK,ESC#LFJT                                                    
         MVC   WORK+1(2),RCLNDATA                                               
         MVI   WORK+3,6                                                         
*                                                                               
CBLD152  GOTO1 =A(JESTADD),DMCB,(RCLXDATA,WORK),COLJOBRC,JOBFLDH                
         MVI   FCJOBBER,PROCACC    MAKE MONACC READ JOBBER                      
         L     R6,AKYWJOBR                                                      
         MVC   COLKYWD,SPACES                                                   
         MVC   COLKYWD,WORK        Save off translated keyword                  
         B     CBLD160                                                          
*                                                                               
CBLD153  TM    COLFLAGS,COLNJEST   IS IT A NON-JOBBER TYPE EST COLUMN?          
         BZ    *+12                                                             
         OI    ESTIND,ESTNOS       Read for estimates                           
         B     CBLD154                                                          
                                                                                
         TM    COLIND5,COLNJESR    OR NON-JOBBER TYPE EST HOURS/RATE            
         BZ    CBLD158                                                          
         OI    ESTIND,ESTHRS                                                    
*                                                                               
CBLD154  OI    RECREAD3,RECAESTS                                                
                                                                                
         MVC   COLKYWD,SPACES                                                   
         SR    RF,RF                                                            
         IC    RF,RCLDATLN                                                      
         BCTR  RF,0                                                             
         EXMVC RF,COLKYWD,RCLNDATA                                              
*                                                                               
         CLC   COLKYWD(2),=AL2(AC#RSEAM)   ESTIMATE WC AMOUNT                   
         BNE   CBLD155                                                          
         MVCDD WORK(6),AC#RSEAM            "ESNET"                              
         B     CBLD157                                                          
*                                                                               
CBLD155  CLC   COLKYWD(2),=AL2(AC#RSEGR)   ESTIMATE GROSS AMOUNT                
         BNE   CBLD156                                                          
         MVCDD WORK(6),AC#RSEGR            "ESGRS"                              
         B     CBLD157                                                          
*                                                                               
CBLD156  DS    0H                 "ESNETC" and "ESGRSC" have KYWDTAB            
         B     CBLD158             entries on RL05 for currency editing         
                                                                                
CBLD157  GOTO1 ADDICTAT,DMCB,C'SU  ',WORK,0                                     
         MVC   COLKYWD,SPACES                                                   
         MVC   COLKYWD,WORK                                                     
         L     R6,AKYWNJES                                                      
         B     CBLD160                                                          
*                                                                               
CBLD158  GOTO1 =A(KYWFIND)         Get data from data table                     
         LTR   R6,R6                                                            
         BNZ   CBLD160             Got keyword from table                       
         CLI   ERROR#,0                                                         
         BNE   CBUILDX                                                          
         OI    COLOPT,COLUDEF      User defined                                 
         GOTO1 =A(USERDEF)         Build user definded keyword table            
         BNE   CBUILDX                                                          
         MVC   COLUDSEQ,UDEFSEQ#                                                
*                                                                               
         USING KYWD,R6                                                          
CBLD160  ST    R6,COLINDEX         A(Keyword)                                   
         MVC   COLDD#,KYWDD#       Data dictionary #                            
*&&UK                              Test old style estimate hours kywds:         
         CLC   COLKYWD(3),=C'OEH'  OEH/OEHB/OEHN/OEHR                           
         BE    *+10                                                             
         CLC   COLKYWD(3),=C'CEH'  ditto CEH                                    
         BE    *+10                                                             
         CLC   COLKYWD(3),=C'HRH'  ditto HRH                                    
         BNE   *+12                                                             
         MVI   COLSEC#,KYWSSRTE    Set security (using FCON Sales Rate)         
         B     *+10                                                             
*&&                                                                             
         MVC   COLSEC#,KYWSECGP                                                 
         TM    DDLNKIND,DDLNKGBL   RLP Global report                            
         BO    CBLD160A            Let DDLINK handle this                       
         GOTOR VALFLDN,COLSEC#                                                  
         BNL   CBLD160A                                                         
         OI    COLFLAGS,COLHIDE    Remove from user view                        
         OI    COLIND4,COLNOSEC    Access denied                                
CBLD160A DS    0H                                                               
*&&UK                                                                           
         TM    KYWIND6,KYWXRATE    Test Exchange rate keyword                   
         BZ    *+8                                                              
         OI    COLIND6,COLXRATE    skip test for $$ in rl04                     
         TM    KYWIND7,KYWNOCUR    Test no currency prefix                      
         BZ    *+8                                                              
         OI    COLIND6,COLNOCUR    Don't print currency prefix                  
*&&                                                                             
*&&US                                                                           
         TM    KYWIND6,KYWCACR     Test keyword requires contra a/c             
         BZ    CBLD160B                                                         
         TM    POSTLVL2,POSTCAC    Test reading contras                         
         BNZ   CBLD160B            Yes - OK                                     
         MVI   ERROR#,22           "Format must include contra a/c"             
         B     CBUILDX                                                          
CBLD160B DS    0H                                                               
         CLC   KYWDD#,=AL2(AC#RSADA)                                            
         BE    *+14                                                             
         CLC   KYWDD#,=AL2(AC#RSBAV)                                            
         BNE   CBLD161                                                          
         OI    COLFLAGS,COLAMT+COLCALC+COLSUPDL                                 
         MVC   COLXTRA,PTPSTACK    Save start of stack                          
         MVC   COLEDOPT,RCLEDOPT   Initialize column edit options               
         CLI   COLEDOPT,0                                                       
         BNE   *+10                                                             
         MVC   COLEDOPT,FMTPIND                                                 
         OI    COLOPT,COLFCALC+COLCZERO     Force calculation                   
         OI    COLIND2,COLRNDBF    Round before processing a record             
         TM    RCLOPT3,RCLKPSIG    Keep significance when adding to tot         
         BZ    *+8                 No                                           
         NI    COLIND2,TURNOFF-COLRNDBF                                         
         OI    COLIND4,COLCFAV                                                  
         OI    FMTIND,FMTIERR                                                   
         OC    COLRTOTS,=X'FFFFFFFE'  All except first row                      
         LA    RE,TEMPAREA                                                      
         CLC   KYWDD#,=AL2(AC#RSADA)                                            
         BE    *+8                                                              
         LA    RE,TEMPAREA+L'CFEXP                                              
         GOTO1 =A(POLISH),DMCB,(L'CFEXP,(RE)),PTPSTACK                          
         MVC   PTPSTACK,DMCB                                                    
*&&                                                                             
CBLD161  TM    COLFLAGS,COLAMT     If amount it is ok                           
         BO    CBLD162                                                          
         TM    KYWIND3,KYWTRNS     Transaction detail keyword                   
         BZ    CBLD162                                                          
         NI    FMTPONCE,TURNOFF-FMTPON    Post once per account -> No           
                                                                                
         USING EDITD,R1                                                         
CBLD162  MVC   COLDTIDX,FMTDTIDX   Default                                      
         TM    KYWIND5,KYWISDTE    Is date type ?                               
         BZ    CBLD164                      No                                  
         TM    DDLNKIND,DDLNKON+DDLNKTST    DDLINK on ?                         
         BZ    CBLD164                      No                                  
         MVI   COLDTIDX,((DATEISO-DATEFMT)/DATELNQ)+1                           
         B     CBLD170                                                          
                                                                                
CBLD164  SR    R1,R1                                                            
         ICM   R1,3,KYWEDIT                                                     
         BZ    CBLD170                                                          
         A     R1,EDTBASE                                                       
         CLI   EDITTYPE,DATETYPE   Date type ?                                  
         BNE   CBLD170             No                                           
         CLI   EDITDTE2,EDITYEAR                                                
         BNE   *+8                                                              
         MVI   RCLDTEFM,EDITYEAR   Over-ride to YYYY                            
         CLI   EDITDTE2,EDITMNTH                                                
         BNE   *+8                                                              
         MVI   RCLDTEFM,EDITMNTH   Over-ride to MMM                             
*                                                                               
         USING DATED,R1                                                         
         CLI   RCLDTEFM,0          Was this set by col profile ?                
         BE    CBLD170             No                                           
         L     R1,ADATEFMT                                                      
         LA    RF,DATEFMT#         Number of entries                            
CBLD165  CLC   DATEFORM,RCLDTEFM   Match on form type                           
         BE    CBLD168                                                          
         LA    R1,DATELNQ(,R1)                                                  
         BCT   RF,CBLD165                                                       
         DC    H'00'                                                            
*                                                                               
CBLD168  SHI   RF,DATEFMT#+1                                                    
         LPR   RF,RF                                                            
         STC   RF,COLDTIDX         Save off index                               
         DROP  R1                                                               
*                                                                               
CBLD170  SR    R1,R1                                                            
         ICM   R1,3,COLDD#         R1 = Dictionary # value                      
         CLC   COLKYWD,SPACES                                                   
         BH    *+10                                                             
         MVC   COLKYWD,KYWCODE     Save for PQIX and debug info                 
                                                                                
         CHI   R1,AC#RSSQN         Sequence Number keyword                      
         BNE   *+8                                                              
         OI    COLEDOPT,RCLEDZRY   Print blank as zero                          
*                                                                               
         CLI   FCIND,FCNEWGL       Only for New GL                              
         BNE   CBLD176                                                          
         CHI   R1,AC#RSDRA         Debit keyword                                
         BNE   CBLD172                                                          
         MVI   COLBUCK,X'FF'                                                    
         OI    COLIND1,COLBUKDR                                                 
                                                                                
CBLD172  CHI   R1,AC#RSCRA         Credit keyword                               
         BE    CBLD174                                                          
         CHI   R1,AC#RSBAL         Balance keyword                              
         BE    CBLD174                                                          
*&&US*&& CHI   R1,AC#PLBAL         Reverse Balance Keyword                      
*&&UK*&& C     R1,=AL4(AC#PLBAL)   (UK) Number is > x'7FFF'                     
         BNE   CBLD176                                                          
CBLD174  MVI   COLBUCK,X'FF'                                                    
                                                                                
CBLD176  TM    RCLOPT3,RCLRDATY+RCLRDATN       Is one of these set ?            
         BNZ   CBLD15CA                        Yes                              
         TM    FMTPOPT1,RPFRDAT    Force redundant column data profile          
         BZ    CBLD15CC            Not on, so don't worry                       
         TM    COLFLAGS,COLAMT     Not applicable to amount column              
         BO    CBLD15CC            Skip amount column                           
         TM    KYWIND3,KYWRATE     Not applicable to rate   column              
         BO    CBLD15CC            Skip rate column                             
         OI    RCLOPT3,RCLRDATY    Set on as default                            
*                                                                               
CBLD15CA TM    RCLOPT3,RCLRDATY    Repeating data option ?                      
         BZ    CBLD15CC            Option varies for amount vs non-amt          
         OI    COLOPT2,COLFCPRT    Print redundante info or copy down           
         TM    COLFLAGS,COLAMT                                                  
         BZ    CBLD15CC            No no totals to worry about                  
         MVI   COLTOTLV,X'FF'      Turn off totals on all lines                 
*                                                                               
CBLD15CC CHI   R1,AC#RSMWR         If MWR then always set calendar              
         BNE   *+8                                                              
         OI    COLIND1,COLCNDR     Set to use calendar                          
         CHI   R1,AC#RSSHR         Standard hours                               
         BE    CBLD15CE                                                         
         CHI   R1,AC#RSEHR         Edit     hours                               
         BE    CBLD15CE                                                         
*&&US*&& CHI   R1,AC#RSMTS         Missing time sheets                          
*&&UK*&& C     R1,=AL4(AC#RSMTS)   (UK) Number is > x'7FFF'                     
         BNE   CBLD15CF                                                         
         OI    COLOPT2,COLFCPRT    Print redundante info or copy down           
*                                                                               
CBLD15CE OI   COLOPT2,COLDSKIP                                                  
         OI   COLIND3,COLNATSR+COLNASRT    Don't add columns together           
*                                                                               
CBLD15CF CHI   R1,AC#RSSQN         Sequence number ?                            
         BNE   *+8                                                              
         OI    COLEDOPT,COLPZERO   Force to print zero                          
*&&US                                                                           
         CHI   R1,AC#FUND$         Funded dollars                               
         BE    *+8                                                              
         CHI   R1,AC#AUTH$         Authorized dollars                           
         BNE   *+8                                                              
         OI    COLIND3,COLALVL$    Account level amounts                        
*&&                                                                             
         CHI   R1,AC#RSCLM         Credit limit                                 
         BE    *+8                                                              
         CHI   R1,AC#RSICL         Internal credit limit                        
*&&US*&& BNE   CBLD15CG                                                         
*&&UK                                                                           
         BE    *+12                                                             
         C     R1,=AL4(AC#RSJFE)   Budget/Fee amount                            
         BNE   CBLD15CG                                                         
*&&                                                                             
         OI    COLIND3,COLALVL$    Account level amounts                        
*&&UK*&& OI    COLIND4,COLNCZAM    Don't check zero amount                      
         TM    COLOPT2,COLFCPRT    Print redundant info or copy down            
         BZ    CBLD15CG                                                         
         OI    COLIND3,COLNATSR+COLNASRT                                        
*                                                                               
CBLD15CG CHI   R1,AC#RSMWR         Man Week Ratio                               
         BE    CBLD15CI                                                         
         CHI   R1,AC#RSPCT         Client time/Total 1R + 1N time               
         BE    CBLD15CI                                                         
         CHI   R1,AC#RSPTC         Client time/Total 1R time                    
         BE    CBLD15CI                                                         
         CLI   KYWREAD,KYWP$AJ                                                  
         BE    CBLD15CI                                                         
         CHI   R1,AC#RSTHR         Total hours keyword                          
         BE    *+8                                                              
         CHI   R1,AC#RSTHC         Total client hours keyword                   
         BNE   CBLD15CJ                                                         
         MVI   COLTOTLV,X'FF'      No totaling                                  
*                                                                               
CBLD15CI OI    FMTSW,FMTTHRON      Must process total hours                     
         OI    THRSW,THRON         At least one format has it                   
*                                                                               
                                                                                
CBLD15CJ CLI   KYWREAD,KYWP$AJ     Payroll adjusted                             
         BNE   CBLD15CK            No                                           
         OI    COLOPT2,COLTHRS     Set to indicate total hours column           
         OI    FMTSW,FMTP$AON                                                   
         OI    THRSW,THRP$A                                                     
                                                                                
CBLD15CK CLI   KYWREAD,KYWTHRS     Read person total hours record ?             
         BNE   CBLD15D             No                                           
         OI    COLOPT2,COLTHRS     Set to indicate total hours column           
         CHI   R1,AC#RSTHR         Total hours                                  
         BE    *+8                                                              
         CHI   R1,AC#RSTHC         Total client hours                           
         BNE   *+8                                                              
         OI    COLOPT2,COLDSKIP    Skip date check                              
         TM    KYWIND4,KYWIPCT     Is it a percent type keyword ?               
         BO    CBLD15D             No                                           
*        OI    FMTFLAG,FMTBYCOL    Yes, not sure what this does anymore         
         OI    COLIND3,COLNATSR+COLNASRT    Don't add columns together          
*                                                                               
CBLD15D  TM    KYWIND4,KYWIPCT     percent type column ?                        
         BZ    CBLD15E                                                          
         OI    COLEDOPT,COLPCT     Set to print %  sign                         
*                                                                               
ELM      USING RFLELD,WORK                                                      
                                                                                
CBLD15E  L     RE,=A(CNTRKYW)                                                   
*                                                                               
         SR    R1,R1                                                            
CBLD15F  ICM   R1,1,0(RE)                                                       
         BZ    CBLD15H             End of table ?                               
         CLC   KYWDD#,1(RE)        Match on keyword #                           
         BE    CBLD15G             Yes                                          
         AR    RE,R1               No, next entry                               
         B     CBLD15F                                                          
*                                                                               
CBLD15G  XC    WORK,WORK                                                        
         MVI   ELM.RFLEL,RFLELQ        X'C5'                                    
         LA    R1,RFLLNQ-3(,R1)                                                 
         STC   R1,ELM.RFLLN            Length                                   
         MVC   ELM.RFLSEQ,RCLSEQ       Column number                            
         MVI   ELM.RFLTYPE,RFLCNTR                                              
         MVI   ELM.RFLIND,RFLINTRL     Internally generated element             
         BCTR  R1,0                                                             
         EXMVC R1,ELM.RFLDATA,3(RE)                                             
         GOTO1 ADDEL,DMCB,(C'P',=CL8'ACCVBIG'),AIO2,WORK,0                      
         CLI   12(R1),0                                                         
         BE    CBLD15H                                                          
         DC    H'00'                                                            
         DROP  ELM                                                              
*                                                                               
CBLD15H  CLC   AC@SEQ#,KYWCODE                                                  
         BNE   *+8                                                              
         MVI   PARSEALL,YES        PARSE ALL DATA                               
         CLI   KYWREAD,KYWPART                                                  
         BNE   *+8                                                              
         OI    COLIND1,COLPART     PARTIAL PAYMENT                              
*                                                                               
         CLI   KYWREAD,KYWPRNP     READ PLANNING ESTIMATE # KEYWORD             
         BE    *+8                 YES, PROCESS IT                              
         CLI   KYWREAD,KYWPRNR     READ REVISION # KEYWORD                      
         BNE   CBLD15I             NO,  SKIP                                    
*                                  PROCESS PLANNING EST/REVISION #              
         GOTO1 =A(BLDPRN),DMCB,(R6),COLJOBRC,RCLXDATA                           
*                                                                               
CBLD15I  TM    COLFLAGS,COLAMT                                                  
         BZ    CBLD16H                                                          
         MVC   BYTE2,COLNUM        column number                                
         BRAS  RE,CKBUD            See if budget column                         
         BL    *+8                                                              
         OI    COLFLAGS,COLBUD     Set to budget column                         
                                                                                
         TM    KYWIND4,KYWBYDTE    DATE TYPES                                   
         BZ    *+8                                                              
         OI    POSTCTL,POSTBYDT                                                 
*                                                                               
         CLI   KYWREAD,0           SPECIAL RECORD?                              
         BE    CBLD15K                                                          
         CLI   KYWREAD,KYWSTDH                                                  
         BNE   *+8                                                              
         OI    COLIND1,COLSHRS     MARK AS STANDARD HOURS                       
                                                                                
         CLI   KYWREAD,KYWEDTH                                                  
         BNE   *+8                                                              
         OI    COLIND1,COLEHRS     MARK AS EDIT HOURS                           
                                                                                
         TM    COLIND1,COLSHRS+COLEHRS                                          
         BZ    *+10                                                             
         ZAP   COLHOURS,PKZERO                                                  
                                                                                
         CLI   KYWREAD,KYWP$AJ     Payroll adjusted amounts                     
         JNE   CBLD15I1            No                                           
         IC    RF,FMT#P$AJ                                                      
         AHI   RF,1                                                             
         STC   RF,FMT#P$AJ                                                      
         STC   RF,COLPAY#                                                       
         OI    COLIND1,COLPAY$+COLPADJ$                                         
         MVC   COLBUCK,KYWLVLQ     Set pay type bucket                          
         TM    COLOPT2,COLFCPRT    Print redundante info or copy down           
         JZ    *+8                                                              
         OI    THRSW,THRDET        Force detail now                             
                                                                                
CBLD15I1 CLI   KYWREAD,KYWPAY$                                                  
         BNE   CBLD15J                                                          
         OI    COLIND3,COLNATSR    Don't merge column /person in TSAR           
         OI    COLIND1,COLPAY$                                                  
         IC    RF,FMT#P$AJ                                                      
         AHI   RF,1                                                             
         STC   RF,FMT#P$AJ                                                      
         STC   RF,COLPAY#                                                       
         MVC   COLBUCK,KYWLVLQ     SET PAY TYPE                                 
         OI    COLOPT2,COLDSKIP                                                 
         TM    COLOPT2,COLFCPRT    Print redundante info or copy down           
         JZ    *+8                                                              
         OI    THRSW,THRDET        Force detail now                             
                                                                                
         TM    KYWIND3,KYWRATE     Sort as row so rate don't merge              
         JZ    CBLD15K             On in TSAR or out of sorter                  
         OI    RCLOPT3,RCLRDATY    Set on as default                            
         OI    COLOPT2,COLFCPRT    Print redundante info or copy down           
         OI    THRSW,THRDET        Force detail now                             
         B     CBLD15K             SET METHOD                                   
*                                                                               
CBLD15J  CLI   KYWREAD,KYWCST$                                                  
         BNE   CBLD15K                                                          
         TM    KYWIND4,KYWBUK                                                   
         BZ    *+14                                                             
         MVC   COLBUCK,KYWLVLQ                                                  
         OI    COLIND1,COLBUKDR    DEFAULT TO DR                                
         OI    COLOPT2,COLDSKIP                                                 
*                                                                               
CBLD15K  MVC   COLMTHD,QMTHD       SET UP DEFAULT METHOD                        
         TM    KYWIND1,KYWREV                                                   
         BZ    CBLD15L                                                          
         OI    COLOPT2,COLREVSG                                                 
         OI    FMTIND,FMTREVSG     FOUND REVERSE INDICATOR                      
*                                                                               
CBLD15L  TM    KYWIND4,KYWNOSQH                                                 
         BZ    *+8                                                              
         OI    COLOPT2,COLNOSQH                                                 
*                                                                               
         TM    COLFLAGS,COLCALC                                                 
         BO    CBLD16B                                                          
         GOTOR =A(ADDATE),DMCB,(R2),(R3),(R6),LCBLD                             
         TM    COLIND1,COLCNDR                                                  
         BZ    CBLD16A                                                          
         OI    RECREAD1,RECCLDR                                                 
         LH    RF,DTECOLLN                                                      
         AHI   RF,L'DTECOL                                                      
         STH   RF,DTECOLLN                                                      
         SR    RF,RF                                                            
         IC    RF,FMT#DTES                                                      
         AHI   RF,1                                                             
         STC   RF,FMT#DTES                                                      
*                                                                               
CBLD16A  TM    KYWIND4,KYWBDATE+KYWTDATE+KYWWDATE                               
         BZ    CBLD16B                                                          
         OI    COLOPT2,COLDSKIP    Don't check dates                            
         CLI   KYWREAD,KYWBLTQ     BALT or BALTCD                               
         BE    CBLD16B            Handle differently                            
         NI    COLOPT2,TURNOFF-COLDSKIP                                         
*&&US*&& TM    FMTROPT7,RPFFPDRD   Period date range by day?                    
*&&UK*&& TM    FMTROPT6,RPFFPDRD   Period date range by day?                    
         BO    CBLD16B                                                          
         MVC   COLSTART,COLALTST                                                
         MVC   COLEND,COLALTEN                                                  
*                                                                               
CBLD16B  TM    KYWIND2,KYWNOTOT    Total on column ?                            
         BZ    *+8                 Yes                                          
         MVI   COLTOTLV,X'FF'      No                                           
*                                                                               
         TM    COLIND3,COLCALDT    Do we know about it                          
         BO    CBLD16F             Yes                                          
         MVI   COL#DEC,4           Set to store as  4 decimals                  
         TM    COLFLAGS,COLCALC                                                 
         BO    CBLD16C             Already set                                  
         MVI   COL#DEC,2           Set to store as  2 decimals                  
         SR    R1,R1                                                            
         ICM   R1,1,KYWDCMLS       Keyword not typical decimals ?               
         BZ    CBLD16C             No, typical 2 decimals                       
         CHI   R1,99               Zero decimals wanted                         
         BNE   *+6                 No                                           
         SR    R1,R1               Yes, set to zero                             
         STC   R1,COL#DEC          # of decimals stored as                      
         CLI   RCLDCMLS,0          Did user over-ride                           
         BNE   CBLD16C             Yes                                          
         AHI   R1,1                Adjust to conform                            
         MVI   RCLDCMLS,TWODEC+1   Set a default                                
         SR    RF,RF                                                            
         ICM   RF,3,COLDD#                                                      
         CHI   RF,AC#RSPCT         Keyword = PCT                                
         BE    CBLD16C                                                          
         CHI   RF,AC#RSPTC         Keyword = PCTCLI                             
         BE    CBLD16C                                                          
         CHI   RF,AC#RSMWR         Keyword = MWR                                
         BE    CBLD16C                                                          
         STC   R1,RCLDCMLS         Set to number of decimals to print           
*                                                                               
CBLD16C  TM    COLEDOPT,COLPCT     Set to print % sign ?                        
         BZ    CBLD16CC            No                                           
         CLI   RCLDCMLS,0                                                       
         BNE   CBLD16CC                                                         
         MVC   RCLDCMLS,FMTPCT     Main default                                 
*                                                                               
CBLD16CC CLI   RCLDCMLS,0          Is # of decimals set by column ?             
         BNE   *+10                Yes                                          
         MVC   RCLDCMLS,FMTRNDTY   No, so set to use default                    
*                                                                               
         TM    KYWIND3,KYWNODEC    No decimals places when printing ?           
         BZ    *+8                 No                                           
         MVI   RCLDCMLS,1          Over-ride user even, no decimals             
*                                                                               
         MVI   COLROUND,0          Initialize not to round                      
         SR    R1,R1                                                            
         IC    R1,RCLDCMLS         If RCLDCMLS is 1 to 5 make 0 to 4            
         BCTR  R1,0                                                             
         STC   R1,COLDCMLS         Set potential number of decimals             
         TM    RCLDCMLS,X'80'      Is it a negative 1 byte number ?             
         BZ    CBLD16D             No                                           
         LHI   R1,-1               Make registar -1 or x'FFFFFFFF'              
         IC    R1,RCLDCMLS         Replace low end byte                         
         MVI   COLDCMLS,0          Set to no decimals, dollar or more           
*                                                                               
CBLD16D  SR    RF,RF                                                            
         IC    RF,COL#DEC          Number of decimals value is store as         
         SR    RF,R1               COL#DEC - (COLDCMLS or neg. #)               
         BZ    CBLD16F             Don't round if zero                          
         BP    CBLD16DC                                                         
         LPR   R1,RF               Shift <-- this way                           
         B     CBLD16DD                                                         
*                                                                               
CBLD16DC LA    R1,64               Max round factor                             
         SR    R1,RF               Shift --> that way                           
*                                                                               
CBLD16DD STC   R1,COLROUND         Save off rounding factor                     
         TM    KYWIND2,KYWFC$      Test currency cash column                    
         BZ    *+12                                                             
         OI    COLOPT2,COLNORND    Don't apply any rounding                     
         MVI   COLROUND,0                                                       
*                                                                               
CBLD16F  TM    KYWIND3,KYWRATE     Sort as row so rate don't merge              
         BZ    CBLD16H             On in TSAR or out of sorter                  
         OI    FMTFLAG,FMTRATES               Rates used on format              
         OI    COLIND3,COLNATSR+COLNASRT      Don't add column together         
         OI    COLIND2,COLRATE                Rate type keyword                 
         NI    COLFLAGS,TURNOFF-COLAMT                                          
         TM    KYWIND2,KYWFC$      SORTING BY FOREIGN CURRENCY CODE?            
         BZ    *+8                                                              
         OI    COLOPT,COLFCAMT                                                  
         ZIC   R1,FMT#RTES         Bump up number of rates created              
         AHI   R1,1                                                             
         STC   R1,FMT#RTES         Save information                             
         TM    RANKSW,RANKON       Ranked ?                                     
         BZ    CBLD18              No                                           
         OI    RANKSW,RANKRTE      Rate on ranked format                        
         CLC   COLNUM,FMTRNK#3     Are we ranking on this column ?              
         BNE   CBLD18              No                                           
         OI    FMTSW,FMTRKRTE      Ranking specificly on rate                   
         NI    FMTSW,TURNOFF-FMTRANK       Not ranking as usual                 
         B     CBLD18                                                           
*                                                                               
CBLD16H  CLC   KYWDD#,=AL2(AC#RSUSF)  IS IT USER FIELD KEYWORD                  
*&&US*&& BE    CBLD16J                                                          
*&&US*&& CLC   KYWDD#,=AL2(AC#RSUSC)  IS IT USER FIELD KEYWORD                  
*&&US*&& BE    CBLD16J                                                          
*&&US*&& CLC   KYWDD#,=AL2(AC#AUUF)   Is it Auth user field keyword             
         BNE   CBLD16R                                                          
*                                                                               
CBLD16J  MVC   COLFILT,PTCCODES       AREA TO STORE FILTERS                     
         L     RE,COLFILT                                                       
         SR    RF,RF                                                            
         IC    RF,RCLDATLN            GET DATA                                  
         SHI   RF,3                   DATA = AL2(UF#),C'UF',C'UF',C'UF'         
         EXMVC RF,0(RE),RCLNDATA+2                                              
         LA    RE,1(RF,RE)                                                      
         MVI   0(RE),EOT                                                        
         AHI   RE,1                                                             
         ST    RE,PTCCODES                                                      
*                                                                               
CBLD16R  CLI   KYWREAD,KYWPPDQ     PERIOD TIME SHEET DAY                        
         BNE   CBLD16T                                                          
         OI    COLIND1,COLCNDR     SET AS CALENDAR BASED (NON$)                 
         MVC   COLPERST,RCLSTDT+1  # DAYS FROM START OF PERIOD                  
         B     CBLD20              SPECIAL CASE                                 
*                                                                               
CBLD16T  TM    KYWIND3,KYWPRTCL    ALWAYS PRINT DATA IN COLUMN                  
         BZ    *+8                                                              
         OI    COLOPT2,COLFCPRT    FORCE COLUMN TO PRINT                        
         TM    COLFLAGS,COLAMT     IGNORE IF ACCUMULATED COLUMN                 
         BZ    CBLD18                                                           
*                                                                               
         TM    KYWIND3,KYWSPLT     SPLIT COLUMN DATA?                           
         BZ    CBLD17                                                           
         GOTO1 =A(VALSPLT)                                                      
         BNE   CBLD17                                                           
         OI    COLFLAGS,COLSPLT                                                 
         OI    SPLITIND,SPLITCOL                                                
*                                                                               
CBLD17   MVC   COLDSP,FMTACMLN     SAVE DISP OF ACCUM FOR THIS COL              
         LA    RE,PKLEN            BUMP TO NEXT LOCATION                        
         AH    RE,FMTACMLN         BUMP UP CURRENT DISP.                        
         STH   RE,FMTACMLN         SAVE FOR NEXT ONE                            
*                                                                               
         TM    KYWIND2,KYWAGE      AGEING COLUMN                                
         BZ    *+8                 NO                                           
         TM    FMTIND,FMTIAGE0                                                  
         BZ    *+12                                                             
         OI    COLOPT,COLCZERO     MARK TO CHECK IF COL=ZERO                    
         OI    FMTFLAG,FMTCZERO    MARK OPTION ON                               
         TM    KYWIND2,KYWFC$      SORTING BY FOREIGN CURRENCY CODE?            
         BZ    *+8                                                              
         OI    COLOPT,COLFCAMT                                                  
*                                                                               
CBLD17A  TM    COLFLAGS,COLCALC    Ignore if column calculation                 
         BO    CBLD20                                                           
         LA    RE,BILLDTE          Post by billing date                         
         TM    KYWIND4,KYWBDATE                                                 
         BO    CBLD17C                                                          
         LA    RE,TRFRDTE          Post by transfer date                        
         TM    KYWIND4,KYWTDATE                                                 
         BO    CBLD17C                                                          
         LA    RE,WROFDTE          Post by write-off date                       
         TM    KYWIND4,KYWWDATE                                                 
         BO    CBLD17C                                                          
*                                                                               
         LA    RE,TRANDTE          Post by transaction date (default)           
         CLI   COLDATES,COLDDTE    Should we use Due/Bill/Moa etc date?         
         BNE   *+8                 No                                           
         LA    RE,DUEDTE           Post by due date of transaction              
         CLI   COLDATES,COLBMOA    Should we use billed MOA date?               
         BNE   *+8                 No                                           
         LA    RE,BMOADTE          Post by due date of transaction              
         CLI   COLDATES,COLSDTE    Statement date ?                             
         BNE   *+8                 No                                           
         LA    RE,STMTDTE          Post by Statement date                       
         CLI   COLDATES,COLMOS     MOS date ?                                   
         BNE   *+8                 No                                           
         LA    RE,CURMMOS          Post by MOS date                             
         CLI   COLDATES,COLADTE    Activity date ?                              
         BNE   CBLD17C             No                                           
         LA    RE,ACTDTE           Post by transaction activity date            
         TM    KYWIND2,KYWAGE      Ageing column                                
         BZ    *+8                 No                                           
         LA    RE,ACTAGE           Post by first transaction activity           
*                                                                               
CBLD17C  CLI   COLDATES,COLMDTE    MOA ?                                        
         BNE   CBLD17D             No                                           
         LA    RE,BMOADTE          Post by billing MOA                          
         TM    KYWIND4,KYWBDATE                                                 
         BO    CBLD17D                                                          
         LA    RE,TMOADTE          Post by transfer MOA                         
         TM    KYWIND4,KYWTDATE                                                 
         BO    CBLD17D                                                          
         LA    RE,WMOADTE          Post by write-off MOA                        
         TM    KYWIND4,KYWWDATE                                                 
         BO    CBLD17D                                                          
         LA    RE,MOADTE           Post by transaction MOA                      
         TM    KYWIND2,KYWAGE      Ageing column ?                              
         BNO   *+8                 No                                           
         LA    RE,MOAAGE           Post by first Transaction MOA                
*                                                                               
CBLD17D  ST    RE,COLDATE          Save address for latter in ACMBLD            
*                                                                               
CBLD17E  CLI   QPROG,PRODUCTION                                                 
         BNE   CBLD20                                                           
         TM    KYWIND2,KYWAGE      IS IT AN AGEING COLUMN?                      
         BZ    CBLD20                                                           
         CLI   KYWREAD,KYWAGET     AGE1 KEYWORD?                                
         BNE   CBLD20              ONLY WANT AGE1, SO SKIP                      
*                                                                               
         USING JAIDATED,R1                                                      
         SR    R1,R1                                                            
         IC    R1,AGECOL#          NUMBER OF AGEING COLUMNS SO FAR              
         LA    R1,1(,R1)                                                        
         STC   R1,AGECOL#          NEW NUMBER OF AGEING COLUMNS                 
         MVC   COLAGE#,AGECOL#                                                  
         BCTR  R1,0                                                             
         MHI   R1,JAIDATEQ                                                      
         A     R1,JBAGECOL         DATE PAIR TABLE                              
         MVC   JAISTADT,COLSTART                                                
         MVC   JAIENDDT,COLEND                                                  
         B     CBLD20                                                           
         DROP  R1                                                               
***********************************************************************         
*  BUILD NEW ADITIONAL ROW ELEMENTS FROM COLUMNS                      *         
***********************************************************************         
         SPACE 1                                                                
         USING RRWELD,RE                                                        
CBLD18   L     RE,POINTER          Point to current postion in row pool         
         XC    RRWEL(RRWLNQ+7),RRWEL                                            
         MVI   RRWEL,RRWELQ        Row element code, X'C2'                      
         MVI   RRWLN,RRWNLNQ+6     Row element length                           
         MVC   RRWSEQ,RCLSORTN     Sort option order                            
         CLC   HIGHSEQ,RRWSEQ      Which is greater                             
         BNL   *+10                                                             
         MVC   HIGHSEQ,RRWSEQ      Save greatest number                         
         TM    RCLOPT2,RCLTOT      Total on column ?                            
         BZ    *+8                 No                                           
         OI    RRWOPT,RRWTOT       Yes, so mark in row                          
         TM    RCLOPT2,RCLNAME     Print name ?                                 
         BZ    *+8                 No                                           
         OI    RRWOPT,RRWNAME      Yes, so mark in row                          
         TM    RCLOPT2,RCLCODE     Print code ?                                 
         BZ    *+8                 No                                           
         OI    RRWOPT,RRWCODE      Yes, so mark in row                          
         TM    RCLOPT2,RCLLVL      Only level portion of account ?              
         BZ    *+8                 No                                           
         OI    RRWOPT2,RRWLVL      Yes, so mark in row                          
         TM    RCLOPT2,RCLSHRT     Use workcode short name                      
         BZ    *+8                 No                                           
         OI    RRWOPT2,RRWSHRT     Yes, so mark in row                          
         TM    RCLOPT,RCLMERGE     Merge data if selected $COLS=ZERO            
         BZ    *+8                 No                                           
         OI    RRWOPT2,RRWMERGE    Yes, so mark in row                          
         MVI   RRWTYPE,ROWCOL      Mark as column type                          
         TM    RCLOPT4,RCLAIDX     Indexing on for Accent download              
         BZ    *+8                                                              
         OI    RRWOPT2,RRWAIDX     Pass to row                                  
*&&US                                                                           
         TM    RCLOPT4,RCLXCOL     Process column + hide + don't sort           
         BZ    *+8                                                              
         OI    RRWOPT3,RRWXCOL                                                  
*&&                                                                             
         STCM  R3,15,RRWNDATA      Point back to column table info.             
         MVI   RRWDATLN,6          Force to length of 6                         
         SR    RF,RF                                                            
         IC    RF,RRWLN                                                         
         AR    RE,RF               Bump up to next element space                
         MVI   0(RE),0             Mark end of elements                         
         ST    RE,POINTER          Save new address location                    
         DROP  RE                                                               
*                                                                               
CBLD20   MVC   COLSIZE,RCLWDTH     Their's is greater so move in                
         CLI   COLSIZE,0           Is column width zero ?                       
         BNE   *+8                 No                                           
         OI    COLFLAGS,COLHIDE    Yes, hide columns with width of zero         
         TM    DDLNKIND,DDLNKON+DDLNKTST    DDLINK running                      
         BZ    CBLD20A                      No                                  
         MVI   COLSIZE,12                   Yes, force max heading              
         TM    DDLNKIND,DDLNKQKR   Quick reports                                
         BO    CBLD20A             Yes, don't pass hidden cols                  
*&&UK*&& TM    COLIND4,COLNOSEC    Access denied?                               
*&&UK*&& BO    CBLD20A             Yes, don't pass cols                         
         TM    COLFLAGS,COLHIDE    No, pass hidden cols plus indicator          
         BZ    CBLD20A                                                          
         NI    COLFLAGS,TURNOFF-COLHIDE                                         
         OI    COLIND4,COL2HIDE    Change flow of code, let DDLINK hide         
                                                                                
CBLD20A  TM    COLIND3,COLNATSR                                                 
         BZ    *+8                                                              
         OI    FMTFLAG,FMTBYCOL    Yes, not sure what this does anymore         
         TM    COLIND2,COLRATE     Is it a rate ?                               
         BZ    CBLD21              No                                           
         TM    COLFLAGS,COLHIDE    Is it hidden ?                               
         BO    CBLD21                    Yes, So FMTFRATE is OK as is           
         NI    FMTSW,TURNOFF-FMTFRATE    No deal now                            
*                                                                               
CBLD21   MVC   COLSRTSZ,KYWSRTQ    Move in actual sort size                     
         MVC   COLSTACK,RCLSTACK                                                
         TM    COLOPT,COLUDEF      User defined keyword ?                       
         BZ    CBLD22              No                                           
         MVI   COLSRTSZ,0                                                       
         MVC   COLSRTSZ+1(1),UDEFSRTS  New size of sort key                     
         MVC   COLDATSZ,UDEFDATS       New size of sort data                    
*                                                                               
CBLD22   TM    COLFLAGS,COLAMT     Do only for accumulated columns              
         BZ    CBLD40                                                           
         XC    HALF,HALF                                                        
         MVC   HALF+1(1),COLSIZE                                                
         CLC   COLSRTSZ,HALF       If field is > column width then              
         BH    *+10                                                             
         MVC   COLSRTSZ,HALF       Shrink field size                            
*                                                                               
         ZIC   R1,FMT#ACMS         Bump up number of accums created             
         LA    R1,1(,R1)                                                        
         STC   R1,FMT#ACMS         Save off this information                    
*                                                                               
         BCTR  R1,0                                                             
         LA    RE,FMT@COL#(R1)                                                  
         MVC   0(1,RE),COLNUM                                                   
         MHI   R1,PKLEN                                                         
         STH   R1,COLACM           Save displacment into row of accums          
*                                                                               
CBLD40   ST    R2,COLHEAD1         Save off address of RCLEL                    
         ZIC   RF,FMT#COLS         Number of columns so far                     
         AHI   RF,1                                                             
         STC   RF,FMT#COLS         Number of columns                            
         ZIC   R1,1(,R2)           Bump to next element                         
         AR    R2,R1                                                            
         AHI   R3,COLLNQ                                                        
         B     CBLD05              Loop to get next element                     
*                                                                               
CBLD99   BRAS  RE,SCOLUMN          Secure columns (Security)                    
         BRAS  RE,CHEADS           Build column headings                        
         ST    R3,PTRCOL           Next availabe spot for next format           
         L     RE,PTRBXCOL         Mark right side of boxes                     
         MVI   0(RE),C'R'                                                       
*                                                                               
         TM    DDLNKIND,DDLNKON+DDLNKTST                                        
         BNZ   CBLD99E                                                          
         L     R3,FMTCOL                                                        
         SR    R0,R0                                                            
         IC    R0,FMT#COLS                                                      
CBLD99A  TM    COLIND1,COLCNDR     Calendar type heading ?                      
         BZ    CBLD99D             No                                           
         TM    COLOPT,COLSFTH                                                   
         BZ    CBLD99D                                                          
         ICM   R4,15,COLHEAD1      Clear heading 1                              
         BZ    CBLD99D                                                          
         BAS   RE,CLRHEAD                                                       
         ICM   R4,15,COLHEAD2      Clear heading 2                              
         BZ    CBLD99D                                                          
         BAS   RE,CLRHEAD                                                       
CBLD99D  AHI   R3,COLLNQ                                                        
         BCT   R0,CBLD99A                                                       
*                                                                               
CBLD99E  L     RE,FMTBOXCL         Re-load A(Start of BXCOL)                    
         AHI   RE,STDPGWD          Bump to  next available spot                 
         ST    RE,PTRBXCOL         point to next space                          
*                                                                               
         L     RE,FMTCHEAD         Re-load A(Start of column heads)             
         L     R3,PTRCHEAD         Use to calculate page width                  
         SR    R3,RE                                                            
         STC   R3,FMTREPWD         Save in format report width                  
         LA    RE,NHD*STDPGWD(,RE) Bump up length of NHD headings               
         ST    RE,PTRCHEAD         Point to next space                          
         GOTOR =A(SETFONT)                                                      
*                                                                               
         L     RF,FMTPGEWD                                                      
         TM    DWNOPT1,DWNGO       Downloading ?                                
         BO    CBLD99F             Don't check report width                     
         CR    RF,R3               Page width vs report width                   
         BNL   *+8                                                              
         MVI   ERROR#,7            Report to wide for paper                     
                                                                                
CBLD99F  SR    RE,RE                                                            
         D     RE,=F'3'            Divide by 3                                  
         SHI   RF,6                Adjust to move it right more                 
         STH   RF,MAXINDNT                                                      
*                                                                               
         BAS   RE,STACKCOL                                                      
         BAS   RE,SORTPOOL         Sort new row column elements                 
*                                                                               
CBUILDX  CLI   ERROR#,0            Set CC                                       
CXIT     XIT1                                                                   
         DROP  R6                                                               
         SPACE 1                                                                
***********************************************************************         
*  CLEAR TEMPORARY DATA FROM COLUMN HEADING                           *         
*  R3 = CURRENT  COLUMN TABLE ENTRY                                   *         
*  R4 = START OF COLUMN HEADING PRINT AREA                            *         
***********************************************************************         
CLRHEAD  SR    RF,RF                                                            
         IC    RF,COLSIZE                                                       
CLRHEAD1 CLI   0(R4),BLANK                                                      
         BE    CLRHEAD9                                                         
         MVI   0(R4),BLANK         BLANK OUT TEMP DATA                          
         AHI   R4,1                                                             
         BCT   RF,CLRHEAD1                                                      
CLRHEAD9 BR    RE                  FINISHED                                     
         EJECT                                                                  
***********************************************************************         
* Build column headings now                                                     
***********************************************************************         
         USING RCLELD,R2                                                        
         USING KYWD,R6                                                          
CHEADS   NTR1                                                                   
         L     R3,FMTCOL                                                        
         ZIC   R0,FMT#COLS                                                      
         XC    PRVHEAD1,PRVHEAD1                                                
         XC    PRVHEAD2,PRVHEAD2                                                
         XC    PRVCH1LC,PRVCH1LC                                                
         XC    PRVCH2LC,PRVCH2LC                                                
         XC    SUPER2AD,SUPER2AD                                                
         MVI   SUPERCOL,0          Initialize super column flag                 
                                                                                
CHEAD010 L     R7,AACRL2D          Reload for each column                       
         L     R2,COLHEAD1         A(RCLEL) stored here temporarily             
                                                                                
         L     R6,COLINDEX                                                      
         CLI   0(R2),RCLELQ        X'C3' element ?                              
         BE    *+6                 Build next column heading                    
         DC    H'00'                                                            
                                                                                
         TM    COLFLAGS,COLAMT     Can do with amounts                          
         BO    CHEAD016                                                         
         SR    RF,RF                                                            
         ICM   RF,1,RCLHD1LN       Any heading 1                                
         BZ    CHEAD016            No so can't be this case                     
         ZIC   R1,RCLDATLN         Data length so we can get to head            
         LA    RE,RCLNDATA(R1)     Point to heading 1                           
         MVC   HEAD1COL,SPACES     Save temporarily in HEAD1COL                 
         BCTR  RF,0                                                             
         EXMVC RF,HEAD1COL,0(RE)                                                
         CLI   HEAD1COL,C'@'       Special table ?                              
         BNE   CHEAD016                                                         
                                                                                
         USING SUBTABD,R1                                                       
         ST    R0,SVR0             Save                                         
         L     R1,@SUBTAB          Substiute tables                             
         LHI   R0,1                                                             
         TM    TABIND,TABXTRN      Did we do this once                          
         BO    CHEAD014                                                         
         OI    TABIND,TABXTRN      External table                               
                                                                                
         ICM   RE,15,FMTCONS       Was this set in GETFORMT                     
         BNZ   CHEAD011            Yes                                          
         MVC   FMTCONS,ACONTAB     Initialize                                   
         B     CHEAD013                                                         
                                                                                
CHEAD011 ICM   RF,15,0(RE)         Get to end of list                           
         BZ    CHEAD012                                                         
         ST    RE,SVRE             Keep location of RE                          
         AR    RE,RF                                                            
         B     *-14                                                             
                                                                                
CHEAD012 SHI   RE,1                                                             
         CLI   0(RE),EOT           End of table                                 
         BE    *+6                                                              
         DC    H'00'                                                            
         ST    RE,ACONTAB                                                       
         L     RE,SVRE                                                          
         ICM   RF,15,0(RE)         Re-adjust size                               
         SHI   RF,1                                                             
         STCM  RF,15,0(RE)                                                      
                                                                                
CHEAD013 BRAS  RE,DSNTABS                                                       
                                                                                
CHEAD014 OC    SUBDATA,SUBDATA                                                  
         BZ    CHEAD01A                                                         
         CLC   SUBLABEL,HEAD1COL   Match table label                            
         BE    CHEAD015                                                         
         AHI   R0,1                                                             
         AHI   R1,SUBTLNQ                                                       
         B     CHEAD014                                                         
         DROP  R1                                                               
*                                                                               
CHEAD015 STC   R0,COLXTRN#         Save index into table                        
CHEAD01A L     R0,SVR0             Restore                                      
*                                                                               
CHEAD016 TM    COLFLAGS,COLHIDE    See if it is a hidden column                 
         BO    CHEAD900            Skip rest                                    
         ICM   RE,15,COLHEAD3                                                   
         BNZ   *+6                                                              
         DC    H'00'               Always set                                   
                                                                                
         TM    COLFLAGS,COLAMT                                                  
         BZ    CHEAD017                                                         
         MVC   HEAD_A(HEADEND-HEAD_A),0(RE)       Restore                       
         MVC   0(HEADEND-HEAD_A,RE),SPACES                                      
                                                                                
CHEAD017 MVC   ELHEAD1,SPACES      Clear                                        
         MVC   ELHEAD2,SPACES                                                   
         SR    R1,R1                                                            
         SR    RF,RF                                                            
         IC    RF,RCLDATLN                                                      
         LA    RE,RCLNDATA         Point to RCLNDATA                            
         AR    RE,RF               Point to heading 1                           
         ICM   R1,1,RCLHD1LN                                                    
         BZ    CHEAD018                                                         
         BCTR  R1,0                                                             
         EXMVC R1,ELHEAD1,0(RE)    Store heading 1                              
         LA    RE,1(R1,RE)                                                      
*                                                                               
CHEAD018 ICM   R1,1,RCLHD2LN       Length of heading 2                          
         BZ    CHEAD020                                                         
         BCTR  R1,0                                                             
         EXMVC R1,ELHEAD2,0(RE)    Store heading 2                              
*                                                                               
CHEAD020 ZIC   R1,COLSIZE          Width of column                              
         AHI   R1,1                Add one for space between columns            
         MVC   HEAD1COL,SPACES     Clear out column headings                    
         MVC   HEAD2COL,SPACES                                                  
         MVC   HEAD3COL,SPACES                                                  
*                                                                               
         OI    SUPERCOL,SUPERSTK   Set column indication for stacking           
         CLI   COLSTACK,0          Column stacking ?                            
         BNE   CHEAD030            Yes                                          
         NI    SUPERCOL,TURNOFF-SUPERSTK                                        
         L     RE,PTRCSPWK         Load current print location address          
         ST    RE,COLPRT           Save in column information                   
         AR    RE,R1               Bump up column by column width               
         ST    RE,PTRCSPWK         Save new location                            
***********************************************************************         
*  BUILD COLUMN HEADINGS                                              *         
***********************************************************************         
         SPACE 1                                                                
CHEAD030 TM    DWNOPT1,DWNGO       Down-loading ?                               
         BZ    CHEAD035            Yes, so don't right justify                  
         SHI   R1,1                -1 for the one we added if printing          
         TM    DDLNKIND,DDLNKON+DDLNKTST                                        
         BNZ   *+12                                                             
         TM    DWNOPT1,DWNCHOP     Fixed width data                             
         BO    *+8                                                              
         LA    R1,L'HEAD1COL                                                    
         L     R4,COLHEAD3         Set up location to save headings             
         XC    COLHEAD3,COLHEAD3   Clear                                        
         ST    R4,COLHEAD1         Location where to store 1st heading          
         STC   R1,COLHEAD1         Save max field size                          
         LA    RE,0(R4,R1)                                                      
         ST    RE,COLHEAD2         Location where to store 2nd heading          
         STC   R1,COLHEAD2         Save max field size                          
         AR    RE,R1               Point to end of headings                     
         TM    DDLNKIND,DDLNKON+DDLNKTST   DDLink mode ?                        
         BZ    CHEAD042                     No                                  
         ST    RE,COLHEAD3         Location where to store 3nd heading          
         STC   R1,COLHEAD3         Save max field size                          
         B     CHEAD042                                                         
*                                                                               
CHEAD035 TM    SUPERCOL,SUPERSTK   Column stacking ?                            
         BZ    CHEAD040            Yes                                          
         L     R4,COLHEAD3         Headings of stacked columns                  
         XC    COLHEAD3,COLHEAD3   Clear                                        
         ST    R4,COLHEAD1         Save location of heading 1                   
         TM    COLFLAGS,COLAMT                                                  
         BO    CHEAD042                                                         
         OI    COLOPT2,COLFCPRT    Always print data                            
         B     CHEAD042                                                         
*                                                                               
CHEAD040 L     RE,PTRBXCOL         LOAD CURRENT BOX HEADING LOCATION            
         ST    RE,PRVCOLBX         SAVE FOR super column headings               
         AR    RE,R1               BUMP UP COLUMN BY COLUMN WIDTH               
         MVI   0(RE),C'C'          MARK CENTER LINE                             
         ST    RE,PTRBXCOL         SAVE NEW LOCATION                            
         L     RE,PTRCHEAD                                                      
         LR    R4,RE               SAVE CURRENT LOCATION IN R4                  
         AR    RE,R1               BUMP UP COLUMN BY COLUMN WIDTH               
         ST    RE,PTRCHEAD         SAVE NEW LOCATION                            
*                                                                               
CHEAD042 CLI   RCLHD1LN,0          IS THERE A HEAD 1                            
         BNE   CHEAD046            YES, SO USE THIS ONE                         
         CLI   RCLHD2LN,0          NO HEADING 1. SO IS THERE A HEAD 2           
         BNE   CHEAD048            YES, SO USE THIS ONE                         
         B     CHEAD050            NO HEADINGS USED, USE DEFAULTS               
*                                                                               
CHEAD046 MVC   HEAD1COL(L'ELHEAD1),ELHEAD1       OVERRIDE HEADING1              
         CLI   HEAD1COL,C'&&'      LOOKING FOR BLANK HEADING                    
         BNE   CHEAD047            NO, SO CONTINUE                              
         OC    ELHEAD1,SPACES      FORCE UPPER CASE                             
         CLC   ELHEAD1+1(6),AC@RSBLK                                            
         BNE   CHEAD048            NO HEADINGS USED, USE DEFAULTS               
         MVC   HEAD1COL,SPACES                                                  
         OI    COLIND4,COLBLKHD    Set on                                       
         B     CHEAD048                                                         
                                                                                
CHEAD047 DS    0H                                                               
                                                                                
CHEAD048 CLI   RCLHD2LN,0          HAD HEAD 1 BUT IS THERE HEAD 2 ?             
         BE    CHEAD100                       NO                                
         MVC   HEAD2COL(L'ELHEAD2),ELHEAD2    OVERRIDE HEAD 2                   
         CLI   HEAD2COL,C'&&'                 LOOKING FOR BLANK HEADING         
         BNE   CHEAD100                       NO, SO CONTINUE                   
         OC    ELHEAD2,SPACES                 FORCE UPPER CASE                  
         CLC   ELHEAD2+1(6),AC@RSBLK                                            
         BNE   CHEAD100                                                         
         MVC   HEAD2COL,SPACES     BLANK OUT                                    
         B     CHEAD100                                                         
*                                                                               
CHEAD050 TM    COLIND1,COLCNDR                                                  
         BZ    CHEAD055                                                         
         OI    COLOPT,COLSFTH             SOFT HEADING                          
         TM    COLFLAGS,COLAMT                                                  
         BO    CHEAD055                                                         
         MVC   HEAD1COL(3),=C'DAY'        SPECIAL PERIOD DAY KEYWORD            
         MVC   HEAD2COL(2),=C'DD'         ROOM FOR DAY ONLY                     
         CLI   COLSIZE,DATESZQ                                                  
         BL    *+10                                                             
         MVC   HEAD2COL(8),DATE#8                                               
*                                                                               
CHEAD055 TM    COLFLAGS,COLAMT+COLCALC    IS A ACCUM &/OR CALC. COL?            
         BZ    CHEAD080                   NO, SO USE DEFAULT HEADING            
         TM    COLFLAGS,COLCALC                                                 
         BO    CHEAD100                   CALC. COL. SO LEAVE BLANK             
         TM    DDLNKIND,DDLNKON+DDLNKTST                                        
         BZ    CHEAD072                                                         
***********************************************************************         
*        Put code to combine head_A and head_B into head_C                      
*        Put code to put YTD, Q1 etc. into head_B                               
*        Put code to put ddictionary value into head_A                          
***********************************************************************         
         MVC   HEAD3COL(10),HEAD_A                                              
         CLC   HEAD_B,SPACES                                                    
         BE    CHEAD062                                                         
*&&UK                                                                           
         TM    DDLNKIND,DDLNKQKR   Quick reports ?                              
         BZ    CHEAD060            Yes, split headings into two lines           
         MVC   HEAD3COL+12(2),=C'^^'                                            
         MVC   HEAD3COL+15(9),HEAD_B                                            
         B     CHEAD062                                                         
*&&                                                                             
CHEAD060 MVI   HEAD3COL+12,C'-'                                                 
         MVC   HEAD3COL+14(10),HEAD_B                                           
                                                                                
CHEAD062 GOTOR ADSQUASH,DMCB,HEAD3COL,L'HEAD3COL                                
         MVC   COLHEAD3(1),7(R1)   Length of field                              
                                                                                
         MVC   HEAD2COL,HEAD_C     Set heading 2                                
         CLI   COLCLVL,2           Level 2                                      
         BL    CHEAD064            No level 1 so keep heading as is             
         BH    *+14                No level 3 so use  heading 2                 
         MVC   LV2HEADC,HEAD_C     Yes, save off heading 2                      
         BNE   *+10                                                             
         MVC   HEAD2COL,LV2HEADC   Set heading 2                                
                                                                                
CHEAD064 GOTOR LENSTR,DMCB,(L'HEAD2COL,HEAD2COL)                                
         STC   RF,COLHEAD2       Length of field                                
                                                                                
*&&UK*&& TM    DDLNKIND,DDLNKQKR   Quick reports ?                              
*&&UK*&& BO    CHEAD068            Yes, don't show ddict entry                  
         OC    KYWDD#,KYWDD#                                                    
         BZ    CHEAD068            Can't extract from data dictionary           
         MVI   HEAD1COL,ESC#LFJT                                                
         MVC   HEAD1COL+1(2),KYWDD#                                             
         MVI   HEAD1COL+3,L'HEAD1COL                                            
         GOTOR ADDICTAT,DMCB,C'SL  ',HEAD1COL,0                                 
         GOTOR LENSTR,DMCB,(L'HEAD1COL,HEAD1COL)                                
         STC   RF,COLHEAD1         Length of data                               
                                                                                
CHEAD068 L     R4,COLHEAD1                                                      
         MVC   0(L'HEAD1COL,R4),HEAD1COL                                        
         L     R4,COLHEAD2                                                      
         MVC   0(L'HEAD2COL,R4),HEAD2COL                                        
         L     R4,COLHEAD3                                                      
         MVC   0(L'HEAD3COL,R4),HEAD3COL                                        
         B     CHEAD900            Skip a ton of code                           
                                                                                
CHEAD072 MVC   HEAD1COL,HEAD_A                                                  
         MVC   HEAD2COL,HEAD_B    Use date headings                             
         CLC   HEAD_B(8),SPACES                                                 
         BNE   CHEAD100                                                         
         DROP  R7                                                               
*                                                                               
CHEAD080 SR    R7,R7                                                            
         ICM   R7,3,KYWCOLH        COLUMN HEADING NAME                          
         BZ    CHEAD100                                                         
         A     R7,NMEBASE          POINT TO NAME                                
         MVC   WORK(NMEVLNQ),0(R7) MOVE HEADING INTO WORK                       
         CLI   WORK,ESC#HIGH                                                    
         BNL   CHEAD084            COLUMN HEADING OK AS IS, GET NEXT            
         GOTO1 ADDICTAT,DMCB,FMTDICT1,WORK,0                                    
*                                                                               
CHEAD084 DS    0H                                                               
*&&UK*&& BRAS  RE,SETFLTHD          Set filter headings                         
         ZIC   R7,COLSIZE                                                       
         CLC   HEAD1COL,SPACES                                                  
         BE    CHEAD088                                                         
         MVC   HEAD2COL(NMEVLNQ),WORK                                           
         B     CHEAD100                                                         
*                                                                               
CHEAD088 CLI   COLSIZE,L'HEAD1COL                                               
         BNH   *+8                                                              
         LA    R7,L'HEAD1COL                                                    
         GOTO1 CHOPPER,DMCB,(L'HEAD1COL,WORK),((R7),WORK+L'HEAD1COL),  X        
               ((R7),2)                                                         
         SHI   R7,1                                                             
         BM    CHEAD100                                                         
         LA    RE,WORK+L'HEAD1COL                                               
         EXMVC R7,HEAD1COL,0(RE)                                                
         AR    RE,R7                                                            
         EXMVC R7,HEAD2COL,1(RE)                                                
*                                                                               
CHEAD100 SR    R7,R7                                                            
         ST    R4,SVR4             Save current print location                  
         TM    FMTPOPT1,RPFMCASE   Leave headings in mixed case ?               
         BO    CHEAD104            Yes                                          
         L     RE,AUPCASE          No                                           
         TR    HEAD1COL,0(RE)      Make headings upper case                     
         TR    HEAD2COL,0(RE)                                                   
*                                                                               
CHEAD104 SR    R7,R7                                                            
         GOTO1 ADSQUASH,DMCB,HEAD1COL,L'HEAD1COL                                
         MVC   HEAD1SZ,DMCB+7                                                   
         MVC   ORGH1SZ,DMCB+7                                                   
         GOTO1 ADSQUASH,DMCB,HEAD2COL,L'HEAD2COL                                
         MVC   HEAD2SZ,DMCB+7                                                   
         MVC   ORGH2SZ,DMCB+7                                                   
         CLI   RCLHD1LN,0          Any heading 1 ?                              
         BNE   CHEAD120            Headings supplied by user                    
         CLI   RCLHD2LN,0          Any heading 2 ?                              
         BNE   CHEAD120            Headings supplied by user                    
         TM    COLIND1,COLCNDR     Column uses calendar periods ?               
         BZ    CHEAD120                   No                                    
         MVC   HEAD1COL(1),COLPERST       Save period number                    
         TM    COLDTTYP,COLMNTH           Calendar based on month               
         BZ    *+10                       No                                    
         MVC   HEAD1COL(2),COLSTART       Yes save YYMM                         
*                                                                               
CHEAD120 CLC   HEAD1COL(L'HEAD1COL*2),SPACES     Any headings at all ?          
         BE    CHEAD300                          No                             
         TM    SUPERCOL,SUPERSTK   Stacked column ?                             
         BZ    CHEAD124            No                                           
         SR    R1,R1                                                            
         IC    R1,HEAD1SZ          Size of heading 1                            
         BCTR  R1,0                                                             
         EXMVC R1,0(R4),HEAD1COL   Save off stacked heading                     
         MVC   COLSCPWD,HEAD1SZ    Prefix width of stacked column               
         B     CHEAD300            Finished this columns headings               
*                                                                               
CHEAD124 XC    RGHTJUST,RGHTJUST   No justification of heading                  
         IC    R7,COLSIZE                                                       
         CLC   COLSIZE,HEAD1SZ                                                  
         BH    *+8                                                              
         STC   R7,HEAD1SZ                                                       
         CLC   COLSIZE,HEAD2SZ                                                  
         BH    *+8                                                              
         STC   R7,HEAD2SZ                                                       
         SR    R1,R1                                                            
         IC    R1,HEAD1SZ                                                       
         TM    DWNOPT1,DWNGO       Down-loading ?                               
         BO    CHEAD145            Yes, so no need to right justify             
         TM    FMTPOPT1,RPFBOX     Print boxes ?                                
         BO    CHEAD130                                                         
         TM    COLFLAGS,COLAMT     Is it an accumulated column ?                
         BZ    CHEAD130            No, no right justify calculation             
         CLC   HEAD1SZ,HEAD2SZ     Which is longer heading 1 or 2               
         BH    *+8                 Heading one is                               
         IC    R1,HEAD2SZ          Heading two is                               
         SR    R7,R1               Column size less length of string            
         STC   R7,RGHTJUST+1       Right justify by this amount                 
*                                                                               
CHEAD130 CLC   HEAD1COL,SPACES     Any text for heading 1 ?                     
         BE    CHEAD200            No                                           
*&&UK*&& TM    FMTPOPT1,RPFBOX     Print boxes ?                                
*&&UK*&& BZ    CHEAD135                                                         
         CLC   PRVHEAD1,HEAD1COL   Check for super column ?                     
         BE    CHEAD140            Yes it is a super column                     
*                                                                               
CHEAD135 MVI   SUPERCOL,0          Re-initailize                                
         ST    R4,PRVCH1LC         No, but save of for next go around           
         MVC   PRVCH1SZ,COLSIZE    location and size                            
         B     CHEAD145                                                         
*                                                                               
CHEAD140 SHI   R3,COLLNQ           Bump back one column entry                   
         OI    SUPERCOL,SUPER1ST   Indicate processing a super column           
         OI    COLOPT,COLCHUNK     Turn on super column flag                    
*                                                                               
         AHI   R3,COLLNQ           Return to original column processing         
         L     R4,PRVCH1LC         A(Previous column location)                  
         IC    R1,PRVCH1SZ         R1 = previous column size                    
         SR    R7,R7                                                            
         IC    R7,COLSIZE          R7 = current column size                     
         LA    R7,1(R1,R7)         New larger column size                       
         STC   R7,PRVCH1SZ         Save new larger size                         
         MVI   1(R4),C' '          Wipe out previous data, start again          
         BCTR  R7,0                Minus one for replication                    
         EXMVC R7,2(R4),1(R4)      Replicate spaces                             
         AHI   R7,1                Restore true length                          
         L     RE,PRVCOLBX         Remove "C" mark from BOXCOL                  
         MVI   0(RE),C' '                                                       
         MVC   HEAD1SZ,ORGH1SZ     Reset heading one data size                  
         CLC   ORGH1SZ,PRVCH1SZ    Was original data larger then column         
         BNH   CHEAD145            Yes                                          
         MVC   HEAD1SZ,PRVCH1SZ    So, use smaller size                         
*                                                                               
CHEAD145 IC    R1,HEAD1SZ          Size of string data to put in column         
         SHI   R1,1                One for the execute                          
         BM    CHEAD200            Not good, went negative                      
         TM    DWNOPT1,DWNGO       Are we down-loading ?                        
         BO    CHEAD150            Don't adjust, no space between cols          
         AHI   R4,1                Adjust by one the location to put            
         TM    SUPERCOL,SUPER1ST   Was it a super column ?                      
         BO    *+8                 Yes, don't right justify                     
         AH    R4,RGHTJUST         No, right justify $, no box columns          
*                                                                               
CHEAD150 EXMVC R1,0(R4),HEAD1COL                                                
         CLC   KYWDD#,=AL2(AC#RSSIC)                                            
         BNE   CHEAD155                                                         
         OI    COLIND2,COLSTATC                                                 
         OI    SUPERCOL,SUPERSTC       Set flag                                 
*                                                                               
CHEAD155 TM    DWNOPT1,DWNGO       Are we down-loading                          
         BO    CHEAD200                     If yes, then already done           
         TM    SUPERCOL,SUPERSTK+SUPERSTC   Stacked or static column ?          
         BNZ   CHEAD160                                                         
         ST    R4,COLHEAD1                                                      
         MVC   COLHEAD1(1),ORGH1SZ    Save off length of text                   
***********************************************************************         
*  Special case keyword = STATIC                                      *         
*       This keyword causes the heading to appear in the column       *         
***********************************************************************         
         SPACE 1                                                                
CHEAD160 TM    SUPERCOL,SUPERSTC   STATIC keyword ?                             
         BZ    CHEAD165            No                                           
         L     RE,COLHEAD3                                                      
*        OI    COLOPT2,COLFCPRT    Print redundante info or copy down           
         XC    COLHEAD3,COLHEAD3                                                
         ST    RE,COLHEAD1         A(Column head 1 goes in column)              
         EXMVC R1,0(RE),HEAD1COL   Save off for printing of report              
         AHI   R1,1                                                             
         STC   R1,COLHEAD1         Save length of data                          
*                                                                               
CHEAD165 TM    FMTPOPT1,RPFBOX     Do we want boxes ?                           
         BO    CHEAD170            Yes, so center it                            
         TM    SUPERCOL,SUPER1ST                                                
         BZ    CHEAD200            Center super all super columns               
*                                                                               
CHEAD170 TM    SUPERCOL,SUPERSTK   Stacked column ?                             
         BO    CHEAD200                                                         
         GOTO1 CENTER,DMCB,(R4),(R7)                                            
         LR    RE,R4               Point to start of column                     
         LR    RF,R7               Max length                                   
*                                                                               
CHEAD175 CLI   0(RE),C' '          This is fancy scoreing                       
         BNE   CHEAD180            As such ==> "----HEADLINE    "               
         TM    SUPERCOL,SUPER1ST   Don't score, just find first char            
         BZ    *+10                                                             
         MVC   0(1,RE),FMTULINE    Score it                                     
         AHI   RE,1                Bump up                                      
         BCT   RF,CHEAD175         Loop                                         
*                                                                               
CHEAD180 TM    SUPERCOL,SUPERSTC   STATIC keyword ?                             
         BO    CHEAD200            Yes                                          
         ST    RE,COLHEAD1         Save address of start of text                
         MVC   COLHEAD1(1),ORGH1SZ Save off length of text                      
         CLC   ORGH1SZ,COLSIZE     Is column size smaller ?                     
         BNH   *+10                No, whole heading fits then                  
         MVC   COLHEAD1(1),COLSIZE Save off length of text                      
*                                                                               
PRV      USING COLD,RE                                                          
         TM    SUPERCOL,SUPER1ST   Is it a super column ?                       
         BZ    CHEAD200            No, so don't fancy score                     
         LR    RE,R3                                                            
         SR    RF,RF                                                            
         IC    RF,COLNUM           Current column number                        
*                                                                               
CHEAD185 SHI   RE,COLLNQ              Bump backwards                            
         TM    PRV.COLOPT,COLCHUNK    Is is part of this super column ?         
         BZ    CHEAD190               No, so finished                           
         TM    PRV.COLIND2,COLSTATC                                             
         BO    *+10                   Don't over-ride STATIC column             
         MVC   PRV.COLHEAD1,COLHEAD1  Replace previous location                 
         BCT   RF,CHEAD185                                                      
         DROP  PRV                                                              
*                                                                               
CHEAD190 LA    RE,0(R4,R7)         Point to end of column                       
         BCTR  RE,0                                                             
         LR    RF,R7               Max length                                   
*                                                                               
CHEAD195 CLI   0(RE),C' '                                                       
         BNE   CHEAD200            As such ==> "    HEADLINE----"               
         MVC   0(1,RE),FMTULINE    Score it                                     
         SHI   RE,1                Bump down                                    
         BCT   RF,CHEAD195         Loop                                         
*                                                                               
CHEAD200 L     R4,SVR4             Restore location of original column          
         CLC   HEAD2COL,SPACES                                                  
         BE    CHEAD260                                                         
         SR    R1,R1                                                            
         IC    R1,HEAD2SZ          Size of string data to put in column         
         SHI   R1,1                one for EX intr.                             
         BM    CHEAD260                                                         
         TM    DWNOPT1,DWNGO       Down-loading ?                               
         BZ    CHEAD205            No                                           
         L     R4,COLHEAD2         Get location to store                        
         B     CHEAD215                                                         
*                                                                               
CHEAD205 AH    R4,RGHTJUST                                                      
         AHI   R4,STDPGWD+1        Bump to second headline                      
         SR    R7,R7                                                            
         IC    R7,COLSIZE                                                       
         TM    SUPERCOL,SUPER1ST   Was first heading a super column ?           
         BZ    CHEAD210            No                                           
         CLC   PRVHEAD2,HEAD2COL   Is 2nd column the same ?                     
         BNE   CHEAD210            No                                           
         OI    SUPERCOL,SUPER2ND   Yes, 2nd heading is super column too         
         SHI   R3,COLLNQ           Point to previous heading                    
         OI    COLIND2,COLSUPR2    Mark to indicate super head 2                
         AHI   R3,COLLNQ           Restore original column                      
         L     R4,PRVCH2LC         Load pervious start location                 
         SR    R1,R1                                                            
         IC    R1,PRVCH2SZ         Previous column size                         
         LA    R7,1(R1,R7)         New size = (CURR COL + PREV COL)             
         STC   R7,PRVCH2SZ         Save new size                                
         MVC   SUPER2SZ,PRVCH2SZ   Save size of 2nd super column                
         MVC   SUPER2AD,PRVCH2LC   Save start location of super column          
         MVI   0(R4),C' '                                                       
         BCTR  R7,0                Minus one for replication                    
         LR    R1,R7                                                            
         EXMVC R7,1(R4),0(R4)      Replicate spaces                             
         AHI   R7,1                Add back                                     
         CLC   ORGH2SZ,PRVCH2SZ    Is it too big                                
         BNL   CHEAD215            Yes, so use column width                     
         IC    R1,ORGH2SZ          Use data size                                
         BCTR  R1,0                                                             
         B     CHEAD215                                                         
*                                                                               
CHEAD210 ST    R4,PRVCH2LC         Reset where to start                         
         MVC   PRVCH2SZ,COLSIZE    Reset to new size                            
         XC    SUPER2AD,SUPER2AD   Clear, not a 2nd super column                
*                                                                               
CHEAD215 EXMVC R1,0(R4),HEAD2COL                                                
         TM    FMTPOPT1,RPFBOX     Do we want boxes ?                           
         BO    CHEAD220                                                         
         TM    SUPERCOL,SUPER2ND   Super column 2nd heading ?                   
         BZ    CHEAD225            No                                           
*                                                                               
CHEAD220 GOTO1 CENTER,DMCB,(R4),(R7)                                            
         LA    RE,0(R4,R7)         Point to end of column                       
         BCTR  RE,0                                                             
*                                                                               
CHEAD225 CLI   0(R4),C' '          Find start of data                           
         BNE   CHEAD235            Keep as BNE (don't use BH)                   
         TM    SUPERCOL,SUPER2ND                                                
         BZ    CHEAD230                                                         
         TM    FMTPOPT1,RPFBOX     Do we want boxes ?                           
         BO    CHEAD230                                                         
         MVC   0(1,R4),FMTULINE    Fancy scoring "------Head 2       "          
*                                                                               
CHEAD230 AHI   R4,1                                                             
         BCT   R7,CHEAD225                                                      
*                                                                               
CHEAD235 TM    DWNOPT1,DWNGO       Down-loading ?                               
         BO    CHEAD240                                                         
         TM    SUPERCOL,SUPERSTC   STATIC keyword ?                             
         BO    CHEAD260                                                         
         TM    SUPERCOL,SUPERSTK   Stacking ?                                   
         BO    CHEAD300                                                         
         ST    R4,COLHEAD2         Save off location of heading text 2          
         MVC   COLHEAD2(1),ORGH2SZ Save off actual size of data                 
         CLC   ORGH2SZ,COLSIZE     Is column size smaller ?                     
         BNH   *+10                No, whole heading fits then                  
         MVC   COLHEAD2(1),COLSIZE Save off length of text                      
*                                                                               
PRV      USING COLD,R4                                                          
CHEAD240 TM    SUPERCOL,SUPER2ND   Super column heading 2 ?                     
         BZ    CHEAD260            No                                           
         SR    RF,RF                                                            
         IC    RF,COLNUM           Get current column number                    
         LR    R4,R3                                                            
*                                                                               
CHEAD245 SHI   R4,COLLNQ                Bump to previous column                 
         TM    PRV.COLIND2,COLSUPR2     Is it a super column head 2 ?           
         BZ    CHEAD250                                                         
         MVC   PRV.COLHEAD2,COLHEAD2    Replace with new location               
         BCT   RF,CHEAD245                                                      
         DROP  PRV                                                              
*                                                                               
CHEAD250 TM    FMTPOPT1,RPFBOX     Do we want boxes ?                           
         BO    CHEAD260                                                         
         CLI   0(RE),C' '          Yes so outline                               
         BNE   CHEAD260                                                         
         MVC   0(1,RE),FMTULINE    Fancy scoring "      Head 2-------"          
         BCTR  RE,0                                                             
         BCT   R7,CHEAD250                                                      
*                                                                               
CHEAD260 TM    DWNOPT1,DWNGO       Down-loading?                                
         BO    CHEAD300            Yes, so don't bother underlineing            
         TM    COLIND1,COLCNDR     Using calendar data ?                        
         BZ    CHEAD265                                                         
         CLI   RCLHD1LN,0          Heading 1 supplied by user ?                 
         BNE   CHEAD265            Yes                                          
         CLI   RCLHD2LN,0          Heading 2 supplied by user ?                 
         BNE   CHEAD265            Yes                                          
         CLI   HEAD2COL,C'&&'      If &PRIOR or &AFTER                          
         BE    CHEAD265                                                         
         OC    COLHEAD1,COLHEAD1                                                
         BNZ   CHEAD265                                                         
         L     R4,COLHEAD2                                                      
         SHI   R4,STDPGWD                                                       
         ST    R4,COLHEAD1                                                      
         XC    COLHEAD2,COLHEAD2                                                
*                                                                               
CHEAD265 TM    FMTPOPT1,RPFBOX     Do we want boxes?                            
         BO    CHEAD300            Yes so skip                                  
         MVC   TEMPAREA,SPACES     else produce underline in heading            
         TM    SUPERCOL,SUPER2ND   2nd column is a super column too ?           
         BZ    CHEAD270                                                         
         L     R4,SUPER2AD         A(Start of 2nd super column)                 
         IC    RF,SUPER2SZ         Size of 2nd super column                     
         BCTR  RF,0                                                             
         EXMVC RF,TEMPAREA,0(R4)   Data to use for underline refrence           
         AHI   R4,STDPGWD          Point to 3rd line to put underline           
         AHI   RF,1                                                             
         B     CHEAD290                                                         
*                                                                               
CHEAD270 SR    RF,RF                                                            
         IC    RF,COLSIZE          Column size                                  
         LR    R1,RF                                                            
         L     R4,SVR4             Start of column head 1                       
         AHI   R4,1                Add 1 for space between columns              
         BCTR  RF,0                                                             
         TM    SUPERCOL,SUPER1ST   Avoid extra long underline                   
         BZ    CHEAD275              when it is a super column                  
         CLC   HEAD2COL,SPACES         unless there is no 2nd heading           
         BNE   CHEAD280                                                         
         L     R4,PRVCH1LC             Start 1st supercol                       
         IC    RF,PRVCH1SZ                                                      
*                                                                               
CHEAD275 EXMVC RF,TEMPAREA,0(R4)                                                
*                                                                               
CHEAD280 EXOC  RF,TEMPAREA,STDPGWD(R4)                                          
         AHI   RF,1                                                             
         AHI   R4,STDPGWD*2                                                     
*                                                                               
CHEAD290 GOTO1 UNDERLIN,DMCB,((RF),TEMPAREA),('DASH',(R4))                      
*                                                                               
CHEAD300 MVC   PRVHEAD1,HEAD1COL   Save off current heading 1                   
         MVC   PRVHEAD2,HEAD2COL   Save off current heading 2                   
*                                                                               
CHEAD900 MVI   SUPERCOL,0          Reset Super column flag                      
         AHI   R3,COLLNQ                                                        
         BCT   R0,CHEAD010                                                      
         J     CXIT                                                             
         DROP  R2,R6                                                            
         EJECT                                                                  
***********************************************************************         
* See if any of the column calculation have security issues                     
* If they do then hide the column                                               
***********************************************************************         
         USING COLD,R3                                                          
         USING EQD,R6                                                           
SCOLUMN  NTR1                                                                   
         TM    DDLNKIND,DDLNKGBL   RLP Global report                            
         BO    SECCOL98            Don't bother                                 
         L     R3,FMTCOL                                                        
         ZIC   R0,FMT#COLS                                                      
                                                                                
SECCOL10 TM    COLFLAGS,COLCALC    Security on column calculations              
         BZ    SECCOL90                                                         
         TM    COLIND4,COLNOSEC    Not secure                                   
         BO    SECCOL32            Mark all column calc columns                 
         ICM   R6,15,COLXTRA       Point to postfix stack                       
         BZ    SECCOL90                                                         
                                                                                
SECCOL14 CLI   EQTYPE,EQEND        End                                          
         BE    SECCOL90            Finished with this one                       
         CLI   EQTYPE,EQCOL        Column # ?                                   
         BE    SECCOL20            Yes                                          
SECCOL18 AHI   R6,EQLNQ            Bump up in stack                             
         B     SECCOL14                                                         
                                                                                
SCH      USING COLD,R2                                                          
                                                                                
SECCOL20 L     R2,FMTCOL                                                        
         ZIC   R1,FMT#COLS                                                      
SECCOL22 CLC   EQCOL#,SCH.COLNUM   Match on column number                       
         BE    SECCOL30                                                         
         AHI   R2,COLLNQ                                                        
         BCT   R1,SECCOL22                                                      
         DC    H'00'                                                            
                                                                                
SECCOL30 TM    SCH.COLIND4,COLNOSEC    Has security ?                           
         BZ    SECCOL18                No, check next possible column           
         OI    COLFLAGS,COLHIDE        Yes                                      
         OI    COLIND4,COLNOSEC    Security on                                  
                                                                                
SECCOL32 L     R6,COLXTRA          Propigate security to Col Cals               
SECCOL34 CLI   EQTYPE,EQEND        End                                          
         BE    SECCOL90            Finished with this one                       
         CLI   EQTYPE,EQCOL        Column # ?                                   
         BE    SECCOL40            Yes                                          
SECCOL38 AHI   R6,EQLNQ            Bump up in stack                             
         B     SECCOL34                                                         
                                                                                
SECCOL40 L     R2,FMTCOL                                                        
         ZIC   R1,FMT#COLS                                                      
SECCOL42 CLC   EQCOL#,SCH.COLNUM   Match on column number                       
         BE    SECCOL50                                                         
         AHI   R2,COLLNQ                                                        
         BCT   R1,SECCOL42                                                      
         DC    H'00'                                                            
                                                                                
SECCOL50 TM    SCH.COLFLAGS,COLCALC     Column calulation ?                     
         BZ    SECCOL38                 Not this one                            
         OI    SCH.COLFLAGS,COLHIDE     Yes                                     
         OI    SCH.COLIND4,COLNOSEC     Security on                             
         B     SECCOL38                 Keep going                              
         DROP  SCH                                                              
                                                                                
SECCOL90 AHI   R3,COLLNQ                                                        
         BCT   R0,SECCOL10                                                      
                                                                                
SECCOL98 J     CXIT                                                             
         DROP  R3,R6,R8                                                         
         EJECT                                                                  
***********************************************************************         
* Stack columns                                                                 
***********************************************************************         
         USING COLD,R3                                                          
TOP      USING COLD,R4                                                          
STACKCOL NTR1                                                                   
         L     R3,FMTCOL           POINT TO STARTING ADDR. OF COLS              
         SR    R0,R0               NUMBER OF COLUMNS TO ORGINIZE                
         IC    R0,FMT#COLS                                                      
STACK10  TM    COLFLAGS,COLHIDE                                                 
         BO    STACK30                                                          
         SR    R4,R4                                                            
         ICM   R4,1,COLSTACK       STACKED UNDER A COLUMN ?                     
         BZ    STACK30             NO                                           
*                                                                               
STACK15  BCTR  R4,0                YES                                          
         MHI   R4,COLLNQ           POINT TO COLUMN STACKED UNDER                
         A     R4,FMTCOL           ADD BASE OF COLUMN TABLE                     
         SR    RF,RF                                                            
         ICM   RF,1,TOP.COLSTACK   IS THIS THE TOP ?                            
         BZ    STACK20             YES, FOUND TOP OF STACKED COLUMNS            
         LR    R4,RF               NO,  TRY NEXT ONE                            
         B     STACK15                                                          
                                                                                
STACK20  MVC   COLSIZE,TOP.COLSIZE     SIZE OF COLUMN                           
         MVC   COLPRT,TOP.COLPRT       ADDRESS OF PRINT BASE                    
         MVC   COLSCTOP,TOP.COLNUM     TOP COLUMN OF STACK                      
         SR    R1,R1                                                            
         IC    R1,TOP.COLSCLVL                                                  
         LA    R1,1(,R1)                                                        
         STC   R1,TOP.COLSCLVL     Keep track of last number                    
         STC   R1,COLSCLVL         Store print line level number                
         CLC   COLSCLVL,FMTSTKHT   Max number of print lines                    
         BNH   *+8                                                              
         STC   R1,FMTSTKHT                                                      
         CLC   TOP.COLSCPWD,COLSCPWD                                            
         BH    *+10                                                             
         MVC   TOP.COLSCPWD,COLSCPWD   USE THE MOST WIDE PREFIX WIDTH           
         TM    TOP.COLFLAGS,COLAMT                                              
         BO    STACK30                                                          
         OI    TOP.COLOPT2,COLFCPRT    ALWAYS PRINT DATA                        
*                                                                               
STACK30  LA    R3,COLLNQ(,R3)                                                   
         BCT   R0,STACK10                                                       
*                                                                               
         L     R3,FMTCOL           Column data table                            
         SR    R0,R0               Number of columns                            
         IC    R0,FMT#COLS                                                      
STACK32  CLI   COLSCLVL,0          Any data ?                                   
         BE    STACK40             No, so skip                                  
         CLI   COLSTACK,0          If zero then must be top                     
         BNE   STACK40                                                          
         MVI   COLSCLVL,0          Clear, make level 0                          
STACK40  LA    R3,COLLNQ(,R3)                                                   
         BCT   R0,STACK32                                                       
         J     CXIT                                                             
         DROP  TOP                                                              
         DROP  R5                                                               
         EJECT                                                                  
***********************************************************************         
*  SORT NEW ROW ELEMENT IN POOL ACCORDING TO SEQNUM ELEMENT           *         
*  IF SEQNUM=0 THEN PUT AT END, THEY ARE OF LOW PRIORITY              *         
***********************************************************************         
         SPACE 1                                                                
         USING RRWELD,R2                                                        
SORTPOOL NTR1                                                                   
         L     R2,ROWWRK           POINT TO BEGINING OF POOL                    
         LR    R3,R2               SAVE IN R3                                   
         ZIC   R1,HIGHSEQ          GET HIGHEST SEQUENCE NUMBER USED             
*                                                                               
SORTPL1  CLI   0(R2),0             ARE THERE ANY ELEMENT LEFT?                  
         BE    SORTPL5             NO SO FINISHED                               
         CLI   RRWSEQ,0            IF SEQ = 0 THEN RESEQUENCE                   
         BNE   SORTPL2                                                          
         AHI   R1,1                BUMP UP BY ONE                               
         STC   R1,RRWSEQ           SAVE NEW SEQUENCE NUMBER                     
*                                                                               
SORTPL2  CLC   HIGHSEQ,RRWSEQ      WHICH IS GREATER?                            
         BNL   *+10                                                             
         MVC   HIGHSEQ,RRWSEQ      SAVE HIGHEST NEW SEQUENCE NUMBER             
         ZIC   RF,RRWLN            BUMP TO NEXT ELEMENT                         
         AR    R2,RF                                                            
         B     SORTPL1                                                          
*                                                                               
SORTPL5  ZIC   R6,HIGHSEQ          GET NUMBER OF ROW ELEMENTS                   
         GOTO1 XSORT,DMCB,ROWWRK,(R6),RRWNLNQ+6,1,RRWSEQ-RRWELD                 
*                                                                               
SORTPL9  J     CXIT                                                             
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* Find length of string                                                         
*      P1(1)   = Max length of String                                           
*      P1+1(3) = A(String)                                                      
*      Return in RF length of string                                            
***********************************************************************         
         SPACE 1                                                                
LENSTR   SR    RF,RF                                                            
         ICM   RF,1,0(R1)          Length of string area                        
         BZR   RE                                                               
         L     R1,0(,R1)           A(String)                                    
         AR    R1,RF               End of field                                 
         BCTR  R1,0                A(last character)                            
         CLI   0(R1),C' '                                                       
         BHR   RE                                                               
         BCTR  R1,0                                                             
         BRCT  RF,*-8                                                           
         BR    RE                                                               
         EJECT                                                                  
***********************************************************************         
* Set filter headings                                                           
***********************************************************************         
         SPACE 1                                                                
         USING CPYELD,RF                                                        
SETFLTHD CLI   FCGTFILT,YES        Filters turned on in MONACC                  
         BNER  RE                  No                                           
         L     RF,ADCMPEL                                                       
         TM    CPYSTAT8,CPYSFNAM   Filters for this company                     
         BZR   RE                  N                                            
         DROP  RF                                                               
                                                                                
         USING FMTRECD,R5                                                       
         USING KYWD,R6                                                          
SETFHD00 NTR1  BASE=*,LABEL=FLTHDS                                              
         LA    RF,FLTNTAB          RF=A(FILTER TABLE)                           
SETFHD10 CLI   0(RF),EOT                                                        
         JE    SETFHDX             NOT FILTER KEYWORDS                          
         CLC   KYWDD#,0(RF)        MATCH FILTER CODE/NAME DDIC #                
         JE    SETFHD15            FOUND - GET FILTER NAME                      
         LA    RF,L'FLTNTAB(,RF)                                                
         J     SETFHD10            CHECK NEXT                                   
*                                                                               
T        USING RSFRECD,IOKEY                                                    
         USING ACMD,R1                                                          
SETFHD15 L     R1,AMONACC                                                       
         MVC   BYTE1,2(RF)         FILTER NUMBER                                
         MVC   T.RSFKEY,SPACES     SEE IF SET UP AT LEDGER LEVEL                
         MVI   T.RSFKTYP,RSFKTYPQ                                               
         MVC   T.RSFKCPY,RCSVCOMP  COMPANY HEXCOMP                              
         MVI   T.RSFKFLT#,0                                                     
         MVC   T.RSFKUNT(2),QUNIT  UNIT/LEDGER                                  
         DROP  T,R1                                                             
                                                                                
         L     R1,=AL4(IOREAD+IOACFIL+IOAREA3)                                  
         GOTO1 AIO                                                              
         JNE   SETFHDX             NO FILTER NAME RECORD                        
*                                                                               
         USING RSFELD,RF                                                        
         L     RF,AIO3                                                          
         AH    RF,DATADISP                                                      
         SR    R1,R1                                                            
SETFHD20 CLI   RSFEL,EOR           END OF RECORD                                
         JE    SETFHDX                                                          
         CLI   RSFEL,RSFELQ        Filter name elements                         
         BNE   SETFHD26                                                         
         CLC   RSFTYPE,BYTE1       Match filter number                          
         BE    SETFHD30                                                         
SETFHD26 IC    R1,RSFLN                                                         
         AR    RF,R1                                                            
         B     SETFHD20                                                         
*                                                                               
SETFHD30 LA    R1,WORK                                                          
         CLI   0(R1),C' '          FIND THE END OF HEADING NAME                 
         JNH   SETFHD32                                                         
         LA    R1,1(,R1)                                                        
         J     *-12                                                             
                                                                                
SETFHD32 DS    0H                                                               
*&&UK                                                                           
         MVI   1(R1),C'-'                                                       
         SR    RE,RE                                                            
         IC    RE,RSFLN                                                         
         SHI   RE,RSFLNQ+1                                                      
         JM    SETFHDX             No filter name!                              
         EXMVC RE,3(R1),RSFLNNM    Move in filter name                          
*&&                                                                             
*                                                                               
SETFHDX  J     CXIT                                                             
         DROP  R5,R6,RF                                                         
                                                                                
         LTORG                                                                  
         SPACE 3                                                                
FLTNTAB  DS    0XL3                                                             
         DC    AL2(AC#RSAF1),AL1(1)                                             
         DC    AL2(AC#RSAN1),AL1(1)                                             
         DC    AL2(AC#RSAF2),AL1(2)                                             
         DC    AL2(AC#RSAN2),AL1(2)                                             
         DC    AL2(AC#RSAF3),AL1(3)                                             
         DC    AL2(AC#RSAN3),AL1(3)                                             
         DC    AL2(AC#RSAF4),AL1(4)                                             
         DC    AL2(AC#RSAN4),AL1(4)                                             
         DC    AL2(AC#RSAF5),AL1(5)                                             
         DC    AL2(AC#RSAN5),AL1(5)                                             
         DC    AL1(EOT)                                                         
         EJECT                                                                  
***********************************************************************         
*    FMTFONT = 0 IS PITCH 10, LANDSCAPE = 110 , PORTRAIT =  85        *         
*    FMTFONT = 1 IS PITCH 12, LANDSCAPE = 132 , PORTRAIT = 102        *         
*    FMTFONT = 2 IS PITCH 15, LANDSCAPE = 165 , PORTRAIT = 127        *         
*---------------------------------------------------------------------*         
*    FMTFONT = 0 IS PITCH 18, LANDSCAPE = 198+, PORTRAIT = 153        *         
*    FMTFONT = 1 IS PITCH 20, LANDSCAPE = 198 , PORTRAIT = 170        *         
*    FMTFONT = 2 IS PITCH 24, LANDSCAPE = NA  , PORTRAIT = 198        *         
*---------------------------------------------------------------------*         
* + NOTE: If printing with stripes or shading then need to switch to  *         
*         PITCH 20 since we do not have a DDS pitch 18 at thsi time   *         
***********************************************************************         
         SPACE 1                                                                
         USING FMTRECD,R5                                                       
SETFONT  NTR1  BASE=*,LABEL=*                                                   
         LA    R3,PGWDLAND         Landscape widths                             
         CLI   QPROG+1,LANDSCPE    Landscape ?                                  
         BE    SFONT05                                                          
         LA    R3,PGWDPORT         Portrait  widths                             
*                                                                               
SFONT05  CLC   FMTREPWD,4(R3)      Largest of group                             
         BNH   SFONT10             This set is ok                               
         AHI   R3,5                Point to secondary group                     
*                                                                               
SFONT10  MVC   FMTPGDEF,0(R3)      PAGEDEF, Supports LPI 08                     
         MVC   FMTMLINE,1(R3)      Set LPI                                      
         LA    R6,2(,R3)                                                        
         MVI   FMTFONT,0           Either 10 or 18, depends on FMTPGDEF         
         CLC   FMTREPWD,2(R3)                                                   
         BNH   SFONT12                                                          
         LA    R6,3(,R3)                                                        
         MVI   FMTFONT,1           Either 12 or 20, depends on FMTPGDEF         
         CLC   FMTREPWD,3(R3)                                                   
         BNH   SFONT12                                                          
         MVI   FMTFONT,2           Either 15 or 24, depends on FMTPGDEF         
         LA    R6,4(,R3)                                                        
         CLC   FMTREPWD,4(R3)                                                   
         BNH   SFONT12                                                          
         MVI   ERROR#,7            Report too wide                              
         B     SFONT90                                                          
*                                                                               
SFONT12  CLI   FMTOPTCH,0          Set to auto if zero                          
         BE    SFONT20                                                          
         LA    R3,PGWDLAND         Landscape widths                             
         CLI   QPROG+1,LANDSCPE    Landscape ?                                  
         BE    *+8                                                              
         LA    R3,PGWDPORT         Portrait  widths                             
         CLI   FMTOPTCH,15                                                      
         BNH   *+8                                                              
         LA    R3,5(,R3)                                                        
*                                                                               
         MVC   FMTPGDEF,0(R3)                                                   
         MVC   FMTMLINE,1(R3)      Set lines per inch                           
         MVI   FMTFONT,0           Set pitch 10                                 
         LA    R6,2(,R3)                                                        
         CLI   FMTOPTCH,10                                                      
         BE    SFONT80                                                          
         CLI   FMTOPTCH,18         Set pitch 18                                 
         BE    SFONT80                                                          
         LA    R6,3(,R3)                                                        
         MVI   FMTFONT,1           Set pitch 12                                 
         CLI   FMTOPTCH,12                                                      
         BE    SFONT80                                                          
         CLI   FMTOPTCH,20         Set pitch 20                                 
         BE    SFONT80                                                          
         LA    R6,4(,R3)                                                        
         MVI   FMTFONT,2           Set pitch 15                                 
         CLI   FMTOPTCH,15                                                      
         BE    SFONT80                                                          
         CLI   FMTOPTCH,24         Set pitch 24                                 
         BE    SFONT80                                                          
*                                                                               
SFONT20  CLI   QPROG+1,LANDSCPE    Landscape ?                                  
         BNE   SFONT80                                                          
         CLI   FMTPGDEF,2          Is it 18,20,24 group ?                       
         BNE   SFONT80                                                          
         TM    FMTPOPT2,RPFSTRPE+RPFOSHDE+RPFISHDE                              
         BZ    SFONT80                                                          
         CLI   FMTFONT,0           Is it Pitch 18 ?                             
         BNE   SFONT80                                                          
         MVI   FMTFONT,1           Goto PITCH 20, supports shade/stripe         
*                                                                               
SFONT80  MVC   FMTPGEWD+3(1),0(R6)    Set max page width                        
         CLI   SOONJOB,DIRECT         Is this going to PQ ?                     
         BE    SFONT82                Yes                                       
         CLI   SOONJOB,YES            Is this job SOON ?                        
         BNE   SFONT90                No, to the DDS printers then              
*                                                                               
SFONT82  MVI   FMTMLINE,LPI08LS    Non-DDS printers work better @ 8 lpi         
         CLI   QPROG+1,LANDSCPE    Landscape ?                                  
         BE    SFONT90                                                          
         MVI   FMTMLINE,LPI08PT    Non-DDS printers work better @ 8 lpi         
*                                                                               
SFONT90  XIT1                                                                   
         SPACE 3                                                                
         LTORG                                                                  
*                                                                               
PGWDLAND DC    AL1(1,LPI08LS,PGWDRL10,PGWDRL12,PGWDRL15)                        
         DC    AL1(2,LPI12LS,PGWDRL18,PGWDRL20,PGWDRL24)                        
*                                                                               
PGWDPORT DC    AL1(1,LPI08PT,PGWDRP10,PGWDRP12,PGWDRP15)                        
         DC    AL1(2,LPI12PT,PGWDRP18,PGWDRP20,PGWDRP24)                        
         EJECT ,                                                                
***********************************************************************         
*  SCAN FOR VALID DATASET NAME                                        *         
***********************************************************************         
         SPACE 1                                                                
SCANALPH NTR1  BASE=*,LABEL=*                                                   
         CLI   ERROR#,0                                                         
         BNE   SCANXIT                                                          
         L     RE,0(,R1)           Get address area to scan                     
         SR    RF,RF                                                            
         ICM   RF,1,0(R1)          Get length of area to scan                   
         BNZ   *+6                                                              
         DC    H'00'               Bad call to routine                          
*                                                                               
         AR    RE,RF               Point to end of data                         
         BCTR  RE,0                One less to point to last character          
SCANAL10 CLI   0(RE),C' '          Find last character                          
         BH    SCANAL15            Found                                        
         BCTR  RE,0                                                             
         BCT   RF,SCANAL10                                                      
         DC    H'00'               No data                                      
*                                                                               
SCANAL15 MVI   ERROR#,18           No blank allowed inbetween                   
         CLI   0(RE),C' '                                                       
         BNH   SCANXIT                                                          
         MVI   ERROR#,19           Char A-Z or 1-9 only                         
         CHI   RF,1                                                             
         BNE   *+8                                                              
         MVI   ERROR#,20           Char A-Z only                                
*&&US                                                                           
         CLI   0(RE),C'-'          Dashes are allowed now                       
         BE    SCANAL20                                                         
*&&                                                                             
         CLI   0(RE),C'A'          Not an allowed character                     
         BL    SCANXIT                                                          
         CLI   0(RE),C'I'                                                       
         BNH   SCANAL20            Ok                                           
         CLI   0(RE),C'J'                                                       
         BL    SCANXIT             Not ok                                       
         CLI   0(RE),C'R'                                                       
         BNH   SCANAL20            Ok                                           
         CLI   0(RE),C'S'                                                       
         BL    SCANXIT             Not ok                                       
         CLI   0(RE),C'Z'                                                       
         BNH   SCANAL20            Ok                                           
         CHI   RF,1                                                             
         BE    SCANXIT             1st character test failed                    
         CLI   0(RE),C'0'                                                       
         BL    SCANXIT             Not ok                                       
         CLI   0(RE),C'9'                                                       
         BH    SCANXIT             Not ok                                       
*                                                                               
SCANAL20 BCTR  RE,0                                                             
         BCT   RF,SCANAL10                                                      
         MVI   ERROR#,0            Reset                                        
*                                                                               
SCANXIT  CLI   ERROR#,0                                                         
         XIT1                                                                   
         SPACE 3                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*  R6 = A(KEYWORD ENTRY)                                              *         
***********************************************************************         
         SPACE 1                                                                
         USING KYWD,R6                                                          
         USING FMTRECD,R5                                                       
         USING PARSED,R3                                                        
VALSPLT  NTR1  BASE=*,LABEL=*                                                   
         SR    R3,R3                                                            
         ICM   R3,3,KYWPRSE                                                     
         BZ    VALSPLT9                                                         
         A     R3,PRSBASE                                                       
VALSPLT3 CLI   PARTYPE,EOT         END OF ENTRIES                               
         BE    VALSPLT9                                                         
         TM    PARIND1,PARSPLT     SPLIT FLAG ON?                               
         BZ    VALSPLT5                                                         
         CLI   PARELEM,PTAELQ      IF X'77' TURN ON SPLIT77                     
         BNE   *+8                                                              
         OI    SPLITIND,SPLIT77                                                 
         TM    PARIND1,PARLDG      SPECIFIC LEDGER                              
         BZ    VALSPLT8                                                         
         MVC   WORK(4),CURLDGR     CHECK LEDGER                                 
         NC    WORK(4),PARLDGRS                                                 
         BNZ   VALSPLT8                                                         
*                                                                               
VALSPLT5 LA    R3,PARSEDQ(,R3)                                                  
         B     VALSPLT3                                                         
*                                                                               
VALSPLT8 SR    RE,RE                                                            
VALSPLT9 LTR   RE,RE                                                            
         XIT1                                                                   
         DROP  R3,R6,R5                                                         
         SPACE 3                                                                
         LTORG                                                                  
         EJECT                                                                  
*&&US                                                                           
***********************************************************************         
*  Set accounts to process based on authorization key                 *         
***********************************************************************         
         SPACE 1                                                                
         USING FMTRECD,R5                                                       
         USING ACMD,R2                                                          
SETAUTH  NTR1  BASE=*,LABEL=*                                                   
         L     R2,AMONACC                                                       
         OC    ACMAACTA,ACMAACTA   TEST BUFFER ACQUIRED & INITIALISED           
         BNZ   SETAUT02                                                         
         L     R0,=A(L'ACTKACT*ACMAACTM)                                        
         GETMAIN RU,LV=(0),LOC=(ANY,ANY),BNDRY=PAGE                             
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
         ST    R1,ACMAACTA         SAVE A(ACCOUNT GROUP BUFFER)                 
*                                                                               
         USING FUNRECD,R3                                                       
SETAUT02 XC    ACMAACTN,ACMAACTN   CLEAR N'ENTRIES IN BUFFER                    
         L     R3,ACMAACTA         R3 = A(ACCOUNT CODE BUFFER)                  
         ST    R3,ACMAACTS         SET  A(START OF BUFFER)                      
         SR    R4,R4               R4 = N'ENTRIES IN BUFFER                     
         LA    R3,IOKEY                                                         
         MVC   FUNKEY,AUTHKREQ                                                  
         MVI   FUNKSUB,FUNKSUBQ    Read funding record for auth#                
         L     R1,=AL4(IOREAD+IOACFIL+IOAREA2)                                  
         GOTO1 AIO                                                              
         BNE   SETAUTX                                                          
         L     R3,AIO2                                                          
         AH    R3,DATADISP                                                      
         SAM31                     31 Bit mode on                               
         L     R6,ACMAACTA                                                      
         SR    RF,RF                                                            
                                                                                
         USING FJNELD,R3                                                        
SETAUT10 CLI   0(R3),0             EOR                                          
         BE    SETAUT20                                                         
         CLI   FJNEL,FJNELQ        X'0C', funding job element                   
         BNE   SETAUT12                                                         
         AHI   R4,1                                                             
         CHI   R4,ACMAACTM         Reached limit                                
         BL    *+6                                                              
         DC    H'00'                                                            
*                                                                               
         MVC   0(L'ACTKACT,R6),FJNJOB      Put account in table                 
         LA    R6,L'ACTKACT(,R6)                                                
                                                                                
SETAUT12 IC    RF,FJNLN                                                         
         AR    R3,RF                                                            
         B     SETAUT10                                                         
         DROP  R3                                                               
                                                                                
SETAUT20 XC    0(L'ACTKACT,R6),0(R6)      Clear EOT                             
         SAM24                     Set 24 bit mode                              
         MVI   ACMAACTD,3          Always depth 3, cli,prod,job                 
         STH   R4,ACMAACTN         Set N'ACCOUNTS to process                    
*        LTR   R4,R4                                                            
*        BZ    SETAUT90                                                         
         OI    ACMINDS4,ACMIUACL   Set this on for MONACC                       
                                                                                
SETAUTX  XIT1                                                                   
         DROP  R2,R5                                                            
         SPACE 3                                                                
         LTORG                                                                  
*&&                                                                             
         EJECT                                                                  
***********************************************************************         
* ROUTINE TO INITIALISE LIST OF ACCOUNTS                              *         
***********************************************************************         
         SPACE 1                                                                
         USING ACMD,R7                                                          
         USING FMTRECD,R5                                                       
SETACT   NTR1  BASE=*,LABEL=*                                                   
         L     R7,AMONACC                                                       
         TM    ACMINDS4,ACMIUACL             Already set                        
         BO    SETACTX                       Yes                                
         TM    ACMINDS3,ACMIAGRP+ACMIAPRS                                       
         BNZ   SETACTX                                                          
         CLC   QACCOUNT,SPACES                                                  
         BNE   SETACTX                                                          
                                                                                
*******************************************************                         
* PASS 1 - Figure out if applicable and the min level *                         
*******************************************************                         
         SR    R9,R9                                                            
         SR    R2,R2                                                            
         MVI   ACMINLEN,L'ACTKACT  Account minimum length - set to max          
         MVI   ACMINLEV,4          Account minimum level  - set to max          
         MVI   BYTE,0              Minimal level length                         
                                                                                
         LH    R9,FORMAT#          # of formats                                 
         L     R5,AFORMATS                                                      
SETACT02 ICM   R2,7,AFLTACC+1                                                   
         BZ    SETACTX                                                          
         TM    AFLTACC,FLTEXCL     Exclude filter                               
         BO    SETACTX             Yes                                          
         TM    AFLTACC,FLTWILD                                                  
         BO    SETACTX                                                          
         CLI   FMTNUM,1            1st format ?                                 
         BE    SETACT03            Yes                                          
         TM    FMTRCAP,FMTRPROF    Use formats own AFLTACC ?                    
         BZ    SETACT20            No, so skip, using format's 1                
                                                                                
SETACT03 TM    AFLTACC,FLTLIST     Is it a +/- list ?                           
         BO    SETACT15            Yes                                          
*        TM    AFLTACC,FLTDLNK     Is it a list from DDLINK?                    
*        BO    SETACT10            Yes                                          
                                                                                
*---------------------------------------------------------------------*         
* Find smallest length in account string                              *         
*---------------------------------------------------------------------*         
SETACT04 CLI   0(R2),EOT           Comma delimited list                         
         BE    SETACT20                                                         
         ZIC   RF,0(,R2)           Length of entry                              
         TM    AFLTACC,FLTNOUL     Has no U/L ledger ?                          
         BO    SETACT06            True                                         
*                                                                               
SETACT05 CLC   QUNIT(2),1(R2)      Match on Unit/Ledger                         
         BNE   SETACT08                                                         
         SHI   RF,2                Less two for Unit/Ledger                     
         BNP   SETACT08            Ignore if just Unit/Ledger                   
                                                                                
SETACT06 CLM   RF,1,ACMINLEN      Save of smallest length                       
         BNL   *+8                                                              
         STC   RF,ACMINLEN                                                      
                                                                                
SETACT08 IC    RF,0(,R2)           Length of entry                              
         LA    R2,1(RF,R2)         Next account                                 
         B     SETACT04                                                         
*&&DO                                                                           
*---------------------------------------------------------------------*         
* Find lowest level in DDLINK table of accounts                       *         
*---------------------------------------------------------------------*         
         USING LDGD,R3                                                          
SETACT10 GOTO1 GETLDGR,DMCB,QUNIT                                               
         ICM   R3,15,0(R1)                                                      
         BNZ   *+6                                                              
         DC    H'00'                                                            
                                                                                
         SR    R0,R0                                                            
         ICM   R0,3,0(R2)          R0 = number of entries                       
         BZ    SETACTX                                                          
         AHI   R2,2                Bump past number of entries value            
                                                                                
SETACT11 CLC   QUNIT(2),0(R2)                                                   
         BNE   SETACT14                                                         
         LA    R6,2(,R2)           Point past unit ledger, to account           
         ZIC   R1,LDG#LEVS         Number of levels                             
         LA    RE,LDGLEV1          Level info                                   
SETACT12 ZIC   RF,1(,RE)           Length of level only                         
         BCTR  RF,0                                                             
         EXCLC RF,0(R6),SPACES                                                  
         BNH   SETACT13                                                         
         MVC   BYTE,0(RE)          Save len of where data was found             
         AHI   RE,LDGLEV2-LDGLEV1  Next level info                              
         LA    R6,1(RF,R6)         Point to next piece of acct                  
         BRCT  R0,SETACT12                                                      
                                                                                
SETACT13 CLC   BYTE,ACMINLEN       Save of smallest length                      
         BNL   *+10                                                             
         MVC   ACMINLEN,BYTE                                                    
                                                                                
SETACT14 AHI   R2,14               Next entry                                   
         BRCT  R0,SETACT11                                                      
         J     SETACT21                                                         
*&&                                                                             
*---------------------------------------------------------------------*         
* Find lowest level in +/- LIST                                       *         
*---------------------------------------------------------------------*         
         USING LIDELD,R2                                                        
SETACT15 AHI   R2,LSTRFST-LSTRECD  Point to first element                       
                                                                                
SETACT16 CLI   0(R2),0                                                          
         BE    SETACT20            Finished                                     
         CLI   0(R2),LIDELQ        X'1F'-LIST DATA ELEMENT                      
         BNE   SETACT18                                                         
         CLC   LIDDLEDG,QUNIT                                                   
         BNE   SETACT18                                                         
         CLC   LIDDALVL,ACMINLEV   Level                                        
         BNL   *+10                                                             
         MVC   ACMINLEV,LIDDALVL   Set to lowest level                          
                                                                                
SETACT18 ZIC   RF,LIDLN                                                         
         AR    R2,RF                                                            
         B     SETACT16                                                         
         DROP  R2                                                               
                                                                                
SETACT20 LA    R5,FMTLNQ(,R5)                                                   
         BCT   R9,SETACT02         Next format                                  
*                                                                               
         USING LDGD,R3                                                          
         GOTO1 GETLDGR,DMCB,QUNIT                                               
         ICM   R3,15,0(R1)                                                      
         BNZ   *+6                                                              
         DC    H'00'                                                            
                                                                                
SETACT21 LA    RE,LDGLEV1                                                       
         ZIC   RF,LDG#LEVS         LEVEL STRUCTURE                              
         LA    R1,1                                                             
SETACT22 CLC   ACMINLEN,0(RE)                                                   
         BNH   SETACT24            Found level based on length                  
         AHI   RE,LDGLEV2-LDGLEV1                                               
         AHI   R1,1                Increment levels                             
         BCT   RF,SETACT22                                                      
         DC    H'00'                                                            
                                                                                
SETACT24 CLM   R1,1,ACMINLEV                                                    
         BNH   *+8                                                              
         IC    R1,ACMINLEV         Use this level it is lower                   
         STC   R1,ACMAACTD         Store depth                                  
                                                                                
         BCTR  R1,0                                                             
         MHI   R1,LDGLEV2-LDGLEV1                                               
         LA    RE,LDGLEV1                                                       
         AR    RE,R1               Point to level info                          
         MVC   ACMINLEN,0(RE)      Set min account length                       
         DROP  R3                                                               
                                                                                
         XC    ACMAACTN,ACMAACTN   CLEAR N'ENTRIES IN BUFFER                    
         OC    ACMAACTA,ACMAACTA   TEST BUFFER ACQUIRED & INITIALISED           
         BNZ   SETACT30                                                         
         L     R0,=A(L'ACTKACT*ACMAACTM)                                        
         GETMAIN RU,LV=(0),LOC=(ANY,ANY),BNDRY=PAGE                             
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
         ST    R1,ACMAACTA         SAVE A(ACCOUNT GROUP BUFFER)                 
                                                                                
*******************************************                                     
* PASS 2 - Build list of accounts         *                                     
*******************************************                                     
SETACT30 L     R6,ACMAACTA         R6 = A(ACCOUNT CODE BUFFER)                  
         ST    R6,ACMAACTS         SET  A(START OF BUFFER)                      
         SAM31                     31 bit mode on                               
                                                                                
         LH    R9,FORMAT#          # OF FORMATS                                 
         L     R5,AFORMATS                                                      
*                                                                               
SETACT35 ICM   R2,7,AFLTACC+1                                                   
         CLI   FMTNUM,1            1st format ?                                 
         BE    SETACT36            Yes                                          
         TM    FMTRCAP,FMTRPROF    Use formats own profile ?                    
         BZ    SETACT80            No so done for format                        
                                                                                
SETACT36 TM    AFLTACC,FLTLIST     Is it a +/- LIST ?                           
         BO    SETACT50            Yes                                          
*        TM    AFLTACC,FLTDLNK     DDLINK table                                 
*        BO    SETACT60            Yes                                          
                                                                                
********************************************************                        
* Process account comma delimited string               *                        
********************************************************                        
SETACT40 CLI   0(R2),EOT           End of string of accounts ?                  
         BE    SETACT80            Yes                                          
         ZIC   RF,0(,R2)           Length of data                               
         LA    R4,1(,R2)           R4 = A(DATA)                                 
*                                                                               
         TM    AFLTACC,FLTNOUL                                                  
         BO    SETACT45            Has U/L included always                      
SETACT42 CLC   QUNIT(2),0(R4)                                                   
         BNE   SETACT48                                                         
         SHI   RF,2                Minus U/L                                    
         BNP   SETACT48            Nothing to add                               
         AHI   R4,2                Skip U/L                                     
*                                                                               
SETACT45 MVC   WORK,SPACES         Which is smaller                             
         CLM   RF,1,ACMINLEN                                                    
         BNH   *+8                                                              
         IC    RF,ACMINLEN                                                      
         BCTR  RF,0                                                             
         EXMVC RF,WORK,0(R4)                                                    
         BAS   RE,ADDACT           Add account if not duplicate                 
                                                                                
SETACT48 ZIC   RF,0(,R2)           Bump to next account                         
         LA    R2,1(RF,R2)                                                      
         B     SETACT40            Next account                                 
                                                                                
********************************************************                        
* Process +/- List                                     *                        
********************************************************                        
         USING LIDELD,R2                                                        
SETACT50 AHI   R2,LSTRFST-LSTRECD                                               
                                                                                
SETACT52 CLI   0(R2),EOR           End of record ?                              
         BE    SETACT80            Yes                                          
         CLI   0(R2),LIDELQ        X'1F'-LIST DATA ELEMENT                      
         BNE   SETACT55                                                         
         CLC   LIDDLEDG,QUNIT                                                   
         BNE   SETACT55                                                         
*                                                                               
         SR    R0,R0                                                            
         SR    RF,RF                                                            
         ZIC   R1,LIDLN                                                         
         SHI   R1,LIDDACCS-LIDELD                                               
         BNP   SETACT80            no data - Exit                               
         ZIC   RE,LIDITLN                                                       
         LR    R8,RE                                                            
         DR    R0,RE               # OF ACCOUNTS IN ELEMENT                     
         LR    R0,R1               R0 = Number of accounts                      
*                                                                               
         LA    R4,LIDDACCS         Start of accounts                            
         CLM   R8,1,ACMINLEN                                                    
         BNH   *+8                                                              
         IC    R8,ACMINLEN                                                      
         BCTR  R8,0                Less one for EX Intr.                        
SETACT54 MVC   WORK,SPACES                                                      
         EXMVC R8,WORK,0(R4)                                                    
         BAS   RE,ADDACT                                                        
         ZIC   RF,LIDITLN                                                       
         AR    R4,RF               Bump to next account                         
         BCT   R0,SETACT54                                                      
*                                                                               
SETACT55 ZIC   RF,LIDLN                                                         
         AR    R2,RF                                                            
         B     SETACT52            Try for another element                      
         DROP  R2                                                               
*&&DO                                                                           
SETACT60 ZIC   R0,3,0(R2)          Number of entries                            
         ZIC   RF,ACMINLEN                                                      
         BCTR  RF,0                                                             
         AHI   R2,2                Bump past length                             
                                                                                
SETACT62 CLC   QUNIT(2),0(R2)      Match on U/L                                 
         BNE   SETACT64                                                         
         MVC   WORK,SPACES         Which is smaller                             
         EXMVC RF,WORK,2(R2)                                                    
         BAS   RE,ADDACT           Add account if not duplicate                 
                                                                                
SETACT64 AHI   R2,14               Unit/Ledger account                          
         BRCT  R0,SETACT62         Next account                                 
*&&                                                                             
SETACT80 LA    R5,FMTLNQ(,R5)      Next format                                  
         BCT   R9,SETACT35                                                      
*                                                                               
         LH    R3,ACMAACTN         Number of accounts in list                   
         LTR   R3,R3                                                            
         BZ    SETACT85                                                         
         OI    ACMINDS4,ACMIUACL   SET THIS ON FOR MONACC                       
         GOTO1 XSORT,DMCB,X'00FFFFFF',(R3),L'ACTKACT,L'ACTKACT,0,      +        
               ACMAACTA                                                         
                                                                                
SETACT85 SAM24                     31 bit mode off                              
*                                                                               
SETACTX  XIT1  ,                                                                
         EJECT                                                                  
***********************************************************************         
*  Add account to list, no duplicates                                 *         
***********************************************************************         
         SPACE 1                                                                
ADDACT   ST    RE,SVRE                                                          
         L     R6,ACMAACTA                                                      
         SR    RF,RF                                                            
         ICM   RF,3,ACMAACTN         Number of accounts in list so far          
         BZ    ADDACT20                                                         
         ZIC   R1,ACMINLEN                                                      
         BCTR  R1,0                                                             
                                                                                
ADDACT10 EXCLC R1,0(R6),WORK       Compare again list                           
         BE    ADDACTX                                                          
         LA    R6,L'ACTKACT(,R6)                                                
         BCT   RF,ADDACT10                                                      
*                                                                               
ADDACT20 MVC   0(L'ACTKACT,R6),WORK                                             
         LH    RF,ACMAACTN         Number of accounts in list so far            
         AHI   RF,1                                                             
         CHI   RF,ACMAACTM         Reached limit on # of entries ?              
         BNH   *+6                                                              
         DC    H'00'               Too many                                     
                                                                                
         STH   RF,ACMAACTN         New # of accounts                            
                                                                                
ADDACTX  L     RE,SVRE                                                          
         BR    RE                                                               
         DROP  R7                                                               
                                                                                
ACMINLEN DS    XL1                                                              
ACMINLEV DS    XL1                                                              
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*   Create entries for date calculations. Date 1 less Date 2          *         
***********************************************************************         
         SPACE 1                                                                
         USING COLD,R3                                                          
         USING RCLELD,R2           ASSUMED FROM CALLER                          
         USING EQD,R7                                                           
         USING RRWELD,RE                                                        
DTECALC  NTR1  BASE=*,LABEL=*                                                   
         LA    R4,12               DATA LOCATION                                
         A     R4,ABLOCK                                                        
         LR    R0,R4                                                            
         L     R7,COLXTRA                                                       
         OI    COLOPT2,COLNORND    STOP ROUNDING BEFORE PRINTING                
         MVI   EQTYPE,EQDATE       "D" (DATE) TYPE CALCULATION                  
***********************************************************************         
*  DATE CALC IF IN TRANSLATED FORMAT                                  *         
***********************************************************************         
         SPACE 1                                                                
         TM    RCLOPT2,RCLDICT     IS IT IN DICTIONARY FORMAT?                  
         BZ    DTECAL10            NO                                           
         LA    R4,RCLNDATA         POINT TO 1ST KEYWORD DICT#                   
         LA    R0,2                ONLY DO TWICE, DATE1 THEN DATE2              
*                                                                               
DTECAL08 L     RE,POINTER                                                       
         XC    RRWEL(RRWLNQ+7),RRWEL                                            
         MVI   RRWEL,RRWELQ        ROW ELEMENT CODE, X'C2'                      
         MVI   RRWLN,RRWNLNQ+6     ROW ELEMENT LENGTH                           
         MVI   RRWOPT,RRWCODE                                                   
         OI    RRWOPT2,RRWDICT                                                  
         MVI   RRWTYPE,ROWDTEC                                                  
         MVC   RRWSEQ,RCLSORTN                                                  
         CLC   HIGHSEQ,RRWSEQ      WHICH IS GREATER                             
         BNL   *+10                                                             
         MVC   HIGHSEQ,RRWSEQ      SAVE GREATER NUMBER                          
         MVC   RRWNDATA(2),0(R4)   MOVE IN DICT#                                
         MVC   KEYWRD#,0(R4)                                                    
         MVI   RRWDATLN,2          FORCE LENGTH TO 2                            
*                                                                               
         SR    RF,RF                                                            
         IC    RF,RRWLN                                                         
         AR    RE,RF               POINT TO END OF ELEMENT                      
         MVI   0(RE),0             MARK END                                     
         ST    RE,POINTER                                                       
         GOTO1 =A(KYWFIND)         R6=TABLE ENTRY FOUND                         
         LTR   R6,R6                                                            
         BNZ   *+6                                                              
         DC    H'00'                                                            
         S     R6,KYWBASE          JUST SAVE DISPLACMENT INTO TABLE             
         STCM  R6,3,EQDSP          SAVE DATAINDEX (SECOND PARAMETER)            
         LA    R7,EQLNQ(,R7)       BUMP TO NEXT SPACE                           
         LA    R4,2(,R4)           POINT TO 2ND KEYWORD DICT#                   
         BCT   R0,DTECAL08         DO TWICE                                     
         B     DTECAL90            FINISHED                                     
         EJECT                                                                  
***********************************************************************         
*  DATE CALC IF NOT IN TRANSLATED FORMAT                              *         
***********************************************************************         
         SPACE 1                                                                
DTECAL10 CLI   0(R4),C' '          END OF DATA?                                 
         BE    DTECAL20                                                         
         CLI   0(R4),C'-'          MINUS SIGN                                   
         BE    DTECAL20                                                         
         LA    R4,1(,R4)                                                        
         B     DTECAL10                                                         
*                                                                               
DTECAL20 LR    R1,R4               SAVE LOCATION AT SO FAR                      
         L     RE,POINTER                                                       
         XC    RRWEL(RRWLNQ+7),RRWEL                                            
         MVI   RRWEL,RRWELQ        ROW ELEMENT CODE, X'C2'                      
         MVI   RRWLN,RRWNLNQ+6     ROW ELEMENT LENGTH                           
         MVI   RRWOPT,RRWCODE                                                   
         MVI   RRWTYPE,ROWDTEC     COLUMN TYPE                                  
         MVC   RRWSEQ,RCLSORTN                                                  
         CLC   HIGHSEQ,RRWSEQ      WHICH IS GREATER                             
         BNL   *+10                                                             
         MVC   HIGHSEQ,RRWSEQ      SAVE GREATER NUMBER                          
         MVC   RRWNDATA(6),SPACES  FORCE DATA TO BE LENGTH 6                    
         SR    R1,R0               FIGURE OUT LENGTH SCANED                     
         MVI   RRWDATLN,6          FORCE LENGTH TO 6                            
*        STC   R1,RRWDATLN         SAVE OFF LENGTH OF DATA                      
         BCTR  R1,0                ONE FOR EXECUTE                              
         LR    RF,R0                                                            
         EXMVC R1,RRWNDATA,0(RF)                                                
         MVC   FINDDATA,SPACES                                                  
         EXMVC R1,FINDDATA,RRWNDATA                                             
         SR    RF,RF                                                            
         IC    RF,RRWLN                                                         
         AR    RE,RF               POINT TO END OF ELEMENT                      
         MVI   0(RE),0             MARK END                                     
         ST    RE,POINTER                                                       
         GOTO1 =A(KYWFIND)         R6=TABLE ENTRY FOUND                         
         LTR   R6,R6                                                            
         BNZ   *+6                                                              
         DC    H'00'                                                            
         S     R6,KYWBASE          JUST SAVE DISPLACMENT INTO TABLE             
         STCM  R6,3,EQDSP          SAVE DATAINDEX (SECOND PARAMETER)            
         LA    R7,EQLNQ(,R7)       BUMP TO NEXT SPACE                           
         CLI   0(R4),C' '          END OF DATA?                                 
         BNH   DTECAL90                                                         
         AHI   R4,1                                                             
         LR    R0,R4               NEW LOCATION TO SCAN                         
         B     DTECAL10                                                         
*                                                                               
DTECAL90 MVI   EQTYPE,EQEND        MARK END                                     
         LA    R7,EQLNQ(,R7)                                                    
         ST    R7,PTPSTACK                                                      
         XIT1                                                                   
         SPACE 3                                                                
         LTORG                                                                  
         DROP  R2,R3,R7,RE                                                      
         TITLE 'DUMP FORMAT TABLES'                                             
*=====================================================================*         
* Dump main tables for debugging                                                
*=====================================================================*         
         USING FMTRECD,R5                                                       
         USING BOXD,R9                                                          
         USING BIGPRNTD,R8                                                      
DUMPTAB  NMOD1 0,**DTAB**                                                       
         L     RC,RLBASEC                                                       
         L     R8,VBIGPRNT                                                      
         L     R9,ADBXAREA                                                      
         SR    R0,R0                                                            
         MVC   WORK,SPACES                                                      
         MVC   WORK(7),=C' Format'                                              
         MVC   WORK+8(1),FMTNUM                                                 
         OI    WORK+8,X'F0'                                                     
         GOTO1 PRNTBL,DMCB,(10,WORK),(R5),C'DUMP',                     X        
               FMTLNQ,=CL2'1D'                                                  
*                                                                               
         LA    R0,AFLTLNQ/4        Global filters                               
         LA    R2,AFLTLIST                                                      
         LHI   R3,1                Filter counter                               
DMPTAB02 ICM   R6,15,0(R2)                                                      
         JZ    DMPTAB04                                                         
         TM    0(R2),FLTMULT                                                    
         JZ    DMPTAB04                                                         
         CLI   0(R6),EOT           End of table?                                
         JE    DMPTAB04            Yes                                          
         ICM   R1,1,0(R6)                                                       
         JZ    DMPTAB04                                                         
         MVC   XP+1(11),=C'000 Filter='                                         
         CVD   R3,DUB                                                           
         OI    DUB+L'DUB-1,X'0F'                                                
         UNPK  XP+1(3),DUB                                                      
         BCTR  R1,0                                                             
         MVC   XP+12(0),1(R6)                                                   
         EX    R1,*-6                                                           
         LA    R6,1(R1,R6)                                                      
         GOTOR ACREPORT                                                         
                                                                                
DMPTAB04 AHI   R3,1                                                             
         AHI   R2,4                                                             
         BRCT  R0,DMPTAB02                                                      
*                                                                               
         IC    R0,FMT#ROWS                                                      
         LA    R7,WORK                                                          
         MVC   WORK,SPACES                                                      
         MVC   WORK(11),=C' Row table,'                                         
         MVC   WORK+11(10),=C' Keyword ='                                       
         ST    R7,DMCB                                                          
         MVI   DMCB,L'WORK                                                      
         LA    R7,WORK+22                                                       
*                                                                               
         USING KYWD,R6                                                          
         USING ROWD,R3                                                          
         L     R3,FMTROW                                                        
DMPTAB10 L     R6,ROWINDEX                                                      
         MVC   0(6,R7),KYWCODE                                                  
         GOTO1 PRNTBL,DMCB,,(R3),C'DUMP',ROWLNQ,=CL2'1D'                        
         MVC   WORK,SPACES                                                      
         MVC   WORK(10),=C' Keyword ='                                          
         LA    R7,WORK+11                                                       
         LA    R3,ROWLNQ(,R3)                                                   
         BCT   R0,DMPTAB10                                                      
         DROP  R3                                                               
*                                                                               
         USING COLD,R3                                                          
         IC    R0,FMT#COLS                                                      
         LA    R7,WORK                                                          
         MVC   WORK,SPACES                                                      
         MVC   WORK(14),=C' Column table,'                                      
         MVC   WORK+14(10),=C' Keyword ='                                       
         ST    R7,DMCB                                                          
         MVI   DMCB,L'WORK                                                      
         LA    R7,WORK+25                                                       
*                                                                               
         L     R3,FMTCOL                                                        
DMPTAB20 L     R6,COLINDEX                                                      
         MVC   0(6,R7),KYWCODE                                                  
         GOTO1 PRNTBL,DMCB,(L'WORK,WORK),(R3),C'DUMP',                 X        
               COLLNQ,=CL2'1D'                                                  
*                                                                               
         USING EQD,R4                                                           
         ICM   R4,15,COLXTRA       Column calculation ?                         
         BZ    DMPTAB26                                                         
         SR    RF,RF               Start to count entries                       
         LR    RE,R4                                                            
*                                                                               
DMPTAB24 CLI   EQTYPE,EQEND        End of table                                 
         BE    DMPTAB25            Finished so print out                        
         AHI   RF,1                Another entry found                          
         LA    R4,EQLNQ(,R4)       Bump to next entry                           
         B     DMPTAB24                                                         
*                                                                               
DMPTAB25 LR    R4,RE               Restore to start                             
         GOTO1 PRNTBL,DMCB,=C' Polish stack',(R4),(RF),                X        
               EQLNQ,=C'1H'                                                     
*                                                                               
         USING FLTADRD,R4                                                       
DMPTAB26 ICM   R4,15,COLFLTS       Any filters ?                                
         BZ    DMPTAB34            No                                           
*                                                                               
DMPTAB28 CLI   FLTFLAG,EOT         End of list of filters                       
         BE    DMPTAB34            Yes, finished                                
         L     RE,FLTADDR                                                       
         SR    R2,R2                                                            
         SR    RF,RF                                                            
         TM    FLTFLAG,FLTLIST                                                  
         BZ    DMPTAB30                                                         
         LHI   R2,7                                                             
         B     DMPTAB32                                                         
*                                                                               
DMPTAB30 CLI   0(RE),EOT           End of filters ?                             
         BE    DMPTAB32                                                         
         IC    RF,0(,RE)                                                        
         LA    R2,1(RF,R2)         Total up length                              
         LA    RE,1(RF,RE)         Bump to next filter data                     
         B     DMPTAB30                                                         
*                                                                               
DMPTAB32 MVC   WORK,SPACES                                                      
         MVC   WORK(15),=C' Include filters'                                    
         TM    FLTFLAG,FLTEXCL                                                  
         BZ    *+10                                                             
         MVC   WORK(15),=C' Exclude filters'                                    
         GOTO1 PRNTBL,DMCB,(16,WORK),FLTADDR,C'DUMP',(R2)                       
         LA    R4,FLTADRLQ(,R4)                                                 
         B     DMPTAB28                                                         
         DROP  R4                                                               
*                                                                               
DMPTAB34 MVC   WORK,SPACES                                                      
         MVC   WORK(10),=C' Keyword ='                                          
         LA    R7,WORK+11                                                       
         LA    R3,COLLNQ(,R3)                                                   
         BCT   R0,DMPTAB20                                                      
         DROP  R3,R6                                                            
*                                                                               
         SR    R0,R0                                                            
         ICM   R0,1,FMT#HEAD                                                    
         BZ    DMPTAB42                                                         
         LA    R7,=CL14' Heading table'                                         
         GOTO1 PRNTBL,DMCB,(14,(R7)),FMTHEAD,(R0),                     X        
               HEADLNQ,=CL2'2H'                                                 
*                                                                               
DMPTAB42 SR    R0,R0                                                            
         ICM   R0,1,FMT#BUDS                                                    
         BZ    DMPTAB44                                                         
         MHI   R0,BUDLNQ                                                        
         LA    R7,=CL13' Budget table'                                          
         GOTO1 PRNTBL,DMCB,(13,(R7)),FMTBDGT,C'DUMP',                  X        
               (R0),=CL2'2D'                                                    
*                                                                               
DMPTAB44 CLI   QPROG,MANPOWER                                                   
         BNE   DMPTAB90                                                         
         L     R6,FMTDTED                                                       
DMPTAB60 CLI   0(R6),0                                                          
         BE    DMPTAB90                                                         
         LH    R0,DTECOLLN                                                      
         LA    R7,=CL13' Period dates'                                          
         GOTO1 PRNTBL,DMCB,(13,(R7)),(R6),C'DUMP',(R0),=CL2'2D'                 
         AH    R6,DTECOLLN                                                      
         B     DMPTAB60                                                         
*                                                                               
DMPTAB90 XIT1                                                                   
         DROP  R5,R8,R9                                                         
         SPACE 3                                                                
         LTORG                                                                  
         TITLE 'Get format into IO area for processing'                         
         USING RESRECD,R2                                                       
         USING FMTRECD,R5                                                       
GFORMAT  NMOD1 0,**GFMT**                                                       
         L     RC,RLBASEC                                                       
         MVC   BYTE2,0(R1)         Store which aio to use                       
         L     R2,AIO2                                                          
         LA    RF,IAREA2           Use IO2                                      
         CLI   0(R1),2             P1(1) = IO Area to use                       
         BE    GFORM10                                                          
         L     R2,AIO1                                                          
         LA    RF,IAREA1           Use IO1                                      
         BL    GFORM10                                                          
         L     R2,AIO3                                                          
         LA    RF,IAREA3           Use IO3                                      
*                                                                               
GFORM10  MVC   RESKEY,SPACES                                                    
         MVI   RESKTYP,RESKTYPQ                                                 
         MVI   RESKSUB,RESKSUBQ                                                 
         MVC   RESKCPY,RCCOMPFL                                                 
         L     RE,0(,R1)           P1 = Format code to get                      
         MVC   RESKFORM,0(RE)      Move in format code                          
         MVC   WORK(L'RESKFORM),RESKFORM   Save off format code                 
         MVC   IOKEY,0(R2)                                                      
         L     R1,=AL4(IOREAD+IOACFIL)                                          
         OR    R1,RF               Or on IO area                                
         GOTO1 AIO                                                              
         BE    GFORM20                                                          
*                                                                               
         USING FMTLSTD,RF                                                       
         L     RF,=A(FMTLIST)      Format not found on file                     
GFORM12  CLI   0(RF),X'FF'         Look in external book for default            
         BE    GFORM18             format                                       
         CLC   FMTLCDE,WORK        Match on format code                         
         BE    GFORM14                                                          
         LA    RF,FMTLLNQ(RF)                                                   
         B     GFORM12                                                          
*                                                                               
GFORM14  LHI   R3,IOSIZEQ          Default format found                         
         SR    R1,R1                                                            
         MVCL  R2,R0               Clear IO area first                          
         L     R2,AIO2             Now point to correct io area                 
         CLI   BYTE2,2                                                          
         BE    GFORM16                                                          
         L     R2,AIO1                                                          
         BL    GFORM16                                                          
         L     R2,AIO3                                                          
*                                                                               
GFORM16  LHI   R3,IOSIZEQ          Default format found                         
         L     RE,FMTLADDR         and move in deafult format                   
         LR    RF,R3                                                            
         MVCL  R2,RE                                                            
         L     R2,AIO2             Now point again to correct io area           
         CLI   BYTE2,2             to continue                                  
         BE    GFORM20                                                          
         L     R2,AIO1                                                          
         BL    GFORM20                                                          
         L     R2,AIO3                                                          
         B     GFORM20                                                          
*                                                                               
GFORM18  MVI   ERROR#,1            FORMAT NOT FOUND                             
         CLI   FMTNUM,1                                                         
         BE    GFORM98             MAIN FORMAT NOT FOUND                        
         MVI   ERROR#,16           RECAP MISSING                                
         B     GFORM98                                                          
*                                                                               
         USING STYELD,R3                                                        
GFORM20  CLI   BYTE2,2                                                          
         BNE   GFORM21                                                          
         LR    R0,R2                                                            
         LHI   R1,IOSIZEQ                                                       
         L     RE,ARESREC                                                       
         LR    RF,R1                                                            
         MVCL  RE,R0                                                            
GFORM21  LR    R3,R2                                                            
         AH    R3,DATADISP                                                      
         SR    RF,RF                                                            
GFORM22  CLI   0(R3),0             EOR ?                                        
         BNE   *+6                                                              
         DC    H'00'               Should have had x'25' element                
*                                                                               
         CLI   0(R3),STYELQ        X'25' Scribe report type                     
         BE    GFORM25                                                          
         IC    RF,1(,R3)                                                        
         AR    R3,RF                                                            
         B     GFORM22                                                          
*                                                                               
GFORM25  MVC   FMTRTYP,STYCODE     Reporting type                               
         TM    STYSTAT,STYS2ND     Two records ?                                
         BZ    GFORM50             No                                           
*                                                                               
         LR    R4,R2               R2 = point to key of 1st record              
         LA    R2,IOKEY                                                         
         MVI   RESKSEQ,RESKS2ND                                                 
         L     R1,=AL4(IOREAD+IOACFIL+IOBUD)                                    
         GOTO1 AIO                                                              
         BE    *+6                                                              
         DC    H'00'                                                            
*                                                                               
         L     R3,ABUDIO           2nd record                                   
         AH    R3,DATADISP         Point to start of elements                   
*                                  R2 = 1st record                              
         LR    R2,R4               Restore R2                                   
         LH    R1,RESRLEN          R1 = Keep track of length                    
         AR    R4,R1               Point    to EOR                              
         BCTR  R4,0                Back one to EOR marker                       
*                                                                               
         SR    RF,RF                                                            
GFORM30  CLI   0(R3),0             EOR ?                                        
         BE    GFORM40             Yes                                          
         ICM   RF,1,1(R3)          Get length of element                        
         BNZ   *+6                                                              
         DC    H'00'                                                            
*                                                                               
         BCTR  RF,0                One less for EX instruction                  
         EXMVC RF,0(R4),0(R3)      Tack on element                              
         LA    R4,1(RF,R4)         Bump past appended element                   
         LA    R3,1(RF,R3)         Next element to appended                     
         LA    R1,1(RF,R1)         Keep track of size of record                 
         B     GFORM30                                                          
*                                                                               
GFORM40  STH   R1,RESRLEN          SAVE NEW LENGTH                              
*                                                                               
GFORM50  LA    R2,IOKEY            Conditional replacement record ?             
         MVI   RESKSEQ,RESKS5TH                                                 
         L     R1,=AL4(IOREAD+IOACFIL+IOBUD)                                    
         GOTO1 AIO                                                              
         BNE   GFORM98                                                          
         OI    FMTFLAG2,FMTCCREC   Indicate we have this record                 
         XC    SVTYSQ,SVTYSQ       Save type and sequence                       
         XC    SVADR1,SVADR1                                                    
         MVC   FMTCONS,ACONTAB                                                  
*                                                                               
         USING CONELD,R3                                                        
         USING UTABD,R4                                                         
         L     R3,ABUDIO           New record with column conditionals          
         AH    R3,DATADISP         Point to start of elements                   
         L     R4,FMTCONS                                                       
*                                                                               
GFORM52  CLI   0(R3),CONELQ        Only element type on record                  
         BNE   GFORM97             Finished                                     
*                                                                               
GFORM54  CLC   SVTYSQ,CONTYPE                                                   
         BE    GFORM55                                                          
         OI    TABSW,TABCOPY       Initial call                                 
         ICM   RE,15,SVADR1        2nd time around ?                            
         BZ    GFORM54B            No                                           
         LR    RF,R4                                                            
         SR    RF,RE                                                            
         ST    RF,0(,RE)           Save length of full entry                    
         STC   R0,7(,RE)           Number of elements in entry                  
*                                                                               
GFORM54B SR    R0,R0               R0 = number of elements for type/seq         
         MVC   UTABTYPE,CONTYPE    Set is it a column or row                    
         MVC   UTABNUM,CONNUM      Set which column or row                      
         MVC   SVTYSQ,CONTYPE      Save off new type & sequence                 
         ST    R4,SVADR1           Save of start address                        
         LA    R4,UTABDHDR         Bump past header                             
*                                                                               
GFORM55  AHI   R0,1                Count # with same type & sequence            
         CLC   CONFROM#,=AL2(AC#RSBTY)                                          
         BE    *+10                                                             
         CLC   CONFROM#,=AL2(AC#BILTC)                                          
         BNE   GFORM60                                                          
*                                                                               
         USING BTYPED,R2                                                        
         TM    TABSW,TABCOPY       Did we build yet                             
         BZ    GFORM57             Yes                                          
         LR    R8,R4               Save R4                                      
         L     R2,ABTYPTAB                                                      
         NI    TABSW,TURNOFF-TABCOPY                                            
GFORM56  CLI   0(R2),EOT                                                        
         BE    GFORM56B                                                         
         MVC   0(BTYPLNQ,R4),0(R2)      Copy table in                           
         AHI   R2,BTYPLNQ                                                       
         AHI   R4,BTYPLNQ                                                       
         B     GFORM56                                                          
         DROP  R2                                                               
*                                                                               
GFORM56B MVI   0(R4),EOT           Mark end of table                            
         AHI   R4,1                                                             
         ST    R4,SVADR3                                                        
         L     R4,SVADR1                                                        
         OI    UTABHIND,UTABSUBT   Substitute table type                        
         DROP  R4                                                               
*                                                                               
         USING BTYPED,R4                                                        
GFORM57  LR    R4,R8               Reload                                       
GFORM57A CLI   0(R4),EOT           End of table ?                               
         BNE   *+6                                                              
         DC    H'00'               Should match at least one of them            
*                                                                               
         CLC   CONFROM(1),BTYPCDE  Match on billing type code                   
         BE    GFORM58                                                          
         AHI   R4,BTYPLNQ                                                       
         B     GFORM57A                                                         
*                                                                               
GFORM58  SR    RF,RF                                                            
         IC    RF,CONTOLN                                                       
         BCTR  RF,0                                                             
         MVC   BTYPNME,SPACES      Clear default value                          
         EXMVC RF,BTYPNME,CONFROM+1                                             
         L     R4,SVADR3           Load end of table                            
         B     GFORM90                                                          
         DROP  R4                                                               
*                                                                               
         USING UTABDHDR,R4                                                      
GFORM60  CLC   CONFROM#,=AL2(AC#RSUSF)                                          
         BE    *+10                                                             
         CLC   CONFROM#,=AL2(AC#RSUSC)                                          
         BNE   GFORM90                                                          
         ST    R4,SVADR2                                                        
         MVC   UTABCC,CONCDE       Conditional code                             
         MVC   UTABDLEN,CONFRLN                                                 
         SR    R6,R6                                                            
         IC    R6,CONFRLN                                                       
         BCTR  R6,0                                                             
         EXMVC R6,UTABDATA,CONFROM    Move in data                              
         LA    R9,CONFROM+1(R6)    R9 = start of CONTO part of elem             
         LA    R4,UTABDATA+1(R6)   R4 = End of data area                        
         LR    R8,R4               R8 = location to stick length                
         AHI   R4,1                R4 = Where to move data to                   
         IC    R6,CONTOLN          R6 = length of TO elem data                  
         DROP  R4                                                               
*                                                                               
GFORM62  CLI   0(R9),03            Indicates marco AL1(len),AL2(kwy#)           
         BE    GFORM68                                                          
*                                                                               
GFORM64  MVC   0(1,R4),0(R9)       Move in replace data                         
         AHI   R4,1                                                             
         AHI   R9,1                                                             
         SHI   R6,1                Less what we processed                       
         BZ    GFORM66             Finished                                     
         CLI   0(R9),03            Marco now ?                                  
         BNE   GFORM64                                                          
*                                                                               
GFORM66  LR    RF,R4               Finish seting length                         
         SR    RF,R8                                                            
         BCTR  RF,0                -1 for length stored                         
         STC   RF,0(,R8)           Save off length of data                      
         LR    R8,R4               Set R8 to new location                       
         LTR   R6,R6               Are we finished with element                 
         BZ    GFORM70             Yes                                          
         AHI   R4,1                                                             
*                                                                               
GFORM68  MVC   KEYWRD#,1(R9)       Data dictionary keyword #                    
         LR    R1,R6               Save R6                                      
         GOTO1 =A(KYWFIND)                                                      
         BE    *+6                                                              
         DC    H'00'                                                            
*                                                                               
         USING KYWD,R6                                                          
         SR    RF,RF                                                            
         ICM   RF,3,KYWPRSE                                                     
         A     RF,PRSBASE                                                       
         STCM  RF,15,0(R4)                                                      
         MVC   0(1,R8),KYWSRTQ+1   Size of data                                 
         DROP  R6                                                               
*                                                                               
         LR    R6,R1               Restore R6                                   
         OI    0(R8),X'80'         Mark as parse entry                          
         AHI   R4,4                                                             
         AHI   R9,3                                                             
         LR    R8,R4                                                            
         AHI   R4,1                                                             
         SHI   R6,3                                                             
         BNZ   GFORM62             Keep going                                   
         BCTR  R4,0                                                             
*                                                                               
GFORM70  L     RE,SVADR2                                                        
         MVI   0(R4),EOT           Mark end                                     
         AHI   R4,1                                                             
         LR    RF,R4                                                            
         SR    RF,RE                                                            
         STC   RF,0(,RE)           Save length of built entry                   
*                                                                               
GFORM90  SR    RF,RF                                                            
         IC    RF,1(,R3)           Next element                                 
         AR    R3,RF                                                            
         B     GFORM52                                                          
*                                                                               
GFORM97  L     RE,SVADR1                                                        
         MVI   0(R4),EOT           Mark end                                     
         AHI   R4,1                                                             
         LR    RF,R4                                                            
         SR    RF,RE                                                            
         ST    RF,0(,RE)           Save length of built entry                   
         STC   R0,7(,RE)           Save number of entries                       
         XC    1(4,R4),1(R4)       Clear some space just in case                
         AHI   R4,4*K              Leave some spare for each format             
         ST    R4,ACONTAB                                                       
*                                                                               
GFORM98  CLI   ERROR#,0                                                         
         DROP  R3,R5                                                            
         XIT1                                                                   
                                                                                
SVADR1   DS    A                                                                
SVADR2   DS    A                                                                
SVADR3   DS    A                                                                
SVTYSQ   DS    XL2                 Saved type and sequence                      
TABSW    DS    XL1                                                              
TABCOPY  EQU   X'80'                                                            
         SPACE 3                                                                
         LTORG                                                                  
         TITLE 'Get all ledgers involved for RUN'                               
         USING FMTRECD,R5                                                       
SETLDGRS NMOD1 0,**SLDG**                                                       
         L     RC,RLBASEC                                                       
         L     R7,=A(FMTTAB)                                                    
         L     R4,ALEDGERS         Initialize list of ledgers to use            
         MVI   0(R4),EOT           Mark end of list                             
         SR    R6,R6               Keep track of number of ledgers              
         CLC   QUNIT(2),SPACES                                                  
         BH    SETLD99             Requesting specific ledger                   
*                                                                               
         USING RFLELD,R2                                                        
         L     R2,AIO2                                                          
SETLD10  AH    R2,DATADISP                                                      
         SR    R1,R1                                                            
SETLD12  CLI   0(R2),0             EOR                                          
         BNE   *+6                                                              
         DC    H'00'                                                            
*                                                                               
         CLI   0(R2),RFLELQ        Get ledger list                              
         BNE   SETLD15                                                          
         CLI   RFLSEQ,0            Is it global report type filter ?            
         BNE   SETLD15             No ledgers                                   
         CLI   RFLTYPE,RFLLDG      Ledger filter(s)                             
         BE    SETLD20                                                          
SETLD15  IC    R1,1(,R2)                                                        
         AR    R2,R1                                                            
         B     SETLD12             Get next element                             
*                                                                               
SETLD20  IC    R1,1(,R2)           Get length of ledger filters                 
         LA    R3,RFLDATA                                                       
         SHI   R1,(RFLDATA-RFLELD)                                              
*                                                                               
SETLD21  L     R4,ALEDGERS         Initialize list of ledgers to use            
SETLD22  CLI   0(R4),EOT           End of ledgers ?                             
         BE    SETLD26             Yes so add to list                           
         CLC   0(2,R4),0(R3)       Are they the same ?                          
         BE    SETLD27             Already in list                              
         AHI   R4,2                Check next ledger in list                    
         B     SETLD22                                                          
*                                                                               
SETLD26  MVC   0(2,R4),0(R3)                                                    
         AHI   R6,1                Number of unique ledgers to read             
         AHI   R4,2                Check next ledger in list                    
         MVI   0(R4),EOT           Mark end of list                             
*                                                                               
SETLD27  AHI   R3,3                Process next ledger                          
         SHI   R1,3                                                             
         BP    SETLD21             Another ledger if positive                   
         TM    RECAPSW,RECAPMIX                                                 
         BZ    SETLD80             All recaps us main                           
*                                                                               
         USING RCPELD,R7                                                        
SETLD30  AHI   R7,RCPLNQ                                                        
         CLI   0(R7),EOT           Any more to process ?                        
         BE    SETLD80             No                                           
         TM    RCPOPT1,RCPPROF     Format profile                               
         BZ    SETLD30             Skip this one, uses main profile             
*                                                                               
         L     R2,AIO3                                                          
         GOTO1 GETFORMT,DMCB,(3,RCPCODE)                                        
         BNE   SETLD30             Format not found                             
         B     SETLD10                                                          
         DROP  R2,R7                                                            
*                                                                               
         USING ACMD,R2                                                          
SETLD80  CHI   R6,1                                                             
         BNH   SETLD90                                                          
*&&DO                                                                           
* AH Aug9/2007. Should implement but would move to procspcl mode                
* Would need to move other code around.                                         
         L     R2,AMONACC                                                       
         MVC   ACMANXL,ALEDGERS                                                 
         STC   R6,ACMANXL                                                       
*&&                                                                             
         MVI   MULTLDG,YES         Multiple ledgers to process                  
         MVI   RCREQREP,NO         Don't create mult. request details           
         DROP  R2                                                               
*                                                                               
SETLD90  L     R4,ALEDGERS                                                      
         MVC   QUNIT(2),0(R4)      Initialize first ledger                      
         CLC   QUNIT(2),SPACES     Should always have a ledger by now           
         BH    SETLD99                                                          
         MVI   ERROR#,5            No unit/ledger set-up                        
*                                                                               
SETLD99  CLI   ERROR#,0            Set condition code                           
         XIT1                                                                   
         DROP  R5                                                               
         SPACE 3                                                                
         LTORG                                                                  
         TITLE 'Set up format gobal filtering'                                  
***********************************************************************         
*  BUILD GENERAL PROFILE FILTERS                                      *         
*   R1 = NUMBER OF SCAN BLOCK PARAMETERS                              *         
*   R2 = A(RFLELD ELEMENT)                                            *         
*   R3 = A(FLTFLD TABLE ENTRY)                                        *         
*   R4 = A(SCAN BLOCK)          OR  CURRENT PARAMETER IN SCAN BLOCK   *         
*   R5 = A(PASSED FORMAT TO PROCESS)                                            
*   R6 = A(FILTER CASE ADDRESS)                                       *         
*   R7 = A(FILTER BUILD AREA)                                         *         
***********************************************************************         
         SPACE 1                                                                
         USING RFLELD,R2                                                        
         USING DATAD,R3                                                         
         USING FMTRECD,R5                                                       
         USING LGFLTD,R9           Local storate                                
GFILTER  NMOD1 LGFLTDQ,**GFLT**,CLEAR=YES                                       
         LR    R9,RC               R9=(Local storage)                           
         L     RC,RLBASEC                                                       
         MVI   GFLTIND,0           Set to say filter type list                  
         TM    FMTRCAP,FMTRPROF    Use formats profile not main                 
         BZ    GFLTR90             No, use main only                            
         USING ACRL2D,RF                                                        
         L     RF,AACRL2D                                                       
         MVC   SVFMTCDE,FMTCODE                                                 
         DROP  RF                                                               
         L     R2,AIO2                                                          
         AH    R2,DATADISP                                                      
*                                                                               
GFLTR02  CLI   0(R2),0             End of record (EOR)                          
         BE    GFLTR85                                                          
         CLI   0(R2),RFLELQ        X'C5', filter/list elements                  
         BNE   GFLTR80                                                          
         CLI   RFLSEQ,0            General profile filter ?                     
         BNE   GFLTR80             No, this is a column filter so skip          
*                                                                               
         MVC   P,SPACES            Use P as work area                           
         SR    R1,R1                                                            
         IC    R1,1(R2)            Length of element                            
         SHI   R1,(RFLLNQ+1)                                                    
         EXMVC R1,P,RFLDATA                                                     
         TM    RFLIND,RFLBINRY     Binary data ?                                
         BO    GFLTR06             Yes, so can't scan                           
                                                                                
         GOTO1 =V(SCANNER),DMCB,(C'C',P),(32,ABLOCK),C',=,`'                    
         MVC   NPRAMS,DMCB+4                                                    
         SR    R1,R1                                                            
         ICM   R1,1,DMCB+4         Number of parameters                         
         BZ    GFLTR80             Bad data                                     
*                                                                               
GFLTR06  L     R3,FLTBASE          Filter table information                     
         L     R4,ABLOCK           A(SCAN BLOCK)                                
         L     R7,AFLTAREA         A(Area to build filter data)                 
*                                                                               
         USING ACQD,RE                                                          
         CLI   RFLTYPE,RFLLDG      Ledger filter(s)                             
         BNE   GFLTR11                                                          
         L     RE,ADQSTACK         Request card stack                           
         CLC   ACQUNT,SPACES       Could be mixed ledgers                       
         BH    GFLTR80             No, already set in request card              
         DROP  RE                                                               
*                                                                               
GFLTR11  CLI   RFLTYPE,RFLCNTR     Contra accounts?                             
         BE    *+8                                                              
         CLI   RFLTYPE,RFLBSR      Contra account for RCV                       
         BNE   GFLTR12                                                          
         OI    THRSW,THRGFP        Global filter per-determined                 
*&&UK*&& TM    RECAPSW,RECAPMIX                                                 
*&&uK*&& BO    GFLTR12             Set-up individual report filter              
         GOTO1 =A(CNTRAFLT),DMCB,(R2)                                           
         B     GFLTR23             Build AFLTCTRA too                           
*                                                                               
GFLTR12  CLI   RFLTYPE,RFLWC       Workcode                                     
         BNE   GFLTR12A                                                         
         OI    THRSW,THRGFP        Global filter pre-determined                 
*                                                                               
GFLTR12A CLI   RFLTYPE,RFLOFF      Office                                       
         BNE   GFLTR16                                                          
         OI    THRSW,THRGFP        Global filter pre-determined                 
         CLC   QOFFICE,SPACES      Make sure office not in request card         
         BNE   GFLTR80             Yes it was                                   
*                                                                               
         CLI   NEWOFF,YES                                                       
         BNE   GFLTR23             Continue as usual                            
         TM    RECAPSW,RECAPMIX    Mix main profiles ?                          
         BZ    GFLTR13             No, so set up global                         
         CLI   NPRAMS,1            Yes, so convert possible office list         
         BNE   GFLTR16             Build filter as normal                       
         LA    R6,AFLTOFF                                                       
         GOTO1 =A(OFFFLT),DMCB,(R2),(R6)                                        
         B     GFLTR80             Next                                         
*                                                                               
         USING OFLELD,RE                                                        
GFLTR13  CLI   NPRAMS,1            If only one then call OFFAL as usual         
         BE    GFLTR15                                                          
         L     RE,ABUDIO           Use as temporary work area                   
         XC    0(256,RE),0(RE)                                                  
         MVI   OFLEL,OFLELQ                                                     
         SR    RF,RF                                                            
         IC    RF,NPRAMS           Number of offices                            
         LR    R1,RF                                                            
         SLL   R1,1                Multiply by 2 for two byte offices           
         AHI   R1,OFLLN1Q                                                       
         STC   R1,OFLLN                                                         
         LA    RE,OFLNTRY          Start of entries to build                    
*                                                                               
GFLTR14  MVC   0(2,RE),12(R4)      Save off offices                             
         LA    RE,2(,RE)                                                        
         LA    R4,32(,R4)          Next parameter                               
         BCT   RF,GFLTR14                                                       
         DROP  RE                                                               
*                                                                               
         USING OFFALD,R1                                                        
GFLTR15  L     R1,ADOFFALD                                                      
         MVC   OFFACOMF,ADCOMFAC                                                
         NI    OFFAINDS,TURNOFF-OFFAIXOL-OFFAIUOL                               
         CLI   NPRAMS,1                                                         
         BNE   GFLTR15D                                                         
         MVC   OFFAOFFC,12(R4)     Move in office                               
         B     GFLTR15F                                                         
*                                                                               
GFLTR15D OI    OFFAINDS,OFFAIUOL                                                
         MVC   OFFAUSRL,ABUDIO     Pass build element                           
         MVI   OFFAOFFC,X'FF'      Trick so MONACC filters offices              
*                                                                               
GFLTR15F TM    RFLIND,RFLXCLD      Test if exclude of not                       
         BZ    *+8                                                              
         OI    OFFAINDS,OFFAIXOL                                                
         MVI   OFFAACT,OFFAREQ     Set request list                             
         MVC   SVRE,OFFAREQL                                                    
         MVC   OFFAREQL,ALTOFFL    Alternate office list area                   
         GOTO1 ADOFFAL                                                          
         BE    *+8                 All OK                                       
         MVI   ERROR#,21           Off lockout, &T                              
         NI    OFFAINDS,TURNOFF-OFFAIXOL-OFFAIUOL                               
         MVC   OFFAREQL,SVRE                                                    
*                                                                               
         USING ACMD,R1                                                          
         L     R1,AMONACC          Set office list in MONACC DSECT              
         LA    RE,ACMOFCN                                                       
         L     R0,ALTOFFL                                                       
         LA    RF,256*2+L'ACMOFCN                                               
         LR    R1,RF                                                            
         MVCL  RE,R0                                                            
         B     GFLTR80             Get next element                             
         DROP  R1                                                               
*                                                                               
GFLTR16  CLI   RFLTYPE,RFLTTIME    Type of time                                 
         BNE   GFLTR18                                                          
         OI    THRSW,THRGFP        Global filter Pre-determined                 
         MVI   TIMESTA2,0          Initialize                                   
*                                                                               
GFLTR17  CLI   12(R4),C'B'         B - time                                     
         BNE   *+8                                                              
         OI    TIMESTA2,TIMEB                                                   
         CLI   12(R4),C'N'         N - time                                     
         BNE   *+12                                                             
         OI    TIMESTA2,TIMEN                                                   
         MVI   FCRNTIME,YES        Need to set MONACC indicator                 
         CLI   12(R4),C'R'         R - Time                                     
         BNE   *+12                                                             
         OI    TIMESTA2,TIMER                                                   
         MVI   FCRNTIME,YES        Need to set MONACC indicator                 
         AHI   R4,32                                                            
         BCT   R1,GFLTR17                                                       
         B     GFLTR80                                                          
*                                                                               
GFLTR18  DS    0H                                                               
*&&UK                                                                           
         CLI   RFLTYPE,RFLVATRG    VAT Region                                   
         BNE   GFLTR20                                                          
         OI    THRSW,THRGFP        Global filter Pre-determined                 
         MVI   VATRGSTA,0          Initialize                                   
*                                                                               
GFLTR19  CLI   12(R4),DDTAXLNQ     N - Exclude E and X                          
         BNE   *+8                                                              
         OI    VATRGSTA,VATRGNAT                                                
         CLI   12(R4),DDTAXLEQ     E - European                                 
         BNE   *+8                                                              
         OI    VATRGSTA,VATRGEU                                                 
         CLI   12(R4),DDTAXLXQ     X - Foreign but non european                 
         BNE   *+8                                                              
         OI    VATRGSTA,VATRGNEU                                                
         AHI   R4,32                                                            
         BCT   R1,GFLTR19                                                       
         B     GFLTR80                                                          
*&&                                                                             
GFLTR20  CLI   RFLTYPE,RFLBESTA    BrandOcean Estimate Status                   
         BNE   GFLTR22                                                          
         OI    THRSW,THRGFP                                                     
         MVI   BESTAS,0                                                         
*                                                                               
GFLTR21  CLI   12(R4),PRGRSS       In progress                                  
         BNE   *+8                                                              
         OI    BESTAS,BESPRG                                                    
         CLI   12(R4),SUBINA       Submitted to internal approver               
         BNE   *+8                                                              
         OI    BESTAS,BESSIN                                                    
         CLI   12(R4),INTAPP       Internally approved                          
         BNE   *+8                                                              
         OI    BESTAS,BESIAP                                                    
         CLI   12(R4),SUBCLI       Submitted to client approver                 
         BNE   *+8                                                              
         OI    BESTAS,BESSCL                                                    
         CLI   12(R4),CLIAPP       Client approved                              
         BNE   *+8                                                              
         OI    BESTAS,BESCAP                                                    
         CLI   12(R4),REJCTD       Rejected                                     
         BNE   *+8                                                              
         OI    BESTAS,BESREJ                                                    
         CLI   12(R4),DELTED       (Logically) deleted                          
         BNE   *+8                                                              
         OI    BESTAS,BESDEL                                                    
         CLI   12(R4),MERGD        Merged                                       
         BNE   *+8                                                              
         OI    BESTAS,BESMRG                                                    
         AHI   R4,32                                                            
         BCT   R1,GFLTR21                                                       
         TM    RFLIND,RFLXCLD      Exclude data instead of include              
         BNO   GFLTR80                                                          
         XI    BESTAS,BESALL                                                    
         B     GFLTR80                                                          
                                                                                
GFLTR22  CLI   RFLTYPE,RFLXCPT     Save number of exception reasons             
         BNE   GFLTR23                                                          
         STC   R1,NEXPCDES                                                      
         OI    ESTIND,ESTRGES                                                   
*                                                                               
GFLTR23  CLI   0(R3),EOT                                                        
         BNE   *+6                                                              
         DC    H'00'               Not in table, update table                   
         CLC   RFLTYPE,DATAFLTY    Match type with element                      
         BNE   GFLTR24                                                          
         TM    DATAIND1,DATASKP    skip this one                                
         BO    GFLTR80                                                          
         TM    DATAIND1,DATAGEN    General profile type filter?                 
         BO    GFLTR25             Yes, so OK                                   
         DC    H'00'               How have I a general profile then ?          
*                                                                               
GFLTR24  AHI   R3,DATALNQ          Bump up in table                             
         B     GFLTR23                                                          
*                                                                               
GFLTR25  SR    R6,R6                                                            
         ICM   R6,3,DATAFLTR       Get address of A(FILTER)                     
         AR    R6,R5               Add base                                     
         CLI   0(R6),0             Is there one set up already?                 
         BNE   GFLTR80             Yes so get next element                      
         MVI   GFLTIND,FLTMULT     Set to say filter type list                  
         TM    RFLIND,RFLXCLD      Exclude data instead of include              
         BZ    *+8                                                              
         OI    GFLTIND,FLTEXCL     X'10' exclude it                             
         TM    RFLIND,RFLWILD      Wild card used ?                             
         BZ    *+8                 No                                           
         OI    GFLTIND,FLTWILD     X'04' wild card set                          
*                                                                               
         CLI   RFLTYPE,RFLPCDE     Pay codes type                               
         BE    GFLTR26                                                          
         CLI   RFLTYPE,RFLTTYPE    Transaction type                             
         BNE   GFLTR30                                                          
*                                  Format codes by making the seperate          
GFLTR26  ST    R7,0(,R6)           Save off start address                       
         MVC   0(1,R6),GFLTIND     Set indicators                               
         SR    R1,R1                                                            
         IC    R1,RFLLN            Lenght of element                            
         SHI   R1,RFLLNQ           Figure out # of trans types                  
         LA    RE,RFLDATA                                                       
*                                                                               
GFLTR27  MVI   0(R7),1             Mark as length 1                             
         MVC   1(1,R7),0(RE)       Save off trans type or pay code              
         AHI   RE,1                Bump to next trans type or pay code          
         AHI   R7,2                Bump up in table                             
         BCT   R1,GFLTR27                                                       
*                                                                               
         MVI   0(R7),EOT           Mark end                                     
         AHI   R7,1                                                             
         ST    R7,AFLTAREA         Save new address for latter                  
         B     GFLTR80             Next element                                 
*                                                                               
GFLTR30  MVC   GFLTUL,DATAUL       Set defualt                                  
         CLI   RFLTYPE,RFLACC      Account list case "??" in table              
         BNE   GFLTR32                                                          
         CLI   QPROG,PAYABLES                                                   
         BE    GFLTR32                                                          
         CLI   QPROG,EXPENSE                                                    
         BE    GFLTR32                                                          
         CLI   QPROG,GENERAL                                                    
         BE    GFLTR32                                                          
         MVC   GFLTUL,QUNIT        If ledger then set FLT U/L                   
*                                                                               
GFLTR32  CLI   RFLTYPE,RFLCLI      Client/product list                          
         BNE   GFLTR40                                                          
         OI    THRSW,THRGFP        Global filter pre-determined                 
         CLI   NPRAMS,2            Special case                                 
         BNE   GFLTR40             Not it                                       
         CLI   RFLDATA,C'+'        Is it a list                                 
         BE    *+8                                                              
         CLI   RFLDATA,C'-'                                                     
         BNE   GFLTR40             Not a list                                   
         L     R4,ABLOCK                                                        
         AHI   R4,12               First entry in block                         
         GOTO1 =A(LISTBLD),DMCB,(R4),0,0                                        
         CLI   DMCB,0              Aa error?                                    
         BE    GFLTR80                                                          
         MVC   AFLTCLI1,DMCB       Save address of list record                  
         AHI   R4,32               Second entry in block, point to data         
         GOTO1 =A(LISTBLD),DMCB,(R4),0,0                                        
         CLI   DMCB,0                                                           
         BE    GFLTR80                                                          
         MVC   AFLTCLI2,DMCB       Save address of 2nd list record              
         B     GFLTR80                                                          
*                                                                               
GFLTR40  GOTO1 =A(LISTBLD),DMCB,(NPRAMS,ABLOCK),(0,GFLTUL),C'SCAN'              
         CLI   0(R1),0                                                          
         BE    GFLTR80             Error ?                                      
         MVC   0(4,R6),0(R1)                                                    
         TM    0(R1),FLTLIST       If +/- list then ignore GFLTIND              
         BO    GFLTR80                                                          
         MVC   BYTE,0(R1)                                                       
         NI    BYTE,FLTNOUL+FLTMULT                                             
         MVC   0(1,R6),GFLTIND                                                  
         OC    0(1,R6),BYTE                                                     
*                                                                               
GFLTR80  SR    R1,R1                                                            
         IC    R1,1(,R2)           Length of element                            
         AR    R2,R1               Bump to next element                         
         B     GFLTR02                                                          
*                                                                               
GFLTR85  CLI   QPROG,INCOME        Special case for contra                      
         BNE   GFLTR99                                                          
         TM    CURLDGR+3,PAR_1C    Income 1C                                    
         BZ    GFLTR99                                                          
         GOTO1 =A(CNTRAFLT),DMCB,0                                              
         B     GFLTR99                                                          
*                                                                               
MAIN     USING FMTRECD,R6                                                       
GFLTR90  L     R6,AFORMATS                                                      
         MVC   AFLTLIST(AFLTLNQ),MAIN.AFLTLIST                                  
         MVC   NEXPCDES,MAIN.NEXPCDES                                           
*                                                                               
GFLTR99  XIT1                                                                   
         DROP  MAIN                                                             
         DROP  R2,R3,R5,R9                                                      
         SPACE 3                                                                
         LTORG                                                                  
         TITLE 'Set up column filtering'                                        
***********************************************************************         
*  BUILD COLUMN FILTERS                                               *         
*   R1 = NUMBER OF SCAN BLOCK PARAMETERS OR NPRAMS                    *         
*   R2 = A(RFLELD ELEMENT)                                            *         
*   R3 = A(FLTFLD TABLE ENTRY)                                        *         
*   R4 = A(SCAN BLOCK)          OR  CURRENT PARAMETER IN SCAN BLOCK   *         
*   R5 = A(FORMAT TO PROCESS)                                         *         
*   R6 = A(FILTER CASE ADDRESS)                                       *         
*   R7 = A(FILTER BUILD AREA)                                         *         
***********************************************************************         
         USING RFLELD,R2                                                        
         USING FLTADRD,R6                                                       
         USING FMTRECD,R5                                                       
         USING LCFLTD,R9                                                        
CFILTER  NMOD1 LCFLTDQ,**CFLT**,CLEAR=YES                                       
         LR    R9,RC               R9=(Local storage)                           
         L     RC,RLBASEC                                                       
         L     R7,AFLTAREA         INITIALIZE R7 (STORE FILTER VALUES)          
         MVI   PREVSEQ,0                                                        
*&&UK                                                                           
         L     RF,AXDATNE                                                       
         MVI   0(RF),X'FF'                                                      
         ST    RF,CXDATNE                                                       
                                                                                
         L     RF,AXDATVE                                                       
         MVI   0(RF),X'FF'                                                      
         ST    RF,CXDATVE                                                       
*&&                                                                             
         L     R6,AFLTADDR         A(LIST OF ADDRESS TO FILTER DATA)            
         L     R2,AIO2                                                          
         AH    R2,DATADISP                                                      
CFLTR02  CLI   0(R2),0             END OF RECORD                                
         BE    CFLTR85                                                          
         CLI   0(R2),RFLELQ        X'C5', FILTER/LIST ELEMENT                   
         BNE   CFLTR80                                                          
         CLI   RFLSEQ,0            HAS TO BE A COLUMN NUMBER                    
         BE    CFLTR80             WAS GENERAL PROFILE FILTER SO SKIP           
*                                                                               
         MVC   P,SPACES            FAKE A HEADER ELEMENT FOR SCANNER            
         XR    R1,R1                                                            
         IC    R1,1(,R2)           ELEMENT LENGTH                               
         SHI   R1,RFLLNQ                                                        
         STC   R1,P+5                                                           
         LR    RE,R1                                                            
         AH    RE,=H'8'                                                         
         STC   RE,P                                                             
         BCTR  R1,0                                                             
         EXMVC R1,P+8,RFLDATA                                                   
         TM    RFLIND,RFLBINRY     Binary data ?                                
         BO    CFLTR04             Yes, so can't scan                           
                                                                                
         GOTO1 =V(SCANNER),DMCB,(20,P),(32,ABLOCK),C',=,`'                      
         MVC   NPRAMS,DMCB+4                                                    
         SR    R1,R1                                                            
         ICM   R1,1,DMCB+4         NUMBER OF PARAMETERS                         
         BZ    CFLTR80             BAD DATA                                     
*                                                                               
         USING COLD,R3                                                          
CFLTR04  TM    DDLNKIND,DDLNKON+DDLNKTST                                        
         BZ    CFLTR10                                                          
         SR    RF,RF                                                            
         IC    RF,FMT#COLS         Number of columns to search                  
         L     R3,FMTCOL           Start of table                               
CFLTR06  CLC   RFLSEQ,COLNUM       Match on column number                       
         BE    CFLTR11                                                          
         AHI   R3,COLLNQ                                                        
         BCT   RF,CFLTR06                                                       
         DC    H'00'                                                            
                                                                                
CFLTR10  SR    R3,R3               POINT TO COLUMN WE ARE ADDRESSING            
         IC    R3,RFLSEQ                                                        
         BCTR  R3,0                                                             
         MHI   R3,COLLNQ                                                        
         A     R3,FMTCOL           ADD BASE OF COLUMNS                          
*                                                                               
CFLTR11  CLI   RFLTYPE,RFLFCUR     FOREIGN CURRENCY?                            
         BNE   CFLTR12                                                          
         MVC   COLFCCDE,RFLDATA    SAVE CURRENCY CODE                           
         OI    COLOPT,COLFCFLT                                                  
         B     CFLTR80                                                          
*                                                                               
CFLTR12  CLI   RFLTYPE,RFLMTHD     IS IT A METHOD                               
         BNE   CFLTR13                                                          
         MVC   COLMTHD,RFLDATA                                                  
         MVC   BYTE,COLMTHD                                                     
         NI    BYTE,TURNOFF-X'F0'  MAKE BINARY C'1' THRU C'9'                   
         SR    RF,RF                                                            
         IC    RF,BYTE                                                          
         BCTR  RF,0                                                             
         LA    RE,METHODS(RF)                                                   
         MVC   0(1,RE),COLMTHD     SAVE OFF METHOD                              
         B     CFLTR80                                                          
*                                                                               
CFLTR13  CLI   RFLTYPE,RFLBUDGT    IS IT A BUDGET                               
         BNE   CFLTR14                                                          
         OI    COLFLAGS,COLBUD     YES, TURN ON FLAG                            
         NI    COLIND3,TURNOFF-COLNASRT-COLNATSR                                
         MVC   COLBUD#,RFLDATA     SAVE BUDGET NUMBER                           
         OI    FMTIND2,FMTBUDON    FLAG TO INITIATE BUILDING BUD CODE           
         B     CFLTR80                                                          
*                                                                               
CFLTR14  DS    0H                                                               
*&&UK                                                                           
         CLI   RFLTYPE,RFLXDATN    IS IT XDATA NAME?                            
         BE    *+12                                                             
         CLI   RFLTYPE,RFLXDATV    IS IT XDATA VALUE?                           
         BNE   CFLTR15                                                          
         TM    RFLIND,RFLXDEST     (Only interested in Estimates)               
         BZ    CFLTR80                                                          
*                                                                               
         USING XDATED,R4                                                        
         CLI   RFLTYPE,RFLXDATN    IS IT XDATA NAME?                            
         BNE   CFLTR14C                                                         
         L     R4,CXDATNE                                                       
         XC    XDATNMS,XDATNMS                                                  
         LA    R8,XDATNMS                                                       
         B     CFLTR14D                                                         
                                                                                
CFLTR14C CLI   RFLTYPE,RFLXDATV    IS IT XDATA VALUE?                           
         BNE   CFLTR80                                                          
         L     R4,CXDATVE                                                       
         XC    XDATVLS,XDATVLS                                                  
         LA    R8,XDATVLS                                                       
*                                                                               
CFLTR14D MVC   XDATCOL,RFLSEQ      SAVE COLUMN NUMBER                           
         IC    R1,RFLLN                                                         
         SHI   R1,RFLLNQ                                                        
         LR    RF,R1               RF=REAL LENGTH OF XDATVAL                    
         LA    RE,1(RF)                                                         
         AHI   RE,XDATUML-XDATCOL                                               
         STC   RE,XDATDLN                                                       
         BCTR  R1,0                                                             
         BM    CFLTR80                                                          
         MVC   1(0,R8),RFLDATA     SAVE XDATA NAME(S) OR VALUE(S)               
         EX    R1,*-6                                                           
*                                                                               
         LA    RE,2(R1,R8)         RE=A(END OF XDATVAL)                         
         LA    R1,1                (MUST BE AT LEAST ONE XDATA ENTRY)           
         XR    R8,R8                                                            
         CLI   RFLTYPE,RFLXDATN    IS IT XDATA NAME?                            
         BNE   CFLTR14E                                                         
         MVI   0(RE),X'FF'         MARK NEW END OF TABLE                        
         ST    RE,CXDATNE                                                       
         BCTR  RE,0                                                             
         B     CFLTR14G                                                         
*                                                                               
CFLTR14E MVI   0(RE),X'FF'         MARK NEW END OF TABLE                        
         ST    RE,CXDATVE                                                       
         BCTR  RE,0                                                             
*                                                                               
CFLTR14G CLI   0(RE),C','          COMMA?                                       
         BNE   CFLTR14H                                                         
         AHI   R1,1                                                             
         STC   R8,0(RE)            STORE LENGTH OF RFLDATA ENTRY                
         XR    R8,R8                                                            
         B     *+8                                                              
CFLTR14H AHI   R8,1                                                             
         SHI   RE,1                                                             
         BCT   RF,CFLTR14G                                                      
         STC   R8,XDATUML          STORE LENGTH OF FIRST RFLDATA ENTRY          
         STC   R1,XDATNUM          # OF ITEMS IN RFLDATA                        
         DROP  R4                                                               
*                                                                               
CFLTR15  CLI   RFLTYPE,RFLSUPE     COLFLT - SUPPRESS UNAPPROVED EST             
         BNE   CFLTR16                                                          
         CLI   RFLDATA,YES                                                      
         BNE   CFLTR80                                                          
         OI    ESTIND,ESTJSTAT     NEED JOB STATUS                              
         B     CFLTR24                                                          
*                                                                               
CFLTR16  TM    COLFLAGS,COLAMT+COLCALC                                          
         BZ    CFLTR18             OK, Not Accm or Calc column                  
         CLI   RFLTYPE,RFLAMFR     COLFLT - AMOUNT FROM                         
         BNE   CFLTR17                                                          
         MVC   COLMIN$,RFLAMNT     SET MIN RANGE                                
         MVI   COLMINCC,BH                                                      
         OI    COLIND1,COLRANGE    SET MIN AND/OR MAX RANGE FILTER?             
         B     CFLTR80                                                          
CFLTR17  CLI   RFLTYPE,RFLAMTO     COLFLT - AMOUNT TO                           
         BNE   CFLTR18                                                          
         MVC   COLMAX$,RFLAMNT     SET MAX RANGE                                
         MVI   COLMAXCC,BL                                                      
         OI    COLIND1,COLRANGE    SET MIN AND/OR MAX RANGE FILTER?             
         B     CFLTR80                                                          
*                                                                               
CFLTR18  CLI   RFLTYPE,RFLESTIM    Estimated time filter                        
         BNE   CFLTR20                                                          
         CLI   RFLDATA,NO          Test exclude est time in Net/Gross           
         BNE   *+8                                                              
         OI    COLIND5,COLIETN                                                  
         CLI   RFLDATA,YES         Test only est time in Net/Gross              
         BNE   *+8                                                              
         OI    COLIND5,COLIETO     ('Yes' = 'Only' ...)                         
         B     CFLTR80                                                          
*                                                                               
CFLTR20  CLI   RFLTYPE,RFLBNVS     BrandOcean Invs status(es) filter            
         BNE   CFLTR22                                                          
         SR    RF,RF                                                            
         IC    RF,RFLDATA          high 4 bits = Sub/Pt app/App/Rej....         
         SRL   RF,4                shift to low 4 bits                          
         STC   RF,BYTE                                                          
         OC    COLIND5,BYTE                                                     
         B     CFLTR80                                                          
*&&                                                                             
CFLTR22  CLI   RFLTYPE,RFLACC      is it an account ?                           
         BE    CFLTR24                                                          
         TM    COLOPT2,COLTHRS                                                  
         BZ    CFLTR24                                                          
         OI    THRSW,THRCFP        COLUMN FILTER PRE-DETERMINED                 
*                                                                               
CFLTR24  L     R4,ABLOCK                                                        
         LA    R4,8(R4)                                                         
         CLI   PREVSEQ,0           FOR FIRST TIME IN                            
         BE    CFLTR26                                                          
         CLC   PREVSEQ,RFLSEQ      IF CHANGED, NO MORE FOR THIS COLUMN          
         BE    CFLTR26                                                          
         LA    R6,4(,R6)           BUMP PAST END OF ENTRY MARKER                
*                                                                               
CFLTR26  OC    COLFLTS,COLFLTS                                                  
         BNZ   *+8                                                              
         ST    R6,COLFLTS          SAVE ADDRESS OF FILTER TABLE TO COL          
         MVC   PREVSEQ,RFLSEQ      SAVE COLUMN NUMBER                           
         L     R7,AFLTAREA                                                      
         ST    R7,FLTADDR          SAVE A(FILTER LIST AREA)                     
         DROP  R3                                                               
*                                                                               
         MVI   CFLTIND,FLTMULT                                                  
         TM    RFLIND,RFLXCLD      FILTER EXCLUSION?                            
         BZ    *+8                                                              
         OI    CFLTIND,FLTEXCL     TURN IT ON                                   
         TM    RFLIND,RFLWILD      FILTER WILD?                                 
         BZ    *+8                                                              
         OI    CFLTIND,FLTWILD     TURN IT ON                                   
*                                                                               
         USING DATAD,R3                                                         
CFLTR28  L     R3,FLTBASE                                                       
*                                                                               
CFLTR30  CLI   0(R3),EOT           END OF TABLE?                                
         BNE   *+6                                                              
         DC    H'00'               UPDATE TABLE?                                
         CLC   DATAFLTY,RFLTYPE    DO TYPES MATCH?                              
         BNE   CFLTR32                                                          
         TM    DATAIND1,DATASKP    SKIP THIS ONE                                
         BO    CFLTR80                                                          
         TM    DATAIND1,DATACOL    COLUMN FILTER TYPE?                          
         BO    CFLTR35                                                          
         DC    H'00'               NOT SUPPORTED, SO LOOK INTO IT               
*                                                                               
CFLTR32  LA    R3,DATALNQ(,R3)                                                  
         B     CFLTR30                                                          
*                                                                               
CFLTR35  SR    RE,RE                                                            
         ICM   RE,7,DATAFLD+1      GET DISPLACEMENT TO DATA                     
         BZ    CFLTR36                                                          
*&&UK*&& TM    DATAIND1,DATAADR    ALREADY AN ADDRESS?                          
*&&UK*&& BNZ   *+6                 YES                                          
         AR    RE,RA               NO, ADD IN BASE                              
CFLTR36  ST    RE,FLTDATA          SAVE LOCATION IN TABLE FOR COLUMN            
         MVC   FLTTYPE,RFLTYPE                                                  
         MVC   FLTFLAG,CFLTIND                                                  
*                                                                               
         CLI   RFLTYPE,RFLOFF      OFFICE ?                                     
         BNE   CFLTR38                                                          
         CLI   NPRAMS,1            ONLY CHECK IF ONE PARAMETER ENTERED          
         BNE   CFLTR38             MORE THAN ONE SO CONTINUE AS BEFORE          
         CLI   NEWOFF,YES                                                       
         BNE   CFLTR38             Continue as usual                            
         GOTO1 =A(OFFFLT),DMCB,(R2),FLTADDR                                     
         NI    FLTFLAG,TURNOFF-FLTEXCL   ADOFFAL builds list of valid           
*                                        offices, so turn off exclude           
         L     R7,AFLTAREA         SET R7 SET BY A(OFFFLT) ROUTINE              
         B     CFLTR75                                                          
*                                                                               
CFLTR38  CLI   RFLTYPE,RFLTTYPE    TRANSACTION TYPE ?                           
*&&US*&& BE    *+12                                                             
*&&US*&& CLI   RFLTYPE,RFLAPMT     Approver method?                             
         BNE   CFLTR45                                                          
         SR    R1,R1                                                            
         IC    R1,RFLLN            GET LENGTH OF ELEMENT DATA                   
         AHI   R1,-RFLLNQ          R1 = TRUE # OF PARAMETERS                    
         LA    RE,RFLDATA                                                       
*                                                                               
CFLTR42  MVI   0(R7),1             MARK AS LENGTH 1                             
         MVC   1(1,R7),0(RE)       SAVE OF TRANS TYPE                           
         LA    RE,1(,RE)           BUMP TO NEXT TRANS TYPE                      
         LA    R7,2(,R7)           BUMP UP IN TABLE                             
         BCT   R1,CFLTR42                                                       
         MVI   0(R7),EOT           MARK END                                     
         LA    R7,1(,R7)                                                        
         ST    R7,AFLTAREA         SAVE NEW ADDRESS                             
         B     CFLTR75             NEXT ELEMENT                                 
*                                                                               
CFLTR45  MVC   CFLTUL,DATAUL       SET DEFAULT                                  
         CLI   RFLTYPE,RFLACC      ACCOUNT COLUMN FILTER                        
         BNE   CFLTR48                                                          
         CLI   QPROG,PAYABLES                                                   
         BE    CFLTR48                                                          
         CLI   QPROG,EXPENSE                                                    
         BE    CFLTR48                                                          
         CLI   QPROG,GENERAL                                                    
         BE    CFLTR48                                                          
         MVC   CFLTUL,QUNIT        If ledger then set FLT unit/ledger           
*                                                                               
CFLTR48  GOTO1 =A(LISTBLD),DMCB,(NPRAMS,ABLOCK),(X'80',CFLTUL),C'SCAN'          
         CLI   0(R1),0                                                          
         BE    CFLTR80             Error ?                                      
*                                                                               
         L     R7,AFLTAREA         Re-load, since it may have changed           
         TM    RFLIND,RFLDENO      Denominator type                             
         BZ    *+8                                                              
         OI    0(R1),FLTDENO                                                    
         MVC   FLTADDR,0(R1)                                                    
         TM    FLTFLAG,FLTLIST     +/- List ?                                   
         BO    CFLTR75             Ignore FLTFLAG                               
*                                                                               
CFLTR55  MVC   BYTE,0(R1)                                                       
         NI    BYTE,FLTNOUL+FLTMULT+FLTDENO                                     
         MVC   FLTFLAG,CFLTIND                                                  
         OC    FLTFLAG,BYTE                                                     
*                                                                               
CFLTR75  LA    R6,FLTADRLQ(,R6)                                                 
         MVI   FLTFLAG,X'FF'       Mark end of entries                          
*                                                                               
CFLTR80  SR    R1,R1               Bump to next element                         
         IC    R1,RFLLN                                                         
         AR    R2,R1                                                            
         B     CFLTR02                                                          
*                                                                               
CFLTR85  ST    R7,AFLTAREA                                                      
         LA    R6,4(,R6)           bump past last entry                         
         ST    R6,AFLTADDR                                                      
                                                                                
ORIGN    USING COLD,R2                                                          
         USING COLD,R3                                                          
         TM    DDLNKIND,DDLNKON+DDLNKTST                                        
         BZ    CFLTR98                                                          
         SR    R0,R0                                                            
         IC    R0,FMT#COLS                                                      
         L     R3,FMTCOL           Add base of column table                     
CFLTR92  CLI   COLCLVL,1           Is it level 1                                
         BNE   *+6                                                              
         LR    R2,R3               Save level one column                        
         CLI   COLCLVL,2           Find level greater then 1                    
         BL    CFLTR94                                                          
         CLC   COLXLNK,ORIGN.COLNUM                                             
         BE    *+6                                                              
         DC    H'00'               Level 1 should be before 2 or 3              
                                                                                
         MVC   COLFCCDE,ORIGN.COLFCCDE                                          
         MVC   COLOPT,ORIGN.COLOPT                                              
         MVC   COLMTHD,ORIGN.COLMTHD                                            
         MVC   COLIND3,ORIGN.COLIND3                                            
         MVC   COLFLTS,ORIGN.COLFLTS                                            
                                                                                
CFLTR94  AHI   R3,COLLNQ           Next column                                  
         BCT   R0,CFLTR92                                                       
         DROP  ORIGN                                                            
                                                                                
CFLTR98  XIT1                                                                   
         DROP  R2,R3,R5,R6,R9                                                   
         SPACE 3                                                                
         LTORG                                                                  
         TITLE 'Adjust sort record'                                             
***********************************************************************         
*  SORT RECORD ADJUSTMENTS FOR MULTIPLE FORMATS                       *         
***********************************************************************         
         SPACE 1                                                                
         USING FMTRECD,R5                                                       
SORTADJ  NMOD1 0,**SADJ**                                                       
         L     RC,RLBASEC                                                       
         L     R5,AFORMATS                                                      
         MVC   SRTKEYLN,FMTKEYLN   DEFAULT                                      
         MVC   SRTDATLN,FMTDATLN   DEFAULT                                      
         MVC   SRTACMLN,FMTACMLN   DEFAULT                                      
         MVC   MAX#ACMS,FMT#ACMS   DEFAULT                                      
         MVC   MAX#RTES,FMT#RTES   DEFAULT                                      
         MVI   BYTE1,NO            VERIFY RANKING                               
         TM    RANKSW,RANKON                                                    
         BZ    SORTAD05            DON'T CARE                                   
         TM    FMTSW,FMTRANK                                                    
         BZ    SORTAD05                                                         
         MVI   BYTE1,YES           YES WE ARE REALLY RANKING                    
*                                                                               
SORTAD05 CLI   FORMAT#+1,1         ONLY ONE FORMAT ?                            
         BE    SORTAD15            YES, SO FINISHED                             
         LH    R1,FORMAT#                                                       
         BCTR  R1,0                                                             
*                                                                               
SORTAD10 LA    R5,FMTLNQ(,R5)                                                   
         CLC   SRTKEYLN,FMTKEYLN   SORT KEY                                     
         BNL   *+10                                                             
         MVC   SRTKEYLN,FMTKEYLN   TAKE LARGER VALUE                            
         CLC   SRTDATLN,FMTDATLN   SORT DATA   LENGTH                           
         BNL   *+10                                                             
         MVC   SRTDATLN,FMTDATLN   TAKE LARGER VALUE                            
         CLC   SRTACMLN,FMTACMLN   SORT ACCUMULATORS LENGTH                     
         BNL   *+10                                                             
         MVC   SRTACMLN,FMTACMLN   TAKE LARGER VALUE                            
         TM    FMTSW,FMTRANK       IS RANK ON ?                                 
         BZ    SORTAD12                                                         
         CLC   MAX#ACMS,FMT#ACMS                                                
         BNL   *+10                                                             
         MVC   MAX#ACMS,FMT#ACMS                                                
         CLC   MAX#RTES,FMT#RTES                                                
         BNL   *+10                                                             
         MVC   MAX#RTES,FMT#RTES                                                
         TM    RANKSW,RANKON                                                    
         BZ    SORTAD12            DON'T CARE                                   
         TM    FMTSW,FMTRANK                                                    
         BZ    SORTAD12                                                         
         MVI   BYTE1,YES           YES WE ARE REALLY RANKING                    
*                                                                               
SORTAD12 BCT   R1,SORTAD10                                                      
*                                                                               
SORTAD15 CLI   BYTE1,YES           ARE WE REALLY RANKING ?                      
         BE    *+8                     YES                                      
         NI    RANKSW,TURNOFF-RANKON   NO                                       
                                                                                
         LH    R1,SRTKEYLN                                                      
         AHI   R1,1                Add 1 for recap number                       
         STH   R1,SRTKEYXT         Start of extra data                          
*        STH   R1,SRTEDIT          Start of currency edit field                 
         AHI   R1,RECXDQ           Add length of extra data                     
         STH   R1,SRTKEYLN         Save new key length                          
         LH    RF,SRTKEYXT         Re-load                                      
         AHI   RF,RECRPT#-RECXD    See RECXD DSECT                              
         STH   RF,SRTREPNO                                                      
*                                                                               
         AH    R1,SRTDATLN                                                      
         STH   R1,SRTDATLN         POINT TO START OF ACCUMS                     
         AH    R1,SRTACMLN         ADD ACCUMULATOR LENGTH                       
         STH   R1,SRTRECLN         POINT TO END   OF ACCUMS                     
         CHI   R1,MAXSRTQ          MAX SIZE OF ONE SORT REOCRDS                 
         BNH   *+6                                                              
         DC    H'00'                                                            
*                                                                               
         LH    R0,FORMAT#          NUMBER OF FORMATS TO PROCESS                 
         L     R5,AFORMATS         INITIALIZE TO FIRST FORMAT                   
*                                                                               
         USING ROWD,R3                                                          
SORTAD20 LHI   R8,1                Start map code                               
         LHI   R9,EL_1ST           Start node code                              
         XC    FULL,FULL                                                        
         L     R3,FMTROW                                                        
         ZIC   R1,FMT#ROWS                                                      
                                                                                
SORTAD22 LH    RE,ROWDADSP         Adjust data displacment by KEY LEN           
         CLI   ROWDASZ,0                                                        
         BE    SORTA22A                                                         
         AH    RE,SRTKEYLN         Add len of sortkey to data disp.             
         STH   RE,ROWDADSP         Save new displacment                         
                                                                                
         USING KYWD,R6                                                          
         USING COLD,R4                                                          
SORTA22A CLI   ROWTYPE,ROWCOL      Row from column                              
         BNE   SORTA22B                                                         
         ICM   R4,15,ROWACOL                                                    
         TM    COLFLAGS,COLHIDE    If hidden column then                        
         BO    SORTA22V              skip this one                              
         TM    ROWXPIND,ROWRATE    Rate type keyword ?                          
         BO    SORTA22V            Treat as column                              
         DROP  R4                                                               
                                                                                
SORTA22B STC   R8,ROWMAP#                                                       
         ICM   R6,15,ROWINDEX                                                   
         BNZ   *+6                                                              
         DC    H'00'                                                            
                                                                                
         C     R6,FULL             It it the same as the previous ?             
         BE    SORTA22K            Same as last                                 
         SR    RF,RF                                                            
         ICM   RF,3,KYWLINK        Check for code vs name                       
         BZ    SORTA22G                                                         
         A     RF,KYWBASE                                                       
         C     RF,FULL             See if this matches                          
         BE    SORTA22K            Not same but treat as it is                  
                                                                                
SORTA22G AHI   R9,1                Add to node count                            
         ST    R6,FULL                                                          
                                                                                
SORTA22K STC   R9,ROWNODE#                                                      
         TM    ROWFLAGS,ROWCDE                                                  
         BZ    *+8                                                              
         AHI   R8,1                                                             
                                                                                
         TM    ROWFLAGS,ROWNME                                                  
         BZ    *+8                                                              
         AHI   R8,1                                                             
                                                                                
         TM    ROWDAIND,ROWIDXON   Is indexing for Accent on                    
         BZ    *+8                                                              
         AHI   R8,1                Add to map code count                        
                                                                                
         TM    ROWFLAGS,ROWADDR                                                 
         BO    SORTA22U                                                         
*&&US*&& TM    ROWDAIND,ROWBDR     OR BDR ADDRESS                               
         BZ    SORTA22V                                                         
SORTA22U SR    RF,RF                                                            
         ICM   RF,1,FMT#ADRL                                                    
         BNZ   *+8                                                              
         LA    RF,4                                                             
         AR    R8,RF                                                            
*                                                                               
SORTA22V LH    RE,ROWXPDSP                                                      
         TM    ROWXPIND,ROWXPADR                                                
         BZ    *+12                                                             
         AH    RE,SRTKEYLN                                                      
         STH   RE,ROWXPDSP                                                      
                                                                                
SORTAD24 AHI   R3,ROWLNQ           BUMP TO NEXT                                 
         BCT   R1,SORTAD22         LOOP TO ADJUST NEXT ROW                      
                                                                                
         USING COLD,R3                                                          
         L     R3,FMTCOL                                                        
         ZIC   R1,FMT#COLS                                                      
         MVI   BYTE,NO             SET TO NO RANK COLUMN FOUND                  
*                                                                               
SORTAD30 TM    COLIND2,COLRATE     Rate keyword case                            
         BO    SORTAD3X                                                         
         OC    COLAROW,COLAROW                                                  
         BNZ   SORTAD31                                                         
                                                                                
SORTAD3X STC   R9,COLNODE#                                                      
         STC   R8,COLMAP#                                                       
         AHI   R8,1                                                             
                                                                                
SORTAD31 CLI   COLACM,X'FF'        SPECIAL NEG DISPLACEMENT VALUE               
         BNE   SORTAD32                                                         
         LH    RE,COLDSP           THIS WILL POINT YOU INTO SORT KEY            
         SH    RE,SRTDATLN         INSTEAD OF ACCUMNLATORS                      
         STH   RE,COLACM           SAVE NEG DISPLACEMENT                        
*                                                                               
SORTAD32 TM    COLFLAGS,COLAMT     IS IT ACCUMULATED COLUMN?                    
         BZ    SORTAD35                                                         
         LH    RE,COLDSP                                                        
         AH    RE,SRTDATLN                                                      
         STH   RE,COLDSP           TURE DISPLACEMENT FROM START OF REC          
*                                                                               
SORTAD35 CLC   COLNUM,FMTRNK#3     DO WE RANK ON COL                            
         BNE   SORTAD38            ONLY ONE FOR NOW                             
         MVI   BYTE,YES            RANK COLUMN FOUND                            
         SR    RF,RF                                                            
         ICM   RF,3,COLDSP                                                      
         STH   RF,FMTRNKCL         DISP INTO SORTACCM                           
         TM    COLIND2,COLRATE                                                  
         BO    SORTAD38                                                         
         SH    RF,SRTDATLN         WE WANT KEY LEN + ACCM DISP                  
         AH    RF,SRTKEYLN         SO REMOVE DATA LEN                           
         STH   RF,FMTRNKCL         DISP INTO SORTACCM                           
         TM    COLFLAGS,COLAMT                                                  
         BO    *+8                                                              
         MVI   ERROR#,14                                                        
*                                                                               
SORTAD38 AHI   R3,COLLNQ           BUMP UP IN COLUMN                            
         BCT   R1,SORTAD30         LOOP TO PROCESS NEXT COLUMN                  
*                                                                               
         USING HEADD,R3                                                         
         USING KYWD,R6                                                          
         L     R3,FMTHEAD                                                       
         SR    R1,R1                                                            
         ICM   R1,1,FMT#HEAD       CURRENT HEAD COUNT                           
         BZ    SORTAD48                                                         
SORTAD40 TM    HEADFLAG,HEADADR    ADDRESS                                      
         BO    SORTAD42            ADJUSTMENT NEEDED                            
         TM    HEADFLAG,HEADROW                                                 
         BO    SORTAD45            NO ADJUSTMENT NEEDED                         
         TM    HEADFLAG,HEADDEF                                                 
         BZ    SORTAD45            NO ADJUSTMENT NEEDED                         
*                                                                               
SORTAD42 ICM   R6,15,HEADINDX                                                   
         BZ    SORTAD45                                                         
         OC    KYWPRSE,KYWPRSE                                                  
         BZ    SORTAD45                                                         
         LH    RE,HEADDISP                                                      
         AH    RE,SRTKEYLN                                                      
         STH   RE,HEADDISP                                                      
*                                                                               
SORTAD45 AHI   R3,HEADLNQ                                                       
         BCT   R1,SORTAD40                                                      
         DROP  R3,R6                                                            
*                                                                               
SORTAD48 CLI   FMTRNK#3,0          ARE WE RANKING ?                             
         BE    SORTAD50            NO                                           
         CLI   BYTE,YES            DID WE FIND A RANK COLUMN ?                  
         BE    SORTAD50            YES                                          
         MVI   ERROR#,14                                                        
*                                                                               
SORTAD50 L     RE,ABIGWRK                                                       
         MVC   0(8,RE),=CL8'**RECx**'   PUT A LABEL                             
         MVC   5(1,RE),FMTNUM                                                   
         OI    5(RE),X'F0'         MAKE PRINTABLE NUMBER                        
         LA    RE,8(,RE)                                                        
         ST    RE,FMTSRTWK         FORMATS SORT RECORD WORK AREA                
         A     RE,=A(MAXSRBQ-8)    MAX SIZE OF AREA                             
         ST    RE,ABIGWRK                                                       
*                                                                               
         L     RE,ADELPOOL                                                      
         ST    RE,FMTDELEL                                                      
         AHI   RE,20               5 items per format                           
         ST    RE,ADELPOOL                                                      
*                                                                               
         BRAS  RE,REORGCOL                                                      
         TM    DDLNKIND,DDLNKON                                                 
         BZ    SORTAD60                                                         
         BRAS  RE,RESOLVE          Convert cols to nodes in equations           
         BRAS  RE,SPCLKYW          Special constatns for PC accent              
         BRAS  RE,GRPSKYW          Accent - keyword grouping                    
                                                                                
SORTAD60 AHI   R5,FMTLNQ           NEXT FORMAT                                  
         BCT   R0,SORTAD20         LOOP FOR NEXT FORMAT                         
*                                                                               
         LH    R1,SRTRECLN         LENGTH OF SORTREC                            
         L     RF,=A(MAXSRBQ-8)                                                 
         SR    RE,RE                                                            
         DR    RE,R1                                                            
         STH   RF,MAX#TRNS                                                      
*                                                                               
*        TM    FCIND,FCISORT                                                    
*        BO    *+10                                                             
*        XC    SRTEDIT,SRTEDIT     ALL COLUMNS ARE PRE-DEFINED                  
*                                                                               
SORTAD90 CLI   ERROR#,0                                                         
         XIT1                                                                   
         DROP  R5                                                               
         EJECT ,                                                                
***********************************************************************         
* Resolve columns into nodes, string format for equations in ACCENT             
***********************************************************************         
         USING COLD,R3                                                          
         USING FMTRECD,R5                                                       
RESOLVE  NTR1                                                                   
         L     R3,FMTCOL                                                        
         ZIC   R0,FMT#COLS                                                      
                                                                                
RSLV002  ST    R3,SVR3                                                          
         TM    COLFLAGS,COLAMT                                                  
         BZ    RSLV300                                                          
         TM    COLFLAGS,COLCALC    Column calculation                           
         BZ    RSLV300                                                          
         ICM   R2,15,COLEQUTN      Get equation                                 
         BZ    RSLV300                                                          
                                                                                
         ST    R2,SVR2                                                          
         MVC   WORK,SPACES                                                      
         MVI   WORK,C'='           indicates it is an equation                  
         LA    R4,WORK+1                                                        
         LA    R7,MAXEQLN                                                       
RSLV010  CLI   0(R2),C' '                                                       
         JNH   RSLV200                                                          
         CLI   0(R2),C'C'          column                                       
         JNE   RSLV100                                                          
         MVI   0(R4),C'A'          Change C to A for amount                     
         AHI   R4,1                                                             
         AHI   R2,1                                                             
         LA    R1,MAXMAPSZ         Find number between 1 to 999                 
         LR    R6,R2                                                            
RSLV030  CLI   0(R6),C'0'                                                       
         JL    RSLV032             No more numbers                              
         AHI   R6,1                Next position in number                      
         BRCT  R1,RSLV030                                                       
                                                                                
RSLV032  SHI   R1,MAXMAPSZ                                                      
         JNZ   *+6                                                              
         DC    H'00'                                                            
                                                                                
         LPR   R1,R1               Absolute val, R1 = length of #               
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         J     *+10                                                             
         PACK  DUB,0(0,R2)                                                      
         CVB   R8,DUB              Column nunber as binary                      
         AHI   R1,1                Restore ture length                          
         AR    R2,R1               point beyound #                              
                                                                                
         L     R3,FMTCOL                                                        
         ZIC   RF,FMT#COLS                                                      
RSLV050  CLM   R8,1,COLNUM         Match on column number                       
         JE    RSLV070                                                          
         AHI   R3,COLLNQ                                                        
         BRCT  RF,RSLV050                                                       
         DC    H'00'                                                            
                                                                                
RSLV070  ZIC   R1,COLMAP#          Convert column # to column map #             
         CVD   R1,DUB                                                           
         OI    DUB+L'DUB-1,X'0F'                                                
         UNPK  0(MAXMAPSZ,R4),DUB                                               
                                                                                
         LA    R1,MAXMAPSZ         Find length of significat data               
RSLV072  CLI   0(R4),C'0'                                                       
         JH    RSLV074                                                          
         MVC   0(MAXMAPSZ,R4),1(R4)                                             
         BRCT  R1,RSLV072                                                       
         DC    H'00'               All zeros, no good                           
                                                                                
RSLV074  AR    R4,R1                                                            
         SR    R7,R1                                                            
         JP    RSLV010                                                          
         J     RSLV200             Ran out of room                              
                                                                                
RSLV100  MVC   0(1,R4),0(R2)                                                    
         AHI   R2,1                                                             
         AHI   R4,1                                                             
         BRCT  R7,RSLV010                                                       
                                                                                
RSLV200  LA    RE,WORK                                                          
         SR    R4,RE               Figure out length of data                    
         CHI   R4,MAXEQLN                                                       
         JNH   *+6                                                              
         DC    H'00'                                                            
                                                                                
         L     R2,SVR2             Location to store result                     
         STC   R4,0(,R2)                                                        
         BCTR  R4,0                                                             
         EXMVC R4,1(R2),WORK       Move in value                                
                                                                                
RSLV300  L     R3,SVR3                                                          
         AHI   R3,COLLNQ                                                        
         BCT   R0,RSLV002                                                       
         XIT1                                                                   
         DROP  R3,R5                                                            
         EJECT ,                                                                
***********************************************************************         
* List of special keywords that are grouped together                            
***********************************************************************         
         USING ROWD,R2                                                          
         USING FMTRECD,R5                                                       
         USING GRPKYWD,R4                                                       
GRPSKYW  NTR1                                                                   
         L     R2,FMTROW           A(Rows)                                      
         LA    R1,GRP#NONE         Non-groups                                   
         SR    R0,R0                                                            
         ICM   R0,1,FMT#ROWS       # of rows                                    
         BZ    GRPSKXIT                                                         
         L     R4,=A(GRPTAB)                                                    
         ST    R4,AGRPTAB                                                       
         L     R4,=A(GRPNAMES)                                                  
         ST    R4,AGRPNMES                                                      
                                                                                
GRPSK100 L     R4,AGRPTAB                                                       
         LA    R6,1                Index into table                             
GRPSK120 CLI   0(R4),0             End of table (Not EOT though)                
         BE    GRPSK140            Found so set                                 
         CLI   ROWTYPE,ROWCOL                                                   
         JE    GRPSK300                                                         
         OC    ROWDD#,ROWDD#                                                    
         BZ    GRPSK140                                                         
         CLC   ROWDD#,GRPKYDD#                                                  
         BE    GRPSK200                                                         
         AHI   R6,1                                                             
         AHI   R4,GRPKYLNQ         Next entry                                   
         J     GRPSK120                                                         
                                                                                
GRPSK140 STC   R1,ROWGPIDX         Set to special                               
         AHI   R1,1                Up the number                                
         J     GRPSK300                                                         
                                                                                
         USING GRPNMED,RE                                                       
GRPSK200 STC   R6,ROWGPIDX         Save off index number                        
         SR    RF,RF                                                            
         IC    RF,GRPKYW#                                                       
         BCTR  RF,0                                                             
         MHI   RF,GRPNMLNQ                                                      
         L     RE,AGRPNMES                                                      
         AR    RE,RF                                                            
         MVI   GRPNMEON,YES                                                     
         DROP  RE                                                               
                                                                                
GRPSK300 AHI   R2,ROWLNQ                                                        
         BRCT  R0,GRPSK100                                                      
                                                                                
GRPSKXIT J     EXIT                                                             
         DROP  R2,R4,R5                                                         
***********************************************************************         
* List of special keywords that are constants                                   
* Special calculations are carried out in PC accent based on values set         
***********************************************************************         
         USING ROWD,R2                                                          
         USING COLD,R3                                                          
         USING FMTRECD,R5                                                       
SPCLKYW  NTR1                                                                   
         L     R3,FMTCOL           A(Columns)                                   
         SR    R0,R0                                                            
         IC    R0,FMT#COLS         # of columns                                 
SPKY010  TM    COLFLAGS,COLAMT                                                  
         BZ    SPKY400                                                          
                                                                                
         L     R4,=A(SPCLKYWS)                                                  
SPKY020  OC    0(2,R4),0(R4)       No more entries                              
         JZ    SPKY400             Try next keyword                             
         CLC   COLDD#,0(R4)        Match on special keyword                     
         JE    SPKY050             Yes                                          
         AHI   R4,4                No                                           
         J     SPKY020             Try next                                     
                                                                                
SPKY050  OI    COLIND4,COLCONST    Mark as constant                             
         MVC   WORK,SPACES         Initialize                                   
         MVC   WORK(3),=C'AC1'                                                  
         LA    R8,WORK+3                                                        
                                                                                
         SR    R6,R6                                                            
         ICM   R6,3,2(R4)          Displacement into KEY of keywords            
         A     R6,=A(KYWKEYS)                                                   
         SR    RF,RF                                                            
         IC    RF,0(,R6)           # of keyword to scan for                     
         LA    RE,2(,R6)           Start of keywords                            
SPKY100  L     R2,FMTROW                                                        
         SR    R1,R1                                                            
         ICM   R1,1,FMT#ROWS                                                    
         BNZ   *+6                                                              
         DC    H'00'                                                            
                                                                                
SPKY110  CLC   ROWDD#,0(RE)        Match on keyword                             
         BNE   SPKY200                                                          
         SR    R6,R6                                                            
         IC    R6,ROWMAP#                                                       
         CVD   R6,DUB                                                           
         OI    DUB+L'DUB-1,X'0F'                                                
         UNPK  0(MAXMAPSZ,R8),DUB  R8 = Build string in WORK                    
                                                                                
         LA    R7,MAXMAPSZ                                                      
SPKY114  CLI   0(R8),C'0'                                                       
         JNE   SPKY116                                                          
         MVC   0(MAXMAPSZ,R8),1(R8)     Eliminate zero                          
         BRCT  R7,SPKY114                                                       
         DC    H'00'                                                            
                                                                                
SPKY116  AR    R8,R7                                                            
         MVI   0(R8),C','                                                       
         AHI   R8,1                                                             
                                                                                
SPKY200  AHI   R2,ROWLNQ           See if next row fit criteria                 
         BRCT  R1,SPKY110                                                       
                                                                                
SPKY300  AHI   RE,2                                                             
         BRCT  RF,SPKY100          Find another key row                         
                                                                                
         LA    R1,WORK                                                          
         SHI   R8,1                Less one for last comma                      
         SR    R8,R1                                                            
         BP    *+6                                                              
         DC    H'00'                                                            
                                                                                
         L     RE,AEQUTION                                                      
         CHI   R8,MAXEQLN                                                       
         BNH   *+6                                                              
         DC    H'00'                                                            
                                                                                
         ST    RE,COLEQUTN                                                      
         STC   R8,0(,RE)                                                        
         BCTR  R8,0                                                             
         EXMVC R8,1(RE),WORK                                                    
         AHI   RE,MAXEQLN                                                       
         ST    RE,AEQUTION                                                      
                                                                                
SPKY400  AHI   R3,COLLNQ           Find another constant column                 
         BRCT  R0,SPKY010                                                       
                                                                                
EXIT     XIT1                                                                   
         DROP  R2,R3,R5                                                         
         EJECT ,                                                                
MAXMAPSZ EQU   3                                                                
         LTORG                                                                  
         TITLE 'Initialize RECAP data'                                          
***********************************************************************         
*  FIGURE OUT RECAP NUMBER FOR EACH FORMAT AND STORE IN ROWRECAP      *         
***********************************************************************         
         SPACE 1                                                                
FMT1     USING ROWD,R2                                                          
FMT2     USING ROWD,R3                                                          
RPT1     USING FMTRECD,R5                                                       
RPT2     USING FMTRECD,R6                                                       
*                                                                               
RECAP    NMOD1 0,**RCAP**                                                       
         L     RC,RLBASEC                                                       
         LH    R0,FORMAT#          Number of formats to scan                    
         SHI   R0,1                                                             
         BZ    RECAP90             Only one format, can't recap                 
***********************************************************************         
*                                                                               
***********************************************************************         
         L     R5,AFORMATS                                                      
         LR    R6,R5                                                            
RECAP10  MVI   HASROWS,NO          Has rows other than columns ?                
         SR    R1,R1               Start with row 2 (2 less one)                
         IC    R1,RPT1.FMT#ROWS    Report 1 # of rows                           
         L     R2,RPT1.FMTROW      Report 1 rows (row 1, format n)              
         AHI   R6,FMTLNQ           Format 2                                     
         SHI   R1,1                                                             
         BZ    RECAP30             Ran out of rows on this format               
         AHI   R2,ROWLNQ           Skip first row                               
         CLI   FMT1.ROWTYPE,ROWCOL Any real rows ?                              
         BE    *+8                 No, treat rowcols as rows                    
         MVI   HASROWS,YES                                                      
*                                                                               
RECAP15  CLI   FMT1.ROWRECAP,0                                                  
         BNE   *+10                                                             
         MVC   FMT1.ROWRECAP,RPT1.FMTNUM   Initialize                           
                                                                                
         SR    R3,R3                                                            
         IC    R3,FMT1.ROWNUM              Report 1, current row number         
         CLC   FMT1.ROWNUM,RPT2.FMT#ROWS   Too few rows in 2nd report           
         BH    RECAP25                                                          
         BCTR  R3,0                                                             
         MHI   R3,ROWLNQ                                                        
         A     R3,RPT2.FMTROW                Report 2 rows                      
                                                                                
         CLC   FMT1.ROWINDEX,FMT2.ROWINDEX   Compare keyword index              
         BNE   RECAP25                       Different, stop recap here         
         MVC   FMT2.ROWRECAP,FMT1.ROWRECAP                                      
*        CLI   FMT2.ROWKYSZ,2                Is this in sort key ?              
*        BL    RECAP18                       No, no impact on key               
         CLI   HASROWS,YES                                                      
         BNE   RECAP18                       Treat ROWCOL as row                
         CLI   FMT2.ROWTYPE,ROWCOL           Detail row column ?                
         BE    RECAP20                       Yes                                
         CLI   FMT1.ROWTYPE,ROWCOL           Detail row column ?                
         BE    RECAP20                       Yes                                
RECAP18  AHI   R2,ROWLNQ                     Next row                           
         BCT   R1,RECAP15                                                       
***********************************************************************         
*                                                                               
***********************************************************************         
         TM    RPT2.FMTRCAP,FMTFPAGE         FORCE NEW PAGE ?                   
         BO    RECAP30                       YES, THIS WILL FORCE PAGE          
         CLC   RPT2.FMT#ROWS,FMT2.ROWNUM     FMT1 & FMT2 SAME # ROWS            
         BE    RECAP38                       FINISHED HERE BUMP TO NEXT         
         AHI   R3,ROWLNQ                     RPT2 HAS MORE ROWS THAN 1          
         OI    RPT1.FMTRCAP,FMTRWALL                                            
         CLI   FMT2.ROWTYPE,ROWCOL                                              
         BNE   RECAP30                                                          
         B     RECAP35                                                          
*                                                                               
RECAP20  TM    RPT2.FMTRCAP,FMTFPAGE    Force new page ?                        
         BO    RECAP28                  Yes, by bumping back one row            
         B     RECAP30                  No                                      
*                                                                               
RECAP25  CLI   FMT2.ROWTYPE,ROWCOL      Detail row column ?                     
         BE    RECAP26                                                          
         NI    PIXOPT1,TURNOFF-PIXGO    Turn off print queue indexing           
         CLI   FMT1.ROWTYPE,ROWCOL      Detail row column ?                     
         BNE   RECAP30                                                          
*                                                                               
RECAP26  TM    RPT2.FMTRCAP,FMTFPAGE    Force new page ?                        
         BZ    RECAP30                  No                                      
*                                                                               
RECAP28  SHI   R2,ROWLNQ           Bump back one row in report 1                
*                                                                               
RECAP30  SR    R3,R3                                                            
         IC    R3,FMT1.ROWNUM      Use report 1 row # to point into             
         BCTR  R3,0                                                             
         MHI   R3,ROWLNQ           Report 2 equivalent row                      
         A     R3,RPT2.FMTROW                                                   
*                                                                               
RECAP35  MVC   FMT2.ROWRECAP,RPT2.FMTNUM  RESET RECAP NUMBER                    
*                                                                               
RECAP38  LR    R5,R6               START AGAIN WITH NEXT REPORT                 
         BCT   R0,RECAP10                                                       
***********************************************************************         
*                                                                               
***********************************************************************         
         LH    R0,FORMAT#          NUMBER OF FORMATS TO SCAN                    
         L     R5,AFORMATS                                                      
RECAP40  TM    RPT1.FMTRCAP,FMTRSEP       FORCE SEPERATE REPORTS                
         BZ    RECAP45                                                          
         L     R2,RPT1.FMTROW             POINT TO ROWS                         
         SR    R1,R1                                                            
         IC    R1,RPT1.FMT#ROWS                                                 
*                                                                               
RECAP42  MVC   FMT1.ROWRECAP,RPT1.FMTNUM  RESET TO ORIGINAL FORMAT              
         AHI   R2,ROWLNQ                                                        
         BCT   R1,RECAP42                                                       
*                                                                               
RECAP45  AHI   R5,FMTLNQ                  LOOK AT NEXT FORMAT                   
         BCT   R0,RECAP40                                                       
*                                                                               
         LH    R0,FORMAT#             NUMBER OF FORMATS TO SCAN                 
         SHI   R0,1                                                             
         L     R5,AFORMATS                                                      
         MVC   TMPPGDEF,RPT1.FMTPGDEF INITIALIZE                                
         AHI   R5,FMTLNQ              SKIP FIRST FORMAT                         
*                                                                               
RECAP46  TM    RPT1.FMTRCAP,FMTRSEP   REPORT SEPERATELY ?                       
         BO    RECAP55                YES, SO OK AS IS, DON'T BOTHER            
         L     R2,RPT1.FMTROW         REPORT  1  ROWS (ROW 1)                   
         SR    R1,R1                                                            
         IC    R1,RPT1.FMT#ROWS    NUMBER OF ROWS TO SCAN                       
         SHI   R1,1                SKIP FIRST ROW                               
         BZ    RECAP55                                                          
*                                                                               
RECAP47  AHI   R2,ROWLNQ                                                        
         CLC   FMT1.ROWNUM,FMT1.ROWRECAP                                        
         BE    *+8                                                              
         BCT   R1,RECAP47                                                       
*                                                                               
         CLI   FMT1.ROWTYPE,ROWMID     IS THIS ROW A MID-LINE ?                 
         BE    *+8                                                              
         CLI   FMT1.ROWTYPE,ROWCOL     IS THIS ROW A DETAIL LINE ?              
         BNE   RECAP55                 MUST BE A HEAD LINE, SO OK               
         OI    RPT1.FMTRCAP,FMTMRGPG   MERGE REPCAP TO LAST REPORT              
*        CLI   QOPT5,C'Y'                                                       
*        BE    *+8                                                              
*        MVI   RPT1.FMTMRGE#,1                                                  
*                                                                               
         L     R3,RPT1.FMTROW      POINT 1ST ROW, CURRENT FORMAT                
         AHI   R3,ROWLNQ           TRY 2ND ROW NOW                              
         SR    R6,R6                                                            
         IC    R6,FMT2.ROWRECAP    GET MAIN RECAP REPORT #                      
         BCTR  R6,0                                                             
         MHI   R6,FMTLNQ                                                        
         A     R6,AFORMATS             POINT RPT2 TO TOP OF GROUP               
         OI    RPT2.FMTRCAP,FMTMRGPG   MERGE REPCAP TO LAST REPORT              
         MVC   RPT2.FMTTOP,FMT2.ROWRECAP                                        
         MVC   RPT1.FMTTOP,FMT2.ROWRECAP     SET TOP REPORT #                   
         CLC   RPT1.FMTTOP,RPT1.FMTNUM                                          
         BNE   *+8                                                              
         MVI   RPT1.FMTTOP,0                                                    
         CLC   RPT2.FMTTOP,RPT2.FMTNUM                                          
         BNE   *+8                                                              
         MVI   RPT2.FMTTOP,0                                                    
*                                                                               
         CLC   RPT1.FMTPGDEF,TMPPGDEF                                           
         BE    RECAP55                 OK AS IS, SO FAR                         
         CLI   TMPPGDEF,2          WAS IT THE FORMAT PRIOR ?                    
         BNE   RECAP50             NO, SO CHANGE ALL PRIORS                     
         MVI   RPT1.FMTPGEWD+3,PGWDRL18   SAVE NEW PAGE WIDTH                   
         MVI   RPT1.FMTFONT,0      SET TO LARGEST OF THE GROUP                  
         MVI   RPT1.FMTPGDEF,2     SET TO CONFORM TO > PITCH                    
         MVI   RPT1.FMTMLINE,LPI12LS   SET LANDSCAPE (# LINES ON PAGE)          
         CLI   QPROG+1,LANDSCPE                                                 
         BE    RECAP48                                                          
         MVI   RPT1.FMTMLINE,LPI12PT      SET PROTRAIT                          
         MVI   RPT1.FMTPGEWD+3,PGWDRP18   SAVE NEW PAGE WIDTH                   
*                                                                               
RECAP48  TM    RPT1.FMTPOPT2,RPFSTRPE+RPFOSHDE+RPFISHDE                         
         BZ    RECAP60                                                          
         MVI   RPT1.FMTFONT,1      GOTO PITCH 20, SUPPORTS SHADE/STRIPE         
         B     RECAP60             FINISHED                                     
*                                                                               
RECAP50  CLC   RPT2.FMTNUM,RPT1.FMTNUM        DO UNTIL THE SAME                 
         BE    RECAP55             FINISHED                                     
         CLI   RPT2.FMTPGDEF,2     ALL MERGED REPORTS NEED TO BE SAME           
         BE    RECAP54             OK AS IS                                     
         MVI   RPT2.FMTPGEWD+3,PGWDRL18   SAVE NEW PAGE WIDTH                   
         MVI   RPT2.FMTFONT,0      SET TO LARGEST OF THE GROUP                  
         MVI   RPT2.FMTPGDEF,2     SET TO CONFORM TO > PITCH                    
         MVI   RPT2.FMTMLINE,LPI12LS   SET LANDSCAPE (# LINES ON PAGE)          
         CLI   QPROG+1,LANDSCPE                                                 
         BE    RECAP52                                                          
         MVI   RPT2.FMTMLINE,LPI12PT      SET PROTRAIT                          
         MVI   RPT2.FMTPGEWD+3,PGWDRP18   SAVE NEW PAGE WIDTH                   
*                                                                               
RECAP52  TM    RPT2.FMTPOPT2,RPFSTRPE+RPFOSHDE+RPFISHDE                         
         BZ    RECAP54                                                          
         MVI   RPT2.FMTFONT,1      GOTO PITCH 20, SUPPORTS SHADE/STRIPE         
*                                                                               
RECAP54  AHI   R6,FMTLNQ           BUMP UP RPT2                                 
         B     RECAP50             TRY NEXT                                     
*                                                                               
RECAP55  MVC   TMPPGDEF,RPT1.FMTPGDEF                                           
*                                                                               
RECAP60  AHI   R5,FMTLNQ                                                        
         BCT   R0,RECAP46                                                       
*                                                                               
RECAP90  XIT1                                                                   
         DROP  FMT1,FMT2                                                        
         DROP  RPT1,RPT2                                                        
*                                                                               
TMPPGDEF DS    XL1                                                              
HASROWS  DS    CL1                 Has rows other than 1st and ROWCOL           
         SPACE 3                                                                
         LTORG                                                                  
         TITLE 'RE-ORGINIZE COLUMNS'                                            
***********************************************************************         
*        REORGINIZE COLUMNS TO OPTIMIZE RESULTS IN CALCULATIONS       *         
***********************************************************************         
         SPACE 1                                                                
         USING ROWD,R2                                                          
         USING COLD,R3                                                          
NEXT     USING COLD,R4                                                          
         USING FMTRECD,R5                                                       
REORGCOL NMOD1 0,**RORG**                                                       
         L     RC,RLBASEC                                                       
         L     R3,FMTCOL           POINT TO STARTING ADDR. OF COLS              
         SR    R0,R0               NUMBER OF COLUMNS TO ORGINIZE                
         IC    R0,FMT#COLS                                                      
         LR    R4,R0                                                            
         BCTR  R4,0                                                             
         MHI   R4,COLLNQ           POINT TO LAST COLUMN                         
         A     R4,FMTCOL           ADD BASE OF COLUMN TABLE                     
         MVI   MAXSWAP,0                                                        
         XC    SVR0,SVR0           SET TO ZERO COLUMN CALCULATIONS              
***********************************************************************         
* MOVE ALL COLUMN CALCULATIONS TO END OF THE PACK                     *         
***********************************************************************         
         SPACE 1                                                                
REORG010 TM    COLFLAGS,COLCALC    IS IT CALCULATED COLUMN?                     
         BZ    REORG012            NO SO CHECK NEXT COLUMN                      
         TM    NEXT.COLFLAGS,COLCALC                                            
         BO    *+8                 DON'T SWAP WITH ANOTHER COL CALC             
         BAS   RE,ORGCOLSW         SWAP COLUMNS USING R3,R4                     
         SHI   R4,COLLNQ           BUMP BACK R4 BY ONE COLUMN                   
         B     REORG015            MIGHT HAVE SWAP A CALC FOR A CALC            
*                                                                               
REORG012 LA    R3,COLLNQ(,R3)      BUMP UP R3 TO NEXT COLUMN                    
         SHI   R0,1                COUNT DOWN # OF COLUMNS                      
         BNP   REORG100            NO CALCULATED COLUMNS                        
*                                                                               
REORG015 CR    R3,R4               HAVE WE MEET IN MIDDLE?                      
         BL    REORG010            NO, SO LOOP                                  
                                                                                
         TM    COLFLAGS,COLCALC                                                 
         BNO   REORG012            LOOP, LAST ONE NOT A COL CALC                
         ST    R3,SVR3             FIRST  COLUMN CALCULATION                    
         ST    R0,SVR0             NUMBER OF CALCULATION COLUMNS                
***********************************************************************         
*  FIGURE OUT WHICH COLUMN CALCULATIONS MUST BE DONE FIRST            *         
***********************************************************************         
         SPACE 1                                                                
         USING EQD,R6                                                           
REORG020 ICM   R6,15,COLXTRA       POINT TO POSTIFIX STACK EQUATION             
         BZ    REORG030            NOT   A TRUE COLUMN CALC.                    
*                                                                               
REORG021 CLI   EQTYPE,EQEND        At end of equation ?                         
         BE    REORG030            Yes, get next calculation column             
         CLI   EQTYPE,EQDATE       Date equation ?                              
         BE    REORG030            Yes, get next calculation column             
         CLI   EQTYPE,EQCOL        Column number ?                              
         BE    REORG022            Yes                                          
         CLI   EQTYPE,EQVERT       Vertical % column ?                          
         BNE   REORG026            No                                           
         OI    COLOPT2,COLVPCT                                                  
         OI    SORTSW,SORTVPCT     TURN ON TO POST VERTICAL%                    
         OI    FMTSW,FMTVPCT                                                    
*                                                                               
REORG022 LA    R4,COLLNQ(,R3)      POINT TO NEXT COLUMN                         
         LR    R2,R0               NUMBER OF COLUMNS TO CHECK                   
*                                                                               
REORG023 CHI   R2,1                                                             
         BNH   REORG026            ONLY ONE COLUMN CALC LEFT                    
         CLC   NEXT.COLNUM,EQCOL#  MATCH ON COLUMN NUMBER                       
         BNE   REORG024                                                         
         BRAS  RE,ORGCOLSW         SWAP COLUMNS WITH R3,R4                      
         B     REORG020            START AGAIN ON THE SWAPED COLUMN             
*                                                                               
REORG024 LA    R4,COLLNQ(,R4)      BUMP TO NEXT COLUMN                          
         BCT   R2,REORG023                                                      
*                                                                               
REORG026 LA    R6,EQLNQ(,R6)       BUMP UP IN POSTFIX STACK                     
         B     REORG021                                                         
*                                                                               
REORG030 LA    R3,COLLNQ(,R3)      BUMP TO NEXT COLUMN                          
         SHI   R0,1                LESS ONE COLUMN TO CHECK                     
         BP    REORG020            START CHECKING NEXT COLUMN                   
         B     REORG100            Finished phase one                           
         EJECT ,                                                                
***********************************************************************         
*  REPLACE COLUMN NUMBERS WITH DISP. TO ACCUMS IN SORT REC.           *         
***********************************************************************         
         SPACE 1                                                                
REORG100 L     R3,FMTCOL           Start of columns                             
         SR    R0,R0                                                            
         IC    R0,FMT#COLS                                                      
*                                                                               
REORG102 ICM   R2,15,COLAROW       Is a row attached ?                          
         BZ    REORG104            No                                           
         ST    R3,ROWACOL          Point back to column                         
*                                                                               
REORG104 TM    COLFLAGS,COLCALC    Column calculation ?                         
         BZ    REORG180            No                                           
         ICM   R6,15,COLXTRA       Point to POSTFIX equation stack              
         BZ    REORG180            None                                         
*                                                                               
REORG106 CLI   EQTYPE,EQEND        End of stack ?                               
         BE    REORG180            Yes, check next column then.                 
         CLI   EQTYPE,EQCOL        Column number ?                              
         BE    REORG130            Yes, so substitute displacement              
         CLI   EQTYPE,EQSUM        CUME() column # ?                            
         BE    REORG130            Yes, so substitute displacement              
         CLI   EQTYPE,EQROW        Row number ?                                 
         BE    REORG110            Yes, so skip                                 
         CLI   EQTYPE,EQFRGN       Column number foriegn currency ?             
         BE    REORG130            Yes, so substitute displacement              
         CLI   EQTYPE,EQDATE       Date equation ?                              
         BE    REORG140            Yes, so substitute displacement              
         CLI   EQTYPE,EQVERT       Vertical % column number ?                   
         BE    REORG108                                                         
         CLI   EQTYPE,EQOPTR       Operator                                     
         BNE   REORG110                                                         
         CLI   EQSIGN,EQPCT        Percent column ?                             
         BNE   REORG110                                                         
*                                                                               
REORG108 OI    COLEDOPT,COLPCT     Turn on to print "%"                         
         CLI   EQTYPE,EQVERT       Vertical % column number ?                   
         BE    REORG112                                                         
         OI    COLOPT,COLFCALC     Force EVAL on total line                     
*                                                                               
REORG110 AHI   R6,EQLNQ            Bump up in stack                             
         B     REORG106            Check next item in stack                     
*                                                                               
REORG112 IC    R2,EQROWLVL         Get level of row or column                   
         CLI   EQDEC#,EQROW        Is it row or column LEVEL?                   
         BE    REORG122            Row                                          
         ZIC   R1,FMT#COLS                                                      
         L     R4,FMTCOL           It is a column                               
*                                                                               
REORG114 CLC   NEXT.COLNUM,EQROWLVL   FIND COLUMN IT REFERS TO                  
         BE    REORG116               FOUND                                     
         AHI   R4,COLLNQ              TRY AGAIN                                 
         BCT   R1,REORG114                                                      
         DC    H'00'               HAS TO BE THERE SOMEWHERE                    
*                                                                               
REORG116 L     R2,NEXT.COLAROW     LOAD ASSOCIATED ROW                          
         IC    R1,ROWNUM                                                        
         SHI   R1,1                1 FOR HIDDEN 1ST ROW                         
         BNM   *+6                                                              
         DC    H'0'                NEGATIVE ROW IS A NO NO.                     
         STC   R1,EQROWLVL         FIX VERTICAL % LEVEL                         
         B     REORG126                                                         
*                                                                               
REORG122 MHI   R2,ROWLNQ                                                        
         A     R2,FMTROW           Add base of row table                        
*                                                                               
REORG126 MVC   COLTOTLV,ROWNUM     Level of to print totals to                  
         OI    ROWKYIND,ROWKYVRT                                                
*                                                                               
         OC    ROWVPACM,ROWVPACM                                                
         BNZ   REORG130            Already have set up                          
         SR    R1,R1                                                            
         ICM   R1,3,ROWKYSZ        Row key size                                 
         AHI   R1,RECXDQ                                                        
         AH    R1,ROWKYDSP         Row displacement                             
         CH    R1,BFLKEYLN         Buffalo key length                           
         BNH   *+8                 Take the greater one                         
         STH   R1,BFLKEYLN         New length                                   
         L     RE,PTRACM           Free space for accumulators                  
         ST    RE,ROWVPACM         Save for vertical %                          
         SR    R1,R1                                                            
         IC    R1,FMT#ACMS         Number of accumulated columns                
         ZAP   0(PKLEN,RE),PKZERO  Zero it out                                  
         AHI   RE,PKLEN                                                         
         BCT   R1,*-10                                                          
         ST    RE,PTRACM           Save new address                             
*                                                                               
REORG130 ZIC   R1,FMT#COLS         Number of columns to look through            
         L     R4,FMTCOL           Begining of column table                     
*                                                                               
REORG136 CLC   NEXT.COLNUM,EQCOL#  Match column numbers                         
         BE    REORG150            Found                                        
         AHI   R4,COLLNQ           Try next column                              
         BCT   R1,REORG136         again                                        
         MVI   ERROR#,4                                                         
         B     REORG900            No match, must be error                      
*                                                                               
REORG140 ZIC   R1,FMT#ROWS         Number of rows to look through               
         L     R2,FMTROW           Begining of row table                        
*                                                                               
REORG142 TM    EQIND,EQDONE        Done already                                 
         BO    REORG144                                                         
         L     RF,ROWINDEX                                                      
         S     RF,KYWBASE                                                       
         CH    RF,EQDSP            Match displacement into keyword tab          
         BNE   REORG144                                                         
         MVI   EQIND,EQDONE        Mark done                                    
         MVC   EQDSP,ROWKYDSP                                                   
*                                                                               
REORG144 AHI   R6,EQLNQ                                                         
         TM    EQIND,EQDONE        Done already                                 
         BO    REORG148            Skip                                         
         L     RF,ROWINDEX                                                      
         S     RF,KYWBASE                                                       
         CH    RF,EQDSP            Match displacement into keyword tab          
         BNE   REORG148                                                         
         MVI   EQIND,EQDONE        Mark done                                    
         MVC   EQDSP,ROWKYDSP                                                   
*                                                                               
REORG148 AHI   R2,ROWLNQ           Bump up to next column                       
         SHI   R6,EQLNQ            Reset to first parameter                     
         BCT   R1,REORG142         Loop                                         
         B     REORG180            Finished                                     
*                                                                               
REORG150 CLI   EQTYPE,EQSUM        CUME() column type ?                         
         BNE   REORG152                                                         
         ST    R4,EQADDR           A(Column table entry)                        
         B     REORG170                                                         
*                                                                               
REORG152 MVC   EQDEC#,NEXT.COL#DEC    Save decimal control                      
         LA    RE,NEXT.COLACM                                                   
         CLI   QPROG,PRODUCTION       Production?                               
         BE    REORG154                                                         
         TM    NEXT.COLOPT2,COLREVSG                                            
         JZ    *+8                                                              
         OI    COLOPT2,COLREVSG    Set on if other is on                        
*        TM    COLOPT2,COLREVSG    Visa versa                                   
*        JZ    *+8                                                              
*        OI    NEXT.COLOPT2,COLREVSG                                            
                                                                                
REORG154 TM    DDLNKIND,DDLNKGBL      RLP Global report                         
         BO    REORG157               Let DDLINK handle this                    
         TM    NEXT.COLIND4,COLNOSEC                                            
         BZ    REORG157               This is okay                              
         OI    COLFLAGS,COLHIDE       Remove from user view                     
         OI    COLIND4,COLNOSEC       Access denied                             
                                                                                
REORG157 TM    NEXT.COLFLAGS,COLAMT                                             
         BO    REORG166                                                         
*                                                                               
         TM    FMTSW,FMTFRATE                                                   
         BZ    REORG158                                                         
         TM    NEXT.COLIND2,COLRATE                                             
         BZ    REORG158                                                         
         OI    COLIND2,COLRCALC         DETAIL COLUMN CALC                      
*                                                                               
REORG158 TM    NEXT.COLFLAGS,COLCALC                                            
         BO    REORG166                                                         
         TM    NEXT.COLIND3,COLNATSR+COLNASRT                                   
         BNZ   REORG162                                                         
         MVI   ERROR#,4                                                         
         B     REORG900            USER INPUT BAD COLUMN #                      
*                                                                               
REORG162 MVI   EQTYPE,EQROW        SWITCH TO ROW DISPLACMENT                    
         LA    RE,NEXT.COLDSP                                                   
*                                                                               
REORG166 MVC   EQDSP,0(RE)         MOVE IN DISP. TO ACCUM.                      
         CLI   EQTYPE,EQCOL                                                     
         BNE   REORG170                                                         
         TM    NEXT.COLOPT2,COLREVSG    SPECIAL REVERSE SIGN KEYWORD?           
         BZ    REORG170                                                         
         OI    EQIND,EQREV         THIS WILL MULT # BY -1 (EVAL ROUT)           
         OI    COLOPT,COLFCALC     ORIGINAL COLUMN FORCE CALC ON TOTALS         
*                                                                               
REORG170 AHI   R6,EQLNQ            BUMP UP IN STACK                             
         B     REORG106            LOOP FOR NEXT                                
*                                                                               
REORG180 AHI   R3,COLLNQ           BUMP TO NEXT COLUMN                          
         BCT   R0,REORG102                                                      
         EJECT ,                                                                
***********************************************************************         
* Set COLPRTSQ for order to print now that columns are reorganized    *         
***********************************************************************         
REORG200 LA    R1,1                                                             
         MVI   BYTE1,0             Set to indicate mode normal                  
         L     R4,FMTCOL                                                        
REORG202 L     R3,FMTCOL           Reset to loop through                        
         CLM   R1,1,FMT#COLS       Has R1 exceeded max cols ?                   
         BH    REORG250            Finished                                     
                                                                                
         LA    R2,1                R2 = True column count                       
REORG206 CLM   R1,1,COLNUM         R1 = Column to match on                      
         BE    REORG210                                                         
         AHI   R2,1                Count the real column number                 
         AHI   R3,COLLNQ           Try next column                              
         B     REORG206            Loop                                         
                                                                                
REORG210 CLI   COLCLVL,1                                                        
         BL    REORG220            Normal case                                  
         BH    REORG250          ? Finshed since these we processed             
         STC   R2,NEXT.COLPRTSQ    Save printing sequence                       
         ZIC   R0,COLXLNK          This will be the column to find              
         MVC   BYTE,COLNUM         Save column sequence or orginal              
         AHI   R4,COLLNQ           Work on next one                             
         BRAS  RE,ORGXCOL                                                       
         B     REORG230                                                         
                                                                                
REORG220 STC   R2,NEXT.COLPRTSQ                                                 
                                                                                
REORG230 AHI   R1,1                BUMP UP BY ONE                               
         AHI   R4,COLLNQ           BUMP TO NEXT COLUMN                          
         B     REORG202                                                         
         EJECT ,                                                                
**********************************************************************          
* DDLINK processing method. All non$ columns first                   *          
**********************************************************************          
REORG250 TM    DDLNKIND,DDLNKON+DDLNKTST                                        
         BZ    REORG300                                                         
         LA    R1,1                                                             
         MVI   BYTE1,1             Set to indicate mode DDLINK                  
         L     R4,FMTCOL                                                        
REORG252 L     R3,FMTCOL           Reset to loop through                        
         CLM   R1,1,FMT#COLS       Has R1 exceeded max cols ?                   
         BH    REORG270            Finished first pass                          
                                                                                
         LA    R2,1                R2 = True column count                       
REORG254 CLM   R1,1,COLNUM         R1 = Column to match on                      
         BE    REORG256                                                         
         AHI   R2,1                Count the real column number                 
         AHI   R3,COLLNQ           Try next column                              
         B     REORG254            Loop                                         
                                                                                
REORG256 TM    COLIND2,COLRATE                                                  
         BO    *+8                                                              
         TM    COLFLAGS,COLAMT+COLCALC                                          
         BZ    REORG258                                                         
         AHI   R1,1                                                             
         B     REORG252            Only process non$ columns for now            
                                                                                
REORG258 STC   R2,NEXT.COLDDLSQ    SAVE SEQ FOR PRINTING                        
                                                                                
REORG260 AHI   R1,1                BUMP UP BY ONE                               
         AHI   R4,COLLNQ           BUMP TO NEXT COLUMN                          
         B     REORG252                                                         
                                                                                
***********************************************************************         
* DDLINK processing method. All $ columns 2nd                                   
***********************************************************************         
REORG270 LA    R1,1                                                             
REORG272 L     R3,FMTCOL           Reset to loop through                        
         CLM   R1,1,FMT#COLS       Has R1 exceeded max cols ?                   
         BH    REORG292            Finished first pass                          
                                                                                
         LA    R2,1                R2 = True column count                       
REORG274 CLM   R1,1,COLNUM         R1 = Column to match on                      
         BE    REORG276                                                         
         AHI   R2,1                Count the real column number                 
         AHI   R3,COLLNQ           Try next column                              
         B     REORG274            Loop                                         
                                                                                
REORG276 TM    COLIND2,COLRATE                                                  
         BO    REORG278                                                         
         TM    COLFLAGS,COLAMT+COLCALC                                          
         BNZ   REORG278                                                         
         AHI   R1,1                                                             
         B     REORG272            Only process non$ columns for now            
                                                                                
REORG278 CLI   COLCLVL,1                                                        
         BL    REORG280            Normal case                                  
         BH    REORG292          ? Finshed since these we processed             
         STC   R2,NEXT.COLDDLSQ    Save DDLINK sequence                         
         ZIC   R0,COLXLNK          This will be the column to find              
         MVC   BYTE,COLNUM         Save column sequence or orginal              
         AHI   R4,COLLNQ           Work on next one                             
         BRAS  RE,ORGXCOL                                                       
         B     REORG290                                                         
                                                                                
REORG280 STC   R2,NEXT.COLDDLSQ    SAVE SEQ FOR DDLINK processing               
                                                                                
REORG290 AHI   R1,1                BUMP UP BY ONE                               
         AHI   R4,COLLNQ           BUMP TO NEXT COLUMN                          
         B     REORG272                                                         
                                                                                
REORG292 LA    R1,1                                                             
         L     R3,FMTCOL                                                        
         ZIC   RF,FMT#COLS                                                      
                                                                                
REORG294 ZIC   R4,COLPRTSQ         Column print sequense                        
         SHI   R4,1                                                             
         MHI   R4,COLLNQ                                                        
         A     R4,FMTCOL                                                        
         TM    NEXT.COLFLAGS,COLHIDE                                            
         BO    REORG296                                                         
         STC   R1,NEXT.COLSEQ#                                                  
         AHI   R1,1                                                             
                                                                                
REORG296 AHI   R3,COLLNQ                                                        
         BCT   RF,REORG294         Finished first pass                          
         EJECT ,                                                                
***********************************************************************         
* SET COLRCALC OPTION ON FOR CERTAIN COLUMNS                          *         
***********************************************************************         
         SPACE 1                                                                
REORG300 ICM   R0,15,SVR0          NUMBER OF CALCULATION COLUMNS                
         BZ    REORG400                                                         
         TM    FMTSW,FMTFRATE                                                   
         BZ    REORG400            DON'T BOTHER IF OPTION NOT ON                
*                                                                               
         SR    R3,R3                                                            
         IC    R3,FMT#COLS                                                      
         BCTR  R3,0                POINT TO LAST COLUMN                         
         MHI   R3,COLLNQ                                                        
         A     R3,FMTCOL                                                        
*                                                                               
REORG310 TM    COLIND2,COLRCALC    IS THIS OPTION ON ?                          
         BZ    REORG340            YES, MARK ALL COL CALC. PRIOR                
         L     R6,COLXTRA                                                       
*                                                                               
REORG314 CLI   EQTYPE,EQEND        AT END OF EQUATION ?                         
         BE    REORG340            YES,  GET NEXT CALC. COL                     
         CLI   EQTYPE,EQCOL        IS IT A COLUMN ?                             
         BNE   REORG330            NO, SO GET NEXT EQUATION VALUE               
         SR    R1,R1                                                            
         IC    R1,FMT#COLS         NUMBER OF COLUMNS                            
         L     R4,FMTCOL           BASE   OF COLUMNS                            
*                                                                               
REORG318 CLC   NEXT.COLNUM,EQCOL#  MATCH ON COLUMN NUMBER                       
         BE    REORG320                                                         
         AHI   R4,COLLNQ           BUMP UP NEXT.COLD                            
         BCT   R1,REORG318                                                      
         DC    H'00'               MUST MATCH A COLUMN                          
*                                                                               
REORG320 TM    NEXT.COLFLAGS,COLCALC    IS THIS A COLUMN CALC ALSO?             
         BZ    REORG330                 NO,  SO NEXT EQUATION VALUE             
         TM    NEXT.COLOPT2,COLVPCT                                             
         BO    REORG330                 DON'T MARK VERTICAL % TYPES             
         OI    NEXT.COLIND2,COLRCALC    YES. MARK ALSO AS COLDCALC              
*                                                                               
REORG330 AHI   R6,EQLNQ            START ALL OVER                               
         B     REORG314                                                         
*                                                                               
REORG340 SHI   R3,COLLNQ           MUST BUMP BACKWARDS                          
         BCT   R0,REORG310                                                      
***********************************************************************         
* Re-organize pointers of accuminators to columns in COLTAB           *         
***********************************************************************         
         SPACE 1                                                                
REORG400 SR    R0,R0                                                            
         ICM   R0,1,FMT#ACMS       Number of accumlated columns                 
         BZ    REORG500                                                         
         LA    RE,FMT@COL#         Start of accum pointer -                     
*                                    re-organize incase move around             
REORG410 L     R3,FMTCOL                                                        
         SR    RF,RF                                                            
         ZIC   R1,FMT#COLS                                                      
                                                                                
REORG412 CLC   COLNUM,0(RE)        Match on column number                       
         BE    REORG420                                                         
         AHI   R3,COLLNQ                                                        
         AHI   RF,1                Next column                                  
         BCT   R1,REORG412                                                      
         DC    H'00'               Must find a match                            
*                                                                               
REORG420 TM    COLOPT2,COLFCPRT    Constant type column ?                       
         BZ    REORG422            No                                           
         CLI   FMTROWLV,0          Any level set ?                              
         BE    REORG422            No                                           
         MVI   COLTOTLV,0          Print all totals                             
*                                                                               
REORG422 STC   RF,0(,RE)           Replace col #, with array index              
         AHI   RE,1                                                             
         BCT   R0,REORG410         Do next one                                  
                                                                                
***********************************************************************         
* Find and set displacement of forced column                          *         
***********************************************************************         
REORG500 CLI   FMTFCOL,0                                                        
         JE    REORG600                                                         
         L     R3,FMTCOL                                                        
         ZIC   RF,FMT#COLS                                                      
                                                                                
REORG510 CLC   COLNUM,FMTFCOL      Match on column sequence                     
         JE    REORG512                                                         
         AHI   R3,COLLNQ                                                        
         BRCT  RF,REORG510                                                      
         DC    H'00'                                                            
                                                                                
*EORG512 CLC   NEXT.COLNUM,FMTFCOL                                              
*        BNE   *+10                                                             
*EORG512 MVC   FMTFCOL,NEXT.COLDSP Replace column # with displacement           
REORG512 MVC   FMTFCOL,COLDSP      Replace column # with displacement           
                                                                                
***********************************************************************         
* Set for main foramt extending header / trail column displacements             
***********************************************************************         
REORG600 CLI   FMTNUM,1                                                         
         BH    REORG900                                                         
         L     R4,ATTRDATA                                                      
         TM    DWNOPT3,DWNXTTR                                                  
         BZ    *+8                                                              
         BRAS  RE,XTADJ                                                         
*                                                                               
         L     R4,ATRLDATA                                                      
         TM    DWNOPT3,DWNXTRL     Extended trailer                             
         BZ    *+8                                                              
         BRAS  RE,XTADJ                                                         
*                                                                               
REORG900 CLI   ERROR#,0                                                         
         XIT1                                                                   
*                                                                               
MAXSWAP  DS    XL1                 MAX NUMBER OF COLUMN SWAPS ALLOWED           
                                                                                
***********************************************************************         
*                                                                               
***********************************************************************         
ORGXCOL  L     R3,FMTCOL                                                        
         LA    R2,1                R2 = True column count                       
                                                                                
ORGXCOL2 CLM   R0,1,COLNUM         R1 = Column to match on                      
         JE    ORGXCOL4                                                         
         AHI   R2,1                Count the real column number                 
         AHI   R3,COLLNQ           Try next column                              
         J     ORGXCOL2            Loop                                         
                                                                                
ORGXCOL4 CLC   BYTE,COLXLNK        Should match                                 
         JNE   ORGXCOL8            Finshed with this group                      
         LA    RF,NEXT.COLPRTSQ                                                 
         CLI   BYTE1,0                                                          
         JE    *+8                                                              
         LA    RF,NEXT.COLDDLSQ                                                 
         STC   R2,0(,RF)           Set processing sequense                      
         AHI   R4,COLLNQ           Set to process next in line                  
         AHI   R0,1                Try another one                              
         CLM   R0,1,FMT#COLS       Has RF exceeded max cols ?                   
         JNH   ORGXCOL             Find next, if it exist                       
                                                                                
ORGXCOL8 SHI   R4,COLLNQ           Reset so outside routine can up it           
         BR    RE                  Must have processed all                      
                                                                                
***********************************************************************         
*                                                                               
***********************************************************************         
ORGCOLSW CR    R3,R4                                                            
         JE    ORGCOLER            CAN'T SWAP WITH ITSELF                       
         SR    RF,RF                                                            
         IC    RF,MAXSWAP          LIMIT THE NUMBER OF SWAPS                    
         LA    RF,1(,RF)                                                        
         STC   RF,MAXSWAP                                                       
         CLI   MAXSWAP,40          HOW MUCH SWAPING HAS OCCURED ?               
         JH    ORGCOLER                 TOO MUCH, MUST BE LOOPING               
         XC    COLD(COLLNQ),NEXT.COLD   SWAP COLUMNS                            
         XC    NEXT.COLD(COLLNQ),COLD                                           
         XC    COLD(COLLNQ),NEXT.COLD                                           
         BR    RE                                                               
*                                                                               
ORGCOLER MVI   ERROR#,4                                                         
         J     REORG900                                                         
         DROP  NEXT                                                             
         EJECT                                                                  
*=====================================================================*         
*   Replace row or column number with address of row or column        *         
*        R4 = A(XTRELD), saved element to process                     *         
*=====================================================================*         
                                                                                
         USING XTRELD,R4                                                        
XTADJ    NTR1                                                                   
         SR    R0,R0                                                            
         SR    R1,R1                                                            
         IC    R1,XTRSUB#          Number of sub-elements                       
         LA    R6,XTRSUBEL                                                      
*                                                                               
         USING XTRSUBEL,R6                                                      
XTADJ10  TM    XTRSIND,XTRSROW     Row number ?                                 
         BZ    XTADJ40                                                          
*                                                                               
         L     R2,FMTROW                                                        
         IC    R0,FMT#ROWS                                                      
XTADJ15  CLC   ROWNUM,XTRSNUM      Match on row number                          
         BE    XTADJ20                                                          
         AHI   R2,ROWLNQ                                                        
         BCT   R0,XTADJ15                                                       
         DC    H'00'               Should have match on row number              
*                                                                               
XTADJ20  STCM  R2,15,XTRSNUM       Save A(Row)                                  
         B     XTADJ80                                                          
*                                                                               
XTADJ40  TM    XTRSIND,XTRSCOL     Column                                       
         BZ    XTADJ80                                                          
*                                                                               
         L     R3,FMTCOL                                                        
         IC    R0,FMT#COLS                                                      
XTADJ45  CLC   COLNUM,XTRSNUM      Match on row number                          
         BE    XTADJ50                                                          
         AHI   R3,COLLNQ                                                        
         BCT   R0,XTADJ45                                                       
         DC    H'00'               Should have match on row number              
*                                                                               
XTADJ50  STCM  R3,15,XTRSNUM       Save A(Column)                               
*                                                                               
XTADJ80  ZIC   RF,XTRSUBLN                                                      
         AR    R6,RF                                                            
         BCT   R1,XTADJ10                                                       
         XIT1                                                                   
         DROP  R4,R5,R6                                                         
         SPACE 3                                                                
         LTORG                                                                  
         TITLE 'CENTER REPORT ON PAGE'                                          
***********************************************************************         
*  ADJUST ADDRESSING TO CENTER REPORT ON PAGE, PITCH DEPENDENT        *         
***********************************************************************         
         SPACE 1                                                                
         USING ROWD,R2                                                          
         USING COLD,R3                                                          
         USING FMTRECD,R5                                                       
         USING LCNTD,R8                                                         
CENTERIT NMOD1 LCNTDQ,**CENT**,CLEAR=YES                                        
         LR    R8,RC                                                            
         L     RC,RLBASEC                                                       
         L     R1,FMTPGEWD         Calculate adjustment size (R1)               
         ZIC   R2,FMTREPWD         Page width - width of columns                
         SR    R1,R2                                                            
         SRL   R1,1                Divide by two (in half)                      
*                                                                               
         L     R3,FMTBOXCL         Adjust the boxes                             
         BAS   RE,CENTFIX          Center box information                       
*                                                                               
         L     R3,FMTCHEAD         Adjust 1st row of column headings            
         BAS   RE,CENTFIX                                                       
         LA    R3,STDPGWD(,R3)     Adjust 2nd row                               
         BAS   RE,CENTFIX                                                       
         TM    FMTPOPT1,RPFBOX     Printing boxes ?                             
         BNZ   *+12                Yes so skip                                  
         LA    R3,STDPGWD(,R3)     Adjust 3rd row                               
         BAS   RE,CENTFIX                                                       
*                                                                               
         L     R3,FMTCOL           Adjust printing addresses in column          
         ZIC   R0,FMT#COLS                                                      
*                                                                               
CENT40   ICM   R6,15,COLPRT        Load printing location address               
         BZ    *+10                                                             
         AR    R6,R1               Add centering adjustment                     
         ST    R6,COLPRT           Save new printing location                   
*                                                                               
         CLI   COLSTACK,0                                                       
         BNE   CENT45              Don't center for stack                       
         TM    COLIND2,COLSTATC                                                 
         BO    CENT45              Don't do for STATIC type keyword             
         ICM   R6,15,COLHEAD1                                                   
         BZ    CENT42                                                           
         AR    R6,R1                                                            
         ST    R6,COLHEAD1                                                      
*                                                                               
CENT42   ICM   R6,15,COLHEAD2                                                   
         BZ    CENT45                                                           
         AR    R6,R1                                                            
         ST    R6,COLHEAD2                                                      
*                                                                               
CENT45   LA    R3,COLLNQ(,R3)      Bump to next column entry                    
         BCT   R0,CENT40                                                        
*                                                                               
         L     R2,FMTROW           Adjust printing addresses for rows           
         ZIC   R0,FMT#ROWS                                                      
*                                                                               
CENT50   ICM   R6,15,ROWPRTAD      Load printing location address               
         BZ    *+6                                                              
         AR    R6,R1               Add centering adjustment                     
         ST    R6,ROWPRTAD         Save new printing location                   
         LA    R2,ROWLNQ(,R2)      Bump to next row entry                       
         BCT   R0,CENT50                                                        
         XIT1  ,                                                                
         EJECT ,                                                                
***********************************************************************         
*  MOVE CHAR FROM LEFT TO RIGHT                                       *         
***********************************************************************         
         SPACE 1                                                                
CENTFIX  MVI   LCNTSTRG,C' '            Clear temporary storage                 
         MVC   LCNTSTRG+1(L'LCNTSTRG-1),LCNTSTRG                                
         LA    RF,LCNTSTRG                                                      
         AR    RF,R1                    Add centering adjustment length         
         EXMVC R2,0(RF),0(R3)                                                   
*                                       R2 = Total column size                  
*                                       R3 = Information to move                
*                                       Move over to center                     
         MVI   0(R3),C' '               Clear previous data                     
         MVC   1(STDPGWD-1,R3),0(R3)                                            
         MVC   0(STDPGWD,R3),LCNTSTRG   Put in new data                         
         BR    RE                       Return                                  
         DROP  R2,R5,R8                                                         
                                                                                
         LTORG                                                                  
         TITLE 'TRANSLATE FORMAT RECORD'                                        
***********************************************************************         
*  CONVERT DICTIONARY VALUES BACK TO CURRENT LANGAUGE                 *         
***********************************************************************         
         SPACE 1                                                                
         USING ACRL2D,R7                                                        
TRNSLATE NMOD1 0,**TLAT**                                                       
         L     RC,RLBASEC                                                       
         L     R7,AACRL2D                                                       
         MVI   BYTE1,NO                                                         
         XC    TRNSTAB,TRNSTAB                                                  
         MVI   TRNSTAB+X'01',C','                                               
         L     R3,ABUDIO           Clear what ever is in BUD IO area            
         AH    R3,DATADISP                                                      
         MVI   0(R3),0                                                          
*                                                                               
         L     R3,AIO2             A(FORMAT RECORD)                             
         AH    R3,DATADISP                                                      
TRNS100  CLI   0(R3),0             END OF RECORD?                               
         BE    TRNS900                                                          
         CLI   0(R3),RHDELQ        X'C1' HEADING ELEMENT                        
         BE    TRNS200                                                          
         CLI   0(R3),RRWELQ        X'C2' ROW     ELEMENT                        
         BE    TRNS300                                                          
         CLI   0(R3),RCLELQ        X'C3' COLUMN  ELEMENT                        
         BE    TRNS400                                                          
         CLI   0(R3),RFLELQ        X'C5' FILTER  ELEMENT                        
         BE    TRNS500                                                          
TRNS125  SR    R1,R1                                                            
         IC    R1,1(,R3)                                                        
         AR    R3,R1                                                            
         B     TRNS100                                                          
         EJECT 1                                                                
         USING RHDELD,R3                                                        
NEW      USING RHDELD,CHOPWRK                                                   
TRNS200  TM    RHDFRM,RHDDEF       ONLY DEFINED HEADING TYPES                   
         BZ    TRNS125                                                          
         TM    RHDFRM,RHDDICT                                                   
         BZ    TRNS125             ONLY TRNASLATE TRANSLATED ITEMS              
         CLC   =AL2(AC#RSBLK),RHDDATA                                           
         BNE   TRNS125                                                          
         CLI   RHDXDATA,0                                                       
         BNE   TRNS125             ALREADY CONVERTED                            
         XC    CHOPWRK,CHOPWRK                                                  
         MVC   NEW.RHDEL(RHDLNQ),RHDEL  SAVE OFF ELEMENT                        
         MVC   NEW.RHDDATA(2),RHDDATA                                           
         MVI   NEW.RHDLN,RHDLNQ+2  NEW LENGTH                                   
         MVC   NEW.RHDXDATA,RHDDATA+2                                           
         NI    NEW.RHDXDATA,TURNOFF-X'F0'   MAKE BINARY # 1 TO 9                
         MVI   RHDEL,X'FF'         DELETE                                       
         MVI   BYTE1,YES           ADD TRANLATED ELEMENT TO TEMP IO             
         GOTO1 ADDEL,DMCB,(C'P',=CL8'ACCVBIG'),ABUDIO,CHOPWRK,0                 
         CLI   12(R1),0                                                         
         BE    TRNS125                                                          
         DC    H'00'                                                            
         DROP  R3                                                               
         DROP  NEW                                                              
         EJECT                                                                  
NEW      USING RRWELD,CHOPWRK                                                   
         USING RRWELD,R3                                                        
*                                                                               
TRNS300  TM    RRWOPT2,RRWDICT     IN DICTIONARY FORM ?                         
         BO    TRNS302             YES                                          
         SR    RF,RF               NO, SO REPLACE X'01' WITH C','               
         LA    RF,L'RRWDATA                                                     
         LA    RE,RRWDATA          OLD LOCATION                                 
         TM    RRWOPT,RRWNEWEL                                                  
         BZ    TRNS301                                                          
         IC    RF,RRWDATLN                                                      
         LA    RE,RRWNDATA         NEW LOCATION                                 
*                                                                               
TRNS301  EX    RF,*+8                                                           
         B     *+10                                                             
         TRT   0(0,RE),TRNSTAB     DESTORIES R1 AND R2                          
         BZ    TRNS302                                                          
         MVI   0(R1),C','          REPLACE X'01' WITH COMMAS                    
         B     TRNS301                                                          
*                                                                               
TRNS302  TM    RRWOPT,RRWNEWEL     NEED TO CONVERT?                             
         BO    TRNS125             NO                                           
         XC    CHOPWRK,CHOPWRK                                                  
         MVC   NEW.RRWEL(RRWDATA-RRWELD),RRWEL                                  
         TM    RRWOPT2,RRWDICT     IN DICTIONARY FORM ?                         
         BZ    TRNS310                                                          
         CLI   RRWDATA+11,0                                                     
         BE    *+10                                                             
         MVC   NEW.RRWXDATA,RRWDATA+11   SPECAIL SAVED DATA                     
         SR    R1,R1                                                            
         LA    RF,5                                                             
         LA    RE,RRWDATA                                                       
*                                                                               
TRNS305  OC    0(2,RE),0(RE)       COUNT THE ITEMS IN RRWDATA                   
         BZ    TRNS308                                                          
         LA    R1,1(,R1)                                                        
         LA    RE,2(,RE)           NEXT ITEM IN RRWDATA                         
         BCT   RF,TRNS305                                                       
         DC    H'00'                                                            
*                                                                               
TRNS308  SLL   R1,1                                                             
         AHI   R1,-1                                                            
         BP    TRNS315                                                          
         DC    H'00'                                                            
*                                                                               
TRNS310  LA    R1,L'RRWDATA                                                     
         LA    RE,RRWDATA-1(R1)    POINT TO END                                 
*                                                                               
TRNS312  CLI   0(RE),BLANK                                                      
         BH    TRNS314                                                          
         BCTR  RE,0                                                             
         BCT   R1,TRNS312                                                       
         DC    H'00'                                                            
*                                                                               
TRNS314  BCTR  R1,0                                                             
*                                                                               
TRNS315  EXMVC R1,NEW.RRWNDATA,RRWDATA                                          
         AHI   R1,1                ADD BACK FOR EX INSTR.                       
         STC   R1,NEW.RRWDATLN     SAVE LENGTH                                  
         LA    RE,NEW.RRWNDATA(R1) POINT TO END                                 
         SR    RF,RF                                                            
         IC    RF,RRWLN                                                         
         SHI   RF,RRWLNQ                                                        
         BZ    TRNS320                                                          
         STC   RF,NEW.RRWPFXLN                                                  
         BCTR  RF,0                                                             
         EXMVC RF,0(RE),RRWPRFX                                                 
         LA    RE,1(RF,RE)                                                      
*                                                                               
TRNS320  LA    RF,NEW.RRWEL                                                     
         SR    RE,RF                                                            
         STC   RE,NEW.RRWLN                                                     
         OI    NEW.RRWOPT,RRWNEWEL                                              
         MVI   RRWEL,X'FF'                                                      
         MVI   BYTE1,YES                                                        
         GOTO1 ADDEL,DMCB,(C'P',=CL8'ACCVBIG'),ABUDIO,CHOPWRK,0                 
         CLI   12(R1),0                                                         
         BE    TRNS125                                                          
         DC    H'00'                                                            
         DROP  NEW                                                              
         DROP  R3                                                               
         EJECT 1                                                                
NEW      USING RCLELD,CHOPWRK                                                   
         USING RCLELD,R3                                                        
*                                                                               
TRNS400  TM    RCLOPT2,RCLDICT                                                  
         BO    TRNS405                                                          
         LA    RF,L'RCLDATA                                                     
         LA    RE,RCLDATA                                                       
         TM    RCLOPT,RCLNEWEL     NEED TO CONVERT?                             
         BZ    TRNS402             NO                                           
         IC    RF,RCLDATLN                                                      
         LA    RE,RCLNDATA                                                      
*                                                                               
TRNS402  EX    RF,*+8                                                           
         B     *+10                                                             
         TRT   0(0,RE),TRNSTAB     DESTORIES R1 AND R2                          
         BZ    TRNS405                                                          
         MVI   0(R1),C','          REPLACE X'01' WITH COMMAS                    
         B     TRNS402                                                          
*                                                                               
TRNS405  TM    RCLOPT,RCLNEWEL                                                  
         BO    TRNS125             FINISHED                                     
         XC    CHOPWRK,CHOPWRK                                                  
         MVC   NEW.RCLEL(RCLDATA-RCLELD),RCLEL                                  
         TM    RCLOPT2,RCLDICT                                                  
         BZ    TRNS415                                                          
         CLI   RCLDATA+11,0                                                     
         BE    *+10                                                             
         MVC   NEW.RCLXDATA,RCLDATA+11                                          
*                                                                               
         SR    R1,R1                                                            
         LA    RF,5                                                             
         LA    RE,RCLDATA                                                       
TRNS410  OC    0(2,RE),0(RE)                                                    
         BZ    TRNS412                                                          
         AHI   R1,1                                                             
         AHI   RE,2                                                             
         BCT   RF,TRNS410                                                       
         DC    H'00'                                                            
*                                                                               
TRNS412  SLL   R1,1                                                             
         SHI   R1,1                                                             
         BP    TRNS425                                                          
         DC    H'00'                                                            
*                                                                               
TRNS415  LA    R1,L'RCLDATA                                                     
         LA    RE,RCLDATA-1(R1)    POINT TO END                                 
TRNS418  CLI   0(RE),BLANK                                                      
         BH    TRNS420                                                          
         BCTR  RE,0                                                             
         BCT   R1,TRNS418                                                       
         DC    H'00'                                                            
*                                                                               
TRNS420  BCTR  R1,0                                                             
*                                                                               
TRNS425  EXMVC R1,NEW.RCLNDATA,RCLDATA                                          
         AHI   R1,1                                                             
         STC   R1,NEW.RCLDATLN                                                  
         LA    RE,NEW.RCLNDATA(R1) POINT TO END                                 
*                                                                               
         CLI   RCLLN,RCLLNQ1                                                    
         BL    TRNS450                                                          
         LA    R2,RCLHDL2-1                                                     
         LA    R1,L'RCLHDL1                                                     
*                                                                               
TRNS430  CLI   0(R2),BLANK                                                      
         BH    TRNS432                                                          
         BCTR  R2,0                                                             
         BCT   R1,TRNS430                                                       
*                                                                               
TRNS432  STC   R1,NEW.RCLHD1LN                                                  
         SHI   R1,1                                                             
         BM    TRNS435                                                          
         EXMVC R1,0(RE),RCLHDL1                                                 
         LA    RE,1(R1,RE)                                                      
*                                                                               
TRNS435  CLI   RCLLN,RCLLNQ2                                                    
         BNE   TRNS450                                                          
         LA    R2,RCLEL+RCLLNQ2-1                                               
         LA    R1,L'RCLHDL2                                                     
*                                                                               
TRNS440  CLI   0(R2),BLANK                                                      
         BH    TRNS442                                                          
         BCTR  R2,0                                                             
         BCT   R1,TRNS440                                                       
         DC    H'00'                                                            
*                                                                               
TRNS442  STC   R1,NEW.RCLHD2LN                                                  
         BCTR  R1,0                                                             
         EXMVC R1,0(RE),RCLHDL2                                                 
         LA    RE,1(R1,RE)                                                      
*                                                                               
TRNS450  LA    RF,NEW.RCLEL                                                     
         SR    RE,RF                                                            
         STC   RE,NEW.RCLLN                                                     
         OI    NEW.RCLOPT,RCLNEWEL                                              
         MVI   RCLEL,X'FF'                                                      
         MVI   BYTE1,YES                                                        
         GOTO1 ADDEL,DMCB,(C'P',=CL8'ACCVBIG'),ABUDIO,CHOPWRK,0                 
         CLI   12(R1),0                                                         
         BE    TRNS125                                                          
         DC    H'00'                                                            
         DROP  NEW                                                              
         DROP  R3                                                               
         EJECT 1                                                                
         USING RFLELD,R3                                                        
TRNS500  OI    RFLIND,RFLBINRY     Set to binary data on these                  
         CLI   RFLTYPE,RFLTTYPE    Ignore transaction type                      
         BE    TRNS125                                                          
         CLI   RFLTYPE,RFLBUDGT    Ignore budget type                           
         BE    TRNS125                                                          
         CLI   RFLTYPE,RFLPCDE     Ignore paycode type                          
         BE    TRNS125                                                          
*&&UK                                                                           
         CLI   RFLTYPE,RFLAMFR     Ignore amount from                           
         BE    TRNS125                                                          
         CLI   RFLTYPE,RFLAMTO     Ignore amount to                             
         BE    TRNS125                                                          
*&&                                                                             
         NI    RFLIND,TURNOFF-RFLBINRY    Switch off this indicator             
         SR    RF,RF                                                            
         IC    RF,RFLLN                                                         
         SHI   RF,RFLLNQ+1         RF= LENGTH OF DATA TO TRANSLATE              
*                                                                               
TRNS525  EX    RF,*+8                                                           
         B     *+10                                                             
         TRT   RFLDATA(0),TRNSTAB  DESTORIES R1 AND R2                          
         BZ    TRNS125                                                          
         MVI   0(R1),C','                                                       
         B     TRNS525                                                          
         DROP  R3                                                               
*                                                                               
TRNS900  CLI   BYTE1,YES           NO ELEMENT(S) TO ADD                         
         BNE   TRNSLTX                                                          
         GOTO1 ADDEL,DMCB,(C'D',=CL8'ACCVBIG'),(X'FF',AIO2),0                   
         L     R3,ABUDIO           NEW ELEMENT(S) TO ADD                        
         AH    R3,DATADISP         POINT TO FIRST ELEMENT                       
*                                                                               
TRNS955  CLI   0(R3),0             END OF RECORD                                
         BE    TRNSLTX             NO MORE TO ADD                               
         LR    RE,R3               SAVE A(CURRENT ELEMENT)                      
         SR    RF,RF                                                            
         IC    RF,1(,R3)           NEXT ELEMENT                                 
         AR    R3,RF                                                            
         BCTR  RF,0                MOVE INTO ELEMENT                            
         EXMVC RF,CHOPWRK,0(RE)                                                 
         GOTO1 ADDEL,DMCB,(C'P',=CL8'ACCVBIG'),AIO2,CHOPWRK,0                   
         CLI   12(R1),0                                                         
         BE    TRNS955                                                          
         DC    H'00'                                                            
*                                                                               
TRNSLTX  XMOD1                                                                  
         SPACE 1                                                                
TRNSTAB  DS    XL256                                                            
EXPNDATA DS    CL12                EXPANDED KEYWORD                             
EXPNTEMP DS    CL12                                                             
         EJECT                                                                  
***********************************************************************         
*        EXPAND KEYWORD USERFIELD PARAMETERS                          *         
*               R1 = A(USFIELD STRING IN RCLNDATA OR RRWNDATA)        *         
***********************************************************************         
         SPACE 1                                                                
USFLD    NTR1                                                                   
         LA    R0,3                AT MOST THREE PARAMS                         
         LA    RE,EXPNDATA                                                      
         LA    RF,L'FINDDATA       MAX LENGTH OF KEYWORD                        
USFLD10  CLI   0(RE),C' '          FIND END OF KEYWORD                          
         BNH   USFLD20             MUST HAVE BEEN SPACE OR NULL                 
         LA    RE,1(,RE)           BACK ONE                                     
         BCT   RF,USFLD10                                                       
*                                                                               
USFLD20  OC    0(2,R1),0(R1)       NO MORE PARAMETERS                           
         BZ    USFLD90                                                          
         MVI   0(RE),C','                                                       
         MVC   1(2,RE),0(R1)       MOVE IN USER FIELD                           
         LA    R1,2(,R1)           NEXT USER FIELD                              
         LA    RE,3(,RE)           NEXT LOCATION TO PUT UF                      
         BCT   R0,USFLD20                                                       
USFLD90  XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
*        FIX KEYWORD BY REPLACING # WITH NUMBER, I.E.                 *         
*            R#G ---> R2G   OR                                        *         
*            R#A ---> R#A,2                                           *         
*                                                                     *         
*        ON INPUT:                                                    *         
*           R1 CONTAINS THE SPECIAL ROW/COLUMN VALUE (RRWSPCL/RCLSPCL)*         
***********************************************************************         
         SPACE 1                                                                
KYW2FIX  NTR1                                                                   
         LR    R5,R1               SAVE THE SPECIAL ROW/COLUMN VALUE            
         LA    R6,L'FINDDATA       MAX TRANSLATED KEYWORD LENGTH                
         LA    R3,EXPNDATA         LOOK FOR # WITH IN KEYWORD                   
         LA    R4,EXPNTEMP         RE-BUILT KEYWORD AREA                        
         MVC   EXPNTEMP,SPACES                                                  
*                                                                               
KYW2F10  CLI   0(R3),C'#'                                                       
         BE    KYW2F20                                                          
         MVC   0(1,R4),0(R3)       MOVE IN NON-C'#'                             
         LA    R3,1(,R3)           NEXT CHARACTER  IN    KEYWORD                
         LA    R4,1(,R4)           NEXT SPOT IN RE-BUILT KEYWORD                
         BCT   R6,KYW2F10                                                       
         DC    H'00'               MUST HAVE BOOBOO                             
*                                                                               
KYW2F20  SR    R1,R1                                                            
         IC    R1,BYTE             NUMBER TO CHANGE TO CHARACTER FORM           
         LA    RF,1                LENGTH OF ONE CHARATER                       
         LA    RE,BYTE             BYTE ALREADY CONTAIN CONVERTED #             
         CLI   BYTE,C'0'           IF BYTE >= C'0'  AND BYTE =< C'9'            
         BNL   KYW2F30             THEN JUST MOVE IN THE ONE BYTE               
         CVD   R1,DUB                                                           
         OI    DUB+7,X'0F'         ADJUST SIGN FOR CHARACTER FORMAT             
         UNPK  WORK(3),DUB                                                      
*                                                                               
         LA    RF,3                MAX LENGTH OF 3                              
         LA    RE,WORK             POINT AT START OF EBCDIC NUMBER              
*                                                                               
KYW2F25  CLI   0(RE),C'0'          FIND START OF NUMBER (IF NOT ZERO)           
         BNE   KYW2F30                                                          
         LA    RE,1(,RE)           NEXT CHARACTER NUMBER                        
         BCT   RF,KYW2F25                                                       
         DC    H'00'               SHOULDN'T BE ALL ZERO                        
*                                                                               
KYW2F30  BCTR  RF,0                LESS ONE FOR EXECUTE                         
         CLM   R5,1,=AL1(RCLSPCT#) NON-JOBBER KEYWORD ?                         
         BE    KYW2F35             YES, SKIP                                    
         EXMVC RF,0(R4),0(RE)      REPLACE C'#' WITH NUMBER                     
*                                  MOVE IN NUMBER FROM WORK TO RWORK            
         LA    R4,1(RF,R4)         NEXT SPOT IN RE-BUILT KEYWORD                
         B     KYW2F40             CONTINUE                                     
*                                                                               
KYW2F35  STC   RF,WORK+3           SAVE THE EXECUTE LENGTH                      
         EXMVC RF,WORK+4,0(RE)     SAVE THE NUMBER                              
         MVC   0(1,R4),0(R3)       KEEP THE # SIGN                              
         AHI   R4,1                NEXT SPOT IN RE-BUILT KEYWORD                
*                                                                               
KYW2F40  SHI   R6,1                MOVE REST OF KEYWORD, LESS 1 FOR #           
         BNP   KYW2F60             FINISHED, NO MORE TO MOVE IN                 
         AHI   R3,1                BUMP PAST C'#'                               
*                                                                               
KYW2F50  MVC   0(1,R4),0(R3)       MOVE IN REST OF KEYWORD                      
         AHI   R3,1                NEXT CHARACTER  IN    KEYWORD                
         AHI   R4,1                NEXT SPOT IN RE-BUILT KEYWORD                
         BCT   R6,KYW2F50                                                       
*                                                                               
KYW2F60  CLM   R5,1,=AL1(RCLSPCT#) NON-JOBBER KEYWORD ?                         
         BNE   KYW2F90             NO,  SKIP                                    
*                                                                               
*                                  YES, FIND LAST BYTE OF DATA                  
         LA    R6,L'FINDDATA       MAX  LENGTH OF KEYWORD                       
         LA    R3,EXPNTEMP-1(R6)   LAST BYTE OF DATA                            
*                                                                               
KYW2F65  CLI   0(R3),BLANK         BLANK ?                                      
         BNE   KYW2F70             NO,  FOUND                                   
         BCTR  R3,0                ->   PREVIOUS BYTE                           
         BCT   R6,KYW2F65          TEST PREVIOUS BYTE                           
         DC    H'0'                SHOULD NEVER HAPPEN                          
*                                                                               
KYW2F70  ZIC   RF,WORK+3           LENGTH OF NUMBER MINUS ONE                   
         MVI   1(R3),C','          INSERT COMMA                                 
         EXMVC RF,2(R3),WORK+4     INSERT NUMBER                                
*                                                                               
KYW2F90  MVC   EXPNDATA,EXPNTEMP   REPLACE OLD KEYWORD WITH NEW                 
         XIT1                                                                   
         DROP  R7                                                               
         SPACE 3                                                                
         LTORG                                                                  
         TITLE 'SET FILTERS BASED ON REQUEST CARD'                              
***********************************************************************         
*  SET UP FILTERS BASED ON REQUEST CARD DATA FIRST                    *         
***********************************************************************         
         SPACE 1                                                                
         USING ACQD,R3                                                          
         USING ACRL2D,R7                                                        
SETCARD  DS    0D                                                               
         NMOD1 0,**CARD**                                                       
         L     RC,RLBASEC                                                       
         L     R7,AACRL2D                                                       
         ST    R5,SVR5             SAVE CURRENT FORMAT RECORD LOCATION          
         L     R3,ADQSTACK         REQUEST CARD STACK                           
*&&UK*&& MVC   QCURRY,ACQCURR      currency 1 or 2                              
         LA    R5,CARDTAB1                                                      
         MVC   RQRELEND,=X'FFFFFF' INITIALIZE                                   
         MVC   REQRECAP,SPACES                                                  
         MVI   REQRECAP,YES        MAIN IS ALWAYS YES                           
         CLI   QPROG,MANPOWER                                                   
         BNE   SETCRD10                                                         
         CLC   ACQCFLT1(5),SPACES  CONTRA FILTERS USED ?                        
         BNH   *+8                                                              
         OI    THRSW,THRGFP        GLOBAL FILTER PRE-DETERMINED                 
*                                                                               
         USING CARDD,R5                                                         
SETCRD10 CLI   0(R5),EOT           End of table?                                
         BE    SETCRD40                                                         
         SR    R4,R4                                                            
         ICM   R4,3,CARDLOC1       DISPLACMENT INTO ACQD                        
         AR    R4,R3               R4 = LOCATION IN ACQD                        
         SR    R6,R6                                                            
         ICM   R6,3,CARDLOC2       DISPLACMENT INTO ACWORKD                     
         BZ    *+6                                                              
         AR    R6,RC               R4 = LOCATION IN ACWORKD                     
*                                                                               
         SR    R1,R1                                                            
         IC    R1,CARDLEN          LENGTH OF FIELD                              
         SHI   R1,1                                                             
         LTR   R6,R6               CHECK DATA IN ACWORKD ONLY                   
         BZ    SETCRD12                                                         
         TM    CARDIND,CARDPROF    POSSIBLE PROFILE COMMENT?                    
         BZ    SETCRD12                                                         
         CLI   0(R6),C'('          WIPE OUT "(PROFILE DATA)" COMMENT            
         BNE   SETCRD12                                                         
         EXMVC R1,0(R4),SPACES     FIRST IN ACQD                                
         EXMVC R1,0(R6),SPACES     2ND IN ACWORKD                               
*                                                                               
SETCRD12 SR    R8,R8                                                            
         ICM   R8,3,CARDAFLT       A(FILTER)                                    
         A     R8,SVR5             ADD BASE OF CURRENT FORMAT                   
         OC    0(4,R8),0(R8)       Was this set already?                        
         BNZ   SETCRD38            Yes, next                                    
***********************************************************************         
*  AL1(INDICATORS),AL1(DATA FIELD LENGTH),AL2(ACQD DISPLACEMENT)      *         
***********************************************************************         
         SPACE 1                                                                
         TM    CARDIND,CARDDLNK    DDLINK multiple entries                      
         BZ    SETCRD15                                                         
         CLI   0(R6),X'FF'         If set the next 3 byte are A(Table)          
         BNE   SETCRD15                                                         
         ICM   R2,15,0(R6)         RF = A(DDLink block)                         
         EXMVC R1,0(R4),SPACES     First  in ACQD                               
         EXMVC R1,0(R6),SPACES     Second in ACWORKD                            
         LR    RE,R4                                                            
         SHI   RE,2                Point to unit/ledger spot                    
         MVC   0(2,RE),2(R2)       Move in Unit/Ledger                          
         LR    RE,R6                                                            
         SHI   RE,2                Point to unit/ledger spot                    
         MVC   0(2,RE),2(R2)       Move in Unit/Ledger                          
         GOTO1 =A(LISTBLD),DMCB,(14,(R2)),(0,=C'UL'),C'DLNK'                    
         CLI   DMCB,0              ANY OUTPUT?                                  
         BNE   *+6                 YES                                          
         DC    H'00'               MUST DEBUG                                   
                                                                                
         MVC   0(4,R8),DMCB                                                     
         B     SETCRD31                                                         
                                                                                
SETCRD15 EXCLC R1,0(R4),SPACES                                                  
         BE    SETCRD38            No data                                      
         EXOC  R1,0(R4),0(R4)                                                   
         BZ    SETCRD38            No data                                      
         OI    0(R8),FLTCARD       Request card over-ride (RECAP INFO)          
         MVC   2(2,R8),CARDLOC1    Save displacement in card (ACQD)             
         AHI   R1,1                One for execute                              
         STC   R1,1(,R8)           Save length in 2 byte                        
*                                                                               
         SR    R2,R2                                                            
         CLI   CARDROUT,1          IS IT QACCOUNT CASE                          
         BNE   SETCRD16                                                         
         LA    R2,QUNIT                                                         
*        MVC   SVUL,QUNIT                                                       
*        LA    R2,SVUL                                                          
*        TM    0(R4),X'40'         IS IT EXCLUDE ACCOUNT?                       
*        BO    SETCRD16            NO                                           
*        OI    0(R4),X'40'         MAKE UPPER CASE                              
*        NI    SVUL,TURNOFF-X'40'                                               
         B     SETCRD30                                                         
*                                                                               
SETCRD16 CLI   CARDROUT,2          IS IT QWRKLIST                               
         BNE   SETCRD18                                                         
         OC    ADLSTREC,ADLSTREC   LIST OF   WORKCODES?                         
         BZ    SETCRD30            NO SINGLE WORKCODE                           
         MVC   0(4,R8),ADLSTREC                                                 
         MVI   0(R8),FLTLIST+FLTNOUL  TO +/- LIST AND NO UNIT/LEDGER            
         OI    0(R8),FLTCARD       REQUEST CARD OVER-RIDE (RECAP INFO)          
         B     SETCRD38                                                         
*                                                                               
         USING ACMD,R4                                                          
SETCRD18 CLI   CARDROUT,3          TRANSACTION TYPE                             
         BNE   SETCRD20                                                         
         L     R4,AMONACC                                                       
         CLI   ACMTFLT,0           MONACC TRANSACTION TYPE FILTER?              
         BE    SETCRD38            FORGET THIS                                  
         CLI   ACMTFLT,TY30DI      229                                          
         BL    SETCRD38                                                         
         CLI   ACMTFLT,TY30TF      235                                          
         BH    SETCRD38                                                         
         MVC   0(0,R6),SPACES                                                   
         L     RE,AFLTAREA         CURRENT ADDRESS                              
         ST    RE,0(,R8)                                                        
         MVI   0(R8),FLTMULT       X'20'                                        
         OI    0(R8),FLTCARD       REQUEST CARD OVER-RIDE (RECAP INFO)          
         CLI   ACMTMSK,X'80'       IS THIS EXCLUDE?                             
         BNE   *+8                                                              
         OI    0(R8),FLTEXCL       X'10' EXCLUDE IT                             
         MVI   0(RE),1             LENGTH OF DATA                               
         MVC   1(1,RE),ACMTFLT     SAVE OFF VALUE                               
         MVI   2(RE),X'FF'         MARK END                                     
         LA    RE,3(,RE)                                                        
         ST    RE,AFLTAREA         SAVE NEW ADDRESS                             
         MVI   ACMTMSK,0                                                        
         B     SETCRD38                                                         
*                                                                               
SETCRD20 CLI   CARDROUT,4          Contra filtering routine #                   
         BNE   SETCRD30            No                                           
         CLI   0(R4),ACQCNTR       Contra filter ?                              
         BNE   SETCRD38            No, next entry                               
         LA    R4,1(,R4)           A(Contra filter)                             
         CLI   0(R4),C'('          Profile?                                     
         BE    SETCRD38            Yes, so can't do here                        
         LA    R1,L'ACQFLT1                                                     
*        LA    R2,=C'BS'           Billing source                               
*        CLC   =C'SR',QUNIT                                                     
*        BE    SETCRD30                                                         
         LA    R2,=C'UL'           Else unit/ledger                             
         CLC   0(2,R4),SPACES                                                   
         BNE   SETCRD30                                                         
         SR    R2,R2                                                            
         DROP  R4                                                               
*                                                                               
SETCRD30 LR    RF,R1                                                            
         GOTO1 =A(LISTBLD),DMCB,((RF),(R4)),(0,(R2)),0                          
         CLI   DMCB,0              ANY OUTPUT?                                  
         BNE   *+6                 YES                                          
         DC    H'00'               MUST DEBUG                                   
*                                                                               
SETCRD31 TM    CARDIND,CARDCLR                                                  
         BZ    SETCRD35                                                         
         TM    0(R1),FLTEXCL+FLTWILD+FLTLIST                                    
         BNZ   SETCRD32            LEAVE REQUEST ALONE                          
*                                                                               
         USING ACMD,R4                                                          
         CLI   CARDROUT,4          Don't clear for this                         
         BE    SETCRD35                                                         
         CLI   CARDROUT,1          IS IT QACCOUNT CASE                          
         BNE   SETCRD38                                                         
         L     R4,AMONACC                                                       
         TM    ACMINDS3,ACMIAPRS                                                
         BZ    SETCRD38            LEAVE REQUEST ALONE                          
         DROP  R4                                                               
*                                                                               
SETCRD32 SR    RF,RF                                                            
         IC    RF,CARDLEN                                                       
         BCTR  RF,0                                                             
         EXMVC RF,0(R6),SPACES     CLEAR REQUEST CARD                           
*                                                                               
SETCRD35 MVC   0(4,R8),0(R1)       SET FILTER ADDRESS AND INDICATORS            
         OI    0(R8),FLTCARD       REQUEST CARD OVER-RIDE (RECAP INFO)          
*                                                                               
SETCRD38 LA    R5,CARDLNQ(,R5)     BUMP UP                                      
         B     SETCRD10                                                         
*                                                                               
SETCRD40 LA    R0,8                EIGHT POSSIBLE ENTRIES                       
         LA    R4,ACQTYP1          FIRST ENTRY                                  
SETCRD42 CLI   0(R4),C' '                                                       
         BNH   SETCRD70            FINISHED                                     
         CLI   0(R4),ACQPID        C'I'                                         
         BNE   SETCRD51            NO, NEXT                                     
         MVC   PIDCODE,1(R4)       SAVE OFF PID CODE                            
         CLC   =C'RLP#=',1(R4)                                                  
         BNE   SETCRD45                                                         
         GOTOR =V(HEXIN),DMCB,6(R4),SECPSWD#,4         C'IRLP#=XXXX'            
         OI    REQIND,REQRLP       RLP request                                  
                                                                                
SETCRD45 CLC   =C'RLP=#',1(R4)     RLP request                                  
         BNE   SETCRD51                                                         
         MVC   SECPSWD#,6(R4)      C'IRLP=#'X'####'                             
         OI    REQIND,REQRLP       RLP request                                  
*                                                                               
SETCRD51 CLI   0(R4),ACQRCAP       RECAP OVER-RIDE                              
         BNE   *+10                                                             
         MVC   REQRECAP+1(MAXFMTS-1),2(R4)    MOVE IN FLAGS                     
*                                                                               
         CLI   0(R4),ACQDATE                                                    
         BNE   SETCRD52            LOOP TO NEXT                                 
         BAS   RE,SETDATE                                                       
*                                                                               
         USING ACMD,R1                                                          
SETCRD52 CLI   0(R4),ACQCNTR       CONTRA FILTER                                
         BNE   SETCRD54            LOOP TO NEXT                                 
         OI    THRSW,THRGFP        GLOBAL FILTER                                
         CLI   1(R4),C'('          COMMA DELIMITED PROFILE SETUP?               
         BNE   SETCRD54                                                         
         NI    THRSW,TURNOFF-THRGFP      NOT REALLY SURE YET                    
         L     R1,AMONACC                                                       
         NI    ACMCFIND,TURNOFF-ACMCFACT                                        
         B     SETCRD60                                                         
         DROP  R1                                                               
*                                                                               
SETCRD54 CLI   0(R4),ACQANAL                                                    
         BNE   SETCRD60            LOOP TO NEXT                                 
         CLI   1(R4),C'('          PROFILE SETUP?                               
         BE    SETCRD60            YES, SO SKIP                                 
         AHI   R4,L'ACQTYP1        BUMP UP ACCOUNT OR LIST FIELD                
         GOTO1 =A(LISTBLD),DMCB,(L'ACQFLT1,(R4)),(0,=C'UL'),0                   
         SHI   R4,L'ACQTYP1        RESET R4                                     
         CLI   0(R1),0             IF ZERO THEN NOT SET UP                      
         BE    SETCRD60            ERROR OCCURED                                
         LA    R5,CARDTAB2         LIST OF LEDGERS                              
         LA    RE,CARDLIST                                                      
         TM    0(R1),FLTLIST       IS IT +/- LIST, X'80'                        
         BO    SETCRD55                                                         
         OI    L'ACQTYP1(R4),X'40' IF EXCLUDE TURN ON FOR COMPARE               
         LA    RE,CARDACCT         IT IS AN ACCOUNT                             
*                                                                               
SETCRD55 CLI   0(R5),EOT           END OF TABLE?                                
         BE    SETCRD60            NO MATCH SO SKIP TO NEXT                     
         SR    RF,RF               MATCH ONLY UNIT                              
         CLI   1(R5),C' '          ANOTHER SPECIAL CASE                         
         BE    *+8                                                              
         LA    RF,1                MATCH UNIT/LEDGER                            
         EX    RF,0(RE)            TRY TO MATCH UNIT/LEDGER                     
         BE    SETCRD58            SAVE OFF ADDRESS                             
         AHI   R5,4                BUMP UP IN TABLE                             
         B     SETCRD55                                                         
*                                                                               
SETCRD58 SR    RE,RE               LOAD ADDRESS TO A(FILTER)                    
         ICM   RE,3,2(R5)          DISPLACEMENT TO FILTER LABLE                 
         A     RE,SVR5             ADD BASE     OF FORMAT                       
         MVC   0(4,RE),0(R1)       SAVE OFF ADDRESS OF LIST OR ACCOUNT          
         OI    0(RE),FLTCARD       REQUEST CARD OVER-RIDE (RECAP INFO)          
*                                                                               
SETCRD60 LA    R4,L'ACQFLT1+1(R4)  BUMP TO NEXT FIELD TYPE                      
         CHI   R0,4                END OF 3RD REQUEST CARD?                     
         BNE   *+8                 NO                                           
         LA    R4,ACQTYP5          POINT TO 4TH REQUEST CARD                    
         BCT   R0,SETCRD42                                                      
*                                                                               
SETCRD70 MVI   REQLOCST,X'FF'      SET TO NO FILTERING                          
         CLI   QPROG,MANPOWER                                                   
         BNE   SETCRD80                                                         
         CLI   ACQLOCS,C' '        ANY LOCATION STATUS SET ?                    
         BNH   SETCRD80            NO                                           
         MVC   BYTE,ACQLOCS                                                     
         MVI   REQLOCCC,BE         LOCATION STATUS CON-CODE (INCLUDE)           
         TM    BYTE,X'40'          EXCLUDE SET ?                                
         BO    *+12                NO                                           
         OI    BYTE,X'40'          MAY BE SET TO EXCLUDE                        
         MVI   REQLOCCC,BNE        LOCATION STATUS CON-CODE (EXCLUDE)           
*                                                                               
         LA    RE,LOCSTAB                                                       
         LA    RF,(LOCSTABX-LOCSTAB)/2                                          
SETCRD72 CLC   BYTE,1(RE)          MATCH REQUEST CARD WITH TABLE                
         BE    SETCRD74                                                         
         LA    RE,2(,RE)           NEXT ENTRY                                   
         BCT   RF,SETCRD72                                                      
         DC    H'00'               NOT A VAILD ENTRY IN REQUEST CARD            
*                                                                               
SETCRD74 MVC   REQLOCST,0(RE)      SAVE VALUE                                   
*                                                                               
SETCRD80 DS    0H                                                               
*                                                                               
SETCARDX XMOD1                                                                  
         SPACE 3                                                                
CARDLIST CLC   4(0,R1),0(R5)           MATCH LEDGER AGAINST PARM 2              
CARDACCT CLC   L'ACQTYP1(0,R4),0(R5)   MATCH LEDGER AGAINST REQ CARD            
SVUL     DS    CL2                                                              
         DROP  R3,R5                                                            
         EJECT                                                                  
LOCSTAB  DC    AL1(LOCSACT),C'A'                                                
         DC    AL1(LOCSTRM),C'T'                                                
         DC    AL1(LOCSLOA),C'L'                                                
         DC    AL1(LOCSTRAN),C'M'                                               
         DC    AL1(LOCSOTH),C'O'                                                
LOCSTABX DC    XL1'FF'                                                          
         EJECT                                                                  
***********************************************************************         
*  SET UP DATE INFORMATION BASED ON REQUEST CARD DATA                 *         
*      R4=REQUEST CARD DATE FIELD                                     *         
***********************************************************************         
         SPACE 1                                                                
         USING ACQTYP1,R4                                                       
SETDATE  NTR1                                                                   
*&&UK                                                                           
         OI    DATEFLT,DATEEST                                                  
         CLI   ACQDTTYP,ACQDTEST           Estimate date ?                      
         JE    SETDTE04                      Yes                                
         NI    DATEFLT,TURNOFF-DATEEST       No, so turn off                    
*&&                                                                             
         OI    DATEFLT2,DATEAPR                                                 
         CLI   ACQDTTYP,ACQDTAPR           Approver  date ?                     
         JE    SETDTE02                      Yes                                
         NI    DATEFLT2,TURNOFF-DATEAPR      No, so turn off                    
         OI    DATEFLT2,DATEPRE                                                 
         CLI   ACQDTTYP,ACQDTPRE           Preparer date ?                      
         JE    SETDTE02                      Yes                                
         NI    DATEFLT2,TURNOFF-DATEPRE      No, so turn off                    
         OI    DATEFLT2,DATETAPR                                                
         CLI   ACQDTTYP,ACQDTSAP           Timesheet Approver date?             
         JE    SETDTE02                      Yes                                
         NI    DATEFLT2,TURNOFF-DATETAPR     No, so turn off                    
         CLI   QPROG,MANPOWER                                                   
         JNE   SETDTE08                                                         
         CLI   ACQDTTYP,ACQDTSSD           Timesheet Submitted date?            
         JNE   SETDTE08                    No                                   
         OI    DATEFLT2,DATETSBD           Yes                                  
*                                                                               
SETDTE02 CLI   QPROG,MANPOWER                                                   
         BE    SETDTE04                                                         
         LA    R2,1                Packed                                       
         LA    R5,RQS_EST          Start                                        
         LA    R6,RQE_EST          End                                          
         OI    ESTIND,ESTRCUR      Read current estimate data                   
         B     SETDTE90                                                         
*                                                                               
SETDTE04 LA    R2,1                Appr date for person                         
         LA    R5,ALTNSTR                                                       
         LA    R6,ALTNEND                                                       
         B     SETDTE90                                                         
*                                                                               
SETDTE08 CLI   ACQDTTYP,ACQDTITF   Interface date ?                             
         BNE   SETDTE10                                                         
         OI    DATEFLT,DATEITF     INTERFACE DATE FILTERING                     
         LA    R2,2                Compressed                                   
         LA    R5,INTRSTR                                                       
         LA    R6,INTREND                                                       
         B     SETDTE90                                                         
*                                                                               
SETDTE10 CLI   ACQDTTYP,ACQDTREL   OVER-RIDE RELATIVE DATE ?                    
         BNE   SETDTE15                                                         
         LA    R2,3                Binary                                       
         LA    R6,RQRELEND                                                      
         B     SETDTE92                                                         
*                                                                               
SETDTE15 CLI   ACQDTTYP,ACQDTMOS   MEDIA MONTH OF SERVICE?                      
         BNE   SETDTE20                                                         
         LA    R2,1                                                             
         LA    R5,RQMMOSST                                                      
         LA    R6,RQMMOSEN                                                      
         B     SETDTE90                                                         
*                                                                               
SETDTE20 DS    0H                                                               
         CLI   ACQDTTYP,ACQDTCHK   CHECK DATE?                                  
         BNE   *+8                                                              
         OI    DATEFLT,DATECHK     CHECK DATE FILTERING                         
         CLI   ACQDTTYP,ACQDTDEP   DEPOSIT DATE?                                
         BNE   *+8                                                              
         OI    DATEFLT,DATEDEP     DEPOSIT DATE FILTERING                       
         CLI   ACQDTTYP,ACQDTUTL   UTILIZE DATE?                                
         BE    *+8                                                              
         CLI   ACQDTTYP,ACQDTBIL   OLD DATE TYPE? TO BE REMOVED                 
         BNE   *+8                                                              
         OI    DATEFLT,DATEBIL     UTILIZE DATE FILTERING                       
*                                                                               
         CLI   QPROG,MANPOWER                                                   
         JE    SETDTE22                                                         
*                                                                               
         CLI   ACQDTTYP,ACQDTSTM   STATEMENT DATE ?                             
         BNE   *+8                                                              
         OI    DATEFLT,DATESTM     STATEMENT DATE FILTERING                     
*                                  NOTE: ACQDTSTM = ACQDTOPN (reused)           
SETDTE22 CLI   ACQDTTYP,ACQDTOPN   OPEN DATE?                                   
         BNE   *+8                                                              
         OI    DATEFLT,DATEOPN     OPEN DATE FILTERING                          
         CLI   ACQDTTYP,ACQDTCLS   CLOSED DATE?                                 
         BNE   *+8                                                              
         OI    DATEFLT,DATECLS     CLOSED DATE FILTERING                        
         CLI   ACQDTTYP,ACQDTHIR   HIRE DATE?                                   
         BNE   *+8                                                              
         OI    DATEFLT,DATEHIR                                                  
         CLI   ACQDTTYP,ACQDTTRM   TERMINATION DATE?                            
         BNE   *+8                                                              
         OI    DATEFLT2,DATETRM                                                 
         CLI   ACQDTTYP,ACQDTXMT   TRANSMIT    DATE?                            
         BNE   *+8                                                              
         OI    DATEFLT,DATEXMT                                                  
         CLI   ACQDTTYP,ACQDTPOA   PO approval date                             
         BNE   *+8                                                              
         OI    DATEFLT2,DATEPOAD                                                
         LA    R2,1                                                             
         LA    R5,ALTNSTR                                                       
         LA    R6,ALTNEND                                                       
*                                                                               
SETDTE90 CLC   ACQDTSTR,SPACES     ANY INPUT?                                   
         BE    SETDTE92                                                         
         GOTO1 DATCON,DMCB,(0,ACQDTSTR),((R2),(R5))                             
*                                                                               
SETDTE92 CLC   ACQDTEND,SPACES     ANY INPUT?                                   
         BE    SETDTE99                                                         
         GOTO1 DATCON,DMCB,(0,ACQDTEND),((R2),(R6))                             
*                                                                               
SETDTE99 XIT1                                                                   
         SPACE 1                                                                
         DROP  R4,R7                                                            
         LTORG                                                                  
         EJECT                                                                  
         DS    0F                                                               
         DC    C'**CARD**'     (SEE CARDD IN ACREPRLWRK)                        
CARDTAB1 DC    AL1(12,CARDCLR+CARDPROF+CARDDLNK,1)                              
         DC    AL2(ACQACT-ACQD,QACCOUNT-ACWORKD,AFLTACC-FMTRECD)                
         DC    AL1(01,0,4),AL2(ACQTYP1-ACQD,0,AFLTCTRA-FMTRECD)                 
         DC    AL1(01,0,4),AL2(ACQTYP2-ACQD,0,AFLTCTRA-FMTRECD)                 
         DC    AL1(01,0,4),AL2(ACQTYP3-ACQD,0,AFLTCTRA-FMTRECD)                 
         DC    AL1(06,CARDPROF,2)                                               
         DC    AL2(ACQWRKLS-ACQD,QWRKLIST-ACWORKD,AFLTWC-FMTRECD)               
         DC    AL1(03,0,3)                                                      
         DC    AL2(ACQTTYPE-ACQD,QTRNSTYP-ACWORKD,AFLTTYPE-FMTRECD)             
*        DC    AL1(02,CARDCLR,4)                                                
*        DC    AL2(ACQOFFFL-ACQD,QOFFICE-ACWORKD,AFLTOFF-FMTRECD)               
         DC    AL1(02,0,0),AL2(ACQANOF-ACQD,0,AFLTANOF-FMTRECD)                 
         DC    AL1(01,0,0),AL2(ACQWCGRP-ACQD,0,AFLTWCGP-FMTRECD)                
         DC    AL1(01,0,0),AL2(ACQOFGRP-ACQD,0,AFLTOFGP-FMTRECD)                
         DC    AL1(02,0,0),AL2(ACQUSFLD-ACQD,0,AFLTUFLD-FMTRECD)                
         DC    AL1(04,0,0),AL2(ACQSTUTY-ACQD,0,AFLTSTTY-FMTRECD)                
         DC    AL1(EOT)                                                         
         SPACE 2                                                                
CARDTAB2 DS    0F                                                               
         DC    C'1C',AL2(AFLTCOST-FMTRECD)                                      
         DC    C'2P',AL2(AFLTPRSN-FMTRECD)                                      
         DC    C'2D',AL2(AFLTDEPT-FMTRECD)                                      
         DC    C'13',AL2(AFLTDEXP-FMTRECD)                                      
         DC    C'SV',AL2(AFLTVNDR-FMTRECD)                                      
         DC    C'SX',AL2(AFLTVNDR-FMTRECD)                                      
         DC    C'SY',AL2(AFLTVNDR-FMTRECD)                                      
         DC    C'SJ',AL2(AFLTCLI1-FMTRECD)                                      
         DC    C'SJ',AL2(AFLTCLI2-FMTRECD)                                      
         DC    C'3 ',AL2(AFLTPART-FMTRECD)                                      
         DC    AL1(EOT)                                                         
         TITLE 'FORMAT SECURITY'                                                
***********************************************************************         
*  GET FIELD CONTROLS AND TEST ACCESS FOR REQUEST                     *         
***********************************************************************         
         SPACE 1                                                                
         USING ACRL2D,R7                                                        
FMTSEC   NMOD1 0,**FSEC**                                                       
         L     RC,RLBASEC                                                       
         L     R7,AACRL2D                                                       
         XC    SECFLDR,SECFLDR     Set to no security (read)                    
         XC    SECFLDW,SECFLDW     Set to no security (write)                   
         SR    RF,RF                                                            
         L     R2,AIO2                                                          
         AH    R2,DATADISP                                                      
FMTSEC10 CLI   0(R2),0             END OF RECORD?                               
         BNE   *+6                                                              
         DC    H'00'                                                            
                                                                                
         CLI   0(R2),STYELQ        X'25' MATCH FOR ELEMENT                      
         BE    FMTSEC12                                                         
         IC    RF,1(,R2)           LENGTH OF ELEMENT                            
         AR    R2,RF                                                            
         B     FMTSEC10                                                         
*                                                                               
         USING STYELD,R2                                                        
FMTSEC12 MVC   SECKYW#1,STYSEC#1                                                
         MVC   SECPRF#5,STYSEC#5                                                
         DROP  R2                                                               
*                                                                               
         USING MASTD,R6                                                         
         L     R6,ADMASTC                                                       
         TM    DDLNKIND,DDLNKON+DDLNKTST                                        
         BNZ   FMTSEC14                                                         
*        BZ    FMTSEC13                                                         
*        TM    DDLNKIND,DDLNKGBL                                                
*        BZ    FMTSEC14                                                         
                                                                                
FMTSEC13 TM    MCRFHDR,MCRHOLD     Old style has terminal number (RLP)          
         BO    FMTSEC14            Yes                                          
         TM    MCRHINFO,MCRHDDS    DDS request terminal                         
         BZ    *+8                                                              
         OI    REQIND,REQDDS       DDS terminal                                 
         CLC   MCRHSAGY,SPACES     Has to be valid                              
         BNH   *+10                                                             
FMTSC13X MVC   SECALPHA,MCRHSAGY                                                
                                                                                
FMTSEC14 DS    0H                                                               
*&&UK                                                                           
         CLC   =C'DDS',PIDCODE                                                  
         BNE   FMTSEC16                                                         
         CLI   MCFACPAK,C'F'       LCSC                                         
         BE    FMTSECOK            YES - OK                                     
         CLI   MCFACPAK,C'T'       LTST                                         
         BE    FMTSECOK                                                         
         CLI   MCFACPAK,C'N'       FACNEW                                       
         BE    FMTSECOK                                                         
         CLI   MCFACPAK,C'S'       LTTS                                         
         BE    FMTSECOK                                                         
*&&                                                                             
FMTSEC16 MVC   PERAUTH#,=X'FFFF'   DEFAULT SECURITY                             
         TM    REQIND,REQRLP       RLP generated request ?                      
         BO    *+10                Yes so already have password                 
         MVC   SECPSWD#,MCRHPSWD                                                
                                                                                
         OC    SECPSWD#,SECPSWD#   IF 0 USE PIDCODE TO GET PSWD                 
         BZ    FMTSECOK            No Pid then allow to run                     
         DROP  R6                                                               
                                                                                
***********************************************************************         
* Read security records                                                         
***********************************************************************         
         USING SA0REC,R3                                                        
FMTSEC25 DS    0H                                                               
         CLC   SECPSWD#,=AL2(4096) DDS person                                   
         BH    FMTSEC28            No                                           
*&&US*&& MVC   SECALPHA,=C'#N'     Yes - take DDS over-ride                     
*&&UK*&& MVC   SECALPHA,=C'#E'     Yes - take DDS over-ride                     
         OI    REQIND,REQDDS       DDS requestor                                
                                                                                
FMTSEC28 LA    R3,IOKEY                                                         
         XC    SA0KEY,SA0KEY                                                    
         MVI   SA0KTYP,SA0KTYPQ    C'0'                                         
         MVC   SA0KAGY,SECALPHA                                                 
         MVC   SA0KNUM,SECPSWD#    Password special number                      
         L     R1,=AL4(IOREAD+IOCNTRL+IOAREA1)                                  
         GOTO1 AIO                                                              
         BNE   FMTSECOK            Okay for now                                 
                                                                                
         L     R3,AIO1                                                          
         LA    R3,SA0DATA          1st element                                  
         XC    PERAUTH#,PERAUTH#   Re-set to none                               
         SR    RF,RF                                                            
FMTSEC30 CLI   0(R3),0                                                          
         BE    FMTSEC50                                                         
*                                                                               
         USING SAPALD,R3                                                        
         CLI   0(R3),SAPALELQ      X'C3' PERSON ID                              
         BNE   *+10                                                             
         MVC   PIDCODE,SAPALPID                                                 
*                                                                               
         USING SASYSD,R3                                                        
         CLI   0(R3),SASYSELQ      X'21' SYSTEM AUTHORIZATION                   
         BNE   *+8                                                              
         CLI   SASYSNUM,X'06'      X'06' = ACCOUNTING                           
         BNE   FMTSEC45                                                         
*                                                                               
FMTSEC35 MVC   PERAUTH#,SASYSALL   DEFAULT SECURITY                             
         IC    RF,SASYSLN          GET ELEMENT LENGTH                           
         SHI   RF,SASYSLNQ         GET LENGTH OF VARIABLE DATA                  
         SHI   RF,3                BUMP BACK FROM END OF ELEMENT                
         BM    FMTSEC45            NO SECURITY BY PROGRAM                       
*                                                                               
FMTSEC40 LA    R2,SASYSPGM(RF)     RE-LOAD FROM BASE OF ELEMENT                 
*                                  SEE IF SET FOR SCRIBE SPECIFIC               
         USING SASYSPGM,R2                                                      
         CLI   SASYSPGM,X'0C'      PROGRAM = X'0C' = SCRIBE                     
         BNE   *+10                                                             
         MVC   PERAUTH#,SASYSAUT   PROGRAM AUTHOURIZATION SECURITY              
         SHI   RF,3                BUMP BACK FROM END OF ELEMENT                
         BNM   FMTSEC40            KEEP GOING UNTIL NEGATIVE                    
         DROP  R2                                                               
*                                                                               
FMTSEC45 SR    RF,RF                                                            
         IC    RF,1(,R3)                                                        
         AR    R3,RF                                                            
         B     FMTSEC30                                                         
*                                                                               
         USING SAPEREC,R3                                                       
FMTSEC50 LA    R3,IOKEY                                                         
         XC    SAPEKEY,SAPEKEY                                                  
         MVI   SAPETYP,SAPETYPQ    C'F'                                         
         MVI   SAPESUB,SAPESUBQ    X'04'                                        
         MVC   SAPEAGY,SECALPHA    SECURITY ALPHA CODE                          
         MVC   SAPEPID,PIDCODE                                                  
         L     R1,=AL4(IOHIGH+IOCNTRL+IOAREA1)                                  
         GOTO1 AIO                                                              
         L     R3,AIO1                                                          
         CLC   SAPEPID,PIDCODE     SAME PERSON?                                 
         BNE   FMTSECNO            CAN'T FIND PERSON, NO DEAL                   
*                                                                               
         LA    R3,SAPEDATA         FIRST ELEMENT                                
         SR    R1,R1                                                            
         XC    SECGROUP,SECGROUP                                                
FMTSEC55 CLI   0(R3),EOR                                                        
         BE    FMTSEC60                                                         
*                                                                               
         USING SAAGCD,R3                                                        
         CLI   0(R3),SAAGCELQ      X'C8' ACCESS GROUP                           
         BNE   *+10                                                             
         MVC   SECGROUP,SAAGCNUM   ACCESS GROUP NUMBER                          
         IC    R1,1(,R3)                                                        
         AR    R3,R1                                                            
         B     FMTSEC55                                                         
*                                                                               
*MTSEC60 OC    SECKYW#1,SECKYW#1   KEYWORD SECURITY ON FORMAT                   
*        BNZ   *+10                                                             
*        OC    SECPRF#5,SECPRF#5   PROFILE SECURITY ON FORMAT                   
*        BZ    FMTSECOK            NO SECURITY SO OK                            
*                                                                               
         USING SAFCREC,R3                                                       
FMTSEC60 LA    R3,IOKEY            GET ACCESS FOR FIELDS                        
         XC    SAFCKEY,SAFCKEY                                                  
         MVI   SAFCTYP,SAFCTYPQ    C'F'                                         
         MVI   SAFCSUB,SAFCSUBQ    X'16'                                        
         MVC   SAFCAGY,SECALPHA    SECURITY AGENCY ALPHA                        
         MVI   SAFCOVS,X'06'       ACCOUNTING SYSTEM                            
         MVI   SAFCPGM,X'0C'       SCRIBE PROGRAM                               
         L     R1,=AL4(IOREAD+IOCNTRL+IOAREA1)                                  
         GOTO1 AIO                                                              
         BNE   FMTSECOK            No security then                             
*        BNE   FMTSECNO            MUST  HAVE  AGENCY LEVEL                     
         MVI   ELCODE,SAFCWELQ     X'BD' FIELD WRITE ACCESS ELEMENT             
         MVI   SECIND1,SECIAGY                                                  
         BAS   RE,MERGBIT                                                       
         MVI   ELCODE,SAFCRELQ     X'BE' FIELD READ  ACCESS ELEMENT             
         MVI   SECIND1,SECIAGY                                                  
         BAS   RE,MERGBIT                                                       
*                                                                               
         MVC   SAFCUID,ORIGINUM    USER ID                                      
         L     R1,=AL4(IOREAD+IOCNTRL+IOAREA1)                                  
         GOTO1 AIO                                                              
         BNE   FMTSEC65                                                         
         MVI   ELCODE,SAFCWELQ     X'BD' FIELD WRITE ACCESS ELEMENT             
         BAS   RE,MERGBIT                                                       
         MVI   ELCODE,SAFCRELQ     X'BE' FIELD READ  ACCESS ELEMENT             
         BAS   RE,MERGBIT                                                       
*                                                                               
FMTSEC65 MVC   SAFCAGN,SECGROUP    ACCESS GROUP                                 
         L     R1,=AL4(IOREAD+IOCNTRL+IOAREA1)                                  
         GOTO1 AIO                                                              
         BNE   FMTSEC67                                                         
         MVI   ELCODE,SAFCWELQ     X'BD' FIELD WRITE ACCESS ELEMENT             
         BAS   RE,MERGBIT                                                       
         MVI   ELCODE,SAFCRELQ     X'BE' FIELD READ  ACCESS ELEMENT             
         BAS   RE,MERGBIT                                                       
         B     FMTSEC70            GOT SECURITY BITS NOW CHECK THEM             
*                                                                               
FMTSEC67 XC    SAFCUID,SAFCUID     GROUP WITHOUT USER-ID                        
         MVC   SAFCAGN,SECGROUP                                                 
         L     R1,=AL4(IOREAD+IOCNTRL+IOAREA1)                                  
         GOTO1 AIO                                                              
         BNE   FMTSECOK            No security then                             
*        BNE   FMTSECNO            MUST  HAVE  THIS LEVEL,  IF NOT LAST         
         MVI   ELCODE,SAFCWELQ     X'BD' FIELD WRITE ACCESS ELEMENT             
         BAS   RE,MERGBIT                                                       
         MVI   ELCODE,SAFCRELQ     X'BE' FIELD READ  ACCESS ELEMENT             
         BAS   RE,MERGBIT                                                       
         DROP  R3                                                               
*                                                                               
FMTSEC70 SR    R3,R3                                                            
         ICM   R3,1,SECPRF#5       GET PROFILE BIT USED                         
         BZ    FMTSECOK            IF WE GOT THIS FAR, MUST BE OK               
         LA    R0,32                                                            
         LA    R2,1                SHIFT THIS BIT 32 TIMES                      
         MVI   BYTE,33             COUNT UP FROM 33 TO 40, START @ 33           
*                                                                               
FMTSEC82 LR    RF,R2               USE RF, NOT TO DESTROY R2                    
         NR    RF,R3               WAS BIT ON?                                  
         BZ    FMTSEC85            NO, CHECK NEXT BIT                           
         GOTOR VALFLDN,BYTE        VALIDATE SECURITY FIELD NUMBER               
         BL    FMTSECNO            ACCESS NOT ALLOWED                           
*                                                                               
FMTSEC85 SLL   R2,1                SHIFT BIT UP                                 
         IC    RF,BYTE                                                          
         AHI   RF,1                COUNT UP BY ONE                              
         STC   RF,BYTE                                                          
         BCT   R0,FMTSEC82         TRY AGAIN                                    
         B     FMTSECOK            GOT THIS FAR, SO OK                          
                                                                                
FMTSECNO MVI   ERROR#,10                                                        
FMTSECOK XMOD1                                                                  
         EJECT ,                                                                
***********************************************************************         
* MERGE FIELD BIT ACCESS ELEMENT DATA                                 *         
*       R3     = A(SECURITY RECORD WITH DATA)                         *         
*       ELCODE = ELEMENT TO FIND AND PROCESS                          *         
***********************************************************************         
         SPACE 1                                                                
         USING SAFCREC,R3                                                       
MERGBIT  NTR1                                                                   
         SR    RF,RF                                                            
         L     R3,AIO1                                                          
         LA    R3,SAFCDATA                                                      
         LA    R1,SECFLDW          WRITE ACCESS FIELD                           
         LA    RE,SAFCWLNQ         LENGTH OF ELEMENT DATA                       
         CLI   ELCODE,SAFCWELQ     X'BD'                                        
         BE    MERGB10                                                          
         LA    R1,SECFLDR          READ  ACCESS FIELD                           
         LA    RE,SAFCRLNQ         LENGTH OF ELEMENT DATA                       
         CLI   ELCODE,SAFCRELQ     X'BE'                                        
         BE    MERGB10                                                          
         DC    H'00'                                                            
*                                                                               
MERGB10  CLI   0(R3),EOR           END OF RECORD?                               
         BNE   *+6                                                              
         DC    H'00'                                                            
         IC    RF,1(,R3)           RF CLEARED ABOVE, RF=LEN OF ELEMENT          
         CLC   ELCODE,0(R3)        MATCH FOR ELEMENT                            
         BE    MERGB12                                                          
         AR    R3,RF                                                            
         B     MERGB10                                                          
*                                                                               
MERGB12  XC    SECBITS,SECBITS                                                  
         SR    RF,RE               RF = LENGTH OF DATA                          
         BZ    MERGB20             NO ACCESS                                    
         AR    RE,R3               RE = POINT  TO DATA                          
         BCTR  RF,0                LESS 1 FOR EXMVC                             
         EXMVC RF,SECBITS,0(RE)                                                 
*                                                                               
MERGB20  NC    0(L'SECBITS,R1),SECBITS                                          
         TM    SECIND1,SECIAGY     AGENCY LEVEL                                 
         BZ    MERGB90                                                          
         MVC   0(L'SECBITS,R1),SECBITS                                          
         NI    SECIND1,TURNOFF-SECIAGY                                          
MERGB90  B     SECEXIT                                                          
         DROP  R7                                                               
         EJECT                                                                  
SECBITS  DS    XL32                TEMPORAY BIT TABLE                           
SECIND1  DS    XL1                                                              
SECIAGY  EQU   X'01'               AGENCY LEVEL RECORD                          
                                                                                
         LTORG                                                                  
***********************************************************************         
* VALIDATE SECURITY FIELD NUMBER AGAINST ACCESS BITS                  *         
*       BYTE   = FIELD NUMBER TO CHECK                                *         
***********************************************************************         
         SPACE 1                                                                
         USING ACRL2D,R7                                                        
VALFLDN  NTR1  BASE=*,LABEL=*                                                   
         L     R7,AACRL2D                                                       
         SR    R0,R0                                                            
         ICM   R0,1,0(R1)          Get field number                             
         BZ    VALFLDEQ            No security set                              
         OC    SECPSWD#,SECPSWD#   Password supplied ?                          
         BNZ   VALFLD10            Keep going                                   
                                                                                
         USING MASTD,R6                                                         
         L     R6,ADMASTC                                                       
         TM    MCRHINFO,MCRHONL    On-line ?                                    
         BZ    VALFLDEQ            Programmer ?                                 
         DROP  R6                                                               
                                                                                
VALFLD10 LR    RF,R0               *** WRITE FIELD VALUES ***                   
         SRL   RF,3                FINDS WHICH BYTE OUT OF 32 BYTES             
         LA    R1,SECFLDW(RF)      POINT TO BYTE TO CHECK BITS                  
         LA    RE,X'07'            MASK BITS                                    
         NR    RE,R0                                                            
         LA    RF,X'80'                                                         
         SRL   RF,0(RE)            SET BIT MASK VALUE                           
         EX    RF,*+8                                                           
         BO    VALFLDEQ            OK TO WRITE SET EQUAL                        
         TM    0(R1),0                                                          
*                                  *** READ FIELD VALUES ***                    
         LR    RF,R0               RELOAD BYTE VALUE                            
         SRL   RF,3                FINDS WHICH BYTE OUT OF 32 BYTES             
         LA    R1,SECFLDR(RF)      POINT TO BYTE TO CHECK BITS                  
         LA    RE,X'07'            MASK BITS                                    
         NR    RE,R0                                                            
         LA    RF,X'80'                                                         
         SRL   RF,0(RE)            SET BIT MASK VALUE                           
         EX    RF,*+8                                                           
         BO    VALFLDHI            OK TO READ, SET HIGH                         
         TM    0(R1),0                                                          
*                                                                               
VALFLDLO LA    RF,0                SET CC = LOW                                 
         J     VALFLDX                                                          
VALFLDEQ LA    RF,1                SET CC = EQUAL                               
         J     VALFLDX                                                          
VALFLDHI LA    RF,2                SET CC = HIGH                                
VALFLDX  CHI   RF,1                                                             
         XIT1                                                                   
*                                                                               
SECEXIT  XIT1                                                                   
         DROP  R7                                                               
                                                                                
         LTORG                                                                  
         EJECT                                                                  
         TITLE 'CHECK MESSAGE ELEMENTS FOR ERROR TYPE MESSAGES'                 
***********************************************************************         
*  CHECK MESSAGE ELEMENTS FOR ERROR TYPE MESSAGES                     *         
*                                                                     *         
*  OUTPUT:                                                            *         
*    CONDITION CODE SET:                                              *         
*      EQUAL     - 'E' TYPE MESSAGE FOUND                             *         
*      NOT EQUAL - 'E' TYPE MESSAGE NOT   FOUND                       *         
***********************************************************************         
         SPACE 1                                                                
         USING MNOELD,R1           MESSAGE ELEMENT                              
WARNP    USING MNOMLN,R2           MESSAGE NUMBER  PORTION                      
         SPACE 1                                                                
CKMSGERR NMOD1 0,***CMNO***                                                     
         L     RC,RLBASEC                                                       
         SR    R6,R6               NO      ERRORS  FOUND                        
         SR    RF,RF               CLEAR   REGISTER                             
         L     R1,AIO2             ->      RECORD                               
         AH    R1,DATADISP                                                      
*                                                                               
CKMSG10  DS    0H                                                               
         CLI   0(R1),0             END     OF      RECORD  ?                    
         BE    CKMSGEX             YES,    ELEMENT NOT     FOUND                
         CLI   MNOEL,MNOELQ        MESSAGE ELEMENT ?                            
         BE    CKMSG30             YES,    CHECK   MESSAGE ELEMENT              
*                                                                               
CKMSG20  DS    0H                  FIND    NEXT    ELEMENT                      
         IC    RF,MNOLN            GET     ELEMENT LENGTH                       
         AR    R1,RF               ->      NEXT    ELEMENT                      
         B     CKMSG10             TEST    NEXT    ELEMENT                      
*                                                                               
CKMSG30  DS    0H                  CHECK   MESSAGE ELEMENT                      
         LA    R2,MNOLN1Q(,R1)     SET     UP      WARNP                        
         SR    R3,R3               CLEAR   REGISTER                             
         LA    R4,R1               ->      MESSAGE ELEMENT                      
         IC    RF,MNOLN            MESSAGE ELEMENT LENGTH                       
         AR    R4,RF               ->      NEXT    ELEMENT                      
*                                                                               
CKMSG40  DS    0H                  CHECK   FOR     MESSAGE TYPE ERROR           
         CLI   WARNP.MNOMTYPE,MNOMTERR                                          
         BNE   CKMSG50             NO,     GET     NEXT    MSG  ID              
         LA    R6,1                SAY     ERRORS  FOUND                        
         B     CKMSGEX             EXIT                                         
*                                                                               
CKMSG50  DS    0H                                                               
         IC    R3,WARNP.MNOMLN     GET     MESSAGE LENGTH                       
         AR    R2,R3               ->      NEXT    MESSAGE                      
         CR    R2,R4               FOUND   NEXT    MESSAGE ?                    
         BL    CKMSG40             YES,    CHECK   IT                           
         B     CKMSG20             NOT     FOUND,  PROCESS NEXT ELEMENT         
*                                                                               
CKMSGEX  DS    0H                                                               
         LTR   R6,R6               SET     CONDITION       CODE                 
         XMOD1 ,                   RETURN                                       
         DROP  R1,WARNP                                                         
         SPACE 3                                                                
         LTORG                                                                  
         TITLE 'FIND KEYWORD IN TABLE'                                          
***********************************************************************         
*  GET KEYWORD FROM TABLE, RETURN ADDRESS IN R6                       *         
***********************************************************************         
         SPACE 1                                                                
         USING FMTRECD,R5                                                       
         USING KYWD,R6                                                          
KYWFIND  NMOD1 0,**KYWF**                                                       
         L     RC,RLBASEC                                                       
         L     R6,KYWBASE          START OF KEYWORDS                            
*                                                                               
KYWF10   OC    KYWCODE,KYWCODE     IS IT END OF TABLE                           
         BZ    KYWF20              YES SO SEE IT USER DEFINED KEYWORD           
         OC    KEYWRD#,KEYWRD#                                                  
         BZ    KYWF15                                                           
         CLC   KYWDD#,KEYWRD#                                                   
         BNE   KYWF18              GET NEXT                                     
         CLI   XDATA,0                                                          
         BE    KYWF70              NO MORE TO CHECK, FOUND KEYWORD              
         CLC   XDATA,KYWTAB#       MATCH LEVEL                                  
         BNE   KYWF18              CLOSE BUT NO CIGAR                           
         B     KYWF70                                                           
*                                                                               
KYWF15   CLC   FINDDATA,KYWCODE    MATCH KEYWORD TO TABLE ENTRY                 
         BE    KYWF70              YES FOUND, SET CONDITIONS                    
*                                                                               
KYWF18   LA    R6,KYWLNQ(,R6)      NO, BUMP TO NEXT ENTRY IN TABLE              
         B     KYWF10                                                           
*                                                                               
         USING KWDRECD,R4                                                       
KYWF20   LA    R4,IOKEY                                                         
         MVC   KWDKEY,SPACES                                                    
         MVI   KWDKTYP,KWDKTYPQ    X'2D'                                        
         MVI   KWDKSUB,KWDKSUBQ    X'06'                                        
         MVC   KWDKCPY,RCCOMPFL    COMPANY CODE                                 
         MVC   KWDKCODE,FINDDATA   USER DEFINDED KEYWORD                        
         L     R1,=AL4(IOREAD+IOACFIL+IOAREA3)                                  
         GOTO1 AIO                                                              
         BE    *+8                                                              
         MVI   ERROR#,6            NOT FOUND IN TABLE (UT-OH)                   
         SR    R6,R6               SET CON CODE TO NOT EQUAL                    
         B     KYWFXIT                                                          
         DROP  R4                                                               
*                                                                               
KYWF70   SR    R2,R2                                                            
         ICM   R2,3,KYWDD#                                                      
*&&US*&& CHI   R2,AC#RSPNM                 Period number                        
*&&UK*&& C     R2,=AL4(AC#RSPNM)           Period number                        
         BNE   *+8                                                              
         OI    POSTCTL,POSTPED#                                                 
                                                                                
         TM    KYWIND1,KYWXUL      EXCLUDE CONTRA UNIT/LEDGER?                  
         BZ    *+8                                                              
         MVI   XCULFLAG,YES                                                     
         TM    KYWIND1,KYWUNQ      IS THERE UNIQUE DATA?                        
         BZ    *+8                                                              
         MVI   UNIFLAG,YES         SET TO PUT ON REC/TRANS                      
         OC    CUROPT,KYWIND2      TURN ANY THAT APPLY                          
         TM    KYWIND3,KYWTRNS     PROCESS TRANSACTIONS                         
         BZ    KYWF72                                                           
         OI    POSTLVL,POSTDET                                                  
                                                                                
KYWF72   TM    KYWIND3,KYWSUBA     PROCESS SUBACCT/HISTORY                      
         BZ    *+12                                                             
         OI    POSTLVL,POSTHST                                                  
         OI    POSTLVL2,POSTCAC                                                 
*                                                                               
         USING ACMD,R1                                                          
         CHI   R2,AC#CFLTC         Contra filter keyword ?                      
         BNE   KYWF75                                                           
         L     R1,AMONACC                                                       
         OI    ACMCFIND,ACMCCFLT   Set to process contra filters                
         DROP  R1                                                               
*                                                                               
KYWF75   TM    KYWIND4,KYWBYDTE    Post sort records by dates                   
         BZ    *+8                 No                                           
         OI    POSTCTL,POSTBYDT    Yes                                          
*                                                                               
         TM    KYWIND4,KYWOKREV    Okay to reverse signs ?                      
         BZ    *+8                 No                                           
         OI    FMTFLAG,FMTOKREV    Yes                                          
*                                                                               
         CHI   R2,AC#RSTXI         TAX2C                                        
         BNE   *+8                                                              
         OI    RECREAD3,RECTAX2C   Yes                                          
*                                                                               
*&&US                                                                           
         CHI   R2,AC#RSLMG         LMGR keywords?                               
         BE    KYWF75D                                                          
         CHI   R2,AC#RSLEM                                                      
         BE    KYWF75D                                                          
         CHI   R2,AC#RSLPI                                                      
         BE    KYWF75D                                                          
*&&                                                                             
*&&UK                                                                           
         C     R2,=AL4(AC#RSLMG)                                                
         BE    KYWF75D                                                          
         C     R2,=AL4(AC#RSLEM)                                                
         BE    KYWF75D                                                          
         C     R2,=AL4(AC#RSLPI)                                                
         BE    KYWF75D                                                          
*&&                                                                             
         B     *+8                                                              
KYWF75D  OI    RECREAD3,RECTMLM                                                 
*&&US                                                                           
         CHI   R2,AC#RSAP          AP keywords                                  
         BE    KYWF75R                                                          
         CHI   R2,AC#RSAPI         APPID                                        
         BE    KYWF75R                                                          
         CHI   R2,AC#RSAEM         APEML                                        
         BE    KYWF75R                                                          
         CHI   R2,AC#RSAPD         APDTE keyword                                
         BE    KYWF75R                                                          
         CHI   R2,AC#RSSBD         SBDTE keyword                                
         BE    KYWF75R                                                          
         CHI   R2,AC#RSSEM         SBEML keyword                                
         BNE   *+8                                                              
KYWF75R  OI    RECREAD3,RECTMAUD                                                
*&&                                                                             
*&&US*&& CHI   R2,AC#RSPOA         POA keyword                                  
*&&UK*&& C     R2,=AL4(AC#RSPOA)   POA keyword                                  
         BE    *+12                                                             
*&&US*&& CHI   R2,AC#RSPAD         POAD keyword                                 
*&&UK*&& C     R2,=AL4(AC#RSPAD)   POAD keyword                                 
         BNE   *+8                                                              
         OI    RECREAD3,RECPOAP                                                 
                                                                                
*&&US*&& CHI   R2,AC#RSPE$         PEEL$ KEYWORD ?                              
*&&UK*&& C     R2,=AL4(AC#RSPE$)   (UK) Number is > x'7FFF'                     
         BNE   KYWF76                                                           
         OI    RECREAD1,RECPEEL                                                 
         CLI   NEWOFF,YES                                                       
         BNE   KYWF76                                                           
         MVI   FCRDOFA,YES                                                      
*                                                                               
KYWF76   CLI   KYWREAD,0                                                        
         BE    KYWF85                                                           
         CLI   KYWREAD,KYWPEFD     Personal effecitive date keyword             
         BNE   KYWF78                                                           
         OI    FMTSPKYW,FMTKPEFD   Indicate found this type                     
*                                                                               
KYWF78   CLI   KYWREAD,KYWLVL4     level 4 special becaue it is mode 44         
         BE    KYWF80              Not between level 1-3 (Modes 33-35)          
         CLI   KYWREAD,KYWLVL1                                                  
         BL    KYWF81                                                           
         CLI   KYWREAD,KYWLVL3                                                  
         BH    KYWF81                                                           
*                                                                               
KYWF80   CLC   FMTLEVMX,KYWREAD    Only move in if higher                       
         BNL   KYWF81                                                           
         MVC   LEVKYWD,KYWREAD     Level of keyword used                        
         MVC   FMTLEVMX,KYWREAD    Move in level number                         
*                                                                               
KYWF81   CLI   KYWREAD,KYWPART                                                  
         BNE   *+8                                                              
         OI    FMTFLAG,FMTPART     Partial payment                              
*&&UK                                                                           
         CLI   KYWREAD,KYWCLPO     Read account extension record                
         BNE   *+8                                                              
         OI    RECREAD3,RECAEXRD                                                
*&&                                                                             
         CLI   KYWREAD,KYWREST     Read estimate records                        
         BNE   *+8                                                              
         OI    RECREAD3,RECAESTS                                                
*&&UK                                                                           
         CLI   KYWREAD,KYWXDAT     Read xdata on transaction                    
         BNE   *+8                                                              
         OI    RECREAD3,RECXDATA                                                
*&&                                                                             
         CLI   KYWREAD,KYWPORD     Read purchase orders                         
         BNE   KYWF81A                                                          
         OI    RECREAD2,RECPORD    Yes                                          
         CHI   R2,AC#RSOWC         POWC keyword                                 
         BE    KYWF81B                                                          
         CHI   R2,AC#RSOWC         POWN keyword                                 
         BE    KYWF81B                                                          
*                                                                               
KYWF81A  CLI   KYWREAD,KYWWKCD     Read workcode names                          
         BNE   *+8                                                              
KYWF81B  MVI   FCWCNAME,YES                                                     
*                                                                               
         CLI   KYWREAD,KYWFLTR     Read filter names?                           
         BNE   *+8                                                              
         MVI   FCGTFILT,YES        Set to read filter names                     
*                                                                               
         CLI   QPROG,PRODUCTION                                                 
         BNE   KYWF82                                                           
*                                                                               
         CLI   KYWREAD,KYWSTUD     Read agency studio pointers                  
         BNE   *+8                                                              
         OI    RECREAD1,RECSTUD                                                 
*&&US                                                                           
         CLI   KYWREAD,KYWPBIL     Pre-read billing                             
         BNE   *+8                 No                                           
         OI    RECREAD2,REC99WC    Read 99 trans                                
         CLI   KYWREAD,KYWAUTH     Read authorization record                    
         BNE   *+8                                                              
         OI    RECREAD2,RECAUTH                                                 
         CHI   R2,AC#AUTH$         Authorization $ doesn't accum                
         BNE   *+8                                                              
         OI    FMTFLAG2,FMTALVL$                                                
         CHI   R2,AC#FUND$         Funded $ doesn't accum                       
         BNE   *+8                                                              
         OI    FMTFLAG2,FMTALVL$                                                
*&&                                                                             
         CLI   KYWREAD,KYWORGE     Read original EST record?                    
         BNE   *+8                                                              
         OI    ESTIND,ESTRORG                                                   
*                                                                               
         CLI   KYWREAD,KYWCURE     Read original EST record?                    
         BNE   *+8                                                              
         OI    ESTIND,ESTRCUR                                                   
*                                                                               
         CLI   KYWREAD,KYWJSTA     Read estimates for job status                
         BNE   *+8                                                              
         OI    ESTIND,ESTJSTAT                                                  
*                                                                               
         CLI   KYWREAD,KYWHREV     Read current EST record?                     
         BNE   *+8                                                              
         OI    ESTIND,ESTRHR                                                    
*                                                                               
         CLI   KYWREAD,KYWEXCP     Exception keyword used ?                     
         BNE   *+8                                                              
         OI    ESTIND,ESTRGES      Yes                                          
*                                                                               
         CLI   KYWREAD,KYWPRNP     Read planning # EST record ?                 
         BNE   *+8                 No                                           
         OI    ESTIND,ESTPRN       Yes, need planning data                      
*                                                                               
         CLI   KYWREAD,KYWPRNR     Read revision # EST records ?                
         BNE   *+8                 No                                           
         OI    ESTIND,ESTPRN       Yes, need revison records                    
*                                  It was disabled by JFOS lvl 38               
         CLI   KYWREAD,KYWREST     Read for estimates on job ?                  
         BNE   *+8                 No                                           
         OI    ESTIND,ESTNOS       Yes, need estimates                          
*                                                                               
KYWF82   CLI   QPROG,MANPOWER      Person Scribe ?                              
         BNE   KYWF85              No                                           
*                                                                               
         CLI   KYWREAD,KYWP$AJ     Payroll adjusted                             
         BE    *+8                                                              
         CLI   KYWREAD,KYWTHRS     Read person total hours records ?            
         BNE   *+8                                                              
         OI    RECREAD2,RECTHRS    Yes                                          
         CLI   KYWREAD,KYWPERS     Read person records ?                        
         BNE   *+8                                                              
         OI    RECREAD1,RECPRSN    Yes                                          
         CLI   KYWREAD,KYWCNDR     Read calendar records ?                      
         BNE   *+8                                                              
         OI    RECREAD1,RECCLDR    Yes                                          
         CLI   KYWREAD,KYWSTDH     Read standard hours data ?                   
         BNE   *+8                                                              
         OI    RECREAD1,RECSTDH    Yes                                          
         CLI   KYWREAD,KYWEDTH     Read edit hours data ?                       
         BNE   *+8                                                              
         OI    RECREAD1,RECEDTH    Yes                                          
         CLI   KYWREAD,KYWCSTR     Read allocated rates ?                       
         BNE   *+8                                                              
         OI    RECREAD2,RECALRT    Yes                                          
                                                                                
         CLI   KYWREAD,KYWPAY$     Read payroll dollars or rates ?              
         BE    *+8                                                              
         CLI   KYWREAD,KYWP$AJ                                                  
         BNE   KYWF85                                                           
         OI    PHISIND,PHISON      Set to process for this format               
         OI    GHISIND,GHISON      Set global                                   
                                                                                
KYWF85   CLI   KYWREAD,KYWCST$     Read allocated dollars ?                     
         BNE   *+8                                                              
         OI    RECREAD2,RECALO$    Yes                                          
*&&US                                                                           
CUR      USING RCLELD,R3                                                        
         L     R3,ACURCOL                 A(Current column working on)          
         TM    CUR.RCLOPT,RCLHIDE                                               
         BO    KYWF85C                                                          
*                                                                               
         TM    KYWIND5,KYWCR       Is keyword Credit related?                   
         BZ    *+8                  no, don't add dummy column                  
         OI    CFKIND,CFKCR                                                     
*                                                                               
         TM    KYWIND5,KYWDR       Is keyword Debit related?                    
         BZ    *+8                  no, don't add dummy column                  
         OI    CFKIND,CFKDR                                                     
*                                                                               
KYWF85C  CLI   KYWREAD,KYWPVND     Read Prod vendor info (CashFlow) ?           
         BNE   *+8                                                              
         OI    RECREAD2,RECPVND    Cashflow vendor keywords on report           
*                                                                               
         CLI   KYWREAD,KYWPRCV     Read Prod rcv info (CashFlow) ?              
         BNE   *+12                                                             
         OI    RECREAD2,RECPRCV    Yes                                          
         OI    CFKIND,CFKPRCV                                                   
*                                                                               
NEW      USING RCLELD,RE                                                        
         TM    CFKIND,CFKDDBAL+CFKDBBAL   Already added a dummy column?         
         BO    KYWF86                       yes                                 
         CHI   R2,AC#RSADA                                                      
         BE    *+12                                                             
         CHI   R2,AC#RSBAV                                                      
         BNE   KYWF86                                                           
*                                                                               
         TM    CFKIND,CFKDDBAL+CFKDBBAL   Already added a dummy column?         
         BNZ   KYWF85A                      yes                                 
*                                                                               
         GOTOR =A(CFWCOL),DMCB,A(AC#RSVDB)  Add Vendor daily balance            
         L     RE,0(,R1)                    A(Element added)                    
         ZIC   RF,NEW.RCLSEQ                                                    
         CVD   RF,DUB                                                           
         OI    DUB+L'DUB-1,X'0F'                                                
         UNPK  CFEOP1(2),DUB                                                    
         MVC   NEW.RCLPARA,CUR.RCLPARA                                          
         MVI   NEW.RCLDCMLS,1        Over-ride user even, no decimals           
         OI    NEW.RCLOPT2,RCLCZERO                                             
*                                                                               
         GOTOR =A(CFWCOL),DMCB,A(AC#RSDCD)  Add Vendor invoice amount           
         L     RE,0(,R1)                    A(Element added)                    
         ZIC   RF,NEW.RCLSEQ                                                    
         CVD   RF,DUB                                                           
         OI    DUB+L'DUB-1,X'0F'                                                
         UNPK  CFEOP2(2),DUB                                                    
         MVC   NEW.RCLPARA,CUR.RCLPARA                                          
         MVI   NEW.RCLDCMLS,1        Over-ride user even, no decimals           
         OI    NEW.RCLOPT2,RCLCZERO                                             
*                                                                               
KYWF85A  CHI   R2,AC#RSADA                                                      
         BNE   KYWF85B                                                          
*                                                                               
         GOTOR =A(CFWCOL),DMCB,A(AC#RSRDB)  Add Rcv daily balance               
         L     RE,0(,R1)                    A(Element added)                    
         ZIC   RF,NEW.RCLSEQ                                                    
         CVD   RF,DUB                                                           
         OI    DUB+L'DUB-1,X'0F'                                                
         UNPK  CFEOP3(2),DUB                                                    
         MVC   NEW.RCLPARA,CUR.RCLPARA                                          
         MVI   NEW.RCLDCMLS,1        Over-ride user even, no decimals           
         OI    NEW.RCLOPT2,RCLCZERO                                             
*                                                                               
         GOTOR =A(CFWCOL),DMCB,A(AC#RSCCD)  Add Net billing amount              
         L     RE,0(,R1)                    A(Element added)                    
         ZIC   RF,NEW.RCLSEQ                                                    
         CVD   RF,DUB                                                           
         OI    DUB+L'DUB-1,X'0F'                                                
         UNPK  CFEOP4(2),DUB                                                    
         MVC   NEW.RCLPARA,CUR.RCLPARA                                          
         MVI   NEW.RCLDCMLS,1        Over-ride user even, no decimals           
         OI    NEW.RCLOPT2,RCLCZERO                                             
         MVC   TEMPAREA(L'CFEXP),CFEXP      Save off expression                 
         OI    CFKIND,CFKDDBAL                 columns added                    
         B     KYWF86                                                           
*                                                                               
KYWF85B  GOTOR =A(CFWCOL),DMCB,A(AC#RSBDB)  Add Rcv daily balance - B           
         L     RE,0(,R1)                    A(Element added)                    
         ZIC   RF,NEW.RCLSEQ                                                    
         CVD   RF,DUB                                                           
         OI    DUB+L'DUB-1,X'0F'                                                
         UNPK  CFEOP3(2),DUB                                                    
         MVC   NEW.RCLPARA,CUR.RCLPARA                                          
         MVI   NEW.RCLDCMLS,1        Over-ride user even, no decimals           
         OI    NEW.RCLOPT2,RCLCZERO                                             
*                                                                               
         GOTOR =A(CFWCOL),DMCB,A(AC#RSBNC)  Add Net billing amount - B          
         L     RE,0(,R1)                    A(Element added)                    
         ZIC   RF,NEW.RCLSEQ                                                    
         CVD   RF,DUB                                                           
         OI    DUB+L'DUB-1,X'0F'                                                
         UNPK  CFEOP4(2),DUB                                                    
         MVC   NEW.RCLPARA,CUR.RCLPARA                                          
         MVI   NEW.RCLDCMLS,1        Over-ride user even, no decimals           
         OI    NEW.RCLOPT2,RCLCZERO                                             
         MVC   TEMPAREA+L'CFEXP(L'CFEXP),CFEXP Save off expression              
         OI    CFKIND,CFKDBBAL                 columns added                    
         DROP  NEW,CUR                                                          
*                                                                               
KYWF86   TM    CFKIND,CFKDAPP      Already added a dummy column?                
         BO    KYWF87                     yes                                   
         TM    CFKIND,CFKCR+CFKPRCV                                             
         BNO   KYWF87                     no, don't add dummy column            
         GOTO1 =A(CFWCOL),DMCB,A(AC#RSRCA)   Add RCAPP for cashflow             
         OI    CFKIND,CFKDAPP                   column added                    
*                                                                               
KYWF87   TM    CFKIND,CFKDBAPP     Already added a dummy column?                
         BO    KYWF88                    yes                                    
         TM    CFKIND,CFKDR+CFKPRCV                                             
         BNO   KYWF88                    no, don't add dummy column             
         GOTO1 =A(CFWCOL),DMCB,A(AC#RSRCB)  Add RCBAPP for cashflow             
         OI    CFKIND,CFKDBAPP                 column added                     
*                                                                               
KYWF88   CLI   KYWREAD,KYWPCSH     Read For all CashFlow info ?                 
         BNE   KYWF89                                                           
         OI    RECREAD2,RECPRCV    Yes                                          
         OI    RECREAD2,RECPVND    Yes                                          
*&&                                                                             
KYWF89   CHI   R2,AC#RSPYD         PAYDTE                                       
         BNE   KYWF90                                                           
         OI    PHISIND,PHISDATE    Payroll history date                         
         OI    GHISIND,GHISDATE    Set global                                   
*                                                                               
KYWF90   CHI   R2,AC#RSMTH         MONTH                                        
         BNE   *+8                                                              
         OI    FMTIND2,FMTYYMM                                                  
         CHI   R2,AC#RSRY1         YEAR                                         
         BNE   *+8                                                              
         OI    FMTIND2,FMTYYMM                                                  
*                                                                               
         C     R2,=AL4(AC#RSDTE)   Daily date keyword used                      
         BNE   *+8                                                              
         OI    FMTIND2,FMTDAILY                                                 
*&&UK                                                                           
         TM    KYWIND6,KYWITEM     Item keywords used                           
         BZ    *+8                                                              
         OI    FMTIND2,FMTITEM                                                  
         TM    KYWIND6,KYWMESYS    Keyword requires media system                
         BZ    KYWF91                                                           
         TM    DDLNKIND,DDLNKON+DDLNKTST   DDLink mode ?                        
         BZ    *+6                                                              
         DC    H'0'                No support this keyword under DDLink         
         OI    FMTIND2,FMTMESYS    Yes, open media file in REQF                 
*&&                                                                             
KYWF91   CHI   R2,AC#RSPYT         PAYTYP                                       
         BNE   KYWF92                                                           
         OI    PHISIND,PHISTYPE    Payroll history type (bucket)                
         OI    GHISIND,GHISTYPE    Global value (across formats)                
*                                                                               
KYWF92   CHI   R2,AC#RSPYC         Payroll history code                         
         BE    *+8                                                              
         CHI   R2,AC#RSPYN         Payroll history name                         
         BNE   KYWF96                                                           
         OI    PHISIND,PHISCDNM                                                 
         OI    GHISIND,GHISCDNM    Set global                                   
*                                                                               
KYWF96   CHI   R2,AC#RSMOA                                                      
         BNE   KYWF98                                                           
         OI    PHISIND,PHISMOA                                                  
         OI    GHISIND,GHISMOA                                                  
*        OI    GHISIND,GHISCDNM    Set global                                   
*                                                                               
KYWF98   DS    0H                                                               
*&&UK                                                                           
         CHI   R2,AC#RSCLM         CRLMT                          (UK)          
         BE    *+8                                                              
         CHI   R2,AC#RSICL         ICRLMT                         (UK)          
         BE    *+8                                                              
         C     R2,=AL4(AC#RSJFE)   Budget/Fee amount              (UK)          
         BNE   *+8                                                              
         OI    FMTFLAG2,FMTALVL$   Account level amounts wanted                 
*&&                                                                             
         TM    KYWIND3,KYWTAB      Build special tables ?                       
         BZ    KYWFXIT             No                                           
         CLI   KYWTAB#,KYWNOFF     Should we build office table ?               
         BNE   KYWF100             No                                           
         OI    BUILD,BUILDOFF      Yes build table of office names              
         CLI   QPROG,PRODUCTION    If production set level of process           
         BNE   KYWF100               to level 2 at minimum                      
         CLI   FMTLEVMX,KYWLVL2                                                 
         BNL   KYWF100                                                          
         MVI   FMTLEVMX,KYWLVL2    Set level 2                                  
*                                                                               
KYWF100  CLI   KYWTAB#,KYWEUFD     Build brand table ?                          
         BNE   *+8                                                              
         OI    BUILD,BUILDBRD      Yes                                          
         CLI   KYWTAB#,KYWSTYP     Build studio name table ?                    
         BNE   *+8                                                              
         OI    BUILD,BUILDSTU      Yes                                          
*                                                                               
         SR    R1,R1                                                            
         IC    R1,KYWTAB#          Get routine table number                     
         GOTO1 =A(NAMEBLD)         Build table                                  
*                                                                               
         CLI   KYWTAB#,KYWNMD1     Did we build this table ?                    
         BNE   KYWFXIT             No                                           
         CLI   QPROG,PRODUCTION    Is it production scribe ?                    
         BE    KYWFXIT             Yes                                          
         GOTO1 =A(NAMEBLD),KYWNMD2 Build 2nd table too                          
*                                                                               
KYWFXIT  XIT1  REGS=(R6)                                                        
         DROP  R5,R6                                                            
         EJECT                                                                  
*                                                                               
* Expression for Average days to disbursement (C00/C00)-(C00/C00)               
*                                                                               
CFEXP    DS    0CL19                                                            
         DC    C'(C'                                                            
CFEOP1   DC    C'00/C'                                                          
CFEOP2   DC    C'00)-(C'                                                        
CFEOP3   DC    C'00/C'                                                          
CFEOP4   DC    C'00)'                                                           
                                                                                
                                                                                
         LTORG                                                                  
         TITLE 'USER DEFINED KEYWORD BUILD'                                     
***********************************************************************         
*  USER DEFINED KEYWORDS                                              *         
***********************************************************************         
         USING LIDELD,R2                                                        
         USING KWDRECD,R3                                                       
         USING UDKRECD,R4                                                       
         USING UDKELD,R5                                                        
         USING KYWD,R6                                                          
USERDEF  NMOD1 0,**UDEF**                                                       
         L     RC,RLBASEC                                                       
         L     R3,AIO3                                                          
         L     R4,UDKBASE          A(USER DEFINED KEYWORD TABLE)                
         SR    R1,R1                                                            
         SR    R6,R6                                                            
         MVI   UDEFSRTS,0          SET TO ZERO                                  
         MVI   UDEFDATS,0          SET TO ZERO                                  
         XC    SVR6,SVR6                                                        
*                                                                               
USERDF10 CLI   0(R4),0             END OF KEYWORDS?                             
         BE    USERDF40            NOT FOUND, ADD TO TABLE                      
         IC    R1,UDKRECLN         REOCRD LENGTH                                
         IC    R6,UDKSEQ           GET SEQUENCE NUMBER                          
         CLC   UDKEY,FINDDATA      USER DEFINED KEYWORD                         
         BE    USERDF15            FOUND MATCH                                  
         AR    R4,R1                                                            
         B     USERDF10            LOOP TO CHECK NEXT                           
*                                                                               
USERDF15 LA    R5,UDKLNQ(,R4)      POINT TO START OF DATA                       
         LA    RE,0(R4,R1)         POINT TO END OF ENTRY                        
USERDF20 CR    R5,RE               AT END OF RECORD YET?                        
         BL    *+6                                                              
         DC    H'0'                PAST DATA, DIE LEDGER NOT FOUND              
*                                                                               
         CLC   QUNIT(2),UDKUNT     COMPARE UNIT/LEDGER                          
         BE    USERDF30            NOT LEDGER WORKING ON NOW                    
         LA    R5,UDKELQ(,R5)      BUMP TO NEXT ENTRY                           
         B     USERDF20                                                         
*                                                                               
USERDF30 ICM   R6,15,UDKINDX       FOUND MATCH, R6=DATA ENTRY                   
         ST    R6,SVR6                                                          
         B     USERDF90                                                         
*                                                                               
USERDF40 MVC   UDKEY,FINDDATA                                                   
         AHI   R6,1                BUMP INDEX UP BY ONE                         
         STC   R6,UDKSEQ           SAVE SEQ. NUMBER                             
         MVC   UDEFSEQ#,UDKSEQ     SAVE SEQUENCE NUMBER                         
         SR    R0,R0               COUNT NUMBER OF ELEMENTS                     
         LA    R5,UDKLNQ(,R4)      POINT TO START OF MULTY ELEMENTS             
*                                                                               
         L     R2,AIO3                                                          
         AH    R2,DATADISP                                                      
USERDF42 CLI   0(R2),0             END OF RECORD                                
         BE    USERDF60            FINISHED                                     
         CLI   0(R2),LIDELQ        X'1F' LIST DATA                              
         BE    USERDF50                                                         
USERDF48 SR    R1,R1                                                            
         IC    R1,1(,R2)                                                        
         AR    R2,R1                                                            
         B     USERDF42                                                         
*                                                                               
USERDF50 AHI   R0,1                BUMP COUNT UP                                
         MVC   UDKUNT(2),LIDDAUNT  SAVE UNIT/LEDGER                             
         MVC   FINDDATA,LIDDACCS   REDEFINED KEYWORD                            
         GOTO1 =A(KYWFIND)                                                      
         LTR   R6,R6               KEYWORD MUST BE IN TABLE                     
         BNZ   *+6                                                              
         DC    H'0'                CAN'T BE A USER DEFINED (HERE)               
         CLC   QUNIT(2),UDKUNT                                                  
         BNE   *+8                                                              
         ST    R6,SVR6             SAVE FOR CURRENT LEDGER TO PROCESS           
         STCM  R6,15,UDKINDX       SAVE INDEX (ARRAY NUMBER INTO TABLE)         
         CLC   KYWSRTQ+1(1),UDKSRTSZ  USE LARGER OF TWO                         
         BL    *+10                                                             
         MVC   UDKSRTSZ,KYWSRTQ+1  SORT SIZE                                    
         SR    R1,R1                                                            
         ICM   R1,3,KYWLINK        LINK TO DATA                                 
         BZ    USERDF58                                                         
         A     R1,KYWBASE                                                       
         LR    R6,R1               POINT TO NEW KEYWORD                         
         CLC   KYWSRTQ+1(1),UDKDATSZ  USE LARGER OF TWO                         
         BL    *+10                                                             
         MVC   UDKDATSZ,KYWSRTQ+1  DATA SIZE                                    
USERDF58 LA    R5,UDKELQ(,R5)                                                   
         B     USERDF48                                                         
*                                                                               
USERDF60 MHI   R0,UDKELQ                                                        
         AHI   R0,UDKLNQ                                                        
         STC   R0,UDKRECLN                                                      
         MVI   0(R5),0             MARK END OF TABLE                            
*                                                                               
USERDF90 MVC   UDEFSRTS,UDKSRTSZ   SAVE SORT SIZE                               
         MVC   UDEFDATS,UDKDATSZ   SAVE DATA SIZE                               
         L     R6,SVR6                                                          
         OC    SVR6,SVR6                                                        
         BNZ   *+8                                                              
         MVI   ERROR#,15                                                        
         CLI   ERROR#,0            SET CON-CODE                                 
         XIT1  REGS=(R6)                                                        
         DROP  R2,R3,R4,R5,R6                                                   
         SPACE 3                                                                
         LTORG                                                                  
         TITLE 'INSERT PLANNING ESTIMATE # OR REVISION #ENTRY'                  
***********************************************************************         
*  INSERT PLANNING ESTIMATE # OR REVISION # INTO PRNENTBL             *         
*                                                                     *         
*  ON INPUT:                                                          *         
*     PARM 1 BYTES 1-3 = ADDRESS OF THE KEYWORD TABLE ENTRY           *         
*     PARM 2 BYTES 1-3 = ADDRESS TO STORE THE PRNENTBL ENTRY NUMBER   *         
*     PARM 3 BYTES 1-3 = ADDRESS OF ONE BYTE VALUE OF EST#            *         
***********************************************************************         
         SPACE 1                                                                
         USING PRNEND,R4          PLANNING OR REVISION NUMBER ELEMENT           
         USING KYWD,R6            KEYWORD ENTRY                                 
         USING ESTD,R7                                                          
BLDPRN   NMOD1 0,**BPR#**                                                       
         L     RC,RLBASEC                                                       
         L     R6,0(,R1)           ->    A(KEYWORD ENTRY)                       
         L     R3,4(,R1)           ->    A(INDEX   ENTRY  FIELD)                
         L     R2,8(,R1)           ->    A(BINARY  VALUE  EST#)                 
         L     R4,PRNENTBL         ->    A(PRNENTBL)                            
*                                                                               
BLDPRN15 SR    R8,R8                                                            
         IC    R8,0(,R2)           GET  THE NUMBER                              
         LA    R5,1                INIT THE INDEX  NUMBER                       
*                                                                               
BLDPRN20 LA    R7,PRNDATA          Point to estimate data area                  
         CLI   PRNTYPE,0           Free entry?                                  
         BE    BLDPRN30            Yes, use it                                  
         CLC   PRNTYPE,KYWREAD     Same type?  (P or R)                         
         BNE   BLDPRN25            No, keep looking                             
         CLM   R8,1,EST#           Same estimate number ?                       
         BE    BLDPRNEX            Yes, so finished, found match                
*                                                                               
BLDPRN25 AHI   R5,1                Try next, increase index number              
         AHI   R4,PRNENLNQ         Bump up in table                             
         B     BLDPRN20                                                         
*                                                                               
BLDPRN30 MVC   PRNTYPE,KYWREAD     Set planning or revision                     
         STC   R8,EST#             Set estimate number for lookup later         
*                                                                               
BLDPRNEX STC   R5,0(,R3)           Save the index                               
         XIT1                                                                   
         DROP  R4,R6,R7                                                         
         SPACE 3                                                                
         LTORG                                                                  
         TITLE 'ADD DEFAULT JOBBER COLS AND SET UP FOR JOBBER'                  
         USING ACRL2D,R7                                                        
JOBCOLS  NMOD1 0,**JCOL**                                                       
         L     RC,RLBASEC                                                       
         L     R7,AACRL2D                                                       
*                                                                               
         MVC   WORK,SPACES                                                      
         MVCDD WORK(6),AC#OE                                                    
         GOTO1 =A(JESTADD),DMCB,WORK,JBCV#OE,JOBFLDH                            
         MVCDD WORK(6),AC#CE                                                    
         GOTO1 =A(JESTADD),DMCB,WORK,JBCV#CE,JOBFLDH                            
         MVCDD WORK(6),AC#CEG                                                   
         GOTO1 =A(JESTADD),DMCB,WORK,JBCV#CEG,JOBFLDH                           
*&&US*&& MVC   WORK(6),=CL6'HR'                                                 
*&&US*&& GOTO1 =A(JESTADD),DMCB,WORK,JBCV#HR,JOBFLDH                            
         MVCDD WORK(6),AC#RSCEH                                                 
         GOTO1 =A(JESTADD),DMCB,WORK,JBCV#CEH,JOBFLDH                           
                                                                                
         GOTO1 =A(JESTFBO),JOBFLD                                               
*                                                                               
         USING ACMD,R3                                                          
         L     R3,AMONACC                                                       
         LA    RE,JOBFLDH                                                       
         ST    RE,ACMAJCSP         FAKE SPEC ADDRESS                            
         GOTO1 ACMAJOBL,DMCB,JOBFLDH,ACMACOLL,ADCOMFAC                          
         CLI   4(R1),0             ANY ERROR?                                   
         BE    JOBCOL15                                                         
         L     RE,ACMAJOBB                                                      
         MVC   ACMAJCSP,JBORICLI-JBLOCKD(RE)                                    
         SR    RE,RE               ENSURE JOBBER BLOCK IS INITIALISED           
         SR    RF,RF                                                            
         L     R0,ACMAJOBB                                                      
         LA    R1,JBLOCKL                                                       
         MVCL  R0,RE                                                            
         B     JOBCOLOK            NO                                           
*                                                                               
JOBCOL15 MVI   ERROR#,6            YES, BAD KEYWORD                             
         SR    RF,RF                                                            
         IC    RF,5(,R1)           GET DISPLACEMENT INTO JOBFLD                 
         LA    RF,JOBFLD(RF)                                                    
         LR    RE,RF               SAVE START OF BAD KEYWORD                    
         MHI   R1,6                                                             
JOBCOL20 CLI   0(RF),C','                                                       
         BE    JOBCOL25            END OF KEYWORD (SEPERATED BY COMMA)          
         CLI   0(RF),C' '                                                       
         BNH   JOBCOL25            LAST KEYWORD                                 
         AHI   RF,1                NEXT CHARACTER                               
         BCT   R1,JOBCOL20                                                      
*                                                                               
JOBCOL25 SR    RF,RE                                                            
         SHI   RF,1                                                             
         MVC   FINDDATA,SPACES     SET UP TO DISPLAY ERROR                      
         BM    JOBCOLNO                                                         
         EXMVC RF,FINDDATA,0(RE)                                                
         B     JOBCOLNO                                                         
*                                                                               
JOBCOLOK SR    RE,RE                                                            
JOBCOLNO LTR   RE,RE                                                            
         XIT1                                                                   
         DROP  R3,R7                                                            
         SPACE 1                                                                
         LTORG                                                                  
         TITLE 'SETUP JOBBER COLUMN DATA FOR PROD'                              
***********************************************************************         
*  FIND OR APPEND JOBBER KEYWORD TO DUMMY FIELD HEADER                *         
*      P1 = A(JOBBER KEYWORD TO ADD)                                  *         
*      P2 = A(RETURN FIELD OF JOBBER COLUMN #, 1 BYTE FIELD)          *         
*      P3 = A(FIELD HEADER)                                           *         
***********************************************************************         
         SPACE 1                                                                
JESTADD  NMOD1 0,**JEST**                                                       
         L     RC,RLBASEC                                                       
         L     R2,0(,R1)           A(DATA TO ADD)                               
         L     R4,4(,R1)           A(1 BYTE FIELD RETURN AREA)                  
         L     R3,8(,R1)           A(FIELD HEADER FOR JOBBER KEYWORDS)          
         LR    R7,R1                                                            
         MVC   JESTNUM,0(R1)       SAVE POSSIBLE ESTIMATE #                     
         MVC   JESTKYW,SPACES      INITAILIZE                                   
*                                                                               
         CLI   0(R2),ESC#HIGH                                                   
         BH    JESTAD10                                                         
         LA    R2,0(,R2)           CLEAR HOB                                    
         GOTO1 ADDICTAT,DMCB,C'SU  ',(R2),0                                     
         SR    R1,R1                                                            
         ICM   R1,1,JESTNUM        IF A NUMBER REPLACE #                        
         BZ    JESTAD10                                                         
         CVD   R1,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         LA    R5,JESTKYW                                                       
*                                                                               
         LA    R1,6                MAX LENGTH                                   
         LR    RE,R2                                                            
JESTAD02 CLI   0(RE),C'#'          LOOK FOR # SIGN                              
         BE    JESTAD04                                                         
         MVC   0(1,R5),0(RE)       BUILD CONVERTED KEYWORD                      
         LA    R5,1(,R5)           TRY AGAIN                                    
         LA    RE,1(,RE)           TRY AGAIN                                    
         BCT   R1,JESTAD02                                                      
         B     JESTAD10            NOT FOUND, SO IGNORE                         
*                                                                               
JESTAD04 LA    RE,1(,RE)           BUMP PAST # SIGN                             
         BCTR  R1,0                LESS ONE FOR OVERALL LENGTH                  
         LA    RF,3                                                             
         UNPK  0(3,R5),DUB         PUT 3 CHARACTER NUMBER IN TO KEYWORD         
         CLI   0(R5),C'0'          IS IT ZERO                                   
         BH    JESTAD05                                                         
         LA    RF,2                                                             
         UNPK  0(2,R5),DUB         PUT 2 CHARACTER NUMBER IN TO KEYWORD         
         CLI   0(R5),C'0'          IS IT ZERO                                   
         BH    JESTAD05                                                         
         LA    RF,1                                                             
         UNPK  0(1,R5),DUB         PUT 1 CHARACTER NUMBER IN TO KEYWORD         
*                                                                               
JESTAD05 AR    R5,RF               POINT TO END OF NUMBER                       
         MVC   0(1,R5),0(RE)       MOVE IN REST OF RIGHT HAND SIDE              
         LA    RF,1                INCREMENT R5 BY ONE                          
         LA    RE,1(,RE)                                                        
         BCT   R1,JESTAD05                                                      
         MVC   0(6,R2),JESTKYW     OVER-WRITE UNEXPANDED VALUE                  
*                                                                               
JESTAD10 LA    R8,1                NUMBER OF ENTRIES (DEFAULT to 1)             
         LR    RE,R2               A(JOBBER KEYWORD TO ADD)                     
         SR    R6,R6               R6 = LENGTH OF JOBBER KEYWORD TO ADD         
         LA    R5,8(,R3)           POINT TO START OF FIELD                      
JESTAD15 CLI   0(RE),C','          KEYWORD FOLLOWED BY A COMMA                  
         BE    JESTAD20                                                         
         CLI   0(RE),BLANK                                                      
         BNH   JESTAD20            FOUND END OF KEYWORD                         
         LA    RE,1(,RE)           BUMP TO NEXT CHARACTER                       
         LA    R6,1(,R6)           ADD ONE TO STRING LENGTH                     
         CLM   R6,1,=AL1(L'KYWCODE)                                             
         BL    JESTAD15                                                         
         DC    H'00'                                                            
*                                                                               
JESTAD20 CLI   5(R3),0             INPUT DATA LENGTH                            
         BE    JESTAD30            ADD JOBBER KEYWORD                           
         GOTO1 =V(SCANNER),DMCB,(R3),(32,ABLOCK)                                
         SR    R1,R1                                                            
         ICM   R1,1,DMCB+4         NUMBER OF JOBBER KEYWORDS                    
*                                                                               
         L     R5,ABLOCK                                                        
         LR    RF,R6                                                            
         AHI   RF,-1                                                            
         BNM   *+6                                                              
         DC    H'00'               BAD DATA                                     
*                                                                               
JESTAD22 CLM   R6,1,0(R5)          MATCH ON LENGTH OF INPUT                     
         BNE   JESTAD24            CAN'T MATCH, DIFFERENT LENGTH                
         EX    RF,*+8                                                           
         BE    JESTAD80            FOUND MATCH, PASS BACK NUMBER                
         CLC   12(0,R5),0(R2)                                                   
JESTAD24 AHI   R5,32               NEXT ENTRY IN ABLOCK                         
         AHI   R8,1                KEEP TRACK OF WHICH ENTRY WERE ON            
         BCT   R1,JESTAD22                                                      
*                                                                               
         SR    RF,RF                                                            
         IC    RF,5(,R3)           GET LENGTH OF INPUT DATA                     
         LA    R5,8(RF,R3)         POINT TO END OF FIELD                        
         MVI   0(R5),C','          MOVE IN A COMMA                              
         AHI   R5,1                                                             
*                                                                               
JESTAD30 LR    RF,R6                                                            
         SHI   RF,1                RF = (LENGTH OF KEYWORD - 1)                 
         BNM   *+6                                                              
         DC    H'00'                                                            
         EXMVC RF,0(R5),0(R2)      EXTRACT KEYWORD                              
         AR    R5,R6               BUMP TO END OF FIELD (JOBBER WORDS)          
         SR    R5,R3               END OF FIELD - START OF FIELD                
         STC   R5,0(,R3)           SAVE FIELD LENGTH                            
         SHI   R5,8                INPUT LENGTH                                 
         STC   R5,5(,R3)                                                        
*                                                                               
JESTAD80 STC   R8,0(,R4)           RETURN ENTRY NUMBER                          
         LA    RE,JESTKYW          Keyword                                      
         ST    RE,0(,R7)           Pass back P1 = A(Expanded keyword)           
         XMOD1 1                                                                
         SPACE 1                                                                
JESTNUM  DS    XL1                                                              
JESTKYW  DS    CL8                                                              
         SPACE 2                                                                
         LTORG                                                                  
         TITLE 'Convert Jobber columns for BrandOcean usage'                    
         SPACE 1                                                                
         USING ACRL2D,R7                                                        
JESTFBO  NMOD1 0,**JFBO**                                                       
         L     RC,RLBASEC                                                       
                                                                                
         LR    R4,R1               for JOBFLD                                   
                                                                                
         USING JCOLTABD,R1                                                      
         LA    R1,JCOLTAB          set column names/escape sequences            
         LA    RE,JDDIN                                                         
                                                                                
JFBO02   MVC   0(L'JDDIN,RE),JCOLDICN                                           
         AHI   R1,JCOLTABL                                                      
         AHI   RE,L'JDDIN                                                       
         CLI   JCOLTABD,JCOLTEOT                                                
         BNE   JFBO02                                                           
                                                                                
         MVI   0(RE),0                                                          
         GOTO1 ADDICTAT,DMCB,C'LU  ',JDDIN,JDDOUT                               
                                                                                
         LA    R1,JCOLTAB                                                       
         LA    RE,JDDOUT                                                        
                                                                                
JFBO04   MVC   JCOLVAL,0(RE)                                                    
         AHI   R1,JCOLTABL                                                      
         AHI   RE,6                                                             
         CLI   JCOLTABD,JCOLTEOT                                                
         BNE   JFBO04                                                           
                                                                                
         LR    R2,R4               match keywords against list                  
         LA    R3,130(R4)                                                       
                                                                                
JFBO10   CLI   0(R2),0             end of list?                                 
         BE    JFBO30                                                           
         LR    RE,R2                                                            
         XR    RF,RF                                                            
                                                                                
JFBO12   CLI   0(RE),C','                                                       
         BE    JFBO14                                                           
         CLI   0(RE),C'#'                                                       
         BE    JFBO14                                                           
         CLI   0(RE),0                                                          
         BE    JFBO14                                                           
         AHI   RE,1                                                             
         AHI   RF,1                                                             
         B     JFBO12                                                           
                                                                                
JFBO14   SHI   RF,1                                                             
         MVC   JTEMP,SPACES                                                     
         MVC   JTEMP(0),0(R2)                                                   
         EX    RF,*-6                                                           
         LA    R2,2(RF,R2)                                                      
                                                                                
         LA    R1,JCOLTAB                                                       
                                                                                
JFBO20   CLI   JCOLTABD,JCOLTEOT                                                
         BNE   JFBO22                                                           
         MVC   0(2,R3),=X'FFFF'    dummy entry rather than die here             
         AHI   R3,2                                                             
         B     JFBO10                                                           
                                                                                
JFBO22   CLC   JTEMP,JCOLVAL                                                    
         BE    JFBO24                                                           
         AHI   R1,JCOLTABL                                                      
         B     JFBO20                                                           
                                                                                
JFBO24   MVC   0(2,R3),JCOLESC                                                  
         AHI   R3,2                                                             
         B     JFBO10                                                           
                                                                                
         USING ACMD,RF                                                          
JFBO30   L     RF,AMONACC          (re)build columns for BrandOcean             
*&&US*&& LA    R1,JOBFLDH                                                       
*&&UK*&& LA    R1,130(R4)                                                       
         L     RE,ACMAJOBB                                                      
         ST    R1,JBORICLI-JBLOCKD(RE)                                          
         DROP  R7,RF                                                            
                                                                                
         XMOD1 1                                                                
         SPACE 1                                                                
         LTORG                                                                  
         SPACE 1                                                                
JTEMP    DS    CL6                                                              
         SPACE 1                                                                
JCOLTAB  DS    0CL(JCOLTABL)                                                    
*                                                                               
         DCDDL AC#OE,6                                                          
         DC    AL2(AC#OE),CL6' '                                                
         DCDDL AC#OEN,6                                                         
         DC    AL2(AC#OEN),CL6' '                                               
         DCDDL AC#OEG,6                                                         
         DC    AL2(AC#OEG),CL6' '                                               
         DCDDL AC#OEC,6                                                         
         DC    AL2(AC#OEC),CL6' '                                               
         DCDDL AC#OET,6                                                         
         DC    AL2(AC#OET),CL6' '                                               
         DCDDL AC#OETG,6                                                        
         DC    AL2(AC#OETG),CL6' '                                              
         DCDDL AC#RSOEH,6                                                       
         DC    AL2(AC#RSOEH),CL6' '                                             
         DCDDL AC#RSOEB,6                                                       
         DC    AL2(AC#RSOEB),CL6' '                                             
         DCDDL AC#RSOEN,6                                                       
         DC    AL2(AC#RSOEN),CL6' '                                             
         DCDDL AC#RSOER,6                                                       
         DC    AL2(AC#RSOER),CL6' '                                             
*                                                                               
         DCDDL AC#CE,6                                                          
         DC    AL2(AC#CE),CL6' '                                                
         DCDDL AC#CEN,6                                                         
         DC    AL2(AC#CEN),CL6' '                                               
         DCDDL AC#CEG,6                                                         
         DC    AL2(AC#CEG),CL6' '                                               
         DCDDL AC#CEC,6                                                         
         DC    AL2(AC#CEC),CL6' '                                               
         DCDDL AC#CET,6                                                         
         DC    AL2(AC#CET),CL6' '                                               
         DCDDL AC#CETG,6                                                        
         DC    AL2(AC#CETG),CL6' '                                              
         DCDDL AC#RSCEH,6                                                       
         DC    AL2(AC#RSCEH),CL6' '                                             
         DCDDL AC#RSCHB,6                                                       
         DC    AL2(AC#RSCHB),CL6' '                                             
         DCDDL AC#RSCHN,6                                                       
         DC    AL2(AC#RSCHN),CL6' '                                             
         DCDDL AC#RSCHR,6                                                       
         DC    AL2(AC#RSCHR),CL6' '                                             
*                                                                               
         DCDDL AC#CRATE,6                                                       
         DC    AL2(AC#CRATE),CL6' '                                             
*                                                                               
         DCDDL AC#RSHR,6                                                        
         DC    AL2(AC#RSHR),CL6' '                                              
         DCDDL AC#RSHRG,6                                                       
         DC    AL2(AC#RSHRG),CL6' '                                             
         DCDDL AC#RSHRC,6                                                       
         DC    AL2(AC#RSHRC),CL6' '                                             
         DCDDL AC#RSHRH,6                                                       
         DC    AL2(AC#RSHRH),CL6' '                                             
         DCDDL AC#RSHRB,6                                                       
         DC    AL2(AC#RSHRB),CL6' '                                             
         DCDDL AC#RSHRN,6                                                       
         DC    AL2(AC#RSHRN),CL6' '                                             
         DCDDL AC#RSHRR,6                                                       
         DC    AL2(AC#RSHRR),CL6' '                                             
*                                                                               
         DCDDL AC#UNCN,6                                                        
         DC    AL2(AC#UNCN),CL6' '                                              
         DCDDL AC#UNCG,6                                                        
         DC    AL2(AC#UNCG),CL6' '                                              
         DCDDL AC#UNCC,6                                                        
         DC    AL2(AC#UNCC),CL6' '                                              
         DCDDL AC#UNCT,6                                                        
         DC    AL2(AC#UNCT),CL6' '                                              
         DCDDL AC#UNCTG,6                                                       
         DC    AL2(AC#UNCTG),CL6' '                                             
*                                                                               
         DCDDL AC#PCOMN,6                                                       
         DC    AL2(AC#PCOMN),CL6' '                                             
         DCDDL AC#PCOMG,6                                                       
         DC    AL2(AC#PCOMG),CL6' '                                             
         DCDDL AC#PCOMC,6                                                       
         DC    AL2(AC#PCOMC),CL6' '                                             
*                                                                               
         DCDDL AC#PUNCN,6                                                       
         DC    AL2(AC#PUNCN),CL6' '                                             
         DCDDL AC#PUNCG,6                                                       
         DC    AL2(AC#PUNCG),CL6' '                                             
         DCDDL AC#PUNCC,6                                                       
         DC    AL2(AC#PUNCC),CL6' '                                             
*                                                                               
         DCDDL AC#MXOEN,6                                                       
         DC    AL2(AC#MXOEN),CL6' '                                             
         DCDDL AC#MXOEG,6                                                       
         DC    AL2(AC#MXOEG),CL6' '                                             
         DCDDL AC#MXOEC,6                                                       
         DC    AL2(AC#MXOEC),CL6' '                                             
         DCDDL AC#MXOET,6                                                       
         DC    AL2(AC#MXOET),CL6' '                                             
         DCDDL AC#MXOTG,6                                                       
         DC    AL2(AC#MXOTG),CL6' '                                             
*                                                                               
         DCDDL AC#MXCEN,6                                                       
         DC    AL2(AC#MXCEN),CL6' '                                             
         DCDDL AC#MXCEG,6                                                       
         DC    AL2(AC#MXCEG),CL6' '                                             
         DCDDL AC#MXCEC,6                                                       
         DC    AL2(AC#MXCEC),CL6' '                                             
         DCDDL AC#MXCET,6                                                       
         DC    AL2(AC#MXCET),CL6' '                                             
         DCDDL AC#MXCTG,6                                                       
         DC    AL2(AC#MXCTG),CL6' '                                             
*                                                                               
         DCDDL AC#PBCEN,6                                                       
         DC    AL2(AC#PBCEN),CL6' '                                             
         DCDDL AC#PBCEG,6                                                       
         DC    AL2(AC#PBCEG),CL6' '                                             
         DCDDL AC#PBCEC,6                                                       
         DC    AL2(AC#PBCEC),CL6' '                                             
*                                                                               
         DCDDL AC#PLAN,6                                                        
         DC    AL2(AC#PLAN),CL6' '                                              
         DCDDL AC#PDN,6                                                         
         DC    AL2(AC#PDN),CL6' '                                               
         DCDDL AC#PDG,6                                                         
         DC    AL2(AC#PDG),CL6' '                                               
         DCDDL AC#PDC,6                                                         
         DC    AL2(AC#PDC),CL6' '                                               
         DCDDL AC#PDT,6                                                         
         DC    AL2(AC#PDT),CL6' '                                               
         DCDDL AC#PDTG,6                                                        
         DC    AL2(AC#PDTG),CL6' '                                              
         DCDDL AC#PDH,6                                                         
         DC    AL2(AC#PDH),CL6' '                                               
         DCDDL AC#PDHB,6                                                        
         DC    AL2(AC#PDHB),CL6' '                                              
         DCDDL AC#PDHN,6                                                        
         DC    AL2(AC#PDHN),CL6' '                                              
         DCDDL AC#PDHR,6                                                        
         DC    AL2(AC#PDHR),CL6' '                                              
*                                                                               
         DCDDL AC#SPP,6                                                         
         DC    AL2(AC#SPP),CL6' '                                               
         DCDDL AC#SPPN,6                                                        
         DC    AL2(AC#SPPN),CL6' '                                              
         DCDDL AC#SPPG,6                                                        
         DC    AL2(AC#SPPG),CL6' '                                              
         DCDDL AC#SPPC,6                                                        
         DC    AL2(AC#SPPC),CL6' '                                              
         DCDDL AC#SPPT,6                                                        
         DC    AL2(AC#SPPT),CL6' '                                              
         DCDDL AC#SPPTG,6                                                       
         DC    AL2(AC#SPPTG),CL6' '                                             
         DCDDL AC#SPPH,6                                                        
         DC    AL2(AC#SPPH),CL6' '                                              
*                                                                               
         DCDDL AC#REVD,6                                                        
         DC    AL2(AC#REVD),CL6' '                                              
         DCDDL AC#RVN,6                                                         
         DC    AL2(AC#RVN),CL6' '                                               
         DCDDL AC#RVG,6                                                         
         DC    AL2(AC#RVG),CL6' '                                               
         DCDDL AC#RVC,6                                                         
         DC    AL2(AC#RVC),CL6' '                                               
         DCDDL AC#RVT,6                                                         
         DC    AL2(AC#RVT),CL6' '                                               
         DCDDL AC#RVTG,6                                                        
         DC    AL2(AC#RVTG),CL6' '                                              
         DCDDL AC#RVH,6                                                         
         DC    AL2(AC#RVH),CL6' '                                               
         DCDDL AC#RVHB,6                                                        
         DC    AL2(AC#RVHB),CL6' '                                              
         DCDDL AC#RVHN,6                                                        
         DC    AL2(AC#RVHN),CL6' '                                              
         DCDDL AC#RVHR,6                                                        
         DC    AL2(AC#RVHR),CL6' '                                              
*                                                                               
         DCDDL AC#MXPDN,6                                                       
         DC    AL2(AC#MXPDN),CL6' '                                             
         DCDDL AC#MXPDG,6                                                       
         DC    AL2(AC#MXPDG),CL6' '                                             
         DCDDL AC#MXPDC,6                                                       
         DC    AL2(AC#MXPDC),CL6' '                                             
         DCDDL AC#MXPDT,6                                                       
         DC    AL2(AC#MXPDT),CL6' '                                             
         DCDDL AC#MXPTG,6                                                       
         DC    AL2(AC#MXPTG),CL6' '                                             
*                                                                               
         DCDDL AC#MXRVN,6                                                       
         DC    AL2(AC#MXRVN),CL6' '                                             
         DCDDL AC#MXRVG,6                                                       
         DC    AL2(AC#MXRVG),CL6' '                                             
         DCDDL AC#MXRVC,6                                                       
         DC    AL2(AC#MXRVC),CL6' '                                             
         DCDDL AC#MXRVT,6                                                       
         DC    AL2(AC#MXRVT),CL6' '                                             
         DCDDL AC#MXRTG,6                                                       
         DC    AL2(AC#MXRTG),CL6' '                                             
*                                                                               
         DCDDL AC#VATRJ,6                                                       
         DC    AL2(AC#VATRJ),CL6' '                                             
*                                                                               
JCOLTABN EQU   (*-JCOLTAB)/L'JCOLTAB                                            
JCOLTABX DC    AL1(JCOLTEOT)                                                    
         SPACE 1                                                                
JDDIN    DS    (JCOLTABN)XL4,X     DICTIONARY INPUT LIST                        
JDDOUT   DS    (JCOLTABN)CL8       DICTIONARY OUTPUT LIST                       
         SPACE 1                                                                
         TITLE 'CONVERT OFFICE LIST FILTER TO SCRIBE FILTER'                    
         USING OFFALD,R1                                                        
         USING RFLELD,R2                                                        
OFFFLT   NMOD1 0,**OFLT**                                                       
         L     RC,RLBASEC                                                       
         L     R2,0(,R1)           A(RFLELD ELEMENT)                            
         L     R4,4(,R1)           A(AFLTOFF)                                   
         L     R1,ADOFFALD                                                      
         L     R6,ABUDIO                                                        
         XC    0(20,R6),0(R6)      Clear to initiaize                           
         MVC   OFFACOMF,ADCOMFAC                                                
         NI    OFFAINDS,TURNOFF-OFFAIUOL-OFFAIXOL                               
         TM    RFLIND,RFLXCLD      TEST IF EXCLUDE OR NOT                       
         BZ    *+8                 NO                                           
         OI    OFFAINDS,OFFAIXOL   YES                                          
         MVC   OFFAOFFC,RFLDATA    TWO CHARACTER OFFICE CODE TO GET             
         MVI   OFFAACT,OFFAREQ     SET REQUEST LIST                             
         MVC   SVREG,OFFAREQL      SAVE ORIGINAL LOCATION                       
         ST    R6,OFFAREQL                                                      
*        MVC   OFFAREQL,ABUDIO     USE OWN AREA                                 
         GOTO1 ADOFFAL                                                          
         NI    OFFAINDS,TURNOFF-OFFAIXOL-OFFAIUOL                               
         MVC   OFFAREQL,SVREG      RESTORE ORIGINAL LOCATION                    
         L     R3,AFLTAREA                                                      
         ST    R3,0(,R4)           SAVE OFF ADDRESS                             
         OI    0(R4),FLTMULT       X'20' SET TO USER LIST                       
*                                                                               
         SR    R1,R1                                                            
         ICM   R1,3,0(R6)          GET NUMBER OF OFFICES                        
         BNZ   *+8                                                              
         LA    R1,1                SAY ONE TO BUILD DUMMY OFFICE                
OFFFLT30 MVI   0(R3),2             LENGTH OF VALUE                              
         LA    R6,2(,R6)           BUMP PAST LENGTH OR OFFICE CODE              
         MVC   1(2,R3),0(R6)       SAVE OFF OFFICE                              
         LA    R3,3(,R3)           BUMP TO NEW LOCATION                         
         BCT   R1,OFFFLT30                                                      
*                                                                               
         MVI   0(R3),EOT           MARK END                                     
         LA    R3,1(,R3)                                                        
         ST    R3,AFLTAREA         SAVE NEW LOCATION                            
         XIT1                                                                   
         DROP  R1,R2                                                            
         SPACE 3                                                                
         LTORG                                                                  
         TITLE 'INITIALIZE OFFCIE FILTER IN ACMASTER'                           
***********************************************************************         
*  BUILD SPECIAL OFFICE FILTER                                        *         
***********************************************************************         
         SPACE 1                                                                
         USING OFFALD,R2                                                        
         USING ACRLD,RA                                                         
         USING ACWORKD,RC                                                       
         USING ACMD,R6                                                          
*&&DO                                                                           
FIXOFF   NMOD1 0,**FIXO**                                                       
         L     RC,RLBASEC                                                       
         L     R6,AMONACC                                                       
         L     R2,ADOFFALD         OFFVAL  BLOCK                                
         L     R3,0(,R1)           OFFICES TO INCLUDE OR EXCLUDE                
         LA    R4,OFFAWORK+2       POINT   TO LIMITED ACCESS LIST               
         LA    R8,ACMROFL          WHERE   TO BUILD REQUEST OFFICE LIST         
         SR    R9,R9                                                            
         CLI   0(R1),0                                                          
         BE    FIXOFF50            INCLUDE TYPE LIST ELSE                       
*                                  EXCLUDE TYPE                                 
         SR    R0,R0                                                            
         ICM   R0,3,OFFAWORK       TOTAL NUMBER OF OFFICES FOR ID               
FIXOFF10 SR    RF,RF                                                            
         ICM   RF,3,0(R3)          NUMBER OF OFFICES                            
         LA    R5,2(,R3)           POINT  TO OFFICES TO EXCLUDE                 
FIXOFF12 CLC   0(2,R4),0(R5)       SEE  IF MATCHES ANY  OFFICE                  
         BE    FIXOFF20            YES, SO EXCLUDE THIS OFFICE                  
         LA    R5,2(,R5)           NEXT REQUESTED  OFFICE                       
         BCT   RF,FIXOFF12                                                      
*                                                                               
         MVC   0(2,R8),0(R4)       REBUILD REQUESTED OFFICE LIST                
         LA    R9,1(,R9)           COUNT   NUMBER OF OFFICES ADDED              
         LA    R8,2(,R8)           NEXT    LOCATION  TO PUT OFFICE              
FIXOFF20 LA    R4,2(,R4)           NEXT    POSSIBLE  OFFICE TO ADD              
         BCT   R0,FIXOFF10                                                      
         B     FIXOFF90                                                         
*                                                                               
FIXOFF50 SR    R0,R0                                                            
         ICM   R0,3,0(R3)          TOTAL NUMBER OF OFFICES TO CHECK             
         LA    R3,2(,R3)           MOVE TO OFFICE LIST                          
FIXOFF52 SR    RF,RF                                                            
         ICM   RF,3,OFFAWORK       NUMBER OF OFFICES COMPARE AGAINST            
         LR    R5,R4               START OF LIMIT ACCESS OFFICE LIST            
FIXOFF54 CLC   0(2,R3),0(R5)       SEE IF MATCHES                               
         BE    FIXOFF60                                                         
         LA    R5,2(,R5)           NEXT LIMITED OFFICE IN LIST                  
         BCT   RF,FIXOFF54                                                      
         B     FIXOFF62            NOT FOUND SO DON'T INCLUDE                   
*                                                                               
FIXOFF60 MVC   0(2,R8),0(R3)       MOVE  TO REQUEST OFFICE LIST                 
         LA    R8,2(,R8)           NEXT  LOCATION  TO PUT OFFICE                
         LA    R9,1(,R9)           COUNT NUMBER OF OFFICES ADDED                
FIXOFF62 LA    R3,2(,R3)           NEXT  POSSIBLE  OFFICE TO ADD                
         BCT   R0,FIXOFF52                                                      
         XC    0(2,R8),0(R8)       CLEAR LAST ENTRY                             
*                                                                               
         LTR   R9,R9               NO OFFICES MATCHED IF ZERO                   
         BNZ   FIXOFF90            LOOKS   OK                                   
         L     R3,0(R1)            OFFICES TO INCLUDE                           
         CLC   0(2,R3),=H'01'      IF ONLY ONE THEN IS IT A LIST?               
         BNE   FIXOFF98            ERROR IF > 1, CAN'T BE LIST                  
         MVC   OFFAOFFC,2(R3)      SEE   IF IT IS A LIST                        
         MVI   OFFAACT,OFFAREQ                                                  
         GOTO1 ADOFFAL,OFFALD                                                   
         B     FIXOFF94                                                         
*                                                                               
FIXOFF90 STCM  R9,3,ACMOFCN        NUMBER OF REQUESTED OFFICES                  
FIXOFF94 OC    ACMOFCN,ACMOFCN                                                  
         BNZ   *+8                                                              
FIXOFF98 MVI   ERROR#,12                                                        
         XMOD1                                                                  
         DROP  R2,R6                                                            
         SPACE 3                                                                
         LTORG                                                                  
*&&                                                                             
         TITLE 'INITIALIZE CONTRA FILTER IN ACMASTER'                           
***********************************************************************         
*  BUILD SPECIAL CONTRA FILTER                                        *         
***********************************************************************         
         SPACE 1                                                                
         USING RFLELD,R2                                                        
         USING ACMD,R6                                                          
         USING ACRLD,RA                                                         
         USING ACWORKD,RC                                                       
CNTRAFLT NMOD1 0,**CFLT**                                                       
         L     RC,RLBASEC                                                       
         L     R6,AMONACC                                                       
         TM    ACMCFIND,ACMCFACT                                                
         BO    CNTRAF90                                                         
         XC    ACMCFMAX,ACMCFMAX                                                
         MVC   ACMCFNTY,=H'01'                                                  
         MVC   ACMCFKEY,SPACES                                                  
         L     R5,ACMCFLST         LOCATION OF LIST                             
         ICM   R2,15,0(R1)         special case                                 
         BZ    CNTRAF60                                                         
         CLI   RFLDATA,C'+'                                                     
         BE    CNTRAF90            IGNORE +/- LIST THIS POINT                   
         CLI   RFLDATA,C'-'                                                     
         BE    CNTRAF90            IGNORE +/- LIST THIS POINT                   
         OI    ACMCFIND,ACMCFACT   CONTRA FILTER                                
         TM    RFLIND,RFLXCLD      EXCLUDE DATA?                                
         BZ    CNTRAF10                                                         
         OI    ACMCFIND,ACMCFXCL   SET TO EXCLUDE                               
*                                                                               
CNTRAF10 L     R4,ABLOCK                                                        
         MVC   ACMCFMAX+1(1),NPRAMS                                             
         SR    R0,R0                                                            
         IC    R0,NPRAMS                                                        
*                                                                               
CNTRAF20 MVC   1(14,R5),SPACES                                                  
         MVI   0(R5),14            FULL LENGTH DEFAULT                          
         SR    R1,R1                                                            
         IC    R1,0(,R4)           LEN OF DATA                                  
         BCTR  R1,0                                                             
         CLI   RFLTYPE,RFLBSR      BILLING SOURCE?                              
         BNE   CNTRAF30            NO, MUST BE REAL CONTRA                      
         EXMVC R1,3(R5),12(R4)                                                  
         B     CNTRAF35                                                         
*                                                                               
         USING LDGD,R3                                                          
CNTRAF30 EXMVC R1,1(R5),12(R4)                                                  
         GOTO1 GETLDGR,DMCB,12(R4)                                              
         OC    DMCB,DMCB                                                        
         BNZ   *+6                                                              
         DC    H'00'                                                            
*                                                                               
         L     R3,DMCB             LOAD UL ENTRY FOR DSECT                      
         SR    R1,R1                                                            
         IC    R1,LDG#LEVS         GET NUMBER OF LEVELS                         
         LA    RE,LDGLEV1          POINT TO FIRST LEVEL                         
         SR    RF,RF                                                            
         IC    RF,0(,R4)           GET LENGTH OF INPUT                          
         SHI   RF,2                LESS TWO FOR UNIT/LEDGER                     
         BZ    CNTRAF34            ONLY A UNIT/LEDGER USED                      
         STC   RF,BYTE                                                          
CNTRAF31 CLC   BYTE,0(RE)                                                       
         BNH   CNTRAF33                                                         
         LA    RE,LDGLEV2-LDGLEV1(,RE)                                          
         BCT   R1,CNTRAF31                                                      
*                                                                               
CNTRAF33 IC    RF,0(,RE)           GET LENGTH OF LEVEL                          
CNTRAF34 LA    RF,2(,RF)           ADD BACK UNIT/LEDGER LENGTH                  
         STC   RF,0(,R5)           SAVE OFF LENGTH OF COMPARE                   
*                                                                               
CNTRAF35 AHI   R4,32               NEXT IN BLOCK                                
         AHI   R5,15               NEXT ENTRY                                   
         BCT   R0,CNTRAF20                                                      
***********************************************************************         
*  BUBBLE SORT RECORDS AND ELIMINATE DUPLICATES                       *         
***********************************************************************         
         SPACE 1                                                                
         IC    R0,NPRAMS                                                        
         LR    R8,R0               R6 = TOTAL NUMBER OF ENTRIES                 
         SHI   R0,1                ONE LESS THEN NUM OF ENTRIES                 
         BNP   CNTRAF90            ONLY ONE ENTRY                               
         LR    R5,R0               POINT TO LAST ENTRY                          
         MHI   R5,15                                                            
         A     R5,ACMCFLST         BASE OF LIST                                 
         ST    R5,FULL                                                          
*                                                                               
CNTRAF40 L     R5,FULL             LAST ENTRY                                   
         SHI   R5,15               BACK ONE ENTRY                               
         LR    R1,R0               NUMBER OF ENTRIES LEFT                       
CNTRAF42 CLC   1(14,R5),16(R5)                                                  
         BL    CNTRAF50                                                         
         BH    CNTRAF48                                                         
         SHI   R8,1                DUPLICATE SO ONE LESS ENTRY NEEDED           
         BNP   CNTRAF58                                                         
         L     RE,FULL             LOCATION OF LAST ENTRY                       
         XC    0(15,RE),15(R5)     SWAP WITH LAST ENTRY                         
         XC    15(15,R5),0(RE)                                                  
         XC    0(15,RE),15(R5)                                                  
         SHI   RE,15                                                            
         ST    RE,FULL                                                          
         B     CNTRAF42            TRY AGAIN                                    
*                                                                               
CNTRAF48 XC    0(15,R5),15(R5)     SWAP WITH NEXT ENTRY                         
         XC    15(15,R5),0(R5)                                                  
         XC    0(15,R5),15(R5)                                                  
*                                                                               
CNTRAF50 SHI   R5,15                                                            
         BCT   R1,CNTRAF42                                                      
         BCT   R0,CNTRAF40                                                      
*                                                                               
CNTRAF58 STH   R8,ACMCFMAX         NUMBER OF ENTRIES                            
         B     CNTRAF90                                                         
*                                                                               
CNTRAF60 MVI   0(R5),2             SET LENGTH                                   
         MVC   1(14,R5),SPACES                                                  
         MVC   1(2,R5),=C'11'      INCOME CONTRAS ALLOWED                       
         LA    R5,15(,R5)          NEXT KEY                                     
         MVI   0(R5),2             SET LENGTH                                   
         MVC   1(14,R5),SPACES                                                  
         MVC   1(2,R5),=C'12'                                                   
         MVI   ACMCFMAX+1,2                                                     
         OI    ACMCFIND,ACMCFACT   CONTRA FILTER                                
CNTRAF90 XIT1                                                                   
         DROP  R2,R3,R6                                                         
         SPACE 1                                                                
         LTORG                                                                  
         TITLE 'INITIALIZE DATES FOR REQUEST'                                   
***********************************************************************         
*  INITIALIZE DATES                                                   *         
***********************************************************************         
         SPACE 1                                                                
         USING ACRLD,RA                                                         
         USING ACRL2D,R7                                                        
         USING ACWORKD,RC                                                       
INITDATE DS    0D                                                               
         NMOD1 0,**IDTE**                                                       
         L     RC,RLBASEC                                                       
         L     R7,AACRL2D                                                       
         MVC   PERDATE,SPACES      PERIOD RANGE                                 
         MVC   REPEND,SPACES       REPORT END DATE                              
         MVC   MOADATE,SPACES      MOA RANGE                                    
         MVC   ACTDATE,SPACES      ACTIVITY RANGE                               
         MVC   ALTDATE,SPACES      ALTERNATE RANGE                              
         MVC   OCUREND,SPACES      OVER-RIDE CURRENT DATE                       
         XC    STDATE,STDATE       START DATE RANGE IS INFINITE                 
         MVC   ENDATE,=X'FFFFFF'   END DATE RANGE IS INFINITE                   
         XC    SAVEMOS,SAVEMOS                                                  
         XC    RMOADTE,RMOADTE                                                  
         XC    RMOAALT,RMOAALT                                                  
         XC    RTRNDTE,RTRNDTE                                                  
         XC    STARTYR,STARTYR     CLEAR FISCAL START YEAR                      
         XC    RELCSYR,RELCSYR                                                  
         XC    RELCEYR,RELCEYR                                                  
         XC    RQCALSTR,RQCALSTR                                                
*&&UK*&& XC    DISDATE,DISDATE                                                  
*&&UK*&& XC    DISMON,DISMON                                                    
         MVC   RQCALEND,=X'FFFFFF'                                              
         MVI   RELSPER#,0                                                       
         MVI   RELEPER#,0                                                       
         MVC   RMOAEND,=X'FFFFFF'                                               
         MVC   RTRNEND,=X'FFFFFF'                                               
         GOTO1 DATCON,DMCB,(4,RCDATE),(3,RELEND)                                
         SPACE 1                                                                
*&&DO                                                                           
***********************************************************************         
*  Fix bad date input                                                           
***********************************************************************         
         CLI   QPROG,MANPOWER                                                   
         BE    INTDTE10                                                         
         CLC   QSTART(4),SPACES    Date entered                                 
         BNH   INTDTE06            No                                           
         CLC   QSTART+4(2),SPACES  Was it in the form YYMM, without DD          
         BNE   *+10                No, okay as is                               
         MVC   QSTART+5(2),=C'01'  Fix date                                     
                                                                                
INTDTE06 CLC   QEND(4),SPACES      Date entered                                 
         BNH   INTDTE10            No                                           
         CLC   QEND+4(2),SPACES    Was it in the form YYMM, without DD          
         BNE   INTDTE10            No, okay as is                               
         GOTOR DATCON,DMCB,(X'30',QEND),(0,QEND),(1,0)                          
*&&                                                                             
***********************************************************************         
*  SET UP END DATES, RELATIVE DATE                                    *         
***********************************************************************         
INTDTE10 MVC   TEMPDATE,QEND                                                    
         LA    R2,0                INPUT DATE TYPE FOR DATCON C'YYMMDD'         
         LA    R3,0                SPECIAL DATCON DATE MODIFIER                 
         CLC   QEND,SPACES         ANY END DATE ?                               
         BNE   INTDTE18            YES,    SET RELATIVE END DATE                
         MVC   TEMPDATE(4),QMOSEND                                              
         MVC   TEMPDATE+4(2),=C'01'        FIND LAST DAY OF MONTH               
         CLC   QMOSEND,SPACES      ANY MOA END DATE ?                           
         BE    INTDTE20            NO, SO USE TODAY AS RELEND                   
*&&DO                                                                           
* Not sure why this code was inserted. Must have fixed a reported bug           
*     but causes other problems. Removed for now.                               
*                                                                               
         CLI   QPROG,MANPOWER                                                   
         BNE   INTDTE17                                                         
                                                                                
         USING CPRCNDRD,R3                                                      
         L     R3,ACNDRBLK                                                      
         MVC   CPROF,SPACES                                                     
         GOTO1 DATCON,DMCB,(0,TEMPDATE),(1,CPRYMD)                              
         MVI   CPRYMD+2,0          Clear out day                                
         GOTO1 AGETCNDR,DMCB,ACNDRBLK,39                                        
         BE    INTDTE15                                                         
         TM    CPRERR,CPRRF        Read occured                                 
         BO    INTDTE15            Don't care                                   
         MVI   ERROR#,8            Invalid calendar                             
         B     INTDTE90                                                         
                                                                                
INTDTE15 GOTO1 DATCON,DMCB,(1,CPREDATE),(3,RELEND)                              
         B     INTDTE19                                                         
         DROP  R3                                                               
*&&                                                                             
INTDTE17 LA    R2,X'30'            MODIFY OUTPUT DATE BASED ON R3               
         LA    R3,1                MAKE   OUTPUT DATE LAST DAY OF MONTH         
         SLL   R3,24               R3=X'01000000'                               
*                                                                               
INTDTE18 GOTO1 DATCON,DMCB,((R2),TEMPDATE),(3,RELEND),(R3)                      
                                                                                
INTDTE19 DS    0H                                                               
*&&UK*&& XC    SENDATE,SENDATE                                                  
         CLC   QEND,SPACES                                                      
         BE    INTDTE20                                                         
         MVC   ENDATE,RELEND                                                    
*&&UK*&& MVC   SENDATE,RELEND                                                   
*                                                                               
INTDTE20 CLC   RQRELEND,=X'FFFFFF' OVER-RIDE RELATIVE END                       
         BE    INTDTE21            NO                                           
         MVC   RELEND,RQRELEND                                                  
         GOTO1 DATCON,DMCB,(3,RQRELEND),(8,OCUREND)                             
*                                                                               
INTDTE21 GOTO1 DATCON,DMCB,(3,RELEND),(0,DAT2PRT)                               
         GOTO1 DATCON,DMCB,(3,RELEND),(8,REPEND)                                
         GOTO1 DATCON,DMCB,(3,RELEND),(1,RELEND2)                               
         MVC   RELCDATE,RELEND2                                                 
***********************************************************************         
*  SET UP PERIOD, START DATES, CURRENT DATES                          *         
***********************************************************************         
         SPACE 1                                                                
         XC    RSTADTE,RSTADTE                                                  
         MVC   RENDDTE,=X'FFFFFF'                                               
         CLC   QSTART(L'QSTART+L'QEND),SPACES     ANY START OR END              
         BE    INTDTE40                           NO                            
         MVC   PERSTR(4),AC@THRU                                                
         MVC   TEMPDATE,QSTART    USE START DATE TO OVER-RIDE FISCAL            
*                                                                               
         CLC   QSTART,SPACES          ANY     START DATES ?                     
         BNE   INTDTE22               YES                                       
         MVC   TEMPDATE(4),QMOSSTRT   NO, THEN USE MOA START DATE               
         MVC   TEMPDATE+4(2),=C'01'   SET TO   1ST DAY OF MONTH                 
         CLC   QMOSSTRT,SPACES        ANY MOA  START ?                          
         BE    INTDTE30               NO, DON'T OVER-RIDE FISCAL                
*                                                                               
INTDTE22 GOTO1 DATCON,DMCB,(0,TEMPDATE),(3,TEMPDATE)                            
         GOTO1 DATCON,DMCB,(0,QSTART),(1,RSTADTE)                               
         CLI   QPROG,MANPOWER      FOR PERSON SCRIBE DON'T                      
         BE    *+10                OVER-RIDE COMPANY FISCAL                     
         MVC   STARTYR,TEMPDATE    OVER-RIDE FISCAL                             
*                                                                               
         CLC   QSTART,SPACES       ANY START DATE ?                             
         BE    INTDTE25            NO                                           
         MVC   STDATE,TEMPDATE                                                  
         MVC   PERSTR(4),AC@FROM                                                
         GOTO1 DATCON,DMCB,(3,STDATE),(8,PEREND)                                
*                                                                               
INTDTE25 CLC   QEND,SPACES         ANY END DATE                                 
         BE    INTDTE40            NO                                           
         MVC   PERSTR,PEREND                                                    
         MVI   PERTHRU,C'-'                                                     
*                                                                               
INTDTE30 GOTO1 DATCON,DMCB,(0,QEND),(8,PEREND)                                  
         GOTO1 DATCON,DMCB,(0,QEND),(1,RENDDTE)                                 
         CLC   PERSTR,PEREND                                                    
         BNE   INTDTE40                                                         
         MVC   PERTHRU(L'PEREND+PEREND-PERTHRU),SPACES                          
***********************************************************************         
*  SET UP MONTH OF SERVICE DATES                                      *         
***********************************************************************         
         SPACE 1                                                                
INTDTE40 CLC   QMOSEND,SPACES                                                   
         BE    INTDTE45            NO MONTH OF SERVICE REQUESTED                
         MVC   TEMPDATE(4),QMOSEND                                              
         MVC   TEMPDATE+4(2),=C'01'                                             
         GOTO1 DATCON,DMCB,(0,TEMPDATE),(9,MOAEND)                              
         MVC   MOASTR(4),AC@THRU                                                
         GOTO1 DATCON,DMCB,(0,TEMPDATE),(1,WORK)                                
         MVC   RMOAEND,WORK        REQUESTED END MOA                            
         MVC   RMOAALTE,WORK       REQUEST ALTERNATE END MOA                    
*&&UK                                                                           
         CLI   QPROG,PAYABLES                                                   
         BNE   INTDT40C                                                         
         MVC   WORK(2),RMOAEND                                                  
         MVI   WORK+2,1                                                         
         GOTO1 DATCON,DMCB,(X'31',WORK),(1,DISMON),(1,0)                        
         GOTO1 DATCON,DMCB,(1,DISMON),(2,DISDATE)                               
*&&                                                                             
INTDT40C CLI   QPROG,PRODUCTION    FOR PRODUCTION ADD MONTH TO MOA              
         BNE   INTDTE41                                                         
         GOTO1 DATCON,DMCB,(X'31',WORK),(1,WORK+9),(2,0)                        
                                                                                
         USING ACMD,R2                                                          
         L     R2,AMONACC          OVER-RIDE MOA END                            
         MVC   ACMMEND,WORK+9      READ IN ONE EXTRA MONTH OF ACTIVITY          
         DROP  R2                                                               
*                                                                               
INTDTE41 MVC   TEMPDATE(4),QMOSSTRT                                             
         MVC   TEMPDATE+4(2),=C'01'                                             
         CLC   QMOSSTRT,SPACES     ANY MOA START DATE ?                         
         BE    INTDTE45            NO                                           
         GOTO1 DATCON,DMCB,(0,TEMPDATE),(1,WORK)                                
         MVC   RMOASTR,WORK        REQUEST MOA START                            
         MVC   RMOAALTS,WORK       REQUEST ALTERNATE MOS START                  
*                                                                               
INTDT41B GOTO1 DATCON,DMCB,(0,TEMPDATE),(3,TEMPDATE)                            
         CLC   QSTART,SPACES       ANY START DATE ?                             
         BNE   INTDTE42            YES                                          
         CLI   QPROG,MANPOWER      DON'T OVER-RIDE START YEAR IF                
         BE    *+10                PERSON SCRIBE                                
         MVC   STARTYR,TEMPDATE                                                 
*                                                                               
INTDTE42 GOTO1 DATCON,DMCB,(3,TEMPDATE),(9,MOASTR)                              
         MVI   MOADASH,C'-'                                                     
*        MVI   MOADASH,DASH                                                     
         CLC   QMOSEND,QMOSSTRT                                                 
         BNE   INTDTE45                                                         
         MVC   MOAEND,SPACES                                                    
         MVI   MOADASH,BLANK                                                    
*=====================================================================*         
*  SET UP ALTERNATE DATES                                             *         
*=====================================================================*         
         SPACE 1                                                                
INTDTE45 MVC   ALTREL,RELEND                                                    
         XC    ALTSTDTE,ALTSTDTE                                                
         MVC   ALTENDTE,=X'FFFFFF'                                              
         CLI   DATEFLT,0           ANY ALTERNATE DATES USED ?                   
         BE    INTDTE50            NO                                           
         MVC   ALTSTR(4),AC@THRU                                                
         TM    DATEFLT,DATEBIL                                                  
         BZ    INTDT45A            Billing date only                            
         XC    RMOAALTS,RMOAALTS   Re-set for billed alt dates                  
         MVC   RMOAALTE,=X'FFFFFF'                                              
*                                                                               
INTDT45A OC    ALTNSTR,ALTNSTR                                                  
         BZ    INTDTE46                                                         
         MVC   ALTSTR(4),AC@FROM                                                
         GOTO1 DATCON,DMCB,(1,ALTNSTR),(8,ALTEND)                               
         GOTO1 DATCON,DMCB,(1,ALTNSTR),(3,ALTSTDTE)                             
         OC    RMOADTE,RMOADTE                                                  
         BZ    INTDTE46            NO MOA TO OVERIDE                            
         TM    DATEFLT,DATEBIL                                                  
         BZ    INTDTE46            Billing date only                            
         MVC   RMOAALTS,ALTNSTR    Override for billed moa too                  
*                                                                               
INTDTE46 CLI   ALTNEND,X'FF'                                                    
         BE    INTDTE50                                                         
         CLC   ALTSTR(4),AC@FROM                                                
         BNE   INTDTE48                                                         
         MVC   ALTSTR,ALTEND                                                    
         MVI   ALTTHRU,C'-'                                                     
*                                                                               
INTDTE48 GOTO1 DATCON,DMCB,(1,ALTNEND),(8,ALTEND)                               
         GOTO1 DATCON,DMCB,(1,ALTNEND),(3,ALTENDTE)                             
         OC    RMOAALT,RMOAALT                                                  
         BZ    INTDTE50            NO MOA TO OVERIDE                            
         TM    DATEFLT,DATEBIL                                                  
         BZ    *+10                Billing date only                            
         MVC   RMOAALTE,ALTNEND    Override for billed MOA                      
         MVC   ALTREL,ALTENDTE                                                  
         CLC   ALTNSTR,ALTNEND                                                  
         BNE   INTDTE50                                                         
         MVC   ALTTHRU(10),SPACES                                               
***********************************************************************         
*  SET UP ACTIVITY DATES                                              *         
***********************************************************************         
         SPACE 1                                                                
INTDTE50 GOTO1 DATCON,DMCB,(3,ALTREL),(0,ALTADDDT)                              
         CLC   QACTSTRT(L'QACTSTRT+L'QACTEND),SPACES   ACTIVITY DATES ?         
         BE    INTDTE55                                NO                       
         MVC   ACTSTR(4),AC@THRU                                                
         CLC   QACTSTRT,SPACES                ACTIVITY START USED ?             
         BE    INTDTE52                       NO                                
         MVC   ACTSTR(4),AC@FROM                                                
         GOTO1 DATCON,DMCB,(0,QACTSTRT),(8,ACTEND)                              
*                                                                               
INTDTE52 CLC   QACTEND,SPACES                 ACTIVITY END USED ?               
         BE    INTDTE55                       NO                                
         CLC   ACTSTR(4),AC@FROM                                                
         BNE   INTDTE54                                                         
         MVC   ACTSTR,ACTEND                                                    
         MVI   ACTTHRU,C'-'                                                     
*                                                                               
INTDTE54 GOTO1 DATCON,DMCB,(0,QACTEND),(8,ACTEND)                               
         CLC   ACTSTR,ACTEND                                                    
         BNE   INTDTE55                                                         
         MVC   ACTTHRU(10),SPACES                                               
***********************************************************************         
*  SET UP DATES IN QUARTER TABLE                                      *         
***********************************************************************         
         SPACE 1                                                                
INTDTE55 MVI   STARTYR+2,X'01'        SET TO FIRST DAY OF MONTH                 
         OC    STARTYR(2),STARTYR     ANY YYMM SET BASED ON REQUEST             
         BNZ   INTDTE56               YES, ALREADY SET                          
         MVC   STARTYR+1(1),FSCLMONB  DEFAULT  TO COMPANY FISCAL MONTH          
         MVC   STARTYR(1),RELEND      SET YEAR TO DEFAULT RELATIVE DATE         
         CLC   STARTYR(2),RELEND      IS START DATE AFTER END  ?                
         BNH   INTDTE56               NO                                        
         SR    R1,R1                  YES SO, LESS ONE YEAR                     
         IC    R1,STARTYR             GET START YEAR                            
         BCTR  R1,0                                                             
         STC   R1,STARTYR                                                       
*                                                                               
INTDTE56 SR    R1,R1                                                            
         IC    R1,RELEND              GET  END YEAR                             
         SHI   R1,1                   LESS ONE YEAR                             
         BP    *+6                                                              
         DC    H'00'                                                            
                                                                                
         MVC   WORK(2),RELEND                                                   
         STC   R1,WORK                                                          
         CLC   WORK(2),STARTYR        MUST BE A 1 YEAR RANGE                    
         BL    INTDTE58                                                         
         MVC   STARTYR(1),RELEND                                                
*                                                                               
         USING QTRD,R5                                                          
INTDTE58 LA    R0,4                FOUR QUARTER PAIRS                           
         L     R5,QTRBASE                                                       
         MVC   QTRSTRB,STARTYR                                                  
         MVI   QTRSTRB+2,1         MAKE DAY 01 OF YYMMDD                        
*                                                                               
INTDTE60 GOTO1 DATCON,DMCB,(3,QTRSTRB),(0,QTRSTRC)                              
         GOTO1 ADDAY,DMCB,(C'M',QTRSTRC),(X'80',QTRENDC),F'2'                   
         GOTO1 DATCON,DMCB,(0,QTRENDC),(3,QTRENDB)                              
*&&UK                                                                           
         CHI   R0,1                END OF QTRSTAB TABLE                         
         BNH   INTDTE62            YES                                          
*&&                                                                             
         MVC   TEMPDATE,QTRENDC                                                 
         LA    R5,QTRLNQ(,R5)      NEXT PAIR                                    
         GOTO1 DATCON,DMCB,(X'30',TEMPDATE),(3,QTRSTRB),(2,0)                   
         BCT   R0,INTDTE60                                                      
         DROP  R5                                                               
*                                                                               
INTDTE62 GOTO1 GETQTR,DMCB,RELEND,CURQTR                                        
         GOTO1 GETQTR,DMCB,ALTREL,ALTCURQT                                      
***********************************************************************         
*  INITIALIZE DATES FOR REVERSIAL TYPE 55,56                          *         
***********************************************************************         
         SPACE 1                                                                
         MVC   BAT55MOS,=X'FFFFFF' INITIALIZE TO X'FF'                          
         CLC   QMOSEND,SPACES      ANY MOA END DATE ?                           
         BE    INTDTE73            NO                                           
         MVC   WORK(4),QMOSEND                                                  
         MVC   WORK+4(2),=C'01'                                                 
         GOTO1 DATCON,DMCB,(0,WORK),(1,WORK+6)                                  
         MVC   BAT55MOS,WORK+6     SAVE CURRENT MOS                             
*                                                                               
INTDTE73 MVC   BAT55DTE,=X'FFFFFF' INITIALIZE TO X'FF'                          
         CLC   ENDATE,=X'FFFFFF'   IF NO END DATE THEN EXIT                     
         BE    INTDTE80            ELSE  SUBTRACT ONE MONTH                     
         GOTO1 DATCON,DMCB,(3,ENDATE),(0,TEMPDATE)                              
         GOTO1 ADDAY,DMCB,(C'M',TEMPDATE),TEMPDATE,F'-1'                        
         GOTO1 DATCON,DMCB,(0,TEMPDATE),(1,BAT55DTE)                            
*                                                                               
         USING ACMD,R2                                                          
         USING CPRCNDRD,R3                                                      
INTDTE80 L     R2,AMONACC                                                       
         L     R3,ACNDRBLK                                                      
         CLC   QSTART,SPACES       Is there a start date ?                      
         BE    INTDTE82            No                                           
         GOTO1 DATCON,DMCB,(3,STDATE),(1,ACMTSTR)                               
         MVC   RTRNSTR,ACMTSTR                                                  
         MVC   RTRNEND,=X'FFFFFF'                                               
*                                                                               
         CLC   QSTART+4(2),SPACES  Was it in the form YYMM, without DD          
         BNE   INTDTE82            No, Only person scribe allows that           
         OI    REQIND,REQCMTH      Set to say calednar month request            
         MVC   RQCALSTR,RTRNSTR    Move in YYMM (Calendar start)                
         MVC   CPROF,SPACES                                                     
         MVC   CPRYM,RTRNSTR                                                    
                                                                                
INTDTE81 GOTO1 AGETCNDR,DMCB,ACNDRBLK,1                                         
         BE    INTDT81A                                                         
         TM    CPRERR,CPRNF                                                     
         BZ    INTDT81A                                                         
         MVI   ERROR#,8            INVALID CALENDAR                             
         B     INTDTE90                                                         
                                                                                
INTDT81A MVC   RELCSYR(1),CPRYEAR          PACKED YY                            
                                                                                
         USING FMTRECD,R6                                                       
INTDTE82 L     R6,AFORMATS         Point to main format data                    
         CLC   QEND,SPACES         Is there an end date ?                       
         BNE   INTDT82A                                                         
         CLI   QPROG,MANPOWER                                                   
         BNE   INTDTE90            No, then finished here                       
*&&US*&& TM    FMTROPT7,RPFFPDRD                                                
*&&UK*&& TM    FMTROPT6,RPFFPDRD                                                
         BZ    INTDTE90                                                         
         GOTO1 DATCON,DMCB,(5,0),(3,ENDATE)                                     
         B     INTDT82B                                                         
*                                                                               
INTDT82A CLI   QPROG,MANPOWER      PERSON SCRIBE ONLY                           
         BNE   INTDTE84                                                         
         CLC   QEND+4(2),SPACES    Was it in the form YYMM                      
         BE    INTDTE84                                                         
*&&US*&& TM    FMTROPT7,RPFFPDRD                                                
*&&UK*&& TM    FMTROPT6,RPFFPDRD                                                
         BNO   INTDTE84                                                         
*                                                                               
INTDT82B GOTO1 DATCON,DMCB,(3,ENDATE),(1,WORK+3)                                
         MVC   SVENDTE,WORK+3                                                   
         MVC   CPROF,SPACES        retrieve calendar for day                    
         MVC   CPRYMD,WORK+3                                                    
         GOTO1 AGETCNDR,DMCB,ACNDRBLK,13                                        
         BE    INTDTE83                                                         
         TM    CPRERR,CPRNF                                                     
         BZ    INTDTE83                                                         
         MVI   ERROR#,8            INVALID CALENDAR                             
         B     INTDTE90                                                         
INTDTE83 MVC   RTRNEND,WORK+3                                                   
         MVC   ACMTEND,WORK+3                                                   
         GOTO1 DATCON,DMCB,(1,ACMTEND),(3,ENDATE)                               
         B     INTDT84A                                                         
*                                                                               
INTDTE84 MVC   WORK(3),ENDATE      Set work to end date                         
         GOTO1 DATCON,DMCB,(3,ENDATE),(1,RTRNEND)                               
INTDT84A MVC   RELCDATE,RTRNEND                                                 
*                                                                               
         CLC   QEND,SPACES                                                      
         BE    INTDTE86                                                         
         CLC   QEND+4(2),SPACES    Was it in the form YYMM                      
         BNE   INTDTE86            No, only person scribe allows that           
         OI    REQIND,REQCMTH      Set request as calendar months               
         MVC   RQCALEND,RTRNEND    Move YYMM (Calednar end)                     
         MVC   CPROF,SPACES                                                     
         MVC   CPRYM,RTRNEND                                                    
                                                                                
INTDTE85 GOTO1 AGETCNDR,DMCB,ACNDRBLK,2                                         
         BE    INTDT85A                                                         
         TM    CPRERR,CPRNF                                                     
         BZ    INTDT85A                                                         
         MVI   ERROR#,8                                                         
         B     INTDTE90                                                         
                                                                                
INTDT85A MVC   RELCEYR(1),CPRYEAR      PACKED YY                                
         DROP  R3                                                               
                                                                                
INTDTE86 CLI   QPROG,PRODUCTION    INCREASE END DATE BY 1 MONTH                 
         BNE   INTDTE88                                                         
         GOTO1 DATCON,DMCB,(3,WORK),(0,TEMPDATE)                                
         GOTO1 ADDAY,DMCB,(C'M',TEMPDATE),TEMPDATE,F'1'                         
         GOTO1 DATCON,DMCB,(0,TEMPDATE),(3,WORK)                                
*                                                                               
INTDTE88 DS    0H                                                               
*&&US*&& TM    FMTROPT7,RPFFPDRD      ACMTEND already set earlier               
*&&UK*&& TM    FMTROPT6,RPFFPDRD      ACMTEND already set earlier               
         BO    INTDTE90                                                         
         GOTO1 DATCON,DMCB,(3,WORK),(1,ACMTEND)                                 
*                                                                               
INTDTE90 XMOD1 1                                                                
         DROP  R2,R6                                                            
         EJECT ,                                                                
***********************************************************************         
* Get quarter number based on date                                              
***********************************************************************         
         USING QTRD,R5                                                          
GETQTR   NTR1                                                                   
         L     RE,0(,R1)           RELATIVE DATE YYMMDD (BINARY)                
         L     RF,4(,R1)           WHERE TO STORE                               
         L     R5,QTRBASE                                                       
         LA    R1,1                                                             
GETQTR10 CLC   QTRSTRBM,QTRENDBM   START MONTH > END MONTH                      
         BL    GETQTR20                                                         
         CLC   QTRENDBM,1(RE)      END MONTH                                    
         BNL   GETQTR90            IF HIGH OR EQUAL THEN CURRENT QTR            
         CLC   QTRSTRBM,1(RE)      START MONTH                                  
         BNH   GETQTR90            IF LOW OR EQUAL THEN CURRENT QTR             
         B     GETQTR30            ELSE LOOP                                    
*                                                                               
GETQTR20 CLC   QTRSTRBM,1(RE)      START MONTH                                  
         BH    GETQTR30            IF HIGH THEN LOOP                            
         CLC   QTRENDBM,1(RE)      END MONTH                                    
         BNL   GETQTR90            IF HIGH OR EQUAL THEN HAVE IT                
GETQTR30 LA    R1,1(,R1)                                                        
         LA    R5,QTRLNQ(,R5)                                                   
         B     GETQTR10                                                         
*                                                                               
GETQTR90 STC   R1,0(,RF)           R1 = 1 TO 4 FOR QTR 1,2,3 OR 4               
         XIT1                                                                   
         DROP  R5                                                               
         EJECT 1                                                                
         LTORG                                                                  
         TITLE 'SET UP COLUMN DATES BASED ON CALENDAR AND OFFICE'               
***********************************************************************         
*  COLUMN CALENDAR DATES BY OFFICE                                    *         
***********************************************************************         
         SPACE 1                                                                
         USING ACWORKD,RC                                                       
         USING ACRLD,RA                                                         
         USING CPRCNDRD,R2                                                      
         USING COLD,R3                                                          
         USING FMTRECD,R5                                                       
         USING CDRD,R6                                                          
SETCDTES DS    0D                                                               
         NMOD1 0,**COLD**                                                       
         L     RC,RLBASEC                                                       
         TM    RECREAD1,RECCLDR                                                 
         BZ    SETCDTEX            FORGET ABOUT IT                              
         L     R2,ACNDRBLK                                                      
         MVC   CPROF,SPACES                                                     
         MVC   CPRYMD,RELEND2                                                   
         GOTO1 AGETCNDR,DMCB,ACNDRBLK,3                                         
         BE    SETCD08                                                          
         TM    CPRERR,CPRNF                                                     
         BO    SETCDNO                                                          
***********************************************************************         
*    Figure out what years to get and save info in column data        *         
***********************************************************************         
         SPACE 1                                                                
SETCD08  MVC   CNDREND,CPREMOA                                                  
         SR    R8,R8                                                            
         ICM   R8,1,FMT#COLS       NUMBER OF COLUMNS                            
         BZ    SETCD41                                                          
         L     R3,FMTCOL           RESET TO START OF COLUMNS                    
SETCD10  TM    COLIND1,COLCNDR                                                  
         BZ    SETCD40                                                          
         TM    COLFLAGS,COLAMT                                                  
         BZ    SETCD40                                                          
         XC    COLCALY1,COLCALY1   YEAR FOR START CALENDAR                      
         XC    COLCALY2,COLCALY2   YEAR FOR END   CALENDAR                      
         XC    CPRYMD,CPRYMD                                                    
         MVC   CPRYY,COLPERYR      INITIALIZE YEAR VALUE                        
         MVC   CPROF,SPACES        SET DEFAULT CALENDAR OFFICE (SPACES)         
         L     R6,ACNDRWRK         A(EXPANDED CALENDAR) TEMPORARY SPACE         
         TM    COLDTTYP,COLPFX#    FIXED PERIOD TYPE                            
         BO    SETCD20                                                          
         TM    COLDTTYP,COLPRNG    RANGE OF PERIODS                             
         BO    SETCD30                                                          
*                                                                               
SETCD12  OC    COLCSMOA,COLCSMOA   ANY CALENDAR MOA START?                      
         BNZ   SETCD14                                                          
         CLC   COLCEMOA,=X'FFFF'   ANY CALENDAR MOA END?                        
         BE    SETCD40             DATE SET TO INFINITY  (NO DATES)             
         B     SETCD16             NO START DATE, HAS END DATE                  
*                                                                               
SETCD14  MVC   CPRYM,COLCSMOA      Focus on start MOA year                      
         MVC   CPROF,SPACES                                                     
*                                                                               
         GOTO1 AGETCNDR,DMCB,ACNDRBLK,5                                         
         MVC   COLCALY1,CPRYEAR    YEAR OF POSSIBLE CALENDAR FOR COL            
         BE    SETCD16                                                          
         TM    CPRERR,CPRNF                                                     
         BO    SETCDNO                                                          
*============================================================                   
*  VERIFY CALENDAR FOR MON, YTD, QTR, M1 - M12, Q1-Q4, PER  *                   
*============================================================                   
         SPACE 1                                                                
SETCD16  CLC   COLCEMOA,=X'FFFF'   FOCUS ON END MOA YEAR                        
         BE    SETCD40             no end date so don't bother                  
         MVC   CPRYY,COLCEMOA      Try end MOA                                  
         MVC   CPROF,SPACES                                                     
*                                                                               
SETCD18  GOTO1 AGETCNDR,DMCB,ACNDRBLK,6                                         
         MVC   COLCALY2,CPRYEAR    YEAR OF POSSIBLE CALENDAR FOR COL            
         BE    SETCD40                                                          
         TM    CPRERR,CPRNF                                                     
         BZ    SETCD40                                                          
         B     SETCDNO                                                          
         EJECT ,                                                                
*===================================                                            
*  VERIFY CALENDAR FOR P1 - P99    *                                            
*===================================                                            
         SPACE 1                                                                
SETCD20  MVC   CPRMM,FSCLMONP      Set month for more accurate calender         
         GOTO1 AGETCNDR,DMCB,ACNDRBLK,7                                         
         MVC   COLCALY1,CPRYEAR    Hopefully the correct year                   
         BE    SETCD40                                                          
         TM    CPRERR,CPRNF        Record not found ?                           
         BZ    SETCD40                                                          
         B     SETCDNO                                                          
         EJECT ,                                                                
*=====================================                                          
*  VERIFY CALENDAR FOR PERIOD RANGE  *                                          
*=====================================                                          
         SPACE 1                                                                
SETCD30  MVC   CPRYM,RELCDATE                                                   
         TM    REQIND,REQCMTH      Calendar month or period based ?             
         BZ    *+10                Period based (YYMMDD)                        
         MVC   CPRYMD,RELCDATE                                                  
         GOTO1 AGETCNDR,DMCB,ACNDRBLK,8                                         
         MVC   COLCALY1,CPRYEAR    Set possible calendar year for col           
         BE    SETCD40                                                          
         TM    CPRERR,CPRNF        Record not found                             
         BZ    SETCD40                                                          
         B     SETCDNO                                                          
                                                                                
SETCD40  LA    R3,COLLNQ(,R3)      Next column                                  
         BCT   R8,SETCD10                                                       
***********************************************************************         
*    Set up date block by office and date pairs                       *         
***********************************************************************         
         SPACE 1                                                                
         USING DTED,R4                                                          
SETCD41  L     R4,FMTDTED                                                       
         SR    R7,R7                                                            
         IC    R7,CPR#OFC          Number of offices to process                 
         LA    R7,1(,R7)           Add one for blank office                     
         LA    R8,CPROFLST         Point to list of offices                     
         MVC   DTEOFF,SPACES       Build list of offices and col dates          
         BAS   RE,FILLPED                                                       
         CLI   ERROR#,0                                                         
         BNE   SETCDTEX                                                         
*                                                                               
SETCD42  LA    R4,DTECOL           Bump past office / related data              
         XC    CPRYMD,CPRYMD                                                    
*                                                                               
         USING DTECOL,R4                                                        
         L     R3,FMTCOL           Initialize date block by office              
         SR    R0,R0               R0 = number of columns                       
         ICM   R0,1,FMT#COLS                                                    
         BZ    SETCD48                                                          
         SR    RF,RF                                                            
SETCD44  TM    COLIND1,COLCNDR     Calendar date needed ?                       
         BZ    SETCD46             No                                           
         TM    COLFLAGS,COLAMT     Yes, is it an amount column ?                
         BZ    SETCD46             No                                           
         XC    DTESTRT,DTESTRT     Yes, so initialize dates                     
         MVC   DTEEND,=X'FFFFFF'                                                
         ZAP   DTE#PEDS,PKZERO                                                  
         STC   RF,COLDTE#          Store number of column processed             
         LA    RF,1(,RF)           RF = number of columns built                 
         LA    R4,L'DTECOL(,R4)    Next date for column                         
SETCD46  LA    R3,COLLNQ(,R3)                                                   
         BCT   R0,SETCD44          Ran through format columns                   
*                                  R4  will point to next entry now             
         USING DTED,R4                                                          
SETCD48  MVC   DTEOFF,0(R8)        Move in office off of R8                     
         CHI   R7,1                Last office ?                                
         BE    SETCD49             Yes                                          
         BAS   RE,FILLPED          Initialize PED in DTED                       
         CLI   ERROR#,0                                                         
         BNE   SETCDTEX                                                         
         LA    R8,2(,R8)           Bump up in list of offices                   
         BCT   R7,SETCD42          Process next office                          
*                                                                               
SETCD49  XC    DTEOFF,DTEOFF       Clear out last office, marking EOT           
         LA    R4,L'DTEOFF(,R4)    Bump up to pass EOT mark                     
         ST    R4,ADATEHDS         Store end or begining of next table          
*                                                                               
         L     R4,FMTDTED          Reload beging of this formats table          
         IC    R7,CPR#OFC          Number of offices to process                 
         LA    R7,1(,R7)           Add one for office blank                     
SETCD50  MVC   CPROF,DTEOFF        Office to process                            
         MVC   CALOFFC,DTEOFF                                                   
***********************************************************************         
*    For each column figure out date pairs and fill in date table     *         
***********************************************************************         
         SPACE 1                                                                
         SR    R0,R0                                                            
         ICM   R0,1,FMT#COLS       NUMBER OF COLUMNS                            
         BZ    SETCDTEX                                                         
         L     R3,FMTCOL           RESET TO START OF COLUMNS                    
         LA    R4,DTECOL           BUMP PAST OFFICE/DATA                        
*                                                                               
         USING DTECOL,R4                                                        
SETCD52  TM    COLIND1,COLCNDR                                                  
         BZ    SETCD90             TRY NEXT COLUMN                              
         TM    COLFLAGS,COLAMT                                                  
         BZ    SETCD90                                                          
         CLI   COLCALY1,0          ANY START YEAR ?                             
         BE    SETCD80             NO, SO SET TO   NULL                         
         CLC   CPROF,CPROFFC       DO WE WANT THIS OFFICE ?                     
         BNE   SETCD52A            NO NOT THE ONE  WE WANT                      
         CLC   CPRYY,COLCALY1      DO WE WANT THIS YEAR   ?                     
         BE    SETCD53             YES,  USE  THIS CALANDER                     
*                                                                               
SETCD52A MVC   CPROF,CALOFFC       SET TO GET THIS OFFICE CALENDAR              
         MVC   CPRYY,COLCALY1      SET TO GET THIS YEAR                         
         GOTO1 AGETCNDR,DMCB,ACNDRBLK,9                                         
         BE    *+6                                                              
         DC    H'00'                                                            
*                                                                               
SETCD53  L     R6,ACNDRWRK         A(EXPANDED CALENDAR DATA)                    
         TM    COLDTTYP,COLPFX#    FIXED PERIOD                                 
         BZ    SETCD54                                                          
         SR    R1,R1                                                            
         IC    R1,COLPERST         GET PERIOD NUMBER                            
         BCTR  R1,0                LESS ONE FOR ARRAY ADJUSTMENT                
         MHI   R1,CDRLNQ                                                        
         AR    R6,R1                                                            
         MVC   DTESTRT,CDRSDATE    SET START DATE OF PERIOD                     
         MVC   DTEEND,CDREDATE                                                  
         CLC   COLPERST,CDRPRD#                                                 
         BNE   SETCD86                                                          
         B     SETCD88                                                          
*                                                                               
SETCD54  TM    COLDTTYP,COLPRNG    Period range ?                               
         BZ    SETCD70             No                                           
         TM    REQIND,REQCMTH      Requested with calendar months ?             
         BO    SETCD55             Yes                                          
         CLI   CDRPRD#,0                                                        
         BNE   *+6                                                              
         DC    H'00'                                                            
*                                                                               
         CLC   CDRSDATE,RELCDATE                                                
         BH    SETCD57                                                          
         CLC   CDREDATE,RELCDATE                                                
         BL    SETCD57                                                          
         B     SETCD58             FOUND ENTRY IN CALENDAR                      
*                                                                               
SETCD55  CLI   CDRPRD#,0           LAST ONE ?                                   
         BE    SETCD56             YES, SO MUST BE PREVIOUS ONE                 
         CLC   CDRMOA,RELCDATE     FIND LAST YYMM MATCH                         
         BNH   SETCD57             KEEP BUMPING UP                              
*                                                                               
SETCD56  AHI   R6,-CDRLNQ          BACK UP ONE                                  
         CLC   CDRMOA,RELCDATE     MUST MATCH NOW                               
         BE    SETCD58             YEP, FOUND ENTRY IN CALENDAR                 
         DC    H'00'               WRONG CALENDAR ?                             
*                                                                               
SETCD57  LA    R6,CDRLNQ(,R6)                                                   
         B     SETCD54                                                          
*                                                                               
SETCD58  XC    CALSTPER,CALSTPER   FOUND RELATIVE BASE PERIOD                   
         XC    CALEDPER,CALEDPER                                                
         TM    COLPERST,X'80'      NEGATIVE BYTE?                               
         BZ    *+10                                                             
         MVC   CALSTPER,=X'FFFF'                                                
         MVC   CALSTPER+1(1),COLPERST                                           
         TM    COLPERED,X'80'      NEGATIVE BYTE?                               
         BZ    *+10                                                             
         MVC   CALEDPER,=X'FFFF'                                                
         MVC   CALEDPER+1(1),COLPERED                                           
*                                                                               
         LH    RF,CALEDPER         DO END PERIOD FIRST                          
         GOTO1 ADJPER,DMCB,(RF),(R6)                                            
         CLI   ERROR#,0                                                         
         BNE   SETCDTEX                                                         
         MVC   DTEEND,CDREDATE     END PERIOD                                   
         LH    RF,CALSTPER         DIFFERENCE = (START - END)                   
         SH    RF,CALEDPER                                                      
         GOTO1 ADJPER,DMCB,(RF),(R6)                                            
         CLI   ERROR#,0                                                         
         BNE   SETCDTEX                                                         
         MVC   DTESTRT,CDRSDATE    START PERIOD                                 
         B     SETCD88                                                          
*                                                                               
SETCD70  TM    COLDTTYP,COLPMON    PERIOD MONTH                                 
         BZ    SETCD75                                                          
*                                                                               
SETCD72  CLI   0(R6),0                                                          
         BNE   *+6                                                              
         DC    H'00'                                                            
         CLC   COLCSMOA,CDRMOA                                                  
         BE    SETCD74                                                          
         LA    R6,CDRLNQ(,R6)                                                   
         B     SETCD72                                                          
*                                                                               
SETCD74  SR    R1,R1                                                            
         IC    R1,COLPERST         PERIOD # IN MONTH                            
         BCTR  R1,0                                                             
         MHI   R1,CDRLNQ                                                        
         AR    R6,R1                                                            
         MVC   DTESTRT,CDRSDATE                                                 
         MVC   DTEEND,CDREDATE                                                  
         CLC   COLCSMOA,CDRMOA                                                  
         BNE   SETCD86                                                          
         B     SETCD88                                                          
*                                                                               
SETCD75  TM    COLDTTYP,COLMNTH    MONTH DATES                                  
         BO    *+6                                                              
         DC    H'00'               NOT A VALID DATE TYPE                        
*                                                                               
         OC    COLCSMOA,COLCSMOA   ANY MONTH SPECIFIED?                         
         BZ    SETCD80             NO                                           
*                                                                               
SETCD77  CLI   0(R6),0                                                          
         BNE   *+6                                                              
         DC    H'00'                                                            
*                                                                               
         CLC   COLCSMOA,CDRMOA     MATCH ON START MONTH                         
         BE    *+12                                                             
         LA    R6,CDRLNQ(,R6)                                                   
         B     SETCD77                                                          
*                                                                               
         MVC   DTESTRT,CDRSDATE                                                 
SETCD80  CLC   COLCEMOA,=X'FFFF'   ANY MONTH SPECIFIED?                         
         BE    SETCD85                                                          
         CLC   COLCALY1,COLCALY2                                                
         BE    SETCD82                                                          
         MVC   CPROF,CALOFFC       RESET OFFICE                                 
         MVC   CPRYY,COLCALY2      GET END DATE CALENDAR YEAR                   
         GOTO1 AGETCNDR,DMCB,ACNDRBLK,10                                        
         BE    *+6                                                              
         DC    H'00'                                                            
*                                                                               
         L     R6,ACNDRWRK         A(EXPANDED CALENDAR DATA)                    
SETCD82  CLI   0(R6),0                                                          
         BE    SETCD84                                                          
         CLC   COLCEMOA,CDRMOA     MATCH ON END MONTH                           
         BL    SETCD84                                                          
         LA    R6,CDRLNQ(,R6)                                                   
         B     SETCD82                                                          
*                                                                               
SETCD84  AHI   R6,-CDRLNQ                                                       
         MVC   DTEEND,CDREDATE                                                  
*                                                                               
SETCD85  TM    COLDTTYP,COL2DTE                                                 
         BZ    SETCD88                                                          
         CLC   DTEEND,RELEND2                                                   
         BNH   SETCD88                                                          
         MVC   DTEEND,RELEND2      END IT EARLIER THEN CALENDAR                 
         B     SETCD88                                                          
*                                                                               
SETCD86  MVC   DTESTRT,=X'FFFFFF'                                               
         XC    DTEEND,DTEEND                                                    
*                                                                               
SETCD88  TM    COLIND1,COLCNDR     IF CALENDAR COLUMN THEN                      
         BZ    SETCD90                                                          
         CLC   COLDD#,=AL2(AC#RSMWR) Man week ratio column ?                    
         BNE   *+8                                                              
         BAS   RE,PEDDIFF                                                       
         LA    R4,L'DTECOL(,R4)    BUMP TO NEXT DATE COLUMN                     
*                                                                               
SETCD90  LA    R3,COLLNQ(,R3)                                                   
         BCT   R0,SETCD52          NEXT COLUMN                                  
         BCT   R7,SETCD50          NEXT OFFICE                                  
         B     SETCDTEX                                                         
*                                                                               
SETCDNO  MVI   ERROR#,8            INVALID CALENDAR                             
*                                                                               
SETCDTEX XIT1                                                                   
         DROP  R5                                                               
         EJECT                                                                  
***********************************************************************         
*  Figure out number of periods between dates                         *         
***********************************************************************         
         SPACE 1                                                                
         USING DTECOL,R4                                                        
PEDDIFF  NTR1                                                                   
         OC    DTESTRT,DTESTRT     Any start date ?                             
         BNZ   *+6                                                              
         DC    H'00'               Need start date (Re-think logic)             
*                                                                               
         CLI   DTEEND,X'FF'        Any end   date ?                             
         BNE   *+6                                                              
         DC    H'00'               Need start date (Re-think logic)             
*                                                                               
         MVC   CPROF,CALOFFC       Reset office                                 
         MVC   CPRYMD,DTESTRT       Get start period                            
         GOTO1 AGETCNDR,DMCB,ACNDRBLK,14                                        
         BE    *+6                                                              
         DC    H'00'                                                            
*                                                                               
*        CLC   DTESTRT,CPREDATE    Is it within the calendar ?                  
*        BNH   PEDDI15             Yes, so far so good                          
*        GOTO1 =A(UPYEAR)          Increase year in CPRYY by 1                  
*        MVC   CPROF,CALOFFC       Reset office                                 
*        GOTO1 AGETCNDR,DMCB,ACNDRBLK,15                                        
*        BE    *+6                                                              
*        DC    H'00'                                                            
*                                  * Check current calendar record *            
PEDDI15  L     R6,ACNDRWRK         A(Expanded calendar)                         
         CLC   DTESTRT,CDRSDATE                                                 
         BNL   *+6                                                              
         DC    H'00'               Less then first period, humm                 
*                                                                               
         LA    R0,1                Intialize number of periods within           
         SR    R1,R1                                                            
         IC    R1,CPR#PRD          Total number of periods                      
PEDDI20  CLC   DTESTRT,CDREDATE    Less or equal to end date ?                  
         BNH   PEDDI25             Found first period to match                  
         LA    R6,CDRLNQ(,R6)      Next period                                  
         BCT   R1,PEDDI20                                                       
         DC    H'00'                                                            
*                                                                               
PEDDI25  CLC   DTEEND,CDREDATE                                                  
         BNH   PEDDI50             Found end period                             
         AHI   R0,1                Count the number of periods                  
         LA    R6,CDRLNQ(,R6)      Next period                                  
         BCT   R1,PEDDI25                                                       
*                                                                               
         GOTO1 =A(UPYEAR)          Increase year in CPRYY by 1                  
         MVC   CPROF,CALOFFC       Reset office                                 
         GOTO1 AGETCNDR,DMCB,ACNDRBLK,16                                        
         BE    *+6                                                              
         DC    H'00'                                                            
*                                  * Check current calendar record *            
         L     R6,ACNDRWRK         A(Expanded calendar)                         
         AHI   R0,1                Count the number of periods                  
         SR    R1,R1                                                            
         IC    R1,CPR#PRD          Total number of periods                      
         B     PEDDI25             Keep going                                   
*                                                                               
PEDDI50  CVD   R0,DUB                                                           
         ZAP   DTE#PEDS,DUB        Save nubmer of periods                       
         XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
*  FILL IN DATE BLOCK FOR COLUMNS BASED ON CALENDAR DATA              *         
***********************************************************************         
         SPACE 1                                                                
         USING DTED,R4                                                          
FILLPED  NTR1                                                                   
         MVC   CPROF,DTEOFF                                                     
         XC    CPRYMD,CPRYMD                                                    
         MVC   CPRYM,CNDREND       END YEAR                                     
         GOTO1 AGETCNDR,DMCB,ACNDRBLK,11                                        
         BNE   FILLPNO                                                          
*                                                                               
         L     R6,ACNDRWRK         A(EXPANDED CALENDAR)                         
FILLPD10 CLI   CDRPRD#,0                                                        
         BNE   *+6                                                              
         DC    H'00'                                                            
*                                                                               
         CLC   RELEND2,CDREDATE    FIND PERIOD OF RELATIVE END DATE             
         BNH   *+12                                                             
         LA    R6,CDRLNQ(,R6)                                                   
         B     FILLPD10                                                         
*                                                                               
         MVC   DTEPEDST,CDRSDATE   SAVE OFF IN TABLE                            
         MVC   DTEPEDEN,CDREDATE                                                
         B     FILLPOK                                                          
*                                                                               
FILLPNO  MVI   ERROR#,8            BAD CALENDAR                                 
FILLPOK  XIT1                                                                   
         DROP  R2,R3,R4,R6                                                      
CNDREND  DS    CL2                 YYMM OF CALENDAR YEAR FOR RELEND2            
         EJECT                                                                  
***********************************************************************         
*  R1 = # OF PERIODS TO GO FORWARD OR BACKWARD                        *         
*  R2 = COMPRESSED CALENDAR INFORMATION                               *         
*  R6 = EXPANDED CALENDAR ENTRIES                                     *         
***********************************************************************         
         SPACE 1                                                                
         USING CDRD,R6                                                          
         USING CPRCNDRD,R2                                                      
ADJPER   NTR1                                                                   
         L     R6,4(,R1)           CURRENT CALENDAR ENTRY                       
         L     R1,0(,R1)           # OF PERIODS FORWARD OR BACKWARDS            
         LPR   R3,R1               SET FOR BCT TYPE LOOP                        
         LA    R4,CDRLNQ           TO BUMP FORWARDS  (ENTRY LENGTH)             
         MVC   BYTE,CPR#PRD                                                     
         LTR   R1,R1                                                            
         BZ    ADJPEROK            NONE, IF ZERO                                
         BP    ADJPER10                                                         
         MVI   BYTE,1              TO CHECK FOR START OF TABLE                  
         LNR   R4,R4               TO BUMP BACKWARDS (ENTRY LENGTH)             
*                                                                               
ADJPER10 CLC   CDRPRD#,BYTE        CHECK FOR START OF END OF TABLE              
         BE    ADJPER20            FOUND, SO GET NEXT CALENDAR                  
         AR    R6,R4               BUMP FORWARD OR BACKWARDS                    
*                                                                               
ADJPER15 BCT   R3,ADJPER10         TRY NEXT PERIOD                              
         B     ADJPEROK            RAN OUT SO FOUND THE ONE WE WANTED           
*                                                                               
ADJPER20 MVC   WORK+1(2),=X'1231'  JUST WANT YEAR PORTION                       
         MVI   DMCB+8,2            First day of next month                      
         LTR   R4,R4               LAST YEAR OR NEXT YEAR ?                     
         BP    ADJPER22            NEXT                                         
         MVC   WORK+1(2),=X'0101'                                               
         MVI   DMCB+8,4            FIRST DAY OF PREVIOUS MONTH                  
*                                                                               
ADJPER22 MVC   WORK(1),CPRYY                                                    
         GOTO1 DATCON,DMCB,(X'31',WORK),(1,WORK)                                
         MVC   CPRYY,WORK                                                       
         MVC   CPROF,CALOFFC                                                    
         GOTO1 AGETCNDR,DMCB,ACNDRBLK,12                                        
         BE    ADJPER25                                                         
         TM    CPRERR,CPRNF        Record not found                             
         BO    ADJPERNO                                                         
                                                                                
ADJPER25 MVC   BYTE,CPR#PRD                                                     
         SR    R6,R6                                                            
         LTR   R4,R4                                                            
         BP    ADJPER30            POINT TO START OF TABLE                      
         IC    R6,CPR#PRD          BUMP TO LAST PERIOD                          
         BCTR  R6,0                                                             
         MHI   R6,CDRLNQ           POINT TO END OF TABLE                        
         MVI   BYTE,1              TO CHECK FOR START OF TABLE                  
*                                                                               
ADJPER30 A     R6,ACNDRWRK                                                      
         B     ADJPER15            TIME TO KEEP GOING                           
*                                                                               
ADJPERNO MVI   ERROR#,8            NO CALENDAR                                  
*                                                                               
ADJPEROK XIT1  REGS=(R6)                                                        
         DROP  R2,R6                                                            
         SPACE 1                                                                
CALSTPER DS    HL2                 CALENDAR START RELATIVE PERIOD               
CALEDPER DS    HL2                 CALENDAR END   RELATIVE PERIOD               
CALOFFC  DS    CL2                                                              
         LTORG                                                                  
         TITLE 'Get calendar record'                                            
***********************************************************************         
*   Retrieve calendar record based on date and optional office        *         
*           Set CPRYY  to get calendar for that year                  *         
*           Set CPRYM  to get calendar with that year month           *         
*           Set CPRYMD to get calendar with this date                 *         
*           Set CPYOF  to get possible office calendar for date       *         
*           P1   =   Calendar block - see CPRCNDRD USING              *         
*                                                                     *         
*           Return   Set condition code to equal if no errors         *         
*                    CPRSDATE set - Start of calendar                 *         
*                    CPREDATE set - End   of calendar                 *         
*                    CPRSMOA  set - Start month of calendar           *         
*                    CPREMOA  set - End   month of calendar           *         
*                    CPREXPC  set - A(Expanded calendar)              *         
***********************************************************************         
         SPACE 1                                                                
         USING ACWORKD,RC                                                       
         USING ACRLD,RA                                                         
         USING CPRCNDRD,R2                                                      
GETCNDR  DS    0D                                                               
         NMOD1 0,**CNDR**                                                       
         L     RC,RLBASEC                                                       
         L     R2,0(,R1)           Load block A(CPRCNDRD)                       
         ST    R1,GCSVPARM                                                      
         MVI   GCBYTE1,NO                                                       
         MVI   CPRERR,0            Set error code to none                       
*&&US*&& MVC   GCYM,CPRYM          Save off requested year and/or month         
*&&UK*&& MVC   GCYMD,CPRYM         Save off requested year/month/day            
         TM    UPSI,UPSITABS                                                    
         BZ    GETCN005                                                         
         LA    RE,=CL19' Read calendar (  )'                                    
         L     RF,4(,R1)           Debug number                                 
         CVD   RF,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  16(2,RE),DUB                                                     
         GOTO1 PRNTBL,DMCB,(19,(RE)),(R2),C'DUMP',3,=CL2'1D'                    
*                                                                               
GETCN005 BRAS  RE,FINDCAL                                                       
         BE    GETCN200            Yes found                                    
         BH    GETCNNO             Not found and already read                   
*&&UK*&& CLI   GCDD,0              YYMMDD entered?                              
*&&UK*&& BNE   GETCNM15            Yes - read calendar passive pointer          
*                                  R5 = Point to new entry                      
         USING CASRECD,R3                                                       
GETCN015 LA    R3,IOKEY                                                         
         XC    CASKEY,CASKEY       Cost calendar record type                    
         MVI   CASKTYP,CASKTYPQ    X'3E'                                        
         MVI   CASKSUB,CASKSUBQ    X'0B'                                        
         MVC   CASKCPY,RCCOMPFL    Company                                      
         MVC   CASKEMOA(1),GCYY    Set year                                     
         CLI   CPRMM,0             Was month specified ?                        
         BNH   *+10                                                             
         MVC   CASKEMOA(2),GCYM    Set year/month                               
         L     R1,=AL4(IOHIGH+IOAREA3+IOACFIL)                                  
         OI    CPRERR,CPRRF        Read occcured                                
*                                                                               
GETCN020 LA    R3,IOKEY                                                         
         GOTO1 AIO                                                              
         L     R4,AIO3                                                          
         CLC   CASKEY(3),0(R4)     Same type/sub type/company ?                 
         BNE   GETCN023            No                                           
         CLI   CPRMM,0             Was month supplied ?                         
         BH    GETCN022                                                         
         CLC   GCYY,CASKEMOA-CASKEY(R4)                                         
         BNE   GETCN023                                                         
         B     GETCN024                                                         
                                                                                
GETCN022 CLC   GCYM,CASKEMOA-CASKEY(R4)                                         
         BH    GETCN023            Yes, so countinue                            
         CLC   GCYM,CASKSMOA-CASKEY(R4)                                         
         BNL   GETCN024                                                         
                                                                                
GETCN023 CLI   GCBYTE1,YES         Did we process any this time in ?            
         BE    GETCN200            Get & expand calendar we need                
         B     GETCNNO             NO                                           
*                                                                               
GETCN024 MVI   GCBYTE1,YES         Got a calendar ?                             
         LR    R3,R4                                                            
         MVC   CPRYEAR,CASKEMOA                                                 
         MVC   CPROFFC,CASKOFC                                                  
         XC    CPRMTH,CPRMTH                                                    
         MVC   CPRSTMOA,CASKSMOA                                                
*                                                                               
         CLC   CPROFFC,SPACES      Default calendar ?                           
         BE    GETCN032            Yes                                          
         SR    RF,RF                                                            
         LA    RE,CPROFLST                                                      
         ICM   RF,1,CPR#OFC        Number of offices                            
         BZ    GETCN028            None                                         
*                                                                               
GETCN025 CLC   CPROFFC,0(RE)       Match on office                              
         BE    GETCN032                                                         
         LA    RE,2(,RE)                                                        
         BCT   RF,GETCN025                                                      
*                                                                               
GETCN028 MVC   0(2,RE),CPROFFC     Save office                                  
         IC    RF,CPR#OFC                                                       
         AHI   RF,1                                                             
         STC   RF,CPR#OFC                                                       
         CLI   CPR#OFC,128         UP TO 128 OFFICES, TOO MANY FOR SURE         
         BL    *+6                                                              
         DC    H'00'                                                            
*                                                                               
         USING TMRELD,R4                                                        
GETCN032 XC    CPRMON1((CPRMTHQ+2)*L'CPRMON1),CPRMON1                           
         XC    CPRMOA1(CPRMTHQ*L'CPRMOA1),CPRMOA1                               
         AH    R4,DATADISP                                                      
         CLI   0(R4),TMRELQ        X'87'                                        
         BE    GETCN033                                                         
         DC    H'00'                                                            
*                                                                               
*&&UK                                                                           
GETCNM15 LA    R3,IODIRKEY                                                      
         XC    CASPAS,CASPAS       Calendar passive pointer                     
         MVI   CASPTYP,CASPTYPQ    X'3E'                                        
         MVI   CASPSUB,CASPSUBQ    X'0C'                                        
         MVC   CASPCPY,RCCOMPFL                                                 
         MVC   CASPEDTE,GCYMD                                                   
         MVC   GCSVKEY,CASPAS                                                   
         L     R1,=AL4(IOHIGH+IOAREA3+IOACDIR)                                  
         OI    CPRERR,CPRRF        Read occcured                                
*                                                                               
GETCNM20 LA    R3,IODIRKEY                                                      
         GOTO1 AIO                                                              
         L     R3,AIO3                                                          
         CLC   GCSVKEY,CASPAS      Same type/sub type/company ?                 
         BNE   GETCNM23            No                                           
         CLI   CPRMM,0             Was month supplied ?                         
         BH    GETCNM21                                                         
         CLC   GCYY,CASPEDTE                                                    
         BNE   GETCNM23                                                         
         B     GETCNM24                                                         
                                                                                
GETCNM21 CLI   CPRDD,0             Was day specified?                           
         BH    GETCNM22                                                         
         CLC   GCYM,CASPEDTE                                                    
         BH    GETCNM23            Yes, so countinue                            
         CLC   GCYM,CASPEDTE                                                    
         BNL   GETCNM24                                                         
         B     GETCNM23                                                         
*                                                                               
GETCNM22 CLC   GCYMD,CASPEDTE                                                   
         BH    GETCNM23            Yes, so countinue                            
         CLC   GCYMD,CASPSDTE                                                   
         BNL   GETCNM24                                                         
*                                                                               
GETCNM23 CLI   GCBYTE1,YES         Did we process any this time in ?            
         BE    GETCN200            Get & expand calendar we need                
         B     GETCNNO             NO                                           
*                                                                               
GETCNM24 MVI   GCBYTE1,YES         Got a calendar ?                             
         L     R1,=AL4(IOGETREC+IOAREA3+IOACMST)                                
         GOTO1 AIO                                                              
         L     R4,AIO3                                                          
         LR    R3,R4                                                            
         MVC   CPRYEAR,CASKEMOA                                                 
         MVC   CPROFFC,CASKOFC                                                  
         XC    CPRMTH,CPRMTH                                                    
         MVC   CPRSTMOA,CASKSMOA                                                
*                                                                               
         CLC   CPROFFC,SPACES      Default calendar ?                           
         BE    GETCNM32            Yes                                          
         SR    RF,RF                                                            
         LA    RE,CPROFLST                                                      
         ICM   RF,1,CPR#OFC        Number of offices                            
         BZ    GETCNM28            None                                         
*                                                                               
GETCNM25 CLC   CPROFFC,0(RE)       Match on office                              
         BE    GETCNM32                                                         
         LA    RE,2(,RE)                                                        
         BCT   RF,GETCNM25                                                      
*                                                                               
GETCNM28 MVC   0(2,RE),CPROFFC     Save office                                  
         IC    RF,CPR#OFC                                                       
         LA    RF,1(,RF)                                                        
         STC   RF,CPR#OFC                                                       
         CLI   CPR#OFC,128         UP TO 128 OFFICES, TOO MANY FOR SURE         
         BL    *+6                                                              
         DC    H'00'                                                            
*                                                                               
         USING TMRELD,R4                                                        
GETCNM32 XC    CPRMON1((CPRMTHQ+2)*L'CPRMON1),CPRMON1                           
         XC    CPRMOA1(CPRMTHQ*L'CPRMOA1),CPRMOA1                               
         AHI   R4,TIMRFST-TIMRECD                                               
         CLI   0(R4),TMRELQ        X'87'                                        
         BE    GETCN033                                                         
         DC    H'00'                                                            
*&&                                                                             
*                                                                               
         USING CALDTED,R5                                                       
GETCN033 CLC   CPROFFC,SPACES      Default calendar ?                           
         BNE   GETCN034                                                         
         MVC   CDTYEAR,CASKEMOA    Set year to actual key                       
         MVC   CDTSDATE,TMRSTART                                                
         MVC   CDTEDATE,TMREND                                                  
         MVC   CDTSMOA,CASKSMOA                                                 
         MVC   CDTEMOA,CASKEMOA                                                 
         DROP  R5                                                               
                                                                                
GETCN034 MVC   CPRSTDTE,TMRSTART                                                
         LA    R7,CPRMOA1                                                       
         XC    CPRSTYM,CPRSTYM                                                  
*                                                                               
         USING TMPELD,R4                                                        
GETCN035 CLI   0(R4),0             EOR                                          
         BE    GETCN070                                                         
         CLI   0(R4),TMPELQ        X'88', time period element                   
         BNE   GETCN060                                                         
         OC    CPRMTH,CPRMTH       Was it initialized ?                         
         BNZ   GETCN040                                                         
         MVC   CPRMTH,TMPMTH       Initialize starting month                    
         MVC   CPRSTMOA,TMPMTH                                                  
         MVI   CPR#MOA,1                                                        
*                                                                               
GETCN040 OC    CPRSTYM,CPRSTYM                                                  
         BNZ   GETCN045                                                         
         MVC   CPRSTYM,TMPEND                                                   
         BAS   RE,SETYML                                                        
*                                                                               
GETCN045 CLC   CPRMTH,TMPMTH       Move in month                                
         BE    GETCN048            If MOA changes move on,                      
         LA    R7,L'CPRMOA1(,R7)      bump to next MMDD                         
         SR    RF,RF               Increment number of MOAs in calendar         
         IC    RF,CPR#MOA                                                       
         AHI   RF,1                                                             
         STC   RF,CPR#MOA                                                       
*                                                                               
GETCN048 MVC   CPRMTH,TMPMTH               Reset month                          
         MVC   0(L'CPRMOA1,R7),TMPEND+1    Move in MMDD, end moa period         
         ZAP   DUB,PKZERO                                                       
*                                                                               
         LA    R8,CPRMON1                                                       
         LA    RE,CPRLSTYM                                                      
         LA    R0,CPRMTHQ+2        1 1/2 years + 2 months                       
GETCN052 CLC   TMPEND(2),0(RE)                                                  
         BE    GETCN055                                                         
         LA    R8,L'CPRMON1(,R8)                                                
         LA    RE,L'CPRLSTYM(,RE)  Next YYMMDD set                              
         BCT   R0,GETCN052                                                      
*                                                                               
GETCN055 MVO   DUB,TMPEND+2(1)     Make DD binary                               
         CVB   R6,DUB                                                           
         LR    RF,R6                                                            
         SRL   RF,3                                                             
         LR    R9,R8                                                            
         AR    R9,RF               Point to byte in word                        
         LA    RE,X'07'            Mask bits                                    
         NR    RE,R6                                                            
         LA    RF,X'80'                                                         
         SRL   RF,0(RE)                                                         
         EX    RF,*+8              Turn on bit for day                          
         B     *+8                                                              
         OI    0(R9),0                                                          
*                                                                               
GETCN060 SR    R1,R1                                                            
         IC    R1,1(,R4)                                                        
         AR    R4,R1                                                            
         B     GETCN035                                                         
*                                                                               
GETCN070 GOTO1 BINSRCH,DMCB,(1,CPRREC),CPRAWRK,CPR#CNDR,               X        
               L'CPRREC,3,MAXCALS                                               
         ICM   R4,15,DMCB                                                       
         BNZ   *+6                                                              
         DC    H'00'                                                            
*                                                                               
         TM    DMCB,X'01'          Was  it found ?                              
         BZ    GETCN080            Yes, already in table                        
         LA    R1,1                Bump up count                                
         A     R1,CPR#CNDR                                                      
         ST    R1,CPR#CNDR                                                      
*                                                                               
GETCN080 DC    0H                                                               
*&&UK*&& L     R1,=AL4(IOAREA3+IOSEQ+IOACDIR)                                   
*&&UK*&& CLI   GCDD,0                                                           
*&&UK*&& BNE   GETCNM20                                                         
         L     R1,=AL4(IOAREA3+IOSEQ+IOACFIL)                                   
         B     GETCN020                                                         
         DROP  R3                                                               
*                                                                               
         USING CDRD,R4                                                          
GETCN200 MVC   CPROFFC,CPROF                                                    
         BRAS  RE,FINDCAL                                                       
         BE    GETCN201            Yes found                                    
         BH    GETCNNO             Not found and already read                   
         CLI   CPRDD,0             Was a day specified                          
         BNE   GETCN211            Yes                                          
         DC    H'00'                                                            
                                                                                
GETCN201 MVC   CPRYEAR,GCYY                                                     
         GOTO1 BINSRCH,DMCB,(0,CPRREC),CPRAWRK,CPR#CNDR,               X        
               L'CPRREC,3,MAXCALS                                               
         TM    DMCB,X'01'          Was office calendar found ?                  
         BZ    GETCN210            Yes                                          
         CLC   CPROF,SPACES        No, was office actually supplied ?           
         BNH   GETCN202            No, so no calendar for year                  
         MVC   CPROFFC,SPACES      Yes, so try default, no office               
         MVC   CPRYEAR,GCYY        Set year again                               
         GOTO1 BINSRCH,DMCB,(0,CPRREC),CPRAWRK,CPR#CNDR,               X        
               L'CPRREC,3,MAXCALS                                               
         TM    DMCB,X'01'          Was it found ?                               
         BZ    GETCN210            Yes                                          
                                                                                
GETCN202 CLI   CPRDD,0             Was YYMMDD passed ?                          
         BH    GETCN211            Yes, specific date, try again                
         B     GETCNNO             Exit                                         
*                                                                               
GETCN210 L     RF,DMCB                                                          
         MVC   CPRREC,0(RF)                                                     
         CLI   CPRDD,0             Was a day specified                          
         BE    GETCN218            No                                           
         CLC   CPRYMD,CPRSTDTE                                                  
         BNL   GETCN218            Found                                        
                                                                                
GETCN211 CLC   GCYY,CPRYY          Did we already try increment year ?          
         BNE   GETCNNO             Yes, so exit                                 
                                                                                
GETCN214 MVC   WORK(1),CPRYY       Bump up year                                 
         MVC   WORK+1(2),=X'1231'  Get first day of next month                  
         GOTO1 DATCON,DMCB,(X'31',WORK),(1,WORK),(2,0)                          
         MVC   GCYY,WORK           Now have next year                           
         B     GETCN005            Try again                                    
                                                                                
GETCN218 BAS   RE,SETYML                                                        
         L     R4,CPREXPC          Expanded calendar USING CDRD                 
         XC    CDRD(CDRLNQ),CDRD                                                
         MVC   CDRSDATE,CPRSTDTE                                                
         MVC   CPRSDATE,CPRSTDTE   SET START DATE OF CALENDAR                   
         MVC   CPRMTH,CPRSTMOA     RESET CPRMTH                                 
         MVC   CPRSMOA,CPRSTMOA    CALENDAR START MOA                           
         XC    GC#MDAYS,GC#MDAYS   NUMBER OF DAYS IN MONTH                      
         LA    R0,CPRMTHQ+2        UP TO 20 MONTHS REAL MONTHS                  
         LA    R5,CPRLSTYM                                                      
         LA    R6,1                UP TO 31 DAYS IN A MONTH                     
         LR    R3,R6               COUNT NUMBER OF DAYS IN PERIOD               
         LA    R7,CPRMOA1          LAST MMDD OF EACH MOA                        
         LA    R8,CPRMON1          31 BITS PER MONTH                            
         LA    R9,1                PERIOD NUMBER                                
         MVI   GC#MOA,1            Set to first MOA                             
*                                                                               
GETCN220 CLM   R6,1,2(R5)          LAST DAY OF MONTH                            
         BH    GETCN260            PASTED LAST DAY OF MONTH                     
         LR    R1,R8               FULL WORD OF DAYS FOR CURRENT MONTH          
         LR    RF,R6               DAY OF MONTH TO CHECK                        
         SRL   RF,3                WHICH BYTE TO CHECK                          
         AR    R1,RF                                                            
         LA    RE,X'07'                                                         
         NR    RE,R6                                                            
         LA    RF,X'80'                                                         
         SRL   RF,0(RE)                                                         
         EX    RF,*+8              IF BIT ON THE IT IS AN END DATE              
         BZ    GETCN240                                                         
         TM    0(R1),0                                                          
*                                                                               
         STC   R9,CDRPRD#          SAVE PERIOD NUBMER                           
         STC   R9,CPR#PRD          NUMBER OF PERIODS IN CALENDAR                
         STC   R3,CDR#DAYS         SAVE NUMBER OF DAYS IN PERIOD                
         LH    R1,GC#MDAYS                                                      
         AR    R1,R3                                                            
         STH   R1,GC#MDAYS                                                      
         SR    R3,R3               RESET TO COUNT # DAYS IN NEXT PERIOD         
         LA    R9,1(,R9)           INCREASE PERIOD NUMBER                       
         MVC   CDREDATE,0(R5)      SET YYMM OF END DATE                         
         MVC   CDRMOA,CPRMTH       SET MOA  OF MONTH                            
         LR    R1,R6                                                            
         CVD   R1,DUB                                                           
         ICM   R1,3,DUB+6                                                       
         SRL   R1,4                SHIFT OFF SIGN                               
         STC   R1,CDREDATE+2       SAVE OFF DD UNSIGNED PACKED                  
         CLC   CDREDATE+1(2),0(R7) IS END DATE LAST FOR MOA?                    
         BNE   GETCN230            NO                                           
         MVC   CDR#MDAY,GC#MDAYS+1 SAVE 1 BYTE OF HALF WORK                     
         XC    GC#MDAYS,GC#MDAYS                                                
         MVC   CPREMOA,CPRMTH      CALENDAR END MOA                             
         LA    R7,L'CPRMOA1(,R7)   NEXT MMDD OF END DATE OF MOA                 
         MVC   WORK(2),CPRMTH      INCREASE MOA BY ONE MONTH                    
         MVI   WORK+2,01                                                        
         GOTO1 DATCON,DMCB,(X'31',WORK),(1,WORK),(2,0)                          
         MVC   CPRMTH,WORK         New MOA                                      
         SR    R1,R1                                                            
         IC    R1,GC#MOA                                                        
         LA    R1,1(,R1)                                                        
         STC   R1,GC#MOA           Number of MOAs processed                     
*                                                                               
GETCN230 MVC   WORK(3),CDREDATE                                                 
         MVC   CPREDATE,CDREDATE   Calendar end date                            
         GOTO1 DATCON,DMCB,(1,WORK),(0,WORK+3)                                  
         GOTO1 ADDAY,DMCB,(C'D',WORK+3),WORK+3,F'1'                             
         GOTO1 DATCON,DMCB,(0,WORK+3),(1,WORK)                                  
         ZAP   CDRTHRS,PKZERO      Initialize                                   
         LA    R4,CDRLNQ(,R4)                                                   
         XC    CDRD(CDRLNQ),CDRD   Clear next entry                             
         MVC   CDRSDATE,WORK       Start date of next period                    
         CLC   GC#MOA,CPR#MOA      Did we reach the limit ?                     
         BH    GETCN270                                                         
*                                                                               
GETCN240 LA    R6,1(,R6)           Increment one day                            
         LA    R3,1(,R3)           Increment one day                            
         B     GETCN220                                                         
*                                                                               
GETCN260 LA    R6,1                Reset to day one                             
         LA    R5,L'CPRLSTYM(,R5)                                               
         LA    R8,L'CPRMON1(,R8)           Next month                           
         BCT   R0,GETCN220                                                      
*                                                                               
GETCN270 MVI   CPRPED#,0           Initialize to zero                           
         CLI   CPRDD,0             Day supplied ?                               
         BE    GETCN280            No, so this is good                          
         CLC   CPRYMD,CPREDATE     See if day is in this calendar               
         BH    GETCN211            No, try next year                            
                                                                                
         L     R4,CPREXPC          Yes, get period number of date               
         SR    R0,R0                                                            
         IC    R0,CPR#PRD          Max number of periods to scan                
         CLC   CDRSDATE,CPRYMD                                                  
         BNH   *+6                 Okay to continue                             
         DC    H'00'                                                            
                                                                                
GETCN272 MVC   CPRPED#,CDRPRD#     Set period number                            
         CLC   CDREDATE,CPRYMD     End   period date                            
         BNL   GETCN280            This is the one                              
         AHI   R4,CDRLNQ           Next period                                  
         BCT   R0,GETCN272                                                      
         DC    H'00'               Ut-Oh                                        
                                                                                
GETCN280 CLI   CPRACT,CPRLOCD      Location detail wanted ?                     
         BNE   GETCNOK                                                          
         L     R4,CPREXPC                                                       
         SR    R0,R0                                                            
         IC    R0,CPR#PRD                                                       
         LR    R1,R0               SET TO POINT TO LAST ENTRY                   
         BCTR  R1,0                                                             
         MHI   R1,CDRLNQ                                                        
         AR    R4,R1                                                            
*                                                                               
GETCN282 OC    CDR#MDAY,CDR#MDAY   ANY DATA                                     
         BZ    *+10                NO, SO FILL IN LAST VALUE                    
         MVC   GC#MDAYS,CDR#MDAY   SAVE OFF VALUE                               
         MVC   CDR#MDAY,GC#MDAYS   PROPAGATE DATA BACKWARDS                     
         AHI   R4,-CDRLNQ                                                       
         BCT   R0,GETCN282                                                      
*                                                                               
         MVI   CPRACT,0            Reset                                        
         ICM   R6,15,AELEM83       Location element                             
         BZ    GETCNOK             No location (nothing active then)            
         SR    RF,RF                                                            
*                                                                               
         USING LOCELD,R6                                                        
GETCN284 CLI   0(R6),0             EOR ?                                        
         BE    GETCNOK                                                          
         CLI   LOCEL,LOCELQ                                                     
         BNE   GETCN300            Next element                                 
         L     R4,CPREXPC          Expanded calendar USING CDRD                 
         SR    R0,R0                                                            
         IC    R0,CPR#PRD          # of periods in calendar                     
*                                                                               
GETCN288 CLC   LOCSTART,CDREDATE   Is start within range ?                      
         BH    GETCN292            Not in this period at all                    
         CLC   LOCEND,CDRSDATE     Is end within range                          
         BL    GETCN292            Not in this period at all                    
         MVC   CDR#ACTV,CDR#DAYS   Set to say active for full period            
         CLC   LOCSTART,CDRSDATE   Is start of location in period ?             
         BNH   GETCN290            Either before of start of period             
         GOTO1 DATCON,DMCB,(1,CDREDATE),(0,DTE1)                                
         GOTO1 DATCON,DMCB,(1,LOCSTART),(0,DTE2)                                
         GOTO1 PERVERT,DMCB,DTE1,DTE2                                           
         LH    R1,8(,R1)           Get number of days inclusive                 
         STC   R1,CDR#ACTV                                                      
*                                                                               
GETCN290 CLC   LOCEND,CDREDATE     Is end of location in period ?               
         BNL   GETCN292            Either after or end of period                
         GOTO1 DATCON,DMCB,(1,CDREDATE),(0,DTE1)                                
         GOTO1 DATCON,DMCB,(1,LOCEND),(0,DTE2)                                  
         GOTO1 PERVERT,DMCB,DTE1,DTE2                                           
         LH    R1,8(,R1)           GET NUMBER OF DAYS INCLUSIVE                 
         BCTR  R1,0                NOT INCLUSIVE                                
         SR    RF,RF                                                            
         IC    RF,CDR#ACTV         DAYS ACTIVE AT THIS POINT                    
         SR    RF,R1                                                            
         STC   RF,CDR#ACTV         NEW NUMBER OF DAYS ACTIVE                    
*                                                                               
GETCN292 LA    R4,CDRLNQ(,R4)      NEXT CALENDAR                                
         BCT   R0,GETCN288                                                      
*                                                                               
GETCN300 SR    RF,RF                                                            
         IC    RF,1(,R6)                                                        
         AR    R6,RF                                                            
         B     GETCN284                                                         
*                                                                               
GETCNNO  XC    CPRSDATE,CPRSDATE   Missing calendar for that year               
         XC    CPREDATE,CPREDATE                                                
         XC    CPRSMOA,CPRSMOA                                                  
         XC    CPREMOA,CPREMOA                                                  
         OI    CPRERR,CPRNF        Calendar not found                           
*                                                                               
GETCNOK  CLI   CPRERR,0            Set condition codes                          
         L     R1,GCSVPARM                                                      
         MVC   0(1,R1),CPRERR                                                   
         MVC   WORK(L'CDRSDATE),CDRSDATE                                        
         MVC   WORK+L'CDRSDATE(L'CDREDATE),CDREDATE                             
         XIT1                                                                   
         DROP  R6                                                               
GCYMD    DS    0XL3                Year and/or month and/or day request         
GCYM     DS    0XL2                Year and/or month request                    
GCYY     DS    XL1                                                              
GCMM     DS    XL1                                                              
GCDD     DS    XL1                                                              
GC#MOA   DS    XL1                 Count number of MOAs                         
GCBYTE1  DS    CL1                                                              
GCSVPARM DS    A                                                                
GC#MDAYS DS    H                                                                
GCSVKEY  DS    XL3                                                              
         EJECT                                                                  
         USING CALDTED,R5                                                       
FINDCAL  NTR1                                                                   
         L     R5,CPRYEARS                                                      
         SR    R1,R1                                                            
         ICM   R1,1,CPR#YRS        Number of years we read in so far            
         BZ    FINDCA50            None, so add entry                           
                                                                                
FINDCA02 CLI   CPRDD,0             Was YYMMDD supplied ?                        
         BNH   FINDCA05            No                                           
         CLC   CPRYMD,CDTSDATE                                                  
         BL    FINDCA30            If low then calendar before                  
         CLC   CPRYMD,CDTEDATE                                                  
         BH    FINDCA20                                                         
         B     FINDCAEQ            Found match                                  
                                                                                
FINDCA05 CLI   CPRMM,0             Was YYMM supplied ?                          
         BNH   FINDCA10                                                         
         CLC   CPRYM,CDTSMOA                                                    
         BL    FINDCA30            If low then calendar before ?                
         CLC   CPRYM,CDTEMOA                                                    
         BH    FINDCA20                                                         
         B     FINDCAEQ            Found match                                  
                                                                                
FINDCA10 CLC   CPRYY,CDTYEAR                                                    
         BE    FINDCAEQ            Found match                                  
                                                                                
FINDCA20 AHI   R5,CDTLNQ           Try next calendar                            
         BCT   R1,FINDCA02                                                      
         B     FINDCA50                                                         
*                                  Make room for new entry                      
FINDCA30 ZIC   R5,CPR#YRS          How many so far                              
         MHI   R5,CDTLNQ           A(where to move to)                          
         A     R5,CPRYEARS                                                      
         LR    RF,R5                                                            
FINDCA32 SHI   RF,CDTLNQ           Move this forward                            
         MVC   0(CDTLNQ,R5),0(RF)                                               
         LR    R5,RF                                                            
         BCT   R1,FINDCA32                                                      
                                                                                
         CLC   CDTYEAR,CPRYY       Did these match to begin with?               
         BE    FINDCA35            Yes                                          
         MVC   GCYY,CPRYY          No, so read this calander instead            
         B     FINDCA50                                                         
                                                                                
FINDCA35 MVC   WORK(1),CDTYEAR                                                  
         MVC   WORK+1(2),=X'0101'                                               
         GOTOR DATCON,DMCB,(X'31',WORK),(1,WORK),(4,0)                          
         MVC   CPRYY,WORK                                                       
         CLI   CPRMM,0             This is good for yymm and yymmdd             
         BE    *+10                                                             
         MVC   GCYY,WORK           Set to read right calendar                   
                                                                                
FINDCA50 ZIC   R1,CPR#YRS          Number of years we read in so far            
         AHI   R1,1                                                             
         STC   R1,CPR#YRS                                                       
         XC    CALDTED(CDTLNQ),CALDTED                                          
         MVC   CDTYEAR,CPRYY                                                    
         LHI   R1,-1               Set CC Low                                   
         B     FINDCALX                                                         
                                                                                
FINDCAEQ LA    R1,1                Set CC High                                  
         OC    CDTSMOA,CDTSMOA     If set then actually have calendar           
         BZ    FINDCALX            Not set so don't have yet or at all          
         LA    R1,0                Set CC Equal                                 
         CLI   CPRMM,0             This is good for yymm and yymmdd             
         BE    FINDCALX                                                         
         MVC   GCYY,CDTYEAR        Set to read right calendar                   
                                                                                
FINDCALX CHI   R1,0                                                             
         XIT1  REGS=(R5)                                                        
         DROP  R5                                                               
         EJECT                                                                  
SETYML   NTR1                                                                   
         LA    R8,CPRLSTYM                                                      
         MVC   WORK,CPRSTYM        STARTING POINT                               
         MVI   WORK+2,01           PACKED DD                                    
         GOTO1 DATCON,DMCB,(X'31',WORK),(1,WORK),(1,0)                          
         SR    R4,R4                                                            
         IC    R4,WORK+2           CONVERT PACKED DD TO BINARY DD               
         SLL   R4,4                                                             
         XC    DUB,DUB                                                          
         STH   R4,DUB+6                                                         
         OI    DUB+7,X'0C'                                                      
         CVB   R4,DUB                                                           
         STC   R4,WORK+3                                                        
*                                                                               
         LA    R0,CPRMTHQ+2                                                     
SETYML10 MVC   0(2,R8),WORK        PACKED YYMM                                  
         MVC   2(1,R8),WORK+3      BINARY DD                                    
         GOTO1 DATCON,DMCB,(X'31',WORK),(1,WORK),(3,0)                          
         IC    R4,WORK+2           CONVERT PACKED DD TO BINARY DD               
         SLL   R4,4                                                             
         STH   R4,DUB+6                                                         
         OI    DUB+7,X'0C'                                                      
         CVB   R4,DUB                                                           
         STC   R4,WORK+3                                                        
         LA    R8,L'CPRLSTYM(,R8)                                               
         BCT   R0,SETYML10                                                      
         XIT1                                                                   
         DROP  R2,R4                                                            
         SPACE 1                                                                
         LTORG                                                                  
         TITLE 'INCREASE CPRYY (CALENDAR YEAR) BY ONE'                          
***********************************************************************         
*  BUMP UP YEAR INORDER TO GET THE FOLLOWING CALENDAR YEAR            *         
***********************************************************************         
         SPACE 1                                                                
         USING ACWORKD,RC                                                       
         USING ACRLD,RA                                                         
         USING CPRCNDRD,R2                                                      
UPYEAR   NMOD1 0,**UPYR**                                                       
         L     RC,RLBASEC                                                       
         L     R2,ACNDRBLK                                                      
         MVC   WORK(1),CPRYY                                                    
         MVC   WORK+1(2),=X'1231'  GET FIRST DAY OF NEXT MONTH                  
         GOTO1 DATCON,DMCB,(X'31',WORK),(1,WORK),(2,0)                          
         MVC   CPRYY,WORK          MOVE IN NEXT YEAR                            
         MVC   CPROF,SPACES                                                     
         XIT1                                                                   
         DROP  R2                                                               
         SPACE 1                                                                
         LTORG                                                                  
         TITLE 'SET COST TABLES FOR CALCULATING COST DOLLARS'                   
***********************************************************************         
*  ROUTINE TO SET UP COST METHODS AND RATE TABLE                      *         
***********************************************************************         
         SPACE 1                                                                
         USING ACWORKD,RC                                                       
         USING ACRLD,RA                                                         
         USING CAPRECD,R3                                                       
         USING MTHDD,R4                                                         
         USING FMTRECD,R5                                                       
SETCOST  NMOD1 0,**SCST**                                                       
         L     RC,RLBASEC                                                       
         OC    CSTMTHDS,CSTMTHDS   DONE DEAL?                                   
         BNZ   SETCST45            YES                                          
         LA    R3,IOKEY            GET METHODS PROFILE                          
         L     R4,MHDBASE                                                       
         MVI   MTHDNUM,C' '                                                     
*                                                                               
         USING CAHRECD,R3                                                       
         MVC   CAHKEY,SPACES                                                    
         MVI   CAHKTYP,CAHKTYPQ    X'3E'                                        
         MVI   CAHKSUB,CAHKSUBQ    X'01'                                        
         MVC   CAHKCPY,RCCOMPFL                                                 
         L     R1,=AL4(IOHIGH+IOACFIL+IOAREA1)                                  
*                                                                               
SETCST05 GOTO1 AIO                                                              
         L     R3,AIO1                                                          
         CLC   CAHKEY(3),IOKEY                                                  
         BNE   SETCST10                                                         
         MVC   MTHDNUM,CAHKMTHD    METHOD NUMBER                                
         OI    MTHDIND,MTHDYTD     DEFAULT IS YTD ALLOCATION                    
         LH    R1,CSTMTHDS                                                      
         AHI   R1,1                                                             
         STH   R1,CSTMTHDS                                                      
*                                                                               
         AH    R3,DATADISP         GET METHOD CODE                              
SETCST06 CLI   0(R3),0             END OF RECORD                                
         BNE   *+6                                                              
         DC    H'00'                                                            
         CLI   0(R3),METELQ        X'82'                                        
         BE    SETCST08                                                         
         IC    R1,1(,R3)                                                        
         AR    R3,R1                                                            
         B     SETCST06                                                         
*                                                                               
         USING METELD,R3                                                        
SETCST08 MVC   MTHDCDE,METCODE     SAVE OF METHOD CODE                          
         LA    R4,MTHDLNQ(,R4)                                                  
         L     R1,=AL4(IOSEQ+IOACFIL+IOAREA1)                                   
         B     SETCST05                                                         
*                                                                               
SETCST10 MVI   0(R4),0             MARK END OF METHODS                          
         L     R4,MHDBASE          RE-LOAD START OF METHODS                     
         SR    R6,R6               NUMBER OF METHODS TO LOOK AT                 
         ICM   R6,3,CSTMTHDS                                                    
         BZ    SETCOSTX            NONE                                         
*                                                                               
         USING CMTRECD,R3                                                       
SETCST12 LA    R3,IOKEY            GET METHOD ALLOCATION DATES                  
         MVC   CMTKEY,SPACES                                                    
         MVI   CMTKTYP,CMTKTYPQ    X'3E'                                        
         MVI   CMTKSUB,CMTKSUBQ    X'02'                                        
         MVC   CMTKCPY,RCCOMPFL                                                 
         MVC   CMTKMTHD,MTHDCDE                                                 
         L     R1,=AL4(IOHIGH+IOACFIL+IOAREA1)                                  
         GOTO1 AIO                                                              
         L     R3,AIO1                                                          
         CLC   CMTKEY(6),IOKEY                                                  
         BNE   SETCST20                                                         
         AH    R3,DATADISP         GO THROUGH ELEMENTS                          
         SR    R1,R1                                                            
*                                                                               
         USING DOAELD,R3                                                        
SETCST15 CLI   0(R3),0                                                          
         BE    SETCST20                                                         
         CLI   0(R3),DOAELQ        X'81' DATE OF ALLOCATION                     
         BNE   *+10                                                             
         MVC   MTHDLAD,DOAPER      YYMM PERIOD                                  
         IC    R1,1(,R3)                                                        
         AR    R3,R1                                                            
         B     SETCST15                                                         
*                                                                               
         USING CAPRECD,R3                                                       
SETCST20 LA    R3,IOKEY            GET METHOD PROFILES                          
         MVC   CAPKEY,SPACES                                                    
         MVI   CAPKTYP,CAPKTYPQ    X'3E'                                        
         MVI   CAPKSUB,CAPKSUBQ    X'09'                                        
         MVC   CAPKCPY,RCCOMPFL                                                 
*                                                                               
SETCST30 MVC   CAPKMTHD,MTHDNUM    METHOD NUMBER                                
         L     R1,=AL4(IOHIGH+IOACFIL+IOAREA1)                                  
         GOTO1 AIO                                                              
         L     R3,AIO1                                                          
         CLC   CAPKTYP(4),IOKEY                                                 
         BNE   SETCST42            NO SO GET NEXT                               
*                                                                               
         USING OPDELD,R2                                                        
         SR    RF,RF                                                            
         LA    R2,ACCORFST(R3)                                                  
SETCST35 CLI   0(R2),0                                                          
         BE    SETCST40                                                         
         CLI   0(R2),OPDELQ        X'A4' PROFILE OPTIONS                        
         BNE   SETCST38                                                         
         CLI   OPDNUM,X'16'        YTD OR MONTHLY ALLOCATION                    
         BE    SETCST40                                                         
SETCST38 IC    RF,1(,R2)                                                        
         AR    R2,RF                                                            
         B     SETCST35                                                         
*                                                                               
SETCST40 CLI   OPDDATA,C'M'                                                     
         BNE   SETCST42                                                         
         OI    MTHDIND,MTHDMTH     METHOD IS MONTLY                             
         NI    MTHDIND,TURNOFF-MTHDYTD                                          
*                                                                               
SETCST42 LA    R4,MTHDLNQ(,R4)     NEXT ENTRY                                   
         BCT   R6,SETCST12                                                      
*                                                                               
         USING CASRECD,R3                                                       
         USING RATED,R6                                                         
         USING COSTD,R7                                                         
SETCST45 LA    R3,IOKEY                                                         
         MVC   WORK(3),RELEND      GO BACK 4 YEARS, SAVE AS PWOS                
         GOTO1 DATCON,DMCB,(3,WORK),(0,TEMPDATE)                                
         GOTO1 ADDAY,DMCB,(C'Y',TEMPDATE),TEMPDATE,F'-4'                        
         GOTO1 DATCON,DMCB,(0,TEMPDATE),(1,WORK+3)                              
         L     R7,CSTBASE                                                       
         L     R6,RTEBASE                                                       
         XC    CASKEY,CASKEY                                                    
         MVI   CASKTYP,CASKTYPQ    X'3E'                                        
         MVI   CASKSUB,CASKSUBQ    X'0B'                                        
         MVC   CASKCPY,RCCOMPFL                                                 
         MVC   CASKEMOA,WORK+3                                                  
         MVC   HALF2,WORK+3                                                     
         XC    CSTYRS,CSTYRS       NUMBER OF CALENDAR YEARS                     
         L     R1,=AL4(IOHIGH+IOACFIL+IOAREA1)                                  
*                                                                               
SETCST50 GOTO1 AIO                                                              
         L     R3,AIO1                                                          
         CLI   CASKTYP,CASKTYPQ    X'3E'                                        
         BNE   SETCST60                                                         
         CLI   CASKSUB,CASKSUBQ    X'0B'                                        
         BNE   SETCST60                                                         
         CLC   CASKCPY,RCCOMPFL    COMPANY CODE                                 
         BNE   SETCST60            SPACES ARE BLANK                             
         CLC   CASKOFC,SPACES      THIS MAY NEED TO CHANGE IN FUTURE            
         BNE   SETCST58               IF OFFICE HAS DIFFERENT MONTHS            
         CLC   CASKEMOA,HALF2      Make sure we do not go backwards             
         BL    SETCST60                                                         
*                                                                               
         USING TMPELD,R3                                                        
         AH    R3,DATADISP                                                      
         SR    RF,RF                                                            
         XC    COSTSMOA,COSTSMOA                                                
         XC    COSTEMOA,COSTEMOA                                                
SETCT51A CLI   0(R3),0             END OF RECORD                                
         BE    SETCST52                                                         
         CLI   TMPEL,TMPELQ        X'88'                                        
         BNE   SETCT51B                                                         
         OC    COSTSMOA,COSTSMOA   WAS IT INITIALIZED ?                         
         BNZ   *+10                YES                                          
         MVC   COSTSMOA,TMPMTH     MOVE IN START MONTH (FIRST ELEMENT)          
         MVC   COSTEMOA,TMPMTH     MOVE IN END   MONTH (LAST  ELEMENT)          
SETCT51B IC    RF,1(,R3)                                                        
         AR    R3,RF                                                            
         B     SETCT51A                                                         
         DROP  R3                                                               
*                                                                               
SETCST52 ST    R6,COSTRATE         ADDRESS INTO TABLE (OWCH)                    
         LH    R1,CSTYRS           NUMBER   OF COST YEARS                       
         AHI   R1,1                INCREASE BY ONE                              
         STH   R1,CSTYRS                                                        
*                                                                               
         MVC   WORK(2),COSTSMOA                                                 
         MVI   WORK+2,01           MAKE AS DAY ONE                              
         GOTO1 DATCON,DMCB,(1,WORK),(0,DTE1)                                    
         MVC   WORK(2),COSTEMOA                                                 
         GOTO1 DATCON,DMCB,(1,WORK),(0,DTE2)                                    
         GOTO1 PERVERT,DMCB,DTE1,DTE2                                           
         LH    R2,DMCB+14          # MONTHS INCLUSE IN PARM4+2                  
         STC   R2,COSTMTHS         # OF MONTHS THIS CALENDAR COVERS             
         MVC   WORK(2),COSTSMOA                                                 
         MVI   WORK+2,01           MOVE IN DAY ONE                              
*                                                                               
SETCST53 L     R4,MHDBASE                                                       
         LH    R0,CSTMTHDS         # OF METHODS                                 
         MVC   RATEMOA,WORK                                                     
         ZAP   RATEHRS,PKZERO                                                   
*                                                                               
         LA    R6,RATEMTHD                                                      
         USING RATEMTHD,R6         SUB ELEMENT                                  
SETCST54 MVC   RATEMTHD,MTHDNUM                                                 
         ZAP   RATESAL,PKZERO                                                   
         ZAP   RATESAL$,PKZERO                                                  
         ZAP   RATEBEN,PKZERO                                                   
         ZAP   RATEBEN$,PKZERO                                                  
         ZAP   RATEPEN,PKZERO                                                   
         ZAP   RATEPEN$,PKZERO                                                  
         ZAP   RATETOT,PKZERO                                                   
         ZAP   RATETOT$,PKZERO                                                  
         LA    R6,RATEBUKQ(,R6)    BUMP UP BUCKETS ONLY                         
         LA    R4,MTHDLNQ(,R4)                                                  
         BCT   R0,SETCST54                                                      
*                                                                               
         GOTO1 ADDAY,DMCB,(C'M',DTE1),DTE1,F'1'                                 
         GOTO1 DATCON,DMCB,(0,DTE1),(1,WORK)                                    
         BCT   R2,SETCST53                                                      
*                                                                               
         LA    R7,COSTLNQ(,R7)                                                  
         MVI   0(R7),0             MARK END OF ENTRIES                          
*                                                                               
SETCST58 L     R1,=AL4(IOSEQ+IOACFIL+IOAREA1)                                   
         B     SETCST50                                                         
*                                                                               
SETCST60 L     R4,MHDBASE                                                       
         LH    R0,CSTMTHDS         # OF METHODS                                 
         LR    RF,R0                                                            
         MHI   RF,RATEBUKQ                                                      
         LA    RF,RATELNQ(,RF)                                                  
         STH   RF,RATELEN          SAVE LENGHT OF FULL ENTRY                    
         LA    RF,RATELNQ                                                       
         STH   RF,MTHDLOC          SAVE DISPLACEMENT INTO RATE                  
         LA    RF,RATEBUKQ(,RF)    NEXT SET OF RATES BY METHOD                  
         LA    R4,MTHDLNQ(,R4)                                                  
         BCT   R0,*-12                                                          
*                                                                               
         USING CAHRECD,R2                                                       
         LA    R2,IOKEY                                                         
         LH    R0,CSTMTHDS         # OF METHODS                                 
         L     R4,MHDBASE                                                       
SETCST62 MVC   CAHKEY,SPACES                                                    
         MVI   CAHKTYP,CAHKTYPQ    X'3E'                                        
         MVI   CAHKSUB,CAHKSUBQ    X'01' COST ALLOCATION HISTORY                
         MVC   CAHKCPY,RCCOMPFL    COMPANY CODE                                 
         MVC   CAHKMTHD,MTHDNUM    METHOD NUMBER                                
         XC    CAHKOFC,CAHKOFC                                                  
         L     R1,=AL4(IOREAD+IOACFIL+IOAREA1)                                  
         GOTO1 AIO                                                              
         BE    *+6                                                              
         DC    H'00'                                                            
*                                                                               
         USING PATELD,R3                                                        
         L     R3,AIO1                                                          
         AH    R3,DATADISP                                                      
SETCST64 CLI   0(R3),0             EOR                                          
         BE    SETCST75                                                         
         CLI   0(R3),PATELQ        X'85' PAYROLL TYPE BY METHOD                 
         BNE   SETCST68                                                         
         SR    R6,R6                                                            
         IC    R6,PATNUM           GET PAYROLL CODE TYPE                        
         LA    R1,MTHDSAL          SALARY?                                      
         CLI   PATTYPE,PATTSAL                                                  
         BE    SETCST66                                                         
         LA    R1,MTHDBEN          BENEFIT?                                     
         CLI   PATTYPE,PATTBEN                                                  
         BE    SETCST66                                                         
         LA    R1,MTHDPEN          PENSION?                                     
         CLI   PATTYPE,PATTPEN                                                  
         BE    SETCST66                                                         
         LA    R1,MTHDIDR          INDIRECT?                                    
         CLI   PATTYPE,PATTIND     SALARY?                                      
         BNE   SETCST68                                                         
*                                                                               
SETCST66 LR    RF,R6               R6=0 TO 255 CODE NUMBER                      
         SRL   RF,3                                                             
         AR    R1,RF               POINT TO BYTE OF BITS                        
         LA    RE,X'07'                                                         
         NR    RE,R6                                                            
         LA    RF,X'80'                                                         
         SRL   RF,0(RE)                                                         
         EX    RF,*+8                                                           
         B     *+8                                                              
         OI    0(R1),0             TURN ON BIT                                  
*                                                                               
SETCST68 SR    R1,R1                                                            
         IC    R1,1(,R3)                                                        
         AR    R3,R1                                                            
         B     SETCST64                                                         
*                                                                               
SETCST75 OC    MTHDTOT,MTHDSAL     SET ALL CODES THAT APPLY                     
         OC    MTHDTOT,MTHDBEN                                                  
         OC    MTHDTOT,MTHDPEN                                                  
         OC    MTHDTOT,MTHDIDR                                                  
         LA    R4,MTHDLNQ(,R4)                                                  
         BCT   R0,SETCST62                                                      
*                                                                               
SETCOSTX XMOD1 1                                                                
         DROP  R2,R3,R4,R5,R6,R7                                                
         SPACE 3                                                                
         LTORG                                                                  
         TITLE 'SET ACMCAM FOR MULTIPLE METHODS'                                
***********************************************************************         
*  SET IF NEEDED TO READ ALL METHODS FOR PERSON OR P&L SCRIBE         *         
***********************************************************************         
         SPACE 1                                                                
         USING COLD,R3                                                          
         USING FMTRECD,R5                                                       
SETMTHD  NMOD1 0,**QMTH**                                                       
         L     RC,RLBASEC                                                       
*        TM    POSTLVL,POSTHST     MUST BE HISTORY LEVEL REPORTING              
*        BZ    SETMTHDX                                                         
         LH    R1,FORMAT#                                                       
         L     R5,AFORMATS                                                      
         MVI   BYTE,0                                                           
SETMTH10 SR    R0,R0                                                            
         IC    R0,FMT#COLS                                                      
         L     R3,FMTCOL                                                        
*                                                                               
SETMTH20 TM    COLFLAGS,COLAMT     IS IT AN AMOUNT COLUMN?                      
         BZ    SETMTH30            NO, SO NEXT COLUMN                           
         CLI   BYTE,0              INITIALIZED?                                 
         BNE   *+10                YES                                          
         MVC   BYTE,COLMTHD        SAVE OFF FIRST COLUMN METHOD                 
         CLC   BYTE,COLMTHD        IF DIFFERENT THEN PROCESS ALL RECS           
         BE    *+8                                                              
         MVI   BYTE,C'A'           SET TO ALL METHODS                           
SETMTH30 LA    R3,COLLNQ(,R3)                                                   
         BCT   R0,SETMTH20                                                      
*                                                                               
         LA    R5,FMTLNQ(,R5)      NEXT FORMAT                                  
         BCT   R1,SETMTH10                                                      
*                                                                               
         USING ACMD,R3                                                          
         L     R3,AMONACC                                                       
         CLI   BYTE,C'A'                                                        
         BNE   *+8                                                              
*&&US*&& MVI   ACMCAM,C'A'         PROCESS ALL METHODS (HISTORY RECS)           
*&&UK*&& MVI   QMTHD,C'A'                                                       
*                                                                               
SETMTHDX XMOD1 1                                                                
         DROP  R3,R5                                                            
         LTORG                                                                  
***********************************************************************         
*  SET TIME STATUS FIELD IF NOT ALREADY ON FORMAT                     *         
***********************************************************************         
         SPACE 1                                                                
         USING RFLELD,R2                                                        
TMSSTAT  NMOD1 0,*TMSSTAT                                                       
         L     RC,RLBASEC                                                       
         L     R2,AIO2                                                          
         AH    R2,DATADISP                                                      
TMSST10  CLI   0(R2),EOR                                                        
         BE    TMSST30                                                          
         CLI   0(R2),RFLELQ        Filter element                               
         BNE   TMSST20                                                          
         CLI   RFLTYPE,RFLTSTA     Time status filter for BrandO                
         BNE   TMSST20                                                          
         CLI   RFLSEQ,0            Must be a general filter not colfilt         
         BE    TMSSTX              WAS GENERAL PROFILE FILTER SO SKIP           
TMSST20  SR    RF,RF                                                            
         IC    RF,1(,R2)                                                        
         AR    R2,RF                                                            
         B     TMSST10                                                          
*                                                                               
ELM      USING RFLELD,WORK                                                      
TMSST30  XC    WORK,WORK                                                        
         MVI   ELM.RFLEL,RFLELQ        X'C5'                                    
         LA    R1,RFLLNQ+1                                                      
         STC   R1,ELM.RFLLN            Length                                   
         MVI   ELM.RFLSEQ,0            Column number                            
         MVI   ELM.RFLTYPE,RFLTSTA                                              
         MVI   ELM.RFLIND,RFLINTRL     Internally generated element             
         MVI   ELM.RFLDATA,C'F'        Want fully approved time only            
         GOTO1 ADDEL,DMCB,(C'P',=CL8'ACCVBIG'),AIO2,WORK,0                      
         CLI   12(R1),0                                                         
         BE    TMSSTX                                                           
         DC    H'00'                                                            
TMSSTX   XMOD1 1                                                                
         DROP  ELM,R2                                                           
*                                                                               
         TITLE 'BUILD 1N LEDGER DETAIL FOR COST'                                
***********************************************************************         
*  BUILD TABLE OF 1N ACCOUNT WITH DATA                                *         
***********************************************************************         
         SPACE 1                                                                
         USING ACTRECD,R3                                                       
         USING NONCLID,R4                                                       
         USING ACWORKD,RC                                                       
         USING ACRLD,RA                                                         
GET1N    NMOD1 0,**NONC**                                                       
         L     RC,RLBASEC                                                       
         SR    R2,R2                                                            
         LA    R3,IOKEY                                                         
         L     R4,ANONCLI                                                       
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,RCCOMPFL                                                 
         MVC   ACTKUNT(2),=C'1N'                                                
         MVI   ACTKACT+L'ACTKACT,X'FF'                                          
         OI    BUILT,BUILT1N       SET TO SAY WE BEEN HERE                      
*                                                                               
GET1N10  L     R1,=AL4(IOHIGH+IOAREA3+IOACFIL)                                  
         GOTO1 AIO                                                              
         L     R3,AIO3                                                          
         CLC   ACTKCPY,RCCOMPFL                                                 
         BNE   GET1NX                                                           
         CLC   ACTKUNT(2),=C'1N'   READ ONLY 1N LEDGER                          
         BNE   GET1NX                                                           
         MVC   NONCCODE,ACTKACT    SAVE    KEY                                  
         AH    R3,DATADISP                                                      
*                                                                               
GET1N20  CLI   0(R3),0                                                          
         BNE   *+6                                                              
         DC    H'00'                                                            
         CLI   0(R3),NAMELQ        X'20' NAME                                   
         BE    GET1N25                                                          
         CLI   0(R3),RSTELQ        X'30' RECORD STATUS                          
         BE    GET1N30                                                          
*                                                                               
GET1N22  SR    R1,R1                                                            
         IC    R1,1(,R3)                                                        
         AR    R3,R1                                                            
         B     GET1N20                                                          
*                                                                               
         USING NAMD,R6                                                          
GET1N25  LA    R6,WORK                                                          
         XC    WORK,WORK                                                        
         MVC   NAMKEY(2),=C'1N'                                                 
         MVC   NAMKEY+2(12),NONCCODE                                            
         GOTO1 BINSRCH,DMCB,(1,WORK),NAMBASE,NAME#,NAMLNQ,             X        
               (0,L'NAMKEY),A(MAXNAMES)                                         
         SR    R6,R6                                                            
         ICM   R6,7,DMCB+1         LOAD WHERE INSERTED OR FOUND                 
         BNZ   *+6                 RECORD NOT FOUND AND TABLE FULL              
         DC    H'00'                                                            
         MVC   NAME#,DMCB+8                                                     
*                                                                               
         USING NAMELD,R3                                                        
         SR    R1,R1                                                            
         IC    R1,NAMLN                                                         
         SHI   R1,NAMLN1Q                                                       
         STC   R1,NAMLEN           SAVE LENGTH OF ENTRY                         
         BCTR  R1,0                1 LESS FOR EXMVC                             
         SAM31                                                                  
         L     RE,APOOLPTR              A(NAME POOL)                            
         STCM  RE,15,NAMADR        SAVE A(NON-CLIENT NAME)                      
         EXMVC R1,0(RE),NAMEREC    SAVE OFF NAME                                
         LA    RE,1(R1,RE)         NEXT AVAILABLE AREA IN NAME POOL             
         ST    RE,APOOLPTR         NEW  A(NAME POOL)                            
         C     RE,APOOLEOT         PAST END ?                                   
         SAM24                                                                  
         BNH   GET1N22             LOOP TO NEXT ELEMENT                         
         DC    H'00'               POOL FULL                                    
         DROP  R6                                                               
*                                                                               
         USING RSTELD,R3                                                        
GET1N30  MVC   NONCFLT2,RSTFILT2                                                
         MVC   NONCANAL,RSTCOSTG                                                
         LA    R2,1(,R2)                                                        
         STH   R2,NONCLI#                                                       
*                                                                               
         USING ACTRECD,R3                                                       
         LA    R3,IOKEY                                                         
         L     R5,AIO3                                                          
         MVC   ACTKACT,ACTKACT-ACTRECD(R5)                                      
         MVI   ACTKACT+L'ACTKACT,X'FF'                                          
         LA    R4,NONCLNQ(,R4)                                                  
         B     GET1N10                                                          
         DROP  R3,R4                                                            
*                                                                               
GET1NX   XMOD1 1                                                                
         SPACE 3                                                                
         LTORG                                                                  
         TITLE 'Cashflow column added to prevent loss of sort records'          
***********************************************************************         
*  Add column for cashflow reporting                                  *         
***********************************************************************         
         USING RCLELD,R2                                                        
         USING FMTRECD,R5                                                       
         USING ACRL2D,R7                                                        
CFWCOL   NTR1  BASE=*,LABEL=*                                                   
         L     R7,AACRL2D                                                       
         LR    R4,R1               Save of parameter list address               
         SR    R3,R3                                                            
         L     R2,AIO2                                                          
         MVI   ELCODE,RCLELQ       COLUMN INFORMATION ELEMENT CODE              
         BRAS  RE,GETEL                                                         
         BNE   CFWCOLX                                                          
                                                                                
         SR    RF,RF                                                            
CFWCOL10 AHI   R3,1                Sequence count                               
         CLI   0(R2),RCLELQ        X'C3'                                        
         BNE   CFWCOL15                                                         
         IC    RF,1(,R2)                                                        
         AR    R2,RF                                                            
         B     CFWCOL10                                                         
                                                                                
CFWCOL15 XC    CHOPWRK,CHOPWRK                                                  
         LA    R2,CHOPWRK                                                       
         MVI   RCLEL,RCLELQ        X'C3'                                        
         MVI   RCLLN,RCLNLNQ+2     LENGTH                                       
         STC   R3,RCLSEQ           COLUMN NUMBER                                
*        OC    FMTFCOL,FMTFCOL                                                  
*        BNZ   *+8                 Already set                                  
*        STC   R3,FMTFCOL          Save to figure out disp later                
         MVI   RCLWDTH,8                                                        
         OI    RCLOPT,RCLACCM+RCLHIDE+RCLNEWEL                                  
         OI    RCLOPT2,RCLDICT                                                  
         MVI   RCLDATES,RCLTRDT                                                 
         MVI   RCLDATLN,2                                                       
         L     RF,0(,R1)                                                        
         STCM  RF,3,RCLNDATA                                                    
                                                                                
CFWCOL50 GOTO1 ADDEL,DMCB,(C'P',=CL8'ACCVBIG'),AIO2,(R2),0                      
         CLI   DMCB+12,0                                                        
         BE    *+6                                                              
         DC    H'00'                                                            
                                                                                
CFWCOLX  MVC   0(4,R4),DMCB+16     Return A(Element added)                      
         XIT1                                                                   
         DROP  R2,R5,R7                                                         
         SPACE 3                                                                
         LTORG                                                                  
         TITLE 'Expand columns for Year and Qtr to months'                      
***********************************************************************         
*  Add column for each month within the year range                    *         
***********************************************************************         
                                                                                
         USING RCLELD,R2                                                        
         USING FMTRECD,R5                                                       
         USING ACRL2D,R7                                                        
NEW      USING RCLELD,CHOPWRK                                                   
                                                                                
XPANDCOL NTR1  BASE=*,LABEL=*                                                   
         L     R7,AACRL2D                                                       
         L     R2,AIO2                                                          
         MVI   ELCODE,RCLELQ       Column element                               
         BRAS  RE,GETEL                                                         
         JE    *+6                                                              
         DC    H'00'                                                            
                                                                                
         SR    RF,RF                                                            
         SR    R3,R3                                                            
         ST    R2,FULL             Save address of 1st x'C3'                    
XPCOL010 CLI   0(R2),RCLELQ        X'C3'                                        
         JNE   XPCOL012            Find last column                             
         IC    R3,RCLSEQ           R3 = last column number                      
         IC    RF,1(,R2)                                                        
         AR    R2,RF                                                            
         J     XPCOL010                                                         
                                                                                
XPCOL012 L     R2,FULL                                                          
                                                                                
XPCOL015 DS    0H                                                               
*&&US*&& MVI   BYTE1,0             Clear out for each column                    
         CLI   0(R2),RCLELQ        X'C3'                                        
         JNE   XPANDX                                                           
         TM    RCLOPT,RCLACCM      Amount column ?                              
         JZ    XPCOL018                                                         
         TM    RCLDTEFG,RCLBBF                                                  
         JZ    XPCOL018                                                         
         TM    RCLDTEFG,RCLYEAR           Fiscal Year     +YR or  +YTD          
         JO    XPCOL020                                                         
         TM    RCLDTEFG,RCLQTR            Fiscal Quarter  +QTR or +QTD          
         JO    XPCOL030                                 or +Q1 to +Q4           
                                                                                
XPCOL018 SR    RF,RF                                                            
         IC    RF,1(,R2)                                                        
         AR    R2,RF                                                            
         J     XPCOL015                                                         
                                                                                
XPCOL020 MVI   RCLXDATA,1          Set to level 1                               
         LR    RF,R3                                                            
         AHI   RF,1                                                             
         STC   RF,RCLDTEFM         Save first column connected to               
         MVC   SVSEQ#,RCLSEQ       Save sequence number or original             
*                                                                               
         MVC   BYTE2,SVSEQ#                                                     
         BRAS  RE,CKBUD            chk if orig column has a budget fltr         
         BL    *+14                                                             
         MVI   BYTE1,C'B'                                                       
         MVC   SVBUD#,HALF         Budget number                                
*                                                                               
         LA    R0,16               Default to all 16 columns                    
         TM    RCLDTEFG,RCLTODTE   YTD ?                                        
         JZ    XPCOL025            No                                           
         GOTOR DATCON,DMCB,(3,STARTYR),(0,DTE1)                                 
         GOTOR DATCON,DMCB,(1,RELEND2),(0,DTE2)                                 
         GOTOR PERVERT,DMCB,DTE1,DTE2                                           
         LLC   RF,15(R1)                                                        
         CHI   RF,12               Has to be 12 or less                         
         JNH   *+12                                                             
         SHI   RF,12                                                            
         J     *-12                                                             
                                                                                
         STC   RF,BYTE             Number of months                             
         LA    R0,4                Only 4 choices                               
         LA    RE,YTDMNTHS                                                      
XPCOL022 CLC   BYTE,0(RE)                                                       
         BNH   XPCOL024                                                         
         AHI   RE,2                                                             
         BRCT  R0,XPCOL022                                                      
         DC    H'00'               Check STARTYR , RELEND2                      
                                                                                
XPCOL024 SR    R0,R0                                                            
         IC    R0,BYTE                                                          
         SR    R1,R1                                                            
         IC    R1,1(,RE)           Number of columns to add to months           
         AR    R0,R1                                                            
                                                                                
XPCOL025 STH   R0,HALF                                                          
         XC    CHOPWRK,CHOPWRK                                                  
         MVC   NEW.RCLEL(RCLNLNQ+2),RCLELD                                      
         MVI   NEW.RCLLN,RCLNLNQ+2                                              
         XC    NEW.RCLENDT,NEW.RCLENDT                                          
         ZIC   RF,RCLLN                                                         
         AR    R2,RF               Bump to where to insert                      
         IC    RF,NEW.RCLLN                                                     
         MH    RF,HALF                                                          
         GOTOR INSSPC,DMCB,AIO2,(R2),(RF)                                       
         LA    R4,XPANDYR                 Year column list                      
         LH    R0,HALF                                                          
         J     XPCOL100                                                         
                                                                                
XPCOL030 MVI   RCLXDATA,1          Set to level 1                               
         LR    RF,R3                                                            
         AHI   RF,1                                                             
         STC   RF,RCLDTEFM         Save first column connected to               
         MVC   BYTE,RCLENDT+1      Save off quarter number                      
         MVC   SVSEQ#,RCLSEQ       Save sequence number or original             
*                                                                               
         MVC   BYTE2,SVSEQ#                                                     
         BRAS  RE,CKBUD            chk if orig column has a budget fltr         
         BL    *+14                                                             
         MVI   BYTE1,C'B'                                                       
         MVC   SVBUD#,HALF         Budget number                                
*                                                                               
         MVC   HALF,RCLSTDT        # of year + or -  for Q1 to Q4               
         LH    RF,HALF                                                          
         TM    RCLDTEFG,RCLNROLL   Q1 to Q4 ?                                   
         BO    XPCOL040            Yes                                          
         MVC   HALF,RCLSTDT        # of qtr(s) + or - for QTR or QTD            
         SR    RE,RE                                                            
         LH    RF,HALF             Load # of quarter(s) to count back           
         LHI   R1,4                Four quarters per year                       
         DR    RE,R1               RE = # of quarter(s) RF = # of years         
         ZIC   R1,CURQTR           #1 to 4 - current fix quarter #              
         AR    R1,RE               Number of quarters back or forward           
         BP    XPCOL032            Same year, have quarter                      
         AHI   R1,4                Adjust to 1 to 4                             
         SHI   RF,1                Less one more year                           
         B     XPCOL034                                                         
                                                                                
XPCOL032 CHI   R1,4                                                             
         BNH   XPCOL034                                                         
         SHI   R1,4                Adjust to 1 to 4                             
         AHI   RF,1                Add one more year                            
                                                                                
XPCOL034 STC   R1,BYTE             Current quarter QTD or QTR                   
                                                                                
XPCOL040 XC    CHOPWRK,CHOPWRK                                                  
         MVC   NEW.RCLEL(RCLNLNQ+2),RCLELD                                      
         MVI   NEW.RCLLN,RCLNLNQ+2                                              
         XC    NEW.RCLENDT,NEW.RCLENDT                                          
         STCM  RF,3,NEW.RCLSTDT           Years forward or backward             
                                                                                
         ZIC   RF,RCLLN                                                         
         AR    R2,RF                      Bump to where to insert               
         IC    RF,NEW.RCLLN                                                     
         LA    R0,3                                                             
         MHI   RF,3                                                             
         GOTOR INSSPC,DMCB,AIO2,(R2),(RF)                                       
         LA    R4,XPANDQ1                 Q1  column list                       
         CLI   BYTE,1                                                           
         JE    XPCOL100                                                         
         LA    R4,XPANDQ2                 Q2  column list                       
         CLI   BYTE,2                                                           
         JE    XPCOL100                                                         
         LA    R4,XPANDQ3                 Q3  column list                       
         CLI   BYTE,3                                                           
         JE    XPCOL100                                                         
         LA    R4,XPANDQ4                 Q4  column list                       
         CLI   BYTE,4                                                           
         JE    XPCOL100                                                         
         DC    H'00'               Did something wrong                          
                                                                                
         USING XPDD,R4                                                          
XPCOL100 STC   R0,SV#COLS                 # of columns to add                   
         AHI   R3,1                                                             
         STC   R3,SVNCOL#                                                       
         B     *+8                                                              
XPCOL110 AHI   R3,1                       Bump up sequence number               
         STC   R3,NEW.RCLSEQ              New column number                     
         MVC   NEW.RCLDTEFG,XPDDTEFG      Set to be month or qtr                
         MVC   NEW.RCLENDT+1(1),XPDENDT   Set month or qtr number               
         MVC   NEW.RCLXDATA,XPDCLVL       Column level                          
         MVC   NEW.RCLDTEFM,SVSEQ#                                              
         MVI   NEW.RCLDATLN,2             Length of data is two                 
         MVI   NEW.RCLHD1LN,0             No headings, use defaults             
         MVI   NEW.RCLHD2LN,0             No headings, use defaults             
         ZIC   RF,NEW.RCLLN                                                     
         BCTR  RF,0                                                             
         EXMVC RF,RCLELD,NEW.RCLELD                                             
         LA    R2,1(RF,R2)                                                      
         AHI   R4,XPDLNQ           Next entry                                   
         BRCT  R0,XPCOL110         R0 = Number of entries to add                
*                                                                               
         CLI   BYTE1,C'B'          Budget on orig column?                       
         BNE   XPCOL130            No then don't add add'l C5 elems             
         ZIC   R0,SV#COLS          # of additional columns added w/bud          
         ZIC   R4,SVNCOL#          Column # of 1st additional column            
XPCOL120 GOTOR ADDBC5,DMCB,(R4),SVBUD#                                          
         AHI   R4,1                bump up for next column #                    
         BRCT  R0,XPCOL120         R0 = Number of entries to add                
                                                                                
XPCOL130 J     XPCOL015            Get next column                              
         DROP  NEW                                                              
         DROP  R4                                                               
                                                                                
XPANDX   DS    0H                                                               
         XIT1                                                                   
                                                                                
SVSEQ#   DS    XL1                 Sequence # of originating column             
SVBUD#   DS    XL2                 Saved budget number for xtra C5's            
SV#COLS  DS    XL1                 # of extra columns (and C5's)                
SVNCOL#  DS    XL1                 New column # for 1st expanded col            
         DROP  R2,R5,R7                                                         
         EJECT ,                                                                
*---------------------------------------------------------------------*         
* Insert space at start position inorder to insert element(s)         *         
*---------------------------------------------------------------------*         
         USING RESRECD,R9                                                       
INSSPC   NTR1                                                                   
         L     R9,0(,R1)           A(Record)                                    
         L     R2,4(,R1)           A(Start location to add to)                  
         L     RF,8(,R1)           Space to obtain for elements                 
         LR    R6,R9                                                            
         AH    R6,RESRLEN          R6 = A(End of Record)                        
         LR    R0,R6                                                            
         SR    R0,R2               R0 = Length to move                          
         LH    RE,RESRLEN                                                       
         AR    RE,RF                                                            
         STH   RE,RESRLEN          New length                                   
         LR    R1,R6                                                            
         AR    R1,RF               R1 = A(New end of record)                    
         AHI   R0,1                Add one for EOR                              
                                                                                
INSSPC10 MVC   0(1,R1),0(R6)                                                    
         BCTR  R1,0                                                             
         BCTR  R6,0                                                             
         BRCT  R0,INSSPC10         Move only real data down                     
         J     XPANDX                                                           
         DROP  R9                                                               
***********************************************************************         
* Add C5 element to expanded columns which have budgets                         
***********************************************************************         
ELM      USING RFLELD,WORK                                                      
ADDBC5   NTR1                                                                   
         L     R2,0(,R1)           Column number                                
         L     RE,4(,R1)           Budget number                                
         XC    WORK,WORK                                                        
         MVI   ELM.RFLEL,RFLELQ        X'C5'                                    
         LA    R1,RFLLNQ+2                                                      
         STC   R1,ELM.RFLLN            Length                                   
         STC   R2,ELM.RFLSEQ           Column number                            
         MVI   ELM.RFLTYPE,RFLBUDGT                                             
         MVI   ELM.RFLIND,RFLINTRL     Internally generated element             
         MVC   ELM.RFLDATA(L'BUDKNO2),0(RE)                                     
         GOTO1 ADDEL,DMCB,(C'P',=CL8'ACCVBIG'),AIO2,WORK,0                      
         CLI   12(R1),0                                                         
         BE    *+6                                                              
         DC    H'00'                                                            
         J     XPANDX                                                           
         DROP  ELM                                                              
         LTORG                                                                  
*                                                                               
* Number of columns to add based on number of months for YTD                    
*                                                                               
YTDMNTHS DC AL1(3,1)               If months 1  to  3 then add 1 qtr            
         DC AL1(6,2)               If months 4  to  6 then add 2 qtrs           
         DC AL1(9,3)               If months 7  to  9 then add 3 qtrs           
         DC AL1(12,4)              If months 10 to 12 then add 4 qtrs           
                                                                                
XPANDQ1  DC    AL1(RCLMON+RCLNROLL,1,2) M1                                      
         DC    AL1(RCLMON+RCLNROLL,2,2) M2                                      
         DC    AL1(RCLMON+RCLNROLL,3,2) M3                                      
         DC    AL1(EOT)                                                         
                                                                                
XPANDQ2  DC    AL1(RCLMON+RCLNROLL,4,2) M4                                      
         DC    AL1(RCLMON+RCLNROLL,5,2) M5                                      
         DC    AL1(RCLMON+RCLNROLL,6,2) M6                                      
         DC    AL1(EOT)                                                         
                                                                                
XPANDQ3  DC    AL1(RCLMON+RCLNROLL,7,2) M7                                      
         DC    AL1(RCLMON+RCLNROLL,8,2) M8                                      
         DC    AL1(RCLMON+RCLNROLL,9,2) M9                                      
         DC    AL1(EOT)                                                         
                                                                                
XPANDQ4  DC    AL1(RCLMON+RCLNROLL,10,2) M10                                    
         DC    AL1(RCLMON+RCLNROLL,11,2) M11                                    
         DC    AL1(RCLMON+RCLNROLL,12,2) M12                                    
         DC    AL1(EOT)                                                         
                                                                                
XPANDYR  DC    AL1(RCLQTR+RCLNROLL,1,2) Q1                                      
         DC    AL1(RCLMON+RCLNROLL,1,3) M1                                      
         DC    AL1(RCLMON+RCLNROLL,2,3) M2                                      
         DC    AL1(RCLMON+RCLNROLL,3,3) M3                                      
                                                                                
         DC    AL1(RCLQTR+RCLNROLL,2,2) Q2                                      
         DC    AL1(RCLMON+RCLNROLL,4,3) M4                                      
         DC    AL1(RCLMON+RCLNROLL,5,3) M5                                      
         DC    AL1(RCLMON+RCLNROLL,6,3) M6                                      
                                                                                
         DC    AL1(RCLQTR+RCLNROLL,3,2) Q3                                      
         DC    AL1(RCLMON+RCLNROLL,7,3) M7                                      
         DC    AL1(RCLMON+RCLNROLL,8,3) M8                                      
         DC    AL1(RCLMON+RCLNROLL,9,3) M9                                      
                                                                                
         DC    AL1(RCLQTR+RCLNROLL,04,2) Q4                                     
         DC    AL1(RCLMON+RCLNROLL,10,3) M10                                    
         DC    AL1(RCLMON+RCLNROLL,11,3) M11                                    
         DC    AL1(RCLMON+RCLNROLL,12,3) M12                                    
         DC    AL1(EOT)                                                         
                                                                                
         TITLE 'Time column to force printing of people'                        
***********************************************************************         
*  Add column for time edit reporting                                 *         
***********************************************************************         
         SPACE 1                                                                
         USING RCLELD,R2                                                        
         USING FMTRECD,R5                                                       
DUMMYCOL NMOD1 0,**DMYC**                                                       
         L     RC,RLBASEC                                                       
         L     R2,AIO2                                                          
         SR    R3,R3                                                            
         SR    RF,RF                                                            
         AH    R2,DATADISP                                                      
DMYCOL04 CLI   0(R2),EOR           End of record                                
         BE    DMYCOLX             Element not found                            
         CLI   0(R2),RCLELQ        X'C3' column info                            
         BE    DMYCOL10                                                         
         BH    DMYCOLX             Not found                                    
         IC    RF,1(,R2)                                                        
         AR    R2,RF                                                            
         J     DMYCOL04                                                         
                                                                                
DMYCOL10 LA    R3,1(,R3)                                                        
         CLI   0(R2),RCLELQ        X'C3'                                        
         BNE   DMYCOL15                                                         
         SR    R1,R1                                                            
         IC    R1,1(,R2)                                                        
         AR    R2,R1                                                            
         B     DMYCOL10                                                         
*                                                                               
DMYCOL15 XC    WORK,WORK                                                        
         LA    R2,WORK                                                          
         MVI   RCLEL,RCLELQ        X'C3'                                        
         MVI   RCLLN,RCLNLNQ+4     LENGTH                                       
         STC   R3,RCLSEQ           COLUMN NUMBER                                
         STC   R3,FMTFCOL          SAVE TO FIGURE OUT DISP LATER                
         MVI   RCLWDTH,8                                                        
         OI    RCLOPT,RCLACCM+RCLHIDE                                           
         MVI   RCLDATES,RCLTRDT                                                 
         MVI   RCLDATLN,4                                                       
         MVC   RCLNDATA(4),=C'zero'                                             
         GOTO1 ADDEL,DMCB,(C'P',=CL8'ACCVBIG'),AIO2,WORK,0                      
         CLI   DMCB+12,0                                                        
         BE    DMYCOLX                                                          
         DC    H'00'                                                            
                                                                                
DMYCOLX  XMOD1 1                                                                
         DROP  R2,R5                                                            
                                                                                
         LTORG                                                                  
         TITLE 'Set RANKWK DCB, BUFFALO and TSAR'                               
*=====================================================================*         
*  Set BUFFALO -- Grab core area and set key length and # of accums   *         
*=====================================================================*         
         SPACE 1                                                                
         USING ACWORKD,RC                                                       
         USING ACRLD,RA                                                         
         USING BUFFALOD,R3                                                      
ASETBUFF NMOD1 0,**SETB**                                                       
         L     RC,RLBASEC                                                       
         OC    BFLKEYLN,BFLKEYLN   Rank or vertical % being used ?              
         BZ    SETBUF30            No                                           
         TM    RANKSW,RANKON       Are we ranking ?                             
         BZ    SETBUF10            No                                           
         L     R3,RANKDCB                                                       
         LA    R1,800              MAX RECORD LENGTH                            
         CH    R1,SRTRECLN         MUST BE LESS THEN MAX RECORD LENGTH          
         BNL   *+6                                                              
         DC    H'00'               NEED TO INCREASE MAX RECORD LENGTH           
*                                                                               
         STCM  R1,3,82(R3)         SET DCB RECORD LENGTH                        
         MHI   R1,10               MAGNITUDE OF TEN                             
         STCM  R1,3,62(R3)         SET DCB BLOCK SIZE                           
         OPEN  ((R3),OUTPUT)                                                    
         OI    RANKSW,RANKOPN                                                   
*                                                                               
SETBUF10 L     R3,ABUFF                                                         
         OI    BUFFXOPT,BUFFXBIG                                                
         MVI   BUFFROWS+3,1                                                     
         SR    R1,R1                                                            
         IC    R1,MAX#ACMS         Number of accumulated columns                
         LA    R1,1(,R1)           Add one extra column                         
         SR    RF,RF                                                            
         IC    RF,MAX#RTES         Number of rate columns                       
         AR    R1,RF               Add these , special cases                    
         ST    R1,BUFFCOLS         Number of accumulators                       
         MHI   R1,PKLEN                                                         
         ST    R1,BUFFLDTA         Save length of accumulators                  
         ST    R1,BUFFWROW         Width of rows                                
         MVI   BUFFWCOL+3,8        Width of columns                             
*                                                                               
         MVI   BUFFFLIP,C'A'       File indicator                               
         LH    R2,BFLKEYLN         Length of buffalo key                        
         ST    R2,BUFFLKEY         Save key length                              
         CHI   R2,255                                                           
         BNH   *+6                                                              
         DC    H'00'               Buffalo supports 255 max                     
*                                                                               
SETBUF20 STC   R2,BUFFCNTL         Length of key remaining                      
         MVC   BUFFCNTL+1(2),=X'C1FF'                                           
*                                                                               
         AR    R2,R1                    Length of full record                   
         ST    R2,BUFFLALL                                                      
         MVI   BUFFFLVR,C'P'            Packed flavor                           
         SR    R0,R0                    Set to zero for division                
         L     R1,=AL4(BUFFQ)           Size of buffer area                     
         DR    R0,R2                    Core size / record size                 
         ST    R1,BUFFCRMX              Number of lines in core                 
         GOTO1 BUFFALO,DMCB,=C'SET',ABUFF                                       
         MVC   BUFFADDR,ABUFCOR         A(CORE BUFFER)                          
         EJECT ,                                                                
*=====================================================================*         
*  INITIALIZE BUFFER FOR TSAR                                         *         
*=====================================================================*         
                                                                                
         USING TSARD,R1                                                         
SETBUF30 OI    THRSW,THR2BIG       KEY > 255                                    
         LH    RF,SRTKEYLN                                                      
         CHI   RF,255              KEY LENGTH > 255? (US)                       
*&&DO*&& CHI   RF,243              KEY LENGTH > 243? (UK)                       
         BH    SETBUF35                                                         
         LH    R0,SRTRECLN                                                      
         CHI   R0,1500             TEST VERY LONG RECS                          
         BH    SETBUF35            TSAR CAN'T HOLD MANY, USE SORTER             
         NI    THRSW,TURNOFF-THR2BIG   NOT TOO BIG                              
         OI    TSARSW,TSARON       SET TO USE TSAR                              
         LA    R1,TSARBLK                                                       
         XC    TSARD(TSARDL),TSARD CLEAR TSAR BLOCK                             
         MVC   TSACOM,ADCOMFAC     A(COMFACS)                                   
         MVC   TSABUF,ATBUFF       A(TSAR BUFF)                                 
         MVC   TSAREC,ATBUFLEN     SIZE OF BUFFER                               
         BCTR  RF,0                Less one for RECXIND                         
*        MVC   TSKEYL,SRTKEYLN+1   KEY LENGTH                                   
         STC   RF,TSKEYL                                                        
         MVC   TSRECL,SRTRECLN     RECORD LENGTH                                
         MVI   TSOFFACT,TSAINI     ACTION(INIT) IS HOB OF BUFFER                
         OI    TSIND2,TSI2MANY     USE FULL WORD COUNTERS                       
         GOTO1 ATSAROFF                                                         
         BE    *+6                                                              
         DC    H'00'                                                            
         DROP  R1                                                               
*                                                                               
         USING ACRL2D,RF                                                        
SETBUF35 DS    0H                                                               
* Not ready for limlist yet                                                     
*        L     RF,AACRL2D                                                       
*        GOTO1 GOATSAR,DMCB,('TSAINI',ATSRERRS),0,GAPAREA,TSARABUF              
         DROP  RF                                                               
         EJECT ,                                                                
*=====================================================================*         
*  SET SORTCARD FOR SORT RECORD                                       *         
*=====================================================================*         
                                                                                
SETBUF40 LA    R1,1                STARTING POSITION OF SORTKEY                 
         CVD   R1,DUB              CONVERT KEY LENGTH TO CHARACTER              
         OI    DUB+7,X'0F'                                                      
         UNPK  SORTCARD+13(3),DUB+6(2)                                          
         LH    R1,SRTKEYLN         SORT KEY LENGTH                              
         CVD   R1,DUB              CONVERT KEY LENGTH TO CHARACTER              
         OI    DUB+7,X'0F'                                                      
         UNPK  SORTCARD+17(4),DUB+5(3)                                          
         LH    R1,SRTRECLN                                                      
         CVD   R1,DUB              CONVERT RECORD LENGTH TO CHARACTER           
         OI    DUB+7,X'0F'                                                      
         UNPK  RECCARD+22(4),DUB+5(3)                                           
         GOTO1 ADSORTER,DMCB,SORTCARD,RECCARD,0                                 
*                                                                               
SETBUF90 XMOD1 1                                                                
         SPACE 3                                                                
SORTCARD DC    CL80'SORT FIELDS=(000,0000,A),FORMAT=BI,WORK=1'                  
RECCARD  DC    CL80'RECORD TYPE=F,LENGTH=(0000,,,,)'                            
         SPACE 3                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*  FIX TABLES FOR DIFFERENT LANGUAGES                                 *         
***********************************************************************         
         SPACE 1                                                                
         USING ACWORKD,RC                                                       
         USING ACRLD,RA                                                         
         USING ACRL2D,R7                                                        
         USING KYWD,R6                                                          
LANGCONV DS    0D                                                               
         NMOD1 0,**LANG**                                                       
         L     RC,RLBASEC                                                       
         L     R6,KYWBASE                                                       
         L     R7,AACRL2D                                                       
LANGC10  OC    KYWCODE,KYWCODE                                                  
         BZ    LANGC40                                                          
         CLI   KYWCODE,ESC#HIGH                                                 
         BNL   LANGC30             KEYWORD OK AS IS, CHECK HEADING              
         MVC   KYWDD#,KYWNUMDD     SAVE DICTIONARY NUMBER                       
         GOTO1 ADDICTAT,DMCB,C'SU  ',KYWCODE,0                                  
         CLI   KYWTAB#,KYWSFL1     SOFT LEVEL 1 THRU 4                          
         BL    LANGC30                                                          
         LA    RE,KYWCODE          SEARCH FOR #                                 
         LA    RF,L'KYWCODE                                                     
LANGC14  CLI   0(RE),C'#'                                                       
         BE    LANGC15                                                          
         LA    RE,1(,RE)                                                        
         BCT   RF,LANGC14                                                       
         DC    H'00'               MUST HAVE C'#' IN KEYWORD                    
*                                                                               
LANGC15  MVC   0(1,RE),KYWTAB#     FILL C'#' WITH C'1' THRU C'4'                
LANGC30  LA    R6,KYWLNQ(,R6)                                                   
         B     LANGC10                                                          
*                                                                               
LANGC40  L     R6,ATTYPE           TRANSACTION TYPE 30 TABLE                    
LANGC42  CLI   0(R6),EOT           END OF TABLE?                                
         BE    LANGC60                                                          
         CLI   0(R6),ESC#HIGH                                                   
         BNL   LANGC45               KEYWORD OK AS IS, CHECK HEADING            
         GOTO1 ADDICTAT,DMCB,C'SU  ',(R6),0                                     
LANGC45  LA    R6,6(,R6)                                                        
         B     LANGC42                                                          
*                                                                               
LANGC60  MVCDD AC@RSBLK(6),AC#RSBLK                                             
         GOTO1 ADDICTAT,DMCB,C'SU  ',AC@RSBLK,0                                 
         MVCDD AC@YES,AC#YES                                                    
         GOTO1 ADDICTAT,DMCB,C'SU  ',AC@YES,0                                   
         MVCDD AC@NO,AC#NO                                                      
         GOTO1 ADDICTAT,DMCB,C'SU  ',AC@NO,0                                    
*                                  CALCULATE EXECUTE LENGTH OF AC@RLBLK         
         LA    RE,L'AC@RSBLK-1     INITIALIZE                                   
*                                                                               
LANGC65  LA    RF,AC@RSBLK(RE)     ->   LAST CHARACTER                          
         CLI   0(RF),C' '          LAST CHARACTER BLANK ?                       
         BNE   LANGC70             NO,  SAVE LENGTH                             
         BCT   RE,LANGC65          TRY  PREVIOUS CHARACTER                      
*                                                                               
LANGC70  STC   RE,ACLRSBLK         SAVE EXECUTE LENGTH                          
*                                                                               
         MVCDD AC@CHGS,AC#CHGS                                                  
         GOTO1 ADDICTAT,DMCB,C'SL  ',AC@CHGS,0                                  
         MVCDD AC@BLG,AC#BLG                                                    
         GOTO1 ADDICTAT,DMCB,C'SL  ',AC@BLG,0                                   
         XMOD1 1                                                                
         DROP  R7                                                               
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* Get user field data                                                           
***********************************************************************         
         USING UDKRECD,R4                                                       
         USING UDKELD,R5                                                        
GETUSDF  NTR1                                                                   
         L     R4,UDKBASE          A(USER DEFINED KEYWORD TABLE)                
         SR    R1,R1                                                            
GETUSDF1 CLI   0(R4),0             END OF KEYWORDS?                             
         BE    GETUSDF9                                                         
         IC    R1,UDKRECLN         REOCRD LENGTH                                
         CLM   R6,1,UDKSEQ         USER DEFINED KEYWORD SEQUNCE NUMBER          
         BE    GETUSDF2            FOUND MATCH                                  
         AR    R4,R1                                                            
         B     GETUSDF1                                                         
*                                                                               
GETUSDF2 LA    R5,UDKLNQ(,R4)      POINT TO START OF DATA                       
         AR    R4,R1               POINT TO END OF ENTRY                        
GETUSDF4 CR    R5,R4               AT END OF RECORD YET?                        
         BL    *+6                                                              
         DC    H'0'                PAST DATA, DIE LEDGER NOT FOUND              
         CLC   QUNIT(2),UDKUNT     COMPARE UNIT/LEDGER                          
         BE    GETUSDF8            NOT LEDGER WORKING ON NOW                    
         LA    R5,UDKELQ(,R5)      BUMP TO NEXT ENTRY                           
         B     GETUSDF4                                                         
*                                                                               
GETUSDF8 ICM   R6,15,UDKINDX       FOUND MATCH, R6=DATA ENTRY                   
         SR    RE,RE                                                            
GETUSDF9 LTR   RE,RE               SET CONDITION CODE                           
         XIT1  REGS=(R6)                                                        
         DROP  R4,R5                                                            
         SPACE 2                                                                
         LTORG                                                                  
         TITLE 'CONVERT INFIX NOTATION TO POSTFIX NOTATION'                     
***********************************************************************         
*        ADD EQUATION TO TABLE AND POINT TO EQUATION IN COLXTRA       *         
*        POLISH CONVERTS FORM INFIX TO POSTFIX NOTATION               *         
*            EXAMPLE   INFIX   = (C1+C2)/2                            *         
*                      POSTFIX = C1C2+2/                              *         
*            C1 MEANS COLUMN 1                                        *         
*            C2 MEANS COLUMN 2                                        *         
*            2 IS THE NUMBER TWO                                      *         
*        THE POSTFIX EXPRESSION IS STACK OF F(0), EACH OPERAND AND    *         
*        OPLNQ AND EQLNQ SHOULD BE EQUAL OPERATOR AND OPERAND         *         
***********************************************************************         
TMP      USING EQD,R3                                                           
PSTACK   USING EQD,R4                                                           
OSTACK   USING OPD,R5                                                           
TAB      USING OPD,R6                                                           
         USING ACRLD,RA                                                         
         USING ACWORKD,RC                                                       
*                                                                               
POLISH   DS    0D                                                               
         NMOD1 0,**POLH**                                                       
         L     RC,RLBASEC                                                       
         LR    R0,R1               SAVE PARAMETER AREA                          
         CLI   FINDDATA,C'='       OLD TYPE CALCULATION?                        
         BE    POLISH60            YES, SO FORMAT AS POLISH                     
*                                                                               
         SR    RF,RF                                                            
         IC    RF,0(,R1)           LENGTH  OF INFIX                             
         L     R2,0(,R1)           A(INFIX INPUT)                               
         MVC   INFIX,SPACES                                                     
         BCTR  RF,0                                                             
         EXMVC RF,INFIX,0(R2)                                                   
*                                                                               
         L     R4,4(,R1)           A(POSTFIX STACK OUTPUT)                      
         MVI   OPFLAG,0            SET FLAG                                     
         LA    R2,INFIX            POINT TO EQUATION DATA                       
         ST    R2,SVREG            INITIALIZE TO START OF INFIX                 
*                                                                               
         LA    R5,OPSTACK          OPERATOR STACK                               
POLISH10 CLI   0(R2),C' '          EQUATION END?                                
         BE    POLISH50                       YES, FINISHED                     
         XC    PSTACK.EQD(EQLNQ),PSTACK.EQD   CLEAR ONE STACK ITEM AREA         
         MVI   CNTRDEC,4                      4 DECIMALS                        
*        MVI   CNTRDEC,2                      2 DECIMALS                        
         TM    OPFLAG,OPNOUNI      DON'T CHECK FOR UNARY                        
         BO    POLISH12                                                         
         CLI   0(R2),C'+'          POSITIVE # (NOT A TRUE OPERATOR)             
         BNE   *+8                                                              
         LA    R2,1(,R2)           IGNORE POSITIVE SIGN, EXTRANIOUS             
         CLI   0(R2),C'-'          NEG. NUMBER (NOT A TRUE OPERATOR)            
         BNE   POLISH12                                                         
         MVI   PSTACK.EQTYPE,EQBIN#     UNARY  ZERO ONTO    STACK               
         MVI   PSTACK.EQDEC#,4                                                  
         LA    R4,EQLNQ(,R4)       PUSH A ZERO ONTO POSTFIX STACK               
         MVI   0(R2),C'~'          MY REVERSE SIGN OPERATOR                     
         LR    RF,R2               UPDATE RF                                    
         B     POLISH15            CREATE (0-VALUE)                             
*                                                                               
POLISH12 NI    OPFLAG,TURNOFF-OPNOUNI     RE-SET                                
         CLI   0(R2),C'C'          COLUMN NUMBER?                               
         BNE   POLISH14            NO                                           
         MVI   OPFLAG,OPCOLUMN     COLUMN NUMBER                                
         MVI   CNTRDEC,C'N'        NO DECMIALS                                  
         LA    R2,1(,R2)           BUMP PAST CHAR C"C"                          
*                                                                               
POLISH14 LR    RF,R2               POINT TO NUMBER                              
*                                                                               
POLISH15 LA    R6,OPTABLE          TABLE OF OPERATORS                           
*                                                                               
POLISH16 CLC   TAB.OPSYMBOL,0(RF)  IS IT AN OPERTATOR?                          
         BE    POLISH20            YES, GOT OPERATOR                            
         LA    R6,OPLNQ(,R6)       BUMP TO NEXT OPERATOR                        
         CLI   TAB.OPTYPE,EOT      END OF OPERTATOR TABLE?                      
         BNE   POLISH16            BUMP UP, AND CHECK NEXT OPERATOR             
*                                                                               
         LA    RF,1(,RF)           BUMP NOT NEXT DIGIT                          
         OI    OPFLAG,OPERAND      GOT NUMBER                                   
         CLI   0(RF),C' '          END OF INFIX ?                               
         BNE   POLISH15            NO, SO CONTINUE                              
         B     *+8                 YES, BUT NO MORE OPERATORS                   
POLISH20 OI    OPFLAG,OPERATOR     GOT OPERATOR                                 
*                                                                               
         TM    OPFLAG,OPVERT       WAS IT A VERTICAL % LAST TIME IN?            
         BZ    POLISH27            NO, SO CONTINUE                              
         LR    R3,R4               POINT TO POSSIBLE V% OPERATOR                
         AHI   R3,-EQLNQ           POP TO FIND V% OPERATOR                      
         CLI   TMP.EQTYPE,EQVERT   IS THIS THE V% OPERATOR ?                    
         BE    POLISH21            FOUND       V% OPERATOR                      
         LR    R3,R5               MUST BE ON OPSTACK                           
         AHI   R3,-OPLNQ           POP  TO POINT TO V% OPERATOR                 
*                                                                               
POLISH21 MVI   TMP.EQDEC#,EQCOL    Mark as column level (EQDEC# temp)           
         CLI   0(R2),C'R'          Vertical level on row?                       
         BNE   *+8                 No                                           
         MVI   TMP.EQDEC#,EQROW    Mark as row level (EQDEC# temporary)         
         LA    R2,1(,R2)                                                        
         LR    RE,R2               Bump up by one                               
         ST    RF,SVREG            Save location of operator                    
*                                                                               
POLISH22 CR    RE,RF               Is there a second operand ?                  
         BNE   POLISH23            Possibly                                     
         MVC   TMP.EQCOL#,OPSAVE   No so use pervious operand                   
         LA    R7,TMP.EQROWLVL     Point to new location, row/col level         
         B     POLISH25                                                         
*                                                                               
POLISH23 CLI   0(RE),C'C'                                                       
         BE    POLISH24            2ND OPERAND                                  
         LA    RE,1(,RE)           BUMP UP BY ONE, AND TRY AGIAN                
         B     POLISH22            LOOP                                         
*                                                                               
POLISH24 SR    RE,R2               LENGTH OF NUMBER                             
         LR    RF,R2                                                            
         AR    R2,RE               SAVE NEW LOCATION FOR R2                     
         GOTO1 CASHVAL,DMCB,(C'N',(RF)),(RE)                                    
         MVC   TMP.EQROWLVL,DMCB+7 SAVE ROW/COLUMN LEVEL #                      
         LA    R2,1(,R2)           BUMP PAST C'C'                               
         LA    R7,TMP.EQCOL#       POINT TO NEW LOCATION, COL #                 
         L     RF,SVREG            RE-LOAD RF                                   
         DROP  TMP                                                              
*                                                                               
POLISH25 SR    RF,R2               LENGTH OF NUMBER                             
         GOTO1 CASHVAL,DMCB,(C'N',(R2)),(RF)                                    
         MVC   0(1,R7),DMCB+7      SAVE EITHER ROW/COL LEVEL OR COL #           
         NI    OPFLAG,TURNOFF-OPVERT-OPERAND                                    
*                                                                               
POLISH27 CLI   TAB.OPSYMBOL,C'V'   IS IT A VERTICAL %                           
         BNE   *+8                 NO                                           
         OI    OPFLAG,OPVERT       YES, TURN OF INDICATOR                       
*                                                                               
         ST    RF,SVREG            SAVE LOCATION OF OPERATOR                    
         TM    OPFLAG,OPERAND      DID WE GET A NUMBER?                         
         BZ    POLISH30            NO, SO PUSH ON TO OPSTACK                    
         SR    RF,R2               LENGTH OF NUMBER                             
*                                                                               
         GOTO1 CASHVAL,DMCB,(CNTRDEC,(R2)),(RF)                                 
         MVI   PSTACK.EQTYPE,EQCOL        MARK AS COLUMN NUMBER                 
         MVC   PSTACK.EQCOL#,DMCB+7       SAVE COLUMN NUMBER                    
         TM    OPFLAG,OPVERT              VERTICAL PERCENT?                     
         BZ    *+10                                                             
         MVC   OPSAVE,PSTACK.EQCOL#       SAVE COLUMN NUMBER                    
*                                                                               
         TM    OPFLAG,OPCOLUMN            COLUMN NUMBER?                        
         BO    POLISH28                                                         
         MVI   PSTACK.EQCOL#,0            SAVE COLUMN NUMBER                    
         MVI   PSTACK.EQTYPE,EQBIN#       MARK AS BINARY CONSTANT               
         MVI   PSTACK.EQDEC#,4                                                  
         MVC   PSTACK.EQCONST,DMCB+4      GET BINARY NUMBER FROM DMCB           
*                                                                               
POLISH28 LA    R4,EQLNQ(,R4)       BUMP TO NEXT POSTITION IN STACK              
*                                                                               
POLISH30 LA    RE,OPSTACK          TOP OF OPSTACK                               
         TM    OPFLAG,OPERATOR     DID WE GET A OPERATOR?                       
         BZ    POLISH50            FINISHED                                     
*                                                                               
POLISH32 AHI   R5,-OPLNQ                  POP OPSTACK                           
         CR    R5,RE                      IS IT UNDERFLOW?                      
         BL    POLISH35                      YES, PUSH ON TO OPSTACK            
         CLC   OSTACK.OPORDER,TAB.OPORDER    COMPARE PRECEDENCE OF OP           
         BL    POLISH35                      PUSH ONTO OPSTACK                  
         CLI   TAB.OPSYMBOL,C'('          IF LEFT PARENTH THEN BRANCH           
         BE    POLISH40                      ELIMINATE                          
         CLI   TAB.OPSYMBOL,C''          IF LEFT PARENTH THEN BRANCH           
         BE    POLISH40                      ELININATE                          
         CLI   TAB.OPSYMBOL,C'{'          IF LEFT PARENTH THEN BRANCH           
         BE    POLISH40                      ELIMINATE                          
         MVC   PSTACK.EQD(EQLNQ),OSTACK.OPD  PUSH TO POSTFIX                    
         LA    R4,EQLNQ(,R4)                                                    
         XC    PSTACK.EQD(EQLNQ),PSTACK.EQD       CLEAR NEXT ITEM AREA          
         B     POLISH32                           CHECK NEXT                    
*                                                                               
POLISH35 LA    R5,OPLNQ(,R5)       UNPOP OPERATOR                               
         OI    OPFLAG,OPNOUNI      SET TO SKIP SIGN (+ OR -) CHECK              
         CLI   TAB.OPSYMBOL,C')'   ELIMINATE                                    
         BE    POLISH45                                                         
         CLI   TAB.OPSYMBOL,C'|'   ELIMINATE                                    
         BE    POLISH45                                                         
         CLI   TAB.OPSYMBOL,C'}'   ELIMINATE                                    
         BE    POLISH45                                                         
         NI    OPFLAG,TURNOFF-OPNOUNI        SET ON NOT TO SKIP CHECK           
         XC    OSTACK.OPD(OPLNQ),OSTACK.OPD  CLEAR OPSTACK                      
         MVC   OSTACK.OPD(OPLNQ),TAB.OPD     PUSH OPERATOR ONTO OPSTACK         
*                                                                               
POLISH40 LA    R5,OPLNQ(,R5)                                                    
         B     *+8                                                              
*                                                                               
POLISH45 AHI   R5,-OPLNQ               POP OPSTACK                              
         L     R2,SVREG                                                         
         LA    R2,1(,R2)               BUMP PAST OPERATOR                       
         NI    OPFLAG,OPVERT+OPNOUNI   RE-SET FLAG                              
         TM    OPFLAG,OPVERT                                                    
         BO    POLISH14                                                         
         B     POLISH10                                                         
*                                                                               
POLISH50 LA    RE,OPSTACK                     START OF OPSTACK                  
POLISH52 CR    R5,RE                          TOP   OF OPSTACK YET ?            
         BNH   POLISH99                       YES                               
         AHI   R5,-OPLNQ                      POP     OPSTACK                   
         MVC   PSTACK.EQD(EQLNQ),OSTACK.OPD   MOVE TO POSTFIX                   
         LA    R4,EQLNQ(,R4)                  PUSH    POSTFIX                   
         B     POLISH52                       LOOP UNTIL STACK EMPTY            
         EJECT                                                                  
***********************************************************************         
*        OLD STYLE CALCULATIONS WITH "=" AND ","                      *         
*        MIMIC POSTFIX NOTATION                                       *         
***********************************************************************         
         SPACE 1                                                                
POLISH60 L     R4,4(,R1)           ADDRESS OF POSTFIX STACK                     
         LA    R3,32               SKIP OVER EQUAL SIGN                         
         A     R3,ABLOCK                                                        
         ZIC   R1,NPRAMS           NUMBER OF PARAMETERS                         
         BCTR  R1,0                                                             
*                                                                               
         XC    PSTACK.EQD(EQLNQ),PSTACK.EQD                                     
         MVC   PSTACK.EQCOL#,7(R3)      PUSH COLUMN NUMBER ONTO POSTFIX         
         MVI   PSTACK.EQTYPE,EQCOL      MARK AS COLUMN                          
         LA    R3,32(,R3)                                                       
         LA    R4,EQLNQ(,R4)                                                    
         BCT   R1,POLISH68                                                      
         B     POLISH99            FINISHED                                     
*                                                                               
POLISH68 LA    R6,OPTABLE          FIND WHICH OPERATOR                          
POLISH69 CLI   TAB.OPTYPE,EOT      END OF OPERATORS?                            
         BNE   *+6                                                              
         DC    H'0'                   NO OPERATOR TYPE                          
         CLC   12(1,R3),TAB.OPSYMBOL  MATCH OPERATOR                            
         BE    POLISH70                                                         
         LA    R6,OPLNQ(,R6)       BUMP UP IN OPERATOR TABLE                    
         B     POLISH69                                                         
*                                                                               
POLISH70 MVC   OPSTACK(OPLNQ),TAB.OPD   PUSH ONTO OPSTACK                       
         BCT   R1,*+6                                                           
         DC    H'0'                     NO OPERATOR TYPE                        
*                                                                               
         LA    R3,32(,R3)                                                       
         MVC   PSTACK.EQD(EQLNQ),PSTACK.EQD                                     
         MVC   PSTACK.EQCOL#,7(R3)      PUSH COLUMN NUMBER ON POSTFIX           
         MVI   PSTACK.EQTYPE,EQCOL      MARK AS COLUMN                          
         LA    R3,32(,R3)                                                       
         LA    R4,EQLNQ(,R4)                                                    
         MVC   PSTACK.EQD(EQLNQ),OPSTACK     PUSH OPERATOR ONTO POSTFIX         
         LA    R4,EQLNQ(,R4)                                                    
         BCT   R1,POLISH68                                                      
*                                                                               
POLISH99 MVI   PSTACK.EQTYPE,EQEND MARK END OF STACK WITH X'FF'                 
         LA    R4,1(,R4)           BUMP UP TO END                               
         LR    R1,R0               RESTORE PARAMETER ADDRESS                    
         ST    R4,0(,R1)           PASS BACK END OF STACK                       
         XMOD1 1                                                                
         DROP  OSTACK                                                           
         DROP  PSTACK                                                           
         DROP  TAB                                                              
***********************************************************************         
*        OPERATOR TABLE WITH PRECEDENCE                               *         
***********************************************************************         
         SPACE 1                                                                
         DS    0A                                                               
OPTABLE  DC    AL1(OPREG),C'(',AL1(0,0)                                         
         DC    AL4(0)                                                           
         DC    AL1(OPREG),C'',AL1(0,0)                                         
         DC    AL4(0)                                                           
         DC    AL1(OPREG),C'{',AL1(0,0)                                         
         DC    AL4(0)                                                           
         DC    AL1(OPREG),C')',AL1(0,1)                                         
         DC    AL4(0)                                                           
         DC    AL1(OPREG),C'|',AL1(0,1)                                         
         DC    AL4(0)                                                           
         DC    AL1(OPREG),C'}',AL1(0,1)                                         
         DC    AL4(0)                                                           
         DC    AL1(OPREG),C'+',AL1(OPADD,4)     ADDITION                        
         DC    AL4(0)                                                           
         DC    AL1(OPREG),C'-',AL1(OPSUB,4)     SUBTRACTION                     
         DC    AL4(0)                                                           
         DC    AL1(OPREG),C'*',AL1(OPMULT,5)    MULTIPLICATION                  
         DC    AL4(0)                                                           
         DC    AL1(OPREG),C'X',AL1(OPMULT,5)    MULTIPLICATION                  
         DC    AL4(0)                                                           
         DC    AL1(OPREG),C'/',AL1(OPDIV,5)     DIVISION                        
         DC    AL4(0)                                                           
         DC    AL1(OPREG),C'%',AL1(OPPCT,5)     PERCENTAGE                      
         DC    AL4(0)                                                           
         DC    AL1(OPVRT),C'V',AL1(OPVPCT,7)    VERTICAL %                      
         DC    AL4(0)                                                           
         DC    AL1(OPREG),C'~',AL1(OPSUB,9)     REVERSE SIGN                    
         DC    AL4(0)                                                           
         DC    AL1(EOT)                         END OF TABLE                    
*                                                                               
OPFLAG   DS    AL1                                                              
OPCOLUMN EQU   X'80'               COLUMN   FOUND                               
OPERAND  EQU   X'40'               OPERAND  FOUND                               
OPERATOR EQU   X'20'               OPERATOR FOUND                               
OPVERT   EQU   X'10'               VERTICAL FOUND                               
OPNOUNI  EQU   X'08'               DON'T CHECK SIGN FOR UNARY                   
OPSAVE   DS    CL1                 SAVE OPERAND COLUMN NUMBER                   
INFIX    DS    CL30                                                             
INFIXEND DC    C' '                                                             
CNTRDEC  DS    AL1                 NUM OF DECIMALS PLACES FOR CASHVAL           
         DS    0F                                                               
         DC    C'**OPSK**'                                                      
OPSTACK  DS    15XL(OPLNQ)                                                      
         SPACE 1                                                                
***********************************************************************         
* See if column is a budget column                                              
***********************************************************************         
         USING RFLELD,RF                                                        
         USING COLD,R3                                                          
CKBUD    NTR1  BASE=*,LABEL=*                                                   
         LR    RF,R2                                                            
CKBUD10  CLI   0(RF),EOR                                                        
         JE    CKBUDL                                                           
         CLI   0(RF),RFLELQ        X'C5' element                                
         JNE   CKBUD30                                                          
         CLI   RFLTYPE,RFLBUDGT    Is it a budget                               
         JNE   CKBUD30                                                          
         CLC   RFLSEQ,BYTE2                                                     
         JNE   CKBUD30                                                          
         MVC   HALF,RFLDATA        Budget number                                
         J     CKBUDE              Done                                         
                                                                                
CKBUD30  LLC   R1,1(,RF)                                                        
         AR    RF,R1                                                            
         J     CKBUD10                                                          
                                                                                
CKBUDL   CLI   *,X'FF'             SET CC = LOW                                 
         J     CKBUDX                                                           
CKBUDE   CR    RB,RB               SET CC = EQUAL                               
CKBUDX   XIT1                                                                   
         DROP  RF                                                               
         LTORG                                                                  
         TITLE 'ADD DATES TO COLUMNS BASED ON START AND END DATES'              
***********************************************************************         
*  ADD DATES TO COLUMN                                                *         
***********************************************************************         
         SPACE 1                                                                
         USING ACWORKD,RC                                                       
         USING ACRLD,RA                                                         
         USING RCLELD,R2                                                        
         USING COLD,R3                                                          
         USING FMTRECD,R5                                                       
         USING KYWD,R6                                                          
         USING ACRL2D,R7                                                        
         USING LCBLD,R8                                                         
ADDATE   NTR1  BASE=*,LABEL=*                                                   
         L     R2,0(,R1)           POINT TO COLUMN ELEMENT                      
         L     R3,4(,R1)           POINT TO COLUMN TABLE ENTRY                  
         L     R6,8(,R1)           POINT TO KEYWORD ENTRY                       
         L     R8,12(,R1)          CBUILD local working storage                 
         L     R7,AACRL2D                                                       
*                                                                               
         MVI   DATEPASS,1                                                       
         TM    KYWIND4,KYWBDATE+KYWTDATE+KYWWDATE                               
         BZ    *+8                                                              
         MVI   DATEPASS,2                                                       
         XC    STCOLDTE,STCOLDTE                                                
         MVC   ENCOLDTE,=X'FFFFFF'                                              
         MVC   RELDATE,RELEND                                                   
         MVC   RELDAYS,DAT2PRT                                                  
         MVC   RELQTR,CURQTR                                                    
         MVC   REQSTDTE,STDATE                                                  
         MVC   REQENDTE,RQRELEND                                                
         CLC   REQENDTE,=X'FFFFFF'                                              
         BNE   *+10                                                             
         MVC   REQENDTE,ENDATE                                                  
         MVC   HEAD_A,SPACES       CLEAR COLUMN HEADING AREA 1                  
         MVC   HEAD_B,SPACES                    HEADING AREA 2                  
         MVC   HEAD_C,SPACES                    HEADING AREA 3                  
         MVC   SRTDTE(4),RCLSTDT   MOVE INTO ALIGNED HALF WORD DATA             
         TM    COLIND1,COLCNDR     CALENDAR BASED                               
         BZ    ADDATE30                                                         
         OI    FMTIND,FMTSFTH      SOFT COLUMN HEADINGS                         
         XC    COLCSMOA,COLCSMOA                                                
         MVC   COLCEMOA,=X'FFFFFF'                                              
         DROP  R5                                                               
*                                                                               
ADDATE30 LA    RE,ADDATE50                                                      
         ST    RE,RETURN2                                                       
*                                                                               
ADDATE40 TM    COLIND1,COLCNDR     CALENDAR BASED?                              
         BZ    ADDATE46            NO                                           
         TM    RCLDTEFG,RCLPERD                                                 
         BZ    ADDATE46                                                         
         TM    RCLDTEFG,RCLMON     PM1-PM12 OR PMON TYPE                        
         BO    PRDMON                                                           
         B     PRDBLD              P1-P99 OR P#                                 
         DC    H'00'                                                            
*                                                                               
ADDATE46 TM    RCLDTEFG,TURNOFF-RCLTODTE                                        
         BZ    PERBLD              PER BASED ON START/END DATES                 
         TM    RCLDTEFG,RCLDAY                                                  
         BO    DAYBLD              DAY TYPE                                     
         TM    RCLDTEFG,RCLMON                                                  
         BO    MONBLD              M1-M12 OR MON TYPE                           
         TM    RCLDTEFG,RCLQTR                                                  
         BO    QTRBLD              Q1-Q4  OR QTD,QTR TYPE                       
         TM    RCLDTEFG,RCLYEAR                                                 
         BO    YEARBLD             YEAR OR YTD TYPE                             
         TM    RCLDTEFG,RCLBBF                                                  
         BO    BBFBLD              BALANCE BROUGHT FORWARD                      
         DC    H'00'                                                            
*                                                                               
ADDATE50 TM    COLIND1,COLCNDR     Calendar based ?                             
         BZ    ADDATE53            No                                           
         TM    RCLDTEFG,RCLTODTE                                                
         BZ    ADDATE52                                                         
         TM    REQIND,REQCMTH      Calendar month requested ?                   
         BO    ADDATE52            Yes                                          
         CLC   QSTART(L'QSTART+L'QEND),SPACES                                   
         BNH   ADDATE52            No request start or end                      
         OI    COLDTTYP,COL2DTE                                                 
*                                                                               
ADDATE52 MVC   HEAD_A(8),DATE#8                                                 
         CLI   HEAD_B,C'&&'                                                     
         BE    *+10                                                             
         MVC   HEAD_B,HEAD_A                                                    
*                                                                               
ADDATE53 OC    STCOLDTE,STCOLDTE                                                
         BZ    ADDATE55                                                         
         GOTO1 DATCON,DMCB,(3,STCOLDTE),(1,COLSTART)                            
         CLI   COLDATES,COLMDTE    MOA?                                         
         BNE   *+8                                                              
         MVI   COLSTART+2,01       FORCE YYMM01                                 
         TM    COLIND1,COLCNDR     CALENDAR BASED                               
         BZ    *+10                                                             
         MVC   COLCSMOA,COLSTART                                                
*                                                                               
ADDATE55 CLI   ENCOLDTE,X'FF'                                                   
         BE    ADDATE60                                                         
         GOTO1 DATCON,DMCB,(3,ENCOLDTE),(1,COLEND)                              
         TM    COLIND1,COLCNDR     CALENDAR BASED                               
         BZ    *+10                                                             
         MVC   COLCEMOA,COLEND                                                  
*                                                                               
ADDATE60 CLI   DATEPASS,2                                                       
         BNE   ADDATE90            FINISHED IF NOT EQUAL                        
         LA    RE,ADDATE80                                                      
         ST    RE,RETURN2                                                       
         XC    STCOLDTE,STCOLDTE                                                
         MVC   ENCOLDTE,=X'FFFFFF'                                              
         MVC   RELDATE,ALTREL      USE ALTERNATE BILLING DATE (PROD)            
         MVC   RELDAYS,ALTADDDT                                                 
         MVC   RELQTR,ALTCURQT                                                  
         MVC   REQSTDTE,STDATE                                                  
         MVC   REQENDTE,RQRELEND                                                
         CLC   REQENDTE,=X'FFFFFF'                                              
         BNE   *+10                                                             
         MVC   REQENDTE,ENDATE                                                  
         TM    DATEFLT,DATEBIL                                                  
         BZ    ADDATE62                                                         
         MVC   REQSTDTE,ALTSTDTE                                                
         MVC   REQENDTE,ALTENDTE                                                
*                                                                               
ADDATE62 MVC   HEAD_A,SPACES       CLEAR COLUMN HEADING AREA                    
         MVC   HEAD_B,SPACES       CLEAR COLUMN HEADING AREA                    
         MVC   HEAD_C,SPACES       CLEAR COLUMN HEADING AREA                    
*                                                                               
         TM    RCLDTEFG,TURNOFF-RCLTODTE                                        
         BZ    PERBLD                                                           
         TM    RCLDTEFG,RCLDAY                                                  
         BNZ   DAYBLD                                                           
         TM    RCLDTEFG,RCLMON                                                  
         BNZ   MONBLD                                                           
         TM    RCLDTEFG,RCLQTR                                                  
         BNZ   QTRBLD                                                           
         TM    RCLDTEFG,RCLYEAR                                                 
         BNZ   YEARBLD                                                          
         DC    H'0'                                                             
*                                                                               
ADDATE80 OC    STCOLDTE,STCOLDTE                                                
         BZ    ADDATE85                                                         
         GOTO1 DATCON,DMCB,(3,STCOLDTE),(1,COLALTST)                            
         CLI   COLDATES,COLMDTE    MOA?                                         
         BNE   *+8                                                              
         MVI   COLALTST+2,01       FORCE YYMM01                                 
ADDATE85 CLI   ENCOLDTE,X'FF'                                                   
         BE    ADDATE90                                                         
         GOTO1 DATCON,DMCB,(3,ENCOLDTE),(1,COLALTEN)                            
*                                                                               
ADDATE90 L     RE,COLHEAD3                                                      
         MVC   0(HEADEND-HEAD_A,RE),HEAD_A                                      
         SR    RE,RE               SET CC TO EQUAL                              
         XMOD1 1                                                                
         EJECT                                                                  
***********************************************************************         
*  DAY                                                                *         
*---------------------------------------------------------------------*         
*             SSSSEEEE  SSSS = RCLSTDT, EEEE=RCLENDT                  *         
*  DAY   -->  DAY1DAY2  DAY1 = NUBMER OF DAYS                         *         
*                       DAY2 = NUMBER OF DAYS FORWARD FROM DAY1       *         
***********************************************************************         
         SPACE 1                                                                
DAYBLD   SR    R6,R6                                                            
         CLC   RCLSTDT,=XL2'8000'                                               
         BNE   DAYBLD10                                                         
         MVC   HEAD_B(2),=C'&& '                                                
         MVC   HEAD_B+2(L'AC@PRIOR),AC@PRIOR                                    
         OC    RCLENDT,RCLENDT                                                  
         BNZ   DAYBLD20                                                         
         MVC   ENCOLDTE,RELDATE                                                 
         MVC   HEAD_A(L'AC@CUR),AC@CUR                                          
         MVC   HEAD_B(10),SPACES                                                
         B     DAYBLD80                                                         
*                                                                               
DAYBLD10 TM    RCLSTDT,X'80'       IS IT NEGATIVE                               
         BZ    *+6                 NO                                           
         BCTR  R6,0                MAKE NEGATIVE NUMBER                         
         ICM   R6,3,RCLSTDT        START DATE PARAMETER                         
         GOTO1 ADDAY,DMCB,(C'D',RELDAYS),TEMPDATE,(R6)                          
         GOTO1 DATCON,DMCB,(0,TEMPDATE),(3,STCOLDTE)                            
         GOTO1 DATCON,DMCB,(0,TEMPDATE),(8,HEAD_A)                              
*                                                                               
DAYBLD20 CLC   RCLENDT,=XL2'8000'  AFTER?                                       
         BNE   DAYBLD24            NO                                           
         MVI   ENCOLDTE,X'FF'      END DATE INFINITE                            
         MVC   HEAD_B(2),=C'&& '                                                
         MVC   HEAD_B+2(L'AC@AFTER),AC@AFTER                                    
         OC    RCLSTDT,RCLSTDT     ANY START DATE?                              
         BNZ   DAYBLD80            YES                                          
         MVC   HEAD_A(L'AC@FUTUR),AC@FUTUR                                      
         MVC   HEAD_B(10),SPACES                                                
         B     DAYBLD80                                                         
*                                                                               
DAYBLD24 SR    R6,R6                                                            
         TM    RCLENDT,X'80'       IS IT NEGATIVE                               
         BZ    *+6                 NO                                           
         BCTR  R6,0                YES                                          
         ICM   R6,3,RCLENDT        END DATE PARAMETER                           
         GOTO1 ADDAY,DMCB,(C'D',RELDAYS),TEMPDATE,(R6)                          
         LA    R6,HEAD_B                                                        
         CLI   STCOLDTE,0                                                       
         BNE   *+8                                                              
         LA    R6,HEAD_A                                                        
         GOTO1 DATCON,DMCB,(0,TEMPDATE),(3,ENCOLDTE)                            
         GOTO1 DATCON,DMCB,(0,TEMPDATE),(8,(R6))                                
DAYBLD80 L     RE,RETURN2                                                       
         BR    RE                                                               
         EJECT                                                                  
***********************************************************************         
*  PM1-PM12 OR PMON, R9=MONTH, R4=YEAR                                *         
*---------------------------------------------------------------------*         
*             SSSSEEEE  SSSS = RCLSTDT, EEEE=RCLENDT                  *         
*  PMON  -->  YYPPMMMM  YY   = X'FF',X'00',X'01' LAST,CUR,NEXT YEAR   *         
*                       PP   = 1 THRU 10 FOR PERIOD NUMBER            *         
*                       MMMM = -NUMBER OR +NUMBER FOR MONTHS TO ROLL  *         
*---------------------------------------------------------------------*         
*  PM1-PM12-> YYPPMMMM  YY   = X'FF',X'00',X'01' LAST,CUR,NEXT YEAR   *         
*                       PP   = 1 THRU 10 FOR PERIOD NUMBER            *         
*                       MMMM = 1 THRU 12 FOR FIXED  MONTHS            *         
***********************************************************************         
         SPACE 1                                                                
PRDMON   SR    R9,R9                                                            
         SR    R4,R4                                                            
         MVI   COLDTTYP,COLPMON    RANGE OF PERIODS WITHIN A MONTH              
         MVC   COLPERST,RCLPDN1    MOVE IN RELATIVE PERIOD#                     
         MVC   STCOLDTE,RELDATE                                                 
         TM    RCLPDYR,X'80'       LAST YEAR ?                                  
         BZ    *+6                 NO                                           
         BCTR  R4,0                MAKE NEGATIVE ONE (ALL X'FF'S)               
         IC    R4,RCLPDYR          YEAR FRAME (PRIOR/CURRENT/FUTURE)            
*                                  R4 =           -1/ ZERO  /  1                
         LH    R9,ENDDTE           MONTH # FOR  PM1-PM12                        
         TM    RCLDTEFG,RCLNROLL   NO  ROLLING  MONTHS                          
         BZ    MONBLD30            FIXED MONTHS PM1-PM12                        
         BCTR  R9,0                                                             
         MVC   STCOLDTE(1),STARTYR                                              
         B     MONBLD30                                                         
         EJECT                                                                  
***********************************************************************         
*  M1-M12 OR MON, R9=MONTH, R4=YEAR                                   *         
*---------------------------------------------------------------------*         
*             SSSSEEEE  SSSS = RCLSTDT, EEEE=RCLENDT                  *         
*  MON   -->  MMMM           = NUBMER OF MONTHS BACKWARDS OR FORWARDS *         
*                 MMMM  WHEN SSSS=X'8000' FOR ALL PRIOR MONTHS        *         
*                       IF   EEEE=X'8000' THEN ALL FUTURE MONTHS      *         
*---------------------------------------------------------------------*         
*  M1-M12 --> YYYYMMMM  YYYY = YEARS FORWARDS OR BACKWARDS            *         
*                       MMMM = 1 THRU 12 FOR FIXED MONTHS             *         
***********************************************************************         
         SPACE 1                                                                
MONBLD   SR    R9,R9               ZERO OUT FOR DIVISION                        
         SR    R4,R4                                                            
         MVC   STCOLDTE,RELDATE    CALCULATE RELITIVE MONTHS                    
         TM    COLIND1,COLCNDR     CALENDAR TYPE                                
         BZ    MONBLD10                                                         
         MVI   COLDTTYP,COLMNTH    RANGE OF PERIODS WITHIN A MONTH              
*                                                                               
MONBLD10 TM    RCLDTEFG,RCLNROLL   NO ROLLING MONTHS                            
         BZ    MONBLD20                                                         
         MVC   STCOLDTE(1),STARTYR                                              
         LH    R9,ENDDTE           NUMBER OF MONTH 1-12 (M1-M12)                
         BCTR  R9,0                                                             
         LH    R4,SRTDTE           NUMBER OF YEAR, BACKWARD OR FORWARD          
         B     MONBLD30                                                         
*                                                                               
MONBLD20 LA    R6,SRTDTE                                                        
         CLC   RCLSTDT,=XL2'8000'  PRIOR?                                       
         BNE   *+8                 NO,  GET NUMBER OF MONTHS IN START           
         LA    R6,ENDDTE           YES, GET NUMBER OF MONTHS IN END             
         LH    R9,0(,R6)           R9 = NUMBER OF MONTHS                        
*                                                                               
MONBLD30 MVC   WORK(1),STCOLDTE    SET YEAR                                     
         MVC   WORK+1(1),RELMM     GET RELATIVE MONTH                           
         TM    RCLDTEFG,RCLNROLL                                                
         BZ    *+10                                                             
         MVC   WORK+1(1),STARTYR+1 GET FISCAL/OVER-RIDE START MONTH             
         MVI   WORK+2,01           SET TO FIRST DAY OF MONTH                    
         GOTO1 DATCON,DMCB,(3,WORK),(0,TEMPDATE)                                
         GOTO1 ADDAY,DMCB,(C'M',TEMPDATE),TEMPDATE,(R9)                         
*                                                                               
         LTR   R4,R4               ANY YEARS TO ADD/SUBTRACT ?                  
         BZ    MONBLD55            NO                                           
         GOTO1 ADDAY,DMCB,(C'Y',TEMPDATE),TEMPDATE,(R4)                         
*                                                                               
MONBLD55 GOTO1 DATCON,DMCB,(0,TEMPDATE),(3,STCOLDTE)                            
         GOTO1 DATCON,DMCB,(X'30',TEMPDATE),(3,ENCOLDTE),(1,0)                  
*                                                                               
MONBLD60 CLC   RELDATE(2),ENCOLDTE IF CURRENT YYMM THEN USE END DATE            
         BNE   MONBLD62                                                         
         CLI   REQENDTE,X'FF'      IF NO REQENDTE DON'T WORRY                   
         BE    MONBLD62                                                         
         CLI   RELDD,0                                                          
         BE    MONBLD62                                                         
         MVC   ENCOLDTE+2(1),RELDD USE END DATE OF REQUEST                      
*                                                                               
MONBLD62 LA    R6,STCOLDTE                                                      
         CLC   RCLSTDT,=XL2'8000'  DO WE WANT EVERYTHING PRIOR?                 
         BNE   MONBLD64                                                         
         XC    STCOLDTE,STCOLDTE                                                
         LA    R6,ENCOLDTE                                                      
         MVC   HEAD_B(2),=C'&& '                                                
         MVC   HEAD_B+2(L'AC@PRIOR),AC@PRIOR                                    
         B     MONBLD70                                                         
*                                                                               
MONBLD64 CLC   RCLENDT,=XL2'8000'  DO WE WANT EVERYTHING AFTER?                 
         BNE   MONBLD70                                                         
         MVC   ENCOLDTE,=X'FFFFFF'                                              
         MVC   HEAD_B(2),=C'&& '                                                
         MVC   HEAD_B+2(L'AC@AFTER),AC@AFTER                                    
*                                                                               
MONBLD70 GOTO1 DATCON,DMCB,(3,(R6)),(9,HEAD_A)                                  
*                                                                               
         L     RE,RETURN2                                                       
         BR    RE                                                               
         EJECT                                                                  
***********************************************************************         
*  Q1-Q4 OR QTR OR QTD                                                *         
*---------------------------------------------------------------------*         
*             SSSSEEEE  SSSS = RCLSTDT, EEEE=RCLENDT                  *         
*  QTR   -->  QQQQ           = NUBMER OF QUARTERS BACK OR FORWARDS    *         
*  QTD                                                                *         
*---------------------------------------------------------------------*         
*  Q1-Q12 ->  YYYYQQQQ  YYYY = NUMBER OF YEARS BACK OR FORWARDS       *         
*        -->            QQQQ = FIXED QUARTER BASED ON FISCAL OR START *         
***********************************************************************         
         SPACE 1                                                                
QTRBLD   LH    R4,SRTDTE           R4=#YEAR (Q1-Q4), R9=#QTRS (QTR/QTD)         
         LH    R9,ENDDTE           GET SPECIFIC QUARTER FOR Q1-Q4               
         L     R5,QTRBASE                                                       
*&&UK*&& TM    DDLNKIND,DDLNKQKR   Quick reports ?                              
*&&UK*&& BO    *+10                Yes, don't show 'QTR'                        
         MVC   HEAD_C(3),=C'QTR'                                                
         MVI   COLDTTYP,COLQTR     Quarter type column                          
         TM    COLIND1,COLCNDR     CALENDAR TYPE                                
         BZ    *+8                                                              
         OI    COLDTTYP,COLMNTH    Start and end qtr months                     
         TM    RCLDTEFG,RCLNROLL   Q1-Q4 ?                                      
         BO    QTRBLD30            YES, NON-ROLLING QUARTER                     
*                                  PROCESS QTR OR QTD                           
         USING QTRD,R5                                                          
         SR    R1,R1               ROLLING QUARTERS                             
         IC    R1,RELQTR           GET CURRENT QUARTER TO BASE ON               
         BCTR  R1,0                                                             
         MHI   R1,QTRLNQ                                                        
         AR    R5,R1               ADD BASE OF QTR TABLE                        
         LA    R6,C'M'             ADD/SUB R4=MONTHS                            
         MHI   R4,03               3 MONTHS IN A QUARTER                        
         B     QTRBLD35                                                         
*                                                                               
*                                  PROCESS Q1 - Q4                              
QTRBLD30 DS    0H                                                               
*&&UK*&& TM    DDLNKIND,DDLNKQKR   Quick reports ?                              
*&&UK*&& BO    QTRBLD32            Yes, don't show 'Qn'                         
         MVC   HEAD_C(3),=C'Qn '                                                
         STC   R9,HEAD_C+1                                                      
         OI    HEAD_C+1,X'F0'                                                   
                                                                                
QTRBLD32 BCTR  R9,0                POINT TO QTR START/END DATES IN TAB          
         MHI   R9,QTRLNQ                                                        
         AR    R5,R9               ADD BASE OF QTR TABLE                        
         MVC   STCOLDTE,QTRSTRB    QUARTER START BINARY                         
         MVC   ENCOLDTE,QTRENDB    QUARTER END   BINARY                         
         LTR   R4,R4               ADD ANY YEARS TO THE QUARTER ?               
         BZ    QTRBLD40            NO                                           
         LA    R6,C'Y'             ADD/SUB R4=YEARS                             
*                                                                               
QTRBLD35 GOTO1 ADDAY,DMCB,((R6),QTRSTRC),TEMPDATE,(R4)                          
         GOTO1 DATCON,DMCB,(0,TEMPDATE),(3,STCOLDTE)                            
         GOTO1 ADDAY,DMCB,((R6),QTRENDC),(X'80',TEMPDATE),(R4)                  
         GOTO1 DATCON,DMCB,(0,TEMPDATE),(3,ENCOLDTE)                            
*                                                                               
QTRBLD40 TM    RCLDTEFG,RCLTODTE   QUARTER TO DATE IS STUPID                    
         BZ    QTRBLD80            NO, NOT TOO STUPID THEN                      
         L     R5,QTRBASE                                                       
         SR    R1,R1               ROLLING QUARTERS                             
         IC    R1,RELQTR           GET CURRENT QUARTER TO BASE ON               
         BCTR  R1,0                                                             
         MHI   R1,QTRLNQ                                                        
***********************************************************************         
* NOTE - CHECK FOR QTR THAT CROSSES OVER TO NEW YEAR                  *         
*        I.E. (NOV-JAN) OR (DEC-FEB)                                  *         
***********************************************************************         
         SPACE 1                                                                
         AR    R5,R1               POINT TO CURRENT QTR DATES                   
         CLI   QTRENDB+1,02        IF END <=2 THEN SPECIAL QTR CASE             
         BH    QTRBLD74            IF END > 2 THEN EASY TO CHECK FOR            
         CLC   QTRENDB+1(1),ENCOLDTE+1      IS THIS COLUMN THIS QTR ?           
         BNE   QTRBLD74            NO, SO NOW CHECK REQUEST END                 
         CLI   RELDATE+1,12        CASE IS NOV-JAN. IS END MM = NOV ?           
         BE    *+8                 YES, CHANGE END DATE FOR YTD                 
         CLI   RELDATE+1,11        CASE IS NOV-JAN. IS END MM = NOV ?           
         BNE   QTRBLD74            CHECK AS NORMAL                              
         MVC   ENCOLDTE+1(2),RELDATE+1                                          
         GOTO1 DATCON,DMCB,(3,ENCOLDTE),(0,TEMPDATE)                            
         GOTO1 ADDAY,DMCB,(C'Y',TEMPDATE),TEMPDATE,F'-1'                        
         GOTO1 DATCON,DMCB,(0,TEMPDATE),(3,ENCOLDTE)                            
         B     QTRBLD80                                                         
*                                                                               
QTRBLD74 CLC   ENCOLDTE+1(1),QTRSTRB+1     DOES REQUESTED MONTH FALL            
         BL    QTRBLD80                    IN   THIS QUARTER ?                  
         CLC   ENCOLDTE+1(1),QTRENDB+1                                          
         BH    QTRBLD80                                                         
         MVC   ENCOLDTE+1(2),RELDATE+1     QUARTER TO DATE                      
*                                                                               
QTRBLD80 MVI   BYTE,8              MMMDD/YY                                     
         TM    COLIND1,COLCNDR     If calendar column use MMMDD/YY              
         BO    *+8                                                              
         MVI   BYTE,9              MMM/YY                                       
         GOTO1 DATCON,DMCB,(3,STCOLDTE),(BYTE,HEAD_A)                           
         GOTO1 DATCON,DMCB,(3,ENCOLDTE),(BYTE,HEAD_B)                           
*                                                                               
QTRBLD90 L     RE,RETURN2                                                       
         BR    RE                                                               
         DROP  R5                                                               
         EJECT                                                                  
***********************************************************************         
*  PER,  BASED ON START/END DATE                                      *         
***********************************************************************         
         SPACE 1                                                                
PERBLD   MVC   STCOLDTE,REQSTDTE                                                
         MVC   ENCOLDTE,REQENDTE                                                
         TM    COLFLAGS,COLBUD                                                  
         BZ    PERBLD10                                                         
         CLI   QPROG,GENERAL       General ledger only for now                  
         BNE   PERBLD10                                                         
         CLI   RMOASTR,0                                                        
         BE    PERBLD05                                                         
         MVC   STCOLDTE(2),RMOASTR                                              
         MVI   STCOLDTE+2,1                                                     
         GOTO1 DATCON,DMCB,(X'31',STCOLDTE),(3,STCOLDTE),(0,0)                  
                                                                                
PERBLD05 CLI   RMOAEND,X'FF'                                                    
         BE    PERBLD10                                                         
         MVC   ENCOLDTE(2),RMOAEND                                              
         MVI   ENCOLDTE+2,1                                                     
         GOTO1 DATCON,DMCB,(X'31',ENCOLDTE),(3,ENCOLDTE),(1,0)                  
                                                                                
PERBLD10 TM    COLIND1,COLCNDR          Calendar type                           
         BZ    PERBLD15                 No                                      
         NI    COLIND1,TURNOFF-COLCNDR  Yes, but turn off bit                   
         TM    REQIND,REQCMTH           Request was calendar based ?            
         BZ    PERBLD15                 No                                      
         OI    COLIND1,COLCNDR          Yes, turn it back on                    
         MVI   COLDTTYP,COLMNTH         Range of periods within a month         
*                                                                               
PERBLD15 CLI   STCOLDTE,0            BUILD COLUMN HEADINGS                      
         BNE   PERBLD20                                                         
         MVC   HEAD_B(2),=C'&& '                                                
         MVC   HEAD_B+2(L'AC@PRIOR),AC@PRIOR                                    
         CLI   ENCOLDTE,X'FF'        IF BOTH STCOLDTE & END ARE INFINIT         
         BNE   PERBLD30                                                         
         MVC   HEAD_A(L'AC@CUR),AC@CUR                                          
         MVC   HEAD_B(10),SPACES                                                
         B     PERBLD90                                                         
*                                                                               
PERBLD20 GOTO1 DATCON,DMCB,(3,STCOLDTE),(8,HEAD_A)                              
         CLI   ENCOLDTE,X'FF'                                                   
         BNE   PERBLD30                                                         
         MVC   HEAD_B(2),=C'&& '                                                
         MVC   HEAD_B+2(L'AC@AFTER),AC@AFTER                                    
         B     PERBLD90                                                         
*                                                                               
PERBLD30 DS    0H                                                               
*&&UK                                                                           
         MVC   WORK(L'ENCOLDTE),ENCOLDTE                                        
         OC    SENDATE,SENDATE                                                  
         BZ    *+10                                                             
         MVC   WORK(L'SENDATE),SENDATE                                          
         GOTO1 DATCON,DMCB,(3,WORK),(8,HEAD_A)                                  
*&&                                                                             
*&&US*&& GOTO1 DATCON,DMCB,(3,ENCOLDTE),(8,HEAD_A)                              
                                                                                
PERBLD90 L     RE,RETURN2                                                       
         BR    RE                                                               
         EJECT                                                                  
***********************************************************************         
*  YEAR OR YTD , R1 = YEAR                                            *         
*---------------------------------------------------------------------*         
*             SSSSEEEE  SSSS = RCLSTDT, EEEE=RCLENDT                  *         
*  YEAR  -->  YYYY           = NUMBER OF YEARS BACK OR FORWARDS       *         
*  YTD   -->  YYYY           = NUMBER OF YEARS BACK OR FORWARDS       *         
***********************************************************************         
         SPACE 1                                                                
YEARBLD  MVC   STCOLDTE,STARTYR    MOVE IN REQUEST START YYMMDD                 
         MVI   STCOLDTE+2,01       INITIALIZE THE  DD OF YYMMDD                 
         LH    R1,SRTDTE           R1 = NUMBER OF YEARS                         
         SR    R0,R0                                                            
         IC    R0,STCOLDTE         GET CURRENT YEAR                             
         AR    R1,R0               ADD/SUB NUMBER OF YEARS                      
         STC   R1,STCOLDTE         SAVE NEW YEAR                                
         MVI   COLDTTYP,COLYEAR    Year column                                  
         TM    COLIND1,COLCNDR     CALENDAR TYPE                                
         BZ    *+8                                                              
         OI    COLDTTYP,COLMNTH    Range of dates within a month                
*                                                                               
*              END DATE = START DATE + 1 YEAR - 1 DAY                           
*                                                                               
         GOTO1 DATCON,DMCB,(3,STCOLDTE),(0,TEMPDATE)                            
         GOTO1 ADDAY,DMCB,(C'Y',TEMPDATE),TEMPDATE,F'1'                         
         GOTO1 DATCON,DMCB,(X'30',TEMPDATE),(3,ENCOLDTE),(5,0)                  
*                                                                               
*&&UK*&& TM    DDLNKIND,DDLNKQKR   Quick reports ?                              
*&&UK*&& BO    *+10                Yes, don't show 'Full Year'                  
         MVC   HEAD_C(9),=CL9'Full Year'                                        
         TM    RCLDTEFG,RCLTODTE           IS YEAR TO DATE (YTD) USED ?         
         BZ    YEARBLD6                    NO                                   
         MVC   HEAD_C,SPACES                                                    
         MVC   HEAD_A(3),=CL3'YTD'         MAKE HEADING 1 "YTD"                 
         MVC   HEAD_C(3),=CL3'YTD'         MAKE HEADING 3 "YTD"                 
         CLC   ENCOLDTE+1(1),RELDATE+1     WHAT YY DOES MONTH FALL INTO         
         BNL   YEARBLD4                    REQUEST MMDD, YY OK                  
         MVC   ENCOLDTE(1),STCOLDTE        FIX     YY,   IT WAS TOO FAR         
*                                                                               
YEARBLD4 MVC   ENCOLDTE+1(2),RELDATE+1     RESET   MMDD TO END OF               
         GOTO1 DATCON,DMCB,(3,ENCOLDTE),(20,TEMPDATE)                           
         MVC   HEAD_B(4),TEMPDATE                                               
         B     YEARBLD9                                                         
*                                                                               
YEARBLD6 GOTO1 DATCON,DMCB,(3,ENCOLDTE),(20,TEMPDATE)                           
         MVC   HEAD_A(4),TEMPDATE                                               
*                                                                               
YEARBLD9 L     RE,RETURN2                                                       
         BR    RE                                                               
         EJECT                                                                  
***********************************************************************         
*  P1-Pn, R1 = PERIOD NUMBER OR PED, PERIOD RANGE                     *         
***********************************************************************         
         SPACE 1                                                                
PRDBLD   ST    RE,SVRE                                                          
         LH    R1,ENDDTE           PERIOD NUMBER P1-PX                          
         TM    RCLDTEFG,RCLNROLL                                                
         BO    PRDBLD10                                                         
         STC   R1,COLPERED         RELATIVE END PERIOD                          
         LH    R6,SRTDTE                                                        
         STC   R6,COLPERST         RELATIVE START PERIOD                        
         SR    R6,R6                                                            
         OI    COLDTTYP,COLPRNG    PERIOD RANGE TYPE                            
         B     PRDBLD20                                                         
*                                                                               
PRDBLD10 STC   R1,COLPERST         RELATIVE PERIOD #                            
         LH    R6,SRTDTE           NUMBER OF YEARS, BACK OR FORWARD             
         OI    COLDTTYP,COLPFX#    FIXED PERIOD TYPE                            
*                                                                               
PRDBLD20 MVC   WORK(3),STARTYR                                                  
         MVI   WORK+2,01           SET DAY TO 01                                
*                                  R6 = NUMBER OF YEARS TO ADD                  
         GOTO1 DATCON,DMCB,(3,WORK),(0,TEMPDATE)                                
         GOTO1 ADDAY,DMCB,(C'Y',TEMPDATE),TEMPDATE,(R6)                         
         GOTO1 DATCON,DMCB,(0,TEMPDATE),(1,WORK)                                
         MVC   COLPERYR,WORK       SAVE PACKED YY (YEAR OF PERIOD)              
         MVC   HEAD_A(8),DATE#8                                                 
         MVC   HEAD_B(8),DATE#8                                                 
*                                       MUST PUT PERIOD YEAR INORDER            
         MVC   HEAD_A(1),COLPERST       FOR CHUNK TO WORK CORRECTLY             
         L     RE,SVRE                                                          
         BR    RE                                                               
         EJECT                                                                  
BBFBLD   ST    RE,SVRE                                                          
         XC    STCOLDTE,STCOLDTE   PRIOR                                        
         MVC   ENCOLDTE,STARTYR    MOVE IN REQUEST START YYMMDD                 
         GOTO1 DATCON,DMCB,(3,ENCOLDTE),(8,HEAD_A)                              
         MVC   HEAD_B(2),=C'&& '                                                
         MVC   HEAD_B+2(L'AC@PRIOR),AC@PRIOR                                    
         L     RE,SVRE                                                          
         BR    RE                                                               
         DROP  R7,R8                                                            
         EJECT                                                                  
         LTORG                                                                  
         TITLE 'BUILD TABLE CONTAINING BUDGET DATA FOR PROCESSING'              
***********************************************************************         
*  CREATE BUDGET INFO                                                 *         
***********************************************************************         
         SPACE 1                                                                
         USING BIVELD,R2                                                        
         USING COLD,R3                                                          
         USING BUDD,R4                                                          
         USING FMTRECD,R5                                                       
         USING KYWD,R6                                                          
         USING ACRLD,RA                                                         
         USING ACWORKD,RC                                                       
         USING BUDRECD,R7                                                       
ABUDBLD  DS    0D                                                               
         NMOD1 0,**BUDB**                                                       
         L     RC,RLBASEC                                                       
         MVI   FMT#BUDS,0          NUMBER OF BUDGETS                            
         L     R3,FMTCOL                                                        
         ZIC   R0,FMT#COLS                                                      
         NI    FMTIND2,TURNOFF-FMTBUDOK    TURN OFF INDICATOR                   
*                                                                               
BUDBLD10 TM    COLFLAGS,COLBUD     IS IT A BUDGETED COLUMN?                     
         BZ    BUDBLD80            NO LOOP                                      
         L     R4,FMTBDGT          A(BUDGET DATA)                               
BUDBLD16 OC    BUD#,BUD#           AND BUDGETS SET UP YET?                      
         BZ    BUDBLD30            SET UP NEW BUDGET ENTRY                      
         CLC   BUD#,COLBUD#        MATCH BUDGET NUMBERS                         
         BE    BUDBLD20            UPDATE ENTRY                                 
         LA    R4,BUDLNQ(,R4)      BUMP TO NEXT BUDGET AREA                     
         B     BUDBLD16                                                         
*                                                                               
BUDBLD20 CLC   BUDSDTE,COLSTART                                                 
         BL    *+10                                                             
         MVC   BUDSDTE,COLSTART                                                 
         CLC   BUDEDTE,COLEND                                                   
         BH    *+10                                                             
         MVC   BUDEDTE,COLEND                                                   
         B     BUDBLD80            FINISHED                                     
*                                                                               
BUDBLD30 MVC   BUDSDTE,COLSTART                                                 
         MVC   BUDEDTE,COLEND                                                   
*                                                                               
BUDBLD32 MVC   BUD#,COLBUD#        MOVE IN BUDGET NUMBER                        
         LA    R7,IOKEY                                                         
         ZIC   R6,FMT#BUDS         ADD ONE TO NUMBER OF BUDGETS                 
         LA    R6,1(,R6)                                                        
         STC   R6,FMT#BUDS                                                      
         XC    BUDKEY,BUDKEY       KEY REQUIRES BINARY ZEROS                    
         MVI   BUDKTYP,BUDKTYPQ    X'1B'                                        
         MVC   BUDKCPY,RCCOMPFL    COMPANY CODE                                 
         MVC   BUDKNO1,BUD#        BUDGET NUMBER                                
         L     R1,=AL4(IOHIGH+IOACFIL+IOBUD)                                    
         GOTO1 AIO                                                              
         BE    *+6                                                              
         DC    H'0'                                                             
         CLC   BUDKNO1,BUD#                                                     
         BE    *+6                                                              
         DC    H'0'                                                             
         SR    R1,R1                                                            
         L     R2,ABUDIO           GET BUDGET RULES                             
         AH    R2,DATADISP                                                      
BUDBLD34 CLI   0(R2),0             END OF RECORD                                
         BE    BUDBLD38            BUDGET FOR UNIT/LEDGER ?                     
*&&US*&& CLI   0(R2),BCNELQ        X'1B'                                        
*&&US*&& BE    BUDBLD37                                                         
         CLI   0(R2),BIVELQ        X'1C'                                        
         BNE   BUDBLD36                                                         
         CLC   BIVAUNT(2),QUNIT    MATCH UNIT AGAINT REQUESTED UNIT             
         BE    BUDBLD40                                                         
BUDBLD36 IC    R1,1(,R2)                                                        
         AR    R2,R1                                                            
         B     BUDBLD34                                                         
*                                                                               
*&&US                                                                           
         USING BCNELD,R2                                                        
BUDBLD37 TM    BCNSTAT,X'80'       Is this budget by office?                    
         BZ    BUDBLD36                                                         
         OI    BUDIND,BUDBYOF                                                   
         B     BUDBLD36                                                         
*&&                                                                             
         DROP  R2                                                               
*                                                                               
BUDBLD38 XC    BUD#,BUD#           WIPE OUT BUDGET                              
         B     BUDBLD80            PROCESS NEXT COLUMN                          
***********************************************************************         
*  GET LENGTH OF ACCOUNT FOR THIS BUDGET LEVEL                        *         
***********************************************************************         
         SPACE 1                                                                
         USING BIVELD,R2                                                        
BUDBLD40 ZIC   R6,BIVACLV          ACCOUNT LEVEL                                
         AHI   R6,-1               SUBTRACT ONE                                 
         SLL   R6,2                X4 FOR THE LENGTH OF AN A(0)                 
         L     R6,AKYWLVLS(R6)     LOAD KEYWORD FOR ACCOUNT LEVEL               
         ZIC   R1,KYWSRTQ+1        GET SORT FIELD SIZE                          
         AHI   R1,1                ADD 1 FOR COMPANY CODE                       
         STC   R1,BUDACCLN         SAVE LENGTH OF BUDGET KEY                    
         OC    BIVVALS,BIVVALS     ANY CONTRA DATA?                             
         BZ    *+8                                                              
         OI    BUDIND,BUDCNTRA     MARK AS BY CONTRA                            
         CLI   QPROG,MANPOWER                                                   
         BNE   BUDBLD80                                                         
         TM    COLIND1,COLCNDR     USE CALENDAR PERIODS ?                       
         BZ    BUDBLD80            NO                                           
         OI    BUDIND,BUDBYPED     2 FOOTED CREATURE THAT DRINKS BUD            
*                                    OR POST BY PERIOD                          
BUDBLD80 LA    R3,COLLNQ(,R3)      NEXT COLUMN                                  
         BCT   R0,BUDBLD10         LOOP TO BUILD NEXT POSSIBLE BUDGET           
*                                                                               
         ZIC   R6,FMT#BUDS                                                      
         GOTO1 XSORT,DMCB,FMTBDGT,(R6),BUDLNQ,BUDSRTLN,0                        
         OI    FMTIND2,FMTBUDOK    TURN ON INDICATOR                            
*                                                                               
BUDBLDX  NI    FMTIND2,TURNOFF-FMTBUDON    TURN OFF INDICATOR                   
         XMOD1 1                                                                
         DROP  R2,R3,R4,R5,R7,R6                                                
         SPACE 3                                                                
         LTORG                                                                  
         TITLE 'BUILD TABLE OF NAMES'                                           
***********************************************************************         
*  Create tables of names with code/names                             *         
***********************************************************************         
         USING ACRLD,RA                                                         
         USING ACWORKD,RC                                                       
         USING NMEKEYD,R3                                                       
NAMEBLD  DS    0D                                                               
         NMOD1 0,**NMEB**                                                       
         L     RC,RLBASEC                                                       
         SR    R0,R0                                                            
         CHI   R1,KYWNMTX          Sales tax   (Payables only)                  
         BE    NMEBLD04                                                         
         CHI   R1,KYWNMD2          Media names 2                                
         BE    NMEBLD04                                                         
         CHI   R1,KYWNMD1          Media names 1                                
         BE    NMEBLD04                                                         
         BH    NMEBLD90                                                         
*&&UK*&& CHI   R1,KYWNOGP          Office group                                 
*&&UK*&& BE    NMEBLD04            (Expense, Payables, receivable only)         
                                                                                
NMEBLD02 CLI   QPROG,MANPOWER      New feature to read SJ office in 1R          
         BE    NMEBLD04                                                         
         CLC   CURSJ,QUNIT         Production only                              
         BNE   NMEBLD90                                                         
         CHI   R1,NMEOFF           Production offices                           
         BNE   *+8                                                              
         OI    BUILT,BUILTOFF                                                   
*                                                                               
NMEBLD04 L     R3,=A(NMEKEYS)                                                   
         CLI   QPROG,MANPOWER      Person Scribe ?                              
         BNE   *+8                                                              
         L     R3,=A(NMEKEY2)                                                   
*                                                                               
NMEBLD05 CLI   0(R3),EOT           End of table ?                               
         BE    NMEBLD90            NOT FOUND                                    
         CLM   R1,1,NMETYPE                                                     
         BE    NMEBLD06                                                         
         AHI   R3,NMEKEYQ          NEXT ENTRY                                   
         B     NMEBLD05                                                         
*                                                                               
NMEBLD06 SR    RE,RE                                                            
         ICM   RE,3,NMETAB                                                      
         AR    RE,RA               A(table)                                     
         TM    0(RE),X'80'         Table built already?                         
         BO    NMEBLD90            Yep                                          
*                                                                               
NMEBLD10 OI    0(RE),X'80'         Mark built                                   
         L     R6,0(,RE)           Point to table area                          
         ST    R6,SVR6             Save base of table                           
         XC    IOKEY,IOKEY                                                      
         MVC   IOKEY(L'NMEKEY),NMEKEY        SET KEY                            
         SR    RE,RE                                                            
         IC    RE,NMECPY                                                        
         LA    RE,IOKEY(RE)        POINT TO WHERE COMPANY CODE GOES             
         MVC   0(1,RE),RCCOMPFL                                                 
         L     R1,=AL4(IOHIGH+IOACFIL+IOAREA1)                                  
*                                                                               
NMEBLD20 GOTO1 AIO                                                              
         BE    *+6                 READ HIGH WAS GOOD                           
         DC    H'00'               BAD READ CHECK PARA 3 (CC)                   
         SR    RE,RE                                                            
         IC    RE,NMECODE                                                       
         LR    RF,RE                                                            
         L     R5,AIO1                                                          
         AR    RE,R5               POINT TO CODE                                
         SHI   RF,1                                                             
         EXCLC RF,IOKEY,0(R5)      PROCESSING SAME RECORD TYPE?                 
         BNE   NMEBLD62            NO, SO FINISHED                              
*                                                                               
         SR    RF,RF                                                            
         IC    RF,NMELEN           SIZE OF CODE                                 
         SHI   RF,1                                                             
         EXMVC RF,0(R6),0(RE)      MOVE CODE INTO TABLE                         
         LA    R6,1(RF,R6)         POINT TO NAME LOCATION                       
*                                                                               
         USING NAMELD,R5                                                        
         AH    R5,DATADISP         POINT TO FIRST ELEMENT                       
NMEBLD35 CLI   0(R5),0                                                          
         BE    NMEBLD60            NO NAME                                      
         CLI   NMETYPE,NMEMD1      MEDIA PRODUCTION ONLY                        
         BNE   NMEBLD36            NO                                           
         CLI   0(R5),PMDELQ        X'11' MEDIA ELEMENT                          
         BE    NMEBLD45            GET MEDIA NAME                               
*                                                                               
NMEBLD36 CLI   NMETYPE,NMEMD2      MEDIA ALL OTHER                              
         BNE   NMEBLD37            YES                                          
         CLI   0(R5),MDIELQ        X'19' MI RECORD DISP                         
         BE    NMEBLD50            GET MEDIA NAME                               
*                                                                               
NMEBLD37 CLI   0(R5),NAMELQ        X'20' NAME ELEMENT                           
         BE    NMEBLD40            FOUND NAME                                   
         IC    RF,NAMLN                                                         
         AR    R5,RF                                                            
         B     NMEBLD35                                                         
*                                                                               
NMEBLD40 IC    RF,NAMLN                                                         
         SHI   RF,(NAMLN1Q+1)                                                   
         BM    NMEBLD60            BAD DATA                                     
         EXMVC RF,0(R6),NAMEREC                                                 
         B     NMEBLD60                                                         
*                                                                               
         USING PMDELD,R5                                                        
NMEBLD45 MVC   0(L'PMDDESC,R6),PMDDESC                                          
         B     NMEBLD60                                                         
*                                                                               
         USING MDIELD,R5                                                        
NMEBLD50 MVC   0(L'MDIDESC,R6),MDIDESC                                          
*                                                                               
NMEBLD60 SR    RF,RF                                                            
         IC    RF,NMENAMEQ         NAME TABLE LENGTH                            
         AR    R6,RF               POINT TO NEXT ENTRY                          
         AHI   R0,1                COUNT THE ENTRIES                            
         CLM   R0,3,NMEMAX#                                                     
         BNH   *+6                                                              
         DC    H'00'               TIME TO MAKE TABLE BIGGER                    
*                                                                               
         L     R1,=AL4(IOSEQ+IOACFIL+IOAREA1)                                   
         B     NMEBLD20            NEXT READ                                    
         DROP  R5                                                               
*                                                                               
NMEBLD62 L     R6,SVR6             RELOAD BASE OF TABLE                         
         SHI   R6,2                POINT 2 INTO LABEL TO SAVE # ENTRIES         
         STH   R0,0(,R6)                                                        
*                                                                               
         USING TRNRECD,R2                                                       
         CLI   NMETYPE,NMEMD2      MEDIA ALL OTHER                              
         BNE   NMEBLD90                                                         
         LA    R2,IOKEY                                                         
         MVC   TRNKCPY,RCCOMPFL    COMPANY CODE                                 
         MVC   TRNKUNT(2),=C'SI'   ADD MEDIA CODES FROM SI                      
         MVI   TRNKACT,X'41'       READ FIRST ACCOUNT                           
*                                                                               
NMEBLD65 L     R1,=AL4(IOHIGH+IOACFIL+IOAREA1)                                  
         GOTO1 AIO                                                              
         L     R5,AIO1                                                          
         CLC   TRNKEY(3),0(R5)     SAME COMPANY AND U/L=SI ?                    
         BNE   NMEBLD90            THEN FINISHED                                
*        CLI   4(R5),C' '          LOOKING FOR SYSTEM/MEDIA                     
*        BNH   NMEBLD75                                                         
         CLC   4(11,R5),SPACES                                                  
         BE    NMEBLD68                                                         
         CLC   5(10,R5),SPACES                                                  
         BNE   NMEBLD75            TRY ANOTHER ACCOUNT                          
*                                                                               
NMEBLD68 LR    R4,R5                                                            
         AH    R4,DATADISP                                                      
         SR    R1,R1                                                            
*                                                                               
NMEBLD70 CLI   0(R4),0             EOR                                          
         BE    NMEBLD75                                                         
         CLI   0(R4),NAMELQ        X'20' Element                                
         BE    NMEBLD72                                                         
         IC    R1,1(,R4)                                                        
         AR    R4,R1                                                            
         B     NMEBLD70                                                         
*                                                                               
         USING NAMELD,R4                                                        
NMEBLD72 MVC   WORK,SPACES                                                      
         MVC   WORK(2),3(R5)       Move in code                                 
         IC    R1,NAMLN                                                         
         SHI   R1,NAMLN1Q                                                       
         CLM   R1,1,NMENAMEQ       Use smaller of two                           
         BNH   *+8                                                              
         IC    R1,NMENAMEQ         Use max length of data                       
         LR    RF,R1                                                            
         SHI   R1,1                                                             
         BM    NMEBLD75            No name on record                            
         EXMVC R1,WORK+2,NAMEREC                                                
         DROP  R4                                                               
*                                                                               
         SR    RF,RF                                                            
         IC    RF,NMELEN           Length of key                                
         SR    R5,R5                                                            
         IC    R5,NMENAMEQ         Length of data                               
         AR    R5,RF               Length of record                             
         SR    R7,R7                                                            
         ICM   R7,3,NMEMAX#                                                     
         GOTO1 BINSRCH,DMCB,(1,WORK),SVR6,(R0),(R5),(0,(RF)),(R7)               
         OC    0(4,R1),0(R1)                                                    
         BNZ   *+6                                                              
         DC    H'00'               Table full                                   
         TM    0(R1),X'01'         Record not found ?                           
         BZ    NMEBLD75            Found                                        
         AHI   R0,1                Not found                                    
         L     RF,SVR6                                                          
         SHI   RF,2                                                             
         STH   R0,0(,RF)           Save new number of entries                   
*                                                                               
NMEBLD75 L     R5,AIO1                                                          
         MVC   TRNKEY,0(R5)                                                     
         MVI   TRNKACT+2,X'FF'                                                  
         B     NMEBLD65                                                         
*                                                                               
NMEBLD90 XMOD1 1                                                                
         DROP  R2,R3                                                            
         SPACE  2                                                               
         LTORG                                                                  
         SPACE  2                                                               
NMEKEYS  DC    AL2(OFGBASE-ACRLD),AL1(NMEOGP,2,5,1,36),X'2C0200',C'SJ'          
         DC    AL2(MAXOFG)                                                      
         DC    AL2(OFFBASE-ACRLD),AL1(NMEOFF,2,5,2,36),X'2C0400',C'SJ'          
         DC    AL2(MAXOFF)                                                      
         DC    AL2(MGPBASE-ACRLD),AL1(NMEMGP,2,5,1,36),X'2C0600',C'SJ'          
         DC    AL2(MAXMGP)                                                      
         DC    AL2(WGPBASE-ACRLD),AL1(NMEWGP,2,5,1,36),X'2C0800',C'SJ'          
         DC    AL2(MAXWGP)                                                      
         DC    AL2(MD1BASE-ACRLD),AL1(NMEMD1,1,2,1,12),X'0900000000'            
         DC    AL2(MAXMD1)                                                      
         DC    AL2(MD2BASE-ACRLD),AL1(NMEMD2,1,2,2,12),X'0800000000'            
         DC    AL2(MAXMD2)                                                      
         DC    AL2(SALETAX-ACRLD),AL1(NMETAX,2,3,8,36),X'2D01000000'            
         DC    AL2(MAXTAX)                                                      
         DC    AL1(EOT)                                                         
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *         
* Note : OFGBASE is for a length of 38*MAXOFF (38*200). This means    *         
*                other tables are being overlayed.                    *         
*                *MGPTAB*,*WGPTAB*,*MD1TAB*,*MD2TAB*                  *         
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *         
         SPACE 1                                                                
NMEKEY2  DC    AL2(OFGBASE-ACRLD),AL1(NMEOFF,2,5,2,36),X'2C0400',C'SJ'          
         DC    AL2(MAXOFF)                                                      
         DC    AL1(EOT)                                                         
                                                                                
         TITLE 'Build tables stored in data set'                                
***********************************************************************         
*  Build bin tabs of tables stored in Data set                        *         
***********************************************************************         
         SPACE 1                                                                
         USING ACMD,RF                                                          
         USING ACRLD,RA                                                         
         USING ACWORKD,RC                                                       
DSNTABS  NTR1  BASE=*,LABEL=*                                                   
         L     RF,AMONACC                                                       
         MVC   DSNALPHA,ACMPFAGY   ALPHA AGENCY                                 
         CLI   DSNALPHA,C'*'       Not valid qualifier                          
         BNE   *+8                                                              
         MVI   DSNALPHA,C'#'       Replace with #                               
                                                                                
         CLC   =C'DJCTEST',QUESTOR                                              
         BNE   DSNTAB01                                                         
         MVC   DSNTABNM,SPACES     USE THIS FOR TESTING                         
         MVC   DSNTABNM(18),=C'ACCTEAM.DDS.A  TAB'                              
         MVC   DSNTABNM+13(2),ACMPFAGY                                          
         DROP  RF                                                               
*                                                                               
DSNTAB01 GOTOR DYNALLOC,DMCB,(X'FF',=CL8'DDNTAB'),(0,DSNTABNM)                  
DSNTAB03 LA    R3,DCBTAB                                                        
         OPEN  (DCBTAB,(INPUT))                                                 
                                                                                
         USING SCANBLKD,R3                                                      
         USING SUBTABD,R4                                                       
         USING UTABD,R5                                                         
         L     R4,@SUBTAB          Subsitute table                              
         L     R5,ACONTAB          Address to store info                        
         SR    R9,R9                                                            
                                                                                
DSNTAB10 L     R2,AIO1                                                          
         AHI   R2,4                Dummy up for Scanner bug                     
         MVC   0(L'SPACES,R2),SPACES                                            
         GET   DCBTAB,(R2)                                                      
                                                                                
         SHI   R2,4                Reclaim first for bytes                      
         L     R3,ABLOCK                                                        
         LA    RF,SCXTRALQ                                                      
         GOTOR =V(SCANNER),DMCB,((RF),(R2)),(3,(R3)),C',=,`'                    
         MVC   NPRAMS,4(R1)                                                     
         CLI   NPRAMS,0            # of parameters                              
         BE    DSNTAB10            Get next                                     
                                                                                
***********************************************************************         
* Process table and label of table                                              
***********************************************************************         
DSNTAB12 CLC   =C'XXXTABLEXXX',SCONEFLD                                         
         BNE   DSNTAB20                                                         
         AHI   R3,SCLNQ1           Next entry                                   
         LTR   R9,R9               R9 = # of entries, we processed one          
         BZ    DSNTAB14            No                                           
         STC   R9,UTAB#OF          Save number of entries                       
         SR    R9,R9                                                            
         LR    RF,R7                                                            
         SR    RF,R5               Find total length of table                   
         ST    RF,UTABLEN                                                       
         LR    R5,R7               Set to new location                          
         AHI   R4,SUBTLNQ          Point for next entry                         
         XC    SUBDATA,SUBDATA     Mark end of tables                           
                                                                                
DSNTAB14 MVC   SUBLABEL,SCONEFLD   Name of table                                
         ST    R5,SUBDATA          A(Data)                                      
         MVI   SUBMAXL,0           Set to zero                                  
                                                                                
DSNTAB16 LA    R6,UTABDHDR         Data header                                  
         B     DSNTAB10            Next record                                  
                                                                                
***********************************************************************         
* Process FROM code                                                             
***********************************************************************         
         USING UTABDHDR,R6                                                      
DSNTAB20 DS    0H                                                               
         XC    UTABDHDR,UTABDHDR                                                
         CLI   NPRAMS,2                                                         
         BNL   *+6                                                              
         DC    H'00'               Error                                        
         BE    *+8                                                              
         OI    UTABDIND,UTABINME   Name included                                
                                                                                
         LA    R7,UTABDLEN         Point to from value area                     
         USING UTABDLEN,R7                                                      
                                                                                
         MVI   UTABCC,BE           Set all to equal for now                     
         MVI   UTABTYPE,UTABXTRN                                                
         MVC   UTABDLEN,SC1STLEN                                                
         SR    R1,R1                                                            
         ICM   R1,1,SC1STLEN       Length                                       
         BNZ   *+6                                                              
         DC    H'00'               Need at least code                           
                                                                                
         BCTR  R1,0                                                             
         EXMVC R1,UTABDATA,SCONEFLD                                             
***********************************************************************         
* Process TO   code                                                             
***********************************************************************         
         LA    R7,2(R1,R7)         Point to TO value area                       
         AHI   R3,SCLNQ1                                                        
         SR    R1,R1                                                            
         ICM   R1,1,SC1STLEN                                                    
*        BZ    DSNTABxx            No convertion just name ?                    
         BNZ   *+6                                                              
         DC    H'00'               Die for now                                  
                                                                                
         CLI   NPRAMS,2                                                         
         BH    DSNTAB26                                                         
         LA    RE,SCONEFLD-1(R1)   Point to end of data                         
DSNTAB22 CLI   0(RE),C' '          Is it a space?                               
         BH    DSNTAB24            No                                           
         BCTR  RE,0                                                             
         BCT   R1,DSNTAB22         Decrement length by one                      
         DC    H'00'                                                            
                                                                                
DSNTAB24 STC   R1,SC1STLEN         Real length                                  
*                                                                               
DSNTAB26 MVC   UTABDLEN,SC1STLEN                                                
         CLC   UTABDLEN,SUBMAXL                                                 
         BL    *+10                                                             
         MVC   SUBMAXL,UTABDLEN                                                 
         BCTR  R1,0                                                             
         EXMVC R1,UTABDATA,SCONEFLD                                             
         LA    R7,2(R1,R7)         Point to To name value area                  
         MVI   UTABDLEN,EOT        Mark end                                     
                                                                                
***********************************************************************         
* Process TO   name                                                             
***********************************************************************         
         AHI   R3,SCLNQ1                                                        
         CLI   NPRAMS,2                                                         
         BE    DSNTAB30            Done for this part                           
         MVC   UTABDLEN,SC1STLEN   Must have a name                             
         CLI   UTABDLEN,SCXTRALQ+L'SC1STFLD                                     
         BNH   *+6                                                              
         DC    H'00'               Max length for now is 36                     
                                                                                
         SR    R1,R1                                                            
         ICM   R1,1,SC1STLEN                                                    
         BCTR  R1,0                                                             
         EXMVC R1,UTABDATA,SCONEFLD                                             
         AHI   R3,SCLNQ1                                                        
         LA    R7,2(R1,R7)         Point to To name value area                  
         MVI   UTABDLEN,EOT        Mark end                                     
                                                                                
DSNTAB30 AHI   R7,1                                                             
         MVI   0(R7),EOT           Mark end                                     
         LR    RF,R7                                                            
         SR    RF,R6               Start of data header                         
         STC   RF,UTABTLEN         Total length of data                         
         LR    R6,R7               R6 = new data header                         
         AHI   R9,1                # of entries                                 
         B     DSNTAB10                                                         
                                                                                
                                                                                
DSNTAB80 LTR   R9,R9                                                            
         BZ    DSNTAB90                                                         
         AHI   R4,SUBTLNQ          Point for next entry                         
         XC    SUBDATA,SUBDATA     Mark end of tables                           
         STC   R9,UTAB#OF                                                       
         LR    RF,R7                                                            
         SR    RF,R5               Find total length of table                   
         ST    RF,UTABLEN                                                       
         ST    R7,ACONTAB          Set to new location                          
                                                                                
DSNTAB90 DS    0H                                                               
         TM    TABIND,TABXTRN                                                   
         BZ    DSNTAB95                                                         
         CLOSE (DCBTAB)                                                         
                                                                                
DSNTAB95 XIT1                                                                   
         DROP  R4                                                               
         LTORG                                                                  
                                                                                
SCXTRALQ EQU   26                                                               
SCLNQ1   EQU   (SC2NDFLD-SCANBLKD)+SCXTRALQ                                     
                                                                                
DSNTABNM DC    CL30'ACC.SCRIBE.A  TAB'                                          
         ORG   DSNTABNM                                                         
DSNTABX  DC    CL10'ACC.SCRIBE'                                                 
         DC    C'.A'                                                            
DSNALPHA DS    CL2' '                                                           
         DC    C'TAB'                                                           
*                                                                               
         ORG                                                                    
                                                                                
DCBTAB   DCB   DSORG=PS,                                               +        
               RECFM=VBA,                                              +        
               MACRF=GM,                                               +        
               BLKSIZE=27998,                                          +        
               LRECL=204,                                              +        
               DDNAME=DDNTAB,                                          +        
               EODAD=DSNTAB80                                                   
                                                                                
         TITLE 'BUILD TABLE OF OFFICE CODES/NAMES'                              
***********************************************************************         
*  CREATE TABLE 2D OFFICE TABLE WITH CODE/NAME                        *         
***********************************************************************         
         SPACE 1                                                                
         USING ACRLD,RA                                                         
         USING ACWORKD,RC                                                       
         USING ACTRECD,R3                                                       
OFBUILD  DS    0D                                                               
         NMOD1 0,**OFBD**                                                       
         L     RC,RLBASEC                                                       
         SR    R5,R5                                                            
         CLC   CURSJ,QUNIT         IS IT PRODUCTION?                            
         BE    OFBLD99             YES SO GET OUT                               
*                                                                               
         USING ACMD,R2                                                          
         L     R2,AMONACC                                                       
         ICM   R5,15,ACMNOFNB      NUMBER OF OFFICES                            
         BZ    OFBLD05                                                          
         MVC   OFFBASE,ACMAOFNB    BUFFER OF OFFICE NAMES                       
         OI    OFFBASE,X'80'                                                    
         B     OFBLD90                                                          
         DROP  R2                                                               
*                                                                               
OFBLD05  L     R6,OFFBASE          A(OFFICE TABLE)                              
         MVC   CUROFF,SPACES                                                    
*                                                                               
OFBLD10  L     R3,AIO1                                                          
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,RCCOMPFL                                                 
         MVI   ACTKUNT,C'2'                                                     
         MVI   ACTKLDG,C'D'                                                     
         MVC   ACTKACT(1),CUROFF        POINT AT ACCOUNT 1 BYTE OFFICE          
         MVI   ACTKACT+1,X'FF'          READ PAST OFFICE                        
         CLI   NEWOFF,NO                1 OR 2 BYTE OFFICE                      
         BE    BLDOF15                                                          
         MVC   ACTKACT(2),CUROFF        POINT AT ACCOUNT 2 BYTE OFFICE          
         MVI   ACTKACT+2,X'FF'          READ PAST OFFICE                        
BLDOF15  MVC   IOKEY,ACTKEY                                                     
         L     R1,=AL4(IOHIGH+IOACFIL+IOAREA1)                                  
         GOTO1 AIO                                                              
         BE    *+6                 READ HIGH WAS GOOD                           
         DC    H'00'               BAD READ CHECK PARA 3 (CC)                   
                                                                                
         CLC   ACTKUNT(2),=CL2'2D' END OF 2D OFFICES ?                          
         BNE   OFBLD90             YES GET OUT                                  
         AHI   R5,1                ANOTHER OFFICE,BUMP UP COUNT                 
         CHI   R5,OFMAXQ                                                        
         BNH   *+6                                                              
         DC    H'00'               TABLE TOO SMALL                              
                                                                                
         MVC   0(38,R6),SPACES                                                  
         MVC   CUROFF(1),ACTKACT       ONE BYTE OFFICE                          
         CLI   NEWOFF,NO                                                        
         BE    *+10                                                             
         MVC   CUROFF,ACTKACT     TWO BYTE OFFICE                               
         MVC   0(2,R6),CUROFF                                                   
         LR    R2,R3                                                            
         AH    R2,DATADISP                                                      
         SR    R1,R1                                                            
OFBLD25  IC    R1,1(,R2)          GET ELEMENT LENGTH                            
         CLI   0(R2),0            END OF RECORD?                                
         BE    OFBLD40                                                          
         CLI   0(R2),NAMELQ       GET NAME X'20'                                
         BE    OFBLD30                                                          
         AR    R2,R1                                                            
         B     OFBLD25                                                          
*                                                                               
OFBLD30  SHI   R1,3                                                             
         EXMVC R1,2(R6),2(R2)                                                   
OFBLD40  LA    R6,38(,R6)          BUMP UP TO NEXT ENTRY LOCATION               
         B     OFBLD10                                                          
*                                                                               
OFBLD90  L     R6,OFFBASE          A(OFFICE TABLE)                              
         SHI   R6,2                SAVE NUMBER OF ENTRIES IN LABLE              
         STH   R5,0(,R6)           NUMBER OF OFFICES                            
OFBLD99  XMOD1 1                                                                
         SPACE 3                                                                
         LTORG                                                                  
         DROP  R3                                                               
         TITLE 'BUILD PAYCODE/NAME TABLE FROM RECORDS'                          
***********************************************************************         
*  KEY = PAYNUM(1), DATA = PAYCODE(5), PAYNAME(15)                    *         
***********************************************************************         
         SPACE 1                                                                
         USING ACRLD,RA                                                         
         USING ACWORKD,RC                                                       
         USING PAYRECD,R2                                                       
PAYTAB   DS    0D                                                               
         NMOD1 0,**PAYT**                                                       
         L     RC,RLBASEC                                                       
         SR    R0,R0                                                            
         LA    R2,IOKEY                                                         
         L     R3,PYCBASE                                                       
         LR    R6,R3               USE 2 BYTES OF LABEL TO KEEP NUMBER          
         AHI   R6,-2                   OF ENTIRES IN TABLE                      
         MVC   PAYKEY,SPACES                                                    
         MVI   PAYKTYP,PAYKTYPQ    X'3E'                                        
         MVI   PAYKSUB,PAYKSUBQ    X'03' PAYROLL CODES                          
         MVC   PAYKCPY,RCCOMPFL    COMPANY                                      
         MVI   PAYKSEQ,0           SEQUENCE                                     
         L     R1,=AL4(IOHIGH+IOACFIL+IOAREA1)                                  
         MVC   WORK(3),IOKEY                                                    
*                                                                               
         USING PYRD,R3             PAYROLL TABLE ENTRY                          
         USING PAYELD,R4                                                        
PAYTAB10 GOTO1 AIO                                                              
         L     R4,AIO1                                                          
         CLC   WORK(3),0(R4)                                                    
         BNE   PAYTABX             FINISHED                                     
         AH    R4,DATADISP                                                      
PAYTAB15 CLI   0(R4),0             END OF RECORD                                
         BE    PAYTAB30            NEXT RECORD                                  
         CLI   0(R4),PAYELQ        X'84' PAYROLL CODE ELEMENT                   
         BNE   PAYTAB20                                                         
         MVC   PYRNUM,PAYNUM       PAYNUM  (KEY)                                
         MVC   PYRCODE,PAYCODE     PAYCODE (DATA)                               
         MVC   PYRNAME,PAYDESC     PAYNAME (DATA)                               
         AHI   R0,1                                                             
         LA    R3,PYRENLNQ(,R3)    NEXT ENTRY                                   
PAYTAB20 SR    RF,RF                                                            
         IC    RF,1(,R4)                                                        
         AR    R4,RF                                                            
         B     PAYTAB15                                                         
*                                                                               
PAYTAB30 L     R1,=AL4(IOSEQ+IOACFIL+IOAREA1)                                   
         B     PAYTAB10                                                         
*                                                                               
PAYTABX  STH   R0,0(,R6)           NUMBER OF PAYCODES IN TABLE                  
         XMOD1 1                                                                
         SPACE 1                                                                
         LTORG                                                                  
         TITLE 'BUILD STUDIO NAME TABLE FROM RECORDS'                           
***********************************************************************         
*  KEY = STUDIO CODE(2), DATA = STUDIO NAME(36)                       *         
***********************************************************************         
         SPACE 1                                                                
         USING ACRLD,RA                                                         
         USING ACWORKD,RC                                                       
         USING STURECD,R4                                                       
STUDBLD  DS    0D                                                               
         NMOD1 0,**STUD**                                                       
         L     RC,RLBASEC                                                       
         L     R3,STUBASE                                                       
         LA    R4,IOKEY            LOAD IO AREA                                 
         SR    R5,R5                                                            
         MVI   0(R3),EOT           MARK END OF TABLE                            
         MVC   STUKEY,SPACES                                                    
         MVI   STUKTYP,STUKTYPQ    X'2C'                                        
         MVI   STUKSUB,STUKSUBQ    X'23'                                        
         MVC   STUKCPY,RCCOMPFL    COMPANY                                      
         L     R1,=AL4(IOHIGH+IOACFIL+IOAREA1)                                  
*                                                                               
STUD10   GOTO1 AIO                                                              
         BE    *+6                                                              
         DC    H'00'                                                            
         L     R4,AIO1                                                          
         CLI   STUKTYP,STUKTYPQ    IS IT STUDIO RECORD?                         
         BNE   STUDX               NO SO FINISHED                               
         CLI   STUKSUB,STUKSUBQ                                                 
         BNE   STUDX                                                            
         CLC   STUKCPY,RCCOMPFL    SAME COMPANY?                                
         BNE   STUDX                                                            
*                                                                               
         USING NAMELD,R2                                                        
         LR    R2,R4                                                            
         AH    R2,DATADISP                                                      
STUD20   CLI   0(R2),0             END OF RECORD                                
         BE    STUD30                                                           
         CLI   NAMEL,NAMELQ                                                     
         BE    STUD25                                                           
         SR    RF,RF                                                            
         IC    RF,NAMLN            GET NEXT ELEMENT                             
         AR    R2,RF                                                            
         B     STUD20                                                           
*                                                                               
STUD25   MVC   0(40,R3),SPACES     CLEAR                                        
         MVC   0(4,R3),STUKCODE    SAVE OFF CODE                                
         IC    RF,NAMLN                                                         
         AHI   RF,-(NAMLN1Q+1)                                                  
         BM    STUD28                                                           
         EXMVC RF,4(R3),NAMEREC                                                 
*                                                                               
STUD28   LA    R3,40(R3)           BUMP TO NEXT ENTRY                           
         CH    R5,=Y(STMAXQ)                                                    
         BL    *+6                                                              
         DC    H'00'                                                            
         MVI   0(R3),EOT           MARK END OF TABLE                            
         AHI   R5,1                                                             
*                                                                               
STUD30   L     R1,=AL4(IOSEQ+IOACFIL+IOAREA1)                                   
         B     STUD10                                                           
*                                                                               
STUDX    XMOD1 1                                                                
         DROP  R2,R4                                                            
         SPACE 3                                                                
         LTORG                                                                  
         TITLE 'BUILD TABLE OF AGENCY OF RECORD'                                
*&&US                                                                           
***********************************************************************         
*              CREATE TABLE OF AGENCY OF RECORD                       *         
*              KEY  = SYS,MEDIA,CLI,PRD,EST                           *         
*              DATA = AGENCY CODE (OF RECORD)                         *         
***********************************************************************         
         SPACE 1                                                                
         USING ACRLD,RA                                                         
         USING ACWORKD,RC                                                       
         USING BRANDD,R6                                                        
BRNBUILD DS    0D                                                               
         NMOD1 0,**BRND**                                                       
         L     RC,RLBASEC                                                       
         LA    R6,BRANDBUF         LOAD BUFFER ADDRESS                          
*                                                                               
         L     R3,BRNDDCB                                                       
         OPEN  ((R3),INPUT)                                                     
BRNBLD10 GET   (R3),(R6)                                                        
         CLI   BRANDAOR+1,C' '     RIGHT JUSTIFIED?                             
         BH    BRNBLD15                                                         
         MVC   BRANDAOR+1(1),BRANDAOR                                           
         MVI   BRANDAOR,C'0'                                                    
*                                                                               
BRNBLD15 LA    R1,0                                                             
         L     R5,BNMBASE          TABLE OF NAMES                               
         MVI   BRANDNME,0          CLEAR OUT INDEX                              
         CLC   =CL2'NN',BRANDSYS   NET                                          
         BNE   BRNBLD20                                                         
         MVC   BRANDSYS,=C'SN'     NET ON ACC                                   
*                                                                               
BRNBLD20 CLI   0(R5),EOT           END OF TABLE?                                
         BE    BRNBLD30            NONE MATCHED                                 
         CLC   BRANDAOR,0(R5)      COMPARE AGENCY CODE TO GET NAME              
         BE    BRNBLD25            FOUND MATCH                                  
         LA    R1,1(R1)            BUMP UP COUNT                                
         LA    R5,BRNDNMQ(R5)      BUMP UP                                      
         B     BRNBLD20                                                         
*                                                                               
BRNBLD25 STC   R1,BRANDNME                                                      
BRNBLD30 GOTO1 BINSRCH,DMCB,(1,BRANDBUF),BRNBASE,NBRNREC,A(BRANDLNQ),  X        
               (0,L'BRANDKEY),A(MAXBRANQ)                                       
         OC    DMCB(4),DMCB                                                     
         BNZ   *+6                                                              
         DC    H'0'                TABLE FULL                                   
         TM    DMCB,X'01'          WAS IT NOT FOUND?                            
         BZ    BRNBLD10            LOOP ALREADY IN TABLE                        
         LA    R1,1                BUMP UP COUNT                                
         A     R1,NBRNREC                                                       
         ST    R1,NBRNREC                                                       
         B     BRNBLD10                                                         
BRNBLD99 BAS   RE,FIXTABS                                                       
         L     R3,BRNDDCB                                                       
         CLOSE ((R3))                                                           
         XMOD1 1                                                                
         SPACE 1                                                                
OLD      USING BRANDD,R2                                                        
FIXTABS  NTR1                                                                   
         LA    R3,FIXENTRY                                                      
         LA    R6,BRANDBUF                                                      
FIXTAB10 MVC   SVAOR,0(R3)                                                      
         LA    R3,L'BRANDAOR(R3)                                                
         MVC   BRANDKEY,0(R3)                                                   
         LA    R3,L'BRANDKEY-L'BRANDEST(R3)                                     
FIXTAB15 GOTO1 BINSRCH,DMCB,(2,BRANDBUF),BRNBASE,NBRNREC,A(BRANDLNQ),  X        
               (0,L'BRANDKEY),A(MAXBRANQ)                                       
         L     R2,DMCB                                                          
         CLC   BRANDKEY,OLD.BRANDKEY                                            
         BNE   FIXTAB30                                                         
         MVC   OLD.BRANDAOR,SVAOR                                               
*                                                                               
         LA    R1,0                                                             
         L     R5,BNMBASE          TABLE OF NAMES                               
         MVI   OLD.BRANDNME,0      CLEAR OUT INDEX                              
FIXTAB20 CLI   0(R5),EOT           END OF TABLE?                                
         BE    FIXTAB30                                                         
         CLC   OLD.BRANDAOR,0(R5)  MATCH ON AOR NUMBER                          
         BE    FIXTAB25                                                         
         LA    R1,1(R1)            BUMP UP INDEX                                
         LA    R5,BRNDNMQ(R5)      BUMP TO NEXT NAME                            
         B     FIXTAB20                                                         
*                                                                               
FIXTAB25 STC   R1,OLD.BRANDNME     SAVE OFF INDEX                               
FIXTAB30 LA    R3,L'BRANDEST(R3)                                                
         CLC   0(3,R3),=C'XXX'     END OF ESTIMATES                             
         BE    FIXTAB50                                                         
         MVC   BRANDEST,0(R3)      MOVE IN NEW EST                              
         B     FIXTAB15                                                         
*                                                                               
FIXTAB50 LA    R3,3(R3)            LENGTH OF END MARKER                         
         CLI   0(R3),EOT           END OF ALL                                   
         BNE   FIXTAB10                                                         
         XIT1                                                                   
         SPACE 1                                                                
SVAOR    DS    CL3                                                              
FIXENTRY DC    C'05 SNMI4LI 010020030040050XXX'                                 
         DC    C'05 SRMR4LI 003004XXX'                                          
         DC    C'05 PNIM4LI 601XXX'                                             
         DC    C'05 POIM4LI 621622XXX'                                          
         DC    C'05 POMR4LI 036XXX'                                             
         DC    C'04 POMR4SH 008XXX'                                             
         DC    C'11 SRMR4MRV010XXX'                                             
         DC    AL1(EOT)                                                         
         DROP  OLD,R6                                                           
         SPACE 2                                                                
         LTORG                                                                  
*&&                                                                             
         SPACE 2                                                                
FMTTAB   DC    (MAXFMTS)XL(RCPLNQ)'00'                                          
         DC    AL1(EOT)                                                         
         SPACE 2                                                                
*&&US                                                                           
BRNDWRK  DCB   DSORG=PS,                                               X        
               RECFM=FB,                                               X        
               MACRF=GM,                                               X        
               BLKSIZE=8000,                                           X        
               LRECL=16,                                               X        
               DDNAME=BRNDWRK,                                         X        
               EODAD=BRNBLD99                                                   
*&&                                                                             
         TITLE 'BUILD MULTIPLE LIST TO FILTER ON'                               
***********************************************************************         
*  ADD FILTER   A) +/- LIST RECORD TO BLOCK                           *         
*               B) BUILD FILTER STRING FROM AN ACCOUNT OR SCAN BLOCK  *         
*              INPUT  P1 = AL1 L'LENGTH OF FIELD PASSING              *         
*                        = AL3(DATA)          +/- LIST OR AN ACCOUNT  *         
*                          OR                                                   
*                        = AL1(NUMBER OF PARAMETERS IN SCANNER)       *         
*                        = AL3(SCAN BLOCK)    IF P3 = C'SCAN'         *         
*                          OR                                         *         
*                        = AL3(DDLINK AREA)   IF P3 = C'DLNK'         *         
*                     P2 = AL1 X'80', IF CALLED FROM CFILTER                    
*                        = ADDRESS OF UNIT/LEDGER                     *         
*                        = ADDRESS OF C'UL' IF UL IS INCLUDED IN ACCT *         
*                        = ADDRESS OF C'BS' If SR billing source      *         
*                        = ADDRESS OF C'  ' OR ZERO IF NO UL INVOLVED *         
*                        = AL3(SCANNER BLOCK)                         *         
*                     P3 = C'SCAN' IF USING SCANNER BLOCK ELSE ZERO   *         
*                        = C'DLNK' IF USING DDLINK  BLOCK ELSE ZERO   *         
*              OUTPUT P1 = XL1'80', +/- LIST RECORD                   *         
*                          XL1'20', ACCOUNT(S) TO FILTER              *         
*                          XL1'10', EXCLUDE FILTER                    *         
*                          XL1'08', UNIT LEDGER NOT INCLUDED          *         
*                          XL1'04', WILD CARD USED                    *         
*                        = AL3(LIST   RECORD) IF X'80', +/- LIST      *         
*                        = AL3(FILTER RECORD) IF X'20', ACCOUNT(S)    *         
*              OUTPUT P2 = A(END OF RECORD)                           *         
***********************************************************************         
         EJECT                                                                  
         USING ACWORKD,RC                                                       
         USING ACRLD,RA                                                         
LISTBLD  DS    0D                                                               
         NMOD1 0,**LIST**                                                       
         L     RC,RLBASEC                                                       
         LR    R6,R1               SAVE PARAMETER ADDRESS                       
         MVI   BYTE1,0             INITIALIZE                                   
         MVC   WORK,SPACES                                                      
         XC    FULL,FULL                                                        
         L     R5,0(,R6)           POINT TO INPUT                               
         LA    R5,0(,R5)           CLEAR HOB                                    
         L     R3,4(,R6)           PARM 2 = POSSIBLE A(UNIT/LEDGER)             
         LA    R3,0(,R3)           CLEAR HOB                                    
         MVI   LSTMODE,LSTMDLNK                                                 
         CLC   8(4,R6),=C'DLNK'    DDLINK block                                 
         BE    LSTBLD50                                                         
         MVI   LSTMODE,0                                                        
         CLC   8(4,R6),=C'SCAN'    Did we pass scanner block?                   
         BNE   LSTBLD02            YES, SO CHECK IT OUT                         
         MVI   LSTMODE,LSTMSCAN                                                 
         TM    4(R6),X'80'         Called from CFILTER?                         
         BZ    *+8                                                              
         OI    LSTMODE,LSTMCFLT                                                 
         CLI   0(R6),1             Only one entry in block ?                    
         BH    LSTBLD50            No, so go process                            
         MVC   0(1,R6),0(R5)       Set length of data                           
         LA    R5,12(,R5)          Treat as if it was not scan block            
*                                                                               
LSTBLD02 MVI   BYTE2,LSTKUINC      ASSUME +LIST                                 
         CLI   0(R5),C'+'          INCLUDE LIST?                                
         BE    LSTBLD05                                                         
         OI    BYTE1,FLTEXCL       Exclude                                      
         MVI   BYTE2,LSTKUEXC      SET  -LIST                                   
         CLI   0(R5),C'-'          EXCLUDE LIST?                                
         BE    LSTBLD05                                                         
         NI    BYTE1,TURNOFF-FLTEXCL                                            
         MVI   BYTE2,0             Not a list                                   
*                                                                               
*  Mimic a Scan block entry                                                     
*                                                                               
         SR    RF,RF               NOT A LIST, SO MUST BE DATA OR ACCT          
         ICM   RF,1,0(R6)          LENGTH OF INPUT AREA                         
         BZ    LSTBLDNO            HUM NO LENGTH SUPPLIED (ERROR)               
         BCTR  RF,0                                                             
         EXCLC RF,0(R5),SPACES     ANY DATA?                                    
         BNH   LSTBLDNO            NO DATA SO OUT                               
         MVC   SCANWORK,SPACES     INITIALIZE                                   
         XC    SCANWORK(12),SCANWORK                                            
         EXMVC RF,SCANWORK+12,0(R5)                                             
         MVI   0(R6),1             SET TO SINGLE ENTRY                          
         LA    R5,SCANWORK         RESET TO NEW AREA                            
         LA    RE,12(RF,R5)        POINT TO END OF DATA - 1                     
         LA    RF,1(,RF)           ADD ONE BACK TO LENGTH                       
*                                                                               
         CLI   0(RE),C' '          FIND NON SPACE                               
         BH    *+10                                                             
         BCTR  RE,0                                                             
         BCT   RF,*-10                                                          
         STC   RF,SCANWORK         SAVE LENGTH                                  
         B     LSTBLD50                                                         
*                                                                               
         USING LSTRECD,R4                                                       
LSTBLD05 OI    LSTMODE,LSTMLIST                                                 
         L     R4,ALISTREC         SEE IF ALREADY HAVE                          
         OI    BYTE1,FLTLIST       X'80' SET TO (+,-) TYPE LIST                 
         SR    R1,R1               LENGTH USED SO FAR IN ALISTREC               
         SR    R7,R7                                                            
         ICM   R7,1,LISTREC#       NUMBER OF LIST RECORDS SAVE OFF              
         BZ    LSTBLD15            NONE SO FAR                                  
*                                                                               
LSTBLD10 CLC   LSTKLST,1(R5)       MATCH LIST RECORD ?                          
         BNE   LSTBLD12            NO,   CONTINUE                               
         CLC   LSTKUSE,BYTE2       SAME  USAGE ?                                
         BE    LSTBLD32            YES,  MATCH FOUND                            
*                                                                               
LSTBLD12 SR    RF,RF                                                            
         ICM   RF,3,LSTRLEN        RECORD LENGTH                                
         AR    R1,RF               TOTAL SIZE  USED                             
         ST    R1,FULL             SAVE  TOTAL USED                             
         AR    R4,RF               END OF THIS RECORD                           
         BCT   R7,LSTBLD10         DROP THROUGH IF NOT FOUND                    
*                                                                               
LSTBLD15 GOTO1 ACLIST,DMCB,(C'R',AIO3),(RCCOMPFL,(R5)),DATAMGR                  
         OC    DMCB(4),DMCB                                                     
         BNZ   LSTBLD18            Ok, added list                               
         MVI   ERROR#,17           Error 17                                     
         MVC   TEMPAREA(7),0(R5)   Bad list code                                
         B     LSTBLDNO            Not found                                    
*                                                                               
LSTBLD18 IC    R7,LISTREC#         OLD NUMBER OF RECORDS                        
         AHI   R7,1                PLUS 1                                       
         STC   R7,LISTREC#         NEW NUMBER OF RECORDS                        
*                                                                               
         LR    R3,R4               SAVE OFF R4                                  
         L     R4,AIO3             MOVE REC FROM AIO3 TO STORAGE AREA           
         SR    RF,RF                                                            
         ICM   RF,3,LSTRLEN        RECORD LENGTH                                
         A     RF,FULL                                                          
         C     RF,=A(LSTBLKQ)      MAX STORAGE AREA                             
         BNH   *+6                                                              
         DC    H'00'               TOO BIG (NEED TO INCREASE AREA)              
*                                                                               
         L     RE,AIO3             MOVE REC FROM AIO3 TO R0=A(STORAGE)          
         LR    R0,R3                                                            
         SR    RF,RF                                                            
         ICM   RF,3,LSTRLEN        RECORD LENGTH                                
         LR    R1,RF               SAME LENGTH                                  
         MVCL  R0,RE               SAVE OFF RECORD                              
*                                                                               
         USING LIDELD,R2                                                        
         LR    R4,R3               RELOAD R4 = A(STORAGE WITH LIST REC)         
         MVC   LSTKUSE,BYTE2       SAVE INCLUDE/EXCLUDE LIST INDICATOR          
*                                                                               
LSTBLD32 SR    R0,R0                                                            
         LA    R2,LSTRFST          POINT TO FIRST ELEMENT                       
*                                                                               
LSTBLD35 CLI   LIDEL,0             END OF RECORD?                               
         BE    LSTBLDNO                                                         
         CLI   LIDEL,LIDELQ        X'1F' ELEMENT                                
         BE    LSTBLD40                                                         
         IC    R0,LIDLN            ELEMENT LENGTH                               
         AR    R2,R0               BUMP UP IN RECORD                            
         B     LSTBLD35                                                         
*                                                                               
LSTBLD40 ST    R4,0(,R6)           PARM1 = A(SAVED LIST RECORD)                 
         OC    0(1,R6),BYTE1       PARM1 = STATUS                               
         MVC   4(2,R6),LIDDLEDG    PARM2 = SAVE UNIT/LEDGER IN                  
         B     LSTBLDOK                                                         
         EJECT                                                                  
***********************************************************************         
*  Build list of filters, either form request card or                 *         
*                                     scan block   or                 *         
*                                     DDLink block                    *         
***********************************************************************         
         SPACE 1                                                                
LSTBLD50 OI    LSTMODE,LSTMDATA    Non-account                                  
         LTR   R3,R3                                                            
         BZ    LSTBLD52                                                         
         CLC   =C'  ',0(R3)        NOT ACCOUNT, STILL DATA                      
         BE    LSTBLD52                                                         
         CLC   =C'BS',0(R3)        NOT ACCOUNT, STILL DATA                      
         BNE   LSTBLD51                                                         
         OI    LSTMODE,LSTMBLSR                                                 
         B     LSTBLD52                                                         
                                                                                
LSTBLD51 NI    LSTMODE,TURNOFF-LSTMDATA                                         
         OI    LSTMODE,LSTMACCT                                                 
*                                                                               
         USING LDGD,R2                                                          
LSTBLD52 L     R7,AFLTAREA         AREA TO BUILD FILTER LIST                    
         ST    R7,WORD             SAVE START OF A(FILTER AREA)                 
         SR    R8,R8                                                            
         ICM   R8,1,0(R6)          # OF ITEMS IN SCAN BLOCK PARM(1)             
         TM    LSTMODE,LSTMDLNK    DDLink block                                 
         BZ    LSTBLD54                                                         
         ICM   R8,3,0(R5)          # of entries is with data                    
         AHI   R5,2                Point past # of entries                      
                                                                                
LSTBLD54 LTR   R8,R8                                                            
         BZ    LSTBLDNO                                                         
         OI    BYTE1,FLTMULT       X'20' SET TO USER LIST                       
         TM    LSTMODE,LSTMDATA                                                 
         BO    LSTBLD60                                                         
         CLC   =C'UL',0(R3)                                                     
         BE    LSTBLD60                                                         
         MVC   WORK(2),0(R3)       USE U/L SUPPLIED AS PARM2                    
         OI    BYTE1,FLTNOUL       U/L IS NOT INCLUDED                          
*                                                                               
LSTBLD60 LA    RF,14               Default length                               
         LR    R3,R5               R3 = Data                                    
         TM    LSTMODE,LSTMDLNK                                                 
         BO    LSTBLD62                                                         
         IC    RF,0(,R5)           Length of input                              
         LA    R3,12(,R5)          Point to data in scan block                  
                                                                                
LSTBLD62 TM    0(R3),X'40'         IS IT EXLCUDE?                               
         BO    *+8                                                              
         OI    BYTE1,FLTEXCL       X'10' EXCLUDE ACCOUNT                        
         OI    0(R3),X'40'         MAKE IT UPPER CASE                           
                                                                                
         TM    LSTMODE,LSTMBLSR    If data is billing source then fix           
         BO    LSTBLD72                                                         
         TM    LSTMODE,LSTMDATA    If data go alright to process                
         BO    LSTBLD75                                                         
         TM    LSTMODE,LSTMDLNK                                                 
         BO    LSTBLD64            It is one or the other                       
                                                                                
         LA    R3,WORK             WORK(2) has unit/ledger                      
         MVC   WORK+2(12),12(R5)   Use work to build account                    
         TM    BYTE1,FLTNOUL       OK AS IS                                     
         BO    *+10                                                             
         MVC   WORK(14),12(R5)     MOVE IN U/L/ACCOUNT                          
*                                                                               
LSTBLD64 GOTO1 GETLDGR,DMCB,(R3)                                                
         LA    RF,12                                                            
         OC    DMCB,DMCB                                                        
         BZ    LSTBLD75            NO U/L, SO DEFAULT TO LENGTH 12              
         L     R2,DMCB             LOAD UL ENTRY FOR DSECT                      
         SR    R1,R1                                                            
         IC    R1,LDG#LEVS         GET NUMBER OF LEVELS                         
         LA    RE,LDGLEV1          POINT TO FIRST LEVEL                         
*                                                                               
LSTBLD65 SR    R0,R0                                                            
         CLC   2(12,R3),SPACES     ANY ACCOUNT INPUT?                           
         BNH   LSTBLD70                                                         
                                                                                
LSTBLD68 IC    R0,0(,RE)           GET LENGTH OF LEVEL                          
         LR    R4,R3               POINT TO BEGINING OF U/L/ACCOUNT             
         AR    R4,R0               BUMP PAST END OF DATA FOR LEVEL              
         LA    RF,12               MAX LENGTH                                   
         SR    RF,R0               LENGTH  REMAINING (SET CC)                   
         BZ    LSTBLD70            NOTHING REMAINING, USE FULL LENGTH           
         BCTR  RF,0                                                             
         EXCLC RF,2(R4),SPACES                                                  
         BNH   LSTBLD70            FOUND LEVEL THAT DATA IS AT                  
         LA    RE,LDGLEV2-LDGLEV1(RE)    POINT TO NEXT LEVEL                    
         BCT   R1,LSTBLD68                                                      
         DC    H'00'               (HUGH)                                       
*                                                                               
LSTBLD70 LR    RF,R0               GET ORIGINAL LEVEL LENGTH                    
         TM    BYTE1,FLTNOUL       U/L IN ACTUAL DATA?                          
         BZ    LSTBLD74                                                         
         AHI   R3,2                BUMP PAST U/L                                
         B     LSTBLD75                                                         
*                                                                               
LSTBLD72 AHI   RF,2                Add two for U/L                              
         STC   RF,0(,R7)           Save lenght of data                          
         MVC   1(2,R7),SPACES      Pad with leading spaces                      
         SHI   RF,1                                                             
         BM    LSTBLD80                                                         
         EXMVC RF,3(R7),0(R3)      Move in billing source                       
         B     LSTBLD76                                                         
*                                                                               
LSTBLD74 AHI   RF,2                Add two for full length                      
LSTBLD75 STC   RF,0(,R7)           SAVE DATA LENGTH                             
         SHI   RF,1                                                             
         BM    LSTBLD80                                                         
         EXMVC RF,1(R7),0(R3)                                                   
*                                                                               
LSTBLD76 AHI   RF,1                Add back because of EX instr                 
         LR    R1,RF               SEE IF A WILD CARD EXISTS                    
         LR    RE,R3                                                            
LSTBLD78 CLI   0(RE),C'?'                                                       
         BNE   *+8                                                              
         OI    BYTE1,FLTWILD       X'04' WILD CARD SET                          
         AHI   RE,1                                                             
         BCT   R1,LSTBLD78                                                      
*                                                                               
         LA    R7,1(RF,R7)         Next available spot                          
LSTBLD80 LA    RF,32               Scan block length                            
         TM    LSTMODE,LSTMCFLT                                                 
         BZ    *+8                                                              
         LA    RF,42                                                            
         TM    LSTMODE,LSTMSCAN                                                 
         BO    LSTBLD82                                                         
         LA    RF,14               Length of DDLink entry                       
                                                                                
LSTBLD82 AR    R5,RF               Next entry                                   
         BCT   R8,LSTBLD60         LOOP FOR NEXT                                
*                                                                               
         MVC   0(4,R6),WORD        P1 = A(START FILTER DATA RECORD)             
         OC    0(1,R6),BYTE1       SET RELATED INDICATORS                       
         MVI   0(R7),EOT           MARK END                                     
         LA    R7,1(,R7)                                                        
         ST    R7,4(,R6)           P2 = A(END FILTER DATA RECORD)               
         ST    R7,AFLTAREA                                                      
         B     LSTBLDOK                                                         
*                                                                               
LSTBLDNO XC    0(8,R6),0(R6)       SET TO ZEROS                                 
         B     LSTBLDXT                                                         
*                                                                               
LSTBLDOK SR    RE,RE                                                            
LSTBLDXT LTR   RE,RE                                                            
         XIT1                                                                   
         SPACE 1                                                                
LSTMODE  DS    XL1                 Type of data processing                      
LSTMLIST EQU   X'80'               .  +/- List         processing               
LSTMDATA EQU   X'40'               .  Non-account data processing               
LSTMACCT EQU   X'20'               .  Account     data processing               
LSTMCFLT EQU   X'10'               .  Called from CFILTER                       
LSTMBLSR EQU   X'04'               .  Billing source                            
LSTMSCAN EQU   X'02'               .  Data in Scan block                        
LSTMDLNK EQU   X'01'               .  DDLink data  block                        
SCANWORK DS    CL42                                                             
         DROP  R2,R4                                                            
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* Date formats supported as output                                              
***********************************************************************         
DATEFMT  DS    0H                                                               
DATEDFT  DC    AL1(00,08,6,DATCON17,DATCON18)                                   
         DC    AL1(01,06,4,DATCON00,DATCON00)                                   
*&&UK*&& DC    AL1(05,09,6,DATCON05,DATCON05)                                   
         DC    AL1(10,08,5,DATCON10,DATCON10)                                   
*&&UK*&& DC    AL1(11,08,6,DATCON11,DATCON11)                                   
*&&UK*&& DC    AL1(13,08,5,DATCON13,DATCON13)                                   
DATEISO  DC    AL1(20,08,6,DATCON20,DATCON20)                                   
         DC    AL1(21,10,8,DATCON21,DATCON21)                                   
         DC    AL1(23,10,7,DATCON23,DATCON23)                                   
*&&US*&& DC    AL1(30,07,5,DATCON05,DATCON05)                                   
*&&US*&& DC    AL1(31,10,7,DATCON23,DATCON23)                                   
*&&US*&& DC    AL1(32,08,6,DATCON20,DATCON20)                                   
*&&US*&& DC    AL1(33,06,4,DATCON00,DATCON00)                                   
*&&US*&& DC    AL1(34,08,6,DATCON20,DATCON20)                                   
         DC    AL1(100,3,3,DATCON11,DATCON11)          MMM                      
         DC    AL1(102,4,4,DATCON23,DATCON23)          YYYY                     
DATEFMT# EQU   (*-DATEFMT)/DATELNQ                                              
         EJECT                                                                  
***********************************************************************         
* Keywords groups                                                               
***********************************************************************         
GRPTAB   DS    0H                                                               
         DC    AL1(1,1,0,0),AL2(AC#RSULC)    Account unit ledger                
         DC    AL1(1,1,0,0),AL2(AC#RSULN)                                       
         DC    AL1(1,2,0,0),AL2(AC#RSA1C)    Account level 1                    
         DC    AL1(1,2,0,0),AL2(AC#RSA1N)                                       
         DC    AL1(1,3,0,0),AL2(AC#RSA2C)    Account level 2                    
         DC    AL1(1,3,0,0),AL2(AC#RSA2N)                                       
         DC    AL1(1,4,0,0),AL2(AC#RSA3C)    Account level 3                    
         DC    AL1(1,4,0,0),AL2(AC#RSA3N)                                       
         DC    AL1(1,5,0,0),AL2(AC#RSA4C)    Account level 4                    
         DC    AL1(1,5,0,0),AL2(AC#RSA4N)                                       
         DC    AL1(2,1,0,0),AL2(AC#RSCUC)    Contra  unit ledger                
         DC    AL1(2,1,0,0),AL2(AC#RSCUN)                                       
         DC    AL1(2,2,0,0),AL2(AC#RSC1C)    Contra  account level 1            
         DC    AL1(2,2,0,0),AL2(AC#RSC1N)                                       
         DC    AL1(2,3,0,0),AL2(AC#RSC2C)    Contra  account level 2            
         DC    AL1(2,3,0,0),AL2(AC#RSC2N)                                       
         DC    AL1(2,4,0,0),AL2(AC#RSC3C)    Contra  account level 3            
         DC    AL1(2,4,0,0),AL2(AC#RSC3N)                                       
         DC    AL1(2,5,0,0),AL2(AC#RSC4C)    Contra  account level 4            
         DC    AL1(2,5,0,0),AL2(AC#RSC4N)                                       
         DC    AL1(3,1,0,0),AL2(AC#RSCC1)    Costing account level 1            
         DC    AL1(3,1,0,0),AL2(AC#RSCN1)                                       
         DC    AL1(3,2,0,0),AL2(AC#RSCC1)    Costing account level 2            
         DC    AL1(3,2,0,0),AL2(AC#RSCN1)                                       
         DC    AL1(3,3,0,0),AL2(AC#RSCC1)    Costing account level 3            
         DC    AL1(3,3,0,0),AL2(AC#RSCN1)                                       
         DC    AL1(3,4,0,0),AL2(AC#RSCC1)    Costing account level 4            
         DC    AL1(3,4,0,0),AL2(AC#RSCN1)                                       
         DC    AL1(4,1,0,0),AL2(AC#RSCLC)    Client                             
         DC    AL1(4,1,0,0),AL2(AC#RSCLN)                                       
         DC    AL1(4,2,0,0),AL2(AC#RSPRC)    Product                            
         DC    AL1(4,2,0,0),AL2(AC#RSPRN)                                       
         DC    AL1(4,3,0,0),AL2(AC#RSJBC)    Job                                
         DC    AL1(4,3,0,0),AL2(AC#RSJBN)                                       
         DC    AL1(0)                                                           
                                                                                
***********************************************************************         
* Group names based on GRPTAB in ACREPRL03, see GRPKYW#               *         
***********************************************************************         
GRPNAMES DS    0H                                                               
         DC    AL1(NO,0),AL2(AC#ACCS)    Grp=1     Accounts                     
         DC    AL1(NO,0),AL2(AC#CTRL)    Grp=2     Contra list                  
*&&US*&& DC    AL1(NO,0),AL2(AC#NFA58)   Grp=3     Costing Account (US)         
*&&UK*&& DC    AL1(NO,0),AL2(AC#CSTA)    Grp=3     Costing Account (UK)         
         DC    AL1(NO,0),AL2(AC#PRD)     Grp=4     Production                   
         DC    AL1(EOT)                                                         
***********************************************************************         
* Keywords that act as constants                                                
***********************************************************************         
SPCLKYWS DS    0H                                                               
         DC    AL2(AC#RSSHR,KYWKEY1-KYWKEYS)                                    
         DC    AL2(AC#RSTHR,KYWKEY1-KYWKEYS)                                    
         DC    AL2(AC#RSP$T,KYWKEY1-KYWKEYS)                                    
         DC    AL2(AC#RSP$S,KYWKEY1-KYWKEYS)                                    
         DC    AL2(AC#RSP$B,KYWKEY1-KYWKEYS)                                    
         DC    AL2(AC#RSP$P,KYWKEY1-KYWKEYS)                                    
         DC    AL2(0)                                                           
KYWKEYS  DS    0H                                                               
KYWKEY1  DC    AL1(4,0),AL2(AC#RSA1C,AC#RSA2C,AC#RSA3C,AC#RSA4C)                
         EJECT                                                                  
***********************************************************************         
* Keywords that filter on contra unit ledger values                             
***********************************************************************         
CNTRKYW  DC    AL1(05),AL2(AC#RSGRS),C'11' Billing        (INC)                 
         DC    AL1(05),AL2(AC#RSBIL),C'11' Billing        (P&L)                 
         DC    AL1(05),AL2(AC#RSREV),C'12' Revenue        (P&L)                 
         DC    AL1(05),AL2(AC#RSDXP),C'13' Direct Exp     (P&L)                 
         DC    AL1(05),AL2(AC#RSDLT),C'14' Direct Labor   (P&L - TOTAL)         
         DC    AL1(05),AL2(AC#RSDLS),C'14' Direct Labor   (P&L - SAL)           
         DC    AL1(05),AL2(AC#RSDLB),C'14' Direct Labor   (P&L - BEN)           
         DC    AL1(05),AL2(AC#RSDLP),C'14' Direct Labor   (P&L - PEN)           
         DC    AL1(05),AL2(AC#RSILT),C'15' Indirect Labor (P&L - TOTAL)         
         DC    AL1(05),AL2(AC#RSILS),C'15' Indirect Labor (P&L - SAL)           
         DC    AL1(05),AL2(AC#RSILB),C'15' Indirect Labor (P&L - BEN)           
         DC    AL1(05),AL2(AC#RSILP),C'15' Indirect Labor (P&L - PEN)           
         DC    AL1(05),AL2(AC#RSOVH),C'16' Overhead       (P&L)                 
         DC    AL1(08),AL2(AC#RSTD$),C'13,14'          Dir Exp & Labor          
         DC    AL1(08),AL2(AC#RSTI$),C'15,16'          Ind Labor & OH           
         DC    AL1(14),AL2(AC#RSTC$),C'13,14,15,16'    Tot Dir & Ind            
         DC    AL1(17),AL2(AC#RSNI$),C'12,13,14,15,16' Rev & Total Cost         
         DC    AL1(0)                                                           
         EJECT                                                                  
                                                                                
***********************************************************************         
* German separators                                                             
***********************************************************************         
GERSEP   DC    AL1(1),C'='                                                      
         DC    AL1(1),C'#'                                                      
         DC    AL1(1),C'#'                                                      
         DC    AL1(1),C'#'                                                      
         DC    AL1(0)                                                           
                                                                                
*ACSCRFMTS                                                                      
       ++INCLUDE ACSCRFMTS                                                      
*ACREPRLWRK                  ** COMMENTED OUT SINCE INCLUDED IN                 
*        PRINT OFF              ACSCRFMTS.  PUT BACK WHEN ACSCRFMTS             
*      ++INCLUDE ACREPRLWRK     MADE INTO A PHASE.                              
*        PRINT ON                                                               
*DDRUNNERD                                                                      
         PRINT OFF                                                              
       ++INCLUDE DDRUNNERD                                                      
         PRINT ON                                                               
*                                                                               
RQH      DSECT                                                                  
RQHITRM  DS      0CL42                                                          
         DS      CL4                                                            
         DS      CL4                                                            
         DS      CL4                                                            
RQHPSWD  DS      XL2                                                            
         EJECT ,                                                                
***********************************************************************         
*   USE DSECT ONLY IN ACREPRL03 TO DUMMY UP KEY OF LIST RECORD TO     *         
*   INDICATE IF THE LIST RECORD SAVED OFF IS INCLUDE OR EXCLUDE TYPE  *         
***********************************************************************         
LSTRECD  DSECT                                                                  
         ORG   LSTKEY+LSTKEND                                                   
LSTKUSE  DS    CL(L'LITUSE)        INCLUDE OR EXCLUDE LIST                      
LSTKUINC EQU   LITUINCL            INCLUDE ENTRIES IN LIST                      
LSTKUEXC EQU   LITUEXCL            EXCLUDE ENTRIES IN LIST                      
                                                                                
XPDD     DSECT                                                                  
XPDDTEFG DS    AL1                                                              
XPDENDT  DS    AL1                                                              
XPDCLVL  DS    AL1                                                              
XPDLNQ   EQU   *-XPDD                                                           
                                                                                
LCBLD    DSECT                     Local working storage                        
HEAD1COL DS    CL24                Work space for column heading                
HEAD2COL DS    CL24                Column heading 2                             
HEAD3COL DS    CL24                Column heading 3                             
HEAD1SZ  DS    XL1                 Column heading 1 size                        
HEAD2SZ  DS    XL1                 Column heading 2 size                        
HEAD3SZ  DS    XL1                 Column heading 3 size                        
*                                                                               
HEAD_A   DS    CL24                                                             
HEAD_B   DS    CL24                                                             
HEAD_C   DS    CL24                                                             
HEADEND  DS    0C                                                               
*                                                                               
ELHEAD1  DS    CL12                Stored value from RCLELD                     
ELHEAD2  DS    CL12                Stored value from RCLELD                     
*                                                                               
ORGH1SZ  DS    XL1                                                              
ORGH2SZ  DS    XL1                                                              
*                                                                               
PRVCH1SZ DS    XL1                                                              
PRVCH2SZ DS    XL1                                                              
PRVHEAD2 DS    CL(L'HEAD2COL)                                                   
PRVCH1LC DS    A                                                                
PRVCH2LC DS    A                                                                
PRVHEAD1 DS    CL(L'HEAD1COL)      Work space for previous column heads         
PRVCOLSZ DS    AL1                 PREVIOUS COLUMN SIZE                         
                                                                                
LV1HEADC DS    CL24                Level heading C for level 1                  
LV2HEADC DS    CL24                Level heading C for level 2                  
LV3HEADC DS    CL24                Level heading C for level 3                  
*                                                                               
SUPER2AD DS    A                   Super column 2nd start location              
SUPER2SZ DS    XL1                 Super column 2nd size                        
SUPERCOL DS    XL1                 Control supper column heading build          
SUPERINT EQU   X'80'               .  1st x column recognized as super          
SUPER1ST EQU   X'40'               .  Super column on 1st line                  
SUPER2ND EQU   X'20'               .  Super column on 2nd line                  
SUPERSTK EQU   X'10'               .  Column is stacked                         
SUPERSTC EQU   X'08'               .  Column is a "STATIC" type                 
*                                                                               
RETURN2  DS    A                                                                
DATEPASS DS    CL1                                                              
REQSTDTE DS    CL3                                                              
REQENDTE DS    CL3                                                              
STCOLDTE DS    CL3                                                              
ENCOLDTE DS    CL3                                                              
RELDATE  DS    0CL3                                                             
RELYY    DS    CL1                                                              
RELMM    DS    CL1                                                              
RELDD    DS    CL1                                                              
RELQTR   DS    CL1                                                              
RELDAYS  DS    CL6                 YYMMDD EBCIDIC                               
LCBLDQ   EQU   *-LCBLD                                                          
                                                                                
LCNTD    DSECT                                                                  
LCNTSTRG DS    CL(STDPGWD)                                                      
LCNTDQ   EQU   *-LCNTD                                                          
         EJECT ,                                                                
LGFLTD   DSECT                     Local storage for GFILTER                    
GFLTIND  DS    CL1                                                              
GFLTUL   DS    CL2                                                              
LGFLTDQ  EQU   *-LGFLTD                                                         
         SPACE 3                                                                
LCFLTD   DSECT                     Local storage for CFILTER                    
PREVSEQ  DS    XL1                                                              
CFLTIND  DS    CL1                                                              
CFLTUL   DS    CL2                                                              
LCFLTDQ  EQU   *-LCFLTD                                                         
         SPACE 3                                                                
JCOLTABD DSECT                     ** COLUMN TABLE **                           
JCOLTEOT EQU   0                   END OF TABLE INDICATOR                       
JCOLDICN DS    0XL4                DICTIONARY ESCAPE SEQUENCE                   
JCOLDESC DS    XL1                 DICTIONARY ESCAPE CHARACTER                  
JCOLDREF DS    XL2                 DICTIONARY REFERENCE NUMBER                  
JCOLDLEN DS    XL1                 DICTIONARY ITEM LENGTH                       
JCOLESC  DS    XL2                 DICTIONARY ESCAPE SEQUENCE                   
JCOLVAL  DS    CL6                 DICTIONARY VALUE                             
JCOLTABL EQU   *-JCOLTABD          ENTRY LENGTH                                 
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'090ACREPRL03 01/25/21'                                      
         END                                                                    
