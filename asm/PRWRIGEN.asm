*          DATA SET PRWRIGEN   AT LEVEL 081 AS OF 11/05/18                      
*PHASE T00A4FB,*                                                                
*INCLUDE SRCHCALL                                                               
*INCLUDE DDUCOM                                                                 
*                                                                               
*        TITLE  PRWRIGEN - PRINT WRITER GENERAL ROUTINES                        
         TITLE 'PRWRIGEN - CHANGE LOG '                                         
***********************************************************************         
* USER    JIRA       DATE                  CHANGE LOG                 *         
* ---- ----------  -------- ----------------------------------------- *         
* AKAT SPEC-22216  11/05/18 SUPPORT NEW MEDIA TYPE "D" (DIGITAL AUDIO)*         
* AKAT SPEC-17214  05/07/18 MAKE SURE DRSECBLK IS PASSED TO DRONE     *         
* AKAT SPEC-13     07/14/16 PUBLOCK FILTER                            *         
* AKAT DSPTK-111   03/24/16 SUPPORT ESTIMATE UCOMMS 5-8               *         
* AKAT DSSUP-6453  01/11/16 HONOR RLP SOFT DATES FOR CHGONLY          *         
* AKAT MOSTK-75    01/11/16 PBQSTART NOT SET WHEN XCGROUP FILTER=Y    *         
*                                                                     *         
***********************************************************************         
*                                                                               
*  AKAT 07/21/15 SUPPORT MEDIA B,V & W                                          
*                                                                               
*  AKAT 03/24/14 SUPPORT MEDIA L                                                
*                                                                               
*  BOBY 01/00/09 BUY CHANGE TYPE FILTER                                         
*                                                                               
*  BOBY 11/00/08 OPTION TO USE BFORM RECORDS                                    
*                                                                               
*  BOBY 02/00/08 FX IS A SPECIAL ADDITIONAL CHARGE                              
*                                                                               
*  BOBY 04/00/07 CLIENT STRING SECURITY                                         
*                                                                               
*  BOBY 04/00/07 STANDARDIZED COLUMNS                                           
*                                                                               
*  BOBY 04/00/07 ESTIMATE RATE FILTER                                           
*                                                                               
*  BOBY 11/00/06 BNVDSTA FILTER                                                 
*                                                                               
*  BOBY 05/00/06 STEWARDSHIP FILTERS                                            
*                                                                               
*  BOBY 04/00/06 VALIDATE LIST= IN PUB FIELD                                    
*                                                                               
*  BOBY 02/13/06 HANDLE H= PROPERLY                                             
*                                                                               
*  BOBY 04/12/04 FORCE FLOW PERIOD TO THAT OF ESTIMATE                          
*                                                                               
*  BOBY 04/27/93 CREATION                                                       
*                                                                               
         TITLE  'PRWRIGEN - PRINT WRITER GENERAL ROUTINES'                      
PRWRIGEN CSECT                                                                  
         PRINT NOGEN                                                            
         NMOD1 0,PRWRIGEN,R7,RR=RE,CLEAR=YES                                    
*                                                                               
         USING SPOOLD,R8                                                        
         LA    RC,SPOOLEND         RE-ESTABLISH COMMON WORKING STORAGE          
         USING GEND,RC                                                          
*                                                                               
         USING GETTXTD,GETTXTCB    ESTABLISH GETTXT CONTROL BLOCK               
*                                                                               
         ST    RD,COMMRD                                                        
*                                                                               
         L     R9,ASYSD                                                         
         USING SYSD,R9                                                          
*                                                                               
         L     RA,ATWA                                                          
         USING T405FFD,RA                                                       
*                                                                               
         ST    RE,RELOPGEN         SAVE RELOCATION FACTOR                       
*                                                                               
         SRL   RF,24               RF HAS INDEX TO ROUTINE IN HIGH              
         SLL   RF,2                   ORDER BYTE                                
         LA    RF,BRANCH(RF)       POINT TO ENTRY IN BRANCH TABLE               
*                                                                               
         CLI   0(RF),0             IF IT IS NOT AN ADDRESS                      
         BNE   0(RF)                  GO TO BRANCH STATEMENT                    
*                                                                               
         L     RF,0(RF)            ELSE GO TO THAT ADDRESS                      
         A     RF,RELOPGEN         RELOCATE ADDRESS                             
         BASR  RE,RF                                                            
         B     XIT                                                              
*                                                                               
         DS    0A                  ALIGNMENT                                    
BRANCH   B     VVALAGY                                                          
         B     VVALMED                                                          
         DC    A(CLIVAL)           VALIDATE CLIENT                              
         B     VVALPRD                                                          
         B     VVALEST                                                          
         DC    A(PBVAL)                                                         
         B     VVALDIV                                                          
         B     VVALREG                                                          
         B     VVALDST                                                          
         B     VVALADC                                                          
         B     VVALDTYP                                                         
         B     VVALPER                                                          
         DC    16X'00'                                                          
         B     VVALFILT                                                         
         B     VVALOPTS                                                         
         B     VVALTITS                                                         
         DC    16X'00'                                                          
*                                                                               
         B     VVALHEAD                                                         
         B     VVALMID                                                          
         B     VVALROWS                                                         
         B     VVALCOLS                                                         
         B     VVALPEX                                                          
         DC    16X'00'                                                          
*                                                                               
         B     VINTDRON                                                         
         B     VVRWDRON                                                         
         B     VGRWDRON                                                         
         B     VVCLDRON                                                         
         B     VGCLDRON                                                         
         B     VVCMDRON                                                         
         B     VGCMDRON                                                         
         B     VGUSDRON                                                         
         DC    12X'00'                                                          
         B     VWRPDRON                                                         
*                                                                               
         B     VINTDRIV                                                         
         DC    12X'00'                                                          
*                                                                               
         B     VGENHEAD                                                         
         DC    XL4'00'                                                          
         B     VGENFOOT                                                         
         DC    9XL4'00'                                                         
*                                                                               
         B     VNUMERIC                                                         
         B     VPACK                                                            
         DC    8X'00'                                                           
*                                                                               
         B     VCURSERR                                                         
         B     VERRXIT                                                          
         B     VEXIT                                                            
         DC    4X'00'                                                           
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE  'PRWRIGEN - PRINT WRITER GENERAL ROUTINES - VALAGY'             
***********************************************************************         
*                                                                     *         
*        VALIDATE AGENCY                                              *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
VVALAGY  MVC   PBQAGY,AGENCY                                                    
*                                                                               
*        INIT VLBLOCK FOR DDVAL                                                 
*                                                                               
         L     R5,AVLPARMS         ESTABLISH DDVAL BLOCK                        
         USING VLPARMS,R5                                                       
*                                                                               
         XC    VLBLOCK(VLBLOCKL),VLBLOCK CLEAR BLOCK                            
         MVC   VLACFACS,ACOMFACS   A(COMFACS)                                   
         MVC   VLCTRY,CTRY         SET COUNTRY CODE                             
         MVC   VLLANG,LANG         LANGUAGE CODE                                
         MVC   VLAGENCY,AGENCY     AGENCY                                       
         MVI   VLSYSTEM,VLSYSPRQ                                                
*                                                                               
         GOTO1 DATCON,DMCB,(3,BTODAY),(2,VLTODAYC)                              
*                                                                               
         DROP  R5                                                               
*                                                                               
         CLI   OFFLINE,C'Y'     SKIP IF OFF-LINE                                
         BE    VVALAGY0                                                         
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,CONRECH+5      GET INPUT LENGTH                             
         BZ    VVALAGY0            SKIP IF NOTHING ENTERED                      
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         CLC   CONREC(0),=CL8'TEST' 'TEST' RECORD TYPE                          
         B     VVALAGY0                                                         
****     BNE   VVALAGY0                                                         
*                                                                               
         CLI   DDS,C'Y'            MUST BE FROM DDS TERMINAL                    
         BE    VVALAGY0                                                         
*                                                                               
         LA    R2,CONRECH          SET CURSOR TO FIELD                          
         MVI   ERROR,PWEDDST       SET ERROR CODE                               
*                                                                               
         GOTO1 CURSERR                                                          
*                                                                               
         DC    H'0'                SHOULD NOT COME BACK HERE                    
*                                                                               
VVALAGY0 DS    0H                                                               
*                                                                               
         CLI   OFFLINE,C'Y'     IF OFF-LINE OPEN CONTROL SYSTEM FILES           
         BNE   VVALAGY1                                                         
*                                                                               
         L     RF,ATWA             POINT TO TWA                                 
         L     RF,TWAMASTC-TWATASK(RF) POINT TO MASTC                           
*                                                                               
         MVC   PBQSECAG,MCAGYSEC-MCBLOCK(RF)  SAVE SECURITY AGENCY ID           
*                                                                               
         L     RF,MCUTL-MCBLOCK(RF)  POINT TO UTL                               
         ST    RF,PBUTLA           SAVE ADDRESS                                 
         MVC   DUB(1),4(RF)        SAVE CURRENT SYSTEM ID                       
         MVI   4(RF),X'0A'         SET FOR CONTROL SYSTEM                       
*                                                                               
         GOTO1 DATAMGR,DMCB,=C'DMOPEN',=C'CONTROL',CONFILES,DMWORK              
*                                                                               
         L     RF,PBUTLA           SWITCH BACK TO CURRENT SYTEM                 
         MVC   4(1,RF),DUB                                                      
*                                                                               
VVALAGY1 DS    0H                                                               
*                                                                               
         XIT1                      GET AGY REC IN MEDIA VALIDATION              
*                                                                               
CONFILES DS    0D                  CONTROL SYSEM FILE LIST                      
         DC    CL8' GENDIR'                                                     
         DC    CL8' GENFIL'                                                     
         DC    CL8'X'              END OF LIST                                  
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE  'PRWRIGEN - PRINT WRITER GENERAL ROUTINES - VALMED'             
***********************************************************************         
*                                                                     *         
*        VALIDATE MEDIA CODE                                          *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
VVALMED  GOTO1 ANY                 READ IN MEDIA ENTRY                          
         MVC   PBQMED,WORK                                                      
*                                                                               
         LA    RF,HELPCBLK         SET MEDIA IN HELP CONTROL BLOCK              
         MVC   HCBMED-HELPCB(L'HCBMED,RF),PBQMED                                
*                                                                               
         MVI   ERROR,INVMED                                                     
         CLI   5(R2),1             INPUT LENGTH MUST BE 1                       
         BNE   TRAPERR                                                          
         LA    RE,L'MEDPOSS                                                     
         LA    RF,MEDPOSS           MEDIA POSSIBILITIES                         
MMEDI    CLC   0(1,RF),PBQMED                                                   
         BE    VVVMEDOK                                                         
         LA    RF,1(RF)                                                         
         BCT   RE,MMEDI                                                         
         B     TRAPERR                                                          
*                                                                               
MEDPOSS  DC    C'*CILMNOSTBVWD'        MEDIA POSSIBILITIES                      
*                                                                               
* USER AGENCY                                                                   
*                                                                               
VVVMEDOK MVC   AGYSIGN,SPACES                                                   
         XC    AGYALPHA,AGYALPHA                                                
         MVI   AGYNUM,X'FF'        ASSUME NOT NUMERIC                           
*                                  AGENCY NAME & ADDRESS FROM ID REC.           
         MVC   FILENAME,=CL8'CTFILE'                                            
         MVI   USEIO,C'Y'                                                       
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING CTIKEY,R4                                                        
         MVI   CTIKTYP,C'I'                                                     
         L     R1,ATWA                                                          
         MVC   CTIKID+8(2),10(R1)                                               
         MVI   RDUPDATE,C'N'                                                    
*                                                                               
         GOTO1 READ                                                             
*                                                                               
*        GET PROFILES                                                           
*                                                                               
         XC    DUB,DUB             PARAMETERS FOR GETPROF                       
*                                                                               
         MVI   DUB,C'P'            SET SYSTEM                                   
         MVC   DUB+2(2),=C'W0'     W0 - WRITER PROFILE                          
         MVC   DUB+4(2),PBQAGY     AGENCY                                       
*                                                                               
         CLI   PBQMED,C'*'         IF SINGLE MEDIA                              
         BE    *+8                                                              
         CLI   PBQMED,C'C'                                                      
         BE    *+10                                                             
         MVC   DUB+6(1),PBQMED        GET MEDIA LEVEL PROFILE                   
*                                                                               
         GOTO1 GETPROF,DMCB,(X'C0',DUB),PBQPRFW0,DATAMGR                        
*                                                                               
         MVC   DUB+2(2),=C'WL'     WL - LIMITS PROFILE                          
*                                                                               
         GOTO1 GETPROF,DMCB,(X'C0',DUB),PBQPRFWL,DATAMGR                        
*                                                                               
*        CHECK IF USER ALLOWED TO PERFORM ACTION                                
*                                                                               
         CLI   OFFLINE,C'Y'        SKIP IF OFF-LINE                             
         BE    VUSRSECX                                                         
*                                                                               
         CLI   PBQPRFW0+5,C'Y'     SKIP IF SECURITY NOT BEING USED              
         BNE   VUSRSECX                                                         
*                                                                               
         TM    AUTH,X'80'          SKIP IF NO SECURITY RESTRICTIONS             
         BO    VUSRSECX                                                         
*                                                                               
         CLI   ACTNUM,ACTDIS       OKAY IF DISPLAYING                           
         BE    VUSRSECX                                                         
*                                                                               
         CLI   ACTNUM,ACTREP       OKAY IF REPORTING                            
         BE    VUSRSECX                                                         
*                                                                               
         CLI   ACTNUM,ACTSEL       OKAY IF SELECTING - MUST BE DISPLAY          
         BE    VUSRSECX                                                         
*                                                                               
         MVI   ERROR,SECLOCK       SECURITY LOCKOUT                             
         B     TRAPERR                                                          
*                                                                               
VUSRSECX DS    0H                                                               
*                                                                               
         L     R4,AIO                                                           
         LA    R4,CTIDATA                                                       
         SR    R3,R3                                                            
*                                                                               
VUSER1   CLI   0(R4),0             DONE IF END OF RECORD                        
         BE    VUSER3                                                           
*                                                                               
         CLI   0(R4),X'30'         DESTINATION DETAILS                          
         BE    VUSER2AB                                                         
*                                                                               
         CLI   0(R4),X'36'         ORIGIN DETAILS                               
         BE    VUSER2A                                                          
*                                                                               
         CLI   0(R4),X'02'         DESCRIPTION ELEMENT                          
         BE    VUSER2B                                                          
*                                                                               
         CLI   0(R4),X'06'         2 CH AGENCY ID ELEMENT                       
         BE    VUSER2C                                                          
*                                                                               
VUSER1A  IC    R3,1(R4)                                                         
         AR    R4,R3                                                            
         B     VUSER1                                                           
*                                                                               
VUSER2A  DS    0H                  ORIGIN DETAILS                               
*                                                                               
         USING CTORGD,R4                                                        
*                                                                               
         MVC   USERADDR,CTORGADD   ALWAYS USE ORIGIN ADDRESS                    
*                                                                               
         CLI   PBQPRFW0,C'Y'       IF PROFILE REQUIRES                          
         BNE   *+10                                                             
         MVC   USERNAME,CTORGNAM      ALSO USE ORIGIN NAME                      
*                                                                               
         B     VUSER1A                                                          
*                                                                               
VUSER2AB DS    0H                  DESTINATION DETAILS                          
*                                                                               
         USING CTDSTD,R4                                                        
*                                                                               
         CLI   PBQPRFW0,C'Y'       UNLESS PROFILE INDICATES OTHERWISE           
         BE    *+10                                                             
         MVC   USERNAME,CTDSTNAM      DEFAULT IS DESTINATION NAME               
*                                                                               
         B     VUSER1A                                                          
*                                                                               
***      =================  ***                                                 
         USING CTDSCD,R4                                                        
***      =================  ***                                                 
VUSER2B  MVC   AGYSIGN,CTDSC                                                    
         MVC   WORK(3),AGYSIGN+2                                                
         NC    WORK(3),=X'F0F0F0'                                               
         CLC   WORK(3),=X'F0F0F0'                                               
         BNE   VUSER1A                                                          
         MVC   AGYNUM,AGYSIGN+2                                                 
         B     VUSER1A                                                          
*                                                                               
***      =================  ***                                                 
         USING CTAGYD,R4                                                        
***      =================  ***                                                 
VUSER2C  MVC   AGYALPHA,CTAGYID                                                 
*                                                                               
         LHI   RF,TRAFID-SYSD                                                   
         LA    RF,SYSD(RF)         POINT TO TRAFFIC ID SAVE AREA                
         MVC   0(1,RF),CTAGYIDT    SAVE TRAFFIC SIGN-ON INDICATOR               
         MVC   PBTRAFID,CTAGYIDT   SAVE TRAFFIC SIGN-ON INDICATOR               
*                                                                               
         B     VUSER1A                                                          
*                                                                               
VUSER3   XC    FILENAME,FILENAME                                                
         MVI   USEIO,0                                                          
         GOTO1 GETFACT,DMCB,0                                                   
         L     RF,0(R1)                                                         
         MVC   FACTWRK(80),0(RF)                                                
*                                                                               
VUSERX   DS    0H                                                               
*                                                                               
         CLI   OFFLINE,C'Y'        CHECK FOR OFF-LINE                           
         BE    VUSERXX                                                          
*                                                                               
         L     RF,ACOMFACS         FORCE SWITCH TO PRINT                        
         L     RF,CSWITCH-COMFACSD(RF)                                          
         GOTO1 (RF),DMCB,=C'PRINT',0                                            
         CLI   4(R1),0                                                          
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
VUSERXX  DS    0H                                                               
*                                                                               
*        INITIALIZE OPTION INDICATORS                                           
*                                                                               
         MVI   BOXOPT,C'Y'         DEFAULT TO BOXES                             
         MVI   PBQPOPT,0                                           L17          
         MVI   SPECOPT,0           USE AS TEMP FOR DOWN OPTIONS                 
         MVI   SPECOPT2,0          USE AS TEMP FOR DOWN OPTIONS 2               
         MVI   SPECCHAR,0          USE AS TEMP FOR DOWN TOTAL CHAR              
         MVI   PBQTAPE,C'N'         NO TAPE UNLESS OTHERWISE        L08         
         MVI   PBQINLIN,0           NEWS LINE/INCH/BOTH OPTION                  
         MVI   PBQTEST,C'N'         INCLUDE ONLY LIVE BUYS                      
         MVI   PBQTOTTY,TOTTYPN     NORMAL TOTAL PROCESSING                     
         MVI   PBFLAVOR,C'B'        BUY FLAVOR DEFAULT                          
         L     RF,AVLPARMS                 POINT TO DDVAL PARMS                 
         MVI   VLFLT4V-VLPARMS(RF),PKVFLBUY                                     
         MVI   PBQPZERO,C'Y'        DO  PRINT 0 DOLLARS                         
         MVI   PBQZERO,C'Y'         PRINT LINE EVEN THO ZERO COST               
         MVI   DRINDS,X'0E'   X'04' ALWAYS PRINT TOTAL X'02' PRINT DETL         
*                                  X'08' DROP REJECTED PRINT LINES              
         MVI   LEFTOPT,C'N'        CENTER REPORT                                
         XC    MAXRANK,MAXRANK     NO RANKING                      L20          
         MVI   SPACOPT,1           SINGLE SPACE                                 
         MVI   DOWNOPT,C'N'        NO DOWNLOADING                               
         MVI   WIDEOPT,C'N'        NORMAL REPORT WIDTH                          
         MVI   TRACEOPT,C'N'       NO TRACING                                   
         MVI   NARROPT,C'N'        NORMAL REPORT WIDTH                          
         MVI   PBQBLLOP,0          INIT BILL DATA OPTIONS                       
         XC    PBQBTYPE,PBQBTYPE   INIT BILL TYPE SELECTION                     
         MVI   NUMOFROW,0          NUMBER OF ROWS                               
         MVI   PRGRAND,C'N'        DEFAULT TO NO GRAND TOTAL                    
         XC    PBQQAGY,PBQQAGY     INIT REQUESTED ADVERTISER AGENCY             
         XC    PBQQCLT,PBQQCLT     INIT REQUESTED CLIENT CODE                   
         MVC   FOOTCOM,SPACES      INIT FOOT COMMENT SAVEAREA                   
         XC    FOOTHOOK,FOOTHOOK   INIT FOOT HOOK ADDRESS                       
         XC    PBQATVST,PBQATVST   INIT ACTIVITY DATES                          
         XC    PBQATVEN,PBQATVEN   INIT ACTIVITY DATES                          
         MVI   PBBYOPTS,0          INIT BUY PROCESSING OPTIONS                  
         ZAP   PBQKYWDN,=P'0'      INIT # OF BUY RELATED KEYWORDS               
         XC    RP2ID,RP2ID         DEFAULT TO NO SECOND REPORT                  
         MVI   PBQRP2OP,0                                                       
         MVI   CONHEAD,0                                                        
         MVI   PBQFLTDA,0          INITIALIZE                                   
         XC    PBQADFLT,PBQADFLT   INIT AD FILTER SAVEAREA                      
*                                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP  R4                                                               
*                                                                               
         TITLE  'PRWRIGEN - PRINT WRITER GENERAL ROUTINES - VALPRD'             
***********************************************************************         
*                                                                     *         
*        VALIDATE PRODUCT                                             *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
VVALPRD  DS    0H                                                               
*                                                                               
         MVC   PBQPRD,=C'ALL'      DEFAULT IS PRD=ALL                           
*                                                                               
         CLI   5(R2),0                                                          
         BE    VPX                                                              
*                                                                               
         GOTO1 ANY                                                              
*                                                                               
*        SEPARATE VALIDATION IF THIS IS A GROUP ORIENTED REPORT                 
*              STARTS WITH 'G='                                                 
*                                                                               
         CLC   =C'G=',8(R2)        IF GROUP INDICATOR ENTERED                   
         BNE   VPRGRPN                VALIDATE AS GROUP CODE                    
*                                                                               
****     CLC   PBQCLT,=C'ALL'      OKAY IF ALL CLIENTS                          
****     BE    VPX                                                              
*                                                                               
         GOTO1 =A(GRPVAL),VGRPPRDQ,RR=RELOPGEN  VALIDATE PRODUCT GROUP          
*                                                                               
         B     VPX                 DONE                                         
*                                                                               
VPRGRPN  DS    0H                                                               
*                                                                               
         MVC   PBQPRD,WORK                                                      
*                                                                               
         CLC   PBQPRD,=C'ALL'      TEST ALL PRODUCTS                            
         BE    VPX                                                              
********                                                                        
**  ALLOW REQUESTING OF A SINGLE PRODUCT FOR ALL CLIENTS OR OFFICE              
*******                                                                         
         MVI   ERROR,INVPRD        NO -                                         
**** WILD CARD CHECK                                                            
         CLI   WILDCARD,C'W'                                      L13           
         BE    VPX               UNABLE TO VERIFY PRODUCT IF WILD L13           
****                                                                            
         CLC   PBQCLT,=C'ALL'      CHECK SINGLE CLIENT                          
         BE    VPX                 WAS TRAPERR                                  
         CLI   PBQCLT,C'*'                                                      
         BE    VPX                 WAS TRAPERR                                  
         CLI   PBQCLT,C'&&'                                                     
         BE    VPX                 WAS TRAPERR                                  
         CLI   PBQCLT,C'$'                                                      
         BE    VPX                 WAS TRAPERR                                  
         XC    KEY,KEY             GET PRODUCT RECORD                           
         LA    R4,KEY                                                           
***      =================  ***                                                 
         USING PPRDKEY,R4                                                       
***      =================  ***                                                 
         MVC   PPRDKAGY,AGENCY                                                  
         MVC   PPRDKMED,PBQMED                                                  
         CLI   PBQMED,C'*'         IF ALL MEDIA                                 
         BE    *+8                                                              
         CLI   PBQMED,C'C'         OR ALL MEDIA COMBINED                        
         BNE   *+8                                                              
         B     VPX                    SKIP VALIDATION                           
         MVI   PPRDKRCD,X'06'                                                   
         MVC   PPRDKCLT,PBQCLT                                                  
         MVC   PPRDKPRD,PBQPRD                                                  
         DROP  R4                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(25),KEYSAVE                                                  
         BNE   TRAPERR                                                          
*                                                                               
VPX      B     XIT                                                              
         LTORG                                                                  
*                                                                               
         TITLE  'PRWRIGEN - PRINT WRITER GENERAL ROUTINES - VALEST'             
***********************************************************************         
*                                                                     *         
*        VALIDATE ESTIMATE                                            *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
VVALEST  DS    0H                                                               
         MVC   DMCB(4),=A(20)                                                   
         B     COMMM                                                            
*                                                                               
COMMM    L     RF,CMMON                                                         
         A     RF,RELOPGEN                                                      
         GOTO1 (RF),DMCB                                                        
         BE    XIT                                                              
         CLI   ERROR,0                                                          
         BE    MYEND                                                            
         B     TRAPERR                                                          
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE  'PRWRIGEN - PRINT WRITER GENERAL ROUTINES - VALDIV'             
***********************************************************************         
*                                                                     *         
*        VALIDATE DIVISION                                            *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
VVALDIV  XC    PBQDIV,PBQDIV                                                    
         CLI   5(R2),0                                                          
         BNE   VDXXX                                                            
**                                                                              
**  CHECK TO SEE IF DIVISION/REGION/DISTRICT  WAS SELECTED                      
**                                                                              
         CLI   PBQDRDSW,PBQDRDYQ                                                
         BNE   VDX                                                              
*                                                                               
         MVC   PBQDIV,=C'ALL'                                                   
*                                                                               
         B     VDX                                                              
*                                                                               
VDXXX    GOTO1 ANY                                                              
*                                                                               
         MVC   PBQDIV,WORK                                                      
*                                                                               
         MVI   ERROR,INVDIV        SET ERROR CODE                               
*                                                                               
         CLC   PBQCLT,=C'ALL'      ALLOW IF ALL CLIENTS                         
         BE    VDX                                                              
*                                                                               
         CLI   PBQCLT,C'*'                                                      
         BE    TRAPERR                                                          
**** WILD CARD CHECK                                                            
         CLI   WILDCARD,C'W'                                      L13           
         BE    TRAPERR           UNABLE TO VERIFY IF WILD         L13           
****                                                                            
         CLI   PBQCLT,C'&&'                                                     
         BE    VDX                                                              
         CLI   PBQCLT,C'$'                                                      
         BE    VDX                                                              
*                                                                               
         CLC   PBQDIV,=C'ALL'      ALLOW IF ALL DIVISIONS                       
         BE    VDX                                                              
*                                                                               
DIVRDD   XC    KEY,KEY             GET DIVISION RECORD                          
***      =================  ***                                                 
         LA    R4,KEY                                                           
         USING PDIVKEY,R4                                                       
***      =================  ***                                                 
         MVC   PDIVKAGY,AGENCY                                                  
         MVI   PDIVKRCD,X'03'                                                   
         MVC   PDIVKCLT,PBQCLT                                                  
         MVC   PDIVKDIV,PBQDIV                                                  
*                                                                               
         BRAS  RE,CLTMED           FIND FIRST MEDIA                             
*                                                                               
DIVMEDLP DS    0H                                                               
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(25),KEYSAVE                                                  
         BE    DIVMEDFD                                                         
*                                                                               
DIVMEDCN DS    0H                                                               
*                                                                               
         MVC   KEY,KEYSAVE         RESTORE STARTING KEY                         
*                                                                               
         BRAS  RE,CLTMED           FIND NEXTMEDIA                               
         BE    DIVMEDLP                                                         
*                                                                               
DIVMEDDN DS    0H                                                               
         B     TRAPERR                                                          
*                                                                               
DIVMEDFD DS    0H                                                               
*                                                                               
         B     VDX                                                              
*                                                                               
VDX      B     XIT                                                              
*                                                                               
         DROP  R4                                                               
*                                                                               
         EJECT                                                                  
* VALIDATE REGION                                                               
*                                                                               
VVALREG  XC    PBQRGN,PBQRGN                                                    
*                                                                               
         CLI   5(R2),0                                                          
         BNE   VRXXXX                                                           
**                                                                              
**  CHECK TO SEE IF DIVISION/REGION/DISTRICT  WAS SELECTED                      
**                                                                              
         CLI   PBQDRDSW,PBQDRDYQ                                                
         BNE   VRX                                                              
*                                                                               
         MVC   PBQRGN,=C'ALL'                                                   
         B     VRXY                                                             
*                                                                               
VRXXXX   GOTO1 ANY                                                              
*                                                                               
         MVC   PBQRGN,WORK                                                      
*                                                                               
VRXY     MVI   ERROR,INVREG                                                     
*                                                                               
         OC    PBQDIV,PBQDIV       CHECK DIVISION IS SET                        
         BZ    TRAPERR                                                          
*                                                                               
         OC    PBQDRDCL,PBQDRDCL   SKIP IF DRDCLI PRESENT                       
         BNZ   VRXY10                                                           
*                                                                               
         CLC   PBQCLT,=C'ALL'      CAN'T VALIDATE IF ALL CLIENTS                
         BE    *+10                                                             
         CLC   PBQDIV,=C'ALL'      CAN'T VALIDATE IF ALL DIVISIONS              
         BNE   VRXY10                                                           
*                                                                               
         CLC   PBQRGN,=C'ALL'      AND THUS MUST HAVE ALL REGIONS               
         BNE   TRAPERR                                                          
         B     VRX                                                              
*                                                                               
VRXY10   DS    0H                                                               
*                                                                               
         CLC   PBQRGN,=C'ALL'                                                   
         BE    VRX                                                              
*                                                                               
         XC    KEY,KEY             GET REGION RECORD                            
***      =================  ***                                                 
         LA    R4,KEY                                                           
         USING PREGKEY,R4                                                       
***      =================  ***                                                 
         MVC   PREGKAGY,AGENCY                                                  
         MVI   PREGKRCD,X'04'                                                   
         MVC   PREGKCLT,PBQCLT                                                  
         MVC   PREGKDIV,PBQDIV                                                  
*                                                                               
         OC    PBQDRDCL,PBQDRDCL   IF DRDCLI PRESENT                            
         BZ    *+16                                                             
         MVC   PREGKCLT,PBQDRDCL      USE DRDCLI                                
         MVC   PREGKDIV,=C'000'       USE DIVISION 000                          
*                                                                               
         MVC   PREGKREG,PBQRGN                                                  
*                                                                               
         BRAS  RE,CLTMED           FIND FIRST MEDIA                             
*                                                                               
REGMEDLP DS    0H                                                               
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(25),KEYSAVE                                                  
         BE    REGMEDFD                                                         
*                                                                               
REGMEDCN DS    0H                                                               
*                                                                               
         MVC   KEY,KEYSAVE         RESTORE STARTING KEY                         
*                                                                               
         BRAS  RE,CLTMED           FIND NEXT MEDIA                              
         BE    REGMEDLP                                                         
*                                                                               
REGMEDDN DS    0H                                                               
         B     TRAPERR                                                          
*                                                                               
REGMEDFD DS    0H                                                               
*                                                                               
         DROP  R4                                                               
*                                                                               
VRX      B     XIT                                                              
         EJECT                                                                  
* VALIDATE DISTRICT                                                             
*                                                                               
VVALDST  XC    PBQDST,PBQDST                                                    
         CLI   5(R2),0                                                          
         BNE   VSXXXX                                                           
**                                                                              
**  CHECK TO SEE IF DIVISION/REGION/DISTRICT  WAS SELECTED                      
**                                                                              
         CLI   PBQDRDSW,PBQDRDYQ                                                
         BNE   VSX                                                              
         MVC   PBQDST,=C'ALL'                                                   
         B     VSXY                                                             
*                                                                               
VSXXXX   GOTO1 ANY                                                              
*                                                                               
         MVC   PBQDST,WORK                                                      
*                                                                               
VSXY     MVI   ERROR,INVDST                                                     
*                                                                               
         OC    PBQRGN,PBQRGN       CHECK REGION IS SET                          
         BZ    TRAPERR                                                          
*                                                                               
         OC    PBQDRDCL,PBQDRDCL   SKIP IF DRDCLI PRESENT                       
         BNZ   VSXY10                                                           
*                                                                               
         CLC   PBQRGN,=C'ALL'      IF ALL REGIONS                               
         BNE   *+18                                                             
         CLC   PBQDST,=C'ALL'      THEN MUST HAVE ALL DSTS                      
         BNE   TRAPERR                                                          
         B     VSX                                                              
*                                                                               
VSXY10   DS    0H                                                               
*                                                                               
         CLC   PBQDST,=C'ALL'                                                   
         BE    VSX                                                              
         XC    KEY,KEY             GET DISTRICT RECORD                          
***      =================  ***                                                 
         LA    R4,KEY                                                           
         USING PDSTKEY,R4                                                       
***      =================  ***                                                 
         MVC   PDSTKAGY,AGENCY                                                  
         MVI   PDSTKRCD,X'05'                                                   
         MVC   PDSTKCLT,PBQCLT                                                  
         MVC   PDSTKDIV,PBQDIV                                                  
*                                                                               
         OC    PBQDRDCL,PBQDRDCL   IF DRDCLI PRESENT                            
         BZ    *+16                                                             
         MVC   PDSTKCLT,PBQDRDCL      USE DRDCLI                                
         MVC   PDSTKDIV,=C'000'       USE DIVISION 000                          
*                                                                               
         MVC   PDSTKREG,PBQRGN                                                  
         MVC   PDSTKDST,PBQDST                                                  
*                                                                               
         BRAS  RE,CLTMED           FIND FIRST MEDIA                             
*                                                                               
DSTMEDLP DS    0H                                                               
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(25),KEYSAVE                                                  
         BE    DSTMEDFD                                                         
*                                                                               
DSTMEDCN DS    0H                                                               
*                                                                               
         MVC   KEY,KEYSAVE         RESTORE STARTING KEY                         
*                                                                               
         BRAS  RE,CLTMED           FIND NEXT MEDIA                              
         BE    DSTMEDLP                                                         
*                                                                               
DSTMEDDN DS    0H                                                               
         B     TRAPERR                                                          
*                                                                               
DSTMEDFD DS    0H                                                               
*                                                                               
         DROP  R4                                                               
*                                                                               
VSX      B     XIT                                                              
         EJECT                                                                  
* VALIDATE ADCODE                                                               
*                                                                               
VVALADC  XC    PBQADC,PBQADC                                                    
         CLI   5(R2),0                                                          
         BE    VAX                                                              
         GOTO1 ANY                                                              
         CLC   8(3,R2),=C'ALL'                                                  
         BE    VAX                                                              
         MVC   PBQADC,WORK                                                      
         MVI   ERROR,INVALID                                                    
         CLC   PBQPRD,=C'ALL'      CHECK SINGLE PRODUCT                         
         BE    VAX                 WAS TRAPERR                                  
         CLC   PBQCLT,=C'ALL'      CHECK SINGLE CLIENT                          
         BE    VAX                 WAS TRAPERR                                  
         CLI   PBQCLT,C'*'                                                      
         BE    VAX                 WAS TRAPERR                                  
**** WILD CARD CHECK                                                            
         CLI   WILDCARD,C'W'                                      L13           
         BE    VAX               UNABLE TO VERIFY IF WILD         L13           
****                                                                            
         CLI   PBQCLT,C'&&'                                                     
         BE    VAX                 WAS TRAPERR                                  
         CLI   PBQCLT,C'$'                                                      
         BE    VAX                 WAS TRAPERR                                  
*                                                                               
         XC    KEY,KEY             READ JOB RECORD                              
***      =================  ***                                                 
         LA    R4,KEY                                                           
         USING PJOBRECD,R4                                                      
***      =================  ***                                                 
         MVC   PJOBKAGY,AGENCY                                                  
         MVI   PJOBKRCD,X'15'                                                   
         MVC   PJOBKCLT,PBQCLT                                                  
         MVC   PJOBKPRD,PBQPRD                                                  
         MVC   PJOBKJOB,PBQADC                                                  
*                                                                               
         BRAS  RE,CLTMED           FIND FIRST MEDIA                             
*                                                                               
VADMEDLP DS    0H                                                               
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(25),KEYSAVE                                                  
         BE    VADMEDFD                                                         
*                                                                               
VADMEDCN DS    0H                                                               
*                                                                               
         MVC   KEY,KEYSAVE         RESTORE STARTING KEY                         
*                                                                               
         BRAS  RE,CLTMED           FIND NEXT MEDIA                              
         BE    VADMEDLP                                                         
*                                                                               
VADMEDDN DS    0H                                                               
         B     TRAPERR                                                          
*                                                                               
VADMEDFD DS    0H                                                               
*                                                                               
         B     VAX                                                              
*                                                                               
VAX      B     XIT                                                              
*                                                                               
         DROP  R4                                                               
*                                                                               
         EJECT                                                                  
*                                                                               
* VALIDATE DATE TYPE                                                            
*                                                                   L01         
VVALDTYP DS    0H                                                               
*                                                                               
*        CHECK IF USER ALLOWED TO CHANGE FIELD                                  
*                                                                               
         CLI   OFFLINE,C'Y'        SKIP IF OFF-LINE                             
         BE    VVDTSECX                                                         
*                                                                               
         CLI   PBQPRFW0+5,C'Y'     SKIP IF SECURITY NOT BEING USED              
         BNE   VVDTSECX                                                         
*                                                                               
         TM    AUTH,X'80'          SKIP IF NO SECURITY RESTRICTIONS             
         BO    VVDTSECX                                                         
*                                                                               
         USING FLDHDRD,R2                                                       
*                                                                               
         CLI   FLDIIND,0           OKAY IF NO ACTIVITY IN FIELD                 
         BE    VVDTSECX                                                         
*                                                                               
         TM    FLDIIND,FINPVAL     OKAY IF FIELD PREVIOUSLY VALIDATED           
         BO    VVDTSECX                                                         
*                                                                               
         MVI   ERROR,SECLOCK       SECURITY LOCKOUT                             
         B     TRAPERR             SECURITY ERROR - FIELD CHANGED               
*                                                                               
VVDTSECX DS    0H                                                               
*                                                                               
         MVI   ERROR,INVDTYP       DEFAULT ERROR MESSAGE                        
*                                                                               
         CLI   PBQDATYP,X'40'      ANY DATE TYPE PRESENT                        
         BH    *+8                                                  L01         
         MVI   PBQDATYP,C'I'     INSERTION DATE (DEFAULT)                       
*                                                                               
         LA    R1,PBQDATYP       ASSUME NO INPUT                    L01         
*                                                                               
         CLI   5(R2),0                                                          
         BE    FINDESC                                                          
*                                                                               
         CLI   8(R2),C'?'          IF HELP REQUESTED                            
         BE    *+8                                                              
         CLI   9(R2),C'?'          IF HELP REQUESTED                            
         BE    *+8                                                              
         CLI   8(R2),C'+'          IF HELP REQUESTED                            
         BE    *+8                                                              
         CLI   9(R2),C'?'          IF HELP REQUESTED                            
         BNE   VDTPHLPX                                                         
*                                                                               
         GOTO1 VPRHELP,DMCB,=AL2(PRQHMDTP),(R2),HELPCBLK SHOW HELP MENU         
*                                     FOR OPTIONS                               
         DC    H'0'                SHOULD NOT COME BACK                         
*                                                                               
VDTPHLPX DS    0H                                                               
*                                                                               
         CLI   5(R2),1                                                          
         BE    FINDESCL                                                         
*                                                                               
         CLI   5(R2),2            SEE IF LENGTH OF TWO                          
         BNE   TRAPERR              NEW INPUT                                   
*                                                                               
         LA    RF,DATECODE                                                      
*                                                                               
OPTCLCX  CLC   0(2,RF),8(R2)                                       L01          
         BE    OT18OKX                                              L01         
         CLI   0(RF),255           AT END                           L01         
         BE    TRAPERR             NO MATCH                         L01         
         ZIC   R3,3(RF)            COMPENSATE FOR LENGTH OF DESCRIPTION         
         LA    RF,4(R3,RF)                                                      
         B     OPTCLCX                                              L01         
*                                                                   L01         
OT18OKX  MVC   PBQDATYP,2(RF)      MOVE TYPE OF DATE FOR PRNTIO     L01         
         CLI   PBQDATYP,C'I'       IF INSERTION DATES                           
         BNE   *+8                                                              
         CLI   PBQMED,C'O'         AND MEDIA OUTDOOR                            
         BNE   OT18OK1                                                          
         ZIC   R3,3(RF)            BUMP TO NEXT TABLE ENTRY                     
         LA    RF,4(R3,RF)                                                      
OT18OK1  DS    0H                                                               
*                                                                               
         CLI   PBQDATYP,C'1'       AND MONTH OF SERVICE DATES                   
         BE    *+8                                                              
         CLI   PBQDATYP,C'I'       OR  DEFAULT INSERT DATES                     
         BNE   *+8                                                              
         MVI   PBQPRTYP,PBQPRMOS   SET OPTION                                   
*                                                                               
         CLI   PBFLAVOR,C'O'                                                    
         BE    *+8                                                              
         CLI   PBFLAVOR,C'C'                                                    
         BNE   BUYRULE                                                          
         LA    RF,THISCONT                                                      
BUYRULE  ST    RF,PERFADDR         SAVE ADDRESS                                 
         MVC   PERFADDR(1),3(RF)    LENGTH OF MESSAGE                           
*                                                                               
         OI    FLDIIND,FINPVAL     INDICATE FIELD IS VAILD                      
*                                                                               
         DROP  R2                                                               
*                                                                               
VTX      B     XIT                                                              
*                                                                   L01         
FINDESCL LA    R1,8(R2)         SOURCE OF COMPARE                               
FINDESC  DS    0H                                                   L01         
         LA    RF,DATECODE                                                      
VPTCLC   CLC   2(0,RF),0(R1)    TABLE TO SOURCE                     L01         
         BE    OT18OKX                                              L01         
         CLI   0(RF),255           AT END                           L01         
         BE    TRAPERR             NO MATCH                         L01         
         ZIC   R3,3(RF)            LENGTH OF MESSAGE                            
         LA    RF,4(R3,RF)         ADD LENGTH TO TABLE ENTRY LEN    L01         
         B     VPTCLC                                               L01         
*                                                                   L01         
         TITLE 'PRWRIGEN - VALIDATE PERIOD - VVALPER'                           
***********************************************************************         
*                                                                     *         
*        VALIDATE PERIOD                                              *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
VVALPER  DS    0H                                                               
*                                                                               
         XC    ELEMENT,ELEMENT     INIT POSSIBLE WORKAREA                       
*                                                                               
         LHI   RF,VALSWTCH-SYSD    POINT TO SWITCH                              
         LA    RF,SYSD(RF)                                                      
         NI    0(RF),ESTPERQ       PERIOD NOT FROM ESTIMATE                     
*                                                                               
         CLI   5(R2),0             TEST ANY PERIOD                              
         BNE   VPERTHER                                                         
*                                                                               
*  ENSURE A REQUEST PERIOD WAS MADE EXCEPT FOR THE CASE WHERE A                 
*          SPECIFIC MEDIA, CLIENT, PRODUCT  AND EST WAS REQUESTED               
*          (USE EST START & END DATE) AND WHERE BILLING DATES RQSTED            
*          IN OPTION FIELD                                                      
*                                                                               
         OC    PBQBLLST,PBQBLLST                                                
         BNZ   VPERX                                                            
         OC    PBQBST,PBQBST       WAS START AND END DTE ENTERED                
         BNZ   VPERX                                                            
         OC    SVESTDA,SVESTDA     OKAY IF SPECIFIC ESTIMATE ENTERED            
         BNZ   RDTHEST                                                          
*****                                                                           
***  PERIOD MUST BE ENTERED                                                     
****                                                                            
         OI    6(R2),X'40'         POSITON CURSOR                               
         MVI   ERROR,INVDATE                                                    
         B     TRAPERR                                                          
***                                                                             
*                                                                               
RDTHEST  DS    0H                                                               
*                                                                               
         MVC   KEY+27(4),SVESTDA   ESTIMATE DISK ADDRESS                        
         XC    SVESTDA,SVESTDA                                                  
         L     RF,AIO1                                                          
         ST    RF,AIO                                                           
         GOTO1 GETREC                                                           
***      =================  ***                                                 
         L     RF,AIO1                                                          
         USING PESTRECD,RF                                                      
***      =================  ***                                                 
         MVC   PBQSTART,PESTST     SET REQUEST PERIOD TO ESTIMATE'S             
         MVC   PBQEND,PESTEND                                                   
         LHI   RF,VALSWTCH-SYSD    POINT TO SWITCH                              
         LA    RF,SYSD(RF)                                                      
         OI    0(RF),ESTPERQ       INDICATE PERIOD IS ESTIMATE'S                
         B     GODATC                                                           
*                                                                               
         DROP  RF                                                               
*                                                                               
VPERTHER GOTO1 ANY                                                              
*                                                                               
         MVI   ERROR,INVDATE       PRESET ERROR ID                              
*                                                                               
*        CHECK FOR SOFT DATES                                                   
*                                                                               
         CLI   8(R2),C'!'          SKIP IF NOT A SOFT DATE                      
         BNE   VVALPER1                                                         
*                                                                               
         BRAS  RE,VSOFTDAT          VALIDATE FOR SOFT DATES                     
*                                                                               
         BE    VPERRFPN                                                         
VVALPER1 DS    0H                                                               
*                                                                               
*        PERIOD NOW CONTAINS A HARD DATE                                        
*                                                                               
*        CHECK IF RFP SYMBOLIC PARAMETER ENTERED                                
*                                                                               
         OC    ARFPBLK,ARFPBLK     SKIP IF RFP NOT BEING USED                   
         BZ    VPERRFPN                                                         
*                                                                               
         L     R4,ARFPBLK          ESTABLISH RFP BLOCK                          
         USING RFPBLK,R4                                                        
*                                                                               
         SR    R0,R0                                                            
         ICM   R0,1,RFPVNUMS       NUMBER OF VIABLE SYMBOLIC NAMES              
         BZ    VPERRFPN            NONE                                         
*                                                                               
         CLC   RFPVSYMB,WORK       MATCH INPUT TO SYMBOLIC PARAMETER            
         BE    *+10                   EXPANDED FORMAT                           
         CLC   RFPVSYME(L'RFPVSYME-1),WORK MATCH INPUT TO SYMBOLIC PARM         
         BE    *+16                  ESCAPE SEQ IN CASE LEFT OVER               
*                                     FROM LAST TRANSACTION                     
         LA    R4,RFPVSYML(R4)     BUMP TO NEXT SYMBOLIC PARAMETER              
         BCT   R0,*-24                                                          
         B     VPERRFPN            NO SYMBOLIC PARAMETER FOUND                  
*                                                                               
         CLC   =AL2(PP#RFPPR),RFPVSYME+1 MUST BE PERIOD SYMBOLIC                
         BNE   TRAPERR                                                          
*                                                                               
         XC    8(L'WRIPER,R2),8(R2) INIT PERIOD FIELD                           
         MVC   8(L'RFPVSYME,R2),RFPVSYME REPLACE KEYWORD WITH ESC SEQ           
*                                                                               
         LA    RF,L'WRIPER         MAX LENGTH FOR PERIOD                        
         STC   RF,5(R2)            CHANGE LENGTH TO MAX INPUT FOR RFP           
         STC   RF,L'RFPVSYME-1+8(R2)   CHG LEN IN ESCAPE SEQ                    
*                                                                               
         B     VPERX               VALID PERIOD                                 
*                                                                               
VPERRFPN DS    0H                                                               
*                                                                               
         DROP  R4                                                               
*                                                                               
         XC    WORK,WORK                                                        
         LA    R4,WORK                                                          
         USING PERVALD,R4          ESTABLISH PERVAL WORKAREA                    
*                                                                               
         MVC   PVALBSTA,BTODAY     PASS TODAY'S DATE                            
*                                                                               
         L     RF,ACOMFACS         GET PERVAL ADDRESS                           
         L     RF,CPERVAL-COMFACSD(RF)                                          
*                                                                               
         GOTO1 (RF),DMCB,(5(R2),8(R2)),('PVINTOD',(R4)) VALIDATE PERIOD         
         CLI   4(R1),0             CHECK FOR ERRORS                             
         BNE   TRAPERR                                                          
*                                                                               
         MVC   PBQSTART,PVALESTA   SAVE START AND END DATES                     
         MVC   PBQEND,PVALEEND                                                  
         MVC   PBQBST,PVALBSTA    SAVE BINARY FORMAT                            
         MVC   PBQBEND,PVALBEND                                                 
*                                                                               
         MVI   ERROR,INVDTSEQ      START DATE AFTER END DATE                    
*                                                                               
         CLC   PBQSTART,PBQEND                                                  
         BH    TRAPERR                                                          
*                                                                               
         MVC   8(L'PVALCPER,R2),PVALCPER RE-DISPLAY PERIOD                      
         MVI   5(R2),L'PVALCPER    RESET INPUT  LENGTH                          
         OI    6(R2),X'80'         FORCE RE-TRANSMISSION                        
         MVI   7(R2),L'PVALCPER    SET   OUTPUT LENGTH                          
*                                                                               
         CLI   OFFLINE,C'Y'        IF ONLINE                                    
         BE    GODATD                                                           
*                                                                               
         CLI   ELEMENT+1,C'!'      IF SOFT DATE                                 
         BNE   GODATD                                                           
*                                                                               
         XC    8(17,R2),8(R2)         RESTORE ORIG SOFT ON SCREEN               
         MVC   5(1,R2),ELEMENT        SAVED IN ELEMENT                          
         ZIC   R1,ELEMENT                                                       
         STC   R1,5(R2)               RESTORE INPUT LENGTH                      
         STC   R1,7(R2)               SET OUTPUT LENGTH                         
         AHI   R1,-1                                                            
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   8(0,R2),ELEMENT+1       RESTORE ORIG SOFT DATE                   
*                                                                               
         B     GODATD                                                           
*                                                                               
         DROP  R4                                                               
*                                                                               
GODATC   GOTO1 DATCON,DMCB,PBQSTART,(3,PBQBST)                                  
         GOTO1 DATCON,DMCB,PBQEND,(3,PBQBEND)                                   
*                                                                   L01         
GODATD   DS    0H                                                               
*                                                                   L01         
         CLI   PBQDATYP,C'L'                                                    
         BNE   NOLTYPE                                                          
*                                                                   L01         
         MVC   PBQBLLST,PBQBST  FOR POSSIBLE BILLING INVOICE                    
         MVC   PBQBLLND,PBQBEND  TYPE REQUEST                                   
*                                                                   L01         
NOLTYPE  DS    0H                                                               
*                                                                   L01         
         CLI   PBQCNRLE,C'Y'   IF CONTRACT RULE OPTION THEN INSERT  L01         
         BNE   VPERX           DATE OPTION M/B REQUESTED            L01         
         CLI   PBQDATYP,C'I'                                                    
         BE    VPERX                                                            
*                                                                               
         MVI   ERROR,PWECRLID      CONTRULE REQUIRES INSERT DATES               
         B     TRAPERR                                                          
*                                                                               
VPERX    DS    0H                                                               
         CLI   OFFLINE,C'Y'         IF OFF-LINE NO REQUEST RESTRICTIONS         
         BE    VPERXX                                                           
         CLC   =C'SOON',CONWHEN    SOON REQUEST                                 
         BNE   VPERXX                                                           
*                                                                               
         CLC   PBQBST(1),PBQBEND    SAME YEAR // OK                             
         BE    VPERXX                                                           
*                                                                               
*        READ WL PROFILE                                                        
*                                                                               
         XC    DUB,DUB             PARAMETERS FOR GETPROF                       
*                                                                               
         MVI   DUB,C'P'            SET SYSTEM                                   
         MVC   DUB+2(2),=C'WL'     WL - LIMITS PROFILE                          
         MVC   DUB+4(2),PBQAGY     AGENCY                                       
         MVC   DUB+6(1),PBQMED     MEDIA                                        
         CLI   DUB+6,C'*'          MULTI MEDIA REPORTS DEFAULT TO M             
         BE    *+8                                                              
         CLI   DUB+6,C'C'                                                       
         BNE   *+8                                                              
         MVI   DUB+6,C'M'                                                       
*                                                                               
         GOTO1 GETPROF,DMCB,(X'C0',DUB),PBQPRFWL,DATAMGR                        
*                                                                               
         ZIC   RE,PBQBST                                                        
         ZIC   RF,PBQBEND                                                       
         SR    RF,RE                                                            
         CLM   RF,1,PBQPRFWL        YEAR DIFF                                   
         BH    VMISUSEA            ERROR - TOO MANY YEARS                       
         BL    VPERXX              PLENTY OF ROOM TO SPARE                      
*                                                                               
*                                  EXACTLY TO ALLOWED TIME PERIOD               
*                                                                               
         CLC   PBQBST+1(1),PBQBEND+1     START MO M/B = OR GT END MO            
         BL    VMISUSEA                                                         
         BH    VPERXX                                                           
*                                                                               
         CLC   PBQBST+2(1),PBQBEND+2     START DAY M/B GT END                   
         BH    VPERXX                                                           
*                                                                               
VMISUSEA OI    6(R2),X'40'               CURSOR POSITIONING                     
         MVI   ERROR,PWESOONR      SOON RESTRICTION ERROR                       
         GOTO1 CURSERR                                                          
*                                                                               
VPERXX   DS    0H                                                               
         XIT1                                                                   
*                                                                               
         EJECT                                                                  
*                                                                               
* VALIDATE FILTERS - SAME VALIDATION AS OPTIONS                                 
*                                                                               
VVALFILT DS    0H                                                               
*                                                                               
         B     VVALOPTS                                                         
*                                                                               
* VALIDATE OPTIONS                                                              
*                                                                               
VVALOPTS DS    0H                                                               
*                                                                               
*        CHECK IF USER ALLOWED TO CHANGE FIELD                                  
*                                                                               
         CLI   OFFLINE,C'Y'        SKIP IF OFF-LINE                             
         BE    VVOPSECX                                                         
*                                                                               
         CLI   PBQPRFW0+5,C'Y'     SKIP IF SECURITY NOT BEING USED              
         BNE   VVOPSECX                                                         
*                                                                               
         TM    AUTH,X'80'          SKIP IF NO SECURITY RESTRICTIONS             
         BO    VVOPSECX                                                         
*                                                                               
         USING FLDHDRD,R2                                                       
*                                                                               
         CLI   FLDIIND,0           OKAY IF NO ACTIVITY IN FIELD                 
         BE    VVOPSECX                                                         
*                                                                               
         TM    FLDIIND,FINPVAL     OKAY IF FIELD PREVIOUSLY VALIDATED           
         BO    VVOPSECX                                                         
*                                                                               
         B     VVOPSECE            SECURITY ERROR - FIELD CHANGED               
*                                                                               
VVOPSECX DS    0H                                                               
*                                                                               
         GOTO1 AVALOPTN,DMCB,RR=RELOPGEN GO VALIDATE OPTIONS ROUTINE            
*                                                                               
         CLI   CONHEAD,0           ERROR CHECK                                  
         BNE   VVALOPER              ERRORS                                     
*                                                                               
         OI    FLDIIND,FINPVAL     INDICATE FIELD IS VAILD                      
*                                                                               
         DROP  R2                                                               
*                                                                               
         LA    R2,WRIOPT1H         POINT TO SECOND OPTION LINE                  
*                                                                               
*        CHECK IF USER ALLOWED TO CHANGE FIELD                                  
*                                                                               
         CLI   OFFLINE,C'Y'        SKIP IF OFF-LINE                             
         BE    VVOPSC1X                                                         
*                                                                               
         CLI   PBQPRFW0+5,C'Y'     SKIP IF SECURITY NOT BEING USED              
         BNE   VVOPSC1X                                                         
*                                                                               
         TM    AUTH,X'80'          SKIP IF NO SECURITY RESTRICTIONS             
         BO    VVOPSC1X                                                         
*                                                                               
         USING FLDHDRD,R2                                                       
*                                                                               
         CLI   FLDIIND,0           OKAY IF NO ACTIVITY IN FIELD                 
         BE    VVOPSC1X                                                         
*                                                                               
         TM    FLDIIND,FINPVAL     OKAY IF FIELD PREVIOUSLY VALIDATED           
         BO    VVOPSC1X                                                         
*                                                                               
         B     VVOPSECE            SECURITY ERROR                               
*                                                                               
VVOPSC1X DS    0H                                                               
*                                                                               
         GOTO1 AVALOPTN,DMCB,RR=RELOPGEN GO VALIDATE OPTIONS ROUTINE            
*                                                                               
         CLI   CONHEAD,0           ERROR CHECK                                  
         BNE   VVALOPER              ERRORS                                     
*                                                                               
         OI    FLDIIND,FINPVAL     INDICATE FIELD IS VAILD                      
*                                                                               
         B     XIT                 VALIDATION OKAY                              
*                                                                               
         DROP  R2                                                               
*                                                                               
VVALOPER DS    0H                                                               
*                                                                               
         L     R2,ALASTCOL         POINT TO FIELD IN ERROR                      
         L     R4,DMCB+8           POINT TO DATA IN ERROR                       
*                                                                               
         B     MYCURSOR                                                         
*                                                                               
VVOPSECE DS    0H                                                               
*                                                                               
         MVI   ERROR,SECLOCK       SECURITY LOCK OUT                            
         GOTO1 CURSERR                                                          
*                                                                               
AVALOPTN DC    A(VALOPTN)          A(OPTIONS VALIDATION)                        
*                                                                               
         EJECT                                                                  
* VALIDATE TITLE                                                                
*                                                                               
VVALTITS MVC   TITLE,SPACES                                                     
         MVC   TITLE(22),=C'PRINTPAK REPORT WRITER'                             
         CLI   5(R2),0                                                          
         BE    VVALTIT2                                                         
         GOTO1 ANY                                                              
         MVC   TITLE,WORK                                                       
         OC    TITLE,SPACES                                                     
*                                                                               
VVALTIT2 LA    R1,L'TITLE                                                       
         ST    R1,DMCB+4                                                        
         GOTO1 CENTER,DMCB,TITLE                                                
*                                                                               
*                                  SET SUBTITLE NOW                             
         MVC   SUBTITLE,SPACES                                                  
         MVC   WORK(3),PBQBST                                                   
         MVC   WORK+3(3),PBQBEND                                                
         LA    RF,SUBTITLE                                                      
         L     RE,PERFADDR                                                      
         ZIC   R1,PERFADDR                                                      
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RF),4(RE)    MOVE DATE TYPE                                  
         LA    R4,2(R1,RF)                                                      
         CLI   PBQBST,0                                                         
         BNE   VVALTIT4                                                         
         MVC   SUBTITLE,SPACES                                                  
*                                                                               
         OC    PBQBLLST,PBQBLLST                                                
         BZ    VVALTITX                                                         
         MVC   WORK(3),PBQBLLST                                                 
         MVC   WORK+3(3),PBQBLLND                                               
         MVC   SUBTITLE(12),=C'BILLING FROM'                                    
         LA    R4,SUBTITLE+13                                                   
*                                                                               
VVALTIT4 GOTO1 DATCON,DMCB,(3,WORK),(5,(R4))                                    
         LA    R4,8(R4)                                                         
         MVI   0(R4),C'-'                                                       
         LA    R4,1(R4)                                                         
         GOTO1 (RF),(R1),(3,WORK+3),(5,(R4))                                    
         LA    R1,L'SUBTITLE                                                    
         ST    R1,DMCB+4                                                        
         GOTO1 CENTER,DMCB,SUBTITLE                                             
*                                                                               
VVALTITX B     XIT                                                              
         TITLE 'PRWRIGEN - VALIDATE HEADERS - VALHEAD'                          
***********************************************************************         
*                                                                     *         
*        VALIDATE HEADERS                                             *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
VVALHEAD XC    TOTWIDTH,TOTWIDTH   NOT CHECKING REPORT WIDTH YET                
         MVI   LEVEL,0             INIT LEVEL NUMBER                            
         ZIC   R3,MAX                                                           
         LTR   R3,R3                                                            
         BNZ   *+8                                                              
         LA    R3,5      *** WAS 5****                 1/9/90                   
         STC   R3,MAX                                                           
         L     RF,CMMON                                                         
         A     RF,RELOPGEN                                                      
         GOTO1 (RF),DMCB,0                                                      
         LA    R4,4                START ON HEAD 4                              
*                                                                               
         CLI   PBQRP2SW,0          SKIP IF DOING A SECOND REPORT                
         BNE   *+8                                                              
         MVI   KEYWORD#,0          INIT KEYWORD COUNTER                         
*                                                                               
VVH2     MVI   MYPOSO,C'H'                                                      
         STC   R4,MYPOSO+1                                                      
         MVI   MYPOSO+2,2          (COLUMN 2)                                   
         STC   R4,LASTHEAD                                                      
*                                                                               
         CLI   LASTHEAD,9          LAST HEADLINE STARTS ON LINE 9               
         BH    VVHCOME5                                                         
*                                                                               
         ZIC   RF,KEYWORD#         BUMP KEYWORD COUNTER                         
         LA    RF,1(RF)                                                         
         STC   RF,KEYWORD#                                                      
*                                                                               
         L     R1,AVLPARMS                                                      
         MVI   VLFLT5V-VLPARMS(R1),PRVWHEAD   SET FOR HEADLINE FILTER           
*                                                                               
         GOTOR VALROW              VALIDATE FIELD AS A ROW                      
*                                                                               
         L     R1,AVLPARMS                                                      
         MVI   VLFLT5V-VLPARMS(R1),0          RESET FILTER                      
*                                                                               
         BAS   RE,BUMP                                                          
*                                                                               
         ZIC   R4,LASTHEAD         IN CASE FIELD UPDATED IN VALROW              
*                                                                               
         CLI   5(R2),0             FIELD NOT-ENTERED                            
         BE    VVHBCT                                                           
*                                                                               
         LA    R4,1(R4)            BUMP HEADLINE NUMBER                         
*                                                                               
VVHBCT   BCT   R3,VVH2                                                          
*                                                                               
VVHX     XIT1                                                                   
*                                                                               
VVHCOME5 MVI   ERROR,PWEHEADS                                                   
         GOTO1 CURSERR                                                          
*                                                                               
         TITLE 'PRWRIGEN - VALIDATE MIDLINES - VALMID'                          
***********************************************************************         
*                                                                     *         
*        VALIDATE MIDLINES                                            *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
VVALMID  MVI   MYPOSO,C'M'                                                      
         MVI   MYPOSO+1,1                                                       
         MVI   MYPOSO+2,1                                                       
*                                                                               
         ZIC   RF,KEYWORD#         BUMP KEYWORD COUNTER                         
         LA    RF,1(RF)                                                         
         STC   RF,KEYWORD#                                                      
*                                                                               
         L     R1,AVLPARMS                                                      
         MVI   VLFLT5V-VLPARMS(R1),PRVWMID    SET FOR MID-LINE FILTER           
*                                                                               
         GOTOR VALROW              VALIDATE FIELD AS A ROW                      
*                                                                               
         L     R1,AVLPARMS                                                      
         MVI   VLFLT5V-VLPARMS(R1),0          RESET FILTER                      
*                                                                               
VVALMIDX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         TITLE 'PRWRIGEN - VALIDATE ROWS - VALROWS'                             
***********************************************************************         
*                                                                     *         
*        VALIDATE ROWS                                                *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
VVALROWS MVI   TOTWIDTH+1,1        START CHECKING REPORT WIDTH NOW              
*                                                                               
         CLI   XBOXSW,C'Y'                                                      
         BNE   *+12                                                             
         MVI   TOTWIDTH+1,2        BOXES WAS REQUESTED                          
         MVI   XBOXSW,0                                                         
*                                                                               
         ZIC   R3,MAX                                                           
         LTR   R3,R3                                                            
         BNZ   *+8                                                              
         LA    R3,6                                                             
         STC   R3,MAX                                                           
*                                                                               
         L     RF,CMMON            CHECK FOR INSERTING OR DELETING FLDS         
         A     RF,RELOPGEN                                                      
         GOTO1 (RF),DMCB,0                                                      
*                                                                               
VVR2     XC    MYPOSO,MYPOSO                                                    
*                                                                               
         ZIC   RF,KEYWORD#         BUMP KEYWORD COUNTER                         
         LA    RF,1(RF)                                                         
         STC   RF,KEYWORD#                                                      
*                                                                               
         L     R1,AVLPARMS                                                      
         MVI   VLFLT5V-VLPARMS(R1),PRVWROW    SET FOR ROW      FILTER           
*                                                                               
         GOTOR VALROW              VALIDATE FIELD AS A ROW                      
*                                                                               
         CLC   =C'MATCLDTS',8(R2)  IF ASKING FOR MATERIAL CLOSING DATES         
         JNE   VVR3                                                             
*                                                                               
         MVC   8(8,R2),=CL8'MATCLEDT'   ADD EXTENSION DATE TO REPORT            
*                                                                               
         GOTOR VALROW                   VALIDATE FIELD AS A ROW                 
*                                                                               
         MVC   8(8,R2),=CL8'MATCLDTS'   RESTORE EXTENSION DTES TO RPT           
*                                                                               
VVR3     DS    0H                                                               
*                                                                               
         L     R1,AVLPARMS                                                      
         MVI   VLFLT5V-VLPARMS(R1),0          RESET FILTER                      
*                                                                               
         BAS   RE,BUMP                                                          
         BCT   R3,VVR2                                                          
*                                                                               
         ZIC   R4,LASTHEAD                                                      
         LA    R4,3(R4)                                                         
         CH    R4,=H'9'                                                         
         BH    *+8                                                              
         LA    R4,9                                                             
*                                                                               
         CLI   PBQRP2SW,0          IF DOING A SECOND REPORT                     
         BE    VVR22                                                            
*                                                                               
         CLM   R4,1,MYFIRSTH          UPDATE ONLY IF LARGER                     
         BNH   VVR23                                                            
*                                                                               
VVR22    DS    0H                                                               
*                                                                               
         STC   R4,MYFIRSTH                                                      
*                                                                               
VVR23    DS    0H                                                               
*                                                                               
         TM    SORTIND,SORTFLDQ    MUST HAVE A SORT FIELD IN REQUEST            
         BNO   VVRSORTE                                                         
         XIT1                                                                   
*                                                                               
VVRSORTE DS    0H                  NO SORT FIELD IN REQUEST                     
*                                                                               
         MVI   ERROR,PWESORTE      SET ERROR NUMBER                             
         MVI   FIELDERR,0                                                       
         LA    R2,WRIHEADH         PUT CURSOR AT FIRST HEADLINE                 
*                                                                               
         GOTO1 CURSERR                                                          
*                                                                               
         TITLE 'PRWRIGEN - VALIDATE COLUMNS - VALCOLS'                          
***********************************************************************         
*                                                                     *         
*        VALIDATE COLUMNS                                             *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
VVALCOLS ZIC   R0,MAX                                                           
*                                                                               
         LTR   R0,R0                                                            
         BZ    VVALCOLX                                                         
*                                                                               
         CLI   5(R2),0                                                          
         BE    VCOLND1E            NEED AT LEAST 1 COLUMN                       
*                                                                               
         L     RF,CMMON            CHECK FOR INSERTING/DELETING FIELDS          
         A     RF,RELOPGEN                                                      
         GOTO1 (RF),DMCB,0                                                      
*                                                                               
         MVI   MYLABEL,C'A'                                                     
         L     R3,=A(EDITLIST-SYSD)                                             
         LA    R3,0(R3,R9)                                                      
*                                                                               
VVALCOL2 XC    MYPOSO,MYPOSO                                                    
*                                                                               
         MVC   DRPOSO,MYPOSO       INITIALIZE AFTER OPTION,NP                   
         MVC   0(1,R3),MYLABEL     SET LABEL IN EDIT LIST                       
*                                                                               
         ZIC   RF,KEYWORD#         BUMP KEYWORD COUNTER                         
         LA    RF,1(RF)                                                         
         STC   RF,KEYWORD#                                                      
*                                                                               
         L     R1,AVLPARMS                                                      
         MVI   VLFLT5V-VLPARMS(R1),PRVWCOL    SET FOR COLUMN   FILTER           
*                                                                               
         GOTOR VALCOL              VALIDATE FIELD AS A COLUMN                   
*                                                                               
         CLC   =C'MATCLDTS',8(R2)  IF ASKING FOR MATERIAL CLOSING DATES         
         JNE   VVC3                                                             
*                                                                               
         MVC   8(8,R2),=CL8'MATCLEDT'   ADD EXTENSION DATE TO REPORT            
*                                                                               
         GOTOR VALCOL                   VALIDATE FIELD AS A COL                 
*                                                                               
         MVC   8(8,R2),=CL8'MATCLDTS'   RESTORE EXTENSION DTES TO RPT           
*                                                                               
VVC3     DS    0H                                                               
*                                                                               
         L     R1,AVLPARMS                                                      
         MVI   VLFLT5V-VLPARMS(R1),0          RESET FILTER                      
*                                                                               
         BAS   RE,BUMP             BUMP TO NEXT COLUMN LABEL FIELD              
*                                                                               
         MVC   MYLABEL,8(R2)                                                    
*                                                                               
         BAS   RE,BUMP                                                          
*                                                                               
         LA    R3,4(R3)            BUMP LIST POINTER                            
         BCT   R0,VVALCOL2                                                      
*                                                                               
         TM    PBQCFOPT,PBQBDGMQ   IF MONTHLY BUDGETS IN PLAY                   
         BNO   VVALCLBX                                                         
*                                                                               
         OC    PBADTLST,PBADTLST   IF DATELIST NOT BUILT YET                    
         BNZ   VVALCLBX                BUILD IT                                 
*                                                                               
         XC    BLOCK(40),BLOCK     FAKE SCANNER BLOCK                           
         LA    R4,BLOCK                                                         
         MVC   12(3,R4),=C'M  '    FORCE TO BUILD MONTH LIST                    
*                                                                               
         GOTOR PEREXP                                                           
*                                                                               
         GOTOR RNGCHK              MAKE SURE REQUEST DATES COVER RANGE          
*                                                                               
VVALCLBX DS    0H                                                               
*                                                                               
****************************************************************                
*  TEST TO SEE IF BUYS ARE TO BE READ BY CONTRACT - IF SO MUST HAVE A           
*   CONTRACT RELATED ENTRY                                                      
****************************************************************                
*                                                                               
         CLI   STACKLST,0          IF LAST STACK COLUMN GIVEN                   
         BE    *+14                                                             
         CLC   CLASTLBL,STACKLST      LAST ENTERED COLUMN MUST BE               
         BL    VCOLSTKE               ON OR AFTER LAST STACK COL                
*                                                                               
         CLI   PBFLAVOR,C'O'                                                    
         BE    *+8                                                              
         CLI   PBFLAVOR,C'C'                                                    
         BNE   NTFLAVOR                                                         
*                                                                               
         TM    PBQSPLOP,PBQCONTR  CONTRACT RELATED ENTRY SELECTED               
         BNO   VCOLCONX                                                         
*                                                                               
NTFLAVOR DS    0H                                                               
*                                                                               
****************************************************************                
*  TEST TO SEE IF BUYS ARE TO BE READ BY CONTRACT - IF SO MUST HAVE A           
*   BUY RELATED ENTRY                                                           
****************************************************************                
*                                                                               
         CLI   PBFLAVOR,C'C'                                                    
         BNE   NTFLAVR1                                                         
*                                                                               
         TM    PBQREAD,PBQRDBUY  MUST HAVE A BUY RELATED ENTRY                  
         BO    NTFLAVR1        FINE                                             
*                                                                               
         MVI   ERROR,PWECONBY      CONTRACT/CONTRULE REQUIRES BUY-ENTRY         
         L     R2,ALASTCOL                                                      
         GOTO1 CURSERR                                                          
*                                                                               
NTFLAVR1 DS    0H                                                               
*=====================================================================          
* CHECK TO SEE IF A NO PRINT COLUMN IS TO BE GENERATED.. SEE COMMENT            
* AT VROW8A                                                                     
*=====================================================================          
*                                                                               
* IF FILTERING ON PUBLISHER, A PUBLISHER RELATED ENTRY MUST HAVE BEEN           
*  ENTERED AS A HEADER,MID,ROW OR COLUMN.  MAY CAUSE CONFUSION                  
*                                                                               
         OC    PBQPBLSH,PBQPBLSH   FILTER ON PUBLISHER                          
         BZ    NOPUBLSH                                                         
         CLI   PBABUFFS,255                                                     
         MVI   PBABUFFS,0                                                       
         BE    NOPUBLSH                                                         
         MVI   ERROR,PWEPBLNE     PUBLISHER ENTRY M/B ENTERED                   
         L     R2,ALASTCOL                                                      
         GOTO1 CURSERR                                                          
*                                                                               
NOPUBLSH CLI   OFFLINE,C'Y'                                                     
         BNE   WIDTHCK                                                          
*                                                                               
         CLI   PBQSPCTL,C'C'       CREATE ELEMENT                               
         BNE   WIDTHCK                                                          
*                                                                               
         XC    BLOCK(42),BLOCK                                                  
         MVC   BLOCK(2),=X'0802'   LENGTH OF SPLIT FIELD                        
         MVC   BLOCK+12(30),SPACES                                              
         MVC   BLOCK+12(8),=C'LIN/INCH'                                         
         MVC   BLOCK+22(2),=C'NP'                                               
*                                                                               
         LA    RE,WIDTHCK               FORCE TO RETURN                         
         LA    R4,BLOCK                                                         
*                                                                               
         GOTO1 VCOLDRON                                                         
         CLI   DRERROR,0                                                        
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         NI    DRFLAGO,X'FF'-X'80'                                              
         NI    DRHEAD1,X'FF'-X'80'                                              
         NI    DRHEAD2,X'FF'-X'80'                                              
         NI    DRHEAD3,X'FF'-X'80'                                              
         NI    DRHEAD4,X'FF'-X'80'                                              
*                                                                               
* MAY NEED TO ALTER WIDTH                                                       
*                                                                               
         MVI   DRLABELI,C'Z'                                                    
         GOTO1 GCOLDRON                                                         
         CLI   DRERROR,0                                                        
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
WIDTHCK  DS    0H                                                               
*                                                                               
         CLC   TOTWIDTH,=H'80'     CHECK NOT TOO BIG NOW                        
         BNH   VVALCOLX                                                         
         CLI   NARROPT,C'Y'        ONLY 80 ALLOWED WITH NARROW OPT              
         BE    VVALCBIG                                                         
         CLC   TOTWIDTH,=H'132'    CHECK NOT TOO BIG NOW                        
         BNH   VVALCOLX                                                         
         CLI   WIDEOPT,C'Y'                                                     
         BE    *+8                                                              
         CLI   DOWNOPT,C'Y'        DOWN OPTION                     L17          
         BNE   VVALCBIG                                                         
         CLC   TOTWIDTH,=H'165'                                                 
         BNH   VVALCOLX                                                         
         CLI   DOWNOPT,C'Y'        DOWN OPTION                     L17          
         BNE   VVALCBIG                                            L17          
*****    CLC   TOTWIDTH,=H'255'                                    L17          
*****    BNH   VVALCOLX                                            L17          
         B     VVALCOLX                                                         
*                                                                               
VVALCBIG DS    0H                  REPORT TOO WIDE                              
         LHI   RF,PWEBIGGG                                                      
         STCM  RF,3,GTMSGNO        SET ERROR MESSAGE                            
         XC    ELEMENT,ELEMENT                                                  
         LA    R1,ELEMENT                                                       
         STCM  R1,7,GTASUBST       A(SUBST TEXT)                                
         MVI   ELEMENT,4           L'SUBST TEXT + 1                             
         EDIT  (2,TOTWIDTH),(3,ELEMENT+1)                                       
*                                                                               
         L     R2,ALASTCOL                                                      
         MVI   ERROR,X'FE'         WE SET ERROR MESSAGE                         
         B     VVCOLERR                                                         
*                                                                               
VCOLSTKE DS    0H                  STACKING MORE COLS THAN EXIST                
         MVI   ERROR,PWESTKE3                                                   
         MVI   FIELDERR,0          FORCE START OF FIELD POINTER                 
         LA    R2,WRICOLSH         POINT TO COLUMN A                            
         B     VVCOLERR                                                         
*                                                                               
VCOLND1E DS    0H                  NEED AT LEAST 1 COLUMUN ENTRY                
         MVI   ERROR,PWENEED1        AND IT MUST BE IN COL A.                   
         MVI   FIELDERR,0          FORCE START OF FIELD POINTER                 
         LA    R2,WRICOLSH         POINT TO COLUMN A                            
         B     VVCOLERR                                                         
*                                                                               
VCOLCONX DS    0H                  CONTRACT FLAVOR NEDDS CON-KEYWORD            
         MVI   ERROR,PWECONX                                                    
         L     R2,ALASTCOL                                                      
         B     VVCOLERR                                                         
*                                                                               
VVCOLERR DS    0H                                                               
         GOTO1 CURSERR                                                          
*                                                                               
VVALCOLX DS    0H                                                               
         XIT1                                                                   
         EJECT                                                                  
VVALPEX  LTR   RB,RB                                                            
         XIT1                                                                   
         EJECT                                                                  
VGENHEAD DS    0H                                                               
         GOTO1 VGENHD                                                           
         B     XIT                                                              
*                                                                               
VGENFOOT DS    0H                  FOOTING ROUTINE                              
*                                                                               
         GOTO1 VGENFT                                                           
*                                                                               
         XIT1                                                                   
*                                                                               
* OTHER DATA HANDLING ROUTINES                                                  
*                                                                               
VNUMERIC TM    4(R2),X'08'                                                      
         BO    VPACK                                                            
         MVI   ERROR,NOTNUM                                                     
         B     THEEND                                                           
*                                                                               
VPACK    SR    R3,R3                                                            
         IC    R3,5(R2)                                                         
         SR    R1,R1                                                            
         ZAP   DUB,=P'0'                                                        
         LTR   R3,R3                                                            
         BZ    XITR1                                                            
         BCTR  R3,R0                                                            
         EX    R3,*+8                                                           
         B     *+10                                                             
         PACK  DUB,8(0,R2)                                                      
         CVB   R1,DUB                                                           
*                                                                               
XITR1    XIT1  REGS=(R1)                                                        
CMMON    DC    A(COMMON1)                                                       
         EJECT                                                                  
* DRONE UTILITIES                                                               
*                                                                               
*                                                                               
VINTDRON MVI   DRWHO,DRPRTWHO      INITIALIZATION                               
         MVI   DRACTION,DRINIT                                                  
         MVC   DRDICT,=CL8'PRWRI'                                               
         MVC   DRALTDIC,=CL8'DRIVER'                                            
         MVC   DRCOMFAC,ACOMFACS                                                
         MVC   DRMAXWID,=H'999'    FORCE BIG - I CHECK WIDTH                    
         MVI   DRCMPMAX,C'N'       MAX COL FOR COMPS                            
***                                                                             
*                                                                               
* SET SECURITY BLOCK ONCE... FOR NOW ONLY DRCOLS AND DRROWS LOOK                
* AT THE SECURITY BLOCK                                                         
***                                                                             
***      CLI   OFFLINE,C'Y'     SKIP IF OFF-LINE                                
***      BE    VINTDR10                                                         
***                                                                             
***      OC    T405FFD+4(2),T405FFD+4    ON NEW SECURITY?                       
***      BNZ   *+14                      YES                                    
***      OC    TWAACCS(2),TWAACCS      IF ON LIMIT ACCESS                       
***      BZ    *+10                      NO, DO NOT PASS SECRET BLOCK           
*                                                                               
****     TM    PBQFLOPT,PBQFLOUT   SKIP IF DOING FILE OPTION                    
****     BO    *+10                                                             
         XC    DRSECBLK,DRSECBLK   DON'T PASS ANY ADDRESS TO DRONE              
******   MVC   DRSECBLK,ASECBLK    PASS A(SECRET) TO DRONE                      
*                                                                               
VINTDR10 DS    0H                                                               
*                                                                               
         GOTO1 DRONE,DMCB,DRGEN                                                 
*                                                                               
         B     XIT                                                              
*                                                                               
VVRWDRON MVI   DRACTION,DRROW      VALIDATE A ROW                               
         B     ALLVAL                                                           
*                                                                               
VGRWDRON MVI   DRACTION,DRGENROW   GENERATE A ROW                               
         B     ALLDRONE                                                         
*                                                                               
VVCLDRON MVI   DRACTION,DRCOL      VALIDATE A COLUMN                            
         B     ALLVAL                                                           
*                                                                               
VGCLDRON MVI   DRACTION,DRGENCOL   GENERATE A COLUMN                            
         B     ALLDRONE                                                         
*                                                                               
VVCMDRON MVI   DRACTION,DRCMP      VALIDATE A COMP                              
         B     ALLVAL                                                           
*                                                                               
VGCMDRON MVI   DRACTION,DRGENCMP   GENERATE A COMP                              
         B     ALLVAL              (LOOKS LIKE A VALIDATION)                    
*                                                                               
VGUSDRON MVI   DRACTION,DRUSER     GENERATE USER ELEMENTS                       
         B     ALLDRONE                                                         
*                                                                               
VWRPDRON MVI   DRACTION,DRWRAPUP   WRAP UP                                      
         GOTO1 DRONE,DMCB,DRGEN                                                 
*                                                                               
         CLI   OFFLINE,C'Y'        SKIP IF ON-LINE                              
         BNE   VWRPDRN1                                                         
*                                                                               
         GOTO1 VTRACDRN            (OPTIONAL TRACE)                             
*                                                                               
VWRPDRN1 DS    0H                                                               
*                                                                               
         B     XIT                                                              
         EJECT                                                                  
* MORE DRONE UTILITIES                                                          
*                                                                               
ALLVAL   XC    WORK,WORK           GENERATE A PSEUDO TWA HEADER                 
         MVC   WORK+5(1),0(R4)     (PASS THROUGH THE LENGTH)                    
         MVC   WORK+8(10),12(R4)                                                
         LA    R1,WORK                                                          
         ST    R1,DRPRTFLD                                                      
         OI    DRFLAGS,DREXPDIC    TELL DRONE TO EXPLODE DICT.                  
*                                                                               
         MVC   DRSECBLK,ASECBLK    PASS A(SECRET) TO DRONE                      
*                                                                               
         GOTO1 DRONE,DMCB,DRGEN                                                 
*                                                                               
         CLI   DRERROR,ERRSECUR    SECURITY ERROR?                              
         BNE   AVAL10              NO                                           
*                                                                               
         MVI   ERROR,SECLOCK       SECURITY LOCKOUT                             
         GOTO1 CURSERR                                                          
*                                                                               
AVAL10   DS    0H                                                               
*                                                                               
         BAS   RE,SETREAD                                                       
         B     XIT                                                              
*                                                                               
ALLDRONE GOTO1 DRONE,DMCB,DRGEN                                                 
         B     XIT                 USER NEEDS TO TEST DRERROR                   
*                                                                               
BADDRONE MVC   CONHEAD,DRERRMSG    ERROR - SO SHOW WHAT DRONE PASSED            
         B     MYCURSOR                                                         
*                                                                               
         TITLE 'SET READ SWUTCHES FROM DICTIONARY - SETREAD'                    
***********************************************************************         
*                                                                     *         
*        ROUTINE TO SET READ SWITCHES FROM DICTIONARY                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
SETREAD  NTR1  LABEL=*                                                          
*==============================================                                 
*=== NOTE ARGUMENT DETERMINES WHAT RECORD TO READ                               
*==============================================                                 
*                                                                               
         CLI   DRARGSI,C'B'        TEST BUY RECORD FIELD                        
         BE    *+8                                                              
         CLI   DRARGSI,C'K'        TEST BUY RECORD FIELD                        
         BE    *+8                                                              
         CLI   DRARGSI,C'J'        TEST BUY RECORD FIELD                        
         BE    *+8                                                              
         CLI   DRARGSI,C'N'        TEST BUY RECORD FIELD                        
         BE    *+8                                                              
         CLI   DRARGSI,C'M'        TEST BUY RECORD FIELD                        
         BE    *+8                                                              
         CLI   DRARGSI,C'I'        TEST BUY RECORD FIELD                        
         BNE   SRBUYX                                                           
*                                                                               
         CLC   =C'SPACE',WORK+8    EXCEPT FOR SPACE                             
         BNE   *+8                                                              
         CLI   PBFLAVOR,C'O'       AND CONTRACT ONLY DATA                       
         BE    SRBUYX                                                           
*                                                                               
         TM    PBQREAD,PBQRDBLS+PBQRDBUY  SKIP IF BUYS & BILLS ALREADY          
         BO    SRBUY10                                                          
*                                                                               
         CLI   DRACTION,DRCOL      IF PROCESSING COLUMN                         
         BNE   SRBUY10                                                          
*                                                                               
         CLI   DRTYPEO,C'N'           NO PROBLEMS IF NUMERIC DATA               
         B     SRBUY10                                                          
******   BE    SRBUY10                                                          
*                                                                               
         TM    PBQREAD,PBQRDBLS    ELSE CAN'T MIX BUY                           
         BO    SRMIXER                AND BILL HEADER DATA                      
*                                                                               
SRBUY10  DS    0H                                                               
*                                                                               
         OI    PBQREAD,PBQRDBUY                                                 
*                                                                               
SRBUYX   DS    0H                                                               
*                                                                               
         CLI   DRARGSI,C'C'        TEST CONTRACT RECORD READ        L01         
         BNE   *+8                                                  L01         
         OI    PBQREAD,PBQRDCON                                     L01         
*                                                                               
         CLI   DRARGSI,C'O'        TEST OTHER AGENCY RECORD TO BE RD            
         BNE   *+8                                                              
         OI    PBQREAD,PBQRDOAN                                                 
*                                                                               
         CLI   DRARGSI,C'P'        PUBMAS RECORD                                
         BNE   *+8                                                              
         OI    PBQREAD,PBQRDPUB                                                 
*                                                                               
         CLI   DRARGSI,C'W'        ISSUE  RECORD                                
         BNE   *+8                                                              
         OI    PBQREAD,PBQRDISS+PBQRDBUY ALSO READ BUYS                         
*                                                                               
         CLI   DRARGSI,C'F'        CIRCULATION  RECORD                          
         BNE   *+8                                                              
         OI    PBQREAD2,PBQRDCRC                                                
*                                                                               
         CLI   DRATTRIB,C'$'        IS THIS A DOLLAR TYPE                       
         BNE   SRDLRN                                                           
*                                                                               
         CLI   DRARGSI+1,C'1'      OPEN RATES FOR FINANCIAL CLIENT              
         BL    *+8                                                              
         MVI   PBFINAN,C'Y'                                                     
*                                                                               
         CLC   DRRTNI,=CL8'IREBATE'  DIFFERENCE BTWN OPEN AND CONTRACT          
         BNE   *+8                                                              
         MVI   PBFINAN,C'Y'                                                     
*                                                                               
SRDLRN   DS    0H                                                               
*                                                                               
         CLI   DRARGSI,C'L'        IF BILL RECORD FIELD                         
         BNE   SRBLLX                                                           
         B     SRBLL05                                                          
*                                                                               
         CLI   PBQDATYP,C'1'       DATE TYPE MUST BE MONTH OF SERVICE           
         BE    *+8                                                              
         CLI   PBQDATYP,C'L'       OR BILLED DATES                              
         BNE   SRDATEER                                                         
*                                                                               
SRBLL05  DS    0H                                                               
*                                                                               
         TM    PBQREAD,PBQRDBLS+PBQRDBUY  SKIP IF BUYS & BILLS ALREADY          
         BO    SRBLL10                                                          
*                                                                               
         CLI   DRACTION,DRCOL      IF PROCESSING COLUMN                         
         BNE   SRBLL10                                                          
*                                                                               
         CLI   DRTYPEO,C'N'           NO PROBLEMS IF NUMERIC DATA               
         B     SRBLL10                                                          
*******  BE    SRBLL10                                                          
*                                                                               
         TM    PBQREAD,PBQRDBUY    ELSE CAN'T MIX BUY                           
         BO    SRMIXER                AND BILL HEADER DATA                      
*                                                                               
SRBLL10  DS    0H                                                               
*                                                                               
         OI    PBQREAD,PBQRDBLS                                                 
*                                                                               
SRBLLX   DS    0H                                                               
*                                                                               
         CLI   DRARGSI,C'Z'        TEST BUCKETS RECORD FIELD                    
         BNE   *+8                                                              
         OI    PBQREAD,PBQRDBKS                                                 
*                                                                               
         CLI   DRACTION,DRROW      TEST VALIDATING A ROW                        
         BNE   SRROWX                                                           
*                                                                               
         ZIC   RE,LEVEL            YES - AUGMENT THE LEVEL NUMBER               
         LA    RE,1(RE)                                                         
         STC   RE,LEVEL                                                         
*                                                                               
         CLC   =C'CLT',WORK+8      TEST ROW = CLIENT                            
         BNE   *+10                                                             
         MVC   CLTLEV,LEVEL        YES - RECORD THE CLIENT LEVEL                
*                                                                               
SRROWX   DS    0H                                                               
*                                                                               
         B     SETREADX                                                         
*                                                                               
SRDATEER DS    0H                                                               
         MVI   ERROR,PWEBLDTP      NOT BILL HEADER DATE TYPE                    
         LA    R2,WRIDTYH          POINT TO DATE TYPE FIELD                     
         B     SRERR                                                            
*                                                                               
SRMIXER  DS    0H                                                               
         MVI   ERROR,PWEMIXED        AND BILL HEADER DATA                       
*                                                                               
SRERR    DS    0H                                                               
         GOTO1 ERREX                                                            
*                                                                               
SETREADX XIT1                                                                   
         EJECT                                                                  
*                                                                               
* INITIALIZE TO RUN DRIVER - LOADS PHASES                                       
*                            SETS GLOBAL ADDRESSES                              
*                                                                               
VINTDRIV DS    0H                                                               
*                                                                               
DRIX     B     XIT                                                              
         EJECT                                                                  
* POSITION CURSOR TO CORRECT FIELD IN ERRORS                                    
* INPUT  : R2 = A(SCREEN HEADER)                                                
*          FIELDERR = NUMBER OF FIELD IN ERROR                                  
*                                                                               
VCURSERR CLI   FIELDERR,0          APPLICATION MUST SET FIELD NUMBER            
         BE    VERRXIT                                                          
         CLI   OFFLINE,C'Y'                                                     
         BE    VERRXIT                                                          
         LR    RE,R4               SAVE BLOCK ADDRESS                           
***      =================  ***                                                 
         L     R4,ATIOB                                                         
         USING TIOBD,R4                                                         
***      =================  ***                                                 
         OI    6(R2),X'80'         TRANSMIT ERROR FIELD HEADER                  
         OI    TIOBINDS,TIOBSETC   INSTRUCT CURSOR SETTING                      
         LR    RF,R2                                                            
         S     RF,ATWA                                                          
         STCM  RF,3,TIOBCURD       DISPLACEMENT FROM START OF TWA               
         MVC   TIOBCURI,FIELDERR                                                
         CLI   4(RE),0              USING X'80' IN HIGH ORDER BYTE              
         BE    CURSEOVR             IN SECOND WORD OF SCANNER CALL              
*                                   SEE OPTION VALIDATION ROUTINE               
*                                                                               
         B     VERRXIT                                                          
**                                                                              
***                                                                             
****   BYPASS REST OF LOGIC..                                                   
***                                                                             
**                                                                              
CURSEOVR LA    RE,8(R2)                                                         
         SR    R1,R1               COMPUTE FIELD DISPLACEMENT INTO R1           
         ZIC   R0,5(R2)            R0 HAS FIELD LENGTH                          
         ZIC   RF,FIELDERR                                                      
         BCT   RF,CURSERR2         CHECK IF ERROR IS IN FIELD 1                 
         B     CURSERR6                                                         
*                                                                               
CURSERR2 CLI   0(RE),C','          SCAN FOR THE COMMAS                          
         BNE   CURSERR4                                                         
         BCT   RF,CURSERR4                                                      
         LA    R1,1(R1)            FOUND ENOUGH - SPACE PAST LAST               
         B     CURSERR6                                                         
*                                                                               
CURSERR4 LA    R1,1(R1)                                                         
         LA    RE,1(RE)                                                         
         BCT   R0,CURSERR2                                                      
         SR    R1,R1               ERROR - DIDN'T FIND ENOUGH COMMAS            
*                                                                               
CURSERR6 STC   R1,TIOBCURI         SET CURSOR DISPLACEMENT WITHIN FIELD         
         B     VERRXIT                                                          
         EJECT                                                                  
* COMMON EXIT ROUTINES                                                          
*                                                                               
BUMP     ZIC   RF,0(R2)            GET TO NEXT SCREEN FIELD                     
         AR    R2,RF                                                            
         BR    RE                                                               
*                                                                               
FINV     MVI   ERROR,INVALID                                                    
         B     THEEND                                                           
*                                                                               
MYEND    MVI   ERROR,X'FE'                                                      
         B     THEEND                                                           
*                                                                               
MYCURSOR MVI   ERROR,X'FE'                                                      
         GOTO1 CURSERR                                                          
*                                                                               
THEEND   B     VEXIT                                                            
*                                                                               
VERRXIT  DS    0H                                                               
         OC    GTMSGNO,GTMSGNO     USE NEW ERROR IF PRESENT                     
         JNZ   NEWTRAP                                                          
         CLI   ERROR,X'FE'                                                      
         BE    VERRX2                                                           
VEXIT2   DS    0H                                                               
         B     TRAPERR                                                          
NEWTRAP  DS    0H                                                               
         OI    GENSTAT2,USGETTXT                                                
         MVI   GTMSYS,25           SET SYSTEM FOR MESSAGES                      
*                                                                               
TRAPERR  DS    0H                                                               
         GOTO1 ERREX               SYSTEM MESSAGE                               
*                                                                               
*                                                                               
VEXIT    OI    6(R2),X'40'         POSITION CURSOR                              
         CLI   ERROR,X'FE'                                                      
         BNE   VEXIT2                                                           
VERRX2   GOTO1 ERREX2              MY OWN ERROR MESSAGE                         
*                                                                               
*                                                                               
*                                                                               
NEXIT    LTR   RB,RB                                                            
         B     XIT                                                              
*                                                                               
EQXIT    CR    RB,RB                                                            
         B     XIT                                                              
*                                                                               
XIT      XIT1                                                                   
*                                                                               
         GETEL (R5),DATADISP,ELCODE                                             
*                                                                               
         EJECT                                                                  
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
*===================================================*                           
* SUBROUTINE MOVES REC AT R2 TO R1 FOR LENGTH IN R0 *                           
* RETURN ON RE (R0-R2 AND RF ARE DESTROYED)         *                           
*===================================================*                           
         SPACE 1                                                                
MOVEREC  LA    RF,256                                                           
         CR    R0,RF                                                            
         BNH   MOVEREC2                                                         
         MVC   0(256,R1),0(R2)                                                  
         AR    R1,RF                                                            
         AR    R2,RF                                                            
         SR    R0,RF                                                            
         B     MOVEREC                                                          
*                                                                               
MOVEREC2 LTR   RF,R0                                                            
         BZR   RE                                                               
         BCTR  RF,0                                                             
         EX    RF,*+6                                                           
         BR    RE                                                               
         MVC   0(0,R1),0(R2) *EXECUTED*                                         
         SPACE 2                                                                
*==================================================                             
* SUBROUTINE CLEARS BUFFER AT R1 FOR LENGTH IN R0 *                             
*==================================================                             
         SPACE 1                                                                
CLRBUFF  LA    RF,256                                                           
         CR    R0,RF                                                            
         BNH   CLRBUFF2                                                         
         XC    0(256,R1),0(R1)                                                  
         AR    R1,RF                                                            
         SR    R0,RF                                                            
         BP    CLRBUFF                                                          
*                                                                               
CLRBUFF2 LTR   RF,R0                                                            
         BZR   RE                                                               
         BCTR  RF,0                                                             
         EX    RF,*+6                                                           
         BR    RE                                                               
         XC    0(0,R1),0(R1) *EXECUTED*                                         
         EJECT                                                                  
REGSPECS DS    0C                                                               
         SSPEC H1,2,RUN            SPECS FOR REGULAR PRINTING                   
         SSPEC H2,2,REQUESTOR                                                   
         SSPEC H1,97,AGYNAME                                                    
         SSPEC H2,97,AGYADD                                                     
         SSPEC H4,97,REPORT                                                     
         SSPEC H4,110,PAGE                                                      
         DC    X'00'                                                            
*                                                                               
NARSPECS DS    0C                                                               
         SSPEC H1,60,RUN           SPECS FOR NARROW PRINTING                    
         SSPEC H2,60,REQUESTOR                                                  
         SSPEC H4,60,REPORT                                                     
         SSPEC H4,73,PAGE                                                       
         DC    X'00'                                                            
*                                                                               
WIDSPECS DS    0C                                                               
         WSPEC H1,2,RUN            SPECS FOR WIDE PRINTING                      
         WSPEC H2,2,REQUESTOR                                                   
         WSPEC H1,129,AGYNAME                                                   
         WSPEC H2,129,AGYADD                                                    
         WSPEC H4,129,REPORT                                                    
         WSPEC H4,142,PAGE                                                      
         DC    X'00'                                                            
         EJECT                                                                  
THISCONT DC    C'  ',C' ',X'01',C' '          NO COMMENT ON CONT FLAVOR         
*                1234567890       123456789ABCDEF0123456          L01           
DATECODE DC    C'PD',C'A',X'0A',C'PAID DATES'                    L01            
         DC    C'BL',C'B',X'0E',C'BILLABLE DATES'                L01            
         DC    C'CL',C'C',X'0D',C'CLOSING DATES'                L01             
         DC    C'ID',C'I',X'0C',C'INSERT DATES'                L01              
         DC    C'ID',C'I',X'0D',C'POSTING DATES'  OUTDOOR EXPRESSION            
         DC    C'BD',C'L',X'0C',C'BILLED DATES'                L01              
         DC    C'MC',C'M',X'10',C'MATERIAL CLOSING'            L01              
         DC    C'IO',C'O',X'12',C'INSERT ORDER DATES'         L01               
         DC    C'PY',C'P',X'0D',C'PAYABLE DATES'                L01             
         DC    C'OS',C'S',X'0E',C'ON STAND DATES'                L01            
         DC    C'EB',C'T',X'12',C'PAID AND/OR BILLED'          L01              
         DC    C'UP',C'U',X'06',C'UNPAID'                 L01                   
         DC    C'CP',C'X',X'0E',C'CONTRACT START'                L01            
         DC    C'BB',C'Z',X'0F',C'PAID AND BILLED'          L01                 
         DC    C'MS',C'1',X'10',C'MONTH OF SERVICE'          L01                
         DC    X'FFFF'                                              L01         
         EJECT                                                                  
         DS    0D                                                               
COMMON1  NMOD1 0,00CM,R7                                                        
*****                                                                           
**   ON ENTRY WORD1 CONTAINS DISPLACEMENT                                       
**                           0000 = DELINS                                      
**                           0004 = REPLACED                                    
**                           000C = FLOWCHARTING                                
**                           0010=  CLIENT VALIDATION                           
**                           0014=  ESTIMATE VALIDATION                         
**                           0018=  PUB VALIDATION                              
**                           0024=  ADD VALUE TO LEVELTYP                       
*****                                                                           
***      =================  ***                                                 
         USING SPOOLD,R8                                                        
         USING GEND,RC                                                          
         USING SYSD,R9                                                          
         USING T405FFD,RA                                                       
***      =================  ***                                                 
         LA    RC,SPOOLEND                                                      
         L     RF,0(R1)                                                         
         LA    RE,TABLEI                                                        
         B     0(RF,RE)                                                         
*                                                                               
TABLEI   B     DELINSS                                                          
         DC    AL4(0)              INACTIVE                                     
         DC    AL4(0)              INACTIVE                                     
         DC    AL4(0)              INACTIVE                                     
         DC    AL4(0)              INACTIVE                                     
         B     VVVALEST                                                         
         DC    AL4(0)              INACTIVE                                     
         DC    AL4(0)              INACTIVE                                     
         EJECT                                                                  
*----------> VALIDATE ESTIMATE                                                  
VVVALEST XC    PBQESTB,PBQESTB                                                  
         XC    PBQESTBX,PBQESTBX                                                
         MVC   PBQEST,SPACES                                                    
         MVC   PBQESTX,SPACES                                                   
         CLI   5(R2),0             DEFAULT IS EST=SPACES                        
         BE    XXEQEXIT                                                         
         MVI   ERROR,INVEST                                                     
         XC    BLOCK(256),BLOCK                                                 
         GOTO1 SCANNER,DMCB,(20,(R2)),(2,BLOCK),C',=,='                         
         CLI   4(R1),1                                                          
         BL    XXNEXIT                                                          
         CLI   4(R1),2                                                          
         BH    XXNEXIT                                                          
         LA    R3,BLOCK                                                         
         CLI   0(R3),3                                                          
         BH    XXNEXIT                                                          
         TM    2(R3),X'80'         TEST NUMERIC                                 
         BO    VE30                                                             
         CLI   1(R3),0             NO                                           
         BNE   XXNEXIT                                                          
         CLC   12(3,R3),=C'NO '    TEST 'NO'                                    
         BE    VE10                YES - EST=SPACES                             
         MVC   PBQEST,12(R3)                                                    
         CLC   PBQEST,=C'ALL'      TEST 'ALL' - YES, EST=ALL                    
         BNE   XXNEXIT             NO - INVALID                                 
*                                                                               
VE10     CLI   4(R1),2             TEST ESTIMATE FILTER                         
         BNE   XXEQEXIT                                                         
         LA    R3,42(R3)           YES                                          
         CLI   1(R3),0                                                          
         BNE   XXNEXIT                                                          
         LA    RE,3                SET ESTIMATE FILTERS                         
         LA    RF,PBQESTX                                                       
         ZIC   R0,0(R3)                                                         
         LA    R4,12(R3)                                                        
*                                                                               
VE15     CLI   0(R4),C'-'                                                       
         BNE   VE20                                                             
         BCT   R0,*+8                                                           
         B     XXNEXIT                                                          
         LA    R4,1(R4)                                                         
         NI    0(R4),X'FF'-X'40'                                                
*                                                                               
VE20     MVC   0(1,RF),0(R4)                                                    
         LA    R4,1(R4)                                                         
         BCT   R0,*+8                                                           
         B     XXEQEXIT                                                         
         LA    RF,1(RF)                                                         
         BCT   RE,VE15                                                          
         B     XXNEXIT                                                          
*                                                                               
VE30     CLI   1(R3),0             NUMERIC                                      
         BNE   XXNEXIT                                                          
         CLC   4(4,R3),=F'999'                                                  
         BH    XXNEXIT                                                          
         MVC   PBQESTB,6(R3)                                                    
         EDIT  (2,PBQESTB),(3,PBQEST)                                           
         XC    PBQESTX,PBQESTX     CLEAR EST END                                
         MVI   PBQESTBX,0                                                       
         CLI   4(R1),1             TEST ANOTHER ESTIMATE NUMBER                 
         BE    VE40                                                             
         LA    R3,42(R3)                                                        
         CLI   1(R3),0                                                          
         BNE   XXNEXIT                                                          
         TM    2(R3),X'80'                                                      
         BZ    XXNEXIT                                                          
         CLC   4(4,R3),=F'999'     YES                                          
         BH    XXNEXIT                                                          
         MVC   PBQESTBX,6(R3)      SET EST END                                  
         CLC   PBQESTB,PBQESTBX                                                 
         BNL   XXNEXIT                                                          
         EDIT  (2,PBQESTBX),(3,PBQESTX)                                         
         B     XXEQEXIT                                                         
*                                                                               
VE40     CLC   PBQPRD,=C'ALL'      SINGLE ESTIMATE - CHECK SINGLE PRD           
         BE    XXEQEXIT            WAS TRAPERR                                  
         CLI   PBQMED,C'*'                                                      
         BE    XXEQEXIT                                                         
         CLI   PBQMED,C'C'                                                      
         BE    XXEQEXIT                                                         
         CLC   PBQCLT,=C'ALL'      CHECK SINGLE CLIENT                          
         BE    XXEQEXIT                                                         
         CLI   PBQCLT,C'*'                                                      
         BE    XXEQEXIT                                                         
**** WILD CARD CHECK                                                            
         CLI   WILDCARD,C'W'                                      L13           
         BE    XXEQEXIT          UNABLE TO VERIFY IF WILD         L13           
****                                                                            
         CLI   PBQCLT,C'&&'                                                     
         BE    XXEQEXIT                                                         
         CLI   PBQCLT,C'$'                                                      
         BE    XXEQEXIT                                                         
*                                                                               
         XC    KEY,KEY             GET ESTIMATE RECORD                          
***      =================  ***                                                 
         LA    R4,KEY                                                           
         USING PESTKEY,R4                                                       
***      =================  ***                                                 
         MVC   PESTKAGY,AGENCY                                                  
         MVI   PESTKRCD,X'07'                                                   
         MVC   PESTKCLT,PBQCLT                                                  
         MVC   PESTKPRD,PBQPRD                                                  
         MVC   PESTKEST,PBQESTB                                                 
*                                                                               
         BRAS  RE,CLTMED           FIND FIRST MEDIA                             
*                                                                               
VESMEDLP DS    0H                                                               
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(25),KEYSAVE                                                  
         BE    VESMEDFD                                                         
*                                                                               
VESMEDCN DS    0H                                                               
*                                                                               
         MVC   KEY,KEYSAVE         RESTORE STARTING KEY                         
*                                                                               
         BRAS  RE,CLTMED           FIND NEXT MEDIA                              
         BE    VESMEDLP                                                         
*                                                                               
VESMEDDN DS    0H                                                               
         B     XXNEXIT                                                          
*                                                                               
VESMEDFD DS    0H                                                               
*                                                                               
         MVC   SVESTDA,KEY+27         SAVE EST KEY ADDRESS                      
         B     XXEQEXIT                                                         
*                                                                               
         DROP  R4                                                               
*                                                                               
         EJECT                                                                  
         EJECT                                                                  
XXNEXIT  LTR   RB,RB                                                            
         B     XRETURN                                                          
XXEQEXIT CR    RE,RE                                                            
XRETURN  XIT1                                                                   
**                                                                              
GOGETEL  DS    0H                                                               
         SR    R0,R0                                                            
         LA    R5,33(R5)                                                        
         B     NEXTXL3                                                          
*******                                                                         
NEXTXL2  SR    R0,R0                                                            
         ICM   R0,1,1(R5)                                                       
         BNZ   *+6                                                              
         DC    H'0'                                                             
         AR    R5,R0                                                            
NEXTXL3  CLI   0(R5),0                                                          
         BE    NEXTXL1                                                          
         CLC   ELCODE,0(R5)                                                     
         BER   RE                                                               
         B     NEXTXL2+2                                                        
NEXTXL1  LTR   R5,R5                                                            
         BR    RE                                                               
*                                                                               
         EJECT                                                                  
*******************************************************                         
*              INSERT DELETE UNPROTECTED FIELDS       *                         
*******************************************************                         
         SPACE 3                                                                
*              INPUT               R2=A(FIRST UNPROTECTED FIELD)                
*                                  MAX=NUMBER OF INPUT FIELDS                   
         SPACE 1                                                                
DELINSS  DS    0H                                                               
         CLI   OFFLINE,C'Y'                                                     
         BE    XXITT                                                            
         CLI   PFAID,3             WAS PF3 OR PF4 HIT                           
         BE    DI2                                                              
         CLI   PFAID,4                                                          
         BE    DI2                                                              
         CLI   PFAID,15            PF15 PF16 EQUIVALENT                         
         BE    DI2                                                              
         CLI   PFAID,16                                                         
         BNE   XXITT                                                            
         SPACE 1                                                                
***      =================  ***                                                 
DI2      L     R4,ATIOB                                                         
         USING TIOBD,R4                                                         
***      =================  ***                                                 
         LH    R4,TIOBCURD         PICK UP RELATIVE DISPLACEMENT                
         AR    R4,RA               INTO TWA                                     
         ZIC   R0,MAX                                                           
         SPACE 1                                                                
DI4      CR    R2,R4                                                            
         BE    DI6                                                              
         BAS   RE,BUMPTOUN                                                      
         BCT   R0,DI4                                                           
         B     XXITT               (NOT IN THIS PART OF THE SCREEN)             
         SPACE 1                                                                
DI6      CLI   PFAID,3                                                          
         BE    DEL2                                                             
         CLI   PFAID,15                                                         
         BE    DEL2                                                             
         XC    BLOCK(80),BLOCK                                                  
         SPACE 1                                                                
INS2     MVC   BLOCK+80(80),8(R2)  SAVE THIS FIELD                              
         ZIC   R1,0(R2)            GET L'FIELD-1 INTO R1                        
         SH    R1,=H'9'                                                         
         TM    1(R2),X'02'                                                      
         BNO   *+8                                                              
         SH    R1,=H'8'                                                         
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   8(0,R2),BLOCK       MOVE IN PREVIOUS (OR CLEAR)                  
         OI    6(R2),X'80'                                                      
         MVC   BLOCK(80),BLOCK+80                                               
         BAS   RE,BUMPTOUN                                                      
         BCT   R0,INS2                                                          
         B     INSFOUND                                                         
XXITT    DS    0H                                                               
         XIT1                                                                   
         SPACE 1                                                                
INSFOUND MVC   CONHEAD(L'INSMESS),INSMESS                                       
         L     R4,ATIOB                                                         
         LH    R2,TIOBCURD         PICK UP RELATIVE DISPLACEMENT                
         AR    R2,RA               INTO TWA                                     
         B     VERRX22                                                          
         SPACE 1                                                                
DEL2     LR    R3,R2                                                            
         BAS   RE,BUMPTOUN                                                      
         CLI   5(R2),0                                                          
         BE    DEL4                                                             
         ZIC   R1,0(R3)            GET L'FIELD-1 INTO R1                        
         SH    R1,=H'9'                                                         
         TM    1(R3),X'02'                                                      
         BNO   *+8                                                              
         SH    R1,=H'8'                                                         
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   8(0,R3),8(R2)       MOVE NEXT INTO THIS                          
         OI    6(R3),X'80'                                                      
         BCT   R0,DEL2                                                          
         SPACE 1                                                                
DEL4     EX    R1,*+8                                                           
         B     *+10                                                             
         XC    8(0,R3),8(R3)                                                    
         OI    6(R3),X'80'                                                      
         LR    R2,R3                                                            
         MVC   CONHEAD(L'DELMESS),DELMESS                                       
VERRX22  GOTO1 ERREX2                                                           
         DROP  R4                                                               
*                                                                               
BUMPTOUN ZIC   RF,0(R2)            GET TO NEXT UNPROTECTED FIELD                
         AR    R2,RF                                                            
         CLI   0(R2),0                                                          
         BER   RE                                                               
         TM    1(R2),X'20'                                                      
         BO    BUMPTOUN                                                         
         BR    RE                                                               
         SPACE 3                                                                
INSMESS  DC    C'NEW FIELD INSERTED ON SCREEN'                                  
DELMESS  DC    C'FIELD DELETED ON SCREEN'                                       
         EJECT                                                                  
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
*              ROUTINE TO VALIDATE PERIOD EXPRESSIONS                           
         SPACE 3                                                                
*              INPUT               R4=A(SCANNER ENTRY)                          
*              OUTPUT              RETURN IN EXPLIST                            
*                                  X'00' NOT VALID                              
*                                  X'FF' VALID BUT DATE MISSED                  
*                                  X'NN00' PERIOD NUMBER                        
*                                  OR LIST OF PERIOD NUMBERS                    
         SPACE 1                                                                
*              VALID               W1 THRU W105   SINGLE WEEK                   
*                                  M1 THRU M25           MONTH                  
*                                  Q1 THRU Q8            QUARTER                
*                                  D1 THRU D14           DAYS                   
*                                  YN-N           FLOW   YEAR                   
*                                  WN-N           FLOW   WEEK                   
*                                  MN-N                  MONTH                  
*                                  QN-N                  QUARTER                
*                                  DN-N                  DAYS                   
*                                                                               
         SPACE 1                                                                
         DROP  7                                                                
PEREXP   NMOD1 0,PREXP                                                          
***      =================  ***                                                 
         USING SPOOLD,R8                                                        
         USING GEND,RC                                                          
         USING SYSD,R9                                                          
         USING T405FFD,RA                                                       
***      =================  ***                                                 
         L     RF,0(R1)                                                         
         B     PEREXDIS                                                         
PEREXDIS B     PEREXP1                                                          
         B     PEXCONTI      JUST DO VALIDATION OF RANGE                        
*                                                                               
PEREXP1  LA    RC,SPOOLEND                                                      
***      =================  ***                                                 
         L     R5,PDADATES                                                      
         ST    R5,PBADTLST         PASS IN PRNTBLOCK                            
*                                                                               
         OC    PBQSTART,PBQSTART   SKIP IF NO PERIOD GIVEN                      
         BZ    PEXIT               HAPPENS WITH SYMBOLICS                       
*                                                                               
**********************************************************                      
*                 CREATE WEEK TABLE                      *                      
**********************************************************                      
         USING DATELSTD,R5                                                      
***      =================  ***                                                 
         LA    R6,WEEKLIST                                                      
         MVC   WORK(6),PBQSTART                                                 
         XC    WORK+6(6),WORK+6                                                 
****     ST    R4,SAVEREG4                                                      
         LR    R7,R4               SAVE REGISTER 4                              
         LA    R2,WEEKLIST+51*6    51W * 6                                      
WAGAIN   L     RF,=F'-1'           PRIOR DAY                                    
         GOTO1 ADDAY,DMCB,WORK,WORK+6,(RF)                                      
         GOTO1 DATCON,DMCB,(0,WORK+6),(3,3(R2)) END DATE                        
         L     RF,=F'-6'                        GET BEGINING OF WEEK            
         MVC   WORK(6),WORK+6                                                   
         XC    WORK+6(6),WORK+6                                                 
         GOTO1 ADDAY,DMCB,WORK,WORK+6,(RF)                                      
         GOTO1 DATCON,DMCB,(0,WORK+6),(3,0(R2)) BEGINING DATE                   
         SH    R2,=H'6'            TO PRIOR ENTRY                               
         CR    R6,R2               ENSURE SOME STOP POINT                       
         BH    FWD                                                              
         MVC   WORK(6),WORK+6                                                   
         XC    WORK+6(6),WORK+6                                                 
         B     WAGAIN                                                           
FWD      DS    0H                                                               
*                                                                               
         LA    R2,WEEKLIST+52*6                                                 
         LA    R3,210              210 WEEKS MAX                                
         MVC   WORK(6),PBQSTART                                                 
DATEAGN  LA    RF,6                ADD 6 DAYS                                   
         GOTO1 ADDAY,DMCB,WORK,WORK+6,(RF)                                      
         GOTO1 DATCON,DMCB,(0,WORK),(3,0(R2))                                   
         GOTO1 DATCON,DMCB,(0,WORK+6),(3,3(R2))                                 
         LA    R2,6(R2)            TO NEXT ENTRY                                
         LA    R6,1(R6)            KEEP COUNT OF NUMBER OF ENTRIES              
         LA    RF,1                                                             
         MVC   WORK(6),WORK+6                                                   
         XC    WORK+6(6),WORK+6                                                 
         GOTO1 ADDAY,DMCB,WORK,WORK+6,(RF)                                      
         MVC   WORK(6),WORK+6                                                   
         CLC   WORK+6(6),PBQEND    ENSURE SOME STOP POINT                       
         BH    ADD1YR              ADD                                          
         XC    WORK+6(6),WORK+6                                                 
         BCT   R3,DATEAGN          CANNOT EXCEED  210 WEEKS                     
         MVI   ERROR,PWEPERLG      PERIOD EXCEEDS 210 WEEKS                     
PEXITCOM MVI   EXPLIST,255         FLAG AS ERROR                                
         ST    R4,DMCB+8                                                        
         GOTO1 CURSERR                                                          
***                                                                             
PEXIT    XIT1                                                                   
***                                                                             
PEXITERR MVI   ERROR,PWEDTNV       DATE EXPRESSION ERROR                        
         B     PEXITCOM                                                         
*                                                                               
*                                                                               
ADD1YR   LA    R6,52               ADD 1 YEAR                                   
IDD1YR   LA    RF,6                ADD 6 DAYS                                   
         GOTO1 ADDAY,DMCB,WORK,WORK+6,(RF)                                      
         GOTO1 DATCON,DMCB,(0,WORK),(3,0(R2))                                   
         GOTO1 DATCON,DMCB,(0,WORK+6),(3,3(R2))                                 
         LA    R2,6(R2)            TO NEXT ENTRY                                
         LA    RF,1                                                             
         MVC   WORK(6),WORK+6                                                   
         XC    WORK+6(6),WORK+6                                                 
         GOTO1 ADDAY,DMCB,WORK,WORK+6,(RF)                                      
         MVC   WORK(6),WORK+6                                                   
         XC    WORK+6(6),WORK+6                                                 
         BCT   R6,IDD1YR                                                        
**********************************************************                      
*                 CREATE QUARTER TABLE                    *                     
**********************************************************                      
         MVC   WORK+10(3),PBQBST                                                
         MVC   WORK+13(3),PBQBEND                                               
         ZIC   RF,WORK+10          BACK UP A YEAR                               
         BCTR  RF,0                                                             
         STC   RF,WORK+10                                                       
         ZIC   RF,WORK+13          GO FORWARD A YEAR                            
         LA    RF,1(RF)                                                         
         STC   RF,WORK+13                                                       
         B     PEXQTR                                                           
***                                                                             
PEQEEKL  SR    R2,R2                                                            
         B     PEX2                                                             
***                                                                             
*                                                                               
PEXQTR   DS    0H                                                               
         ZIC   RE,WORK+10         START YEAR                                    
         ZIC   RF,WORK+11       START MONTH                                     
         LA    R2,QURTLIST                                                      
**                                                                              
**                                                                              
PEXQBCT  STC   RE,0(R2)           YEAR TO TABLE                                 
         STC   RF,1(R2)           MONTH                                         
         MVI   2(R2),0            FORCE DAY TO ZERO                             
         LA    RF,2(RF)           INCREMENT MONTH BY 3 MONTHS (QTR)             
         CH    RF,=H'13'          MONTH EXCEEDES 12                             
         BL    PEXQEND                                                          
         SH    RF,=H'12'          CORRECT MONTH                                 
         LA    RE,1(RE)           INCREMENT YEAR                                
PEXQEND  STC   RE,3(R2)                                                         
         STC   RF,4(R2)                                                         
         MVI   5(R2),31            FORCE DAY                                    
         LA    R6,1(R6)            KEEP COUNT OF NUMBER OF ENTRIES              
         CLC   3(2,R2),WORK+13                                                  
         BH    MONTHT                                                           
         LA    R2,6(R2)                                                         
         LA    RF,1(RF)           TO GET TO NEXT MONTH OF QUARTER               
         CH    RF,=H'13'                                                        
         BL    PEXBCT                                                           
         SH    RF,=H'12'           CORRECT THE MONTH                            
         LA    RE,1(RE)            INCREMENT THE YEAR                           
PEXBCT   B     PEXQBCT                                                          
**********************************************************                      
*                 CREATE MONTH  TABLE                    *                      
**********************************************************                      
MONTHT   DS    0H                                                               
         LA    R2,MNTHLIST                                                      
         ZIC   RF,WORK+10         START YEAR                                    
         ZIC   RE,WORK+11       START MONTH                                     
         BCTR  RE,0                                                             
PEXMONA  LA    RE,1(RE)                                                         
         CH    RE,=H'13'           BEYOND DECEMBER                              
         BL    PEXMONST                                                         
         LA    RE,1                MAKE MONTH JAN                               
         LA    RF,1(RF)            INCREMENT YEAR                               
*                                                                               
PEXMONST XC    0(6,R2),0(R2)      NOTE MONTH TABLE START AND END DATE           
         STC   RE,1(R2)           NOTE MONTH/YEAR                               
         STC   RE,4(R2)            FOR THE PERIOD IS THE SAME                   
         STC   RF,0(R2)            YEAR                                         
         STC   RF,3(R2)                                                         
         MVI   5(R2),X'1F'         31ST DAY                                     
         CLC   0(2,R2),WORK+13                                                  
         BH    PEX2                                                             
         LA    R2,6(R2)                                                         
         B     PEXMONA                                                          
**                                                                              
**                                                                              
**                                                                              
         SPACE 1                                                                
PEX2     DS    0H                                                               
**********************************************************                      
*                 CREATE YEAR   TABLE                    *                      
**********************************************************                      
YEART    DS    0H                                                               
         LA    R2,YEARLIST                                                      
         ZIC   RF,WORK+10         START YEAR                                    
         BCTR  RF,0                                                             
PEXYRA   LA    RF,1(RF)                                                         
*                                                                               
         XC    0(6,R2),0(R2)      NOTE YEAR TABLE START AND END DATE            
         STC   RF,0(R2)            YEAR                                         
         MVI   1(R2),1             JANUARY                                      
         MVI   2(R2),1             FIRST                                        
         STC   RF,3(R2)            YEAR                                         
         MVI   4(R2),12            DECEMBER                                     
         MVI   5(R2),31            31ST DAY                                     
         CLC   0(2,R2),WORK+13                                                  
         BH    PEX3                                                             
         LA    R2,6(R2)                                                         
         B     PEXYRA                                                           
**                                                                              
PEX3     DS    0H                                                               
*                                                                               
         LA    R4,1(R4)           R4=A(FIRST POTENTIAL NUMBER)                  
         CLI   12(R4),C'D'                                                      
         BE    PEXITERR           DAY CANNOT BE SECOND PART OF DATE             
*                                 COMBINATION                                   
*                                                                               
CLI124Q  CLI   12(R4),C'Q'                                                      
         BNE   *+16                                                             
         OI    PBQPTSW,PBQPTTQQ    DETAILS BY QUARTER                           
         OI    PBQPTLVL,PBQPTL2Q   WITH TOTALS                                  
         B     PEXCK                                                            
*                                                                               
         CLI   12(R4),C'M'                                                      
         BNE   *+16                                                             
         OI    PBQPTSW,PBQPTTMQ    DETAILS BY MONTH                             
         OI    PBQPTLVL,PBQPTL2Q   WITH TOTALS                                  
         B     PEXCK                                                            
*                                                                               
         CLI   12(R4),C'W'                                                      
         BNE   *+16                                                             
         OI    PBQPTSW,PBQPTTWQ    DETAILS BY WEEK                              
         OI    PBQPTLVL,PBQPTL2Q   WITH TOTALS                                  
         B     PEXCK                                                            
*                                                                               
         CLI   12(R4),C'Y'                                                      
         BNE   PEX22                                                            
         OI    PBQPTSW,PBQPTTYQ    DETAILS BY YEAR                              
         OI    PBQPTLVL,PBQPTL2Q   WITH TOTALS                                  
*                                                                               
**********************************************                                  
*  VERIFY DATES ARE SUBSETS OF EACH OTHER    *                                  
**********************************************                                  
PEXCK    DS    0H                                                               
         TM    PBQPTLVL,PBQPTL2Q    TEST FOR COMBINATION OF DATES               
         BNO   PEXIT               NO COMBINATION OF DATES                      
         LA    RF,SUBSETER         COMINATION ERRORS                            
         MVC   DMCB(1),PBQPTSW     COPY PERIOD TYPE                             
PEXTM    CLC   DMCB(1),0(RF)                                                    
         BE    PEXITERR                                                         
         LA    RF,1(RF)                                                         
         CLI   0(RF),255                                                        
         BE    PEXIT               COMBINATIONS OK                              
         B     PEXTM                                                            
*                                                                               
*        INVALID DATE COMBOS                                                    
*                                                                               
SUBSETER DS   0H                                                                
         DC   AL1(PBQPTDYQ+PBQPTTYQ)   YR    DETAILS   YR    TOTALS             
         DC   AL1(PBQPTDYQ+PBQPTTQQ)   YR    DETAILS   QTR   TOTALS             
         DC   AL1(PBQPTDYQ+PBQPTTMQ)   YR    DETAILS   MONTH TOTALS             
         DC   AL1(PBQPTDYQ+PBQPTTWQ)   YR    DETAILS   WEEK  TOTALS             
         DC   AL1(PBQPTDQQ+PBQPTTQQ)   QTR   DETAILS   QTR   TOTALS             
         DC   AL1(PBQPTDQQ+PBQPTTMQ)   QTR   DETAILS   MONTH TOTALS             
         DC   AL1(PBQPTDQQ+PBQPTTWQ)   QTR   DETAILS   WEEK  TOTALS             
         DC   AL1(PBQPTDMQ+PBQPTTMQ)   MONTH DETAILS   MONTH TOTALS             
         DC   AL1(PBQPTDMQ+PBQPTTWQ)   MONTH DETAILS   WEEK  TOTALS             
         DC   AL1(PBQPTDWQ+PBQPTTWQ)   WEEK  DETAILS   WEEK  TOTALS             
         DC   X'FF'                    END OF TABLE                             
*                                                                               
PEX22    LA    R4,12(R4)           R4=A(FIRST POTENTIAL NUMBER)                 
         CLI   0(R4),C'D'          DETAILS (QD,MD,WD) ?                         
         BE    *+12                                                             
         CLI   0(R4),C' '          NO DETAILS JUST (Q,M,W) ?                    
         BNE   PEXCONTI                                                         
*                                                                               
         BCTR  R6,0                                                             
         EX    R6,*+8                                                           
         B     PEXIT                                                            
*                                                                               
*                                                                               
PEXCONTI LA    RE,EXPLIST                                                       
         MVI   FCHRTITR,0          INITALIZE - WILL CONTAIN ITERATION           
*                                 RANGE 2-6  FCHRTITR WILL BE 4                 
         LA    RF,1                                                             
PEXC     STC   RF,0(RE)           CREATE A STRING OF NUMBERS                    
         LA    RE,1(RE)                                                         
         LA    RF,1(RF)                                                         
         CH    RF,=H'211'                                                       
         BL    PEXC                                                             
         XC    FLOWSTRT(2),FLOWSTRT FLOW PERIOD INDICATORS                      
*        L     RF,SAVEREG4        POINT TO DATE TYPE                            
         LR    RF,R7              POINT TO DATE TYPE                            
         LA    RF,12(RF)                                                        
         LA    R3,50              MONTHS CANNOT BE GT 50                        
         CLI   0(RF),C'M'                                                       
         BE    PEXD                                                             
         LA    R3,16              16 Q MAX                                      
         CLI   0(RF),C'Q'                                                       
         BE    PEXD                                                             
         LA    R3,210             210 WEEKS MAX                                 
         CLI   0(RF),C'W'                                                       
         BE    PEXD                                                             
         LA    R3,4               4 YEARS MAX                                   
         CLI   0(RF),C'Y'                                                       
         BE    PEXD                                                             
         DC    H'0'                                                             
PEXD     BAS   RE,PEXNUM                                                        
         LTR   R0,R0               DID WE GET A VALID NUMBER                    
         BZ    PEXITERR                                                         
         CR    R0,R3               THAT WASN'T TOO BIG?                         
         BH    PEXITERR                                                         
         STC   R0,FLOWSTRT         START OF DATE (EG. W1) FLOWSTRT=01           
         LR    RF,R0               THEN SAVE THAT NUMBER                        
         LA    R1,1                FORCE COUNT TO 1             BUG02           
         CLI   0(R4),C'-'          IS THERE A RANGE SPECIFIED?                  
         BNE   PEX6                                                             
         LA    R4,1(R4)                                                         
         BAS   RE,PEXNUM           WAS THE SECOND NUMBER VALID?                 
         LTR   R0,R0                                                            
         BZ    PEXITERR                                                         
         CR    R0,R3                                                            
         BH    PEXITERR                                                         
         LR    R1,RF               BEGINING OF RANGE                            
         CR    R0,R1                                                            
         BNH   PEXITERR            SECOND MUST BE HIGHER THAN FIRST             
         STC   R0,FLOWEND          SECOND PART OF RANGE                         
         SR    R1,R0                                                            
         LCR   R1,R1                                                            
         CH    R1,=H'15'           AND NOT MORE THAT 15 MORE                    
         BH    PEXITERR                                                         
         SPACE 1                                                                
         STC   R1,FCHRTITR        CONTAINS ITERATION                            
PEX6     LR    R2,RF              NOW HAVE A LIST OF NUMBERS (RF=BEG #)         
         BCTR  R2,0                                                             
         LA    R2,EXPLIST(R2)                                                   
         LR    R3,R1               IN EXPLIST R1=COUNT                          
*        L     RF,SAVEREG4                                                      
         LR    RF,R7                                                            
         LA    RE,WEEKLIST+52*6 POINT TO START OF RQSTED WEEKS                  
         CLI   12(RF),C'W'          WEEKS REQUESTED                             
         BE    PEXWEEKS                                                         
         LA    RE,MNTHLIST+12*6                                                 
         CLI   12(RF),C'M'                                                      
         BE    PEXWEEKS                                                         
         LA    RE,QURTLIST+4*6                                                  
         CLI   12(RF),C'Q'                                                      
         BE    PEXWEEKS                                                         
         LA    RE,YEARLIST+1*6                                                  
         CLI   12(RF),C'Y'                                                      
         BE    PEXWEEKS                                                         
         DC    H'0'                                                             
PEXWEEKS DS    0H                                                               
         SPACE 1                                                                
PEX8     CLI   0(R2),0                                                          
         BE    PEXITERR                                                         
         ZIC   R1,0(R2)            CHECK THAT EACH NUMBER                       
         BCTR  R1,0                                                             
         MH    R1,=H'6'                                                         
         AR    R1,RE                                                            
         OC    0(3,R1),0(R1)       PRODUCES A VALID DATE RANGE                  
         BZ    PEXITERR                                                         
         LA    R2,1(R2)                                                         
         BCT   R3,PEX8                                                          
         B     PEXIT                                                            
         SPACE 1                                                                
         DROP  R5                                                               
         SPACE 1                                                                
PEXNUM   SR    R0,R0               VALIDATE FOR NUMERIC                         
*                                  R4=A(POTENTIAL EXPRESSION)                   
*                                  PASS BACK NUMBER IN R0                       
         SPACE 1                                                                
PEXNUM2  CLI   0(R4),C' '          DELIMITED BY SPACE OR DASH                   
         BER   RE                                                               
         CLI   0(R4),C'-'                                                       
         BER   RE                                                               
         CLI   0(R4),C'0'          CHECK FOR NUMERIC DIGIT                      
         BL    PEXNUMNO                                                         
         CLI   0(R4),C'9'                                                       
         BH    PEXNUMNO                                                         
         MH    R0,=H'10'           MULTIPLY PREVIOUS BY 10                      
         ZIC   R1,0(R4)            AND ADD THIS DIGIT                           
         SLL   R1,28               (STRIP TOP BITS)                             
         SRL   R1,28                                                            
         AR    R0,R1                                                            
         LA    R4,1(R4)                                                         
         B     PEXNUM2                                                          
         SPACE 1                                                                
PEXNUMNO SR    R0,R0               NO GOOD - RETURN ZERO                        
         BR    RE                                                               
         SPACE 2                                                                
*SAVEREG4 DS    F                                                               
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'PRWRIGEN - PRINT WRITER ROOT PHASE - CLIVAL'                    
***********************************************************************         
*                                                                     *         
*        VALIDATE CLIENT                                              *         
*                                                                     *         
*NTRY    R2 ==>  CLIENT FIELD ON SCREEN                               *         
*                                                                     *         
*EXIT                                                                 *         
*        NEQ CC SET ON ERROR                                          *         
*                                                                     *         
***********************************************************************         
         DS    0D                                                               
CLIVAL   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING SPOOLD,R8                                                        
         USING SYSD,R9                                                          
         USING T405FFD,RA                                                       
         USING GEND,RC                                                          
*                                                                               
         MVI   BRANDSW,0           INIT BRAND AGENCY AOR REQ SWITCH             
         SR    R5,R5               INIT CLIENT RECORD POINTER                   
         MVI   ERROR,INVCLT        SET DEFAULT ERROR CODE                       
*                                                                               
         MVC   DUB(3),=C'ALL'      DEFAULT TO 'ALL' CLIENTS'                    
*                                                                               
         CLI   5(R2),0             ANYTHING ENTERED                             
         BE    CLVALL                NO - USE DEFAULT                           
*                                                                               
*        READ IN ENTERED CLIENT CODE/OPTION                                     
*                                                                               
         GOTO1 ANY                 READ IN FIELD                                
*                                                                               
         MVC   DUB,WORK            SPACE PADDED CLIENT FROM GOTO1 ANY           
*                                                                               
*        SEPARATE VALIDATION IF THIS IS A GROUP ORIENTED REPORT                 
*              STARTS WITH 'G=' OR '='                                          
*                                                                               
         CLC   =C'G=',8(R2)        IF GROUP INDICATOR ENTERED                   
         BE    *+10                                                             
         CLC   =C'=',8(R2)         IF GROUP INDICATOR ENTERED                   
         BNE   CLVGRPN                                                          
*                                                                               
         MVC   PBQCLT,=C'ALL'      DEFAULT TO ALL CLIENTS                       
*                                                                               
         GOTOR GRPVAL,VGRPCLTQ        VALIDATE CLIENT GROUP                     
*                                                                               
         B     CLIVALX             DONE                                         
*                                                                               
CLVGRPN  DS    0H                                                               
*                                                                               
*        VALIDATE AS CLIENT/OFFICE/BILLING GROUP OR LIST                        
*                                                                               
         CLC   =C'ALL',DUB         IF ALL CLIENTS                               
         BE    CLVALL                                                           
*                                                                               
         CLI   DUB,C'&&'           IF SINGLE BILLING GROUP                      
         BE    CLVGRP                                                           
*                                                                               
         CLI   DUB,C'*'            IF OFFICE OPTION                             
         BE    CLVOFC                                                           
*                                                                               
         CLI   DUB,C'$'            IF OFFICE LIST                               
         BE    CLVLST                                                           
*                                                                               
         B     CLVCLT              ELSE MUST BE SINGLE CLIENT                   
*                                                                               
*        REQUEST FOR ALL CLIENTS                                                
*                                                                               
CLVALL   DS    0H                                                               
*                                                                               
*        SEE IF SIGNON CAN ISSUE THIS REQUEST                                   
*                                                                               
         MVC   PBQCLT,=C'ALL'         SET PBQCLT                                
*                                                                               
         B     CLVSCKX                END OF SECURITY CHECKS                    
*                                                                               
*        REQUEST WILL FILTER TO ALLOWED CLIENTS LATER                           
*                                                                               
         ICM   RF,15,ASECBLK       ESTABLISH SECURITY BLOCK                     
         USING SECD,RF                                                          
         BZ    *+14                   NO SECURITY AVAILABLE                     
         OC    SECCLAL,SECCLAL     IF ON CLIENT STRING SECURITY                 
         BNZ   CLVSCKX                ALLOW REQUEST                             
*                                                                               
         DROP  RF                                                               
*                                                                               
         OC    TWAACCS(2),TWAACCS                                               
         BNZ   CLVSCKE                MUST HAVE UNLIMITED ACCESS                
*                                                                               
         B     CLVSCKX                END OF SECURITY CHECKS                    
*                                                                               
*        REQUEST FOR                                                            
*              SINGLE OFFICE      - *AA                                         
*              ALL BUT ONE OFFICE - *-AA                                        
*              RANGE OF OFFICES   - *AA-ZZ                                      
*                                                                               
CLVOFC   DS    0H                                                               
*                                                                               
         MVI   PBQCLT,C'*'         SET OFFICE INDICATOR                         
*                                                                               
         SR    R0,R0                                                            
         IC    R0,5(R2)            LENGTH OF INPUT                              
         LA    R4,DUB              START OF CLIENT FIELD INPUT                  
*                                                                               
         LA    R4,1(R4)            BYPASS TYPE INDICATOR                        
         SHI   R0,1                DECREMENT LENGTH COUNTER                     
         BNP   CLVSCKE             MUST HAVE SOME CODE                          
*                                                                               
         CLI   0(R4),C'-'          IF ALL BUT ONE OFFICE                        
         BNE   CLVSCK10                                                         
*                                                                               
         LA    R4,1(R4)               BUMP OFFICE START                         
         SHI   R0,1                   DECREMENT LENGTH OF CODE                  
         BNP   CLVSCKE                   MUST HAVE A CODE                       
*                                                                               
         B     CLVSCK20                                                         
*                                                                               
CLVSCK10 DS    0H                                                               
*                                                                               
         LR    R6,R4               COPY OFFICE CODE START                       
*                                                                               
         CLI   1(R6),C'-'          IF RANGE OF OFFICES                          
         BE    *+16                                                             
         LA    R6,1(R6)                                                         
         CLI   1(R6),C'-'                                                       
         BNE   CLVSCK20            ELSE MUST BE SINGLE OFFICE                   
*                                                                               
         LR    R0,R6               COPY END OF CODE                             
         SR    R0,R4               LENGTH OF OFFICE CODE                        
         AHI   R0,1                                                             
*                                                                               
CLVSCK20 DS    0H                                                               
*                                                                               
         CHI   R0,2                OFFICE CODE IS MAX 2 LONG                    
         BH    CLVSCKE                                                          
*                                                                               
*        TRANSLATE 2 CHARACTER OFFICE CODE                                      
*                                                                               
         LA    R3,WORK                USE OFFICER                               
         XC    WORK,WORK                                                        
*                                                                               
         USING OFFICED,R3                                                       
*                                                                               
         GOTOR OFCVAL,DMCB,((R0),0(R4)),(0,OFFICED)                             
         BNE   CLVSCKE             DID NOT PASS SECURITY TEST                   
*                                                                               
         MVC   PBQCLT+1(1),OFCOFC  SAVE INTERNAL OFCOFC CODE                    
*                                                                               
         CLI   DUB+1,C'-'          IF ALL BUT ONE OFFICE                        
         BNE   *+14                                                             
         MVI   PBQCLT+1,C'-'                                                    
         MVC   PBQCLT+2(1),OFCOFC     SAVE INTERNAL OFCOFC CODE                 
*                                                                               
         AR    R4,R0               BUMP TO END OF OFFICE CODE                   
*                                                                               
*        WE HAVE AN OFFICE RANGE *AA-BB                                         
*                                                                               
         LR    RF,R4               CALCULATE LENGTH SO FAR                      
         LA    RE,DUB                                                           
         SR    RF,RE               LENGTH SO FAR                                
*                                                                               
         SR    R0,R0                                                            
         IC    R0,5(R2)            ORIGINAL LENGTH                              
         SR    R0,RF               REMAINING LENGTH                             
         BNP   CLVSCKX             DONE                                         
*                                                                               
         CLI   0(R4),C'-'          MUST BE A RANGE OF OFFICES                   
         BNE   CLVSCKE                                                          
*                                                                               
         LA    R4,1(R4)            BUMP TO NEXT OFFICE CODE                     
         SHI   R0,1                DECREMENT INPUT COUNTER                      
         BNP   CLVSCKE             MUST HAVE AN OFFICE CODE                     
*                                                                               
         CHI   R0,2                MAX 2 CHARACTERS FOR OFFICE LENGTH           
         BH    CLVSCKE                                                          
*                                                                               
         XC    WORK,WORK                                                        
*                                                                               
         GOTOR OFCVAL,DMCB,((R0),0(R4)),(0,OFFICED) VALIDATE OFFICE             
         BNE   CLVSCKE             FAILED VALIDATION                            
*                                                                               
         MVC   PBQCLT+2(1),OFCOFC  SAVE END OF RANGE OFC CODE                   
*                                                                               
         B     CLVSCKX                                                          
*                                                                               
*        FOLLOWING SECURITY TESTS SHOULD HAVE BEEN HANDLED                      
*        BY ABOVE CALL TO OFFICER                                               
*                                                                               
CLV1OFC1 DS    0H                                                               
*                                                                               
         ICM   RF,15,ASECBLK       ESTABLISH SECURITY BLOCK                     
         USING SECD,RF                                                          
         BZ    *+14                   NO SECURITY AVAILABLE                     
         OC    SECCLAL,SECCLAL     IF ON CLIENT STRING SECURITY                 
         BNZ   CLVSCKX                ALLOW REQUEST                             
*                                                                               
         DROP  RF                                                               
*                                                                               
         CLI   TWAACCS,C'$'        ELSE ERROR IF NOT CLEARED FOR LIST           
         BNE   CLVSCKE                I.E. CLEARED FOR CLIENT                   
*                                                                               
*        USE OFFICER TO SEE IF OFFICE OKAY FOR SIGNON ID                        
*                                                                               
         LA    R3,WORK                USE OFFICER                               
         XC    WORK,WORK                                                        
*                                                                               
         USING OFFICED,R3                                                       
*                                                                               
         MVI   OFCSYS,C'P'         SYSTEM                                       
         MVC   OFCAUTH,TWAACCS     SIGN ON LIMITS                               
         MVC   OFCAGY,AGENCY       AGENCY ID                                    
         MVC   OFCOFC,PBQCLT+1     REQUESTED OFFICE                             
         MVC   OFCLMT,TWAACCS      LIMIT ACCESS VALUE                           
*                                                                               
         MVC   OFCSECD,ASECBLK     A(FASECRET BLOCK)                            
*                                                                               
         GOTO1 OFFICER,DMCB,(C'N',OFFICED),ACOMFACS                             
*                                                                               
         CLI   0(R1),0                                                          
         BNE   CLVSCKE             DID NOT PASS SECURITY TEST                   
*                                                                               
         B     CLVSCKX             PASSES SECURITY TEST                         
*                                                                               
*        HANDLE OFFICE LISTS                                                    
*                                                                               
CLVLST   DS    0H                                                               
*                                                                               
         CLI   5(R2),3             ENTRY NOT MORE THAN 3 LONG                   
         BH    CLVSCKE                                                          
*                                                                               
         MVC   PBQCLT,DUB          SAVE CLIENT FIELD ENTRY                      
*                                                                               
         OC    TWAACCS(2),TWAACCS                                               
         BZ    CLVSCKX                OKAY IF UNLIMITED ACCESS                  
*                                                                               
         B     CLVSCKX             SECURITY CHECKED AT RUN TIME                 
*                                                                               
         ICM   RF,15,ASECBLK       ESTABLISH SECURITY BLOCK                     
         USING SECD,RF                                                          
         BZ    *+14                   NO SECURITY AVAILABLE                     
         OC    SECCLAL,SECCLAL     IF ON CLIENT STRING SECURITY                 
         BNZ   CLVSCKX                ALLOW REQUEST                             
*                                                                               
         DROP  RF                                                               
*                                                                               
         CLC   PBQCLT(2),TWAACCS     MUST MATCH SIGNON OFFICE LIST              
         BNE   CLVSCKE                                                          
*                                                                               
         B     CLVSCKX             PASSES SECURITY TEST                         
*                                                                               
*        HANDLE BILLING GROUP                                                   
*                                                                               
CLVGRP   DS    0H                                                               
*                                                                               
*        NEED TO READ ALL CLIENT HEADERS                                        
*           IF CLIENT BELONGS TO BILLING GROUP                                  
*           THEN IT MUST BE AVAILABLE TO SIGN ON                                
*                                                                               
         CLI   5(R2),3             ENTRY NOT MORE THAN 3 LONG                   
         BH    CLVSCKE                                                          
*                                                                               
         MVC   PBQCLT,DUB          SAVE CLIENT FIELD ENTRY                      
*                                                                               
         ICM   RF,15,ASECBLK       ESTABLISH SECURITY BLOCK                     
         USING SECD,RF                                                          
         BZ    *+14                   NO SECURITY AVAILABLE                     
         OC    SECCLAL,SECCLAL     IF ON CLIENT STRING SECURITY                 
         BNZ   CLVSCKX                ALLOW REQUEST                             
*                                                                               
         B     CLVSCKX             PASSES SECURITY TEST                         
*                                                                               
         DROP  RF                                                               
*                                                                               
         LA    R3,WORK             SET UP OFFICER CONTROL BLOCK                 
         XC    WORK,WORK           INIT OFFICER PARAMETERS                      
*                                                                               
         USING OFFICED,R3                                                       
*                                                                               
         MVI   OFCSYS,C'P'         SYSTEM                                       
         MVC   OFCAUTH,TWAACCS     SIGN ON LIMITS                               
         MVC   OFCAGY,AGENCY       AGENCY ID                                    
         MVC   OFCLMT,TWAACCS      LIMIT ACCESS VALUE                           
         MVC   OFCSECD,ASECBLK     A(FASECRET BLOCK)                            
*                                                                               
         XC    KEY,KEY             INIT CLIENT RECORD KEY                       
         LA    R4,KEY              ESTABLISH CLIENT RECORD KEY                  
         USING PCLTKEY,R4                                                       
*                                                                               
         MVC   PCLTKAGY,AGENCY     SET AGENCY                                   
*                                                                               
         BRAS  RE,CLTMED           FIND FIRST MEDIA                             
         BE    *+6                 THERE MUST BE AT LEAST ONE                   
         DC    H'0'                                                             
*                                                                               
         MVI   PCLTKRCD,X'02'      INDICATE CLIENT RECORD                       
         MVI   RDUPDATE,C'N'       NOT READING FOR UPDATE                       
*                                                                               
         MVC   AIO,AIO1            INDICATE WHERE TO READ RECORD INTO           
*                                                                               
CLVSCK1L DS    0H                                                               
*                                                                               
         GOTO1 HIGH                READ IST DIRECTORY POINTER FOR MEDIA         
*                                                                               
CLVSCK2L DS    0H                                                               
*                                                                               
         CLC   PCLTKEY(PCLTKCLT-PCLTKEY),KEYSAVE  MATCH AGY/MEDIA/TYPE          
         BNE   CLVSCK2D                                                         
*                                                                               
         GOTO1 GETREC              READ RECORD                                  
*                                                                               
         L     R6,AIO              POINT TO FOUND RECORD                        
         LA    R5,33(R6)           POINT TO FIRST ELEMENT IN RECORD             
*                                                                               
         USING PCLTELEM,R5         ESTABLISH CLIENT HEADER ELEMENT              
*                                                                               
         CLC   PCLTBLGP,PBQCLT+1   SKIP IF CLIENT NOT IN BILL GRP               
         BNE   CLVSCK2C                                                         
*                                                                               
*        USE OFFICER FOR SECURITY VALIDATION                                    
*                                                                               
         MVC   OFCPMED,PCLTKMED    MEDIA                                        
         MVC   OFCOFC,PCLTOFF      SET CLIENT OFFICE CODE                       
         MVC   OFCCLT,PCLTKCLT     SET CLIENT CODE                              
*                                                                               
         LR    R0,R5               SAVE CURRENT ELEMENT POINTER                 
*                                                                               
         LHI   RF,TRAFID-SYSD      POINT TO TRAFFIC USERID IND                  
         LA    RF,SYSD(RF)                                                      
         CLI   0(RF),C'T'          IF TRAFFIC SIGN ON                           
         BNE   CLVSCK21                                                         
*                                                                               
         MVI   ELCODE,X'50'        TRAFFIC OFFICE ELEMENT                       
*                                                                               
         BRAS  RE,NEXTEL           FIND ELEMENT                                 
         BNZ   CLVSCK21            SKIP IF NO ELEM FOUND                        
         USING PCLTTOEL,R5         ESTABLISH TRAFFIC ELEMENT                    
*                                                                               
         MVC   OFCOFC,PCLTTOFC     VALIDATE TRAFFIC OFFICE                      
*                                                                               
CLVSCK21 DS    0H                                                               
*                                                                               
         LR    R5,R0               RESTORE ELEMENT PONTER                       
*                                                                               
         GOTO1 OFFICER,DMCB,(C'N',OFFICED),ACOMFACS                             
*                                                                               
         CLI   0(R1),0                                                          
         BNE   CLVSCKE             FAILS SECURITY TEST                          
*                                                                               
CLVSCK2C DS    0H                                                               
*                                                                               
         GOTO1 SEQ                 READ NEXT DIRECTORY POINTER                  
*                                                                               
         B     CLVSCK2L                                                         
*                                                                               
CLVSCK2D DS    0H                                                               
*                                                                               
CLVSCK1C DS    0H                                                               
*                                                                               
         MVC   PCLTKEY,KEYSAVE     RESTORE LAST CLIENT KEY                      
*                                                                               
         BRAS  RE,CLTMED           FIND NEXT MEDIA                              
         BE    CLVSCK1L            ONE WAS FOUND                                
*                                                                               
CLVSCK1D DS    0H                  NO MORE MEDIAS                               
*                                                                               
         B     CLVSCKX             PASSES SECURITY TEST                         
*                                                                               
CLVBGPN  DS    0H                                                               
*                                                                               
CLVSCKX DS     0H                                                               
*                                                                               
         B     CLIVALOK                   PASSED SECURITY TESTS                 
*                                                                               
CLVCLT  DS     0H                                                               
*                                                                               
*        SINGLE CLIENT CODE                                                     
*                                                                               
         CLI   5(R2),3             CLIENT CODE MUST BE 2 OR 3 LONG              
         BH    CLVERR                                                           
*                                                                               
         CLI   5(R2),2                                                          
         BL    CLVERR                                                           
*                                                                               
         MVC   PBQCLT,DUB          SAVE REQUESTED CLIENT                        
*                                                                               
         CLC   PBQCLT,PBQXCL       EXLUDED CLIENT MUST NOT EQ                   
         BE    CLVERRXC               REQUESTED CLIENT                          
*                                                                               
*        READ CLIENT HEADER                                                     
*                                                                               
*        NEED TO LOOP TO FIND FIRST MEDIA CLIENT ESTABLISHED FOR                
*                                                                               
         XC    KEY,KEY             GET CLIENT RECORD                            
         LA    R4,KEY              ESTABLISH CLIENT RECORD KEY                  
         USING PCLTKEY,R4                                                       
*                                                                               
         MVC   PCLTKAGY,AGENCY     SET AGENCY                                   
*                                                                               
         BRAS  RE,CLTMED           GET FIRST MEDIA                              
*                                                                               
         MVI   PCLTKRCD,X'02'      INDICATE CLIENT RECORD                       
         MVC   PCLTKCLT,PBQCLT     SET CLIENT CODE                              
*                                                                               
         MVI   RDUPDATE,C'N'       NOT READING FOR UPDATE                       
*                                                                               
CLVCLTLP DS    0H                                                               
*                                                                               
         GOTO1 HIGH                FIND DIRECTORY POINTER                       
*                                                                               
         CLC   KEY(25),KEYSAVE     MUST FIND RECORD                             
         BE    CLVCLTFD                                                         
*                                                                               
CLVCLTCN DS    0H                                                               
*                                                                               
         MVC   PCLTKEY,KEYSAVE     RESTORE KEY                                  
*                                                                               
         BRAS  RE,CLTMED           GET NEXT MEDIA                               
         BE    CLVCLTLP            MEDIA FOUND                                  
*                                                                               
         B     CLVERR              INVALID CLIENT                               
*                                                                               
CLVCLTFD DS    0H                                                               
*                                                                               
         MVC   AIO,AIO1            INDICATE WHERE TO READ RECORD INTO           
*                                                                               
         GOTO1 GETREC              READ RECORD                                  
*                                                                               
CLVELM   DS    0H                  FIND HEADER AND AOR ELEMENTS                 
*                                                                               
         LHI   RF,AORELMSV-SYSD    POINT TO AOR ELM SAVEAREA                    
         LA    RF,SYSD(RF)                                                      
         XC    0(L'AORELMSV,RF),0(RF) INIT ELEMENT SAVEAREA                     
*                                                                               
         L     R5,AIO              POINT TO FOUND RECORD                        
*                                                                               
         LHI   RF,CLVMEDSV-SYSD    SAVE MEDIA                                   
         LA    RF,SYSD(RF)                                                      
         MVC   0(L'CLVMEDSV,RF),PCLTKMED-PCLTKEY(R5)                            
*                                                                               
         SR    R0,R0                                                            
         LA    R5,33(R5)           POINT TO FIRST ELEMENT IN RECORD             
*                                                                               
CLVELML DS     0H                  FIND CLIENT HEADER ELEMENT                   
*                                                                               
         CLI   0(R5),X'00'         CHECK FOR RECORD END                         
         BE    CLVELMD                                                          
*                                                                               
         CLI   0(R5),X'02'         CHECK FOR CORRECT ELEMENT                    
         BE    CLVHDR                                                           
*                                                                               
         CLI   0(R5),X'15'         CHECK FOR ADVERTISER ELEMENT                 
         BE    CLVADV                                                           
*                                                                               
         B     CLVELMC                                                          
*                                                                               
CLVHDR   DS    0H                  FIND CLIENT HEADER ELEMENT                   
*                                                                               
         USING PCLTELEM,R5                                                      
*                                                                               
         CLI   PCLTPROF+5,C'1'    IF THIS A MASTER CLIENT         L01           
         BNE   CLVMASN                                            L01           
         CLI   PBFLAVOR,C'O'      AND NOT A CONTONLY REPORT                     
         BE    *+8                                                              
         MVI   PBQSLAVE,C'Y'      INDICATE SLAVES ARE TO BE READ  L01           
         B     CLVRDX                                                           
*                                                                 L01           
CLVMASN DS     0H                                                               
*                                                                 L01           
         CLI   PCLTPROF+5,C'2'     IF THIS IS A SLAVE CLIENT                    
         BNE   CLVSLVN                                                          
         CLI   PBFLAVOR,C'O'       THEN CAN'T BE CONTONLY REPORT                
         BE    CLVSLER                                                          
*                                                                 L01           
CLVSLVN  DS    0H                                                               
*                                                                               
CLVRDX   DS    0H                                                               
*                                                                               
*        CHECK UP ON SECURITY                                                   
*                                                                               
CLVSEC   DS    0H                                                               
*                                                                               
         CLI   OFFLINE,C'Y'     SKIP IF OFF-LINE                                
         BE    CLVSECX                                                          
*                                                                               
         MVI   ERROR,SECLOCK       SET DEFAULT ERROR CODE                       
*                                                                               
*        GO TO OFFICER FOR SECURITY CHECK                                       
*                                                                               
         LA    R3,WORK             OFFICE LIST                                  
         XC    WORK,WORK                                                        
*                                                                               
         USING OFFICED,R3                                                       
*                                                                               
         MVI   OFCSYS,C'P'         SYSTEM                                       
         MVC   OFCAUTH,TWAACCS     SIGN ON LIMITS                               
         MVC   OFCAGY,AGENCY       AGENCY ID                                    
         MVC   OFCLMT,TWAACCS      LIMIT ACCESS VALUE                           
         MVC   OFCSECD,ASECBLK     A(FASECRET BLOCK)                            
*                                                                               
         MVC   OFCSECD,ASECBLK     A(FASECRET BLOCK)                            
*                                                                               
         MVC   OFCPMED,PCLTKMED    MEDIA                                        
         MVC   OFCOFC,PCLTOFF      SET CLIENT OFFICE CODE                       
         MVC   OFCCLT,PCLTKCLT     SET CLIENT CODE                              
*                                                                               
         LR    R0,R5               SAVE CURRENT ELEMENT CPONTER                 
*                                                                               
         LHI   RF,TRAFID-SYSD      POINT TO TRAFFIC USERID IND                  
         LA    RF,SYSD(RF)                                                      
         CLI   0(RF),C'T'          IF TRAFFIC SIGN ON                           
         BNE   CLVSEC41                                                         
*                                                                               
         L     R5,AIO1             POINT TO CLIENT RECORD                       
         MVI   ELCODE,X'50'        TRAFFIC OFFICE ELEMENT                       
*                                                                               
         BRAS  RE,GETEL            FIND ELEMENT                                 
         BNZ   CLVSEC41            SKIP IF NO ELEM FOUND                        
         USING PCLTTOEL,R5         ESTABLISH TRAFFIC ELEMENT                    
*                                                                               
         MVC   OFCOFC,PCLTTOFC     VALIDATE TRAFFIC OFFICE                      
*                                                                               
CLVSEC41 DS    0H                                                               
*                                                                               
         LR    R5,R0               RESTORE CURRENT ELEMENT POINTER              
*                                                                               
         GOTO1 OFFICER,DMCB,(C'N',OFFICED),ACOMFACS                             
*                                                                               
         CLI   0(R1),0                                                          
         BNE   CLVERR              MUST FIND OFFICE RECORD                      
*                                                                               
CLVSECX  DS    0H                                                               
         B     CLVELMC                                                          
*                                                                               
*        IF PBQADVSW SET THEN MAKE SURE THIS IS AN ADVERTISER CLIENT            
*                                                                               
CLVADV   DS    0H                                                               
*                                                                               
         CLI   PBQADVSW,C'Y'       SKIP UNLESS AOR SWITCH SET                   
         BNE   CLVADVX                                                          
*                                                                               
         USING PCLTADVE,R5         ESTABLISH ADVERTISER ELEMENT                 
*                                                                               
         CLC   PCLTKCLT,PCLTADV    IF NOT ITS OWN ADVERTISER                    
         BNE   *+10                                                             
         CLC   PCLTAOR,AGENCY      OR NOT ADVERTISER AGENCY                     
         BE    CLVADV1                                                          
*                                                                               
         MVI   BRANDSW,C'Y'           SET AS BRAND AGY AOR REQ                  
*                                                                               
         OC    PBQQAGY,PBQQAGY     MUST BE AOR=ALL/ALL REPORT                   
         BNZ   CLVADV2                                                          
         OC    PBQQCLT,PBQQCLT                                                  
         BNZ   CLVADV2                                                          
         OC    PBQQAGFL,PBQQAGFL                                                
         BNZ   CLVADV2                                                          
*                                                                               
CLVADV1 DS     0H                                                               
*                                                                               
         LHI   RF,AORELMSV-SYSD POINT TO AOR ELM SAVEAREA                       
         LA    RF,SYSD(RF)                                                      
         MVC   0(L'AORELMSV,RF),0(R5) SAVE AOR ELEMENT                          
*                                                                               
CLVADVX DS     0H                                                               
*                                                                               
CLVELMC DS     0H                                                               
*                                                                               
         LTR   R5,R5               SKIP IF CLIENT HEADER NOT READ               
         BZ    CLVELMD                                                          
*                                                                               
         SR    R0,R0                                                            
         ICM   R0,1,1(R5)          ELEMENT LENGTH                               
         BNZ   *+6                                                              
         DC    H'0'                BAD RECORD                                   
*                                                                               
         AR    R5,R0                                                            
         B     CLVELML                                                          
*                                                                               
CLVELMD DS     0H                                                               
*                                                                               
CLIVALOK DS    0H                                                               
*                                                                               
         CLI   PBQADVSW,C'Y'       SKIP IF NOT AOR SITUATION                    
         BNE   CLVAAGX                                                          
*                                                                               
*        VALIDATE AOR OKAY USING CONTROL RECORD                                 
*                                                                               
CLVAAG   DS    0H                                                               
*                                                                               
*        MUST SWITCH TO CONTROL                                                 
*                                                                               
         CLI   OFFLINE,C'Y'        HANDLE DIFFERENT IF OFF-LINE                 
         BE    CLVAOF                                                           
*                                                                               
         L     RF,ACOMFACS                                                      
         L     RF,CSWITCH-COMFACSD(RF)                                          
         XC    DMCB(8),DMCB                                                     
         MVI   DMCB,X'0A'               CONTROL SYSTEM                          
         GOTO1 (RF),DMCB           SWITCH TO CONTROL SYSTEM                     
         CLI   4(R1),0                                                          
         BE    *+6                                                              
         DC    H'0'                                                             
         B     CLVAOFX                                                          
*                                                                               
CLVAOF   DS    0H                  OPEN CONTROL SYSTEM FILES                    
*                                                                               
         L     RF,PBUTLA               SWITCH TO CONTROL SYSTEM                 
         MVC   DUB(1),4(RF)        SAVE CURRENT SYSTEM ID                       
         MVI   4(RF),X'0A'                                                      
*                                                                               
CLVAOFX DS     0H                                                               
*                                                                               
         LH    R5,=Y(AORELMSV-SYSD) POINT TO AOR ELM SAVEAREA                   
         LA    R5,SYSD(R5)                                                      
*                                                                               
         USING PCLTADVE,R5         ESTABLISH ADVERTISER ELEMENT                 
*                                                                               
*        READ ADVERTISER HEADER                                                 
*                                                                               
         XC    KEY,KEY                                                          
         LA    R6,KEY              ESTABLISH ADVERTISER RECORD KEY              
         USING ADVKEYD,R6                                                       
*                                                                               
         MVI   ADVTYP,ADVTYPQ      SET RECORD TYPE                              
         MVI   ADVSYS,C'P'         SET SYSTEM TO PRINT                          
*                                                                               
         LHI   RF,CLVMEDSV-SYSD    POINT TO SAVED MEDIA                         
         LA    RF,SYSD(RF)                                                      
         MVC   ADVMED,0(RF)        SET MEDIA                                    
*                                                                               
         MVC   ADVAOR,PCLTAOR      AOR AGENCY ID                                
         MVC   ADVADV,PCLTADV      ADVERTISER CODE                              
*                                                                               
         MVC   ADVAGY,PBQQAGY      REQUESTED AGENCY                             
         OC    ADVAGY,ADVAGY       IF ALL AGENCIES REQUESTED                    
         BNZ   *+10                                                             
         MVC   ADVAGY,PCLTAOR         USE AOR AGENCY                            
*                                                                               
         MVC   KEYSAVE,KEY         SAVE STARTING KEY                            
*                                                                               
         GOTO1 DATAMGR,DMCB,=C'DMRDHI',=C'GENDIR',KEY,KEY,0,0  READ PTR         
*                                                                               
         TM    ADVKSTA,X'80'       RECORD MUST NOT BE DELETED                   
         BO    CLVAGER                                                          
*                                                                               
         CLC   ADVKEY,KEYSAVE      MUST FIND RECORD                             
         BNE   CLVAGER                                                          
*                                                                               
         CLC   =C'ALL',PBQQCLT     OKAY IF 'ALL' OR SPACES                      
         BE    CLVACLX                                                          
         CLC   =C'   ',PBQQCLT     OKAY IF 'ALL' OR SPACES                      
         BNL   CLVACLX                                                          
*                                                                               
         L     R6,AIO1             INDICATE WHERE TO READ RECORD INTO           
         ST    R6,AIO                                                           
*                                                                               
         GOTO1 DATAMGR,DMCB,=C'GETREC',=C'GENFIL',KEY+36,(R6),DMWORK            
*                                                                               
         USING ADVKEYD,R6          ESTABLISH ADVERTISER CONTROL RECORD          
*                                                                               
         SR    RF,RF                                                            
         LA    R5,ADVFRST          POINT TO FIRST ELEMENT                       
         USING CLTD,R5             ESTABLISH CLIENT ELEMENT                     
*                                                                               
CLVACLL DS     0H                                                               
*                                                                               
         CLI   CLTEL,0             CHECK FOR END OF RECORD                      
         BE    CLVACLD                                                          
*                                                                               
         CLI   CLTEL,CLTELQ        FIND A CLIENT ELEMENT                        
         BNE   CLVACLC                                                          
*                                                                               
         OC    PBQQAGY,PBQQAGY     IF ALL AGENCIES WANTED                       
         BNZ   CLVACL1                                                          
*                                                                               
         OC    CLTADV,=C'   '                                                   
         CLC   CLTADV,PBQQCLT         MATCH AOR CLIENT TO REQUESTED CLT         
         BE    CLVACLF                                                          
         B     CLVACLC                                                          
*                                                                               
CLVACL1 DS     0H                  ELSE                                         
*                                                                               
         OC    CLTAGY,=C'   '                                                   
         CLC   CLTAGY,PBQQCLT         MATCH AGY CLIENT TO REQUESTED CLT         
         BE    CLVACLF                                                          
*                                                                               
CLVACLC DS     0H                                                               
*                                                                               
         IC    RF,CLTLN            ELEMENT LENGTH                               
         LA    R5,CLTEL(RF)        BUMP TO NEXT ELEMENT                         
         B     CLVACLL                                                          
*                                                                               
CLVACLD DS     0H                                                               
*                                                                               
         B     CLVCLE1             INVALID CLIENT FOR AGENCY                    
*                                                                               
CLVACLF DS     0H                  OKAY - CLIENT FOUND IN RECORD                
*                                                                               
CLVACLX DS     0H                                                               
*                                                                               
*        MUST SWITCH BACK                                                       
*                                                                               
         CLI   OFFLINE,C'Y'        CHECK FOR OFF-LINE                           
         BE    CLVOFF                                                           
*                                                                               
         L     RF,ACOMFACS                                                      
         L     RF,CSWITCH-COMFACSD(RF)                                          
         GOTO1 (RF),DMCB,=C'PRINT',0                                            
         CLI   4(R1),0                                                          
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         B     CLVOFFX                                                          
*                                                                               
CLVOFF   DS    0H                                                               
*                                                                               
         L     RF,PBUTLA           RE-POINT TO UTL                              
         MVC   4(1,RF),DUB         RESET TO CURRENT SYSTEM                      
*                                                                               
CLVOFFX DS     0H                                                               
*                                                                               
         DROP  R5,R6                                                            
*                                                                               
CLVAAGX DS     0H                                                               
*                                                                               
CLVSON   DS    0H                  CHECK IF SOON REQUEST ALLOWED                
*                                                                               
         CLI   OFFLINE,C'Y'        IF OFF-LINE NO REQUEST RESTRICTIONS          
         BE    CLVSONX                                                          
*                                                                               
         CLC   =C'SOON',CONWHEN    OKAY IF NOT SOON REQUEST                     
         BNE   CLVSONX                                                          
*                                                                               
         CLC   PBQCLT,=C'ALL'      OKAY IF NOT 'ALL' CLIENTS                    
         BE    *+12                                                             
         CLI   PBQCLT,C'A'         AND THIS INCLUDES (*$&)                      
         BNL   CLVSONX                                                          
*                                                                               
         MVI   REQSML,C'L'         POSSIBLY LARGE REQUEST                       
*                                                                               
*        READ WL PROFILE                                                        
*                                                                               
         XC    DUB,DUB             PARAMETERS FOR GETPROF                       
*                                                                               
         MVI   DUB,C'P'            SET SYSTEM                                   
         MVC   DUB+2(2),=C'WL'     WL - LIMITS PROFILE                          
         MVC   DUB+4(2),PBQAGY     AGENCY                                       
         MVC   DUB+6(1),PBQMED     MEDIA                                        
         CLI   DUB+6,C'*'          MULTI MEDIA REPORTS DEFAULT TO M             
         BE    *+8                                                              
         CLI   DUB+6,C'C'                                                       
         BNE   *+8                                                              
         MVI   DUB+6,C'M'                                                       
*                                                                               
         GOTO1 GETPROF,DMCB,(X'C0',DUB),PBQPRFWL,DATAMGR                        
*                                                                               
         CLI   PBQPRFWL+1,C'A'     OKAY IF ALL CLIENTS/ALL MEDIA OKAY           
         BE    CLVSONX                                                          
*                                                                               
         CLI   PBQPRFWL+1,C'Y'     IF ALL CLIENTS ONLY ALLOWED FOR SOON         
         BNE   CLVSNER                                                          
*                                                                               
         CLI   PBQMED,C'*'            ALL MEDIA NOT ALLOWED                     
         BE    CLVSNER                                                          
         CLI   PBQMED,C'C'                                                      
         BE    CLVSNER                                                          
*                                  ELSE REQUEST ALLOWED                         
CLVSONX DS     0H                                                               
*                                                                               
*        GET CLIENT LEVEL PROFILES                                              
*                                                                               
CLVPRF   DS    0H                                                               
*                                                                               
         CLI   PBQMED,C'*'         SKIP IF MULTI-MEDIA                          
         BE    CLVPRFX                                                          
         CLI   PBQMED,C'C'                                                      
         BE    CLVPRFX                                                          
*                                                                               
         CLC   PBQCLT,=C'ALL'      SKIP IF MULTI-CLIENT                         
         BE    CLVPRFX                                                          
*                                                                               
         XC    DUB,DUB             PARAMETERS FOR GETPROF                       
*                                                                               
         CLI   PBQCLT,C'*'         IF SINGLE OFFICE REQUEST                     
         BNE   CLVPRF10                                                         
         CLI   PBQCLT+2,0                                                       
         BNE   CLVPRFX                                                          
*                                                                               
CLVPRF10 DS    0H                                                               
*                                                                               
         MVI   WORK,C'P'           SET SYSTEM                                   
         MVC   WORK+2(2),=C'W0'    W0 - WRITER PROFILE                          
         MVC   WORK+4(2),PBQAGY    AGENCY                                       
*                                                                               
         MVC   WORK+6(1),PBQMED       GET MEDIA  LEVEL PROFILE                  
         MVC   WORK+7(3),PBQCLT       GET CLIENT LEVEL PROFILE                  
*                                                                               
         CLI   PBQCLT,C'*'         IF OFFICE LEVEL REQUEST                      
         BNE   *+16                                                             
         XC    WORK+7(3),WORK+6       CLEAR CLIENT                              
         MVC   WORK+10(2),PBQCLT       SET OFFICE CODE                          
*                                                                               
         GOTO1 GETPROF,DMCB,(X'C0',WORK),PBQPRFW0,DATAMGR                       
*                                                                               
         MVC   WORK+2(2),=C'WL'    WL - LIMITS PROFILE                          
*                                                                               
         GOTO1 GETPROF,DMCB,(X'C0',WORK),PBQPRFWL,DATAMGR                       
*                                                                               
CLVPRFX  DS    0H                                                               
*                                                                               
         MVI   ERROR,0             TURN OFF ERROR                               
         CR    RB,RB               SET CC TO EQ                                 
         B     CLIVALX                                                          
*                                                                               
CLVSCKE DS     0H                  SECURITY LOCKOUT                             
         MVI   ERROR,SECLOCK       SET ERROR CODE                               
         B     CLVERR                                                           
*                                                                               
CLVAOE1 DS     0H                                                               
         MVI   ERROR,PWECLADN      CLIENT IS AND ADVERTISER                     
         B     CLVERR                                                           
*                                                                               
CLVAGER DS     0H                                                               
         MVI   ERROR,PWECLAGN      NOT AN AGENCY FOR ADVERTISER                 
         B     CLVERR                                                           
*                                                                               
CLVAOER DS     0H                                                               
         MVI   ERROR,PWECLAGI      INVALID AGENCY                               
         B     CLVERR                                                           
*                                                                               
CLVCLE1 DS     0H                                                               
         MVI   ERROR,PWECLADX      NOT A CLIENT FOR ADVERTISER                  
         B     CLVERR                                                           
*                                                                               
CLVADV2 DS     0H                                                               
         MVI   ERROR,PWECLAD2      REPORT MUST BE AOR=ALL/ALL FOR BRAND         
         B     CLVERR                                                           
*                                                                               
CLVSLER DS     0H                                                               
         MVI   ERROR,PWECLSLI      SPACE CLIENTS INVALID FOR CONTONLY           
         B     CLVERR                                                           
*                                                                               
CLVERRXC DS    0H                                                               
         USING GETTXTD,GETTXTCB    ESTABLISH GETTXT CONTROL BLOCK               
*                                                                               
         LHI   RF,PWEXCLEQ         EXCLUDED CLT = REQUESTED CLT                 
         STCM  RF,3,GTMSGNO        SET ERROR MESSAGE                            
         B     CLVERR                                                           
*                                                                               
CLVSNER DS     0H                                                               
         MVI   ERROR,PWESOONR      SOON RESTRICTION REQUEST ERROR               
*                                                                               
CLVERR   DS    0H                                                               
*                                                                               
         MVI   FIELDERR,1          FIRST FIELD IN ERROR                         
         XC    BLOCK(42),BLOCK     INIT SCANNER BLOCK AREA                      
         LA    R4,BLOCK            DUNMMY SCANNER BLOCK                         
*                                                                               
         GOTO1 CURSERR             GO HANDLE ERROR MESSAGE                      
*                                                                               
CLIVALX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'PRWRIGEN - PRINT WRITER ROOT PHASE - PBVAL'                     
***********************************************************************         
*                                                                     *         
*        VALIDATE PUBLICATION                                         *         
*                                                                     *         
*NTRY    R2 ==>  PUB FIELD ON SCREEN                                  *         
*                                                                     *         
*EXIT                                                                 *         
*        NEQ CC SET ON ERROR                                          *         
*                                                                     *         
***********************************************************************         
         DS    0D                                                               
PBVAL    NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING SPOOLD,R8                                                        
         USING SYSD,R9                                                          
         USING T405FFD,RA                                                       
         USING GEND,RC                                                          
*                                                                               
         XC    PBQPUB(6),PBQPUB                                                 
         XC    PBQREPF,PBQREPF     CLEAR REP FILTER                             
         XC    PBQPBLSH,PBQPBLSH   CLEAR PUBLISHER FILTER                       
         XC    PBQLISCD,PBQLISCD   CLEAR PUBLIST CODE                           
*                                                                               
         SR    RE,RE                                                            
*                                                                               
         ICM   RE,1,5(R2)          DONE IF NO ENTRY                             
         BZ    PBVALX                                                           
*                                                                               
         CLI   8(R2),C'='          CHECK FOR PUB NAME SEARCH                    
         BNE   PBVSRCHN                                                         
*                                                                               
         LA    R3,WORK             SET UP SRCHCALL PARMS                        
         USING DSPARM,R3                                                        
*                                                                               
         XC    DSPARM(DSPARML),DSPARM                                           
*                                                                               
         MVC   DSMEDCOD,PBQMED                                                  
*                                                                               
         CLI   PBQMED,C' '         SINGLE MEDIA REQUIRED                        
         BE    PBVMEDER                                                         
         CLI   PBQMED,C'*'         SINGLE MEDIA REQUIRED                        
         BE    PBVMEDER                                                         
         CLI   PBQMED,C'C'         SINGLE MEDIA REQUIRED                        
         BE    PBVMEDER                                                         
*                                                                               
         SR    R2,RA               DISPLACEMENT INTO TWA                        
*                                                                               
         GOTO1 =V(SRCHCALL),DMCB,(3,(R2)),(X'80',(RA)),ACOMFACS,       X        
               ('DSPARML',WORK),(1,=CL8'PUB'),0,RR=RELOPGEN                     
*                                                                               
         B     PBVALX                                                           
*                                                                               
         DROP  R3                                                               
*                                                                               
PBVSRCHN DS    0H                                                               
*                                                                               
*        SEPARATE VALIDATION IF THIS IS A GROUP ORIENTED REPORT                 
*              STARTS WITH 'G='                                                 
*                                                                               
         CLC   =C'G=',8(R2)        IF GROUP INDICATOR ENTERED                   
         BNE   PBVGRPN                VALIDATE AS GROUP CODE                    
*                                                                               
         GOTOR GRPVAL,VGRPPUBQ        VALIDATE PUB GROUP                        
*                                                                               
         B     PBVALX              DONE                                         
*                                                                               
PBVGRPN  DS    0H                                                               
*                                                                               
         CLC   8(3,R2),=C'ALL'     OKAY IF ALL PUBS                             
         BE    PBVALX                                                           
*                                                                               
*        FILTER ON PUBLISHER                                                    
*                                                                               
PBVPBL   DS    0H                                                               
*                                                                               
         CLC   8(6,R2),=C'PBLSH='      PUBLISHER                                
         BNE   PBVPBLN                                                          
*                                                                               
         CLI   BRANDSW,C'Y'        NOT ALLOWED FOR BRAND AGY AOR RPTS           
         BE    PBVBRDE                                                          
*                                                                               
         CLI   5(R2),7             PUBLISHER CODE MUST BE 1 TO 4 CHS            
         BL    PBVPBLER                                                         
*                                                                               
         CLI   5(R2),10                                                         
         BH    PBVPBLER                                                         
*                                                                               
         SH    RE,=H'7'                                                         
         EX    RE,*+8                                                           
         B     *+10                                                             
         CLC   14(0,R2),=C'0000'   PUBLISHER CODE MUST BE NUMERIC               
         BL    PBVPBLER                                                         
*                                                                               
         EX    RE,*+8                                                           
         B     *+10                                                             
         PACK  WORK(3),14(0,R2)                                                 
*                                                                               
         UNPK  PBQPBLSH,WORK(3)    SAVE CODE                                    
*                                                                               
*        SEE IF PUBLISHER EXISTS                                                
*                                                                               
         CLI   PBQMED,C'*'        CANNOT VALIDATE                               
         BE    *+8                                                              
         CLI   PBQMED,C'C'        CANNOT VALIDATE                               
         BE    PBVPBLX                                                          
*                                                                               
*        VERIFY PUBLISHER RECORD EXISTS                                         
*              BY FINDING PASSIVE FOR THIS PUBLISHER                            
*                                                                               
         XC    KEY,KEY                                                          
*                                                                               
         LA    R4,KEY              ESTABLISH PUBLISHER RECORD                   
         USING PUBRECD,R4                                                       
*                                                                               
*        BUILD KEY                                                              
*                                                                               
         MVI   PUBPKCOD,X'F0'      RECORD CODE                                  
         MVI   PUBPKSCD,C'P'       SUBTYPE CODE - PUBLISHER                     
         MVC   PUBPKAGY,AGENCY     AGENCY                                       
         MVC   PUBPKMED,PBQMED     MEDIA                                        
         MVC   PUBPKREP,PBQPBLSH   PUBLISHER CODE                               
*                                                                               
         MVI   RDUPDATE,C'N'       NOT READING FOR UPDATE                       
*                                                                               
         MVC   FILENAME,=CL8'PUBDIR'   PUBFILE                                  
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
         XC    FILENAME,FILENAME   RESET TO DEFAULT FILE                        
*                                                                               
         CLC   KEY(09),KEYSAVE     ERROR IF NO PASSIVE FOUND                    
         BNE   PBVPBLER                                                         
*                                                                               
PBVPBLX  DS    0H                                                               
         B     PBVALX                                                           
*                                                                               
PBVPBLN  DS    0H                                                               
*                                                                               
*        FILTERING ON REP                                                       
*                                                                               
PBVREP   DS    0H                                                               
*                                                                               
         CLC   8(6,R2),=C'RPCON='      CONTRACT REP                             
         BNE   *+16                                                             
         LA    R3,6                LABEL LENGTH                                 
         MVI   PBQREPF+4,C'C'                                                   
         B     PBVREP10                                                         
*                                                                               
         CLC   8(6,R2),=C'RPPAY='      PAYING REP                               
         BNE   *+16                                                             
         LA    R3,6                LABEL LENGTH                                 
         MVI   PBQREPF+4,C'P'                                                   
         B     PBVREP10                                                         
*                                                                               
         CLC   8(6,R2),=C'RPTRA='      TRAFFIC REP                              
         BNE   *+16                                                             
         LA    R3,6                LABEL LENGTH                                 
         MVI   PBQREPF+4,C'T'                                                   
         B     PBVREP10                                                         
*                                                                               
         CLC   8(4,R2),=C'SREP='       SPECIAL REP                              
         BNE   *+16                                                             
         LA    R3,5                LABEL LENGTH                                 
         MVI   PBQREPF+4,C'S'                                                   
         B     PBVREP10                                                         
*                                                                               
         B     PBVREPN                                                          
*                                                                               
PBVREP10 DS    0H                                                               
*                                                                               
         LA    R3,8(R3,R2)         POINT TO REP CODE                            
*                                                                               
         SR    RF,RF                                                            
         IC    RF,5(R2)            GET REP ENTRY LENGTH                         
*                                                                               
         LA    RF,8(RF,R2)         END OF REP ENTRY                             
*                                                                               
         SR    RF,R3               REP CODE LENGTH                              
         BNP   PBVREPX                                                          
*                                                                               
         CLI   0(R3),C'-'          IF A NEGATIVE REP FILTER                     
         BNE   PBVREP20                                                         
*                                                                               
         NI    PBQREPF+4,X'FF'-X'40' MAKE ID LOWERCASE                          
         LA    R3,1(R3)            BUMP REP CODE POINTER                        
         BCT   RF,*+8              DECREMENT CODE LENGTH                        
         B     PBVREPX             NO REP CODE ENTERED                          
*                                                                               
PBVREP20 DS    0H                                                               
*                                                                               
         CH    RF,=H'1'            CODE MUST BE 1 TO 4 LONG                     
         BL    PBVREPER                                                         
         CH    RF,=H'4'                                                         
         BH    PBVREPER                                                         
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         CLC   0(0,R3),=C'0000'    REP CODE MUST BE NUMERIC                     
         BL    PBVREPER                                                         
*                                                                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         PACK  WORK(3),0(0,R3)                                                  
*                                                                               
         UNPK  PBQREPF(4),WORK(3)  SAVE REP CODE                                
*                                                                               
* SEE IF REP EXISTS                                                             
*                                                                               
         CLI   PBQMED,C'*'        CANNOT VALIDATE                               
         BE    *+8                                                              
         CLI   PBQMED,C'C'        CANNOT VALIDATE                               
         BE    PBVREPX                                                          
*                                                                               
         XC    KEY,KEY                                                          
*                                                                               
         LA    R4,KEY              ESTABLISH REP RECORD KEY                     
         USING PREPRECD,R4                                                      
*                                                                               
         MVI   PREPKRCD,X'11'      RECORD CODE                                  
         MVC   PREPKAGY,AGENCY     AGENCY                                       
         MVC   PREPKMED,PBQMED     MEDIA                                        
         MVC   PREPKREP,PBQREPF    REP CODE                                     
*                                                                               
         MVI   RDUPDATE,C'N'       NON UPDATIVE READ                            
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(10),KEYSAVE                                                  
         BNE   PBVREPER                                                         
*                                                                               
PBVREPX  DS    0H                                                               
         B     PBVALX                                                           
*                                                                               
PBVREPN  DS    0H                                                               
*                                                                               
*        ALLOW LIST= FOR PUBLIST                                                
*                                                                               
PBVLST   DS    0H                                                               
*                                                                               
         CLC   8(5,R2),=C'LIST='   LIST?                                        
         BNE   PBVLSTN                                                          
*                                                                               
         LA    R3,8+5(R2)          POINT TO LIST CODE                           
*                                                                               
         SR    RF,RF                                                            
         IC    RF,5(R2)            GET REP ENTRY LENGTH                         
*                                                                               
         LA    RF,8(RF,R2)         END OF LIST ENTRY                            
*                                                                               
         SR    RF,R3               LIST CODE LENGTH                             
         BNP   PBVLST1E                                                         
*                                                                               
         CH    RF,=H'1'            CODE MUST BE 2 TO 3 LONG                     
         BL    PBVLST1E                                                         
         CH    RF,=H'4'                                                         
         BH    PBVLST1E                                                         
*                                                                               
         MVC   PBQLISCD,SPACES                                                  
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   PBQLISCD(0),0(R3)   SAVE LIST CODE                               
*                                                                               
*        SEE IF LIST EXISTS                                                     
*                                                                               
         CLI   PBQMED,C'*'        NEED A MEDIA                                  
         BE    *+8                                                              
         CLI   PBQMED,C'C'                                                      
         BE    PBVLST3E                                                         
*                                                                               
         LA    R4,KEY              ESTABLISH PUB LIST RECORD KEY                
         USING PLISREC,R4                                                       
*                                                                               
         XC    KEY,KEY                                                          
*                                                                               
         MVI   PLISKRCD,X'17'      RECORD CODE                                  
         MVC   PLISKAGY,AGENCY     AGENCY                                       
         MVC   PLISKMED,PBQMED     MEDIA                                        
         MVC   PLISKCLT,PBQCLT     CLIENT                                       
         MVC   PLISKCOD,PBQLISCD   LIST CODE                                    
*                                                                               
         MVI   RDUPDATE,C'N'       NON UPDATIVE READ                            
*                                                                               
         MVC   KEYSAVE,KEY         SAVE STARTING KEY                            
*                                                                               
         CLC   PBQCLT,=C'ALL'     IF ALL CLIENTS USE ZZZ FOR CLIENT             
         BE    PBVLSTZZ                                                         
         CLI   PBQCLT,C'*'        OFFICE                                        
         BE    PBVLSTZZ                                                         
         CLC   PBQCLT,SPACES      ALL CLIENTS                                   
         BNH   PBVLSTZZ                                                         
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
*        MUST FIND KEY THAT MATCHES LIST CODE                                   
*                                                                               
         CLC   PLISKEY(PLISKLIN-PLISKEY),KEYSAVE                                
         BE    PBVLSTX                                                          
*                                                                               
PBVLSTZZ DS    0H                  LOOK FOR LIST UNDER CLIENT ZZZ               
*                                                                               
         MVC   PLISKEY,KEYSAVE     RESTORE STARTING KEY                         
*                                                                               
         MVC   PLISKCLT,=C'ZZZ'    CHANGE CLIENT TO ZZZ                         
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
*        MUST FIND KEY THAT MATCHES LIST CODE                                   
*                                                                               
         CLC   PLISKEY(PLISKLIN-PLISKEY),KEYSAVE                                
         BNE   PBVLST2E            ERROR IF NOT FOUND                           
*                                                                               
PBVLSTX  DS    0H                                                               
*                                                                               
         B     PBVALX                                                           
*                                                                               
PBVLSTN  DS    0H                                                               
*                                                                               
*        PUB NUMBER ENTERED                                                     
*                                                                               
*  ALLOW FOR 'ALL' TO FOLLOW PUB NUMBER/ PROCESS ALL ZONES AND EDITONS          
*                                                                               
PBVPUB   DS    0H                                                               
*                                                                               
         LA    RF,8(R2)            POINT TO STRING                              
*                                                                               
PBV4CO   CLI   0(RF),C','          CHECK FOR A DELIMITER                        
         BE    PBVCOMMA                                                         
         LA    RF,1(RF)                                                         
         BCT   RE,PBV4CO                                                        
*                                                                               
         B     PBVNORM             NO DELIMITER                                 
*                                                                               
PBVCOMMA CLC   =C'ALL',1(RF)       SEE IF ALL ZONE/ED                           
         BNE   PBVNORM                                                          
*                                                                               
         MVI   PBQALLZN,C'Y'                                                    
*                                                                               
PBVNORM  ZIC   R4,5(R2)            ORIGINAL LENGTH                              
*                                                                               
         CLI   PBQALLZN,C'Y'       ALL REQUESTED                                
         BNE   *+8                                                              
         SH    R4,=H'4'            REDUCE LEN BY ,ALL                           
*                                                                               
         GOTO1 PUBVAL,DMCB,((R4),8(R2)),PBQPUB                                  
*                                                                               
         CLI   0(R1),X'FF'         TEST PUBVAL ERROR                            
         BE    PBVPUBER                                                         
*                                                                               
         CLI   PBQMED,C'*'         MUST BE SINGLE MEDIA                         
         BE    PBVPUBER                                                         
         CLI   PBQMED,C'C'                                                      
         BE    PBVPUBER                                                         
*                                                                               
         XC    KEY,KEY             READ PUB RECORD                              
***      =================  ***                                                 
         LA    R4,KEY                                                           
         USING PUBRECD,R4                                                       
***      =================  ***                                                 
*                                                                               
         MVC   PUBKMED,PBQMED                                                   
         MVC   PUBKPUB(6),PBQPUB   MOVE PUB/ZONE/EDTN                           
         MVC   PUBKAGY,AGENCY                                                   
         MVI   PUBKCOD,X'81'                                                    
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
*                                                                               
         MVC   FILENAME,=CL8'PUBDIR'                                            
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
         XC    FILENAME,FILENAME                                                
*                                                                               
         LA    RF,24               SET KEY COMPARE LENGTH                       
*                                                                               
         CLI   PBQALLZN,C'Y'                                                    
         BNE   *+8                                                              
         LA    RF,4                JUST CHECK MED/PUB                           
*                                                                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         CLC   KEY(0),KEYSAVE      CHECK IF PUB ON FILE                         
*                                                                               
         BNE   PBVPUBER                                                         
*                                                                               
PBVALX   DS    0H                                                               
         XIT1                                                                   
*                                                                               
         USING GETTXTD,GETTXTCB    ESTABLISH GETTXT CONTROL BLOCK               
*                                                                               
PBVMEDER DS    0H                                                               
         MVI   ERROR,PWESCHMD      SET ERROR CODE                               
         B     PBVERR                                                           
*                                                                               
PBVPUBER DS    0H                                                               
         MVI   ERROR,INVPUB                                                     
         B     PBVERR                                                           
*                                                                               
PBVBRDE  MVI   ERROR,PWEPBLBE      BRAND AGENCIES CAN'T REQUEST                 
         B     PBVERR                                                           
*                                                                               
PBVPBLER MVI   ERROR,INVPUB                                                     
         B     PBVERR                                                           
*                                                                               
PBVREPER MVI   ERROR,PWEREPNV      INVALID REP                                  
         B     PBVERR                                                           
*                                                                               
PBVLST1E DS    0H                  INVALID LIST CODE                            
         LHI   RF,PWELSTNV                                                      
         STCM  RF,3,GTMSGNO        SET ERROR MESSAGE                            
         B     PBVERR                                                           
*                                                                               
PBVLST2E DS    0H                  LIST CODE NOT ON FILE                        
         LHI   RF,PWELSTNF                                                      
         STCM  RF,3,GTMSGNO        SET ERROR MESSAGE                            
         B     PBVERR                                                           
*                                                                               
PBVLST3E DS    0H                  LIST CODE NEEDS SINGLE MEDIA                 
         LHI   RF,PWELSTMD                                                      
         STCM  RF,3,GTMSGNO        SET ERROR MESSAGE                            
         B     PBVERR                                                           
*                                                                               
PBVERR   DS    0H                                                               
*                                                                               
         MVI   FIELDERR,1          FIRST FIELD IN ERROR                         
         XC    BLOCK(42),BLOCK     INIT SCANNER BLOCK AREA                      
         LA    R4,BLOCK            DUMMY SCANNER BLOCK                          
*                                                                               
         GOTO1 CURSERR             GO HANDLE ERROR MESSAGE                      
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'PRWRIGEN - PRINT WRITER ROOT PHASE - OFCVAL'                    
***********************************************************************         
*                                                                     *         
*        VALIDATE CLIENT MEDIA OFFICE CODE AND CHECK AUTHORIZATION    *         
*                                                                     *         
*NTRY    PARM0+0  XL1 - LENGTH OF OFFICE CODE                         *         
*        PARM0    A   - A(MEDIA OFFICE CODE)                          *         
*        PARM1    A   - A(OFFICE CONTROL BLOCK) PRESET TO NULLS       *         
*                                                                     *         
*EXIT    CC     BNE -OFFICE CODE INVALID OR CLIENT NOT AUTHORIZED     *         
*                                                                     *         
***********************************************************************         
         DS    0D                                                               
OFCVAL   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING SPOOLD,R8                                                        
         USING GEND,RC                                                          
         USING SYSD,R9                                                          
         USING T405FFD,RA                                                       
*                                                                               
         LR    R2,R1               SAVE PARAMETER LIST POINTER                  
         L     R4,0(R2)            POINT TO MEDIA OFFICE CODE                   
*                                                                               
         L     R3,4(R2)               USE OFFICER                               
*                                                                               
         USING OFFICED,R3                                                       
*                                                                               
         MVI   OFCSYS,C'P'         SYSTEM                                       
*****    MVC   OFCAUTH,TWAACCS     SIGN ON LIMITS                               
         MVC   OFCAGY,AGENCY       AGENCY ID                                    
*                                                                               
         MVC   OFCOFC2,=C'  '      PREFILL OFFICE CODE WITH BLANKS              
         SR    RF,RF                                                            
         IC    RF,0(R2)            OFFICE CODE LENGTH                           
         SHI   RF,1                DECREMENT FOR EXECUTE                        
         BM    OFCVALER            MUST BE NON-NEGATIVE LENGTH                  
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   OFCOFC2(0),0(R4)    REQUESTED OFFICE                             
*                                                                               
         MVC   OFCLMT,TWAACCS      LIMIT ACCESS VALUE                           
*                                                                               
         MVC   OFCSECD,ASECBLK     A(FASECRET BLOCK)                            
*                                                                               
         GOTO1 OFFICER,PARAS,(C'2',OFFICED),(0,ACOMFACS)                        
*                                                                               
         CLI   0(R1),0                                                          
         BNE   OFCVALER            DID NOT PASS SECURITY TEST                   
*                                                                               
         CR    RB,RB               SET EQUAL CC                                 
*                                                                               
         B     OFCVALX                                                          
*                                                                               
OFCVALER DS    0H                                                               
*                                                                               
         LTR   RB,RB               SET NOT EQUAL CC                             
*                                                                               
OFCVALX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'PRWRIGEN - PRINT WRITER ROOT PHASE - CLTMED'                    
***********************************************************************         
*                                                                     *         
*        FIND NEXT MEDIA FOR CLIENT KEY                               *         
*                                                                     *         
*NTRY    KEY    CLIENT KEY FOR LAST MEDIA                             *         
*                 MEDIA = NULLS MEANS FIRST TIME                      *         
*                                                                     *         
*EXIT    KEY    CLIENT KEY FOR NEXT MEDIA                             *         
*                 CC NE MEANS END OF MEDIA                            *         
*                                                                     *         
***********************************************************************         
         DS    0D                                                               
CLTMED   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING SPOOLD,R8                                                        
         USING GEND,RC                                                          
         USING SYSD,R9                                                          
         USING T405FFD,RA                                                       
*                                                                               
         LA    R4,KEY              ESTABLISH CLIENT KEY                         
         USING PCLTKEY,R4                                                       
*                                                                               
         CLI   PCLTKMED,0          SKIP IF FIRST TIME                           
         BE    *+14                                                             
         CLC   PBQMED,PCLTKMED     DONE IF ONLY ONE MEDIA WANTED                
         BE    CMDDONE             AND WE HAVE JUST DONE IT                     
*                                                                               
         LA    R5,PBQMED           DEFAULT TO REQUEST MEDIA                     
*                                                                               
         CLI   PBQMED,C'*'         IF ALL MEDIA                                 
         BE    *+8                                                              
         CLI   PBQMED,C'C'         OR ALL MEDIA COMBINED                        
         BNE   CMDMEDX                                                          
*                                                                               
         LA    R5,CMDMEDLS            DEFAULT TO LIST OF ALL MEDIA              
*                                                                               
         OC    PBQMEDLS,PBQMEDLS   IF MEDIA LIST EXISTS                         
         BZ    *+8                                                              
         LA    R5,PBQMEDLS+1          USE IT INSTEAD                            
*                                                                               
         CLI   PCLTKMED,0          IF FIRST TIME                                
         BE    CMDMEDX                USE FIRST MEDIA IN LIST                   
*                                                                               
CMDMEDLP DS    0H                                                               
*                                                                               
         CLC   PCLTKMED,0(R5)      FIND CURRENT MEDIA IN LIST                   
         BE    CMDMEDFD                                                         
                                                                                
CMDMEDCN DS    0H                                                               
*                                                                               
         LA    R5,1(R5)                                                         
         B     CMDMEDLP                                                         
*                                                                               
CMDMEDFD DS    0H                                                               
*                                                                               
         LA    R5,1(R5)            BUMP TO NEXT MEDIA IN LIST                   
*                                                                               
         CLI   0(R5),C' '          CHECK FOR END OF LIST                        
         BNH   CMDDONE                                                          
*                                                                               
CMDMEDX  DS    0H                                                               
*                                                                               
         MVC   PCLTKMED,0(R5)      FILL IN NEXT MEDIA                           
*                                                                               
         CR    RB,RB               SET EQ CC                                    
*                                                                               
         B     CLTMEDX                                                          
*                                                                               
CMDDONE  DS    0H                  END OF MEDIAS                                
*                                                                               
         LTR   RB,RB               SET NE CC                                    
*                                                                               
CLTMEDX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
CMDMEDLS DC    C'ILMNOSTBVWD '         VALID MEDIA                              
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'PRWRIGEN - PRINT WRITER ROOT PHASE - VALOPTN'                   
***********************************************************************         
*                                                                     *         
*        VALIDATE REPORT OPTIONS                                      *         
*                                                                     *         
*NTRY    R2 ==>  OPTION FIELD ON SCREEN                               *         
*                                                                     *         
*EXIT    DMCB+8 ==>  ON ERROR TO OPTION IN ERROR                      *         
*                                                                     *         
***********************************************************************         
         DS    0D                                                               
VALOPTN  NTR1  BASE=*,LABEL=*                                                   
***      =================  ***                                                 
         USING SPOOLD,R8                                                        
         USING GEND,RC                                                          
         USING SYSD,R9                                                          
         USING T405FFD,RA                                                       
***      =================  ***                                                 
*                                                                               
         CLI   5(R2),0             EXIT IF NO OPTIONS ENTERED                   
         JE    VALOPTNX                                                         
*                                                                               
         MVI   ROWCOLSW,0          INIT CONTINUED FIELD SWITCH                  
*                                                                               
         ST    R2,ALASTCOL         SAVE COLUMN POINTER                          
*                                                                               
         MVI   FIELDERR,1          INIT FIELD IN ERROR COUNTER                  
         XC    BLOCK(240),BLOCK    INIT FIELD                                   
         XC    BLOCK+240(240),BLOCK+240                                         
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,5(R2)          FIELD LENGTH                                 
         LA    RE,7(RF,R2)         LAST BYTE OF INPUT                           
*                                                                               
         CLI   0(RE),C','          IF FIELD ENDS IN COMMA                       
         JNE   *+10                                                             
         BCTR  RF,0                   LENGTH DECREMENTED FOR SCANNER            
         STC   RF,5(R2)                                                         
*                                                                               
*        SCAN INPUT                                                             
*                                                                               
         GOTOR SCANNER,DMCB,(20,(R2)),(138,BLOCK),0                             
*                                                                               
         LA    R4,BLOCK            POINT TO FIRST SCANNED FIELD                 
*                                                                               
         ZIC   R0,4(R1)            GET NUMBER OF FIELDS                         
         LTR   R0,R0                                                            
         JZ    VOPTNVER            MUST HAVE ONE IF FIELD ENTERED               
*                                                                               
VOPTLOOP DS    0H                                                               
*                                                                               
         MVC   FIELDERR,4(R4)      FIRST BYTE OF CHUNK                          
*                                                                               
         CLI   12(R4),C'+'         IF HELP REQUESTED                            
         JNE   VOPTHLPX                                                         
*                                                                               
         GOTOR VPRHELP,DMCB,=AL2(PRQHMOPW),(R2),HELPCBLK SHOW HELP MENU         
*                                     FOR OPTIONS                               
         DC    H'0'                SHOULD NOT COME BACK                         
*                                                                               
VOPTHLPX DS    0H                                                               
*                                                                               
         EJECT                                                                  
*                                                                               
*        CHECK FOR '<' & '>' AS SEPARATORS                                      
*                                                                               
         BRAS  RE,SEPSCAN          CHECK FOR < AND >                            
         JNE   VOPTNVER            ERROR FOUND                                  
*                                                                               
*        VALIDATE OPTION AGAINST FILTERS                                        
*                                                                               
         L     R1,AVLPARMS                                                      
         USING VLPARMS,R1          ESTABLISH DDVAL PARAMETERS                   
*                                                                               
         GOTO1 VDDVAL,(R1),('VLPVALQ',=AL2(PRQWROPT)),                 X        
               (0(R4),12(R4)),AVLTAB,0,0,0                                      
*                                                                               
         CLI   VLPERR,0            CHECK FOR ERRORS                             
         JNE   VOPTNVER                                                         
*                                                                               
         L     R5,AVLTAB           POINT TO RETURNED TABLE                      
         USING VLTABD,R5           ESTABLISH TABLE ENTRY                        
*                                                                               
         SR    RF,RF               GET INTERNAL CODE                            
         ICM   RF,3,VLTICODE                                                    
*                                                                               
         DROP  R1,R5                                                            
*                                                                               
*        CHECK FOR OPTIONS WITH SPECIAL VALIDATION ROUTINES                     
*                                                                               
         L     R1,=A(VOPTRTB)      POINT TO TABLE OF ROUTINES                   
         A     R1,RELOPGEN         RELOCATE ADDRESS                             
         LHI   RE,VOPTRTB#         NUMBER OF ENTRIES IN TABLE                   
*                                                                               
VOPTRTLP DS    0H                                                               
*                                                                               
         CH    RF,0(R1)           MATCH ON OPTION                               
         JE    VOPTRTFD                                                         
*                                                                               
VOPTRTCN DS    0H                                                               
*                                                                               
         LA    R1,VOPTRTBL(R1)     BUMP TO NEXT TABLE ENTRY                     
         BCT   RE,VOPTRTLP         CHECK NEXT ENTRY                             
*                                                                               
         B     VOPTRTDN                                                         
*                                                                               
VOPTRTFD DS    0H                  ROUTINE FOUND                                
*                                                                               
         L     RF,4(R1)            POINT TO VALIDATION ROUTINE                  
         A     RF,RELOPGEN         RELOCATE ADDRESS                             
         BASR  RE,RF               GO TO ROUTINE                                
*                                                                               
         J     VOPTLPCN            NEXT OPTION                                  
*                                                                               
VOPTRTDN DS    0H                  NO SPECIAL ROUTINE                           
*                                                                               
VOPTBOX  DS    0H                                                               
*                                                                               
         CHI   RF,PRQOPBOX         BOX OPTION                                   
         JNE   VOPTBOXN                                                         
*                                                                               
         CLI   22(R4),C'N'         BOX OPTION MUST BE Y OR N                    
         JE    *+8                                                              
         CLI   22(R4),C'Y'                                                      
         JNE   VOPTNVER                                                         
*                                                                               
         MVC   BOXOPT,22(R4)       SAVE OPTION                                  
*                                                                               
         J     VOPTLPCN                                                         
*                                                                               
VOPTBOXN DS    0H                                                               
*                                                                               
VOPTCMA  DS    0H                  COMMAS TO BE DROPPED FROM NUMBERS            
*                                                                               
         CHI   RF,PRQOPCMA         COMMA=Y/N OPTION                             
         JNE   VOPTCMAN                                                         
*                                                                               
         CLI   1(R4),0             NO ENTRY NOT VALID                           
         JE    VOPTNVER                                                         
*                                                                               
         CLI   22(R4),C'Y'         COMMA OPTION MUST BE Y OR N                  
         JE    VOPTLPCN              Y - DEFAULT                                
*                                                                               
         CLI   22(R4),C'N'                                                      
         JNE   VOPTNVER                                                         
*                                                                               
         OI    PBQOPTS,PBQOXCMA      N - NO COMMAS                              
*                                                                               
         J     VOPTLPCN                                                         
*                                                                               
VOPTCMAN DS    0H                                                               
*                                                                               
*        BILL HEADER DATE OPTIONS                                               
*                                                                               
VOPTBH   DS    0H                                                               
*                                                                               
         SR    R3,R3               INIT DATES POINTER                           
*                                                                               
         CHI   RF,PRQOPBRD           BILL RUN     DATE                          
         JNE   VOPTBHDN                                                         
*                                                                               
         OC    ARFPBLK,ARFPBLK     IF RFP BEING INVOKED                         
         JZ    *+12                                                             
         BRAS  RE,BHDVAL              VALIDATE FOR RFP SYMBOLIC                 
         JE    VOPTLPCN                  SYMBOLIC ENTERED                       
*                                                                               
         LA    R3,PBQBRNST         SET FOR RUN    DATES                         
         J     VOPTBHD1                                                         
*                                                                               
VOPTBHDN DS    0H                                                               
*                                                                               
         CHI   RF,PRQOPBDD           BILL DUE     DATE                          
         JNE   *+8                                                              
         LA    R3,PBQBDUST         SET FOR DUE     DATES                        
*                                                                               
         CHI   RF,PRQOPBED           BILL EDI     DATE                          
         JNE   *+8                                                              
         LA    R3,PBQBEDST         SET FOR EDI     DATES                        
*                                                                               
         CHI   RF,PRQOPBID         BILL INVOICE DATE                            
         JNE   *+8                                                              
         LA    R3,PBQBIVST         SET FOR INVOICE DATES                        
*                                                                               
         CHI   RF,PRQOPBPD           BILL POSTING DATE                          
         JNE   *+8                                                              
         LA    R3,PBQBPSST         SET FOR POSTING DATES                        
*                                                                               
VOPTBHD1 DS    0H                                                               
*                                                                               
         LTR   R3,R3               SKIP IF NO DATES FOUND                       
         JZ    VOPTBHN                                                          
*                                                                               
         STCM  RF,3,HALF           SAVE OPTION CODE                             
*                                                                               
         LA    R5,WORK                                                          
         USING PERVALD,R5          ESTABLISH PERVAL WORKAREA                    
*                                                                               
         MVC   PVALBSTA,BTODAY     PASS TODAY'S DATE                            
*                                                                               
         L     RF,ACOMFACS         GET PERVAL ADDRESS                           
         L     RF,CPERVAL-COMFACSD(RF)                                          
*                                                                               
*        VALIDATE PERIOD WITH SINGLE DATE RETURNED AS SINGLE                    
*                                                                               
         GOTO1 (RF),DMCB,(1(R4),22(R4)),('PVINTOD+PVINSGLS',(R5))               
         TM    4(R1),X'03'         CHECK FOR INVALID DATES                      
         JNZ   VOPTDTNV                                                         
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,3,HALF           RETRIEVE OPTION                              
*                                                                               
         CHI   RF,PRQOPBED         IF EDI DATES FILTER                          
         JNE   VOPTBEDN                                                         
*                                                                               
         MVC   0(2,R3),PVALCSTA    SAVE START AND END EDIT DATES                
         MVC   2(2,R3),PVALCEND      COMPRESSED                                 
*                                                                               
         TM    4(R1),X'04'         IF ONLY ONE DATE ENTERED                     
         JNO   *+14                                                             
         MVC   2(2,R3),0(R3)          COPY START TO END DATE                    
         J     VOPTBEDX                                                         
*                                                                               
         CLC   0(2,R3),2(R3)       START DATE MUST BE BEFORE END DATE           
         JH    VOPTDTER                                                         
*                                                                               
VOPTBEDX DS    0H                                                               
         J     VOPTBHX                                                          
*                                                                               
VOPTBEDN DS    0H                                                               
*                                                                               
         MVC   0(6,R3),PVALBSTA    SAVE START AND END DATES                     
*                                                                               
         TM    4(R1),X'04'         IF ONLY ONE DATE ENTERED                     
         JNO   *+14                                                             
         MVC   3(3,R3),0(R3)          COPY START TO END DATE                    
         J     VOPTBHX                                                          
*                                                                               
         CLC   0(3,R3),3(R3)       START DATE MUST BE BEFORE END DATE           
         JH    VOPTDTER                                                         
*                                                                               
         CHI   RF,PRQOPBRD           IF BILL RUN DATE                           
         JNE   VOPTBHX                                                          
*                                                                               
         MVC   PBQBLLST(6),0(R3)        COPY TO BILLED DATES                    
         MVC   PBQBST,PBQBLLST          COPY TO REQUEST DATES                   
         MVC   PBQBEND,PBQBLLND                                                 
         MVC   PBQSTART,PVALESTA                                                
         MVC   PBQEND,PVALEEND                                                  
*                                                                               
VOPTBHX  DS    0H                                                               
*                                                                               
         J     VOPTLPCN                                                         
*                                                                               
VOPTBHN  DS    0H                                                               
*                                                                               
         DROP  R5                                                               
*                                                                               
*        ACTIVITY DATES AND OTHER DATE FILTERS                                  
*                                                                               
VOPTATV  DS    0H                                                               
*                                                                               
         SR    R3,R3               INIT DATES POINTER                           
*                                                                               
         CHI   RF,PRQOPPGD          PG CUT OFF DATE                             
         JNE   *+8                                                              
         LA    R3,PBQPGDT          SET FOR PG CUTOFF DATE                       
*                                                                               
         CHI   RF,PRQOPCEN        '  CONTRACT END DATE                          
         JNE   *+8                                                              
         LA    R3,PBQCENST         SET FOR CONTRACT END DATES                   
*                                                                               
         CHI   RF,PRQOPATD         ACTIVITY DATE                                
         JNE   *+8                                                              
         LA    R3,PBQATVST         SET FOR ACTIVITY DATES                       
*                                                                               
         CHI   RF,PRQOPCDT        CHANGES DATE                                  
         JNE   *+8                                                              
         LA    R3,PBQCHGST         SET FOR CHANGES DATES                        
*                                                                               
         CHI   RF,PRQOPCOS        CHANGED BUYS ONLY                             
         JNE   VOPTAT10           NO                                            
         OI    PBBYOPTS,PBBYCHGQ   SET INDICATOR                                
         LA    R3,PBQCHGST        SET FOR CHANGES DATES                         
         OC    ARFPBLK,ARFPBLK    IF RFP BEING INVOKED                          
         JZ    *+12                                                             
         BRAS  RE,BHDVAL          VALIDATE FOR RFP SYMBOLIC                     
         JE    VOPTLPCN           SYMBOLIC ENTERED                              
*                                                                               
VOPTAT10 LTR   R3,R3               SKIP IF NO DATES FOUND                       
         JZ    VOPTATVN                                                         
*                                                                               
         LA    R5,WORK                                                          
         USING PERVALD,R5          ESTABLISH PERVAL WORKAREA                    
*                                                                               
         MVC   PVALBSTA,BTODAY     PASS TODAY'S DATE                            
*                                                                               
         L     RF,ACOMFACS         GET PERVAL ADDRESS                           
         L     RF,CPERVAL-COMFACSD(RF)                                          
*                                                                               
*        VALIDATE PERIOD WITH SINGLE DATE RETURNED AS SINGLE                    
*                                                                               
         GOTO1 (RF),DMCB,(1(R4),22(R4)),('PVINTOD+PVINSGLS',(R5))               
         TM    4(R1),X'03'         CHECK FOR INVALID DATES                      
         JNZ   VOPTDTNV                                                         
*                                                                               
         MVC   0(3,R3),PVALBSTA    SAVE START AND END DATES                     
         MVC   3(3,R3),PVALBEND                                                 
*                                                                               
         TM    4(R1),X'04'         IF ONLY ONE DATE ENTERED                     
         JNO   *+14                                                             
         XC    3(3,R3),3(R3)          CLEAR END DATE                            
         J     VOPTATVX                                                         
*                                                                               
         CLC   0(3,R3),3(R3)       START DATE MUST BE BEFORE END DATE           
         JH    VOPTDTER                                                         
*                                                                               
VOPTATVX DS    0H                                                               
*                                                                               
         J     VOPTLPCN                                                         
*                                                                               
VOPTATVN DS    0H                                                               
*                                                                               
         DROP  R5                                                               
*                                                                               
         EJECT                                                                  
*                                                                               
*        VERIFY PRESENCE OF STANDARD COMMENTS                                   
*                                                                               
VOPTCOM  DS    0H                                                               
*                                                                               
         CHI   RF,PRQOPSC1             STANDARD COMMENT 1                       
         JE    *+8                                                              
         CHI   RF,PRQOPSC2             STANDARD COMMENT 2                       
         JNE   VOPTCOMN                                                         
*                                                                               
         GOTOR SCOMVAL                                                          
*                                                                               
         J     VOPTLPCN                                                         
*                                                                               
VOPTCOMN DS    0H                                                               
*                                                                               
         EJECT                                                                  
*                                                                               
VOPTBKD  CHI   RF,PRQOPBKD         BANKDATE OPTION                              
         JNE   VOPTBKDX                                                         
*                                                                               
         OI    PBQOPTS,PBQOBNKD    SET FLAG                                     
*                                                                               
         J     VOPTLPCN                                                         
*                                                                               
VOPTBKDX DS    0H                                                               
*                                                                               
VOPT4    CHI   RF,PRQOPLEF         LEFT OPTION                                  
         JNE   VOPT34A                                                          
*                                                                               
         MVI   LEFTOPT,C'Y'                                                     
*                                                                               
         J     VOPTLPCN                                                         
*                                                                               
VOPT34A  CHI   RF,PRQOPTPE         WRITE TO TAPE                  L08           
         JNE   VOPT6A                                             L08           
*                                                                               
         MVI   PBQTAPE,C'Y'                                       L08           
*                                                                               
         J     VOPTLPCN                                           L08           
*                                                                               
         SPACE 1                                                                
*                                                                               
VOPT6A   CHI   RF,PRQOPPBL           ZERO PRINT                                 
         JNE   VOPT6B1                                                          
         MVI   PBQPZERO,C'N'                                                    
         J     VOPTLPCN                                                         
*                                                                               
VOPT6B1  DS    0H                                                  L22          
         CHI   RF,PRQOPNHD                                         L22          
         JNE   VOPT6B2                                             L22          
         OI    SPECOPT,GLDLNOHD    NOHEADINGS                      L22          
         J     VOPTLPCN                                            L22          
*                                                                               
VOPT6B2  DS    0H                                                  L22          
         CHI   RF,PRQOPSTR                                         L22          
         JNE   VOPT6B3                                             L22          
         OI    SPECOPT,GLDLSTRP    STRIP                           L22          
         J     VOPTLPCN                                            L22          
*                                                                               
VOPT6B3  DS    0H                                                  L22          
         CHI   RF,PRQOPNTR                                         L22          
         JNE   VOPT6B4                                             L22          
         OI    SPECOPT,GLDLNOTR     NO TRUNCATION                  L22          
         J     VOPTLPCN                                            L22          
*                                                                               
VOPT6B4  DS    0H                                                  L22          
         CHI   RF,PRQOPALP                                         L22          
         JNE   VOPT6B5A                                            L22          
         OI    SPECOPT,GLDLALPH     ALL DOWNLOAD IS ALPHA          L22          
         J     VOPTLPCN                                            L22          
*                                                                               
VOPT6B5A DS    0H                                                  L22          
         CHI   RF,PRQOPDTP                                         L22          
         JNE   VOPT6B5B                                            L22          
         OI    SPECOPT,GLDLALPH+GLDLSTRP+GLDLNOHD+GLDLNOTR+GLDLACTV M2          
         MVI   DOWNOPT,C'Y'                                                     
         J     VOPTLPCN                                            L22          
*                                                                               
VOPT6B5B DS    0H                                                  L22          
*                                                                               
         CHI   RF,PRQOPDHD           DOWNLOAD HEADLINES            L22          
         JNE   VOPT6B5                                             L22          
         OI    SPECOPT,GLDLHEAD                                                 
         MVI   DOWNOPT,C'Y'                                                     
         J     VOPTLPCN                                            L22          
*                                                                               
VOPT6B5  DS    0H                                                  L22          
*                                                                               
         CHI   RF,PRQOPDTL         DOWNTOT                        L22           
         JE    VOPTDWT1                                            L22          
*                                                                               
         CHI   RF,PRQOPDTT         DOWNTOTT                                     
         JNE   VOPTDWTN                                                         
*                                                                               
         OI    SPECOPT2,GLDLTTXT   KEEP TOTAL TEXT                              
*                                                                               
VOPTDWT1 DS    0H                                                  L22          
*                                                                               
         OI    SPECOPT,GLDLTOTS    DOWNLOAD TITLES                              
         MVI   DOWNOPT,C'Y'                                                     
*                                                                               
         CLI   22(R4),C' '         IF TOTAL CHARACTER GIVEN                     
         JNH   *+10                                                             
         MVC   SPECCHAR,22(R4)        PASS IT ON                                
*                                                                               
         J     VOPTLPCN                                            L22          
*                                                                               
VOPTDWTN DS    0H                                                  L22          
*                                                                               
         CHI   RF,PRQOPMDY         DATES IN MM/DD/YY FORMAT                     
         JNE   *+12                                                L22          
         MVI   PBQDTTYP,X'2A'      SET DATACON OUTPUT TYPE                      
         J     VOPTLPCN                                            L22          
*                                                                               
         CHI   RF,PRQOPYMD         DATES IN YYMMDD FORMAT         L22           
         JNE   VOPT6B6                                             L22          
*                                                                               
         OI    PBQPOPT,PBQPOYYM                                    L22          
         J     VOPTLPCN                                            L22          
*                                                                               
VOPT6B6  DS    0H                                                  L22          
*                                                                               
         CHI   RF,PRQOPDFX         ELIMINATE EXTRA BLANK COLUMN                 
         JNE   VOPT6B6B            WHEN DOWNLOADING TEXT= KYWD                  
*                                                                               
         OI    SPECOPT2,GLD2FIX                                    L22          
         J     VOPTLPCN                                            L22          
*                                                                               
VOPT6B6B DS    0H                                                  L22          
*                                                                               
         CHI   RF,PRQOPDLG         HANDLE FIELDS LONGER THAN 128 LONG           
         JNE   VOPT6B6C               WHEN DOWNLOADING                          
*                                                                               
         OI    SPECOPT2,GLD2128                                    L22          
         J     VOPTLPCN                                            L22          
*                                                                               
VOPT6B6C DS    0H                                                  L22          
*                                                                               
         CHI   RF,PRQOPRFP         DATES IN RFPDATE FORMAT                      
         JNE   VOPT6B6A                                                         
*                                                                               
         OI    PBQPOPT,PBQPORFP+PBQPOYYM                           L22          
         J     VOPTLPCN                                            L22          
*                                                                               
VOPT6B6A DS    0H                                                  L22          
*                                                                               
         CHI   RF,PRQOPCYM         DATES IN CCYYMMDD FORMAT                     
         JNE   VOPT6B7                                             L22          
*                                                                               
         OI    PBQPOPT,PBQPOYYM+PBQPOCTY                           L22          
         J     VOPTLPCN                                            L22          
*                                                                               
VOPT6B7  DS    0H                                                  L22          
*                                                                               
VOPT6B   CLC   12(2,R4),=C'S '   SPACING OPTION                     L01         
         JNE   VOPT6C                                                           
*                                                                               
         MVC   SPACOPT,22(R4)      SAVE NUMBER OF LINES TO SPACE    L01         
         NI    SPACOPT,X'0F'       KILL ZONE                                    
*                                                                               
         CLI   SPACOPT,1           MUST BE 1 TO 3                               
         JL    VOPTNVER                                                         
*                                                                               
         CLI   SPACOPT,3                                                        
         JH    VOPTNVER                                                         
*                                                                               
         J     VOPTLPCN                                                         
*                                                                               
VOPT6C   CHI   RF,PRQOPBSL         BILLSEL                         L18          
         JE    *+8                                                 L18          
         CHI   RF,PRQOPPSL         PAYSEL                                       
         JNE   VOPT6DD                                                          
*                                                                               
         CLI   PBFLAVOR,C'O'       INCONSISTENT IF CONTRACT ONLY REPORT         
         JE    VOPTCOER                                                         
*                                                                               
         OI    PBQPOPT,PBQPOBIL    SELECT OUT BILLED SPOTS         L18          
*                                                                               
         J     VOPTLPCN                                            L18          
*                                                                               
VOPT6DD  CHI   RF,PRQOPTOP         'TOP' NNN OF RANKING                         
         JNE   VOPT6D                                              L20          
*                                                                               
         TM    3(R4),X'80'         ENSURE NUMERIC                  L20          
         JNO   VOPTNVER                                            L20          
*                                                                               
         MVC   MAXRANK+1(3),9(R4)      VALUE                       L20          
*                                                                               
         J     VOPTLPCN                                            L20          
*                                                                               
*                                  MINTOT                                       
VOPT6D   CHI   RF,PRQOPMNT         OPTION TO SUPPRESS TOTAL WHEN THERE          
         JNE   VOPT7AA             IS ONLY ONE DETAIL LINE                      
*                                                                               
         NI    DRINDS,X'FF'-X'04'  REMOVE X'04'                                 
         J     VOPTLPCN                                                         
*                                                                               
VOPT7AA  DS    0H                                                               
*                                                                               
         CHI   RF,PRQOPGND         OPTION TO PRINT GRAND TOTALS                 
         JNE   VOPT7A                                                           
*                                                                               
* THIS IS A BIT TRICKY - IT'S PUTTING A TOTAL ELEM IN THE DRONE                 
* BUFFER AFTER THE REC ELEM TO CREATE GRAND TOTALS.  IT MUST BE                 
* DONE AFTER THE INITDRON CALL, BUT BEFORE ANY OTHER BUFFER ELEMS               
* ARE ADDED.  ALL THAT SHOULD BE IN THE BUFFER CURRENTLY IS 1002.               
*                                                                               
         L     R1,DRCURBUF         PUT IN REPORT TOTALS                         
         MVC   0(2,R1),=X'4802'                                                 
         LA    R1,2(R1)                                                         
         MVC   0(2,R1),=X'820A'                                                 
         MVC   2(8,R1),=C'NOREPORT'                                             
         LA    R1,10(R1)                                                        
         ST    R1,DRCURBUF                                                      
*                                                                               
         MVI   PRGRAND,C'Y'                                                     
*                                                                               
         J     VOPTLPCN                                                         
*                                                                               
VOPT7A   CLC  12(4,R4),=C'INCH'      REPORT NEWS BY INCHES                      
         JNE  *+12                                                              
         MVI  PBQINLIN,X'1F'                                                    
         J    VOPT7B                                                            
*                                                                               
         CLC  12(4,R4),=C'LINE'      REPORT NEWS BY LINES                       
         JNE  *+12                                                              
         MVI  PBQINLIN,X'2F'                                                    
         J    VOPT7B                                                            
*                                                                               
         CLC  12(4,R4),=C'BOTH'      PRINT BOTH                                 
         JNE  VOPT8                                                             
         MVI  PBQINLIN,X'3F'                                                    
         J    VOPT7B                                                            
*                                                                               
VOPT7B   DS    0H                                                               
*                                                                               
         CLI   PBFLAVOR,C'O'       INCONSISTENT IF CONTRACT ONLY REPORT         
         JE    VOPTCOER                                                         
         J     VOPTLPCN                                                         
*                                                                               
VOPT8    CLC   12(4,R4),=C'DOWN'   DOWNLOADING OPTION                           
         JNE   VOPT10                                                           
*                                                                               
         MVI   DOWNOPT,C'Y'                                                     
*                                                                               
         J     VOPTLPCN                                                         
*                                                                               
VOPT10   CLC   12(4,R4),=C'WIDE'   WIDE PRINTING (165)                          
         JNE   VOPT12                                                           
         MVI   WIDEOPT,C'Y'                                                     
         J     VOPTLPCN                                                         
*                                                                               
VOPT12   CLC   12(5,R4),=C'TRACE'  TRACE OPTION                                 
         JNE   VOPT14                                                           
         MVI   TRACEOPT,C'Y'                                                    
         MVI   PBQTRACE,C'Y'                                                    
         J     VOPTLPCN                                                         
*                                                                               
VOPT14   DS    0H                                                  L17          
*                                                                               
         CLC   12(4,R4),=C'PQIX'      INDEX OPTION                              
         JNE   *+12                                                             
         OI    NEWOPTS,NOPTPQIX    SET OPTION INDICATOR                         
         J     VOPTLPCN                                                         
*                                                                               
         CLC   12(3,R4),=C'CUT'       NO SECOND LINES              L17          
         JNE   VOPT14A                                             L17          
         OI    PBQPOPT,PBQPOCUT                                    L17          
         OI    SPECOPT,GLDLCUT                                    BUG03         
         J     VOPTLPCN                                            L17          
*======                                                                         
VOPT14A  DS    0H                                                               
         CLC   12(6,R4),=C'NOZERO'    NO ZERO BUYS                              
         JNE   VOPT16B                                                          
*                                                                               
         CLI   PBFLAVOR,C'O'       INCONSISTENT IF CONTRACT ONLY REPORT         
         JE    VOPTCOER                                                         
*                                                                               
         MVI   PBQZERO,C'N'                                                     
         NI    DRINDS,X'FF'-X'02'      DON'T PRINT DETAILS                      
*                                                                               
         J     VOPTLPCN                                                         
*======                                                                         
*    ==========CONTRACT START/END DATES WILL RULE IN FILTERING BUYS             
*=====                                                                          
VOPT16B  CLC   12(8,R4),=C'CONTRULE'                                            
         JNE   VOPT16C                                                          
*                                                                               
         MVI   PBFLAVOR,C'C'                                                    
         MVI   PBQCNRLE,C'Y'                                                    
         L     RF,AVLPARMS                 POINT TO DDVAL PARMS                 
         MVI   VLFLT4V-VLPARMS(RF),PKVFLCRL INDICATE CONTRACT REPORT            
         J     VOPTLPCN                                                         
*                                                                               
VOPT16C  CLC   12(8,R4),=C'CONTRACT'                                            
         JNE   VOPT16CX                                                         
         MVI   PBFLAVOR,C'C'                                                    
         L     RF,AVLPARMS                 POINT TO DDVAL PARMS                 
         MVI   VLFLT4V-VLPARMS(RF),PKVFLCRL INDICATE CONTRACT REPORT            
         J     VOPTLPCN                                                         
*                                                                               
VOPT16CX DS    0H                                                               
*                                                                               
         CLC   12(8,R4),=C'CONSPACE'  BUYS MUST BELONG TO CONTRACT              
         JNE   VOPTCSPX                                                         
*                                                                               
         OI    PBBYOPTS,PBBYCSPQ   SET INDICATOR                                
*                                                                               
         J     VOPTLPCN                                                         
*                                                                               
VOPTCSPX DS    0H                                                               
*                                                                               
VOPT16CA CLC   12(8,R4),=C'CONTONLY'                                            
         JNE   VOPTCONN                                                         
*                                                                               
*        OPTIONS INCONSISTENT WITH CONTRACT ONLY                                
*                                                                               
         CLI   PBQTEST,C'N'        ASKING FOR TEST OR DELETED BUYS              
         JNE   VOPTCOER                                                         
*                                                                               
         CLI   PBQZERO,C'N'        ASKING TO INCLUDE ZERO BUYS                  
         JE    VOPTCOER                                                         
*                                                                               
         TM    PBQPOPT,PBQPOSPL    ASKING TO NOT SPLIT POOL BUYS                
         JO    VOPTCOER                                                         
*                                                                               
         TM    PBQPOPT,PBQPODEL    ASKING TO LOOK AT DELETED BUYS               
         JO    VOPTCOER                                                         
*                                                                               
         OC    PBQDRDCL,PBQDRDCL   ASKING TO USE DRDCLI=                        
         JNZ   VOPTCOER                                                         
*                                                                               
         CLI   PBQINLIN,0          ASKING FOR SOME KIND OF INCH/LINE            
         JNE   VOPTCOER              CONVERSION                                 
*                                                                               
         TM    PBQPOPT,PBQPOBIL    ASKING TO LOOK AT BILLED SPOTS               
         JO    VOPTCOER                                                         
*                                                                               
         OC    PBQBLLST,PBQBLLST   ASKING TO USE BILLING DATES                  
         JNZ   VOPTCOER                                                         
*                                                                               
         MVI   PBFLAVOR,C'O'                                                    
         L     RF,AVLPARMS                 POINT TO DDVAL PARMS                 
         MVI   VLFLT4V-VLPARMS(RF),PKVFLCON INDICATE CONTRACT REPORT            
*                                                                               
         J     VOPTLPCN                                                         
*                                                                               
VOPTCONN DS    0H                                                               
*                                                                               
VOPTEST  DS    0H                                                               
*                                                                               
         CHI   RF,PRQOPEST         READ FILE BY ESTIMATE RECS                   
         JNE   VOPTESTN                                                         
*                                                                               
         OI    PBQREAD,PBQRDEST    FLAG TO READ ESTIMATE RECORDS                
*                                                                               
         CLC   =C'INPERIOD',22(R4) IF ESTS MUST LIE IN PERIOD                   
         JNE   *+8                                                              
         OI    PBQALLOP,PBQALEPR      SET SWITCH                                
*                                                                               
         J     VOPTLPCN                                                         
*                                                                               
VOPTESTN DS    0H                                                               
*                                                                               
         CHI   RF,PRQOPPUB         READ FILE BY PUB RECS                        
         JNE   VOPTPUBN                                                         
*                                                                               
         OI    PBQREAD2,PBQRDPBS   FLAG TO READ PUB RECORDS                     
*                                                                               
         J     VOPTLPCN                                                         
*                                                                               
VOPTPUBN DS    0H                                                               
*                                                                               
         CLC   =C'ALLINVS',12(R4)  READ FILE BY INVOICE RECS                    
         JNE   VOPTIVN                                                          
*                                                                               
         OI    PBQREAD2,PBQRDINV+PBQRDNV  FLAG TO READ INV RECS                 
*                                                                               
         J     VOPTLPCN                                                         
*                                                                               
VOPTIVN  DS    0H                                                               
*                                                                               
         CLC   =C'ALLREPS',12(R4)  READ FILE BY REP      RECS                   
         JNE   VOPTREPN                                                         
*                                                                               
         OI    PBQREAD2,PBQRDREP   FLAG TO READ REP      RECORDS                
*                                                                               
         J     VOPTLPCN                                                         
*                                                                               
VOPTREPN DS    0H                                                               
*                                                                               
         CLC   =C'ALLCIRCS',12(R4) READ FILE BY CIRCULATION RECS                
         JNE   VOPTCRCN                                                         
*                                                                               
         OI    PBQREAD2,PBQRDCRC   FLAG TO READ CIRCULATION RECORDS             
*                                                                               
         J     VOPTLPCN                                                         
*                                                                               
VOPTCRCN DS    0H                                                               
*                                                                               
VOPT16D  CLC   12(8,R4),=C'NOREQDET'  SKIPS REQUEST DETAIL PAGE                 
         JNE   VOPT16E                                            L16           
         OI    GENSTAT2,NOREQDET                                                
         MVI   NOREQDTL,C'Y'                                      L16           
         J     VOPTLPCN                                                         
*                                                                               
VOPT16E  DS    0H                                                               
*                                                                               
         CLC   12(7,R4),=C'DELONLY'                                L23          
         JNE   VOPT14C                                             L23          
*                                                                               
         CLI   PBFLAVOR,C'O'       INCONSISTENT IF CONTRACT ONLY REPORT         
         JE    VOPTCOER                                                         
*                                                                               
         MVI   PBQTEST,C'D'                                        L23          
*                                                                               
         J     VOPT14C1                                                         
*                                                                               
VOPT14C  CLC   12(6,R4),=C'DELETE' INCLUDE DELETED BUYS            L25          
         JNE   VOPT14D                                             L25          
*                                                                               
         CLI   PBFLAVOR,C'O'       INCONSISTENT IF CONTRACT ONLY REPORT         
         JE    VOPTCOER                                                         
*                                                                               
         OI    PBQPOPT,PBQPODEL                                    L25          
*                                                                               
VOPT14C1 DS    0H                                                               
*                                                                               
         CLI   1(R4),0             ANY DATES ENTERED               L24          
         JE    VOPTLPCN                                            L24          
*                                                                               
         LA    R5,WORK                                                          
         USING PERVALD,R5          ESTABLISH PERVAL WORKAREA                    
*                                                                               
         MVC   PVALBSTA,BTODAY     PASS TODAY'S DATE                            
*                                                                               
         L     RF,ACOMFACS         GET PERVAL ADDRESS                           
         L     RF,CPERVAL-COMFACSD(RF)                                          
*                                                                               
*        VALIDATE PERIOD WITH SINGLE DATE RETURNED AS SINGLE                    
*                                                                               
         GOTO1 (RF),DMCB,(1(R4),22(R4)),('PVINTOD+PVINSGLS',(R5))               
         TM    4(R1),X'03'         CHECK FOR INVALID DATES                      
         JNZ   VOPTDTNV                                                         
*                                                                               
         MVC   PBQDELST,PVALBSTA   SAVE START AND END DATES                     
         MVC   PBQDELND,PVALBEND                                                
*                                                                               
         TM    4(R1),X'04'         DONE IF ONLY ONE DATE ENTERED                
         JO    VOPTLPCN                                                         
*                                                                               
         CLC   PBQDELST,PBQDELND   START DATE MUST BE BEFORE END DATE           
         JH    VOPTDTER                                                         
*                                                                               
         J     VOPTLPCN                                                         
*                                                                               
VOPT14D  CLC   12(4,R4),=C'SPLIT'                                  L26          
         JNE   VOPT14X                                             L26          
*                                                                               
         CLI   PBFLAVOR,C'O'       INCONSISTENT IF CONTRACT ONLY REPORT         
         JE    VOPTCOER                                                         
*                                                                               
         CLI   22(R4),C'Y'                                         L26          
         JE    VOPTLPCN                                            L26          
         CLI   22(R4),C'N'         DO NOT SPLIT PASSIVE POL RECS   L26          
         JNE   VOPTNVER                                            L26          
         OI    PBQPOPT,PBQPOSPL                                    L26          
         J     VOPTLPCN                                            L26          
*                                                                               
VOPT14X  CLC   12(6,R4),=C'NARROW'  NARROW OPTION                               
         JNE   VOPT14Y                                                          
         MVI   NARROPT,C'Y'                                                     
         J     VOPTLPCN                                                         
*                                                                               
VOPT14Y  CLC   12(4,R4),=C'XBOX'                                                
         JNE   VOPT14Z                                                          
         OI    PBUNITS,GLEXTBOX                                                 
         MVI   XBOXSW,C'Y'         TEMP INDICATOR                  L29          
         J     VOPTLPCN                                                         
*                                                                               
VOPT14Z  CLC   12(4,R4),=C'TEST'  INCLUDE TEST BUYS                             
         JNE   VOPT14ZA                                                         
*                                                                               
         CLI   PBFLAVOR,C'O'       INCONSISTENT IF CONTRACT ONLY REPORT         
         JE    VOPTCOER                                                         
*                                                                               
         MVI   PBQTEST,C'Y'      NO                                             
         J     VOPTLPCN                                                         
*                                                                               
*                                                                               
VOPT14ZA CLC   12(4,R4),=C'TSTONLY'  INCLUDE TEST BUYS ONLY                     
         JNE   VOPT14ZB                                                         
*                                                                               
         CLI   PBFLAVOR,C'O'       INCONSISTENT IF CONTRACT ONLY REPORT         
         JE    VOPTCOER                                                         
*                                                                               
         MVI   PBQTEST,C'T'          ONLY                                       
         J     VOPTLPCN                                                         
*                                                                               
VOPT14ZB CLC   12(11,R4),=C'STEWARDONLY'  INCLUDE STEWARDSHIP BUYS ONLY         
         JNE   VOPT14ZC                                                         
*                                                                               
         CLI   PBFLAVOR,C'O'       INCONSISTENT IF CONTRACT ONLY REPORT         
         JE    VOPTCOER                                                         
*                                                                               
         OI    PBQOPSTW,PBQSTWOQ   INCLUDE STEWARDSHIP BUYS ONLY                
         J     VOPTLPCN                                                         
*                                                                               
VOPT14ZC CLC   12(7,R4),=C'STEWARD'  INCLUDE STEWARDSHIP BUYS                   
         JNE   VOPT14ZD                                                         
*                                                                               
         CLI   PBFLAVOR,C'O'       INCONSISTENT IF CONTRACT ONLY REPORT         
         JE    VOPTCOER                                                         
*                                                                               
         OI    PBQOPSTW,PBQSTWYQ   INCLUDE STEWARDSHIP BUYS                     
         J     VOPTLPCN                                                         
*                                                                               
VOPT14ZD DS    0H                                                               
*                                                                               
VOPT15   CLC   12(5,R4),=C'SOLID'    OPTION TO GET ALL THE DETAILS              
         JNE   VOPT15A                                                          
         OI    PBUNITS,GLPWHOLE                                                 
         J     VOPTLPCN                                                         
*                                                                               
VOPT15A  CLC   12(6,R4),=C'ALLTOT' OPTION TO GET ALL THE TOTALS                 
         JNE   VOPT15B                                                          
         OI    DRINDS,X'04'                                                     
         J     VOPTLPCN                                                         
*                                                                               
VOPT15B  CLC   12(6,R4),=C'ALLDET' OPTION TO GET ALL THE DETAILS                
         JNE   VOPT15C                                                          
         OI    DRINDS,X'02'                                                     
         J     VOPTLPCN                                                         
*                                                                               
VOPT15C  CLC   12(5,R4),=C'ROUND'    ROUNDING OPTION TOTALS ONLY                
         JNE   VOPT16                                                           
         OI    PBQGET,X'01' ROUND                                               
         J     VOPTLPCN                                                         
*                                                                               
VOPT16   DS    0H                  SEE IF DRD SCHEME REQUESTED                  
         CLC   12(6,R4),=C'DRDCLI'                                              
         JNE   VOPT16A                                                          
*                                                                               
         LA    R3,22(R4)           GET TO SECOND HALF OF REQUEST                
         CLI   1(R4),2             CHECK LENGTH OF CLIENT                       
         JL    VOPTNVER                                                         
         CLI   1(R4),3                                                          
         JH    VOPTNVER                                                         
*                                                                               
*  READ FOR DRD CLIENT                                                          
*                                                                               
         XC    KEY,KEY             GET CLIENT RECORD                            
         LA    RF,KEY              ESTABLISH CLIENT RECORD                      
         USING PCLTKEY,RF                                                       
*                                                                               
         MVC   PCLTKAGY,AGENCY                                                  
         BRAS  RE,CLTMED           SET FIRST MEDIA                              
         MVI   PCLTKRCD,X'02'                                                   
         MVC   PCLTKCLT,0(R3)                                                   
*                                                                               
         DROP  RF                                                               
*                                                                               
VOPTDRDL DS    0H                                                               
*                                                                               
         GOTO1 HIGH                READ FOR CLIENT HEADER                       
*                                                                               
         CLC   KEY(25),KEYSAVE                                                  
         JE    VOPTDRDF            CLIENT FOUND FOR MEDIA                       
*                                                                               
VOPTDRDC DS    0H                                                               
*                                                                               
         MVC   KEY,KEYSAVE         RESTORE CLIENT HEADER KEY                    
         BRAS  RE,CLTMED           FIND NEXT MEDIA                              
         JE    VOPTDRDL            NEW MEDIA FOUND                              
*                                                                               
         J     VOPTNVER            CLIENT NOT VALID FOR ANY MEDIA               
*                                                                               
VOPTDRDF DS    0H                                                               
*                                                                               
         MVC   PBQDRDCL,0(R3)                                                   
         MVI   PBQDRDSW,PBQDRDYQ   ASSUME DRD FIELDS TO COME                    
         J     VOPTLPCN                                                         
*                                                                               
VOPT16A  CLC   12(3,R4),=C'BD '    BILLED DATES                                 
         JNE   VOPT20                                                           
*                                                                               
         CLI   PBFLAVOR,C'O'       INCONSISTENT IF CONTRACT ONLY REPORT         
         JE    VOPTCOER                                                         
*                                                                               
         LA    R3,22(R4)                                                        
         GOTO1 DATVAL,DMCB,(R3),WORK                                            
         OC    0(4,R1),0(R1)                                                    
         JZ    VOPTNVER                                                         
         A     R3,0(R1)                                                         
         CLI   0(R3),C'-'                                                       
         JNE   VOPTNVER                                                         
         LA    R3,1(R3)                                                         
         GOTO1 DATVAL,DMCB,(R3),WORK+6                                          
         OC    0(4,R1),0(R1)                                                    
         JZ    VOPTNVER                                                         
         CLC   WORK(6),WORK+6                                                   
         JH    VOPTNVER                                                         
         GOTO1 DATCON,DMCB,WORK,(3,PBQBLLST)                                    
         GOTO1 DATCON,DMCB,WORK+6,(3,PBQBLLND)                                  
         MVC   PBQBST,PBQBLLST                                                  
         MVC   PBQBEND,PBQBLLND                                                 
         MVC   PBQSTART,WORK                                                    
         MVC   PBQEND,WORK+6                                                    
         J     VOPTLPCN                                                         
*                                                                               
VOPT20   CLC   12(5,R4),=C'TOTBT' TOTAL BOTH (LIVE AND TEST) + TST L10          
         JNE   VOPT21                                             L10           
*                                                                               
         CLI   PBFLAVOR,C'O'       INCONSISTENT IF CONTRACT ONLY REPORT         
         JE    VOPTCOER                                                         
*                                                                               
         MVI   PBQTEST,C'Y'                                       L10           
         MVI   PBQTOTTY,TOTTYPNT                                  L10           
         J     VOPTLPCN                                           L10           
*                                                                               
VOPT21   CLC   12(5,R4),=C'TOTLT'  TOTAL LIVE  AND TEST           L10           
         JNE   VOPT22                                             L10           
*                                                                               
         CLI   PBFLAVOR,C'O'       INCONSISTENT IF CONTRACT ONLY REPORT         
         JE    VOPTCOER                                                         
*                                                                               
         MVI   PBQTEST,C'Y'                                       L10           
         MVI   PBQTOTTY,TOTTYPLT                                  L10           
         J     VOPTLPCN                                           L10           
*                                                                               
VOPT22   DS    0H                                                               
*                                                                               
         CLC   12(6,R4),=C'CDONLY'                                L11           
         JNE   VOPT22A                                            L11           
*                                                                               
         CLI   PBFLAVOR,C'O'       INCONSISTENT IF CONTRACT ONLY REPORT         
         JE    VOPTCOER                                                         
*                                                                               
         MVI   PBQCDFLT,C'Y'                                      L11           
*                                                                               
         J     VOPT22B                                            L11           
*                                                                 L11           
VOPT22A  DS    0H                                                               
*                                                                 L11           
         CLC   12(7,R4),=C'NCDONLY'                               L11           
         JNE   VOPT25                                             L11           
*                                                                               
         CLI   PBFLAVOR,C'O'       INCONSISTENT IF CONTRACT ONLY REPORT         
         JE    VOPTCOER                                                         
*                                                                               
         MVI   PBQCDFLT,C'N'                                      L11           
*                                                                               
VOPT22B  MVC   FLDINSET,4(R4)      SAVE POINTER FOR POSSIBLE ERROR              
         J     VOPTLPCN                                           L11           
*                                                                               
VOPT25   DS    0H                                                               
         CLC   12(7,R4),=C'REPORT2'   SECOND REPORT WANTED                      
         JE    *+10                                                             
         CLC   12(8,R4),=C'CONTINUED' SECOND REPORT WANTED                      
         JNE   VOPT26                                                           
*                                                                               
         GOTOR VALRP2              VALIDATE SECOND REPORT                       
         JNE   VOPTRP2E            NOT VALID                                    
*                                                                               
         J     VOPTLPCN                                                         
*                                                                               
VOPT26   DS    0H                                                               
*                                                                               
*        CHECK FOR VARIABLE                                                     
*                                                                               
         CLI   12(R4),AMPERSND     SKIP UNLESS STARTS WITH AMPERSAND            
         JNE   VOPTAMPX                                                         
*                                                                               
         LA    RF,3                MAX 3 VARIABLES ALLOWED                      
         LA    R1,VARSAVE          POINT TO ALREADY SAVED VARIABLES             
*                                                                               
         OC    0(42,R1),0(R1)      FIND OPEN SLOT IN SAVEAREA                   
         JZ    *+16                                                             
         LA    R1,42(R1)           BUMP TO NEXT SLOT                            
         BRCT  RF,*-14                                                          
         J     VOPTNVER            INVALID OPTION                               
*                                                                               
         MVC   0(42,R1),0(R4)      SAVE SCANNER BLOCK                           
*                                                                               
         J     VOPTLPCN                                                         
*                                                                               
VOPTAMPX DS    0H                                                               
*                                                                               
*        VALIDATE FILTERS                                                       
*                                                                               
         CLC   12(3,R4),=C'SP1'                                                 
         JE    VF01AA                                                           
         CLC   12(3,R4),=C'SP2'                                                 
         JNE   VF10                                                             
VF01AA   CLI   PBQMED,C'N'         NO SPACE FILTER FOR NEWS                     
         JE    VFLTNVER                                                         
         CLI   PBQMED,C'C'         NO SPACE FILTER FOR COMBINED                 
         JE    VFLTNVER                                                         
         CLI   PBQMED,C'*'         NO SPACE FILTER FOR ALL MEDIA                
         JE    VFLTNVER                                                         
*                                                                               
*        SPACE FILTER - IF IT ENDS IN * THEN JUST MATCH UP TO *                 
*                                                                               
         MVI   BYTE,0              INIT WORKAREA                                
*                                                                               
         LA    R3,22(R4)           POINT TO FILTER VALUE                        
*                                                                               
         CLI   0(R3),C'-'          IF A NEGATIVE FILTER                         
         JNE   *+12                                                             
         MVI   BYTE,X'01'             SET WORK INDICATOR                        
         LA    R3,1(R3)               POINT TO SPACE DESCRIPTION                
*                                                                               
         LA    RE,L'PBQSPDS1       DEFAULT TO FILTER SAVEAREA LENGTH            
*                                                                               
         ZIC   RF,1(R4)            GET LENGTH OF FILTER                         
*                                                                               
         CLI   BYTE,0              IF NEGATIVE FILTER                           
         JE    *+6                                                              
         BCTR  RF,0                   ADJUST FILTER LENGTH                      
*                                                                               
         LA    R1,0(RF,R3)         POINT TO LAST BYTE OF FILTER                 
         BCTR  R1,0                                                             
*                                                                               
         CLI   0(R1),C'*'          IF FILTER ENDS IN WILDCARD                   
         JNE   *+8                                                              
         LR    RE,RF                  MAKE LENGTH EQUAL FILTER LENGTH           
         BCTR  RE,0                                                             
*                                                                               
         CLC   12(3,R4),=C'SP2'                                                 
         JE    VF01A                                                            
*                                                                               
         STC   RE,PBQSPD1L         SAVE FILTER LENGTH                           
*                                                                               
         CLI   BYTE,0              IF NEGATIVE FILTER                           
         JE    *+8                                                              
         OI    PBQSPD1L,X'80'         SET INDICATOR                             
*                                                                               
         LTR   RE,RE               NO LENGTH MEANS ACCEPT ALL SPACES            
         JZ    VF01AAA                                                          
*                                                                               
         BCTR  RE,0                DECREMENT FOR EXECUTE                        
         EX    RE,*+8                                                           
         J     *+10                                                             
         MVC   PBQSPDS1(0),0(R3)   SAVE FILTER                                  
*                                                                               
         OC    PBQSPDS1,SPACES     MAKE FILTER UPPERCASE                        
*                                                                               
VF01AAA  DS    0H                                                               
*                                                                               
         J     VOPTLPCN                                                         
*                                                                               
VF01A    DS    0H                                                               
*                                                                               
         STC   RE,PBQSPD2L         SAVE FILTER LENGTH                           
*                                                                               
         CLI   BYTE,0              IF NEGATIVE FILTER                           
         JE    *+8                                                              
         OI    PBQSPD2L,X'80'         SET INDICATOR                             
*                                                                               
         LTR   RE,RE               NO LENGTH MEANS ACCEPT ALL SPACES            
         JZ    VF01AAB                                                          
*                                                                               
         BCTR  RE,0                DECREMENT FOR EXECUTE                        
         EX    RE,*+8                                                           
         J     *+10                                                             
         MVC   PBQSPDS2(0),0(R3)   SAVE FILTER                                  
*                                                                               
         OC    PBQSPDS2,SPACES     MAKE FILTER UPPERCASE                        
*                                                                               
VF01AAB  DS    0H                                                               
*                                                                               
         J     VOPTLPCN                                                         
*                                                                               
VF10     DS    0H                                                               
*                                                                               
         MVC   FIELDERR,4(R4)      FIRST BYTE OF CHUNK                          
*                                                                               
         CLC   12(5,R4),=C'REFNO'                                               
         JNE   VFREFN                                                           
*                                                                               
*        SPACE FILTER - IF IT ENDS IN * THEN JUST MATCH UP TO *                 
*                                                                               
         LA    R3,22(R4)           POINT TO FILTER VALUE                        
*                                                                               
         LA    RE,L'PBREFFLT       DEFAULT TO FILTER SAVEAREA LENGTH            
*                                                                               
         ZIC   RF,1(R4)            GET LENGTH OF FILTER                         
*                                                                               
         LA    R1,0(RF,R3)         POINT TO LAST BYTE OF FILTER                 
         BCTR  R1,0                                                             
*                                                                               
         CLI   0(R1),C'*'          IF FILTER ENDS IN WILDCARD                   
         JNE   *+8                                                              
         LR    RE,RF                  MAKE LENGTH EQUAL FILTER LENGTH           
         BCTR  RE,0                                                             
*                                                                               
         STC   RE,PBREFFLL         SAVE FILTER LENGTH                           
*                                                                               
         LTR   RE,RE               NO LENGTH MEANS ACCEPT ALL                   
         JZ    VFREFX                                                           
*                                                                               
         BCTR  RE,0                DECREMENT FOR EXECUTE                        
         EX    RE,*+8                                                           
         J     *+10                                                             
         MVC   PBREFFLT(0),0(R3)   SAVE FILTER                                  
*                                                                               
         OC    PBREFFLT,SPACES     MAKE FILTER UPPERCASE                        
*                                                                               
VFREFX   DS    0H                                                               
*                                                                               
         J     VOPTLPCN                                                         
*                                                                               
VFREFN   DS    0H                                                               
*                                                                               
VF20     DS    0H                                                               
*                                                                               
         CLC   =C'ADF',12(R4)                                                   
         JNE   VF30                                                             
*                                                                               
         SR    R1,R1                                                            
         ICM   R1,1,1(R4)          INPUT LENGTH OF FILTER VALUE                 
         JZ    VFADNONE            MUST HAVE A FILTER ENTERED                   
*                                                                               
         LA    R3,L'PBQADFLT+1     MAX FILTER LENGTH                            
         LA    RF,PBQADFLT         START OF FILTER SAVEAREA                     
         LA    RE,22(R4)           INPUTTED FILTER START                        
*                                                                               
VFADLOOP DS    0H                                                               
*                                                                               
         CLI   0(RE),C'-'          CHECK FOR NEGATIVE FILTER                    
         JNE   VFAD10                                                           
*                                                                               
         LA    RE,1(RE)            POINT TO FILTER CHARACTER                    
         BRCT  R1,*+8              INPUT LENGTH COUNTER                         
         J     VFFLTNVE            MUST ENTER CHARACTER                         
*                                                                               
         MVC   0(1,RF),0(RE)       SAVE FILTER CHARACTER                        
         NI    0(RF),X'FF'-X'40'   INDICATE NEGATIVE FILTER                     
*                                                                               
         J     VFADLPCN                                                         
*                                                                               
VFAD10   DS    0H                                                               
*                                                                               
         MVC   0(1,RF),0(RE)       SAVE FILTER CHARACTER                        
*                                                                               
VFADLPCN DS    0H                                                               
*                                                                               
         LA    RE,1(RE)            BUMP TO NEXT INPUT CHARACTER                 
         LA    RF,1(RF)            BUMP TO NEXT SAVE POSITION                   
         BRCT  R3,*+8              DECREMENT SAVEAREA LENGTH COUNTER            
         J     VFADLNGE                                                         
*                                                                               
         BRCT  R1,VFADLOOP                                                      
*                                                                               
         J     VOPTLPCN            NO MORE FILTER TO PROCESS                    
*                                                                               
VF30     DS    0H                                                               
*                                                                               
         CHI   RF,PRQOPHON         NO HELD BUYS INCLUDED                        
         JNE   VFHNON                                                           
*                                                                               
         OI    PBQHLDSW,PBQRELOQ   SET INDICATOR                                
*                                                                               
VFHNOX   DS    0H                                                               
*                                                                               
         J     VOPTLPCN                                                         
*                                                                               
VFHNON   DS    0H                                                               
*                                                                               
*        CLC   =C'HELDONLY',12(R4)   HELD BUYS ONLY                             
         CHI   RF,PRQOPHON         HELD BUYS ONLY                               
         JNE   VFHONN                                                           
*                                                                               
         OI    PBQHLDSW,PBQHLDOQ   SET INDICATOR                                
*                                                                               
VFHONX   DS    0H                                                               
*                                                                               
         J     VOPTLPCN                                                         
*                                                                               
VFHONN   DS    0H                                                               
*                                                                               
         CHI   RF,PRQOPSRN          NO *RATE BUYS INCLUDED                      
         JNE   VFSRNN                                                           
*                                                                               
         OI    PBQHLDSW,PBQHSRNQ   SET INDICATOR                                
*                                                                               
VFSRNX   DS    0H                                                               
*                                                                               
         J     VOPTLPCN                                                         
*                                                                               
VFSRNN   DS    0H                                                               
*                                                                               
         CHI   RF,PRQOPSRO            *RATE BUYS ONLY                           
         JNE   VFSRON                                                           
*                                                                               
         OI    PBQHLDSW,PBQHSROQ   SET INDICATOR                                
*                                                                               
VFSROX   DS    0H                                                               
*                                                                               
         J     VOPTLPCN                                                         
*                                                                               
VFSRON   DS    0H                                                               
*                                                                               
*        FILTER ON INVOICE DATES                                                
*                                                                               
VOPTINV  DS    0H                                                               
*                                                                               
         CLI   0(R4),3             CHECK FOR INVOICE RANGE OPTION               
         JNE   VOPTINVN                                                         
*                                                                               
         CLC   =C'INV',12(R4)      INVOICE RANGE                                
         JNE   VOPTINVN                                                         
*                                                                               
         BRAS  RE,INVVAL           VALIDATE INVOICE NUMBERS                     
*                                                                               
         J     VOPTLPCN                                                         
*                                                                               
VOPTINVN DS    0H                                                               
*                                                                               
*        FILTER ON TRAFFICKED BUYS                                              
*                                                                               
VOPTTBS  DS    0H                                                               
*                                                                               
         CHI   RF,PRQOPTBS         TRAFFICKED BUYS ONLY                         
         JNE   *+12                                                             
         MVI   PBQTROPT,PBQTBSQ       SET OPTION                                
         J     VOPTLPCN                                                         
*                                                                               
         CHI   RF,PRQOPTBX         EXCLUDE TRAFFICKED BUYS                      
         JNE   *+12                                                             
         MVI   PBQTROPT,PBQTBXQ       SET OPTION                                
         J     VOPTLPCN                                                         
*                                                                               
VOPTTBSX DS    0H                                                               
*                                                                               
*        EXCLUDE CLIENT CIRCULATION OVERIDES                                    
*                                                                               
VOPTXCC  DS    0H                                                               
*                                                                               
         CHI   RF,PRQOPXCC         EXCLUDED CLIENT CIRCULATION                  
         JNE   VOPTXCCN                                                         
*                                                                               
         OI    PBQOPTS,PBQOXCCR    SET REPORT SWITCH                            
*                                                                               
         J     VOPTLPCN                                                         
*                                                                               
VOPTXCCN DS    0H                                                               
*                                                                               
*        PAYPEND - REPORT BUYS WITH PENDING PAYMENTS                            
*                                                                               
VOPTPPD  DS    0H                                                               
*                                                                               
         CHI   RF,PRQOPPPD         PAYPEND                                      
         JNE   VOPTPPDN                                                         
*                                                                               
         OI    PBQOPTS,PBQOXPD     SET OPTION INDICATOR                         
         OI    PBBYOPTS,PBBYCLSQ   CLEARANCE STATUS DATA WANTED                 
*                                                                               
         J     VOPTLPCN                                                         
*                                                                               
VOPTPPDN DS    0H                                                               
*                                                                               
*        MATCHED BUYS/INVOICES ONLY                                             
*                                                                               
VOPTMAT  DS    0H                                                               
*                                                                               
         CHI   RF,PRQOPMAT         MATCHED BUYS/INVOICES                        
         JNE   VOPTMATN                                                         
*                                                                               
         OI    PBQMATSW,PBQMATYQ      SET FLAG                                  
*                                                                               
         J     VOPTLPCN                                                         
*                                                                               
VOPTMATN DS    0H                                                               
*                                                                               
*        PO# FILTERS                                                            
*                                                                               
VOPTPO#  DS    0H                                                               
*                                                                               
         CHI   RF,PRQOPPOO         ONLY BUYS WITH    PO#'S                      
         JNE   *+12                                                             
         OI    PBQPO#OP,PBQPO#OQ      SET FLAG                                  
         J     VOPTLPCN                                                         
*                                                                               
         CHI   RF,PRQOPPOX         ONLY BUYS WITHOUT PO#'S                      
         JNE   *+12                                                             
         OI    PBQPO#OP,PBQPO#XQ      SET FLAG                                  
         J     VOPTLPCN                                                         
*                                                                               
         CHI   RF,PRQOPPON         ONLY BUYS NEEDING PO#'S                      
         JNE   *+12                                                             
         OI    PBQPO#OP,PBQPO#NQ      SET FLAG                                  
         J     VOPTLPCN                                                         
*                                                                               
         CHI   RF,PRQOPPOA         ONLY BUYS WITH ACTIVE   PO#'S                
         JNE   *+12                                                             
         OI    PBQPO#OP,PBQPO#AQ      SET FLAG                                  
         J     VOPTLPCN                                                         
*                                                                               
         CHI   RF,PRQOPPOI         ONLY BUYS WITH INACTVIE PO#'S                
         JNE   *+12                                                             
         OI    PBQPO#OP,PBQPO#IQ      SET FLAG                                  
         J     VOPTLPCN                                                         
*                                                                               
VOPTOP#N DS    0H                                                               
*                                                                               
         CHI   RF,PRQOPNVP         NVPAYABLE                                    
         JNE   VOPTNVPN                                                         
*                                                                               
         OI    PBQMATS2,PBQNVPYQ      SET FLAG                                  
         MVI   PBQFLTDA,C'A'          SET PAYABLE FLAG                          
*                                                                               
         J     VOPTLPCN                                                         
*                                                                               
VOPTNVPN DS    0H                                                               
*                                                                               
*        UNMATCHED BUYS/INVOICES ONLY                                           
*                                                                               
VOPTUNM  DS    0H                                                               
*                                                                               
         CHI   RF,PRQOPUNM         UNMATCHED BUYS/INVOICES                      
         JNE   VOPTUNMN                                                         
*                                                                               
         OI    PBQMATSW,PBQMATNQ      SET FLAG                                  
*                                                                               
         J     VOPTLPCN                                                         
*                                                                               
VOPTUNMN DS    0H                                                               
*                                                                               
*        NEW INVOICE MATCHED BUYS/INVOICES ONLY                                 
*                                                                               
VOPTNMT  DS    0H                                                               
*                                                                               
         CHI   RF,PRQOPNMT         NEW INVOICE MATCHED BUYS/INVOICES            
         JNE   VOPTNMTN                                                         
*                                                                               
         OI    PBQMATS2,PBQNMTYQ      SET FLAG                                  
*                                                                               
         J     VOPTLPCN                                                         
*                                                                               
VOPTNMTN DS    0H                                                               
*                                                                               
*        NEW INVOICE UNMATCHED BUYS/INVOICES ONLY                               
*                                                                               
VOPTNUM  DS    0H                                                               
*                                                                               
         CHI   RF,PRQOPNUM         NEW INVOICE UNMATCHED BUYS/INVOICES          
         JNE   VOPTNUMN                                                         
*                                                                               
         OI    PBQMATS2,PBQNMTNQ      SET FLAG                                  
*                                                                               
         J     VOPTLPCN                                                         
*                                                                               
VOPTNUMN DS    0H                                                               
*                                                                               
*        NEW INVOICE NOINVOICE BUYS ONLY                                        
*                                                                               
VOPTNNI  DS    0H                                                               
*                                                                               
         CHI   RF,PRQOPNNI         NEW INVOICE NOINVOICE BUYS                   
         JNE   VOPTNNIN                                                         
*                                                                               
         OI    PBQMATS2,PBQNVNIQ      SET FLAG                                  
*                                                                               
         J     VOPTLPCN                                                         
*                                                                               
VOPTNNIN DS    0H                                                               
*                                                                               
*        TEARSHEETED BUYS/INVOICES ONLY                                         
*                                                                               
VOPTTSH  DS    0H                                                               
*                                                                               
         CHI   RF,PRQOPTS          TEARSHEETED BUYS/INVOICES                    
         JNE   VOPTTSHN                                                         
*                                                                               
         OI    PBQMATSW,PBQTSHYQ      SET FLAG                                  
*                                                                               
         J     VOPTLPCN                                                         
*                                                                               
VOPTTSHN DS    0H                                                               
*                                                                               
*        NO TEARSHEET BUYS/INVOICES ONLY                                        
*                                                                               
VOPTTSX  DS    0H                                                               
*                                                                               
         CHI   RF,PRQOPTSX         NO TEARSHEETED BUYS/INVOICES                 
         JNE   VOPTTSXN                                                         
*                                                                               
         OI    PBQMATSW,PBQTSHNQ      SET FLAG                                  
*                                                                               
         J     VOPTLPCN                                                         
*                                                                               
VOPTTSXN DS    0H                                                               
*                                                                               
VOPTPG   DS    0H                  PGTAPE OPTIONS                               
*                                                                               
         CHI   RF,PRQOPPGN         PGNET                                        
         JNE   *+12                                                             
         OI    PBQPGOPT,PBQPGNTQ   SET NET DOLLARS OPTION                       
         J     VOPTPG1                                                          
*                                                                               
         CHI   RF,PRQOPPGA         PGAC                                         
         JNE   VOPTPGN                                                          
         OI    PBQPGOPT,PBQPGACQ   SET AGENCY COMMISSION OPTION                 
*                                                                               
VOPTPG1  DS    0H                                                               
*                                                                               
         TM    PBQPGOPT,PBQPGNTQ+PBQPGACQ TEST IF BOTH OPTIONS ON               
         JO    VOPTPGE                NOT ALLOWED                               
*                                                                               
         J     VOPTLPCN                                                         
*                                                                               
VOPTPGN  DS    0H                                                               
*                                                                               
VOPTFIL  DS    0H                                                               
*                                                                               
         CHI   RF,PRQOPFIL         IF SEND OUTPUT TO A FILE                     
         JNE   VOPTFILX                                                         
*                                                                               
         OI    PBQFLOPT,PBQFLOUT      SET OPTION                                
*                                                                               
         J     VOPTLPCN                                                         
*                                                                               
VOPTFILX DS    0H                                                               
*                                                                               
VOPTCPY  DS    0H                                                               
*                                                                               
         CHI   RF,PRQOPCPY         IF COPY SPLIT PROCESSING                     
         JNE   VOPTCPYX                                                         
*                                                                               
         OI    PBBYOPT2,PBBYCPYQ      SET OPTION                                
*                                                                               
         J     VOPTLPCN                                                         
*                                                                               
VOPTCPYX DS    0H                                                               
*                                                                               
VOPTBFM  DS    0H                                                               
*                                                                               
         CHI   RF,PRQOPBFM         IF BFORM RECS TO BE USED                     
         JNE   VOPTBFMX                                                         
*                                                                               
         OI    PBQBLLO2,PBQBFRMQ      SET OPTION                                
*                                                                               
         J     VOPTLPCN                                                         
*                                                                               
VOPTBFMX DS    0H                                                               
*                                                                               
VOPTCBU  DS    0H                                                               
*                                                                               
         CHI   RF,PRQOPCBU         CLEARED BUT UNDISBURSED                      
         JNE   VOPTCBUX                                                         
*                                                                               
         OI    PBQOPTS,PBQCBU       SET OPTION                                  
*                                                                               
         J     VOPTLPCN                                                         
*                                                                               
VOPTCBUX DS    0H                                                               
*                                                                               
VF90     L     RF,=A(VVFILTD)                                                   
         A     RF,RELOPGEN         RELOCATE ADDRESS                             
*                                                                               
         CLI   0(R4),9                                                          
         JH    VFLTNVER                                                         
         ZIC   RE,0(R4)                                                         
         BCTR  RE,0                                                             
VF90AA   CLI   0(RF),255                                                        
         JE    FILTEND                                                          
*                                                                               
         EX    RE,VF90EX                                                        
         JNE   VF90AAB                                                          
         MVC   PBQFLTDA,9(RF)                                                   
         J     VOPTLPCN                                                         
VF90AAB  LA    RF,L'VVFILTD(RF)                                                 
         J     VF90AA                                                           
*                                                                               
VF90EX   CLC   0(0,RF),12(R4)                                                   
*                                                                               
FILTEND  DS    0H                                                               
*                                                                               
*        END OF OPTIONS                                                         
*                                                                               
         J     VOPTNVER            INVALID OPTION                               
*                                                                               
VOPTLPCN DS    0H                                                               
*                                                                               
         LA    R4,42(R4)                                                        
         AI    FIELDERR,1                                                       
         BRCT  R0,VOPTLOOP                                                      
*                                                                               
VOPTLPDN DS    0H                                                               
*                                                                               
         CLI   DOWNOPT,C'Y'        IF DOWNLOADING                               
         JNE   VOPTDWNX                                                         
*                                                                               
         TM    NEWOPTS,NOPTPQIX    IF DOING PQIX                                
         BNO   *+8                                                              
         OI    SPECOPT,GLDLHEAD       FORCE DOWNHEAD OPTION                     
*                                                                               
         CLI   CONOUTH+5,0         SKIP IF ANYTHING ENTERED IN OUTPUT           
         JNE   VOPTDWNX              YES                                        
*                                                                               
         FOUT CONOUTH,=CL8'DOWN',8                                              
*                                                                               
         OI    CONOUTH+5,4                                                      
*                                                                               
         MVC   TWAOUT,CONOUT                                                    
*                                                                               
VOPTDWNX DS    0H                                                               
*                                                                               
         J     VOPTORGX                                                         
*                                                                               
         LTORG                                                                  
*                                                                               
VOPTORGX DS    0H                                                               
*                                                                               
         LA    RF,HELPCBLK         SET FLAVOR IN HELP CONTROL BLOCK             
         MVC   HCBFLVR-HELPCB(L'HCBFLVR,RF),PBFLAVOR                            
*                                                                               
         L     R2,ALASTCOL         RE-POINT TO SCREEN FIELD                     
*                                                                               
         OC    PBQCENST,PBQCENST   IF FILTERING ON CONTRACT END                 
         JZ    VOPTLPD1                                                         
*                                                                               
         CLI   PBFLAVOR,C'C'       THEN MUST BE CONTRACT DRIVEN REPORT          
         JE    *+8                                                              
         CLI   PBFLAVOR,C'O'                                                    
         JE    *+12                                                             
         LA    R4,BLOCK            POINT TO FIRST SCANNED FIELD                 
         J     VOPTCOER                                                         
*                                                                               
VOPTLPD1 DS    0H                                                               
*                                                                               
*        IF TWO SPACE FILTERS ENTERED                                           
*           BOTH MUST BE POSITIVE OR NEGATIVE                                   
*                                                                               
         CLI   PBQSPD1L,0                                                       
         JE    VOPTLPD2                                                         
         CLI   PBQSPD2L,0                                                       
         JE    VOPTLPD2                                                         
*                                  TWO SPACE FILTERS ENTERED                    
         TM    PBQSPD1L,X'80'      IF FIRST IS NEGATIVE                         
         JNO   *+16                                                             
         TM    PBQSPD2L,X'80'         SECOND MUST BE NEGATIVE                   
         JNO   VFSPDER                                                          
         J     VOPTLPD2                                                         
*                                                                               
         TM    PBQSPD2L,X'80'      ELSE SECOND CAN'T BE NEGATIVE                
         JO    VFSPDER                                                          
*                                                                               
VOPTLPD2 DS    0H                                                               
*                                                                               
VALOPTNX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         EJECT                                                                  
*                                                                               
*        ERROR MESSAGES                                                         
*                                                                               
VFLTNVER MVI   ERROR,PWEFLTNV      INVALID FILTER                               
         J     VOPTERR                                                          
*                                                                               
VFSPDER  MVI   ERROR,PWESPDER      CAN'T COMBINE NEG AND POS SPACE FLTS         
         J     VOPTERR                                                          
*                                                                               
VFADNONE DS    0H                  AD FILTER MISSING                            
         MVI   ERROR,PWEFVLNE                                                   
         J     VOPTERR                                                          
*                                                                               
VFADLNGE DS    0H                  AD FILTER TOO LARGE                          
         MVI   ERROR,PWEFVLLG                                                   
         J     VOPTERR                                                          
*                                                                               
VFFLTNVE DS    0H                  AD FILTER VALUE INVALID                      
         MVI   ERROR,PWEFVLNV                                                   
         J     VOPTERR                                                          
*                                                                               
VOPTRP2E MVI   ERROR,PWEOPRP2      SECOND REPORT NOT FOUND                      
         J     VOPTERR                                                          
*                                                                               
VOPTFCE4 MVI   ERROR,PWEOPFC4      COMMENT FOR ESTIMATE REPORT                  
         J     VOPTERR                                                          
*                                                                               
VOPTCOER MVI   ERROR,PWEOPCOS      INCONSISTENT OPTIONS                         
         J     VOPTERR                                                          
*                                                                               
VOPTDTER MVI   ERROR,PWEOPDTS      START MUST BE BEFORE END                     
         J     VOPTERR                                                          
*                                                                               
VOPTDTNV MVI   ERROR,PWEOPDNV      INVALID DATE EXPRESSION                      
         J     VOPTERR                                                          
*                                                                               
VOPTPGE  MVI   ERROR,PWEPGERR      TOO MANY PGTAPE OPTIONS                      
         J     VOPTERR                                                          
*                                                                               
VOPTNVER MVI   ERROR,PWEOPNV       INVALID OPTION                               
*                                                                               
VOPTERR  ST    R4,DMCB+8           SAVE ERROR POINTER                           
VOPTERR1 GOTO1 CURSERR             PUT OUT ERROR MESSAGE                        
*                                                                               
* CONSTANTS TABLES ETC                                                          
*                                                                               
*            DOLLAR FILTERS                                                     
VVFILTD  DC    C'UNORDEREDU'                                                    
         DC    C'BILLABLE I'                                                    
         DC    C'PAYABLE  A'                                                    
         DC    C'PAID     P'                                                    
         DC    C'BILLED   B'                                                    
         DC    C'ORDERED  O'                                                    
         DC    X'FF'                                                            
*                                                                               
         TITLE 'PRWRIGEN - PRINT WRITER ROOT PHASE - VOPTRTB'                   
***********************************************************************         
*                                                                     *         
*        TABLE OF OPTIONS AND VALIDATION ROUTINES                     *         
*                                                                     *         
*        DC    Y(PRQCFOPT)    OPTION EQUATE                           *         
*        DC    Y(0)                SPARE                              *         
*        DC    A(VALIDATION ROUTINE)                                  *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
VOPTRTB  DS    0D                  VALIDATION ROUTINES TABLE                    
         DC    Y(PRQOPAOR),Y(0)    AOR                                          
         DC    A(VOPTAOR)                                                       
VOPTRTBL EQU   *-VOPTRTB           LENGTH OF ENTRY IN TABLE                     
*                                                                               
         DC    Y(PRQOPACH),Y(0)    ADDITIONAL CHARGES                           
         DC    A(ACHGVAL)                                                       
*                                                                               
         DC    Y(PRQOPBCH),Y(0)    BUY CHANGES FILTER                           
         DC    A(BCHGVAL)                                                       
*                                                                               
         DC    Y(PRQOPTSS),Y(0)    TEARSHEET STATUS FILTER                      
         DC    A(TSSVAL)                                                        
*                                                                               
         DC    Y(PRQOPBTP),Y(0)    BILL TYPE OPTION                             
         DC    A(VOPTBTP)                                                       
*                                                                               
         DC    Y(PRQOPMED),Y(0)    MEDIA LIST OPTION                            
         DC    A(VOPVMED)                                                       
*                                                                               
         DC    Y(PRQOPSMD),Y(0)    SUBMEDIA FILTER                              
         DC    A(SMDVAL)                                                        
*                                                                               
         DC    Y(PRQOPERT),Y(0)    ESTIMATE RATE TYPE FILTER                    
         DC    A(ERTVAL)                                                        
*                                                                               
         DC    Y(PRQOPFTC),Y(0)    FOOTER COMMENT                               
         DC    A(FOOTVAL)                                                       
*                                                                               
         DC    Y(PRQOPXCL),Y(0)    EXCLUDED CLIENT                              
         DC    A(XCLVAL)                                                        
*                                                                               
         DC    Y(PRQOPXCG),Y(0)    EXCLUDED CLIENT GROUP                        
         DC    A(XCGVAL)                                                        
*                                                                               
         DC    Y(PRQOPUID),Y(0)    UPID FILTER                                  
         DC    A(UIDVAL)                                                        
*                                                                               
         DC    Y(PRQOPDST),Y(0)    DISCREPANCY STATUS FILTER                    
         DC    A(DSTVAL)                                                        
*                                                                               
         DC    Y(PRQOPPSR),Y(0)    PAYSRC FILTER                                
         DC    A(PSRCVAL)                                                       
*                                                                               
         DC    Y(PRQOPPLK),Y(0)    PUBLOCK FILTER                               
         DC    A(PUBLOCK)                                                       
*                                                                               
VOPTFCN  DS     0H                                                              
VOPTRTBX EQU   *-1                 END OF TABLE                                 
VOPTRTB# EQU   ((VOPTRTBX-VOPTRTB)+1)/VOPTRTBL  # OF TABLE ENTRIES              
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'PRWRIGEN - PRINT WRITER ROOT PHASE - VSOFTDAT'                  
***********************************************************************         
*                                                                               
*        VALIDATION OF SOFT DATES                                               
*                                                                               
*        R2       POINT TO THE HEADER OF PERIOD FIELD.                          
*        SOFDATC  IS THE AREA WHERE WE BUILD BLOCK                              
*                 THAT WE PASS TO VSOFDAT.                                      
***********************************************************************         
*                                                                               
         DS    0D                                                               
VSOFTDAT NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING SPOOLD,R8                                                        
         USING GEND,RC                                                          
         USING SYSD,R9                                                          
         USING T405FFD,RA                                                       
*                                                                               
*  NOTE IN FIELD ELEMENT :    FIRST BYTE IS THE LENGTH                          
*                             VAR LEN SOFT DATE                                 
*                                                                               
         XC    ELEMENT,ELEMENT          CLEAR THE AREA FOR SOFT DATE            
         MVC   ELEMENT(1),5(R2)                                                 
         ZIC   R1,5(R2)                 GET THE LENGTH                          
         AHI   R1,-1                                                            
         EX    R1,VSOFT00                                                       
         B     VSOFT01                                                          
                                                                                
VSOFT00  DS    0H                                                               
         MVC   ELEMENT+1(0),8(R2)         SAVE ORIG SOFT DATE                   
*                                                                               
VSOFT01  DS    0H                                                               
*                                                                               
         LHI   R7,SOFDATC-SYSD                                                  
         LA    R7,SYSD(R7)                                                      
         USING SOFDATD,R7                                                       
*                                                                               
         XC    SOFDATD(SOFDATL),SOFDATD                                         
*                                                                               
*        VALIDATE FOR YMD SOFT DATES                                            
*                                                                               
         ST    R2,SOFAINP               SET SET A(INPUT FIELD)                  
         LA    R0,PBQSTART                                                      
         ST    R0,SOFAOUT               SET A(OUTPUT)                           
         MVC   SOFACOM,ACOMFACS         SET A(COMFACS)                          
         MVI   SOFITYPE,SOFITYMD        VALIDATE YEAR MONTH DAY                 
         MVI   SOFOTYPE,SOFOTSD2        12 BYTE EBCDIC YYMMDDYYMMDD             
         MVI   SOFIINDS,SOFIIANY        VALIDATE SOFT AND HARD DATES            
*                                                                               
         OI    SOFIINDS,SOFIIRES        ALWAYS RESOLVE SOFT DATE                
*                                                                               
         MVC   SOFTODAY,PBQTODAY        SET TODAY'S DATE                        
         MVC   SOFCTRY,CTRY             SET COUNTRY                             
         MVC   SOFLANG,LANG             SET LANGUAGE                            
         MVI   SOFSYSN,X'04'            ??? PRINT SYSTEM                        
*                                                                               
         GOTO1 VSOFDAT,SOFDATD                                                  
         BZ    VSOFTOK                                                          
*                                                                               
*        NOT YMD SOFT DATE - TRY YM SOFTDATES                                   
*                                                                               
         XC    8(17,R2),8(R2)           RESTORE ORIG SOFT ON A SCREEN           
         MVC   5(1,R2),ELEMENT                                                  
         ZIC   R1,ELEMENT                                                       
         AHI   R1,-1                                                            
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   8(0,R2),ELEMENT+1        RESTORE ORIG SOFT DATE                  
*                                                                               
         MVI   SOFITYPE,SOFITYM         VALIDATE YEAR MONTH                     
         MVI   SOFOTYPE,SOFOTSD1        8 BYTE EBCDIC YYMMYYMM                  
*                                                                               
         GOTO1 VSOFDAT,SOFDATD                                                  
         BZ    VSOFTOK                                                          
*                                                                               
         B     VSOFERRX                                                         
*                                                                               
VSOFTOK  DS    0H                                                               
*                                                                               
         TM    SOFOINDS,SOFOISFT                                                
         BNZ   VSOFSOFT                                                         
*                                                                               
VSOFERRX DS    0H                                                               
         MVI   ERROR,PWESOFDT           SET ERROR MESSAGE NUMBER                
         GOTO1 CURSERR                                                          
*                                                                               
VSOFSOFT DS    0H                                                               
*                                                                               
VSOFDATX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'PRWRIGEN - PRINT WRITER ROOT PHASE - BHDVAL'                    
***********************************************************************         
*                                                                     *         
*        VALIDATE BHRDATE OPTION FOR RFP SYMBOLIC                     *         
*                                                                     *         
*NTRY    R4 ==>  SCANNER BLOCK                                        *         
*                                                                     *         
*EXIT                                                                 *         
*                                                                     *         
***********************************************************************         
         DS    0D                                                               
BHDVAL   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING SPOOLD,R8                                                        
         USING GEND,RC                                                          
         USING SYSD,R9                                                          
         USING T405FFD,RA                                                       
*                                                                               
*        CHECK IF RFP SYMBOLIC PARAMETER ENTERED                                
*                                                                               
         OC    ARFPBLK,ARFPBLK     SKIP IF RFP NOT BEING USED                   
         BZ    BHVRFPN                                                          
*                                                                               
         L     R6,ARFPBLK          ESTABLISH RFP BLOCK                          
         USING RFPBLK,R6                                                        
*                                                                               
         SR    RE,RE                                                            
         ICM   RE,1,RFPVNUMS       NUMBER OF VIABLE SYMBOLIC NAMES              
         BZ    BHVRFPN             NONE                                         
*                                                                               
         LA    RF,RFPVSYMS         POINT TO SYMBOL TABLE                        
*                                                                               
         USING RFPVSYMS,RF         ESTABLISH SYMBOL TABLE                       
*                                                                               
BHVRFPLP DS    0H                                                               
*                                                                               
         CLC   RFPVSYMB(20),22(R4) MATCH INPUT TO SYMBOLIC PARAMETER            
         JE    BHVRFPFD               EXPANDED FORMAT                           
         CLC   RFPVSYME(L'RFPVSYME-1),22(R4) MATCH INPUT TO SYMB PARM           
         JE    BHVRFPFD              ESCAPE SEQ IN CASE LEFT OVER               
*                                     FROM LAST TRANSACTION                     
BHVRFPCN DS    0H                                                               
*                                                                               
         LA    RF,RFPVSYML(RF)     BUMP TO NEXT SYMBOLIC PARAMETER              
         BCT   RE,BHVRFPLP                                                      
*                                     FROM LAST TRANSACTION                     
BHVRFPDN DS    0H                                                               
*                                                                               
         J     BHVRFPN             NO SYMBOLIC PARAMETER FOUND                  
*                                                                               
BHVRFPFD DS    0H                                                               
*                                                                               
         CLC   =AL2(PP#BHRDT),RFPVSYME+1 MUST BE BHRDATE SYMBOLIC               
*****    CLC   =AL2(543),RFPVSYME+1 MUST BE BHRDATE SYMBOLIC                    
         JNE   BHVRFP1E                                                         
*                                                                               
         CHI   R0,1                MUST BE LAST OPTION                          
         JNE   BHVRFP2E                                                         
*                                                                               
         SR    R1,R1                                                            
         IC    R1,8(R4)            DISPLACEMENT OF DATE IN FIELD                
         LA    R1,8(R1,R2)         POINT TO DATE AREA                           
         MVC   0(17,R1),SPACES     INIT DATE                                    
         MVC   0(L'RFPVSYME,R1),RFPVSYME REPLACE KEYWORD WITH ESC SEQ           
*                                                                               
         SR    RE,RE                                                            
         SR    RF,RF                                                            
*                                                                               
         IC    RE,1(R4)            LENGTH OF DATE AS ENTERED                    
         IC    RF,5(R2)            CURRENT LENGTH OF INPUT                      
*                                                                               
         SR    RF,RE               LENGTH WITHOUT DATE                          
*                                                                               
         LA    RF,17(RF)           LENGTH WITH MAX DATE                         
*                                                                               
         LA    RF,16(RF)           MAKE SURE IT WILL FIT IN FIELD               
         CLM   RF,1,0(R2)                                                       
         JH    BHVRFP3E                                                         
*                                                                               
         AHI   RF,-16              RESTORE INPUT LENGTH                         
*                                                                               
         CHI   RF,63               FIELD LENGTH MUST BE LE 63                   
         JH    BHVRFP3E                                                         
*                                                                               
         STC   RF,5(R2)            CHANGE LENGTH TO MAX INPUT FOR RFP           
         MVI   L'RFPVSYME-1(R1),17   CHG LEN IN ESCAPE SEQ                      
*                                                                               
         CR    RB,RB               SET EQUAL CC                                 
*                                                                               
         B     BHDVALX                                                          
*                                                                               
BHVRFPN DS     0H                                                               
         LTR   RB,RB               SET NOT EQUAL CC                             
*                                                                               
BHDVALX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
BHVRFP1E DS    0H                                                               
         MVI   ERROR,PWEBHRFP      INVALID SYMBOLIC                             
         J     BHVRFPER                                                         
*                                                                               
BHVRFP2E DS    0H                                                               
         MVI   ERROR,PWERFLST      SYMBOLIC MUST BE LAST OPTION                 
         J     BHVRFPER                                                         
*                                                                               
BHVRFP3E DS    0H                                                               
         MVI   ERROR,PWERFSZE      NO ROOM IN OPTIONS FIELD                     
         B     BHVRFPER                                                         
*                                                                               
BHVRFPER DS    0H                                                               
*                                                                               
         ST    R4,DMCB+8           SAVE ERROR POINTER                           
         GOTO1 CURSERR             GO HANDLE ERROR MESSAGE                      
*                                                                               
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'PRWRIGEN - PRINT WRITER ROOT PHASE - VOPVMED'                   
***********************************************************************         
*                                                                     *         
*        VALIDATE MEDIA LIST OPTION                                   *         
*                                                                     *         
*NTRY    R4 ==>  SCANNER BLOCK                                        *         
*                                                                     *         
*EXIT                                                                 *         
*                                                                     *         
***********************************************************************         
         DS    0D                                                               
VOPVMED  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING SPOOLD,R8                                                        
         USING GEND,RC                                                          
         USING SYSD,R9                                                          
         USING T405FFD,RA                                                       
*                                                                               
         CLI   WRIMED,C'*'         MEDIA MUST BE '*' OR 'C' FOR OPTION          
         JE    *+8                                                              
         CLI   WRIMED,C'C'                                                      
         JNE   VOPTMEDE                                                         
*                                                                               
*        VALIDATE MEDIA ENTERED                                                 
*                                                                               
         CLI   1(R4),0             MUST HAVE A MEDIA ENTERED                    
         JE    VOPTMDE1                                                         
*                                                                               
         LA    RE,22(R4)           POINT TO ENTERED MEDIA                       
         XC    DUB,DUB                                                          
         MVC   DUB(L'VOPTMEDS),VOPTMEDS    COPY VALID MEDIA LIST                
*                                                                               
VOPTMDL1 DS    0H                                                               
*                                                                               
         CLI   0(RE),C' '          CHECK FOR END OF LIST                        
         JNH   VOPTMDD1                                                         
*                                                                               
         LA    RF,DUB              POINT TO LIST OF VALID MEDIA                 
*                                                                               
VOPTMDL2 DS    0H                                                               
*                                                                               
         CLI   0(RF),C' '          ERROR IF NO MATCH FOUND IN LIST              
         JNH   VOPTMDE2                                                         
*                                                                               
         CLC   0(1,RE),0(RF)       MATCH ENTERED MEDIA TO ONE IN LIST           
         JE    VOPTMDD2                                                         
*                                                                               
VOPTMDC2 DS    0H                                                               
*                                                                               
         LA    RF,1(RF)            BUMP TO NEXT VALID MEDIA                     
         J     VOPTMDL2                                                         
*                                                                               
VOPTMDD2 DS    0H                                                               
*                                                                               
         MVI   0(RF),X'FF'         ELIMINATE MEDIA FROM LIST                    
*                                  THIS PREVENTS DUPLICATES                     
VOPTMDC1 DS    0H                                                               
*                                                                               
         LA    RE,1(RE)            BUMP TO NEXT MEDIA IN LIST                   
         J     VOPTMDL1                                                         
*                                                                               
VOPTMDD1 DS    0H                                                               
*                                                                               
         SR    RF,RF                                                            
         IC    RF,1(R4)            LENGTH OF MEDIA LIST                         
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         J     *+10                                                             
         MVC   PBQMEDLS+1(0),22(R4)  SAVE MEDIA LIST                            
*                                  FIRST BYTE MUST BE X'00' FOR LATER           
*                                  PROCESSING                                   
*                                                                               
VOPVMEDX DS    0H                                                               
         XIT1                                                                   
*                                                                               
VOPTMEDS DC    C'ILMNOSTBVWD '     VALID MEDIAS                                 
*                                                                               
*                                                                               
         LTORG                                                                  
*                                                                               
VOPTMEDE MVI   ERROR,PWEMEDLS      MEDIA LIST REQUIRES MEDIA * OR C             
         LA    R2,WRIMEDH          PUT CURSOR AT MEDIA FIELD                    
         J     VOPMDER1                                                         
*                                                                               
VOPTMDE1 MVI   ERROR,MISSING       MEDIA LIST HAS NOTHING IN IT                 
         J     VOPMDERR                                                         
*                                                                               
VOPTMDE2 MVI   ERROR,PWEMEDE2      INVALID OR DUPLICATE MEDIA IN LIST           
         J     VOPMDERR                                                         
*                                                                               
VOPMDERR ST    R4,DMCB+8           SAVE ERROR POINTER                           
VOPMDER1 GOTO1 CURSERR             GO HANDLE ERROR MESSAGE                      
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'PRWRIGEN - PRINT WRITER ROOT PHASE - SMDVAL'                    
***********************************************************************         
*                                                                     *         
*        VALIDATE SUBMEDIA CODE                                       *         
*                                                                     *         
*NTRY    R4 ==>  SCANNER BLOCK                                        *         
*                                                                     *         
*EXIT                                                                 *         
*                                                                     *         
***********************************************************************         
         DS    0D                                                               
SMDVAL   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING SPOOLD,R8                                                        
         USING GEND,RC                                                          
         USING SYSD,R9                                                          
         USING T405FFD,RA                                                       
*                                                                               
*        VALIDATE AS SUBMEDIA                                                   
*                                                                               
         LA    R1,22(R4)           POINT TO FILTER                              
         SR    RF,RF                                                            
*                                                                               
         CLI   0(R1),C'-'          CHECK FOR NEGATIVE PREFIX                    
         BNE   SMDVAL10                                                         
*                                                                               
         LA    R1,1(R1)               BUMP PAST NEGATIVE SIGN                   
         IC    RF,1(R4)               DECREMENT LENGTH                          
         SHI   RF,1                                                             
         STC   RF,1(R4)                                                         
*                                                                               
SMDVAL10 DS    0H                                                               
*                                                                               
         CLC   =C'NONE',0(R1)      CHECK OF SPECIAL CASE OF 'NONE'              
         BNE   *+12                                                             
         MVI   PBQSMD,PBQNONEQ        DROP ALL LINES WITH A SUBMEDIA            
         B     SMDVALDN                                                         
*                                                                               
         CLC   =C'ONLY',0(R1)      CHECK OF SPECIAL CASE OF 'ONLY'              
         BNE   *+12                                                             
         MVI   PBQSMD,PBQONLYQ        ONLY LINES WITH A SUBMEDIA                
         B     SMDVALDN                                                         
*                                                                               
         CLI   1(R4),L'PSMDKSMD    MAKE SURE CODE IS NOT TOO LARGE              
         BH    SMDVERR                                                          
*                                                                               
         MVC   PBQSMD,0(R1)        SAVE ENTERED SUBMEDIA CODE                   
*                                                                               
         SR    R5,R5               INIT CLIENT RECORD POINTER                   
*                                                                               
*        READ SUBMEDIA RECORD                                                   
*                                                                               
         XC    KEY,KEY             GET SUBMEDIA RECORD                          
         LA    R7,KEY              ESTABLISH SUBMEDIA RECORD KEY                
         USING PSUBMEDD,R7                                                      
*                                                                               
         MVC   PSMDKAGY,AGENCY     SET AGENCY                                   
         MVC   PSMDKMED,PBQMED     SET MEDIA                                    
*                                                                               
         CLI   PBQMED,C'*'         SKIP VALIDATION IF ALL MEDIA                 
         BE    SMDVALDN                                                         
         CLI   PBQMED,C'C'         SKIP VALIDATION IF COMBINED MEDIA            
         BE    SMDVALDN                                                         
*                                                                               
         MVI   PSMDKRCD,PSMDKR1Q   INDICATE SUBMEDIA RECORD                     
         MVI   PSMDKRC2,PSMDKR2Q                                                
         MVC   PSMDKSMD,PBQSMD     SET SUBMEDIA CODE                            
*                                                                               
         MVI   RDUPDATE,C'N'       NOT READING FOR UPDATE                       
*                                                                               
         GOTO1 HIGH                FIND DIRECTORY POINTER                       
*                                                                               
         CLC   PSMDKEY,KEYSAVE     MUST FIND RECORD                             
         BNE   SMDVERR                                                          
*                                                                               
SMDVALDN DS    0H                                                               
*                                                                               
         CLI   22(R4),C'-'         IF NEGATIVE FILTER                           
         BNE   *+8                                                              
         NI    PBQSMD,X'FF'-X'40'     KILL X'40' BIT                            
*                                                                               
SMDVALX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
SMDVERR  DS    0H                                                               
*                                                                               
         LHI   RF,PWESMDNV         INVALID SUB MEDIA CODE                       
*                                                                               
         USING GETTXTD,GETTXTCB    ESTABLISH GETTXT CONTROL BLOCK               
*                                                                               
         STCM  RF,3,GTMSGNO        SET ERROR MESSAGE NUMBER                     
*                                                                               
         GOTO1 CURSERR             GO HANDLE ERROR MESSAGE                      
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'PRWRIGEN - PRINT WRITER ROOT PHASE - ERTVAL'                    
***********************************************************************         
*                                                                     *         
*        VALIDATE ESTIMATE RATE TYPE FILTER                           *         
*                                                                     *         
*NTRY    R4 ==>  SCANNER BLOCK                                        *         
*                                                                     *         
*EXIT                                                                 *         
*                                                                     *         
***********************************************************************         
         DS    0D                                                               
ERTVAL   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING SPOOLD,R8                                                        
         USING GEND,RC                                                          
         USING SYSD,R9                                                          
         USING T405FFD,RA                                                       
*                                                                               
*        SAVE ESTIMATE RATE TYPE                                                
*                                                                               
         LA    R1,22(R4)           POINT TO FILTER                              
         SR    RF,RF                                                            
*                                                                               
         CLI   0(R1),C'-'          CHECK FOR NEGATIVE PREFIX                    
         BNE   ERTVAL10                                                         
*                                                                               
         LA    R1,1(R1)               BUMP PAST NEGATIVE SIGN                   
         IC    RF,1(R4)               DECREMENT LENGTH                          
         SHI   RF,1                                                             
         STC   RF,1(R4)                                                         
*                                                                               
ERTVAL10 DS    0H                                                               
*                                                                               
         CLI   1(R4),L'PBQESTRT    MAKE SURE CODE IS NOT TOO LARGE              
         BH    ERTVERR                                                          
*                                                                               
         MVC   PBQESTRT,0(R1)      SAVE ENTERED ESTIMATE RATE TYPE              
*                                                                               
         CLI   22(R4),C'-'         IF NEGATIVE FILTER                           
         BNE   *+8                                                              
         NI    PBQESTRT,X'FF'-X'40'   KILL X'40' BIT                            
*                                                                               
ERTVALX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
ERTVERR  DS    0H                                                               
*                                                                               
         ST    R4,DMCB+8           SAVE ERROR POINTER                           
         MVI   ERROR,INVALID       INVALID ENTRY                                
*                                                                               
         GOTO1 CURSERR             GO HANDLE ERROR MESSAGE                      
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'PRWRIGEN - PRINT WRITER ROOT PHASE - XCLVAL'                    
***********************************************************************         
*                                                                     *         
*        VALIDATE EXCLUDED CLIENT                                     *         
*                                                                     *         
*NTRY    R4 ==>  SCANNER BLOCK                                        *         
*                                                                     *         
*EXIT                                                                 *         
*                                                                     *         
***********************************************************************         
         DS    0D                                                               
XCLVAL   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING SPOOLD,R8                                                        
         USING GEND,RC                                                          
         USING SYSD,R9                                                          
         USING T405FFD,RA                                                       
*                                                                               
*        VALIDATE AS CLIENT                                                     
*                                                                               
         MVI   ERROR,INVCLT        SET DEFAULT ERROR CODE                       
*                                                                               
         CLI   1(R4),3             CLIENT CODE MUST BE 2 OR 3 LONG              
         BH    XCLVERR                                                          
*                                                                               
         CLI   1(R4),2                                                          
         BL    XCLVERR                                                          
*                                                                               
         MVC   PBQXCL,SPACES       PAD CLIENT CODE                              
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,1(R4)          CLIENT CODE LENGTH                           
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   PBQXCL(0),22(R4)    SAVE ENTERED EXCLUDED CLIENT                 
*                                                                               
         SR    R5,R5               INIT CLIENT RECORD POINTER                   
*                                                                               
*        READ CLIENT HEADER                                                     
*                                                                               
         XC    KEY,KEY             GET CLIENT RECORD                            
***      =================  ***                                                 
         LA    R7,KEY              ESTABLISH CLIENT RECORD KEY                  
         USING PCLTKEY,R7                                                       
***      =================  ***                                                 
         MVC   PCLTKAGY,AGENCY     SET AGENCY                                   
         BRAS  RE,CLTMED           FIND FIRST MEDIA                             
         MVI   PCLTKRCD,X'02'      INDICATE CLIENT RECORD                       
         MVC   PCLTKCLT,PBQXCL     SET CLIENT CODE                              
*                                                                               
         MVI   RDUPDATE,C'N'       NOT READING FOR UPDATE                       
*                                                                               
XCLCLTLP DS    0H                                                               
*                                                                               
         GOTO1 HIGH                FIND DIRECTORY POINTER                       
*                                                                               
         CLC   KEY(25),KEYSAVE     MUST FIND RECORD                             
         BE    XCLCLTFD                                                         
*                                                                               
XCLCLTCN DS    0H                                                               
*                                                                               
         MVC   KEY,KEYSAVE         RESTORE CLIENT KEY                           
         BRAS  RE,CLTMED           NEXT MEDIA                                   
         BE    XCLCLTLP            NEW MEDIA FOUND                              
*                                                                               
         B     XCLVERR             CLIENT NOT FOUND                             
*                                                                               
XCLCLTFD DS    0H                                                               
*                                                                               
         L     R5,AIO1             INDICATE WHERE TO READ RECORD INTO           
         ST    R5,AIO                                                           
*                                                                               
         GOTO1 GETREC              READ RECORD                                  
*                                                                               
XCLVELM  DS    0H                  FIND HEADER                                  
*                                                                               
         SR    R0,R0                                                            
         LA    R6,33(R5)           POINT TO FIRST ELEMENT IN RECORD             
*                                                                               
XCLVELML DS    0H                  FIND CLIENT HEADER ELEMENT                   
*                                                                               
         CLI   0(R6),X'00'         CHECK FOR RECORD END                         
         BE    XCLVELMD                                                         
*                                                                               
         CLI   0(R6),X'02'         CHECK FOR CORRECT ELEMENT                    
         BE    XCLVHDR                                                          
*                                                                               
***      =================  ***                                                 
         USING PCLTELEM,R6                                                      
***      =================  ***                                                 
*                                                                               
XCLVHDR  DS    0H                  FIND CLIENT HEADER ELEMENT                   
*                                                                               
         B     XCLVRDX             DON'T SET PBQSLAVE                           
*                                                                               
         CLI   PCLTPROF+5,C'1'    IF THIS A MASTER CLIENT         L01           
         BNE   XCLVMASN                                           L01           
         CLI   PBFLAVOR,C'O'      AND NOT A CONTONLY REPORT                     
         BE    *+8                                                              
         MVI   PBQSLAVE,C'Y'      INDICATE SLAVES ARE TO BE READ  L01           
         B     XCLVRDX                                                          
*                                                                 L01           
XCLVMASN DS    0H                                                               
*                                                                 L01           
         CLI   PCLTPROF+5,C'2'     IF THIS IS A SLAVE CLIENT                    
         BNE   XCLVSLVN                                                         
         MVI   PBQSLAVE,C'Y'      INDICATE SLAVES ARE TO BE READ  L01           
         B     XCLVRDX                                                          
*                                                                 L01           
XCLVSLVN DS    0H                                                               
*                                                                               
XCLVRDX  DS    0H                                                               
*                                                                               
XCLVELMC DS    0H                                                               
*                                                                               
         ICM   R0,1,1(R6)          ELEMENT LENGTH                               
         BNZ   *+6                                                              
         DC    H'0'                BAD RECORD                                   
*                                                                               
         AR    R6,R0                                                            
         B     XCLVELML                                                         
*                                                                               
XCLVELMD DS    0H                                                               
*                                                                               
         MVI   ERROR,0             TURN OFF ERROR                               
         CR    RB,RB               SET CC TO EQ                                 
         B     XCLVALX                                                          
*                                                                               
XCLVSLER DS    0H                                                               
         MVI   ERROR,PWECLSLI      SLAVE CLIENTS INVALID FOR CONTONLY           
         B     XCLVERR                                                          
*                                                                               
XCLVERR  DS    0H                                                               
*                                                                               
         GOTO1 CURSERR             GO HANDLE ERROR MESSAGE                      
*                                                                               
XCLVALX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'PRWRIGEN - PRINT WRITER ROOT PHASE - XCGVAL'                    
***********************************************************************         
*                                                                     *         
*        VALIDATE EXCLUDED CLIENT GROUP                               *         
*                                                                     *         
*NTRY    R4 ==>  SCANNER BLOCK                                        *         
*                                                                     *         
*EXIT                                                                 *         
*                                                                     *         
***********************************************************************         
         DS    0D                                                               
XCGVAL   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING SPOOLD,R8                                                        
         USING GEND,RC                                                          
         USING SYSD,R9                                                          
         USING T405FFD,RA                                                       
*                                                                               
*        VALIDATE AS CLIENT GROUP                                               
*                                                                               
         LA    R1,22(R4)           POINT TO READ IN INPUT                       
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,1(R4)          INPUT LENGTH                                 
         BNP   XCGVNONE            MUST HAVE A CLIENT GROUP                     
         CHI   RF,L'PBQXCGRP+1     CHECK MAX LENGTH OF GROUP ID                 
         BH    XCGVNOTV                                                         
*                                                                               
*                                                                               
         CLI   0(R1),C'A'          FIRST POSITION MUST BE ALPHA                 
         BL    XCGVNOTA                                                         
         CLI   0(R1),C'Z'                                                       
         BH    XCGVNOTA                                                         
*                                                                               
         LA    R3,PBQXCGRP         EXCLUDED CLIENT GROUP CODE                   
         XC    0(L'PBQXCGRP,R3),0(R3) INIT GROUP ID AREA                        
*                                                                               
         MVC   HALF,SPACES                                                      
         MVC   HALF(1),0(R1)          SAVE GROUP CODE                           
*                                                                               
         CLI   1(R1),C'0'             IF NEXT IS NOT NUMERIC                    
         BNL   XCGPCL10                                                         
         CLI   1(R1),C'*'             OR WILD CARD                              
         BE    XCGPCL10                                                         
         CLI   1(R1),C' '             OR SPACE                                  
         BE    XCGPCL10                                                         
*                                                                               
         LA    R1,1(R1)                  BUMP ID POINTER                        
         MVC   HALF+1(1),0(R1)           SAVE SECOND PART OF CODE               
         SHI   RF,1                      DECREMENT LENGTH COUNTER               
*                                                                               
XCGPCL10 DS    0H                                                               
*                                                                               
*        TRANSLATE CLIENT GROUP CODE TO 1 BYTE ID                               
*                                                                               
         LAY   RE,SPCGRTAB         POINT TO CLIENT GROUP TABLE                  
*                                                                               
XCGPCLLP DS    0H                                                               
*                                                                               
         CLI   0(RE),X'FF'         INVALID IF EOT REACHED                       
         BE    XCGVNOTV                                                         
*                                                                               
         CLC   HALF,0(RE)          MATCH ENTRY TO TABLE                         
         BE    XCGPCLFD                                                         
*                                                                               
XCGPCLCN DS    0H                                                               
         LA    RE,3(RE)            BUMP TO NEXT TABLE ENTRY                     
         B     XCGPCLLP                                                         
*                                                                               
XCGPCLFD DS    0H                                                               
*                                                                               
         MVC   0(1,R3),2(RE)       SAVE 1 BYTE GROUPID                          
*                                                                               
         BCT   RF,*+8              DECREMENT FOR EXECUTE                        
         B     XCGPCLDN               NONE LEFT                                 
*                                                                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   1(0,R3),1(R1)       SAVE GROUP ID                                
*                                                                               
XCGPCLDN DS    0H                                                               
*                                                                               
*        READ SCHEME RECORD TO VALIDATE SCHEME                                  
*                                                                               
         XC    KEY,KEY             GET SCHEME RECORD                            
*                                                                               
         LA    R6,KEY              ESTABLISH GROUP RECORD KEY                   
         USING GRPRECD,R6                                                       
*                                                                               
         MVC   GRPKAGY,AGENCY      SET AGENCY                                   
*                                                                               
         BRAS  RE,CLTMED           FIND FIRST MEDIA                             
*                                                                               
         MVI   GRPKRCOD,GRPKCTYQ   ASSUME CLIENT GROUP                          
*                                                                               
         MVC   GRPKID,PBQXCGRP     SET SCHEME ID                                
*                                                                               
         MVI   RDUPDATE,C'N'       NOT READING FOR UPDATE                       
*                                                                               
XCGGRPLP DS    0H                                                               
*                                                                               
         GOTO1 HIGH                FIND DIRECTORY POINTER                       
*                                                                               
         CLC   KEY(25),KEYSAVE     CHECK IF RECORD FOUND                        
         BE    XCGGRPFD                                                         
*                                                                               
XCGGRPCN DS    0H                                                               
*                                                                               
         MVC   KEY,KEYSAVE         RESTORE KEY                                  
         BRAS  RE,CLTMED           FIND NEXT MEDIA                              
         BE    XCGGRPLP            NEW MEDIA FOUND                              
*                                                                               
         B     XCGVNOTV            GROUP NOT FOUND                              
*                                                                               
XCGGRPFD DS    0H                                                               
*                                                                               
         CLC   =C'ALL',1(R3)       DONE IF ALL OF SCHEME WANTED                 
         BE    XCGVIDSX                                                         
*                                                                               
         OC    1(L'PBQXCGC,R3),1(R3)   SAME AS ALL IF NO CODE                   
         BZ    XCGVIDSX                                                         
*                                                                               
         LA    RF,PBQXCGC-PBQXCGRP(R3)  START OF GROUP CODE                     
         LA    R0,L'PBQXCGC        CODE LENGTH                                  
*                                                                               
         CLI   0(RF),C'*'          SKIP VALIDATION IF WILD CARD                 
         BE    XCGVIDSX                                                         
         LA    RF,1(RF)                                                         
         BCT   R0,*-12                                                          
*                                  GROUP CODE ENTERED                           
         PACK  FULL(3),1(5,R3)     PACK 4 POSITION CODE WITHOUT SIGN            
*                                  GROUP CODE ENTERED                           
         LA    R6,KEY              RE-ESTABLISH KEY AS GRP RECORD KEY           
*                                  GROUP CODE ENTERED                           
         MVC   GRPKCODE,FULL       ADD CODE TO KEY                              
*                                  GROUP CODE ENTERED                           
         GOTO1 HIGH                                                             
*                                  GROUP CODE ENTERED                           
         CLC   GRPKEY,KEYSAVE      MUST FIND KEY                                
         BNE   XCGVNOTF                                                         
*                                                                               
XCGVIDSX DS    0H                                                               
*                                                                               
         MVI   ERROR,0             TURN OFF ERROR                               
         CR    RB,RB               SET CC TO EQ                                 
         B     XCGVALX                                                          
*                                                                               
*        ERROR ROUTINES                                                         
*                                                                               
XCGVNONE DS    0H                  MISSING GROUP CODE                           
         MVI   ERROR,PWEGPNO       SET ERROR CODE                               
         B     XCGVERR                                                          
*                                                                               
XCGVNOTF DS    0H                  GROUP CODE NOT ON FILE                       
         MVI   ERROR,PWEGPNFD      SET ERROR CODE                               
         B     XCGVERR                                                          
*                                                                               
XCGVNOTA DS    0H                  GROUP SCHEME NOT ALPHA                       
         MVI   ERROR,PWEGPNMN      SET ERROR CODE                               
         B     XCGVERR                                                          
*                                                                               
XCGVNOTV DS    0H                  INVALID GROUP CODE                           
         MVI   ERROR,PWEGPINV      SET ERROR CODE                               
         B     XCGVERR                                                          
*                                                                               
XCGVERR  DS    0H                                                               
*                                                                               
         GOTO1 CURSERR             GO HANDLE ERROR MESSAGE                      
*                                                                               
XCGVALX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'PRWRIGEN - PRINT WRITER ROOT PHASE - UIDVAL'                    
***********************************************************************         
*                                                                     *         
*        VALIDATE UPID FILTER                                         *         
*                                                                     *         
*        FILTER OF FORM NNNNNNN-NNNNNNNN NUMERIC                      *         
*              EITHER COMPONENT CAN BE MISSING                        *         
*                                                                     *         
*NTRY    R4 ==>  SCANNER BLOCK                                        *         
*                                                                     *         
*EXIT                                                                 *         
*                                                                     *         
***********************************************************************         
         DS    0D                                                               
UIDVAL   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING SPOOLD,R8                                                        
         USING GEND,RC                                                          
         USING SYSD,R9                                                          
         USING T405FFD,RA                                                       
*                                                                               
         LA    R7,PBLOCK           ESTABLISH PRINT BLOCK                        
         USING PBLOCK,R7                                                        
*                                                                               
*        VALIDATE AS RANGE OF NUMBERS                                           
*                                                                               
         LA    R1,22(R4)           POINT TO READ IN INPUT                       
*                                                                               
         SR    R0,R0                                                            
         ICM   R0,1,1(R4)          INPUT LENGTH                                 
         BNP   UIDVNONE            MUST HAVE A FILTER                           
         CHI   R0,L'PBUPIDFL+1     CHECK MAX LENGTH OF FILTER                   
         BH    UIDVLONG                                                         
*                                                                               
         LR    RE,R1               SAVE START OF FILTER                         
*                                                                               
         MVC   PBUPIDST,=8C' '     INIT UPID FILTER START                       
         MVC   PBUPIDEN,=8C' '     INIT UPID FILTER END                         
*                                                                               
UIDVSTLP DS    0H                                                               
*                                                                               
         CLI   0(R1),C'-'          FIND SEPARATOR                               
         BE    UIDVSTDN                                                         
*                                                                               
UIDVSTCN DS    0H                                                               
*                                                                               
         LA    R1,1(R1)            BUMP POINTER                                 
         BCT   R0,UIDVSTLP                                                      
*                                                                               
UIDVSTDN DS    0H                                                               
*                                                                               
*        HAVE STARTING FILTER                                                   
*                                                                               
         LR    RF,R1               END OF FILTER                                
         SR    RF,RE               LENGTH OF FILTER START                       
         BZ    UIDVEN              NO END FILTER                                
*                                                                               
         STC   RF,PBUPIDCL         SAVE AS COMPARE LENGTH                       
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   PBUPIDST(0),0(RE)   SAVE START OF FILTER RANGE                   
*                                                                               
*        FIND END OF UPID RANGE                                                 
*                                                                               
UIDVEN   DS    0H                                                               
*                                                                               
         MVC   PBUPIDEN,PBUPIDST   INIT END OF RANGE WITH START                 
*                                                                               
         AHI   R0,-1               DECREMENT FOR SEPARATOR                      
         BM    UIDV50              SINGLE FILTER                                
         BP    *+14                END FILTER ENTERED                           
         MVC   PBUPIDEN,=8C'9'     NO END - SET TO MAX END                      
         B     UIDV60                                                           
*                                                                               
         LA    R1,1(R1)            BUMP TO START OF END OF RANGE                
         LR    RE,R1               SAVE START OF END OF FILTER RANGE            
*                                                                               
UIDVENLP DS    0H                                                               
*                                                                               
UIDVENCN DS    0H                                                               
*                                                                               
         LA    R1,1(R1)            BUMP POINTER                                 
         BCT   R0,UIDVENLP                                                      
*                                                                               
UIDVENDN DS    0H                                                               
*                                                                               
*        HAVE END OF FILTER RANGE                                               
*                                                                               
         LR    RF,R1               POINT TO END OF FILTER                       
         SR    RF,RE               LENGTH OF FILTER END                         
*                                                                               
         CLM   RF,1,PBUPIDCL       SAVE SMALLER OF FILTER LENGTHS               
         BNL   *+8                                                              
         STC   RF,PBUPIDCL         SAVE AS COMPARE LENGTH                       
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   PBUPIDEN(0),0(RE)   SAVE END   OF FILTER RANGE                   
*                                                                               
UIDV50   DS    0H                                                               
*                                                                               
         CLC   PBUPIDST,PBUPIDEN   DONE IF START AND END DIFFERENT              
         BNE   UIDV60                                                           
*                                                                               
         CLI   PBUPIDCL,0          NO RANGE IF NO COMPARE LENGTH                
         BE    UIDVNONE                                                         
         CLI   SCANSEP,C'<'        IF END OF RANGE GIVEN                        
         BNE   UIDV55                                                           
*                                                                               
         MVC   PBUPIDST,=8C' '     SET START TO LOWEST                          
         B     UIDV60                                                           
*                                                                               
UIDV55   DS    0H                                                               
*                                                                               
         CLI   SCANSEP,C'>'        IF START OF RANGE GIVEN                      
         BNE   UIDV60                                                           
*                                                                               
         MVC   PBUPIDEN,=8C'9'     SET END TO HIGHEST                           
*                                                                               
UIDV60   DS    0H                                                               
*                                                                               
         CR    RB,RB               SET CC TO EQ                                 
         B     UIDVALX                                                          
*                                                                               
*        ERROR ROUTINES                                                         
*                                                                               
UIDVNOTV DS    0H                  INCORRECT RELATIONAL CHARACTER               
         MVI   ERROR,PWEUIDNV      SET ERROR CODE                               
         B     UIDVERR                                                          
*                                                                               
UIDVNONE DS    0H                  MISSING UPID RANGE                           
         MVI   ERROR,PWEUIDNO      SET ERROR CODE                               
         B     UIDVERR                                                          
*                                                                               
UIDVNOTN DS    0H                  UPID NOT NUMERIC                             
         MVI   ERROR,PWEUIDNN      SET ERROR CODE                               
         B     UIDVERR                                                          
*                                                                               
UIDVLONG DS    0H                  UPID TOO LONG                                
         MVI   ERROR,PWEUIDLN      SET ERROR CODE                               
         B     UIDVERR                                                          
*                                                                               
UIDVERR  DS    0H                                                               
*                                                                               
         GOTO1 CURSERR             GO HANDLE ERROR MESSAGE                      
*                                                                               
UIDVALX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'PRWRIGEN - PRINT WRITER ROOT PHASE - DSTVAL'                    
***********************************************************************         
*                                                                     *         
*        VALIDATE DISCREPANCY STATUS FILTER                           *         
*                                                                     *         
*NTRY    R4 ==>  SCANNER BLOCK                                        *         
*                                                                     *         
*EXIT                                                                 *         
*                                                                     *         
***********************************************************************         
         DS    0D                                                               
DSTVAL   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING SPOOLD,R8                                                        
         USING GEND,RC                                                          
         USING SYSD,R9                                                          
         USING T405FFD,RA                                                       
*                                                                               
         LA    R7,PBLOCK           ESTABLISH PRINT BLOCK                        
         USING PBLOCK,R7                                                        
*                                                                               
*        VALIDATE AS AGAINST TABLE OF VALUES                                    
*                                                                               
         LA    R1,22(R4)           POINT TO READ IN INPUT                       
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,1(R4)          INPUT LENGTH                                 
         BNP   DSTNONE             MUST HAVE A FILTER                           
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
*                                                                               
         LA    R3,DSTTAB           POINT TO TABLE OF VALUES                     
         USING DSTTAB,R3           ESTABLISH TABLE                              
*                                                                               
         MVI   PBQDSTA,0           INIT FILTER SAVEAREA                         
*                                                                               
DSTVALLP DS    0H                                                               
*                                                                               
         CLI   0(R3),0             ERROR IF EOT                                 
         BE    DSTNOTV                                                          
*                                                                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         CLC   0(0,R1),0(R3)       MATCH TO TABLE                               
         BE    DSTVALFD                                                         
*                                                                               
DSTVALCN DS    0H                                                               
*                                                                               
         LA    R3,DSTTABLQ(R3)     BUMP POINTER                                 
         B     DSTVALLP                                                         
*                                                                               
DSTVALFD DS    0H                                                               
*                                                                               
         MVC   PBQDSTA,DSTTABLQ-1(R3) SAVE INTERNAL VALUE                       
*                                                                               
         CR    RB,RB               SET CC TO EQ                                 
         B     DSTVALX                                                          
*                                                                               
*        ERROR ROUTINES                                                         
*                                                                               
DSTNOTV  DS    0H                  INVALID FILTER VALUE                         
         LHI   RF,PWEDSTNV         SET ERROR CODE                               
         B     DSTVERR                                                          
*                                                                               
DSTNONE  DS    0H                  FILTER VALUE REQUIRED                        
         LHI   RF,PWEDSTRQ         SET ERROR CODE                               
         B     DSTVERR                                                          
*                                                                               
DSTVERR  DS    0H                                                               
*                                                                               
         USING GETTXTD,GETTXTCB    ESTABLISH GETMSG CONTROL BLOCK               
*                                                                               
         STCM  RF,3,GTMSGNO        SET ERROR CODE                               
*                                                                               
         GOTO1 CURSERR             GO HANDLE ERROR MESSAGE                      
*                                                                               
DSTVALX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
DSTTAB   DS    0X                                                               
DSTTDST  DC    CL12'RESOLVED    '  FILTER                                       
DSTTDSTI DC    AL1(PBNVDRSQ)       INTERNAL VALUE                               
DSTTABLQ EQU   *-DSTTAB            TABLE ENTRY LENGTH                           
*                                                                               
         DC    CL12'REVIEWING   '  FILTER                                       
         DC    AL1(PBNVDRVQ)       INTERNAL VALUE                               
*                                                                               
         DC    CL12'NEEDS REVIEW'  FILTER                                       
         DC    AL1(PBNVDNRQ)       INTERNAL VALUE                               
*                                                                               
         DC    XL1'00'             EOT                                          
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'PRWRIGEN - PRINT WRITER ROOT PHASE - INVVAL'                    
***********************************************************************         
*                                                                     *         
*        VALIDATE INVENTORY RANGE                                     *         
*                                                                     *         
*NTRY    R4 ==>  SCANNER BLOCK                                        *         
*                                                                     *         
*EXIT                                                                 *         
*                                                                     *         
***********************************************************************         
         DS    0D                                                               
INVVAL   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING SPOOLD,R8                                                        
         USING GEND,RC                                                          
         USING SYSD,R9                                                          
         USING T405FFD,RA                                                       
*                                                                               
         XC    PBQINVST,PBQINVST   INIT SAVED INVOICE NUMBERS                   
         XC    PBQINVEN,PBQINVEN   INIT SAVED INVOICE NUMBERS                   
*                                                                               
         SR    R0,R0                                                            
         ICM   R0,1,1(R4)          GET INVOICE NUMBER LENGTH                    
         BZ    INVVNOTE            INVOICE NUMBER REQUIRED                      
*                                                                               
         LA    R1,22(R4)           START OF INVOICE NUMBERS                     
         LR    RE,R1               SAVE START OF INVOICE NUMBER                 
*                                                                               
         CLI   0(R1),C'-'          FIND END OF START INV NUMBER                 
         BE    *+12                                                             
         AHI   R1,1                BUM TO NEXT POSITION                         
         BCT   R0,*-12                                                          
*                                                                               
         LR    RF,R1               END OF INVOICE NUMBER                        
         SR    RF,RE               INVOICE NUMBER LENGTH                        
         BZ    INVV10              NO STARTING INV #                            
*                                                                               
         CHI   RF,6                MUST BE 6 LONG                               
         BNE   INVVNVE                                                          
*                                                                               
         MVC   PBQINVST,0(RE)      SAVE STARTING INVOICE NUMBER                 
*                                                                               
INVV10   DS    0H                                                               
*                                                                               
         MVC   PBQINVEN,PBQINVST   INIT ENDING   INVOICE NUMBER                 
*                                                                               
         LTR   R0,R0                                                            
         BZ    INVV20              SINGLE INVOICE NUMBER                        
*                                                                               
         XC    PBQINVEN,PBQINVEN   INIT ENDING INVOICE NUMBER                   
*                                                                               
         LA    R1,1(R1)            START OF ENDING INVOICE NUMBER               
         LR    RE,R1               SAVE START                                   
*                                                                               
         BCT   R0,*+8              DECREMENT LENGTH COUNTER                     
         B     INVV20              NO ENDING INVOICE NUMBER                     
*                                                                               
         LR    RF,R0               LENGTH OF ENDING INVOICE NUMBER              
*                                                                               
         CHI   RF,6                MUST BE 6 LONG                               
         BNE   INVVNVE                                                          
*                                                                               
         MVC   PBQINVEN,0(RE)      SAVE ENDING INVOICE NUMBER                   
*                                                                               
INVV20   DS    0H                                                               
*                                                                               
         OI    PBBYOPTS,PBBYBHTQ   BUILD BILL HEADER TABLE                      
*                                                                               
INVVALX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
INVVNVE  MVI   ERROR,PWEINVNV      INVALID INVOICE NUMBER                       
         B     INVVERR                                                          
*                                                                               
INVVNOTE MVI   ERROR,PWEINVNE      MISSING INVOICE NUMBER                       
*                                                                               
INVVERR  ST    R4,DMCB+8           SAVE ERROR POINTER                           
         GOTO1 CURSERR             PUT OUT ERROR MESSAGE                        
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'PRWRIGEN - PRINT WRITER ROOT PHASE - VALRP2'                    
***********************************************************************         
*                                                                     *         
*        VALIDATE A SECOND REPORT ID                                  *         
*                                                                     *         
*NTRY    R4 ==>  SCANNER BLOCK                                        *         
*                                                                     *         
*EXIT                                                                 *         
*                                                                     *         
***********************************************************************         
         DS    0D                                                               
VALRP2   NMOD1 0,**#RP2**,RR=RE                                                 
***      =================  ***                                                 
         USING SPOOLD,R8                                                        
         USING GEND,RC                                                          
         USING SYSD,R9                                                          
         USING T405FFD,RA                                                       
***      =================  ***                                                 
*                                                                               
         LA    RC,SPOOLEND         RESET WORKING STORAGE POINTER                
         ST    RE,VRWRELO          SAVE RELOACTION FACTOR                       
*                                                                               
         XC    KEY,KEY             READ REPORT KEY TO VERIFIFY                  
         LA    R2,KEY                                                           
         USING CT01RECD,R2         ESTABLISH PROGRAM RECORD                     
*                                                                               
         MVI   CT01TYPE,CT01TYPQ   SET RECORD TYPE                              
         MVC   CT01AGID,AGYALPHA   SET AGENCY ID                                
         MVI   CT01SYS,4           SET FOR PRINT SYSTEM                         
         MVI   CT01PRG,5           SET FOR PRINT WRITER                         
         MVI   CT01PHAS,1          SET FOR PHASE 1                              
         MVC   CT01NAME,22(R4)     SECOND REPORT NAME                           
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
*                                                                               
         MVC   FILENAME,=CL8'CTFILE' SET FILENAME                               
         MVI   USEIO,C'Y'                                                       
*                                                                               
         GOTO1 HIGH                READ IN PROGRAM RECORD                       
*                                                                               
         XC    FILENAME,FILENAME   RESET FILENAME                               
         MVI   USEIO,C'N'                                                       
*                                                                               
         CLC   CT01KEY,KEYSAVE     MUST FIND IT                                 
         BNE   VRP2NEQ                                                          
*                                                                               
         MVC   RP2ID,CT01NAME      SAVE SECOND REPORT ID                        
*                                                                               
         CLC   12(8,R4),=C'CONTINUED'  IF CONTINUED OPTION                      
         BNE   *+12                                                             
         MVI   PBQRP2OP,C'C'              SET INDICATOR                         
         MVI   DOWNOPT,C'Y'               FORCE DOWNLOAD                        
*                                                                               
VRP2EQU  CR    RB,RB               SET EQ CC                                    
         B     VALRP2X                                                          
*                                                                               
VRP2NEQ  LTR   RB,RB               SET NEQ CC                                   
*                                                                               
VALRP2X  DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP  R2,RB                                                            
*                                                                               
         TITLE 'PRWRIGEN - PRINT WRITER ROOT PHASE - VALROW'                    
***********************************************************************         
*                                                                     *         
*        VALIDATE A ROW                                               *         
*                                                                     *         
*NTRY    R2 ==>  ROW    FIELD ON SCREEN                               *         
*                                                                     *         
*EXIT                                                                 *         
*                                                                     *         
***********************************************************************         
         DS    0D                                                               
VALROW   NTR1  BASE=*,LABEL=*                                                   
***      =================  ***                                                 
         USING SPOOLD,R8                                                        
         USING GEND,RC                                                          
         USING SYSD,R9                                                          
         USING T405FFD,RA                                                       
***      =================  ***                                                 
         GOTOR VINIROW             INITIALIZE VALROW                            
*                                                                               
* ROWS - FIRST VALIDATE FOR KEYWORD                                             
*                                                                               
         LA    R4,BLOCK            POINT TO START OF SCANNER BLOCK              
*                                                                               
         STC   R3,FLDNMBR          SAVE FIELD NUMBER                            
         ST    R2,ALASTCOL         SAVE COLUMN POINTER                          
*                                                                               
         SR    R0,R0                                                            
         ICM   R0,1,MAX            GET MAX NUMBER OF FIELDS OF TYPE             
         JZ    VALROWX             MUST HAVE SOME                               
*                                                                               
         CLI   5(R2),0             SKIP IF NO DATA ENTERED                      
         JE    VALROWX                                                          
*                                                                               
VALROWXL DS    0H                                                               
*                                                                               
         STC   R3,FLDNMBR          SAVE FIELD NUMBER                            
         ST    R2,ALASTCOL         SAVE COLUMN POINTER                          
*                                                                               
         MVI   FIELDERR,1          INIT FIELD IN ERROR COUNTER                  
*                                                                               
         NI    ROWCOLSW,X'FF'-ROWCOLXQ INIT CONTINUED FIELD INDICATOR           
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,5(R2)          FIELD LENGTH                                 
         JZ    VRWNOTV                MUST HAVE SOMETHING                       
         LA    RE,7(RF,R2)         LAST BYTE OF INPUT                           
*                                                                               
         CLI   0(RE),C','          IF FIELD ENDS IN COMMA                       
         JNE   VALROWX1                                                         
*                                                                               
         MVI   0(RE),C' '             REPLACE COMMA                             
         OI    ROWCOLSW,ROWCOLXQ      FIELD CONTINUED IN NEXT FIELD             
         BCTR  RF,0                   LENGTH DECREMENTED FOR SCANNER            
         STC   RF,5(R2)                                                         
*                                                                               
VALROWX1 DS    0H                                                               
*                                                                               
*        SCAN INPUT                                                             
*                                                                               
         GOTO1 SCANNER,DMCB,(20,(R2)),(134,(R4)),0                              
*                                                                               
         SR    R0,R0                                                            
         ICM   R0,1,4(R1)          SOMETHING MUST HAVE BEEN SCANNED             
         JZ    VRWNOTV                                                          
*                                                                               
         TM    ROWCOLSW,ROWCOL2Q   SKIP IF DOING CONTINUATION FIELD             
         JO    VRWQUAL                                                          
*                                                                               
         CLI   12(R4),C'?'         IF HELP REQUESTED                            
         JE    *+8                                                              
         CLI   12(R4),C'+'         IF HELP REQUESTED                            
         JNE   VROWHLPX                                                         
*                                                                               
         LA    RF,HELPCBLK         SET FIELD TYPE IN HELP CONTROL BLOCK         
         MVC   HCBFTYP-HELPCB(L'HCBFTYP,RF),MYPOSO                              
*                                                                               
         CLI   MYPOSO,0            IF PROCESSING A ROW                          
         JNE   *+8                                                              
         MVI   HCBFTYP-HELPCB(RF),C'R'   HARD CODE VALUE                        
*                                                                               
         GOTO1 VPRHELP,DMCB,=AL2(PRQHMKYW),(R2),HELPCBLK SHOW HELP MENU         
*                                     FOR OPTIONS                               
         DC    H'0'                SHOULD NOT COME BACK                         
*                                                                               
VROWHLPX DS    0H                                                               
*                                                                               
         OI    SORTIND,SORTFLDQ    INDICATE REPORT HAS A SORT FIELD             
*                                                                               
*        VALIDATE KEYWORD FOR ENTRY                                             
*                                                                               
VRWENT   DS    0H                                                               
*                                                                               
*        CHECK FOR '<' & '>' AS SEPARATORS                                      
*                                                                               
         GOTOR SEPSCAN       CHECK FOR < AND >                                  
*                                                                               
         JNE   VRWNOTV             ERROR FOUND                                  
*                                                                               
*        VALIDATE KEYWORD AGAINST FILTERS                                       
*                                                                               
         L     R1,AVLPARMS                                                      
         USING VLPARMS,R1          ESTABLISH DDVAL PARAMETERS                   
*                                                                               
         GOTO1 VDDVAL,(R1),('VLPVALQ',=AL2(PRQWRKYW)),                 X        
               (0(R4),12(R4)),AVLTAB,0,0,0                                      
*                                                                               
         CLI   VLPERR,0            CHECK FOR ERRORS                             
         BE    *+16                NONE                                         
         CLI   DDS,C'Y'            OKAY IF FROM DDS TERMINAL                    
         BE    *+8                                                              
         J     VRWNOTV             ELSE ERROR                                   
*                                                                               
         DROP  R1                                                               
*                                                                               
         GOTO1 VROWDRON            VALIDATE A ROW ENTRY VIA DRONE               
*                                                                               
         CLI   DRERROR,0           CHECK FOR VALIDATION ERRORS                  
         JNE   VRWNOTV                                                          
*                                                                               
*        CHECK TO SEE IF ENTRY IS A KEY FIELD AND INDICATOR                     
*           NEEDS TO BE SAVED                                                   
*            DATA IS IN ENTRY ATTRIBUTES - BYTE AFTER A C'Q'                    
*                                                                               
         MVC   DRARGSI+6(1),KEYWORD# PASS ALONG KEYWORD NUMBER                  
         MVI   DRNARGSI,16         UPDATE NUMBER OF ARGUMENTS                   
*                                                                               
         MVC   DRARGSO+6(1),KEYWORD# PASS ALONG KEYWORD NUMBER                  
         MVI   DRNARGSO,16         UPDATE NUMBER OF ARGUMENTS                   
*                                                                               
VRWKTP   DS    0H                                                               
*                                                                               
         LA    R1,DRATTRIB         POINT TO ENTRY ATTRIBUTES                    
         LA    RF,L'DRATTRIB       MAX NUMBER OF ATTRIBUTES                     
*                                                                               
         CLI   0(R1),C'Q'          Q INDICATES KEY FIELD NEXT                   
         JE    *+16                                                             
         LA    R1,1(R1)            BUMP ATTRIBUTE POINTER                       
         BRCT  RF,*-12                                                          
         J     VRWKTPX             NONE FOUND                                   
*                                                                               
*       ADD SORT TYPE ID (WHAT IS TO BE SORTED ) INTO VALUETAB                  
*          DATA GOES IN NEXT AVAILABLE PLACE                                    
*                                                                               
         LA    RE,LEVELTYP         POINT TO TYPE SAVEAREA                       
         LA    RF,L'LEVELTYP       NUMBER OF POSITIONS IN SAVEAREA              
*                                                                               
         CLI   0(RE),0             LOOK FOR EMPTY PLACE                         
         JE    *+16                                                             
         LA    RE,1(RE)            BUMP TO NEXT PLACE                           
         BRCT  RF,*-12                                                          
         J     VRWKTPX             NO ROOM AVAILABLE                            
*                                                                               
         MVC   0(1,RE),1(R1)       SAVE KEY VALUE                               
*                                                                               
VRWKTPX  DS    0H                                                               
*                                                                               
         CLI   PBFLAVOR,C'O'       IF CONTRACT DATA ONLY                        
         JNE   VRW00                                                            
*                                                                               
         CLI   DRARGSI,C'B'        NO BUY  FIELDS FOR CONTONLY OPTION           
         JE    *+8                                                              
         CLI   DRARGSI,C'K'        NO CLEARANCE   FOR CONTONLY OPTION           
         JE    *+8                                                              
         CLI   DRARGSI,C'L'        NO BILL FIELDS FOR CONTONLY OPTION           
         JE    *+8                                                              
         CLI   DRARGSI,C'Q'        NO CASH FIELDS FOR CONTONLY OPTION           
         JNE   VRW00                                                            
*                                                                               
         CLC   =C'SPACE',12(R4)    'SPACE' IS AN EXCEPTION                      
         JNE   VRWCONTE                                                         
*                                                                               
         MVI   DRARGSI,C'C'        IT IS CHANGED TO CONTRACT FIELD              
         MVC   DRATTRIB+1(2),=C'NT'   AND NOT TOTALLED                          
         J     VRW00                                                            
*                                                                               
VRW00    DS    0H                                                               
*                                                                               
         CLI   DRATTRIB+1,X'10'  IS THIS A CLIENT ENTRY           L15           
         JNE   *+8                                                L15           
         OI    PBQREQFL,X'10'                                     L15           
*                                                                               
         CLI   DRATTRIB+1,X'08'   PUB RELATED ENTRY               L15           
         JNE   *+8                                                L15           
         OI    PBQREQFL,X'08'                                     L15           
*                                                                               
         CLC   DRATTRIB(3),=C'DTI'  INSERT DATE                   L15           
         JNE   *+8                                                L15           
         OI    PBQREQFL,X'04'                                     L15           
*                                                                               
         CLI   DRATTRIB+1,6        PUBLISHER ENTRY                              
         JNE   *+8                                                              
         MVI   PBABUFFS,255        MOVE PUBLISHER ID                            
*                                                                               
         CLC   DRATTRIB(2),=C'DT'  SPECIAL DATE EXPRESSION                      
         JE    VRW01                                                            
*                                                                               
         CLI   DRATTRIB,C'C'       COLUMN ONLY ENTRIES NOT ALLOWED              
         JE    VRWNOTV                                                          
*                                                                               
         CLI   DRATTRIB,C'D'       DETAIL ONLY ENTRIES IN HEAD OR MID           
         JNE   *+12                NOT ALLOWED                                  
         CLI   MYPOSO,0                                                         
         JNE   VRWNOTV                                                          
*                                                                               
VRW01    DS    0H                                                               
**                                                                              
**  DETERMINE DISTRICT/REGION/DIVISION                                          
**                                                                              
         CLC   DRATTRIB+1(2),=C'DR'      DRD ROW SELECTED                       
         JNE   *+8                                                              
         MVI   PBQDRDSW,PBQDRDYQ                                                
*                                                                               
         EJECT                                                                  
*                                                                               
*        CHECK FOR COMMENT ENTRY                                                
*                                                                               
         CLC   =C'COM',12(R4)      CHECK FOR COMMENT ENTRY                      
         JNE   VRWCOMN                                                          
*                                                                               
         GOTOR COMVAL                                                           
*                                                                               
         J     VRWENTX                                                          
*                                                                               
VRWCOMN  DS    0H                                                               
*                                                                               
*        CHECK FOR CUSTOM COLUMN ENTRY                                          
*                                                                               
         CLC   =C'CC ',12(R4)      CHECK FOR CUSTOM COLUMN                      
         JNE   VRWCCN                                                           
*                                                                               
         GOTOR CCVAL                                                            
*                                                                               
         J     VRWENTX                                                          
*                                                                               
VRWCCN   DS    0H                                                               
*                                                                               
*        IF GROUP SCHEME REPORT                                                 
*        ADD BREAK NAMES TO HEADLINES                                           
*                                                                               
         CLC   =C'IGRP',DRRTNI     SKIP IF NOT GROUP CODE KEYWORD               
         JNE   VRWGRPX                                                          
*                                                                               
         L     R6,PBAGPCBK         ASSUME CLIENT GROUP KEYWORD                  
*                                                                               
         CLI   DRARGSI+2,C'P'      CHECK FOR PRODUCT                            
         JNE   *+8                                                              
         L     R6,PBAGPPBK                                                      
*                                                                               
         CLI   DRARGSI+2,C'B'      CHECK FOR PUB                                
         JNE   *+8                                                              
         L     R6,PBAGPBBK                                                      
*                                                                               
         LTR   R6,R6               MUST BE USING A GROUP SCHEME                 
         JZ    VRWGRPNF                                                         
*                                                                               
         USING GRPBRKD,R6          ESTABLISH BREAK DESC ELM                     
*                                                                               
         OI    DRHEAD1,X'80'       FORCE HEADLINE TO PRINT                      
*                                                                               
         LA    R1,GRPBK1           DEFAULT TO FIRST BREAK                       
*                                                                               
         CLI   DRARGSI+3,C'1'      OKAY IF FIRST BREAK WANTED                   
         JE    VRWGRP5                                                          
*                                                                               
         CLI   DRARGSI+3,C'0'      OKAY IF LOWEST BREAK WANTED                  
         JNE   *+12                                                             
         CLI   GRPBK2LN,0          AND NO SECOND BREAK PRESENT                  
         JE    VRWGRP5                                                          
*                                                                               
         LA    R1,GRPBK2           ELSE USE SECOND BREAK                        
*                                                                               
VRWGRP5  DS    0H                                                               
*                                                                               
         CLI   DRARGSI+3,C'2'      IF SECOND BREAK WANTED                       
         JNE   *+12                                                             
         CLI   GRPBK2LN,0          THEN MUST HAVE SECOND BREAK DEFINED          
         JE    VRWNO2E                                                          
*                                                                               
*        FIND LENGTH OF BREAK NAME                                              
*                                                                               
         LA    RF,L'GRPBK1         MAX LENGTH OF BREAK NAME                     
         LA    RE,(L'GRPBK1-1)(R1) LAST BYTE OF BREAK NAME                      
*                                                                               
         CLI   0(RE),C' '          FIND LAST NON-BLANK                          
         JH    *+14                                                             
         BCTR  RE,0                                                             
         BRCT  RF,*-10                                                          
         J     *+6                 NO NAME                                      
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         J     *+10                                                             
         MVC   DRH1LIT(0),0(R1)    SET COLUMN TITLE                             
*                                                                               
         LA    RF,1(RF)            RESTORE TRUE LENGTH                          
*                                                                               
         STC   RF,DRH1LITL         SET LITERAL LENGTH                           
*                                                                               
         J     VRWENTX                                                          
*                                                                               
VRWGRPX  DS    0H                                                               
*                                                                               
         CLC   =C'IGP',DRRTNI      SKIP IF NOT GROUP CODE KEYWORD               
         JNE   VRWGPX                                                           
*                                                                               
         CLI   1(R4),1             MUST HAVE 1-CHARACTER SCHEME CODE            
         JNE   VRWGP1E                                                          
*                                                                               
         TM    3(R4),X'40'         MUST BE ALPHABETIC                           
         JNO   VRWGP2E                                                          
         TM    3(R4),X'80'         AND NOT NUMERIC                              
         JO    VRWGP2E                                                          
*                                                                               
         MVC   DRARGSI+3(1),22(R4) SAVE SCHEME CODE                             
*                                                                               
         J     VRWENTX                                                          
*                                                                               
VRWGPX   DS    0H                                                               
*                                                                               
         EJECT                                                                  
*                                                                               
*        IF ADDITIONAL CHARGES BROKEN OUT                                       
*           SET APPROPRIATE SWITCHES                                            
*                                                                               
         CLC   =C'IACH',DRRTNI     SKIP IF NOT ADDITIONAL CHGS KYWD             
         JNE   VRWACHX                                                          
*                                                                               
         OI    PBBYOPT2,PBBYACHQ   INDICATE ADDL CHGS WANTED                    
         OI    PBQACHGS,PBQACOPQ+PBQACLSQ  AND ADDL CHGS TO BE LISTED           
*                                                                               
VRWACHX  DS    0H                                                               
*                                                                               
         CLC   =C'IBNV',DRRTNI     SKIP IF NOT NEW INVOICE KYWD                 
         JNE   VRWBNVX                                                          
*                                                                               
         OI    PBBYOPT2,PBBYPNVQ   INDICATE NEW INVOICE DATA                    
*                                                                               
VRWBNVX  DS    0H                                                               
*                                                                               
*        CHECK FOR STACKING (STACK=A-N)                                         
*        CHECK FOR MERGING  (MERGE=A-N)                                         
*                                                                               
         CLC   =C'STACK',12(R4)    IF STACKING BEING CALLED FOR                 
         JE    *+10                                                             
         CLC   =C'MERGE',12(R4)    IF MERGING  BEING CALLED FOR                 
         JNE   VRWSTKN                                                          
*                                                                               
         CLI   1(R4),0                MUST HAVE COLUMN SPECIFICATION            
         JE    VRWSTKE2                                                         
*                                                                               
         CLI   1(R4),3                AND AT MOST 3 LONG                        
         JH    VRWSTKE2                                                         
*                                                                               
         OI    SPECOPT2,GLDADDCH   IN CASE DOWNLOADING, KEEP                    
*                                     CHAR ADDITIVE FIELDS AS CHAR              
*                                     EVEN IF NUMERIC                           
*                                                                               
         CLC   =C'MERGE',12(R4)    IF MERGING  BEING CALLED FOR                 
         JNE   VRWMRG05                                                         
*                                                                               
         OI    STACKSW,STCKMRGQ+STCKBUFQ  INDICATE MERGING AND                  
*                                         BUFFER NEED OFF-LINE                  
         NI    DRFLAGO,X'FF'-X'80' TURN OFF PRINT IND ON ALL HEADLINES          
         NI    DRHEAD1,X'FF'-X'80'                                              
         NI    DRHEAD2,X'FF'-X'80'                                              
         NI    DRHEAD3,X'FF'-X'80'                                              
         NI    DRHEAD4,X'FF'-X'80'                                              
*                                                                               
         J     VRWMRG10                                                         
*                                                                               
VRWMRG05 DS    0H                                                               
*                                                                               
         OI    STACKSW,STACKYQ+STCKBUFQ ELSE INDICATE STACKING AND              
*                                         BUFFER NEED OFF-LINE                  
*                                                                               
*        INITIALIZE STACK BUFFER                                                
*                                                                               
         ICM   RF,15,ASTACKBF      POINT TO STACK BUFFER                        
         USING STACKBFD,RF         ESTABLISH BUFFER                             
*                                                                               
         LA    RE,STBFSTRT         SET BXLE ADDRESSES FOR BUFFER                
         ST    RE,STBFSTA          START ADDRESS                                
         BCTR  RE,0                                                             
         ST    RE,STBFENA          CURRENT END ADDRESS                          
         LA    RE,STBFENTL         BUFFER ENTRY LENGTH                          
         ST    RE,STBFLEN                                                       
*                                                                               
         DROP  RF                                                               
*                                                                               
VRWMRG10 DS    0H                                                               
*                                                                               
         LA    RF,22(R4)           POINT TO COLUMN SPECIFICATIONS               
*                                                                               
         CLI   0(RF),C'A'          MUST BE A TO N                               
         JL    VRWSTKE2                                                         
         CLI   0(RF),C'N'                                                       
         JH    VRWSTKE2                                                         
*                                                                               
         MVC   STACK1ST,0(RF)      SAVE STARTING COLUMN                         
*                                                                               
         CLI   1(R4),1             OKAY IF ONLY 1 COLUMN                        
         JE    VRWSTKCX                                                         
*                                                                               
         CLI   1(RF),C'-'          ELSE NEED DASH AS SEPARATOR                  
         JNE   VRWSTKE2                                                         
*                                                                               
         CLC   2(1,RF),STACK1ST    MUST BE EQUAL OR AFTER FIRST                 
         JL    VRWSTKE2                                                         
         CLI   2(RF),C'N'          AND AT MOST C'N'                             
         JH    VRWSTKE2                                                         
*                                                                               
         MVC   STACKLST,2(RF)      SAVE ENDING COLUMN                           
*                                                                               
VRWSTKCX DS    0H                                                               
*                                                                               
         J     VRWENTX                                                          
*                                                                               
VRWSTKN  DS    0H                                                               
*                                                                               
         EJECT                                                                  
*                                                                               
*        CHECK FOR USER FIELDS                                                  
*                                                                               
VRWUDEF  DS    0H                                                               
*                                                                               
         CLC   =C'UDEF',12(R4)     USER FIELD IDENTIFIER                        
         JE    *+10                                                             
         CLC   =C'LBGL#',12(R4)    LABATT GENERAL LEDGER #                      
         JNE   VRWUDEFX                                                         
*                                                                               
         GOTOR UDEFVAL             GO DO VALIDATION                             
*                                                                               
         J     VRWENTX                                                          
*                                                                               
VRWUDEFX DS    0H                                                               
*                                                                               
VRWUCOM  DS    0H                                                               
*                                                                               
         CLC   =C'UCOM',12(R4)     USER FIELD IDENTIFIER                        
         JNE   VRWUCOMX                                                         
*                                                                               
         GOTOR UCOMVAL             GO DO VALIDATION                             
*                                                                               
         J     VRWENTX                                                          
*                                                                               
VRWUCOMX DS    0H                                                               
*                                                                               
         CLI   DRARGSI,C'X'        IF INVOICE KEYWORD                           
         BNE   *+8                                                              
         OI    PBQREAD2,PBQRDINV      SET TO READ INVOICE RECORDS               
*                                                                               
         CLI   DRARGSI,C'Y'        IF INVOICE KEYWORD                           
         BNE   *+8                                                              
         OI    PBQREAD2,PBQRDNV       SET TO READ INVOICE RECORDS               
*                                                                               
*  CHECK IF READING BUYS VIA PAY OR BILL ELEMENTS                               
*                                                                               
         CLI   DRARGSI,C'B'        IF GENERAL BUY RECORD DATA                   
         JNE   *+14                                                             
         OI    PBBYOPTS,PBBYBUYQ      SET INDICATOR                             
         AP    PBQKYWDN,=P'1'         BUMP # OF BUY RELATED KEYWORDS            
*                                                                               
         CLI   DRARGSI,C'K'        IF CLEARANCE STATUS KEYWORD                  
         JNE   *+8                                                              
         OI    PBBYOPTS,PBBYCLSQ+PBBYPAYQ   READING BY PAY & CLEARANCE          
*                                                                               
         CLI   DRARGSI,C'N'        IF PAY ELEMENT ONLY KEYWORD                  
         JNE   *+8                                                              
         OI    PBBYOPTS,PBBYPAYQ      READING BY PAY                            
*                                                                               
         CLI   DRARGSI,C'J'        IF PAY ELEMENT KEYWORD                       
         JNE   *+8                                                              
         OI    PBBYOPTS,PBBYCLSQ+PBBYPAYQ   READING BY PAY & CLEARANCE          
*                                                                               
         CLI   DRARGSI,C'L'        IF BILL HEADER DATA                          
         JNE   *+8                                                              
         OI    PBBYOPTS,PBBYBHDQ                                                
*                                                                               
         CLI   DRARGSI,C'Q'        IF CASH APPLIED DATA                         
         JNE   *+16                                                             
         OI    PBBYOPTS,PBBYBHTQ      NEED BILL HEADER TABLE                    
         OI    PBBYOPT2,PBBYCSHQ      NEED CASH DATA                            
         OI    PBQREAD,PBQRDBLS    READ BILL RECORDS                            
*                                                                               
         CLI   DRARGSI,C'M'        IF BILL ELEMENT KEYWORD                      
         JNE   *+8                                                              
         OI    PBBYOPTS,PBBYBLLQ      READING BY BILL ELEMENTS                  
*                                                                               
         CLI   DRARGSI,C'I'        IF BILL ELEMENT KEYWORD & BILL               
         JNE   *+12                   HEADER DATA NEEDED                        
         OI    PBBYOPTS,PBBYBLLQ+PBBYBHTQ READING BY BILL ELEMENTS              
*                                     AND NEED BILL HEADER TABLE                
         OI    PBQREAD,PBQRDBLS    READ BILL RECORDS                            
*                                                                               
         CLC   DRRTNI,=C'IAADT   ' ACTIVITY DATE USES ALL ELEMENTS              
         JNE   *+18                                                             
         OI    PBBYOPTS,PBBYBLLQ+PBBYBHTQ+PBBYPAYQ+PBBYCLSQ                     
         OI    PBQREAD,PBQRDBLS    READ BILL RECORDS                            
         ZAP   PBQKYWDN,=P'1'      RESET # OF BUY RELATED KEYWORDS              
*                                                                               
         CLC   DRARGSI(2),=C'H6 ' PGEST KEYWORD                                 
         JNE   *+8                                                              
         OI    PBQCFOPT,PBQCFPGQ   SET FLAG                                     
*                                                                               
         CLC   DRARGSI(2),=C'H7 ' GFEST KEYWORD                                 
         JNE   *+8                                                              
         OI    PBQCFOP2,PBQCFGFQ   SET FLAG                                     
*                                                                               
*  MARKET VALID FOR NEWSPAPER AND OUTDOOR ONLY                                  
*                                                                               
VRWMKT   DS    0H                                                               
*                                                                               
         CLC   12(6,R4),=C'MARKET'   CHECK FOR MARKET ENTRY                     
         JNE   VRWMKTX                                                          
*                                                                               
         CLI   PBQMED,C'N'         MEDIA MUST BE NEWSPAPER                      
         JE    *+8                                                              
         CLI   PBQMED,C'O'         OR OUTDOOR                                   
         JNE   VRWMKTE1                                                         
*                                                                               
VRWMKTX  DS    0H                                                               
*                                                                               
*        CROSS CHECKING FOR RANK ENTRY                                          
*                                                                               
VRWRNK   DS    0H                                                               
*                                                                               
         CLC   12(4,R4),=C'RANK'                                                
         JNE   VRW06                                                            
*                                                                               
         LA    R4,42(R4)           RANK NEEDS A COMPUTE EXPRESSION              
         BRCT  R0,*+8              MUST HAVE FOLLOWING ENTRY                    
         J     VRWNOTV                                                          
*                                                                               
         AI    FIELDERR,1          BUMP FIELD IN ERROR COUNTER                  
         MVI   DRCMPMAX,C'N'                                                    
         MVI   PBUNITS+1,C'R'      INDICATE RANK IN ROW RQSTD- NO               
*                                   TOTALS AFTER THIS                           
         CLI   OFFLINE,C'Y'        IF OFF-LINE                                  
         JNE   VRWRNK1                                                          
*                                                                               
         GOTO1 GROWDRON            GENERATE ROW ENTRY                           
         GOTO1 GCMPDRON            GENERATE FOR COMPUTE                         
*                                                                               
         CLI   DRERROR,0           CHECK FOR ERRORS                             
         JNE   VRWNOTV                                                          
         J     VALROWX                                                          
*                                                                               
VRWRNK1  DS    0H                                                               
*                                                                               
         GOTO1 VCMPDRON            VALIDATE NEXT FIELD AS COMPUTE               
         CLI   DRERROR,0                                                        
         JNE   VRWNOTV                                                          
*                                                                               
         CLI   MYPOSO,0            IF WE DOING ROWS - NOT 'H' OR 'M'            
         JNE   VRW06                                                            
*                                                                               
         CH    R3,=H'1'            CHECK THIS IS NOT THE LAST ROW               
         JE    VRWRNKE1                                                         
*                                                                               
         LR    R3,R2               SAVE CURRENT FIELD POINTER                   
*                                                                               
         ZIC   RF,0(R2)            BUMP TO NEXT SCREEN FIELD                    
         AR    R2,RF                                                            
*                                                                               
         CLI   5(R2),0             IF NEXT FIELD HAS NO INPUT                   
         LR    R2,R3               THEN ERROR BECAUSE IT IS                     
         JE    VRWRNKE1              NOT GOOD TO RANK ON LAST ROW               
*                                                                               
VRW06    DS    0H                                                               
*                                                                               
*                                                                               
         CLC   12(5,R4),=C'SPACE'  IF SPACE ENTRY                               
         JNE   VRWSPCX                                                          
*                                                                               
***********************************************************************         
*** RULES FOR INCH/LINE TOTALING                                                
*   CONT DRIVEN  -- CONT NAME AS ENTRY M/B MID OR ROW. INCH/LINE OPTION         
*                 IF MUST BE SELECTED.                                          
*    BUY DRIVEN.  -- INCH/LINE OPTION MUST BE SELECTED.                         
*                     PUB NAME AS ENTRY M/B MID OR ROW.                         
*  IN BOTH CASES SPACE MUST BE A ROW AND MUST FOLLOW CONT OR PUB ENTRY          
***********************************************************************         
*                                                                               
         CLI   DRARGSI,C'C'        SKIP IF CONTRACT DATA ONLY ASKED FOR         
         JE    VRWENTX               (NORMALLY A BUY RELATED ENTRY)             
*                                                                               
         CLI   PBQSPCTL,C'S'       SKIP IF CONTROL ENTRY ALREADY                
         JNE   VRWENTX               PROCESSED                                  
*                                                                               
         MVI   PBQSPCTL,C'C'       INDICATE CONTROL ENTRY FOUND                 
         J     VRWENTX                                                          
*                                                                               
VRWSPCX  DS    0H                                                               
*                                                                               
         CLC   12(6,R4),=C'CONT  ' IF CONTRACT DICTION ENTRY                    
         JE    *+10                                                             
         CLC   12(3,R4),=C'PUB'    OR PUBLICATION CODE ENTRY                    
         JE    *+10                                                             
         CLC   12(5,R4),=C'CONT- ' OR CONTRACT DICTION ENTRY                    
         JNE   VRWSCKX                                                          
*                                                                               
         CLI   PBQMED,C'N'         AND MEDIA IS NEWSPAPER                       
         JE    *+8                                                              
         CLI   PBQMED,C'C'           OR COMBINED                                
         JE    *+8                                                              
         CLI   PBQMED,C'*'                                                      
         JNE   VRWSCKX                                                          
*                                                                               
         CLI   PBQINLIN,0     AND INCH/LINE/BOTH OPTION SELECTED                
         JE    VRWSCKX                NO                                        
*                                                                               
         MVI   PBQSPCTL,C'S'  INDICATE SPACE ALLOWED ENTRY                      
         OI    DRTOTAL,X'80'       INDICATE TOTALS TO BE DONE                   
         MVC   DRTRTN,=C'SPACETOT' GIVE TOTAL ROUTINE ADDRESS                   
*                                                                               
         CLI   PBQINLIN,0     INCH/LINE/BOTH OPTION                             
         JNE   VRWSCKX                                                          
*                                                                               
         MVI   PBQINLIN,X'1C' INCH DEFAULT                                      
         J     VRWSCKX                                                          
*                                                                               
VRWSCKX  DS    0H                                                               
*                                                                               
*        HANDLE TEXT= KEYWORD                                                   
*                                                                               
VRWTEXT  DS    0H                                                               
*                                                                               
         CLC   =C'TEXT',12(R4)     SKIP IF NOT TEXT KEYWORD                     
         JNE   VRWTEXTX                                                         
*                                                                               
         CLI   1(R4),20            MAX 20 BYTES                                 
         JH    VRWTXT1E                                                         
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,1(R4)          GET TEXT LENGTH                              
         JZ    VRWTXT2E            MUST HAVE SOME TEXT                          
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         J     *+10                                                             
         MVC   DRLITO(0),22(R4)    SAVE TEXT AS LITERAL                         
*                                                                               
         MVC   DRLITLNO,1(R4)      PASS ON LITERAL LENGTH                       
         MVC   DRLENI,1(R4)        SET COLUMN WIDTH                             
         MVC   DRLENO,1(R4)        SET COLUMN WIDTH                             
*                                                                               
VRWTEXTX DS    0H                                                               
*                                                                               
*        CHECK IF KEYWORD BEING FILTERED ON VALUE                               
*                                                                               
         GOTOR FLTRVAL                                                          
         JNE   VRWFVALE            INVALID FILTER                               
*                                                                               
VRWFLTRX DS    0H                                                               
*                                                                               
VRWENTX  DS    0H                                                               
*                                                                               
         CLI   MYPOSO,C'H'         SPECIAL FOR HEADS                            
         JNE   VRW08                                                            
*                                                                               
         OI    DRFIRST,X'80'       GENERATE FIRST STATEMENT                     
         OI    DRFOPTS,DRFSKIP     WITH SKIP OPTION                             
         MVI   DRFSPACE,0          NO SPACING                                   
*                                                                               
         J     VRW10                                                            
*                                                                               
VRW08    DS    0H                                                               
*                                                                               
         CLI   MYPOSO,C'M'         SPECIAL FOR MID                              
         JNE   VRW09               SPACE CHECK                                  
*                                                                               
         OI    DRLAST,X'80'        GENERATE LAST STATEMENT                      
*                                                                               
*===================================================================*           
* CHECK TO SEE IF ROW REQUESTED IS SPACE AND MEDIA IS NEWSPAPER     *           
*   IF SO WILL HAVE TO CREATE AN ENTRY WHEN PROCESSING OFF-LINE TO  *           
*   ACCUMULATE LINES/INCHES AS LAST COLUMN ENTRY                    *           
*===================================================================*           
*                                                                               
VRW09    DS    0H                                                               
*                                                                               
         MVI   PBTAX,0                 INITALIZE HEADING SWITCH                 
*                                                                 L02           
         ZIC   RF,NUMOFROW         BUMP NUMBER OF ROWS IN REPORT  L02           
         LA    RF,1(RF)                                           L02           
         STC   RF,NUMOFROW                                        L02           
*                                                                 L02           
VRW10    DS    0H                                                               
*                                                                 L02           
         TM    PBBYOPTS,PBBYBHTQ   IF BUILDING INVOICE TABLE                    
         JNO   *+12                                                             
         CLI   PBQDATYP,C'1'          DATE TYPE MUST BE MNTH OF SERVICE         
         JNE   VRWMSER                                                          
*                                                                               
*        IF BRAND AGENCY AOR REQUEST                                            
*           THE KEYWORD MUST BE ALLOWED                                         
*           NEXT BYTE AFTER C'@' IN ATTRIBUTES MUST HAVE X'80' ON               
*                                                                               
         CLI   BRANDSW,C'Y'        SKIP IF NOT BRAND AGY AOR REQUEST            
         JNE   VRWBRDX                                                          
*                                                                               
         LA    R1,DRATTRIB         POINT TO ENTRY ATTRIBUTES                    
         LA    RF,L'DRATTRIB       MAX NUMBER OF ATTRIBUTES                     
*                                                                               
         CLI   0(R1),C'@'          @ INDICATES CONTROL BYTE NEXT                
         JE    *+16                                                             
         LA    R1,1(R1)            BUMP ATTRIBUTE POINTER                       
         BRCT  RF,*-12                                                          
         J     VRWBRDER            MUST FIND IT                                 
*                                                                               
         TM    1(R1),X'80'         X'80' MUST BE ON                             
         JNO   VRWBRDER                                                         
*                                                                               
VRWBRDX  DS    0H                                                               
*                                                                               
         EJECT                                                                  
*                                                                               
* CHECK FOR QUALIFYING ROW EXPRESSIONS                                          
*                                                                               
         CLI   DRARGSI,C'C'      CONTRACT RELATED ENTRY                         
         JNE   *+8                                                              
         OI    PBQSPLOP,PBQCONTR                                                
*                                                                               
         LA    R4,42(R4)           POINT TO NEXT SCANNED ENTRY                  
         MVI   PBTAX,0             USE AS HEADING OVERRIDE SWITCH               
         AI    FIELDERR,1          BUMP SCANNED FIELD COUNTER                   
         BRCT  R0,*+8              DECREMENT FIELD COUNTER                      
         J     VRWQUAD             NO QUALIFIERS                                
*                                                                               
VRWQUAL  DS    0H                                                               
*                                                                               
         CLI   0(R4),0             SKIP IF NO DATA SCANNED                      
         BE    VRWQUAC                                                          
*                                                                               
*        CHECK FOR '<' & '>' AS SEPARATORS                                      
*                                                                               
         GOTO1 =A(SEPSCAN),RR=RELOPGEN CHECK FOR < AND >                        
*                                                                               
         JNE   VRWNOTV             ERROR FOUND                                  
*                                                                               
         CLI   12(R4),C'?'         IF HELP REQUESTED                            
         JE    *+8                                                              
         CLI   13(R4),C'?'         IF HELP REQUESTED                            
         JE    *+8                                                              
         CLI   12(R4),C'+'         IF HELP REQUESTED                            
         JNE   VRWQHLPX                                                         
*                                                                               
         GOTO1 VPRHELP,DMCB,=AL2(PRQHMCFW),(R2),HELPCBLK SHOW HELP MENU         
*                                     FOR OPTIONS                               
         DC    H'0'                SHOULD NOT COME BACK                         
*                                                                               
VRWQHLPX DS    0H                                                               
*                                                                               
         MVC   FIELDERR,4(R4)      SAVE NUMERIC VALUE OF ENTRY                  
*                                                                               
VRWTOT   DS    0H                                                               
*                                                                               
         CLC   =C'ADD ',12(R4)     AVG DAYS TO DISBURSE                         
         JE    VRWTOT1                                                          
*                                                                               
         CLC   12(2,R4),=C'* '     TOTAL EXPRESSION                             
         JE    VRWTOT1                                                          
         CLC   12(2,R4),=C'\ '     TOTAL EXPRESSION                             
         JE    VRWTOT1                                                          
*                                                                               
         CLC   12(2,R4),=C'@ '     TOTAL WITH TEST BREAKS           L10         
         JNE   VRWTOTN                                              L10         
*                                                                               
         CLI   PBQTEST,C'Y'        MUST HAVE TEST REQUESTS          L10         
         JNE   VRWNOTV                                              L10         
*                                                                               
         MVI   12(R4),C'*'         FORCE BACK TO NORMAL TOTAL       L10         
*                                                                               
         LA    RE,12               MAX NUMBER OF LEVELS             L10         
         LA    RF,LEVELCON         POINT TO LEVEL SAVEAREA        L10           
*                                                                               
         CLI   0(RF),0             LOOK FOR OPEN LEVEL SPOT       L10           
         JE    *+16                                               L10           
         LA    RF,1(RF)                                           L10           
         BRCT  RE,*-12                                            L10           
         J     VRWNOTV             TOO MANY TOTAL LEVELS          L10           
*                                                                 L10           
         MVC   0(1,RF),LEVEL       SAVE LEVEL                     L10           
*                                                                               
VRWTOT1  DS    0H                                                               
*                                                                               
         CLI   PBUNITS+1,C'R'                                                   
         JE    VRWNOTV             NO TOTALS AFTER RANK EXPRESSION              
*                                                                               
         OI    DRTOTAL,X'80'       FLAG ENTRY FOR TOTALS                        
*                                                                               
         LR    RE,R2               SAVE CURRENT SCREEN POINTER                  
*                                                                               
         ZIC   RF,0(RE)            POINT TO NEXT SCREEN FIELD                   
         AR    RE,RF               HAVE A LOOK AT THE NEXT LEVEL                
*                                                                               
VRWLVLL  DS    0H                                                               
*                                                                               
         CLI   0(RE),0             DONE IF AT END OF SCREEN                     
         JE    VRWLVLD                                                          
*                                                                               
         TM    1(RE),X'20'         SKIP IF A PROTECTED FIELD                    
         JO    VRWLVLC                                                          
*                                                                               
         SR    RF,RF               WITH SOME DATA                               
         ICM   RF,1,5(RE)                                                       
         JZ    VRWLVLC                NO DATA                                   
*                                                                               
         LA    RE,8(RE)            POINT TO DATA                                
*                                                                               
         CLI   0(RE),C'*'          SEARCH FIELD FOR TOTAL INDICATOR             
         JE    VRWLVLD               FOUND CONTINUE PROCESSING                  
         LA    RE,1(RE)            BUMP DATA POINTER                            
         BRCT  RF,*-12                                                          
*                                    NO TOTAL INDICATOR FOUND                   
         MVI   DRLSPACE,1          SPACE AFTER CURRENT ENTRY TOTALS             
         J     VRWLVLD                                                          
*                                                                               
VRWLVLC  DS    0H                                                               
*                                                                               
         ZIC   RF,0(RE)            POINT TO NEXT SCREEN FIELD                   
         AR    RE,RF               HAVE A LOOK AT THE NEXT LEVEL                
         J     VRWLVLL                                                          
*                                                                               
VRWLVLD  DS    0H                                                               
*                                                                               
VRWTOTX  DS    0H                                                               
*                                                                               
         CLC   =C'ADD ',12(R4)     AVG DAYS TO DISBURSE                         
         JE    VROWFLT             NEED TO STORE AS FILTER ALSO                 
*                                                                               
         J     VRWQUAC             GO EXAMINE NEXT QUALIFIER                    
*                                                                               
VRWTOTN  DS    0H                                                               
*                                                                               
         CLC   12(5,R4),=C'SKIP '  SKIP TO CHANNEL 1 AFTER BREAK                
         JNE   VRWSKN                                                           
*                                                                               
         OI    DRFIRST,X'80'       GENERATE FIRST STATEMENT                     
         OI    DRFOPTS,DRFSKIP     WITH SKIP OPTION                             
         J     VRWQUAC                                                          
*                                                                               
VRWSKN   DS    0H                                                               
*                                                                               
         CLC   12(2,R4),=C'U '     USER RECORD                                  
         JNE   VRWUSRN                                                          
*                                                                               
         MVI   DRACTION,DRUSER                                                  
         MVC   DRUSRKEY(2),PBQAGY               KEY IS AGENCY                   
         MVC   DRUSRKEY+2(8),22(R4)              AND USER CODE                  
*                                                                               
         GOTO1 DRONE,DMCB,DRGEN                                                 
         CLI   DRERROR,0                                                        
         JNE   VRWUSRE1                                                         
*                                                                               
         TM    DROPTSO,DRBKMINO    IF BRACKET=M SPECIFIED                       
         JNO   VRWUSRX                                                          
*                                                                               
         NI    DROPTSO,X'DF'          DON'T NEED MINUS=YES                      
*                                                                               
         CLI   DRFLOATO,C'-'                                                    
         JNE   *+8                                                              
         MVI   DRFLOATO,0             OR FLOAT=-                                
*                                                                               
VRWUSRX  DS    0H                                                               
*                                                                               
         J     VRWQUAC                                                          
*                                                                               
VRWUSRN  DS    0H                                                               
*                                                                               
         CLI   MYPOSO,C'H'         HEADLINE                                     
         JE    *+8                                                              
         CLI   MYPOSO,C'M'         & MIDLINE HAVE NO LENGTH OVERRIDE            
         JE    VRWLENN                                                          
*                                                                               
         TM    2(R4),X'80'         LENGTH MUST BE NUMERIC INPUT                 
         JNO   VRWLENN                                                          
*                                                                               
         ICM   R1,7,5(R4)          RESET ENTRY OUTPUT LENGTH                    
         STC   R1,DRLENO                                                        
*                                                                               
         CLC   =C'IBUYDSCR',DRRTNI  IF SPACE ENTRY                              
         JNE   VRWLEN1                                                          
*                                                                               
         SLL   R1,1                   DRLENI=2*DRLENO+1                         
         LA    R1,1(R1)                                                         
         STC   R1,DRLENI                                                        
*                                                                               
VRWLEN1  DS    0H                                                               
*                                                                               
         CLC   =C'ODATA',DRRTNO   IF ODATA ROUTINE                              
         JNE   VRWLEN2                                                          
*                                                                               
         CLC   DRLENI,DRLENO         DRLENI MUST BE >= DRLENO                   
         JNL   *+10                                                             
         MVC   DRLENI,DRLENO                                                    
*                                                                               
VRWLEN2  DS    0H                                                               
*                                                                               
         J     VRWQUAC                                                          
*                                                                               
VRWLENN  DS    0H                                                               
*                                                                               
         EJECT                                                                  
*                                                                               
         CLC   DRATTRIB(2),=C'DT'   IF PROCESSING A DATE FLD                    
         JNE   VRWDTEN                                                          
*                                                                               
         CLC   =C'WK',12(R4)        SKIP IF PRINTING WEEK OF/BFD IND            
         JE    VRWDTEN                                                          
*                                                                               
*  MUST SAVE ATTRIBUTE +2 - CONTAINS THE TYPE OF DATE FIELD                     
*                                                                               
         MVI   WORK,PBQPTDYQ                                                    
         CLI   12(R4),C'Y'         YEARLY    TOTALS                             
         JE    VRWDTE1                                                          
*                                                                               
         MVI   WORK,PBQPTDQQ                                                    
         CLI   12(R4),C'Q'         QUARTERLY TOTALS                             
         JE    VRWDTE1                                                          
*                                                                               
         MVI   WORK,PBQPTDMQ                                                    
         CLI   12(R4),C'M'         MONTHLY TOTALS                               
         JE    VRWDTE1                                                          
*                                                                               
         MVI   WORK,PBQPTDWQ                                                    
         CLI   12(R4),C'W'         WEEKLY TOTALS                                
         JE    VRWDTE1                                                          
*                                                                               
         MVI   WORK,0              DAILY                                        
         CLI   12(R4),C'D'                                                      
         JNE   VRWDTEN                                                          
*                                                                               
         CLI   13(R4),C'M'                                                      
         JL    VRWNOTV                                                          
*                                                                               
VRWDTE1  DS    0H                                                               
*                                                                               
         CLI   13(R4),C'Y'                                                      
         JH    VRWNOTV                                                          
*                                                                               
         TM    PBQPTLVL,PBQPTL2Q   IF NO DATE TYPES YET                         
         JO    VRWNSTE1                                                         
*                                                                               
         MVC   PBQPTSW,WORK           USE LATEST ONE                            
*                                                                               
***      =================  ***                                                 
         L     RF,PDADATES                                                      
         USING DATELSTD,RF                                                      
***      =================  ***                                                 
*                                                                               
         CLI   EXPLIST,0                                                        
         JNE   VRWNSTE1                                                         
*                                                                               
         GOTOR PEREXP,DMCB                                                      
*                                                                               
***      =================  ***                                                 
         L     RF,PDADATES                                                      
         USING DATELSTD,RF                                                      
***      =================  ***                                                 
*                                                                               
         CLI   EXPLIST,255                                                      
         JE    VRWNOTV                                                          
*                                                                               
         DROP  RF                                                               
*                                                                               
         MVI   DRNARGSI,16         FORCE 16 ARGUMENTS ON INPUT                  
         MVI   DRNARGSO,16         AND OUTPUT                                   
         MVC   DRARGSI+15(1),12(R4)     LINK FOR SYSDRIVER FOR THIS             
         MVC   DRARGSO+15(1),12(R4)      ENTRY                                  
*                                                                               
         J     VRWQUAC                                                          
*                                                                               
VRWDTEN  DS    0H                                                               
*                                                                               
         CLC   12(6,R4),=C'SPACE ' SPACE OPTION                                 
         JNE   VRWSPAN                                                          
*                                                                               
         OI    DRLAST,X'80'        GENERATE LAST STATEMENT                      
         MVI   DRLSPACE,1          WITH AT LEAST ONE SPACE                      
*                                                                               
         CLI   1(R4),0             CHECK SECOND PARAMETER                       
         JE    VRWSPAX                                                          
*                                                                               
         MVC   DRLSPACE,11(R4)     NUMBER OF LINES TO SPACE                     
*                                                                               
         CLI   DRLSPACE,0          S/B 1-3 LINES                                
         JE    VRWNOTV                                                          
*                                                                               
         CLI   DRLSPACE,3                                                       
         JH    VRWNOTV                                                          
*                                                                               
VRWSPAX  DS    0H                                                               
*                                                                               
         J     VRWQUAC                                                          
*                                                                               
VRWSPAN  DS    0H                                                               
*                                                                               
         CLC   12(4,R4),=C'DET '   DET=N OR D=N                                 
         JE    *+10                                                             
         CLC   12(2,R4),=C'D '                                                  
         JNE   VRWDTLN                                                          
*                                                                               
         OI    DRTOTAL,X'80'       FORCE TOTAL                                  
         MVC   DRTDET(1),11(R4)    NUMBER OF DETAILS                            
*                                                                               
         CLI   DRTDET,0            MUST HAVE A NUMBER                           
         JE    VRWNOTV                                                          
*                                                                               
         J     VRWQUAC                                                          
*                                                                               
VRWDTLN  DS    0H                                                               
*                                                                               
         CLC   12(4,R4),=C'DET '   DET=N OR D=N                                 
         JE    *+10                                                             
         CLC   12(5,R4),=C'HORIZ'                                               
         JNE   VRWHRZN                                                          
*                                                                               
         OI    DRLAST,X'80'        FORCE LAST PROCESSING                        
         OI    DRLOPTS,DRLHORIZ    FORCE HORIZ LINE WHEN ROW BREAKS             
*                                                                               
         J     VRWQUAC                                                          
*                                                                               
VRWHRZN  DS    0H                                                               
*                                                                               
         CLC   12(3,R4),=C'NP '    OPTION NOT TO PRINT                          
         JNE   VRWNPN                                                           
*                                                                               
         NI    DRFLAGO,X'FF'-X'80' TURN OFF PRINT IND ON ALL HEADLINES          
         NI    DRHEAD1,X'FF'-X'80'                                              
         NI    DRHEAD2,X'FF'-X'80'                                              
         NI    DRHEAD3,X'FF'-X'80'                                              
         NI    DRHEAD4,X'FF'-X'80'                                              
*                                                                               
         J     VRWQUAC                                                          
*                                                                               
VRWNPN   DS    0H                                                               
*                                                                               
VRWDTLX  DS    0H                                                               
*                                                                               
*        CHECK FOR HEADING OVERRIDES                                            
*                                                                               
         LA    R1,DRHEAD1          POINT TO FIRST HEADLINE                      
         CLC   12(2,R4),=C'H '                                                  
         JNE   *+12                                                             
         OI    PBTAX,1             HEADING ONE OVERRIDE                         
         J     VRWHDG1                                                          
*                                                                               
         CLC   12(3,R4),=C'H1 '                                                 
         JNE   *+12                                                             
         OI    PBTAX,1             HEADING ONE OVERRIDE                         
         J     VRWHDG1                                                          
*                                                                               
         LA    R1,DRHEAD2                                                       
         CLC   12(3,R4),=C'H2 '                                                 
         JNE   *+12                                                             
         OI    PBTAX,2             HEADING TWO OVERRIDE                         
         J     VRWHDG1                                                          
*                                                                               
         LA    R1,DRHEAD3                                                       
         CLC   12(3,R4),=C'H3 '                                                 
         JNE   *+12                                                             
         OI    PBTAX,4             HEADING 3 OVERRIDE                           
         J     VRWHDG1                                                          
*                                                                               
         LA    R1,DRHEAD4                                                       
         CLC   12(3,R4),=C'H4 '                                                 
         JNE   *+12                                                             
         OI    PBTAX,8             HEADING 4 OVERRIDE                           
         J     VRWHDG1                                                          
*                                                                               
         LA    R1,DRTOTAL                                                       
         CLC   12(3,R4),=C'HT '                                                 
         JNE   VRWHDGN                                                          
         OI    PBTAX,X'10'         TOTAL HEADING OVERRIDE                       
*                                                                               
***      =================  ***                                                 
         USING DRHEADD,R1                                                       
***      =================  ***                                                 
*                                                                               
VRWHDG1  DS    0H                                                               
*                                                                               
         XC    0(26,R1),0(R1)      TURN OFF ROUTINE & ARGS                      
*                                                                               
         CLI   1(R4),2             CHECK FOR NO NEW HEADING                     
         JL    VRWQUAC             HN=X CAUSES REMOVAL                          
*                                                                               
         OI    DRHEAD,X'80'        OTHERWISE TURN IT BACK ON                    
         MVC   DRHLITL,1(R4)       PASS LITERAL LENGTH TO DRONE                 
*                                                                               
         CLC   DRHLITL,DRLENO                                                   
         JH    VRWHDGE1            LITERAL WIDER THAN COLUMN                    
*                                                                               
         ZIC   RE,DRHLITL          GET LENGTH OF HEADING                        
         BCTR  RE,0                DECREMENT FOR EXECUTE                        
         EX    RE,*+8              MOVE IN THE HEADER LITERAL                   
         J     *+10                                                             
         MVC   DRHLIT(0),22(R4)    ** EXECUTED                                  
*                                                                               
         J     VRWQUAC                                                          
         DROP  R1                                                               
*                                                                               
VRWHDGN  DS    0H                                                               
*                                                                               
*        ANALYZE FOR FLOWCHARTING                                               
*                                                                               
         CLC   =C'WK',12(R4)       SKIP IF WKBFD FORMAT OPTION                  
         JE    VRWFLWN                                                          
*                                                                               
         CLI   12(R4),C'Y'         YEARLY    TOTAL                              
         JE    *+8                                                              
         CLI   12(R4),C'Q'         QUARTERLY TOTAL                              
         JE    *+8                                                              
         CLI   12(R4),C'M'         MONTHLY TOTALS                               
         JE    *+8                                                              
         CLI   12(R4),C'W'         WEEKLY TOTALS                                
         JNE   VRWFLWN                                                          
*                                                                               
         CLI   13(R4),C'1'                                                      
         JL    VRWFLWE1                                                         
*                                                                               
         MVC   PBQ$DTYP,12(R4)       MOVE $ DATE TYPE                           
*                                                                               
         L     RF,PDADATES                                                      
         LA    RE,0                                                             
         MVI   FCHRTITR,0            INITIALIZE                                 
*                                                                               
         USING DATELSTD,RF                                                      
*                                                                               
         CLI   EXPLIST,0       HAVE DATE TABLES BEEN CONSTRUCTED                
         JE    *+8                                                              
         LA    RE,4                                                             
*                                                                               
         GOTO1 =A(PEREXP),DMCB,(RE),RR=RELOPGEN                                 
*                                                                               
         L     RF,PDADATES                                                      
         USING DATELSTD,RF                                                      
*                                                                               
         CLI   EXPLIST,255                                                      
         JNE   VRWFLWX                                                          
*                                                                               
         GOTO1 CURSERR                                                          
         DROP  RF                                                               
*                                                                               
VRWFLWX  DS    0H                                                               
*                                                                               
         GOTOR RNGCHK              MAKE SURE REQUEST DATES COVER RANGE          
*                                                                               
         J     VRWQUAC                                                          
*                                                                               
VRWFLWN  DS    0H                                                               
*                                                                     *         
*        CHECK FOR COLUMN FILTERS VIA DDVAL                           *         
*                                                                     *         
VROWFLT  DS    0H                                                               
*                                                                               
         GOTOR CFLTVAL             VALIDATE COLUMN FILTERS                      
*                                                                               
         OC    CFLTQTIC,CFLTQTIC   CHECK IF VALID FILTER FOUND                  
         JZ    VRWNOTV             UNKNOWN QUALIFIER                            
*                                                                               
         L     R5,AVLTAB           POINT TO RETURNED TABLE                      
         USING VLTABD,R5           ESTABLISH TABLE ENTRY                        
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,3,VLTICODE       GET INTERNAL CODE                            
*                                                                               
         LA    RE,PRQCFACH         QUALIFIER TYPE                               
         CLM   RE,3,CFLTQTIC       CHECK FOR ANY ACHG OPTIONS                   
         JNE   *+8                                                              
         OI    PBQACHGS,PBQACOPQ      INDICATE ADDL CHG OPT IN EFFECT           
*                                                                               
*        CONTINUATION OF ROW QUALIFIERS                                         
*                                                                               
VRWQUAC  DS   0H                                                                
*                                                                               
         LA    R4,42(R4)           BUMP TO NEXT SCANNED FIELD                   
         MVI   PBTAX,0             USE AS HEADING OVERRIDE SWITCH               
         AI    FIELDERR,1          BUMP SCANNED FIELD COUNTER                   
*                                                                               
         BRCT  R0,VRWQUAL                                                       
*                                                                               
VRWQUAD  DS   0H                                                                
*                                                                               
         TM    ROWCOLSW,ROWCOLXQ   IF THERE IS A CONTINUATION                   
         JNO   VALROWXD                                                         
*                                                                               
         L     R2,ALASTCOL         RE-POINT TO SCREEN FIELD                     
*                                                                               
         SR    RF,RF                                                            
         IC    RF,5(R2)            RESTORE LAST FIELD LENGTH                    
         LA    R1,8(RF,R2)                                                      
         MVI   0(R1),C','          REPLACE COMMA                                
         LA    RF,1(RF)                                                         
         STC   RF,5(R2)                                                         
*                                                                               
         OI    ROWCOLSW,ROWCOL2Q   INDICATE ON SECOND FIELD                     
*                                                                               
         SR    R3,R3                                                            
         IC    R3,FLDNMBR                                                       
         BRCT  R3,*+8              DECREMENT FIELD COUNTER                      
         J     VRWNOTV             NO MORE AVAILABLE                            
*                                                                               
         ZIC   RF,0(R2)            GET TO NEXT SCREEN FIELD                     
         AR    R2,RF                                                            
         ST    R2,ALASTCOL         UPDATE CURRENT FIELD POINTER                 
*                                                                               
         J     VALROWXL            PROCESS CONTINUATION                         
*                                                                               
VALROWXD DS    0H                                                               
*                                                                               
*        SAVE FIRST TWO STACK HEADLINES                                         
*                                                                               
         CLC   DRRTNI,=CL8'ISTACK' IF DEALING WITH STACK KEYWORD                
         JNE   VRWSTHX                                                          
         CLI   DRARGSI+1,C'M'      SKIP IF MERGING                              
         JE    VRWSTHX                                                          
*                                                                               
*        SAVE HEADLINES IN WORKAREA FOR LATER                                   
*                                                                               
         LA    R0,2                ONLY INTERESTED IN 1ST TWO HEADLINES         
         LA    R1,STACKH1L         HEAD 1 SAVEAREA                              
         LA    R2,DRHEAD1          POINT TO FIRST HEADLINE                      
*                                                                               
VRWSTHLP DS    0H                                                               
*                                                                               
         USING DRHEADD,R2                                                       
*                                                                               
         TM    DRHEAD,X'80'        IF THERE IS NO HEADING                       
         JO    *+12                                                             
         MVI   0(R1),X'FF'            SET INDICATOR                             
         J     VRWSTHCN                                                         
*                                                                               
         XI    DRHEAD,X'80'        DON'T PRINT HEADLINE                         
*                                                                               
         MVC   0(1,R1),DRHLITL     SAVE LITERAL LENGTH                          
*                                                                               
         SR    RE,RE                                                            
         ICM   RE,1,0(R1)          GET LENGTH OF HEADING                        
         JZ    *+10                NO LENGTH                                    
         BCTR  RE,0                DECREMENT FOR EXECUTE                        
         EX    RE,*+8              MOVE IN THE HEADER LITERAL                   
         J     *+10                                                             
         MVC   1(0,R1),DRHLIT      SAVE HEADLINE                                
*                                                                               
VRWSTHCN DS    0H                                                               
*                                                                               
         LA    R2,L'DRH1ALL(R2)    POINT TO NEXT HEADLINE                       
         LA    R1,STACKH2L         POINT TO SECOND SAVEAREA                     
         BRCT  R0,VRWSTHLP                                                      
*                                                                               
         DROP  R2                                                               
*                                                                               
VRWSTHX  DS    0H                                                               
*                                                                               
         OC    TOTWIDTH,TOTWIDTH   SKIP IF WE AREN'T CHECKING WIDTH             
         JZ    VRWWIDX                                                          
*                                                                               
         CLC   =C'ISTACK',DRRTNI   IF STACK ROW                                 
         JNE   VRWWID1                                                          
         CLI   DRARGSI+1,C'M'      SKIP IF MERGING                              
         JE    VRWWID1                                                          
*                                                                               
         MVC   STACKWID,DRLENO     SAVE WIDTH OF STACK COLUMN                   
*                                                                               
         NI    DRFLAGO,X'FF'-X'80' NO PRINT                                     
         NI    DRHEAD1,X'FF'-X'80'                                              
         NI    DRHEAD2,X'FF'-X'80'                                              
         NI    DRHEAD3,X'FF'-X'80'                                              
         NI    DRHEAD4,X'FF'-X'80'                                              
*                                                                               
         J     VRWWID2             COUNT WIDTH BECAUSE OF TITLE COL             
*                                                                               
VRWWID1  DS    0H                                                               
*                                                                               
         TM    DRFLAGO,X'80'       SKIP IF NOT BEING PRINTED                    
         JZ    VRWWIDX                                                          
*                                                                               
VRWWID2  DS    0H                                                               
*                                                                               
         LH    R1,TOTWIDTH         ADJUST CURRENT WIDTH                         
         ZIC   RF,DRLENO           ENTRY OUTPUT LENGTH                          
         LA    R1,1(RF,R1)         ADD 1 MORE FOR BOX COLUMN                    
         STH   R1,TOTWIDTH                                                      
*                                                                               
         CLC   =C'ISTACK',DRRTNI   IF STACK ROW                                 
         JE    *+8                                                              
         STC   R1,TOTROWID            WIDTH IS FOR TITLES COLUMN                
*                                                                               
VRWWIDX  DS   0H                                                                
*                                                                               
         CLI   OFFLINE,C'Y'        SKIP IF NOT OFF-LINE                         
         JNE   VALROWX                                                          
*                                                                               
         TM    DRFLAGO,X'80'       SKIP IF NOT PRINTING ROW                     
         JNO   VRWINXX                                                          
*                                                                               
*        BUILD PQINDEX TABLE ENTRY                                              
*                                                                               
         ICM   RF,15,APQINDEX      POINT TO PQ INDEX TABLE                      
         JZ    VRWINXX             SKIP IF NO TABLE AVAILABLE                   
*                                                                               
         USING PQINDEX,RF          ESTABLISH TABLE ENTRY                        
*                                                                               
*        FIND NEXT AVAILABLE ENTRY IN TABLE                                     
*                                                                               
         LA    R0,MAXHEADS+MAXMIDS+MAXROWS+MAXCOLS   MAX ENTRIES                
*                                                                               
         OC    PQKEYWRD,PQKEYWRD   FIND FIRST NULL ENTRY                        
         JZ    *+16                                                             
         LA    RF,PQINDXEQ(RF)     BUMP TO NEXT ENTRY                           
         BRCT  R0,*-14                                                          
         J     VRWINXX             SKIP                                         
*                                                                               
         MVC   PQKEYWRD,BLOCK+12   SAVE KEYWORD                                 
         MVC   PQOUTLEN,DRLENO     SAVE OUTPUT LENGTH                           
         MVC   PQPOSO,MYPOSO       SAVE KEYWORD TYPE                            
         MVC   PQHEAD1,DRH1LIT     SAVE FIRST  COLUMN HEADLINE                  
         CLI   PQPOSO,C' '         IF NO POSITION CHARCTER                      
         BH    *+8                                                              
         MVI   PQPOSO,C'R'            ASSUME A ROW                              
*                                                                               
         CLI   MYPOSO,C'H'         SINGLE HEADER FOR HEADS AND MIDS             
         JE    VRWINXHX                                                         
         CLI   MYPOSO,C'M'         SINGLE HEADER FOR HEADS AND MIDS             
         JE    VRWINXHX                                                         
*                                                                               
         MVC   PQHEAD2,DRH2LIT     SAVE SECOND COLUMN HEADLINE                  
         MVC   PQHEAD3,DRH3LIT     SAVE THIRD  COLUMN HEADLINE                  
         MVC   PQHEAD4,DRH4LIT     SAVE FOURTH COLUMN HEADLINE                  
*                                                                               
VRWINXHX DS    0H                                                               
*                                                                               
         DROP  RF                                                               
*                                                                               
VRWINXX  DS    0H                                                               
*                                                                               
         MVC   DRPOSO,MYPOSO       SET PRINT POSITION                           
*                                                                               
         CLI   DRARGSI+15,0          ENSURE THIS ENTRY HAS DATE QUALIF-         
         JE    VRWGEND               IER                                        
*                                                                               
         CLC   DRATTRIB(2),=C'DT'      PROCESSING A DATE FLD                    
         JNE   VRWGEND                 BYPASS IF NOT                            
*                                                                               
         CLI   PBQPTSW,0                 NORMAL - NO TOTALS REQUESTED           
         JE    VRWGEND                                                          
*                                                                               
         TM    PBQPTLVL,PBQPTL2Q    MUST WE CREATE A PERIOD ROW                 
         JZ    VRWGEND               NO                                         
*                                                                               
*        SAVE DRONE BLOCK AND CREATE A PERIOD ROW BEFORE THIS DATE              
*                                                                               
         BRAS  RE,VRWHCHG                                                       
*                                                                               
         LA    R0,DRINFEND-1                                                    
         LA    R2,DRLENIN                                                       
         SR    R0,R2               CALCULATE LENGTH                             
         LR    R4,R0               SAVE LENGTH                                  
         L     R1,AIO1                                                          
*                                                                               
         BRAS  RE,VRWMREC                                                       
*                                                                               
         MVC   DRRTNO,=CL8'OPERIOD'   FORCE TO GO TO THIS ROUTINE               
         OI    DRTOTAL,X'80'       FORCE TOTALS                                 
         MVC   DRTRTN,=C'PERTOTAL' TOTAL ROUTINE NAME                           
         MVI   DRNARGSI,16         16 INPUT ARGUMENTS                           
*                                                                               
         TM    PBQPTSW,PBQPTTQQ        DEFINE DATE TYPE FOR ADJACENT            
         MVI   DRARGSO+15,C'Q'         FIELD                                    
         JO    VRWGENA                                                          
*                                                                               
         TM    PBQPTSW,PBQPTTMQ                                                 
         MVI   DRARGSO+15,C'M'                                                  
         JO    VRWGENA                                                          
*                                                                               
         TM    PBQPTSW,PBQPTTWQ                                                 
         MVI   DRARGSO+15,C'W'                                                  
         JO    VRWGENA                                                          
*                                                                               
         TM    PBQPTSW,PBQPTTYQ                                                 
         MVI   DRARGSO+15,C'Y'                                                  
         JO    VRWGENA                                                          
*                                                                               
         MVI   DRARGSO+15,0                                                     
*                                     DATE TYPE OF ADJACENT FIELD               
VRWGENA  DS    0H                                                               
*                                                                               
         MVI   DRNARGSO,16                                                      
*                                                                               
         TM    PBQPTSW,PBQPTDQQ                                                 
         MVI   DRARGSO+13,C'Q'                                                  
         JO    VRWGENB                                                          
*                                                                               
         TM    PBQPTSW,PBQPTDMQ                                                 
         MVI   DRARGSO+13,C'M'                                                  
         JO    VRWGENB                                                          
*                                                                               
         TM    PBQPTSW,PBQPTDWQ                                                 
         MVI   DRARGSO+13,C'W'                                                  
         JO    VRWGENB                                                          
*                                                                               
         TM    PBQPTSW,PBQPTDYQ                                                 
         MVI   DRARGSO+13,C'Y'                                                  
         JO    VRWGENB                                                          
*                                                                               
         MVI   DRARGSO+13,0       MUST BE DAILY DATES                           
*                                                                               
VRWGENB  DS    0H                                                               
*                                                                               
         MVC   DRARGSI+13(3),DRARGSO+13                                         
         MVC   DRARGSO+14(1),DRLENI       LENGTH OF DATE FOR SYSDRIVE           
         MVC   DRTARGS+13(3),DRARGSO+13                                         
         MVC   DRTARGS(1),DRARGSO         INSERT DATE ID                        
         MVI   DRTNARGS,16                                                      
*                                                                               
         CLI   DRLENO,9            QUARTER DATE TAKES 10 POSITIONS              
         JH    VRWGENC                                                          
         TM    PBQPTSW,PBQPTDQQ+PBQPTTQQ  QUARTER DATE RANGE RQSTD              
         JZ    *+8                                                              
         MVI   DRLENO,10          LENGTH NEEDED TO PRINT QUARTER                
*                                                                               
VRWGENC  DS    0H                                                               
*                                                                               
         GOTO1 GROWDRON                 GENERATE ROW                            
         CLI   DRERROR,0                                                        
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
*  RESTORE DRONE BLOCK AND CREATE THE DATE AS A NON-PRINTING ROW                
*                                                                               
         LA    R0,DRINFEND-1                                                    
         LA    R1,DRLENIN                                                       
         SR    R0,R1   CALCULATE LENGTH                                         
         L     R2,AIO1                                                          
*                                                                               
         BRAS  RE,VRWMREC                                                       
*                                                                               
         NI    DRFLAGO,X'FF'-X'80' NO PRINT                                     
         NI    DRHEAD1,X'FF'-X'80'                                              
         NI    DRHEAD2,X'FF'-X'80'                                              
         NI    DRHEAD3,X'FF'-X'80'                                              
         NI    DRHEAD4,X'FF'-X'80'                                              
*                                                                               
         TM    PBQPTSW,PBQPTDQQ                                                 
         MVI   DRARGSI+15,C'Q'                                                  
         JO    VRWGEND                                                          
*                                                                               
         TM    PBQPTSW,PBQPTDMQ                                                 
         MVI   DRARGSI+15,C'M'                                                  
         JO    VRWGEND                                                          
*                                                                               
         TM    PBQPTSW,PBQPTDWQ                                                 
         MVI   DRARGSI+15,C'W'                                                  
         JO    VRWGEND                                                          
*                                                                               
         TM    PBQPTSW,PBQPTDYQ                                                 
         MVI   DRARGSI+15,C'Y'                                                  
         JO    VRWGEND                                                          
*                                                                               
         MVI   DRARGSI+15,C'R'          ASSUME REGULAR DATES                    
*                                                                               
VRWGEND  DS    0H                                                               
*                                                                               
         CLI   DRARGSI+15,0          ENSURE THIS ENTRY HAS DATE QUALIF-         
         JE    VRWGENE               IER                                        
*                                                                               
         CLC   DRATTRIB(2),=C'DT'      PROCESSING A DATE FLD                    
         JNE   VRWGENE                 BYPASS IF NOT                            
*                                                                               
         CLI   PBQPTSW,0                 NORMAL                                 
         JE    VRWGENE                                                          
*                                                                               
         BRAS  RE,VRWHCHG                                                       
*                                                                               
         CLI   DRLENO,9            QUARTER DATE TAKES 10 POSITIONS              
         JH    VRWGENE                                                          
         TM    PBQPTSW,PBQPTDQQ+PBQPTTQQ QUARTER DATE RANGE RQSTD               
         JZ    *+8                                                              
         MVI   DRLENO,10          LENGTH NEEDED TO PRINT QUARTER                
*                                                                               
VRWGENE  DS    0H                                                L03            
*                                                                               
         TM    DRTOTAL,X'80'       WAS TOTAL REQUESTED?           L03           
         JNO   VRWGENF                                            L03           
*                                                                               
         CLI   DRTLITLN,0          SKIP IF TOTAL HEADING GIVEN                  
         JNE   VRWGENF                                                          
*                                                                               
         CLI   DRRTNO,X'41'        IF OUT ROUTINE SPECIFIED       L03           
         JL    VRWGENF                                            L03           
*                                                                               
         MVC   DRTRTN,DRRTNO       USE THIS FOR TOTAL AS WELL     L03           
         MVC   DRTARGS,DRARGSO     AND PASS THROUGH THE ARGUMENTS L03           
         MVI   DRTNARGS,16                                        L03           
         MVI   DRTLITLN,0                                         L03           
*                                                                               
VRWGENF  DS    0H                                                L03            
*                                                                               
         GOTO1 GROWDRON            GENERATE ROW                                 
         CLI   DRERROR,0                                                        
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLC   BLOCK+12(4),=C'RANK' IF RANKING                                  
         JNE   VRWGENG                                                          
*                                                                               
         GOTO1 GCMPDRON              ALSO GENERATE COMPUTE EXPRESSION           
*                                                                               
VRWGENG  DS    0H                                                L03            
*                                                                               
         J     VALROWX                                                          
*                                                                               
VALROWX  DS    0H                                                               
*                                                                               
         SR    R3,R3                                                            
         IC    R3,FLDNMBR          RESTORE FIELD NUMBER                         
         L     R2,ALASTCOL         RESTORE CURRENT FIELD POINTER                
*                                                                               
         NI    ROWCOLSW,X'FF'-ROWCOL2Q   TURN OFF INDICATOR                     
*                                                                               
         USING FLDHDRD,R2          ESTABLISH SCREEN HEADER                      
*                                                                               
         OI    FLDIIND,FINPVAL     INDICATE FIELD IS VALID                      
*                                                                               
         CR    RB,RB               EQUAL CC                                     
         XIT1  REGS=(R2,R3)                                                     
*                                                                               
         DROP  R2                                                               
*                                                                               
         LTORG                                                                  
*                                                                               
         EJECT                                                                  
*                                                                               
*        ERROR ROUTINES                                                         
*                                                                               
VRWFVALE DS    0H                  INVALID FILTER VALUE FOR KEYWORD             
         MVI   ERROR,PWEFLTNV                                                   
         J     VRWERR                                                           
*                                                                               
VRWGP1E  DS    0H                  1 BYTE GROUP SCHEME REQUIRED                 
         MVI   ERROR,PWEGPREQ                                                   
         J     VRWERR                                                           
*                                                                               
VRWGP2E  DS    0H                  GROUP SCHEME MUST BE ALPHABETIC              
         MVI   ERROR,PWEGPAPH                                                   
         J     VRWERR                                                           
*                                                                               
VRWMSER  DS    0H                  REQUIRES MONTH OF SERVICE DATE TYPE          
         MVI   ERROR,PWEMSERR                                                   
         J     VRWERR                                                           
*                                                                               
VRWNOTV  DS    0H                  GENERAL ERROR                                
*                                                                               
         CLI   MYPOSO,C'H'         SPECIAL MESSAGE IF HEADLINE                  
         JNE   VRWNOTV1                                                         
*                                                                               
         MVI   ERROR,PWEHDC                                                     
         J     VRWERR                                                           
*                                                                               
VRWNOTV1 DS    0H                                                               
*                                                                               
         MVI   ERROR,PWEERRC                                                    
         J     VRWERR                                                           
*                                                                               
VRWBRDER MVI   ERROR,PWEBRDER      ILLEGAL KEYWORD FOR BRAND AOR REPORT         
         J     VRWERR                                                           
*                                                                               
VRWGRPNF MVI   ERROR,PWEGRPNF      NO GROUP SCHEME SPECIFIED                    
         J     VRWERR                                                           
*                                                                               
VRWMKTE1 MVI   ERROR,PWEMKTNV      MARKET VALID ONLY FOR MEDIA N,O              
         J     VRWERR                                                           
*                                                                               
VRWRNKE1 MVI   ERROR,PWERNKC1      RANK CANNOT BE LAST ROW                      
         J     VRWERR                                                           
*                                                                               
VRWUSRE1 MVI   ERROR,PWEUSRNF      USER RECORD NOT FOUND                        
         J     VRWERR                                                           
*                                                                               
VRWHDGE1 MVI   ERROR,PWEHDWID      HEADING TOO LARGE                            
         J     VRWERR                                                           
*                                                                               
VRWNSTE1 MVI   ERROR,PWENSTC1      NESTED PERIOD TOTALS                         
         J     VRWERR                                                           
*                                                                               
VRWSTKE1 MVI   ERROR,PWESTKE1      STACK MUST BE A ROW                          
         J     VRWERR                                                           
*                                                                               
VRWSTKE2 MVI   ERROR,PWESTKE2      INVALID COLUMN SPEC FOR STACK                
         J     VRWERR                                                           
*                                                                               
VRWCONTE MVI   ERROR,PWENOTCT      NOT A CONTRACT RELATED FIELD '               
         J     VRWERR                                                           
*                                                                               
VRWFLWE1 MVI   ERROR,PWEFLWNV      INVALID FLOWCHARTING EXPRESSION              
         J     VRWERR                                                           
*                                                                               
VRWNO2E  DS    0H                  NO SECOND GROUP LEVEL DEFINED                
         MVI   ERROR,PWEGPNO2      SET ERROR CODE                               
         J     VRWERR                                                           
*                                                                               
VRWTXT1E DS    0H                  TEXT TOO LONG                                
         MVI   ERROR,PWETXT1E      SET ERROR CODE                               
         J     VRWERR                                                           
*                                                                               
VRWTXT2E DS    0H                  TEXT REQUIRED                                
         MVI   ERROR,PWETXT2E      SET ERROR CODE                               
         J     VRWERR                                                           
*                                                                               
VRWERR   DS    0H                                                               
         GOTO1 CURSERR                                                          
*                                                                               
         DC    H'0'                SHOULDN'T RETURN HERE                        
*                                                                               
         EJECT                                                                  
*                                                                               
*        SUBROUTINE                                                             
*                                                                               
VRWHCHG  NTR1  BASE=*,LABEL=*                                                   
        CLI    PBTAX,0                                                          
         JE    VRWHCH2                                                          
*                                                                               
         TM    PBTAX,2      WAS HEADING 2 OVERRIDEN// IF SO BYPASS              
         MVI   PBTAX,0       INSERTING DESCRIPTION                              
         BO    VRWHCHGX                                                         
*                                                                               
VRWHCH2 LA     R1,DRHEAD2                                                       
*                                                                               
         CLI   DRATTRIB+3,C'3'           THREE LINE HEADER                      
         JNE   VRWHCH3                                                          
***      =================  ***                                                 
         LA    R1,DRHEAD3                                                       
         USING DRHEADD,R1                                                       
***      =================  ***                                                 
*                                                                               
VRWHCH3 MVC    DRHOPTS,DRH1OPTS                                                 
*                                                                               
         TM    PBQPTSW,PBQPTDQQ                                                 
         JNO   *+18                                                             
         MVC   DRHLIT(7),=C'QUARTER'                                            
         MVI   DRHLITL,7                                                        
         B     VRWHCHGX                                                         
*                                                                               
         TM    PBQPTSW,PBQPTDMQ                                                 
         JNO   *+18                                                             
         MVC   DRHLIT(5),=C'MONTH'                                              
         MVI   DRHLITL,5                                                        
         B     VRWHCHGX                                                         
*                                                                               
         TM    PBQPTSW,PBQPTDWQ                                                 
         JNO   *+18                                                             
         MVC   DRHLIT(7),=C'WEEK OF'                                            
         MVI   DRHLITL,7                                                        
         B     VRWHCHGX                                                         
*                                                                               
         TM    PBQPTSW,PBQPTDYQ                                                 
         BNO   VRWHCHGX                                                         
         MVC   DRHLIT(4),=C'YEAR'                                               
         MVI   DRHLITL,4                                                        
         B     VRWHCHGX                                                         
*                                                                               
VRWHCHGX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         EJECT                                                                  
*                                                                               
*===================================================*                           
* SUBROUTINE MOVES REC AT R2 TO R1 FOR LENGTH IN R0 *                           
* RETURN ON RE (R0-R2 AND RF ARE DESTROYED)         *                           
*===================================================*                           
         SPACE 1                                                                
VRWMREC  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
VRWMREC1 LA    RF,256                                                           
*                                                                               
         CR    R0,RF                                                            
         JNH   VRWMRC2                                                          
*                                                                               
         MVC   0(256,R1),0(R2)                                                  
         AR    R1,RF                                                            
         AR    R2,RF                                                            
         SR    R0,RF                                                            
*                                                                               
         J     VRWMREC1                                                         
*                                                                               
VRWMRC2 LTR    RF,R0                                                            
         JZ    VRWMRECX                                                         
*                                                                               
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R1),0(R2) *EXECUTED*                                         
*                                                                               
VRWMRECX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'PRWRIGEN - CHECK FLOWCHART AND REQUESTS PERIOD -RNGCHK'         
***********************************************************************         
*                                                                     *         
*        CHECK THAT FLOWCHART RANGE DEOESN'T EXCEED REQUEST PERIOD    *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
RNGCHK   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         CLI   FLOWSTRT,0          SKIP IF FLOWCHART START                      
         BE    RNGCHKX                                                          
         CLI   FLOWEND,0           OR END IS MISSING                            
         BE    RNGCHKX                                                          
*                                                                               
*        DETERMINE DATE LIST TO USE                                             
*                                                                               
         L     R5,PDADATES         ESTABLISH DATEAREA                           
         USING DATELSTD,R5                                                      
*                                                                               
         LA    RE,WEEKLIST+52*6    FIND DATE TYPE AND POINT TO DATELIST         
         CLI   PBQ$DTYP,C'W'       WEEKLY                                       
         BE    RNCKLSFD                                                         
*                                                                               
         LA    RE,MNTHLIST+12*6    MONTHLY                                      
         CLI   PBQ$DTYP,C'M'                                                    
         BE    RNCKLSFD                                                         
*                                                                               
         LA    RE,QURTLIST+4*6     QUARTERLY                                    
         CLI   PBQ$DTYP,C'Q'                                                    
         BE    RNCKLSFD                                                         
*                                                                               
         LA    RE,YEARLIST+1*6     YEARLY                                       
         CLI   PBQ$DTYP,C'Y'                                                    
         BE    RNCKLSFD                                                         
*                                                                               
         B     RNGCHKX             UNKNOWN DATE TYPE                            
*                                                                               
RNCKLSFD DS    0H                                                               
*                                                                               
RNCKLOOP DS    0H                                                               
*                                                                               
         ZIC   R7,FLOWEND          END OF DATE RANGE (EG W6)                    
         BCTR  R7,0                                                             
*                                                                               
         LA    R7,EXPLIST(R7)      POINT TO CORRECT PLACE IN EXPLIST            
*                                     GIVES INDEX INTO LIST OF DATES            
*                                                                               
*                                                                               
         ZIC   RF,0(R7)            GET INDEX TO FLOW END DATES                  
         BCTR  RF,0                DECREMENT FOR INDEXNG                        
         MHI   RF,6                DATE ENTRY IS 6 LONG                         
         LA    RF,0(RF,RE)         POINT TO DATES FOR LAST FLOW PERIOD          
*                                                                               
         CLC   PBQBEND,0(RF)       REQUEST MUST END AFTER START OF              
         BNL   RNCKDONE              LAST FLOW PERIOD                           
*                                                                               
RNCKCONT DS    0H                                                               
*                                                                               
         LHI   RF,VALSWTCH-SYSD    POINT TO SWITCH                              
         LA    RF,SYSD(RF)                                                      
         TM    0(RF),ESTPERQ       ERROR IF REQUEST PERIOD                      
         BNO   RNCKE1                NOT FROM ESTIMATE                          
*                                                                               
         CLC   FLOWSTRT,FLOWEND    ERROR IF FLOW PERIOD NOW TOO SHORT           
         BNL   RNCKE1                                                           
*                                                                               
         SR    R7,R7               GET LAST FLOW PERIOD                         
         ICM   R7,1,FLOWEND                                                     
         BZ    RNCKE1              MUST HAVE ONE                                
*                                                                               
         SHI   R7,1                BACK FLOWEND BY ONE                          
         BZ    RNCKE1              MUST HAVE ONE                                
*                                                                               
         STC   R7,FLOWEND                                                       
*                                                                               
         B     RNCKLOOP                                                         
*                                                                               
RNCKDONE DS    0H                                                               
*                                                                               
RNGCHKX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
RNCKE1   DS    0H                                                               
*                                                                               
         USING GETTXTD,GETTXTCB    ESTABLISH GETTXT CONTROL BLOCK               
*                                                                               
         LHI   RF,PWERNGE          SET ERROR MESSAGE                            
         STCM  RF,3,GTMSGNO                                                     
*                                                                               
RNCKERR  DS    0H                                                               
         GOTO1 CURSERR                                                          
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'PRWRIGEN - VALIDATE COLUMN - VINIROW'                           
***********************************************************************         
*                                                                     *         
*        INITIALIZE VALROW ROUTINE                                    *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
VINIROW  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
*        CHECK IF USER ALLOWED TO CHANGE FIELD                                  
*                                                                               
         CLI   OFFLINE,C'Y'        SKIP IF OFF-LINE                             
         JE    VROWSECX                                                         
*                                                                               
         CLI   PBQPRFW0+5,C'Y'     SKIP IF SECURITY NOT BEING USED              
         JNE   VROWSECX                                                         
*                                                                               
         TM    AUTH,X'80'          SKIP IF NO SECURITY RESTRICTIONS             
         JO    VROWSECX                                                         
*                                                                               
         USING FLDHDRD,R2                                                       
*                                                                               
         CLI   FLDIIND,0           OKAY IF NO ACTIVITY IN FIELD                 
         JE    VROWSECX                                                         
*                                                                               
         TM    FLDIIND,FINPVAL     OKAY IF FIELD PREVIOUSLY VALIDATED           
         JO    VROWSECX                                                         
*                                                                               
         CLI   FLDILEN,0           OKAY IF ENTRY DELETED                        
         JE    VROWSECX                                                         
*                                                                               
         MVI   ERROR,SECLOCK       SECURITY LOCKOUT                             
         GOTO1 CURSERR             SECURITY ERROR - FIELD CHANGED               
*                                                                               
VROWSECX DS    0H                                                               
*                                                                               
         LA    R0,DRLENIN          CLEAR DRONEBLOCK AREA                        
         LA    R1,DRINFEND-DRLENIN                                              
         LR    RE,R0                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
         XC    DRATTRIB,DRATTRIB   INIT ATTRIBUTE AREA                          
*                                                                               
         LA    R4,BLOCK            POINT TO START OF SCANNER BLOCK              
         XC    BLOCK(240),BLOCK    INIT FIELD                                   
         XC    BLOCK+240(240),BLOCK+240                                         
*                                                                               
VINIROWX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'PRWRIGEN - VALIDATE COLUMN - VALCOL'                            
***********************************************************************         
*                                                                     *         
*        VALIDATE COLUMN                                              *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
VALCOL   NMOD1 0,#VCOL,RR=RE                                                    
*                                                                               
         USING SPOOLD,R8           ESTABLISH DATA AREAS                         
         USING GEND,RC                                                          
         USING SYSD,R9                                                          
         USING T405FFD,RA                                                       
*                                                                               
         LA    RC,SPOOLEND         RESET WORKING STORAGE POINTER                
         ST    RE,VCLRELO          SAVE RELOCATION FACTOR                       
*                                                                               
         ST    R3,AEDTLST          SAVE A(ENTRY IN EDIT LIST)                   
*                                                                               
         STC   R0,FLDNMBR          SAVE FIELD NUMBER                            
*                                                                               
         LR    R4,R0               SAVE FIELD NUMBER                            
         LA    R0,DRLENIN          CLEAR DRONEBLOCK AREA                        
         LA    R1,DRINFEND-DRLENIN                                              
         LR    RE,R0                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
         LR    R0,R4               RESTORE FIELD NUMBER                         
*                                                                               
*        CHECK IF USER ALLOWED TO CHANGE FIELD                                  
*                                                                               
         CLI   OFFLINE,C'Y'        SKIP IF OFF-LINE                             
         BE    VCOLSECX                                                         
*                                                                               
         CLI   PBQPRFW0+5,C'Y'     SKIP IF SECURITY NOT BEING USED              
         BNE   VCOLSECX                                                         
*                                                                               
         TM    AUTH,X'80'          SKIP IF NO SECURITY RESTRICTIONS             
         BO    VCOLSECX                                                         
*                                                                               
         USING FLDHDRD,R2                                                       
*                                                                               
         CLI   FLDIIND,0           OKAY IF NO ACTIVITY IN FIELD                 
         BE    VCOLSECX                                                         
*                                                                               
         TM    FLDIIND,FINPVAL     OKAY IF FIELD PREVIOUSLY VALIDATED           
         BO    VCOLSECX                                                         
*                                                                               
         CLI   FLDILEN,0           OKAY IF ENTRY DELETED                        
         BE    VCOLSECX                                                         
*                                                                               
         MVI   ERROR,SECLOCK       SECURITY LOCKOUT                             
         GOTO1 CURSERR             SECURITY ERROR - FIELD CHANGED               
*                                                                               
VCOLSECX DS    0H                                                               
*                                                                               
         XC    DRATTRIB,DRATTRIB   INIT ATTRIBUTE AREA                          
*                                                                               
         CLI   5(R2),0             SKIP IF FIELD WAS NOT ENTERED                
         BE    VALCOLX                                                          
*                                                                               
         MVC   CLASTLBL,MYLABEL    UPDATE LAST ENTERED COLUMN                   
*                                                                               
         XC    BLOCK(240),BLOCK    INIT FIELD                                   
         XC    BLOCK+240(240),BLOCK+240                                         
         LA    R4,BLOCK+42         START OF SCANNER OUTPUT                      
*                                                                               
VALCOLXL DS    0H                                                               
*                                                                               
         STC   R0,FLDNMBR          SAVE FIELD NUMBER                            
         ST    R2,ALASTCOL         SAVE COLUMN POINTER                          
         MVI   FIELDERR,1          INIT FIELD IN ERROR COUNTER                  
*                                                                               
         NI    ROWCOLSW,X'FF'-ROWCOLXQ INIT CONTINUED FIELD INDICATOR           
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,5(R2)          FIELD LENGTH                                 
         LA    RE,7(RF,R2)         LAST BYTE OF INPUT                           
*                                                                               
         CLI   0(RE),C','          IF FIELD ENDS IN COMMA                       
         BNE   VALCOLX1                                                         
*                                                                               
         OI    ROWCOLSW,ROWCOLXQ      FIELD CONTINUED IN NEXT FIELD             
         MVI   0(RE),C' '             ELIMINATE COMMA                           
         BCTR  RF,0                   LENGTH DECREMENTED FOR SCANNER            
         STC   RF,5(R2)                                                         
*                                                                               
VALCOLX1 DS    0H                                                               
*                                                                               
         GOTO1 SCANNER,DMCB,(20,(R2)),(134,(R4)),0                              
*                                                                               
         SR    R0,R0                                                            
         ICM   R0,1,4(R1)          NUMBER OF ENTRY ITEMS                        
         BZ    VCOLNOTV            MUST HAVE A COLUMN                           
*                                                                               
         TM    ROWCOLSW,ROWCOL2Q   SKIP IF DOING CONTINUATION FIELD             
         BO    VCOLKYWX                                                         
*                                                                               
         CLI   12(R4),C'?'         IF HELP REQUESTED                            
         BE    *+8                                                              
         CLI   13(R4),C'?'         IF HELP REQUESTED                            
         BE    *+8                                                              
         CLI   12(R4),C'+'         IF HELP REQUESTED                            
         BNE   VCOLHLPX                                                         
*                                                                               
         LA    RF,HELPCBLK         SET FIELD TYPE IN HELP CONTROL BLOCK         
         MVI   HCBFTYP-HELPCB(RF),C'C'   HARD CODE VALUE                        
*                                                                               
         GOTO1 VPRHELP,DMCB,=AL2(PRQHMKYW),(R2),HELPCBLK SHOW HELP MENU         
*                                     FOR OPTIONS                               
         DC    H'0'                SHOULD NOT COME BACK                         
*                                                                               
VCOLHLPX DS    0H                                                               
*                                                                               
*        CHECK FOR '<' & '>' AS SEPARATORS                                      
*                                                                               
         GOTO1 =A(SEPSCAN),RR=RELOPGEN CHECK FOR < AND >                        
*                                                                               
         BNE   VCOLNOTV            ERROR FOUND                                  
*                                                                               
*        VALIDATE KEYWORD AGAINST FILTERS                                       
*                                                                               
         L     R1,AVLPARMS                                                      
         USING VLPARMS,R1          ESTABLISH DDVAL PARAMETERS                   
*                                                                               
         GOTO1 VDDVAL,(R1),('VLPVALQ',=AL2(PRQWRKYW)),                 X        
               (0(R4),12(R4)),AVLTAB,0,0,0                                      
*                                                                               
         CLI   VLPERR,0            CHECK FOR ERRORS                             
         BE    *+16                NONE                                         
         CLI   DDS,C'Y'            OKAY IF FROM DDS TERMINAL                    
         BE    *+8                                                              
         J     VCOL6               ERROR FOUND - GO TRY COMPUTE                 
*                                                                               
         DROP  R1                                                               
*                                                                               
*        VALIDATE KEYWORD VIA DDDRONE                                           
*                                                                               
         GOTO1 VCOLDRON            VALIDATE COLUMN ENTRY                        
*                                                                               
         CLI   DRERROR,0           INVALID KEYWORD ENTRY                        
         BNE   VCOL6               MAY NOT BE AN ERROR                          
*                                                                               
         OI    DROPTSO,DRCOMMAO    ASSUME NUMBERS PRINTED WITH COMMAS           
*                                                                               
         TM    PBQOPTS,PBQOXCMA    IF COMMAS EXCLUDED                           
         BNO   *+8                                                              
         NI    DROPTSO,X'FF'-DRCOMMAO      PRINT NUMBER WITHOUT COMMAS          
*                                                                               
         MVC   DRARGSI+6(1),KEYWORD# PASS ALONG KEYWORD NUMBER                  
         CLI   DRNARGSI,7          UPDATE NUMBER OF ARGUMENTS IF NEEDED         
         BNL   *+8                                                              
         MVI   DRNARGSI,7                                                       
*                                                                               
         MVC   DRARGSO+6(1),KEYWORD# PASS ALONG KEYWORD NUMBER                  
         CLI   DRNARGSO,7          UPDATE NUMBER OF ARGUMENTS IF NEEDED         
         BNL   *+8                                                              
         MVI   DRNARGSO,7                                                       
*                                                                               
         CLI   PBFLAVOR,C'O'       IF CONTRACT DATA ONLY                        
         BNE   VCOL00                                                           
*                                                                               
         CLI   DRARGSI,C'B'        NO BUY  FIELDS FOR CONTONLY OPTION           
         BE    *+8                                                              
         CLI   DRARGSI,C'K'        NO CLEARANCE   FOR CONTONLY OPTION           
         BE    *+8                                                              
         CLI   DRARGSI,C'L'        NO BILL FIELDS FOR CONTONLY OPTION           
         BNE   VCOL00                                                           
*                                                                               
         CLC   =C'SPACE',12(R4)    'SPACE' IS AN EXCEPTION                      
         BNE   VCOLNOTC                                                         
*                                                                               
         MVI   DRARGSI,C'C'           IT IS CHANGED TO CONTRACT FIELD           
         MVC   DRATTRIB+1(2),=C'NT'      AND NOT TOTALLED                       
*                                                                               
VCOL00   DS    0H                                                               
*                                                                               
         CLI   DRATTRIB+1,6        IF PUBLISHER ENTRY                           
         BNE   *+8                                                              
         MVI   PBABUFFS,255           MOVE PUBLISHER ID                         
*                                                                               
*        MONEY FIELDS PRINT ZEROS BASED ON PBQZERO SETTING                      
*                                                                               
         CLI   DRATTRIB,C'$'       IF MONEY FIELD                               
         BNE   VCOLPZX                                                          
*                                                                               
         TM    PBQGET,X'01'        IF ROUNDING OPTION ON                        
         BNO   VCOLRNDN                                                         
*                                                                               
         CLI   DRDECO,0            AND KEYWORD USES DECIMALS                    
         BE    VCOLRNDN                                                         
*                                                                               
         MVI   DRDECO,0               PRINT WITH NO DECIMALS                    
         MVI   DRDIVO,2               DIVIDE BY 100                             
*                                                                               
VCOLRNDN DS    0H                                                               
*                                                                               
         CLI   PBQPZERO,C'Y'          IF WE ARE TO PRINT ZEROS                  
         BNE   *+12                                                             
         OI    DROPTSO,DRZEROO           SET DRIVER INDICATOR                   
         B     VCOLPZX                                                          
*                                                                               
         NI    DROPTSO,X'FF'-DRZEROO  ELSE TURN OFF INDICATOR                   
*                                                                               
VCOLPZX  DS    0H                                                               
*                                                                               
*        KEYWORD CAN'T BE DESIGNATED AS ROW ONLY                                
*                                                                               
VCOLROW  DS    0H                                                               
*                                                                               
         CLI   DRATTRIB,C'R'       ROW ONLY ENTRIES NOT ALLOWED                 
         BE    VCOLNOTV                                                         
*                                                                               
         CLC   DRATTRIB(2),=C'DT'  SKIP IF DATE COLUMN/ROW EXPRESSION           
         BE    VCOLROWX                                                         
*                                                                               
         CLI   DRATTRIB,C'D'       ROW DETAIL ONLY ENTRIES NOT ALLOWED          
         BE    VCOLNOTV                                                         
*                                                                               
VCOLROWX DS    0H                                                               
*                                                                               
*        CHECK FOR CUSTOM COLUMN ENTRY                                          
*                                                                               
         CLC   =C'CC ',12(R4)      CHECK FOR CUSTOM COLUMN                      
         JNE   VCOLCCN                                                          
*                                                                               
         GOTOR CCVAL                                                            
*                                                                               
         B     VCOLKEYX                                                         
*                                                                               
VCOLCCN  DS    0H                                                               
*                                                                               
*        CHECK FOR USER FIELDS                                                  
*                                                                               
VCOLUDF  DS    0H                                                               
*                                                                               
         CLC   =C'UDEF',12(R4)     USER FIELD IDENTIFIER                        
         BE    *+10                                                             
         CLC   =C'LBGL#',12(R4)    LABATT GENERAL LEDGER #                      
         BNE   VCOLUDFN                                                         
*                                                                               
         GOTOR UDEFVAL             GO DO VALIDATION                             
*                                                                               
         B     VCOLKEYX                                                         
*                                                                               
VCOLUDFN DS    0H                                                               
*                                                                               
         CLI   DRARGSI,C'X'        IF INVOICE KEYWORD                           
         BNE   *+8                                                              
         OI    PBQREAD2,PBQRDINV      SET TO READ INVOICE RECORDS               
*                                                                               
         CLI   DRARGSI,C'Y'        IF INVOICE KEYWORD                           
         BNE   *+8                                                              
         OI    PBQREAD2,PBQRDNV       SET TO READ INVOICE RECORDS               
*                                                                               
         CLC   =C'UCOM',12(R4)     USER FIELD IDENTIFIER                        
         JNE   VCOLUCMX                                                         
*                                                                               
         GOTOR UCOMVAL             GO DO VALIDATION                             
*                                                                               
         J     VCOLKEYX                                                         
*                                                                               
VCOLUCMX DS    0H                                                               
*                                                                               
*        IF GROUP SCHEME REPORT                                                 
*        ADD BREAK NAMES TO HEADLINES                                           
*                                                                               
         CLC   =C'IGRP',DRRTNI     SKIP IF NOT GROUP CODE KEYWORD               
         BNE   VCOLGRPX                                                         
*                                                                               
         L     R6,PBAGPCBK         ASSUME CLIENT GROUP KEYWORD                  
*                                                                               
         CLI   DRARGSI+2,C'P'      CHECK FOR PRODUCT                            
         BNE   *+8                                                              
         L     R6,PBAGPPBK                                                      
*                                                                               
         CLI   DRARGSI+2,C'B'      CHECK FOR PUB                                
         BNE   *+8                                                              
         L     R6,PBAGPBBK                                                      
*                                                                               
         LTR   R6,R6               MUST BE USING A GROUP SCHEME                 
         BZ    VCLGRPNF                                                         
*                                                                               
         USING GRPBRKD,R6          ESTABLISH BREAK DESC ELM                     
*                                                                               
         OI    DRHEAD1,X'80'       FORCE HEADLINE TO PRINT                      
*                                                                               
         LA    R1,GRPBK1           DEFAULT TO FIRST BREAK                       
*                                                                               
         CLI   DRARGSI+3,C'1'      OKAY IF FIRST BREAK WANTED                   
         BE    VCOLGRP5                                                         
*                                                                               
         CLI   DRARGSI+3,C'0'      OKAY IF LOWEST BREAK WANTED                  
         BNE   *+12                                                             
         CLI   GRPBK2LN,0          AND NO SECOND BREAK PRESENT                  
         BE    VCOLGRP5                                                         
*                                                                               
         LA    R1,GRPBK2           ELSE USE SECOND BREAK                        
*                                                                               
VCOLGRP5 DS    0H                                                               
*                                                                               
         CLI   DRARGSI+3,C'2'      IF SECOND BREAK WANTED                       
         BNE   *+12                                                             
         CLI   GRPBK2LN,0          THEN MUST HAVE SECOND BREAK DEFINED          
         BE    VCOLNO2E                                                         
*                                                                               
*        FIND LENGTH OF BREAK NAME                                              
*                                                                               
         LA    RF,L'GRPBK1         MAX LENGTH OF BREAK NAME                     
         LA    RE,(L'GRPBK1-1)(R1) LAST BYTE OF BREAK NAME                      
*                                                                               
         CLI   0(RE),C' '          FIND LAST NON-BLANK                          
         BH    *+14                                                             
         BCTR  RE,0                                                             
         BCT   RF,*-10                                                          
         B     *+6                 NO NAME                                      
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   DRH1LIT(0),0(R1)    SET COLUMN TITLE                             
*                                                                               
         LA    RF,1(RF)            RESTORE TRUE LENGTH                          
*                                                                               
         STC   RF,DRH1LITL         SET LITERAL LENGTH                           
*                                                                               
         J     VCOLKEYX                                                         
*                                                                               
VCOLGRPX DS    0H                                                               
*                                                                               
         CLC   =C'IGP',DRRTNI      SKIP IF NOT GROUP CODE KEYWORD               
         JNE   VCOLGPX                                                          
*                                                                               
         CLI   1(R4),1             MUST HAVE 1-CHARACTER SCHEME CODE            
         JNE   VCOLGP1E                                                         
*                                                                               
         TM    3(R4),X'40'         MUST BE ALPHABETIC                           
         JNO   VCOLGP2E                                                         
         TM    3(R4),X'80'         AND NOT NUMERIC                              
         JO    VCOLGP2E                                                         
*                                                                               
         MVC   DRARGSI+3(1),22(R4) SAVE SCHEME CODE                             
*                                                                               
         J     VCOLKEYX                                                         
*                                                                               
VCOLGPX  DS    0H                                                               
*                                                                               
         CLC   =C'IACH',DRRTNI     SKIP IF NOT ADDITIONAL CHGS KYWD             
         JNE   VCOLACHX                                                         
*                                                                               
         OI    PBBYOPT2,PBBYACHQ   INDICATE ADDL CHGS WANTED                    
         OI    PBQACHGS,PBQACOPQ+PBQACLSQ  AND ADDL CHGS TO BE LISTED           
*                                                                               
VCOLACHX DS    0H                                                               
         CLC   =C'IBNV',DRRTNI     SKIP IF NOT ADDITIONAL CHGS KYWD             
         JNE   VCOLBNVX                                                         
*                                                                               
         OI    PBBYOPT2,PBBYPNVQ   INDICATE NEW INVOICE KEYWORDS                
*                                                                               
VCOLBNVX DS    0H                                                               
*                                                                               
*        CHECK IF READING BUYS VIA PAY OR BILL ELEMENTS                         
*                                                                               
         CLI   DRARGSI,C'B'        IF GENERAL BUY RECORD DATA                   
         BNE   *+14                                                             
         OI    PBBYOPTS,PBBYBUYQ      SET INDICATOR                             
         AP    PBQKYWDN,=P'1'         BUMP # OF BUY RELATED KEYWORDS            
*                                                                               
         CLI   DRARGSI,C'K'        IF CLEARANCE STATUS KEYWORD                  
         BNE   *+8                                                              
         OI    PBBYOPTS,PBBYCLSQ+PBBYPAYQ   READING BY PAY & CLEARANCE          
*                                                                               
         CLI   DRARGSI,C'N'        IF PAY ELEMENT ONLY KEYWORD                  
         BNE   *+8                                                              
         OI    PBBYOPTS,PBBYPAYQ      READING BY PAY                            
*                                                                               
         CLI   DRARGSI,C'J'        IF PAY ELEMENT KEYWORD                       
         BNE   *+8                                                              
         OI    PBBYOPTS,PBBYCLSQ+PBBYPAYQ   READING BY PAY & CLEARANCE          
*                                                                               
         CLI   DRARGSI,C'L'        IF BILL HEADER DATA                          
         BNE   *+8                                                              
         OI    PBBYOPTS,PBBYBHDQ                                                
*                                                                               
         CLI   DRARGSI,C'Q'        IF CASH APPLIED DATA                         
         BNE   *+16                                                             
         OI    PBBYOPTS,PBBYBHTQ      NEED BILL HEADER TABLE                    
         OI    PBBYOPT2,PBBYCSHQ      NEED CASH DATA                            
         OI    PBQREAD,PBQRDBLS       READ BILL RECORDS                         
*                                                                               
         CLI   DRARGSI,C'M'        IF BILL ELEMENT KEYWORD                      
         BNE   *+8                                                              
         OI    PBBYOPTS,PBBYBLLQ      READING BY BILL ELEMENTS                  
*                                                                               
         CLI   DRARGSI,C'I'        IF BILL ELEMENT KEYWORD & BILL               
         BNE   *+12                   HEADER DATA NEEDED                        
         OI    PBBYOPTS,PBBYBLLQ+PBBYBHTQ READING BY BILL ELEMENTS              
*                                     AND NEED BILL HEADER TABLE                
         OI    PBQREAD,PBQRDBLS    READ BILL RECORDS                            
*                                                                               
         CLC   DRRTNI,=C'IAADT   ' ACTIVITY DATE USES ALL ELEMENTS              
         BNE   *+18                                                             
         OI    PBBYOPTS,PBBYBLLQ+PBBYBHTQ+PBBYPAYQ+PBBYCLSQ                     
         OI    PBQREAD,PBQRDBLS    READ BILL RECORDS                            
         ZAP   PBQKYWDN,=P'1'      RESET # OF BUY REALTED KEYWORDS              
*                                                                               
         CLC   DRARGSI(2),=C'H6 ' PGEST KEYWORD                                 
         BNE   *+8                                                              
         OI    PBQCFOPT,PBQCFPGQ   SET FLAG                                     
*                                                                               
         CLC   DRARGSI(2),=C'H7 ' GFEST KEYWORD                                 
         BNE   *+8                                                              
         OI    PBQCFOP2,PBQCFGFQ   SET FLAG                                     
*                                                                               
         CLC   DRRTNI,=C'IESTBGT ' BUDGET KEYWORD                               
         BNE   VCOLBDGX                                                         
*                                                                               
         OI    PBQCFOPT,PBQBDGQ      BUDGETS IN PLAY                            
*                                                                               
         CLI   DRARGSI+1,C'M'        IF NOT MONTHLY MONTHLY                     
         BE    *+12                                                             
         OI    PBQCFOPT,PBQBDGTQ        TOTAL   BUDGETS IN PLAY                 
         B     VCOLBDGX                                                         
*                                                                               
         OI    PBQCFOPT,PBQBDGMQ        MONTHLY BUDGETS IN PLAY                 
*                                                                               
VCOLBDGX DS    0H                                                               
*                                                                               
*        MARKET VALID FOR NEWSPAPER AND OUTDOOR                                 
*                                                                               
         CLC   12(6,R4),=C'MARKET'                                              
         BNE   VCOLMKTX                                                         
*                                                                               
         CLI   PBQMED,C'N'                                                      
         BE    *+8                                                              
         CLI   PBQMED,C'O'                                                      
         BNE   VCOLMKTN                                                         
*                                                                               
VCOLMKTX DS    0H                                                               
*                                                                               
*        HANDLE TEXT= KEYWORD                                                   
*                                                                               
VCLTEXT  DS    0H                                                               
*                                                                               
         CLC   =C'TEXT',12(R4)     SKIP IF NOT TEXT KEYWORD                     
         JNE   VCLTEXTX                                                         
*                                                                               
         CLI   1(R4),20            MAX 20 BYTES                                 
         JH    VCLTXT1E                                                         
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,1(R4)          GET TEXT LENGTH                              
         JZ    VCLTXT2E            MUST HAVE SOME TEXT                          
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         J     *+10                                                             
         MVC   DRLITO(0),22(R4)    SAVE TEXT AS LITERAL                         
*                                                                               
         MVC   DRLITLNO,1(R4)      PASS ON LITERAL LENGTH                       
         MVC   DRLENI,1(R4)        SET COLUMN WIDTH                             
         MVC   DRLENO,1(R4)        SET COLUMN WIDTH                             
*                                                                               
VCLTEXTX DS    0H                                                               
*                                                                               
*        DETERMINE DISTRICT/REGION/DIVISION                                     
*                                                                               
         CLC   DRATTRIB+1(2),=C'DR'      DRD ROW SELECTED                       
         BNE   *+8                                                              
         MVI   PBQDRDSW,PBQDRDYQ                                                
*                                                                               
*        ENTRIES SHOW, ILLUM AND REGULAR MUST BE FOR MEDIA OUTDOOR              
*                                                                               
VCOLOUT  DS    0H                                                               
*                                                                               
         CLC   12(5,R4),=C'ILLUM'                                  L19          
         BE    *+10                                                L19          
         CLC   12(6,R4),=C'REGULA'                                 L19          
         BE    *+10                                                L19          
         CLC   12(6,R4),=C'SHOW'                                   L19          
         BE    *+10                                                L19          
         CLC   12(6,R4),=C'POSTER'                                 L19          
         BNE   VCOLOUTX                    MUST BE OUTDOOR MEDIA   L19          
*                                                                               
         CLI   PBQMED,C'O'                                         L19          
         BNE   VCOLMEDO                                            L19          
*                                                                               
VCOLOUTX DS    0H                                                               
*                                                                               
*        HANDLE FIELD FLAGGED AS NO TOTAL                                       
*                                                                               
         CLC   DRATTRIB+1(2),=C'NT'     IF NO TOTAL FOR THIS COLUMN             
         BNE   VCOLNTX                                                          
*                                                                               
         TM    SPECOPT,GLDLSTRP            DONE IF  THIS IS A DOWN LOAD         
         BO    VCOLNTX                                                          
*                                                                               
         OI    DROPTSO+1,DRNOTOT   TURN ON INDICATOR                            
*                                                                               
VCOLNTX  DS    0H                                                               
*                                                                               
*        CHECK IF KEYWORD BEING FILTERED ON VALUE                               
*                                                                               
         GOTO1 =A(FLTRVAL),RR=RELOPGEN                                          
         BNE   VCOLFVLE            INVALID FILTER                               
*                                                                               
VCOLFLTX DS    0H                                                               
*                                                                               
         B     VCOLKEYX                                                         
*                                                                               
*        IF HERE, THEN HAD ERROR VALIDATING VIA DRONE                           
*                                                                               
VCOL6    XC    BLOCK(42),BLOCK     MAY BE A COMPUTE EXPRESSION                  
         MVI   BLOCK,7                                                          
         MVC   BLOCK+12(30),SPACES                                              
         MVC   BLOCK+12(7),=C'COMPUTE'                                          
         LA    R4,BLOCK                                                         
*                                                                               
         GOTO1 VCOLDRON            VALIDATE THE COMPUTE COLUMN                  
*                                                                               
         CLI   DRERROR,0           ERROR MEANS INVALID KEYWORD                  
         BNE   VCOLNOTV                                                         
*                                                                               
         LA    R4,BLOCK+42                                                      
*                                                                               
         CLI   OFFLINE,C'Y'        SKIP VALIDFATION IF OFF-LINE                 
         BE    VCOL8                                                            
*                                                                               
         GOTO1 VCMPDRON            VALIDATE A COMPUTE EXPRESSION                
*                                                                               
         CLI   DRERROR,0                                                        
         BNE   VCOLNOTV                                                         
*                                                                               
VCOL8    BRAS  RE,COMPEDIT         AUTO EDIT FOR COMPUTES                       
*                                                                               
         CLI   DRDECO,X'FF'        ERROR CHECK                                  
         BE    VCOLER02                                                         
*                                                                               
VCOLKEYX DS    0H                                                               
*                                                                               
*        CHECK IF BRAND AGENCY REQUESTING AOR REPORT                            
*                                                                               
         CLI   BRANDSW,C'Y'        SKIP IF NOT BRAND AGY AOR REQUEST            
         BNE   VCOLBRDX                                                         
*                                                                               
         LA    R1,DRATTRIB         POINT TO ENTRY ATTRIBUTES                    
         LA    RF,L'DRATTRIB       MAX NUMBER OF ATTRIBUTES                     
*                                                                               
         CLI   0(R1),C'@'          @ INDICATES CONTROL BYTE NEXT                
         BE    *+16                                                             
         LA    R1,1(R1)            BUMP ATTRIBUTE POINTER                       
         BCT   RF,*-12                                                          
         B     VCOLBRDE            MUST FIND IT                                 
*                                                                               
         TM    1(R1),X'80'         X'80' MUST BE ON                             
         BNO   VCOLBRDE                                                         
*                                                                               
VCOLBRDX DS    0H                                                               
*                                                                               
         TM    PBBYOPTS,PBBYBHTQ   IF BUILDING INVOICE TABLE                    
         BNO   *+12                                                             
         CLI   PBQDATYP,C'1'          DATE TYPE MUST BE MNTH OF SERVICE         
         BNE   VCOLMSER                                                         
*                                                                               
         CLI   DRARGSI,C'C'        CONTRACT RELATED ENTRY                       
         BNE   *+8                                                              
         OI    PBQSPLOP,PBQCONTR                                                
*                                                                               
         EJECT                                                                  
*                                                                               
*        CHECK FOR SUBSIDIARY COLUMN EXPRESSIONS                                
*                                                                               
         LA    R4,42(R4)           BUMP TO FIRST FORMAT OR FILTER               
         AI    FIELDERR,1                                                       
         BCT   R0,*+8                                                           
         B     VCOLDONE            NO FORMAT OR FILTER OPTIONS                  
*                                                                               
VCOLKYWX DS    0H                                                               
*                                                                               
VCOLLOOP DS    0H                                                               
*                                                                               
         CLI   0(R4),0             SKIP IF NO DATA FOR OPTION                   
         BE    VCOLCONT                                                         
*                                                                               
         GOTOR VCOLOPT             VALIDATE FORMAT AND FILTER OPTIONS           
*                                                                               
VCOLCONT DS    0H                                                               
*                                                                               
         LA    R4,42(R4)                                                        
         AI    FIELDERR,1                                                       
         BCT   R0,VCOLLOOP                                                      
*                                                                               
VCOLDONE DS    0H                                                               
*                                                                               
         TM    ROWCOLSW,ROWCOLXQ   IF THERE IS A CONTINUATION                   
         BNO   VALCOLXD                                                         
*                                                                               
         L     R2,ALASTCOL         RE-POINT TO SCREEN FIELD                     
*                                                                               
         SR    RF,RF                                                            
         IC    RF,5(R2)            RESTORE LAST FIELD LENGTH                    
         LA    R1,8(RF,R2)         POINT TO END OF FIELD                        
         MVI   0(R1),C','          REPLACE COMMA                                
         LA    RF,1(RF)                                                         
         STC   RF,5(R2)                                                         
*                                                                               
         OI    ROWCOLSW,ROWCOL2Q   INDICATE ON SECOND FIELD                     
*                                                                               
         ZIC   RF,0(R2)            GET TO NEXT SCREEN FIELD                     
         AR    R2,RF                                                            
*                                                                               
         ZIC   RF,0(R2)            GET TO NEXT SCREEN FIELD                     
         AR    R2,RF                                                            
*                                                                               
         SR    R0,R0                                                            
         IC    R0,FLDNMBR                                                       
*                                                                               
         BCT   R0,VALCOLXL         DECREMENT FIELD COUNTER                      
*                                                                               
         B     VCOLNOTV            NO MORE AVAILABLE                            
*                                                                               
VALCOLXD DS    0H                                                               
*                                                                               
         BRAS  RE,PERPOP           MAY POP IN A PERIOD HEADING                  
*                                                                               
         TM    STACKSW,STACKYQ+STCKMRGQ    IF STACKING OR MERGING               
         BZ    VCOLSTCX                                                         
*                                                                               
         MVC   DRLABELI,MYLABEL                                                 
*                                                                               
         CLC   DRLABELI,STACK1ST   AND THIS IS A STACKED COLUMN                 
         BL    VCOLSTCX                                                         
         CLC   DRLABELI,STACKLST                                                
         BH    VCOLSTCX                                                         
*                                                                               
         CLI   DRTYPEO,C'N'        IF NOT NUMERIC                               
         BE    *+8                                                              
         OI    DROPTSO+1,DRNOTOT      DON'T TOTAL FIELD                         
*                                                                               
         TM    STACKSW,STACKYQ     CONTINUE IF STACKING                         
         BNO   VCOLSTCX                                                         
*                                                                               
         L     R3,ASTACKBF         POINT TO STACK BUFFER                        
         USING STACKBFD,R3         ESTABLISH BUFFER                             
*                                                                               
*        SAVE DRONEBLOCK IN BUFFER                                              
*                                                                               
         L     RE,STBFENA          NEXT ENTRY IN BUFFER                         
         LA    RE,1(RE)            NEXT AVAILABLE SLOT                          
         LA    RF,DRINFEND-DRLENIN DRONE BLOCK LENGTH                           
         LR    R1,RF               COPY LENGTH                                  
         LA    R0,DRLENIN          SAVE DRONEBLOCK FROM HERE                    
*                                                                               
         MVCL  RE,R0                                                            
*                                                                               
         L     RE,STBFENA          CURRENT END OF BUFFER                        
         LA    RE,1(RE)            A(ENTRY USED IN BUFFER)                      
         USING STBFENTD,RE         ESTABLISH BUFFER ENTRY                       
*                                                                               
         MVC   STBFSBLK,BLOCK+42   SAVE SCANNER BLOCK                           
*                                                                               
         DROP  RE                                                               
*                                                                               
         A     RE,STBFLEN          BUFFER ENTRY LENGTH                          
         BCTR  RE,0                                                             
         ST    RE,STBFENA          NEW END OF BUFFER                            
*                                                                               
         CLC   STACKLNO,DRLENO     UPDATE COLUMN WIDTH                          
         BNL   *+10                                                             
         MVC   STACKLNO,DRLENO     USE LARGEST IN STACK                         
*                                                                               
         LA    RE,0                CLEAR DRONEBLOCK                             
         SR    RF,RF                                                            
         LA    R1,DRINFEND-DRLENIN DRONE BLOCK LENGTH                           
         LA    R0,DRLENIN                                                       
*                                                                               
         MVCL  R0,RE                                                            
*                                                                               
         DROP  R3                                                               
*                                                                               
         CLC   MYLABEL,STACKLST    DONE IF NOT LAST COLUMN                      
         BNE   VALCOLX                                                          
*                                                                               
         OI    DRFLAGO,X'80'       INDICATE WE ARE PRINTING THIS FIELD          
         MVC   DRLENO,STACKLNO     RESET OUTPUT LENGTH                          
*                                                                               
VCOLSTCX DS    0H                                                               
*                                                                               
         MVI   HDGOVRSW,0          CLEAR                                        
*                                                                               
         TM    DRFLAGO,X'80'       IF THERE IS ANY PRINTING                     
         BZ    VCOLGEN                                                          
*                                                                               
         CLI   DRPOSO,C'N'                                                      
         BE    VCOLGEN                                                          
*                                                                               
         ZIC   RE,FCHRTITR         ANY FLOWCHARTING                             
         LA    RE,1(RE)            ENSURE AT LEAST ONE                          
         MVI   FCHRTITR,0            INITIALIZE                                 
*                                                                               
VCOLMULT LH    R1,TOTWIDTH         ADJUST CURRENT WIDTH                         
*                                                                               
         ZIC   RF,DRLENO                                                        
         AR    R1,RF                                                            
         LA    R1,1(R1)                                                         
         STH   R1,TOTWIDTH                                                      
*                                                                               
         CLI   OFFLINE,C'Y'           OFF LINE                                  
         BE    VCOLGEN                                                          
*                                                                               
         CLI   PBQ$DTYP,0             ANY FLOWCHARTING                          
         BE    VCOLGEN                                                          
*                                                                               
         BCT   RE,VCOLMULT                                                      
*                                                                               
VCOLGEN  CLI   OFFLINE,C'Y'        NOW GENERATE ELEMENTS                        
         BNE   VALCOLX                                                          
*                                                                               
*        BUILD PQINDEX TABLE ENTRY                                              
*                                                                               
         ICM   RF,15,APQINDEX      POINT TO PQ INDEX TABLE                      
         JZ    VCLINXX             SKIP IF NO TABLE AVAILABLE                   
*                                                                               
         USING PQINDEX,RF          ESTABLISH TABLE ENTRY                        
*                                                                               
*        FIND NEXT AVAILABLE ENTRY IN TABLE                                     
*                                                                               
         LA    R0,MAXHEADS+MAXMIDS+MAXROWS+MAXCOLS   MAX ENTRIES                
*                                                                               
         OC    PQKEYWRD,PQKEYWRD   FIND FIRST NULL ENTRY                        
         JZ    *+16                                                             
         LA    RF,PQINDXEQ(RF)     BUMP TO NEXT ENTRY                           
         BRCT  R0,*-14                                                          
         J     VCLINXX             SKIP                                         
*                                                                               
         MVC   PQKEYWRD,BLOCK+54   SAVE KEYWORD                                 
         MVC   PQOUTLEN,DRLENO     SAVE OUTPUT LENGTH                           
         MVI   PQPOSO,C'C'         SAVE KEYWORD TYPE                            
         MVC   PQHEAD1,DRH1LIT     SAVE FIRST  COLUMN HEADLINE                  
         MVC   PQHEAD2,DRH2LIT     SAVE SECOND COLUMN HEADLINE                  
         MVC   PQHEAD3,DRH3LIT     SAVE THIRD  COLUMN HEADLINE                  
         MVC   PQHEAD4,DRH4LIT     SAVE FOURTH COLUMN HEADLINE                  
*                                                                               
         DROP  RF                                                               
*                                                                               
VCLINXX  DS    0H                                                               
*                                                                               
         L     RF,AEDTLST          POINT TO CURRENT PLACE IN EDITLIST           
         MVC   1(1,RF),DRDECO      SAVE NUMBER OF DECIMALS                      
         MVC   2(1,RF),DRDIVO      SAVE DIVIDING FACTOR                         
*                                                                               
         TM    STACKSW,STACKYQ     IF STACKING                                  
         BO    *+12                                                             
         CLI   PBQ$DTYP,0          OR FLOWCHARTING                              
         BE    VCOLFLWX                                                         
*                                                                               
         GOTO1 VDOFLOW,DMCB        DOFLOW ROUTINE                               
*                                                                               
         MVI   PBQ$DTYP,0          TURN OFF FLOWCHARTING                        
         MVC   DRLABELI,MYLABEL                                                 
*                                                                               
         TM    STACKSW,STACKYQ     IF STACKING                                  
         BNO   *+12                                                             
         NI    STACKSW,X'FF'-STACKYQ  TURN OFF STACKING                         
         OI    STACKSW,STACKP1        NEXT COLUMN USES P1 FOR POSITION          
*                                                                               
         B      VCOLFLWY                                                        
*                                                                               
VCOLFLWX DS    0H                                                               
*                                                                               
         MVC   DRLABELI,MYLABEL                                                 
*                                                                               
         TM    STACKSW,STACKP1     IF WE HAVE JUST COMPLETED STACKING           
         BNO   *+16                                                             
         MVI   DRPOSO,C'P'            WE MUST RESET PRINTING TO P1              
         MVI   DRPOSO+1,1             TO GET COL HORIZ ALIGNED                  
         XI    STACKSW,STACKP1        TURN OFF SWITCH                           
*                                                                               
         TM    STACKSW,STCKMRGQ    IF MERGING                                   
         BNO   *+16                                                             
         CLI   DRTYPEI+1,C' '         IF THIS INFO NOT SPECIFIED                
         BH    *+8                                                              
         MVI   DRTYPEI+1,C'+'            FORCE ADDITIVE NATURE                  
*                                                                               
*                                                                               
         CLI   OFFLINE,C'Y'           OFF LINE                                  
         BNE   VCOLFLWY                                                         
*                                                                               
         GOTO1 GCOLDRON                                                         
*                                                                               
VCOLFLWY DS    0H                                                               
*                                                                               
         CLC   BLOCK+12(7),=C'COMPUTE'                                          
         BNE   VALCOLX                                                          
*                                                                               
         LA    R4,BLOCK+42                                                      
*                                                                               
         GOTO1 GCMPDRON                                                         
*                                                                               
         CLI   DRERROR,0                                                        
         BNE   VCOLNOTV                                                         
         B     VALCOLX                                                          
*                                                                               
*        ERROR ROUTINES                                                         
*                                                                               
VCLGRPNF DS    0H                  NO GROUP SCHEME BEING USED                   
         MVI   ERROR,PWEGRPNF                                                   
         B     VCOLERR                                                          
*                                                                               
VCOLGP1E DS    0H                  GROUP SCHEME CODE REQUIRED                   
         MVI   ERROR,PWEGPREQ                                                   
         B     VCOLERR                                                          
*                                                                               
VCOLGP2E DS    0H                  GROUP SCHEME CODE MUST BE ALPHABETIC         
         MVI   ERROR,PWEGPAPH                                                   
         B     VCOLERR                                                          
*                                                                               
VCOLBRDE DS    0H                  ILLEGAL KEYWORD FOR BRAND AOR REPORT         
         MVI   ERROR,PWEBRDER                                                   
         B     VCOLERR                                                          
*                                                                               
VCOLFVLE DS    0H                  INVALID FILTER VALUE FOR KEYWORD             
         MVI   ERROR,PWEFLTNV                                                   
         B     VCOLERR                                                          
*                                                                               
VCOLMSER DS    0H                  MONTH OF SERVICE DATE TYPE                   
         MVI   ERROR,PWEMSERR                                                   
         B     VCOLERR                                                          
*                                                                               
VCOLMEDO DS    0H                  OUTDOOR MEDIA REQUIRED                       
         MVI   ERROR,PWEMEDO                                                    
         B     VCOLERR                                                          
*                                                                               
VCOLNOTC DS    0H                  INVALID COLUMN ENTRY                         
         MVI   ERROR,PWENOTCT                                                   
         B     VCOLERR                                                          
*                                                                               
VCOLNOTV DS    0H                  INVALID COLUMN ENTRY                         
         MVI   ERROR,PWECOLNV                                                   
         B     VCOLERR                                                          
*                                                                               
VCOLER01 DS    0H                  INCONSISTENT OPTION                          
         MVI   ERROR,PWEOPTNC                                                   
         B     VCOLERR                                                          
*                                                                               
VCOLER02 DS    0H                  COMPUTE COLUMNS MUST BE PREVIOUSLY           
         MVI   ERROR,PWECPREV        DEFINED                                    
         B     VCOLERR                                                          
*                                                                               
VCOLMKTN DS    0H                  MARKET VALID ONLY FOR MEDIA N,O              
         MVI   ERROR,PWEMKTNV                                                   
         B     VCOLERR                                                          
*                                                                               
VCOLNO2E DS    0H                  NO SECOND GROUP LEVEL DEFINED                
         MVI   ERROR,PWEGPNO2      SET ERROR CODE                               
         B     VCOLERR                                                          
*                                                                               
VCLTXT1E DS    0H                  TEXT TOO LONG                                
         MVI   ERROR,PWETXT1E      SET ERROR CODE                               
         J     VCOLERR                                                          
*                                                                               
VCLTXT2E DS    0H                  TEXT REQUIRED                                
         MVI   ERROR,PWETXT2E      SET ERROR CODE                               
         J     VCOLERR                                                          
*                                                                               
VCOLERR  DS    0H                                                               
*                                                                               
         GOTO1 CURSERR                                                          
*                                                                               
VALCOLX  DS    0H                                                               
*                                                                               
         SR    R0,R0                                                            
         ICM   R0,1,FLDNMBR          RESTORE FIELD NUMBER                       
         BNZ   *+6                                                              
         DC    H'0'                                                             
*                                                                               
         NI    ROWCOLSW,X'FF'-ROWCOL2Q   TURN OFF INDICATOR                     
*                                                                               
         XIT1  REGS=(R0,R2)                                                     
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'PRWRIGEN - VALIDATE COLUMN - VCOLOPT'                           
***********************************************************************         
*                                                                     *         
*        VALIDATE COLUMN FORMAT AND FILTER OPTIONS                    *         
*                                                                     *         
*NTRY    R4==> SCANNER BLOCK OF OPTION                                *         
*                                                                     *         
*                                                                     *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                  ALIGNMENT                                    
VCOLOPT  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING SPOOLD,R8                                                        
         USING GEND,RC                                                          
         USING SYSD,R9                                                          
         USING T405FFD,RA                                                       
*                                                                               
*        CHECK FOR '<' & '>' AS SEPARATORS                                      
*                                                                               
         GOTOR SEPSCAN             CHECK FOR < AND >                            
         BNE   VCOPNOTV            ERROR FOUND                                  
*                                                                               
         CLI   12(R4),C'?'         IF HELP REQUESTED                            
         BE    *+8                                                              
         CLI   13(R4),C'?'         IF HELP REQUESTED                            
         BE    *+8                                                              
         CLI   12(R4),C'+'         IF HELP REQUESTED                            
         BNE   VCOPHLPX                                                         
*                                                                               
         LA    RF,HELPCBLK         SET FIELD TYPE IN HELP CONTROL BLOCK         
         MVI   HCBFTYP-HELPCB(RF),C'C'   HARD CODE VALUE                        
*                                                                               
         GOTO1 VPRHELP,DMCB,=AL2(PRQHMCFW),(R2),HELPCBLK SHOW HELP MENU         
*                                     FOR OPTIONS                               
         DC    H'0'                SHOULD NOT COME BACK                         
*                                                                               
VCOPHLPX DS    0H                                                               
*                                                                               
         MVC   FIELDERR,4(R4)      FIRST BYTE OF CHUNK                          
*                                                                               
*        PURE NUMBER IS ASSUMED TO BE LENGTH OVERRIDE                           
*                                                                               
         TM    2(R4),X'80'         NUMERIC=OUTPUT WIDTH OVERRIDE                
         BNO   VCOPLENX                                                         
*                                                                               
         ZIC   R1,7(R4)            OUTPUT WIDTH OVERRIDE                        
         STC   R1,DRLENO           (NEW OUTPUT LENGTH)                          
*                                                                               
         CLC   =C'IBUYDSCR',DRRTNI  IF SPACE ENTRY                              
         BNE   VCOPLEN1                                                         
*                                                                               
         SLL   R1,1                   DRLENI=2*DRLENO+1                         
         LA    R1,1(R1)                                                         
         STC   R1,DRLENI                                                        
*                                                                               
VCOPLEN1 DS    0H                                                               
*                                                                               
         CLC   =C'ODATA',DRRTNO   IF ODATA ROUTINE                              
         BNE   VCOPLEN2                                                         
*                                                                               
         CLC   DRLENI,DRLENO         DRLENI MUST BE >= DRLENO                   
         BNL   *+10                                                             
         MVC   DRLENI,DRLENO                                                    
*                                                                               
VCOPLEN2 DS    0H                                                               
*                                                                               
         B     VCOPOPTX                                                         
*                                                                               
VCOPLENX DS    0H                                                               
*                                                                               
*        CHECK FOR HEADING OVERRIDES                                            
*                                                                               
VCOPHD   DS    0H                                                               
*                                                                               
         CLC   12(2,R4),=C'H '     DETERMINE HEADING BEING OVERRIDDEN           
         BE    *+10                                                             
         CLC   12(3,R4),=C'H1 '                                                 
         BNE   *+12                                                             
         LA    R1,DRHEAD1                                                       
         B     VCOPHD10                                                         
*                                                                               
         CLC   12(3,R4),=C'H2 '                                                 
         BNE   *+12                                                             
         LA    R1,DRHEAD2                                                       
         B     VCOPHD10                                                         
*                                                                               
         CLC   12(3,R4),=C'H3 '                                                 
         BNE   *+12                                                             
         LA    R1,DRHEAD3                                                       
         B     VCOPHD10                                                         
*                                                                               
         CLC   12(3,R4),=C'H4 '                                                 
         BNE   *+12                                                             
         LA    R1,DRHEAD4                                                       
         B     VCOPHD10                                                         
*                                                                               
         B     VCOPHDN             NOT A HEDAING OVERRIDE                       
*                                                                               
VCOPHD10 DS    0H                                                               
*                                                                               
         USING DRHEADD,R1          ESTABLISH HEADING DRONE AREA                 
*                                                                               
         XC    0(26,R1),0(R1)      TURN OFF ROUTINE & ARGS                      
         MVI   HDGOVRSW,C'Y'       HEADING OVERRIDE INDICATOR                   
*                                                                               
         CLI   1(R4),2                                                          
         BL    VCOPHDX             HN= CAUSES REMOVAL                           
*                                                                               
         OI    DRHEAD,X'80'        OTHERWISE TURN IT BACK ON                    
         MVC   DRHLITL,1(R4)       PASS LITERAL LENGTH TO DRONE                 
*                                                                               
         CLC   DRHLITL,DRLENO                                                   
         BH    VCOPWIDE            CHECK LITERAL NOT WIDER THAN COLUMN          
*                                                                               
         ZIC   RE,DRHLITL                                                       
         BCTR  RE,0                                                             
         EX    RE,*+8              MOVE IN THE HEADER LITERAL                   
         B     *+10                                                             
         MVC   DRHLIT(0),22(R4)    ** EXECUTED                                  
*                                                                               
VCOPHDX  DS    0H                                                               
*                                                                               
         B     VCOPOPTX                                                         
*                                                                               
         DROP  R1                                                               
*                                                                               
VCOPHDN  DS    0H                                                               
*                                                                               
         CLC   12(3,R4),=C'NP '    OPTION NOT TO PRINT                          
         BNE   VCOPNPN                                                          
*                                                                               
*        NI    DRFLAGO,X'FF'-X'80'                                              
         MVI   DRPOSO,C'N'                                                      
         NI    DRHEAD1,X'FF'-X'80'                                              
         NI    DRHEAD2,X'FF'-X'80'                                              
         NI    DRHEAD3,X'FF'-X'80'                                              
         NI    DRHEAD4,X'FF'-X'80'                                              
         MVC   DRH1LIT,SPACES                                                   
         MVC   DRH2LIT,SPACES                                                   
         MVC   DRH3LIT,SPACES                                                   
         MVC   DRH4LIT,SPACES                                                   
*                                                                               
         B     VCOPOPTX                                                         
*                                                                               
VCOPNPN  DS    0H                                                               
*                                                                               
         CLC   12(3,R4),=C'NT '    OPTION NOT TO TOTAL THIS COLUMN              
         BNE   VCOPNTN                                                          
*                                                                               
         OI    DROPTSO+1,DRNOTOT   TURN ON INDICATOR                            
*                                                                               
         B     VCOPOPTX                                                         
*                                                                               
VCOPNTN  DS    0H                                                               
*                                                                               
         CLC   12(2,R4),=C'R '     RIGHT JUSTIFY OUTPUT                         
         BE    *+10                                                             
         CLC   12(5,R4),=C'RIGHT'  RIGHT JUSTIFY OUTPUT                         
         BNE   VCOPRGTN                                                         
*                                                                               
         OI    DROPTSO,DRALGNRO    TURN ON INDICATOR                            
*                                                                               
         B     VCOPOPTX                                                         
*                                                                               
VCOPRGTN DS    0H                                                               
*                                                                               
         CLC   12(2,R4),=C'U '     USER RECORD                                  
         BNE   VCOP28B1                                                         
*                                                                               
         BRAS  RE,VUSRDRON                                                      
*                                                                               
         B     VCOPOPTX                                                         
*                                                                               
VCOP28B1 DS    0H                                                  L24          
*                                                                               
         BAS   RE,VCOLMXMN                                         L24          
         BNE   VCOP28A                                             L24          
*                                                                               
         B     VCOPOPTX                                            L22          
*                                                                               
VCOP28A  DS    0H                                                               
*                                                                               
VCOPTHO  CLC   12(5,R4),=C'THOU ' THOUSANDS OPTION                              
         BNE   VCOPTHON                                                         
*                                                                               
         MVI   DRDIVO,3            DIVIDE BY A THOUSAND                         
*                                                                               
         B     VCOPOPTX                                            L22          
*                                                                               
VCOPTHON DS    0H                                                               
*                                                                               
         CLC   12(6,R4),=C'(000) ' THOUSANDS OPTION                             
         BNE   VCOP28B                                                          
*                                                                               
         MVI   DRDIVO,5            DIVIDE BY A THOUSAND INCLUDING CENTS         
         MVI   DRDECO,0            NO DECIMALS                                  
*                                                                               
*        ADD (000) TO COLUMN HEADLINES                                          
*                                                                               
         LA    R1,DRH1ALL          FIND FIRST UNUSED HEADLINE                   
         LA    RE,4                MAX 4 HEADLINES                              
*                                                                               
         CLC   DRH1LIT-DRH1ALL(L'DRH1LIT,R1),SPACES USE IF NO LIT YET           
         BNH   *+16                                                             
         LA    R1,L'DRH1ALL(R1)    BUMP TO NEXT HEADLINE                        
         BCT   RE,*-14                                                          
         B     VCOPTHOX            ALL HEADLINES USED                           
*                                                                               
         LA    RF,5                LITERAL LENGTH                               
         CLM   RF,1,DRLENO         DEFAULT TO COLUMN WIDTH                      
         BNH   *+8                                                              
         IC    RF,DRLENO           COLUMN WIDTH                                 
*                                                                               
         STC   RF,DRH1LITL-DRH1ALL(R1) SET HEADLINE LITERAL LENGTH              
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   DRH1LIT-DRH1ALL(0,R1),=C'(000)' ADD TO HEADLINES                 
*                                                                               
         MVC   DRHEAD1-DRH1ALL(L'DRHEAD1,R1),DRHEAD1 COPY STATUS OF 1ST         
*                                                                               
VCOPTHOX DS    0H                                                               
*                                                                               
         B     VCOPOPTX                                                         
*                                                                               
VCOP28B  DS    0H                                                               
*                                                                               
*        ANALYZE FOR FLOWCHARTING                                               
*                                                                               
*        CLI   DRATTRIB,C'$'                                                    
*        BNE   VCOP29                                                           
*                                                                               
         CLC   12(2,R4),=C'MAT'    SKIP IF MATCHED FILTER                       
         BE    VCOP29                                                           
*                                                                               
         CLC   =C'WK',12(R4)       SKIP IF PRINTING WEEK OF/BFD IND             
         BE    VCOP29                                                           
*                                                                               
         CLI   12(R4),C'Y'         YEARLY    TOTAL                              
         BE    VCOP28S                                                          
         CLI   12(R4),C'Q'         QUARTERLY TOTAL                              
         BE    VCOP28S                                                          
         CLI   12(R4),C'M'         MONTHLY TOTALS                               
         BE    VCOP28S                                                          
         CLI   12(R4),C'W'         WEEKLY TOTALS                                
         BNE   VCOP29                                                           
*                                                                               
VCOP28S  CLI   13(R4),C'1'                                                      
         BL    VCOPNOTV                                                         
*                                                                               
         CLI   DRATTRIB,C'$'        IF NOT NUMERIC FIELD                        
         BE    *+20                                                             
         CLI   STACKSW,0            AND STACKING                                
         JE    VCOPKFNV                                                         
         CLI   MYLABEL,C'A'         THEN MUST BE 1ST COLUMN                     
         JNE   VCOPKFNV                                                         
*                                                                               
         MVC   PBQ$DTYP,12(R4)       MOVE $ DATE TYPE                           
*                                                                               
         L     RF,PDADATES                                                      
         SR    RE,RE                                                            
         MVI   FCHRTITR,0            INITIALIZE                                 
***      =================  ***                                                 
         USING DATELSTD,RF                                                      
***      =================  ***                                                 
         CLI   EXPLIST,0       HAVE DATE TABLES BEEN CONSTRUCTED                
         BE    VCOP15T                                                          
*                                                                               
         LA    RE,4                                                             
*                                                                               
VCOP15T  L     RF,PPEREX                                                        
         GOTO1 (RF),DMCB,(RE),RR=VCLRELO                                        
***      =================  ***                                                 
         L     RF,PDADATES                                                      
         USING DATELSTD,RF                                                      
***      =================  ***                                                 
         CLI   EXPLIST,255                                                      
         BNE   VCOP16                                                           
*                                                                               
         GOTO1 CURSERR                                                          
         DROP  RF                                                               
*                                                                               
VCOP16   DS    0H                                                               
*                                                                               
         GOTOR RNGCHK              MAKE SURE REQUEST DATES COVER RANGE          
*                                                                               
         B     VCOPOPTX                                                         
*                                                                               
VCOP29   CLC   12(4,R4),=C'DIV '   DIVIDE OPTION                                
         BNE   VCOP30                                                           
*                                                                               
         TM    3(R4),X'80'                                                      
         BZ    VCOPNOTV                                                         
*                                                                               
         MVI   DRDIVO,1                                                         
         XR    RF,RF                                                            
         ICM   RF,7,9(R4)                                                       
*                                                                               
         CH    RF,=H'10'                                                        
         BE    VCOPOPTX                                                         
*                                                                               
         MVI   DRDIVO,2                                                         
         CH    RF,=H'100'                                                       
         BE    VCOPOPTX                                                         
*                                                                               
         MVI   DRDIVO,3                                                         
         CH    RF,=H'1000'                                                      
         BE    VCOPOPTX                                                         
*                                                                               
         MVI   DRDIVO,4                                                         
         CH    RF,=H'10000'                                                     
         BE    VCOPOPTX                                                         
*                                                                               
         MVI   DRDIVO,5                                                         
         C     RF,=F'100000'                                                    
         BE    VCOPOPTX                                                         
*                                                                               
         B     VCOPNOTV                                                         
*                                                                               
VCOP30   CLC   12(8,R4),=C'BRACKET '   (NUMBERS) BRACKET POS AND NEG            
         BNE   VCOP32                                                           
*                                                                               
         OI    DROPTSO,DRBKMINO                                                 
*                                                                               
         CLI   22(R4),C'M'              ELIMINATE FLOAT                         
         BNE   VCOPOPTX                                                         
*                                                                               
         NI    DROPTSO,X'DF'            DO NOT NEED MINUS =                     
*                                                                               
         CLI   DRFLOATO,C'-'                                                    
         BNE   VCOPOPTX                                                         
*                                                                               
         MVI   DRFLOATO,0                                                       
*                                                                               
         B     VCOPOPTX                                                         
*                                                                               
VCOP32   CLC   12(4,R4),=C'DEC '   DECIMAL PLACES                               
         BNE   VCOP33                                                           
*                                                                               
         TM    3(R4),X'80'                                                      
         BZ    VCOPNOTV                                                         
*                                                                               
         MVC   DRDECO,11(R4)                                                    
*                                                                               
         B     VCOPOPTX                                                         
*                                                                               
VCOP33   CLC   12(4,R4),=C'CUME'     ACCUMULATE                   L09           
         BNE   VCOP34                                             L09           
*                                                                               
         CLI   DRATTRIB+1,C'$'       FOR COMPUTE                  L09           
         BE    VCOP33A                                            L09           
*                                                                               
         CLI   DRATTRIB,C'$'       MUST BE DOLLARS                L09           
         BNE   VCOP34                                             L09           
*                                                                               
VCOP33A  OI    DROPTSO+1,DRCUME                                   L09           
*                                                                               
         B     VCOPOPTX                                           L09           
*                                                                               
VCOP34   DS    0H                                                 L12           
*                                                                               
         CLC   12(4,R4),=C'LIVE'                                  L12           
         BNE   *+12                                                             
         OI    DRARGSI+5,X'04'                                                  
         B     VCOP34A                                            L12           
*                                                                               
         CLC   12(4,R4),=C'TEST'                                  L12           
         BNE   VCOP35                                             L12           
         OI    DRARGSI+5,X'08'                                                  
*                                                                               
VCOP34A  DS    0H                                                               
*                                                                               
         CLI   DRNARGSI,6                                         L12           
         BH    *+8                                                L12           
         MVI   DRNARGSI,6                                         L12           
*                                                                               
         MVI   PBQTEST,C'Y'        FORCE TO GET TEST BUYS         L12           
         CLI   DRATTRIB,C'$'       M/B $ ATTRIB                   L12           
         BE    VCOPOPTX                                           L12           
*                                                                               
         CLI   DRATTRIB+1,C'$'     M/B $ ATTRIB                   L12           
         BNE   VCOPNOTV                                           L12           
*                                                                               
         B     VCOPOPTX                                           L12           
*                                                                               
VCOP35   DS    0H                                                               
*                                                                     *         
*        CHECK FOR COLUMN FILTERS VIA DDVAL                           *         
*                                                                     *         
VCOPFLT  DS    0H                                                               
*                                                                               
         GOTOR CFLTVAL             VALIDATE FILTERS                             
*                                                                               
         OC    CFLTQTIC,CFLTQTIC   CHECK FOR ERRORS                             
         BZ    VCOP90                                                           
*                                                                               
         L     R5,AVLTAB           POINT TO RETURNED TABLE                      
         USING VLTABD,R5           ESTABLISH TABLE ENTRY                        
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,3,VLTICODE       GET INTERNAL CODE                            
*                                                                               
*        COMMA=Y/N                                                              
*                                                                               
         CHI   RF,PRQCFCMA         IF COMMA=Y/N OPTION                          
         BNE   VCOPCMAN                                                         
*                                                                               
         CLI   1(R4),0                NO ENTRY NOT VALID                        
         BE    VCOPFMYN                                                         
*                                                                               
         CLI   22(R4),C'Y'            Y - OKAY                                  
         BNE   *+12                                                             
         OI    DROPTSO,DRCOMMAO       SET INDICATOR                             
         B     VCOPOPTX                                                         
*                                                                               
         CLI   22(R4),C'N'            ERROR IF NOT N                            
         BNE   VCOPFMYN                                                         
*                                                                               
         NI    DROPTSO,X'FF'-DRCOMMAO   ELSE TURN OFF INDICATOR                 
*                                                                               
         B     VCOPOPTX                                                         
*                                                                               
VCOPCMAN DS    0H                                                               
*                                                                               
*        ADDITIONAL CHARGES                                                     
*                                                                               
         LA    RE,PRQCFACH         QUALIFIER TYPE                               
         CLM   RE,3,CFLTQTIC       CHECK FOR ANY ACHG OPTIONS                   
         BNE   VCOPACHN                                                         
*                                                                               
         OI    PBQACHGS,PBQACOPQ      INDICATE ADDL CHG OPT IN EFFECT           
*                                                                               
         B     VCOPOPTX                                                         
*                                                                               
VCOPACHN DS    0H                                                               
*                                                                               
         CHI   RF,PRQCFABS             IF ABSOLUTE VALUE                        
         BNE   VCOPFLT1                                                         
         CLC   DRENTRYI,=CL8'COMPUTE'     MUST BE A COMPUTE STATEMENT           
         BNE   VCOPNOTV                                                         
         OI    DROPTSO+1,DROPABSO            SET INDICATOR                      
*                                                                               
         B     VCOPOPTX                                                         
*                                                                               
VCOPFLT1 DS    0H                                                               
*                                                                               
         CHI   RF,PRQCFAOR             IF AOR ONLY                              
         BNE   *+12                                                             
         OI    DRARGSI+5,X'80'            SET INDICATOR                         
         B     VCOPOPTX                                                         
*                                                                               
         CHI   RF,PRQCFNAR             IF AOR EXCLUDED                          
         BNE   *+12                                                             
         OI    DRARGSI+5,X'40'            SET INDICATOR                         
         B     VCOPOPTX                                                         
*                                                                               
         CHI   RF,PRQCFGSI             IF INPUT GST                             
         BE    *+8                                                              
         CHI   RF,PRQCFPSI             IF INPUT PST                             
         BNE   VCOPFLIX                                                         
*                                                                               
         CLI   DRATTRIB,C'$'          MUST BE A MONEY FIELD                     
         BNE   VCOPIGER                                                         
         TM    DRATTRIB+1,X'80'       AND INVOLVE INPUT GST                     
         BNO   VCOPIGER                                                         
*                                                                               
         OI    DRARGSI+5,X'20'            SET INDICATOR                         
*                                                                               
         B     VCOPOPTX                                                         
*                                                                               
VCOPFLIX DS    0H                                                               
*                                                                               
         CHI   RF,PRQCFGSO             IF OUTPUT GST                            
         BE    *+8                                                              
         CHI   RF,PRQCFPSO             IF OUTPUT PST                            
         BNE   VCOPFLON                                                         
*                                                                               
         CLI   DRATTRIB,C'$'          MUST BE A MONEY FIELD                     
         BNE   VCOPOGER                                                         
         TM    DRATTRIB+1,X'40'       AND INVOLVE OUTPUT GST                    
         BNO   VCOPOGER                                                         
*                                                                               
         OI    DRARGSI+5,X'10'            SET INDICATOR                         
*                                                                               
         B     VCOPOPTX                                                         
*                                                                               
VCOPFLON DS    0H                                                               
*                                                                               
         CHI   RF,PRQCFTRM              IF TRIMMING DECIMALS                    
         BNE   VCOPTRMN                                                         
*                                                                               
         OI    DROPTSO+1,DRTRMDEC         SET INDICATOR                         
*                                                                               
         B     VCOPOPTX                                                         
*                                                                               
VCOPTRMN DS    0H                                                               
*                                                                               
         CHI   RF,PRQCFPBL              IF NOT PRINTING ZERO FIELDS             
         BNE   VCOPPBLN                                                         
*                                                                               
         NI    DROPTSO,X'FF'-DRZEROO      SET INDICATOR                         
*                                                                               
         B     VCOPOPTX                                                         
*                                                                               
VCOPPBLN DS    0H                                                               
*                                                                               
         B     VCOPOPTX                                                         
*                                                                               
         DROP  R5                                                               
*                                                                               
VCOP90   B     VCOPNOTV                                                         
*                                                                               
VCOPOPTX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
PPEREX   DC    A(PEREXP)                                                        
*                                                                               
VCOPNOTV DS    0H                  INVALID COLUMN ENTRY                         
         MVI   ERROR,PWECOLNV                                                   
         B     VCOPERR                                                          
*                                                                               
VCOPWIDE DS    0H                  HEADING OVERRIDE TOO WIDE                    
         MVI   ERROR,PWEHDWID                                                   
         B     VCOPERR                                                          
*                                                                               
VCOPKFNV DS    0H                  KEYWORD NOT AVAILABLE FOR FLOWCHART          
         MVI   ERROR,PWEKWFNV                                                   
         B     VCOPERR                                                          
*                                                                               
VCOPFMYN DS    0H                  FORMAT OPTION MUST BE Y/N                    
         MVI   ERROR,PWEFMTYN                                                   
         B     VCOPERR                                                          
*                                                                               
VCOPIGER DS    0H                  FIELD NOT VALID FOR GST                      
         MVI   ERROR,PWEIGSTX                                                   
         B     VCOPERR                                                          
*                                                                               
VCOPOGER DS    0H                  FIELD NOT VALID FOR OUTPUT GST               
         MVI   ERROR,PWEOGSTX                                                   
         B     VCOPERR                                                          
*                                                                               
VCOPERR  DS    0H                                                               
*                                                                               
         GOTO1 CURSERR                                                          
*                                                                               
       ++INCLUDE DDVALMNMX                                                      
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'PRWRIGEN - VALIDATE COLUMN - VUSRDRON'                          
***********************************************************************         
*                                                                     *         
*        VALIDATE USER RECORD                                         *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
VUSRDRON NTR1  BASE=*,LABEL=*                  VALIDATE USER RECORD             
*                                                                               
         MVI   DRACTION,DRUSER                                                  
         MVC   DRUSRKEY(2),PBQAGY               KEY IS AGENCY                   
         MVC   DRUSRKEY+2(8),22(R4)              AND USER CODE                  
*                                                                               
         GOTO1 DRONE,DMCB,DRGEN                                                 
*                                                                               
         CLI   DRERROR,0                                                        
         BNE   VUSRNOTF                                                         
*                                                                               
         TM    DROPTSO,DRBKMINO    IF BRACKET=M SPECIFIED                       
         BNO   VUSRDROX                                                         
*                                                                               
         NI    DROPTSO,X'DF'       NON'T NEED MUNUS=YES                         
*                                                                               
         CLI   DRFLOATO,C'-'                                                    
         BNE   VUSRDROX                                                         
*                                                                               
         MVI   DRFLOATO,0          OR FLOAT=-                                   
*                                                                               
         B     VUSRDROX                                                         
*                                                                               
VUSRNOTF DS    0H                  USER RECORD NOT FOUND                        
*                                                                               
         MVI   ERROR,PWEUSRNF                                                   
         GOTO1 CURSERR                                                          
*                                                                               
VUSRDROX DS    0H                  USER RECORD NOT FOUND                        
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
*                                                                               
         EJECT                                                                  
*                                                                               
* ROUTINE TO PUT IN PERIOD HEADING SUPPORT                                      
*                                                                               
PERPOP   NTR1  BASE=*,LABEL=*                                                   
         CLI   DRNARGSI,16         WAS A PERIOD SPECIFIED?                      
         BNE   CK4CUME                                                          
         CLI   DRARGSI+15,0        SKIP IF NO DATE TYPE                         
         BE    CK4CUME                                                          
         LA    R1,DRHEAD1          YES - PUT PERIOD EXPRESSION                  
         TM    0(R1),X'80'               INTO HEAD1                             
         BZ    PERPOP2                                                          
         MVC   DRHEAD4(64),DRHEAD3       HEAD1 ALREADY DEFINED -                
         MVC   DRHEAD3(64),DRHEAD2       THEN SHUFFLE THE HEADS DOWN            
         MVC   DRHEAD2(64),DRHEAD1                                              
         XC    DRHEAD1(64),DRHEAD1                                              
*                                                                               
PERPOP2  OI    0(R1),X'80'                                                      
         MVC   1(8,R1),=CL8'HPER'                                               
         MVC   9(4,R1),DRARGSI+12  PASS A(PERIOD S/E)                           
         MVI   25(R1),4            N'ARGUMENTS IS 4                             
         B     PEROPX                                                           
*                                                                               
CK4CUME  DS    0H                                                 L09           
         TM    DRARGSI+5,X'08'   TEST                             L12           
         BO    CK4CUMEA                                           L12           
         TM    DRARGSI+5,X'04'   LIVE                             L12           
         BO    CK4CUMEA                                           L12           
         TM    DROPTSO+1,DRCUME                                   L09           
         BNO   PEROPX                                             L09           
CK4CUMEA CLI   HDGOVRSW,C'Y'             HEADING OVERRIDE         L09           
         BE    PEROPX                                             L09           
         MVC   DRHEAD4(64),DRHEAD3       HEAD1 ALREADY DEFINED -  L09           
         MVC   DRHEAD3(64),DRHEAD2       THEN SHUFFLE THE HEADS DOWN            
         MVC   DRHEAD2(64),DRHEAD1                                L09           
         MVC   DRH1LIT,=CL24'CUME'                                L09           
         MVI   DRH1LITL,4                                         L09           
         TM    DRARGSI+5,X'08'   TEST                             L12           
         BNO   CK4CUMEB                                           L12           
         MVC   DRH1LIT,=CL24'TEST'                                L12           
         B     PEROPX                                             L12           
*                                                                               
CK4CUMEB TM    DRARGSI+5,X'04'   LIVE                             L12           
         BNO   *+10                                               L12           
         MVC   DRH1LIT,=CL24'LIVE'                                L12           
         B     PEROPX                                             L09           
*                                                                               
PEROPX   DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         EJECT                                                                  
* ROUTINE TO FIGURE OUT EDITS FOR COMPUTES                                      
*                                                                               
COMPEDIT NTR1  BASE=*,LABEL=*                                                   
         ZIC   R1,0(R4)            PICK UP EXPRESSION LENGTH                    
         LA    R1,10(R1,R4)                                                     
         CLI   0(R1),C'%'          IS LAST OPERATOR PERCENT?                    
         BE    COMPPCT                                                          
         CLI   0(R1),C'I'          OR INDEX?                                    
         BE    COMPINX                                                          
         BCTR  R1,0                                                             
         CLI   0(R1),C'V'          OR VERTICAL PERCENT                          
         BE    COMPPCT                                                          
         LA    RF,8(R2)            RF=A(START OF INPUT STRING)                  
         ZIC   R0,5(R2)            R0=LENGTH OF INPUT STRING                    
         BAS   RE,CMPEDFND         ELSE LOOK FOR FIRST OPERAND                  
         BE    *+12                                                             
         MVI   DRDECO,X'FF'        SET ERROR FLAG                               
         B     COMPEDTX                                                         
*                                                                               
         OI    DROPTSO,DRCOMMAO    DEFAULT TO PRINTING WITH COMMAS              
*                                                                               
         TM    PBQOPTS,PBQOXCMA    IF COMMAS EXCLUDED                           
         BNO   *+8                                                              
         NI    DROPTSO,X'FF'-DRCOMMAO      PRINT NUMBER WITHOUT COMMAS          
*                                                                               
         MVC   DRDECO,1(R1)        PICK UP ITS EDIT CHARACTERISTIC              
         MVC   DRDIVO,2(R1)                                                     
*                                                                               
         CLI   1(RF),C'/'          TEST DIVIDE                                  
         BNE   COMPEDTX                                                         
         LA    RF,2(RF)            YES-PICK UP DIVIDOR'S EDIT                   
         SH    R0,=H'2'                CHARACTERISTIC                           
         BNP   COMPEDTX                                                         
         BAS   RE,CMPEDFND                                                      
         BNE   COMPEDTX                                                         
         CLI   1(R1),1             TEST FOR DEC=1                               
         BNE   COMPEDTX                                                         
         SR    RE,RE                                                            
         ICM   RE,1,DRDECO         YES-ONE LESS DECIMAL PLACE FOR               
         BZ    COMPEDTX                RESULT                                   
         BCTR  RE,0                                                             
         STC   RE,DRDECO                                                        
         B     COMPEDTX                                                         
*                                                                               
COMPPCT  MVI   DRDECO,2            PERCENTS HAVE 2 DEC                          
         MVI   DRTRAILO,C'%'       AND END WITH PERCENT SIGN                    
         B     COMPEDTX                                                         
*                                                                               
COMPINX  MVI   DRDECO,0            INDEXES HAVE 0 DEC                           
         B     COMPEDTX                                                         
         SPACE 2                                                                
CMPEDFND DS    0H                                                               
         L     R1,=A(EDITLIST-SYSD)                                             
         LA    R1,0(R1,R9)                                                      
CMPEDFN2 CLI   0(R1),0                                                          
         BNE   CMPEDFN4                                                         
         LA    RF,1(RF)                                                         
         BCT   R0,CMPEDFND                                                      
         LTR   RE,RE               NO VARIABLES IN INPUT STRING                 
         BR    RE                                                               
CMPEDFN4 CLC   0(1,R1),0(RF)                                                    
         BER   RE                                                               
         LA    R1,4(R1)                                                         
         B     CMPEDFN2                                                         
*                                                                               
COMPEDTX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'PRWRIGEN - VALIDATE COLUMN FILTERS - CFLTVAL'                   
***********************************************************************         
*                                                                     *         
*        USE DDVAL TO VALIDATE COLUMN FILTERS                         *         
*                                                                     *         
*NTRY    R4 ==>   SCANNER BLOCK                                       *         
*                                                                     *         
*EXIT    CFLTQTIC - INTERNAL CODE FOR COLUMN FILTER                   *         
*                   NULLS IF INVALID FILTER                           *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
CFLTVAL  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING SPOOLD,R8                                                        
         USING GEND,RC                                                          
         USING SYSD,R9                                                          
         USING T405FFD,RA                                                       
*                                                                               
         XC    CFLTQTIC,CFLTQTIC   INIT FILTER INTERNAL CODE                    
*                                                                               
***********************************************************************         
*                                                                     *         
*        CHECK FOR COLUMN FILTERS VIA DDVAL                           *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
CFLVFLT  DS    0H                                                               
*                                                                               
*        INIT VLBLOCK FOR DDVAL                                                 
*                                                                               
         SR    R0,R0                                                            
         IC    R0,0(R4)            GET FILTER LENGTH                            
*                                                                               
         LA    RF,12(R4)           POINT TO START OF FILTER                     
*                                                                               
         CLI   0(RF),C'-'          IF FILTER STARTS WITH MINUS SIGN             
         BNE   *+10                                                             
         LA    RF,1(RF)               BUMP TO START OF FILTER                   
         BCTR  R0,0                   DECREMENT FILTER LENGTH                   
*                                                                               
         MVC   CFLTQTIC,=AL2(PRQWRCFL)   INIT FILTER INTERNAL CODE              
*                                                                               
         L     R1,AVLPARMS                                                      
*                                                                               
         GOTO1 VDDVAL,(R1),('VLPVALQ',=AL2(PRQWRCFL)),                 X        
               ((R0),0(RF)),AVLTAB,0,0,0                                        
*                                                                               
         CLI   VLPERR,0            CHECK FOR ERRORS                             
         BNE   CFLVERR                                                          
*                                                                               
         L     RF,AVLTAB           POINT TO RETURNED TABLE ENTRY                
*                                                                               
         TM    VLTIND-VLTABD(RF),VLTCHLDQ SKIP IF ENTRY HAS NO CHILDREN         
         BNO   CFLVFLT1                                                         
*                                                                               
         MVC   CFLTQTIC,VLTICODE-VLTABD(RF)    SAVE FILTER TYPE                 
*                                                                               
         CLI   22(R4),C'+'          IF HELP REQUESTED                           
         BE    *+8                                                              
         CLI   22(R4),C'?'          IF HELP REQUESTED                           
         BE    *+8                                                              
         BNE   CFLVHLPX                                                         
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,3,CFLTQTIC       GET FILTER TYPE                              
*                                                                               
         CHI   RF,PRQCFACH         IF ADDITIONAL CHARGES                        
         BNE   *+12                                                             
         LA    RF,=AL2(PRQHMACH)      SET HELP MENU ID                          
         B     CFLVHLP1                                                         
*                                                                               
         B     CFLVHLPX            UNKNOWN - IGNORE                             
*                                                                               
CFLVHLP1 DS    0H                                                               
*                                                                               
         GOTO1 VPRHELP,DMCB,(RF),(R2),HELPCBLK SHOW HELP MENU                   
*                                     FOR OPTIONS                               
         DC    H'0'                SHOULD NOT COME BACK                         
*                                                                               
CFLVHLPX DS    0H                                                               
*                                                                               
         SR    R0,R0                                                            
         IC    R0,1(R4)            GET FILTER LENGTH                            
*                                                                               
         LA    RF,22(R4)           POINT TO START OF FILTER                     
*                                                                               
         CLI   0(RF),C'-'          IF FILTER STARTS WITH MINUS SIGN             
         BNE   *+10                                                             
         LA    RF,1(RF)               BUMP TO START OF FILTER                   
         BCTR  R0,0                   DECREMENT FILTER LENGTH                   
*                                                                               
         CLC   CFLTQTIC,=AL2(PRQCFSMD) SKIP IF SUBMEDIA                         
         JE    CFLVFLT1                                                         
*                                                                               
         L     R1,AVLPARMS                                                      
         GOTO1 VDDVAL,(R1),('VLPVALQ',CFLTQTIC),                       X        
               ((R0),(RF)),AVLTAB,0,0,0                                         
*                                                                               
         CLI   VLPERR,0            SKIP IF NO ERRORS                            
         JE    CFLVFLT1                                                         
*                                                                               
         SR    RF,RF               GET INTERNAL CODE FOR FILTER TYPE            
         ICM   RF,3,CFLTQTIC                                                    
*                                                                               
         CHI   RF,PRQCFACH         ERROR IF NOT ADDL CHARGES FILTER             
         JNE   CFLVERR                                                          
*                                                                               
*        ADDITIONAL CHARGES COLUMN FILTER                                       
*                                                                               
CFLVACH  DS    0H                                                               
*                                                                               
*        ASSUME CODE FOR SINGLE ADDITIONAL CHARGE                               
*                                                                               
         CLI   1(R4),0             MUST HAVE A CODE                             
         JE    CFLVERR                                                          
*                                                                               
         CLI   1(R4),L'PBQACHG     MAX LENGTH OF ACHRG CODE                     
         JH    CFLVERR                                                          
*                                                                               
         MVC   WORK(2),22(R4)      SAVE CHARGE CODE                             
         OC    WORK(2),SPACES      SPACE FILL                                   
*                                                                               
         CLC   =C'FX',WORK         FX - SPECIAL CHARGE CODE FOR                 
         BE    CFVACDFD               EVERYONE                                  
*                                                                               
         XC    KEY,KEY                                                          
         LA    R6,KEY              ESTABLISH ADDITIONAL CHARGES REC             
         USING PSPLRECD,R6                                                      
*                                                                               
         MVC   PSPLKAGY,AGENCY     SET AGENCY                                   
         MVI   PSPLKRCD,PSPLKIDQ   SET RECORD CODE                              
*                                                                               
         BRAS  RE,CLTMED           FIND FIRST MEDIA                             
*                                                                               
CFVMEDLP DS    0H                                                               
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(25),KEYSAVE     TEST IF RECORD FOUND                         
         JE    CFVMEDFD                                                         
*                                                                               
CFVMEDCN DS    0H                                                               
*                                                                               
         MVC   KEY,KEYSAVE         RESTORE STARTING KEY                         
*                                                                               
         BRAS  RE,CLTMED           FIND NEXT MEDIA                              
         JE    CFVMEDLP                                                         
*                                                                               
CFVMEDDN DS    0H                                                               
         J     CFLVERR                                                          
*                                                                               
CFVMEDFD DS    0H                                                               
*                                                                               
         MVC   AIO,AIO1            READ INTO IOAREA1                            
*                                                                               
         GOTO1 GETREC              READ RECORD                                  
*                                                                               
         MVI   ELCODE,X'10'        SET CHARGE CODE ELM ID                       
         L     R5,AIO              POINT TO FOUND RECORD                        
         BRAS  RE,GETEL            KIND FIRST ELEMENT                           
         JNE   CFLVERR             NONE FOUND                                   
*                                                                               
CFVACDLP DS    0H                                                               
*                                                                               
         USING PSPLELEM,R5         ESTABLISH CHARGE ELEMENT                     
*                                                                               
         CLC   PSPLCODE,WORK       MATCH ON CHARGE CODE                         
         JE    CFVACDFD                                                         
*                                                                               
CFVACDCN DS    0H                                                               
         BRAS  RE,NEXTEL           FIND NEXT ELEMENT                            
         JE    CFVACDLP                                                         
*                                                                               
         J     CFLVERR             CODE NOT FOUND                               
*                                                                               
CFVACDFD DS    0H                  CODE IS VALID                                
*                                                                               
         L     R5,AVLTAB           POINT TO RETURNED TABLE                      
         USING VLTABD,R5           ESTABLISH TABLE ENTRY                        
*                                                                               
         MVC   VLTICODE,=AL2(PRQACONE) SET TO SINGLE ADDL CHARGE                
         MVC   VLTEXTRA(2),WORK    SAVE ADDL CHARGE CODE                        
*                                                                               
CFLVFLT1 DS    0H                                                               
*                                                                               
         L     R5,AVLTAB           POINT TO RETURNED TABLE                      
         USING VLTABD,R5           ESTABLISH TABLE ENTRY                        
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,3,VLTICODE       GET FILTER CODE                              
*                                                                               
         CHI   RF,PRQCFNDT         IF SUPPRESS FILTER                           
         BNE   *+8                                                              
         OI    PBQCFOPT,PBQCFNDQ           SET OPTION IN WORKAREA               
*                                                                               
         CHI   RF,PRQCFND          IF NO DETAILS FILTER                         
         BNE   *+12                                                             
         OI    DROPTSO+1,DRNODET           SET OPTION                           
         B     CFLVFHDX                    SKIP PUTTING IN HEADS                
*                                                                               
         CHI   RF,PRQCFCMA              IF COMMAS=Y/N                           
         BE    CFLVFHDX                    SKIP PUTTING IN HEADS                
*                                                                               
         CHI   RF,PRQCFCT               IF COUNT OPTION                         
         BNE   *+12                                                             
         OI    PBQCFOPT,PBQCFCTQ           SET OPTION IN WORKAREA               
         B     CFLVFHDX                    SKIP PUTTING IN HEADS                
*                                                                               
         CHI   RF,PRQCFPGE              IF PAGE  OPTION                         
         BNE   *+12                                                             
         OI    PBQCFOPT,PBQCFPAQ           SET OPTION IN WORKAREA               
         B     CFLVFHDX                    SKIP PUTTING IN HEADS                
*                                                                               
         CHI   RF,PRQCFADD              SKIP AVG DAYS TO DISBURSE               
         BE    CFLVFHDX                                                         
*                                                                               
         CHI   RF,PRQCFNAD              SKIP NONADD CASHFLOW                    
         BE    CFLVFHDX                                                         
*                                                                               
         CHI   RF,PRQCFMAJ              SKIP MAJOR STACK FIELD                  
         BE    CFLVFHDX                                                         
*                                                                               
         CHI   RF,PRQCFPBL              SKIP DON'T PRINT ZEROS                  
         BE    CFLVFHDX                                                         
*                                                                               
         CHI   RF,PRQCFOUT              OUTLET= HANDLED SEPARATELY              
         BE    CFLVFOUT                                                         
*                                                                               
         CHI   RF,PRQCFSMD              SUBMEDIA FILTER                         
         BNE   CFLVSMDN                                                         
*                                                                               
         ICM   R0,1,PBQSMD         SAVE CURRENT SUBMEDIA CODE                   
         GOTOR SMDVAL              VALIDATE SUBMEDIA CODE                       
         MVC   VLTEXTRA(1),PBQSMD  SAVE SUBMEDIA FILTER                         
         OI    VLTEXTRA,X'40'      UNDO NEGATIVE INDICATOR                      
         STCM  R0,1,PBQSMD         RESTORE OLD SUBMEDIA CODE                    
         B     CFLVFHD             ADD TO HEADLINES                             
*                                                                               
CFLVSMDN DS    0H                                                               
*                                                                               
         CHI   RF,PRQCFISN              ISSUE NAME - LIMITED USE                
         BNE   CFLVISNN                                                         
*                                                                               
         CLC   =C'IINDATE ',DRRTNI        VALID ONLY FOR INSDATE KYWDS          
         BNE   CFLVISNE                                                         
*                                                                               
         CLI   DRLENO,13                  MUST HAVE LARGE ENOUGH OUTPUT         
         BL    CFLVISNE                                                         
*                                                                               
         SR    RF,RF               ADD 9 TO INPUT LENGTH                        
         IC    RF,DRLENI                                                        
         LA    RF,9(RF)                                                         
         STC   RF,DRLENI                                                        
*                                                                               
         B     CFLVFHDX                   ELSE DON'T PUT IN HEADLINES           
*                                                                               
CFLVISNN DS    0H                                                               
*                                                                               
*        ADD FILTER TO COLUMN HEADLINES                                         
*                                                                               
CFLVFHD  DS    0H                                                               
*                                                                               
         LA    R1,DRH1ALL          FIND FIRST UNUSED HEADLINE                   
         LA    R0,4                MAX 4 HEADLINES                              
*                                                                               
         CLC   DRH1LIT-DRH1ALL(L'DRH1LIT,R1),SPACES USE IF NO LIT YET           
         BNH   *+16                                                             
         LA    R1,L'DRH1ALL(R1)    BUMP TO NEXT HEADLINE                        
         BCT   R0,*-14                                                          
         B     CFLVFHDX            ALL HEADLINES USED                           
*                                                                               
         SR    RF,RF                                                            
         IC    RF,0(R4)            FILTER ID WIDTH                              
         CLM   RF,1,DRLENO         DEFAULT TO COLUMN WIDTH                      
         BNH   *+8                                                              
         IC    RF,DRLENO           COLUMN WIDTH                                 
*                                                                               
         STC   RF,DRH1LITL-DRH1ALL(R1) SET HEADLINE LITERAL LENGTH              
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   DRH1LIT-DRH1ALL(0,R1),12(R4) ADD TO HEADLINES                    
*                                                                               
         CLI   1(R4),0             SKIP IF NO VALUE FOR ID                      
         BE    CFLVFHD1                                                         
*                                                                               
         LA    RE,DRH1LIT+1-DRH1ALL(RF,R1) NEXT OUTPUT POSITION                 
*                                                                               
         MVC   0(1,RE),SCANSEP     COMPARATIVE OPERATOR                         
         LA    RE,1(RE)            BUMP OUTPUT POINTER                          
*                                                                               
         SR    R7,R7                                                            
         IC    R7,DRLENO           COLUMN WIDTH                                 
         SR    R7,RF               CALCULATE WIDTH LEFT                         
         SH    R7,=H'2'                                                         
*                                                                               
         CLM   R7,1,1(R4)          IF NO ROOM ON CURRENT LINE                   
         BNL   CFLTLITX                                                         
*                                                                               
         CH    R0,=H'1'            AND THERE IS ANOTHER LINE AVAILABLE          
         BNH   CFLTLITX                                                         
*                                                                               
         LA    RF,DRH1LIT-DRH1ALL(R1)                                           
         SR    RE,RF                                                            
         STC   RE,DRH1LITL-DRH1ALL(R1) UPDATE CURRENT HEADLINE LENGTH           
         MVC   DRHEAD1-DRH1ALL(L'DRHEAD1,R1),DRHEAD1 COPY STATUS OF 1ST         
*                                                                               
         LA    R1,L'DRH1ALL(R1)       BUMP TO NEXT LINE                         
         LA    RE,DRH1LIT-DRH1ALL(R1) RESET OUTPUT POSITION                     
         BCTR  R0,0                   DECREMENT LINE COUNTER                    
         IC    R7,DRLENO              USE TOTAL COLUMN WIDTH                    
*                                                                               
CFLTLITX DS    0H                                                               
*                                                                               
         IC    RF,1(R4)            VALUE LENGTH                                 
*                                                                               
         CLI   22(R4),C'-'         IF NEGATIVE FILTER                           
         BNE   *+8                                                              
         AHI   RF,1                   BUMP LENGTH BY ONE                        
*                                                                               
         CR    RF,R7               MAKE SURE IT FITS                            
         BNH   *+6                                                              
         LR    RF,R7                                                            
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RE),22(R4)      DISPLAY VALUE                                
*                                                                               
         LA    RE,2(RF,RE)         NEXT AVAILABLE POSITION                      
         LA    RF,DRH1LIT-DRH1ALL(R1)                                           
         SR    RE,RF               HEADLINE LENGTH                              
         STC   RE,DRH1LITL-DRH1ALL(R1) UPDATE HEADLINE LENGTH                   
*                                                                               
CFLVFHD1 DS    0H                                                               
*                                                                               
         MVC   DRHEAD1-DRH1ALL(L'DRHEAD1,R1),DRHEAD1 COPY STATUS OF 1ST         
*                                                                               
         B     CFLVFHDX                                                         
*                                                                               
*        OUTLET= ADDS HEADLINE ROUTINE TO DRONBLK                               
*                                                                               
CFLVFOUT DS    0H                                                               
*                                                                               
*        FIND EMPTY HEADLINE FOR OUTLET ID                                      
*                                                                               
         TM    3(R4),X'80'         OUTLET MUST BE NUMERIC                       
         BNO   CFLVERR                                                          
*                                                                               
         LA    R1,DRH1ALL          ESTABLISH HEADLINE AREA                      
         USING DRH1ALL,R1                                                       
         LA    R0,4                MAX 4 HEADLINES                              
*                                                                               
         TM    DRHEAD1,X'80'       FIND FIRST EMPTY HEADLINE                    
         BNO   *+16                                                             
         LA    R1,L'DRH1ALL(R1)    BUMP TO NEXT HEADLINE                        
         BCT   R0,*-12                                                          
         B     CFLVFOUX            NO HEADLINE AVAILABLE                        
*                                                                               
         OI    DRHEAD1,X'80'       ACTIVATE HEADLINE                            
         MVC   DRH1RTN,=CL8'HOUTLET'  SET HEADLINE ROUTINE NAME                 
         MVC   DRH1ARGS(1),22(R4)  SAVE OUTLET NUMBER                           
         MVC   DRH1ARGS+6(1),KEYWORD# PASS ALONG KEYWORD NUMBER                 
         MVI   DRH1NARG,16         SET FOR 16 ARGUMENTS                         
*                                                                               
         MVC   CFLTQTIC,=AL2(PRQCFOUT) CHANGE MAJOR FILTER NAME                 
*                                                                               
         DROP  R1                                                               
*                                                                               
         OI    PBQCFOPT,PBQCFOUQ   INDICATE OUTLET FILTER EXISTS                
*                                                                               
CFLVFOUX DS    0H                                                               
*                                                                               
CFLVFHDX DS    0H                                                               
*                                                                               
*        ADD COLUMN FILTER TO COLUMN FILTER SAVEAREA                            
*                                                                               
         MVC   DRARGSI+6(1),KEYWORD# PASS ALONG KEYWORD NUMBER                  
         CLI   DRNARGSI,7          UPDATE NUMBER OF ARGUMENTS IF NEEDED         
         BNL   *+8                                                              
         MVI   DRNARGSI,7                                                       
*                                                                               
         MVC   DRARGSO+6(1),KEYWORD# PASS ALONG KEYWORD NUMBER                  
         CLI   DRNARGSO,7          UPDATE NUMBER OF ARGUMENTS IF NEEDED         
         BNL   *+8                                                              
         MVI   DRNARGSO,7                                                       
*                                                                               
         CLC   =AL2(PRQCFADD),VLTICODE  AVG DAYS TO DISBURSE USES TOTAL         
         BNE   CFLVADTX                                                         
*                                                                               
         OI    DRTOTAL,X'80'       TOTAL KEYWORD                                
         MVC   DRTARGS+6(1),KEYWORD# PASS ALONG KEYWORD NUMBER                  
         CLI   DRTNARGS,7          UPDATE NUMBER OF ARGUMENTS IF NEEDED         
         BNL   *+8                                                              
         MVI   DRTNARGS,7                                                       
*                                                                               
CFLVADTX DS    0H                                                               
*                                                                               
         L     R7,AFLTTAB          POINT TO FILTER SAVEAREAS                    
*                                                                               
         SR    RE,RE                                                            
         IC    RE,KEYWORD#         KEYWORD NUMBER                               
         BCTR  RE,0                DECREMENT FOR INDEXING                       
         LA    RF,FTBENTL          FILTER AREA LENGTH                           
         MR    RE,RE               INDEX INTO FILTER AREA                       
         LA    R7,0(RF,R7)         AREA FOR THIS KEYWORD                        
*                                                                               
         USING FLTTABD,R7          ESTABLISH FILTER SAVEAREA                    
*                                                                               
         CLC   =AL2(PRQCFMAJ),VLTICODE  IF MAJOR STACK FIELD                    
         BNE   *+12                                                             
         OI    DRARGSI+5,X'02'             SET INDICATOR                        
         B     CFLTVALX                                                         
*                                                                               
         USING FLTAREA,R7          ESTABLISH FILTERS SAVEAREA                   
*                                                                               
         LA    R6,FLTCTL           POINT TO FIRST FILTER IN AREA                
*                                                                               
         SR    RE,RE                                                            
         ICM   RE,1,FLTFNO         GET NUMBER OF FILTERS SO FAR                 
         BZ    CFLVFL10                                                         
*                                                                               
         SR    RF,RF                                                            
         USING FLTCTL,R6           ESTABLISH FILTER                             
*                                                                               
         ICM   RF,1,FLTFVLEN       GET LENGTH OF FILTER                         
         LA    R6,FLTFVAL(RF)      BUMP TO NEXT FILTER                          
         BCT   RE,*-8                                                           
*                                                                               
CFLVFL10 DS    0H                                                               
*                                                                               
         SR    RF,RF                                                            
         IC    RF,FLTFNO           ADD ONE TO FILTER COUNTER                    
         LA    RF,1(RF)                                                         
         STC   RF,FLTFNO                                                        
*                                                                               
         L     R1,AVLTAB           POINT TO DDVAL TABLE ENTRY                   
*                                                                               
         MVC   FLTFTIC,CFLTQTIC    SET FILTER TYPE                              
         MVI   FLTCTL,FLTEQQ       SET FOR EQUALITY                             
*                                                                               
         CLI   SCANSEP,C'<'        IF FILTER STARTS WITH '<'                    
         BNE   *+8                                                              
         MVI   FLTCTL,FLTLTQ          SET FOR LESS THAN                         
*                                                                               
         CLI   SCANSEP,C'>'        IF FILTER STARTS WITH '>'                    
         BNE   *+8                                                              
         MVI   FLTCTL,FLTGTQ          SET FOR LESS THAN                         
*                                                                               
         CLI   12(R4),C'-'         IF FILTER STARTS WITH '-'                    
         BE    *+8                                                              
         CLI   22(R4),C'-'                                                      
         BNE   *+8                                                              
         OI    FLTCTL,FLTNOTQ         SET FOR INEQUALITY                        
*                                                                               
         TM    VLTIND-VLTABD(R1),VLTNSLNQ IF STANDARD ICODE                     
         BO    CFLVFL20                                                         
*                                                                               
         MVI   FLTFVLEN,2          FILTER VALUE IS 2 BYTES                      
         MVC   FLTFVAL(2),VLTICODE-VLTABD(R1)  SAVE FILTER VALUE                
*                                                                               
         CLC   CFLTQTIC,=AL2(PRQCFACH) IF ADDL CHARGE FILTER                    
         BNE   CFLVFL18                                                         
*                                                                               
         OI    PBQACHGS,PBQACOPQ   ADDL OPTIONS IN EFFECT                       
*                                                                               
         CLC   VLTICODE,=AL2(PRQACONE) AND IF SINGLE CODE FILTER                
         BNE   CFLVFL18                                                         
*                                                                               
         MVI   FLTFVLEN,4                                                       
         MVC   FLTFVAL+2(2),VLTEXTRA-VLTABD(R1)    SAVE CODE                    
*                                                                               
         B     CFLVFL30                                                         
*                                                                               
CFLVFL18 DS    0H                                                               
*                                                                               
         CLC   CFLTQTIC,=AL2(PRQCFOUT) IF OUTLET FILTER                         
         BNE   CFLVFL19                                                         
*                                                                               
         MVI   FLTFVLEN,1                 FILTER LENGTH IS 1                    
         MVC   FLTFVAL(1),11(R4)          SAVE OUTLET NUMBER                    
         MVI   FLTFVAL+1,0                CLEAR ANY GARBAGE                     
*                                                                               
         B     CFLVFL30                                                         
*                                                                               
CFLVFL19 DS    0H                                                               
*                                                                               
         CLC   CFLTQTIC,=AL2(PRQCFSMD) IF SUBMEDIA FILTER                       
         BNE   CFLVFL1A                                                         
*                                                                               
         MVI   FLTFVLEN,1                 FILTER LENGTH IS 1                    
         MVC   FLTFVAL(1),VLTEXTRA        SAVE SUBMEDIA CODE                    
         MVI   FLTFVAL+1,0                CLEAR ANY GARBAGE                     
*                                                                               
         B     CFLVFL30                                                         
*                                                                               
CFLVFL1A DS    0H                                                               
*                                                                               
         B     CFLVFL30                                                         
*                                                                               
CFLVFL20 DS    0H                                                               
*                                                                               
         MVC   FLTFVLEN,VLTEXTRA-VLTABD(R1)  LENGTH AT VLTEXTRA                 
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,VLTEXTRA-VLTABD(R1) FILTER VALUE LENGTH                     
         BZ    *+6                                                              
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   FLTFVAL(0),VLTEXTRA+1-VLTABD(R1) SAVE FILTER VALUE               
*                                                                               
CFLVFL30 DS    0H                                                               
*                                                                               
         B     CFLTVALX                                                         
*                                                                               
CFLVISNE DS    0H                  ISSUE NAME ERROR                             
         MVI   ERROR,PWEISNNV      NOT APPROPRIATE KEYWORD                      
         GOTO1 CURSERR                                                          
*                                                                               
         DROP  R5                                                               
*                                                                               
CFLVERR  DS    0H                                                               
*                                                                               
         XC    CFLTQTIC,CFLTQTIC   CLEAR FILTER ICODE                           
*                                                                               
CFLTVALX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'PRWRIGEN - VALIDATE CUSTOM COLUMN - CCVAL'                      
***********************************************************************         
*                                                                     *         
*        VALIDATE CUSTOM COLUMN BY READING DESCRIPTIVE RECORD         *         
*                                                                     *         
*NTRY    R4 ==>   SCANNER BLOCK                                       *         
*                                                                     *         
*EXIT             DEONE BLOCK FILLED IN FROM DESCRIPTIVE RECORD       *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
CCVAL    NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING SPOOLD,R8                                                        
         USING GEND,RC                                                          
         USING SYSD,R9                                                          
         USING T405FFD,RA                                                       
*                                                                               
         CLI   1(R4),0             MUST HAVE A CCOL ID                          
         BE    CCVE1                                                            
*                                                                               
         CLI   22(R4),C'!'         IF STANDARD CUSTOM COLUMN                    
         BNE   CCVSTDN                                                          
*                                                                               
*        MUST SWITCH TO CONTROL                                                 
*                                                                               
         CLI   OFFLINE,C'Y'        HANDLE DIFFERENT IF OFF-LINE                 
         BE    CCVOFF                                                           
*                                                                               
         L     RF,ACOMFACS                                                      
         L     RF,CSWITCH-COMFACSD(RF)                                          
         XC    DMCB(8),DMCB                                                     
         MVI   DMCB,X'0A'               CONTROL SYSTEM                          
         GOTO1 (RF),DMCB           SWITCH TO CONTROL SYSTEM                     
         CLI   4(R1),0                                                          
         BE    *+6                                                              
         DC    H'0'                                                             
         B     CCVOFFX                                                          
*                                                                               
CCVOFF   DS    0H                  OPEN CONTROL SYSTEM FILES                    
*                                                                               
         L     RF,PBUTLA               SWITCH TO CONTROL SYSTEM                 
         MVC   DUB(1),4(RF)        SAVE CURRENT SYSTEM ID                       
         MVI   4(RF),X'0A'                                                      
*                                                                               
CCVOFFX DS     0H                                                               
*                                                                               
         XC    KEY,KEY             INIT KEY BUILD AREA                          
         LA    R6,KEY              ESTABLISH AS GCOL KEY                        
         USING GCOLRECD,R6                                                      
*                                                                               
         MVC   GCOLKRID,=AL3(GCOLKRIQ) SET RECORD ID                            
         MVI   GCOLKMED,C'A'       SET MEDIA                                    
         MVI   GCOLKRCD,X'61'      SET RECORD IDENTIFIER                        
         MVC   GCOLKCOD,22(R4)     SET GCOL CODE                                
*                                                                               
         MVC   KEYSAVE,KEY         SAVE KEY                                     
*                                                                               
         GOTO1 DATAMGR,DMCB,=CL8'DMRDHI',=CL8'GENDIR',KEY,KEY,0,0               
*                                                                               
         CLC   GCOLKEY,KEYSAVE     CHECK IF RECORD FOUND                        
         BNE   CCVE2                                                            
*                                                                               
         MVC   AIO,AIO2            READ RECORD INTO IOA2                        
        GOTO1 DATAMGR,DMCB,=CL8'GETREC',=CL8'GENFIL',KEY+36,AIO,DMWORK          
         MVC   AIO,AIO1            RESTORE STANDARD IOA POINTER                 
*                                                                               
         MVI   ELCODE,X'61'        SET TO FIND DESCRIPTION ELEMENT              
         L     R6,AIO2                                                          
         LA    R5,GCOLFRST         POINT TO FIRST ELEMENT                       
         USING PCOLELEM,R5         ESTABLISH DESCRIPTION ELEMENT                
*                                                                               
         SR    RF,RF                                                            
*                                                                               
CCVGLOOP DS    0H                                                               
*                                                                               
         CLI   PCOLELEM,X'61'      FIND DESCRITPION ELEMENT                     
         BE    CCVGFND                                                          
*                                                                               
CCVGCONT DS    0H                                                               
         IC    RF,PCOLELEM+1       GET ELEMENT LENGTH                           
         LA    R5,PCOLELEM(RF)                                                  
         B     CCVGLOOP                                                         
*                                                                               
CCVGDONE DS    0H                                                               
*                                                                               
         B     CCVE2               NO DESCRIPTION AVAILABLE                     
*                                                                               
CCVGFND  DS    0H                                                               
*                                                                               
         CLI   OFFLINE,C'Y'        CHECK FOR OFF-LINE                           
         BE    CCVSOFF                                                          
*                                                                               
         L     RF,ACOMFACS         FORCE SWITCH TO PRINT                        
         L     RF,CSWITCH-COMFACSD(RF)                                          
         GOTO1 (RF),DMCB,=C'PRINT',0                                            
         CLI   4(R1),0                                                          
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         B     CCVSTDX                                                          
*                                                                               
CCVSOFF  DS    0H                                                               
*                                                                               
         L     RF,PBUTLA           RE-POINT TO UTL                              
         MVC   4(1,RF),DUB         RESET TO CURRENT SYSTEM                      
*                                                                               
CCVSTDX  DS    0H                                                               
*                                                                               
         B     CCV10                                                            
*                                                                               
CCVSTDN  DS    0H                                                               
*                                                                               
*        NORMAL CUSTOM COLUMN                                                   
*                                                                               
         XC    KEY,KEY             INIT KEY BUILD AREA                          
         LA    R6,KEY              ESTABLISH AS CCOL RECORD                     
         USING PCOLRECD,R6                                                      
*                                                                               
         MVC   PCOLKAGY,AGENCY     SET AGENCY                                   
         MVI   PCOLKMED,C'A'       SET MEDIA                                    
         MVI   PCOLKRCD,X'61'      SET RECORD IDENTIFIER                        
         MVC   PCOLKCOD,22(R4)     SET CCOL CODE                                
*                                                                               
         GOTO1 HIGH                READ FOR RECORD                              
*                                                                               
         CLC   PCOLKEY,KEYSAVE     CHECK IF RECORD FOUND                        
         BNE   CCVE2                                                            
*                                                                               
         MVC   AIO,AIO2            READ RECORD INTO IOA2                        
         GOTO1 GETREC                                                           
         MVC   AIO,AIO1            RESTORE STANDARD IOA POINTER                 
*                                                                               
         MVI   ELCODE,X'61'        SET TO FIND DESCRIPTION ELEMENT              
         L     R5,AIO2                                                          
*                                                                               
         BRAS  RE,GETEL            LOOK FOR DESCRIPTIVE ELEMENT                 
         BNE   CCVE2               NO DESCRIPTION AVAILABLE                     
*                                                                               
CCV10    DS    0H                                                               
*                                                                               
         USING PCOLELEM,R5         ESTABLISH COLUMN ELEMENT                     
*                                                                               
         MVC   DRARGSI+1(2),PCOLSQN SAVE CCOL SEQ. NUMBER                       
         MVC   DRARGSI+3(1),PCOLTYP SAVE DATA TYPE                              
         MVC   DRARGSO+3(1),PCOLTYP SAVE DATA TYPE                              
         MVC   DRARGSI+4(1),PCOLTOT SAVE TOTALLING OPTION                       
         MVC   DRARGSO+4(1),PCOLTOT SAVE TOTALLING OPTION                       
         MVC   DRDECI,PCOLDECS     SET DECIMALS                                 
         MVC   DRDECO,PCOLDECS     SET DECIMALS                                 
         MVC   DRLENO,PCOLMLEN     SET OUTPUT LENGTH                            
*                                                                               
         CLI   PCOLTOT,C'A'        IF AVERAGE TOTAL                             
         BNE   *+12                                                             
         MVI   DRLENI,16              DOUBLE LENGTH                             
         MVI   DRTYPEI+2,2            INDICATE 2 ARGUMENTS                      
*                                                                               
*        ANALYZE DATATYPE                                                       
*                                                                               
CCVDTTX  DS    0H                                                               
*                                                                               
         CLI   PCOLTYP,C'T'        IF TEXT                                      
         BNE   CCVDTTXN                                                         
*                                                                               
         MVI   DRTYPEI,C'C'           INPUT IS CHARACTER                        
         MVC   DRLENI,PCOLMLEN        INPUT LENGTH IS MAX OUTPUT LENGTH         
         MVI   DRTYPEO,C'C'           OUTPUT IS CHARCTER                        
*                                                                               
         B     CCVDTYPX                                                         
*                                                                               
CCVDTTXN DS    0H                                                               
*                                                                               
CCVDTPC  DS    0H                                                               
*                                                                               
         CLI   PCOLTYP,C'%'        IF %                                         
         BNE   CCVDTPCN                                                         
*                                                                               
         MVI   DRTYPEI,C'P'           INPUT IS PACKED                           
         MVI   DRTYPEI+1,C'-'         NON-ADDITIVE                              
         MVI   DRLENI,8               INPUT LENGTH IS 8                         
         MVI   DRTYPEO,C'N'           OUTPUT IS NUMERIC                         
         MVI   DRTRAILO,C'%'          SET TRAILING CHARACTER                    
         OI    DROPTSO+1,DRNOTOT      NO TOTALLING                              
*                                                                               
         B     CCVDTYPX                                                         
*                                                                               
CCVDTPCN DS    0H                                                               
*                                                                               
CCVDTNM  DS    0H                                                               
*                                                                               
         CLI   PCOLTYP,C'N'        IF NUMERIC                                   
         BNE   CCVDTNMN                                                         
*                                                                               
         MVI   DRTYPEI,C'P'           INPUT IS PACKED                           
         MVI   DRTYPEI+1,C'+'         INPUT IS ADDITIVE                         
         MVI   DRLENI,8               INPUT LENGTH IS 8                         
         MVI   DRTYPEO,C'N'           OUTPUT IS NUMERIC                         
         MVI   DRATTRIB,C'$'          FLOWCHARTABLE                             
*                                                                               
         B     CCVDTYPX                                                         
*                                                                               
CCVDTNMN DS    0H                                                               
*                                                                               
CCVDTDL  DS    0H                                                               
*                                                                               
         CLI   PCOLTYP,C'$'        IF DOLLARS                                   
         BNE   CCVDTDLN                                                         
*                                                                               
         MVI   DRTYPEI,C'P'           INPUT IS PACKED                           
         MVI   DRTYPEI+1,C'+'         INPUT IS ADDITIVE                         
         MVI   DRLENI,8               INPUT LENGTH IS 8                         
         MVI   DRTYPEO,C'N'           OUTPUT IS NUMERIC                         
         MVI   DRATTRIB,C'$'          FLOWCHARTABLE                             
*                                                                               
         B     CCVDTYPX                                                         
*                                                                               
CCVDTDLN DS    0H                                                               
*                                                                               
CCVDTDT  DS    0H                                                               
*                                                                               
         CLI   PCOLTYP,C'D'        IF DATE                                      
         BNE   CCVDTDTN                                                         
*                                                                               
         MVI   DRTYPEI,C'X'           INPUT IS HEX                              
         MVI   DRLENI,3               INPUT LENGTH IS 3                         
*                                                                               
         B     CCVDTYPX                                                         
*                                                                               
CCVDTDTN DS    0H                                                               
*                                                                               
CCVDTPR  DS    0H                                                               
*                                                                               
         CLI   PCOLTYP,C'P'        IF PERIOD                                    
         BNE   CCVDTPRN                                                         
*                                                                               
         MVI   DRTYPEI,C'X'           INPUT IS HEX                              
         MVI   DRLENI,6               INPUT LENGTH IS 6                         
*                                                                               
         B     CCVDTYPX                                                         
*                                                                               
CCVDTPRN DS    0H                                                               
*                                                                               
CCVDTYPX DS    0H                                                               
*                                                                               
*        ANALYZE TOTAL OPTIONS                                                  
*                                                                               
*        HANDLE COLUMN HEADINGS                                                 
*                                                                               
         CLC   PCOLHDR1,SPACES     IF HEADLINE 1 PRESENT                        
         BNH   CCVHD1X                                                          
*                                                                               
         OI    DRHEAD1,X'80'          ACTIVATE HEADLINE 1                       
         MVC   DRH1LIT,PCOLHDR1       SET HEADLINE 1                            
         MVI   DRH1LITL,L'PCOLHDR1    SET HEADER LENGTH                         
*                                                                               
CCVHD1X  DS    0H                                                               
*                                                                               
         CLC   PCOLHDR2,SPACES     IF HEADLINE 2 PRESENT                        
         BNH   CCVHD2X                                                          
*                                                                               
         OI    DRHEAD2,X'80'          ACTIVATE HEADLINE 2                       
         MVC   DRH2LIT,PCOLHDR2       SET HEADLINE 2                            
         MVI   DRH2LITL,L'PCOLHDR2    SET HEADER LENGTH                         
*                                                                               
CCVHD2X  DS    0H                                                               
*                                                                               
CCVALX   DS     0H                                                              
         XIT1                                                                   
*                                                                               
CCVE1    LHI   RF,PWECC1           CUSTOM COLUMN ID MISSING                     
         B     CCVERR                                                           
*                                                                               
CCVE2    LHI   RF,PWECC2           CUSTOM COLUMN UNKNOWN                        
         B     CCVERR                                                           
*                                                                               
CCVERR   DS    0H                                                               
*                                                                               
         USING GETTXTD,GETTXTCB    ESTABLISH GETTXT CONTROL BLOCK               
*                                                                               
         STCM  RF,3,GTMSGNO        SET ERROR MESSAGE NUMBER                     
*                                                                               
         GOTO1 CURSERR                                                          
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'PRWRIGEN - VALIDATE COMMENT KEYWORD - COMVAL'                   
***********************************************************************         
*                                                                     *         
*        VALIDATE COMMENT KEYWORD BY FINDING IT ON FILE               *         
*                                                                     *         
*NTRY    R4 ==>   SCANNER BLOCK                                       *         
*                                                                     *         
*EXIT                                                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
COMVAL   NMOD1 0,**#CMV                                                         
*                                                                               
         USING SPOOLD,R8                                                        
         USING GEND,RC                                                          
         USING SYSD,R9                                                          
         USING T405FFD,RA                                                       
*                                                                               
         LA    RC,SPOOLEND         RESET WORKING STORAGE POINTER                
*                                                                               
COMV     DS    0H                                                               
*                                                                               
         CLI   MYPOSO,C'H'         MUST BE A HEADLINE                           
         BNE   COMVE1                                                           
*                                                                               
         CLI   1(R4),0             MUST HAVE A COMMENT ID                       
         BE    COMVE2                                                           
*                                                                               
         CLI   1(R4),L'PCOMKNUM    CHECK MAX ALLOWED LENGTH                     
         BH    COMVE2                                                           
*                                                                               
*        READ IN COMMENT RECORD                                                 
*                                                                               
         XC    KEY,KEY             INIT KEY BUILD AREA                          
         LA    R5,KEY              ESTABLISH AS COMMENT RECORD                  
         USING PCOMRECD,R5                                                      
*                                                                               
         MVC   PCOMKAGY,PBQAGY     SET AGENCY IN KEY                            
         BRAS  RE,CLTMED           FIND FIRST MEDIA                             
*                                                                               
         MVC   PCOMKNUM,SPACES     INIT COMMENT NUMBER IN KEY                   
*                                                                               
         SR    RF,RF                                                            
         IC    RF,1(R4)            GET COMMENT NUMBER LENGTH                    
*                                                                               
         LA    R1,L'PCOMKNUM       FIND START OF NUMBER                         
         SR    R1,RF               IN ORDER TO RIGHT JUSTIFY IT                 
         LA    R1,PCOMKNUM(R1)                                                  
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R1),22(R4)      MOVE COMMENT NUMBER TO KEY                   
*                                                                               
         MVI   PCOMKRCD,PCOMKIDQ   IDENTIFY AS COMMENT RECORD                   
*                                                                               
COMMEDLP DS    0H                                                               
*                                                                               
         GOTO1 HIGH                READ FOR KEY                                 
*                                                                               
         CLC   KEY(L'PCOMKEY),KEYSAVE  MAKE SURE WE GOT THE RIGHT ONE           
         BE    COMMEDFD                                                         
*                                                                               
COMMEDCN DS    0H                                                               
*                                                                               
         MVC   KEY,KEYSAVE         RESTORE KEY                                  
         BRAS  RE,CLTMED           TRY NEXT MEDIA                               
         BE    COMMEDLP            NEW MEDIA FOUND                              
*                                                                               
         B     COMVE3              COMMENT NOT FOUND                            
*                                                                               
COMMEDFD DS    0H                                                               
*                                                                               
         MVC   AIO,AIO3            USE I/O AREA 3 FOR RECORD                    
*                                                                               
         MVI   ERROR,0             INIT ERROR CODE                              
*                                                                               
         GOTO1 GETREC              READ IN RECORD                               
*                                                                               
         CLI   ERROR,0             NO ERRORS TOLERATED                          
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R5,AIO              POINT TO FOUND RECORD                        
*                                                                               
         LA    R6,PCOMCELM         POINT TO FIRST ELEMENT IN RECORD             
         USING PCOMCELM,R6         ESTABLISH AS COMMENT LINE ELM                
*                                                                               
         SR    R7,R7               INIT COMMENT LINE COUNTER                    
         MVI   DRLENO,0            INIT OUTPUT LENGTH                           
         MVI   MYPOSO+2,31         START IN COLUMN 30                           
*                                                                               
COMVLP DS      0H                                                               
*                                                                               
         CLI   PCOMCELM,0          EOR                                          
         BE    COMVDN                                                           
*                                                                               
         CLI   PCOMCELM,X'40'      SEARCH FOR COMMENT LINE ELEMENTS             
         BNE   COMVCN                                                           
*                                                                               
         CLC   =C'++START',PCOMDT  IF ++START                                   
         BE    COMVE4                ERROR - FOR ESTIMATE REPORT                
*                                                                               
         CLC   =C'++END',PCOMDT    IF ++END                                     
         BE    COMVE4                ERROR - FOR ESTIMATE REPORT                
*                                                                               
         SR    RF,RF                                                            
         IC    RF,PCOMCELM+1       ELEMENT'S LENGTH                             
         SH    RF,=Y(PCOMDT-PCOMCELM) DETERMINE COMMENT'S LENGTH                
         BNP   COMVCN              MUST HAVE SOME LENGTH                        
*                                                                               
         LA    R1,PCOMDT           POINT TO START OF COMMENT                    
*                                                                               
         CLI   0(R1),C'+'          SKIP UNLESS LINES TO BE SKIPPED              
         BNE   COMV10                                                           
*                                                                               
         PACK  DUB,1(1,R1)         NUMBER OF LINES TO SKIP                      
         CVB   RE,DUB                                                           
*                                                                               
         AR    R7,RE               ACCUMULATE NUMBER OF LINES                   
*                                                                               
         LA    R1,2(R1)            POINT TO BODY OF COMMENT                     
         SH    RF,=H'2'            ADJUST COMMENT LENGTH                        
*                                                                               
COMV10 DS      0H                                                               
*                                                                               
         LTR   RF,RF               TEST IF ANY COMMENT TO PRINT                 
         BNP   COMV20              NOTHING TO PRINT                             
*                                                                               
         CH    RF,=H'70'           MAX 50 BYTES                                 
         BNH   *+8                                                              
         LH    RF,=H'70'                                                        
*                                                                               
         AH    R7,=H'1'            BUMP LINE COUNTER 1 FOR COMMENT LINE         
*                                                                               
         CLM   RF,1,DRLENO         SKIP UNLESS LONGER THAN PREVIOUS             
         BNH   *+8                                                              
         STC   RF,DRLENO           THEN UPDATE OUTPUT LENGTH                    
*                                                                               
COMV20 DS      0H                                                               
*                                                                               
COMVCN DS      0H                                                               
*                                                                               
         SR    RF,RF                                                            
         IC    RF,PCOMCELM+1       GET ELEMENT LENGTH                           
         LA    R6,0(RF,R6)         BUMP TO NEXT LINE ELEMENT                    
         B     COMVLP                                                           
*                                                                               
COMVDN DS      0H                                                               
*                                                                               
         LTR   RF,R7               GET NUMBER OF COMMENT LINES                  
         BZ    COMVE3              MUST HAVE SOME                               
*                                                                               
         BCTR  RF,0                DECREMENT BECAUSE 1 ALREADY ASSUMED          
         IC    R7,LASTHEAD         GET CURRENT HEADLINE NUMBER                  
         AR    R7,RF               BUMP BY # OF COMMENTS                        
*                                                                               
         CH    R7,=H'09'           MAKE SURE WE AREN'T OVER LIMIT               
         BH    COMVE5                                                           
*                                                                               
         STC   R7,LASTHEAD         UPDATE LAST HEADLINE USED                    
*                                                                               
         MVI   DRNARGSO,16         FORCE 16 ARGUMENTS                           
         MVC   DRARGSO+8(L'PCOMKNUM),PCOMKNUM   PASS COMMENT NUMBER             
*                                                                               
COMVX    DS     0H                                                              
         XIT1                                                                   
*                                                                               
COMVE1 MVI     ERROR,PWECOMC1      COMMENT MUST BE A HEADLINE                   
         B     COMVERR                                                          
*                                                                               
COMVE2 MVI     ERROR,PWECOMC2      INVALID COMMENT NUMBER                       
         B     COMVERR                                                          
*                                                                               
COMVE3 MVI     ERROR,PWECOMC3      COMMENT NOT FOUND                            
         B     COMVERR                                                          
*                                                                               
COMVE4 MVI     ERROR,PWECOMC4      COMMENT RESERVED FOR ESTIMATE REPORT         
         B     COMVERR                                                          
*                                                                               
COMVE5 MVI     ERROR,PWECOMC5      TOO MANY HEADLINES                           
         B     COMVERR                                                          
*                                                                               
COMVERR  DS    0H                                                               
         GOTO1 CURSERR                                                          
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'PRWRIGEN - VALIDATE KEYWORD FILTERS - FLTRVAL'                  
***********************************************************************         
*                                                                     *         
*        USE DDVAL TO VALIDATE FILTER VALUES FOR KEYWORD              *         
*                                                                     *         
*NTRY    R4 ==>   SCANNER BLOCK                                       *         
*                                                                     *         
*EXIT    CFLTQTIC - INTERNAL CODE FOR KEYWORD VALUE                   *         
*                   NULLS IF INVALID VALUE                            *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
FLTRVAL  NMOD1 0,**#FLV                                                         
*                                                                               
         USING SPOOLD,R8                                                        
         USING GEND,RC                                                          
         USING SYSD,R9                                                          
         USING T405FFD,RA                                                       
*                                                                               
         CLI   1(R4),0             SKIP IF NOTHING IN 2ND PART                  
         BE    FLTROK                                                           
*                                                                               
         LA    RC,SPOOLEND         RESET WORKING STORAGE POINTER                
*                                                                               
         XC    CFLTQTIC,CFLTQTIC   INIT FILTER INTERNAL CODE                    
*                                                                               
***********************************************************************         
*                                                                     *         
*        CHECK IF KEYWORD ALLOWS FILTERING ON VALUES                  *         
*                                                                     *         
*        AN 'X' IN ATTRIBUTES INDICATES NEXT BYTE IS                  *         
*        INTERNAL CODE FOR VALUES TABLE                               *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         LA    R0,L'DRATTRIB       NUMBER OF ATTRIBUTES                         
         LA    R1,DRATTRIB         START OF ATTRIBUTES                          
*                                                                               
         CLI   0(R1),C'X'          LOOK FOR 'X'                                 
         BE    *+16                                                             
         LA    R1,1(R1)            BUMP TO NEXT ATTRIBUTE                       
         BCT   R0,*-12                                                          
         B     FLTROK              NO VALUES ALLOWED                            
*                                                                               
         MVC   CFLTQTIC+1(1),1(R1)   COPY INTERNAL CODE FOR TABLE               
*                                                                               
         MVI   BYTE,FLTEQQ         DEFAULT TO EQUALITY                          
*                                                                               
         CLI   SCANSEP,C'<'        IF SEPARATOR IS LESS THAN                    
         BNE   *+12                                                             
         MVI   BYTE,FLTLTQ         SET FILTER CONTROL BYTE                      
         B     FLTRSEPF                                                         
*                                                                               
         CLI   SCANSEP,C'>'        IF SEPARATOR IS GREATER THAN                 
         BNE   *+12                                                             
         MVI   BYTE,FLTGTQ         SET FILTER CONTROL BYTE                      
         B     FLTRSEPF                                                         
*                                                                               
FLTRSEPF DS    0H                                                               
*                                                                               
FLTRFLT  DS    0H                                                               
*                                                                               
         SR    R0,R0                                                            
         IC    R0,1(R4)            LENGTH OF SECOND PART OF BLOCK               
         LA    RF,22(R4)           START OF SECOND PART OF BLOCK                
*                                                                               
         CLI   0(RF),C'-'          IF NEGATIVE SIGN STARTS RESULT               
         BNE   *+14                                                             
         OI    BYTE,FLTNOTQ           SET INEQUALITY INDICATOR                  
         BCTR  R0,0                   DECREMENT LENGTH                          
         LA    RF,1(RF)               POINT TO TRUE START OF VALUE              
*                                                                               
         L     R1,AVLPARMS                                                      
         GOTO1 VDDVAL,(R1),('VLPVALQ',CFLTQTIC),((R0),(RF)),           X        
               AVLTAB,0,0,0                                                     
*                                                                               
         CLI   VLPERR,0            SKIP IF ERRORS                               
         BNE   FLTRERR                                                          
*                                                                               
FLTRFLT1 DS    0H                                                               
*                                                                               
         L     R5,AVLTAB           POINT TO RETURNED TABLE                      
         USING VLTABD,R5           ESTABLISH TABLE ENTRY                        
*                                                                               
*        ADD FILTER TO COLUMN HEADLINES                                         
*                                                                               
         CLI   MYPOSO,C'H'         SKIP FOR  HEADLINES                          
         BE    FLTRFHDX                                                         
         CLI   MYPOSO,C'M'         AND MIDLINES                                 
         BE    FLTRFHDX                                                         
*                                                                               
         LA    R1,DRH1ALL          FIND FIRST UNUSED HEADLINE                   
         USING DRH1ALL,R1          ESTABLISH GENERIC HEADLINE BLOCK             
         LA    RE,4                MAX 4 HEADLINES                              
*                                                                               
         CLC   DRH1LIT,SPACES      USE IF NO LITERAL YET                        
         BNH   *+16                                                             
         LA    R1,L'DRH1ALL(R1)    BUMP TO NEXT HEADLINE                        
         BCT   RE,*-14                                                          
         B     FLTRFHDX            ALL HEADLINES USED                           
*                                                                               
         SR    RF,RF                                                            
         IC    RF,1(R4)            FILTER ID WIDTH                              
         CLM   RF,1,DRLENO         DEFAULT TO COLUMN WIDTH                      
         BNH   *+8                                                              
         IC    RF,DRLENO           COLUMN WIDTH                                 
*                                                                               
         STC   RF,DRH1LITL         SET HEADLINE LITERAL LENGTH                  
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   DRH1LIT(0),22(R4)   ADD TO HEADLINES                             
*                                                                               
         DROP  R1                                                               
*                                                                               
         MVC   DRHEAD1-DRH1ALL(L'DRHEAD1,R1),DRHEAD1 COPY STATUS OF 1ST         
*                                                                               
FLTRFHDX DS    0H                                                               
*                                                                               
*        ADD COLUMN FILTER TO COLUMN FILTER SAVEAREA                            
*                                                                               
         MVC   DRARGSI+6(1),KEYWORD# PASS ALONG KEYWORD NUMBER                  
         CLI   DRNARGSI,7          UPDATE NUMBER OF ARGUMENTS IF NEEDED         
         BNL   *+8                                                              
         MVI   DRNARGSI,7                                                       
*                                                                               
         MVC   DRARGSO+6(1),KEYWORD# PASS ALONG KEYWORD NUMBER                  
         CLI   DRNARGSO,7          UPDATE NUMBER OF ARGUMENTS IF NEEDED         
         BNL   *+8                                                              
         MVI   DRNARGSO,7                                                       
*                                                                               
         L     R7,AFLTTAB          POINT TO FILTER SAVEAREAS                    
*                                                                               
         SR    RE,RE                                                            
         IC    RE,KEYWORD#         KEYWORD NUMBER                               
         BCTR  RE,0                DECREMENT FOR INDEXING                       
         LA    RF,FTBENTL          FILTER AREA LENGTH                           
         MR    RE,RE               INDEX INTO FILTER AREA                       
         LA    R7,0(RF,R7)         AREA FOR THIS KEYWORD                        
*                                                                               
         USING FLTAREA,R7          ESTABLISH FILTERS SAVEAREA                   
*                                                                               
         LA    R6,FLTCTL           POINT TO FIRST FILTER IN AREA                
*                                                                               
         SR    RE,RE                                                            
         ICM   RE,1,FLTFNO         GET NUMBER OF FILTERS SO FAR                 
         BZ    FLTRFL10                                                         
*                                                                               
         SR    RF,RF                                                            
         USING FLTCTL,R6           ESTABLISH FILTER                             
*                                                                               
         ICM   RF,1,FLTFVLEN       GET LENGTH OF FILTER                         
         LA    R6,FLTFVAL(RF)      BUMP TO NEXT FILTER                          
         BCT   RE,*-8                                                           
*                                                                               
FLTRFL10 DS    0H                                                               
*                                                                               
         SR    RF,RF                                                            
         IC    RF,FLTFNO           ADD TWO TO FILTER COUNTER                    
         LA    RF,2(RF)                                                         
         STC   RF,FLTFNO                                                        
*                                                                               
*        ADD ENTRY CONTAINING MASTER TYPE                                       
*                                                                               
         MVC   FLTFTIC,=AL2(PRQMTIC)  SET FILTER TYPE AS MASTER HOLDER          
         MVI   FLTCTL,FLTEQQ       SET CONTROL BYTE                             
*                                                                               
         MVI   FLTFVLEN,2          FILTER VALUE IS 2 BYTES                      
         MVC   FLTFVAL(2),CFLTQTIC  SAVE DEFAULT TYPE                           
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,FLTFVLEN       GET LENGTH OF FILTER                         
         LA    R6,FLTFVAL(RF)      BUMP TO NEXT FILTER                          
*                                                                               
         L     R1,AVLTAB           POINT TO DDVAL TABLE ENTRY                   
*                                                                               
         MVC   FLTFTIC,CFLTQTIC    SET FILTER TYPE                              
         MVC   FLTCTL,BYTE         SET CONTROL BYTE                             
*                                                                               
         TM    VLTIND-VLTABD(R1),VLTNSLNQ IF STANDARD ICODE                     
         BO    FLTRFL20                                                         
*                                                                               
         MVI   FLTFVLEN,2          FILTER VALUE IS 2 BYTES                      
         MVC   FLTFVAL(2),VLTICODE-VLTABD(R1)  SAVE FILTER VALUE                
*                                                                               
         B     FLTRFL30                                                         
*                                                                               
FLTRFL20 DS    0H                                                               
*                                                                               
         MVC   FLTFVLEN,VLTEXTRA-VLTABD(R1)  LENGTH AT VLTEXTRA                 
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,VLTEXTRA-VLTABD(R1) FILTER VALUE LENGTH                     
         BZ    *+6                                                              
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   FLTFVAL(0),VLTEXTRA+1-VLTABD(R1) SAVE FILTER VALUE               
*                                                                               
FLTRFL30 DS    0H                                                               
*                                                                               
         DROP  R5                                                               
*                                                                               
FLTROK   DS    0H                  FILTER VALIDATION OKAY                       
*                                                                               
         CR    RB,RB               SET EQ CC                                    
         B     FLTRVALX                                                         
*                                                                               
FLTRERR  DS    0H                                                               
*                                                                               
         XC    CFLTQTIC,CFLTQTIC   CLEAR FILTER ICODE                           
         LTR   RB,RB               SET NE CC                                    
         B     FLTRVALX                                                         
*                                                                               
FLTRVALX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP  R6,R7                                                            
*                                                                               
         TITLE 'PRWRIGEN - VALIDATE FOOTCOM ENTRY - FOOTVAL'                    
***********************************************************************         
*                                                                     *         
*        MAKE SURE SOMMENT RECORD EXISTS FOR FOOTCOM                  *         
*                                                                     *         
*NTRY    R4 ==>   SCANNER BLOCK                                       *         
*                                                                     *         
*EXIT    FOOT#LNS   = NUMBER OF FOOTLINES                             *         
*        FOOTCOM    = FOOT COMMENT NUMBER                             *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
FOOTVAL  NMOD1 0,**#FTV                                                         
*                                                                               
         USING SPOOLD,R8                                                        
         USING GEND,RC                                                          
         USING SYSD,R9                                                          
         USING T405FFD,RA                                                       
*                                                                               
         LA    RC,SPOOLEND         RESET WORKING STORAGE POINTER                
*                                                                               
         CLI   1(R4),0             MUST HAVE A COMMENT ID                       
         BE    FTVFCE2                                                          
*                                                                               
         CLI   1(R4),L'PCOMKNUM    CHECK MAX ALLOWED LENGTH                     
         BH    FTVFCE2                                                          
*                                                                               
*        READ IN COMMENT RECORD                                                 
*                                                                               
         XC    KEY,KEY             INIT KEY BUILD AREA                          
         LA    R5,KEY              ESTABLISH AS COMMENT RECORD                  
         USING PCOMRECD,R5                                                      
*                                                                               
         MVC   PCOMKAGY,PBQAGY     SET AGENCY IN KEY                            
         BRAS  RE,CLTMED           SET FIRST MEDIA                              
*                                                                               
         MVC   PCOMKNUM,SPACES     INIT COMMENT NUMBER IN KEY                   
*                                                                               
         SR    RF,RF                                                            
         IC    RF,1(R4)            GET COMMENT NUMBER LENGTH                    
*                                                                               
         LA    R1,L'PCOMKNUM       FIND START OF NUMBER                         
         SR    R1,RF               IN ORDER TO RIGHT JUSTIFY IT                 
         LA    R1,PCOMKNUM(R1)                                                  
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R1),22(R4)      MOVE COMMENT NUMBER TO KEY                   
*                                                                               
         MVI   PCOMKRCD,PCOMKIDQ   IDENTIFY AS COMMENT RECORD                   
*                                                                               
FTMEDLP  DS    0H                                                               
*                                                                               
         GOTO1 HIGH                READ FOR KEY                                 
*                                                                               
         CLC   KEY(L'PCOMKEY),KEYSAVE  MAKE SURE WE GOT THE RIGHT ONE           
         BE    FTMEDFD             COMMENT FOUND                                
*                                                                               
FTMEDCN  DS    0H                                                               
*                                                                               
         MVC   KEY,KEYSAVE         RESTORE KEY                                  
         BRAS  RE,CLTMED           NEXT MEDIA                                   
         BE    FTMEDLP             NEW MEDIA FOUND                              
*                                                                               
         B     FTVFCE3                                                          
*                                                                               
FTMEDFD  DS    0H                                                               
*                                                                               
         MVC   AIO,AIO3            USE I/O AREA 3 FOR RECORD                    
*                                                                               
         MVI   ERROR,0             INIT ERROR CODE                              
*                                                                               
         GOTO1 GETREC              READ IN RECORD                               
*                                                                               
         CLI   ERROR,0             NO ERRORS TOLERATED                          
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R5,AIO              POINT TO FOUND RECORD                        
*                                                                               
         LA    R6,PCOMCELM         POINT TO FIRST ELEMENT IN RECORD             
         USING PCOMCELM,R6         ESTABLISH AS COMMENT LINE ELM                
*                                                                               
         SR    R7,R7               INIT COMMENT LINE COUNTER                    
         MVI   DRLENO,0            INIT OUTPUT LENGTH                           
         MVI   MYPOSO+2,31         START IN COLUMN 30                           
*                                                                               
FTVFCLP DS     0H                                                               
*                                                                               
         CLI   PCOMCELM,0          EOR                                          
         BE    FTVFCDN                                                          
*                                                                               
         CLI   PCOMCELM,X'40'      SEARCH FOR COMMENT LINE ELEMENTS             
         BNE   FTVFCCN                                                          
*                                                                               
         CLC   =C'++START',PCOMDT  IF ++START                                   
         BE    FTVFCE4               ERROR - FOR ESTIMATE REPORT                
*                                                                               
         CLC   =C'++END',PCOMDT    IF ++END                                     
         BE    FTVFCE4               ERROR - FOR ESTIMATE REPORT                
*                                                                               
         SR    RF,RF                                                            
         IC    RF,PCOMCELM+1       ELEMENT'S LENGTH                             
         SH    RF,=Y(PCOMDT-PCOMCELM) DETERMINE COMMENT'S LENGTH                
         BNP   FTVFCCN             MUST HAVE SOME LENGTH                        
*                                                                               
         LA    R1,PCOMDT           POINT TO START OF COMMENT                    
*                                                                               
         CLI   0(R1),C'+'          SKIP UNLESS LINES TO BE SKIPPED              
         BNE   FTVFC10                                                          
*                                                                               
         PACK  DUB,1(1,R1)         NUMBER OF LINES TO SKIP                      
         CVB   RE,DUB                                                           
*                                                                               
         AR    R7,RE               ACCUMULATE NUMBER OF LINES                   
*                                                                               
         LA    R1,2(R1)            POINT TO BODY OF COMMENT                     
         SH    RF,=H'2'            ADJUST COMMENT LENGTH                        
*                                                                               
FTVFC10 DS     0H                                                               
*                                                                               
         LTR   RF,RF               TEST IF ANY COMMENT TO PRINT                 
         BNP   FTVFC20             NOTHING TO PRINT                             
*                                                                               
         AH    R7,=H'1'            BUMP LINE COUNTER 1 FOR COMMENT LINE         
*                                                                               
FTVFC20 DS     0H                                                               
*                                                                               
FTVFCCN DS     0H                                                               
*                                                                               
         SR    RF,RF                                                            
         IC    RF,PCOMCELM+1       GET ELEMENT LENGTH                           
         LA    R6,0(RF,R6)         BUMP TO NEXT LINE ELEMENT                    
         B     FTVFCLP                                                          
*                                                                               
FTVFCDN DS     0H                                                               
*                                                                               
         LTR   R7,R7               SKIP IF THERE IS NO FOOTING                  
         BZ    FTVFCX                                                           
*                                                                               
         LA    R7,2(R7)            ADD 2 FOR SPACING                            
*                                                                               
         STC   R7,FOOT#LNS         SAVE NUMBER OF FOOT LINES                    
         MVC   FOOTCOM,PCOMKNUM    SAVE ID                                      
*                                                                               
FTVFCX   DS     0H                                                              
         XIT1                                                                   
*                                                                               
FTVFCE2  MVI   ERROR,PWEOPFC2      INVALID COMMENT NUMBER                       
         B     FTVERR                                                           
*                                                                               
FTVFCE3  MVI   ERROR,PWEOPFC3      COMMENT NOT FOUND                            
         B     FTVERR                                                           
*                                                                               
FTVFCE4  MVI   ERROR,PWEOPFC4      COMMENT FOR ESTIMATE REPORT                  
         B     FTVERR                                                           
*                                                                               
FTVERR   ST    R4,DMCB+8           SAVE ERROR POINTER                           
         GOTO1 CURSERR             PUT OUT ERROR MESSAGE                        
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'PRWRIGEN - VALIDATE STANDARD COMMENT ENTRY - SCOMVAL'           
***********************************************************************         
*                                                                     *         
*        MAKE SURE STANDARD COMMENT RECORD EXISTS                     *         
*                                                                     *         
*NTRY    R4 ==>   SCANNER BLOCK                                       *         
*                                                                     *         
*EXIT    PBQCOM1    = STANDARD COMMENT ID                             *         
*        PBGCOM2    = STANDARD COMMENT ID                             *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
SCOMVAL  NMOD1 0,**#SCV                                                         
*                                                                               
         USING SPOOLD,R8                                                        
         USING GEND,RC                                                          
         USING SYSD,R9                                                          
         USING T405FFD,RA                                                       
*                                                                               
         LA    RC,SPOOLEND         RESET WORKING STORAGE POINTER                
*                                                                               
         LA    R3,22(R4)           POINT TO COMMENT ID                          
*                                                                               
         CLI   1(R4),0             MUST HAVE LENGTH                             
         BE    SCVNVER                                                          
*                                                                               
         ZIC   RF,1(R4)            GET COMMENT CODE LENGTH                      
         LA    RE,PBQCOMLQ         DEFAULT TO END OF REPORT                     
*                                                                               
         CLI   1(R4),3             MAY HAVE POSITIONAL CODE                     
         BL    SCVCOM1               IF LENGTH GREATER OR EQUAL 3               
*                                                                               
         LA    R1,0(RF,R3)         POINT TO THIRD LAST BYTE                     
         SH    R1,=H'3'                                                         
*                                                                               
         CLI   0(R1),C'('          CHECK FOR POSITIONAL CODE                    
         BNE   SCVCOM1                                                          
*                                                                               
         SH    RF,=H'3'            DECREMENT COMMENT CODE LENGTH                
*                                                                               
*        ANALYZE POSITION CODE AND SET INDICATOR                                
*                                                                               
         CLI   1(R1),C'C'          CHECK IF COVER SHEET                         
         BNE   *+8                                                              
         LA    RE,PBQCOMFQ                                                      
         CLI   1(R1),C'F'          CHECK IF FOOT  OF REPORT                     
         BNE   *+8                                                              
         LA    RE,PBQCOMLQ                                                      
         CLI   1(R1),C'B'          CHECK IF BOTH ENDS OF REPORT                 
         BNE   *+8                                                              
         LA    RE,PBQCOMFQ+PBQCOMLQ                                             
*                                                                               
SCVCOM1  DS    0H                                                               
*                                                                               
         CLM   RF,1,=X'6'          CODE HAS MAX LENGTH 6                        
         BH    SCVNVER                                                          
*                                                                               
         STC   RF,1(R4)            RESET CODE LENGTH                            
*                                                                               
         CLI   17(R4),C'1'            STCOMMENT 1                               
         BNE   *+8                                                              
         STC   RE,PBQCOM1P         SAVE POSITIONAL CODE                         
         CLI   17(R4),C'2'            STCOMMENT 2                               
         BNE   *+8                                                              
         STC   RE,PBQCOM2P         SAVE POSITIONAL CODE                         
*                                                                               
*        READ COMMENT RECORD TO VERIFY IT EXISTS                                
*                                                                               
         XC    KEY,KEY                                                          
         MVC   KEY(2),AGENCY                                                    
*                                                                               
         MVI   KEY+3,X'40'         COMMENT RECORD                               
*                                                                               
         ZIC   R1,1(R4)                                                         
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   WORK+6(0),0(R3)    RIGHT JUSTIFY COMMENT                         
         LA    RF,5                                                             
         SR    RF,R1                                                            
         MVC   WORK(6),SPACES                                                   
         LA    R1,WORK+6                                                        
         SR    R1,RF                                                            
         MVC   KEY+4(6),0(R1)                                                   
*                                                                               
         BRAS  RE,CLTMED           FIND FIRST MEDIA                             
*                                                                               
SCVMEDLP DS    0H                                                               
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(11),KEYSAVE                                                  
         BE    SCVMEDFD                                                         
*                                                                               
SCVMEDCN DS    0H                                                               
*                                                                               
         MVC   KEY,KEYSAVE         RESTORE STARTING KEY                         
*                                                                               
         BRAS  RE,CLTMED           FIND NEXT MEDIA                              
         BE    SCVMEDLP                                                         
*                                                                               
SCVMEDDN DS    0H                                                               
         B     SCVCMER                                                          
*                                                                               
SCVMEDFD DS    0H                                                               
*                                                                               
         CLI   17(R4),C'1'            STCOMMENT 1                               
         BNE   *+10                                                             
         MVC   PBQCOM1,KEY+27        SAVE ADDRESS                               
*                                                                               
         CLI   17(R4),C'2'            STCOMMENT 2                               
         BNE   *+10                                                             
         MVC   PBQCOM2,KEY+27        SAVE ADDRESS                               
*                                                                               
SCOMVALX DS    0H                                                               
*                                                                               
         XIT1                                                                   
*                                                                               
SCVCMER  MVI   ERROR,PWEOPCMS      STANDARD COMMENT NOT FOUND                   
         B     SCVERR                                                           
*                                                                               
SCVNVER  MVI   ERROR,PWEOPNV       INVALID OPTION                               
*                                                                               
SCVERR   ST    R4,DMCB+8           SAVE ERROR POINTER                           
         GOTO1 CURSERR             PUT OUT ERROR MESSAGE                        
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'PRWRIGEN - VALIDATE USER FIELDS - UDEFVAL'                      
***********************************************************************         
*                                                                     *         
*        REQUEST FOR USER FIELDS                                      *         
*        DEFINITIONS AND FIELD TITLES ARE IN CLIENT HEADER            *         
*        USE DEFINITION TO SET COLUMN WIDTH AND TITLE                 *         
*           SINGLE CLIENT REQUEST ONLY                                *         
*        DATA IS IN PRODUCT OR ESTIMATE RECORD                        *         
*        IDS OF WHICH DATA FIELDS TO REPORT ARE                       *         
*           KEPT AS COLUMN FILTERS                                    *         
*                                                                     *         
*NTRY    R4 ==>   SCANNER BLOCK                                       *         
*        R2 ==>   FIELD ON SCREEN                                     *         
*                                                                     *         
*EXIT                                                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
UDEFVAL  NTR1  BASE=*,LABEL=*,WORK=(R7,16)                                      
*                                                                               
         USING SPOOLD,R8                                                        
         USING SYSD,R9                                                          
         USING GEND,RC                                                          
         USING UDEFWRKD,R7                                                      
*                                                                               
         ST    R2,UDEFFLDA         FIELD ADDRESS FOR ERRORS                     
*                                                                               
         CLC   =C'LBGL#',12(R4)    IF LABATT GL #                               
         BNE   *+14                                                             
         MVC   22(2,R4),=C'E1'        FORCE FIRST ESTIMATE UDEF                 
         MVI   1(R4),2                SET ID LENGTH                             
*                                                                               
         CLI   1(R4),0             MUST HAVE IDS ENTERED                        
         BE    UDFNONE                                                          
*                                                                               
***********************************************************************         
*                                                                     *         
*        VALIDATE FIELD ID                                            *         
*          SAVE ID IN FILTER AREA                                     *         
*          ADJUST COLUMN WIDTH AND HEADLINES                          *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         XC    UDEFDTIC,UDEFDTIC   INIT FIELD ID INTERNAL CODE                  
         MVI   UDEFLENI,0          INIT INPUT AND OUTPUT LENGTHS                
         MVI   UDEFLENO,0                                                       
*                                                                               
*        FIND NEXT AVAILABLE AREA FOR COLUMN FILTER                             
*                                                                               
         MVC   DRARGSI+6(1),KEYWORD# PASS ALONG KEYWORD NUMBER                  
*                                                                               
         CLI   DRNARGSI,7          UPDATE NUMBER OF ARGUMENTS IF NEEDED         
         BNL   *+8                                                              
         MVI   DRNARGSI,7                                                       
*                                                                               
         MVC   DRARGSO+6(1),KEYWORD# PASS ALONG KEYWORD NUMBER                  
*                                                                               
         CLI   DRNARGSO,7          UPDATE NUMBER OF ARGUMENTS IF NEEDED         
         BNL   *+8                                                              
         MVI   DRNARGSO,7                                                       
*                                                                               
         L     R2,AFLTTAB          POINT TO FILTER SAVEAREAS                    
*                                                                               
         SR    RE,RE                                                            
         IC    RE,KEYWORD#         KEYWORD NUMBER                               
         BCTR  RE,0                DECREMENT FOR INDEXING                       
         LA    RF,FTBENTL          FILTER AREA LENGTH                           
         MR    RE,RE               INDEX INTO FILTER AREA                       
         LA    R2,0(RF,R2)         AREA FOR THIS KEYWORD                        
*                                                                               
         USING FLTAREA,R2          ESTABLISH FILTER SAVEAREA                    
*                                                                               
         LA    R3,FLTCTL           POINT TO FIRST FILTER IN AREA                
*                                                                               
         SR    R0,R0                                                            
         ICM   R0,1,FLTFNO         GET NUMBER OF FILTERS SO FAR                 
         BZ    UDFVFL10                                                         
*                                                                               
         SR    RF,RF                                                            
         USING FLTCTL,R3           ESTABLISH FILTER                             
*                                                                               
         ICM   RF,1,FLTFVLEN       GET LENGTH OF FILTER                         
         LA    R3,FLTFVAL(RF)      BUMP TO NEXT FILTER                          
         BCT   R0,*-8                                                           
*                                                                               
UDFVFL10 DS    0H                                                               
*                                                                               
         ZAP   UDEFFCTR,=P'0'      INIT FIELD COUNTER                           
*                                                                               
         LA    RA,22(R4)           A(1ST UDEF ID)                               
         LA    RE,DRH1ALL          POINT TO FIRST HEADLINE                      
         ST    RE,UDEFDRHA         SAVE A(DRHEAD AREA)                          
*                                                                               
UDFLOOP  DS    0H                                                               
*                                                                               
         LR    RF,RA               START OF DATA                                
*                                  FIND SEPARATOR C'/' OR END OF INPUT          
         CLI   0(RF),C'/'          SEPARATOR                                    
         BE    *+8                                                              
         CLI   0(RF),C' '          END OF DATA                                  
         BNH   *+12                                                             
         LA    RF,1(RF)            BUMP POINTER                                 
         B     *-20                                                             
*                                                                               
         AP    UDEFFCTR,=P'1'      BUMP FIELD COUNTER                           
         SR    RF,RA               LENGTH OF ID                                 
         LTR   R0,RF               SAVE LENGTH                                  
         BZ    UDFCONT             NO ID                                        
*                                                                               
         L     R1,AVLPARMS         VALIDATE INPUT                               
         GOTO1 VDDVAL,(R1),('VLPVALQ',=AL2(PRQUDEF)),                  X        
               ((R0),(RA)),AVLTAB,0,0,0                                         
*                                                                               
         CLI   VLPERR-VLPARMS(R1),0  DONE IF ERRORS                             
         BNE   UDFINVE             INVALID ID                                   
*                                                                               
         L     R5,AVLTAB           POINT TO RETURNED TABLE                      
         USING VLTABD,R5           ESTABLISH TABLE ENTRY                        
*                                                                               
         MVC   UDEFDTIC,VLTICODE   SAVE UDEF TYPE                               
*                                                                               
*        ADD FIELD DEFINITION TO NEXT HEADLINE                                  
*                                                                               
         CLC   PBQCLT,=C'ALL'      IF WE HAVE MULTIPLE CLIENTS                  
         BE    UDEFCOLX               SKIP COLUMN ADJUSTMENTS                   
         CLC   PBQCLT,SPACES                                                    
         BNH   UDEFCOLX                                                         
         CLI   PBQCLT,C'A'                                                      
         BL    UDEFCOLX                                                         
*                                                                               
*        SINGLE CLIENT - READ CLIENT HEADER                                     
*                                                                               
         XC    KEY,KEY             INIT CLIENT RECORD KEY                       
*                                                                               
         LA    R6,KEY              ESTABLISH CLIENT RECORD KEY                  
         USING PCLTKEY,R6                                                       
*                                                                               
         MVC   PCLTKAGY,AGENCY     SET AGENCY                                   
*                                                                               
         MVI   PCLTKRCD,PCLTKIDQ   INDICATE CLIENT RECORD                       
         MVC   PCLTKCLT,PBQCLT     SET CLIENT CODE                              
*                                                                               
         BRAS  RE,CLTMED           FIND FIRST MEDIA                             
*                                                                               
UDEFCLLP DS    0H                                                               
*                                                                               
         L     R6,AIO1             POINT TO RECORD INPUT AREA                   
*                                                                               
         CLC   PCLTKEY,KEY         SKIP READ IF RECORD IN CORE                  
         BE    UDFCLRDX                                                         
*                                                                               
         MVI   RDUPDATE,C'N'       NOT READING FOR UPDATE                       
*                                                                               
         MVC   AIO,AIO1            INDICATE WHERE TO READ RECORD INTO           
*                                                                               
         GOTO1 HIGH                READ RECORD                                  
*                                                                               
         CLC   KEY(L'PCLTKEY),KEYSAVE                                           
         BNE   UDEFCLCN            SKIP IF CLIENT NOT FOUND                     
*                                                                               
         GOTO1 GETREC              READ RECORD                                  
*                                                                               
         BE    UDEFCLFD            CLIENT FOUND                                 
*                                                                               
UDEFCLCN DS    0H                                                               
*                                                                               
         MVC   KEY,KEYSAVE         RESTORE ORIGINAL KEY                         
         BRAS  RE,CLTMED           GET NEXT MEDIA                               
         BE    UDEFCLLP            CONTINUE IF MEDIA FOUND                      
*                                                                               
UDEFCLDN DS    0H                                                               
         B     UDFCONT             NO CLIENT RECORD FOUND                       
*                                                                               
UDEFCLFD DS    0H                  CLIENT RECORD FOUND                          
*                                                                               
UDFCLRDX DS    0H                                                               
*                                                                               
         SR    RF,RF                                                            
         LA    R6,PCLTELEM         POINT TO FIRST ELEMENT IN CLIENT             
*                                                                               
         CLI   0(R6),X'20'         FIND USER FIELD DEF ELM                      
         BE    *+24                                                             
         IC    RF,1(R6)            ELEMENT LENGTH                               
         LA    R6,0(RF,R6)         NEXT ELEMENT                                 
         CLI   0(R6),0             END OF RECORD                                
         BNE   *-20                                                             
         B     UDFNOTFE            NO USER FIELDS DEFINED                       
*                                                                               
         USING PCLTUDEF,R6         ESTABLISH USER DEFINITION RECORD             
*                                                                               
*        FIND DESCRIPTION ASKED FOR                                             
*                                                                               
         SR    R1,R1               INIT POINTER                                 
         SR    RF,RF                                                            
*                                                                               
         ICM   RF,3,UDEFDTIC       GET FIELD TYPE                               
*                                                                               
         CHI   RF,PRQUDP1          PRODUCT 1                                    
         BNE   *+8                                                              
         LA    R1,PCLTPU1                                                       
*                                                                               
         CHI   RF,PRQUDP2          PRODUCT 2                                    
         BNE   *+8                                                              
         LA    R1,PCLTPU2                                                       
*                                                                               
         CHI   RF,PRQUDE1          ESTIMATE 1                                   
         BNE   *+8                                                              
         LA    R1,PCLTEU1                                                       
*                                                                               
         CHI   RF,PRQUDE2          ESTIMATE 2                                   
         BNE   *+8                                                              
         LA    R1,PCLTEU2                                                       
*                                                                               
         LTR   R1,R1               MUST HAVE A MATCH                            
         BZ    UDFINVE                                                          
*                                                                               
         USING PCLTPU1,R1          ESTABLISH DESCRIPTION FIELDS                 
*                                                                               
         CLI   PCLTP1LN,0          MUST HAVE A LENGTH SPECIFIED                 
         BE    UDFINVE                                                          
*                                                                               
         CLC   UDEFLENI,PCLTP1LN   FIND LARGEST INPUT NEEDED                    
         BNL   *+10                                                             
         MVC   UDEFLENI,PCLTP1LN   SET INPUT LENGTH                             
*                                                                               
         CLC   UDEFLENO,PCLTP1LN   FIND MINIMUM OUTPUT NEEDED                   
         BNL   *+10                                                             
         MVC   UDEFLENO,PCLTP1LN   UPDATE OUTPUT LENGTH                         
*                                                                               
*        FIND MINIMUM LENGTH OF DESCRIPTION                                     
*                                                                               
         LA    RE,PCLTPU1+L'PCLTPU1-1      END OF DESCRIPTION                   
         LA    RF,L'PCLTPU1        DESCRIPTION LENGTH                           
*                                                                               
         CLI   0(RE),C' '          FIND LAST OF DESCRIPTION                     
         BH    *+14                                                             
         BCTR  RF,0                BACKUP A SPACE                               
         BCT   RE,*-10                                                          
         B     *+6                 BLANK DESCRIPTION                            
         BCTR  RF,0                EXECUTE LENGTH OF DESCRIPTION                
*                                                                               
         L     RE,UDEFDRHA         GET  A(DRHEAD AREA)                          
         USING DRH1ALL,RE          ESTABLISH GENERIC HEADLINE BLOCK             
*                                                                               
         OI    DRHEAD1,X'80'       FORCE HEADLINE TO PRINT                      
*                                                                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   DRH1LIT(0),PCLTPU1  SET COLUMN TITLE                             
*                                                                               
         LA    RF,1(RF)            RESTORE TRUE LENGTH                          
*                                                                               
         STC   RF,DRH1LITL         SET LITERAL LENGTH                           
*                                                                               
         CLM   RF,1,UDEFLENO       SEE IF WIDTH IS OKAY                         
         BNH   *+8                                                              
         STC   RF,UDEFLENO         MAKE DESCRIPTION FIT COLUMN                  
*                                                                               
         DROP  RE                                                               
*                                                                               
UDEFCOLX DS    0H                                                               
*                                                                               
*        ADD FIELD ID TO COLUMN FILTER SAVEAREA                                 
*                                                                               
         SR    RF,RF                                                            
         IC    RF,FLTFNO           ADD ONE TO FILTER COUNTER                    
         LA    RF,1(RF)                                                         
         STC   RF,FLTFNO                                                        
*                                                                               
         MVC   FLTFTIC,=AL2(PRQUDEF) SET FILTER TYPE                            
         MVI   FLTCTL,FLTEQQ       SET FOR EQUALITY                             
*                                                                               
         MVI   FLTFVLEN,2          FILTER VALUE IS 2 BYTES                      
         MVC   FLTFVAL(2),UDEFDTIC  SAVE USER FIELD ID                          
*                                                                               
         LA    R3,FLTFVAL+2        POINT TO NEXT FILTER AREA                    
*                                                                               
UDFCONT  DS    0H                                                               
*                                                                               
         L     RE,UDEFDRHA         GET  A(DRHEAD AREA)                          
         LA    RE,L'DRH1ALL(RE)    BUMP TO NEXT HEADLINE                        
         ST    RE,UDEFDRHA         SAVE A(DRHEAD AREA)                          
*                                                                               
         AR    RA,R0               BUMP TO NEXT ID                              
         LA    RA,1(RA)            BYPASS SEPARATOR                             
*                                                                               
         CLI   0(RA),C' '          CONTINUE IF MORE                             
         BH    UDFLOOP                                                          
*                                                                               
UDFDONE  DS    0H                                                               
*                                                                               
         CLC   =C'LBGL#',12(R4)    SKIP LENGTH SETTING IF LABATT                
         BE    UDEFVALX                                                         
*                                                                               
         CP    UDEFFCTR,=P'0'      MUST HAVE A USER FIELD SPECIFIED             
         BE    UDFNONE                                                          
*                                                                               
         CLI   MYPOSO,C'H'         HEADLINE                                     
         BE    *+8                                                              
         CLI   MYPOSO,C'M'         MIDLINE                                      
         BNE   *+14                                                             
         CP    UDEFFCTR,=P'1'      ALLOWED ONLY ONE USER FIELD                  
         BH    UDFHEADE                                                         
*                                                                               
         CP    UDEFFCTR,=P'4'      MAX 4 USER FIELDS                            
         BH    UDFMAXE                                                          
*                                                                               
         CLI   UDEFLENO,0          IF NO OUTPUT LENGTH GIVEN                    
         BE    *+10                   KEEP DEFAULT WIDTH                        
         MVC   DRLENO,UDEFLENO     ELSE SET COLUMN WIDTH                        
*                                                                               
         CLI   UDEFLENI,0          IF NO INPUT LENGTH SPECIFIED                 
         BNE   *+10                                                             
         MVC   UDEFLENI,DRLENO        USE OUTPUT LENGTH FOR INPUT               
*                                                                               
         CVB   RE,UDEFFCTR         NUMBER OF FIELDS ASKED FOR                   
         SR    RF,RF                                                            
         IC    RF,UDEFLENI         MAXIMUM LENGTH OF 1 INPUT                    
         MR    RE,RE               INPUT AREA REQUIRED                          
         STC   RF,DRLENI                                                        
*                                                                               
         B     UDEFVALX                                                         
*                                                                               
UDFMAXE  DS    0H                                                               
         MVI   ERROR,PWEUDFMX      MAX 4 USER FIELDS ALLOWED                    
         B     UDFERR                                                           
*                                                                               
UDFNONE  DS    0H                                                               
         MVI   ERROR,PWEUDFNE      NEED USER FIELD ID                           
         B     UDFERR                                                           
*                                                                               
UDFHEADE DS    0H                                                               
         MVI   ERROR,PWEUDFHD      HEAD & MIDLINES ALLOWED ONLY 1 USER          
         B     UDFERR                                                           
*                                                                               
UDFNOTFE DS    0H                                                               
         MVI   ERROR,PWEUDFNF      NO USER FIELDS FOR CLIENT                    
         B     UDFERR                                                           
*                                                                               
UDFINVE  DS    0H                                                               
         MVI   ERROR,PWEUDFNV      INVALID USER FIELD ID                        
         B     UDFERR                                                           
*                                                                               
UDFERR   DS    0H                                                               
*                                                                               
         L     R2,UDEFFLDA         POINT TO FIELD ON SCREEN                     
*                                                                               
         GOTO1 CURSERR             PUT OUT ERROR MESSAGE                        
*                                                                               
UDEFVALX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
UDEFWRKD DSECT                     UDEFVAL WORKING STORAGE                      
*                                                                               
UDEFFCTR DS    D                   FIELD COUNTER                                
UDEFFLDA DS    A                   FIELD ON SCREEN ADDRESS                      
UDEFDRHA DS    A                   A(DRHEAD AREA)                               
UDEFDTIC DS    XL2                 FIELD ID INTERNAL CODE                       
UDEFLENI DS    X                   MAX INPUT LENGTH FOR 1 FIELD                 
UDEFLENO DS    X                   COLUMN WIDTH NEEDED                          
*                                                                               
PRWRIGEN CSECT                                                                  
         DROP                                                                   
*                                                                               
         TITLE 'PRWRIGEN - VALIDATE USER FIELDS - UCOMVAL'                      
***********************************************************************         
*                                                                     *         
*        REQUEST FOR USER FIELDS                                      *         
*        DEFINITIONS AND FIELD TITLES ARE IN UCOMM RECORDS            *         
*        USE DEFINITION TO SET COLUMN WIDTH AND TITLE                 *         
*           SINGLE CLIENT REQUEST ONLY                                *         
*        DATA RETRIEVED VIA DDUCOM                                    *         
*        IDS OF WHICH DATA FIELDS TO REPORT ARE                       *         
*           KEPT AS COLUMN FILTERS                                    *         
*                                                                     *         
*NTRY    R4 ==>   SCANNER BLOCK                                       *         
*        R2 ==>   FIELD ON SCREEN                                     *         
*                                                                     *         
*EXIT                                                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
UCOMVAL  NTR1  BASE=*,LABEL=*,WORK=(R7,100)                                     
*                                                                               
         USING SPOOLD,R8                                                        
         USING SYSD,R9                                                          
         USING GEND,RC                                                          
*                                                                               
         USING UCOMWRKD,R7         ESTABLISH LOCAL WORKING STORAGE              
*                                                                               
         USING DDUCOMD,UCOMBLK     ESTABLISH DDUCOM CONTROL BLOCK               
*                                                                               
         ST    R2,UCOMFLDA         SAVE FIELD ADDRESS FOR ERRORS                
*                                                                               
         CLI   1(R4),0             MUST HAVE IDS ENTERED                        
         BE    UCMNONE                                                          
*                                                                               
***********************************************************************         
*                                                                     *         
*        VALIDATE FIELD ID                                            *         
*          SAVE ID IN FILTER AREA                                     *         
*          ADJUST COLUMN WIDTH AND HEADLINES                          *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         XC    UCOMDTIC,UCOMDTIC   INIT FIELD ID INTERNAL CODE                  
         MVI   UCOMLENI,0          INIT INPUT AND OUTPUT LENGTHS                
         MVI   UCOMLENO,0                                                       
         XC    DDUCOMD(UCOMDLNQ),DDUCOMD INIT UCOM CONTROL BLOCK                
*                                                                               
         MVC   DRARGSI+6(1),KEYWORD# PASS ALONG KEYWORD NUMBER                  
*                                                                               
         MVI   DRNARGSI,16         ALWAYS MAX NUMBER OF ARGUMENTS               
         MVI   DRNARGSO,16                                                      
*                                                                               
*        FIND NEXT AVAILABLE AREA FOR COLUMN FILTER                             
*                                                                               
         L     R2,AFLTTAB          POINT TO FILTER SAVEAREAS                    
*                                                                               
         SR    RE,RE                                                            
         IC    RE,KEYWORD#         KEYWORD NUMBER                               
         BCTR  RE,0                DECREMENT FOR INDEXING                       
         LA    RF,FTBENTL          FILTER AREA LENGTH                           
         MR    RE,RE               INDEX INTO FILTER AREA                       
         LA    R2,0(RF,R2)         AREA FOR THIS KEYWORD                        
*                                                                               
         ST    R2,UCOMAFLT         SAVE A(FILTERAREA)                           
         USING FLTAREA,R2          ESTABLISH FILTER SAVEAREA                    
*                                                                               
         LA    R3,FLTCTL           POINT TO FIRST FILTER IN AREA                
*                                                                               
         SR    RE,RE                                                            
         ICM   RE,1,FLTFNO         GET NUMBER OF FILTERS SO FAR                 
         BZ    UCMVFL10                                                         
*                                                                               
         DROP  R2                                                               
*                                                                               
         SR    RF,RF                                                            
         USING FLTCTL,R3           ESTABLISH FILTER                             
*                                                                               
         ICM   RF,1,FLTFVLEN       GET LENGTH OF FILTER                         
         LA    R3,FLTFVAL(RF)      BUMP TO NEXT FILTER                          
         BCT   RE,*-8                                                           
*                                  R3 => AREA FOR NEXT FILTER                   
UCMVFL10 DS    0H                                                               
*                                                                               
         ZAP   UCOMFCTR,=P'0'      INIT FIELD COUNTER                           
*                                                                               
         LA    RA,22(R4)           A(1ST UCOM ID)                               
         LA    R2,DRH1ALL          POINT TO FIRST HEADLINE                      
*                                                                               
UCMLOOP  DS    0H                                                               
*                                                                               
         LR    RF,RA               START OF DATA                                
*                                  FIND SEPARATOR C'/' OR END OF INPUT          
         CLI   0(RF),C'/'          SEPARATOR                                    
         BE    *+8                                                              
         CLI   0(RF),C' '          END OF DATA                                  
         BNH   *+12                                                             
         LA    RF,1(RF)            BUMP POINTER                                 
         B     *-20                                                             
*                                                                               
         AP    UCOMFCTR,=P'1'      BUMP FIELD COUNTER                           
         SR    RF,RA               LENGTH OF ID                                 
         LTR   R0,RF               SAVE LENGTH                                  
         BZ    UCMCONT             NO ID                                        
*                                                                               
         L     R1,AVLPARMS         VALIDATE INPUT                               
         GOTO1 VDDVAL,(R1),('VLPVALQ',=AL2(PRQUCOM)),                  X        
               ((R0),(RA)),AVLTAB,0,0,0                                         
*                                                                               
         CLI   VLPERR-VLPARMS(R1),0  DONE IF ERRORS                             
         BNE   UCMINVE             INVALID ID                                   
*                                                                               
         L     R5,AVLTAB           POINT TO RETURNED TABLE                      
         USING VLTABD,R5           ESTABLISH TABLE ENTRY                        
*                                                                               
         MVC   UCOMDTIC,VLTICODE   SAVE UCOM TYPE                               
*                                                                               
*        ADD FIELD TITLE TO NEXT HEADLINE                                       
*                                                                               
         CLC   PBQCLT,=C'ALL'      IF WE HAVE MULTIPLE CLIENTS                  
         BE    UCOMCOLX               SKIP COLUMN ADJUSTMENTS                   
         CLC   PBQCLT,SPACES                                                    
         BNH   UCOMCOLX                                                         
         CLI   PBQCLT,C'A'                                                      
         BL    UCOMCOLX                                                         
*                                                                               
         CLI   22(R4),C'E'         ESTIMATE UCOMM REQUEST?                      
         BNE   UCMVFL20            NO                                           
         CLI   23(R4),C'5'         ESTIMATE UCOMM 1-4?                          
         BL    UCMVFL20            YES                                          
         OI    UCOPT,UCO8EST       FLAG ESTIMATE UCOMM 5-8                      
         B     UCMVFL30            FORCE HEADLINE READ AGAIN!                   
*                                                                               
UCMVFL20 OC    DDUCOMD(UCOMDLNQ),DDUCOMD SKIP IF TITLES ALREADY FOUND           
         BNZ   *+8                                                              
UCMVFL30 BRAS  RE,UCOMTTL             GET COLUMN TITLES VIA DDUCOM              
*                                                                               
         TM    UCDATA,UCDNOCLT     ERROR IF NO CLIENT DATA AVAILABLE            
         BO    UCMNOTFE                                                         
*                                                                               
*        FIND DESCRIPTION ASKED FOR                                             
*                                                                               
         SR    RF,RF               GET UCOMM INTERNAL ID                        
         ICM   RF,1,UCOMDTIC+1     X'01' - X'04' - PROD                         
*                                  X'21' - X'24' - ESTIMATE                     
*                                  X'25' - X'28' - ESTIMATE 5-8                 
*                                  X'61' - X'64' - REGION                       
*                                  X'81' - X'84' - DISTRICT                     
*                                                                               
         CHI   RF,32               IF CODE LT 32                                
         BNL   *+16                                                             
         MVI   UCOMTYPE,C'P'          PRODUCT TITLE                             
         LA    R1,UCPTTLS             POINT TO PRODUCT TITLE                    
         B     UCMIDX                                                           
*                                                                               
         CHI   RF,96               IF CODE LT 96                                
         BNL   UCMNEST                                                          
         MVI   UCOMTYPE,C'E'          SET ESTIMATE TYPE                         
         AHI   RF,-32                 REDUCE TO 1 TO 8                          
         LA    R1,UCETTLS             POINT TO ESTIMATE TITLES                  
         CHI   RF,5                   INDEX NOW 1 TO 8                          
         BL    UCMIDX                 YES - HAVE EST UCOMM 1-4                  
         LA    R1,UCPTTLS             EST UCOMM 5-8 IN PRD TITLE!               
         AHI   RF,-4                  REDUCE TO 1 TO 4                          
         B     UCMIDX                                                           
*                                                                               
UCMNEST  CHI   RF,128              IF CODE LT 128                               
         BNL   *+20                                                             
         MVI   UCOMTYPE,C'R'          SET REGION TYPE                           
         AHI   RF,-96                 REDUCE TO 1 TO 4                          
         LA    R1,UCRTTLS             POINT TO REGION TITLES                    
         B     UCMIDX                                                           
*                                                                               
         MVI   UCOMTYPE,C'D'          SET DISTRICT TYPE                         
         AHI   RF,-128                REDUCE TO 1 TO 4                          
         LA    R1,UCDTTLS             POINT TO DISTRICT TITLES                  
*                                                                               
UCMIDX   DS    0H                                                               
*                                                                               
         BCTR  RF,0                RELATIVE NUMBER FOR INDEXING                 
         STC   RF,UCOMINDX         SAVE INDEX VALUE                             
*                                                                               
         SR    RE,RE                                                            
         LA    R6,UCPMXLNS-UCPTTLS(R1)  POINT TO DATA MAX LENGTHS               
         LA    R6,0(RF,R6)         POINT TO MAX LENGTH FOR DATA                 
         ICM   RE,1,0(R6)          GET MAX LENGTH FOR DATA                      
         BZ    UCMINVE             NO TITLE AVAILABLE                           
*                                                                               
         OI    DRHEAD1-DRH1ALL(R2),X'80'  FORCE HEADLINE TO PRINT               
*                                                                               
         CLM   RE,1,UCOMLENO       FIND LARGEST OUTPUT LNGTH FOR COLUMN         
         BNH   *+8                                                              
         STCM  RE,1,UCOMLENO                                                    
*                                                                               
         TM    UCOPT,UCO8EST       JUST GOT EST UCOMM 5-8?                      
         BO    *+12                YES - VALUES IN PRD TITLE                    
         CLI   UCOMTYPE,C'P'       TEST FOR PRODUCT TITLE                       
         BNE   *+12                                                             
         LA    R1,UCPEDITS                                                      
         B     UCMEDITX                                                         
*                                                                               
         CLI   UCOMTYPE,C'E'       TEST FOR ESTIMATE                            
         BNE   *+12                                                             
         LA    R1,UCEEDITS                                                      
         B     UCMEDITX                                                         
*                                                                               
         CLI   UCOMTYPE,C'R'       TEST FOR REGION                              
         BNE   *+12                                                             
         LA    R1,UCREDITS                                                      
         B     UCMEDITX                                                         
*                                                                               
         CLI   UCOMTYPE,C'D'       TEST FOR DISTRICT                            
         BNE   *+8                                                              
         LA    R1,UCDEDITS                                                      
*                                                                               
UCMEDITX DS    0H                                                               
*                                                                               
         LA    R1,0(RF,R1)         POINT TO DATA TYPE                           
         CLI   0(R1),C'D'          IF A DATE TYPE                               
         BNE   *+8                                                              
         LHI   RE,3                   INPUT LENGTH IS 3                         
*                                                                               
         SR    RF,RF                                                            
         IC    RF,UCOMLENI         CURRENT INPUT DATA LENGTH                    
         AR    RF,RE               ADD ON THIS UNIT'S LENGTH                    
         STCM  RF,1,UCOMLENI       RESET INPUT DATA LENGTH                      
*                                                                               
*        FIND MINIMUM LENGTH OF DESCRIPTION                                     
*                                                                               
         TM    UCOPT,UCO8EST       JUST GOT EST UCOMM 5-8?                      
         BO    *+12                YES - VALUES IN PRD TITLE                    
         CLI   UCOMTYPE,C'P'       TEST FOR PRODUCT                             
         BNE   *+12                                                             
         LA    R6,UCOMPTLS                                                      
         B     UCMTLSX                                                          
*                                                                               
         CLI   UCOMTYPE,C'E'       TEST FOR ESTIMATE                            
         BNE   *+12                                                             
         LA    R6,UCOMETLS                                                      
         B     UCMTLSX                                                          
*                                                                               
         CLI   UCOMTYPE,C'R'       TEST FOR REGION                              
         BNE   *+12                                                             
         LA    R6,UCOMRTLS                                                      
         B     UCMTLSX                                                          
*                                                                               
         CLI   UCOMTYPE,C'D'       TEST FOR DISTRICT                            
         BNE   *+12                                                             
         LA    R6,UCOMDTLS                                                      
         B     UCMTLSX                                                          
*                                                                               
UCMTLSX  DS    0H                                                               
*                                                                               
         SR    RF,RF               RELATIVE NUMBER FOR INDEXING                 
         ICM   RF,1,UCOMINDX       GET INDEX VALUE                              
*                                                                               
         MHI   RF,20               INDEX * TITLE MAX LENGTH                     
         LA    R6,0(RF,R6)         POINT TO CURRENT TITLE                       
*                                                                               
         LA    RE,20-1(R6)         END OF TITLE                                 
         LA    RF,20               TITLE MAX LENGTH                             
*                                                                               
         CLI   0(RE),C' '          FIND LAST OF TITLE                           
         BH    *+14                                                             
         BCTR  RF,0                BACKUP A SPACE                               
         BCT   RE,*-10                                                          
         B     *+6                 BLANK DESCRIPTION                            
         BCTR  RF,0                EXECUTE LENGTH OF DESCRIPTION                
*                                                                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   DRH1LIT-DRH1ALL(0,R2),0(R6)    SET COLUMN TITLE                  
*                                                                               
         LA    RF,1(RF)            RESTORE TRUE LENGTH                          
*                                                                               
         STC   RF,DRH1LITL-DRH1ALL(R2)  SET LITERAL LENGTH                      
*                                                                               
         CLM   RF,1,UCOMLENO       SEE IF WIDTH IS OKAY                         
         BNH   *+8                                                              
         STC   RF,UCOMLENO         MAKE DESCRIPTION FIT COLUMN                  
*                                                                               
UCOMCOLX DS    0H                                                               
*                                                                               
*        ADD FIELD ID TO COLUMN FILTER SAVEAREA                                 
*                                                                               
         L     R1,UCOMAFLT         POINT TO KEYWORD FILTERS                     
         USING FLTAREA,R1          ESTABLISH FILTER SAVEAREA                    
*                                                                               
         SR    RF,RF                                                            
         IC    RF,FLTFNO           ADD ONE TO FILTER COUNTER                    
         LA    RF,1(RF)                                                         
         STC   RF,FLTFNO                                                        
*                                                                               
         DROP  R1                                                               
*                                                                               
         MVC   FLTFTIC,=AL2(PRQUCOM) SET FILTER TYPE                            
         MVI   FLTCTL,FLTEQQ       SET FOR EQUALITY                             
*                                                                               
         MVI   FLTFVLEN,2          FILTER VALUE IS 2 BYTES                      
         MVC   FLTFVAL(2),UCOMDTIC  SAVE USER FIELD ID                          
*                                                                               
         LA    R3,FLTFVAL+2        POINT TO NEXT FILTER AREA                    
*                                                                               
UCMCONT  DS    0H                                                               
*                                                                               
         LA    R2,L'DRH1ALL(R2)    BUMP TO NEXT HEADLINE                        
*                                                                               
         AR    RA,R0               BUMP TO NEXT ID                              
         LA    RA,1(RA)            BYPASS SEPARATOR                             
*                                                                               
         CLI   0(RA),C' '          CONTINUE IF MORE                             
         BH    UCMLOOP                                                          
*                                                                               
UCMDONE  DS    0H                                                               
*                                                                               
         CP    UCOMFCTR,=P'0'      MUST HAVE A USER FIELD SPECIFIED             
         BE    UCMNONE                                                          
*                                                                               
         CLI   MYPOSO,C'H'         HEADLINE                                     
         BE    *+8                                                              
         CLI   MYPOSO,C'M'         MIDLINE                                      
         BNE   *+14                                                             
         CP    UCOMFCTR,=P'1'      ALLOWED ONLY ONE USER FIELD                  
         BH    UCMHEADE                                                         
*                                                                               
         CP    UCOMFCTR,=P'4'      MAX 4 USER FIELDS                            
         BH    UCMMAXE                                                          
*                                                                               
         CLI   UCOMLENO,0          IF NO OUTPUT LENGTH GIVEN                    
         BE    *+10                   KEEP DEFAULT WIDTH                        
         MVC   DRLENO,UCOMLENO     ELSE SET COLUMN WIDTH                        
*                                                                               
         CLI   UCOMLENI,0          IF NO INPUT LENGTH SPECIFIED                 
         BNE   *+10                                                             
         MVC   UCOMLENI,DRLENO        USE OUTPUT LENGTH FOR INPUT               
*                                                                               
         MVC   DRLENI,UCOMLENI     SET INPUT LENGTH                             
*                                                                               
         B     UCOMVALX                                                         
*                                                                               
UCMMAXE  DS    0H                                                               
         MVI   ERROR,PWEUCMMX      MAX 4 USER FIELDS ALLOWED                    
         B     UCMERR                                                           
*                                                                               
UCMNONE  DS    0H                                                               
         MVI   ERROR,PWEUCMNE      NEED USER FIELD ID                           
         B     UCMERR                                                           
*                                                                               
UCMHEADE DS    0H                                                               
         MVI   ERROR,PWEUCMHD      HEAD & MIDLINES ALLOWED ONLY 1 USER          
         B     UCMERR                                                           
*                                                                               
UCMNOTFE DS    0H                                                               
         MVI   ERROR,PWEUCMNF      NO USER FIELDS FOR CLIENT                    
         B     UCMERR                                                           
*                                                                               
UCMINVE  DS    0H                                                               
         MVI   ERROR,PWEUCMNV      INVALID USER FIELD ID                        
         B     UCMERR                                                           
*                                                                               
UCMERR   DS    0H                                                               
*                                                                               
         L     R2,UCOMFLDA         POINT TO FIELD ON SCREEN                     
*                                                                               
         GOTO1 CURSERR             PUT OUT ERROR MESSAGE                        
*                                                                               
UCOMVALX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'PRWRIVAL - PRINT WRITER VALIDATION PHASE - GRPVAL'              
***********************************************************************         
*                                                                     *         
*        GET UCOMM COLUMN TITLES VIA DDUCOM                           *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
UCOMTTL  NTR1  LABEL=*                                                          
*                                                                               
         USING SPOOLD,R8                                                        
         USING SYSD,R9                                                          
         USING GEND,RC                                                          
*                                                                               
         USING UCOMWRKD,R7         ESTABLISH LOCAL WORKING STORAGE              
*                                                                               
         USING DDUCOMD,UCOMBLK     ESTABLISH DDUCOM CONTROL BLOCK               
*                                                                               
         MVC   UCACOMF,ACOMFACS    A(COMFACS)                                   
         MVI   UCSYS,C'P'          SYSTEM IS PRINT                              
         MVC   UCAGY,AGENCY        AGENCY                                       
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY              ESTABLISH AS CLIENT KEY                      
         USING PCLTKEY,R4                                                       
*                                                                               
         MVC   PCLTKAGY,AGENCY     AGENCY                                       
         MVI   PCLTKRCD,PCLTKIDQ   INDICATE CLIENT RECORD                       
         MVC   PCLTKCLT,PBQCLT     SET CLIENT CODE                              
*                                                                               
         BRAS  RE,CLTMED           FIND FIRST MEDIA                             
*                                                                               
UCOMCLLP DS    0H                                                               
*                                                                               
         GOTO1 HIGH                READ RECORD                                  
*                                                                               
         CLC   KEY(L'PCLTKEY),KEYSAVE                                           
         BE    UCOMCLFD            CLIENT FOUND                                 
*                                                                               
UCOMCLCN DS    0H                                                               
*                                                                               
         MVC   KEY,KEYSAVE         RESTORE ORIGINAL KEY                         
         BRAS  RE,CLTMED           GET NEXT MEDIA                               
         BE    UCOMCLLP            CONTINUE IF MEDIA FOUND                      
*                                                                               
UCOMCLDN DS    0H                                                               
         OI    UCDATA,UCDNOCLT     NO CLIENT DATA AVAILABLE                     
*                                                                               
         B     UCOMTTLX                                                         
*                                                                               
UCOMCLFD DS    0H                  CLIENT RECORD FOUND                          
*                                                                               
         MVC   UCMED,PCLTKMED      MEDIA                                        
*                                                                               
         MVC   UCCLT,PBQCLT        SET CLIENT                                   
*                                                                               
         OC    PBQDIV,PBQDIV       IF DIV/REG/DST                               
         BNZ   *+10                                                             
         OC    PBQRGN,PBQRGN       IF DIV/REG/DST                               
         BNZ   *+10                                                             
         OC    PBQDST,PBQDST       IF DIV/REG/DST                               
         BZ    *+8                                                              
         OI    UCOPT,UCOREG+UCODST    ASK FOR THOSE TITLES                      
*                                                                               
         CLC   =C'ALL',PBQDIV      SKIP IF ALL DIVISIONS                        
         BE    *+10                                                             
         MVC   UCDIV,PBQDIV        SET DIVISION                                 
*                                                                               
         CLC   =C'ALL',PBQRGN      SKIP IF ALL REGIONS                          
         BE    *+10                                                             
         MVC   UCREG,PBQRGN        SET REGION                                   
*                                                                               
         CLC   =C'ALL',PBQDST      SKIP IF ALL DISTRICTS                        
         BE    *+10                                                             
         MVC   UCDST,PBQDST        SET DISTRICT                                 
*                                                                               
         OI    UCOPT,UCOTTL        RETURN TITLES ONLY                           
*                                                                               
         GOTO1 =V(DDUCOM),DDUCOMD,RR=RELOPGEN   FIND COLUMN TITLES              
*                                                                               
         CLI   UCERROR,0           NO ERRORS TOLERATED                          
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R1,UCPTTLS          SAVE PRODUCT TITLES                          
         MVC   UCOMPTLS,0(R1)                                                   
         L     R1,UCETTLS          SAVE ESTIMATE TITLES                         
         MVC   UCOMETLS,0(R1)                                                   
         L     R1,UCRTTLS          SAVE REGION   TITLES                         
         MVC   UCOMRTLS,0(R1)                                                   
         L     R1,UCDTTLS          SAVE DISTRICT TITLES                         
         MVC   UCOMDTLS,0(R1)                                                   
*                                                                               
UCOMTTLX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'PRWRIVAL - PRINT WRITER VALIDATION PHASE - VCOMWRKD'            
***********************************************************************         
*                                                                     *         
*        UCOMVAL WORKING STORAGE                                      *         
*                                                                     *         
***********************************************************************         
         DS    0D                                                               
UCOMWRKD DSECT                     UCOMVAL WORKING STORAGE                      
UCOMFCTR DS    PL8                 FIELD COUNTER                                
UCOMFLDA DS    A                   FIELD ON SCREEN ADDRESS                      
UCOMAFLT DS    A                   A(FILTERS FOR KEYWORD)                       
UCOMDTIC DS    XL2                 FIELD ID INTERNAL CODE                       
UCOMLENI DS    X                   MAX INPUT LENGTH FOR 1 FIELD                 
UCOMLENO DS    X                   COLUMN WIDTH NEEDED                          
UCOMINDX DS    XL1                 INDEX INTO UCOM FIELDS SAVEAREA              
UCOMTYPE DS    XL1                 TITLES TYPE P, E, R, D                       
         DS    XL2                 SPARE                                        
*                                                                               
UCOMBLK  DS    XL(UCOMDLNQ)        DDUCOM CONTROL BLOCK                         
*                                                                               
UCOMPTLS DS    CL80                PRODUCT  TITLES SAVEAREA                     
UCOMETLS DS    CL80                ESTIMATE TITLES SAVEAREA                     
UCOMRTLS DS    CL80                REGION   TITLES SAVEAREA                     
UCOMDTLS DS    CL80                DISTRICT TITLES SAVEAREA                     
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'PRWRIVAL - PRINT WRITER VALIDATION PHASE - GRPVAL'              
PRWRIGEN CSECT                                                                  
***********************************************************************         
*                                                                     *         
*        VALIDATE GROUP CODE                                          *         
*                                                                     *         
*              ONE LETTER                                             *         
*              LETTER FOLLOWED BY 'ALL'                               *         
*              LETTER FOLLOWED BY NUMBER OR '*'                       *         
*                                                                     *         
*NTRY    R2 ==>  FIELD ON SCREEN                                      *         
*        R1 =    GROUP TYPE - CLIENT/PRODUCT/PUB                      *         
*                                                                     *         
*EXIT                                                                 *         
*                                                                     *         
***********************************************************************         
         DS    0D                                                               
VGRPCLTQ EQU   1                   VALIDATE CLIENT  GROUP                       
VGRPPRDQ EQU   2                   VALIDATE PRODUCT GROUP                       
VGRPPUBQ EQU   3                   VALIDATE PUB     GROUP                       
*                                                                               
GRPVAL   NMOD1 0,**#GRP**                                                       
***      =================  ***                                                 
         USING SPOOLD,R8                                                        
         USING GEND,RC                                                          
         USING SYSD,R9                                                          
         USING T405FFD,RA                                                       
***      =================  ***                                                 
         LA    RC,SPOOLEND         RESET WORKING STORAGE POINTER                
*                                                                               
         LR    R7,R1               SAVE GROUP TYPE INDICATOR                    
*                                                                               
         GOTO1 ANY                 READ IN FIELD                                
*                                                                               
*              STARTS WITH 'G=' OR '='                                          
*                                                                               
         LA    R1,WORK             POINT TO READ IN INPUT                       
         SR    RF,RF                                                            
         ICM   RF,1,5(R2)          INPUT LENGTH                                 
*                                                                               
         LA    R1,1(R1)            BUMP INPUT POINTER                           
         SHI   RF,1                DECREMENT INPUT LENGTH                       
*                                                                               
         CLI   8(R2),C'='          IF NOT OF FORM =G1234                        
         BE    *+12                                                             
         LA    R1,1(R1)               BUMP INPUT POINTER                        
         SHI   RF,1                   DECREMENT INPUT LENGTH                    
*                                                                               
         LTR   RF,RF                                                            
         BNP   VGPENONE            NO GRP ID ENTERED                            
*                                                                               
         CLI   0(R1),C'A'          FIRST POSITION MUST BE ALPHA                 
         BL    VGPENOTA                                                         
         CLI   0(R1),C'Z'                                                       
         BH    VGPENOTA                                                         
*                                                                               
         CHI   R7,VGRPCLTQ         IF CLIENT GROUP                              
         BNE   VGPCLTX                                                          
*                                                                               
         LA    R3,PBQGPCLT            SET CLIENT GROUP CODE                     
*                                                                               
         MVC   HALF,SPACES                                                      
         MVC   HALF(1),0(R1)          SAVE GROUP CODE                           
*                                                                               
         CLI   1(R1),C'0'             IF NEXT IS NOT NUMERIC                    
         BNL   VGPCLT10                                                         
         CLI   1(R1),C'*'             AND IF NEXT IS NOT WILDCARD               
         BE    VGPCLT10                                                         
*                                                                               
         LA    R1,1(R1)                  BUMP ID POINTER                        
         MVC   HALF+1(1),0(R1)           SAVE SECOND PART OF CODE               
         SHI   RF,1                      DECREMENT LENGTH COUNTER               
*                                                                               
VGPCLT10 DS    0H                                                               
*                                                                               
*        TRANSLATE CLIENT GROUP CODE TO 1 BYTE ID                               
*                                                                               
         LA    RE,SPCGRTAB         POINT TO CLIENT GROUP TABLE                  
*                                                                               
VGPCLTLP DS    0H                                                               
*                                                                               
         CLI   0(RE),X'FF'         INVALID IF EOT REACHED                       
         BE    VGPENOTV                                                         
*                                                                               
         CLC   HALF,0(RE)          MATCH ENTRY TO TABLE                         
         BE    VGPCLTFD                                                         
*                                                                               
VGPCLTCN DS    0H                                                               
         LA    RE,3(RE)            BUMP TO NEXT TABLE ENTRY                     
         B     VGPCLTLP                                                         
*                                                                               
VGPCLTFD DS    0H                                                               
*                                                                               
         MVC   0(1,R3),2(RE)       SAVE 1 BYTE GROUPID                          
*                                                                               
         B     VGPIDX                                                           
*                                                                               
VGPCLTX  DS    0H                                                               
*                                                                               
         CHI   R7,VGRPPRDQ         IF PRODUCT GROUP WANTED                      
         BNE   *+8                                                              
         LA    R3,PBQGPPRD            SWITCH POINTER                            
*                                                                               
         CHI   R7,VGRPPUBQ         IF PUB GROUP WANTED                          
         BNE   *+8                                                              
         LA    R3,PBQGPPUB            SWITCH POINTER                            
*                                                                               
         MVC   0(1,R3),0(R1)       SAVE GROUPID                                 
*                                                                               
VGPIDX   DS    0H                                                               
*                                                                               
         LA    R1,1(R1)            POINT TO NUMERIC PART OF ID                  
         SHI   RF,1                DECREMENT LENGTH COUNTER                     
*                                                                               
         MVC   1(L'PBQGPCLT-1,R3),SPACES INIT GROUP ID AREA                     
*                                                                               
         CHI   RF,1                DONE IF NO NUMERIC PART                      
         BL    VGPNIDX                                                          
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   1(0,R3),0(R1)       SAVE NUMERIC ID                              
*                                                                               
         CHI   RF,L'PBQGPCLT-2     CHECK MAX LENGTH OF GROUP ID                 
         BH    VGPENOTV                                                         
*                                                                               
VGPNIDX  DS    0H                                                               
*                                                                               
*        READ SCHEME RECORD TO VALIDATE SCHEME                                  
*                                                                               
         XC    KEY,KEY             GET SCHEME RECORD                            
*                                                                               
         LA    R4,KEY              ESTABLISH GROUP RECORD KEY                   
         USING GRPRECD,R4                                                       
*                                                                               
         MVC   GRPKAGY,AGENCY      SET AGENCY                                   
*                                                                               
         MVI   GRPKRCOD,GRPKCTYQ   ASSUME CLIENT GROUP                          
*                                                                               
         CHI   R7,VGRPPRDQ         IF PRODUCT GROUP WANTED                      
         BNE   VGPPRDN                                                          
*                                                                               
         MVI   GRPKRCOD,GRPKPTYQ      SET FOR PRODUCT GROUP                     
*                                                                               
         CLC   PBQCLT,=C'ALL'      IF NOT ALL CLIENTS WANTED                    
         BE    *+14                                                             
         MVC   GRPKCLT,PBQCLT         SET CLIENT CODE                           
         B     VGPPRDN                                                          
*                                                                               
         CLC   PBQGPCL1,=CL3' '    IF FIRST CLIENT IN GROUP KNOWN               
         BNH   *+10                                                             
         MVC   GRPKCLT,PBQGPCL1       USE IT                                    
*                                                                               
VGPPRDN  DS    0H                                                               
*                                                                               
         CHI   R7,VGRPPUBQ         IF PUB GROUP WANTED                          
         BNE   *+8                                                              
         MVI   GRPKRCOD,GRPKBTYQ      SET FOR PUB GROUP                         
*                                                                               
         MVC   GRPKID,0(R3)        SET SCHEME ID                                
*                                                                               
         BRAS  RE,CLTMED           FIND FIRST MEDIA                             
*                                                                               
VGPMEDLP DS    0H                                                               
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(04),KEYSAVE     MATCH TO AT LEAST MEDIA                      
         BNE   VGPMEDCN                                                         
*                                                                               
VGPKYLP  DS    0H                                                               
*                                                                               
         CLC   KEY(25),KEYSAVE     CHECK IF RECORD FOUND                        
         BE    VGPKYFD                                                          
*                                                                               
         CHI   R7,VGRPPRDQ         IF PRODUCT GROUP                             
         BNE   VGPKYDN                NO - TRY NEXT MEDIA                       
*                                                                               
         CLI   GRPKRCOD,GRPKPTYQ      MUST BE A PRODUCT GROUP RECORD            
         BNE   VGPKYDN                                                          
*                                                                               
         CLC   GRPKID,0(R3)        MATCH ON PRODUCT GROUP ID                    
         BNE   VGPKYCN                                                          
*                                                                               
         CLC   PBQGPCL1,=CL3' '    IF 1ST CLIENT IN CGROUP KNOWN                
         BNH   VGPKYFD1                                                         
*                                                                               
         CLC   GRPKCLT,PBQGPCL1       MUST MATCH                                
         BE    VGPKYFD                                                          
         B     VGPKYDN                TRY NEXT MEDIA                            
*                                                                               
VGPKYCN  DS    0H                                                               
*                                                                               
         GOTO1 SEQ                 READ NEXT GROUP ON FILE                      
*                                                                               
         B     VGPKYLP                                                          
*                                                                               
VGPKYFD1 DS    0H                                                               
*                                                                               
         MVC   PBQGPCL1,GRPKCLT    SAVE FIRST CLIENT                            
*                                                                               
VGPKYFD  DS    0H                                                               
*                                                                               
         B     VGPMEDFD                                                         
*                                                                               
VGPKYDN  DS    0H                                                               
*                                                                               
VGPMEDCN DS    0H                                                               
*                                                                               
         MVC   KEY,KEYSAVE         RESTORE STARTING KEY                         
         BRAS  RE,CLTMED           FIND NEXT MEDIA                              
         BE    VGPMEDLP                                                         
*                                                                               
VGPMEDDN DS    0H                                                               
         B     VGPENOTV                                                         
*                                                                               
VGPMEDFD DS    0H                                                               
*                                                                               
         SR    R0,R0                                                            
         ICM   R0,1,GRPKMED        SAVE MEDIA                                   
*                                                                               
         L     R4,AIO1             INDICATE WHERE TO READ RECORD INTO           
         ST    R4,AIO                                                           
*                                                                               
         GOTO1 GETREC              READ RECORD                                  
*                                                                               
*        FIND AND SAVE BREAK DESCRIPTION ELEMENT                                
*                                                                               
         LA    R6,GRPKEY+33        POINT TO FIRST ELEMENT                       
         USING GRPBRKD,R6          ESTABLISH AS BREAK DESCRIPTION ELM           
         SR    RF,RF                                                            
*                                                                               
         CLI   0(R6),0             CHECK FOR END OF RECORD                      
         BE    VGPENOTV            INVALID SCHEME                               
         CLI   GRPBRKCD,GRPBRKCQ   LOOK FOR BREAK DESC ELM                      
         BE    *+16                                                             
         ICM   RF,1,GRPBRKLN       ELEMENT LENGTH                               
         LA    R6,GRPBRKD(RF)      NEXT ELEMENT                                 
         B     *-24                                                             
*                                                                               
         CHI   R7,VGRPCLTQ         IF CLIENT  GROUP WANTED                      
         BNE   *+16                                                             
         LHI   R1,GPCBRKSV-SYSD       SET A(CLT BREAK DESC ELM SAVE)            
         LA    R1,SYSD(R1)                                                      
         ST    R1,PBAGPCBK                                                      
*                                                                               
         CHI   R7,VGRPPRDQ         IF PRODUCT GROUP WANTED                      
         BNE   *+16                                                             
         LHI   R1,GPPBRKSV-SYSD       SET A(PRD BREAK DESC ELM SAVE)            
         LA    R1,SYSD(R1)                                                      
         ST    R1,PBAGPPBK                                                      
*                                                                               
         CHI   R7,VGRPPUBQ         IF PUB     GROUP WANTED                      
         BNE   *+16                                                             
         LHI   R1,GPBBRKSV-SYSD       SET A(PUB BREAK DESC ELM SAVE)            
         LA    R1,SYSD(R1)                                                      
         ST    R1,PBAGPBBK                                                      
*                                                                               
*                                                                               
         IC    RF,GRPBRKLN         ELEMENT LENGTH                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R1),GRPBRKD     SAVE GROUP DESCRIPTION ELEMENT               
*                                                                               
         CLC   =C'ALL',1(R3)       DONE IF ALL OF SCHEME WANTED                 
         BE    VGPIDSX                                                          
*                                                                               
         OC    1(L'PBQGPCLC,R3),1(R3)   SAME AS ALL IF NO CODE                  
         BZ    VGPIDSX                                                          
*                                                                               
         LA    RF,PBQGPCLC-PBQGPCLT(R3)  START OF GROUP CODE                    
         LA    RE,L'PBQGPCLC       CODE LENGTH                                  
*                                                                               
         CLI   0(RF),C'*'          SKIP VALIDATION IF WILD CARD                 
         BE    VGPIDSX                                                          
         LA    RF,1(RF)                                                         
         BCT   RE,*-12                                                          
*                                  GROUP CODE ENTERED                           
         PACK  FULL(3),1(5,R3)     PACK 4 POSITION CODE WITHOUT SIGN            
*                                  GROUP CODE ENTERED                           
         LA    R4,KEY              RE-ESTABLISH KEY AS GRP RECORD KEY           
*                                  GROUP CODE ENTERED                           
         MVC   GRPKCODE,FULL       ADD CODE TO KEY                              
*                                  GROUP CODE ENTERED                           
         GOTO1 HIGH                                                             
*                                  GROUP CODE ENTERED                           
         CLC   GRPKEY,KEYSAVE      MUST FIND KEY                                
         BNE   VGPENOTF                                                         
*                                                                               
VGPIDSX  DS    0H                                                               
*                                                                               
         DROP  R4                                                               
*                                                                               
*        SEE IF SIGNON CAN ISSUE THIS REQUEST                                   
*                                                                               
VGPISCK  DS    0H                                                               
*                                                                               
         B     VGPISCKX            ALLOW ALL REQUESTS                           
*                                                                               
         CHI   R7,VGRPCLTQ             SKIP UNLESS CLIENT GROUP                 
         BNE   VGPISCKX                                                         
*                                                                               
         CLI   OFFLINE,C'Y'     SKIP IF OFF-LINE                                
         BE    VGPISCKX                                                         
*                                                                               
         ICM   RF,15,ASECBLK       ESTABLISH SECURITY BLOCK                     
         USING SECD,RF                                                          
         BZ    *+14                   NO SECURITY AVAILABLE                     
         OC    SECCLAL,SECCLAL     IF ON CLIENT STRING SECURITY                 
         BNZ   VGPISCKX               ALLOW REQUEST                             
*                                                                               
         DROP  RF                                                               
*                                                                               
*        NEED TO READ ALL CLIENT HEADERS IN GROUP                               
*           IF CLIENT BELONGS TO GROUP                                          
*           THEN IT MUST BE AVAILABLE TO SIGN ON                                
*                                                                               
*        INIT OFFICER PARAMETERS                                                
*                                                                               
         LA    R3,WORK             OFFICE LIST                                  
         XC    WORK,WORK           INIT OFFICER PARAMETERS                      
         USING OFFICED,R3                                                       
*                                                                               
         MVI   OFCSYS,C'P'         SYSTEM                                       
         MVC   OFCAUTH,TWAACCS     SIGN ON LIMITS                               
         MVC   OFCAGY,AGENCY       AGENCY ID                                    
         MVC   OFCLMT,TWAACCS      LIMIT ACCESS VALUE                           
*                                                                               
         MVC   OFCSECD,ASECBLK     A(FASECRET BLOCK)                            
*                                                                               
*        INIT GROUP MEMBERSHIP POINTER                                          
*                                                                               
         XC    KEY,KEY             INIT GROUP MEMBER KEY                        
         LA    R5,KEY              ESTABLISH GROUP MEMBER KEY                   
         USING GRPGKEY,R5                                                       
*                                                                               
         MVC   GRPGAGY,AGENCY      SET AGENCY                                   
         STCM  R0,1,GRPGMED        SET MEDIA                                    
*                                                                               
         MVI   GRPGTYP,GRPGCGQ     INDICATE CLIENT GROUP POINTER                
         MVC   GRPGID,PBQGPCLS     SET GROUP SCHEME ID                          
*                                                                               
         GOTO1 HIGH                READ FIRST MEMBERSHIP POINTER                
*                                                                               
VGPGSCKL DS    0H                                                               
*                                                                               
         CLC   GRPGKEY(GRPGCODE-GRPGKEY),KEYSAVE  DONE IF NEW ID                
         BNE   VGPGSCKD                                                         
*                                  BREAK OUT GROUP CODE                         
         UNPK  DUB(2*L'GRPGCODE+1),GRPGCODE(L'GRPGCODE+1)                       
*                                                                               
         LA    R1,PBQGPCLC         POINT TO REQUESTED PATTERN                   
         LA    RF,DUB              POINT TO CURRENT CODE                        
         LA    RE,L'PBQGPCLC       CODE LENGTH                                  
*                                                                               
VGPCDELP DS    0H                                                               
*                                                                               
         CLI   0(R1),C' '          ACCEPT IF END OF REQ PATTERN REACHED         
         BNH   VGPCDEDN                                                         
*                                                                               
         CLI   0(R1),C'*'          OKAY IF THIS POSITION IS WILD CARD           
         BE    VGPCDECN                                                         
*                                                                               
         CLC   0(1,R1),0(RF)       REJECT IF DIGIT DOESN'T MATCH                
         BNE   VGPGSCKC            SKIP THIS POINTER                            
*                                                                               
VGPCDECN DS    0H                                                               
*                                                                               
         LA    R1,1(R1)            BUMP POINTERS                                
         LA    RF,1(RF)                                                         
         BCT   RE,VGPCDELP                                                      
*                                                                               
VGPCDEDN DS    0H                  ACCEPT CLIENT CODE                           
*                                                                               
         NOP   VGPGSCKC                                                         
*                                                                               
VGPCDEFS DS    0H                  ACCEPT CLIENT CODE                           
*                                                                               
         CLC   PBQGPCL1,=CL3' '    IF FIRST CLIENT IN GROUP                     
         BH    *+10                                                             
         MVC   PBQGPCL1,GRPGVAL       SAVE CLIENT CODE                          
*                                                                               
         MVC   PBKEYSV,KEY         SAVE CURRENT POINTER                         
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY              ESTABLISH CLIENT KEY                         
         USING PCLTKEY,R4                                                       
*                                                                               
         MVC   PCLTKAGY,AGENCY     SET AGENCY                                   
         STCM  R0,1,PCLTKMED       SET MEDIA                                    
         MVI   PCLTKRCD,X'02'      SET RECORD ID                                
*                                                                               
         MVC   PCLTKCLT,GRPGVAL-GRPGKEY+PBKEYSV FILL IN CLIENT CODE             
*                                                                               
*        READ CLIENT HEADER AND CHECK SECURITY                                  
*                                                                               
         GOTO1 HIGH                READ CLIENT DIRECTORY POINTER                
*                                                                               
         CLC   PCLTKEY,KEYSAVE     MATCH AGY/MED/TYPE                           
         BNE   VGPESEC             MUST FIND KEY                                
*                                                                               
         GOTO1 GETREC              READ RECORD                                  
*                                                                               
         L     R6,AIO              POINT TO FOUND RECORD                        
         LA    R6,33(R6)           POINT TO FIRST ELEMENT IN RECORD             
*                                                                               
         USING PCLTELEM,R6         ESTABLISH CLIENT DESCRIPTION ELEMENT         
*                                                                               
*        USE OFFICER FOR SECURITY VALIDATION                                    
*                                                                               
         MVC   OFCPMED,PCLTKMED    MEDIA                                        
         MVC   OFCOFC,PCLTOFF      SET CLIENT OFFICE CODE                       
         MVC   OFCCLT,PCLTKCLT     SET CLIENT CODE                              
*                                                                               
         LHI   RF,TRAFID-SYSD      POINT TO TRAFFIC USERID IND                  
         LA    RF,SYSD(RF)                                                      
         CLI   0(RF),C'T'          IF TRAFFIC SIGN ON                           
         BNE   VGPSCK21                                                         
*                                                                               
         MVI   ELCODE,X'50'        TRAFFIC OFFICE ELEMENT                       
*                                                                               
         BRAS  RE,NEXTEL           FIND ELEMENT                                 
         BNZ   VGPSCK21            SKIP IF NO ELEM FOUND                        
         USING PCLTTOEL,R6         ESTABLISH TRAFFIC ELEMENT                    
*                                                                               
         MVC   OFCOFC,PCLTTOFC     VALIDATE TRAFFIC OFFICE                      
*                                                                               
VGPSCK21 DS    0H                                                               
*                                                                               
         GOTO1 OFFICER,DMCB,(C'N',OFFICED),ACOMFACS                             
*                                                                               
         CLI   0(R1),0                                                          
         BNE   VGPESEC             FAILS SECURITY TEST                          
*                                                                               
VGPGSCK9 DS    0H                                                               
*                                                                               
         MVC   KEY,PBKEYSV         RESTORE GROUP MEMBERSHIP PTR                 
*                                                                               
         GOTO1 HIGH                RE-POINT FILE                                
*                                                                               
VGPGSCKC DS    0H                                                               
*                                                                               
         GOTO1 SEQ                 READ NEXT DIRECTORY POINTER                  
*                                                                               
         B     VGPGSCKL                                                         
*                                                                               
VGPGSCKD DS    0H                                                               
*                                                                               
*        PASSES SECURITY TEST                                                   
*                                                                               
VGPISCKX DS    0H                                                               
*                                                                               
*        MAKE SURE REQUEST NOT TOO BIG FOR SOON                                 
*                                                                               
VGPIREQ  DS    0H                                                               
*                                                                               
         CLI   OFFLINE,C'Y'         IF OFF-LINE NO REQUEST RESTRICTIONS         
         BE    VGPIREQX                                                         
*                                                                               
         CLC   =C'SOON',CONWHEN    IF SOON REQUEST                              
         BNE   VGPIREQX                                                         
*                                                                               
         CH    R7,=Y(VGRPCLTQ)     SKIP UNLESS CLIENT GROUP                     
         BNE   VGPIREQX                                                         
*                                                                               
         OC    PBQGPCLC,PBQGPCLC   SKIP IF NOT ALL CLIENTS IN SCHEME            
         BNZ   VGPIREQX                                                         
*                                                                               
*        READ WL PROFILE                                                        
*                                                                               
         XC    DUB,DUB             PARAMETERS FOR GETPROF                       
*                                                                               
         MVI   DUB,C'P'            SET SYSTEM                                   
         MVC   DUB+2(2),=C'WL'     WL - LIMITS PROFILE                          
         MVC   DUB+4(2),PBQAGY     AGENCY                                       
         MVC   DUB+6(1),PBQMED     MEDIA                                        
         CLI   DUB+6,C'*'          MULTI MEDIA REPORTS DEFAULT TO M             
         BE    *+8                                                              
         CLI   DUB+6,C'C'                                                       
         BNE   *+8                                                              
         MVI   DUB+6,C'M'                                                       
*                                                                               
         GOTO1 GETPROF,DMCB,(X'C0',DUB),PBQPRFWL,DATAMGR                        
*                                                                               
         CLI   PBQPRFWL+1,C'A'     OKAY IF ALL CLIENTS/ALL MEDIA OKAY           
         BE    VGPISONX                                                         
*                                                                               
         CLI   PBQPRFWL+1,C'Y'     IF ALL CLIENTS ONLY ALLOWED FOR SOON         
         BNE   VGPISNER                                                         
*                                                                               
         CLI   PBQMED,C'*'            ALL MEDIA NOT ALLOWED                     
         BE    VGPISNER                                                         
         CLI   PBQMED,C'C'                                                      
         BE    VGPISNER                                                         
*                                  ELSE REQUEST ALLOWED                         
VGPISONX DS    0H                                                               
*                                                                               
VGPIREQX DS    0H                                                               
*                                                                               
         MVI   ERROR,0             TURN OFF ERROR                               
         CR    RB,RB               SET CC TO EQ                                 
         B     GRPVALX                                                          
*                                                                               
*        ERROR ROUTINES                                                         
*                                                                               
VGPENONE DS    0H                  MISSING GROUP CODE                           
         MVI   ERROR,PWEGPNO       SET ERROR CODE                               
         B     VGPERR                                                           
*                                                                               
*                                                                               
VGPENOTF DS    0H                  GROUP CODE NOT ON FILE                       
         MVI   ERROR,PWEGPNFD      SET ERROR CODE                               
         B     VGPERR                                                           
*                                                                               
VGPENOTA DS    0H                  GROUP SCHEME NOT ALPHA                       
         MVI   ERROR,PWEGPNMN      SET ERROR CODE                               
         B     VGPERR                                                           
*                                                                               
VGPENOTV DS    0H                  INVALID GROUP CODE                           
         MVI   ERROR,PWEGPINV      SET ERROR CODE                               
         B     VGPERR                                                           
*                                                                               
VGPESEC  DS    0H                  SECURITY LOCKOUT                             
         MVI   ERROR,SECLOCK       SET ERROR CODE                               
         B     VGPERR                                                           
*                                                                               
VGPISNER DS    0H                                                               
         MVI   ERROR,PWESOONR      SOON RESTRICTION REQUEST ERROR               
*                                                                               
VGPERR   DS    0H                                                               
*                                                                               
         MVI   FIELDERR,1          FIRST FIELD IN ERROR                         
         XC    BLOCK(42),BLOCK     INIT SCANNER BLOCK AREA                      
         LA    R4,BLOCK            DUNMMY SCANNER BLOCK                         
*                                                                               
         GOTO1 CURSERR             GO HANDLE ERROR MESSAGE                      
*                                                                               
GRPVALX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
       ++INCLUDE SPCGRTAB                                                       
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'PRWRIGEN - VALIDATE AOR OPTION  - VOPTAOR'                      
***********************************************************************         
*                                                                     *         
*        VALIDATE AOR OPTION INPUT                                    *         
*                                                                     *         
*NTRY    R4 ==>   SCANNER BLOCK                                       *         
*        R2 ==>   FIELD ON SCREEN                                     *         
*                                                                     *         
*EXIT                                                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
VOPTAOR  NMOD1 0,**#VOA                                                         
*                                                                               
         USING SPOOLD,R8                                                        
         USING SYSD,R9                                                          
*                                                                               
         LA    RC,SPOOLEND         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         MVI   PBQADVSW,C'Y'       INDICATE AOR TYPE REPORT                     
         LA    RF,HELPCBLK         SET FLAVOR IN HELP CONTROL BLOCK             
         MVI   HCBAOR-HELPCB(RF),PKVAORY   INDICATE AOR TYPE REPORT             
         L     RF,AVLPARMS                 POINT TO DDVAL PARMS                 
         MVI   VLFLT1V-VLPARMS(RF),PKVAORY  INDICATE AOR REPORT                 
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,1(R4)          OPTION LENGTH                                
         BZ    VOPTAOR1            NO ENTRY DEFAULTS TO AOR REPORT              
*                                     FOR ALL BUYING AGENCIES                   
*                                     AND ALL CLIENTS                           
*                                                                               
         LA    R1,22(R4)           POINT TO START OF AGENCY CODE                
*                                                                               
         CLI   0(R1),C'/'          C'/' MEANS END OF AGENCY CODE                
         BE    *+12                                                             
         LA    R1,1(R1)            BUMP POINTER                                 
         BCT   RF,*-12                                                          
*                                                                               
         ST    R1,DUB              SAVE '/' ADDRESS                             
*                                                                               
         LR    RF,R1               CALCULATE AGENCY ID LENGTH                   
         LA    R1,22(R4)                                                        
         SR    RF,R1               AGENCY ID LENGTH                             
         BZ    VOPTAOR1            NO-ENTRY DEFAULTS TO 'ALL'                   
*                                                                               
         CH    RF,=H'3'            LENGTH > 3 INDICATES FILTER                  
         BH    VOPTAFL                                                          
*                                                                               
         BL    *+18                                                             
         CLC   =C'ALL',22(R4)      CHECK FOR 'ALL'                              
         BNE   VOPTAFL             FILTER IF NOT                                
         B     VOPTAOR1            ELSE OKAY                                    
*                                                                               
         CH    RF,=H'2'            LENGTH MUST BE NOW 2                         
         BL    VOPTAOER            ELSE ERROR                                   
*                                                                               
         MVC   PBQQAGY,22(R4)      SAVE REQUESTED AGENCY                        
*                                                                               
         B     VOPTAOR1                                                         
*                                                                               
VOPTAFL  DS    0H                  VALIDATE AGENCY FILTER                       
*                                                                               
         LR    R3,RF               FILTER INPUT LENGTH                          
         LA    R1,22(R4)           POINT TO START OF AGENCY FILTER              
         LA    RE,L'PBQQAGFL       SET MAX NUMBER OF FILTERS                    
         LA    RF,PBQQAGFL         SAVEAREA                                     
*                                                                               
VOPTAFLL DS    0H                  VALIDATE AGENCY FILTER                       
*                                                                               
         CLI   0(R1),C'-'          IF NEGATIVE FILTER                           
         BNE   VOPTAFL2                                                         
*                                                                               
         BCT   R3,*+8                 DECREMENT INPUT COUNTER                   
         B     VOPTAOE3                MUST HAVE FOLLOWING INPUT                
         LA    R1,1(R1)               BUMP INPUT POINTER                        
         NI    0(R1),X'FF'-X'40'      CHANGE INPUT TO LOWERCASE                 
*                                                                               
VOPTAFL2 DS    0H                                                               
*                                                                               
         MVC   0(1,RF),0(R1)       SAVE FILTER COMPONENT                        
*                                                                               
VOPTAFLC DS    0H                                                               
*                                                                               
         LA    R1,1(R1)            BUMP TO NEXT PART OF FILTER                  
         BCTR  R3,0                DECREMENT INPUT COOUNTER                     
*                                                                               
         LA    RF,1(RF)            BUMP TO NEXT FILTER POSITION                 
         BCT   RE,VOPTAFLL                                                      
*                                                                               
         LTR   R3,R3               INPUT MUST BE EXHAUSTED                      
         BNZ   VOPTAOE3            INCOMPLETE FILTER                            
*                                                                               
VOPTAFLD DS    0H                                                               
*                                                                               
VOPTAOR1 DS    0H                                                               
*                                                                               
         L     R1,DUB              RESTORE C'/' POINTER                         
         LA    R1,1(R1)            POINT TO START OF CLIENT                     
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,1(R4)          LENGTH OF AOR OPTION                         
         BZ    VOPTACLX            NO ENTRY MEANS ALL CLIENTS                   
         LA    RF,22(RF,R4)        END OF AOR OPTION                            
         SR    RF,R1               LENGTH OF CLIENT AOPTION                     
         BNP   VOPTACLX            NO ENTRY OKAY = 'ALL'                        
*                                                                               
         CH    RF,=H'3'            CAN'T BE MORE THAN 3 LONG                    
         BH    VOPTCLE1                                                         
         BL    *+14                                                             
         CLC   =C'ALL',0(R1)       OKAY IF 'ALL'                                
         BE    VOPTACLX                                                         
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         MVC   PBQQCLT,SPACES                                                   
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   PBQQCLT(0),0(R1)                                                 
*                                                                               
VOPTACLX DS    0H                                                               
*                                                                               
         B     VOPTAORX                                                         
*                                                                               
VOPTAORX DS    0H                                                               
         XIT1                                                                   
*                                                                               
*        ERROR EXITS                                                            
*                                                                               
VOPTCLE1 DS    0H                                                               
         MVI   ERROR,PWEOPCL1      NOT A CLIENT FOR ADVERTISER                  
         B     VOPTAORE                                                         
*                                                                               
VOPTAOER DS    0H                                                               
         MVI   ERROR,PWEOPAOE      INVALID AGENCY                               
         B     VOPTAORE                                                         
*                                                                               
VOPTAOE3 MVI   ERROR,PWEOPAO3      INVALID AGENCY FILTER                        
         B     VOPTAORE                                                         
*                                                                               
VOPTAORE ST    R4,DMCB+8           SAVE ERROR POINTER                           
         GOTO1 CURSERR             PUT OUT ERROR MESSAGE                        
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'PRWRIGEN - VALIDATE ADDITIONAL CHGS OPTION  - ACHGVAL'          
***********************************************************************         
*                                                                     *         
*        VALIDATE ADDITIONAL CHARGES REPORTING OPTIONS                *         
*                                                                     *         
*NTRY    R4 ==>   SCANNER BLOCK                                       *         
*        R2 ==>   FIELD ON SCREEN                                     *         
*                                                                     *         
*        ACHG=    LIST - LIST ALL ADDITIONAL CHARGES SEPARATELY       *         
*                 EXCLUDE - EXCLUDE ADDITIONAL CHARGES                *         
*                 INCLUDE ADDITIONAL CHARGES IN $ FIELDS - DEFAULT    *         
*                 ONLY - REPORT ONLY TOTAL FOR ALL ADDITIONAL CHGS    *         
*                 'XX' - REPORT DOLLARS ONLY FOR ADDNL CHG XX         *         
*                                                                     *         
*EXIT                                                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
ACHGVAL  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING SPOOLD,R8                                                        
         USING SYSD,R9                                                          
         USING GEND,RC                                                          
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,1(R4)          OPTION LENGTH                                
         BZ    ACHGVALX            NO ENTRY DEFAULTS TO INCLUDE                 
*                                                                               
         CLI   22(R4),C'+'         IF HELP REQUESTED                            
         BE    *+8                                                              
         CLI   22(R4),C'?'         IF HELP REQUESTED                            
         BNE   ACVHLPX                                                          
*                                                                               
         GOTO1 VPRHELP,DMCB,=AL2(PRQHMACH),(R2),HELPCBLK SHOW HELP MENU         
*                                     FOR OPTIONS                               
*                                                                               
         DC    H'0'                SHOULD NOT COME BACK                         
*                                                                               
ACVHLPX  DS    0H                                                               
*                                                                               
*        VALIDATE ADDITIONAL CHARGES REPORTING OPTION                           
*                                                                               
         L     R1,AVLPARMS                                                      
         USING VLPARMS,R1          ESTABLISH DDVAL PARAMETERS                   
*                                                                               
         GOTO1 VDDVAL,(R1),('VLPVALQ',=AL2(PRQACHGS)),                 X        
               (1(R4),22(R4)),AVLTAB,0,0,0                                      
*                                                                               
         CLI   VLPERR,0            IF THERE ARE  ERRORS                         
         JNE   ACVONE                 GO CHECK FOR SINGLE CODE FILTER           
*                                                                               
         L     R5,AVLTAB           POINT TO RETURNED TABLE                      
         USING VLTABD,R5           ESTABLISH TABLE ENTRY                        
*                                                                               
         SR    RF,RF               GET INTERNAL CODE                            
         ICM   RF,3,VLTICODE                                                    
*                                                                               
         DROP  R1,R5                                                            
*                                                                               
         CHI   RF,PRQACINC         IF INCLUDING ADDITIONAL CHARGES              
         BE    ACHGVALX               DONE - IT IS THE DEFAULT                  
*                                                                               
         OI    PBQACHGS,PBQACOPQ   INDICATE ACHG OPTION ACTIVE                  
*                                                                               
         CHI   RF,PRQACEXC         IF EXCLUDING ADDITIONAL CHARGES              
         BNE   *+12                                                             
         OI    PBQACHGS,PBQACEXQ      SET FLAG                                  
         B     ACHGVALX                                                         
*                                                                               
         CHI   RF,PRQACONL         IF ONLY      ADDITIONAL CHARGES              
         BNE   *+12                                                             
         OI    PBQACHGS,PBQACONQ      SET FLAG                                  
         B     ACHGVALX                                                         
*                                                                               
         CHI   RF,PRQACLST         IF LISTING ADDITIONAL CHARGES                
         BNE   *+12                                                             
         OI    PBQACHGS,PBQACLSQ      SET FLAG                                  
         B     ACHGVALX                                                         
*                                                                               
         CHI   RF,PRQACXFX         IF EXCLUDING FX ADDITIONAL CHARGE            
         BNE   *+12                                                             
         OI    PBQACHGS,PBQACXFQ      SET FLAG                                  
         B     ACHGVALX                                                         
*                                                                               
         B     ACVNOTV             INVALID OPTION                               
*                                                                               
*        ASSUME CODE FOR SINGLE ADDITIONAL CHARGE                               
*                                                                               
ACVONE   DS    0H                                                               
*                                                                               
         CLI   1(R4),L'PBQACHG     MAX LENGTH OF ACHRG CODE                     
         BH    ACVNOTV                                                          
*                                                                               
         MVC   PBQACHG,22(R4)      SAVE CHARGE CODE                             
         OC    PBQACHG,SPACES      SPACE FILL                                   
*                                                                               
         CLC   =C'FX',PBQACHG      FX = FOREIGN EXCHANGE                        
         BE    ACVACDFD               FOR EVERYONE                              
*                                                                               
         XC    KEY,KEY                                                          
         LA    R6,KEY              ESTABLISH ADDITIONAL CHARGES REC             
         USING PSPLRECD,R6                                                      
*                                                                               
         MVC   PSPLKAGY,AGENCY     SET AGENCY                                   
         MVI   PSPLKRCD,PSPLKIDQ   SET RECORD CODE                              
*                                                                               
         BRAS  RE,CLTMED           FIND FIRST MEDIA                             
*                                                                               
ACVMEDLP DS    0H                                                               
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(25),KEYSAVE     TEST IF RECORD FOUND                         
         BE    ACVMEDFD                                                         
*                                                                               
ACVMEDCN DS    0H                                                               
*                                                                               
         MVC   KEY,KEYSAVE         RESTORE STARTING KEY                         
*                                                                               
         BRAS  RE,CLTMED           FIND NEXT MEDIA                              
         BE    ACVMEDLP                                                         
*                                                                               
ACVMEDDN DS    0H                                                               
         B     ACVNOTF                                                          
*                                                                               
ACVMEDFD DS    0H                                                               
*                                                                               
         MVC   AIO,AIO1            READ INTO IOAREA1                            
*                                                                               
         GOTO1 GETREC              READ RECORD                                  
*                                                                               
         MVI   ELCODE,X'10'        SET CHARGE CODE ELM ID                       
         L     R5,AIO              POINT TO FOUND RECORD                        
         BRAS  RE,GETEL            KIND FIRST ELEMENT                           
         BNE   ACVNOTF             NONE FOUND                                   
*                                                                               
ACVACDLP DS    0H                                                               
*                                                                               
         USING PSPLELEM,R5         ESTABLISH CHARGE ELEMENT                     
*                                                                               
         CLC   PBQACHG,PSPLCODE    MATCH ON CHARGE CODE                         
         BE    ACVACDFD                                                         
*                                                                               
ACVACDCN DS    0H                                                               
         BRAS  RE,NEXTEL           FIND NEXT ELEMENT                            
         BE    ACVACDLP                                                         
*                                                                               
         B     ACVNOTF             CODE NOT FOUND                               
*                                                                               
ACVACDFD DS    0H                  CODE IS VALID                                
*                                                                               
         OI    PBQACHGS,PBQACOPQ+PBQAC1Q  ACH OPT ACTIVE AND 2 CODE             
*                                                                               
ACVONEX  DS    0H                                                               
*                                                                               
ACHGVALX DS    0H                                                               
         XIT1                                                                   
*                                                                               
*        ERROR EXITS                                                            
*                                                                               
ACVNOTV  DS    0H                                                               
         MVI   ERROR,PWEACHNV      ADDITIONAL CHARGES OPTION INVALID            
         B     ACVERR                                                           
*                                                                               
ACVNOTF  DS    0H                                                               
         MVI   ERROR,PWEACHNF      ADDITIONAL CHARGE NOT FOUND                  
         B     ACVERR                                                           
*                                                                               
ACVERR   ST    R4,DMCB+8           SAVE ERROR POINTER                           
         GOTO1 CURSERR             PUT OUT ERROR MESSAGE                        
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'PRWRIGEN - VALIDATE BUY CHANGES FILTER - BCHGVAL'               
***********************************************************************         
*                                                                     *         
*        VALIDATE ADDITIONAL CHARGES REPORTING OPTIONS                *         
*                                                                     *         
*NTRY    R4 ==>   SCANNER BLOCK                                       *         
*        R2 ==>   FIELD ON SCREEN                                     *         
*                                                                     *         
*        BCHGS=   REPORT ALL BUYS WHICH HAVE HAD THIS TYPE OF DATA    *         
*                 CHANGED                                             *         
*                 IF NEGATIVE SUGN PRECEDES CHANGE TYPE THEN          *         
*                 REPORT IGNORES THIS TYPE OF CHANGE WHEN FILTERING   *         
*                                                                     *         
*EXIT                                                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
BCHGVAL  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING SPOOLD,R8                                                        
         USING SYSD,R9                                                          
         USING GEND,RC                                                          
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,1(R4)          OPTION LENGTH                                
         BZ    BCHVNOTE            NO ENTRY IS AN ERROR                         
*                                                                               
         CLI   22(R4),C'+'         IF HELP REQUESTED                            
         BE    *+8                                                              
         CLI   22(R4),C'?'         IF HELP REQUESTED                            
         BNE   BCHVHLPX                                                         
*                                                                               
         GOTO1 VPRHELP,DMCB,=AL2(PRQHMBCH),(R2),HELPCBLK SHOW HELP MENU         
*                                     FOR OPTIONS                               
*                                                                               
         DC    H'0'                SHOULD NOT COME BACK                         
*                                                                               
BCHVHLPX DS    0H                                                               
*                                                                               
*        VALIDATE ADDITIONAL CHARGES REPORTING OPTION                           
*                                                                               
         SR    R0,R0                                                            
         IC    R0,1(R4)            GET FILTER LENGTH                            
*                                                                               
         LA    RF,22(R4)           POINT TO START OF FILTER                     
*                                                                               
         CLI   0(RF),C'-'          IF FILTER DOESN'T START WITH MINUS           
         BE    BCHV10                                                           
*                                                                               
         TM    PBQBCHOP,PBQBCHNG      NO OTHER FILTERS CAN BE NEGATIVE          
         BO    BCHVMIXE                                                         
*                                                                               
         OI    PBQBCHOP,PBQBCHPS      BCHGS FILTER IS POSITIVE                  
         B     BCHV20                                                           
*                                                                               
BCHV10   DS    0H                  FILTER IS NEGATIVE                           
*                                                                               
         TM    PBQBCHOP,PBQBCHPS      NO OTHER FILTERS CAN BE POSITIVE          
         BO    BCHVMIXE                                                         
*                                                                               
         LA    RF,1(RF)               BUMP TO START OF FILTER                   
         BCTR  R0,0                   DECREMENT FILTER LENGTH                   
         OI    PBQBCHOP,PBQBCHNG      BCHGS FILTER IS NEGATIVE                  
*                                                                               
BCHV20   DS    0H                                                               
*                                                                               
         L     R1,AVLPARMS                                                      
*                                                                               
         GOTO1 VDDVAL,(R1),('VLPVALQ',=AL2(PRQBCHGS)),                 X        
               ((R0),0(RF)),AVLTAB,0,0,0                                        
*                                                                               
         CLI   VLPERR,0            IF THERE ARE  ERRORS                         
         JNE   BCHVNOTF                ERROR                                    
*                                                                               
         L     R5,AVLTAB           POINT TO RETURNED TABLE                      
         USING VLTABD,R5           ESTABLISH TABLE ENTRY                        
*                                                                               
         OC    PBQBCHGS,VLTEXTRA   SAVE MASK FOR THIS TYPE OF CHG               
*                                                                               
         DROP  R5                                                               
*                                                                               
BCHGVALX DS    0H                                                               
         XIT1                                                                   
*                                                                               
*        ERROR EXITS                                                            
*                                                                               
BCHVNOTE DS    0H                                                               
         LHI   RF,PWEBCREQ         BUY CHANGE TYPE REQUIRED                     
         B     BCHVERR                                                          
*                                                                               
BCHVNOTF DS    0H                                                               
         LHI   RF,PWEBCINV         BUY CHANGE TYPE NOT FOUND                    
         B     BCHVERR                                                          
*                                                                               
BCHVMIXE DS    0H                                                               
         LHI   RF,PWEBCMIX         BUY CHANGE TYPE NOT FOUND                    
         B     BCHVERR                                                          
*                                                                               
BCHVERR  ST    R4,DMCB+8           SAVE ERROR POINTER                           
*                                                                               
         USING GETTXTD,GETTXTCB    ESTABLISH GETTXT CONTROL BLOCK               
*                                                                               
         STCM  RF,3,GTMSGNO        SET ERROR MESSAGE NUMBER                     
*                                                                               
         GOTO1 CURSERR             PUT OUT ERROR MESSAGE                        
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'PRWRIGEN - VALIDATE BUY CHANGES FILTER - PSRCVAL'               
***********************************************************************         
*                                                                     *         
*        VALIDATE ADDITIONAL CHARGES REPORTING OPTIONS                *         
*                                                                     *         
*NTRY    R4 ==>   SCANNER BLOCK                                       *         
*        R2 ==>   FIELD ON SCREEN                                     *         
*                                                                     *         
*        PAYSRC=  SCRIPT/-SCRIPT                                      *         
*                                                                     *         
*EXIT                                                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
PSRCVAL  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING SPOOLD,R8                                                        
         USING SYSD,R9                                                          
         USING GEND,RC                                                          
*                                                                               
         LLC   RF,1(R4)            OPTION LENGTH                                
         JZ    VOPTNVER            NEED AN ENTRY                                
         LA    R1,22(R4)           POINT TO ENTERED OPTION                      
*                                                                               
         CLC   =C'-SCRIPT',0(R1)   -SCRIPT?                                     
         BNE   PSRC10              NO                                           
         OI    PBQOPTS,PBQNSCPT    YES                                          
         B     PSRCX               DONE                                         
*                                                                               
PSRC10   CLC   =C'SCRIPT',0(R1)    SCRIPT?                                      
         JNE   VOPTNVER            NO - ERROR                                   
         OI    PBQOPTS,PBQYSCPT    YES                                          
*                                                                               
PSRCX    XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'PRWRIGEN - VALIDATE PUB LOCK FILTER - PUBLOCK'                  
***********************************************************************         
*                                                                     *         
*        VALIDATE PUBLOCK OPTIONS                                     *         
*                                                                     *         
*NTRY    R4 ==>   SCANNER BLOCK                                       *         
*        R2 ==>   FIELD ON SCREEN                                     *         
*                                                                     *         
*        PUBLOCK = Y/N                                                *         
*                                                                     *         
*EXIT                                                                 *         
*                                                                     *         
***********************************************************************         
         DS    0D                                                               
PUBLOCK  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING SPOOLD,R8                                                        
         USING SYSD,R9                                                          
         USING GEND,RC                                                          
*                                                                               
         LLC   RF,1(R4)            OPTION LENGTH                                
         JZ    VOPTNVER            NEED AN ENTRY                                
         LA    R1,22(R4)           POINT TO ENTERED OPTION                      
*                                                                               
         CLI   0(R1),C'Y'          PUBLOCK = Y?                                 
         JNE   *+12                NO                                           
         OI    PBQOPTS2,PBQOPLKY   YES - SET PUBLOCK=Y FLAG                     
         J     PLOCKX              DONE                                         
*                                                                               
         CLI   0(R1),C'N'          PUBLOCK = N?                                 
         JNE   VOPTNVER            NO - ERROR                                   
         OI    PBQOPTS2,PBQOPLKN   YES - SET PUBLOCK=N FLAG                     
*                                                                               
PLOCKX   XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'PRWRIGEN - VALIDATE TEARSHEET FILTER  - TSSVAL'                 
***********************************************************************         
*                                                                     *         
*        VALIDATE TEARSHEET FILTER VALUES                             *         
*                                                                     *         
*NTRY    R4 ==>   SCANNER BLOCK                                       *         
*        R2 ==>   FIELD ON SCREEN                                     *         
*                                                                     *         
*        TSSTATUS = C'A' APPROVED                                     *         
*                   C'N' NOT APPROVED                                 *         
*                   C'X' NOT ENTERED                                  *         
*                                                                     *         
*EXIT                                                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
TSSVAL   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING SPOOLD,R8                                                        
         USING SYSD,R9                                                          
         USING GEND,RC                                                          
*                                                                               
*        LA    R7,PBLOCK           ESTABLISH PRINT BLOCK                        
*        USING PBLOCK,R7                                                        
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,1(R4)          OPTION LENGTH                                
         BZ    TSSNOTVE            NO ENTRY NOT ALLOWED                         
*                                                                               
         CLI   22(R4),C'+'         IF HELP REQUESTED                            
         BE    *+8                                                              
         CLI   22(R4),C'?'         IF HELP REQUESTED                            
         BNE   TSSHLPX                                                          
*                                                                               
         GOTO1 VPRHELP,DMCB,=AL2(PRQHMTSS),(R2),HELPCBLK SHOW HELP MENU         
*                                     FOR FILTER                                
*                                                                               
         DC    H'0'                SHOULD NOT COME BACK                         
*                                                                               
TSSHLPX  DS    0H                                                               
*                                                                               
*        VALIDATE TEARSHEET STATUS REPORTING OPTION                             
*                                                                               
         L     R1,AVLPARMS                                                      
         USING VLPARMS,R1          ESTABLISH DDVAL PARAMETERS                   
*                                                                               
         GOTO1 VDDVAL,(R1),('VLPVALQ',=AL2(PRQOPTSS)),                 X        
               (1(R4),22(R4)),AVLTAB,0,0,0                                      
*                                                                               
         CLI   VLPERR,0            CHECK FOR ERRORS                             
         JNE   TSSNOTVE                                                         
*                                                                               
         L     R5,AVLTAB           POINT TO RETURNED TABLE                      
         USING VLTABD,R5           ESTABLISH TABLE ENTRY                        
*                                                                               
         SR    RF,RF               GET INTERNAL CODE                            
         ICM   RF,3,VLTICODE                                                    
*                                                                               
         CHI   RF,PRQTSSTA         TRANSLATE STATUS                             
         BNE   *+12                                                             
         MVI   PBQTSSTA,C'A'                                                    
         B     TSSVALX                                                          
*                                                                               
         CHI   RF,PRQTSSTN         TRANSLATE STATUS                             
         BNE   *+12                                                             
         MVI   PBQTSSTA,C'N'                                                    
         B     TSSVALX                                                          
*                                                                               
         CHI   RF,PRQTSSTB         TRANSALTE STATUS                             
         BNE   *+12                                                             
         MVI   PBQTSSTA,C'X'                                                    
         B     TSSVALX                                                          
*                                                                               
         B     TSSNOTVE            INVALID VALUE                                
*                                                                               
         DROP  R1,R5                                                            
*                                                                               
TSSVALX DS     0H                                                               
         XIT1                                                                   
*                                                                               
*        ERROR EXITS                                                            
*                                                                               
TSSNOTVE DS    0H                                                               
         MVI   ERROR,PWETSSNV      TEARSHEET FILTER INVALID                     
         B     TSSERR                                                           
*                                                                               
TSSERR   ST    R4,DMCB+8           SAVE ERROR POINTER                           
         GOTO1 CURSERR             PUT OUT ERROR MESSAGE                        
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'PRWRIGEN - VALIDATE BILL TYPE OPTION  - VOPTBTP'                
***********************************************************************         
*                                                                     *         
*        VALIDATE AOR OPTION INPUT                                    *         
*                                                                     *         
*NTRY    R4 ==>   SCANNER BLOCK                                       *         
*        R2 ==>   FIELD ON SCREEN                                     *         
*                                                                     *         
*EXIT                                                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
VOPTBTP  NMOD1 0,**#VBT                                                         
*                                                                               
         USING SPOOLD,R8                                                        
         USING SYSD,R9                                                          
*                                                                               
         LA    RC,SPOOLEND         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
*                                  BILL TYPE SELECTION                          
*                                    BTYPE = CN                                 
*                                     C   = 'B' OR 'M' OR 'A' OR 'R'            
*                                     N   = 4-7 OR ' '                          
*                                    AOR                                        
*                                    UFC                                        
*                                    NET                                        
*                                    COM                                        
*                                    CLR - CLEARED INSERTIONS ONLY              
*                                                                               
*        COMBO FORM IS      UFC/B4                                              
*                                                                               
*        ANY FORM CAN BE PRECEDED BY '-' TO EXCLUDE TYPE                        
*                                                                               
         MVC   PBQBTYPE,=C'  '     INIT BILL TYPE SAVEAREA                      
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,1(R4)          OPTION LENGTH                                
         BZ    VBTPNVER            NEED AN ENTRY                                
         LA    R1,22(R4)           POINT TO ENTERED OPTION                      
*                                                                               
         CLI   22(R4),C'-'         CHECK IF TYPE BEING EXCLUDED                 
         BNE   *+20                                                             
         OI    PBQBLLOP,PBQBNBTQ   INDICATE EXCLUDING BILL TYPE                 
         LA    R1,1(R1)            BUMP TO NEXT INPUT BYTE                      
         BCT   RF,*+8              DECREMENT LENGTH                             
         BZ    VBTPNVER            NEED AN ENTRY                                
*                                                                               
         CLC   =C'UFC',0(R1)       CHECK FOR 'UFC' BILLING                      
         BNE   *+12                                                             
         OI    PBQBLLOP,PBQBUFCQ   FLAG FOR UFC BILLS                           
         B     VOPT3CHX                                                         
*                                                                               
         CLC   =C'NET',0(R1)       CHECK FOR 'NET' BILLING                      
         BNE   *+12                                                             
         OI    PBQBLLOP,PBQBNETQ   FLAG FOR NET BILLS                           
         B     VOPT3CHX                                                         
*                                                                               
         CLC   =C'COM',0(R1)       CHECK FOR 'COM' BILLING                      
         BNE   *+12                                                             
         OI    PBQBLLOP,PBQBCOMQ   FLAG FOR COMMISSION BILLS                    
         B     VOPT3CHX                                                         
*                                                                               
         CLC   =C'CLR',0(R1)       CHECK FOR 'CLR' BILLING                      
         BNE   *+12                                                             
         OI    PBQBLLOP,PBQBCLRQ   FLAG FOR CLEARED BUYS BILLS                  
         B     VOPT3CHX                                                         
*                                                                               
         CLC   =C'ORD',0(R1)       CHECK FOR 'ORD' BILLING                      
         BNE   *+16                                                             
         XI    PBQBLLOP,PBQBNBTQ   SWITCH NEGATIVE FLAG                         
         OI    PBQBLLOP,PBQBCLRQ   FLAG FOR ORDERED BUYS BILLS                  
         B     VOPT3CHX                                                         
*                                                                               
         CLC   =C'AOR',0(R1)       CHECK FOR 'AOR' BILLING                      
         BNE   VOPTBARN                                                         
*                                                                               
         OI    PBQBLLOP,PBQBAORQ   FLAG FOR AOR BILLS                           
*                                                                               
VOPT3CHX DS    0H                                                               
*                                                                               
         LA    R1,3(R1)            BUMP POINTER                                 
         SH    RF,=H'3'            DECREMENT LENGTH COUNTER                     
         BZ    VOPTBTPX            OKAY IF NO MORE ENTRY                        
         BM    VBTPNVER            RUNNING PAST INPUT END                       
*                                                                               
         CLI   0(R1),C'/'          MUST BE FOLLOWED BY '/'                      
         BNE   VBTPNVER                                                         
*                                                                               
         LA    R1,1(R1)            BUMP TO NEXT INPUT BYTE                      
         BCT   RF,*+8              DECREMENT LENGTH                             
         BZ    VBTPNVER            NEED AN ENTRY                                
*                                                                               
VOPTBARN DS    0H                                                               
*                                                                               
         CLI   0(R1),C'0'          SKIP IF NUMERIC                              
         BNL   VOPTBTP2                                                         
*                                                                               
         CLI   0(R1),C'B'          'B' REGULAR BILLING                          
         BE    *+8                                                              
         CLI   0(R1),C'M'          'M' MANUAL  BILLING                          
         BE    *+8                                                              
         CLI   0(R1),C'R'          'R' REBATE  BILLING                          
         BE    *+8                                                              
         B     VBTPNVER            INVALID BILL TYPE                            
*                                                                               
         MVC   PBQBTYPE(1),0(R1)   SAVE BILL TYPE                               
*                                                                               
         BCTR  RF,0                DECREMENT LENGTH COUNTER                     
         LA    R1,1(R1)            BUMP POINTER                                 
*                                                                               
VOPTBTP2 DS    0H                                                               
*                                                                               
         CH    RF,=H'1'            LENGTH MUST BE AT MOST 1 NOW                 
         BH    VBTPNVER                                                         
*                                                                               
         BL    VOPTBTPX            OKAY IF NO ENTRY                             
*                                                                               
         CLI   0(R1),C'4'          MUST BE '4' - '7'                            
         BL    VBTPNVER                                                         
         CLI   0(R1),C'7'                                                       
         BH    VBTPNVER                                                         
*                                                                               
         MVC   PBQBTYPE+1(1),0(R1)  SAVE BILL TYPE SECOND PART                  
*                                                                               
VOPTBTPX DS    0H                                                               
         XIT1                                                                   
*                                                                               
VBTPNVER DS    0H                                                               
         MVI   ERROR,PWEOPNV       INVALID OPTION                               
*                                                                               
VBTPERR  DS    0H                                                               
         ST    R4,DMCB+8           SAVE ERROR POINTER                           
         GOTO1 CURSERR             PUT OUT ERROR MESSAGE                        
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'PRWRIGEN - SCAN FOR < OR >  - SEPSCAN'                          
***********************************************************************         
*                                                                     *         
*        SCAN FIRST PART OF SCANNER BLOCK FOR < AND >                 *         
*        IF FOUND SPLIT BLOCK INTO 2 PARTS AND SAVE                   *         
*          ACTUAL SEPARATOR                                           *         
*                                                                     *         
*                                                                     *         
*NTRY    R4 ==>   SCANNER BLOCK                                       *         
*                                                                     *         
*EXIT    SCANSEP HAS ACTUAL SEPARATOR                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
SEPSCAN  NMOD1 0,**#SEP                                                         
*                                                                               
         USING SPOOLD,R8                                                        
         USING SYSD,R9                                                          
*                                                                               
         LA    RC,SPOOLEND         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         MVI   SCANSEP,0           DEFAULT TO NO SEPARATOR                      
*                                                                               
         CLI   1(R4),0             IF THERE IS A SECOND PART                    
         BE    *+12                                                             
         MVI   SCANSEP,C'='           SET TO '=' SEPARATOR                      
         B     SEPSCAND               SKIP CHECK                                
*                                                                               
         SR    RE,RE                                                            
         IC    RE,0(R4)            GET DATA LENGTH                              
         LR    R1,RE               SAVE TOTAL LENGTH                            
*                                                                               
         LA    RF,12(R4)           POINT TO START OF DATA                       
*                                                                               
SEPSCANL DS    0H                                                               
*                                                                               
         CLI   0(RF),C'<'          IF DATA HAS LT SIGN                          
         BE    *+8                                                              
         CLI   0(RF),C'>'           OR GT SIGN                                  
         BE    SEPSCANF               USE AS SEPARATOR                          
*                                                                               
SEPSCANC DS    0H                                                               
*                                                                               
         LA    RF,1(RF)            BUMP POINTER                                 
         BCT   RE,SEPSCANL                                                      
*                                                                               
         B     SEPSCAND            NO SPECIAL SEPARATORS                        
*                                                                               
SEPSCANF DS    0H                                                               
*                                                                               
         MVC   SCANSEP,0(RF)       SAVE SEPARATOR                               
*                                                                               
         SR    R1,RE               FIRST PART LENGTH                            
         BZ    SEPNOTV             NOTHING BEFORE SEPARATOR                     
*                                                                               
         STC   R1,0(R4)            SAVE FIRST PART LENGTH                       
*                                                                               
         BCT   RE,*+8              SECOND PART LENGTH                           
         B     SEPNOTV             NOTHING AFTER SEPARATOR                      
*                                                                               
         STC   RE,1(R4)            SET SECOND PART LENGTH                       
*                                                                               
         BCTR  RE,0                DECREMENT FOR EXECUTE                        
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   22(0,R4),1(RF)         MOVE TO SECOND PART                       
*                                                                               
         MVI   0(RF),C' '             CLEAR SEPARATOR                           
*                                                                               
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   1(0,RF),SPACES         CLEAR REMAINDER OF KEYWORD PART           
*                                                                               
SEPSCAND DS    0H                                                               
*                                                                               
*        CHECK IF A VARIABLE NEEDS TO BE REPLACED                               
*                                                                               
         CLI   12(R4),AMPERSND     IF KEYWORD                                   
         BE    *+8                                                              
         CLI   22(R4),AMPERSND     OR VALUE STARTS WITH AMPERSAND               
         BNE   SETVARX                                                          
*                                                                               
*        IF VARIABLE IN FIRST PART OF SCANNER BLOCK                             
*           REPLACE WITH VARIABLE'S VALUE                                       
*                                                                               
         CLI   12(R4),AMPERSND     SKIP UNLESS FIRST PART OF BLOCK              
         BNE   SVAR1STX               BEING REPLACED                            
*                                                                               
         CLI   0(R4),1             LENGTH MUST BE GREATER THAN 1                
         BNH   SVAR1STX                                                         
*                                                                               
         LA    R0,3                MAX 3 VARIABLES SAVED                        
         LA    R1,VARSAVE          POINT TO FIRST SAVED VARIABLE                
*                                                                               
         CLC   0(1,R1),0(R4)       LENGTHS MUST MATCH                           
         BNE   *+10                                                             
         CLC   12(10,R1),12(R4)    INPUT MUST MATCH                             
         BE    *+16                                                             
         LA    R1,42(R1)           BUMP TO NEXT VARIABLE                        
         BCT   R0,*-24                                                          
         B     SETVARER            UNKNOWN VARIABLE                             
*                                                                               
         MVC   0(1,R4),1(R1)       REPLACE WITH VARIABLE LENGTH                 
         MVC   12(10,R4),22(R1)    REPLACE WITH VARIABLE VALUE                  
*                                                                               
SVAR1STX DS    0H                                                               
*                                                                               
         CLI   22(R4),AMPERSND     SKIP UNLESS SECOND PART OF BLOCK             
         BNE   SVAR2NDX               BEING REPLACED                            
*                                                                               
         CLI   1(R4),1             LENGTH MUST BE GREATER THAN 1                
         BNH   SVAR2NDX                                                         
*                                                                               
         LA    R0,3                MAX 3 VARIABLES SAVED                        
         LA    R1,VARSAVE          POINT TO FIRST SAVED VARIABLE                
*                                                                               
         CLC   1(1,R4),0(R1)       LENGTHS MUST MATCH                           
         BNE   *+10                                                             
         CLC   22(10,R4),12(R1)    INPUT MUST MATCH                             
         BE    *+16                                                             
         LA    R1,42(R1)           BUMP TO NEXT VARIABLE                        
         BCT   R0,*-24                                                          
         B     SETVARER            UNKNOWN VARIABLE                             
*                                                                               
         MVC   1(1,R4),1(R1)       REPLACE WITH VARIABLE LENGTH                 
         MVC   22(20,R4),22(R1)    REPLACE WITH VARIABLE                        
*                                                                               
SVAR2NDX DS    0H                                                               
*                                                                               
         B     SETVARX                                                          
*                                                                               
SETVARER DS    0H                  INVALID VARIABLE                             
*                                                                               
         B     SEPNOTV                                                          
*                                                                               
SETVARX  DS    0H                                                               
*                                                                               
         CR    RB,RB               SET EQ CC                                    
*                                                                               
         B     SEPSCANX                                                         
*                                                                               
SEPNOTV  DS    0H                                                               
*                                                                               
         LTR   RB,RB               SET NEQ CC                                   
*                                                                               
SEPSCANX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
PBQACXFQ EQU   X'04'                                                            
*                                                                               
         TITLE   'PRSYSDRIVE DSECTS / STORAGE'                                  
       ++INCLUDE PRWRIWORKD                                                     
         EJECT                                                                  
* OTHER DSECTS ARE HIDDEN IN HERE                                               
*                                                                               
*        INCLUDE DDSPOOLD                                                       
*        INCLUDE DDSPLWORKD                                                     
*        INCLUDE PRWRIFFD                                                       
*        INCLUDE DDGENTWA                                                       
*        INCLUDE DDFLDIND                                                       
*        INCLUDE DDFLDHDR                                                       
*        INCLUDE CTGENDIC                                                       
*        INCLUDE CTGENFILE                                                      
*        INCLUDE CTGENADVD                                                      
*        INCLUDE FAFACTS                                                        
*        INCLUDE FATIOB                                                         
*        INCLUDE DDCOMFACS                                                      
*        INCLUDE DRGLOBAL                                                       
*        INCLUDE DDBIGBOX                                                       
*        INCLUDE DDWIDED                                                        
*        INCLUDE DDOFFICED                                                      
*        INCLUDE DRONEBLKHD                                                     
*        INCLUDE DDCOREQUS                                                      
*        INCLUDE DDMASTD                                                        
*        INCLUDE DDPERVALD                                                      
*        INCLUDE PRVALTABD                                                      
*        INCLUDE PPDDEQUS                                                       
*        INCLUDE PRWRIEQUS                                                      
         PRINT OFF                                                              
       ++INCLUDE DDSPOOLD                                                       
       ++INCLUDE DDSPLWORKD                                                     
       ++INCLUDE PRWRIFFD                                                       
         ORG   CONTAGH                                                          
       ++INCLUDE PRWRIF1D                                                       
       ++INCLUDE DDGENTWA                                                       
       ++INCLUDE DDFLDIND                                                       
       ++INCLUDE DDFLDHDR                                                       
       ++INCLUDE CTGENDIC                                                       
       ++INCLUDE CTGENFILE                                                      
       ++INCLUDE CTGENADVD                                                      
       ++INCLUDE FAFACTS                                                        
       ++INCLUDE FATIOB                                                         
       ++INCLUDE DDCOMFACS                                                      
       ++INCLUDE DRGLOBAL                                                       
       ++INCLUDE DDBIGBOX                                                       
       ++INCLUDE DDWIDED                                                        
       ++INCLUDE DDOFFICED                                                      
       ++INCLUDE DRONEBLKHD                                                     
       ++INCLUDE DDCOREQUS                                                      
       ++INCLUDE DDMASTD                                                        
       ++INCLUDE DDPERVALD                                                      
       ++INCLUDE PRVALTABD                                                      
       ++INCLUDE PPDDEQUS                                                       
       ++INCLUDE PRWRIEQUS                                                      
         EJECT                                                                  
         PRINT ON                                                               
* PPSRCHPARM                                                                    
         PRINT OFF                                                              
       ++INCLUDE PPSRCHPARM                                                     
         PRINT ON                                                               
* FAGETTXTD                                                                     
         PRINT OFF                                                              
       ++INCLUDE FAGETTXTD                                                      
         PRINT ON                                                               
* FASECRETD                                                                     
         PRINT OFF                                                              
       ++INCLUDE FASECRETD                                                      
         PRINT ON                                                               
* DDUCOMD                                                                       
         PRINT OFF                                                              
       ++INCLUDE DDUCOMD                                                        
         PRINT ON                                                               
* PRGENFILE                                                                     
         PRINT OFF                                                              
       ++INCLUDE PRGENFILE                                                      
         PRINT ON                                                               
* GERFPIOD                                                                      
         PRINT OFF                                                              
       ++INCLUDE GERFPIOD                                                       
         PRINT ON                                                               
       ++INCLUDE PRDATELSTD                                                     
WEELLENT EQU   *-WEEKLIST                                                       
         EJECT                                                                  
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'081PRWRIGEN  11/05/18'                                      
         END                                                                    
