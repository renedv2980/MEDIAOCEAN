*          DATA SET ACREP2102  AT LEVEL 109 AS OF 12/22/14                      
*PHASE AC2102C                                                                  
*INCLUDE UNDERLIN                                                               
*INCLUDE HELEN                                                                  
*INCLUDE CASHVAL                                                                
*INCLUDE SQUASHER                                                               
*INCLUDE RIGHT                                                                  
*INCLUDE ACTRACK                                                                
*                                                                               
*                                                                               
*  OPTION 1       S=SUPPRESS ESTIMATE VALUE                                     
*  OPTION 2       Y=PRINT VENDOR INVOICE NUMBER                                 
*  OPTION 3       Y=DEMAND TOTAL BILLING                                        
*  OPTION 4       Y=SUPPRESS VENDOR NAME                                        
*  OPTION 5       Y=SUPPRESS NET+COMMISSION                                     
*  OPTION 6       P=PRODUCTION ONLY, M=MEDIA ONLY, A=APPROVED ONLY              
*  OPTION 7       GROUP BILLING FORMAT (A,B)                                    
*  OPTION 8       Y=SUPPRESS GST & PST, P=SUPPRESS PST ONLY                     
         TITLE 'AC21- PRODUCTION BILLING - MAIN PROCESSOR'                      
A21BASE  CSECT                                                                  
         PRINT NOGEN                                                            
         NMOD1 0,**AC21**,RA,R9,R6                                              
         L     RC,0(R1)                                                         
         USING ACWORKD,RC                                                       
         LA    R7,SPACEND                                                       
         USING BILLD,R7                                                         
         LR    R8,R7                                                            
         AH    R8,=Y(BILLDLNQ)                                                  
         USING BILLD2,R8                                                        
         EJECT                                                                  
*              FIRST TIME ROUTINES(RUNFRST)                                     
*                                                                               
         DC    0H'0'                                                            
RUNFST   CLI   MODE,RUNFRST                                                     
         BNE   REQFST                                                           
*                                                                               
         L     RF,AMONACC                                                       
         USING ACMD,RF                                                          
         L     R0,=A(DICI)                                                      
         LA    R1,DICO                                                          
         STM   R0,R1,ACMAUCDI                                                   
         MVC   VATICAN,ACMAVTCN    SAVE VATICAN ADDRESS                         
         DROP  RF                                                               
*                                                                               
         MVC   FILNME,=CL8'ACCOUNT'                                             
         XC    RUNCNT,RUNCNT       COUNT BILLS FOR SUMMARY                      
         XC    CURCOD,CURCOD       CLEAR CURRENCY CODE                          
         MVI   BILLOPT,0                                                        
         MVI   RUNOPT,0                                                         
         MVI   BILLMODE,0                                                       
         MVI   EPTYPE,47           ESTIMATED PRODUCTION                         
         MVI   EPRTYPE,48          E.P. REVERSAL                                
         OI    BILLMODE,ORIG                                                    
         CLI   RCRERUN,C'Y'                                                     
         BNE   *+12                                                             
         NI    BILLMODE,ALL-ORIG                                                
         OI    BILLMODE,RERUN                                                   
*                                                                               
         RELOC RELO                                                             
         L     RE,=A(RELOTAB)      RELOCATE MY A TYPES                          
         LA    R1,ATYPES                                                        
*                                                                               
RELOOP   L     RF,0(RE)                                                         
         LA    RF,0(RF)                                                         
         A     RF,RELO                                                          
         ST    RF,0(R1)                                                         
         LA    RE,4(RE)                                                         
         LA    R1,4(R1)                                                         
         CLI   0(RE),X'FF'                                                      
         BNE   RELOOP                                                           
*                                                                               
         L     R2,ADMASTC                                                       
         USING MASTD,R2                                                         
         LA    R3,PHASES           R3=A(LOADABLE PHASE LIST)                    
         LHI   R0,PHASEN                                                        
         LA    R4,APHASES             R4=A(PHASE ADDRESSES)                     
         MVC   MCDUB,=CL8'T00AXX'                                               
                                                                                
RUNF00   GOTOR HEXOUT,DMCB,0(R3),MCDUB+4,1                                      
         GOTOR MCVLOADM,DMCB,0                                                  
         BE    *+6                 MUSTTEST PHASE NOT FOUND                     
         DC    H'0'                                                             
         MVC   0(L'APHASES,R4),4(R1)                                            
         AHI   R3,L'PHASES                                                      
         AHI   R4,L'APHASES                                                     
         BCT   R0,RUNF00                                                        
                                                                                
RUNF02   TM    MCAGCTRY,CTRYCAN    IS THIS A CANADIAN COMPANY ?                 
         BZ    *+8                 NO                                           
         OI    RUNOPT,CANAGY       YES, INDICATE SO                             
*                                                                               
         MVC   CTRYCOD,MCAGCTRY    SAVE THE COUNTRY CODE                        
         CLI   CTRYCOD,0           IF NO COUNTRY SPECIFIED                      
         BNE   *+8                                                              
         MVI   CTRYCOD,CTRYUSA     MAKE IS USA                                  
*                                                                               
         TM    MCTSTRUN,X'FF'      TEST RUN?                                    
         BZ    *+8                 NO                                           
         OI    RUNOPT,TESTRUN      YES                                          
         DROP  R2                                                               
*                                                                               
         USING CPYELD,RF                                                        
         L     RF,ADCMPEL                                                       
         MVC   TAXUL,CPYTAX        GET U/L FOR GST/PST POSTINGS                 
         MVC   CURCOD,CPYCURR      MAYBE                                        
         DROP  RF                                                               
*                                                                               
         OC    CURCOD,CURCOD       DO WE HAVE A CODE?                           
         BNZ   RUNF04                                                           
         GOTO1 GETCUR,DMCB,(RC)    GET THE CORRECT CURRENCY CODE                
*                                                                               
RUNF04   L     RF,VEXTRAS                                                       
         USING RUNXTRAD,RF                                                      
         MVC   ORIGNME,ORIGINAM    SAVE ORIGIN NAME                             
         MVC   ORIGADD,ORIGINAD    AND ADDRESS                                  
*                                                                               
         MVC   NARR(8*21),SPACES                                                
         USING ACPROFSD,RF                                                      
         L     RF,APROFILE                                                      
         MVC   PROFS,ACPPFCPY                                                   
*                                                                               
         XC    ALSORT,ALSORT       CLEAR A(LAST SORT)                           
         GOTO1 ADSORTER,DMCB,SORTCARD,RECCARD,0                                 
         GOTO1 BUFFALO,DMCB,=C'SET',ABUFF                                       
*                                                                               
         LA    R0,JOBBKCNT                                                      
         LA    R2,ZEROS                                                         
         ZAP   0(L'JOBNET,R2),=P'0' INITIALIZE ZEROS                            
         LA    R2,L'JOBNET(R2)                                                  
         BCT   R0,*-10                                                          
*                                                                               
         XC    ID,ID                                                            
         SP    RCSPECNO+1(3),=P'1'                                              
         MVI   MAXLINES,54         HANDLE US BILLING PAPER                      
*                                                                               
         ZAP   TOTBL,=P'0'                                                      
         ZAP   TOTCOM,=P'0'                                                     
         ZAP   TAPECASH,=P'0'                                                   
         ZAP   TAPECNT,=P'0'                                                    
         ZAP   MARKED,=P'0'                                                     
         GOTO1 DATCON,DMCB,(4,RCDATE),(2,TODAY2)                                
         GOTO1 DATCON,DMCB,(4,RCDATE),(1,TODAYP)                                
*                                                                               
         MVC   MY+1(1),RCDATE+7      RCDATE IS MM/DD/YY                         
         MVC   MY(1),RCDATE+1        SET MONTH/YEAR                             
         CLI   RCDATE,C'1'                                                      
         BNE   RUNF06                                                           
         MVI   MY,C'A'                                                          
         CLI   RCDATE+1,C'0'                                                    
         BE    RUNF06                                                           
         MVI   MY,C'B'                                                          
         CLI   RCDATE+1,C'1'                                                    
         BE    RUNF06                                                           
         MVI   MY,C'C'                                                          
*                                                                               
RUNF06   MVC   YM+1(1),MY            SET YEAR/MONTH                             
         MVC   YM(1),MY+1                                                       
         L     R4,ADCMPEL                                                       
         USING CPYELD,R4                                                        
         MVI   CMPOPT,0                                                         
         TM    CPYSTAT1,X'10'                                                   
         BZ    *+8                                                              
         OI    CMPOPT,POSTCOST         WANT COSTING POSTINGS                    
         TM    CPYSTAT4,X'80'                                                   
         BZ    *+8                                                              
         OI    CMPOPT,ESTSK        POST % EST TO SK                             
*                                                                               
         USING LOGOD,R5                                                         
         L     R5,LOGOC                                                         
         MVI   LOGOEND,C'X'                                                     
         CLC   LOGO1,SPACES                                                     
         BNE   *+10                                                             
         MVC   LOGO1,CPYLOGO                                                    
         GOTO1 LOGO,DMCB,(R5)                                                   
*                                                                               
*              BUILD TABLE OF MEDIA CODES AND NAMES                             
*                                                                               
         USING MESD,R5                                                          
         DC    0H'0'                                                            
         LA    R5,MESWK                                                         
         XC    MESWK(MESKLEN),MESWK                                             
         MVC   MESACCUM(JOBLNQ),ZEROS                                           
         L     R2,ADCOMP                                                        
         AH    R2,DATADISP                                                      
*                                                                               
RUNF08   CLI   0(R2),0                                                          
         BE    RUNF14                                                           
         CLI   0(R2),X'11'                                                      
         BE    RUNF12                                                           
*                                                                               
RUNF10   ZIC   R0,1(R2)                                                         
         AR    R2,R0                                                            
         B     RUNF08                                                           
*                                                                               
         USING PMDELD,R2                                                        
RUNF12   MVC   MESCDE,PMDCODE                                                   
         MVC   MESNME,PMDDESC          NO MATCH LOOK FOR NEXT                   
         GOTO1 SHR,DMCB,('SUBRBIN',(RC)),(R5),AMEDTAB                           
         B     RUNF10                                                           
*                                                                               
RUNF14   MVI   MESCDE,X'FF'                                                     
         MVC   MESNME,SPACES            FOR THE TOTAL                           
         GOTO1 SHR,DMCB,('SUBRBIN',(RC)),(R5),AMEDTAB                           
*                                                                               
         L     R3,AMONACC                                                       
         USING ACMD,R3                                                          
         GOTO1 ACMAJOBL,DMCB,LOOKFLDH,ACMACOLL,ADCOMFAC                         
         CLI   DMCB+4,X'00'                                                     
         BNE   XIT                                                              
         DC    H'0'                                                             
*                                                                               
LOOKFLDH DC    AL1(8+L'LOOKFLD),4X'00',AL1(L'LOOKFLD),AL2(0)                    
LOOKFLD  DC    C'CE,CEG,PEBCE,PEBCEG'                                           
         DROP  R2,R3,R4,R5,RF                                                   
         EJECT                                                                  
*               FIRST TIME ROUTINES(REQFRST)                                    
*                                                                               
REQFST   CLI   MODE,REQFRST                                                     
         BNE   LEDGFST                                                          
*                                                                               
         USING MASTD,RF                                                         
         L     RF,ADMASTC                                                       
         MVC   USERPID,MCRHPSWD       SAVE PID                                  
         DROP  RF                                                               
*                                                                               
         MVI   PRINTED,C'N'                                                     
         MVI   REQOPT,0                                                         
         CLI   QOPT6,C'P'                                                       
         BNE   *+8                                                              
         OI    REQOPT,REQPRDO      PRODUCTION ONLY                              
*                                                                               
         CLI   QOPT6,C'M'                                                       
         BNE   *+8                                                              
         OI    REQOPT,REQMEDO      MEDIA ONLY                                   
*                                                                               
         CLI   QOPT6,C'A'                                                       
         BNE   *+8                                                              
         OI    REQOPT,REQAPPO      APPROVED ONLY                                
*                                                                               
         CLC   QPROG,=C'21'                                                     
         BNE   *+8                                                              
         OI    BILLMODE,BILL       LIVE BILLING                                 
*                                                                               
         CLC   QPROG,=C'22'                                                     
         BNE   *+8                                                              
         OI    BILLMODE,DRAFT      DRAFT BILLING                                
*                                                                               
         CLC   QPROG,=C'23'                                                     
         BNE   *+8                                                              
         OI    BILLMODE,UNBILL     UNBILLING                                    
*                                                                               
         CLC   QPROG,=C'24'                                                     
         BNE   *+12                                                             
         OI    BILLMODE,UNBILL     UNBILLING                                    
         OI    BILLMODE,DRAFT      DRAFT BILLING                                
*                                                                               
         TM    BILLMODE,BILL+DRAFT+UNBILL                                       
         BNZ   *+6                                                              
         DC    H'0'                                                             
*                                                                               
         TM    RUNOPT,CANAGY            IS THIS A CANADIAN AGENCY?              
         BZ    *+8                      NO                                      
         OI    RUNOPT,NEEDGST+NEEDPST   YES, BOTH TAXES NEEDED                  
*                                                                               
         CLI   QOPT8,C'Y'               SUPPRESS BOTH TAXES?                    
         BNE   *+8                      NO                                      
         NI    RUNOPT,X'FF'-NEEDGST-NEEDPST                                     
*                                                                               
         CLI   QOPT8,C'P'               SUPPRESS PST ONLY?                      
         BNE   *+8                      NO                                      
         NI    RUNOPT,X'FF'-NEEDPST                                             
*                                                                               
         CLI   QOPT8,C'G'               SUPPRESS GST ONLY?                      
         BNE   *+8                      NO                                      
         NI    RUNOPT,X'FF'-NEEDGST                                             
*                                                                               
         OC    ID,ID                                                            
         BNZ   REQF02              ALREADY HAVE ID                              
         GOTO1 POST,DMCB,('POSTOPEN',(RC))  OPEN FILE                           
*                                                                               
REQF02   MVC   MNTH,RCDATE         THIS MONTH (MM)                              
         MVC   MOS,THISMNTH                                                     
         MVC   BILLDTE,RCDATE                                                   
         CLC   QSTART,SPACES                                                    
         BE    REQF04                                                           
         MVC   BILLDTE+6(2),QSTART       YY                                     
         MVC   BILLDTE+3(2),QSTART+4     DD                                     
         MVC   BILLDTE+0(2),QSTART+2     MM                                     
         MVI   BILLDTE+2,C'/'                                                   
         MVI   BILLDTE+5,C'/'                                                   
         MVC   MOS(1),QSTART+1     BUILD MONTH OF SERVICE                       
         MVC   MOS+1(1),QSTART+3   FROM BILL DATE                               
         CLI   QSTART+2,C'1'                                                    
         BNE   REQF04                                                           
         MVI   MOS+1,C'A'                                                       
         CLI   QSTART+3,C'0'                                                    
         BE    REQF04                                                           
         MVI   MOS+1,C'B'                                                       
         CLI   QSTART+3,C'1'                                                    
         BE    REQF04                                                           
         MVI   MOS+1,C'C'                                                       
*                                                                               
REQF04   DS    0H                                                               
         MVI   ENDATE,ALL                                                       
         CLC   QEND,SPACES                                                      
         BE    REQF06                                                           
         GOTO1 DATCON,DMCB,(0,QEND),(1,ENDATE)                                  
         GOTO1 DATCON,DMCB,(0,QEND),(2,END2)                                    
         GOTO1 DATCON,DMCB,(0,QEND),(1,CALLDATE)                                
*                                                                               
REQF06   DS    0H                                                               
         GOTO1 DATCON,DMCB,(4,BILLDTE),(2,RCDAY2)                               
         GOTO1 DATCON,DMCB,(4,BILLDTE),(0,DUB)                                  
         GOTO1 (RF),(R1),,(1,DATE3)                                             
         GOTO1 DATCON,DMCB,(4,BILLDTE),(10,WORK)                                
         MVC   BILLDTE,WORK                                                     
*                                                                               
         LA    R4,10               DUE DATE=TODAY + 10 DAYS                     
         CLI   QBDAY,X'00'         ANY DAYS ON REQUEST?                         
         BE    REQF07              NO                                           
         CLI   QBDAY,X'FF'                                                      
         BE    REQF07                                                           
*                                                                               
         SR    R4,R4                                                            
         IC    R4,QBDAY            YES, USE THIS DATE INSTEAD                   
*                                                                               
REQF07   GOTO1 ADDAY,DMCB,DUB,DUE6,(R4)                                         
         GOTO1 DATCON,DMCB,(0,DUE6),(8,DUEDAT)                                  
         MVC   SVDUE,DUEDAT                                                     
         GOTO1 DATCON,DMCB,(0,DUE6),(2,DUE2)                                    
         MVC   SVDUE2,DUE2                                                      
         MVC   SVDUE6,DUE6                                                      
         TM    BILLMODE,UNBILL     ARE WE UNBILLING ?                           
         BO    *+10                YES, LEAVE CALLDATE AS QEND                  
         MVC   CALLDATE,DATE3      NO, REPLACE WITH INVOICE DATE                
*                                                                               
         MVI   MYSPACE,2           DOUBLE SPACING IS DEFAULT                    
         MVC   SVGSTDAT,CALLDATE                                                
         MVC   SVPSTDAT,CALLDATE                                                
*                                                                               
         TM    BILLMODE,DRAFT      CAN ONLY GET REQUESTS DETAILS                
         BNO   REQF10              FOR DRAFT                                    
         CLI   PROF7,C'Y'          DO THEY WANT REQDETS                         
         BNE   REQF10                                                           
         CLI   SPECSW,C'Y'                                                      
         BE    REQF10              ALREADY FIXED SPECS                          
         MVI   SPECSW,C'Y'                                                      
         L     R4,ACSPECS          SPEC POOL                                    
*                                                                               
REQF08   ZIC   R3,1(R4)                                                         
         AR    R4,R3                                                            
         CLI   0(R4),0             END OF SPECS                                 
         BNE   REQF08                                                           
         L     R3,AMYSPECS                                                      
         MVC   0(100,R4),0(R3)     ADD SPECS FOR REQDETS                        
*                                                                               
REQF10   BRAS  RE,GETPRO           SET IF ARCHIVING IS SET                      
         B     XIT                                                              
         EJECT                                                                  
*              FIRST FOR LEDGER                                                 
*                                                                               
LEDGFST  CLI   MODE,LEDGFRST                                                    
         BNE   LVAFRST                                                          
         USING ACPROFSD,RF                                                      
         L     RF,APROFILE                                                      
         MVC   PROFS,ACPPFLDG                                                   
         B     XIT                                                              
         DROP  RF                                                               
         EJECT                                                                  
*              FIRST FOR CLIENT(LEVAFRST)                                       
*                                                                               
LVAFRST  CLI   MODE,LEVAFRST                                                    
         BNE   LVBFRST                                                          
         USING ACPROFSD,RF                                                      
         L     RF,APROFILE                                                      
         MVC   PROFS,ACPPFACC                                                   
         MVI   SHIPDATE,0                                                       
         CLI   PROF23,0            TEST SHIP DATE NEEDED                        
         BE    LVAF01                                                           
         CLI   PROF23,31                                                        
         BH    LVAF01                                                           
         MVC   SHIPDATE,PROF23     SAVE NUMBER OF DAYS                          
*                                                                               
LVAF01   MVC   GRPTYPE,QOPT7       GROUP TYPE                                   
         MVI   GRPOPT,0                                                         
         CLI   GRPTYPE,C'A'                                                     
         BNE   *+8                 NOT A GROUP BILL                             
         OI    GRPOPT,GRPBILL      FORMAT A IS GROUP BILL                       
*                                                                               
         LA    R3,CLINAME          SET UP CLIENT NAME                           
         L     R2,ADHEIRA                                                       
         GOTO1 SHR,DMCB,('SUBRNAM',(RC))                                        
         MVC   CLICODE,0(R2)       AND ACCOUNT CODE                             
         DROP  RF                                                               
*                                                                               
         TM    BILLMODE,DRAFT      A22 OPTION MEANS SOMETHING ELSE              
         BO    LVAF02                                                           
         L     RE,APROFILE                                                      
         USING ACPROFSD,RE                                                      
         CLI   ACPPFC15,1          COMPANY PROFILE 15                           
         BL    LVAF02              MONTH FOR INVOICE                            
         CLI   ACPPFC15,12                                                      
         BH    LVAF02                                                           
         SR    R1,R1                                                            
         IC    R1,ACPPFC15                                                      
         CVD   R1,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  WORK(3),DUB+6(2)    GET CHARARCTER MONTH NUMBER                  
         CLC   WORK+1(2),BILLDTE   IF PROFILE MONTH NOT HIGHER                  
         BL    LVAF02              THAN RUN DATE- USE RUN DATE                  
         CLC   WORK+1(2),=C'12'    IF PROFILE IS FOR DECEMBER                   
         BNE   *+14                                                             
         CLC   BILLDTE(2),=C'01'    AND DATE IS JANUARY                         
         BE    LVAF02              USE RUN MONTH                                
         MVC   MNTH,WORK+1         MONTH FROM PROFILE                           
*                                                                               
LVAF02   TM    BILLMODE,ORIG                                                    
         BO    XIT                 NOT A RERUN                                  
         L     R2,ADHEIRA          FIND NUMBER ELEMENTS ON CLIENTS              
         CLC   LASTCLI,3(R2)                                                    
         BE    XIT                 (FIRST TIME ONLY)                            
         MVC   LASTCLI,3(R2)                                                    
         MVI   ELCODE,X'21'                                                     
         BAS   RE,GETEL                                                         
         BNE   XIT                                                              
*                                                                               
         USING NUMELD,R4                                                        
LVAF04   LR    R4,R2                                                            
         TM    BILLMODE,ORIG                                                    
         BO    *+14                NOT A RERUN                                  
         MVC   NUMAFT,NUMBEF   USE PREVIOUS START FOR A RERUN                   
         B     *+10                                                             
         MVC   NUMBEF,NUMAFT   ELSE FIX UP START FOR NEXT TIME                  
         B     XIT                                                              
         DROP  R4,RE                                                            
         EJECT                                                                  
*              FIRST FOR PRODUCT(LEVBFRST)                                      
*                                                                               
LVBFRST  CLI   MODE,LEVBFRST                                                    
         BNE   ACCFST                                                           
*                                                                               
         ZAP   GRPINT,=P'0'        CLEAR INTERNAL INCOME                        
         ZAP   GRPCD,=P'0'         AND CASH DISCOUNT, ET AL.                    
         ZAP   GRP11,=P'0'                                                      
         ZAP   GRP12,=P'0'                                                      
         ZAP   GRPSJ,=P'0'                                                      
         ZAP   GRPSR,=P'0'                                                      
         ZAP   GRPGST,=P'0'                                                     
         ZAP   GRPPST,=P'0'                                                     
*                                                                               
         MVC   GRPTOT(JOBLNQ),ZEROS       GROUP TOTAL                           
         XC    SALENUM,SALENUM                                                  
         MVC   SALENAM,SPACES                                                   
*                                                                               
         LA    R3,PRDNAME                 SET UP PRODUCT NAME                   
         L     R2,ADHEIRB                                                       
         GOTO1 SHR,DMCB,('SUBRNAM',(RC))                                        
         MVC   PRDCODE,0(R2)       AND ACCOUNT CODE                             
         MVC   PRODNAM,PRDNAME     SET UP PRODUCT CODE FOR                      
         MVC   PRODNUM,PRDCODE     INCOME POSTING CONTRA-ACCOUNT                
         MVI   ELCODE,X'3D'                                                     
         BAS   RE,GETEL                                                         
         BNE   XIT                                                              
*                                                                               
         USING SANELD,R2                                                        
         MVC   PRODNUM,SANCODE    CAN BE OVERRIDDEN                             
         MVC   PRODNAM,SANNAME                                                  
         MVC   SALENUM,SANCODE                                                  
         MVC   SALENAM,SANNAME                                                  
         B     XIT                                                              
         EJECT                                                                  
*              PROCESSING AN ACCOUNT(PROCACC)                                   
*                                                                               
ACCFST   CLI   MODE,PROCACC                                                     
         BNE   LSTEST                                                           
         MVC   PAGE,=H'1'                                                       
         MVI   FORCEHED,C'Y'                                                    
         L     R2,ADACC                                                         
*                                                                               
         ZAP   SAVCD,=P'0'                                                      
         ZAP   SAVEPN,=P'0'                                                     
         ZAP   SAVEPC,=P'0'                                                     
         ZAP   PRVCD,=P'0'                                                      
         ZAP   SCIUNET,=P'0'                                                    
*                                                                               
         ZAP   TOTPB,=P'0'          CLEAR PB BUCKETS                            
         ZAP   SVPBAMT,=P'0'                                                    
*                                                                               
         MVC   SVANAL,SPACES                                                    
         MVC   SVANALN,SPACES                                                   
         XC    SVJOBCR,SVJOBCR     CLEAR JOB LEVEL INCOME ACCOUNTS              
         XC    SVJOBDR,SVJOBDR                                                  
         XC    REBILLNO,REBILLNO   RE-RUN BILL NUMBER                           
*                                                                               
         XC    SVVEND,SVVEND       CLEAR STUDIO FIELDS                          
         XC    SVAGKEY,SVAGKEY                                                  
         XC    SVSTUD,SVSTUD                                                    
         XC    SVBDB,SVBDB                                                      
         XC    SVICR,SVICR                                                      
         XC    SVAGHOLD,SVAGHOLD                                                
         XC    SVELEM,SVELEM                                                    
         XC    SVDBELM,SVDBELM                                                  
         XC    SVAGXJOB,SVAGXJOB                                                
         MVC   SVVENDN,SPACES                                                   
         MVC   SVAGACN,SPACES                                                   
         MVC   SVAGOFF,SPACES                                                   
         XC    WARNRSNS,WARNRSNS                                                
         NI    RTLOPT,X'FF'-RTLSCOMM TURN OFF SPECIAL COMMISSION RATE           
*                                                                               
         USING BIND,R5                                                          
         L     R5,AWRKTAB                                                       
         XC    BININ,BININ         CLEAR COUNTER                                
         DROP  R5                                                               
*                                                                               
         MVI   JOBOPT,0                                                         
         MVI   INCOPT,0            CLEAR INCOME OPTION                          
*                                                                               
         L     RF,AESTPOOL         INITIALIZE ESTIMATE POOL                     
         MVI   0(RF),0                                                          
         L     RF,AUSRPOOL         INITIALIZE USER POOL                         
         MVI   0(RF),X'FF'                                                      
         L     RF,APREVB7          INITIALIZE TABLE OF PREVIOUS B7'S            
         MVI   0(RF),0                                                          
         L     RF,ACURRB7          INITIALIZE TABLE OF CURRENT B7'S             
         MVI   0(RF),0                                                          
*                                                                               
         LA    R3,JOBNAME          SET UP JOB NAME                              
         GOTO1 SHR,DMCB,('SUBRNAM',(RC))                                        
         MVC   JOBCODE,0(R2)       AND ACCOUNT CODE                             
         MVC   JOBLET,9(R2)                                                     
*                                                                               
         NI    BILLOPT,AGYNUM            DON'T TURN OFF AGENCY NUMBER           
         MVC   JOBDTL(JOBLNQ),ZEROS      CLEAR CURRENT DETAIL LINE              
         MVC   JOBWKC(JOBLNQ),ZEROS            WORKCODE TOTAL                   
         MVC   JOBCHG(JOBLNQ),ZEROS            CHARGES TOTAL                    
         MVC   JOBTOT(JOBLNQ),ZEROS            ACCOUNT TOTAL                    
         MVC   JOBPOST(JOBLNQ),ZEROS           POSTING TOTAL                    
         MVC   JOBMED(JOBLNQ),ZEROS            MEDIA TOTAL                      
         MVC   TOTCHG(JOBLNQ),ZEROS            TOTAL CHARGES FOR RETAIL         
*                                                                               
         MVC   OFFC,SPACES                                                      
         USING PPRELD,R2                                                        
         L     R2,ADPROFIL                                                      
         MVC   OFFC,PPRGAOFF                                                    
         MVI   ESTOPT,0                                                         
         GOTO1 FILTER,DMCB,(RC)    DO SOME FILTERING/EXTRACT DATA               
*                                                                               
         CLI   BILLTYPE,NOTBILL    NOT  BILLABLE ?                              
         BE    ACCF01              YES, SKIP RTL INITIALIZATION                 
         CLI   RTLEDG,0            A    DISTRIBUTION SCAN ?                     
         BE    ACCF01              NO,  SKIP RTL INITIALIZATION                 
         MVI   RTLMODE,RTLINIT                                                  
         GOTO1 RTL,DMCB,(RC)       RETAIL INITIALIZATION                        
*                                                                               
ACCF01   TM    RUNOPT,NEEDGST+NEEDPST     DOING ANY TAXES?                      
         BZ    ACCF02                     NO                                    
*                                                                               
         L     RE,ASVTABLE                CLEAR SVTABLE                         
         LA    RF,(SVTABLNQ*TAXNUM)                                             
         SR    R1,R1                                                            
         MVCL  RE,R0                                                            
*                                                                               
         USING VTCD,R2                                                          
         L     R2,AVATBUFF                DO CALL TO VATICAN                    
         XC    VTCACTN(VTCLNQ),VTCACTN    CLEAR VATICAN BUFFER                  
         MVI   VTCACTN,VTCALOOK           LOOK FOR RATES                        
         MVC   VTCCOMF,ADCOMFAC           A(COMFACS)                            
         MVC   VTCCPY,CLICODE             COMPANY CODE                          
         MVC   VTCOFFC,OFFC               OFFICE                                
         MVC   VTCINVD,CALLDATE           INVOICE/UNBILL DATE                   
         MVC   VTCLANG,RCLANG                                                   
         MVI   VTCTYPE,C'S'               ALWAYS NEED A TYPE                    
         GOTO1 VATICAN,(R2)                                                     
         TM    VTCINDS,VTCINA             IS TAX APPLICABLE ?                   
         BZ    *+8                        YES                                   
         NI    RUNOPT,X'FF'-NEEDGST       NO, TURN OFF OPTION THEN              
         MVC   SVGSTREG,VTCREG            GET REGISTRATION NUMBER               
*                                                                               
         MVC   VTCPRV,SVPSTPRV            MOVE IN PROVINCE CODE                 
         MVC   VTCLANG,RCLANG                                                   
         XC    VTCINDS,VTCINDS            CLEAR ERROR CODE                      
         GOTO1 VATICAN,(R2)                                                     
         TM    VTCINDS,VTCINA             IS TAX APPLICABLE ?                   
         BZ    *+8                        YES                                   
         NI    RUNOPT,X'FF'-NEEDPST       NO, TURN OFF OPTION THEN              
         MVC   SVPSTREG,VTCREG            GET REGISTRATION NUMBER               
         DROP  R2                                                               
*                                                                               
ACCF02   CLI   BILLTYPE,NOTBILL    DID WE COME BACK BILLABLE ?                  
         BNE   ACCF03              YES                                          
         CLC   P,SPACES            NO, WANT THE REASON ?                        
         BE    ACCF30              NO                                           
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))     YES                               
         B     ACCF30                                                           
*                                                                               
ACCF03   TM    JOBOPT,JBSTUDIO     IS THIS A STUDIO JOB?                        
         BZ    ACCF06              NO                                           
*                                                                               
         USING ACTRECD,R2                                                       
         L     R2,AIO2             YES, READ AGENCY CLIENT                      
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKEY(L'SVAGCUL),SVAGCUL                                        
         MVC   ACTKEY+L'SVAGCUL(L'SVAGCLI),SVAGCLI                              
*                                                                               
         GOTO1 DATAMGR,DMCB,DMREAD,FILNME,(R2),(R2)                             
         CLI   DMCB+8,0            FIND IT?                                     
         BE    ACCF03B             YES                                          
*                                                                               
         USING NOBD,R5                                                          
ACCF03A  L     R5,ANOBWK                                                        
         LA    R1,NOBLNQ                                                        
         SLL   R1,16                                                            
         ST    R1,NOBLEN                                                        
         MVI   NOBTYP,NOBEQU           RECORD TYPE                              
         L     R2,ADACC                                                         
         MVC   NOBCLI(12),3(R2)         CLI/PRD/JOB                             
*                                                                               
         MVC   NOBDATA,SPACES                                                   
         MVI   NOBRSN,99           REASON CODE                                  
         MVC   NOBDATA(37),=C'CAN''T BILL - LINK INFORMATION MISSING'           
         GOTO1 ADSORTER,DMCB,=C'PUT',ANOBWK                                     
         MVI   ALSORT,1                                                         
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
         MVI   BILLTYPE,NOTBILL                                                 
         MVI   FCRDTRNS,C'N'                                                    
         MVI   FCRDEST,C'N'                                                     
         B     ACCF30                                                           
*                                                                               
ACCF03B  LA    R3,SVAGCLIN         SAVE CLIENT NAME                             
         GOTO1 SHR,DMCB,('SUBRNAM',(RC))                                        
*                                                                               
         USING ACTRECD,R2                                                       
         L     R2,AIO2             YES, READ AGENCY JOB RECORD                  
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCULA,SVAGKEY                                                 
*                                                                               
         GOTO1 DATAMGR,DMCB,DMREAD,FILNME,(R2),(R2)                             
         CLI   DMCB+8,0            FIND IT?                                     
         BNE   ACCF03A             NO                                           
*                                                                               
         LA    R3,SVAGACN                                                       
         GOTO1 SHR,DMCB,('SUBRNAM',(RC))                                        
*                                                                               
         USING JOBELD,R2                                                        
         MVI   ELCODE,JOBELQ                                                    
         BAS   RE,GETEL                                                         
         BNE   ACCF04                                                           
         TM    JOBSTA1,JOBSXJOB   IS THIS AN X-JOB?                             
         BZ    *+8                 NO                                           
         OI    SVAGXJOB,JOBX       YES, INDICATE SO                             
*                                                                               
ACCF04   L     RE,ACOMBUF                                                       
         LH    RF,=YL2(GOBLOCKX-GOBLOCK)                                        
         SR    R1,R1                                                            
         MVCL  RE,R0                                                            
*                                                                               
         USING GOBLOCKD,R4                                                      
         L     R4,ACOMBUF                                                       
         MVC   GOADM,DATAMGR                                                    
         LA    RE,GOBLOCKX-GOBLOCK(R4)                                          
         ST    RE,GOAEXT                                                        
         LH    RF,=YL2(GOXBLKX-GOXBLKD)                                         
         SR    R1,R1                                                            
         MVCL  RE,R0                                                            
*                                                                               
         MVC   GOSELCUL,JOBCODE                                                 
         MVC   GOSELCLI,SPACES                                                  
         MVC   GOSELCLI(L'SVAGCLI),SVAGCLI                                      
         MVC   GOSELPRO,SPACES                                                  
         MVC   GOSELPRO(L'SVAGPRO),SVAGPRO                                      
         MVC   GOSELJOB,SVAGJOB                                                 
         MVC   GOAJOB,AIO2                                                      
         GOTO1 GETOPT,DMCB,ACOMBUF                                              
*                                                                               
         MVC   SVAGOFF,GOEFFOFC    SAVE THE OFFICE CODE                         
*                                                                               
         L     R4,GOAEXT                                                        
         USING GOXBLKD,R4                                                       
         CLI   GOINTPST,C'Y'       ARE WE MAKING POSTINGS?                      
         BNE   ACCF06              NO                                           
         TM    SVAGXJOB,JOBX       IS THE AGENCY AN XJOB?                       
         BZ    ACCF05              NO                                           
         MVI   WARNRSN,WARN01      YES, CAN'T MAKE INTERCOMPANY THEN            
         BAS   RE,FILTNOW                                                       
         B     ACCF06                                                           
*                                                                               
ACCF05   OI    JOBOPT,POSTAGY      YES, SET THE BIT                             
         MVC   SVAGHOLD,GOHOLD     AND SAVE THE HOLD OPTION                     
*                                                                               
         USING STURECD,R2                                                       
         L     R2,AIO2             READ THE STUDIO FOR VENDOR                   
         XC    STUKEY,STUKEY                                                    
         MVI   STUKTYP,STUKTYPQ                                                 
         MVI   STUKSUB,STUKSUBQ                                                 
         MVC   STUKCPY,CLICODE                                                  
         MVC   STUKCODE,SVSTUD                                                  
*                                                                               
         GOTO1 DATAMGR,DMCB,DMREAD,FILNME,(R2),(R2)                             
         CLI   DMCB+8,0            FIND IT?                                     
         BNE   ACCF03A             NO                                           
*                                                                               
         USING STUELD,R2                                                        
         MVI   ELCODE,STUELQ                                                    
         BAS   RE,GETEL                                                         
         BNE   ACCF03A                                                          
         MVC   SVVEND,STUVEND                                                   
*                                                                               
         USING ACTRECD,R2                                                       
         L     R2,AIO2             YES, GET VENDOR NAME                         
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCULA,SVVEND                                                  
*                                                                               
         GOTO1 DATAMGR,DMCB,DMREAD,FILNME,(R2),(R2)                             
         CLI   DMCB+8,0            FIND IT?                                     
         BNE   ACCF03A             NO                                           
*                                                                               
         USING NAMELD,R2                                                        
         MVI   ELCODE,NAMELQ                                                    
         BAS   RE,GETEL                                                         
         BNE   ACCF03A                                                          
*                                                                               
         SR    R1,R1                                                            
         IC    R1,NAMLN                                                         
         SH    R1,=Y(NAMEREC-NAMELD+1)                                          
         BM    ACCF06                                                           
         EX    R1,*+8                                                           
         B     ACCF06                                                           
         MVC   SVVENDN(0),NAMEREC                                               
*                                                                               
ACCF06   ZAP   SKINC,=P'0'                                                      
         ZAP   SKGRS,=P'0'                                                      
*                                                                               
         TM    BILLMODE,UNBILL                                                  
         BZ    ACCF07                                                           
         GOTO1 BILLNUM,DMCB,(RC)                                                
         MVI   FCRDEST,C'N'                                                     
         MVI   FCRDTRNS,C'Y'                                                    
         ZAP   SPECAMNT,=P'0'                                                   
         OC    USEDATE,USEDATE                                                  
         BNZ   ACCF07                                                           
         MVI   BILLTYPE,NOTBILL    NO, SO GET OUT                               
         MVI   FCRDTRNS,C'N'                                                    
         B     ACCF30                                                           
*                                                                               
ACCF07   TM    BILLTYPE,ESTIM                                                   
         BZ    ACCF08                                                           
         TM    CMPOPT,ESTSK                                                     
         BZ    ACCF08                                                           
         OI    JOBOPT,JOBSK        %EST BILL INCOME TO SK                       
         EJECT                                                                  
ACCF08   DC    0H'0'                                                            
         GOTO1 SHR,DMCB,('SUBRCOST',(RC))                                       
         TM    BILLMODE,DRAFT                                                   
         BO    ACCF10                                                           
         TM    BILLOPT,OLDNUM                                                   
         BO    ACCF10                                                           
         OC    REBILLNO,REBILLNO                                                
         BZ    ACCF09                                                           
         PACK  BILLNO,REBILLNO+2(4)     IF RE-RUN NUMBER USE IT                 
         MVC   BILLREF,REBILLNO                                                 
         B     ACCF13                                                           
*                                                                               
ACCF09   TM    GRPOPT,GRPBILL+GRPNUM                                            
         BO    ACCF10              IF GROUP AND NUMBER ASSIGNED                 
         BAS   RE,AGYBILL          AGENCY BILL NUMBER                           
         TM    BILLOPT,AGYNUM                                                   
         BO    ACCF10                                                           
         BAS   RE,CLIBILL          TRY TO FIND A CLIENT BILL NO                 
         TM    BILLOPT,CLINUM                                                   
         BO    ACCF10                                                           
         BAS   RE,MEDSRCH          TRY TO FIND A MEDIA/BILL NO. RECORD          
         TM    BILLOPT,MEDNUM                                                   
         BO    ACCF10                                                           
         AP    RCSPECNO+1(3),=P'1'                                              
         MVC   BILLNO,RCSPECNO                                                  
*                                                                               
ACCF10   TM    GRPOPT,GRPBILL       REQUEST FOR GROUP BILLING                   
         BZ    *+8                                                              
         OI    GRPOPT,GRPNUM        ASSIGN ONE NUMBER PER GROUP                 
*                                   SET-UP BILL NUMBER                          
ACCF12   DS    0H                                                               
         TM    BILLOPT,OLDNUM                                                   
         BO    ACCF13                                                           
         MVC   LNGBILNO,SPACES                                                  
         MVI   WORK,C'*'                                                        
         MVC   WORK+1(L'AC@DRAFT),AC@DRAFT                                      
         MVI   WORK+1+L'AC@DRAFT,C'*'                                           
         MVC   LNGBILNO(7),WORK                                                 
         MVC   SHTBILNO,SPACES                                                  
         MVC   SHTBILNO,WORK                                                    
         TM    BILLMODE,DRAFT                                                   
         BO    ACCF16                                                           
*                                                                               
         UNPK  WORK(6),BILLNO                                                   
         OI    WORK+5,X'F0'                                                     
         MVC   BILLREF,WORK        BILL NUMBER MMNNNN                           
         CLI   PROF24,0            TEST MM OPTION                               
         BE    ACCF13                                                           
         MVC   BILLREF(2),YM       BILL NUMBER YMNNN                            
         CLI   PROF24,2            TEST YM OPTION                               
         BE    ACCF13                                                           
         MVC   BILLREF(2),MY       BILL MYNNNN                                  
*                                                                               
ACCF13   MVC   SHTBILNO(2),BILLREF  MM-NNNN                                     
         MVI   SHTBILNO+2,C'-'                                                  
         MVC   SHTBILNO+3(4),BILLREF+2                                          
*                                                                               
ACCF14   MVC   LNGBILNO(1),JOBLET         MEDIA-MM-NNNN                         
         MVI   LNGBILNO+1,C'-'                                                  
         MVC   LNGBILNO+2(2),BILLREF                                            
         MVI   LNGBILNO+4,C'-'                                                  
         MVC   LNGBILNO+5(4),BILLREF+2                                          
*                                                                               
ACCF16   OC    WARNRSNS,WARNRSNS   ANY WARNING MESSAGES?                        
         BZ    ACCF17              NO                                           
         LA    R3,WARNRSN                                                       
         LA    R4,WRN01                                                         
         GOTO1 WARNMSG,DMCB,(RC),(R3),(R4)                                      
*                                                                               
ACCF17   DS    0H                                                               
         CLI   RTLEDG,0            A    DISTRIBUTION SCAN ?                     
         BE    ACCF18              NO,  SKIP                                    
         MVI   RTLMODE,RTLINI2                                                  
         GOTO1 RTL,DMCB,(RC)       RETAIL INITIALIZATION PART 2                 
*                                                                               
ACCF18   DS    0H                                                               
         TM    BILLTYPE,SPECIAL    SPECIAL BILL ?                               
         BO    ACCF24              YES,    PROCESS  SPECIAL BILL                
         TM    BILLTYPE,ESTIM      PERCENT ESTIMATE BILL ?                      
         BZ    ACCF30              NO,     PROCESS  STANDARDLY                  
         TM    BILLMODE,UNBILL     UNBILL ?                                     
         BZ    ACCF30              NO,     STANDARD PROCESSING                  
*                                                                               
*                                  UNBILL PERCENT ESTIMATE BILL                 
         L     R2,AESTPOOL         ->   ESTIMATE POOL                           
*                                                                               
ACCF20   CLI   0(R2),0             ANYTHING IN ESTPOOL ?                        
         BE    ACCF30              NO, SKIP THIS                                
         ST    R2,ADTRANS          SAVE ADDRESS FOR POST ROUTINES               
*                                                                               
         CLI   0(R2),BESELQ        IS THIS A NEW FORMAT ?                       
         BNE   ACCF22              NO                                           
*                                                                               
         USING BESELD,R2                                                        
         MVC   SVANAL,BESWC        GET WORKCODE AND AMOUNT FOR POSTIT           
         ZAP   SPECAMNT,BESPEBC                                                 
         MP    SPECAMNT,=P'-1'     MAKE IT NEGATIVE                             
         XC    SVGSTCOD,SVGSTCOD                                                
         XC    SVPSTCOD,SVPSTCOD                                                
         XC    SVPSTPRV,SVPSTPRV                                                
         CLI   BESLN,BESLNQ                                                     
         BL    *+10                                                             
         MVC   SVGSTCOD,BESVAT     GET THE GST CODE                             
         CLI   BESLN,BESLN2Q                                                    
         BL    *+16                                                             
         MVC   SVPSTCOD,BESPST     GET THE PST CODE                             
         MVC   SVPSTPRV,BESPRV     AND THE PROVINCE CODE                        
         GOTO1 GETRATE,DMCB,(RC)                                                
         BAS   RE,POSTPOOL                                                      
         BAS   RE,POSTIT                                                        
         SR    R0,R0                                                            
         IC    R0,1(R2)                                                         
         AR    R2,R0                                                            
         B     ACCF20                                                           
         DROP  R2                                                               
*                                                                               
         USING ESTELD,R2                                                        
ACCF22   ZAP   DUB,ESTCURR                                                      
         MVC   SVANAL,ESTWORK                                                   
         L     R5,PEREST                                                        
         CVD   R5,DUB1                                                          
         ZAP   PL13,DUB                                                         
         MP    PL13,DUB1+1(7)                                                   
         SRP   PL13,64-4,5                                                      
         ZAP   SPECAMNT,PL13                                                    
         MP    SPECAMNT,=P'-1'                                                  
         ZAP   COMMRATE,ESTORIG                                                 
         OI    CLIOPT,COMMISN                                                   
         GOTO1 GETRATE,DMCB,(RC)                                                
         BAS   RE,POSTRANS                                                      
         BAS   RE,POSTIT                                                        
         SR    R0,R0                                                            
         IC    R0,1(R2)                                                         
         AR    R2,R0                                                            
         B     ACCF20                                                           
         DROP  R2                                                               
         EJECT                                                                  
*              PRINT SPECIAL BILL AT PROCACC                                    
*                                                                               
ACCF24   BAS   RE,ESTRATES         SET COMMRATE AT JOB LEVEL                    
         GOTO1 GETRATE,DMCB,(RC)                                                
         NI    WKCOPT,X'FF'-WKCMT  TURN OFF MEDIA TRANSFER BIT                  
         BAS   RE,POSTRANS                                                      
         BAS   RE,POSTBUFF                                                      
         GOTO1 POSTGST,DMCB,(RC)                                                
         GOTO1 POSTPST,DMCB,(RC)                                                
         CLI   RTLEDG,0            A    DISTRIBUTION SCAN ?                     
         BE    ACCF26              NO,  PRINT                                   
         MVI   RTLMODE,RTLPRNT                                                  
         GOTO1 RTL,DMCB,(RC)       RETAIL PRINT                                 
         B     ACCF28                                                           
*                                                                               
ACCF26   GOTO1 PRNT,DMCB,('PRNTDUE',(RC))   PRINT AMOUNT DUE LINE               
         GOTO1 PRNT,DMCB,('PRNTCOM',(RC))      AND COMMENTS                     
*                                                                               
ACCF28   TM    BILLMODE,DRAFT                                                   
         BO    ACCF32                                                           
         L     R2,AIO2              READ ACCOUNT RECORD                         
         L     RF,ADACC            BEFORE THE WRITE                             
         MVC   0(42,R2),0(RF)                                                   
         GOTO1 DATAMGR,DMCB,DMREAD,FILNME,(R2),(R2)                             
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                CAN'T READ ACCOUNT RECORD                    
         L     RF,ADACCSTA                                                      
         USING RSTELD,RF                                                        
         MVC   RSTPBILL,TODAY2     WRITE IT BACK WITH TODAYS DATE               
         MVI   MODE,WRITACC                                                     
         B     ACCF32                                                           
*                                                                               
ACCF30   CLI   BILLTYPE,NOTBILL         IF NOT BILLABLE                         
         BE    ACCF36                   DON'T BOTHER WITH ANYTHING              
*                                                                               
ACCF32   TM    BILLTYPE,SPECIAL    IS THIS SPECIAL ?                            
         BNO   ACCF34              NO                                           
         MVI   BILLTYPE,NOTBILL    YES, AVOID FURTHER PROCESSING                
         B     ACCF36                                                           
*                                                                               
ACCF34   TM    BILLMODE,UNBILL     ARE WE UNBILLING ?                           
         BO    ACCF36              YES, GET OUT                                 
         TM    BILLTYPE,ESTIM      NO, IS THIS PERCENT OF ESTIMATE ?            
         BNO   ACCF36              NO                                           
         BAS   RE,PRINTEST         YES, BUILD ESTPOOL                           
*                                                                               
ACCF36   L     R2,AIO2              READ ACCOUNT RECORD                         
         L     RF,ADACC            TO RE-ESTABLISH SEQUENCE                     
         MVC   0(42,R2),0(RF)                                                   
         GOTO1 DATAMGR,DMCB,DMREAD,FILNME,(R2),(R2)                             
         CLI   DMCB+8,0                                                         
         BE    XIT                                                              
         DC    H'0'                CAN'T READ ACCOUNT RECORD                    
         DROP  RF                                                               
         EJECT                                                                  
*              LAST FOR ESTIMATE ELEMENTS(LASTEST)                              
*                                                                               
LSTEST   CLI   MODE,LASTEST                                                     
         BNE   ANALFST                                                          
*                                                                               
LSTE00   TM    RUNOPT,NEEDGST      DOING GST LOGIC?                             
         BZ    LSTE01              NO                                           
         CP    JOBWKC+(JOBGST-JOBD)(L'JOBGST),=P'0'                             
         BNE   LSTE02                                                           
*                                                                               
LSTE01   TM    RUNOPT,NEEDPST      DOING PST LOGIC?                             
         BZ    LSTE04              NO                                           
         CP    JOBWKC+(JOBPST-JOBD)(L'JOBPST),=P'0'                             
         BE    LSTE04                                                           
*                                                                               
LSTE02   TM    WKCOPT,WKCDTLC                                                   
         BO    LSTE03              WORK-CODE DETAILS                            
         MVC   P,SPACES                                                         
         MVC   JOBWKC,ZEROS                                                     
         B     XIT                                                              
*                                                                               
LSTE03   MVC   P,SPACES                                                         
         MVC   P+1(L'AC@ABTAX),AC@ABTAX                                         
         MVC   TEMPWK,JOBWKC                                                    
         GOTO1 SHR,DMCB,('SUBRFORM',(RC))                                       
         MVI   MYSPACE,1                                                        
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
*                                                                               
         CLI   RTLEDG,0            RETAIL BILLING?                              
         BNE   LSTE04              YES, CAN'T DO RECAP YET                      
         GOTO1 RECAP,DMCB,(RC)     PRINT TAX BY CODE                            
*                                                                               
LSTE04   MVC   P,SPACES                                                         
         MVC   P+1(L'AC@TOTAL),AC@TOTAL                                         
         MVC   P+1+L'AC@TOTAL(11),SPACES                                        
         MVC   TEMPWK,JOBWKC                                                    
         GOTO1 SHR,DMCB,('SUBRTOT',(RC))                                        
         MVC   JOBWKC,ZEROS                                                     
         MVI   MYSPACE,1                                                        
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
         MVI   P+1,C'-'                                                         
         MVC   P+2(82),P+1                                                      
         MVI   MYSPACE,1                                                        
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
         B     XIT                                                              
         EJECT                                                                  
*              FIRST FOR WORK CODE(ANALFRST)                                    
*                                                                               
         USING TRNELD,R2                                                        
ANALFST  CLI   MODE,ANALFRST                                                    
         BNE   TRANREC                                                          
         CLI   BILLTYPE,NOTBILL                                                 
         BE    XIT                                                              
         ZAP   WCODECD,=P'0'       WORK-CODE CASH DISCOUNT                      
         XC    SVAGWC,SVAGWC                                                    
         XC    SVWKCCR,SVWKCCR     CLEAR WORKCODE LEVEL INCOME ACCOUNTS         
         XC    SVWKCDR,SVWKCDR                                                  
         MVI   SVANINC,C'N'        INDICATE NOT AN INCOME WORKCODE              
         OI    WKCOPT,WKCDTL                                                    
         NI    WKCOPT,X'FF'-WKCMT  TURN OFF MEDIA TRANSFER BIT                  
*                                                                               
         L     R2,ADTRANS                                                       
         CLC   QTRNSFLT(2),SPACES  IF FILTERING BY WORKCODE                     
         BE    *+14                                                             
         CLC   TRNANAL,=C'99'        ALWAYS EXCLUDE BILLING                     
         BE    XIT                                                              
*                                                                               
         MVC   SVANAL(2),TRNANAL                                                
         MVC   SVANALN,SPACES                                                   
         MVC   SVANALN(L'AC@OTHRS),AC@OTHRS                                     
         MVC   SVAGWC,SVANAL                                                    
*                                                                               
         L     R4,ADGOBLOC                                                      
         USING GOBLOCKD,R4                                                      
         MVC   GOSELWC,SVANAL                                                   
         L     R3,AMONACC                                                       
         USING ACMD,R3                                                          
         MVC   GOAKEY,ACMALTN       A(LAST RECORD READ)                         
         GOTO1 GETOPT,DMCB,ADGOBLOC                                             
         XC    GOAKEY,GOAKEY                                                    
         XC    GOSELWC,GOSELWC                                                  
         MVC   SVGSTCOD,GOTAXCOD   SAVE THE GST CODE                            
         MVC   SVPSTCOD,GOPSTCOD   SAVE THE PST CODE                            
         MVC   SVPSTPRV,GOPSTPRV   SAVE THE PROVINCE CODE                       
*                                                                               
         CLC   QTRNSFLT(2),SPACES  IF FILTERING BY WORKCODE                     
         BE    ANLF02                                                           
         CLC   SVANAL,=C'99'       ALWAYS EXCLUDE BILLING                       
         BE    XIT                                                              
*                                                                               
ANLF02   L     R2,ADLEDGER         LOOK FOR DESCRIPTION                         
         MVI   ELCODE,WCOELQ       X'12' - WORK CODE ELEMENT                    
         BAS   RE,GETEL                                                         
         BNE   ANLF08                                                           
*                                                                               
         USING WCOELD,R2                                                        
ANLF04   CLC   SVANAL,WCOCODE                                                   
         BNE   ANLF05                                                           
         MVC   SVANALN,SPACES                                                   
         MVC   SVANALN(15),WCODESC                                              
         TM    WCOSTAT2,WCOSINC    IS THIS AN INCOME WORKCODE ?                 
         BZ    *+8                 NO                                           
         MVI   SVANINC,C'Y'        YES                                          
         CLI   GO1LINBL,C'Y'       IS IT ONE-LINE FOR WORK-CODE                 
         BNE   *+8                                                              
         NI    WKCOPT,ALL-WKCDTL   NO WORK-CODE DETAILS                         
         TM    WCOSTAT,WCOSMEDT    IS MEDIA TRANSFER BIT ON ?                   
         BZ    ANLF06              NO                                           
         OI    WKCOPT,WKCMT        YES                                          
         B     ANLF06                                                           
*                                                                               
ANLF05   CLC   SVPBWRK,WCOCODE                                                  
         BNE   ANLF06                                                           
         MVC   SVPBWRKN(L'WCODESC),WCODESC                                      
*                                                                               
ANLF06   BAS   RE,NEXTEL                                                        
         BE    ANLF04                                                           
*                                                                               
ANLF08   TM    CLIOPT2,USELONG     SHOULD WE LOOK FOR LONG NAMES?               
         BZ    ANLF12              NO                                           
*                                                                               
         USING WCNTABD,R4                                                       
         L     R4,ACMWCNMA         YES                                          
         LH    R2,ACMWCNMN                                                      
         LTR   R2,R2                                                            
         BZ    ANLF12                                                           
*                                                                               
ANLF10   CLC   SVANAL,WCNCODE                                                   
         BNE   *+10                                                             
         MVC   SVANALN,WCNNAME                                                  
         CLC   SVPBWRK,WCNCODE                                                  
         BNE   *+10                                                             
         MVC   SVPBWRKN,WCNNAME                                                 
         LA    R4,WCNTABL(R4)                                                   
         BCT   R2,ANLF10                                                        
*                                                                               
         USING GOXBLKD,R4                                                       
ANLF12   L     R4,ACMAGOX                                                       
         OC    GOAGWC,GOAGWC       IF WE HAVE AN OVERRIDE, USE IT               
         BZ    *+10                                                             
         MVC   SVAGWC,GOAGWC                                                    
         MVC   SVWKCCR,GOINCCR     SAVE INCOME CREDIT ACCOUNT                   
         MVC   SVWKCDR,GOINCDR     SAVE INCOME DEBIT ACOUNT                     
*                                                                               
         TM    BILLTYPE,ESTIM                                                   
         BO    ANLFEST                                                          
         TM    BILLTYPE,PROG                                                    
         BO    ANLFPRO                                                          
         TM    BILLTYPE,ONELNE                                                  
         BO    ANLFONE                                                          
         TM    BILLTYPE,TOTAL                                                   
         BO    ANLFTOT                                                          
         DC    H'0'                                                             
***********************************************************************         
*                                  TOTAL BILLTYPE                               
***********************************************************************         
*                                                                               
ANLFTOT  CLC   SVANAL,=C'99'                                                    
         BE    ANLFT6                                                           
*                                                                               
ANLFT2   LA    RE,MID1+1                                                        
         CLC   SVANAL,=C'99'                                                    
         BE    *+14                                                             
         MVC   0(L'SVANAL,RE),SVANAL                                            
         LA    RE,L'SVANAL+1(RE)                                                
         MVC   0(L'SVANALN,RE),SVANALN                                          
         OC    MID1,SPACES                                                      
         CLC   SVANAL,=C'99'                                                    
         BNE   *+12                                                             
         TM    BILLMODE,UNBILL                                                  
         BO    ANLFT4                                                           
         TM    WKCOPT,WKCDTLC+WKCDTL                                            
         BNO   ANLFTX                                                           
*                                                                               
ANLFT4   GOTO1 UNDERLIN,DMCB,(L'SVANALN,MID1+1),MID2+1                          
         OC    MID1,SPACES                                                      
         OC    MID2,SPACES                                                      
         B     ANLFTX                                                           
*                                                                               
ANLFT6   GOTO1 PRNT,DMCB,('PRNTOTC',(RC))                                       
         MVC   SVANALN(L'AC@PRVBL),AC@PRVBL                                     
         TM    BILLMODE,UNBILL                                                  
         BO    ANLFT2                                                           
         CLI   PREVOPT,C'Y'                                                     
         BNE   ANLFT2                                                           
*                                                                               
ANLFTX   B     XIT                                                              
***********************************************************************         
*                                  ONELINE BILLTYPE                             
***********************************************************************         
*                                                                               
ANLFONE  CLC   SVANAL,=C'99'                                                    
         BNE   ANLFOX                                                           
         GOTO1 PRNT,DMCB,('PRNTOTC',(RC))                                       
         MVC   SVANALN(L'AC@PRVBL),AC@PRVBL                                     
         CLI   PREVOPT,C'Y'                                                     
         BE    ANLFOX                                                           
         LA    RE,MID1+1                                                        
         MVC   0(L'SVANALN,RE),SVANALN                                          
         OC    MID1,SPACES                                                      
         TM    BILLMODE,UNBILL                                                  
         BO    ANLFO2                                                           
         TM    WKCOPT,WKCDTLC+WKCDTL                                            
         BNO   ANLFOX                                                           
*                                                                               
ANLFO2   GOTO1 UNDERLIN,DMCB,(L'SVANALN,MID1+1),MID2+1                          
         OC    MID1,SPACES                                                      
         OC    MID2,SPACES                                                      
*                                                                               
ANLFOX   B     XIT                                                              
***********************************************************************         
*                                  PROGRESSIVE BILLTYPE                         
***********************************************************************         
*                                                                               
ANLFPRO  CLC   SVANAL,=C'99'                                                    
         BE    ANLFP6                                                           
*                                                                               
ANLFP2   LA    RE,MID1+1                                                        
         CLC   SVANAL,=C'99'                                                    
         BE    *+14                                                             
         MVC   0(L'SVANAL,RE),SVANAL                                            
         LA    RE,L'SVANAL+1(RE)                                                
         MVC   0(L'SVANALN,RE),SVANALN                                          
         OC    MID1,SPACES                                                      
         CLC   SVANAL,=C'99'                                                    
         BNE   *+12                                                             
         TM    BILLMODE,UNBILL                                                  
         BO    ANLFP4                                                           
         TM    WKCOPT,WKCDTLC+WKCDTL                                            
         BNO   ANLFPX                                                           
*                                                                               
ANLFP4   GOTO1 UNDERLIN,DMCB,(L'SVANALN,MID1+1),MID2+1                          
         OC    MID1,SPACES                                                      
         OC    MID2,SPACES                                                      
         B     ANLFPX                                                           
*                                                                               
ANLFP6   GOTO1 PRNT,DMCB,('PRNTOTC',(RC))                                       
         CLI   RTLEDG,0                                                         
         BNE   ANLFP8                                                           
         GOTO1 PRNT,DMCB,('PRNTDUE',(RC))                                       
*                                                                               
ANLFP8   MVC   SVANALN(L'AC@PRVBL),AC@PRVBL                                     
         CLI   PREVOPT,C'Y'                                                     
         BNE   ANLFP2                                                           
*                                                                               
ANLFPX   B     XIT                                                              
***********************************************************************         
*                                  ESTIMATE BILLTYPE                            
***********************************************************************         
*                                                                               
ANLFEST  CLC   SVANAL,=C'99'                                                    
         BNE   ANLFEX                                                           
         GOTO1 PRNT,DMCB,('PRNTOTC',(RC))                                       
         MVC   SVANALN(L'AC@PRVBL),AC@PRVBL                                     
         TM    BILLMODE,UNBILL                                                  
         BO    ANLFE2                                                           
         CLI   PREVOPT,C'Y'                                                     
         BE    ANLFEX                                                           
*                                                                               
ANLFE2   LA    RE,MID1+1                                                        
         MVC   0(L'SVANALN,RE),SVANALN                                          
         OC    MID1,SPACES                                                      
         TM    BILLMODE,UNBILL                                                  
         BO    ANLFE4                                                           
         TM    WKCOPT,WKCDTLC+WKCDTL                                            
         BNO   ANLFEX                                                           
*                                                                               
ANLFE4   GOTO1 UNDERLIN,DMCB,(L'SVANALN,MID1+1),MID2+1                          
         OC    MID1,SPACES                                                      
         OC    MID2,SPACES                                                      
*                                                                               
ANLFEX   B     XIT                                                              
         DROP  R2,R4                                                            
         EJECT                                                                  
***********************************************************************         
*              PROCESS A TRANSACTION(PROCTRNS)                        *         
***********************************************************************         
*                                                                               
         USING TRNELD,R2                                                        
TRANREC  CLI   MODE,PROCTRNS                                                    
         BNE   ANALLST                                                          
         L     R2,ADTRANS                                                       
         CLI   TRNEL,TRNELQ                                                     
         BNE   XIT                                                              
*       - - - - - - - - - - - - - -                                             
         SH    R2,DATADISP         GET TO FRONT OF TRAN REC                     
         LA    R2,ACCOPEEL(R2)                                                  
         OC    0(ACCOPLEN,R2),0(R2) CHECK FOR PEELED ITEMS                      
         BNZ   XIT                  NOT ZERO MEANS PEELED SO EXIT               
         L     R2,ADTRANS          RELOAD ADDRESS OF 44 ELEMENT                 
*                                                                               
         CLI   BILLTYPE,NOTBILL                                                 
         BE    XIT                                                              
         NI    BILLOPT,ALL-WRITE                                                
*                                                                               
         XC    CONTRA,CONTRA       CLEAR CONTRA SAVEAREA                        
*                                                                               
         ZAP   RATE,=P'0'                                                       
         ZAP   HOURS,=P'0'                                                      
         ZAP   PRICE,=P'0'                                                      
         ZAP   UNITS,=P'0'                                                      
*                                                                               
         CLC   TRNANAL,=C'**'      IGNORE ORDERS                                
         BE    XIT                                                              
         CLC   TRNANAL,=C'99'      PREVIOUS BILLING?                            
         BNE   *+12                NO                                           
         TM    BILLTYPE,ESTIM+TOTAL+ONELNE                                      
         BNZ   TRAN00              MUST HAVE ALL 99'S FOR THESE                 
         TM    BILLMODE,UNBILL+RERUN                                            
         BNZ   TRAN00                                                           
         TM    TRNSTAT,X'20'       IGNORE REVERSALS                             
         BO    XIT                                                              
*                                                                               
TRAN00   L     R2,ADTRANS                                                       
         MVI   ELCODE,TRSELQ       CHECK STATUS BYTE FOR NON-BILLABLE           
         TM    BILLMODE,RERUN                                                   
         BO    TRAN02                                                           
         BAS   RE,NEXTEL                                                        
         BNE   TRAN02              NO ELEMENT, CAN'T CHECK                      
         USING TRSELD,R2                                                        
         TM    TRSSTAT3,TRSSNBIL                                                
         BO    XIT                                                              
*                                                                               
TRAN02   L     R2,ADTRANS                                                       
         MVI   ELCODE,TRXELQ       CHECK EXTRA STATUS FOR PENDING               
         TM    BILLMODE,RERUN                                                   
         BO    TRAN03                                                           
         BAS   RE,NEXTEL                                                        
         BNE   TRAN03              NO ELEMENT, CAN'T CHECK                      
         USING TRXELD,R2                                                        
         TM    TRXSTA2,TRXSXFRP+TRXSWOFP+TRXSBILP                               
         BNZ   XIT                                                              
         DROP  R2                                                               
*                                                                               
TRAN03   XC    LONGREF,LONGREF     CLEAR LONG REF IN CASE NOT USED              
         CLI   PROF27,C'Y'         USE LONG INVOICE NUMBER?                     
         BNE   TRAN05              NO                                           
         L     R2,ADTRANS                                                       
*                                                                               
         USING FFTELD,R2                                                        
TRAN04   MVI   ELCODE,FFTELQ       LOOK FOR LONG INVOICE NUMBER                 
         BAS   RE,NEXTEL                                                        
         BNE   TRAN05                                                           
         CLI   FFTTYPE,FFTTINVN    44 - SUPPLIER INVOICE NUMBER                 
         BNE   TRAN04                                                           
         SR    R1,R1                                                            
         ICM   R1,1,FFTDLEN        NO DATA, SKIP IT                             
         BZ    TRAN05                                                           
         BCTR  R1,0                SUBTRACT 1 FOR MVC                           
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   LONGREF(0),FFTDATA  MAX LENGTH IS 20                             
         DROP  R2                                                               
*                                                                               
         USING TRNELD,R2                                                        
TRAN05   L     R2,ADTRANS                                                       
         MVC   HGSTCOD,SVGSTCOD    SAVE THE GST CODE                            
         MVC   HGSTDAT,SVGSTDAT    AND THE DATE                                 
*                                                                               
         MVC   HPSTCOD,SVPSTCOD    SAVE THE PST CODE                            
         MVC   HPSTDAT,SVPSTDAT     AND THE DATE                                
         MVC   HPSTPRV,SVPSTPRV     AND THE PROVINCE CODE                       
*                                                                               
         LR    R3,R2                                                            
         SH    R3,DATADISP                                                      
*                                                                               
         USING TRNRECD,R3                                                       
         TM    BILLMODE,UNBILL                                                  
         BO    TRAN40              UNBILLING                                    
         CLC   TRNANAL,=C'99'                                                   
         BE    TRAN30                                                           
*                                                                               
         DC    0H'0'                                                            
         TM    BILLTYPE,ESTIM                                                   
         BO    XIT                 DON'T POST IF ESTIMATE                       
         TM    BILLTYPE,TOTAL      IF TOTAL BILL AND ALREADY BILLED             
         BZ    TRAN06              SKIP END DATE CHECK                          
         OC    TRNRECD+ACCOUSED(ACCOULEN),TRNRECD+ACCOUSED                      
         BNZ   TRAN16                                                           
*                                                                               
TRAN06   TM    BILLMODE,RERUN                                                   
         BO    TRAN10                                                           
         TM    TRNSTAT,X'04'       IS ITEM MARKED HELD                          
         BZ    TRAN10              IF NOT OK TO BILL                            
         TM    CLIOPT,UNHOLD       IS CLIENT OPTION TO AUTO UNHOLD              
         BZ    TRAN08              IF NOT DON'T UNHOLD                          
         NI    TRNSTAT,X'FF'-X'04' UNHOLD FOR NEXT TIME                         
         MVI   MODE,WRITRANS        SET TO  WRITE IT BACK                       
*                                                                               
TRAN08   TM    REQOPT,REQAPPO       BILL APPROVED(UNHELD)  ONLY                 
         BO    XIT                                                              
*                                                                               
TRAN10   CLC   TRNDATE,ENDATE      TRANSACTION PAST END DATE                    
         BH    XIT                                                              
         CLI   TRNTYPE,50          TALENT INTERFACE                             
         BNE   TRAN12                                                           
         LA    R1,PROF7            GET OPTION ADDRESS FOR A21                   
         TM    BILLMODE,BILL       IS THIS BILLING?                             
         BO    *+8                 YES                                          
         LA    R1,PROF15           NO, GET A22 OPTION ADDRESS                   
         CLI   0(R1),C'Y'                                                       
         BNE   TRAN12              CAN OPTIONALLY BE EXCLUDED                   
         CLC   TRNDATE,ENDATE                                                   
         BE    XIT                 IF EQUAL TO END DATE                         
*                                                                               
TRAN12   TM    REQOPT,REQPRDO      IS REQUEST FOR PRODUCTION ONLY               
         BZ    TRAN14              BRANCH IF NOT                                
         TM    WKCOPT,WKCMT        IS THIS A MEDIA CHARGE                       
         BO    XIT                 IF IT IS IGNORE IT                           
         B     TRAN16                                                           
*                                                                               
TRAN14   TM    REQOPT,REQMEDO      IS REQUEST FOR MEDIA ONLY                    
         BZ    TRAN16              BRANCH IF NOT                                
         TM    WKCOPT,WKCMT        IS THIS A MEDIA CHARGE                       
         BZ    XIT                 BRANCH IF IT IS NOT                          
*                                                                               
TRAN16   DC    0H'0'                                                            
         TM    BILLMODE,RERUN                                                   
         BZ    TRAN20                                                           
         CLC   QSELECT,SPACES      RERUN OF SPECIFIC BILL                       
         BE    TRAN17                                                           
         L     R2,ADTRANS                                                       
         MVI   ELCODE,PTAELQ       FIND BILLING ELEMENT                         
TRAN16A  BAS   RE,NEXTEL                                                        
         BNE   XIT                                                              
         USING PTAELD,R2                                                        
         CLC   PTADATE,TODAY2      CHECK ACTIVITY DATE?                         
         BNE   TRAN16A             NO, SKIP IT                                  
         CLI   PTATYPE,PTATRAL     IS THIS A BILLING ELEMENT?                   
         BNE   TRAN16A             NO, SKIP IT                                  
         CLC   PTARBLNO,QSELECT    IS THE THE CORRECT BILL                      
         BNE   TRAN16A             NO, SKIP IT                                  
         CLC   PTARBLDT,RCDAY2     IS IT THE CORRECT DAY?                       
         BNE   TRAN16A             YES,SKIP IT                                  
         PACK  BILLNO,QSELECT+2(4)                                              
         MVC   BILLREF,QSELECT                                                  
         L     R2,ADTRANS                                                       
         USING TRNELD,R2                                                        
         B     TRAN24                                                           
*                                                                               
TRAN17   OC    TRNRECD+ACCOUSED(ACCOULEN),TRNRECD+ACCOUSED                      
         BZ    XIT                 RE-RUN IGNORE ITEMS NOT USED                 
         TM    BILLTYPE,PROG                                                    
         BNO   TRAN18                                                           
         CLC   TRNRECD+ACCOUSED(ACCOULEN),TODAY2                                
*                                  PROG ONLY ITEMS MARKED TODAY                 
         BNE   XIT                                                              
         OI    BILLOPT,WRITE                                                    
         B     TRAN24                                                           
*                                                                               
TRAN18   TM    BILLTYPE,TOTAL                                                   
         BNO   TRAN24                                                           
         CLC   TRNRECD+ACCOUSED(ACCOULEN),TODAY2                                
         BNE   TRAN24              MARKED ITEMS                                 
         OI    BILLOPT,WRITE       WRITE ITEMS BILLED TODAY                     
         B     TRAN24                                                           
*                                                                               
TRAN20   OC    TRNRECD+ACCOUSED(ACCOULEN),TRNRECD+ACCOUSED TEST BILLED?         
         BNZ   TRAN22              YES, SEE IF TOTAL BILL                       
         MVC   TRNRECD+ACCOUSED(ACCOULEN),TODAY2                                
*                                  NO, MARK IT USED THEN                        
         OI    BILLOPT,WRITE                                                    
         NI    TRNSTAT,X'FF'-X'04'   TURN-OFF HELD WHEN BILLING                 
         B     TRAN28                                                           
*                                                                               
TRAN22   TM    BILLTYPE,PROG       IF ALREADY BILLED, MUST BE TOTAL             
         BO    XIT                                                              
*                                                                               
TRAN24   XC    SVGSTCOD,SVGSTCOD   CLEAR GST CODE                               
         XC    SVPSTCOD,SVPSTCOD   CLEAR PST CODE                               
         XC    SVPSTPRV,SVPSTPRV   CLEAR PROVINCE CODE                          
*                                                                               
         USING ACMD,R2                                                          
         L     R2,AMONACC                                                       
         L     R2,ACMAPRO2                                                      
         CLI   0(R2),PTAELQ                                                     
         B     TRAN26+8                                                         
*                                                                               
         USING PTAELD,R2                                                        
TRAN26   MVI   ELCODE,PTAELQ       FIND LATEST BILLING ELEMENT                  
         BAS   RE,NEXTEL                                                        
         BNE   TRAN28                                                           
         CLI   PTATYPE,PTATRAL     IS THIS A BILLING ELEMENT?                   
         BNE   TRAN26              NO, SKIP IT                                  
         TM    PTASTAT1,PTASPEND   YES, IS IT PENDING?                          
         BO    TRAN26              YES, SKIP IT                                 
         TM    PTASTAT1,PTASREVS   NO, IS THIS A REVERSAL?                      
         BO    TRAN26              YES,SKIP IT                                  
         TM    PTASTAT1,PTASREVU   NO, IS THIS REVERSED?                        
         BO    TRAN26              YES, SKIP IT                                 
*                                                                               
         MVC   SVGSTCOD,PTARGSTC   NO, MUST BE THE ONE STILL BILLED             
         MVC   SVPSTCOD,PTARPSTC   GET GST/PST AND PROVINCE CODES               
         MVC   SVPSTPRV,PTARPRVC                                                
*                                                                               
         GOTO1 DATCON,DMCB,(2,PTARBLDT),(1,SVGSTDAT)                            
         MVC   SVPSTDAT,SVGSTDAT                                                
         DROP  R2                                                               
*                                                                               
         USING TRNELD,R2                                                        
TRAN28   L     R2,ADTRANS          RELOAD ADDRESS OF 44 ELEMENT                 
         BAS   RE,ESTRATES                                                      
         GOTO1 GETRATE,DMCB,(RC)                                                
         BAS   RE,POSTRANS                                                      
         BAS   RE,POSTBUFF                                                      
         GOTO1 POSTGST,DMCB,(RC)                                                
         GOTO1 POSTPST,DMCB,(RC)                                                
         B     TRAN80                                                           
         EJECT                                                                  
***********************************************************************         
*              PROCESS A 99 TRANSACTION FOR BILLING                   *         
***********************************************************************         
*                                                                               
         USING TRNELD,R2                                                        
TRAN30   L     R2,ADTRANS          RELOAD ADDRESS OF 44 ELEMENT                 
         CLC   QTRNSFLT(2),SPACES                                               
         BNE   XIT              IF FILTERING BY W/C EXCLUDE BILLING             
         TM    BILLTYPE,PROG                                                    
         BO    TRAN36                                                           
*                                                                               
         TM    BILLMODE,RERUN      IS THIS A RERUN?                             
         BZ    TRAN32              NO                                           
         CLC   TRN2DAY,TODAY2      YES, ORIGINAL 99                             
         BNL   XIT                                                              
*                                                                               
TRAN32   BAS   RE,SUBABILL         PREV. BILLS FOR TOTAL AND EST.               
         BAS   RE,POSTBUFF                                                      
*                                                                               
         TM    BILLTYPE,TOTAL+ONELNE                                            
         BZ    TRAN84                                                           
         GOTO1 BILLE5,DMCB,(RC)    UPDATE GDAEL ELEMENT                         
*                                                                               
         TM    BILLTYPE,TOTAL                                                   
         BNO   TRAN84                                                           
*                                                                               
         CP    TRNAM2SK,=P'0'                                                   
         BE    TRAN84              NO SK INCOME TO BE REVERSED                  
         OC    TRNSK2SI,TRNSK2SI                                                
         BZ    TRAN34              NOT REVERSED YET                             
         TM    BILLMODE,RERUN      MARKED WITH REVERSED DATE                    
         BNO   TRAN84              AND NOT A RERUN                              
         CLC   TRNSK2SI,TODAY2                                                  
         BNE   TRAN84                                                           
*                                                                               
TRAN34   AP    SKINC,TRNAM2SK         SK INCOME TO SI NET                       
         AP    SKGRS,TRNBLPAY         AND GROSS                                 
         MVC   TRNSK2SI,TODAY2        TODAY                                     
         MVI   MODE,WRITRANS                                                    
         B     TRAN84                                                           
*                                                                               
TRAN36   CLI   RTLEDG,0            RETAIL BILLING?                              
         BE    TRAN38              NO                                           
         TM    RUNOPT,NEEDGST+NEEDPST                                           
         BNZ   *+8                                                              
*                                                                               
TRAN38   BAS   RE,ADDABILL                                                      
         CLI   PREVOPT,C'Y'        NO PREVIOUS BILLS                            
         BE    TRAN96                                                           
         B     TRAN84                                                           
         EJECT                                                                  
***********************************************************************         
*              PROCESS A TRANSACTION FOR UNBILLING                    *         
***********************************************************************         
*                                                                               
         USING TRNELD,R2                                                        
TRAN40   L     R2,ADTRANS          RELOAD ADDRESS OF 44 ELEMENT                 
         CLC   TRNANAL,=C'99'                                                   
         BE    TRAN60                                                           
*                                                                               
         TM    BILLMODE,RERUN                                                   
         BO    TRAN42                                                           
         TM    TRNSTAT,X'04'       HELD ITEM                                    
         BO    XIT                 SKIP IT                                      
         TM    TRNSTAT,X'20'                                                    
         BZ    TRAN42              NOT REVERSED                                 
         MVI   ELCODE,X'60'                                                     
         BAS   RE,NEXTEL                                                        
         BNE   TRAN42                                                           
         USING TRSELD,R2                                                        
         CLC   TRSDATE,USEDATE                                                  
         BH    XIT                                                              
         CLI   TRSLN,9                                                          
         BL    TRAN42              OLD ELEMENT                                  
         CLC   TRSREVD,USEDATE    IF REVERSED BEFORE ORIGINAL BILLING           
         BL    XIT                 DATE -  IGNORE IT                            
*                                                                               
TRAN42   XC    SVGSTCOD,SVGSTCOD   CLEAR GST/PST/PROVINE                        
         XC    SVPSTCOD,SVPSTCOD                                                
         XC    SVPSTPRV,SVPSTPRV                                                
*                                                                               
         USING ACMD,R2                                                          
         L     R2,AMONACC                                                       
         L     R2,ACMAPRO2         GET PRORATA BLOCK                            
*                                                                               
         TM    BILLMODE,RERUN      IS THIS A RERUN?                             
         BZ    TRAN48              NO                                           
*                                                                               
         CLI   0(R2),PTAELQ        YES, LOOK FOR ELEMENTS                       
         B     TRAN44+8                                                         
*                                                                               
         USING PTAELD,R2                                                        
TRAN44   MVI   ELCODE,PTAELQ                                                    
         BAS   RE,NEXTEL                                                        
         BNE   TRAN104                                                          
*                                                                               
         CLI   PTATYPE,PTATRAL     IS THIS BILLING?                             
         BNE   TRAN44              NO                                           
         TM    PTASTAT1,PTASPEND   YES, IS IT STILL PENDING?                    
         BO    TRAN44              YES                                          
         TM    PTASTAT1,PTASREVS   NO, IS THIS A REVERSAL?                      
         BZ    TRAN46              NO                                           
*                                                                               
         CLC   PTARORGD,USEBILL    ORIGINAL BILL DATE MATCH?                    
         BNE   TRAN44              NO                                           
         CLC   PTARORGB,QSELECT    ORIGINAL BILL NUMBER MATCH?                  
         BNE   TRAN44              NO                                           
         CLC   PTARDATE,TODAY2     YES, UNBILL DATE MATCH?                      
         BNE   TRAN44              NO                                           
         OI    BILLOPT,WRITE       YES, UNMARK IT                               
         B     TRAN58                                                           
*                                                                               
TRAN46   TM    PTASTAT1,PTASREVU   IS THIS A REVERSAL?                          
         BO    TRAN44              YES, SKIP IT                                 
         TM    BILLTYPE,TOTAL      IF NOT TOTAL, EXCLUDE                        
         BNO   TRAN44                                                           
         CLC   PTARDATE,USEDATE    NO, BILLED BEFORE THIS ONE?                  
         BNH   TRAN58              YES, INCLUDE                                 
         B     TRAN44              NO, SKIP IT                                  
*                                                                               
TRAN48   CLC   TRNRECD+ACCOUSED(ACCOULEN),USEDATE                               
*                                  IS THIS THE DATE WE WANT?                    
         BNE   TRAN52              NO, CHECK IF RUNNING TOTAL BILL              
*                                                                               
         CLI   0(R2),PTAELQ                                                     
         B     TRAN50+8                                                         
*                                                                               
         USING PTAELD,R2                                                        
TRAN50   MVI   ELCODE,PTAELQ                                                    
         BAS   RE,NEXTEL                                                        
         BNE   TRAN104                                                          
*                                                                               
         CLI   PTATYPE,PTATRAL     IS THIS BILLING?                             
         BNE   TRAN50              NO                                           
         TM    PTASTAT1,PTASPEND   YES, IS IT STILL PENDING?                    
         BO    TRAN50              YES                                          
         TM    PTASTAT1,PTASREVS   NO, IS THIS A REVERSAL?                      
         BO    TRAN50              YES                                          
         TM    PTASTAT1,PTASREVU   NO, HAS THIS ALREADY BEEN REVERSED?          
         BO    TRAN50              YES                                          
         CLC   PTARBLNO,QSELECT    NO, DOES BILL NUMBER MATCH?                  
         BNE   TRAN50              NO                                           
         CLC   PTARBLDT,USEBILL    NO, DOES BILL DATE MATCH?                    
         BNE   TRAN50              NO                                           
***********************************************************************         
* THIS CODE IS TEMPORARY - IT CAN BE DELETED AFTER JUNE 26,1997.      *         
* TRANSACTIONS BILLED PRIOR TO JUNE 26, 1995 DO NOT HAVE A RUN DATE.  *         
* THEREFORE, PTARDATE CONTAINS THE BILLDATE AND WILL NOT MATCH THE    *         
* RUN DATE IF A BILL DATE WAS SPECIFIED.                              *         
*                                                                               
         CLC   USEDATE,=XL2'BEDA'                                               
         BL    *+14                                                             
***********************************************************************         
         CLC   PTARDATE,USEDATE    YES, DOES DATE MATCH?                        
         BNE   TRAN50              NO                                           
*                                                                               
         OI    BILLOPT,WRITE       YES                                          
         XC    TRNRECD+ACCOUSED(ACCOULEN),TRNRECD+ACCOUSED                      
         B     TRAN58                                                           
*                                                                               
         USING TRNRECD,R3                                                       
TRAN52   TM    BILLTYPE,TOTAL      ONLY TOTAL CAN SHOW BILLED ITEMS             
         BZ    TRAN104                                                          
*                                                                               
         CLI   0(R2),PTAELQ                                                     
         B     TRAN54+8                                                         
*                                                                               
         USING PTAELD,R2                                                        
TRAN54   MVI   ELCODE,PTAELQ                                                    
         BAS   RE,NEXTEL                                                        
         BNE   TRAN104                                                          
*                                                                               
         CLI   PTATYPE,PTATRAL     IS THIS BILLING?                             
         BNE   TRAN54              NO                                           
         TM    PTASTAT1,PTASPEND   YES, IS IT PENDING?                          
         BO    TRAN54              YES                                          
*                                                                               
*                                  IS THIS TRANSACTION BILLED?                  
         OC    TRNRECD+ACCOUSED(ACCOULEN),TRNRECD+ACCOUSED                      
         BZ    *+14                NO                                           
*                                  YES, PRIOR TO OUR DATE?                      
         CLC   TRNRECD+ACCOUSED(ACCOULEN),USEDATE                               
         BL    TRAN56              YES                                          
*                                                                               
         TM    PTASTAT1,PTASREVU   NO, FIND ORIGINAL REVERSED 77                
         BZ    TRAN54              NO                                           
         CLC   PTARDATE,USEDATE    YES, BILLED AT TIME OF BILLING?              
         BNL   TRAN54              NO, BILLED AFTER - SKIP IT                   
         CLC   PTARUNBD,USEDATE    YES, WAS IT UNBILLED AFTER BILLING?          
         BNH   TRAN54              NO, PRIOR - SKIP IT                          
         B     TRAN58              YES, INCLUDE                                 
*                                                                               
TRAN56   TM    PTASTAT1,PTASREVU   SKIP REVERSALS                               
         BO    TRAN54                                                           
         TM    PTASTAT1,PTASREVS                                                
         BO    TRAN54                                                           
***********************************************************************         
* THIS CODE IS TEMPORARY - IT CAN BE DELETED AFTER JUNE 26,1997.      *         
* TRANSACTIONS BILLED PRIOR TO JUNE 26, 1995 DO NOT HAVE A RUN DATE.  *         
* THEREFORE, PTARDATE CONTAINS THE BILLDATE AND WILL NOT MATCH THE    *         
* RUN DATE IF A BILL DATE WAS SPECIFIED.                              *         
*                                                                               
         CLC   TRNRECD+ACCOUSED(ACCOULEN),=XL2'BEDA'                            
         BL    *+14                                                             
***********************************************************************         
*                                                                               
         CLC   PTARDATE,TRNRECD+ACCOUSED                                        
*                                  FIND ELEMENT THAT MATCHES USED DATE          
         BNE   TRAN54                                                           
*                                                                               
TRAN58   MVC   SVGSTCOD,PTARGSTC   GET GST/PST/PROVINCE CODE                    
         MVC   SVPSTCOD,PTARPSTC                                                
         MVC   SVPSTPRV,PTARPRVC                                                
*                                                                               
         GOTO1 DATCON,DMCB,(2,PTARBLDT),(1,SVGSTDAT)                            
         MVC   SVPSTDAT,SVGSTDAT                                                
*                                                                               
         USING TRNELD,R2                                                        
         L     R2,ADTRANS                                                       
         BAS   RE,ESTRATES                                                      
*                                                                               
         ZAP   WORK(16),TRNAMNT          PUT IN LARGE FIELD FOR MP              
         MP    WORK(16),=P'-1'                                                  
         ZAP   TRNAMNT,WORK(16)                                                 
*                                                                               
         GOTO1 GETRATE,DMCB,(RC)                                                
         BAS   RE,POSTRANS         POST IT                                      
         BAS   RE,POSTBUFF                                                      
         GOTO1 POSTGST,DMCB,(RC)                                                
         GOTO1 POSTPST,DMCB,(RC)                                                
         B     TRAN80                                                           
         DROP  R2                                                               
         EJECT                                                                  
***********************************************************************         
*              PROCESS A 99 TRANSACTION FOR UNBILLING                 *         
***********************************************************************         
*                                                                               
         USING TRNELD,R2                                                        
TRAN60   L     R2,ADTRANS          RELOAD ADDRESS OF 44 ELEMENT                 
         CLC   QTRNSFLT(2),SPACES                                               
         BNE   XIT                 IF FILTERING BY W/C EXCLUDE BILLING          
         TM    BILLTYPE,TOTAL                                                   
         BO    *+12                                                             
         TM    BILLTYPE,ESTIM                                                   
         BZ    XIT                                                              
*                                                                               
         GOTO1 UBILLE5,DMCB,(RC)   UPDATE GDAEL ELEMENT                         
*                                                                               
         L     R2,ADTRANS                                                       
         CLC   TRNNARR(6),=C'MANUAL'                                            
         BE    TRAN62                                                           
         CLC   TRN2DAY,USEDATE                                                  
         BNL   XIT                                                              
         AP    TOTPB,TRNAMNT       ADD PREVIOUS 99'S TO TOTPB                   
         BAS   RE,ADDABILL         FOR TOTAL BILL NEED OLD BILLS                
         BAS   RE,POSTBUFF                                                      
*                                                                               
         CP    TRNAM2SK,=P'0'                                                   
         BE    TRAN84              NO SK IMCOME                                 
         CLC   TRNSK2SI,USEDATE    WAS IT ADDED TO SI TODAY                     
         BNE   TRAN84                                                           
         SP    SKINC,TRNAM2SK      IF SO, MUST TAKE IT OUT                      
         SP    SKGRS,TRNBLPAY         AND GROSS                                 
         XC    TRNSK2SI,TRNSK2SI      AND UNMARK                                
         MVI   MODE,WRITRANS                                                    
         B     TRAN84                                                           
*                                                                               
TRAN62   MVI   ELCODE,X'60'        INCLUDE ALL MANUAL BILLING                   
         BAS   RE,NEXTEL           THAT WAS ON FILE WHEN THE TOTAL              
         BNE   TRAN64              BILL WAS RUN                                 
         USING TRSELD,R2                                                        
         CLC   TRSDATE,USEDATE                                                  
         BH    XIT                                                              
         L     R2,ADTRANS                                                       
         B     TRAN66                                                           
*                                                                               
TRAN64   L     R2,ADTRANS                                                       
         USING TRNELD,R2                                                        
         GOTO1 DATCON,DMCB,(1,TRNDATE),(2,WORK)                                 
         CLC   WORK(2),USEDATE                                                  
         BH    XIT                                                              
*                                                                               
TRAN66   BAS   RE,ADDABILL                                                      
         BAS   RE,POSTBUFF                                                      
         B     TRAN84                                                           
         EJECT                                                                  
***********************************************************************         
*              COMMON TRANSACTION LOGIC                               *         
***********************************************************************         
*                                                                               
TRAN80   TM    WKCOPT,WKCMT                                                     
         BZ    TRAN82                                                           
         TM    GRPOPT,GRPBILL      IF MEDIA TRANSFER AND GROUP BILL             
         BO    TRAN96              DON'T PRINT TILL SUMMARY                     
         B     TRAN86              ELSE, ALWAYS PRINT MEDIA DETAIL              
*                                                                               
TRAN82   TM    WKCOPT,WKCDTLC+WKCDTL   PRINT DETAIL?                            
         BNO   TRAN86                                                           
*                                                                               
TRAN84   GOTO1 FORMLINE,DMCB,(RC)                                               
*                                                                               
TRAN86   TM    BILLTYPE,ONELNE                                                  
         BZ    TRAN88                                                           
         CLC   SVANAL,=C'99'                                                    
         BE    TRAN88                                                           
         MVC   P,SPACES                                                         
         MVC   PSECOND,SPACES                                                   
         MVC   PTHIRD,SPACES                                                    
         B     TRAN96              GO AND MARK TRANSACTION                      
*                                                                               
TRAN88   DS    0H                                                               
         CLI   MID2+1,C'-'         HAVE WE PRINTED THE MIDLINES YET?            
         BNE   TRAN90              YES-BRANCH                                   
         MVI   FORCEMID,C'Y'                                                    
         ZIC   RE,LINE                                                          
         ZIC   RF,MAXLINES                                                      
         LA    RE,4(RE)                                                         
         LA    R1,P                ADD ONE FOUR EACH NON BLANK LINE             
         LA    R0,4                                                             
         CLC   0(132,R1),SPACES                                                 
         BE    *+16                                                             
         LA    RE,1(RE)                                                         
         LA    R1,132(R1)                                                       
         BCT   R0,*-18                                                          
         CR    RE,RF                                                            
         BNH   TRAN90                                                           
         MVI   FORCEHED,C'Y'                                                    
*                                                                               
TRAN90   DS    0H                                                               
         CLC   TRNANAL,=C'99'                                                   
         BNE   *+8                                                              
         MVI   MYSPACE,1           SINGLE SPACE PREVIOUS BILLS                  
         TM    WKCOPT,WKCDTL                                                    
         BZ    TRAN96              SUPPRESS DETAILS FOR WORK-CODE               
         TM    WKCOPT,WKCDTLC                                                   
         BO    TRAN92              PRINT DETAILS                                
         CLC   TRNANAL,=C'99'                                                   
         BE    TRAN92                                                           
         TM    BILLTYPE,TOTAL+PROG                                              
         BNZ   TRAN96                                                           
*                                                                               
TRAN92   GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
         LA    R3,P+1        PRINT REMAINING NARRATIVE IF ANY                   
         LA    R0,5                                                             
         LA    R2,NARR+(2*21)                                                   
         CLC   0(21,R2),0(R3)      DID WE PRINT 3TH LINE YET?                   
         BNE   TRAN94              NO, PRINT IT NOW?                            
*                                                                               
         LA    R2,21(R2)           YES, GET THE 4TH LINE                        
         CLC   0(21,R2),SPACES                                                  
         BE    TRAN96              NOTHING TO PRINT                             
         LA    R0,4                                                             
*                                                                               
TRAN94   MVC   0(21,R3),0(R2)                                                   
         MVC   0(21,R2),SPACES                                                  
         LA    R3,132(R3)                                                       
         LA    R2,21(R2)                                                        
         BCT   R0,TRAN94                                                        
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
*                                                                               
TRAN96   L     R2,ADTRANS                                                       
         TM    BILLMODE,DRAFT                                                   
         BO    TRAN104                                                          
         TM    BILLOPT,WRITE                                                    
         BZ    TRAN104                                                          
         AP    MARKED,TRNAMNT                                                   
*                                                                               
         L     R4,ADSUBAC                                                       
         USING CACELD,R4                                                        
         GOTO1 POST,DMCB,('POSTSK',(RC))                                        
         CLC   TRNTYPE,EPTYPE      ESTIMATED PRODUCTION ?                       
         BNE   TRAN100                                                          
         GOTO1 POST,DMCB,('POSTEST',(RC))   REVERSE EP POSTING                  
         CLI   EPRFILT2,0          AUTO FILTER2 FOR EP REVERSAL                 
         BE    TRAN100                                                          
         L     R2,ADACC                                                         
         MVI   ELCODE,X'26'                                                     
         BAS   RE,GETEL                                                         
         L     RF,ADACCSTA                                                      
         USING RSTELD,RF                                                        
         BNE   TRAN98                                                           
         USING JOBELD,R2                                                        
         CLI   JOBLN,JOBLN3Q                                                    
         BL    TRAN98              OR IF'S OLD TYPE                             
         MVC   JOBF2BLB,RSTFILT1+1  SAVE FILTER 2                               
*                                                                               
TRAN98   MVC   RSTFILT1+1(1),EPRFILT2   ADD FILTER 2 FOR EP REVERSE             
*                                                                               
TRAN100  TM    BILLMODE,UNBILL                                                  
         BZ    TRAN102                                                          
         L     R2,ADTRANS                                                       
         USING TRNELD,R2                                                        
*                                                                               
         ZAP   WORK(16),TRNAMNT   PUT IN LARGE FIELD FOR MP                     
         MP    WORK(16),=P'-1'                                                  
         ZAP   TRNAMNT,WORK(16)                                                 
*                                                                               
TRAN102  MVI   MODE,WRITRANS                                                    
*                                                                               
TRAN104  MVC   SVGSTCOD,HGSTCOD    RESTORE CODES FOR NEXT ITEM                  
         MVC   SVGSTDAT,HGSTDAT                                                 
*                                                                               
         MVC   SVPSTDAT,HPSTDAT                                                 
         MVC   SVPSTCOD,HPSTCOD                                                 
         MVC   SVPSTPRV,HPSTPRV                                                 
         B     XIT                                                              
         DROP  R2,R3,R4,RF                                                      
         EJECT                                                                  
***********************************************************************         
*              TOTALS AT ANALYSIS HEAD END(ANALLAST)                  *         
***********************************************************************         
*                                                                               
ANALLST  CLI   MODE,ANALLAST                                                    
         BNE   ACCLST                                                           
         CLI   BILLTYPE,NOTBILL                                                 
         BE    XIT                                                              
         CLC   SVANAL,=C'**'   IGNORE ORDERS                                    
         BE    XIT                                                              
         MVC   TEMPWK,JOBWKC                                                    
         GOTO1 SHR,DMCB,('SUBRFORM',(RC))                                       
         CLC   P(132),SPACES                                                    
         BNE   ANLL02                                                           
         MVC   MID1,SPACES                                                      
         MVC   MID2,SPACES                                                      
         B     XIT                                                              
*                                                                               
ANLL02   TM    BILLTYPE,ESTIM                                                   
         BO    ANLLEST                                                          
         TM    BILLTYPE,PROG                                                    
         BO    ANLLPRO                                                          
         TM    BILLTYPE,ONELNE                                                  
         BO    ANLLONE                                                          
         TM    BILLTYPE,TOTAL                                                   
         BO    ANLLTOT                                                          
         DC    H'0'                                                             
***********************************************************************         
*                                  TOTAL BILLTYPE                     *         
***********************************************************************         
*                                                                               
ANLLTOT  CLC   SVANAL,=C'99'                                                    
         BNE   ANLLT4                                                           
         TM    BILLMODE,UNBILL                                                  
         BZ    ANLLT12                                                          
*                                                                               
ANLLT2   MVC   PSECOND,P                                                        
         MVC   P,SPACES                                                         
         MVI   MYSPACE,1                                                        
         MVC   PSECOND+1(L'AC@TPRVB),AC@TPRVB                                   
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
         B     ANLLTX                                                           
*                                                                               
ANLLT4   MVC   P+1(L'AC@TWC),AC@TWC                                             
         MVC   P+1+L'AC@TWC+1(L'SVANAL),SVANAL                                  
         TM    WKCOPT,WKCDTLC                                                   
         BZ    ANLLT6                                                           
         TM    WKCOPT,WKCDTL                                                    
         BO    ANLLT8                                                           
*                                                                               
ANLLT6   MVC   P+2(22),SPACES                                                   
         MVC   P+1(L'SVANALN),MID1+1      MOVE W-CODE NAME TO SAME              
         MVC   MID1+1(L'SVANALN),SPACES    LINE AS W-CODE TOTALS                
*                                                                               
ANLLT8   CLI   PROF9,C'Y'          PRINT CD BY WORK-CODE                        
         BNE   ANLLT10                                                          
         CP    WCODECD,=P'0'                                                    
         BE    ANLLT10                                                          
         MVC   P+25(3),=C'CD='                                                  
         CURED (P6,WCODECD),(10,P+28),2,MINUS=YES,ALIGN=LEFT                    
*                                                                               
ANLLT10  ZAP   WCODECD,=P'0'                                                    
         MVI   MYSPACE,2                                                        
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
         B     ANLLTX                                                           
*                                                                               
ANLLT12  CLI   PREVOPT,C'Y'                                                     
         BNE   ANLLT2                                                           
         MVC   P,SPACES                                                         
*                                                                               
ANLLTX   MVC   JOBWKC(JOBLNQ),ZEROS                                             
         B     XIT                                                              
***********************************************************************         
*                                  ONELINE BILLTYPE                   *         
***********************************************************************         
*                                                                               
ANLLONE  CLC   SVANAL,=C'99'                                                    
         BNE   ANLLO4                                                           
         CLI   PREVOPT,C'Y'                                                     
         BNE   ANLLO2                                                           
         MVC   P,SPACES                                                         
         B     ANLLOX                                                           
*                                                                               
ANLLO2   MVC   PSECOND,P                                                        
         MVC   P,SPACES                                                         
         MVI   MYSPACE,1                                                        
         MVC   PSECOND+1(L'AC@TPRVB),AC@TPRVB                                   
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
         B     ANLLOX                                                           
*                                                                               
ANLLO4   MVC   P(132),SPACES                                                    
*                                                                               
ANLLOX   MVC   JOBWKC(JOBLNQ),ZEROS                                             
         B     XIT                                                              
***********************************************************************         
*                                  PROGRESSIVE BILLTYPE               *         
***********************************************************************         
*                                                                               
ANLLPRO  CLC   SVANAL,=C'99'                                                    
         BNE   ANLLP4                                                           
         CLI   PREVOPT,C'Y'                                                     
         BNE   ANLLP2                                                           
         MVC   P,SPACES                                                         
         B     ANLLPX                                                           
*                                                                               
ANLLP2   MVC   PSECOND,P                                                        
         MVC   P,SPACES                                                         
         MVI   MYSPACE,1                                                        
         MVC   PSECOND+1(L'AC@TPRVB),AC@TPRVB                                   
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
         B     ANLLPX                                                           
*                                                                               
ANLLP4   MVC   P+1(L'AC@TWC),AC@TWC                                             
         MVC   P+1+L'AC@TWC+1(L'SVANAL),SVANAL                                  
         TM    WKCOPT,WKCDTLC                                                   
         BZ    ANLLP6                                                           
         TM    WKCOPT,WKCDTL                                                    
         BO    ANLLP8                                                           
*                                                                               
ANLLP6   MVC   P+2(22),SPACES                                                   
         MVC   P+1(L'SVANALN),MID1+1      MOVE W-CODE NAME TO SAME              
         MVC   MID1+1(L'SVANALN),SPACES    LINE AS W-CODE TOTALS                
*                                                                               
ANLLP8   CLI   PROF9,C'Y'          PRINT CD BY WORK-CODE                        
         BNE   ANLLP10                                                          
         CP    WCODECD,=P'0'                                                    
         BE    ANLLP10                                                          
         MVC   P+25(3),=C'CD='                                                  
         CURED (P6,WCODECD),(10,P+28),2,MINUS=YES,ALIGN=LEFT                    
*                                                                               
ANLLP10  ZAP   WCODECD,=P'0'                                                    
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
*                                                                               
ANLLPX   MVC   JOBWKC(JOBLNQ),ZEROS                                             
         B     XIT                                                              
***********************************************************************         
*                                  ESTIMATE BILLTYPE                  *         
***********************************************************************         
*                                                                               
ANLLEST  CLC   SVANAL(2),=C'99'                                                 
         BNE   ANLLEX                                                           
         TM    BILLMODE,UNBILL                                                  
         BZ    ANLLE4                                                           
*                                                                               
ANLLE2   MVC   PSECOND,P                                                        
         MVC   P,SPACES                                                         
         MVI   MYSPACE,1                                                        
         MVC   PSECOND+1(L'AC@TPRVB),AC@TPRVB                                   
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
         B     ANLLEX                                                           
*                                                                               
ANLLE4   CLI   PREVOPT,C'Y'                                                     
         BNE   ANLLE2                                                           
         MVC   P,SPACES                                                         
*                                                                               
ANLLEX   MVC   JOBWKC(JOBLNQ),ZEROS                                             
         B     XIT                                                              
*                                                                               
         EJECT                                                                  
*              ROUTINES AT END OF ACCOUNT(ACCLAST)                              
*                                                                               
ACCLST   CLI   MODE,ACCLAST                                                     
         BNE   LVBLAST                                                          
         CLI   BILLTYPE,NOTBILL                                                 
         BE    ACCLA10                                                          
         CLI   RTLEDG,0                                                         
         BE    ACCL06                   NO DISTRIBUTION SCHEME                  
         MVI   RTLMODE,RTLPRNT                                                  
         GOTO1 RTL,DMCB,(RC)           RETAIL PRINT ROUTINE                     
*                                                                               
ACCL02   CLI   ESTTYPE,C'T'        CHANGE BILL TYPE TOTAL                       
         BNE   ACCLALL             NO CHANGE                                    
         L     R2,ADACC                                                         
         MVI   ELCODE,X'26'                                                     
         BAS   RE,GETEL                                                         
         BNE   ACCL04              NO JOB ELEMENT CAN'T SAVE OLD                
         USING JOBELD,R2                                                        
         CLI   JOBLN,JOBLN3Q                                                    
         BL    ACCL04               OR IF'S OLD TYPE                            
         MVI   JOBBTBLB,C'E'       PREVIOUS WAS EST.                            
*                                                                               
ACCL04   L     R2,ADACC                                                         
         MVI   ELCODE,X'24'                                                     
         BAS   RE,GETEL                                                         
         BNE   ACCLALL             NO PROFILE CAN'T CHANGE                      
         MVI   PPRBTYPE-PPRELD(R2),C'T' CHANGE TO TOTAL BILL                    
         B     ACCLALL                                                          
*                                                                               
ACCL06   TM    BILLTYPE,ESTIM                                                   
         BO    ACCLEST                                                          
         TM    BILLTYPE,PROG                                                    
         BO    ACCLPRO                                                          
         TM    BILLTYPE,ONELNE                                                  
         BO    ACCLONE                                                          
         TM    BILLTYPE,TOTAL                                                   
         BO    ACCLTOT                                                          
         DC    H'0'                                                             
***********************************************************************         
*                                  TOTAL BILLTYPE                     *         
***********************************************************************         
*                                                                               
ACCLTOT  CLC   SVANAL,=C'99'                                                    
         BE    ACCLT2                                                           
         GOTO1 PRNT,DMCB,('PRNTOTC',(RC))  TOTAL CHARGES                        
*                                                                               
ACCLT2   GOTO1 PRNT,DMCB,('PRNTDUE',(RC))   AMOUNT DUE                          
         B     ACCLALL                                                          
***********************************************************************         
*                                  ONELINE BILLTYPE                   *         
***********************************************************************         
*                                                                               
ACCLONE  B     ACCLTOT                                                          
***********************************************************************         
*                                  PROGRESSIVE BILLTYPE               *         
***********************************************************************         
*                                                                               
ACCLPRO  CLC   SVANAL,=C'99'                                                    
         BE    ACCLP2                                                           
         GOTO1 PRNT,DMCB,('PRNTOTC',(RC))    DO PRINT HERE IN CASE              
*                                                                               
ACCLP1   GOTO1 PRNT,DMCB,('PRNTDUE',(RC))   THERE IN CASE NO 99'S               
         B     ACCLALL                                                          
*                                                                               
ACCLP2   CLC   QTRNSFLT,SPACES                                                  
         BNE   ACCLP1                                                           
         CLI   PREVOPT,C'Y'                                                     
         BE    ACCLALL                                                          
         MVC   P+1(L'AC@TJOB),AC@TJOB                                           
         MVC   TEMPWK,JOBTOT                                                    
         GOTO1 SHR,DMCB,('SUBRFORM',(RC))                                       
         MVI   MYSPACE,2                                                        
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
*                                                                               
         CLC   SVANAL,=C'99'                                                    
         BNE   ACCLALL             LAST WAS NOT A PREVIOUS BILL                 
*                                                                               
         TM    RUNOPT,NEEDGST+NEEDPST   DO ANY TAXES?                           
         BZ    ACCLP4                   NO                                      
         CP    DUETOT+(JOBGST-JOBD)(L'JOBGST),=P'0'                             
         BNE   ACCLP3                                                           
*                                                                               
         TM    RUNOPT,NEEDPST      DOING PST LOGIC?                             
         BZ    ACCLP4              NO                                           
         CP    DUETOT+(JOBPST-JOBD)(L'JOBPST),=P'0'                             
         BE    ACCLP4                                                           
*                                                                               
ACCLP3   MVC   P+1(L'AC@ABTAX),AC@ABTAX                                         
         MVC   TEMPWK,DUETOT                                                    
         GOTO1 SHR,DMCB,('SUBRFORM',(RC))                                       
         CLI   DUESW,C'N'                                                       
         BNE   *+10                NOTHING DUE                                  
         MVC   P+80(L'AC@NIL),AC@NIL                                            
         MVI   MYSPACE,1                                                        
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
*                                                                               
         GOTO1 RECAP,DMCB,(RC)     PRINT TAX BY CODE                            
*                                                                               
ACCLP4   MVC   P+1(L'AC@TAMTD),AC@TAMTD   '                                     
         MVC   TEMPWK,DUETOT                                                    
         GOTO1 SHR,DMCB,('SUBRTOT',(RC))                                        
         CLI   DUESW,C'N'                                                       
         BNE   *+10                NOTHING DUE                                  
         MVC   P+80(L'AC@NIL),AC@NIL                                            
         MVI   MYSPACE,1                                                        
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
         MVI   P+1,C'-'                                                         
         MVC   P+2(82),P+1                                                      
         MVI   MYSPACE,1                                                        
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
         B     ACCLALL                                                          
***********************************************************************         
*                                  ESTIMATE BILLTYPE                  *         
***********************************************************************         
*                                                                               
ACCLEST  GOTO1 PRNT,DMCB,('PRNTDUE',(RC))                                       
         B     ACCL02                                                           
***********************************************************************         
*                                  ALL BILLTYPES                      *         
***********************************************************************         
*                                                                               
ACCLALL  CLI   RTLEDG,0                 FOR RETAIL ALREADY                      
         BNE   ACCLA2                   ALREADY PRINTED COMMENTS                
         GOTO1 PRNT,DMCB,('PRNTCOM',(RC))   PRINT JOB COMMENTS                  
*                                                                               
ACCLA2   GOTO1 POST,DMCB,('POSTINTR',(RC))                                      
*                                                                               
         TM    BILLMODE,DRAFT                                                   
         BO    ACCLA10                                                          
*                                                                               
         L     R2,ADACC                                                         
         USING SCIELD,R2                                                        
         MVI   ELCODE,SCIELQ       LOOK FOR SCIEL'S                             
         BAS   RE,GETEL                                                         
         B     ACCLA4+4                                                         
*                                                                               
ACCLA4   BAS   RE,NEXTEL                                                        
         BNE   ACCLA6                                                           
         CLI   SCITYPE,SCITT99S    LOOK FOR TYPE TO HOLD 99'S                   
         BNE   ACCLA4                                                           
         AP    SCIAMNT,SCIUNET                                                  
         B     ACCLA8                                                           
*                                                                               
ACCLA6   LA    R2,WORK             NOT THERE, BUILD ONE                         
         XC    WORK,WORK                                                        
         MVI   SCIEL,SCIELQ                                                     
         MVI   SCILN,SCILN1Q                                                    
         MVI   SCITYPE,SCITT99S                                                 
         ZAP   SCIAMNT,SCIUNET                                                  
         L     RF,ADACC                                                         
         BAS   RE,ADDELEM          ADD THE ELEMENT                              
*                                                                               
ACCLA8   L     RF,ADACCSTA                                                      
         USING RSTELD,RF                                                        
         MVC   RSTPBILL,TODAY2     WRITE IT BACK WITH TODAYS DATE               
         MVI   MODE,WRITACC                                                     
*                                                                               
ACCLA10  XC    ARETAIL,ARETAIL          TURNOFF RETAIL MODE(IF ANY)             
         MVI   RTLEDG,0                                                         
         MVI   RTLMODE,0                                                        
         MVI   BYTE,GSTTYPE5                                                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),(X'80',1)                    
         MVI   BYTE,GSTTYPE6                                                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),(X'80',1)                    
         MVI   BYTE,PSTTYPE7                                                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),(X'80',1)                    
         MVI   BYTE,PSTTYPE8                                                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),(X'80',1)                    
*                                                                               
         TM    GRPOPT,GRPBILL                                                   
         BO    XIT                  NOT A GROUP BILL                            
         MVI   BYTE,TRATYPE2       CLEAR BUFFALO                                
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),1,(X'80',2)                  
         MVI   BYTE,TRATYPE3                                                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),1,(X'80',2)                  
         MVI   BYTE,MRCTYPE4                                                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),1,(X'80',2)                  
         B     XIT                                                              
         DROP  R2,RF                                                            
         EJECT                                                                  
*              OTHER LAST TIME ROUTINES                                         
*                                                                               
LVBLAST  CLI   MODE,LEVBLAST                                                    
         BNE   LVALAST                                                          
         GOTO1 PROSUMY,DMCB,(RC)                                                
         TM    GRPOPT,GRPBILL                                                   
         BZ    XIT                  NOT A GROUP BILL                            
         GOTO1 PRNT,DMCB,('PRNTGRP',(RC))    GROUP SUMMARY                      
         MVI   BYTE,TRATYPE2       CLEAR BUFFALO                                
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),1,(X'80',2)                  
         MVI   BYTE,TRATYPE3                                                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),1,(X'80',2)                  
         MVI   BYTE,MRCTYPE4                                                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),1,(X'80',2)                  
         MVI   BYTE,GSTTYPE5                                                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),1,(X'80',2)                  
         MVI   BYTE,GSTTYPE6                                                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),1,(X'80',2)                  
         MVI   BYTE,PSTTYPE7                                                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),1,(X'80',2)                  
         MVI   BYTE,PSTTYPE8                                                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),1,(X'80',2)                  
         B     XIT                                                              
*                                                                               
LVALAST  CLI   MODE,LEVALAST                                                    
         BNE   REQLST                                                           
         GOTO1 CLISUMY,DMCB,(RC)                                                
         TM    BILLMODE,DRAFT                                                   
         BO    XIT                                                              
         TM    RUNOPT,WRITLVA                                                   
         BZ    XIT                                                              
         NI    RUNOPT,ALL-WRITLVA                                               
         MVI   MODE,WRITLEVA       WRITE BACK THE CLIENT                        
         B     XIT                                                              
*                                                                               
REQLST   CLI   MODE,REQLAST                                                     
         BNE   LEDGLST                                                          
         CLI   PRINTED,C'Y'        DID WE PRINT ANYTHING?                       
         BE    REQLX               YES                                          
         CLI   ARCHIVE,C'Y'        ARCHIVING?                                   
         BNE   REQLX               NO, SKIP THE BLANK PAGE                      
         MVI   FORCEHED,C'Y'                                                    
         MVI   RCSUBPRG,21                                                      
         MVC   P,SPACES                                                         
         MVC   PSECOND,SPACES                                                   
         MVC   PTHIRD,SPACES                                                    
         MVC   P(L'AC@REQDE),AC@REQDE                                           
         GOTO1 HEXOUT,DMCB,QCOMPANY,PSECOND,1,=C'TOG',2                         
         MVC   PSECOND+3(L'QRECORD),QRECORD                                     
         MVI   PSECOND+3+(QCOMPANY-QRECORD),C' '                                
         MVC   PTHIRD(L'QRECORD2),QRECORD2                                      
         GOTO1 ACREPORT                                                         
         MVC   P(22),=C'**NO BILLING GENERATED'                                 
         GOTO1 ACREPORT                                                         
         MVI   RCSUBPRG,0                                                       
*                                                                               
REQLX    B     XIT                                                              
*                                                                               
LEDGLST  CLI   MODE,LEDGLAST                                                    
         BNE   RUNLST                                                           
         TM    BILLMODE,DRAFT                                                   
         BO    XIT                                                              
         TM    RUNOPT,WRITLG                                                    
         BZ    XIT                                                              
         MVI   MODE,WRITLEDG                                                    
         B     XIT                                                              
*                                                                               
RUNLST   CLI   MODE,RUNLAST                                                     
         BNE   XIT                                                              
         CP    TAPECNT,=P'0'                                                    
         BE    RUNL02                                                           
         GOTO1 POST,DMCB,('POSTCLSE',(RC))                                      
*                                                                               
RUNL02   GOTO1 END,DMCB,(RC)                                                    
         GOTO1 ADSORTER,DMCB,=C'END'                                            
         TM    BILLMODE,DRAFT                                                   
         BO    XIT                                                              
         TM    RUNOPT,WRITMED                                                   
         BZ    XIT                                                              
         MVI   MODE,WRITMEDS                                                    
         B     XIT                                                              
         EJECT                                                                  
***********************************************************************         
*    PRINT ESTIMATES FROM TABLE BUILD IN BUILDEST                     *         
***********************************************************************         
*                                                                               
PRINTEST NTR1                                                                   
         L     R2,AESTPOOL                                                      
*                                                                               
PRINTE2  CLI   0(R2),0             ANYTHING IN ESTPOOL ?                        
         BE    PRINTEX             NO, SKIP THIS                                
         ST    R2,ADTRANS          SAVE ADDRESS FOR POST ROUTINES               
*                                                                               
         USING BESELD,R2                                                        
         MVC   SVANAL,BESWC        GET WORKCODE AND AMOUNT FOR POSTIT           
         ZAP   SPECAMNT,BESPEBC                                                 
         MVC   SVGSTCOD,BESVAT     GET THE GST AND PST CODES                    
         MVC   SVPSTCOD,BESPST                                                  
         MVC   SVPSTPRV,BESPRV                                                  
         GOTO1 GETRATE,DMCB,(RC)                                                
         GOTO1 GETINC,DMCB,(RC)                                                 
         BAS   RE,POSTPOOL                                                      
         BAS   RE,POSTIT                                                        
         LA    R2,BESLN2Q(R2)      GET NEXT ENTRY                               
         B     PRINTE2                                                          
*                                                                               
PRINTEX  B     XIT                                                              
         DROP  R2                                                               
         EJECT                                                                  
*              ESTABLISH RATES OF  COMMISSION FOR TRANSACTION                   
*                                                                               
         USING TRNELD,R2                                                        
ESTRATES DC    0H'0'                                                            
         L     R4,ADGOBLOC                                                      
         USING GOBLOCKD,R4                                                      
         ZAP   COMMRATE,=P'0'      ASSUME ZERO COMMISSION RATE                  
         TM    CLIOPT,COMMISN                                                   
         BZR   RE                  NON-COMMISSIONABLE                           
         CLI   MODE,PROCTRNS                                                    
         BNE   ESTRATE1                                                         
         TM    WKCOPT,WKCMT                                                     
         BOR   RE                  NO COMMISSION FOR MEDIA TRANSFERS            
*                                                                               
ESTRATE1 ZAP   COMMRATE,GOAGYCOM                                                
         BR    RE                                                               
         DROP  R2,R4                                                            
         EJECT                                                                  
*              SET WARNING MESSAGE NUMBER                                       
*                                                                               
FILTNOW  ZIC   R1,WARNRSN                                                       
         BCTR  R1,0                                                             
         LA    R1,WARNRSNS(R1)                                                  
         MVC   0(1,R1),WARNRSN                                                  
         BR    RE                                                               
         EJECT                                                                  
***********************************************************************         
*              POST A TRANSACTION TO ACCUMS AND CREATE 77 ELEMENTS    *         
***********************************************************************         
*                                                                               
         USING TRNELD,R2                                                        
POSTRANS NTR1                                                                   
         L     R2,ADTRANS                                                       
         NI    BILLOPT,ALL-CASHD                                                
         ZAP   AMOUNT,=P'0'        NET                                          
         ZAP   COMMISH,=P'0'       COMMISSION                                   
         ZAP   CASH,=P'0'          DISCOUNT                                     
         ZAP   DUB,=P'0'           WORK AREA                                    
*                                                                               
         CLI   TRNEL,TRNELQ                                                     
         BNE   POST16                                                           
*                                                                               
         ZAP   AMOUNT,TRNAMNT                                                   
         TM    TRNSTAT,X'80'                                                    
         BO    POST02                                                           
         ZAP   AMOUNT,=P'0'                                                     
         SP    AMOUNT,TRNAMNT      MAKE AMOUNT A CREDIT                         
         B     POST16                                                           
*                                                                               
POST02   SR    R3,R3                                                            
         LR    RF,R2                                                            
*                                                                               
POST04   CLI   0(RF),0                                                          
         BE    POST16                                                           
         CLI   0(RF),X'50'         ANY CASH DISCOUNT                            
         BE    POST14                                                           
         CLI   0(RF),X'40'         HOURS                                        
         BE    POST08                                                           
         CLI   0(RF),X'7C'         UNITS                                        
         BE    POST10                                                           
*                                                                               
POST06   IC    R3,1(RF)                                                         
         AR    RF,R3                                                            
         B     POST04                                                           
*                                                                               
         USING PRTELD,RF                                                        
POST08   ZAP   HOURS,PRTHOUR      SAVE STAFF HOURS                              
         ZAP   RATE,PRTRATE       AND  RATE                                     
         B     POST06                                                           
*                                                                               
         USING UNPELD,RF                                                        
POST10   TM    UNPSTAT,UNPSQTRH    UNITS OR QUARTER HOURS?                      
         BZ    POST12              UNITS                                        
         ZAP   HOURS,UNPUNIT       NOPE, HOURS                                  
         ZAP   RATE,UNPRICE                                                     
         B     POST06                                                           
*                                                                               
POST12   ZAP   UNITS,UNPUNIT       SAVE UNITS                                   
         ZAP   PRICE,UNPRICE       AND  PRICE                                   
         B     POST06                                                           
*                                                                               
         USING SCIELD,RF                                                        
POST14   CLI   SCITYPE,C'D'                                                     
         BNE   POST06                                                           
         ZAP   CASH,SCIAMNT                                                     
         DROP  RF                                                               
*                                                                               
         TM    BILLMODE,UNBILL                                                  
         BZ    *+10                                                             
         MP    CASH,=P'-1'                                                      
         AP    SAVCD,CASH                                                       
         AP    WCODECD,CASH                                                     
         OI    BILLOPT,CASHD                                                    
*                                                                               
POST16   CP    SPECAMNT,=P'0'                                                   
         BE    POST18                                                           
         ZAP   AMOUNT,SPECAMNT                                                  
*                                                                               
         USING JOBD,R4                                                          
POST18   LA    R4,JOBDTL                                                        
         MVC   JOBBK(JOBLNQ),ZEROS CLEAR    DETAIL LINE                         
*                                                                               
         TM    BILLMODE,UNBILL     ARE WE UNBILLING?                            
         JZ    POST20              NO, ADD EVERYTHING WE GET                    
         CLI   TRNTYPE,64          TYPE 64?                                     
         JNE   POST20              NO, ADD IT                                   
         TM    BILLTYPE,TOTAL+ONELNE                                            
         JZ    POST22              SKIP 64'S IF PROGRESSIVE                     
*                                                                               
         USING TRNRECD,R3                                                       
         L     R3,ADTRANS                                                       
         SH    R3,DATADISP                                                      
         CLC   TRNKREF,QSELECT     SKIP ONLY ONE BEING UNBILLED                 
         JE    POST22                                                           
         DROP  R3                                                               
*                                                                               
POST20   CLC   TRNTYPE,EPTYPE      IS THIS A TYPE 47?                           
         BNE   POST21              NO                                           
         TM    BILLOPT,WRITE       YES BUT ARE WE UPDATING THIS ONE?            
         BZ    POST21              NO, THEN DON'T ADD AMOUNT                    
         AP    SAVEPN,AMOUNT                                                    
*                                                                               
POST21   AP    TOTPB,AMOUNT                                                     
*                                                                               
POST22   AP    JOBNET,AMOUNT       NET  TO   NET                                
         AP    JOBGRS,AMOUNT                 GROSS                              
*                                                                               
         AP    JOBVBAS,AMOUNT                GST  BASIS                         
         AP    JOBVNET,AMOUNT                GST  NET                           
         AP    JOBVGRS,AMOUNT                GST  GROSS                         
*                                                                               
         AP    JOBPBAS,AMOUNT                PST  BASIS                         
         AP    JOBPNET,AMOUNT                PST  NET                           
         AP    JOBPGRS,AMOUNT                PST  GROSS                         
*                                                                               
         AP    JOBCD,CASH          CD   TO   CD                                 
         AP    JOBNET,CASH                   NET                                
         AP    JOBGRS,CASH                   GROSS                              
*                                                                               
         ZAP   COMMISH,=P'0'       INITIALIZE                                   
         ZAP   DUB1,=P'0'               RESULTS   FIELDS                        
*                                                                               
         USING WCOELD,RF           MAP  WORK CODE ELEMENT                       
         GOTO1 GETWORK,DMCB,(RC)   GET  WORK CODE ELEMENT                       
         L     RF,AWCEL            ->   WORK CODE ELEMENT                       
         LTR   RF,RF               ANY  WORK CODE ELEMENT ?                     
         BZ    POST24              NO,  SKIP                                    
         TM    WCOSTAT,WCOSNONC    WORK CODE NON-COMMISSIONABLE ?               
         BO    POST30              YES, DONE                                    
         DROP  RF                                                               
*                                                                               
POST24   DS    0H                  WORK CODE IS   COMMISSIONABLE                
         TM    CLIOPT,COMMISN      CLIENT    SAYS COMMISSIONABLE ?              
         BZ    POST30              NO,  DONE                                    
*                                                                               
         CLI   TRNEL,TRNELQ        TRANSACTION    ELEMENT ?                     
         BNE   POST26              NO,  SKIP                                    
         TM    TRNSTAT,TRNSNOCM    NON-COMMISSIONABLE  ITEM ?                   
         BO    POST30              YES, DONE                                    
*                                                                               
POST26   DS    0H                  COMMISSIONABLE ITEM                          
         ZAP   DUB1,COMMRATE       COMMISSION     RATE                          
         ZAP   DUB,AMOUNT          NET  AMOUNT                                  
         AP    DUB,CASH            PLUS CASH DISCOUNT                           
*                                                                               
         TM    RTLOPT,RTLSCOMM     ANY  SPECIAL   COMMISSION     RATES?         
         BO    POST28              YES, SPECIAL   PROCESSING                    
         ZAP   PL13,COMMRATE       WC   COMMISSION     RATE                     
         MP    PL13,DUB            TIMES    (AMOUNT    PLUS CASH DISC)          
         SRP   PL13,64-6,5         ROUND     TO   TWO  DECIMAL   PLACES         
         ZAP   COMMISH,PL13        RETURN    RESULT                             
         B     POST30              DONE WITH THIS CALCULATION                   
*                                                                               
POST28   DS    0H                  SPECIAL   RATE PRESENT                       
*                                  CALCULATE RETAIL    COMMISSION               
         GOTO1 SHR,DMCB,('SUBRCCOM',(RC)),DUB,COMMRATE,COMMISH                  
*                                                                               
POST30   DS    0H                  CONTINUE                                     
         CLI   TRNEL,TRNELQ        TRANSACTION    ELEMENT ?                     
         BNE   POST80              NO,  SKIP                                    
*                                                                               
         TM    BILLOPT,WRITE       ARE WE UPDATING THIS TRANSACTION?            
         BZ    POST80              NO                                           
*                                                                               
         TM    BILLMODE,UNBILL     YES, UNBILLING?                              
         BO    POST60              YES                                          
*                                                                               
         TM    BILLMODE,RERUN      RERUN?                                       
         BO    POST50              YES                                          
         EJECT                                                                  
***********************************************************************         
*                                  POST BILLING                       *         
***********************************************************************         
*                                                                               
         USING ACMD,R2                                                          
POST40   L     R2,AMONACC                                                       
         L     R2,ACMAPRO2                                                      
         CLI   0(R2),PTAELQ                                                     
         B     POST42+8                                                         
*                                                                               
         USING PTAELD,R2                                                        
POST42   MVI   ELCODE,PTAELQ                                                    
         BAS   RE,NEXTEL                                                        
         BE    POST44              WE HAVE ONE                                  
         XC    CHOPWRK,CHOPWRK                                                  
         MVI   CHOPWRK,PTAELQ         CREATE DUMMY 77                           
         MVI   CHOPWRK+(PTALN-PTAELD),PTARLN1Q                                  
*                                                                               
         LA    R1,PTARLN1Q                                                      
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R2),CHOPWRK                                                  
*                                                                               
         LA    R2,1(R2,R1)         GET TO END OF ELEMENT                        
         MVI   0(R2),0             MARK END                                     
         B     POST40              AND TRY AGAIN                                
*                                                                               
POST44   CLI   PTATYPE,0           IS THIS A SPARE?                             
         BNE   POST42              NO, LOOK AGAIN                               
*                                                                               
         MVI   PTATYPE,PTATRAL     SET TYPE                                     
         MVC   PTAMOA,DATE3        MOA                                          
         MVC   PTARBLDT,RCDAY2     BILL DATE                                    
         MVC   PTARDATE,TODAY2     RUN DATE                                     
         MVC   PTADATE,TODAY2      ACTIVITY DATE                                
*                                                                               
         ZAP   PTANET,AMOUNT       AMOUNT                                       
         ZAP   PTANETF,=P'0'                                                    
         MVC   PTACUR,CURCOD       CURRENCY CODE                                
*                                                                               
         ZAP   PTACDSC,CASH        DISCOUNT                                     
*                                                                               
         ZAP   PTARCORT,DUB1       COMMISSION RATE                              
*                                                                               
         ZAP   PTARCOM,COMMISH     COMMISSION                                   
*                                                                               
         ZAP   DUB1,HOURS          HOURS                                        
         CVB   RF,DUB1                                                          
         STH   RF,PTAHOURS                                                      
*                                                                               
         MVC   PTARBLNO,BILLREF                                                 
         MVC   PTARCODE,BILLCODE   SAVE THE TYPE OF BILLING                     
*                                                                               
         TM    RUNOPT,NEEDGST      ARE WE DOING GST LOGIC?                      
         BZ    POST45              NO                                           
         MVC   PTARGSTC,SVGSTCOD   YES, SAVE CODE                               
*                                                                               
POST45   TM    RUNOPT,NEEDPST      ARE WE DOING PST LOGIC ALSO?                 
         BZ    POST80              NO                                           
*                                                                               
         MVC   PTARPSTC,SVPSTCOD   YES, SAVE PST AND PROVINCE CODES             
         MVC   PTARPRVC,SVPSTPRV                                                
         B     POST80                                                           
         EJECT                                                                  
***********************************************************************         
*                                  POST BILLING RERUN                 *         
***********************************************************************         
*                                                                               
         USING ACMD,R2                                                          
POST50   L     R2,AMONACC                                                       
         L     R2,ACMAPRO2                                                      
         CLI   0(R2),PTAELQ                                                     
         B     POST52+8                                                         
*                                                                               
         USING PTAELD,R2                                                        
POST52   MVI   ELCODE,PTAELQ                                                    
         BAS   RE,NEXTEL                                                        
         BE    *+6                 MUST HAVE IT                                 
         DC    H'0'                                                             
*                                                                               
         CLI   PTATYPE,PTATRAL     IS THIS ALLOCATED?                           
         BNE   POST52              NO, GET NEXT                                 
         TM    PTASTAT1,PTASPEND   YES, IS IT PENDING?                          
         BO    POST52              YES, NOT BILLED YET                          
         CLC   PTARDATE,TODAY2     DOES DATE MATCH?                             
         BNE   POST52              NO                                           
         B     POST80              YES, CONTINUE                                
         EJECT                                                                  
***********************************************************************         
*                                  POST UNBILLING                     *         
***********************************************************************         
*                                                                               
         USING ACMD,R2                                                          
POST60   TM    BILLMODE,RERUN      RERUN UNBILLING?                             
         BO    POST70              YES                                          
*                                                                               
         L     R2,AMONACC          LOOK FOR ITEM TO UNBILL                      
         L     R2,ACMAPRO2                                                      
         CLI   0(R2),PTAELQ                                                     
         B     POST62+8                                                         
*                                                                               
         USING PTAELD,R2                                                        
POST62   MVI   ELCODE,PTAELQ                                                    
         BAS   RE,NEXTEL                                                        
         BE    *+6                 MUST HAVE THE ONE WE ARE UNBILLING           
         DC    H'0'                                                             
*                                                                               
         CLI   PTATYPE,PTATRAL     IS THIS ALLOCATED?                           
         BNE   POST62              NO, GET NEXT                                 
         TM    PTASTAT1,PTASPEND   YES, IS IT STILL PENDING?                    
         BO    POST62              YES, GET NEXT                                
*                                                                               
*                                  CHECK TO SEE IF ALREADY UNBILLED             
         TM    PTASTAT1,PTASREVS+PTASREVU                                       
         BNZ   POST62              YES, GET NEXT                                
*                                                                               
         CLC   PTARBLNO,QSELECT    IS BILL NUMBER CORRECT?                      
         BNE   POST62              NO                                           
         CLC   PTARBLDT,USEBILL    IS BILL DATE CORRECT?                        
         BNE   POST62              NO                                           
***********************************************************************         
* THIS CODE IS TEMPORARY - IT CAN BE DELETED AFTER JUNE 26,1997.      *         
* TRANSACTIONS BILLED PRIOR TO JUNE 26, 1995 DO NOT HAVE A RUN DATE.  *         
* THEREFORE, PTARDATE CONTAINS THE BILLDATE AND WILL NOT MATCH THE    *         
* RUN DATE IF A BILL DATE WAS SPECIFIED.                              *         
*                                                                               
*        CLC   USEDATE,=XL2'BEDA'                                               
*        BL    *+14                                                             
***********************************************************************         
         CLC   PTARDATE,USEDATE    YES, DOES DATE MATCH?                        
         BNE   POST62              NO                                           
*                                                                               
         AP    AMOUNT,PTANET       YES, GET AMOUNT                              
         AP    CASH,PTACDSC        CASH DISCOUNT                                
         ZAP   COMMISH,PTARCOM     COMMISSION                                   
*                                                                               
         LH    RF,PTAHOURS         HOURS                                        
         CVD   RF,DUB                                                           
         MP    DUB,=P'-1'                                                       
         AP    HOURS,DUB                                                        
*                                                                               
         MP    AMOUNT,=P'-1'       REVERSE SIGNS                                
         MP    CASH,=P'-1'                                                      
         MP    COMMISH,=P'-1'                                                   
*                                                                               
         OI    PTASTAT1,PTASREVU   INDICATE REVERSED                            
         MVC   PTARUNBD,TODAY2     SAVE DATE UNBILLED                           
         MVC   PTARUNBB,BILLREF    SAVE UNBILLED BILL NUMBER                    
*                                                                               
         XC    CHOPWRK,CHOPWRK     CLEAR AREA FOR NEW ELEMENT                   
         SR    R1,R1                                                            
         IC    R1,PTALN                                                         
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   CHOPWRK(0),PTAEL                                                 
*                                                                               
         BAS   RE,NEXTEL           LOOK FOR END OF ELEMENTS                     
         BE    *-4                                                              
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R2),CHOPWRK     MOVE IT IN OFF R2                            
*                                                                               
         MVI   PTASTAT1,PTASREVS   UPDATE ELEMENT IN PLACE                      
*                                                                               
         MVC   PTARORGB,PTARBLNO   SAVE ORIGINAL BILL NUMBER                    
         MVC   PTARORGD,PTARBLDT   SAVE ORIGINAL BILL DATE                      
*                                                                               
         MVC   PTARDATE,TODAY2     UPDATE DATES                                 
         MVC   PTADATE,TODAY2                                                   
         MVC   PTARBLDT,RCDAY2                                                  
         MVC   PTAMOA,DATE3                                                     
*                                                                               
         MVC   PTARBLNO,BILLREF    SAVE NEW BILL NUMBER                         
         MVC   PTARCODE,BILLCODE   SAVE THE BILLING TYPE                        
*                                                                               
         ZAP   WORK(16),PTANET     PUT IN LARGE FIELD FOR MP                    
         MP    WORK(16),=P'-1'                                                  
         ZAP   PTANET,WORK(16)                                                  
*                                                                               
         MP    PTANETF,=P'-1'                                                   
         MP    PTACDSC,=P'-1'                                                   
         MP    PTARCOM,=P'-1'                                                   
         LH    RF,PTAHOURS                                                      
         LCR   RF,RF                                                            
         STH   RF,PTAHOURS                                                      
         LA    R2,1(R2,R1)         GET TO END OF ELEMENT                        
*                                                                               
         MVI   0(R2),0             NO, MARK END OF RECORD                       
         B     POST80                                                           
         EJECT                                                                  
***********************************************************************         
*                                  POST UNBILLING RERUN               *         
***********************************************************************         
*                                                                               
         USING ACMD,R2                                                          
POST70   L     R2,AMONACC          LOOK FOR ITEM TO UNBILL                      
         L     R2,ACMAPRO2                                                      
         CLI   0(R2),PTAELQ                                                     
         B     POST72+8                                                         
*                                                                               
         USING PTAELD,R2                                                        
POST72   MVI   ELCODE,PTAELQ                                                    
         BAS   RE,NEXTEL                                                        
         BE    *+6                 MUST HAVE                                    
         DC    H'0'                                                             
*                                                                               
         CLI   PTATYPE,PTATRAL     BILLING?                                     
         BNE   POST72              NO                                           
         TM    PTASTAT1,PTASREVS   YES, IS THIS A REVERSE ELEMENT?              
         BZ    POST74              NO                                           
*                                                                               
         CLC   PTARORGD,USEBILL    DOES THE ORIGINAL DATE MATCH?                
         BNE   POST72              NO                                           
         CLC   PTARORGB,QSELECT    YES, DOES THE ORIGINAL BILL# MATCH?          
         BNE   POST72              NO                                           
         CLC   PTARDATE,TODAY2     YES, DOES UNBILL DATE MATCH?                 
         BNE   POST72              NO                                           
         B     POST80              YES, CONTINUE                                
*                                                                               
POST74   TM    PTASTAT1,PTASREVU   A REVERSAL?                                  
         BO    POST72              YES, SKIP IT                                 
         CLC   PTARDATE,USEDATE    NO, BILLED BEFORE THIS ONE?                  
         BNH   POST80              YES                                          
         B     POST72              NO, SKIP IT                                  
         EJECT                                                                  
***********************************************************************         
*                                  COMMON CODE FOR BILL/UNBILL        *         
***********************************************************************         
*                                                                               
         USING TRNELD,R2                                                        
POST80   L     R2,ADTRANS                                                       
         CLI   TRNEL,TRNELQ                                                     
         BNE   POST84                                                           
         TM    WKCOPT,WKCMT        MEDIA TRANSFER ?                             
         BZ    POST84              NO                                           
*                                                                               
         MVI   ELCODE,VBIELQ       GET GST ELEMENT                              
         BAS   RE,NEXTEL                                                        
         BNE   POST82                                                           
         USING VBIEL,R2                                                         
         MVC   SVGSTCOD,VBITYPE    GET GST CODE                                 
         MVC   SVGSTRAT,VBIRATE        RATE                                     
         MVC   SVGSTACC,VBIACCT        ACCOUNT                                  
         MVC   SVGSTDAT,VBIDATE        DATE                                     
*                                                                               
         ZAP   JOBVGRS,VBIGROSS        GROSS                                    
         ZAP   JOBCOMM,VBICOMM         COMMISSION                               
         ZAP   JOBGST,VBIVAT           GST                                      
         ZAP   SAVGST,VBIVAT                                                    
*                                                                               
         ZAP   JOBVNET,VBIGROSS        NET (GROSS LESS COMMISSION)              
         SP    JOBVNET,VBICOMM                                                  
*                                                                               
         ZAP   JOBVBAS,VBIGROSS        BASIS (GROSS LESS GST)                   
         SP    JOBVBAS,VBIVAT                                                   
*                                                                               
         USING PBIEL,R2                                                         
POST82   L     R2,ADTRANS                                                       
         MVI   ELCODE,PBIELQ       GET PST ELEMENT                              
         BAS   RE,NEXTEL                                                        
         BNE   POST87                                                           
*                                                                               
         MVC   SVPSTCOD,PBITYPE    GET PST CODE                                 
         MVC   SVPSTRAT,PBIRATE        RATE                                     
         MVC   SVPSTACC,PBIACCT        ACCOUNT                                  
         MVC   SVPSTDAT,PBIDATE        DATE                                     
         MVC   SVPSTPRV,PBIPRV         PROVINCE                                 
*                                                                               
         ZAP   JOBPGRS,PBIGROSS        GROSS                                    
         ZAP   JOBPST,PBIPST           PST                                      
*                                                                               
         ZAP   JOBPNET,PBIGROSS        NET (GROSS LESS COMMISSION)              
         SP    JOBPNET,PBICOMM                                                  
*                                                                               
         ZAP   JOBPBAS,PBIGROSS        BASIS (GROSS LESS PST)                   
         SP    JOBPBAS,PBIPST                                                   
*                                                                               
         CLC   PBIPRV,=C'PQ'                                                    
         BNE   POST87                                                           
*                                                                               
         LA    RE,SVPSTDAT                                                      
*        LA    RE,DATE3                                                         
         TM    BILLMODE,UNBILL     ARE WE UNBILLING ?                           
         BZ    *+8                 NO, USE BILL DATE                            
         LA    RE,CALLDATE         YES, USE UNBILL DATE                         
         CLC   0(3,RE),=X'B30101'  SEE IF 2013                                  
         BL    POST87              NO                                           
         SP    JOBPBAS,SAVGST      YES, EXCLUDE GST FROM BASIS                  
         B     POST87                                                           
*                                                                               
POST84   AP    JOBGRS,COMMISH      COMMISSION TO GROSS                          
         AP    JOBVGRS,COMMISH                   GROSS                          
         AP    JOBCOMM,COMMISH                   COMMISSION                     
*                                                                               
         USING TRNELD,R2                                                        
         L     R2,ADTRANS                                                       
         CLC   TRNTYPE,EPTYPE      IS THIS TYPE 47?                             
         BNE   POST85              NO                                           
         TM    BILLOPT,WRITE       YES BUT ARE WE UPDATING THIS ONE?            
         BZ    POST85              NO, THEN DON'T ADD AMOUNT                    
         AP    SAVEPC,COMMISH                                                   
         DROP  R2                                                               
*                                                                               
POST85   TM    CLIOPT,PAYNET       GST BASIS IS DEPENEDENT ON PAY=NET           
         BO    *+10                                                             
         AP    JOBVBAS,COMMISH                                                  
*                                                                               
         SR    RE,RE                                                            
         ICM   RE,3,SVGSTRAT                                                    
         CVD   RE,DUB                                                           
*                                                                               
         ZAP   PK16,JOBVBAS        CALCULATE GST AMOUNT                         
         MP    PK16,DUB                                                         
         TM    SVGSTIND,VBIIDC3    DOES RATE HAVE 3 DECIMALS?                   
         BZ    *+14                NO                                           
         SRP   PK16,64-5,5         YES, SHIFT ONE MORE DIGIT                    
         B     *+10                                                             
         SRP   PK16,64-4,5                                                      
         ZAP   JOBGST,PK16         SAVE IT                                      
*                                                                               
         AP    JOBVNET,JOBGST                                                   
         AP    JOBVGRS,JOBGST                                                   
*                                                                               
         ZAP   JOBPBAS,JOBVBAS                                                  
         AP    JOBPBAS,JOBGST                                                   
*                                                                               
         CLC   SVPSTPRV,=C'PQ'     IS THIS PROVINCE PQ?                         
         BNE   POST86              NO                                           
*                                                                               
         LA    RE,SVPSTDAT                                                      
*        LA    RE,DATE3                                                         
         TM    BILLMODE,UNBILL     ARE WE UNBILLING ?                           
         BZ    *+8                 NO, USE BILL DATE                            
         LA    RE,CALLDATE         YES, USE UNBILL DATE                         
         CLC   0(3,RE),=X'B30101'  SEE IF 2013                                  
         BL    POST86              YES, INCLUDE THE GST IN THE BASIS            
         SP    JOBPBAS,JOBGST      NO, PST BASIS IS LESS GST THEN               
*                                                                               
POST86   SR    RE,RE                                                            
         ICM   RE,3,SVPSTRAT                                                    
         CVD   RE,DUB                                                           
*                                                                               
         ZAP   PK16,JOBPBAS        CALCULATE PST AMOUNT                         
         MP    PK16,DUB                                                         
         TM    SVPSTIND,PBIIDC3    DOES RATE HAVE 3 DECIMALS?                   
         BZ    *+14                NO                                           
         SRP   PK16,64-5,5         YES, SHIFT ONE MORE DIGIT                    
         B     *+10                                                             
         SRP   PK16,64-4,5                                                      
         ZAP   JOBPST,PK16          SAVE IT                                     
*                                                                               
         ZAP   JOBPNET,JOBVNET                                                  
         AP    JOBPNET,JOBPST                                                   
*                                                                               
         ZAP   JOBPGRS,JOBVGRS                                                  
         AP    JOBPGRS,JOBPST                                                   
*                                                                               
         GOTO1 SHR,DMCB,('SUBRSUML',(RC))  ADD DETAIL LINE TOTALS               
         MVC   TOTCHG,JOBCHG      SAVE TOTAL CHARGES FOR RETAIL                 
*                                                                               
         USING TRNRECD,R3                                                       
POST87   TM    BILLTYPE,TOTAL      B7'S ONLY VALID FOR TOTAL                    
         BZ    POSTTX                                                           
         L     R3,ADTRANS                                                       
         SH    R3,DATADISP                                                      
         CLC   TRNKCUNT(2),=C'SK' WITH SK/SI CONTRA                             
         BE    POST88                                                           
         CLC   TRNKCUNT(2),=C'SI'                                               
         BNE   POSTTX                                                           
*                                                                               
         USING TRNELD,R2                                                        
POST88   CLI   SVANINC,C'Y'        IS THIS AN INCOME WORKCODE ?                 
         BNE   POSTTX              NO, ALL DONE                                 
         L     R2,ADTRANS                                                       
         ZAP   DUB,TRNAMNT         YES, GET AMOUNT                              
         TM    BILLMODE,UNBILL     ARE WE UNBILLING ?                           
         BO    *+8                 YES, SKIP                                    
         BRAS  RE,NEWB7            NO, UPDATE CURRENT B7 TABLE                  
*                                                                               
POSTTX   B     XIT                                                              
         DROP  R2,R3,R4                                                         
         EJECT ,                                                                
POSTPOOL NTR1                                                                   
         USING BESELD,R2                                                        
         NI    BILLOPT,ALL-CASHD                                                
         USING JOBD,R4                                                          
         LA    R4,JOBDTL                                                        
         MVC   JOBBK(JOBLNQ),ZEROS                                              
         ZAP   JOBNET,BESPEBC      CURRENT X PERCENT OF ESTIMATE                
         ZAP   JOBGRS,BESPEBCG     BESPEBC + COMMISSION                         
         ZAP   JOBCOMM,BESPEBCG    COMMISSION AMOUNT = BESPEBCG-BESPEBC         
         SP    JOBCOMM,BESPEBC                                                  
*                                                                               
         TM    RTLOPT,RTLSCOMM     ANY    SPECIAL COMMISSION RATES ?            
         BZ    POSTP6              NO,    SKIP                                  
         CP    JOBNET,=P'0'        NET    AMOUNT ZERO ?                         
         BE    POSTP6              YES,   SKIP                                  
         CP    JOBCOMM,=P'0'       A      COMMISSIONABLE ITEM ?                 
         BNE   POSTP2              YES,   FIND COMMISSION AMOUNTS               
         TM    CLIOPT,COMMISN      CHARGE COMMISSION FOR ESTIMATES ?            
         BZ    POSTP6              NO,    SKIP                                  
*                                                                               
*                                  VERIFY NON-COMMISSIONABLE WORK CODE          
         USING WCOELD,RF           MAP    WORK CODE ELEMENT                     
         GOTO1 GETWORK,DMCB,(RC)   GET    WORK CODE ELEMENT                     
         L     RF,AWCEL            ->     WORK CODE ELEMENT                     
         LTR   RF,RF               ANY    WORK CODE ELEMENT                     
         BZ    POSTP6              NO,    SKIP                                  
         TM    WCOSTAT,WCOSNONC    WORK   CODE NON-COMMISSIONABLE ?             
         BO    POSTP6              YES,   SKIP IT                               
         ZAP   DUB,=P'0'           COMMISSION  RATE IS ZERO                     
         B     POSTP4              CALCULATE RETAIL COMMISSION                  
*                                                                               
         DROP  RF                                                               
*                                                                               
POSTP2   DS    0H                                                               
         ZAP   JOBCOMM,=P'0'       CLEAR  COMMISSION AMOUNT                     
*                                  ESTIMATE THE COMMISSION RATE                 
*                                    SINCE GROSS = NET +(RATE * NET)            
*                                    RATE = (GROSS / NET) - 1                   
*                                  NOTE:  COMMISSION RATE IS NN.MMMM %          
         ZAP   PK16,JOBGRS         GET    GROSS                                 
         SRP   PK16,7,0            TIMES  10,000,000                            
         DP    PK16,JOBNET         DIVIDE GROSS*10,000,000 BY NET               
         SRP   PK16(8),64-1,5      ROUND  THE AMOUNT                            
         SP    PK16(8),=P'1000000' MINUS                                        
         ZAP   DUB,PK16(8)         SAVE   THE RATE IN DUB + 4                   
*                                                                               
POSTP4   DS    0H                                                               
*                                  CALCULATE RETAIL COMMISSION                  
         GOTO1 SHR,DMCB,('SUBRCCOM',(RC)),JOBNET,DUB+4,JOBCOMM+2                
         ZAP   JOBGRS,JOBNET       RE-CALCULATE GROSS =                         
         AP    JOBGRS,JOBCOMM             NET + COMMISSION                      
*                                                                               
POSTP6   DS    0H                                                               
*                                                                               
         SR    RE,RE                                                            
         ICM   RE,3,SVGSTRAT                                                    
         CVD   RE,DUB                                                           
*                                                                               
         ZAP   JOBVBAS,JOBNET      GST BASIS IS DEPENDENT ON PAY=NET            
         TM    CLIOPT,PAYNET                                                    
         BO    *+10                                                             
         ZAP   JOBVBAS,JOBGRS                                                   
*                                                                               
         ZAP   PK16,JOBVBAS        CALCULATE GST AMOUNT                         
         MP    PK16,DUB                                                         
         TM    SVGSTIND,VBIIDC3    DOES RATE HAVE 3 DECIMALS?                   
         BZ    *+14                NO                                           
         SRP   PK16,64-5,5         YES, SHIFT ONE MORE DIGIT                    
         B     *+10                                                             
         SRP   PK16,64-4,5                                                      
         ZAP   JOBGST,PK16          SAVE IT                                     
*                                                                               
         ZAP   JOBPBAS,JOBVBAS                                                  
         AP    JOBPBAS,JOBGST                                                   
*                                                                               
         CLC   SVPSTPRV,=C'PQ'     IS THIS PROVINCE PQ?                         
         BNE   POSTP8              NO                                           
*                                                                               
         LA    RE,SVPSTDAT                                                      
*        LA    RE,DATE3                                                         
         TM    BILLMODE,UNBILL     ARE WE UNBILLING ?                           
         BZ    *+8                 NO, USE BILL DATE                            
         LA    RE,CALLDATE         YES, USE UNBILL DATE                         
         CLC   0(3,RE),=X'B30101'  SEE IF 2013                                  
         BL    POSTP8              YES, INCLUDE THE GST IN THE BASIS            
         SP    JOBPBAS,JOBGST      NO, PST BASIS IS LESS GST THEN               
*                                                                               
POSTP8   SR    RE,RE                                                            
         ICM   RE,3,SVPSTRAT                                                    
         CVD   RE,DUB                                                           
*                                                                               
         ZAP   PK16,JOBPBAS        CALCULATE PST AMOUNT                         
         MP    PK16,DUB                                                         
         TM    SVPSTIND,PBIIDC3    DOES RATE HAVE 3 DECIMALS?                   
         BZ    *+14                NO                                           
         SRP   PK16,64-5,5         YES, SHIFT ONE MORE DIGIT                    
         B     *+10                                                             
         SRP   PK16,64-4,5                                                      
         ZAP   JOBPST,PK16          SAVE IT                                     
*                                                                               
         ZAP   JOBVNET,JOBNET      GET GST NET AND GROSS                        
         AP    JOBVNET,JOBGST                                                   
*                                                                               
         ZAP   JOBVGRS,JOBGRS                                                   
         AP    JOBVGRS,JOBGST                                                   
*                                                                               
         ZAP   JOBPNET,JOBVNET     AND PST NET AND GROSS                        
         AP    JOBPNET,JOBPST                                                   
*                                                                               
         ZAP   JOBPGRS,JOBVGRS                                                  
         AP    JOBPGRS,JOBPST                                                   
*                                                                               
         TM    BILLMODE,UNBILL     IS THIS UNBILLING ?                          
         BNO   POSTPEX             NO                                           
*                                                                               
         MP    JOBNET,=P'-1'       YES, NEGATE AMOUNTS                          
         MP    JOBGRS,=P'-1'                                                    
         MP    JOBCOMM,=P'-1'                                                   
         MP    JOBGST,=P'-1'                                                    
         MP    JOBVNET,=P'-1'                                                   
         MP    JOBVGRS,=P'-1'                                                   
         MP    JOBVBAS,=P'-1'                                                   
         MP    JOBPST,=P'-1'                                                    
         MP    JOBPNET,=P'-1'                                                   
         MP    JOBPGRS,=P'-1'                                                   
         MP    JOBPBAS,=P'-1'                                                   
*                                                                               
POSTPEX  GOTO1 SHR,DMCB,('SUBRSUML',(RC))                                       
         MVC   TOTCHG,JOBCHG       SAVE TOTAL CHARGES FOR RETAIL                
         B     XIT                                                              
         DROP  R2,R4                                                            
         EJECT                                                                  
POSTIT   NTR1                                                                   
         MVI   SVANINC,C'N'        INDICATE NOT AN INCOME WORKCODE              
         GOTO1 GETWORK,DMCB,(RC)                                                
         USING WCOELD,R2                                                        
         L     R2,AWCEL                                                         
         LTR   R2,R2                                                            
         BZ    POSTI06                                                          
         MVC   SVANALN,SPACES                                                   
         MVC   SVANALN(15),WCODESC                                              
*                                                                               
         TM    CLIOPT2,USELONG     USE WORKCODE LONGNAME?                       
         BZ    POSTI04             NO                                           
*                                                                               
         USING ACMD,R3                                                          
         L     R3,AMONACC                                                       
         USING WCNTABD,R4                                                       
         L     R4,ACMWCNMA                                                      
         LH    R0,ACMWCNMN                                                      
         LTR   R0,R0                                                            
         BZ    POSTI04                                                          
*                                                                               
POSTI02  CLC   SVANAL,WCNCODE                                                   
         BNE   *+14                                                             
         MVC   SVANALN,WCNNAME                                                  
         B     *+12                                                             
         LA    R4,WCNTABL(R4)                                                   
         BCT   R0,POSTI02                                                       
         DROP  R3,R4                                                            
*                                                                               
POSTI04  LA    RE,P+1                                                           
         MVC   0(L'SVANAL,RE),SVANAL                                            
         TM    ESTOPT,ESTCODE+ESTBOTH                                           
         BZ    *+8                                                              
         LA    RE,1+L'SVANAL(RE)                                                
         TM    ESTOPT,ESTCODE                                                   
         BNZ   *+10                                                             
         MVC   0(L'SVANALN,RE),SVANALN                                          
*                                                                               
         TM    WCOSTAT2,WCOSINC    IS THIS AN INCOME WORKCODE ?                 
         BZ    POSTI06             NO                                           
         MVI   SVANINC,C'Y'        YES                                          
         ZAP   DUB,SPECAMNT                                                     
         TM    BILLMODE,UNBILL     ARE WE UNBILLING ?                           
         BO    *+8                 YES, SKIP                                    
         BRAS  RE,NEWB7            NO, UPDATE CURRENT B7 TABLE                  
*                                                                               
POSTI06  BAS   RE,POSTBUFF                                                      
         GOTO1 POSTGST,DMCB,(RC)                                                
         GOTO1 POSTPST,DMCB,(RC)                                                
         MVC   TEMPWK,JOBDTL       FORMAT DETAIL LINE                           
         GOTO1 SHR,DMCB,('SUBRFORM',(RC))                                       
         MVC   JOBDTL(JOBLNQ),ZEROS                                             
         TM    WKCOPT,WKCDTLC                                                   
         BZ    XIT                 NO WORK-CODE DETAILS                         
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
         B     XIT                                                              
         DROP  R2                                                               
         EJECT                                                                  
***********************************************************************         
*              POST CHARGES TO BUFFALO TABLE                          *         
***********************************************************************         
*                                                                               
         USING TRNELD,R2                                                        
         USING TRAD,R5                                                          
POSTBUFF NTR1                                                                   
         L     R2,ADTRANS                                                       
         LA    R5,BUFWK                                                         
         XC    BUFWK(TRALNQ),BUFWK                                              
*                                                                               
         USING JOBD,RF                                                          
         LA    RF,JOBDTL                                                        
         ZAP   JOBFUDGE,=P'1'                                                   
         DROP  RF                                                               
*                                                                               
         MVC   TRAACCUM(JOBLNQ),JOBDTL    ACCUMS                                
         MVI   TRATYPE,TRATYPE2                                                 
*                                                                               
POSTB02  MVI   TRAMED,X'FF'               TOTAL ALL JOBS                        
         GOTO1 BUFFALO,DMCB,=C'PUT',ABUFF,(R5)                                  
         MVC   TRAMED,JOBLET                                                    
         MVI   TRAPRD,X'FF'                MEDIA TOTAL                          
         BASR  RE,RF                                                            
         MVC   TRAPRD,PRDCODE+6                                                 
         MVC   TRAJOB,JOBCODE+9                                                 
         MVI   TRAWKC,X'FF'                 JOB TOTAL                           
         CLI   TRATYPE,TRATYPE3    IS THIS A MEDIA CHARGE ?                     
         BNE   POSTB04             NO                                           
         MVI   TRABIL,X'FF'        YES, TOTAL BILLED/BILLABLE                   
         BASR  RE,RF                                                            
*                                                                               
         MVI   TRABIL,C'N'         SET UP AS NOT BILLABLE                       
         TM    BILLOPT,WRITE       IS THIS A BILLABLE ITEM ?                    
         BZ    *+8                 NO                                           
         MVI   TRABIL,C'Y'         YES, CHANGE IT TO BILLABLE                   
*                                                                               
POSTB04  BASR  RE,RF                                                            
         XC    TRABIL,TRABIL                                                    
*                                                                               
         MVC   TRAWKC,SVANAL       GET WORKCODE AND NAME                        
         MVC   TRANAME,SPACES                                                   
         MVC   TRANAME(L'SVANALN),SVANALN                                       
         CP    SPECAMNT,=P'0'      IS THERE A SPECIAL AMOUNT ?                  
         BNE   POSTB06             YES                                          
         BASR  RE,RF               NO                                           
*                                                                               
         CLI   TRATYPE,TRATYPE3    IS THIS A MEDIA CHARGE                       
         BNE   POSTB12             NO, DON'T NEED DETAIL                        
         MVI   TRAREF,X'FF'        WORK-CODE TOTAL                              
         BASR  RE,RF                                                            
         MVC   TRAREF,TRNREF       REFERENCE DETAIL                             
         BASR  RE,RF                                                            
         B     POSTB12                                                          
*                                                                               
POSTB06  TM    BILLTYPE,ESTIM      IS THIS A PERCENT OF ESTIMATE BILL ?         
         BZ    POSTB08             NO                                           
         TM    WKCOPT,WKCDTLC      DO WE WANT DETAILS ?                         
         BO    POSTB10             YES                                          
         MVC   TRAWKC,SPACES       NO,SETUP FOR NO DETAILS                      
         MVC   TRANAME,SPACES                                                   
         MVC   TRANAME(L'BILLNAME),BILLNAME                                     
         B     POSTB10                                                          
*                                                                               
POSTB08  MVC   TRAWKC,SPACES       NO, MUST REALLY BE SPECIAL                   
         MVC   TRANAME,SPACES                                                   
         MVC   TRANAME(L'AC@SPCAM),AC@SPCAM                                     
*                                                                               
POSTB10  BASR  RE,RF                                                            
*                                                                               
POSTB12  XC    TRAWKC,TRAWKC                                                    
         XC    TRAREF,TRAREF                                                    
         MVC   TRANAME,SPACES                                                   
         MVC   TRANAME,JOBNAME            SAVE JOB NAME                         
         MVC   TRABLPR,SVPRBLPR           PRINT ON BILLS                        
         BASR  RE,RF                                                            
*                                                                               
         CLI   TRNEL,TRNELQ                                                     
         BNE   POSTB13                                                          
         TM    WKCOPT,WKCMT        DIFFERENT TYPE IF MEDIA TRANSFER             
         BZ    POSTB13             (1-LINE, TOTAL OR PROGRESSIVE ONLY)          
         CLI   TRATYPE,TRATYPE3    DID WE DO THE MEDIA ONLY YET?                
         BE    POSTB13             YES                                          
         OI    JOBOPT,JOBMEDT      NO, SET BIT, CHANGE TYPE & RETURN            
         XC    BUFWK(TRALNQ),BUFWK                                              
         MVC   TRAACCUM(JOBLNQ),JOBDTL                                          
         MVI   TRATYPE,TRATYPE3                                                 
         B     POSTB02                                                          
*                                                                               
*              NOW POST TO MEDIA RECAP                                          
         USING MRCD,R5                                                          
POSTB13  XC    BUFWK(MRCLNQ),BUFWK                                              
         MVC   MRCACCUM(JOBLNQ),JOBDTL    ACCUMS                                
         MVI   MRCTYPE,MRCTYPE4                                                 
         MVI   MRCMED,X'FF'               TOTAL ALL JOBS                        
         BASR  RE,RF                                                            
         MVC   MRCMED(12),MEDNAME+3  MEDIA NAME IF PRODUCTION                   
         USING TRNELD,R2                                                        
         L     R2,ADTRANS                                                       
         CLI   TRNEL,TRNELQ                                                     
         BNE   POSTB14                                                          
         TM    WKCOPT,WKCMT                                                     
         BZ    *+10                                                             
         MVC   MRCMED(15),SVANALN    W/C NAME IF MEDIA TRANSFER                 
*                                                                               
POSTB14  BASR  RE,RF                                                            
*                                                                               
         USING WRKD,R5                                                          
         TM    JOBOPT,POSTAGY      MAKING STUDIO/INTER POSTINGS?                
         BZ    POSTB16             NO                                           
*                                                                               
         TM    BILLOPT,WRITE       YES, ONLY TAKE NEW POSTINGS                  
         BZ    POSTB16                                                          
*                                                                               
         LA    R5,WRKWK            ADD DATA TO BINSRCH                          
         XC    WRKWK,WRKWK                                                      
         MVC   WRKCDE,SVAGWC            AGENCY WORKCODE                         
         MVC   WRKACCUM(JOBLNQ),JOBDTL  ACCUMULATORS                            
         GOTO1 SHR,DMCB,('SUBRBIN',(RC)),(R5),AWRKTAB                           
         MVC   WRKCDE,=XL2'FFFF'                                                
         GOTO1 SHR,DMCB,('SUBRBIN',(RC)),(R5),AWRKTAB                           
*                                                                               
POSTB16  B     XIT                                                              
         DROP  R2,R5                                                            
         EJECT                                                                  
***********************************************************************         
*              ADD  A BILLING RECORD TO ACCUMS                        *         
***********************************************************************         
*                                                                               
ADDABILL NTR1                                                                   
         LA    R4,SUBDTL                                                        
         USING JOBD,R4                                                          
         MVC   JOBBK(JOBLNQ),ZEROS     INITIALIZE DETAIL                        
         L     R2,ADTRANS                                                       
         USING TRNELD,R2                                                        
         ZAP   DUB,TRNAMNT                                                      
         MVC   SAVTRND,TRNDATE                                                  
*                                                                               
         AP    JOBNET,DUB              ADD NET TO NET                           
         AP    JOBGRS,DUB                         GROSS                         
*                                                                               
         AP    JOBVNET,DUB                        GST NET                       
         AP    JOBVGRS,DUB                        GST GROSS                     
*                                                                               
         AP    JOBPNET,DUB                        PST NET                       
         AP    JOBPGRS,DUB                        PST GROSS                     
*                                                                               
         AP    PRVCD,TRNBLCD       SAVE PREVIOUS CASH DISCOUNT                  
         CLI   TRNLN,121                                                        
         BNE   ADDAB2                                                           
*                                                                               
         ZAP   DUB,TRNBLCOM                                                     
         AP    JOBCOMM,DUB         COMMISSION TO COMMISSION                     
         AP    JOBGRS,DUB                         GROSS                         
         AP    JOBVGRS,DUB                        GST GROSS                     
         AP    JOBPGRS,DUB                        PST GROSS                     
*                                                                               
ADDAB2   TM    RUNOPT,NEEDGST      ARE WE DOING GST LOGIC?                      
         BZ    ADDAB6              NO, SEE IF WE ARE DOING PST                  
*                                                                               
         USING VBIEL,R2                                                         
ADDAB4   MVI   ELCODE,VBIELQ                                                    
         TM    BILLTYPE,PROG     DON'T ADD GST/PST FROM PREVIOUS BILLS          
         BO    ADDAB10                                                          
         BAS   RE,NEXTEL                                                        
         BNE   ADDAB6                                                           
         AP    JOBGST,VBIVAT                                                    
         ZAP   SAVGST,VBIVAT                                                    
         AP    JOBVNET,VBIVAT                                                   
         AP    JOBVGRS,VBIVAT                                                   
         AP    JOBVBAS,VBIGROSS                                                 
         SP    JOBVBAS,VBIVAT                                                   
*                                                                               
         ZAP   JOBPGRS,JOBVGRS                                                  
         ZAP   JOBPNET,JOBVNET                                                  
*                                                                               
         LA    RE,JOBDTL+(JOBBK-JOBD)                                           
         MVC   0(JOBLNQ,RE),ZEROS         INITIALIZE DETAIL                     
*                                                                               
         LA    RE,JOBDTL+(JOBVGRS-JOBD)   JOBVGRS                               
         AP    0(L'JOBVGRS,RE),VBIGROSS                                         
*                                                                               
         LA    RE,JOBDTL+(JOBPGRS-JOBD)   JOBPGRS                               
         AP    0(L'JOBPGRS,RE),VBIGROSS                                         
*                                                                               
         LA    RE,JOBDTL+(JOBCOMM-JOBD)   JOBCOMM                               
         AP    0(L'JOBCOMM,RE),VBICOMM                                          
*                                                                               
         LA    RE,JOBDTL+(JOBGST-JOBD)    JOBGST                                
         AP    0(L'JOBGST,RE),VBIVAT                                            
*                                                                               
         LA    RE,JOBDTL+(JOBVNET-JOBD)   JOBVNET (GROSS LESS COMM)             
         AP    0(L'JOBVNET,RE),VBIGROSS                                         
         SP    0(L'JOBVNET,RE),VBICOMM                                          
*                                                                               
         LA    RE,JOBDTL+(JOBPNET-JOBD)   JOBPNET (GROSS LESS COMM)             
         AP    0(L'JOBPNET,RE),VBIGROSS                                         
         SP    0(L'JOBPNET,RE),VBICOMM                                          
*                                                                               
         LA    RE,JOBDTL+(JOBVBAS-JOBD)   JOBVBAS (GROSS LESS GST)              
         AP    0(L'JOBVBAS,RE),VBIGROSS                                         
         SP    0(L'JOBVBAS,RE),VBIVAT                                           
*                                                                               
         MVC   SVGSTCOD,VBITYPE                                                 
         MVC   SVGSTRAT,VBIRATE                                                 
         MVC   SVGSTIND,VBIINDS                                                 
         MVC   SVGSTDAT,VBIDATE                                                 
         MVC   SVGSTACC,VBIACCT                                                 
         GOTO1 POSTGST,DMCB,(RC)                                                
         B     ADDAB4                                                           
         DROP  R2                                                               
*                                                                               
ADDAB6   TM    RUNOPT,NEEDPST      ARE WE DOING PST LOGIC?                      
         BZ    ADDAB10             NO, DONE                                     
         L     R2,ADTRANS                                                       
*                                                                               
         USING PBIEL,R2                                                         
ADDAB7   MVI   ELCODE,PBIELQ                                                    
         BAS   RE,NEXTEL                                                        
         BNE   ADDAB10                                                          
         AP    JOBPST,PBIPST                                                    
         AP    JOBPNET,PBIPST                                                   
         AP    JOBPGRS,PBIPST                                                   
         AP    JOBPBAS,PBIGROSS                                                 
         SP    JOBPBAS,PBIPST                                                   
*                                                                               
         CLC   PBIPRV,=C'PQ'                                                    
         BNE   ADDAB8                                                           
*                                                                               
         LA    R1,SAVTRND                                                       
         TM    BILLMODE,UNBILL     ARE WE UNBILLING ?                           
         BZ    *+8                 NO, USE BILL DATE                            
         LA    R1,CALLDATE         YES, USE UNBILL DATE                         
         CLC   0(3,R1),=X'B30101'  SEE IF 2013                                  
         BL    ADDAB8                                                           
         SP    JOBPBAS,SAVGST                                                   
*                                                                               
ADDAB8   LA    RE,JOBDTL+(JOBPGRS-JOBD)                                         
         MVC   0(L'JOBPGRS,RE),ZEROS         INITIALIZE DETAIL                  
         LA    RE,JOBDTL+(JOBPST-JOBD)                                          
         MVC   0(L'JOBPST,RE),ZEROS                                             
         LA    RE,JOBDTL+(JOBPNET-JOBD)                                         
         MVC   0(L'JOBPNET,RE),ZEROS                                            
         LA    RE,JOBDTL+(JOBPBAS-JOBD)                                         
         MVC   0(L'JOBPBAS,RE),ZEROS                                            
*                                                                               
         LA    RE,JOBDTL+(JOBPGRS-JOBD)   JOBPGRS                               
         AP    0(L'JOBPGRS,RE),PBIGROSS                                         
*                                                                               
         LA    RE,JOBDTL+(JOBPST-JOBD)    JOBPST                                
         AP    0(L'JOBPST,RE),PBIPST                                            
*                                                                               
         LA    RE,JOBDTL+(JOBPNET-JOBD)   JOBPNET (GROSS LESS COMM)             
         AP    0(L'JOBPNET,RE),PBIGROSS                                         
         SP    0(L'JOBPNET,RE),PBICOMM                                          
*                                                                               
         LA    RE,JOBDTL+(JOBPBAS-JOBD)   JOBPBAS (GROSS LESS GST)              
         AP    0(L'JOBPBAS,RE),PBIGROSS                                         
         SP    0(L'JOBPBAS,RE),PBIPST                                           
*                                                                               
         CLC   PBIPRV,=C'PQ'                                                    
         BNE   ADDAB9                                                           
*                                                                               
         LA    R1,SAVTRND                                                       
         TM    BILLMODE,UNBILL     ARE WE UNBILLING ?                           
         BZ    *+8                 NO, USE BILL DATE                            
         LA    R1,CALLDATE         YES, USE UNBILL DATE                         
         CLC   0(3,R1),=X'B30101'  SEE IF 2013                                  
         BL    ADDAB9                                                           
         SP    0(L'JOBPBAS,RE),SAVGST                                           
*                                                                               
ADDAB9   MVC   SVPSTCOD,PBITYPE                                                 
         MVC   SVPSTPRV,PBIPRV                                                  
         MVC   SVPSTRAT,PBIRATE                                                 
         MVC   SVPSTIND,PBIINDS                                                 
         MVC   SVPSTDAT,PBIDATE                                                 
         MVC   SVPSTACC,PBIACCT                                                 
*                                                                               
         USING VTCD,R5                                                          
         L     R5,AVATBUFF                                                      
         MVI   VTCACTN,VTCANAME                                                 
         MVC   VTCPRV,SVPSTPRV     SET PROVINCE CODE                            
         MVC   SVPSTNME,SPACES     CLEAR IN CASE NOT FOUND                      
         MVC   VTCLANG,RCLANG                                                   
         GOTO1 VATICAN,(R5)                                                     
         MVC   SVPSTNME,VTCPRVD    GET THE DESCRIPTION                          
*                                                                               
         GOTO1 POSTPST,DMCB,(RC)                                                
         B     ADDAB7                                                           
*                                                                               
ADDAB10  MVC   JOBDTL,SUBDTL                                                    
         GOTO1 SHR,DMCB,('SUBRSUML',(RC))      DOWNCAST TABLE                   
         B     XIT                                                              
         DROP  R2,R4,R5                                                         
         EJECT                                                                  
***********************************************************************         
*              SUBTRACT A BILLING RECORD FROM ACCUMS                  *         
***********************************************************************         
*                                                                               
SUBABILL NTR1                                                                   
         LA    R4,SUBDTL                                                        
         USING JOBD,R4                                                          
         MVC   JOBBK(JOBLNQ),ZEROS     INITIALIZE DETAIL                        
         L     R2,ADTRANS                                                       
         USING TRNELD,R2                                                        
         ZAP   DUB,TRNAMNT                                                      
         MVC   SAVTRND,TRNDATE                                                  
*                                                                               
         SP    JOBNET,DUB          SUBTRACT FROM NET                            
         SP    JOBGRS,DUB                        GROSS                          
         SP    JOBVNET,DUB                       GST NET                        
         SP    JOBVGRS,DUB                       GST GROSS                      
         SP    TOTPB,DUB                                                        
*                                                                               
         SP    JOBPNET,DUB                       PST NET                        
         SP    JOBPGRS,DUB                       PST GROSS                      
         SP    PRVCD,TRNBLCD       SAVE PREVIOUS CASH DISCOUNT                  
*                                                                               
         CLI   TRNLN,121                                                        
         BNE   SUBAB2                                                           
         ZAP   DUB,TRNBLCOM                                                     
         SP    JOBCOMM,DUB         COMMISSION FROM COMMISSION                   
         SP    JOBGRS,DUB                          GROSS                        
         SP    JOBVGRS,DUB                         GST GROSS                    
         SP    JOBPGRS,DUB                         PST GROSS                    
*                                                                               
SUBAB2   TM    RUNOPT,NEEDGST      ARE WE DOING GST LOGIC?                      
         BZ    SUBAB6              NO, SEE IF WE ARE DOING PST                  
*                                                                               
         USING VBIEL,R2                                                         
SUBAB4   MVI   ELCODE,VBIELQ                                                    
         BAS   RE,NEXTEL                                                        
         BNE   SUBAB6                                                           
         SP    JOBGST,VBIVAT                                                    
         ZAP   SAVGST,VBIVAT                                                    
         SP    JOBVNET,VBIVAT                                                   
         SP    JOBVGRS,VBIVAT                                                   
         SP    JOBVBAS,VBIGROSS                                                 
         AP    JOBVBAS,VBIVAT                                                   
*                                                                               
         ZAP   JOBPGRS,JOBVGRS                                                  
         ZAP   JOBPNET,JOBVNET                                                  
*                                                                               
         LA    RE,JOBDTL+(JOBBK-JOBD)                                           
         MVC   0(JOBLNQ,RE),ZEROS         INITIALIZE DETAIL                     
*                                                                               
         LA    RE,JOBDTL+(JOBVGRS-JOBD)   JOBVGRS                               
         SP    0(L'JOBVGRS,RE),VBIGROSS                                         
*                                                                               
         LA    RE,JOBDTL+(JOBPGRS-JOBD)   JOBPGRS                               
         SP    0(L'JOBPGRS,RE),VBIGROSS                                         
*                                                                               
         LA    RE,JOBDTL+(JOBCOMM-JOBD)   JOBCOMM                               
         SP    0(L'JOBCOMM,RE),VBICOMM                                          
*                                                                               
         LA    RE,JOBDTL+(JOBGST-JOBD)    JOBGST                                
         SP    0(L'JOBGST,RE),VBIVAT                                            
*                                                                               
         LA    RE,JOBDTL+(JOBVNET-JOBD)   JOBVNET (GROSS LESS COMM)             
         SP    0(L'JOBVNET,RE),VBIGROSS                                         
         AP    0(L'JOBVNET,RE),VBICOMM                                          
*                                                                               
         LA    RE,JOBDTL+(JOBPNET-JOBD)   JOBPNET (GROSS LESS COMM)             
         SP    0(L'JOBPNET,RE),VBIGROSS                                         
         AP    0(L'JOBPNET,RE),VBICOMM                                          
*                                                                               
         LA    RE,JOBDTL+(JOBVBAS-JOBD)   JOBVBAS (GROSS LESS GST)              
         SP    0(L'JOBVBAS,RE),VBIGROSS                                         
         AP    0(L'JOBVBAS,RE),VBIVAT                                           
*                                                                               
         MVC   SVGSTCOD,VBITYPE                                                 
         MVC   SVGSTRAT,VBIRATE                                                 
         MVC   SVGSTIND,VBIINDS                                                 
         MVC   SVGSTDAT,VBIDATE                                                 
         MVC   SVGSTACC,VBIACCT                                                 
         GOTO1 POSTGST,DMCB,(RC)                                                
         B     SUBAB4                                                           
*                                                                               
SUBAB6   TM    RUNOPT,NEEDPST      ARE WE DOING PST LOGIC?                      
         BZ    SUBAB10             NO, DONE                                     
         L     R2,ADTRANS                                                       
*                                                                               
         USING PBIEL,R2                                                         
SUBAB7   MVI   ELCODE,PBIELQ                                                    
         BAS   RE,NEXTEL                                                        
         BNE   SUBAB10                                                          
         SP    JOBPST,PBIPST                                                    
         SP    JOBPNET,PBIPST                                                   
         SP    JOBPGRS,PBIPST                                                   
         SP    JOBPBAS,PBIGROSS                                                 
         AP    JOBPBAS,PBIPST                                                   
*                                                                               
         CLC   PBIPRV,=C'PQ'                                                    
         BNE   SUBAB8                                                           
*                                                                               
         LA    RE,SAVTRND                                                       
         TM    BILLMODE,UNBILL     ARE WE UNBILLING ?                           
         BZ    *+8                 NO, USE BILL DATE                            
         LA    RE,CALLDATE         YES, USE UNBILL DATE                         
         CLC   0(3,RE),=X'B30101'  SEE IF 2013                                  
         BL    SUBAB8                                                           
         AP    JOBPBAS,SAVGST                                                   
*                                                                               
SUBAB8   LA    RE,JOBDTL+(JOBPGRS-JOBD)                                         
         MVC   0(L'JOBPGRS,RE),ZEROS         INITIALIZE DETAIL                  
         LA    RE,JOBDTL+(JOBPST-JOBD)                                          
         MVC   0(L'JOBPST,RE),ZEROS                                             
         LA    RE,JOBDTL+(JOBPNET-JOBD)                                         
         MVC   0(L'JOBPNET,RE),ZEROS                                            
         LA    RE,JOBDTL+(JOBPBAS-JOBD)                                         
         MVC   0(L'JOBPBAS,RE),ZEROS                                            
*                                                                               
         LA    RE,JOBDTL+(JOBPGRS-JOBD)   JOBPGRS                               
         SP    0(L'JOBPGRS,RE),PBIGROSS                                         
*                                                                               
         LA    RE,JOBDTL+(JOBPST-JOBD)    JOBPST                                
         SP    0(L'JOBPST,RE),PBIPST                                            
*                                                                               
         LA    RE,JOBDTL+(JOBPBAS-JOBD)   JOBPBAS (GROSS LESS GST)              
         SP    0(L'JOBPBAS,RE),PBIGROSS                                         
         AP    0(L'JOBPBAS,RE),PBIPST                                           
*                                                                               
         CLC   PBIPRV,=C'PQ'                                                    
         BNE   SUBAB9                                                           
*                                                                               
         LA    R1,SAVTRND                                                       
         TM    BILLMODE,UNBILL     ARE WE UNBILLING ?                           
         BZ    *+8                 NO, USE BILL DATE                            
         LA    R1,CALLDATE         YES, USE UNBILL DATE                         
         CLC   0(3,R1),=X'B30101'  SEE IF 2013                                  
         BL    SUBAB9                                                           
         AP    0(L'JOBPBAS,RE),SAVGST                                           
*                                                                               
SUBAB9   MVC   SVPSTCOD,PBITYPE                                                 
         MVC   SVPSTPRV,PBIPRV                                                  
         MVC   SVPSTRAT,PBIRATE                                                 
         MVC   SVPSTIND,PBIINDS                                                 
         MVC   SVPSTDAT,PBIDATE                                                 
         MVC   SVPSTACC,PBIACCT                                                 
*                                                                               
         USING VTCD,R5                                                          
         L     R5,AVATBUFF                                                      
         MVI   VTCACTN,VTCANAME                                                 
         MVC   VTCPRV,SVPSTPRV     SET PROVINCE CODE                            
         MVC   SVPSTNME,SPACES     CLEAR IN CASE NOT FOUND                      
         MVC   VTCLANG,RCLANG                                                   
         GOTO1 VATICAN,(R5)                                                     
         MVC   SVPSTNME,VTCPRVD    GET THE DESCRIPTION                          
*                                                                               
         GOTO1 POSTPST,DMCB,(RC)                                                
         B     SUBAB7                                                           
*                                                                               
SUBAB10  MVC   JOBDTL,SUBDTL                                                    
         GOTO1 SHR,DMCB,('SUBRSUML',(RC))    DOWNCAST TABLE                     
         B     XIT                                                              
         DROP  R2,R4,R5                                                         
         EJECT                                                                  
***********************************************************************         
*              LOOK FOR AGENCY BILL NUMBER                            *         
***********************************************************************         
*                                                                               
AGYBILL  NTR1                                                                   
         L     R2,ADLEDGER                                                      
         MVI   ELCODE,X'11'                                                     
         BAS   RE,GETEL                                                         
         BNE   XIT                                                              
         TM    BILLOPT,AGYNUM                                                   
         BO    AGYBILL9            NOT FIRST TIME                               
         BAS   RE,SETMNTH          SET BILL MONTH                               
*                                                                               
AGYBILL9 OI    BILLOPT,AGYNUM                                                   
         OI    RUNOPT,WRITLG                                                    
         BAS   RE,SETNUMB          SET BILL NUMBER                              
         B     XIT                                                              
*                                                                               
         USING PMDELD,R2                                                        
         USING ACPROFSD,R3                                                      
SETMNTH  L     R3,APROFILE                                                      
         TM    BILLMODE,RERUN                                                   
         BZ    SETMNT2                                                          
         MVC   PMDLBILL,PMDFBILL   USE FIRST BILL FOR RERUN                     
         B     *+10                                                             
*                                                                               
SETMNT2  MVC   PMDFBILL,PMDLBILL   FIX START FOR NEXT TIME                      
         CLC   MNTH,PMDLBILL                                                    
         BER   RE                                                               
         MVC   PMDLBILL(2),MNTH                                                 
         MVC   PMDLBILL+2(4),PMDRBILL                                           
         BR    RE                                                               
*                                                                               
SETNUMB  PACK  BILLNO,PMDLBILL                                                  
         LA    R1,PMDLBILL                                                      
         ST    R1,ANUMAFT          ADDRESS OF NUMBER AFTER FOR RETAIL           
         ZAP   FULL,BILLNO                                                      
         AP    FULL,=P'1'                                                       
         UNPK  PMDLBILL,FULL                                                    
         OI    PMDLBILL+5,X'F0'                                                 
         BR    RE                                                               
         DROP  R2                                                               
         EJECT                                                                  
***********************************************************************         
*              LOOK FOR A CLIENT BILL NUMBER                          *         
***********************************************************************         
*                                                                               
CLIBILL  NTR1                                                                   
         L     R2,ADHEIRA                                                       
         MVI   ELCODE,X'11'                                                     
         BAS   RE,GETEL                                                         
         BNE   CBILL04                                                          
         TM    BILLOPT,CLINUM                                                   
         BO    CBILL02           NOT FIRST TIME                                 
         BAS   RE,SETMNTH                                                       
*                                                                               
CBILL02  OI    BILLOPT,CLINUM                                                   
         OI    RUNOPT,WRITLVA                                                   
         BAS   RE,SETNUMB                                                       
         B     XIT                                                              
*                                                                               
CBILL04  L     R2,ADHEIRA                                                       
         MVI   ELCODE,X'21'                                                     
         BAS   RE,GETEL                                                         
         BNE   XIT                                                              
         B     CBILL08                                                          
*                                                                               
CBILL06  BAS   RE,NEXTEL                                                        
         BNE   XIT                                                              
*                                                                               
         USING NUMELD,R4                                                        
CBILL08  LR    R4,R2                                                            
         CLI   NUMLN,15         DOES IT HAVE A MEDIA CODE                       
         BL    CBILL06             NO-GET NEXT                                  
*                                                                               
         CLC   JOBLET,NUMTYPE     MATCH ON MEDIA                                
         BNE   CBILL06             NO-GET NEXT                                  
         CLC   MNTH,NUMAFT       RIGHT MONTH                                    
         BE    CBILL16                                                          
         L     R2,ADCOMP           FIND MEDIA RESET VALUE                       
         AH    R2,DATADISP                                                      
*                                                                               
CBILL10  CLI   0(R2),0                                                          
         BE    CBILL16                                                          
         CLI   0(R2),X'11'                                                      
         BE    CBILL14                                                          
*                                                                               
CBILL12  ZIC   R0,1(R2)                                                         
         AR    R2,R0                                                            
         B     CBILL10                                                          
*                                                                               
         USING PMDELD,R2                                                        
CBILL14  CLI   1(R2),X'30'         RIGHT LENGTH                                 
         BE    CBILL12                                                          
         CLC   PMDCODE,NUMTYPE   RIGHT MEDIA                                    
         BNE   CBILL12                                                          
         MVC   NUMAFT(2),MNTH    RESET MONTH AND NUMBER                         
         MVC   NUMAFT+2(4),PMDRBILL                                             
*                                                                               
CBILL16  OI    BILLOPT,CLINUM                                                   
         LA    R1,NUMAFT                                                        
         ST    R1,ANUMAFT          ADDRESS OF NUMBER AFTER FOR RETAIL           
         PACK  BILLNO,NUMAFT                                                    
         ZAP   FULL,BILLNO                                                      
         AP    FULL,=P'1'                                                       
         UNPK  NUMAFT,FULL                                                      
         OI    NUMAFT+5,X'F0'                                                   
         OI    RUNOPT,WRITLVA                                                   
         B     XIT                                                              
         DROP  R2,R4                                                            
         EJECT                                                                  
***********************************************************************         
*              LOOK FOR A MEDIA RECORD                                *         
***********************************************************************         
*                                                                               
MEDSRCH  NTR1                                                                   
         MVC   MEDIA,JOBLET                                                     
         GOTO1 SHR,DMCB,('SUBRMED',(RC))  GET ADDRESS OF MEDIA ELEMENT          
         L     R2,AMEL                                                          
         CLI   1(R2),X'3C'         RIGHT LENGTH                                 
         BL    XIT                                                              
         BAS   RE,SETMNTH                                                       
         OI    RUNOPT,WRITMED                                                   
         OI    BILLOPT,MEDNUM                                                   
         BAS   RE,SETNUMB                                                       
XIT      XIT1                                                                   
         EJECT                                                                  
         USING ACMD,R2                                                          
ADDELEM  NTR1                                                                   
         L     R2,AMONACC                                                       
         GOTO1 ACMVHELO,DMCB,(C'P',FILNME),(RF),WORK                            
         CLI   DMCB+12,X'00'                                                    
         B     XIT                 JUST GO BACK, EVEN IF NOT ADDED              
         DROP  R2                                                               
         EJECT                                                                  
         GETEL R2,DATADISP,ELCODE                                               
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
SORTCARD DC    CL80'SORT FIELDS=(5,15,A),FORMAT=BI,WORK=1'                      
RECCARD  DC    CL80'RECORD TYPE=V,LENGTH=(200,,,,)'                             
*                                                                               
PHASES   DS    0AL1                LOADABLE PHASES                              
         DC    AL1(QPOSTWRK)                                                    
PHASEN   EQU   (*-PHASES)/L'PHASES                                              
*                                                                               
WARNRSN  DS    CL1                 CURRENT WARNING                              
WARNRSNS DS    CL(WARN01-WARN01+1) LIST OF WARNINGS                             
*                                                                               
*              TABLE OF WARNING MESSAGES                                        
*                                                                               
WARN01   EQU   1                                                                
WRN01    DC    AL1(WARN01),AL1(L'WRN01M)                                        
WRN01M   DC    CL60'NO INTERCOMPANY POSTINGS MADE - AGENCY JOB IS AN EXX        
               PENSE JOB'                                                       
         DC    X'FF'                                                            
         EJECT                                                                  
***********************************************************************         
* GET THE PROFILE RECORD                                              *         
***********************************************************************         
*                                                                               
GETPRO   NTR1  BASE=*,LABEL=*                                                   
         MVI   ARCHIVE,C'N'        SET TO NOT ARCHIVING                         
         USING CTPREC,R2                                                        
         L     R2,AIO2             IO AREA                                      
         XC    CTPKEY,CTPKEY                                                    
         MVI   CTPKTYP,CTPKTYPQ    PROFILE RECORD "P"                           
         MVI   CTPKSYS,C'A'        SYSTEM=ACC                                   
         MVC   CTPKPROG,QPROG                                                   
         MVC   CTPKORIG,ORIGINUM                                                
         GOTO1 DATAMGR,DMCB,DMREAD,=C'CTFILE  ',(R2),(R2)                       
         CLI   DMCB+8,0                                                         
         BNE   GETPROX                                                          
*                                                                               
         SR    R0,R0                                                            
         LA    R2,CTPDATA          POINT TO FIRST ELEMENT                       
*                                                                               
GETPRO2  CLI   0(R2),0                                                          
         BE    GETPROX                                                          
         CLI   0(R2),CTARTELQ                                                   
         BE    GETPRO4                                                          
         IC    R0,1(R2)                                                         
         AR    R2,R0                                                            
         B     GETPRO2             NEXT ELEMENT                                 
         DROP  R2                                                               
*                                                                               
         USING CTARTD,R2                                                        
GETPRO4  CLI   CTARTCOD,C'A'                                                    
         BNE   GETPROX                                                          
         MVI   ARCHIVE,C'Y'                                                     
*                                                                               
GETPROX  B     XIT                                                              
         DROP  R2                                                               
*                                                                               
         LTORG                                                                  
***********************************************************************         
*              CREATE TABLE OF CURRENT B7 ELEMENTS                    *         
***********************************************************************         
*                                                                               
*                                                                               
         USING INCELD,RE                                                        
NEWB7    NTR1  BASE=*,LABEL=*                                                   
         L     RE,APREVB7                                                       
         ZAP   SVINCPR,=P'0'       CLEAR PREVIOUS INCOME                        
         CLI   0(RE),X'FF'         ARE B7'S ALLOWED ?                           
         BE    NEWB7X              NO, DON'T CREATE CURRB7 TABLE                
*                                                                               
NEWB702  CLI   0(RE),0             ANY PREVIOUS B7'S FOR THIS WORKCODE          
         BE    NEWB706             NO, UPDATE CURRENT TABLE ONLY                
         CLC   INCWRKC(2),SVANAL   YES, FIND THIS WORKCODE                      
         BE    NEWB704                                                          
         LA    RE,INCLN2Q(RE)      GET NEXT TABLE ENTRY                         
         B     NEWB702             KEEP LOOKING                                 
*                                                                               
NEWB704  SP    DUB,INCAMNT         NET OUT AMOUNTS                              
         MVI   INCWRKC,X'EE'       INDICATE WORKCODE USED                       
         TM    INCOPT,INCTOT       ARE WE MAKING TOTAL POSTINGS?                
         BZ    NEWB706             NO                                           
         ZAP   SVINCPR,INCINAM     YES, SAVE INCOME AMOUNT & ACCOUNTS           
         OC    INCCACC,INCCACC                                                  
         BZ    *+10                                                             
         MVC   SVWKCCR+1(L'INCCACC),INCCACC                                     
         OC    INCDACC,INCDACC                                                  
         BZ    *+10                                                             
         MVC   SVWKCDR+1(L'INCDACC),INCDACC                                     
         DROP  RE                                                               
*                                                                               
         USING INCELD,RF                                                        
NEWB706  L     RF,ACURRB7                                                       
*                                                                               
NEWB708  CLI   0(RF),0             ANY MATCHING CURRENT B7'S ?                  
         BE    NEWB712             NO                                           
         CLC   INCWRKC(2),SVANAL   YES, FIND THIS WORKCODE                      
         BE    NEWB710                                                          
         LA    RF,INCLN2Q(RF)                                                   
         B     NEWB708                                                          
*                                                                               
NEWB710  AP    INCAMNT,DUB         UPDATE IF ALREADY THERE                      
         TM    INCOPT,INCEST       IS THIS %ESTIMATE BILL?                      
         BZ    *+10                NO                                           
         AP    INCINAM,DUB         YES, INCOME IS THE SAME                      
         B     NEWB7X                                                           
*                                                                               
NEWB712  MVI   INCEL,INCELQ                                                     
         MVI   INCLN,INCLN2Q                                                    
         ZAP   INCAMNT,DUB         ADD DATA                                     
         ZAP   INCINAM,=P'0'                                                    
         MVC   INCWRKC(2),SVANAL   MOVE IN THE WORKCODE                         
         MVC   INCCACC,SVWKCCR+1   CREDIT ACCOUNT                               
         MVC   INCDACC,SVWKCDR+1   DEBIT ACCOUNT                                
         ZAP   INCINAM,DUB         ASSUME IT'S %ESTIMATE                        
         TM    INCOPT,INCEST       IS IT?                                       
         BO    NEWB714             YES                                          
         ZAP   INCINAM,SVINCPR     NO, MUST BE TOTAL, USE PREVIOUS              
         MP    INCINAM,=P'-1'                                                   
*                                                                               
NEWB714  LA    RF,INCLN2Q(RF)                                                   
         MVI   0(RF),0             MARK END OF TABLE                            
*                                                                               
NEWB7X   B     XIT                                                              
         DROP  RF                                                               
                                                                                
         LTORG                                                                  
         EJECT                                                                  
RELOTAB  DS    0A                                                               
*                                  LOCAL ROUTINES                               
         DC    A(FORML)                                                         
         DC    A(GETWC)                                                         
         DC    A(BILLE)                                                         
         DC    A(UBILLE)                                                        
         DC    A(PSUMR)                                                         
         DC    A(CSUMR)                                                         
         DC    A(WARNR)                                                         
         DC    A(BILLN)                                                         
         DC    A(GETR)                                                          
         DC    A(GETI)                                                          
         DC    A(RECR)                                                          
         DC    A(GETC)                                                          
         DC    A(FILTR)                                                         
         DC    A(PRNTR)                                                         
         DC    A(POSTR)                                                         
         DC    A(SHRR)                                                          
         DC    A(RTLR)                                                          
         DC    A(ENDR)                                                          
         DC    A(POSTG)                                                         
         DC    A(POSTP)                                                         
*                                  LOCAL STORAGE                                
         DC    A(MEDTAB)                                                        
         DC    A(COMBUF)                                                        
         DC    A(IO2)                                                           
         DC    A(POSTBUF)                                                       
         DC    A(MYSPECS)                                                       
         DC    A(BUFFALOC)                                                      
         DC    A(ESTPOOL)                                                       
         DC    A(USRPOOL)                                                       
         DC    A(VATBUFF)                                                       
         DC    A(SVTABLE)                                                       
         DC    A(SUBTAB)                                                        
         DC    A(RTAWK)                                                         
         DC    A(NOBWK)                                                         
         DC    A(INVRWK)                                                        
         DC    A(INTRWK)                                                        
         DC    A(EXCRWK)                                                        
         DC    A(PREVB7)                                                        
         DC    A(CURRB7)                                                        
         DC    A(WRKTAB)                                                        
         DC    A(DSTRB)            RETAIL DISTRIBUTION TABLE                    
         DC    A(POBWK)                                                         
*                                  EXTRNS                                       
         DC    V(UNDERLIN)                                                      
         DC    V(CASHVAL)                                                       
         DC    V(SQUASHER)                                                      
         DC    V(RIGHT)                                                         
         DC    V(ACTRACK)                                                       
         DC    X'FF'                                                            
*                                                                               
         EJECT ,                                                                
DICI     DCDDL AC#ABTAX,19,L                                                    
         DCDDL AC#ACC#,13,R                                                     
         DCDDL AC#ACC#,13,RU                                                    
         DCDDL AC#AMT,7,R                                                       
         DCDDL AC#AMT,7,RU                                                      
         DCDDL AC#BASIS,6,R                                                     
         DCDDL AC#BASIS,6,RU                                                    
         DCDDL AC#BIL,4,L                                                       
         DCDDL AC#BILC,11,L                                                     
         DCDDL AC#CLINT,6,L                                                     
         DCDDL AC#CRAM,13,R                                                     
         DCDDL AC#CSHDS,13,L                                                    
         DCDDL AC#DOCC,15,L                                                     
         DCDDL AC#DRAFT,5,L                                                     
         DCDDL AC#DUEDT,8,L                                                     
         DCDDL AC#EST,8,L                                                       
         DCDDL AC#GROSS,5,L                                                     
         DCDDL AC#GSTAM,11,L                                                    
         DCDDL AC#IFDED,27,L                                                    
         DCDDL AC#INV,10,L                                                      
         DCDDL AC#JOBN,8,L                                                      
         DCDDL AC#JOBNU,10,L                                                    
         DCDDL AC#NDIST,21,L                                                    
         DCDDL AC#NET,3,L                                                       
         DCDDL AC#NIL,4,R                                                       
         DCDDL AC#OTHRS,6,L                                                     
         DCDDL AC#PAA,33,R                                                      
         DCDDL AC#PCTOE,12,L                                                    
         DCDDL AC#PC100,26,L                                                    
         DCDDL AC#PLCD,27,L                                                     
         DCDDL AC#PRD,10,C                                                      
         DCDDL AC#PRO,7,L                                                       
         DCDDL AC#PRVBL,20,L                                                    
         DCDDL AC#PRVBS,14,L                                                    
         DCDDL AC#PRVDE,27,L                                                    
         DCDDL AC#PSTAM,11,L                                                    
         DCDDL AC#PSTAN,12,L                                                    
         DCDDL AC#PSTAN,12,LU                                                   
         DCDDL AC#PSTBA,11,L                                                    
         DCDDL AC#PSTRT,11,L                                                    
         DCDDL AC#PST,3,L                                                       
         DCDDL AC#QST,3,L                                                       
         DCDDL AC#RATE,4,R                                                      
         DCDDL AC#RATE,4,RU                                                     
         DCDDL AC#RECAP,14,L                                                    
         DCDDL AC#REQDE,15,L                                                    
         DCDDL AC#SCM,9,L                                                       
         DCDDL AC#SPCAM,14,L                                                    
         DCDDL AC#STDIO,6,L                                                     
         DCDDL AC#TAMTD,20,L                                                    
         DCDDL AC#TAX,4,L                                                       
         DCDDL AC#TAX,4,LU                                                      
         DCDDL AC#TAXAN,17,C                                                    
         DCDDL AC#TAXAN,17,CU                                                   
         DCDDL AC#TCLI,16,R                                                     
         DCDDL AC#TCRGS,15,L                                                    
         DCDDL AC#TFOR,9,R                                                      
         DCDDL AC#TJOB,13,R                                                     
         DCDDL AC#TMEDC,19,L                                                    
         DCDDL AC#TOREV,18,L                                                    
         DCDDL AC#TOTAL,5,R                                                     
         DCDDL AC#TOTRN,17,L                                                    
         DCDDL AC#TPRCG,24,L                                                    
         DCDDL AC#TPRCG,16,L,LABEL=AC@TPRD                                      
         DCDDL AC#TPRO,17,R                                                     
         DCDDL AC#TPRVB,22,L                                                    
         DCDDL AC#TWC,19,R                                                      
         DCDDL AC#TYPE,4,L                                                      
         DCDDL AC#UNITS,6,L                                                     
         DCDDL AC#VAT1,3,L                                                      
         DCDDL AC#XFRTO,14,L                                                    
         DCDDL AC#YSHRE,10,L                                                    
         DCDDL AC#SHIP,9,L                                                      
         DC    X'00'                                                            
         DROP  R6,R9,RA,RB                                                      
         TITLE 'FORMAT A LINE OF DETAIL ON THE BILL'                  *         
FORML    DS    0D                                                               
         NMOD1 0,*FORML*                                                        
         L     RC,0(R1)                                                         
         L     R2,ADTRANS                                                       
         USING TRNELD,R2                                                        
         L     R4,ADSUBAC                                                       
         USING CACELD,R4                                                        
         MVC   TEMPWK,JOBDTL                                                    
         GOTO1 SHR,DMCB,('SUBRFORM',(RC))                                       
         MVC   JOBDTL(JOBLNQ),ZEROS                                             
         MVC   CHOPWRK,SPACES                                                   
         CLC   TRNANAL,=C'99'                                                   
         BE    FORML28                                                          
*                                                                               
         LA    R5,P+1              SET TO FIRST PRINT LINE                      
         CLI   QOPT2,C'Y'          PRINT REFERENCE NUMBER?                      
         BE    FORML00             YES                                          
         CLI   PROF2,C'Y'                                                       
         BNE   FORML02                                                          
*                                                                               
FORML00  MVC   CHOPWRK(6),TRNREF   YES                                          
         OC    LONGREF,LONGREF                                                  
         BZ    *+10                                                             
         MVC   CHOPWRK(L'LONGREF),LONGREF                                       
         GOTO1 ADSQUASH,DMCB,CHOPWRK,121                                        
         L     R3,DMCB+4                                                        
         GOTO1 CHOPPER,DMCB,((R3),CHOPWRK),(L'LONGREF,0(R5)),1                  
         LA    R5,132(R5)                                                       
*                                                                               
FORML02  CP    HOURS,=P'0'                                                      
         BE    FORML04             NOT TIMESHEET INPUT                          
         XC    CHOPWRK(23),CHOPWRK                                              
         CURED HOURS,(7,CHOPWRK),2,MINUS=YES                                    
         MVC   CHOPWRK+8(7),=C'HOURS @'                                         
         LA    R3,CHOPWRK+16                                                    
         CURED RATE,(7,0(R3)),2                                                 
         B     FORML06                                                          
*                                                                               
FORML04  CP    UNITS,=P'0'                                                      
         BE    FORML08             NOT UNIT PRICING                             
         XC    CHOPWRK(21),CHOPWRK                                              
         CURED UNITS,(6,CHOPWRK),0,MINUS=YES                                    
         MVC   CHOPWRK+7(7),=C'UNITS @'                                         
         LA    R3,CHOPWRK+15                                                    
         CURED PRICE,(8,0(R3)),2                                                
*                                                                               
FORML06  GOTO1 ADSQUASH,DMCB,CHOPWRK,121                                        
         L     R3,DMCB+4                                                        
         GOTO1 CHOPPER,DMCB,((R3),CHOPWRK),(21,0(R5)),1                         
         LA    R5,132(R5)                                                       
*                                                                               
FORML08  XC    CHOPWRK(23),CHOPWRK                                              
         CLC   TRNNARR(2),=C'**'   DON'T PRINT NARRATIVE                        
         BE    FORML10                                                          
         SR    R3,R3                                                            
         IC    R3,TRNLN                                                         
         SH    R3,=H'29'                                                        
         BM    FORML10                                                          
*                                                                               
         CHI   R3,L'CHOPWRK        MAKE SURE WE ONLY MOVE WHAT FITS             
         BL    *+8                                                              
         LHI   R3,L'CHOPWRK-1                                                   
*                                                                               
         EX    R3,*+8                                                           
         B     *+10                                                             
         MVC   CHOPWRK(0),TRNNARR                                               
         B     FORML10                                                          
*                                                                               
FORML10  GOTO1 ADSQUASH,DMCB,CHOPWRK,121                                        
         L     R3,DMCB+4                                                        
         GOTO1 CHOPPER,DMCB,((R3),CHOPWRK),(21,NARR),8                          
         LA    R0,3          PRINT 3 LINES UNLESS WE ALREADY PRINTED 1          
         LA    R3,PSECOND+1  MOVE FIRST 3 OF NARRATIVE TO P2,P3,P4              
         LA    R2,NARR       IF THERE ARE MORE THAN 3 THE REST                  
         CR    R5,R3         WILL BE PRINTED AFTER RETURN                       
         BE    *+8                                                              
         LA    R0,2                                                             
*                                                                               
FORML12  MVC   0(21,R5),0(R2)  FROM FORMLINE.                                   
         MVC   0(21,R2),SPACES                                                  
         LA    R5,132(R5)                                                       
         LA    R2,21(R2)                                                        
         BCT   R0,FORML12                                                       
*                                                                               
         CLC   0(21,R2),SPACES     IS THERE A FIFTH LINE OF NARRATIVE           
         BE    *+8                                                              
         MVI   MYSPACE,1           IF SO, DON'T SPACE AFTER FOURTH              
*                                                                               
         MVC   TEMPWK,JOBDTL                                                    
         GOTO1 SHR,DMCB,('SUBRFORM',(RC))                                       
         MVC   JOBDTL(JOBLNQ),ZEROS                                             
         CLI   QOPT4,C'Y'          OPTION TO SUPPRESS VENDOR NAME               
         BE    FORML14                                                          
         CLI   PROF3,C'Y'                                                       
         BE    FORML14                                                          
         SR    R3,R3               CLEAR REGISTER FIRST                         
         IC    R3,CACLN                                                         
         SH    R3,=H'17'                                                        
         GOTO1 CHOPPER,DMCB,((R3),CACNAME),(15,P+23),(C'P',3)                   
*                                                                               
FORML14  L     R2,ADTRANS                                                       
         CLI   PROF10,C'Y'        PRINT TRANSFER INFO                           
         BNE   FORML24                                                          
*                                                                               
FORML16  CLI   0(R2),0             END OF RECORD, NOTHING TO PRINT              
         BE    FORML24                                                          
         CLI   0(R2),X'4E'         TRANSFER ELEMENT?                            
         BE    FORML18             YES                                          
         SR    RE,RE               NO, LOOK AGAIN                               
         IC    RE,1(R2)                                                         
         AR    R2,RE                                                            
         B     FORML16                                                          
*                                                                               
         USING PXDELD,R2                                                        
FORML18 MVC    CHOPWRK,SPACES                                                   
         MVC   CHOPWRK(L'AC@XFRTO),AC@XFRTO                                     
         CLI   PXDTYPE,C'T'                                                     
         BE    *+10                                                             
         MVC   CHOPWRK+12(4),=C'FROM'                                           
         MVC   CHOPWRK+17(L'PXDFRTO-3),PXDFRTO+3                                
         MVC   CHOPWRK+32(2),=C'ON'                                             
         GOTO1 DATCON,DMCB,(1,PXDDATE),(8,CHOPWRK+35)                           
         LA    R4,P                                                             
         LA    R3,4                                                             
*                                                                               
FORML20  CLC   0(50,R4),SPACES                                                  
         BE    FORML22                                                          
         LA    R4,132(R4)          FIND BLANK LINE                              
         BCT   R3,FORML20                                                       
         B     FORML24             NO ROOM FOR TRANSFER INFO                    
*                                                                               
FORML22  GOTO1 ADSQUASH,DMCB,CHOPWRK,90                                         
         L     R3,DMCB+4                                                        
         GOTO1 CHOPPER,DMCB,((R3),CHOPWRK),(50,1(R4)),(C'P',2)                  
*                                                                               
         USING TRNELD,R2                                                        
FORML24  L     R2,ADTRANS                                                       
         TM    BILLTYPE,TOTAL                                                   
         BZ    FORML26                                                          
         TM    BILLOPT,WRITE                                                    
         BZ    FORML26                                                          
         MVC   P+36(2),=C' *'      NEW ITEMS ON TOTAL BILL                      
*                                                                               
FORML26  TM    BILLOPT,CASHD                                                    
         BZ    FORMLX                                                           
         CLI   PROF9,C'G'                                                       
         BE    FORMLX                                                           
         MVC   P+38(4),=C'*CD*'                                                 
         B     FORMLX                                                           
*                                                                               
FORML28  DS    0H                  ROUTINE FOR PREVIOUS BILLS                   
         MVC   P+1(15),TRNNARR                                                  
         LA    R1,P+1                                                           
         LA    R3,10                                                            
*                                                                               
FORML30  CLC   0(6,R1),=C'PC EST'                                               
         BE    FORML32                                                          
         LA    R1,1(R1)                                                         
         BCT   R3,FORML30                                                       
         B     FORML34                                                          
*                                                                               
FORML32  MVC   0(L'AC@PCTOE,R1),AC@PCTOE                                        
*                                                                               
FORML34  MVC   PSECOND+12(6),TRNREF                                             
         GOTO1 DATCON,DMCB,(1,TRNDATE),(8,PSECOND+1)                            
*                                                                               
FORMLX   XIT1                                                                   
         DROP  R2,R4,RB                                                         
*                                                                               
         LTORG                                                                  
         TITLE 'GET ADDRESS OF WORKCODE ELEMENT'                                
GETWC    DS    0D                                                               
         NMOD1 0,*GETWC*                                                        
         L     RC,0(,R1)                                                        
         L     R2,ADLEDGER                                                      
         AH    R2,DATADISP                                                      
*                                                                               
GETWC02  CLI   0(R2),0                                                          
         BE    GETWC06                                                          
         CLI   0(R2),WCOELQ        X'12' - WORK CODE ELEMENT                    
         BNE   GETWC04                                                          
         USING WCOELD,R2                                                        
         CLC   WCOCODE,SVANAL                                                   
         BE    GETWC08                                                          
*                                                                               
GETWC04  SR    R3,R3                                                            
         IC    R3,1(,R2)                                                        
         AR    R2,R3                                                            
         B     GETWC02                                                          
*                                                                               
GETWC06  SR    R2,R2                                                            
*                                                                               
GETWC08  ST    R2,AWCEL                                                         
*                                                                               
GETWCX   XIT1                                                                   
         DROP  R2,RB                                                            
*                                                                               
         LTORG                                                                  
         TITLE 'FIND/ADD/UPDATE GDAEL ELEMENTS FOR BILLING'                     
BILLE    DS    0D                                                               
         NMOD1 0,*BILLE*                                                        
         L     RC,0(,R1)                                                        
         USING TRNELD,R2                                                        
         CLI   TRNBTYPE,TRNBTMAN   ONLY UPDATE MANUAL, SPECIAL & %EST.          
         BE    BILLE02                                                          
         CLI   TRNBTYPE,TRNBTPER                                                
         BE    BILLE02                                                          
         CLI   TRNBTYPE,TRNBTSPE                                                
         BNE   BILLEX                                                           
*                                                                               
BILLE02  SR    R1,R1                                                            
         LR    R5,R2               R2 = ADTRANS                                 
*                                                                               
         USING GDAEL,R5                                                         
BILLE04  CLI   0(R5),0                                                          
         BE    BILLE10                                                          
         CLI   0(R5),GDAELQ        DO WE HAVE A DATE ELEMENT?                   
         BE    BILLE08             YES                                          
*                                                                               
BILLE06  IC    R1,1(R5)            KEEP LOOKING                                 
         AR    R5,R1                                                            
         B     BILLE04                                                          
*                                                                               
BILLE08  CLI   GDATYPE,GDATBILL    FIND RIGHT TYPE                              
         BNE   BILLE06                                                          
         OC    GDADATE2,GDADATE2   DO WE HAVE AN UNBILL DATE?                   
         BNZ   BILLE06             YES, CHECK THE REST                          
         B     BILLEX              NO, CAN'T BILL IT THEN                       
*                                                                               
BILLE10  LA    R5,WORK             OK, ADD A NEW ELEMENT                        
         XC    WORK,WORK                                                        
         MVI   GDAEL,GDAELQ                                                     
         MVI   GDALN,GDALN2Q                                                    
         MVI   GDATYPE,GDATBILL                                                 
         GOTO1 DATCON,DMCB,(2,TODAY2),(1,GDADATE)                               
         LR    RF,R3               PASS ADDRESS OF RECORD                       
         BAS   RE,ADDEL2                                                        
         MVI   MODE,WRITRANS                                                    
*                                                                               
BILLEX   XIT1                                                                   
*                                                                               
         USING ACMD,R2                                                          
ADDEL2   NTR1                                                                   
         L     R2,AMONACC                                                       
         GOTO1 ACMVHELO,DMCB,(C'P',FILNME),(RF),WORK                            
         CLI   DMCB+12,X'00'                                                    
         XIT1                      JUST GO BACK, EVEN IF NOT ADDED              
         DROP  R2,R5,RB                                                         
*                                                                               
         LTORG                                                                  
         TITLE 'FIND/ADD/UPDATE GDAEL ELEMENTS FOR UNBILLING'                   
UBILLE   DS    0D                                                               
         NMOD1 0,*UBILLE*                                                       
         L     RC,0(,R1)                                                        
         USING TRNELD,R2                                                        
         CLI   TRNBTYPE,TRNBTMAN   ONLY UPDATE MANUAL, SPECIAL & %EST.          
         BE    UNBILL02                                                         
         CLI   TRNBTYPE,TRNBTPER                                                
         BE    UNBILL02                                                         
         CLI   TRNBTYPE,TRNBTSPE                                                
         BNE   UNBILLX                                                          
*                                                                               
UNBILL02 SR    R1,R1                                                            
         LR    R5,R2               R2 = ADTRANS                                 
*                                                                               
         USING GDAEL,R5                                                         
UNBILL04 CLI   0(R5),0                                                          
         BE    UNBILLX             NOT MARKED USED, CAN'T MARK UNUSED           
         CLI   0(R5),GDAELQ        DO WE HAVE A DATE ELEMENT?                   
         BE    UNBILL08            YES                                          
*                                                                               
UNBILL06 IC    R1,1(R5)            KEEP LOOKING                                 
         AR    R5,R1                                                            
         B     UNBILL04                                                         
*                                                                               
UNBILL08 CLI   GDATYPE,GDATBILL    FIND RIGHT TYPE                              
         BNE   UNBILL06                                                         
         CLC   GDADATE,OBDATP      FIND THIS BILLING                            
         BNE   UNBILL06            YES, CHECK THE REST                          
         OC    GDADATE2,GDADATE2   IS IT ALREADY UNBILLED?                      
         BNZ   UNBILL06            YES                                          
         GOTO1 DATCON,DMCB,(2,TODAY2),(1,GDADATE2)                              
         MVI   MODE,WRITRANS                                                    
*                                                                               
UNBILLX  XIT1                                                                   
         DROP  R2,R5,RB                                                         
*                                                                               
         LTORG                                                                  
         TITLE 'AC21 - PRODUCT SUMMARY'                                         
PSUMR    DS    0D                                                               
         NMOD1 0,*PSUMR                                                         
         L     RC,0(R1)                                                         
         TM    CLIOPT,PROSUM                                                    
         BZ    PROS12                                                           
         MVC   PAGE,=H'1'                                                       
         MVI   FORCEHED,C'Y'                                                    
         MVI   RCSUBPRG,1                                                       
         TM    RUNOPT,NEEDGST      ARE WE DOING GST LOGIC?                      
         BZ    *+8                 NO                                           
         MVI   RCSUBPRG,14         YES, CHANGE HEADING                          
*                                                                               
         USING SUMD,R5                                                          
         LA    R5,BUFWK                                                         
         XC    SUMKEY(SUMLNQ),SUMKEY                                            
         MVI   SUMTYPE,SUMTYPE1                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),1                           
         TM    DMCB+8,X'80'                                                     
         BO    PROS12                                                           
         CLI   SUMTYPE,SUMTYPE1                                                 
         BNE   PROS12                                                           
*                                                                               
PROS02   MVC   MEDIA,SUMMED                                                     
         MVC   LASTMED,MEDIA                                                    
         GOTO1 SHR,DMCB,('SUBRMED',(RC))                                        
         L     R2,AMEL             ADDRESS OF MEDIA ELEMENT                     
         USING PMDELD,R2                                                        
*                                                                               
         MVC   MID1+1(12),PMDDESC    MEDIA NAME                                 
         GOTO1 UNDERLIN,DMCB,(12,MID1+1),MID2+1                                 
         MVI   FORCEMID,C'Y'                                                    
*                                                                               
PROS04   MVC   P+1(6),SUMJOB                                                    
         MVC   P+8(9),SUMOTH                                                    
         MVC   P+28(10),SUMBILNO                                                
         MVC   TEMPWK,SUMACCUM                                                  
         GOTO1 SHR,DMCB,('SUBRSUM',(RC))                                        
         BAS   RE,PRODPRT                                                       
*                                                                               
PROS06   MVI   BYTE,SUMTYPE1                                                    
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),1                         
         TM    DMCB+8,X'80'                                                     
         BO    PROS12                                                           
         CLI   SUMCLI,X'FF'                                                     
         BE    PROS08              MEDIA TOTAL                                  
         CLI   SUMMED,X'FF'                                                     
         BE    PROS10              PRODUCT TOTALS                               
         CLC   LASTMED,SUMMED                                                   
         BNE   PROS02              CHANGE OF MEDIA/PRINT MIDLINES               
         B     PROS04                                                           
*                                                                               
PROS08   BAS   RE,PRODPRT                                                       
         MVC   P+1(L'AC@TFOR),AC@TFOR           MEDIA                           
         MVC   P+1+L'AC@TFOR+1(12),PMDDESC                                      
         MVC   TEMPWK,SUMACCUM                                                  
         GOTO1 SHR,DMCB,('SUBRSUM',(RC))                                        
         MVI   SPACING,2                                                        
         BAS   RE,PRODPRT                                                       
         B     PROS06                                                           
*                                                                               
PROS10   MVC   MID1,SPACES                                                      
         MVC   MID2,SPACES                                                      
         MVI   FORCEMID,C'N'                                                    
         MVC   TEMPWK,SUMACCUM                                                  
         GOTO1 SHR,DMCB,('SUBRSUM',(RC))                                        
         MVC   P+1(L'AC@TPRO),AC@TPRO                                           
         BAS   RE,PRODPRT                                                       
*                                                                               
PROS12   MVI   FORCEMID,C'N'                                                    
         MVI   RCSUBPRG,0                                                       
         MVI   BYTE,SUMTYPE1                                                    
         GOTO1 BUFFALO,DMCB,=C'ADD',(BYTE,ABUFF),1,(X'80',2)                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),(X'80',1)                    
*                                                                               
PROSX    XIT1                                                                   
         DROP  R2,R5                                                            
*                                                                               
PRODPRT  NTR1                                                                   
         MVC   HEAD4+55(L'AC@PRO),AC@PRO                                        
         MVC   HEAD4+55+L'AC@PRO+1(3),PRDCODE+6                                 
         MVC   HEAD4+69(19),SPACES                                              
         MVC   HEAD5+69(17),SPACES                                              
         LA    R3,HEAD4+69                                                      
         GOTO1 CHOPPER,DMCB,(36,PRDNAME),(19,(R3)),(C'P',2)                     
         MVC   HEAD4+1(L'AC@CLINT),AC@CLINT                                     
         MVC   HEAD4+8(3),CLICODE+3                                             
         MVC   HEAD4+15(36),CLINAME                                             
         GOTO1 ACREPORT                                                         
         B     PROSX                                                            
         DROP  RB                                                               
         EJECT                                                                  
         LTORG                                                                  
         TITLE 'AC21 - CLIENT SUMMARY'                                          
CSUMR    DS    0D                                                               
         NMOD1 0,*CSUMR                                                         
         L     RC,0(R1)                                                         
         TM    CLIOPT,CLISUM                                                    
         BZ    CLIS12                                                           
         MVC   PAGE,=H'1'                                                       
         MVI   FORCEHED,C'Y'                                                    
         MVI   RCSUBPRG,1                                                       
         TM    RUNOPT,NEEDGST      ARE WE DOING GST LOGIC?                      
         BZ    *+8                 NO                                           
         MVI   RCSUBPRG,14         YES, CHANGE HEADING                          
*                                                                               
         USING SUMD,R5                                                          
         LA    R5,BUFWK                                                         
         XC    SUMKEY(SUMLNQ),SUMKEY                                            
         MVI   SUMTYPE,SUMTYPE1                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),2                           
         TM    DMCB+8,X'80'                                                     
         BO    CLIS12                                                           
         CLI   SUMTYPE,SUMTYPE1                                                 
         BNE   CLIS12                                                           
*                                                                               
CLIS02   MVC   MEDIA,SUMMED                                                     
         MVC   LASTMED,MEDIA                                                    
         GOTO1 SHR,DMCB,('SUBRMED',(RC))                                        
         L     R2,AMEL             ADDRESS OF MEDIA ELEMENT                     
*                                                                               
         USING PMDELD,R2                                                        
         MVC   MID1+1(12),PMDDESC    MEDIA NAME                                 
         GOTO1 UNDERLIN,DMCB,(12,MID1+1),MID2+1                                 
         MVI   FORCEMID,C'Y'                                                    
*                                                                               
CLIS04   MVC   P+1(3),SUMPRD                                                    
         MVC   P+4(6),SUMJOB                                                    
         MVC   P+11(9),SUMOTH                                                   
         MVC   P+28(10),SUMBILNO                                                
         MVC   TEMPWK,SUMACCUM                                                  
         GOTO1 SHR,DMCB,('SUBRSUM',(RC))                                        
         BAS   RE,CLIPRT                                                        
*                                                                               
CLIS06   MVI   BYTE,SUMTYPE1                                                    
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),2                         
         TM    DMCB+8,X'80'                                                     
         BO    CLIS12                                                           
         CLI   SUMCLI,X'FF'                                                     
         BE    CLIS08              MEDIA TOTAL                                  
         CLI   SUMMED,X'FF'                                                     
         BE    CLIS10              CLIENT TOTAL                                 
         CLC   LASTMED,SUMMED                                                   
         BNE   CLIS02                                                           
         B     CLIS04                                                           
*                                                                               
CLIS08   BAS   RE,CLIPRT                                                        
         MVC   P+1(L'AC@TFOR),AC@TFOR           MEDIA                           
         MVC   P+1+L'AC@TFOR+1(12),PMDDESC                                      
         MVC   TEMPWK,SUMACCUM                                                  
         GOTO1 SHR,DMCB,('SUBRSUM',(RC))                                        
         MVI   SPACING,2                                                        
         BAS   RE,CLIPRT                                                        
         B     CLIS06                                                           
*                                                                               
CLIS10   MVC   MID1,SPACES                                                      
         MVC   MID2,SPACES                                                      
         MVI   FORCEMID,C'N'                                                    
         MVC   TEMPWK,SUMACCUM                                                  
         GOTO1 SHR,DMCB,('SUBRSUM',(RC))                                        
         MVC   P+1(L'AC@TCLI),AC@TCLI                                           
         BAS   RE,CLIPRT                                                        
*                                                                               
CLIS12   MVI   FORCEMID,C'N'                                                    
         MVI   RCSUBPRG,0                                                       
         MVI   BYTE,SUMTYPE1                                                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),1,(X'80',2)                  
*                                                                               
CLISX    XIT1                                                                   
         DROP  R2,R5                                                            
*                                                                               
CLIPRT   NTR1                                                                   
         MVC   HEAD4+1(L'AC@CLINT),AC@CLINT                                     
         MVC   HEAD4+8(3),CLICODE+3                                             
         MVC   HEAD4+15(36),CLINAME                                             
         GOTO1 ACREPORT                                                         
         B     CLISX                                                            
         DROP  RB                                                               
         EJECT                                                                  
         LTORG                                                                  
         TITLE 'AC21 - WARNING MESSAGES'                                        
***********************************************************************         
*              ADD WARNING MESSAGE TO SORT                            *         
*              R3=A(WARNRSNS)                                                   
*              R4=A(REASON EQUATES)                                   *         
***********************************************************************         
*                                                                               
         USING EXCD,R5                                                          
WARNR    DS    0D                                                               
         NMOD1 0,*WARNR                                                         
         L     RC,0(R1)                                                         
         L     R3,4(R1)                                                         
         L     R4,8(R1)                                                         
         L     R5,AEXCRWK          GENERATE SORT RECORD FOR REPORT              
         LA    R1,EXCRLNQ                                                       
         SLL   R1,16                                                            
         ST    R1,EXCRLN                                                        
*                                                                               
         MVI   EXCRTYP,EXCREQU                                                  
         MVC   EXCRSTUD,SVSTUD     STUDIO TYPE                                  
         MVC   EXCRSACC,JOBCODE+3  STUDIO JOB                                   
*                                                                               
         MVC   EXCRDATE,DATE3      DATE                                         
         MVC   EXCRAJOB,SVAGACC    AGENCY JOB                                   
         MVC   EXCRMSG,SPACES                                                   
         MVC   EXCRBILL(7),SHTBILNO                                             
*                                                                               
         LA    R0,L'WARNRSNS                                                    
WARN02   CLI   0(R3),0             WARNING MESSAGE ASSIGNED?                    
         BNE   WARN06              YES FIND IT                                  
*                                                                               
WARN04   LA    R3,1(R3)            CHECK NEXT BYTE                              
         BCT   R0,WARN02                                                        
         B     WARN12                                                           
*                                                                               
WARN06   LR    R1,R4                                                            
*                                                                               
WARN08   CLC   0(1,R1),0(R3)       GET THE REASON                               
         BE    WARN10                                                           
         CLI   0(R1),X'FF'         END OF TABLE?                                
         BE    WARN12              NO MESSAGE                                   
         SR    R2,R2                                                            
         IC    R2,1(R1)                                                         
         LA    R1,2(R2,R1)                                                      
         B     WARN08                                                           
*                                                                               
WARN10   SR    R2,R2                                                            
         IC    R2,1(R1)                                                         
         BCTR  R2,0                                                             
         EX    R2,*+8                                                           
         B     *+10                                                             
         MVC   EXCRMSG(0),2(R1)                                                 
*                                                                               
WARN12   GOTO1 ADSORTER,DMCB,=C'PUT',(R5)                                       
         MVI   ALSORT,1                                                         
*                                                                               
WARNX    XIT1                                                                   
         DROP  RB                                                               
*                                                                               
         LTORG                                                                  
         TITLE 'AC21 - GET BILL NUMBER AND DATE FOR UNBILLING'                  
         USING TRNRECD,R3                                                       
BILLN    DS    0D                                                               
         NMOD1 0,*BILL*                                                         
         L     RC,0(R1)                                                         
         L     R3,AIO2                                                          
         L     R4,ADACC                                                         
         MVC   TRNKEY,SPACES                                                    
         MVC   TRNKCULA,0(R4)                                                   
         MVC   TRNKWORK,=C'99'                                                  
*                                                                               
         MVC   SAVEKEY,TRNKEY                                                   
         GOTO1 DATAMGR,DMCB,DMRDHI,FILNME,(R3),(R3)                             
*                                                                               
BILLN02  CLC   TRNKCULA(TRNKCULC-TRNRECD),SAVEKEY                               
         BNE   BILLXNO             CAN'T UNBILL WHAT I CAN'T FIND               
         CLC   TRNKREF,QSELECT                                                  
         BNE   BILLN04                                                          
         GOTO1 DATCON,DMCB,(1,TRNKDATE),(2,WORK)                                
         CLC   WORK(2),END2                                                     
         BNE   BILLN04                                                          
         B     BILLN06                                                          
*                                                                               
BILLN04  GOTO1 DATAMGR,DMCB,DMRSEQ,FILNME,(R3),(R3)                             
         B     BILLN02                                                          
*                                                                               
BILLN06  LR    R2,R3                                                            
         AH    R2,DATADISP                                                      
         CLI   0(R2),X'44'                                                      
         BNE   BILLXNO                                                          
*                                                                               
         USING TRNELD,R2                                                        
         MVC   BILLNAME,=CL15'PROGRESSIVE'                                      
         MVI   BILLTYPE,PROG                                                    
         CLI   TRNNARR,C'P'                                                     
         BE    BILLN18                                                          
         MVC   BILLNAME,=CL15'TOTAL BILL'                                       
         MVI   BILLTYPE,TOTAL                                                   
         CLI   TRNNARR,C'T'                                                     
         BE    BILLN18             MUST BE PROGRESSIVE /  TOTAL                 
         MVC   BILLNAME,=CL15'ONE-LINE BILL'  OR  ONE-LINE                      
         MVI   BILLTYPE,ONELNE+TOTAL                                            
         CLI   TRNNARR,C'O'                                                     
         BE    BILLN18                                                          
         LA    R0,8                                                             
         LA    R1,TRNNARR+1                                                     
         LA    R5,1                                                             
*                                                                               
BILLN08  CLC   0(4,R1),=C'PC E'    PC ESTIMATE CONSTANT                         
         BE    BILLN10                                                          
         LA    R1,1(R1)           R1 TO NEXT TRNNARR BYTE                       
         LA    R5,1(R5)           COUNT NUMBER OF PRECEEDING CHARACTERS         
         BCT   R0,BILLN08                                                       
         B     BILLN04             LOOK FOR ANOTHER BILL                        
*                                                                               
BILLN10  GOTO1 CASHVAL,DMCB,TRNNARR,(R5)                                        
         CLI   DMCB,X'FF'                                                       
         BE    BILLN04                                                          
         MVC   PEREST,DMCB+4                                                    
         MVC   BILLNAME,TRNNARR                                                 
         MVI   BILLTYPE,ESTIM                                                   
         LR    R3,R2                                                            
         L     RF,AESTPOOL                                                      
         MVI   0(RF),0                                                          
*                                                                               
BILLN12  ZIC   R1,1(R3)            FIND ESTIMATE ELEMENTS                       
         AR    R3,R1               ADD TO ESTIMATE POOL                         
         CLI   0(R3),0                                                          
         BE    BILLN16             END OF ELEMENTS                              
         CLI   0(R3),X'35'                                                      
         BE    BILLN14                                                          
         CLI   0(R3),X'B2'                                                      
         BNE   BILLN12                                                          
*                                                                               
BILLN14  ZIC   R1,1(R3)                                                         
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RF),0(R3)       ELEMENT TO ESTPOOL                           
         LA    RF,1(R1,RF)         NEXT AREA IN POOL                            
         MVI   0(RF),0                                                          
         B     BILLN12             GET NEXT ELEMENT                             
*                                                                               
BILLN16  L     R3,AIO2             RELOAD REGISTER 3                            
*                                                                               
BILLN18  OC    TRN2DAY,TRN2DAY                                                  
         BZ    BILLXNO             AS OF 4/12/82 THIS FIELD HAS DATE            
*                                  THE BILLING WAS ACTUALLY RUN                 
         MVC   OBDATE,TRN2DAY      SAVE THE ORIGINAL BILL DATE                  
         GOTO1 DATCON,DMCB,(2,OBDATE),(1,OBDATP)                                
*                                                                               
         TM    BILLMODE,RERUN                                                   
         BO    BILLN26                                                          
*                                                                               
         OC    TRNUNBIL,TRNUNBIL   IF UNBILLED DATE NOT ZERO                    
         BNZ   BILLXNO             IT WAS ALREADY UNBILLED - SKIP IT            
         LR    R4,R2               SAVE WHERE WE ARE                            
*                                                                               
         USING ACMD,R5                                                          
         L     R5,AMONACC                                                       
         GOTO1 ACMAPRAT,DMCB,(X'C0',(R3)),ADGOBLOC,ADCOMFAC,0,         X        
               ACMAPROB,ACMAPRO2                                                
*                                                                               
         L     R5,ACMAPRO2                                                      
BILLN20  CLI   0(R5),PTAELQ                                                     
         BE    BILLN22                                                          
         CLI   0(R5),0                                                          
         BE    BILLN24                                                          
         SR    RF,RF                                                            
         IC    RF,1(R5)                                                         
         AR    R5,RF                                                            
         B     BILLN20                                                          
*                                                                               
         USING PTAELD,R5                                                        
BILLN22  TM    PTASTAT1,PTASREVS   IS THIS AN UNBILLING?                        
         BO    BILLXNO             YES, CAN'T UNBILL IT                         
         TM    PTASTAT2,PTASRETB   IS THIS SECONDARY RETAIL POSTING?            
         BO    BILLXNO             YES, CAN'T UNBILL IT                         
*                                                                               
BILLN24  LR    R2,R4               RESTORE REGISTER                             
         USING TRNELD,R2                                                        
         MVC   TRNUNBIL,TODAY2     UNBILLED TODAY                               
         OI    PTASTAT1,PTASREVU   MARK 77 UNBILLED                             
         CLI   RCWRITE,C'N'                                                     
         BE    BILLN28                                                          
         GOTO1 DATAMGR,DMCB,DMWRT,FILNME,(R3),(R3)                              
         B     BILLN28                                                          
*                                                                               
BILLN26  CLC   TRNUNBIL,TODAY2     IF RERUN UNBILL DATE                         
         BNE   BILLXNO             MUST BE TODAY                                
*                                                                               
BILLN28  MVC   USEDATE,TRN2DAY                                                  
         OC    TRNBTYPE,TRNBTYPE   DO WE HAVE A BILL TYPE?                      
         BZ    *+10                NO                                           
         MVC   BILLCODE,TRNBTYPE   YES, USE IT                                  
         MVC   USEBILL,WORK        SAVE BILL DATE ALSO                          
         OC    TRNQTFLT,TRNQTFLT                                                
         BZ    *+10                                                             
         MVC   QTRNSFLT,TRNQTFLT     USE SAME FILTER FOR WORK CODE              
         CLI   QOPT1,C'Y'                                                       
         BNE   BILLXYES                                                         
         PACK  BILLNO,QSELECT+2(4) USE OLD NUMBER                               
         MVC   BILLREF,QSELECT                                                  
         OI    BILLOPT,OLDNUM                                                   
         B     BILLXYES                                                         
*                                                                               
BILLXNO  XC    USEDATE,USEDATE                                                  
         B     BILLXIT                                                          
*                                                                               
BILLXYES BAS   RE,OLDB7            BUILD TABLE OF PREVIOUS B7'S                 
         BAS   RE,CKCYCLE          CHECK IF UNBILLING CORRECT CYCLE             
         BE    BILLXNO             DO NOT ALLOW UNBILLING                       
*                                                                               
BILLXIT  MVC   TRNKEY,SPACES                                                    
         MVC   TRNKCULA,0(R4)                                                   
         MVC   KEYSAVE,TRNKCULA    READ ACCOUNT                                 
         XIT1                                                                   
         DROP  R2,R3,R5                                                         
         EJECT                                                                  
***********************************************************************         
*              READ CYCLE RECORD AND VERIFY UNBILLING LAST ITEM       *         
***********************************************************************         
*                                                                               
         USING JCBRECD,R4                                                       
         USING GOBLOCKD,R5                                                      
CKCYCLE  NTR1                                                                   
         L     R4,ACOMBUF                                                       
         L     R5,ADGOBLOC                                                      
         CLI   GOBILTYP,C'A'       DO FOR AUTO BILLTYPES ONLY                   
         BNE   CKCYCLX                                                          
         XC    PEREST,PEREST                                                    
         XC    JCBKEY,JCBKEY                                                    
         MVI   JCBKTYP,JCBKTYPQ                                                 
         MVI   JCBKSUB,JCBKSUBQ                                                 
         MVC   JCBKCUL,GOSELCUL                                                 
         MVC   JCBKCLI,GOSELCLI                                                 
         MVC   JCBKPRO,GOSELPRO                                                 
         MVC   JCBKJOB,GOSELJOB                                                 
*                                                                               
         GOTO1 DATAMGR,DMCB,DMREAD,FILNME,(R4),(R4)                             
         CLI   DMCB+8,0            FIND IT ?                                    
         BNE   CKCYCLN             NO                                           
         AH    R4,DATADISP                                                      
*                                                                               
CKCYCL2  CLI   0(R4),0             END OF RECORD ?                              
         BE    CKCYCLN             YES, ERROR                                   
         CLI   0(R4),BCYELQ        CYCLE ELEMENT ?                              
         BE    CKCYCL6             YES                                          
*                                                                               
CKCYCL4  SR    R0,R0               KEEP LOOKING                                 
         IC    R0,1(R4)                                                         
         AR    R4,R0                                                            
         CLI   0(R4),BCYELQ        MORE B8'S ?                                  
         BNE   CKCYCL7             NO                                           
*                                                                               
         USING BCYELD,R4                                                        
CKCYCL6  OC    BCYBILD,BCYBILD     WAS THIS ONE BILLED ?                        
         BNZ   CKCYCL4             YES, LOOK AT NEXT ONE                        
*                                                                               
CKCYCL7  SR    R4,R0               NO, GET PREVIOUS ONE                         
         CLI   0(R4),BCYELQ        ARE WE STILL AT A B8 ELEMENT ?               
         BE    *+6                 YES                                          
         AR    R4,R0               NO, GET BACK TO FIRST ELEMENT                
         CLC   BCYREF,QSELECT      RIGHT BILL NUMBER ?                          
         BNE   CKCYCLN             NO, CAN'T UNBILL                             
         CLC   OBDATE,BCYBILD      YES, RIGHT BILL DATE ?                       
         BNE   CKCYCLN             NO, CAN'T UNBILL                             
         MVC   BCYUNBD,TODAY2      YES, SET UNBILL DATE                         
         XC    BCYBILD,BCYBILD     CLEAR BILL DATE                              
         CLI   RCWRITE,C'N'        WRITING TO THE FILE ?                        
         BE    CKCYCL8             NO                                           
         L     R4,ACOMBUF                                                       
         GOTO1 DATAMGR,DMCB,DMWRT,FILNME,(R4),(R4)                              
*                                                                               
CKCYCL8  LTR   R0,R0               SET RETURN CODE                              
         B     CKCYCLX                                                          
*                                                                               
CKCYCLN  SR    R0,R0                                                            
*                                                                               
CKCYCLX  XIT1                                                                   
         DROP  R4,R5                                                            
         EJECT                                                                  
***********************************************************************         
*              BUILD TABLE OF PREVIOUS B7 ELEMENTS                    *         
***********************************************************************         
*                                                                               
         USING TRNRECD,R3                                                       
OLDB7    NTR1                                                                   
         L     R3,AIO2                                                          
         L     R4,ADACC                                                         
         MVC   TRNKEY,SPACES                                                    
         MVC   TRNKCULA,0(R4)                                                   
         MVC   TRNKWORK,=C'99'                                                  
         L     RF,APREVB7          INDICATE NO PREVIOUS BILLING                 
         MVI   0(RF),X'FF'                                                      
*                                                                               
         MVC   SAVEKEY,TRNKEY                                                   
         GOTO1 DATAMGR,DMCB,DMRDHI,FILNME,(R3),(R3)                             
*                                                                               
OLDB702  CLC   TRNKEY(TRNKCULC-TRNRECD),SAVEKEY                                 
         BNE   OLDB7X              CAN'T UNBILL WHAT I CAN'T FIND               
         CLC   TRNKREF,QSELECT    LOOK FOR ONE WE ARE UNBILLING                 
         BNE   OLDB704                                                          
         GOTO1 DATCON,DMCB,(1,TRNKDATE),(2,WORK)                                
         CLC   WORK(2),END2                                                     
         BE    OLDB706                                                          
*                                                                               
OLDB704  GOTO1 DATAMGR,DMCB,DMRSEQ,FILNME,(R3),(R3)                             
         B     OLDB702                                                          
*                                                                               
OLDB706  LA    R2,TRNRECD+ACCORFST                                              
         CLI   0(R2),X'44'                                                      
         BNE   OLDB7X                                                           
*                                                                               
         USING INCELD,RF                                                        
OLDB708  SR    R1,R1                                                            
         IC    R1,1(R2)                                                         
         AR    R2,R1                                                            
         CLI   0(R2),0             END OF RECORD ?                              
         BE    OLDB7X              YES                                          
         CLI   0(R2),INCELQ        NO, INCOME ELEMENT ?                         
         BNE   OLDB708             NO, KEEP LOOKING                             
         L     RF,APREVB7                                                       
*                                                                               
OLDB710  CLI   0(RF),0             ENTRY NOT IN TABLE ?                         
         BE    OLDB714             YES, MOVE IT IN                              
         CLI   0(RF),X'FF'                                                      
         BE    OLDB714                                                          
         CLC   INCWRKC(2),INCWRKC-INCELD(R2)                                    
         BE    OLDB712             ALREADY THERE, ADD IT UP                     
         LA    RF,INCLN2Q(RF)      GET NEXT PLACE IN TABLE                      
         B     OLDB710             KEEP LOOKING                                 
*                                                                               
OLDB712  AP    INCAMNT,INCAMNT-INCELD(6,R2)                                     
         CLI   INCLN,INCLN2Q       CHECK LENGTH                                 
         BL    *+10                                                             
         AP    INCINAM,INCINAM-INCELD(6,R2)                                     
         B     OLDB708                                                          
*                                                                               
OLDB714  XC    INCEL(INCLN2Q),INCEL                                             
         SR    R1,R1                                                            
         IC    R1,1(R2)                                                         
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RF),0(R2)       MOVE ELEMENT TO B7 TABLE                     
         CLI   INCLN,INCLN2Q       NEW ELEMENT?                                 
         BE    OLDB716             YES                                          
         MVI   INCLN,INCLN2Q       NO, SET NEW LENGTH                           
         ZAP   INCINAM,=P'0'       INITIALIZE INCOME                            
*                                                                               
OLDB716  LA    RF,INCLN2Q(RF)      NEXT AREA IN TABLE                           
         MVI   0(RF),0             MARK END OF TABLE                            
         B     OLDB708                                                          
*                                                                               
OLDB7X   XIT1                                                                   
         DROP  R3,RB,RF                                                         
*                                                                               
         LTORG                                                                  
         TITLE 'AC21 - GET TAX RATES ROUTINE'                                   
         USING VTCD,R2                                                          
         USING SVTABD,R4                                                        
GETR     DS    0D                                                               
         NMOD1 0,*GETR*                                                         
         L     RC,0(R1)                                                         
         L     R2,AVATBUFF                                                      
         L     R4,ASVTABLE                                                      
         LA    R5,TAXNUM                                                        
         XC    SVGSTRAT,SVGSTRAT                                                
         XC    SVGSTIND,SVGSTIND                                                
         MVC   SVGSTACC,SPACES                                                  
         XC    SVPSTRAT,SVPSTRAT                                                
         XC    SVPSTIND,SVPSTIND                                                
         MVC   SVPSTACC,SPACES                                                  
*                                                                               
         TM    RUNOPT,NEEDGST      ARE WE DOING GST LOGIC?                      
         BZ    GETR10              NO, EXIT                                     
         OC    SVGSTCOD,SVGSTCOD   DO WE HAVE A GST CODE?                       
         BZ    GETR10              NO, CHECK PST                                
*                                                                               
GETR02   CLI   SVCODE,X'00'        NOTHING IN TABLE OR END                      
         BE    GETR06                                                           
         CLI   SVTYPE,C'G'         IS THIS A GST ENTRY?                         
         BNE   GETR04              NO, GET NEXT                                 
         CLC   SVGSTCOD,SVCODE     YES, DOES CODE MATCH?                        
         BNE   GETR04              NO, TRY NEXT                                 
         CLC   SVGSTDAT,SVDATE     YES, DOES DATE MATCH?                        
         BE    GETR08              YES                                          
*                                                                               
GETR04   LA    R4,SVTABLNQ(R4)                                                  
         BCT   R5,GETR02                                                        
         DC    H'0'                EXCEEDED TAXNUM                              
*                                                                               
GETR06   MVC   VTCTYPE,SVGSTCOD    PASS GST TYPE CODE                           
         MVC   VTCINVD,SVGSTDAT    CURRENT/ORIGINAL BILL DATE                   
         MVI   VTCACTN,VTCALOOK    LOOK FOR RATES                               
         XC    VTCPRV,VTCPRV       CLEAR PROVINCE CODE                          
         XC    VTCINDS,VTCINDS     CLEAR ERROR CODE                             
         MVC   VTCLANG,RCLANG                                                   
         GOTO1 VATICAN,(R2)                                                     
         TM    VTCINDS,VTCINA      IS TAX APPLICABLE ?                          
         BO    GETR10              NO                                           
         CLI   VTCERR,X'00'        YES, FIND TYPE ?                             
         BNE   GETR10              NO                                           
         MVC   SVRATE,VTCRATE      YES, PUT RATE,                               
         MVC   SVINDS,VTCINDS            DECIMALS                               
         MVC   SVACCT,VTCACT              ACCOUNT,                              
         MVC   SVCODE,SVGSTCOD             CODE                                 
         MVC   SVDATE,SVGSTDAT              AND EFFECTIVE DATE IN TABLE         
         MVI   SVTYPE,C'G'         SPECIFY GST                                  
*                                                                               
GETR08   MVC   SVGSTRAT,SVRATE     SAVE RATE/DECIMAL/ACCOUNT FOR                
         MVC   SVGSTIND,SVINDS                                                  
         MVC   SVGSTACC,SVACCT        POSTBUFF                                  
*                                                                               
GETR10   TM    RUNOPT,NEEDPST      DOING PST ALSO?                              
         BZ    GETRX               NO                                           
         OC    SVPSTCOD,SVPSTCOD   DO WE HAVE A PST CODE?                       
         BZ    GETRX               NO, EXIT                                     
         MVC   SVPSTNME,SPACES                                                  
*                                                                               
         L     R4,ASVTABLE                                                      
         LA    R5,TAXNUM                                                        
*                                                                               
GETR12   CLI   SVCODE,X'00'        NOTHING IN TABLE OR END                      
         BE    GETR16                                                           
         CLI   SVTYPE,C'P'         IS THIS A PST ENTRY?                         
         BNE   GETR14              NO, GET NEXT                                 
         CLC   SVPSTCOD,SVCODE     YES, DOES CODE MATCH?                        
         BNE   GETR14              NO, TRY NEXT                                 
         CLC   SVPSTDAT,SVDATE     YES, DOES DATE MATCH?                        
         BNE   GETR14              NO, TRY NEXT                                 
         CLC   SVPSTPRV,SVPROV     YES, DOES PROVINCE MATCH?                    
         BE    GETR18              YES                                          
*                                                                               
GETR14   LA    R4,SVTABLNQ(R4)                                                  
         BCT   R5,GETR12                                                        
         DC    H'0'                EXCEEDED TAXNUM                              
*                                                                               
GETR16   MVC   VTCTYPE,SVPSTCOD    PASS PST TYPE CODE                           
         MVC   VTCINVD,SVPSTDAT    CURRENT/ORIGINAL BILL DATE                   
         MVC   VTCPRV,SVPSTPRV     SET PROVINCE CODE                            
         XC    VTCINDS,VTCINDS     CLEAR ERROR CODE                             
         XC    VTCPRVD,VTCPRVD     CLEAR PROVINCE DESCRIPTION                   
         MVC   VTCLANG,RCLANG                                                   
         GOTO1 VATICAN,(R2)                                                     
         TM    VTCINDS,VTCINA      IS TAX APPLICABLE ?                          
         BO    GETRX               NO                                           
         CLI   VTCERR,X'00'        YES, FIND TYPE ?                             
         BNE   GETRX               NO                                           
*                                                                               
         MVC   SVNAME,VTCPRVD      YES, PUT NAME                                
         MVC   SVRATE,VTCRATE       RATE,                                       
         MVC   SVINDS,VTCINDS        DECIMALS                                   
         MVC   SVACCT,VTCACT          ACCOUNT                                   
         MVC   SVREG,VTCREG                                                     
         MVC   SVCODE,SVPSTCOD        CODE                                      
         MVC   SVPROV,SVPSTPRV         PROVINCE CODE                            
         MVC   SVDATE,SVPSTDAT          AND EFFECTIVE DATE IN TABLE             
         MVI   SVTYPE,C'P'         SPECIFY PST                                  
*                                                                               
GETR18   MVC   SVPSTRAT,SVRATE     SAVE RATE/DECIMALS/DATE/NAME                 
         MVC   SVPSTIND,SVINDS                                                  
         MVC   SVPSTACC,SVACCT        FOR POSTBUFF                              
         MVC   SVPSTNME,SVNAME                                                  
         MVC   SVPSTREG,SVREG                                                   
*                                                                               
GETRX    XIT1                                                                   
         DROP  R2,R4,RB                                                         
*                                                                               
         LTORG                                                                  
         TITLE 'AC21 - GET INCOME ACCOUNTS FOR ESTIMATES'                       
GETI     DS    0D                                                               
         NMOD1 0,*GETI*                                                         
         L     RC,0(R1)                                                         
         L     R3,AMONACC                                                       
         USING ACMD,R3                                                          
         L     R4,ADGOBLOC                                                      
         USING GOBLOCKD,R4                                                      
         MVC   GOSELWC,SVANAL                                                   
         MVC   GOAKEY,ACMALTN       A(LAST RECORD READ)                         
         GOTO1 GETOPT,DMCB,ADGOBLOC                                             
         XC    GOAKEY,GOAKEY                                                    
         XC    GOSELWC,GOSELWC                                                  
         USING GOXBLKD,R4                                                       
         L     R4,ACMAGOX                                                       
         MVC   SVWKCCR,GOINCCR     SAVE INCOME CREDIT ACCOUNT                   
         MVC   SVWKCDR,GOINCDR     SAVE INCOME DEBIT ACCOUNT                    
*                                                                               
GETIX    XIT1                                                                   
         DROP  R3,R4,RB                                                         
*                                                                               
         LTORG                                                                  
         TITLE 'AC21 - RECAP TAXES BY TYPE'                                     
RECR     DS    0D                                                               
         USING GSTD,R5                                                          
         NMOD1 0,*RECR*                                                         
         L     RC,0(R1)                                                         
         LR    R4,R6               SAVE A(TOTALS)                               
         ZAP   DUB,=P'0'                                                        
*                                                                               
         LA    R5,BUFWK            GET GST DETAILS                              
         XC    GSTKEY(GSTLNQ),GSTKEY                                            
         MVI   GSTTYPE,GSTTYPE5                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),1                           
         TM    DMCB+8,X'80'                                                     
         BO    RECAP10                                                          
*                                                                               
RECAP02  CLI   GSTTYPE,GSTTYPE5                                                 
         BNE   RECAP10             NOT A GST RECORD                             
*                                                                               
         USING JOBD,R6                                                          
         LA    R6,GSTACCUM                                                      
         CLI   GSTCODE,X'FF'       LOOKING FOR DETAIL RECORDS                   
         BE    RECAP08                                                          
*                                                                               
         CP    JOBGST,=P'0'        DO WE HAVE ANY GST ?                         
         BNE   RECAP06             YES                                          
*                                                                               
RECAP04  MVI   BYTE,GSTTYPE5                                                    
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),1                         
         TM    DMCB+8,X'80'                                                     
         BO    RECAP10                                                          
         B     RECAP02                                                          
*                                                                               
RECAP06  MVI   MYSPACE,1                                                        
         MVC   P+1(L'AC@VAT1),AC@VAT1                                           
         GOTO1 SHR,DMCB,('SUBRSHR',(RC))                                        
         AP    DUB,JOBGST                                                       
         B     RECAP04                                                          
*                                                                               
RECAP08  CP    DUB,=P'0'           DID WE PRINT ANYTHING?                       
         BE    RECAP10             NO                                           
         CLI   QOPT5,C'Y'          OPTION TO SUPPRESS NET/COMMISSION            
         BE    RECAP09                                                          
         CLI   PROF4,C'Y'                                                       
         BE    RECAP09                                                          
         CURED DUB,(11,P+41),2,MINUS=YES                                        
*                                                                               
RECAP09  CURED DUB,(11,P+73),2,MINUS=YES                                        
         MVI   MYSPACE,1                                                        
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
*                                                                               
RECAP10  TM    RUNOPT,NEEDPST      DOING PST LOGIC?                             
         BZ    RECAP26             NO                                           
         MVC   LASTNAME,SPACES                                                  
*                                                                               
         USING PSTD,R5                                                          
         ZAP   DUB1,=P'0'                                                       
         ZAP   DUB2,=P'0'          MORE THAN ONE KIND OF PST                    
         LA    R5,BUFWK            GET PST DETAILS                              
         XC    PSTKY(PSTLNQ),PSTKY                                              
         MVI   PSTTYPE,PSTTYPE7                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),1                           
         TM    DMCB+8,X'80'                                                     
         BO    RECAP26                                                          
*                                                                               
RECAP12  CLI   PSTTYPE,PSTTYPE7                                                 
         BNE   RECAP26             NOT A PST RECORD                             
*                                                                               
         USING JOBD,R6                                                          
         LA    R6,PSTACCUM                                                      
         CLI   PSTCODE,X'FF'       LOOKING FOR NAME PROVINCE TOTAL              
         BE    RECAP22                                                          
         CP    JOBPST,=P'0'        DO WE HAVE ANY PST ?                         
         BNE   RECAP16             YES                                          
*                                                                               
RECAP14  MVI   BYTE,PSTTYPE7                                                    
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),1                         
         TM    DMCB+8,X'80'                                                     
         BO    RECAP26                                                          
         B     RECAP12                                                          
*                                                                               
RECAP16  MVI   MYSPACE,1                                                        
         CLC   LASTNAME,PSTNAME                                                 
         MVC   LASTNAME,PSTNAME                                                 
         BE    RECAP20                                                          
         CP    DUB1,=P'0'          ANY DATA YET?                                
         BE    RECAP20             NO, FIRST TIME                               
         CLI   QOPT5,C'Y'          OPTION TO SUPPRESS NET/COMMISSION            
         BE    RECAP18                                                          
         CLI   PROF4,C'Y'                                                       
         BE    RECAP18                                                          
         CURED DUB1,(11,P+41),2,MINUS=YES                                       
*                                                                               
RECAP18  CURED DUB1,(11,P+73),2,MINUS=YES                                       
         MVI   MYSPACE,1                                                        
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
         ZAP   DUB1,=P'0'                                                       
*                                                                               
RECAP20  MVC   P+1(L'PSTNAME),PSTNAME                                           
         GOTO1 SHR,DMCB,('SUBRSHR',(RC))                                        
         AP    DUB1,JOBPST                                                      
         AP    DUB2,DUB1                                                        
         B     RECAP14                                                          
*                                                                               
RECAP22  CLI   QOPT5,C'Y'          OPTION TO SUPPRESS NET/COMMISSION            
         BE    RECAP24                                                          
         CLI   PROF4,C'Y'                                                       
         BE    RECAP24                                                          
         CURED DUB1,(11,P+41),2,MINUS=YES                                       
*                                                                               
RECAP24  CURED DUB1,(11,P+73),2,MINUS=YES                                       
         MVI   MYSPACE,1                                                        
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
*                                                                               
         USING RTLD,R5                                                          
RECAP26  L     R5,ARETAIL          SEE IF RETAIL                                
         LTR   R5,R5                                                            
         BZ    RECAPX              NO, OK TO EXIT NOW                           
*                                                                               
         CP    DUB,=P'0'           ANY GST TO ADJUST?                           
         BNE   RECAP28                                                          
         CP    DUB2,=P'0'          NO, ANY PST?                                 
         BE    RECAPX              NO, OK TO EXIT NOW                           
*                                                                               
RECAP28  SP    DUB,JOBGST-JOBD(L'JOBGST,R4)                                     
         SP    DUB2,JOBPST-JOBD(L'JOBPST,R4)                                    
*                                                                               
*                                        ADJUST TOTALS THAT CAME IN R6          
         AP    JOBGST-JOBD(L'JOBGST,R4),DUB                                     
         AP    JOBPNET-JOBD(L'JOBPNET,R4),DUB                                   
         AP    JOBPGRS-JOBD(L'JOBPGRS,R4),DUB                                   
         AP    JOBPST-JOBD(L'JOBPST,R4),DUB2                                    
         AP    JOBPNET-JOBD(L'JOBPNET,R4),DUB2                                  
         AP    JOBPGRS-JOBD(L'JOBPGRS,R4),DUB2                                  
*                                                                               
*                                        ADJUST RETAIL CHARGES                  
         LA    R4,RTLCHG                                                        
         AP    JOBGST-JOBD(L'JOBGST,R4),DUB                                     
         AP    JOBPNET-JOBD(L'JOBPNET,R4),DUB                                   
         AP    JOBPGRS-JOBD(L'JOBPGRS,R4),DUB                                   
         AP    JOBPST-JOBD(L'JOBPST,R4),DUB2                                    
         AP    JOBPNET-JOBD(L'JOBPNET,R4),DUB2                                  
         AP    JOBPGRS-JOBD(L'JOBPGRS,R4),DUB2                                  
*                                                                               
*                                        ADJUST RETAIL NET                      
         LA    R4,RTLNET                                                        
         AP    JOBGST-JOBD(L'JOBGST,R4),DUB                                     
         AP    JOBPNET-JOBD(L'JOBPNET,R4),DUB                                   
         AP    JOBPGRS-JOBD(L'JOBPGRS,R4),DUB                                   
         AP    JOBPST-JOBD(L'JOBPST,R4),DUB2                                    
         AP    JOBPNET-JOBD(L'JOBPNET,R4),DUB2                                  
         AP    JOBPGRS-JOBD(L'JOBPGRS,R4),DUB2                                  
*                                                                               
RECAPX   XIT1                                                                   
         DROP  R5,R6,RB                                                         
         TITLE 'AC21 - GET CURRENCY CODE'                                       
GETC     DS    0D                                                               
         NMOD1 0,*GETC*                                                         
         L     RC,0(R1)                                                         
*                                                                               
         LA    R1,CURTAB                                                        
GETC02   CLI   0(R1),0             END OF TABLE                                 
         BNE   *+6                                                              
         DC    H'0'                                                             
         CLC   CTRYCOD,0(R1)       MATCH ON COUNTRY CODE                        
         BE    *+12                                                             
         LA    R1,L'CURTAB(R1)                                                  
         B     GETC02                                                           
         MVC   CURCOD,1(R1)                                                     
*                                                                               
GETCX    XIT1                                                                   
*                                                                               
*                                                                               
CURTAB   DS    0XL4                                                             
       ++INCLUDE ACCURTAB                                                       
CURTABX  DC    AL1(0)                                                           
         DROP  RB                                                               
*                                                                               
         LTORG                                                                  
         TITLE 'AC21 - PRODUCTION BILLING - FILTERING ROUTINES'                 
FILTR    DS    0D                                                               
         NMOD1 0,*FILT*,RA                                                      
         L     RC,0(R1)                                                         
         L     R6,ADGOBLOC                                                      
         USING GOBLOCKD,R6                                                      
         MVC   SAVOTH,SPACES            OTHER NUMBER                            
         MVC   SVEA,SPACES                                                      
         MVC   SVAC,SPACES                                                      
         MVC   SVBI,SPACES                                                      
         MVC   SVBU,SPACES                                                      
         MVC   SVPRBLPR,SPACES                                                  
         MVC   SVAGYCOM,GOAGYCOM   SAVE COMMISSION RATE AT THIS LEVEL           
         MVC   SVGSTCOD,GOTAXCOD   SAVE GST, PST AND PROVINCE CODE              
         MVC   SVPSTCOD,GOPSTCOD        FOR SPECIAL BILLTYPE                    
         MVC   SVPSTPRV,GOPSTPRV                                                
         MVC   SVZERO,GOZERO       SAVE OPTION FOR GROSS BILLINGS               
         ZAP   GRSSEST,=P'0'                                                    
*                                                                               
         ZAP   SPECAMNT,=P'0'                                                   
         ZAP   ESTIMATE,=P'0'                                                   
         MVC   BILLINFO,SPACES                                                  
         XC    REASONS,REASONS                                                  
         XC    SPECRSNS,SPECRSNS                                                
*                                                                               
         MVC   TEMPTYPE,GOBILTYP   SAVE THE BILL TYPE                           
         CLC   GOBILTYP,=C'AUTO'   SPECIAL AUTO BILLTYPE ?                      
         BNE   *+8                 NO                                           
         BAS   RE,GTCYCLE          YES, GET THE CORRECT BILLTYPE                
*                                                                               
         L     R3,AMONACC                                                       
         USING ACMD,R3                                                          
         L     R5,ACMAJOBB                                                      
         USING JBLOCKD,R5                                                       
         MVC   JBAJOB,ADACC                                                     
         MVC   JBACOLS,ACMACOLL                                                 
         MVC   JBACOM,ADCOMFAC                                                  
         MVC   JBAGOBLK,ADGOBLOC                                                
         MVC   JBAIO,ACMAJOBI                                                   
         MVC   JBAKEY,LASTIO                                                    
         MVC   JBGETOPT,GETOPT                                                  
*                                                                               
         MVC   JBACOLTB,ACMACOL                                                 
         MVC   JBLCOLTB,ACMLCOL                                                 
         MVC   JBAOPVTB,ACMAOPV                                                 
         MVC   JBLOPVTB,ACMLOPV                                                 
         MVC   JBSELSCH,GOSCHEME                                                
*                                                                               
         MVI   JBSELFUN,JBGETDE    GET BO DETAILS                               
         MVC   JBORICLI,ACMAJCSP                                                
*                                                                               
         CLI   GOBILTYP,C'A'       SPECIAL AUTO BILL?                           
         BNE   EXTR00              NO                                           
         MVC   DUB(4),PEREST       YES, PASS AMOUNT WE WANT TO USE              
         L     RF,DUB                                                           
         CVD   RF,DUB                                                           
         ZAP   JBPEREST,DUB                                                     
*                                                                               
EXTR00   GOTO1 ACMAJOBR,DMCB,ACMAJOBB                                           
         CLI   JBERROR,X'00'                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R3,ACMACOL                                                       
         CLI   JBNEWEST,JBMCSQ     FOR MCS ESTIMATES SKIP                       
         BNE   EXTR01                                                           
         USING MJETABD,R3                                                       
         ZAP   GRSSEST,MJETVAL+6(6)                                             
         B     *+10                                                             
         USING JBCOLD,R3                                                        
EXTR01   ZAP   GRSSEST,JBCOLVAL+6(6)                                            
         DROP  R3,R5                                                            
*                                                                               
         MVC   GOAGYCOM,SVAGYCOM   RESTORE COMMISSION                           
         XC    GOSELWC,GOSELWC                                                  
*                                                                               
         L     R2,ADACC                                                         
         AH    R2,DATADISP                                                      
*                                                                               
         USING OTHELD,R2                                                        
EXTRACT  CLI   0(R2),X'23'              NUMBER ELEMENT                          
         BNE   EXTR02                                                           
         MVC   SAVOTH,OTHNUM                                                    
         B     EXTRNXT                                                          
*                                                                               
         USING PPRELD,R2                                                        
EXTR02   CLI   0(R2),X'24'              PROFILE ELEMENT                         
         BNE   EXTR04                                                           
         MVC   SVPRBLPR,PPRBILLP   SAVE PRINT ON BILLS                          
         OC    SVPRBLPR,SPACES                                                  
         B     EXTRNXT                                                          
*                                                                               
         USING JOBELD,R2                                                        
EXTR04   CLI   0(R2),X'26'     MUST REPLACE OF STATUS INFO IF RERUN             
         BNE   EXTR12                                                           
         TM    JOBSTA1,X'80'      TEST FOR UNAPPROVED ESTIMATE                  
         BZ    *+8                 ON IS UNAPPROVED                             
         OI    ESTOPT,UNAPP                                                     
         TM    JOBSTA1,JOBSXJOB   IS THIS AN X-JOB ?                            
         BZ    *+8                 NO                                           
         OI    JOBOPT,JOBX         YES, INDICATE SO                             
         TM    JOBSTA2,JOBSFUN    IS JOB FUNDED?                                
         BZ    *+8                 NO                                           
         OI    JOBOPT,FUNDED       YES, INDICATE SO                             
         CLI   GOBILTYP,C'E'       PERCENT OF ESTIMATE BILLS                    
         BNE   EXTRNXT                                                          
         LA    R3,GOBILAM1                                                      
         MVC   PEREST,0(R3)                                                     
         CLI   JOBLN,JOBLN3Q                                                    
         BL    EXTR10                                                           
         LA    R0,2                                                             
         LA    RE,X'80'                                                         
         EX    RE,*+8                                                           
         B     *+8                                                              
         TM    JOBBIST,X'00'                                                    
         BZ    EXTR08                                                           
*                                                                               
EXTR06   LA    R3,4(R3)                                                         
         OC    0(4,R3),0(R3)       IF NEXT CYCLE IS ZERO                        
         BZ    EXTR10              GET OUT                                      
*                                                                               
         SRL   RE,1                SET FOR NEXT PERCENT                         
         L     RF,0(R3)                                                         
         A     RF,PEREST                                                        
         ST    RF,PEREST                                                        
         EX    RE,*+8                                                           
         B     *+8                                                              
         TM    JOBBIST,X'00'                                                    
         BZ    EXTR08                                                           
         BCT   R0,EXTR06                                                        
         B     EXTR10                                                           
*                                                                               
EXTR08   EX    RE,*+8                                                           
         B     *+8                                                              
         OI    JOBBIST,X'00'                                                    
*                                                                               
EXTR10   TM    BILLMODE,RERUN                                                   
         BZ    EXTRNXT                                                          
         L     RF,ADACCSTA                                                      
         USING RSTELD,RF                                                        
         CLC   RSTPBILL,TODAY2     NOT BILLED TODAY                             
         BNE   EXTRNXT                                                          
         CLI   JOBF2BLB,0                                                       
         BE    *+10                NO SAVED VALUE FOR FILTER 2                  
         MVC   RSTFILT1+1(1),JOBF2BLB   REPLACE FILTER 2                        
         L     RF,ADPROFIL                                                      
         CLI   JOBBTBLB,0                                                       
         BE    EXTRNXT                                                          
         MVC   PPRBTYPE-PPRELD(L'PPRBTYPE,RF),JOBBTBLB                          
         B     EXTRNXT                                                          
*                                                                               
         USING ABIELD,R2                                                        
EXTR12   CLI   0(R2),X'27'         EXTRACT SPECIAL ELEMENTS                     
         BNE   EXTR14                                                           
         MVC   SVEA,ABIEANO                                                     
         MVC   SVAC,ABIACNO                                                     
         CLI   ABILN,X'48'       ANY SPECIAL BILL NO                            
         BL    EXTR14                                                           
         MVC   SVBI,ABIBINO                                                     
         CLI   ABILN,X'57'       ANY BUDGET MEMO                                
         BL    EXTR14                                                           
         MVC   SVBU,ABIBMEM                                                     
         B     EXTR14                                                           
*                                                                               
         USING LNKELD,R2                                                        
EXTR14   CLI   0(R2),LNKELQ                                                     
         BNE   EXTRNXT                                                          
         OC    LNKAGJB,LNKAGJB     DO WE HAVE AN AGENCY JOB?                    
         BNZ   EXTR16              YES                                          
         MVI   SPECRSN,ESSN04                                                   
         BAS   RE,FILTNOS                                                       
         B     EXTRNXT                                                          
*                                                                               
EXTR16   MVC   SVSTUD,LNKSTUD      SAVE THE TYPE AND THE AGENCY JOB             
         MVC   SVAGCUL,JOBCODE                                                  
         MVC   SVAGACC,LNKAGJB                                                  
         MVC   SVELEM,LNKEL        SAVE THE WHOLE ELEMENT                       
         OI    JOBOPT,JBSTUDIO                                                  
         B     EXTRNXT                                                          
*                                                                               
EXTRNXT  ZIC   R0,1(R2)                                                         
         AR    R2,R0                                                            
         CLI   0(R2),0                                                          
         BNE   EXTRACT                                                          
         DROP  RF,R2,R6                                                         
         EJECT                                                                  
*              ROUTINE TO EXTRACT EXTRA PROFILE INFO                            
*                                                                               
         MVI   CLIOPT,CLISUM+PROSUM+COMMISN+ESTREQ                              
         MVI   CLIOPT2,0                                                        
         MVI   EPRFILT2,0                                                       
         MVI   ESTTYPE,0                                                        
         MVI   WKCOPT,WKCDTLC+WKCDTL                                            
         OI    ESTOPT,NOESTDL      NO EST. DETAIL IS DEFAULT                    
*                                                                               
         USING GOBLOCKD,R6                                                      
         L     R6,ADGOBLOC                                                      
         CLI   GOCLISUM,C'N'                                                    
         BNE   *+8                                                              
         NI    CLIOPT,ALL-CLISUM                                                
*                                                                               
         CLI   GOBILDET,C'Y'                                                    
         BE    *+8                                                              
         NI    WKCOPT,ALL-WKCDTLC                                               
*                                                                               
         CLI   GOWCONES,C'N'       PRINT WORKCODE DETAIL?                       
         BE    EXTRN2              NO, ALREADY SET FOR THIS                     
         NI    ESTOPT,ALL-NOESTDL  YES, WE WANT SOME DETAIL                     
*                                                                               
         CLI   GOWCONES,C'C'                                                    
         BNE   *+8                                                              
         OI    ESTOPT,ESTCODE      WANT CODE ONLY                               
*                                                                               
         CLI   GOWCONES,C'B'                                                    
         BNE   *+8                                                              
         OI    ESTOPT,ESTBOTH      WANT CODE AND NAME                           
*                                                                               
EXTRN2   CLI   GOSUPAGY,C'Y'        PAY=NET AND SUPPRESS                        
         BNE   *+12                                                             
         OI    CLIOPT,PAYNET                                                    
         OI    CLIOPT,NOCOMM                                                    
*                                                                               
         CLI   GOESTCOM,C'Y'                                                    
         BE    *+8                                                              
         OI    ESTOPT,NOESTCM      NO COMM. ON ESTIMATE OR SPECIAL              
*                                                                               
         CLI   GOAUTOUN,C'Y'                                                    
         BNE   *+8                                                              
         OI    CLIOPT,UNHOLD       AUTO UNHOLD                                  
*                                                                               
         CLI   GOFILT2,0     FILTER 2 REPLACE VALUE FOR EP. REVERSE             
         BE    *+10                                                             
         MVC   EPRFILT2,GOFILT2                                                 
         CLI   GONEWBT,0          NEW BILL TYPE FOR %EST JOBS                   
         BE    *+10                                                             
         MVC   ESTTYPE,GONEWBT                                                  
*                                                                               
         CLI   GOPROSUM,C'N'                                                    
         BNE   *+8                                                              
         NI    CLIOPT,ALL-PROSUM                                                
*                                                                               
         CLI   GOFILT2,0     FILTER 2 REPLACE VALUE FOR EP. REVERSE             
         BE    *+10                                                             
         MVC   EPRFILT2,GOFILT2                                                 
*                                                                               
         CLI   GONEWBT,0          NEW BILL TYPE FOR %EST JOBS                   
         BE    *+10                                                             
         MVC   ESTTYPE,GONEWBT                                                  
*                                                                               
         CLI   GOFILT2,0     FILTER 2 REPLACE VALUE FOR EP. REVERSE             
         BE    *+10                                                             
         MVC   EPRFILT2,GOFILT2                                                 
*                                                                               
         CLI   GONEWBT,0          NEW BILL TYPE FOR %EST JOBS                   
         BE    *+10                                                             
         MVC   ESTTYPE,GONEWBT                                                  
*                                                                               
         ZAP   SMALL,=P'0'                                                      
         OC    GOMINBIL,GOMINBIL                                                
         BZ    *+10                                                             
         ZAP   SMALL,GOMINBIL                                                   
         ZAP   DUB,=P'0'                                                        
         OC    GOOVRPER,GOOVRPER   MAXIMUM OVER PERCENT                         
         BZ    *+10                                                             
         ZAP   DUB,GOOVRPER                                                     
         CVB   R3,DUB                                                           
         ST    R3,OVEREST                                                       
         ZAP   OVERAMT,=P'0'                                                    
         CP    GOOVRAMT,=P'0'      MAXIMUM OVER AMOUNT                          
         BE    *+10                                                             
         ZAP   OVERAMT,GOOVRAMT                                                 
*                                                                               
         CLI   GOPAYNET,C'Y'        PAY=NET                                     
         BNE   *+8                                                              
         OI    CLIOPT,PAYNET                                                    
         CLI   GONEEDES,C'N'                                                    
         BNE   *+8                                                              
         NI    CLIOPT,ALL-ESTREQ                                                
*                                                                               
         MVC   COMMAC,GOTBC                                                     
*                                                                               
         XC    RTLEDG(3),RTLEDG        DISTRIBUTION LEDGER AND SCHEME           
         CLI   GODIST,X'41'                                                     
         BL    EXTRP2                                                           
         TM    JOBOPT,JBSTUDIO     IS THIS A STUDIO JOB?                        
         BZ    *+12                NO                                           
         MVI   SPECRSN,ESSN05      YES, ERROR                                   
         BAS   RE,FILTNOS                                                       
         MVC   RTLEDG(3),GODIST                                                 
*                                                                               
EXTRP2   MVC   PREVOPT,GOSUP99S   SAVE OPTION TO SUPPRESS 99'S                  
         OC    PREVOPT,PREVOPT     DO WE HAVE ANY VALUE ?                       
         BNZ   *+10                YES, USE IT                                  
         MVC   PREVOPT,PROF8       NO, USE VALUE FROM CONTROL PROFILE           
*                                                                               
         MVC   DUEDAT,SVDUE                                                     
         MVC   DUE2,SVDUE2                                                      
         MVC   DUE6,SVDUE6                                                      
*                                                                               
         CLI   QBDAY,X'FF'         DO WE HAVE DUE DAYS FROM REQUEST?            
         BE    *+12                NO, SEE IF GETOP HAS ONE                     
         CLI   QBDAY,X'00'                                                      
         BNE   EXTRP4              YES, LEAVE IT ALONE THEN                     
*                                                                               
         ZIC   R3,GODUEDAY         NO, SEE IF GETOPT HAS ONE                    
         LTR   R3,R3                                                            
         BZ    EXTRP4                                                           
*                                                                               
         CH    R3,=H'10'           DEFAULT IS TEN DAYS                          
         BE    EXTRP4                                                           
*                                                                               
         GOTO1 DATCON,DMCB,(4,BILLDTE),(0,DUB)                                  
         GOTO1 ADDAY,DMCB,DUB,WORK,(R3)                                         
         GOTO1 DATCON,DMCB,(0,WORK),(8,DUEDAT)                                  
         GOTO1 DATCON,DMCB,(0,WORK),(2,DUE2)                                    
         MVC   DUE6,WORK                                                        
*                                                                               
         USING ACMD,R3                                                          
EXTRP4   L     R3,AMONACC                                                       
         USING GOXBLKD,R6                                                       
         L     R6,ACMAGOX                                                       
         MVC   SVJOBCR,GOINCCR     SAVE JOB LEVEL INCOME CREDIT ACCOUNT         
         MVC   SVJOBDR,GOINCDR     SAVE JOB LEVEL INCOME DEBIT ACCOUNT          
*                                                                               
         MVI   SVPBBIL,C'N'        DEFAULT IS NO POB                            
         MVC   SVPBPCT,GOPBPCT     GET POB OPTIONS                              
         MVC   SVPBACC,GOPBACC                                                  
         MVC   SVPBWRK,GOPBWRK                                                  
         MVC   SVPBWRKN,SPACES                                                  
*                                                                               
         MVC   COMMKEY,SPACES      YES, GET THE NAME                            
         MVC   COMMKEY(L'SVPBACC),SVPBACC                                       
         MVC   KEYSAVE,COMMKEY                                                  
         L     R2,ACOMBUF                                                       
         GOTO1 DATAMGR,DMCB,DMRDHI,FILNME,COMMKEY,(R2)                          
         CLC   KEYSAVE,0(R2)       FIND IT?                                     
         BE    EXTRP6              YES                                          
         XC    SVPBACC,SVPBACC     CLEAR ACCOUNT IF CAN'T BE FOUND              
         B     EXTRP8                                                           
*                                                                               
EXTRP6   LA    R3,SVPBNAM                                                       
         GOTO1 SHR,DMCB,('SUBRNAM',(RC))                                        
*                                                                               
EXTRP8   TM    JOBOPT,JBSTUDIO     IS THIS A STUDIO JOB?                        
         BZ    FILTERS             NO                                           
         MVC   SVBDB,GOBDB         YES, SAVE BILLING DEBIT ACCOUNT              
         MVC   SVICR,GOICR         AND INTERCO CREDIT ACCOUNT                   
         DROP  R3,R6                                                            
         EJECT                                                                  
*              APPLY FILTERS TO JOB                                             
*                                                                               
         USING ACMD,R3                                                          
FILTERS  L     R3,AMONACC                                                       
         USING JBCOLD,R4                                                        
         L     R4,ACMACOL                                                       
         USING JBLOCKD,R5                                                       
         L     R5,ACMAJOBB                                                      
         USING GOBLOCKD,R6                                                      
         L     R6,ADGOBLOC                                                      
         DROP  R3                                                               
*                                                                               
         BAS   RE,BLDSOFT          BUILD SOFT HEADLINES                         
*                                                                               
         CLI   PROF21,C'Y'         USE LONG NAMES?                              
         BNE   *+8                                                              
         OI    CLIOPT2,USELONG     YES                                          
*                                                                               
         CLI   QOPT4,C'Y'          SUPPRESS VENDOR NAME?                        
         BE    *+12                                                             
         CLI   PROF3,C'Y'                                                       
         BNE   FILT00                                                           
         MVI   RCSUBPRG,17         USE HEADING WITH IT                          
         CLI   PROF4,C'Y'          SUPPRESS NET AND COMMISSION                  
         BNE   *+8                 NO                                           
         MVI   RCSUBPRG,18         YES, CLEAR IT OUT                            
         B     FILT01                                                           
*                                                                               
FILT00   MVI   RCSUBPRG,0                                                       
         CLI   PROF4,C'Y'          SUPPRESS NET AND COMMISSION                  
         BNE   *+8                                                              
         MVI   RCSUBPRG,8                                                       
*                                                                               
FILT01   L     RF,ADACCSTA                                                      
         USING RSTELD,RF                                                        
         MVI   REASON,ERSN26                                                    
         TM    RSTSTAT,X'40'      IF CLOSED, PRINT MESSAGE AND EXIT             
         BZ    *+12                                                             
         BAS   RE,FILTNO                                                        
         B     FILT46                                                           
*                                                                               
         L     R2,ADACCBAL                                                      
         USING ABLELD,R2                                                        
         ZAP   DEBITS,ABLDR                                                     
*                                                                               
         MVI   REASON,ERSN31                                                    
         TM    JOBOPT,JOBX         IS THIS AN X-JOB ?                           
         BZ    *+8                 NO                                           
         BAS   RE,FILTNO           YES, CAN'T BILL                              
*                                                                               
         OC    SVPBPCT,SVPBPCT     ANY PERCENT OF BILLING?                      
         BZ    FILT01A             NO                                           
         CP    SVPBPCT,=P'0'       YES, IS IT ZERO?                             
         BE    FILT01A             YES                                          
*                                                                               
         MVI   REASON,ERSN37                                                    
         OC    SVPBACC,SVPBACC     NO, MUST HAVE A PB ACCOUNT?                  
         BNZ   *+8                 YES                                          
         BAS   RE,FILTNO           NO, CAN'T BILL                               
*                                                                               
         MVI   REASON,ERSN38                                                    
         OC    SVPBWRK,SVPBWRK     YES, DO WE HAVE A WORKCODE?                  
         BNZ   *+8                 YES                                          
         BAS   RE,FILTNO           NO, CAN'T BILL                               
         MVI   SVPBBIL,C'Y'        INDICATE DOING POB                           
*                                                                               
         USING PPRELD,R2                                                        
FILT01A  L     R2,ADPROFIL                                                      
         MVC   RECEIVBL,PPRRECV                                                 
         OC    SVBDB,SVBDB         DO WE HAVE A BILLING DEBIT ACCOUNT?          
         BZ    *+10                NO                                           
         MVC   RECEIVBL,SVBDB      YES, USE IT AS RECEIVABLE ACCOUNT            
         MVC   COSTING,PPRCOST                                                  
         LA    R3,BILLTAB                                                       
*                                                                               
         USING BILLTD,R3                                                        
FILT02   MVI   REASON,ERSN20                                                    
         CLI   BILLNME,X'FF'                                                    
         BNE   *+12                                                             
         BAS   RE,FILTNO                                                        
         B     FILT44                                                           
*                                                                               
         CLC   TEMPTYPE,BILLCDE                                                 
         BE    FILT03                                                           
         LA    R3,L'BILLEN(R3)                                                  
         B     FILT02                                                           
*                                                                               
FILT03   MVC   BILLNAME,BILLNME                                                 
         MVC   FCRDTRNS,BILLTRNS                                                
         MVC   FCRDEST,BILLEST                                                  
         MVC   BILLTYPE,BILLTYP                                                 
         MVC   BILLCODE,BILLCOD                                                 
         DROP  R3                                                               
*                                                                               
         CLC   QAPPL+6(2),SPACES   DO WE HAVE A CYCLE DATE ?                    
         BNH   FILT04              NO, CONTINUE ON                              
         CLC   GOBILTYP,=C'AUTO'   YES, IS THE BILLTYPE AUTO ?                  
         BE    FILT04              YES, OK                                      
         MVI   REASON,ERSN35                                                    
         BAS   RE,FILTNO           NO, DON'T BILL JOB                           
         B     FILT44                                                           
*                                                                               
FILT04   MVI   REASON,ERSN05                                                    
         CLI   BILLNAME,C'U'                                                    
         BNE   *+12                                                             
         BAS   RE,FILTNO           IF UNBILLABLE SKIP THE REST                  
         B     FILT44                                                           
*                                                                               
         MVI   REASON,ERSN09                                                    
         CLI   BILLNAME,C'C'                                                    
         BNE   *+8                                                              
         BAS   RE,FILTNO                                                        
*                                                                               
         MVI   REASON,ERSN10                                                    
         CLI   GONEEDES,C'Y'       DO WE NEED AN ESTIMATE ?                     
         BNE   FILT08              NO                                           
*                                                                               
         CLI   JBNEWEST,C'Y'       YES, IS THIS A NEW ESTIMATE ?                
         BE    FILT05              YES                                          
         CLI   JBNEWEST,JBMCSQ     NO, IS IT MCS?                               
         BNE   FILT06              NO                                           
*                                                                               
FILT05   CLI   GONEEDAE,C'Y'       NEED APPROVAL TO BILL ?                      
         BNE   FILT08              NO                                           
         OC    JBHIAPP,JBHIAPP     YES, ANY ESTIMATES APPROVED ?                
         BNZ   FILT08              YES                                          
         B     *+12                NO                                           
*                                                                               
FILT06   TM    ESTOPT,UNAPP                                                     
         BZ    *+8                                                              
         BAS   RE,FILTNO                                                        
*                                                                               
FILT08   TM    JOBOPT,JBSTUDIO     IS THIS A STUDIO JOB?                        
         BZ    FILT09              NO                                           
         TM    BILLTYPE,PROG+TOTAL+ONELNE                                       
         BNZ   FILT09                                                           
         MVI   SPECRSN,ESSN06                                                   
         BAS   RE,FILTNOS                                                       
*                                                                               
FILT09   TM    BILLTYPE,PROG+TOTAL                                              
         BZ    FILT10                                                           
         TM    WKCOPT,WKCDTLC                                                   
         BO    FILT10                                                           
         MVI   RCSUBPRG,6                                                       
         CLI   PROF4,C'Y'                                                       
         BNE   *+8                                                              
         MVI   RCSUBPRG,9                                                       
*                                                                               
FILT10   TM    BILLTYPE,PROG+ESTIM                                              
         BNZ   FILT11                                                           
         CLC   QTRNSFLT,SPACES                                                  
         BE    FILT11                                                           
         MVI   REASON,ERSN32                                                    
         BAS   RE,FILTNO                                                        
*                                                                               
FILT11   CLI   PROF13,C'Y'                                                      
         BNE   *+8                                                              
         OI    REQOPT,REQAPPO                                                   
*                                                                               
         TM    BILLTYPE,ESTIM      SET IF %EST OR TOTAL                         
         BZ    *+8                                                              
         OI    INCOPT,INCEST                                                    
         TM    BILLTYPE,TOTAL+ONELNE                                            
         BZ    *+8                                                              
         OI    INCOPT,INCTOT                                                    
*                                                                               
         TM    BILLMODE,BILL+DRAFT                                              
         BZ    FILT16              DO FOR BILL AND DRAFT ONLY                   
*                                                                               
         BAS   RE,LOOKAHD                                                       
*                                                                               
         TM    BILLMODE,RERUN      SKIP ALL THIS FOR RERUN                      
         BO    FILT16                                                           
*                                                                               
         TM    BILLTYPE,PROG       IS THIS PROGRESSIVE ?                        
         BZ    FILT12              NO                                           
         MVI   SPECRSN,ESSN03      YES, PREPARE FOR ERROR                       
         L     RE,APREVB7          SEE IF ANY PREVIOUS B7'S EXIST               
         CLI   0(RE),X'B7'                                                      
         BNE   FILT12                                                           
         BAS   RE,FILTNOS                                                       
*                                                                               
FILT12   CP    SKINC,=P'0'                                                      
         BE    FILT13                                                           
         MVI   REASON,ERSN21                                                    
         TM    BILLTYPE,TOTAL+ESTIM    IF DEFERRED INCOME(SK)                   
         BNZ   FILT13                                                           
         BAS   RE,FILTNO                 MUST BE TOTAL OR %EST                  
*                                                                               
FILT13   TM    BILLTYPE,PROG+TOTAL                                              
         BZ    FILT16                                                           
         CLC   QTRNSFLT,SPACES                                                  
         BE    FILT14          IF NO W/C FILTER IGNORE AMOUNT CHECK             
         MVI   REASON,ERSN22                                                    
         CP    WKCAMT,=P'0'                                                     
         BNE   *+8                                                              
         BAS   RE,FILTNO              NO WORKCODE AMOUNTS                       
*                                                                               
FILT14   TM    BILLMODE,RERUN                                                   
         BZ    FILT16                                                           
         MVI   REASON,ERSN23                                                    
         CP    DEBITS,=P'0'                                                     
         BNE   *+8                                                              
         BAS   RE,FILTNO       IF RE-RUN AND NO TRANSACTIONS GET OUT            
*                                                                               
FILT16   TM    REQOPT,REQPRDO+REQMEDO  IF PROD OR MEDIA REQUESTED               
         BZ    FILT18                                                           
         MVI   REASON,ERSN24                                                    
         TM    BILLTYPE,PROG+TOTAL     MUST BE TOTAL OR PROGRESSIVE             
         BNZ   *+8                                                              
         BAS   RE,FILTNO                                                        
*                                                                               
FILT18   MVC   BILLINFO,PPRBILLP                                                
         MVC   DUB,GOBILAM1                                                     
         CLI   GOBILTYP,C'A'       SPECIAL AUTO BILLTYPE ?                      
         BE    FILT19              YES                                          
         CLI   GOBILTYP,C'E'       PERCENT OF ESTIMATE ?                        
         BNE   FILT20              NO                                           
         MVI   REASON,ERSN25                                                    
         OC    PEREST,PEREST       PERCENT IS ZERO                              
         BNZ   *+12                                                             
         BAS   RE,FILTNO                                                        
         B     FILT44                                                           
*                                                                               
FILT19   MVC   DUB(4),PEREST          GET PERCENT FOR THIS BILLING              
*                                                                               
FILT20   L     R3,DUB              CONVERT SPECIAL AMOUNT/OR PERCENT            
         CVD   R3,DUB                                                           
         CLI   BILLMODE,BILL+ORIG                                               
         BNE   FILT22                                                           
         TM    BILLTYPE,TOTAL+ESTIM                                             
         BZ    FILT22                                                           
         MVI   REASON,ERSN27                                                    
         CLC   RSTPBILL,TODAY2                                                  
         BNE   *+8                                                              
         BAS   RE,FILTNO              ALREADY BILLED TODAY                      
*                                                                               
FILT22   TM    BILLTYPE,SPECIAL                                                 
         BZ    FILT23                                                           
         ZAP   SPECAMNT,DUB                                                     
*                                                                               
FILT23   CLI   JBNEWEST,JBMCSQ     FOR MCS ESTIMATES SKIP                       
         BNE   FILT24                                                           
         USING MJETABD,R4                                                       
         ZAP   ESTIMATE,MJETVAL                                                 
         B     *+10                                                             
         DROP  R4                                                               
*                                                                               
         USING JBCOLD,R4                                                        
FILT24   ZAP   ESTIMATE,JBCOLVAL   GET TOTAL CURRENT NET                        
         TM    BILLMODE,UNBILL                                                  
         BO    FILT38                                                           
         TM    BILLTYPE,SPECIAL                                                 
         BO    FILT38                                                           
         ZAP   DUB,ESTIMATE                                                     
         TM    BILLTYPE,PROG+TOTAL                                              
         BNZ   FILT26                                                           
         ZAP   PL13,DUB            ESTIMATE AMOUNT                              
         L     RF,PEREST           PERCENT OF ESTIMATE                          
         CVD   RF,DUB1                                                          
         MP    PL13,DUB1+1(7)                                                   
         SRP   PL13,64-4,5                                                      
         ZAP   DUB,PL13                                                         
         L     R2,ADACCBAL         ONLY INTERESTED IF NOT EQUAL TO              
*                                  PREVIOUS BILLING ON THE JOB                  
         USING ABLELD,R2                                                        
         CLI   QOPT3,C'Y'          FORCE % ESTIMATE BILL                        
         BE    FILT36                                                           
         CLI   RTLEDG,0                                                         
         BE    *+12                NOT RETAIL                                   
         CLI   QOPT3,C'R'          FOR RETAIL SKIP ALL THIS SHIT                
         BE    FILT38                                                           
         MVI   REASON,ERSN28                                                    
         CP    ABLCR,DUB                                                        
         BNE   *+8                                                              
         BAS   RE,FILTNO                                                        
         ZAP   SPECAMNT,DUB                                                     
         B     FILT36                                                           
*                                                                               
FILT26   CP    ESTIMATE,=P'0'      IF NO ESTIMATE,NEED PROFILE                  
         BNE   FILT28              OPTION TO PRODUCE A BILL                     
         MVI   REASON,ERSN06                                                    
         TM    CLIOPT,ESTREQ                                                    
         BZ    *+8                                                              
         BAS   RE,FILTNO                                                        
         ZAP   DUB,DEBITS                                                       
         B     FILT30                                                           
*                                                                               
FILT28   L     RF,OVEREST                                                       
         CVD   RF,DUB                                                           
         ZAP   PL13,DUB                                                         
         ZAP   DUB,DEBITS                                                       
         MP    PL13,ESTIMATE            PERCENT OF EST X EST.                   
         DP    PL13,=PL3'10000'                                                 
         CLI   GONEEDES,C'Y'       DO WE NEED AN ESTIMATE ?                     
         BNE   FILT30              NO                                           
         MVI   REASON,ERSN01                                                    
         CP    DUB,PL13(10)                                                     
         BNH   *+8                                                              
         BAS   RE,FILTNO                                                        
         CP    OVERAMT,=P'0'       AMOUNT OVER ESTIMATE                         
         BE    FILT30                                                           
         ZAP   PL13,ESTIMATE       ESTIMATE                                     
         AP    PL13,OVERAMT        + AMOUNT ALLOWED TO GO OVER                  
         CP    DUB,PL13            VERUS TOTAL BILLING AMOUNT                   
         BNH   FILT30                                                           
         MVI   REASON,ERSN03       OVER MAXIMUM ESTIMATE AMOUNT                 
         BAS   RE,FILTNO                                                        
*                                                                               
FILT30   CLI   RTLEDG,0            OR RETAIL                                    
         BE    FILT32                                                           
         CLI   QOPT3,C'R'          SKIP THE BALANCE                             
         BE    FILT38                                                           
         B     FILT34                                                           
*                                                                               
FILT32   TM    BILLTYPE,TOTAL      FOR TOTAL                                    
         BZ    FILT34                                                           
         CLI   QOPT3,C'Y'          OPTION TO IGNORE BALANCE                     
         BE    FILT38                                                           
*                                                                               
FILT34   L     R2,ADACCBAL                                                      
         MVI   REASON,ERSN07                                                    
         CP    ABLCR,DUB          ALSO CHECK IF ANY BILLING IS NEEDED           
         BNE   *+8                                                              
         BAS   RE,FILTNO                                                        
         TM    BILLTYPE,PROG                                                    
         BZ    FILT38                                                           
         SP    DUB,ABLCR                                                        
         BM    FILT38              MINUS PROG. BILL ALLOWED                     
*                                                                               
FILT36   MVI   REASON,ERSN02                                                    
         CP    DUB,SMALL           BILL MUST EXCEED SMALL BILL  VALUE           
         BNL   *+8                                                              
         BAS   RE,FILTNO                                                        
*                                                                               
FILT38   MVI   REASON,ERSN36                                                    
         CLI   GOBILFUN,C'Y'       BILL ONLY FUNDED JOBS?                       
         BNE   FILT39              NO                                           
         TM    JOBOPT,FUNDED       YES, IS THIS JOB FUNDED?                     
         BO    *+8                 YES                                          
         BAS   RE,FILTNO           NO, GENERATE AN ERROR                        
*                                                                               
FILT39   TM    BILLTYPE,ESTIM+SPECIAL                                           
         BZ    FILT44                                                           
         TM    ESTOPT,NOESTCM                                                   
         BZ    *+8                                                              
         NI    CLIOPT,ALL-COMMISN  NO COMM. ON ESTIMATE OR SPECIAL              
*                                                                               
         TM    BILLTYPE,ESTIM                                                   
         BZ    FILT44                                                           
         MVI   SPECRSN,ESSN01                                                   
*                                                                               
         CLI   JBNEWEST,JBMCSQ     FOR MCS ESTIMATES SKIP                       
         BNE   FILT40                                                           
         BRAS  RE,BUILDMCS                                                      
         B     *+8                                                              
*                                                                               
FILT40   BRAS  RE,BUILDEST         BUILD TABLE OF ESTIMATES                     
         BNE   *+8                 NO ERRORS, CONTINUE                          
         BAS   RE,FILTNOS                                                       
         MVC   BILLNAME,SPACES                                                  
         CURED (4,PEREST),(6,BILLNAME),2,ALIGN=LEFT                             
         LA    R1,BILLNAME                                                      
         AR    R1,R0                                                            
         SH    R1,=H'3'                                                         
         CLC   0(3,R1),=C'.00'     ENGLISH                                      
         BE    FILT41                                                           
         CLC   0(3,R1),=C',00'     FRENCH                                       
         BNE   *+10                                                             
*                                                                               
FILT41   MVC   0(3,R1),SPACES                                                   
         LA    R1,BILLNAME+14                                                   
         SR    R3,R3                                                            
*                                                                               
FILT42   CLI   0(R1),C' '                                                       
         BNE   FILT43                                                           
         AH    R3,=H'1'                                                         
         BCT   R1,FILT42                                                        
*                                                                               
FILT43   CH    R3,=H'11'                                                        
         BL    *+8                                                              
         LA    R3,11                                                            
         BCTR  R3,0                                                             
         EX    R3,*+8                                                           
         B     *+10                                                             
         MVC   1(0,R1),=C'PC ESTIMATE'                                          
         OI    WKCOPT,WKCDTLC                                                   
         TM    ESTOPT,NOESTDL                                                   
         BZ    *+8                                                              
         NI    WKCOPT,ALL-WKCDTLC  NO DETAIL ON ESTIMATE                        
*                                                                               
FILT44   MVI   BILFLTSW,C'Y'       CHECK BILLING FILTER STATUS                  
         L     RF,ADLVASTA         FOR CLIENT                                   
         BAS   RE,FILTRBL                                                       
         L     RF,ADLVBSTA             PRODUCT                                  
         BAS   RE,FILTRBL                                                       
         L     RF,ADACCSTA         AND JOB                                      
         BAS   RE,FILTRBL                                                       
*                                                                               
         MVI   REASON,ERSN30                                                    
         CLI   BILFLTSW,C'Y'                                                    
         BE    *+8                                                              
         BAS   RE,FILTNO           EXCLUDE FROM BILLING                         
*                                                                               
         TM    BILLMODE,UNBILL                                                  
         BZ    *+8                                                              
         MVI   SVPBBIL,C'U'        INDICATE UNBILLING                           
*                                                                               
         TM    BILLTYPE,PROG+TOTAL+ONELNE                                       
         BNZ   *+8                                                              
         MVI   SVPBBIL,C'N'        NO POB UNLESS PROGRESSIVE OR TOTAL           
*                                                                               
         TM    BILLTYPE,NOTBILL    IS THIS ALREADY UNBILLABLE ?                 
         BO    FILT46              YES, PRINT MESSAGES                          
         TM    BILLMODE,UNBILL                                                  
         BO    FILTX               ALWAYS TRY TO RUN - IF UNBILLING             
         TM    BILLMODE,RERUN                                                   
         BO    FILTX               ALWAYS TRY TO RUN - IF RERUNNING             
*                                                                               
FILT46   OC    REASONS,REASONS                                                  
         BNZ   FILT48             FOUND REASONS - NOT TO BILL                   
         OC    SPECRSNS,SPECRSNS                                                
         BNZ   FILT48             FOUND SPECIAL REASONS - NOT TO BILL           
         OC    SOFTRSN,SOFTRSN                                                  
         BZ    FILTX               OK TO BILL                                   
*                                                                               
FILT48   MVI   BILLTYPE,NOTBILL                                                 
         MVI   FCRDTRNS,C'N'                                                    
         MVI   FCRDEST,C'N'                                                     
*                                                                               
         LA    R0,L'SPECRSNS       PRINT SPECIAL REASONS (IF ANY)               
         LA    R3,SPECRSNS                                                      
         LA    R4,SSN01                                                         
         BAS   RE,NOBILMSG                                                      
*                                                                               
         CLC   QUESTOR(7),=C'XIX    '                                           
         BE    FILT50                                                           
*                                                                               
         TM    BILLMODE,DRAFT      RUNNING DRAFT?                               
         BZ    FILTX               NO, OPTIONS USED FOR SOMETHING ELSE          
         CLI   PROF24,C'Y'         YES, WANT NON-BILLABLE DETAILS?              
         BNE   FILTX               NO                                           
*                                                                               
FILT50   LA    R0,L'REASONS        PRINT REGULAR REASONS (IF XIX)               
         LA    R3,REASONS                                                       
         LA    R4,RSN01                                                         
*                                                                               
         BAS   RE,NOBILMSG                                                      
*                                                                               
         USING NOBD,RF                                                          
SOFTBIL  LA    R3,SOFTRSN          PRINT SOFT REASONS (IF XIX)                  
         LA    R0,10                                                            
*                                                                               
SOFTB02  OC    0(12,R3),0(R3)                                                   
         BZ    FILTX               NO MORE REASONS                              
         L     RF,ANOBWK                                                        
         MVC   NOBDATA,SPACES                                                   
         MVI   NOBRSN,40           REASON CODE                                  
         MVC   NOBDATA(10),=C'MISSING - '                                       
         MVC   NOBDATA+11(12),0(R3)      SOFT REASON                            
         GOTO1 ADSORTER,DMCB,=C'PUT',ANOBWK                                     
         MVI   ALSORT,1            SO ADDRESS IS NOT ZERO                       
         LA    R3,12(R3)                                                        
         BCT   R0,SOFTB02                                                       
*                                                                               
FILTX    XIT1                                                                   
*                                                                               
*              SET ERROR REASON NUMBER                                          
*                                                                               
FILTNO   ZIC   R1,REASON                                                        
         BCTR  R1,0                                                             
         LA    R1,REASONS(R1)                                                   
         MVC   0(1,R1),REASON                                                   
         BR    RE                                                               
*                                                                               
         USING RSTELD,RF                                                        
FILTRBL  CLI   RSTLN,RSTLN2Q                                                    
         BLR   RE                  OLD ELEMENT                                  
         TM    RSTSTAT2,X'80'      BILLABLE STATUS                              
         BZ    *+10                                                             
         MVI   BILFLTSW,C'Y'                                                    
         BR    RE                                                               
         TM    RSTSTAT2,X'40'      UNBILLABLE STATUS                            
         BZR   RE                                                               
         MVI   BILFLTSW,C'N'                                                    
         BR    RE                                                               
*                                                                               
*              SET SPECIAL ERROR REASON NUMBER                                  
FILTNOS  ZIC   R1,SPECRSN                                                       
         BCTR  R1,0                                                             
         LA    R1,SPECRSNS(R1)                                                  
         MVC   0(1,R1),SPECRSN                                                  
         BR    RE                                                               
         DROP  RF,R2,R4,R5,R6                                                   
         EJECT                                                                  
***********************************************************************         
*              PRINT SPECIAL MESSAGE OR, OPTIONALLY, REGULAR MESSAGE  *         
*              FOR NO BILLING GENERATED                               *         
*              R0=L'SPECRSNS/REASONS                                  *         
*              R3=A(SPECRSNS/REASONS)                                 *         
*              R4=A(REASON EQUATES)                                   *         
***********************************************************************         
*                                                                               
         USING NOBD,RF                                                          
NOBILMSG NTR1                                                                   
         L     RF,ANOBWK                                                        
         LA    R1,NOBLNQ                                                        
         SLL   R1,16                                                            
         ST    R1,NOBLEN                                                        
         MVI   NOBTYP,NOBEQU           RECORD TYPE                              
         L     R2,ADACC                                                         
         MVC   NOBCLI(12),3(R2)         CLI/PRD/JOB                             
*                                                                               
NOBIL02  CLI   0(R3),0             IS REASON BIT SET                            
         BNE   NOBIL06             IF IT IS - MUST FIND REASON                  
*                                                                               
NOBIL04  LA    R3,1(R3)            BUMP TO NEXT REASON BYTE                     
         BCT   R0,NOBIL02                                                       
         B     NOBILX              ALL REASONS PRINTED                          
*                                                                               
NOBIL06  LR    R1,R4               GET REASON FROM TABLE                        
*                                                                               
NOBIL08  CLC   0(1,R1),0(R3)       REASON TABLE VS REASON VALUE                 
         BE    NOBIL10                                                          
         CLI   0(R1),X'FF'                                                      
         BE    NOBIL04             UNDEFINED REASON                             
         ZIC   R2,1(R1)                                                         
         LA    R1,2(R2,R1)         BUMP TO NEXT REASON                          
         B     NOBIL08                                                          
*                                                                               
NOBIL10  L     RF,ANOBWK                                                        
         MVC   NOBDATA,SPACES                                                   
         MVC   NOBRSN,0(R1)        REASON CODE                                  
         ZIC   R2,1(R1)                                                         
         BCTR  R2,0                GET LENGTH OF REASON                         
         EX    R2,*+8                                                           
         B     *+10                                                             
         MVC   NOBDATA(0),2(R1)                                                 
         GOTO1 ADSORTER,DMCB,=C'PUT',ANOBWK                                     
         MVI   ALSORT,1            SO ADDRESS IS NOT ZERO                       
         B     NOBIL04                                                          
*                                                                               
NOBILX   B     FILTX                                                            
         EJECT                                                                  
***********************************************************************         
*              READ FOR AUTHORIZATION AND GET USER FIELDS                       
***********************************************************************         
*                                                                               
BLDSOFT  NTR1                                                                   
         XC    SOFTRSN(10*12),SOFTRSN                                           
         XC    SVAUTH,SVAUTH                                                    
*                                                                               
         LA    R0,10               CLEAR ALL 10 SOFT HEADINGS                   
         LA    R1,SOFTH1                                                        
         MVC   0(L'SOFTH1,R1),SPACES                                            
         LA    R1,L'SOFTH1(R1)                                                  
         BCT   R0,*-10                                                          
*                                                                               
         LA    R0,10               LOOK THROUGH ALL 10 USER FIELDS              
         LA    R1,SOFTH1                                                        
         L     R5,AUSRPOOL                                                      
         LA    R9,USRNUM                                                        
*                                                                               
         L     R4,ADACC            ADDRSS THE JOB                               
         MVI   ELCODE,JFNELQ       LOOK FOR JOB FUND ELEMENT                    
         BAS   RE,GETEL2                                                        
         LA    RE,SOFTRSN                                                       
         BNE   BLDS16              NOT FUNDED                                   
*                                                                               
         USING JFNELD,R4                                                        
         MVC   SVAUTH,JFNNUM       SAVE THE AUTHORIZATION NUMBER                
*                                                                               
         L     R3,ACOMBUF                                                       
         USING AUTRECD,R3                                                       
         XC    AUTKEY,AUTKEY                                                    
         MVI   AUTKTYP,AUTKTYPQ                                                 
         MVI   AUTKSUB,AUTKSUBQ                                                 
         MVC   AUTKOGR(L'JFNKEY),JFNKEY                                         
         L     R2,ADACC                                                         
         MVC   AUTKCPY(3),0(R2)    GET CUL                                      
         ST    R1,SAVER1           GOTO1 WILL KILL THESE REGISTERS              
         ST    RE,SAVERE                                                        
         GOTO1 DATAMGR,DMCB,DMREAD,FILNME,(R3),(R3)                             
         L     R1,SAVER1                                                        
         L     RE,SAVERE                                                        
         MVI   SPECRSN,ESSN07                                                   
         CLI   DMCB+8,0                                                         
         BE    BLDS02                                                           
         BAS   RE,FILTNOS                                                       
         L     RE,SAVERE                                                        
         B     BLDS16                                                           
*                                                                               
BLDS02   L     R3,ACOMBUF                                                       
         AH    R3,DATADISP                                                      
*                                                                               
         USING UFSELD,R3                                                        
BLDS04   CLI   0(R3),0                                                          
         BE    BLDS16              END OF RECORD                                
         CLI   0(R3),X'A2'                                                      
         BE    BLDS08                                                           
*                                                                               
BLDS06   ZIC   RF,1(R3)                                                         
         AR    R3,RF                                                            
         B     BLDS04                                                           
*                                                                               
BLDS08   LA    R2,UFSDATA-UFSELD    LENGTH UP TO DATA                           
         ZIC   R4,UFSLN             ELEMENT LENGTH                              
         SR    R4,R2                R4=LENGTH OF UFSDATA                        
         BZ    BLDS10               NO DATA                                     
         BCTR  R4,0                                                             
         EX    R4,*+8                                                           
         B     *+10                                                             
         MVC   13(0,R1),UFSDATA   DATA TO SOFT FIELD                            
         MVC   0(12,R1),UFSDESC   FIELD DESCRIPTION                             
         MVI   43(R1),C'A'         INDICATE AUTHORIZATION USER FIELD            
*                                                                               
BLDS10   TM    UFSSTAT,X'40'       NEEDED FOR BILLING                           
         BZ    BLDS12              NO                                           
         CLC   13(10,R1),SPACES    YES, IS THERE DATA?                          
         BNE   BLDS12              YES                                          
         MVC   0(12,RE),UFSDESC    NO, ADD IT TO SOFTRSN                        
         LA    RE,12(RE)                                                        
*                                                                               
BLDS12   TM    UFSSTAT,X'10'      SHOW ON BILLS                                 
         BO    *+10                                                             
         MVC   0(L'SOFTH1,R1),SPACES  NOT NEEDED FOR PRINTING                   
*                                                                               
         TM    UFSSTAT,X'08'       NEED FOR RECEIVABLE ?                        
         BZ    BLDS14              NO                                           
*                                                                               
         LTR   R9,R9               ANY ROOM LEFT ?                              
         BZ    BLDS14              NO                                           
*                                                                               
         SR    R6,R6                                                            
         IC    R6,UFSLN                                                         
         BCTR  R6,0                                                             
         EX    R6,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R5),UFSEL      SAVE ELEMENT                                  
         LA    R5,1(R5,R6)                                                      
         MVI   0(R5),X'FF'                                                      
         BCTR  R9,0                                                             
*                                                                               
BLDS14   CLC   0(L'SOFTH1,R1),SPACES                                            
         BE    BLDS06               GET NEXT                                    
         LA    R1,L'SOFTH1(R1)      IF NEEDED BUMP TO NEXT AREA                 
         BCT   R0,BLDS06                                                        
*                                                                               
BLDS16   L     R3,ADACC                                                         
         USING ACTRECD,R3                                                       
         LA    R4,ACTRECD+ACCORFST                                              
         L     R5,AUSRPOOL                                                      
*                                                                               
         USING UFSELD,R4                                                        
BLDS18   CLI   0(R4),0                                                          
         BE    BLDSX               END OF RECORD                                
         CLI   0(R4),X'A2'                                                      
         BE    BLDS22                                                           
*                                                                               
BLDS20   ZIC   RF,1(R4)                                                         
         AR    R4,RF                                                            
         B     BLDS18                                                           
*                                                                               
BLDS22   LA    R2,UFSDATA-UFSELD   LENGTH UP TO DATA                            
         ZIC   R3,UFSLN            ELEMENT LENGTH                               
         SR    R3,R2               R3=LENGTH OF UFSDATA                         
         BNZ   BLDS23              DATA                                         
         TM    UFSSTAT,X'40'       NO DATA, IS IT NEEDED FOR BILLING?           
         BZ    BLDS30              NO                                           
         B     BLDS29              YES, SAVE FOR ERROR                          
*                                                                               
BLDS23   BCTR  R3,0                                                             
         LA    R0,20               20 USER FIELDS                               
         LA    R1,SOFTH1           LOOK FOR A MATCH OR FREE SPACES              
*                                                                               
BLDS24   CLC   0(12,R1),SPACES                                                  
         BE    BLDS26                                                           
         CLC   UFSDESC,0(R1)       IS DESCRIPTION THE SAME?                     
         BNE   BLDS25              NO, GET NEXT SPACE                           
         CLI   43(R1),C'A'         IS THIS AN AUTHORIZATION FIELD?              
         BE    BLDS26              YES, OK TO OVERWRITE IT.                     
*                                                                               
BLDS25   LA    R1,L'SOFTH1(R1)      GET NEXT SPACE                              
         BCT   R0,BLDS24                                                        
         B     BLDSX                                                            
*                                                                               
BLDS26   TM    UFSSTAT,X'10'       SHOW ON BILLS                                
         BZ    BLDS28              NO                                           
         MVC   0(L'SOFTH1,R1),SPACES                                            
         EX    R3,*+8                                                           
         B     *+10                                                             
         MVC   13(0,R1),UFSDATA    DATA TO SOFT FIELD                           
         MVC   0(12,R1),UFSDESC    FIELD DESCRIPTION                            
         MVI   43(R1),C' '         CLEAR AUTHORIZATION BIT IF ON                
*                                                                               
BLDS28   TM    UFSSTAT,X'40'       NEEDED FOR BILLING                           
         BZ    BLDS30                                                           
         CLC   UFSDATA(10),SPACES                                               
         BNE   BLDS30              DATA IS PRESENT                              
*                                                                               
BLDS29   MVC   0(12,RE),UFSDESC   DESCRIPTION TO SOFTRSN FIELD                  
         LA    RE,12(RE)                                                        
*                                                                               
BLDS30   TM    UFSSTAT,X'08'      NEED FOR RECEIVABLE ?                         
         BZ    BLDS20             NO                                            
*                                                                               
         SR    R6,R6                                                            
         IC    R6,UFSLN                                                         
         BCTR  R6,0                                                             
*                                                                               
         LA    R0,USRNUM                                                        
         L     R5,AUSRPOOL                                                      
*                                                                               
BLDS32   CLI   0(R5),X'FF'         FREE SPACES?                                 
         BE    BLDS38              YES, SAVE NEW ELEMENT                        
         CLC   6(L'UFSDESC,R5),UFSDESC                                          
         BE    BLDS34              SEE IF ALREADY THERE                         
*                                                                               
         SR    RF,RF               NO, GET TO NEXT ENTRY                        
         IC    RF,1(R5)                                                         
         LA    R5,0(R5,RF)          GET NEXT SPACE                              
         BCT   R0,BLDS32                                                        
         B     BLDS20                                                           
*                                                                               
BLDS34   SR    RF,RF                                                            
         IC    RF,1(R5)            GET LENGTH OF EXISTING ELEMENT               
         AR    RF,R5               GET TO END OF ELEMENT                        
         LA    R0,X'FF'            SET END MARKER                               
*                                                                               
BLDS36   MVST  R5,RF                                                            
         BO    BLDS36                                                           
*                                                                               
BLDS38   EX    R6,*+8              NOW MOVE NEW ELEMENT TO END                  
         B     *+10                                                             
         MVC   0(0,R5),UFSEL      SAVE ELEMENT                                  
*                                                                               
         LA    R5,1(R5,R6)                                                      
         MVI   0(R5),X'FF'                                                      
         B     BLDS20                                                           
*                                                                               
BLDSX    B     FILTX                                                            
         DROP  R3,R4                                                            
         EJECT                                                                  
***********************************************************************         
*    BUILD TABLE OF ESTIMATES USING FIELDS GENERATED BY JOBBER                  
***********************************************************************         
*                                                                               
BUILDEST NTR1                                                                   
         L     R3,AMONACC                                                       
         USING ACMD,R3                                                          
         L     R5,ACMAJOBB                                                      
         USING JBLOCKD,R5                                                       
         LA    R4,ESMREC                                                        
         USING BESELD,R4                                                        
         L     R3,ACMACOL                                                       
         USING JBCOLD,R3                                                        
         LH    R0,JBNROWS                                                       
         XC    ESMREC,ESMREC       CLEAR THE RECORD FIRST                       
         MVI   BESEL,BESELQ                                                     
         MVI   BESLN,BESLN2Q                                                    
*                                                                               
BEST02   CLI   JBCOLTYP,JBCOLTWC   ARE WE AT WORKCODE LEVEL ?                   
         BNE   BEST10              NO, TRY NEXT                                 
         CP    JBCOLVAL,=P'0'      YES, IS IT ZERO ?                            
         BE    BEST10              YES, SKIP IT                                 
         CLC   QTRNSFLT,SPACES     FILTER ON WORKCODE ?                         
         BE    BEST04              NO                                           
         CLC   QTRNSFLT,JBCOLWC    YES, ARE THEY EQUAL ?                        
         BE    BEST04              YES, SAVE THIS ONE                           
         TM    QTRNSFLT,X'40'      NO, IS THIS ALL EXCEPT THIS ONE ?            
         BO    BEST10              NO, TRY THE NEXT                             
         MVC   WORK(2),QTRNSFLT    YES                                          
         OI    WORK,X'40'                                                       
         CLC   WORK(2),JBCOLWC                                                  
         BE    BEST10                                                           
*                                                                               
BEST04   MVC   BESWC,JBCOLWC       MOVE VALUES TO POOL RECORD                   
         ZAP   BESPEBC,JBCOLVAL+12(6)                                           
         ZAP   BESPEBCG,JBCOLVAL+18(6)                                          
         TM    CLIOPT,COMMISN      COMMISSIONABLE ?                             
         BO    *+10                YES                                          
         ZAP   BESPEBCG,BESPEBC    NO, MAKE GROSS SAME AS NET                   
*                                                                               
         L     R2,AESTPOOL         GET START OF ESTPOOL                         
*                                                                               
BEST06   CLI   0(R2),0             THIS SPOT VACANT ?                           
         BE    BEST08              YES                                          
         LA    R2,BESLN2Q(R2)      NO, TRY NEXT                                 
         B     BEST06                                                           
*                                                                               
BEST08   MVC   SVANAL,JBCOLWC      GET GSTCOD AND LOOK FOR MEDIA DATA           
         BAS   RE,GETGST                                                        
         BE    FILTX               MEDIA TRANSFER FOUND- GET OUT                
         MVI   BESVAT,X'00'                                                     
         TM    RUNOPT,NEEDGST      ARE WE DOING GST LOGIC?                      
         BZ    *+10                NO                                           
         MVC   BESVAT,SVGSTCOD     YES, SAVE GST CODE                           
*                                                                               
         TM    RUNOPT,NEEDPST      ARE WE DOING PST LOGIC?                      
         BZ    BEST09              NO                                           
         MVC   BESPST,SVPSTCOD     YES, SAVE PST CODE                           
         MVC   BESPRV,SVPSTPRV          AND PROVINCE CODE                       
*                                                                               
BEST09   MVC   0(BESLN2Q,R2),ESMREC  MOVE RECORD TO POOL                        
         MVI   BESLN2Q(R2),0       INDICATE END                                 
*                                                                               
BEST10   AH    R3,JBLCOL           GET NEXT TABLE ENTRY                         
         BCT   R0,BEST02                                                        
         B     FILTX                                                            
*                                                                               
         DROP  R3,R4,R5                                                         
         EJECT                                                                  
***********************************************************************         
*    BUILD TABLE OF MCS ESTIMATES USING FIELDS GENERATED BY JOBBER              
***********************************************************************         
*                                                                               
BUILDMCS NTR1                                                                   
         L     R3,AMONACC                                                       
         USING ACMD,R3                                                          
         L     R5,ACMAJOBB                                                      
         USING JBLOCKD,R5                                                       
         LA    R4,ESMREC                                                        
         USING BESELD,R4                                                        
         L     R3,ACMACOL                                                       
         USING MJETABD,R3                                                       
         XC    ESMREC,ESMREC       CLEAR THE RECORD FIRST                       
         MVI   BESEL,BESELQ                                                     
         MVI   BESLN,BESLN2Q                                                    
         XR    R0,R0                                                            
*                                                                               
BMCS02   CLI   MJETTYP,MJETTEQ     ARE WE AT END?                               
         BE    BMCSX               YES                                          
         CLI   MJETTYP,MJETTWQ     ARE WE AT WORKCODE LEVEL ?                   
         BNE   BMCS10              NO, TRY NEXT                                 
         OC    MJET1RA,MJET1RA     BUT NOT 1R-LEVEL DETAILS                     
         BNZ   BMCS10                                                           
         CP    MJETVAL,=P'0'       YES, IS IT ZERO ?                            
         BE    BMCS10              YES, SKIP IT                                 
         CLC   QTRNSFLT,SPACES     FILTER ON WORKCODE ?                         
         BE    BMCS04              NO                                           
         CLC   QTRNSFLT,MJETWCD    YES, ARE THEY EQUAL ?                        
         BE    BMCS04              YES, SAVE THIS ONE                           
         TM    QTRNSFLT,X'40'      NO, IS THIS ALL EXCEPT THIS ONE ?            
         BO    BMCS10              NO, TRY THE NEXT                             
         MVC   WORK(2),QTRNSFLT    YES                                          
         OI    WORK,X'40'                                                       
         CLC   WORK(2),MJETWCD                                                  
         BE    BMCS10                                                           
*                                                                               
BMCS04   MVC   BESWC,MJETWCD       MOVE VALUES TO POOL RECORD                   
         ZAP   BESPEBC,MJETVAL+12(6)                                            
         ZAP   BESPEBCG,MJETVAL+18(6)                                           
         TM    CLIOPT,COMMISN      COMMISSIONABLE ?                             
         BO    *+10                YES                                          
         ZAP   BESPEBCG,BESPEBC    NO, MAKE GROSS SAME AS NET                   
*                                                                               
         L     R2,AESTPOOL         GET START OF ESTPOOL                         
*                                                                               
BMCS06   CLI   0(R2),0             THIS SPOT VACANT ?                           
         BE    BMCS08              YES                                          
         LA    R2,BESLN2Q(R2)      NO, TRY NEXT                                 
         B     BMCS06                                                           
*                                                                               
BMCS08   MVC   SVANAL,MJETWCD      GET GSTCOD AND LOOK FOR MEDIA DATA           
         BAS   RE,GETGST                                                        
         BE    FILTX               MEDIA TRANSFER FOUND- GET OUT                
         MVI   BESVAT,X'00'                                                     
         TM    RUNOPT,NEEDGST      ARE WE DOING GST LOGIC?                      
         BZ    *+10                NO                                           
         MVC   BESVAT,SVGSTCOD     YES, SAVE GST CODE                           
*                                                                               
         TM    RUNOPT,NEEDPST      ARE WE DOING PST LOGIC?                      
         BZ    BMCS09              NO                                           
         MVC   BESPST,SVPSTCOD     YES, SAVE PST CODE                           
         MVC   BESPRV,SVPSTPRV          AND PROVINCE CODE                       
*                                                                               
BMCS09   MVC   0(BESLN2Q,R2),ESMREC  MOVE RECORD TO POOL                        
         MVI   BESLN2Q(R2),0       INDICATE END                                 
*                                                                               
BMCS10   IC    R0,MJETLEN          GET NEXT TABLE ENTRY                         
         AR    R3,R0                                                            
         B     BMCS02                                                           
*                                                                               
BMCSX    LTR   R3,R3                                                            
         B     FILTX                                                            
         DROP  R3,R4,R5                                                         
         EJECT                                                                  
***********************************************************************         
*              ROUTINE TO CALL GETOPT FOR TAXCODES FOR $ESTIMATE BILLS*         
***********************************************************************         
*                                                                               
         USING ACMD,R3                                                          
         USING GOBLOCKD,R4                                                      
GETGST   NTR1                                                                   
         L     R3,AMONACC                                                       
         L     R4,ADGOBLOC                                                      
         MVC   GOSELWC,SVANAL                                                   
         MVC   GOAKEY,ACMALTN       A(LAST RECORD READ)                         
         GOTO1 GETOPT,DMCB,ADGOBLOC                                             
         XC    GOAKEY,GOAKEY                                                    
         XC    GOSELWC,GOSELWC                                                  
         MVC   SVGSTCOD,GOTAXCOD   SAVE THE GST CODE                            
         MVC   SVPSTCOD,GOPSTCOD     PST CODE                                   
         MVC   SVPSTPRV,GOPSTPRV     AND PROVINCE CODE                          
         TM    GOEFFWST,X'01'      IS THIS A MEDIA TRANSFER ?                   
         BZ    GETGSTX             NO                                           
         SR    R3,R3               YES, SET RETURN TO ZERO                      
*                                                                               
GETGSTX  LTR   R3,R3                                                            
         B     FILTX                                                            
         DROP  R3,R4                                                            
         EJECT                                                                  
***********************************************************************         
*              ROUTINE TO LOOK FORWARD THROUGH JOB POSTINGS                     
***********************************************************************         
*                                                                               
         USING TRNRECD,R3                                                       
         USING TRNELD,R2                                                        
LOOKAHD  NTR1                                                                   
         L     R3,ADACC                                                         
         MVC   SAVEKEY,0(R3)                                                    
         L     R3,ACOMBUF                                                       
         MVC   0(42,R3),SAVEKEY                                                 
         ZAP   DEBITS,=P'0'                                                     
         ZAP   SKINC,=P'0'                                                      
         ZAP   WKCAMT,=P'0'                                                     
         MVC   SVANAL,SPACES                                                    
         MVC   SVANALN,SPACES                                                   
*                                                                               
         GOTO1 DATAMGR,DMCB,DMREAD,FILNME,(R3),(R3)                             
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
LOOK02   GOTO1 DATAMGR,DMCB,DMRSEQ,FILNME,(R3),(R3)                             
         CLC   0(15,R3),SAVEKEY                                                 
         BNE   LOOKXIT                                                          
         LA    R2,TRNRECD+ACCORFST                                              
         CLI   0(R2),X'44'                                                      
         BNE   LOOK02                                                           
         CLC   TRNKWORK,=C'99'                                                  
         BE    LOOK20                                                           
         TM    TRNRECD+ACCOSTAT,X'40' BYPASS DRAFT TRANSACTIONS                 
         BO    LOOK02                                                           
         TM    TRNSTAT,X'80'       DEBIT                                        
         BZ    LOOK02                                                           
*                                                                               
         TM    BILLMODE,RERUN                                                   
         BZ    LOOK04                                                           
         CLC   TRNRECD+ACCOUSED(ACCOULEN),TODAY2                                
         BNE   LOOK02                                                           
         OC    REBILLNO,REBILLNO                                                
         BNZ   LOOK14              ALREADY HAVE RERUN NUMBER                    
*                                                                               
         USING ACMD,R4                                                          
         L     R4,AMONACC                                                       
         GOTO1 ACMAPRAT,DMCB,(X'C0',(R3)),ADGOBLOC,ADCOMFAC,0,         X        
               ACMAPROB,ACMAPRO2                                                
*                                                                               
         L     R4,ACMAPRO2                                                      
         CLI   0(R4),PTAELQ                                                     
         B     LOOK03+8                                                         
*                                                                               
         USING PTAELD,R4                                                        
LOOK03   MVI   ELCODE,PTAELQ                                                    
         BAS   RE,NEXTEL2                                                       
         BNE   LOOK14              NO BILLING ELEMENT                           
*                                                                               
         CLI   PTATYPE,PTATRAL     IS THIS BILLING?                             
         BNE   LOOK03              NO                                           
         TM    PTASTAT1,PTASPEND   YES, IS IT PENDING?                          
         BO    LOOK03              YES, NOT BILLED YET                          
         CLC   PTARDATE,TODAY2     NO, WAS IT BILLED TODAY?                     
         BNE   LOOK03              NO                                           
         MVC   REBILLNO,PTARBLNO   YES, GET BILL NUMBER                         
         L     R3,ACOMBUF          RESTORE R3                                   
         B     LOOK14                                                           
*                                                                               
         USING TRNRECD,R3                                                       
LOOK04   TM    BILLTYPE,PROG       IF PROGRESSIVE                               
         BZ    LOOK06                                                           
         OC    TRNRECD+ACCOUSED(ACCOULEN),TRNRECD+ACCOUSED                      
         BNZ   LOOK14              AND ALREADY BILLED SKIP DATE TEST            
*                                                                               
LOOK06   CLC   TRNDATE,ENDATE      AND APPROVED TEST                            
         BH    LOOK02                                                           
         CLI   TRNTYPE,50          TALENT INTERFACE                             
         BNE   LOOK08                                                           
         LA    R1,PROF7            GET OPTION ADDRESS FOR A21                   
         TM    BILLMODE,BILL       IS THIS BILLING?                             
         BO    *+8                 YES                                          
         LA    R1,PROF15           NO, GET A22 OPTION ADDRESS                   
         CLI   0(R1),C'Y'                                                       
         BNE   LOOK08              CAN OPTIONALLY BE EXCLUDED                   
         CLC   TRNDATE,ENDATE                                                   
         BE    LOOK02              IF EQUAL TO END DATE                         
*                                                                               
LOOK08   TM    REQOPT,REQAPPO      IS IT BILL APPROVED ONLY                     
         BZ    LOOK10                                                           
         TM    TRNSTAT,X'04'       IS ITEM TO BE HELD FROM BILLING              
         BO    LOOK02              YES SO SKIP IT                               
*                                                                               
LOOK10   CLC   TRNANAL,SVANAL      HAVE WE DONE THIS ONE BEFORE ?               
         BE    *+8                 YES                                          
         BAS   RE,SETMT            NO, SEE IF MEDIA TRANSFER W/C                
*                                                                               
         TM    REQOPT,REQPRDO      IS REQUEST FOR PRODUCTION ONLY               
         BZ    LOOK12              BRANCH IF NOT                                
         TM    WKCOPT,WKCMT        IS THIS A MEDIA CHARGE                       
         BO    LOOK02              IF IT IS IGNORE IT                           
         B     LOOK14                                                           
*                                                                               
LOOK12   TM    REQOPT,REQMEDO      IS REQUEST FOR MEDIA ONLY                    
         BZ    LOOK14              BRANCH IF NOT                                
         TM    WKCOPT,WKCMT        IS THIS A MEDIA CHARGE                       
         BZ    LOOK02              BRANCH IF IT IS NOT                          
*                                                                               
LOOK14   AP    DEBITS,TRNAMNT                                                   
         CLC   QTRNSFLT,SPACES     DO SOME FILTERING ON WORKCODE                
         BE    LOOK16              NO FILTERING                                 
         CLC   QTRNSFLT,TRNANAL                                                 
         BE    LOOK16              MATCHED WORKCODE FILTER                      
         TM    QTRNSFLT,X'40'                                                   
         BO    LOOK18                                                           
         MVC   WORK(2),QTRNSFLT                                                 
         OI    WORK,X'40'                                                       
         CLC   WORK(2),TRNANAL    ALL EXCEPT THIS ONE                           
         BE    LOOK18                                                           
*                                                                               
LOOK16   AP    WKCAMT,TRNAMNT     ADD AMOUNTS FOR FILTERED CODES                
*                                                                               
LOOK18   B     LOOK02                                                           
*                                                                               
*              FOR BILLING / LOOK FOR CLIENT BILLS                              
LOOK20   MVI   REASON,ERSN29       CLIENT BILLING                               
         CLC   TRNNARR(15),=CL15'CLIENT WP BILL'                                
         BNE   *+8                                                              
         BAS   RE,FILTNO                                                        
         CLC   TRNNARR(15),=CL15'ALLOCATED BILL'                                
         BNE   *+8                                                              
         BAS   RE,FILTNO                                                        
*                                                                               
         MVI   SPECRSN,ESSN02      CHECK FOR RETAIL/NON-RETAIL MIX              
         LA    R1,X'70'            SET BRANCH NOT EQUAL                         
         CLI   RTLEDG,0                                                         
         BE    *+8                                                              
         LA    R1,X'80'            SET BRANCH EQUAL                             
         CLI   TRNKCULC+1,C'3'     RETAIL UNIT IS '3'                           
         EX    R1,*+8                                                           
         B     *+8                                                              
         BC    0,*+8                                                            
         BAS   RE,FILTNOS                                                       
*                                                                               
*              OR UNREVERSED SK INCOME                                          
         CLI   TRNLN,121                                                        
         BNE   LOOK22                                                           
         OC    TRNSK2SI,TRNSK2SI                                                
         BNZ   LOOK22               SK INCOME REVERSED                          
         AP    SKINC,TRNAM2SK       SK INCOME NOT REVERSED                      
*                                                                               
LOOK22   TM    BILLTYPE,TOTAL+ONELNE   RUNNING A TOTAL BILL?                    
         BZ    LOOK25              NO                                           
         CLI   TRNBTYPE,TRNBTPER   NO, IS THIS AN ESTIMATE BILL?                
         BNE   LOOK25              NO                                           
         OI    INCOPT,INCTOT       TURN INCOME OPTION BACK ON                   
         LR    RE,R2               YES                                          
*                                                                               
         USING GDAELD,RE                                                        
LOOK23   SR    R1,R1               CHECK TO SEE IF ALREADY BILLED               
         IC    R1,1(RE)                                                         
         AR    RE,R1                                                            
         CLI   0(RE),0                                                          
         BE    LOOK25                                                           
         CLI   0(RE),GDAELQ        LOOK FOR DATE ELEMENT                        
         BNE   LOOK23                                                           
         CLI   GDATYPE,GDATBILL    FROM AC21 BILLING                            
         BNE   LOOK23                                                           
         OC    GDADATE2,GDADATE2   HAS IT BEEN UNBILLED?                        
         BNZ   LOOK23              YES                                          
         MVI   INCOPT,0            NO, ALREADY BEEN BILLED                      
         DROP  RE                                                               
*                                                                               
LOOK25   LR    RE,R2                                                            
         L     RF,APREVB7                                                       
*                                                                               
         TM    BILLTYPE,ESTIM      ESTIMATED BILLING?                           
         BO    *+16                YES, SKIP THESE INSTRUCTIONS                 
*                                                                               
         CLI   0(RF),X'00'         DO WE HAVE ANY TABLE ENTRIES ?               
         BNE   *+8                 YES, OK TO HAVE 99'S W/B7'S                  
         MVI   0(RF),X'FF'         NO, INDICATE WE HAVE 99'S W/O B7'S           
*                                                                               
LOOK26   SR    R1,R1                                                            
         IC    R1,1(RE)                                                         
         AR    RE,R1                                                            
         CLI   0(RE),0             END OF RECORD ?                              
         BE    LOOK02              YES                                          
         CLI   0(RE),INCELQ        NO, INCOME ELEMENT ?                         
         BNE   LOOK26              NO, KEEP LOOKING                             
         L     RF,APREVB7                                                       
*                                                                               
ELM      USING INCELD,RE                                                        
         USING INCELD,RF                                                        
LOOK27   CLI   0(RF),0             ENTRY IN TABLE ?                             
         BE    LOOK31              NO, MOVE IT IN                               
         CLI   0(RF),X'FF'                                                      
         BE    LOOK31                                                           
         CLC   INCWRKC(2),ELM.INCWRKC                                           
         BE    LOOK28              ALREADY THERE, ADD IT UP                     
         LA    RF,INCLN2Q(RF)      GET NEXT PLACE IN TABLE                      
         B     LOOK27              KEEP LOOKING                                 
*                                                                               
LOOK28   AP    INCAMNT,ELM.INCAMNT                                              
         CLI   ELM.INCLN,INCLN2Q                                                
         BNE   LOOK30                                                           
         AP    INCINAM,ELM.INCINAM                                              
         OC    ELM.INCCACC,ELM.INCCACC                                          
         BZ    *+10                                                             
         MVC   INCCACC,ELM.INCCACC                                              
         OC    ELM.INCDACC,ELM.INCDACC                                          
         BZ    *+10                                                             
         MVC   INCDACC,ELM.INCDACC                                              
         B     LOOK26                                                           
*                                                                               
LOOK30   CLI   TRNBTYPE,TRNBTPER    IS THIS AN ESTIMATE BILL?                   
         BNE   LOOK26               NO, DONE WITH THIS ONE                      
         AP    INCINAM,ELM.INCAMNT  YES, AMOUNTS SHOULD BE THE SAME             
         B     LOOK26                                                           
*                                                                               
LOOK31   XC    INCEL(INCLN2Q),INCEL                                             
         SR    R1,R1                                                            
         IC    R1,1(RE)                                                         
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RF),0(RE)       MOVE ELEMENT TO B7 TABLE                     
         CLI   INCLN,INCLN2Q       NEW ELEMENT?                                 
         BE    LOOK32              YES                                          
*                                                                               
         MVI   INCLN,INCLN2Q       NO, SET NEW LENGTH                           
         ZAP   INCINAM,=P'0'                                                    
         CLI   TRNBTYPE,TRNBTPER   IS THIS AN ESTIMATE BILL?                    
         BNE   LOOK32              NO,                                          
         ZAP   INCINAM,INCAMNT     INITIALIZE INCOME                            
*                                                                               
LOOK32   LA    RF,INCLN2Q(RF)      NEXT AREA IN TABLE                           
         MVI   0(RF),0             MARK END OF TABLE                            
         B     LOOK26                                                           
         DROP  ELM,RF                                                           
*                                                                               
LOOKXIT  DS    0H                                                               
         MVC   SVANAL,SPACES                                                    
         MVC   SVANALN,SPACES                                                   
         B     FILTX                                                            
*                                                                               
SETMT    NTR1                                                                   
         NI    WKCOPT,X'FF'-WKCMT  TURN OFF MEDIA TRANSFER BIT                  
         L     R4,ADLEDGER                                                      
         MVI   ELCODE,X'12'                                                     
         BAS   RE,GETEL2                                                        
         BNE   SETX                                                             
*                                                                               
         USING WCOELD,R4                                                        
SETM02   CLC   TRNANAL,WCOCODE    DOES CODE MATCH ?                             
         BNE   SETM04              NO, GET NEXT ONE                             
         TM    WCOSTAT,WCOSMEDT    YES, IS IT MEDIA TRANSFER ?                  
         BZ    SETX                NO                                           
         OI    WKCOPT,WKCMT        YES                                          
         B     SETX                                                             
*                                                                               
SETM04   BAS   RE,NEXTEL2                                                       
         BE    SETM02                                                           
*                                                                               
SETX     MVC   SVANAL,TRNANAL      SAVE NEW CODE                                
         XIT1                                                                   
         DROP  R2,R3,R4                                                         
         EJECT                                                                  
***********************************************************************         
*              READ CYCLE RECORD TO DETERMINE BILLTYPE                          
***********************************************************************         
*                                                                               
         USING JCBRECD,R4                                                       
         USING GOBLOCKD,R6                                                      
GTCYCLE  NTR1                                                                   
         L     R4,ACOMBUF                                                       
         L     R6,ADGOBLOC                                                      
         XC    PEREST,PEREST                                                    
         XC    JCBKEY,JCBKEY                                                    
         MVI   JCBKTYP,JCBKTYPQ                                                 
         MVI   JCBKSUB,JCBKSUBQ                                                 
         MVC   JCBKCUL,GOSELCUL                                                 
         MVC   JCBKCLI,GOSELCLI                                                 
         MVC   JCBKPRO,GOSELPRO                                                 
         MVC   JCBKJOB,GOSELJOB                                                 
*                                                                               
         GOTO1 DATAMGR,DMCB,DMREAD,FILNME,(R4),(R4)                             
         CLI   DMCB+8,0            FIND IT ?                                    
         BE    GTCYCL2             YES                                          
*                                                                               
GTCYCL1  MVI   REASON,ERSN33       NO, CAN'T BILL                               
         BAS   RE,FILTNO                                                        
         B     GTCYCLX                                                          
*                                                                               
GTCYCL2  AH    R4,DATADISP                                                      
*                                                                               
GTCYCL4  CLI   0(R4),0             END OF RECORD ?                              
         BE    GTCYCL1             YES, ERROR                                   
         CLI   0(R4),BCYELQ        CYCLE ELEMENT ?                              
         BE    GTCYCL8             YES                                          
*                                                                               
GTCYCL6  SR    R0,R0               KEEP LOOKING                                 
         IC    R0,1(R4)                                                         
         AR    R4,R0                                                            
         B     GTCYCL4                                                          
*                                                                               
         USING BCYELD,R4                                                        
GTCYCL8  OC    BCYBILD,BCYBILD     WAS THIS ONE BILLED ?                        
         BNZ   GTCYCL6             YES, LOOK AT NEXT ONE                        
         CLC   QAPPL+6(2),BCYMON   NO, THIS MUST BE THE ONE                     
         BE    GTCYCL10                                                         
         TM    BCYSTAT,BCYSMON     CHECK IF DATE HIGHER ALSO ?                  
         BZ    *+14                NO, ERROR                                    
         CLC   QAPPL+6(2),BCYMON   YES, IS IT ?                                 
         BH    GTCYCL10            YES, OK                                      
*                                                                               
         MVI   REASON,ERSN34                                                    
         BAS   RE,FILTNO                                                        
         B     GTCYCLX                                                          
*                                                                               
GTCYCL10 MVI   TEMPTYPE,C'T'       ASSUME TOTAL                                 
         CLI   BCYPER,X'FF'        ANY PERCENTAGE ?                             
         BE    GTCYCLX             NO, ALL DONE                                 
         MVI   TEMPTYPE,C'E'       YES, CHANGE TYPE                             
         MVC   PEREST+2(2),BCYPER  GET THE PERCENTAGE                           
*                                                                               
GTCYCLX  XIT1                                                                   
         DROP  R4,R6                                                            
         EJECT                                                                  
         GETELN R4,DATADISP,ELCODE,2                                            
*                                                                               
BILLTAB  DS   0CL20                                                             
         DC   C'PROGRESSIVE    ',C'PYN',AL1(TRNBTPRO),AL1(PROG)                 
         DC   C'TOTAL BILL     ',C'TYN',AL1(TRNBTTOT),AL1(TOTAL)                
         DC   C'ONE-LINE BILL  ',C'1YN',AL1(TRNBTONE),AL1(ONELNE+TOTAL)         
         DC   C'   PC ESTIMATE ',C'EYY',AL1(TRNBTPER),AL1(ESTIM)                
         DC   C'SPECIAL AMOUNT ',C'SYN',AL1(TRNBTSPE),AL1(SPECIAL)              
         DC   C'CLIENT         ',C'CNN',AL1(TRNBTCLI),AL1(0)                    
         DC   C'UNBILLABLE     ',C'UNN',AL1(0),AL1(0)                           
         DC   X'FF'                                                             
*                                                                               
SOFTRSN  DS    10CL12              SOFT REASONS                                 
*                                                                               
SVAGYCOM DS    PL4                                                              
OVEREST  DS    F                   OVEREST PERCENT                              
OVERAMT  DS    PL4                 OVEREST AMOUNT                               
DEBITS   DS    PL6                                                              
WKCAMT   DS    PL6                                                              
SMALL    DS    PL4                                                              
TEMPTYPE DS    C                                                                
*                                                                               
BILFLTSW DS    CL1                 SPECIAL BILLING FILTER SWITCH                
*                                                                               
REASON   DS    CL1                 CURRENT REASON FOR NO BILLING                
REASONS  DS    CL(ERSN38-ERSN01+1) LIST OF REASONS FOR NO BILLING               
SPECRSN  DS    CL1                 CURRENT SPECIAL REASON                       
SPECRSNS DS    CL(ESSN06-ESSN01+1) LIST OF SPECIAL REASONS                      
*                                                                               
ESMREC   DS    CL(BESLN2Q)         WORK AREA FOR ESTIMATE RECORDS               
         EJECT                                                                  
*                                  ERROR CODES FOR NOT BILLING                  
*                                                                               
ERSN01   EQU   1                                                                
ERSN02   EQU   2                                                                
ERSN03   EQU   3                                                                
ERSN05   EQU   5                                                                
ERSN06   EQU   6                                                                
ERSN07   EQU   7                                                                
ERSN09   EQU   9                                                                
ERSN10   EQU   10                                                               
ERSN20   EQU   20                                                               
ERSN21   EQU   21                                                               
ERSN22   EQU   22                                                               
ERSN23   EQU   23                                                               
ERSN24   EQU   24                                                               
ERSN25   EQU   25                                                               
ERSN26   EQU   26                                                               
ERSN27   EQU   27                                                               
ERSN28   EQU   28                                                               
ERSN29   EQU   29                                                               
ERSN30   EQU   30                                                               
ERSN31   EQU   31                                                               
ERSN32   EQU   32                                                               
ERSN33   EQU   33                                                               
ERSN34   EQU   34                                                               
ERSN35   EQU   35                                                               
ERSN36   EQU   36                                                               
ERSN37   EQU   37                                                               
ERSN38   EQU   38                                                               
*                                                                               
*              TABLE OF REASONS FOR NO BILLING                                  
*                                                                               
RSN01    DC    AL1(ERSN01),AL1(L'RSN01M)                                        
RSN01M   DC    C'CAN''T BILL DUE TO OVERSPENDING ESTIMATE PERCENT'              
RSN02    DC    AL1(ERSN02),AL1(L'RSN02M)                                        
RSN02M   DC    C'CAN''T BILL DUE TO BALANCE LESS THAN ''LOW''.'                 
RSN03    DC    AL1(ERSN03),AL1(L'RSN03M)                                        
RSN03M   DC    C'CAN''T BILL DUE TO OVERSPENDING ESTIMATE AMOUNT.'              
RSN05    DC    AL1(ERSN05),AL1(L'RSN05M)                                        
RSN05M   DC    C'CAN''T BILL - JOB HAS UNBILLABLE BILLING TYPE.'                
RSN06    DC    AL1(ERSN06),AL1(L'RSN06M)                                        
RSN06M   DC    C'JOB DOES NOT HAVE AN ESTIMATE.'                                
RSN07    DC    AL1(ERSN07),AL1(L'RSN07M)                                        
RSN07M   DC    C'JOB HAS NO ESTIMATE,CHARGES OR BILLING.'                       
RSN09    DC    AL1(ERSN09),AL1(L'RSN09M)                                        
RSN09M   DC    C'CLIENT BILLING JOB.'                                           
RSN10    DC    AL1(ERSN10),AL1(L'RSN10M)                                        
RSN10M   DC    C'JOB HAS UNAPPROVED ESTIMATE.'                                  
RSN20    DC    AL1(ERSN20),AL1(L'RSN20M)                                        
RSN20M   DC    C'JOB HAS UNDEFINED BILL TYPE.'                                  
RSN21    DC    AL1(ERSN21),AL1(L'RSN21M)                                        
RSN21M   DC    C'JOB HAS SK INCOME - MUST BE TOTAL OR %EST BILL TYPE.'          
RSN22    DC    AL1(ERSN22),AL1(L'RSN22M)                                        
RSN22M   DC    C'NO BILLABLE ITEMS FOR SELECTED WORKCODES.'                     
RSN23    DC    AL1(ERSN23),AL1(L'RSN23M)                                        
RSN23M   DC    C'NO TRANSACTIONS MARKED ON ORIGINAL RUN.'                       
RSN24    DC    AL1(ERSN24),AL1(L'RSN24M)                                        
RSN24M   DC    C'IF OPTION 6 USED - JOB MUST BE TOTAL OR PROGRESSIVE.'          
RSN25    DC    AL1(ERSN25),AL1(L'RSN25M)                                        
RSN25M   DC    C'%ESTIMATE BILL - BILLED 100% OR PERCENT IS ZERO.'              
RSN26    DC    AL1(ERSN26),AL1(L'RSN26M)                                        
RSN26M   DC    C'CAN''T BILL/UNBILL - JOB IS CLOSED.'                           
RSN27    DC    AL1(ERSN27),AL1(L'RSN27M)                                        
RSN27M   DC    C'JOB ALREADY BILLED TODAY.'                                     
RSN28    DC    AL1(ERSN28),AL1(L'RSN28M)                                        
RSN28M   DC    C'%ESTIMATE IS EQUAL TO PREVIOUS BILLS.'                         
RSN29    DC    AL1(ERSN29),AL1(L'RSN29M)                                        
RSN29M   DC    C'CAN''T BILL - JOB HAS CLIENT WP BILLING'                       
RSN30    DC    AL1(ERSN30),AL1(L'RSN30M)                                        
RSN30M   DC    C'BILLING FILTERS USED TO EXCLUDE.'                              
RSN31    DC    AL1(ERSN31),AL1(L'RSN31M)                                        
RSN31M   DC    C'JOB IS DEFINED AS AN ''X-JOB''.'                               
RSN32    DC    AL1(ERSN32),AL1(L'RSN32M)                                        
RSN32M   DC    C'BILLTYPE MUST BE PROGRESSIVE OR ESTIMATE TO USE SELECTX        
               IVE WC''S'                                                       
RSN33    DC    AL1(ERSN33),AL1(L'RSN33M)                                        
RSN33M   DC    C'BILLTYPE AUTO BUT NO CYCLE RECORDS EXIST'                      
RSN34    DC    AL1(ERSN34),AL1(L'RSN34M)                                        
RSN34M   DC    C'CYCLE BILLING OUT OF SEQUENCE'                                 
RSN35    DC    AL1(ERSN35),AL1(L'RSN35M)                                        
RSN35M   DC    C'CYCLE DATE SPECIFIED, BILLTYPE NOT ''AUTO'''                   
RSN36    DC    AL1(ERSN36),AL1(L'RSN36M)                                        
RSN36M   DC    C'CAN''T BILL - JOB IS NOT FUNDED'                               
RSN37    DC    AL1(ERSN37),AL1(L'RSN37M)                                        
RSN37M   DC    C'CAN''T BILL - MISSING ACCOUNT(S) FOR PERCENT OF BILLINX        
               G'                                                               
RSN38    DC    AL1(ERSN38),AL1(L'RSN38M)                                        
RSN38M   DC    C'CAN''T BILL - MISSING WORKCODE FOR PERCENT OF BILLING'         
         EJECT                                                                  
*                                                                               
ESSN01   EQU   01                                                               
ESSN02   EQU   02                                                               
ESSN03   EQU   03                                                               
ESSN04   EQU   04                                                               
ESSN05   EQU   05                                                               
ESSN06   EQU   06                                                               
ESSN07   EQU   07                                                               
*                                                                               
*              TABLE OF SPECIAL REASONS FOR NO BILLING                          
*                                                                               
SSN01    DC    AL1(ESSN01),AL1(L'SSN01M)                                        
SSN01M   DC    C'CAN''T BILL - JOB HAS MEDIA TRANSFER DATA'                     
SSN02    DC    AL1(ESSN02),AL1(L'SSN02M)                                        
SSN02M   DC    C'CAN''T BILL - JOB HAS RETAIL/NON-RETAIL CONFLICT'              
SSN03    DC    AL1(ESSN03),AL1(L'SSN03M)                                        
SSN03M   DC    C'CAN''T BILL AS PROGRESSIVE - INTERNAL/B7 INCOME EXISTSX        
               '                                                                
SSN04    DC    AL1(ESSN04),AL1(L'SSN04M)                                        
SSN04M   DC    C'CAN''T BILL - STUDIO JOB IS MISSING LINK'                      
SSN05    DC    AL1(ESSN05),AL1(L'SSN05M)                                        
SSN05M   DC    C'CAN''T BILL RETAIL FOR STUDIO JOB WITH LINK'                   
SSN06    DC    AL1(ESSN06),AL1(L'SSN06M)                                        
SSN06M   DC    C'CAN''T BILL - INVALID BILL TYPE FOR STUDIO JOB WITH LIX        
               NK'                                                              
SSN07    DC    AL1(ESSN07),AL1(L'SSN07M)                                        
SSN07M   DC    C'CAN''T BILL - AUTHORIZATION RECORD MISSING'                    
         DC    X'FF'                                                            
         DROP  RA,RB                                                            
         EJECT                                                                  
         LTORG                                                                  
         TITLE 'AC21 - PRODUCTION BILLING - POSTING ROUTINES'                   
POSTR    DS    0D                                                               
         NMOD1 0,*POST*,RA,R9                                                   
         L     RC,0(R1)                                                         
         MVC   POSTMODE,0(R1)                                                   
         CLI   POSTMODE,POSTBILL                                                
         BE    WRITPOST            REGULAR POSTINGS                             
         CLI   POSTMODE,POSTCLSE                                                
         BE    WRITOTAL            TOTAL AND CLOSE                              
         CLI   POSTMODE,POSTSK                                                  
         BE    REVERSIT            REVERSE SK POSTINGS                          
         CLI   POSTMODE,POSTOPEN                                                
         BE    OPENPOST            OPEN WORKER FILE                             
         CLI   POSTMODE,POSTGRP                                                 
         BE    PSTGBIL             POST GROUP BILL                              
         CLI   POSTMODE,POSTEST                                                 
         BE    EPREV               REVERSE EST. PRODUCTION                      
         CLI   POSTMODE,POSTINTR                                                
         BE    PSTINTER            MAKE INTERCOMPANY POSTINGS                   
         DC    H'0'                                                             
         B     POSTX                                                            
*                                                                               
POSTX    XIT1                                                                   
         EJECT                                                                  
*              WRITE POSTING FILE DETAILS FOR A BILL                            
*                                                                               
         USING TRNELD,R2                                                        
         USING PSHEADD,R3                                                       
         USING JOBD,R6                                                          
WRITPOST DS    0H                                                               
         LR    R4,R3                                                            
         LA    RE,AREA                                                          
         LA    RF,L'AREA                                                        
         SR    R1,R1                                                            
         MVCL  RE,R0                                                            
         LA    RE,AREA                                                          
         LA    R3,4(RE)                                                         
         MVC   PSHDEL(2),=X'5046'                                               
         SR    R2,R2                                                            
         IC    R2,PSHDLEN                                                       
         LA    R2,0(R2,R3)                                                      
**                                                                              
**             FIRST POSTING IS CREDIT TO THE JOB                               
**                                                                              
**                                                                              
         LA    R5,10                                                            
         LA    R1,TRN2DAY                                                       
         ZAP   0(6,R1),=P'0'       FORMER GST FIELDS IN BILL NARRATIVE          
         LA    R1,6(R1)                                                         
         BCT   R5,*-10                                                          
*                                                                               
         ZAP   POSTCD,SAVCD                                                     
         TM    BILLTYPE,TOTAL  FOR TOTAL BILLS SUBTRACT 8/30/84                 
         BZ    WRIT02           PREVIOUS CD THAT IS REALLY NEGATIVE             
         AP    POSTCD,PRVCD     TO CD ON THIS INVOICE                           
*                                                                               
WRIT02   TM    GRPOPT,GRPBILL      GROUP BILLING ?                              
         BZ    *+10                NO                                           
         AP    GRPCD,POSTCD                                                     
*                                                                               
         LA    R6,JOBTOT                                                        
         TM    BILLTYPE,PROG                                                    
         BZ    *+8                                                              
         LA    R6,JOBCHG                                                        
         MVC   JOBPOST(JOBLNQ),0(R6) SAVE POSTING TOTALS                        
         LA    R6,JOBPOST                                                       
         EJECT                                                                  
***********************************************************************         
*                                  GENERATE POSTING AMOUNTS                     
***********************************************************************         
*                                        12 POSTING AMOUNT                      
         ZAP   AMOUNT12,JOBCOMM                                                 
         LA    RE,JOBMED+(JOBCOMM-JOBD)  SUBTRACT MEDIA COSTS                   
         SP    AMOUNT12,0(L'JOBCOMM,RE)  FROM COSTING POSTINGS                  
         AP    AMOUNT12,SKINC            ADD INCOME TRANSFERRED FROM SK         
         TM    GRPOPT,GRPBILL      GROUP BILLING ?                              
         BZ    *+10                NO                                           
         AP    GRP12,AMOUNT12                                                   
*                                                                               
*                                        11 POSTING AMOUNT                      
         ZAP   AMOUNT11,AMOUNT12                                                
         AP    AMOUNT11,JOBPNET    COMMISSION + NET + GST + PST                 
*                                                                               
         CLI   PROF22,C'Y'         EXCLUDE TAXES?                               
         BNE   WRIT03              NO                                           
         ZAP   AMOUNT11,AMOUNT12   YES, USE JOBNET                              
         AP    AMOUNT11,JOBNET                                                  
*                                                                               
WRIT03   CLI   PROF9,C'G'                FOR GROSS CD                           
         BNE   *+10                                                             
         SP    AMOUNT11,JOBCD            DEDUCT FROM BILLING POSTING            
         LA    RE,JOBMED+(JOBPNET-JOBD)  SUBTRACT MEDIA COSTS                   
         SP    AMOUNT11,0(L'JOBPNET,RE)  FROM COSTING POSTINGS                  
         CLI   PROF9,C'G'                IF GROSS OPTION MEDIA CD               
         BNE   *+14                      HAS BEEN SUBTRACTED TWICE              
         LA    RE,JOBMED+(JOBCD-JOBD)                                           
         AP    AMOUNT11,0(L'JOBCD,RE)   SO ADD IT BACK IN                       
         SP    AMOUNT11,SKINC                                                   
         TM    CLIOPT,PAYNET                                                    
         BZ    *+10                                                             
         SP    AMOUNT11,JOBCOMM                                                 
         TM    GRPOPT,GRPBILL      GROUP BILLING ?                              
         BZ    *+10                NO                                           
         AP    GRP11,AMOUNT11                                                   
*                                                                               
*                                  SJ POSTING AMOUNT                            
         ZAP   AMOUNTSJ,JOBNET  (NET)                                           
         CLI   PROF9,C'G'          FOR GROSS CD OPTION                          
         BNE   *+10                                                             
         SP    AMOUNTSJ,JOBCD   MUST DEDUCT CD FROM INVENTORY                   
         TM    GRPOPT,GRPBILL      GROUP BILLING ?                              
         BZ    *+10                NO                                           
         AP    GRPSJ,AMOUNTSJ                                                   
*                                                                               
*                                  SR POSTING AMOUNT                            
         ZAP   AMOUNTSR,JOBPGRS                                                 
         TM    CLIOPT,PAYNET                                                    
         BZ    *+10                                                             
         ZAP   AMOUNTSR,JOBPNET                                                 
*                                                                               
         TM    GRPOPT,GRPBILL      GROUP BILLING ?                              
         BZ    *+10                NO                                           
         AP    GRPSR,AMOUNTSR                                                   
*                                                                               
*                                                                               
         ZAP   AMOUNTGS,JOBGST                                                  
         LA    RE,JOBMED+(JOBGST-JOBD)   SUBTRACT MEDIA GST                     
         SP    AMOUNTGS,0(L'JOBGST,RE)   FROM GST POSTINGS                      
         TM    GRPOPT,GRPBILL      GROUP BILLING ?                              
         BZ    *+10                NO                                           
         AP    GRPGST,AMOUNTGS                                                  
*                                                                               
         ZAP   AMOUNTPS,JOBPST                                                  
         LA    RE,JOBMED+(JOBPST-JOBD)   SUBTRACT MEDIA PST                     
         SP    AMOUNTPS,0(L'JOBPST,RE)   FROM PST POSTINGS                      
         TM    GRPOPT,GRPBILL      GROUP BILLING ?                              
         BZ    *+10                NO                                           
         AP    GRPPST,AMOUNTPS                                                  
*                                                                               
         AP    SCIUNET,AMOUNTSJ    ADD TO 99 TOTAL                              
*                                                                               
         BRAS  RE,ADD2SUB          ADD POSTING ACCOUNTS TO SUBTAB               
         BRAS  RE,BUILDDB          BUILD THE WORKCODE ELEMENT                   
         EJECT                                                                  
***********************************************************************         
**             POSTING FOR CREDIT TO SJ                                         
***********************************************************************         
**                                                                              
         MVI   TRNEL,TRNELQ        FILL IN TRANSACTION                          
         MVI   TRNLN,121                                                        
         MVC   TRNDATE,DATE3                                                    
         MVC   TRNREF,BILLREF                                                   
         MVI   TRNTYPE,6                                                        
         ZAP   TRNAMNT,AMOUNTSJ                                                 
         MVC   TRNANAL,=C'99'                                                   
         MVC   TRNBTCH(2),MOS                                                   
         MVC   TRNNARR(15),BILLNAME                                             
         MVC   TRNQTFLT,QTRNSFLT       WORKCODE FILTER                          
*                                                                               
         ZAP   TRNBLCOM,JOBCOMM                                                 
         TM    JOBOPT,JOBSK                                                     
         BZ    *+16                                                             
         ZAP   TRNAM2SK,JOBCOMM        INCOME POSTED TO SK                      
         XC    TRNSK2SI,TRNSK2SI       CLEAR DATE                               
         TM    CLIOPT,PAYNET                                                    
         BZ    *+10                                                             
         ZAP   TRNAM2SK,=P'0'          IF PAY=NET, NOTHING POSTED TO SK         
         ZAP   TRNBLCD,POSTCD                                                   
         ZAP   TRNBLPAY,TRNAMNT                                                 
         LA    RF,JOBMED+(JOBNET-JOBD)   POST MEMO OF MEDIA                     
         ZAP   TRNMDCST,0(L'JOBNET,RF)   COSTS TO NARRATIVE                     
         TM    CLIOPT,PAYNET                                                    
         BO    *+10                                                             
         AP    TRNBLPAY,JOBCOMM         PAYABLE AMOUNT                          
         MVC   TRN2DAY,TODAY2                                                   
         AP    TOTBL,TRNAMNT                                                    
         ZAP   TRNRTPCT,=P'0'                                                   
         MVC   TRNBTYPE,BILLCODE                                                
         ZAP   TRNBINTI,JOBINT                                                  
*                                                                               
         L     R5,ARETAIL                                                       
         USING RTLD,R5                                                          
         LTR   R5,R5                                                            
         BZ    *+10                                                             
         ZAP   TRNRTPCT,RTLPCT                                                  
         DROP  R5                                                               
*                                                                               
         LR    RF,R2                                                            
         SR    RE,RE                                                            
         IC    RE,TRNLN                                                         
         AR    RF,RE                                                            
*                                                                               
         BAS   RE,BUILD48          BUILD GST ELEMENT                            
*                                                                               
         USING DUEELD,RF                                                        
         MVI   DUEEL,DUEELQ      DUE DATE TO JOB POSTING                        
         MVI   DUELN,DUELNQ                                                     
         MVC   DUEDATE,DUE2                                                     
         SR    RE,RE                                                            
         IC    RE,DUELN                                                         
         AR    RF,RE                                                            
*                                                                               
         USING PTAELD,RF                                                        
         MVI   PTAEL,PTAELQ        CREATE 77 ELEMENT                            
         MVI   PTALN,PTARLN1Q                                                   
         MVC   PTADATE,TODAY2                                                   
         MVI   PTATYPE,PTATRAL                                                  
         MVI   PTASTAT1,PTASCASH                                                
         TM    BILLMODE,UNBILL     ARE WE UNBILLING?                            
         BZ    *+8                 NO                                           
         OI    PTASTAT1,PTASREVS   YES, MARK THE 77 ACCORDINGLY                 
*                                                                               
         MVC   PTARDATE,TODAY2                                                  
         MVC   PTARBLDT,RCDAY2                                                  
         MVC   PTAMOA,DATE3                                                     
*                                                                               
         MVC   PTARBLNO,BILLREF                                                 
         MVC   PTARCODE,BILLCODE   SAVE THE TYPE OF BILLING                     
         ZAP   PTANET,AMOUNTSJ                                                  
         MVC   PTACUR,CURCOD                                                    
*                                                                               
         ZAP   PTANETF,=P'0'       THESE FIELDS NOT USED                        
         ZAP   PTACDSC,=P'0'                                                    
         ZAP   PTARCORT,=P'0'                                                   
         ZAP   PTARCOM,=P'0'                                                    
*                                                                               
         TM    GRPOPT,GRPBILL      IS THIS A GROUP BILL?                        
         BZ    *+10                NO                                           
         MVC   PTARFORM,=C'0P'     YES, SAVE THE FORMAT/LEVEL                   
*                                                                               
         L     R5,ARETAIL                                                       
         LTR   R5,R5               RETAIL BILLING?                              
         BZ    WRIT04              NO                                           
         L     RE,ARETSTRT         YES, GET TO BEGINNING OF TABLE               
         CR    R5,RE               ARE WE AT THE FIRST ENTRY?                   
         BE    *+8                 YES, LEAVE BIT ZERO                          
         OI    PTASTAT2,PTASRETB   NO, INDICATE CAN'T UNBILL THIS GUY           
*                                                                               
WRIT04   SR    RE,RE                                                            
         IC    RE,PTALN                                                         
         AR    RF,RE                                                            
*                                                                               
         BAS   RE,BUILD7D          BUILD PST ELEMENT                            
*                                                                               
         USING PIDELD,RF                                                        
         MVI   PIDEL,PIDELQ        BUILD PID ELEMENT                            
         MVI   PIDLN,PIDLNQ                                                     
         MVC   PIDNO,USERPID                                                    
         SR    RE,RE                                                            
         IC    RE,PIDLN                                                         
         AR    RF,RE                                                            
         MVI   0(RF),0                                                          
*                                                                               
         CP    SAVEPN,=P'0'                                                     
         BE    WRIT05                                                           
*                                                                               
         USING FFTELD,RF                                                        
         MVI   FFTEL,FFTELQ                                                     
         MVI   FFTLN,FFTLN1Q+L'FFTDLEN+L'FFTESTA                                
         MVI   FFTTYPE,FFTTESTP                                                 
         MVI   FFTSEQ,0                                                         
         MVI   FFTDLEN,L'FFTESTA                                                
         ZAP   FFTESTN,SAVEPN                                                   
         ZAP   FFTESTC,SAVEPC                                                   
         SR    RE,RE                                                            
         IC    RE,FFTLN                                                         
         AR    RF,RE                                                            
         MVI   0(RF),0             MARK END OF RECORD                           
*                                                                               
         USING BSCELD,RF                                                        
WRIT05   MVI   BSCEL,BSCELQ      SAVE THE BILLING SOURCE                        
         MVI   BSCLN,BSCLNQ                                                     
         MVC   BSCBSRC,MEDNAME+3                                                
*                                                                               
         TM    REQOPT,REQMEDO      FOR MEDIA ONLY?                              
         BZ    *+10                NO                                           
         MVC   BSCBSRC,=CL12'PRINT MEDIA'                                       
*                                                                               
         TM    GRPOPT,GRPBILL      IS THIS A GROUP BILLING?                     
         BZ    *+10                NO                                           
         MVC   BSCBSRC,=CL12'PRODUCTION '                                       
*                                                                               
         OC    BSCBSRC,SPACES                                                   
         MVC   BSCBOFF,OFFC                                                     
*                                                                               
         SR    RE,RE                                                            
         IC    RE,BSCLN                                                         
         AR    RF,RE                                                            
*                                                                               
         L     R5,ARETAIL                                                       
         LTR   R5,R5               RETAIL BILLING?                              
         BZ    WRIT06              NO                                           
*                                                                               
         USING CPJELD,RF                                                        
         MVI   CPJEL,CPJELQ                                                     
         MVI   CPJLN,CPJLNQ                                                     
         MVI   CPJTYPE,C'R'         SAVE RECEIVABLE ACCOUNT                     
         MVC   CPJRULA,RECEIVBL+1                                               
*                                                                               
         SR    RE,RE                                                            
         IC    RE,CPJLN                                                         
         AR    RF,RE                                                            
*                                                                               
WRIT06   MVI   0(RF),0             MARK END OF RECORD IN CASE                   
         DROP  RF                                                               
*                                                                               
         TM    JOBOPT,JBSTUDIO     IS THIS A STUDIO JOB?                        
         BZ    WRIT07              NO                                           
*                                                                               
         USING LNKEL,RF                                                         
         MVC   LNKEL(LNKLNQ),SVELEM                                             
         SR    RE,RE                                                            
         IC    RE,LNKLN                                                         
         AR    RF,RE                                                            
         MVI   0(RF),0                                                          
*                                                                               
WRIT07   L     R1,AESTPOOL         ADD ESTIMATE ELEMENTS FROM POOL              
         TM    BILLTYPE,ESTIM      ADD THIS IN CASE BILLTYPE ON UNBILL          
         BZ    WRIT09              WAS WRONG BEFORE GOING TO BILLNUM            
*                                                                               
WRIT08   CLI   0(R1),0                                                          
         BE    WRIT09                                                           
         ZIC   RE,1(R1)                                                         
         BCTR  RE,0                                                             
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RF),0(R1)       ELEMENT TO IO AREA FROM POOL                 
         LA    RF,1(RE,RF)         NEXT IO AREA                                 
         MVI   0(RF),0             MARK END IN CASE LAST ONE                    
         LA    R1,1(RE,R1)         NEXT ITEM IN POOL                            
         B     WRIT08                                                           
*                                                                               
WRIT09   BAS   RE,FORMB7           FORMAT PREVIOUS 1ST TIME THROUGH             
         BAS   RE,BUILDB7          ADD INCOME ELEMENTS                          
         MVI   0(RF),0             MARK END OF RECORD                           
*                                                                               
         L     R5,ADACC            FILL IN HEADER FOR NET BILL TO JOB           
         MVC   PSHDACC,0(R5)                                                    
         MVC   PSHDANAL,=C'99'                                                  
         MVC   PSHDSBAC,RECEIVBL                                                
         MVC   PSHDSBNM,CLINAME                                                 
                                                                                
         L     R5,ARETAIL                                                       
         USING RTLD,R5                                                          
         LTR   R5,R5                                                            
         BZ    WRIT10                   NOT RETAIL                              
         MVC   PSHDSBAC,RTLDIS          CONTRA TO JOB IS RETAILER               
         MVC   PSHDSBNM,RTLNME                                                  
         DROP  R5                                                               
*                                                                               
         USING FFTELD,RE                                                        
WRIT10   LA    RE,SVDBELM          UPDATE THE FFTEL                             
         MVC   FFTWORK,PSHDANAL                                                 
         ZAP   FFTWAMT,TRNAMNT                                                  
         DROP  RE                                                               
*                                                                               
         BRAS  RE,BUILDC0                                                       
         MVI   0(RF),0             MARK END OF RECORD                           
         BAS   RE,PUTTAPE                                                       
         EJECT                                                                  
***********************************************************************         
**             POSTING FOR CREDIT TO INCOME (COMMISSION)                        
***********************************************************************         
**                                                                              
         ZAP   TRNAMNT,=P'0'                                                    
         TM    CLIOPT,PAYNET                                                    
         BO    *+10                                                             
         ZAP   TRNAMNT,JOBCOMM     NOW AMEND FOR THE COMMISSION POSTING         
         ZAP   INCOME,TRNAMNT      SAVE INCOME AMOUNT POSTING                   
         AP    TOTCOM,TRNAMNT                                                   
         MVC   TRNANAL,OFFC                                                     
         MVI   TRNLN,X'2B'         (SHORTEN NARRATIVE)                          
         MVI   TRNBLCOM,0                                                       
         MVC   PSHDANAL,SPACES                                                  
         MVC   PSHDACC,COMMAC                                                   
         MVC   PSHDSBAC,PRODNUM                                                 
         MVC   PSHDSBNM,PRODNAM                                                 
         TM    JOBOPT,JBSTUDIO     IS THIS A STUDIO JOB?                        
         BZ    WRIT11              NO                                           
         MVC   PSHDSBAC,JOBCODE    YES, CONTRA IS STUDIO JOB                    
         MVC   PSHDSBNM,JOBNAME                                                 
*                                                                               
WRIT11   LR    RF,R2                                                            
         SR    RE,RE                                                            
         IC    RE,TRNLN                                                         
         AR    RF,RE                                                            
*                                                                               
         L     R5,ARETAIL                                                       
         USING RTLD,R5                                                          
         LTR   R5,R5                                                            
         BZ    WRIT12                                                           
*                                                                               
         USING SPAELD,RF                                                        
         MVI   SPAEL,SPAELQ        RETAIL ONLY                                  
         MVI   SPALN,SPALNQ                                                     
         MVI   SPATYPE,SPATPART                                                 
         MVC   SPAAULA,RTLDIS+1                                                 
         DROP  R5                                                               
*                                                                               
         SR    RE,RE                                                            
         IC    RE,SPALN                                                         
         AR    RF,RE                                                            
*                                                                               
         USING SCIELD,RF                                                        
WRIT12   MVI   SCIEL,SCIELQ      ADD GROSS BILLING ELEMENT TO INCOME            
         MVI   SCILN,SCILN1Q                                                    
         MVI   SCITYPE,C'G'                                                     
*                                                                               
         CLI   PROF22,C'Y'         EXCLUDE TAXES?                               
         BNE   WRIT12A             NO                                           
         ZAP   SCIAMNT,JOBGRS                                                   
         LA    RE,JOBMED+(JOBGRS-JOBD)    SUBTRACT MEDIA COSTS                  
         SP    SCIAMNT,0(L'JOBGRS,RE)    MEMO GROSS                             
         B     WRIT12B                                                          
*                                                                               
WRIT12A  ZAP   SCIAMNT,JOBPGRS                                                  
         LA    RE,JOBMED+(JOBPGRS-JOBD)    SUBTRACT MEDIA COSTS                 
         SP    SCIAMNT,0(L'JOBPGRS,RE)    MEMO GROSS                            
*                                                                               
WRIT12B  CLI   PROF9,C'G'          IF GROSS CD OPTION                           
         BNE   WRIT13              MUST SUBTRACT PRODUCTION CD                  
         ZAP   DUB,JOBCD           WHICH IS TOTAL CD                            
         LA    RE,JOBMED+(JOBCD-JOBD)                                           
         SP    DUB,0(L'JOBCD,RE)   MINUS MEDIA CD                               
         SP    SCIAMNT,DUB                                                      
*                                                                               
WRIT13   MVI   SCIAMNT+6,0        MARK END OF RECORD                            
         TM    CLIOPT,PAYNET                                                    
         BZ    *+10                                                             
         SP    SCIAMNT,JOBCOMM    GROSS BECOMES NET IN MEMO ITEM                
         CLI   SVZERO,C'Y'         ZERO GROSS BILLINGS?                         
         BNE   WRIT14              NO                                           
         ZAP   SCIAMNT,=P'0'      YES                                           
*                                                                               
WRIT14   AP    TRNAMNT,SKINC       ADD INCOME TO BE REVERSED FROMSK             
         TM    JOBOPT,JOBSK                                                     
         BZ    *+10                NOT % ESTIMATE JOB                           
         ZAP   TRNAMNT,=P'0'       IF IT IS SI POSTING IS ZERO                  
*                                                                               
         SR    RE,RE                                                            
         IC    RE,SCILN                                                         
         AR    RF,RE                                                            
*                                                                               
         LA    R4,1                GET LEVEL 1 DATA                             
         BAS   RE,BUILD50          GST PST DETAILS                              
         BAS   RE,BUILDB7          INCOME ELEMENTS                              
                                                                                
         LA    R1,ADD6A            ADD NEW (PACKED ELEMENT)                     
         CP    AMOUNTSJ,HIAMT      TEST AMOUNTS TOO LARGE                       
         BH    WRIT14A                                                          
         CP    AMOUNT11,HIAMT                                                   
         BH    WRIT14A                                                          
         CP    AMOUNT12,HIAMT                                                   
         BH    WRIT14A                                                          
         CP    JOBINT,HIAMT                                                     
         BH    WRIT14A                                                          
*                                                                               
         CP    AMOUNTSJ,LOAMT      TEST AMOUNTS TOO SMALL                       
         BL    WRIT14A                                                          
         CP    AMOUNT11,LOAMT                                                   
         BL    WRIT14A                                                          
         CP    AMOUNT12,LOAMT                                                   
         BL    WRIT14A                                                          
         CP    JOBINT,LOAMT                                                     
         BL    WRIT14A                                                          
         LA    R1,ADD1A            ADD BINARY ELEMENT                           
*                                                                               
WRIT14A  BASR  RE,R1                                                            
         B     WRIT15                                                           
*                                                                               
HIAMT    DC    PL6'2100000000'                                                  
LOAMT    DC    PL6'-2100000000'                                                 
         EJECT                                                                  
***********************************************************************         
* ADD BINARY 1A ELEMENT                                              *          
***********************************************************************         
                                                                                
ADD1A    LR    R0,RE                                                            
         USING MDTELD,RF                                                        
         BAS   RE,SET1A            INITIALIZE MEDIA ELEMENT                     
         ZAP   DUB,JOBINT          FILL IN AMOUNTS                              
         CVB   RE,DUB                                                           
         STCM  RE,15,MDTINTL                                                    
         ZAP   DUB,AMOUNTSJ                                                     
         CVB   R1,DUB                                                           
         SR    R1,RE                                                            
         STCM  R1,15,MDTNET                                                     
         TM    CLIOPT,PAYNET       PAY = NET OR SNET ?                          
         BO    ADD1A3              YES, LEAVE INCOME AS ZERO                    
         ZAP   DUB,AMOUNT12                                                     
         CVB   RE,DUB                                                           
         STCM  RE,15,MDTCOM                                                     
*                                                                               
ADD1A3   ZAP   DUB,AMOUNT11                                                     
         CVB   RE,DUB                                                           
         STCM  RE,15,MDTGRS                                                     
         ZAP   DUB,JOBCD                                                        
         CVB   RE,DUB                                                           
         STCM  RE,15,MDTCD                                                      
         ZAP   DUB,AMOUNTSR                                                     
         CVB   RE,DUB                                                           
         STCM  RE,15,MDTRECV                                                    
         ZAP   DUB,AMOUNTGS                                                     
         CVB   RE,DUB                                                           
         STCM  RE,15,MDTVAT                                                     
         SR    RE,RE                                                            
         IC    RE,MDTLN                                                         
         AR    RF,RE                                                            
         MVI   0(RF),X'00'         MARK END OF RECORD                           
         LR    RE,R0                                                            
         BR    RE                                                               
         DROP  RF                                                               
*                                                                               
         EJECT                                                                  
***********************************************************************         
* ADD PACKED 6A ELEMENT                                              *          
***********************************************************************         
                                                                                
ADD6A    LR    R0,RE                                                            
         USING MDPELD,RF                                                        
         BAS   RE,SET6A            INITIALIZE MEDIA ELEMENT                     
         ZAP   MDPINTL,JOBINT                                                   
         ZAP   DUB,AMOUNTSJ                                                     
         SP    DUB,JOBINT                                                       
         ZAP   MDPNET,DUB                                                       
         TM    CLIOPT,PAYNET       PAY = NET OR SNET ?                          
         BO    ADD6A3              YES, LEAVE INCOME AS ZERO                    
         ZAP   MDPCOM,AMOUNT12                                                  
*                                                                               
ADD6A3   ZAP   MDPGRS,AMOUNT11                                                  
         ZAP   MDPCD,JOBCD                                                      
         ZAP   MDPRECV,AMOUNTSR                                                 
         ZAP   MDPVAT,AMOUNTGS                                                  
         SR    RE,RE                                                            
         IC    RE,MDPLN                                                         
         AR    RF,RE                                                            
         MVI   0(RF),X'00'         MARK END OF RECORD                           
         LR    RE,R0                                                            
         BR    RE                                                               
         DROP  RF                                                               
         EJECT                                                                  
WRIT15   TM    JOBOPT,JBSTUDIO     IS THIS A STUDIO JOB?                        
         BZ    WRIT16              NO                                           
*                                                                               
         USING LNKEL,RF                                                         
         MVC   LNKEL(LNKLNQ),SVELEM                                             
         SR    RE,RE                                                            
         IC    RE,LNKLN                                                         
         AR    RF,RE                                                            
         MVI   0(RF),0                                                          
*                                                                               
WRIT16   BRAS  RE,BUILDC0                                                       
         BAS   RE,MOVEFFT                                                       
         MVI   0(RF),0             MARK END OF RECORD                           
         BAS   RE,PUTTAPE                                                       
                                                                                
         USING SCIELD,RF                                                        
         LR    RF,R2                                                            
         SR    RE,RE                                                            
         IC    RE,TRNLN                                                         
         AR    RF,RE               BYPASS IT FOR NEXT POSTING                   
         MVI   SCIAMNT+6,0                                                      
         EJECT                                                                  
***********************************************************************         
*              OPTION TO  POST CD TO SIMD IF PROF9=G -PRODUCTION                
***********************************************************************         
*                                                                               
         CLI   PROF9,C'G'          GROSS CD OPTION ?                            
         BNE   WRIT20              NO                                           
         MVC   PSHDACC,CDACCT      CD ACCOUNT                                   
         ZAP   TRNAMNT,JOBCD             CASH DISCOUNT                          
         LA    RE,JOBMED+(JOBCD-JOBD)    SUBTRACT MEDIA CD                      
         SP    TRNAMNT,0(L'JOBCD,RE)     FROM TOTAL CD                          
         CP    TRNAMNT,=P'0'                                                    
         BE    WRIT18                                                           
         ZAP   SCIAMNT,=P'0'       MEMO OF ZERO                                 
                                                                                
         SR    RE,RE                                                            
         IC    RE,SCILN                                                         
         AR    RF,RE                                                            
                                                                                
         BRAS  RE,BUILDC0                                                       
         BAS   RE,MOVEFFT                                                       
         MVI   0(RF),0             MARK END OF RECORD                           
         BAS   RE,PUTTAPE                                                       
*                                                                               
*              OPTION TO  POST CD TO SIMP IF PROF9=G -PRINT                     
*                                                                               
WRIT18   MVC   PSHDACC,PRCDACCT    PRINT CD ACCOUNT                             
         LA    RE,JOBMED+(JOBCD-JOBD)     MEDIA CD                              
         ZAP   TRNAMNT,0(L'JOBCD,RE)                                            
         CP    TRNAMNT,=P'0'                                                    
         BE    WRIT20                                                           
         ZAP   SCIAMNT,=P'0'           MEMO OF ZERO                             
                                                                                
         SR    RE,RE                                                            
         IC    RE,SCILN                                                         
         AR    RF,RE                                                            
                                                                                
         BRAS  RE,BUILDC0                                                       
         BAS   RE,MOVEFFT                                                       
         MVI   0(RF),0             MARK END OF RECORD                           
         BAS   RE,PUTTAPE                                                       
*                                                                               
*              OPTION TO  POST PERCENT OF ESTIMATE JOBS TO SK                   
*                                                                               
WRIT20   TM    JOBOPT,JOBSK                                                     
         BZ    WRIT22              NOT % ESTIMATE JOB                           
         MVC   PSHDACC,COMMAC      RESET KEY                                    
         MVI   PSHDACC+2,C'K'      CHANGE SI TO SK                              
         MVC   PSHDSBAC,JOBCODE    CONTRA IS CLIENT/PRODUCT/JOB                 
         MVC   PSHDSBNM,JOBNAME                                                 
         ZAP   TRNAMNT,INCOME       INCOME TO SK                                
         ZAP   SCIAMNT,=P'0'       MEMO OF ZERO                                 
                                                                                
         SR    RE,RE                                                            
         IC    RE,SCILN                                                         
         AR    RF,RE                                                            
                                                                                
         BRAS  RE,BUILDC0                                                       
         BAS   RE,MOVEFFT                                                       
         MVI   0(RF),0             MARK END OF RECORD                           
         BAS   RE,PUTTAPE                                                       
         EJECT                                                                  
***********************************************************************         
*              DEBIT POSTING TO RECEIVABLES                                     
***********************************************************************         
*                                                                               
WRIT22   MVC   PSHDSBNM,SPACES                                                  
         OI    TRNSTAT,X'80'       ADJUST FOR THE RECEIVABLE POSTING            
         ZAP   TRNAMNT,AMOUNTSR                                                 
         MVC   PSHDACC,RECEIVBL                                                 
         CLI   PSHDACC,X'40'                                                    
         BH    *+6                                                              
         DC    H'0'                BAD RECEIVABLE CODE                          
*                                                                               
         L     R5,ARETAIL                                                       
         USING RTLD,R5                                                          
         LTR   R5,R5                                                            
         BZ    WRIT24                                                           
         CLI   RTLRECV,X'40'                                                    
         BNH   WRIT24                                                           
         MVC   PSHDACC,RTLRECV          RETAIL RECEIVABLE                       
         DROP  R5                                                               
*                                                                               
WRIT24   MVC   PSHDSBAC,MEDNAME                                                 
         TM    REQOPT,REQMEDO      FOR MEDIA ONLY                               
         BZ    *+10            USE SPECIAL CONTRA NAME ON RECEIVABLE            
         MVC   PSHDSBAC(15),=CL15'   PRINT MEDIA'                               
*                                                                               
         CLC   PSHDACC+1(2),=C'SB' IF RECEIVABLE SB, CONTRA IS JOBCODE          
         BNE   *+10                                                             
         MVC   PSHDSBAC,JOBCODE                                                 
*                                                                               
         LR    RF,R2                                                            
         SR    RE,RE                                                            
         IC    RE,TRNLN                                                         
         AR    RF,RE                                                            
*                                                                               
         USING OTHELD,RF                                                        
         MVI   OTHEL,OTHELQ                                                     
         MVI   OTHLN,OTHLN1Q                                                    
         MVC   OTHNUM(13),SPACES                                                
         MVI   OTHPROF,C'J'                                                     
         L     RE,ADACC                                                         
         MVC   OTHNUM,6(RE)                                                     
         SR    RE,RE                                                            
         IC    RE,OTHLN                                                         
         AR    RF,RE                                                            
*                                                                               
         L     R5,ARETAIL                                                       
         USING RTLD,R5                                                          
         LTR   R5,R5                                                            
         BZ    WRIT25                                                           
         USING SPAELD,RF                                                        
         XC    0(SPALNQ,RF),0(RF)  CLEAR THE ELEMENT                            
         MVI   SPAEL,SPAELQ        RETAIL ONLY                                  
         MVI   SPALN,SPALNQ                                                     
         MVI   SPATYPE,SPATPART                                                 
         MVC   SPAAULA,RTLDIS+1                                                 
         DROP  R5                                                               
*                                                                               
         SR    RE,RE                                                            
         IC    RE,SPALN                                                         
         AR    RF,RE                                                            
*                                                                               
         USING CPJELD,RF                                                        
WRIT25   MVI   CPJEL,CPJELQ            ADD CLI/PRD/JOB ELEMENT                  
         MVI   CPJLN,X'17'                                                      
         MVI   CPJTYPE,C'J'             TO RECEIVABLE POSTING                   
         MVC   CPJCLI(20),SPACES                                                
         L     RE,ADACC                                                         
         MVC   CPJCLI(3),3(RE)                                                  
         MVC   CPJPRO(3),6(RE)                                                  
         MVC   CPJJOB(6),9(RE)                                                  
         SR    RE,RE                                                            
         IC    RE,CPJLN                                                         
         AR    RF,RE                                                            
*                                                                               
         USING SCIELD,RF                                                        
         MVI   SCIEL,SCIELQ                                                     
         MVI   SCILN,SCILN1Q                                                    
         MVI   SCITYPE,C'D'       CASH DISCOUNT ELEMENT                         
         ZAP   SCIAMNT,POSTCD                                                   
         CLI   PROF9,C'G'                                                       
         BNE   *+10                                                             
         MP    SCIAMNT,=P'-1'                                                   
         CP    SCIAMNT,=P'0'                                                    
         BE    WRIT26              NO 50 IF NO CD                               
*                                                                               
         SR    RE,RE                                                            
         IC    RE,SCILN                                                         
         AR    RF,RE                                                            
*                                                                               
WRIT26   MVI   SCIEL,SCIELQ                                                     
         MVI   SCILN,SCILN1Q                                                    
         MVI   SCITYPE,C'I'     ADD INCOME ELEMENT TO                           
         ZAP   SCIAMNT,INCOME   RECEIVABLE POSTING                              
         AP    SCIAMNT,SKINC                                                    
         TM    JOBOPT,JOBSK                                                     
         BZ    *+10                                                             
         ZAP   SCIAMNT,=P'0'   FOR %EST=SK NO INCOME/TILL ADDED TO SI           
*                                                                               
         SR    RE,RE                                                            
         IC    RE,SCILN                                                         
         AR    RF,RE                                                            
*                                                                               
         LA    R4,1                GET LEVEL 1 DATA                             
         BAS   RE,BUILD50          GST PST DETAILS                              
                                                                                
         TM    GRPOPT,GRPBILL                                                   
         BZ    WRIT28              NOT A GROUP BILL POST RECEIVABLE             
         BAS   RE,POSTGRPB         ADD TO GROUP ACCUMS                          
         B     WRIT34              HOLD RECEIVABLE TIL END                      
*                                                                               
         USING DUEELD,RF                                                        
WRIT28   MVI   DUEEL,DUEELQ                                                     
         MVI   DUELN,DUELNQ                                                     
         MVC   DUEDATE,DUE2                                                     
         SR    RE,RE                                                            
         IC    RE,DUELN                                                         
         AR    RF,RE                                                            
*                                                                               
         LA    R1,ADD6A            ADD NEW (PACKED ELEMENT)                     
         CP    AMOUNTSJ,HIAMT      TEST AMOUNTS TOO LARGE                       
         BH    WRIT29                                                           
         CP    AMOUNT11,HIAMT                                                   
         BH    WRIT29                                                           
         CP    AMOUNT12,HIAMT                                                   
         BH    WRIT29                                                           
         CP    JOBINT,HIAMT                                                     
         BH    WRIT29                                                           
*                                                                               
         CP    AMOUNTSJ,LOAMT      TEST AMOUNTS TOO SMALL                       
         BL    WRIT29                                                           
         CP    AMOUNT11,LOAMT                                                   
         BL    WRIT29                                                           
         CP    AMOUNT12,LOAMT                                                   
         BL    WRIT29                                                           
         CP    JOBINT,LOAMT                                                     
         BL    WRIT29                                                           
         LA    R1,ADD1A            ADD BINARY ELEMENT                           
*                                                                               
WRIT29   BASR  RE,R1                                                            
*                                                                               
         USING UFSELD,R5                                                        
         L     R5,AUSRPOOL                                                      
         LA    R6,USRNUM           GET NUMBER OF ENTRIES                        
*                                                                               
WRIT30   CLI   0(R5),X'FF'         ANY ENTRIES ?                                
         BE    WRIT32              NO                                           
*                                                                               
         SR    R1,R1                                                            
         IC    R1,UFSLN                                                         
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RF),UFSEL                                                    
         LA    RF,1(RF,R1)                                                      
         LA    R5,1(R5,R1)                                                      
         BCT   R6,WRIT30                                                        
*                                                                               
WRIT32   BAS   RE,BUILDB7          ADD INCOME ELEMENTS                          
*                                                                               
         TM    JOBOPT,JBSTUDIO     IS THIS A STUDIO JOB?                        
         BZ    WRIT33              NO                                           
*                                                                               
         USING LNKEL,RF                                                         
         MVC   LNKEL(LNKLNQ),SVELEM                                             
         SR    RE,RE                                                            
         IC    RE,LNKLN                                                         
         AR    RF,RE                                                            
*                                                                               
WRIT33   MVI   0(RF),0             MARK END OF RECORD                           
                                                                                
         BRAS  RE,BUILDC0                                                       
         BAS   RE,MOVEFFT                                                       
         MVI   0(RF),0             MARK END OF RECORD                           
         BAS   RE,PUTTAPE                                                       
         EJECT                                                                  
***********************************************************************         
*              MINUS CREDIT TO SK FOR REVERESED DEFERRED INCOME                 
***********************************************************************         
*                                                                               
WRIT34   LR    RF,R2               KILL 23, 50 AND 1A ELEMENTS                  
         SR    RE,RE                                                            
         IC    RE,TRNLN                                                         
         AR    RF,RE                                                            
         MVI   0(RF),0                                                          
         CP    SKINC,=P'0'                                                      
         BE    WRIT36              NO DEFERRED INCOME FROM %EST                 
         ZAP   DUB,SKINC                                                        
         MP    DUB,=P'-1'          MINUS CREDIT TO SK                           
         ZAP   TRNAMNT,DUB                                                      
         MVI   TRNSTAT,0                                                        
         MVC   TRNANAL,OFFC                                                     
         MVI   TRNLN,X'2B'                                                      
         MVI   TRNBLCOM,0                                                       
         MVC   PSHDANAL,SPACES                                                  
         MVC   PSHDACC,COMMAC                                                   
         MVI   PSHDACC+2,C'K'      INCOME ACCOUNT CHANGED TO SK                 
         MVC   PSHDSBAC,JOBCODE    CONTRA IS CLIENT/PRODUCT/JOB                 
         MVC   PSHDSBNM,JOBNAME                                                 
*                                                                               
         LR    RF,R2                                                            
         SR    RE,RE                                                            
         IC    RE,TRNLN                                                         
         AR    RF,RE                                                            
*                                                                               
         USING SCIELD,RF                                                        
         MVI   SCIEL,SCIELQ      ADD GROSS BILLING ELEMENT TO INCOME            
         MVI   SCILN,SCILN1Q                                                    
         MVI   SCITYPE,C'G'                                                     
         ZAP   SCIAMNT,=P'0'                                                    
         MVI   SCIAMNT+6,0                                                      
                                                                                
         SR    RE,RE                                                            
         IC    RE,SCILN                                                         
         AR    RF,RE                                                            
                                                                                
         BRAS  RE,BUILDC0                                                       
         BAS   RE,MOVEFFT                                                       
         MVI   0(RF),0             MARK END OF RECORD                           
         BAS   RE,PUTTAPE                                                       
         EJECT                                                                  
***********************************************************************         
*              COSTING POSTINGS                                                 
***********************************************************************         
*                                                                               
WRIT36   TM    CMPOPT,POSTCOST                                                  
         BZ    WRIT42                                                           
*                                                                               
         LR    RF,R2                                                            
         SR    RE,RE                                                            
         IC    RE,TRNLN                                                         
         AR    RF,RE                                                            
         MVI   0(RF),0             KILL 50 ELEMENT                              
*                                                                               
         ZAP   TRNAMNT,AMOUNT12    CREDIT COSTING SYSTEM COMMISSION             
         TM    CLIOPT,PAYNET                                                    
         BZ    *+10                                                             
         ZAP   TRNAMNT,=P'0'       CLEAR AMOUNT IF PAY=NET                      
         MVI   TRNSTAT,0                                                        
         MVC   PSHDACC,SUSPAC                                                   
         MVC   PSHDSBAC,COSTING                                                 
         CLI   COSTING,X'40'                                                    
         BH    *+6                                                              
         DC    H'0'                BAD COSTING CODE                             
*                                                                               
         MVC   PSHDSBNM,CLINAME                                                 
         TM    JOBOPT,JOBSK         FOR % ESTIMATE=SK, DON'T POST               
         BO    WRIT38               INCOME TILL IT'S ADDED TO SI                
                                                                                
         BRAS  RE,BUILDC0                                                       
         BAS   RE,MOVEFFT                                                       
         MVI   0(RF),0             MARK END OF RECORD                           
*                                                                               
         BAS   RE,PUTTAPE                                                       
*                                                                               
WRIT38   MVI   PSHDACC+2,C'1'      CREDIT COSTING SYSTEM BILLING                
         ZAP   TRNAMNT,AMOUNT11                                                 
         CLI   SVZERO,C'Y'         ZERO GROSS BILLINGS?                         
         BNE   *+10                NO                                           
         ZAP   TRNAMNT,=P'0'       YES, CLEAR AMOUNT                            
                                                                                
         LR    RF,R2                                                            
         SR    RE,RE                                                            
         IC    RE,TRNLN                                                         
         AR    RF,RE                                                            
         MVI   0(RF),0             REMOVE OLD X'C0'                             
*                                                                               
         BRAS  RE,BUILDC0                                                       
         BAS   RE,MOVEFFT                                                       
         MVI   0(RF),0             MARK END OF RECORD                           
*                                                                               
         BAS   RE,PUTTAPE                                                       
*                                                                               
         ZAP   TRNAMNT,AMOUNT12    DEBIT  COSTING CLIENT A/C (COMM)             
         TM    CLIOPT,PAYNET                                                    
         BZ    *+10                                                             
         ZAP   TRNAMNT,=P'0'                                                    
         MVI   TRNSTAT,X'80'                                                    
         MVC   PSHDACC,COSTING                                                  
         MVC   PSHDSBAC,SUSPAC                                                  
         MVC   PSHDSBNM,SPACES                                                  
         MVC   PSHDSBNM(10),=C'PRODUCTION'                                      
         CLC   SUSPAC+3(12),=CL12'3'                                            
         BE    *+10                                                             
         MVC   PSHDSBNM(12),MEDNAME+3                                           
         TM    JOBOPT,JOBSK         FOR % ESTIMATE=SK, DON'T POST               
         BO    WRIT40               INCOME TILL IT'S ADDED TO SI                
                                                                                
         LR    RF,R2                                                            
         SR    RE,RE                                                            
         IC    RE,TRNLN                                                         
         AR    RF,RE                                                            
         MVI   0(RF),0             REMOVE OLD X'C0'                             
*                                                                               
         BRAS  RE,BUILDC0                                                       
         BAS   RE,MOVEFFT                                                       
         MVI   0(RF),0             MARK END OF RECORD                           
*                                                                               
         BAS   RE,PUTTAPE                                                       
*                                                                               
WRIT40   MVI   PSHDSBAC+2,C'1'                                                  
         ZAP   TRNAMNT,AMOUNT11    DEBIT COSTING CLIENT A/C (BILLING)           
         CLI   SVZERO,C'Y'         ZERO GROSS BILLINGS?                         
         BNE   *+10                NO                                           
         ZAP   TRNAMNT,=P'0'       YES, CLEAR AMOUNT                            
                                                                                
         LR    RF,R2                                                            
         SR    RE,RE                                                            
         IC    RE,TRNLN                                                         
         AR    RF,RE                                                            
         MVI   0(RF),0             REMOVE OLD X'C0'                             
*                                                                               
         BRAS  RE,BUILDC0                                                       
         BAS   RE,MOVEFFT                                                       
         MVI   0(RF),0             MARK END OF RECORD                           
*                                                                               
         BAS   RE,PUTTAPE                                                       
         EJECT                                                                  
***********************************************************************         
*              POST CREDITS TO SG (GST) ACCOUNTS                                
***********************************************************************         
*                                                                               
         USING GSTD,R5                                                          
WRIT42   LA    R5,BUFWK                                                         
         XC    GSTKEY(GSTLNQ),GSTKEY                                            
         MVI   GSTTYPE,GSTTYPE5                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),1                           
         TM    DMCB+8,X'80'                                                     
         BO    WRIT52                                                           
*                                                                               
         CLI   GSTTYPE,GSTTYPE5                                                 
         BNE   WRIT52              NOT A GST RECORD                             
         B     WRIT48                                                           
*                                  ELSE GET NEXT RECORD                         
WRIT46   MVI   BYTE,GSTTYPE5                                                    
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),1                         
         TM    DMCB+8,X'80'                                                     
         BO    WRIT52                                                           
*                                                                               
         USING JOBD,R6                                                          
WRIT48   OC    GSTACCT,GSTACCT     DO WE HAVE AN ACCOUNT ?                      
         BZ    WRIT46              NO, GET NEXT ONE                             
         CLI   GSTCODE,X'FF'       TOTAL RECORD?                                
         BE    WRIT46              YES, SKIP IT                                 
         MVC   PSHDACC,GSTACCT                                                  
         MVC   PSHDSBAC,JOBCODE                                                 
         MVC   PSHDSBNM,JOBNAME                                                 
         MVI   TRNSTAT,X'00'                                                    
         MVC   TRNLN,=YL1(TRNLN1Q+L'BILLNAME)                                   
         LA    R6,GSTACCUM                                                      
         CP    JOBGST,=P'0'        DO WE HAVE ANY GST ?                         
         BNE   WRIT50              YES                                          
         CP    JOBVBAS,=P'0'       NO, DO WE HAVE ANY BASIS ?                   
         BE    WRIT46              NO, GET THE NEXT ONE THEN                    
*                                                                               
WRIT50   GOTO1 SHR,DMCB,('SUBRSHR',(RC))                                        
         ZAP   TRNAMNT,JOBGST                                                   
*                                                                               
         LR    RF,R2                                                            
         SR    RE,RE                                                            
         IC    RE,TRNLN                                                         
         AR    RF,RE                                                            
*                                                                               
         USING SCIELD,RF                                                        
         MVI   SCIEL,SCIELQ                                                     
         MVI   SCILN,SCILN1Q                                                    
         MVI   SCITYPE,C'N'                                                     
         ZAP   SCIAMNT,JOBVBAS                                                  
         MVI   SCIAMNT+6,0        END OF RECORD                                 
                                                                                
         SR    RE,RE                                                            
         IC    RE,SCILN                                                         
         AR    RF,RE                                                            
                                                                                
         BRAS  RE,BUILDC0                                                       
         BAS   RE,MOVEFFT                                                       
         MVI   0(RF),0             MARK END OF RECORD                           
         BAS   RE,PUTTAPE                                                       
         B     WRIT46                                                           
         EJECT                                                                  
***********************************************************************         
*              POST CREDITS TO SG (PST) ACCOUNTS                                
***********************************************************************         
*                                                                               
         USING PSTD,R5                                                          
WRIT52   LA    R5,BUFWK                                                         
         XC    PSTKY(PSTLNQ),PSTKY                                              
         MVI   PSTTYPE,PSTTYPE7                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),1                           
         TM    DMCB+8,X'80'                                                     
         BO    WRIT60                                                           
*                                                                               
         CLI   PSTTYPE,PSTTYPE7                                                 
         BNE   WRIT60              NOT A PST RECORD                             
         B     WRIT56                                                           
*                                  ELSE GET NEXT RECORD                         
WRIT54   MVI   BYTE,PSTTYPE7                                                    
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),1                         
         TM    DMCB+8,X'80'                                                     
         BO    WRIT60                                                           
*                                                                               
         USING JOBD,R6                                                          
WRIT56   OC    PSTACCT,PSTACCT     DO WE HAVE AN ACCOUNT ?                      
         BZ    WRIT54              NO, GET NEXT ONE                             
         CLI   PSTCODE,X'FF'       TOTAL RECORD?                                
         BE    WRIT54              YES, SKIP IT                                 
         MVC   PSHDACC,PSTACCT                                                  
         MVC   PSHDSBAC,JOBCODE                                                 
         MVC   PSHDSBNM,JOBNAME                                                 
         MVI   TRNSTAT,X'00'                                                    
         MVC   TRNLN,=YL1(TRNLN1Q+L'BILLNAME)                                   
         LA    R6,PSTACCUM                                                      
         CP    JOBPST,=P'0'        DO WE HAVE ANY PST ?                         
         BNE   WRIT58              YES                                          
         CP    JOBPBAS,=P'0'       NO, DO WE HAVE ANY BASIS ?                   
         BE    WRIT54              NO, GET THE NEXT ONE THEN                    
*                                                                               
WRIT58   GOTO1 SHR,DMCB,('SUBRSHR',(RC))                                        
         ZAP   TRNAMNT,JOBPST                                                   
*                                                                               
         LR    RF,R2                                                            
         SR    RE,RE                                                            
         IC    RE,TRNLN                                                         
         AR    RF,RE                                                            
*                                                                               
         USING SCIELD,RF                                                        
         MVI   SCIEL,SCIELQ                                                     
         MVI   SCILN,SCILN1Q                                                    
         MVI   SCITYPE,C'N'                                                     
         ZAP   SCIAMNT,JOBPBAS                                                  
         MVI   SCIAMNT+6,0        END OF RECORD                                 
                                                                                
         SR    RE,RE                                                            
         IC    RE,SCILN                                                         
         AR    RF,RE                                                            
                                                                                
         BRAS  RE,BUILDC0                                                       
         BAS   RE,MOVEFFT                                                       
         MVI   0(RF),0             MARK END OF RECORD                           
         BAS   RE,PUTTAPE                                                       
         B     WRIT54                                                           
         EJECT                                                                  
***********************************************************************         
*              POST INTERNAL INCOME                                             
***********************************************************************         
                                                                                
         USING INCELD,R5                                                        
WRIT60   L     R5,APREVB7                                                       
*                                                                               
WRIT62   CLI   0(R5),0             ANY MORE ENTRIES?                            
         BE    WRIT80              NO                                           
         CLI   0(R5),X'FF'         ANY ENTRIES AT ALL?                          
         BE    WRIT80              NO                                           
         CLI   INCWRKC,X'EE'       HAS THIS BEEN USED ALREADY?                  
         BE    WRIT64              YES, GET NEXT                                
         CP    INCINAM,=P'0'       NO, ANYTHING TO POST?                        
         BE    WRIT64              NO, GET NEXT                                 
*                                                                               
         MVC   PSHDACC(1),QCOMPANY                                              
         MVC   PSHDACC+1(L'INCDACC),INCDACC                                     
         MVC   PSHDSBAC,JOBCODE                                                 
         MVC   PSHDSBNM,JOBNAME                                                 
         MVI   TRNSTAT,X'80'                                                    
         MVC   TRNLN,=YL1(TRNLN1Q+L'BILLNAME)                                   
         ZAP   TRNAMNT,INCINAM                                                  
*                                                                               
         LR    RF,R2                                                            
         SR    RE,RE                                                            
         IC    RE,TRNLN                                                         
         AR    RF,RE                                                            
         MVI   0(RF),0             MARK END OF RECORD                           
                                                                                
         BAS   RE,PUTTAPE                                                       
*                                                                               
         MVC   PSHDACC(1),QCOMPANY                                              
         MVC   PSHDACC+1(L'INCCACC),INCCACC                                     
         MVC   PSHDSBAC,JOBCODE                                                 
         MVC   PSHDSBNM,JOBNAME                                                 
         MVI   TRNSTAT,X'00'                                                    
         MVC   TRNLN,=YL1(TRNLN1Q+L'BILLNAME)                                   
         ZAP   TRNAMNT,INCINAM                                                  
*                                                                               
         LR    RF,R2                                                            
         SR    RE,RE                                                            
         IC    RE,TRNLN                                                         
         AR    RF,RE                                                            
         MVI   0(RF),0                                                          
*                                                                               
         CP    TRNAMNT,HIAMT       TEST TRANSACTION AMOUNT TOO LARGE            
         BH    WRIT63                                                           
         CP    TRNAMNT,LOAMT       TEST TRANSACTION AMOUNT TOO SMALL            
         BL    WRIT63                                                           
*                                                                               
         USING MDTELD,RF                                                        
         BAS   RE,SET1A            BINARY ELEMENT                               
         ZAP   DUB,TRNAMNT                                                      
         CVB   RE,DUB                                                           
         STCM  RE,15,MDTCOM                                                     
         B     WRIT63A                                                          
         DROP  RF                                                               
*                                                                               
         USING MDPELD,RF                                                        
WRIT63   BAS   RE,SET6A                                                         
         ZAP   MDPCOM,TRNAMNT      PACKED ELEMENT                               
         DROP  RF                                                               
*                                                                               
WRIT63A  SR    RE,RE                                                            
         IC    RE,1(RF)                                                         
         AR    RF,RE                                                            
*                                                                               
         USING SCIELD,RF                                                        
         MVI   SCIEL,SCIELQ                                                     
         MVI   SCILN,SCILN1Q                                                    
         MVI   SCITYPE,C'G'                                                     
         ZAP   SCIAMNT,=P'0'                                                    
*                                                                               
         SR    RE,RE                                                            
         IC    RE,SCILN                                                         
         AR    RF,RE                                                            
*                                                                               
         LA    R1,INCWRKC          PASS WORKCODE FROM TABLE                     
         BRAS  RE,BUILDC5                                                       
         MVI   0(RF),0             END OF RECORD                                
                                                                                
         BAS   RE,PUTTAPE                                                       
*                                                                               
         TM    CMPOPT,POSTCOST     DO COST POSTINGS?                            
         BZ    WRIT64              NO                                           
*                                                                               
         BAS   RE,GET12            YES, GET THE 12 ACCOUNT                      
*                                                                               
         MVC   PSHDACC,COSTING     DEBIT 1C CONTRA 12                           
         MVC   PSHDSBAC,INC12ACC                                                
         MVC   PSHDSBNM,INC12NME                                                
         MVI   TRNSTAT,X'80'                                                    
*                                                                               
         LR    RF,R2               GET RID OF ELEMENTS                          
         SR    RE,RE                                                            
         IC    RE,TRNLN                                                         
         AR    RF,RE                                                            
         MVI   0(RF),0                                                          
                                                                                
         BAS   RE,PUTTAPE                                                       
*                                                                               
         MVC   PSHDACC,INC12ACC    CREDIT 12 CONTRA 1C                          
         MVC   PSHDSBAC,COSTING                                                 
         MVC   PSHDSBNM,CLINAME                                                 
         MVI   TRNSTAT,X'00'                                                    
                                                                                
         BAS   RE,PUTTAPE                                                       
*                                                                               
WRIT64   LA    R5,INCLN2Q(R5)                                                   
         B     WRIT62                                                           
*                                                                               
WRIT80   L     R5,ACURRB7                                                       
*                                                                               
WRIT82   CLI   0(R5),0             ANY MORE ENTRIES?                            
         BE    WRIT86              NO                                           
         CLI   0(R5),X'FF'         ANY ENTRIES AT ALL?                          
         BE    WRIT86              NO                                           
         CLI   INCWRKC,X'EE'       HAS THIS BEEN USED ALREADY?                  
         BE    WRIT84              YES, GET NEXT                                
         CP    INCINAM,=P'0'       NO, ANYTHING TO POST?                        
         BE    WRIT84              NO, GET NEXT                                 
*                                                                               
         MVC   PSHDACC(1),QCOMPANY                                              
         MVC   PSHDACC+1(L'INCDACC),INCDACC                                     
         MVC   PSHDSBAC,JOBCODE                                                 
         MVC   PSHDSBNM,JOBNAME                                                 
         MVI   TRNSTAT,X'80'                                                    
         MVC   TRNLN,=YL1(TRNLN1Q+L'BILLNAME)                                   
         ZAP   TRNAMNT,INCINAM                                                  
*                                                                               
         LR    RF,R2                                                            
         SR    RE,RE                                                            
         IC    RE,TRNLN                                                         
         AR    RF,RE                                                            
         MVI   0(RF),0             MARK END OF RECORD                           
                                                                                
         BAS   RE,PUTTAPE                                                       
*                                                                               
         MVC   PSHDACC(1),QCOMPANY                                              
         MVC   PSHDACC+1(L'INCCACC),INCCACC                                     
         MVC   PSHDSBAC,JOBCODE                                                 
         MVC   PSHDSBNM,JOBNAME                                                 
         MVI   TRNSTAT,X'00'                                                    
         MVC   TRNLN,=YL1(TRNLN1Q+L'BILLNAME)                                   
         ZAP   TRNAMNT,INCINAM                                                  
*                                                                               
         LR    RF,R2                                                            
         SR    RE,RE                                                            
         IC    RE,TRNLN                                                         
         AR    RF,RE                                                            
         MVI   0(RF),0                                                          
*                                                                               
         CP    TRNAMNT,HIAMT       TEST TRANSACTION AMOUNT TOO LARGE            
         BH    WRIT83                                                           
         CP    TRNAMNT,LOAMT       TEST TRANSACTION AMOUNT TOO SMALL            
         BL    WRIT83                                                           
*                                                                               
         USING MDTELD,RF                                                        
         BAS   RE,SET1A            BINARY ELEMENT                               
         ZAP   DUB,TRNAMNT                                                      
         CVB   RE,DUB                                                           
         STCM  RE,15,MDTCOM                                                     
         B     WRIT83A                                                          
         DROP  RF                                                               
*                                                                               
         USING MDPELD,RF                                                        
WRIT83   BAS   RE,SET6A                                                         
         ZAP   MDPCOM,TRNAMNT      PACKED ELEMENT                               
         DROP  RF                                                               
*                                                                               
WRIT83A  SR    RE,RE                                                            
         IC    RE,1(RF)                                                         
         AR    RF,RE                                                            
*                                                                               
         USING SCIELD,RF                                                        
         MVI   SCIEL,SCIELQ                                                     
         MVI   SCILN,SCILN1Q                                                    
         MVI   SCITYPE,C'G'                                                     
         ZAP   SCIAMNT,=P'0'                                                    
*                                                                               
         SR    RE,RE                                                            
         IC    RE,SCILN                                                         
         AR    RF,RE                                                            
*                                                                               
         LA    R1,INCWRKC          PASS WORKCODE FROM TABLE                     
         BRAS  RE,BUILDC5                                                       
         MVI   0(RF),0             END OF RECORD                                
                                                                                
         BAS   RE,PUTTAPE                                                       
*                                                                               
         TM    CMPOPT,POSTCOST     DO COST POSTINGS?                            
         BZ    WRIT84              NO                                           
*                                                                               
         BAS   RE,GET12            YES, GET THE 12 ACCOUNT                      
*                                                                               
         MVC   PSHDACC,COSTING     DEBIT 1C CONTRA 12                           
         MVC   PSHDSBAC,INC12ACC                                                
         MVC   PSHDSBNM,INC12NME                                                
         MVI   TRNSTAT,X'80'                                                    
*                                                                               
         LR    RF,R2               GET RID OF ELEMENTS                          
         SR    RE,RE                                                            
         IC    RE,TRNLN                                                         
         AR    RF,RE                                                            
         MVI   0(RF),0                                                          
                                                                                
         BAS   RE,PUTTAPE                                                       
*                                                                               
         MVC   PSHDACC,INC12ACC    CREDIT 12 CONTRA 1C                          
         MVC   PSHDSBAC,COSTING                                                 
         MVC   PSHDSBNM,CLINAME                                                 
         MVI   TRNSTAT,X'00'                                                    
                                                                                
         BAS   RE,PUTTAPE                                                       
*                                                                               
WRIT84   LA    R5,INCLN2Q(R5)                                                   
         B     WRIT82                                                           
         EJECT                                                                  
***********************************************************************         
*              ROUTINE TO PUT OUT PERCENT OF BILLING POSTING          *         
***********************************************************************         
*                                                                               
WRIT86   CP    SVPBAMT,=P'0'       ANYTHING TO POST?                            
         BE    WRIT100             NO                                           
         CLI   SVPBBIL,C'N'        ARE WE DOING POB?                            
         BE    WRIT100             NO                                           
*                                                                               
         MVI   TRNEL,TRNELQ        DEBIT THE JOB                                
         MVI   TRNLN,121                                                        
         OI    TRNSTAT,X'80'                                                    
         OI    TRNSTAT,X'01'       MAKE NON-COMMISSIONABLE                      
*                                                                               
         MVC   TRNDATE,DATE3                                                    
         ZAP   TRNAMNT,SVPBAMT                                                  
*                                                                               
         MVC   TRNREF,BILLREF                                                   
*                                                                               
         MVI   TRNTYPE,64         CREATING TYPE 64                              
         MVC   TRNANAL,SVPBWRK                                                  
         MVC   TRNBTCH(2),MOS                                                   
*                                                                               
         MVI   TRNNARR,0                                                        
         LA    RF,TRNNARR         GET LENGTH OF TRANSACTION                     
         SR    RF,R2                                                            
         AHI   RF,1                                                             
         STC   RF,TRNLN                                                         
*                                                                               
         LR    RF,R2                                                            
         SR    RE,RE                                                            
         IC    RE,TRNLN                                                         
         AR    RF,RE                                                            
*                                                                               
         USING PTAELD,RF                                                        
         XC    PTAEL(PTARLN1Q),PTAEL                                            
         MVI   PTAEL,PTAELQ                                                     
         MVI   PTALN,PTARLN1Q                                                   
         ZAP   PTANET,=P'0'                                                     
         ZAP   PTANETF,=P'0'                                                    
         ZAP   PTACDSC,=P'0'                                                    
         ZAP   PTARCORT,=P'0'                                                   
         ZAP   PTARCOM,=P'0'                                                    
*                                                                               
         SR    RE,RE                                                            
         IC    RE,PTALN            GET LENGTH                                   
*                                                                               
         CLI   SVPBBIL,C'U'        ARE WE UNBILLING?                            
         BE    WRIT87              YES                                          
*                                                                               
         USING PTAELD,RF                                                        
         MVC   PTADATE,TODAY2                                                   
         MVI   PTATYPE,PTATRAL                                                  
         MVI   PTASTAT1,PTASCASH                                                
         ZAP   PTANET,SVPBAMT                                                   
*                                                                               
         MVC   PTARDATE,TODAY2                                                  
         MVC   PTARBLDT,RCDAY2                                                  
*                                                                               
         MVC   PTARBLNO,BILLREF    YES, PUT IN BILL NUMBER AND                  
         MVC   PTARCODE,BILLCODE   BILLING TYPE                                 
         MVC   PTAMOA,DATE3                                                     
         AR    RF,RE               GET PAST PTA                                 
*                                                                               
         USING TRSELD,RF                                                        
         XC    TRSEL(TRSLNQ),TRSEL                                              
         MVI   TRSEL,TRSELQ        FORMAT STATUS SO ACDTUSED IS SET             
         MVI   TRSLN,TRSLNQ                                                     
         MVC   TRSUDAT,TODAY2                                                   
         SR    RE,RE                                                            
         IC    RE,TRSLN                                                         
         AR    RF,RE                                                            
*                                                                               
         USING PAKELD,RF                                                        
WRIT87   MVI   PAKEL,PAKELQ                                                     
         MVI   PAKLN,PAKLNQ                                                     
         MVC   PAKACC,SVICR                                                     
         MVC   PAKACC,SVPBACC                                                   
         MVC   PAKOFF,OFFC                                                      
         MVC   PAKCON,JOBCODE                                                   
         MVC   PAKDATE,DATE3                                                    
         MVC   PAKREF,BILLREF                                                   
         SR    RE,RE                                                            
         IC    RE,PAKLN            ADD PAYABLE KEY ELEMENT                      
         AR    RF,RE                                                            
         MVI   0(RF),0             MARK END OF RECORD                           
                                                                                
         MVC   PSHDACC,JOBCODE                                                  
         MVC   PSHDANAL,SVPBWRK                                                 
         MVC   PSHDSBAC,SVPBACC                                                 
         MVC   PSHDSBNM,SVPBNAM                                                 
                                                                                
         BAS   RE,PUTTAPE                                                       
*                                                                               
         MVC   TRNANAL,OFFC                                                     
         NI    TRNSTAT,X'FF'-X'80'                                              
*                                                                               
         LR    RF,R2                                                            
         SR    RE,RE                                                            
         IC    RE,TRNLN                                                         
         AR    RF,RE                                                            
*                                                                               
         USING MDTELD,RF                                                        
         BAS   RE,SET1A                                                         
*                                                                               
         ZAP   DUB,SVPBAMT         FILL IN AMOUNTS                              
         CVB   RE,DUB                                                           
         STCM  RE,15,MDTINTL                                                    
         STCM  RE,15,MDTNET                                                     
         STCM  RE,15,MDTGRS                                                     
*                                                                               
         SR    RE,RE                                                            
         IC    RE,MDTLN                                                         
         AR    RF,RE                                                            
*                                                                               
         USING OTHELD,RF                                                        
         MVI   OTHEL,OTHELQ                                                     
         MVI   OTHLN,OTHLN1Q                                                    
         MVC   OTHNUM(OTHLN1Q-2),SPACES                                         
         MVC   OTHNUM(6),PRDCODE+6                                              
         MVC   OTHNUM+6(6),JOBCODE+9                                            
         SR    RE,RE                                                            
         IC    RE,OTHLN                                                         
         AR    RF,RE                                                            
*                                                                               
         TM    JOBOPT,JBSTUDIO     IS THIS A STUDIO?                            
         BZ    WRIT88              NO                                           
*                                                                               
         USING LNKEL,RF                                                         
         MVC   LNKEL(LNKLNQ),SVELEM                                             
         SR    RE,RE                                                            
         IC    RE,LNKLN                                                         
         AR    RF,RE                                                            
*                                                                               
         USING FFTELD,RF                                                        
WRIT88   MVI   FFTEL,FFTELQ                                                     
         MVI   FFTLN,FFTLN1Q+L'FFTDLEN+L'FFTWORK+L'FFTWAMT                      
         MVI   FFTTYPE,FFTTWRKC                                                 
         MVI   FFTSEQ,0                                                         
         MVI   FFTDLEN,L'FFTWORK+L'FFTWAMT                                      
         MVC   FFTWORK,SVPBWRK                                                  
         ZAP   FFTWAMT,SVPBAMT                                                  
         SR    RE,RE                                                            
         IC    RE,FFTLN                                                         
         AR    RF,RE                                                            
         MVI   0(RF),X'00'         MARK END OF RECORD                           
*                                                                               
         MVC   PSHDACC,SVPBACC                                                  
         MVC   PSHDANAL,SPACES                                                  
         MVC   PSHDSBAC,JOBCODE                                                 
         MVC   PSHDSBNM,JOBNAME                                                 
                                                                                
         BAS   RE,PUTTAPE                                                       
*                                                                               
         USING POBD,R4                                                          
         L     R4,APOBWK                                                        
         LA    R1,POBLNQ                                                        
         SLL   R1,16                                                            
         ST    R1,POBLN                                                         
*                                                                               
         MVI   POBTYP,POBEQU                                                    
         L     RF,ADACC                                                         
         MVC   POBCLI(12),3(RF)                                                 
         MVC   POBACC,SVPBACC+1                                                 
         MVC   POBWC,SVPBWRK                                                    
         ZAP   POBAMT,SVPBAMT                                                   
*                                                                               
         MVC   POBBILL,SPACES                                                   
         MVI   POBBIL,C'Y'                                                      
         MVC   POBBILL(7),SHTBILNO                                              
*                                                                               
         GOTO1 ADSORTER,DMCB,=C'PUT',(R4)                                       
         MVI   ALSORT,1                                                         
*                                                                               
         USING GOBLOCKD,R3                                                      
WRIT100  TM    BILLMODE,UNBILL     ARE WE UNBILLING ?                           
         BO    POSTX               YES, CYCLE RECORD ALREADY UPDATED            
         L     R3,ADGOBLOC                                                      
         CLI   GOBILTYP,C'A'       WAS THIS AN AUTOMATIC BILLTYPE ?             
         BNE   *+8                 NO, JUST EXIT                                
         BAS   RE,UPCYCLE          YES, UPDATE THE CYCLE RECORD                 
         B     POSTX                                                            
         DROP  R3,R4,R5                                                         
         EJECT                                                                  
***********************************************************************         
*              CREATE POSTING FOR GROUP BILL                                    
***********************************************************************         
*                                                                               
         USING TRNELD,R2                                                        
         USING PSHEADD,R3                                                       
         USING JOBD,R6                                                          
         USING DUEELD,RF                                                        
PSTGBIL  DS    0H                                                               
         LA    R6,GRPTOT                                                        
         LR    R4,R3                                                            
         LA    RE,AREA                                                          
         LA    RF,L'AREA                                                        
         SR    R1,R1                                                            
         MVCL  RE,R0                                                            
         LA    RE,AREA                                                          
         LA    R3,4(RE)                                                         
         MVC   PSHDEL(2),=X'5046'                                               
         SR    R2,R2                                                            
         IC    R2,PSHDLEN                                                       
         LA    R2,0(R2,R3)                                                      
*                                                                               
         MVC   PSHDACC,RECEIVBL                                                 
         MVC   PSHDANAL,SPACES                                                  
         MVC   PSHDSBNM,SPACES                                                  
         MVC   PSHDSBAC,=CL15'   PRODUCTION'                                    
         TM    REQOPT,REQMEDO      FOR MEDIA ONLY                               
         BZ    *+10            USE SPECIAL CONTRA NAME ON RECEIVABLE            
         MVC   PSHDSBAC(15),=CL15'   PRINT MEDIA'                               
*                                                                               
         MVI   TRNEL,TRNELQ        FILL IN TRANSACTION                          
         MVI   TRNLN,TRNLN1Q                                                    
         MVI   TRNSTAT,X'80'                                                    
         MVC   TRNDATE,DATE3                                                    
         MVC   TRNREF,BILLREF                                                   
         MVI   TRNTYPE,6                                                        
         ZAP   TRNAMNT,GRPSR       TOTAL ALL JOBS                               
         MVC   TRNANAL,OFFC                                                     
         MVC   TRNBTCH(2),MOS                                                   
*                                                                               
         LR    RF,R2                                                            
         SR    RE,RE                                                            
         IC    RE,TRNLN                                                         
         AR    RF,RE                                                            
*                                                                               
         USING SCIELD,RF                                                        
         MVI   SCIEL,SCIELQ                                                     
         MVI   SCILN,SCILN1Q                                                    
         MVI   SCITYPE,C'D'       CASH DISCOUNT ELEMENT                         
         ZAP   SCIAMNT,GRPCD                                                    
         CP    SCIAMNT,=P'0'                                                    
         BE    PSTG02              NO 50 IF NO CD                               
*                                                                               
         SR    RE,RE                                                            
         IC    RE,SCILN                                                         
         AR    RF,RE                                                            
*                                                                               
PSTG02   MVI   SCIEL,SCIELQ                                                     
         MVI   SCILN,SCILN1Q                                                    
         MVI   SCITYPE,C'I'     ADD INCOME ELEMENT TO                           
         ZAP   SCIAMNT,JOBCOMM  RECEIVABLE POSTING                              
         TM    CLIOPT,PAYNET                                                    
         BZ    *+10                                                             
         ZAP   SCIAMNT,=P'0'     ZERO IF PAY=NET                                
*                                                                               
         SR    RE,RE                                                            
         IC    RE,SCILN                                                         
         AR    RF,RE                                                            
*                                                                               
         USING DUEELD,RF                                                        
         MVI   DUEEL,DUEELQ                                                     
         MVI   DUELN,DUELNQ                                                     
         MVC   DUEDATE,DUE2                                                     
*                                                                               
         SR    RE,RE                                                            
         IC    RE,DUELN                                                         
         AR    RF,RE                                                            
*                                                                               
         LA    R4,2                GET LEVEL 2 DATA                             
         BAS   RE,BUILD50                                                       
*                                                                               
         LA    R1,PST6A            ADD NEW (PACKED ELEMENT)                     
         CP    GRPSR,HIAMT         TEST AMOUNT TOO LARGE                        
         BH    PSTG03                                                           
         CP    GRPSR,LOAMT         TEST AMOUNT TOO SMALL                        
         BL    PSTG03                                                           
         LA    R1,PST1A            ADD BINARY ELEMENT                           
PSTG03   BASR  RE,R1                                                            
                                                                                
*                                                                               
         SR    RE,RE                                                            
         IC    RE,1(RF)                                                         
         AR    RF,RE                                                            
         MVI   0(RF),X'00'         MARK END OF RECORD                           
                                                                                
         BAS   RE,PUTTAPE                                                       
         B     POSTX                                                            
         EJECT                                                                  
***********************************************************************         
* ADD MEDIA ELEMENT - BINARY                                          *         
***********************************************************************         
                                                                                
PST1A    LR    R0,RE                                                            
         USING MDTELD,RF                                                        
         BAS   RE,SET1A            INITIALIZE MEDIA ELEMENT                     
*                                                                               
         MVC   MDTJOB,=CL6'GROUP' SET NAME TO GROUP                             
         MVI   MDTMED,C' '        CLEAR MEDIA AND DESCRIPTION                   
         MVC   MDTDSCP,SPACES                                                   
         CLI   GRPTYPE,C'A'                                                     
         BE    *+10                IF PRODUCT LEVEL, LEAVE PRODUCT              
         MVC   MDTPRD,SPACES                                                    
*                                                                               
         ZAP   DUB,GRPINT          FILL IN AMOUNTS                              
         CVB   RE,DUB                                                           
         STCM  RE,15,MDTINTL                                                    
*                                                                               
         ZAP   DUB,GRPSJ                                                        
         CVB   R1,DUB                                                           
         SR    R1,RE                                                            
         STCM  R1,15,MDTNET                                                     
*                                                                               
         TM    CLIOPT,PAYNET       PAY = NET OR SNET ?                          
         BO    PST1A3              YES, LEAVE INCOME AS ZERO                    
         ZAP   DUB,GRP12                                                        
         CVB   RE,DUB                                                           
         STCM  RE,15,MDTCOM                                                     
*                                                                               
PST1A3   ZAP   DUB,GRP11                                                        
         CVB   RE,DUB                                                           
         STCM  RE,15,MDTGRS                                                     
*                                                                               
         ZAP   DUB,JOBCD                                                        
         CVB   RE,DUB                                                           
         STCM  RE,15,MDTCD                                                      
*                                                                               
         ZAP   DUB,GRPSR                                                        
         CVB   RE,DUB                                                           
         STCM  RE,15,MDTRECV                                                    
*                                                                               
         ZAP   DUB,GRPGST                                                       
         CVB   RE,DUB                                                           
         STCM  RE,15,MDTVAT                                                     
         LR    RE,R0                                                            
         BR    RE                                                               
         DROP  RF                                                               
         EJECT                                                                  
***********************************************************************         
* ADD MEDIA ELEMENT - PACKED                                          *         
***********************************************************************         
                                                                                
PST6A    LR    R0,RE                                                            
         USING MDPELD,RF                                                        
         BAS   RE,SET6A            INITIALIZE MEDIA ELEMENT                     
*                                                                               
         MVC   MDPJOB,=CL6'GROUP' SET NAME TO GROUP                             
         MVI   MDPMED,C' '        CLEAR MEDIA AND DESCRIPTION                   
         MVC   MDPDSCP,SPACES                                                   
         CLI   GRPTYPE,C'A'                                                     
         BE    *+10                IF PRODUCT LEVEL, LEAVE PRODUCT              
         MVC   MDPPRD,SPACES                                                    
*                                                                               
         ZAP   MDPINTL,GRPINT                                                   
*                                                                               
         ZAP   DUB,GRPSJ                                                        
         SP    DUB,GRPINT                                                       
         ZAP   MDPNET,DUB                                                       
*                                                                               
         TM    CLIOPT,PAYNET       PAY = NET OR SNET ?                          
         BO    PST6A3              YES, LEAVE INCOME AS ZERO                    
         ZAP   MDPCOM,GRP12                                                     
*                                                                               
PST6A3   ZAP   MDPGRS,GRP11                                                     
         ZAP   MDPCD,JOBCD                                                      
         ZAP   MDPRECV,GRPSR                                                    
         ZAP   MDPVAT,GRPGST                                                    
         LR    RE,R0                                                            
         BR    RE                                                               
         DROP  RF                                                               
         EJECT                                                                  
*              ADD GROUP BILL TO GROUP ACCUM                                    
*                                                                               
POSTGRPB NTR1                                                                   
         LA    R5,GRPTOT                                                        
         LA    R6,JOBPOST                                                       
         LA    R0,JOBBKCNT                                                      
POSTGRP2 AP    0(8,R5),0(8,R6)                                                  
         LA    R5,8(R5)                                                         
         LA    R6,8(R6)                                                         
         BCT   R0,POSTGRP2                                                      
         B     POSTX                                                            
         EJECT                                                                  
***********************************************************************         
*              WRITE LAST POSTING FILE RECORD AND CLOSE                         
***********************************************************************         
*                                                                               
WRITOTAL DS    0H                                                               
         LA    RE,AREA                                                          
         LA    RF,L'AREA                                                        
         SR    R1,R1                                                            
         MVCL  RE,R0                                                            
*                                                                               
         LA    R3,AREA                                                          
         MVC   0(4,R3),=X'00210000'                                             
*                                                                               
         USING PSSUBFD,R3                                                       
         LA    R3,4(R3)            GET PAST HEADER                              
         MVI   PSSBEL,PSSBELQ                                                   
         MVI   PSSBLEN,PSSUBFL                                                  
         MVC   PSSBDESC,=C'PROD. BILLING  '                                     
         ZAP   PSSBRECS,TAPECNT+2(6)                                            
         ZAP   PSSBCASH,TAPECASH+2(6)                                           
         BAS   RE,ADDPOST                                                       
         BAS   RE,CLOSPOST                                                      
         CLI   RCFFPARM,C'T'       IS THIS A TEST RUN?                          
         BNE   *+8                 NO                                           
         BAS   RE,KEEPPOST         YES, PUT FILE ON KEEP                        
         B     POSTX                                                            
         EJECT                                                                  
***********************************************************************         
*              PRODUCE SK/SI REVERSALS                                          
***********************************************************************         
*                                                                               
         USING CACELD,R4                                                        
REVERSIT DS    0H                                                               
         L     R4,ADSUBAC                                                       
         LA    R6,JOBDTL                                                        
         MVC   JOBDTL(JOBLNQ),ZEROS    CLEAR CURRENT DETAIL LINE                
         USING CACELD,R4                                                        
         CLC   CACCNT+1(2),=C'SK'                                               
         BNE   RVSK                MUST BE TYPE 41/49                           
*                                                                               
         MVC   SIAC,SPACES                                                      
         MVC   COMMKEY,SPACES      FIND COSTING CATEGORY IN SI ACCOUNT          
         L     R4,ADSUBAC                                                       
         MVC   COMMKEY(15),CACCNT                                               
         MVI   COMMKEY+2,C'I'                                                   
         MVC   KEYSAVE,COMMKEY                                                  
         L     R2,ACOMBUF                                                       
         GOTO1 DATAMGR,DMCB,DMRDHI,FILNME,COMMKEY,(R2)                          
         CLC   KEYSAVE,0(R2)                                                    
         BNE   REV16                                                            
         AH    R2,DATADISP                                                      
         LR    RF,R2                                                            
*                                                                               
REV06    CLI   0(RF),0                                                          
         BE    REV16                                                            
         CLI   0(RF),X'2C'                                                      
         BE    REV12                                                            
         CLI   0(RF),X'30'                                                      
         BE    REV10                                                            
*                                                                               
REV08    ZIC   R1,1(RF)                                                         
         AR    RF,R1                                                            
         B     REV06                                                            
*                                                                               
         USING RSTELD,RF                                                        
REV10    MVC   SIAC(L'RSTCOSTG),RSTCOSTG                                        
         B     REV14                                                            
*                                                                               
         USING SPAELD,RF                                                        
REV12    CLI   SPATYPE,SPATANAL     IS THIS AN ANALYSIS ACCOUNT ?               
         BNE   REV08               NO, TRY AGAIN                                
         MVC   SIAC(L'SIAC),SPAAULA                                             
*                                                                               
REV14    MVC   COMMKEY+1(41),SPACES                                             
         MVC   COMMKEY+1(2),=C'11'                                              
         MVC   COMMKEY+3(L'SIAC),SIAC                                           
         MVC   KEYSAVE,COMMKEY                                                  
         L     R2,ACOMBUF                                                       
         GOTO1 DATAMGR,DMCB,DMRDHI,FILNME,COMMKEY,(R2)                          
         CLC   KEYSAVE,0(R2)                                                    
         BNE   REV16                                                            
         DROP  RF                                                               
*                                                                               
         LA    R3,SINM                                                          
         GOTO1 SHR,DMCB,('SUBRNAM',(RC))                                        
*                                                                               
         USING TRNRECD,R3                                                       
         USING TRNELD,R2                                                        
REV16    L     RF,ACOMBUF                                                       
         L     R2,ADTRANS                                                       
         L     R4,ADSUBAC                                                       
         LA    R3,SAVEKEY          RE-BUILD KEY                                 
         XC    SAVEKEY,SAVEKEY                                                  
         MVC   TRNKWORK,TRNANAL                                                 
         MVC   TRNKCULC,CACCNT                                                  
         MVC   TRNKDATE,TRNDATE                                                 
         MVC   TRNKREF(7),TRNREF                                                
         L     R2,ADACC                                                         
         MVC   TRNKCULA,0(R2)                                                   
         GOTO1 DATAMGR,DMCB,DMREAD,FILNME,SAVEKEY,(RF)                          
*                                                                               
         USING PSHEADD,R3                                                       
         LA    RE,AREA                                                          
         LA    RF,L'AREA                                                        
         SR    R1,R1                                                            
         MVCL  RE,R0                                                            
         LA    RE,AREA                                                          
         LA    R3,4(RE)                                                         
         LA    R2,74(RE)                                                        
         L     R4,ADTRANS                                                       
         MVC   PSHDEL(2),=X'5046'                                               
         MVC   PSHDANAL,SPACES     FILL IN THE FIXED VALUES                     
         MVI   TRNEL,TRNELQ                                                     
         MVI   TRNLN,X'1D'                                                      
         MVC   TRNDATE,TRNDATE-TRNELD(R4)                                       
         MVC   TRNREF,TRNREF-TRNELD(R4)                                         
         MVI   TRNSUB,0                                                         
         MVI   TRNTYPE,6                                                        
         MVC   TRNBTCH,SPACES                                                   
         MVC   TRNBTCH(2),MOS                                                   
         ZAP   TRNAMNT,TRNAMNT-TRNELD(L'TRNAMNT,R4)                             
         ZIC   RF,1(R4)            USE INCOME ELEMENT FOR REVERSAL              
         LR    R1,R4               POSTING (IF PRESENT)                         
         AR    RF,R1                                                            
         CLI   0(RF),X'50'                                                      
         BNE   REV18                                                            
         CLI   2(RF),C'C'                                                       
         BNE   REV18                                                            
         ZAP   TRNAMNT,3(6,RF)                                                  
*                                                                               
REV18    AP    JOBINT,TRNAMNT      ACCUMULATE TOTAL INTERNAL INCOME             
         TM    GRPOPT,GRPBILL      GROUP BILLING ?                              
         BZ    *+10                NO                                           
         AP    GRPINT,TRNAMNT      YES, ADD HERE ALSO                           
         MVC   TRNANAL,OFFC                                                     
         MVI   TRNNARR,C' '                                                     
         L     R4,ADSUBAC                                                       
*                                                                               
         MVC   PSHDACC,CACCNT    DEBIT SK ,CONTRA JOB                           
         L     R1,ADACC                                                         
         MVC   PSHDSBAC,0(R1)                                                   
         L     R1,ADACCNAM                                                      
         MVC   PSHDSBNM,SPACES                                                  
         SR    RE,RE                                                            
         IC    RE,1(R1)                                                         
         SH    RE,=H'3'                                                         
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   PSHDSBNM(0),2(R1)                                                
         MVI   TRNSTAT,X'80'                                                    
                                                                                
         LR    RF,R2                                                            
         SR    RE,RE                                                            
         IC    RE,TRNLN                                                         
         AR    RF,RE                                                            
*                                                                               
         BRAS  RE,ADDSUB2                                                       
         BRAS  RE,BUILDC0                                                       
         MVI   0(RF),0                                                          
                                                                                
         BAS   RE,PUTTAPE                                                       
         BAS   RE,BUILDINV         BUILD INTERNAL INVOICE REGISTER              
*                                                                               
         GOTO1 SHR,DMCB,('SUBRSUML',(RC))  ADD DETAIL LINE TOTALS               
         MVC   TOTCHG,JOBCHG      SAVE TOTAL CHARGES FOR RETAIL                 
         EJECT                                                                  
*                                                                               
         MVI   PSHDACC+2,C'I'      CREDIT SI, CONTRA PRODUCT                    
         MVC   PSHDSBAC,JOBCODE    CONTRA IS JOB                                
         MVC   PSHDSBNM,JOBNAME                                                 
         TM    JOBOPT,JBSTUDIO     IS THIS A STUDIO JOB?                        
         BO    REV20               YES                                          
         OC    SALENUM,SALENUM     ANY SALES ACCOUNT?                           
         BZ    REV20               NO,LEAVE CONTRA AS JOB                       
         MVC   PSHDSBAC,SALENUM                                                 
         MVC   PSHDSBNM,SALENAM                                                 
*                                                                               
REV20    MVI   TRNSTAT,0                                                        
         MVC   TRNDATE,DATE3       SAME DETAILS AS BILL POSTINGS                
         MVC   TRNREF,BILLREF                                                   
*                                                                               
         LR    RF,R2               ADD MEMO OF ZERO TO SI POSTING               
         SR    RE,RE                                                            
         IC    RE,TRNLN                                                         
         AR    RF,RE                                                            
*                                                                               
         USING SCIELD,RF                                                        
         MVI   SCIEL,SCIELQ                                                     
         MVI   SCILN,SCILN1Q                                                    
         MVI   SCITYPE,C'G'                                                     
         ZAP   SCIAMNT,=P'0'                                                    
*                                                                               
         SR    RE,RE               CREATE MEDIA TRANSFER ELEMENT                
         IC    RE,SCILN                                                         
         AR    RF,RE                                                            
*                                                                               
         LA    R1,SVANAL           PASS WORKCODE                                
         BRAS  RE,BUILDC5          WORKCODE ELEMENT                             
*                                                                               
         CP    TRNAMNT,HIAMT       TEST TRANSACTION AMOUNT TOO LARGE            
         BH    REV21                                                            
         CP    TRNAMNT,LOAMT       TEST TRANSACTION AMOUNT TOO SMALL            
         BL    REV21                                                            
*                                                                               
         USING MDTELD,RF                                                        
         BAS   RE,SET1A            BINARY ELEMENT                               
         ZAP   DUB,TRNAMNT                                                      
         CVB   RE,DUB                                                           
         STCM  RE,15,MDTCOM                                                     
         B     REV21A                                                           
         DROP  RF                                                               
*                                                                               
         USING MDPELD,RF                                                        
REV21    BAS   RE,SET6A                                                         
         ZAP   MDPCOM,TRNAMNT      PACKED ELEMENT                               
         DROP  RF                                                               
*                                                                               
*                                                                               
REV21A   SR    RE,RE                                                            
         IC    RE,1(RF)                                                         
         AR    RF,RE                                                            
*                                                                               
         TM    JOBOPT,JBSTUDIO     IS THIS A STUDIO JOB?                        
         BZ    REV22               NO                                           
*                                                                               
         USING LNKEL,RF                                                         
         MVC   LNKEL(LNKLNQ),SVELEM                                             
         SR    RE,RE                                                            
         IC    RE,LNKLN                                                         
         AR    RF,RE                                                            
*                                                                               
REV22    MVI   0(RF),0             MARK END OF RECORD                           
         DROP  RF                                                               
*                                                                               
         BRAS  RE,BUILDC0                                                       
         MVI   0(RF),0                                                          
                                                                                
         BAS   RE,PUTTAPE                                                       
         LR    RF,R2                                                            
         SR    RE,RE                                                            
         IC    RE,TRNLN                                                         
         AR    RF,RE               KILL MEMO ITEM AND MEDIA TRANSFER            
         MVI   0(RF),0                                                          
         TM    CMPOPT,POSTCOST                                                  
         BZ    POSTX                                                            
*                                                                               
         MVC   PSHDACC,SUSPAC      CREDIT COSTING COMMISSION                    
         CLI   SIAC,C' '                                                        
         BE    *+10                                                             
         MVC   PSHDACC+3(L'SIAC),SIAC                                           
         MVC   PSHDSBAC,COSTING    CONTRA A/C CLIENT                            
         MVC   PSHDSBNM,CLINAME                                                 
                                                                                
         BRAS  RE,BUILDC0                                                       
         MVI   0(RF),0                                                          
                                                                                
         BAS   RE,PUTTAPE                                                       
*                                                                               
         MVC   PSHDSBAC,PSHDACC                                                 
         MVC   PSHDACC,COSTING                                                  
         MVC   PSHDSBNM,SPACES                                                  
         MVC   PSHDSBNM(10),=C'PRODUCTION'                                      
         CLI   SIAC,C' '                                                        
         BE    *+10                                                             
         MVC   PSHDSBNM,SINM                                                    
         MVI   TRNSTAT,X'80'                                                    
                                                                                
         BAS   RE,PUTTAPE                                                       
         B     POSTX                                                            
         EJECT                                                                  
***********************************************************************         
*              REVERSE SK POSTING FOR TYPE 49 AND TRANSFER                      
***********************************************************************         
*                                                                               
RVSK     MVC   SAVEKEY,SPACES                                                   
         MVC   CONTRA,CACCNT     SAVE THE CONTRA FOR X'C0' POSTING              
         L     R2,ADTRANS                                                       
         SH    R2,DATADISP                                                      
         MVC   SAVEKEY,0(R2)       SAVE TRANASCATION KEY                        
         MVC   SKACCT(1),RCCOMPFL                                               
         MVC   SKACCT+1(14),COMMAC+1   MAKE CONTRA THE COMMISSION ACCT          
         MVC   SKACCTN,SPACES                                                   
         L     R2,ADTRANS                                                       
         LR    RF,R2                                                            
*                                                                               
RVSK02   ZIC   R0,1(RF)            GET REAL SK ACCOUNT                          
         AR    RF,R0                                                            
         CLI   0(RF),0                                                          
         BE    RVSK04                                                           
         CLI   0(RF),X'4C'                                                      
         BNE   RVSK02                                                           
         MVC   SKACCT+1(14),SPACES                                              
         ZIC   R1,1(RF)            FOUND SPDELD ELEMENT                         
         SH    R1,=H'3'                                                         
         EX    R1,*+8                                                           
         B     RVSK04                                                           
         MVC   SKACCT+1(0),SPDACCS-SPDELD(RF) REAL SK ACCOUNT                   
*                                                                               
RVSK04   CLC   SKACCT+1(2),=C'SK'                                               
         BNE   RVSKX               NO SK -  JUST GET OUT                        
         L     R2,ACOMBUF                                                       
         MVC   0(42,R2),SPACES                                                  
         MVC   0(15,R2),SKACCT   GET CONTRA NAME                                
         GOTO1 DATAMGR,DMCB,DMRDHI,FILNME,(R2),(R2)                             
         CLC   0(15,R2),SKACCT                                                  
         BNE   RVSK06                                                           
         LA    R3,SKACCTN                                                       
         GOTO1 SHR,DMCB,('SUBRNAM',(RC))                                        
*                                                                               
RVSK06   MVC   SIACCT,SKACCT                                                    
         MVI   SIACCT+2,C'I'       INCOME ACCOUNT                               
         MVC   SIACCTN,SPACES                                                   
         MVC   SIAC,SPACES                                                      
         L     R2,ACOMBUF                                                       
         MVC   0(42,R2),SPACES                                                  
         MVC   0(15,R2),SIACCT   GET SI ACCOUNT NAME                            
         GOTO1 DATAMGR,DMCB,DMRDHI,FILNME,(R2),(R2)                             
         CLC   0(15,R2),SIACCT                                                  
         BNE   RVSK12                                                           
         LA    R3,SIACCTN                                                       
         GOTO1 SHR,DMCB,('SUBRNAM',(RC))                                        
         LR    RF,R2                                                            
         AH    RF,DATADISP                                                      
*                                                                               
RVSK08   CLI   0(RF),0                                                          
         BNE   *+6                                                              
         DC    H'0'                                                             
         CLI   0(RF),X'2C'                                                      
         BE    RVSK14                                                           
         CLI   0(RF),X'30'                                                      
         BE    RVSK12                                                           
*                                                                               
RVSK10   ZIC   RE,1(RF)                                                         
         AR    RF,RE                                                            
         B     RVSK08                                                           
*                                                                               
         USING RSTELD,RF                                                        
RVSK12   MVC   SIAC(L'RSTCOSTG),RSTCOSTG                                        
         B     RVSK16                                                           
*                                                                               
         USING SPAELD,RF                                                        
RVSK14   CLI   SPATYPE,SPATANAL                                                 
         BNE   RVSK10                                                           
         MVC   SIAC(L'SIAC),SPAAULA                                             
*                                                                               
RVSK16   MVC   COMMKEY,SPACES                                                   
         MVC   COMMKEY(1),RCCOMPFL                                              
         MVC   COMMKEY+1(2),=C'12'                                              
         MVC   COMMKEY+3(L'SIAC),SIAC                                           
         MVC   KEYSAVE,COMMKEY                                                  
         L     R2,ACOMBUF                                                       
         GOTO1 DATAMGR,DMCB,DMRDHI,FILNME,COMMKEY,(R2)                          
         CLC   KEYSAVE,0(R2)                                                    
         BNE   RVSK18                                                           
         LA    R3,SINM                                                          
         GOTO1 SHR,DMCB,('SUBRNAM',(RC))                                        
*                                                                               
RVSK18   LA    RE,AREA                                                          
         LA    RF,L'AREA                                                        
         SR    R1,R1                                                            
         MVCL  RE,R0                                                            
*                                                                               
         LA    RE,AREA                                                          
         LA    R3,4(RE)                                                         
         LA    R2,74(RE)                                                        
         USING PSHEADD,R3                                                       
         MVC   PSHDEL(2),=X'5046'                                               
         MVC   PSHDANAL,SPACES                                                  
         MVC   PSHDACC,SIACCT      CREDIT SI                                    
         MVC   PSHDSBAC,JOBCODE    CONTRA JOB                                   
         MVC   PSHDSBNM,JOBNAME                                                 
*                                                                               
         TM    JOBOPT,JBSTUDIO     IS THIS A STUDIO JOB?                        
         BO    RVSK20              YES                                          
         OC    SALENUM,SALENUM     ANY SALES ACCOUNT?                           
         BZ    RVSK20              NO,LEAVE CONTRA AS JOB                       
         MVC   PSHDSBAC,SALENUM                                                 
         MVC   PSHDSBNM,SALENAM                                                 
*                                                                               
         USING TRNELD,R2                                                        
RVSK20   MVI   TRNEL,TRNELQ                                                     
         MVI   TRNLN,TRNLN1Q                                                    
         MVC   TRNDATE,DATE3                                                    
         MVC   TRNREF,BILLREF                                                   
         MVI   TRNSUB,0                                                         
         MVI   TRNTYPE,6                                                        
         MVI   TRNSTAT,0           CREDIT                                       
         L     R4,ADTRANS                                                       
         TM    TRNSTAT-TRNELD(R4),X'01'        NON-COMMISSIONABLE               
         BZ    *+8                                                              
         OI    TRNSTAT,X'01'                                                    
         MVC   TRNBTCH,SPACES                                                   
         MVC   TRNBTCH(2),MOS                                                   
         MVC   TRNANAL,OFFC                                                     
         MVI   TRNNARR,C' '                                                     
         ZAP   TRNAMNT,TRNAMNT-TRNELD(L'TRNAMNT,R4)                             
         AP    JOBINT,TRNAMNT      ACCUMULATE TOTAL INTERNAL INCOME             
         TM    GRPOPT,GRPBILL      GROUP BILLING ?                              
         BZ    *+10                NO                                           
         AP    GRPINT,TRNAMNT      YES, ADD HERE ALSO                           
*                                                                               
         LR    RF,R2                                                            
         SR    RE,RE                                                            
         IC    RE,TRNLN                                                         
         AR    RF,RE                                                            
*                                                                               
         USING SCIELD,RF                                                        
         MVI   SCIEL,SCIELQ                                                     
         MVI   SCILN,SCILN1Q                                                    
         MVI   SCITYPE,C'G'                                                     
         ZAP   SCIAMNT,=P'0'                                                    
*                                                                               
         SR    RE,RE                                                            
         IC    RE,SCILN                                                         
         AR    RF,RE                                                            
*                                                                               
         LA    R1,SVANAL           PASS WORKCODE                                
         BRAS  RE,BUILDC5          WORKCODE ELEMENT                             
*                                                                               
         CP    TRNAMNT,HIAMT       TEST TRANSACTION AMOUNT TOO LARGE            
         BH    RSK21                                                            
         CP    TRNAMNT,LOAMT       TEST TRANSACTION AMOUNT TOO SMALL            
         BL    RSK21                                                            
*                                                                               
         USING MDTELD,RF                                                        
         BAS   RE,SET1A            BINARY ELEMENT                               
         ZAP   DUB,TRNAMNT                                                      
         CVB   RE,DUB                                                           
         STCM  RE,15,MDTCOM                                                     
         B     RSK21A                                                           
         DROP  RF                                                               
*                                                                               
         USING MDPELD,RF                                                        
RSK21    BAS   RE,SET6A                                                         
         ZAP   MDPCOM,TRNAMNT      PACKED ELEMENT                               
         DROP  RF                                                               
*                                                                               
RSK21A   SR    RE,RE                                                            
         IC    RE,1(RF)                                                         
         AR    RF,RE                                                            
*                                                                               
         TM    JOBOPT,JBSTUDIO     IS THIS A STUDIO JOB?                        
         BZ    RVSK22              NO                                           
*                                                                               
         USING LNKEL,RF                                                         
         MVC   LNKEL(LNKLNQ),SVELEM                                             
         SR    RE,RE                                                            
         IC    RE,LNKLN                                                         
         AR    RF,RE                                                            
*                                                                               
RVSK22   MVI   0(RF),X'00'         MARK END OF RECORD                           
         DROP  RF                                                               
*                                                                               
         BRAS  RE,ADDSUB3                                                       
         BRAS  RE,BUILDC0                                                       
         MVI   0(RF),0                                                          
                                                                                
         BAS   RE,PUTTAPE                                                       
                                                                                
         LR    RF,R2                                                            
         SR    RE,RE                                                            
         IC    RE,TRNLN                                                         
         AR    RF,RE                                                            
         MVI   0(RF),0             REMOVE THE 50 AND 1A ELEMENTS                
*                                                                               
         MVC   PSHDACC,SKACCT      DEBIT SK ACCOUNT                             
         MVC   PSHDSBAC,JOBCODE    CONTRA JOB                                   
         MVC   PSHDSBNM,JOBNAME                                                 
         L     R4,ADTRANS                                                       
         MVC   TRNDATE,TRNDATE-TRNELD(R4)     SAVE DATE/REV/ETC                 
         MVC   TRNREF,BILLREF                                                   
         OI    TRNSTAT,X'80'                                                    
                                                                                
         BRAS  RE,BUILDC0                                                       
         MVI   0(RF),0                                                          
                                                                                
         BAS   RE,PUTTAPE                                                       
         BAS   RE,BUILDINV         BUILD INTERNAL INVOICE REGISTER              
*                                                                               
         GOTO1 SHR,DMCB,('SUBRSUML',(RC))  ADD DETAIL LINE TOTALS               
         MVC   TOTCHG,JOBCHG      SAVE TOTAL CHARGES FOR RETAIL                 
         EJECT                                                                  
***********************************************************************         
*              NOW THE COSTING POSTINGS                                         
***********************************************************************         
*                                                                               
         TM    CMPOPT,POSTCOST                                                  
         BZ    RVSK24              NO COSTING                                   
*                                                                               
         MVI   TRNSTAT,X'00'       CREDIT 12 CONTRA 1C                          
         MVC   PSHDACC,SUSPAC                                                   
         CLI   SIAC,C' '                                                        
         BE    *+10                                                             
         MVC   PSHDACC+3(L'SIAC),SIAC                                           
         MVC   PSHDSBAC,COSTING                                                 
         MVC   PSHDSBNM,CLINAME                                                 
                                                                                
         LR    RF,R2                                                            
         SR    RE,RE                                                            
         IC    RE,TRNLN                                                         
         AR    RF,RE                                                            
                                                                                
         BRAS  RE,BUILDC0                                                       
         MVI   0(RF),0                                                          
         BAS   RE,PUTTAPE                                                       
*                                                                               
         MVI   TRNSTAT,X'80'       DEBIT 1C CONTRA 12                           
         MVC   PSHDSBAC,PSHDACC                                                 
         MVC   PSHDACC,COSTING                                                  
         MVC   PSHDSBNM,SPACES                                                  
         MVC   PSHDSBNM(10),=C'PRODUCTION'                                      
         CLI   SIAC,C' '                                                        
         BE    *+10                                                             
         MVC   PSHDSBNM,SINM                                                    
         BAS   RE,PUTTAPE                                                       
*                                                                               
RVSK24   L     R3,ACOMBUF                                                       
         MVC   0(42,R3),SAVEKEY  RESTORE KEY                                    
         GOTO1 DATAMGR,DMCB,DMREAD,FILNME,(R3),(R3)                             
*                                                                               
RVSKX    XC    CONTRA,CONTRA       CLEAR THE CONTRA                             
         B     POSTX                                                            
         EJECT                                                                  
***********************************************************************         
*              ROUTINE TO REVERSE ESTIMATED PRODUCTION                          
***********************************************************************         
*                                                                               
EPREV    DC    0H'0'                                                            
         LA    RE,AREA                                                          
         LA    RF,L'AREA                                                        
         SR    R1,R1                                                            
         MVCL  RE,R0                                                            
         LA    RE,AREA                                                          
         LA    R3,4(RE)                                                         
         LA    R2,74(RE)                                                        
         USING PSHEADD,R3                                                       
         MVC   PSHDEL(2),=X'5046'                                               
         MVC   PSHDANAL,SPACES                                                  
         MVC   PSHDSBNM,SPACES                                                  
         MVC   PSHDACC,JOBCODE     DEBIT JOB                                    
         L     R4,ADSUBAC                                                       
         USING CACELD,R4                                                        
         MVC   PSHDSBAC,CACCNT   SAME CONTRA                                    
         ZIC   R1,CACLN                                                         
         SH    R1,=H'18'                                                        
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   PSHDSBNM(0),CACNAME                                              
         USING TRNELD,R2                                                        
         MVI   TRNEL,TRNELQ                                                     
*                                                                               
         LA    R1,TRNNARR          MOVE IN STANDARD NARRATIVE                   
         MVC   0(L'EPRCMT,R1),EPRCMT                                            
         LA    R1,L'EPRCMT(R1)                                                  
         MVI   0(R1),C' '                                                       
*                                                                               
         L     R4,ADTRANS          MOVE IN CUSTOM NARRATIVE                     
         SR    RF,RF                                                            
         IC    RF,1(R4)            GET ATUAL TRANSCATION LENGTH                 
         SH    RF,=YL2(TRNLN1Q)    LESS STANDARD TRANSACTION LENGTH             
         SH    RF,=YL2(L'EPCMT)    LESS STANDARD NARRATIVE                      
         BZ    EPRE00                                                           
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R1),TRNNARR-TRNELD+L'EPCMT(R4)                               
*                                                                               
EPRE00   AH    RF,=YL2(L'EPRCMT)                                                
         LA    R1,TRNLN1Q          TRANSACTION LENGTH                           
         LA    R1,1(R1,RF)         PLUS COMMENT PLUS 1                          
         STC   R1,TRNLN            IS ELEMENT LENGTH                            
*                                                                               
         MVC   TRNDATE,TRNDATE-TRNELD(R4)     SAVE DATE/REV/ETC                 
         MVC   TRNREF,TRNREF-TRNELD(R4)                                         
         MVI   TRNSUB,0                                                         
         MVC   TRNTYPE,EPRTYPE     REVERSE TYPE                                 
         MVI   TRNSTAT,X'80'       DEBIT                                        
         TM    TRNSTAT-TRNELD(R4),X'01'        NON-COMMISSIONABLE               
         BZ    *+8                                                              
         OI    TRNSTAT,X'01'                                                    
         MVC   TRNBTCH,SPACES                                                   
         MVC   TRNBTCH(2),MOS                                                   
         MVC   TRNANAL,TRNANAL-TRNELD(R4)                                       
         MVC   PSHDANAL,TRNANAL                                                 
         ZAP   DUB,TRNAMNT-TRNELD(L'TRNAMNT,R4)                                 
         MP    DUB,=P'-1'          MINUS                                        
         ZAP   TRNAMNT,DUB                                                      
         MVC   TRNNARR(L'EPRCMT),EPRCMT                                         
         BAS   RE,PUTTAPE                                                       
*                                                                               
         MVC   PSHDACC,PSHDSBAC    CREDIT THE CONTRA                            
         MVC   PSHDSBAC,PRDCODE                                                 
         MVC   PSHDSBNM,PRDNAME                                                 
         MVC   PSHDANAL,SPACES                                                  
         MVI   TRNSTAT,X'00'                                                    
         MVC   TRNANAL,OFFC                                                     
*                                                                               
*              CREDIT WAS TO CASH ACCOUNT                                       
*              REVERSAL MUST ALSO GO TO CASH                                    
EPRE02   ZIC   R0,1(R4)                                                         
         AR    R4,R0                                                            
         CLI   0(R4),X'4C'                                                      
         BE    EPRE04                                                           
         CLI   0(R4),0                                                          
         BE    EPRE06                                                           
         B     EPRE02                                                           
*                                                                               
         USING SPDELD,R4                                                        
EPRE04   MVC   PSHDACC+1(14),SPACES                                             
         ZIC   R1,SPDLN                                                         
         SH    R1,=H'3'                                                         
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   PSHDACC+1(0),SPDACCS                                             
*                                                                               
EPRE06   BAS   RE,PUTTAPE                                                       
         B     POSTX                                                            
*                                                                               
EPRCMT   DC    C'**AUTO REVERSE E.P.'                                           
EPCMT    DC    C'**ESTIMATED PRODUCTION'                                        
         DROP  R4                                                               
         EJECT                                                                  
***********************************************************************         
*              MAKE INTERCOMPANY POSTINGS                                       
*              PUT RECORDS TO SORTER FOR END-OF-JOB REPORT                      
***********************************************************************         
*                                                                               
         USING TRNELD,R2                                                        
         USING BIND,R5                                                          
PSTINTER DS    0H                                                               
         L     R5,AWRKTAB                                                       
         L     R4,BININ                                                         
         LTR   R4,R4                                                            
         BZ    PSTINTX             NOTHING IN TABLE, NO POSTINGS                
         LA    R5,BINTABLE                                                      
*                                                                               
         LA    RE,AREA             CLEAR POSTING AREA                           
         LA    RF,L'AREA                                                        
         SR    R1,R1                                                            
         MVCL  RE,R0                                                            
*                                                                               
         LA    RE,AREA                                                          
         LA    R3,4(RE)                                                         
         MVC   PSHDEL(2),=X'5046'                                               
         SR    R2,R2                                                            
         IC    R2,PSHDLEN                                                       
         LA    R2,0(R2,R3)                                                      
*                                                                               
         CLI   SVAGHOLD,C'Y'       ARE WE HOLDING POSTINGS?                     
         BNE   *+8                 NO                                           
         MVI   TRNSTAT,X'04'       YES                                          
*                                                                               
         USING WRKD,R5                                                          
         USING JOBD,R6                                                          
PSTI02   LA    R6,WRKACCUM                                                      
         CLI   WRKCDE,X'FF'                                                     
         BE    PSTI12              MAKE CREDIT POSTING/SEND TO SORT             
*                                                                               
         ZAP   TRNAMNT,JOBPGRS                                                  
         TM    CLIOPT,PAYNET                                                    
         BZ    *+10                                                             
         ZAP   TRNAMNT,JOBPNET                                                  
*                                                                               
         MVI   TRNEL,TRNELQ        DEBIT TO AGENCY JOB                          
         MVI   TRNLN,121                                                        
         OI    TRNSTAT,X'80'                                                    
         MVC   TRNDATE,DATE3                                                    
*                                                                               
         MVC   TRNREF,BILLREF                                                   
         MVI   TRNTYPE,63          NEW BATCH TYPE                               
         MVC   TRNANAL,WRKCDE      AGENCY WORKCODE                              
         MVC   TRNBTCH(2),MOS                                                   
*                                                                               
         MVC   TRNNARR,SPACES      NARRATIVE IS STUDIO JOB                      
         MVC   TRNNARR(2),=C'**'                                                
         MVC   TRNNARR+2(L'SVSTUD),SVSTUD                                       
         MVI   TRNNARR+2+L'SVSTUD,C'/'                                          
         MVC   TRNNARR+2+L'SVSTUD+1(L'JOBCODE-3),JOBCODE+3                      
*                                                                               
         LR    RF,R2                                                            
         SR    RE,RE                                                            
         IC    RE,TRNLN                                                         
         AR    RF,RE                                                            
*                                                                               
         OC    SVICR,SVICR         DO WE HAVE AN INTERCOMPANY CREDIT?           
         BZ    PSTI04              NO                                           
*                                                                               
         USING SPDELD,RF                                                        
         LR    R6,RF               SAVE RF                                      
         MVI   SPDEL,SPDELQ      YES, PASS IT ALONG                             
         MVC   SPDACCS(80),SPACES                                               
         MVC   SPDACCS(14),SVICR+1                                              
         GOTO1 SQUASHER,DMCB,SPDACCS,80                                         
         LR    RF,R6               RESTORE RF                                   
         SR    R1,R1                                                            
         IC    R1,DMCB+7                                                        
         LA    R1,2(R1)                                                         
         STC   R1,SPDLN                                                         
         AR    RF,R1                                                            
*                                                                               
         LA    RE,SVICR                                                         
         B     *+8                                                              
*                                                                               
PSTI04   LA    RE,SVVEND                                                        
         CLC   1(2,RE),=C'SV'                                                   
         BE    PSTI06                                                           
         CLC   1(2,RE),=C'SX'                                                   
         BE    PSTI06                                                           
         CLC   1(2,RE),=C'SY'                                                   
         BE    PSTI06                                                           
         CLC   1(2,RE),=C'SW'                                                   
         BNE   PSTI08                                                           
*                                                                               
         USING PAKELD,RF                                                        
PSTI06   MVI   PAKEL,PAKELQ                                                     
         MVI   PAKLN,PAKLNQ                                                     
         MVC   PAKACC,SVICR                                                     
         OC    PAKACC,PAKACC                                                    
         BNZ   *+10                                                             
         MVC   PAKACC,SVVEND                                                    
         MVC   PAKOFF,SVAGOFF                                                   
         MVC   PAKCON(6),SVAGKEY                                                
         MVC   PAKDATE,DATE3                                                    
         MVC   PAKREF,BILLREF                                                   
         SR    RE,RE                                                            
         IC    RE,PAKLN            ADD PAYABLE KEY ELEMENT                      
         AR    RF,RE                                                            
*                                                                               
PSTI08   TM    TRNSTAT,X'04'       IS THIS HELD?                                
         BZ    PSTI10              NO                                           
*                                                                               
         USING GDAELD,RF                                                        
         MVI   GDAEL,GDAELQ        YES, ADD ELEMENT WITH DATE                   
         MVI   GDALN,GDALNQ                                                     
         MVI   GDATYPE,GDATBHLD                                                 
         MVC   GDADATE,TODAYP                                                   
*                                                                               
         SR    RE,RE                                                            
         IC    RE,GDALN                                                         
         AR    RF,RE                                                            
*                                                                               
PSTI10   MVI   0(RF),0             MARK END OF RECORD                           
         MVC   PSHDACC,SVAGKEY                                                  
         MVC   PSHDANAL,WRKCDE                                                  
         MVC   PSHDSBAC,SVVEND                                                  
         MVC   PSHDSBNM,SVVENDN                                                 
*                                                                               
         BAS   RE,PUTTAPE                                                       
*                                                                               
         LA    R5,WRKLNQ(R5)                                                    
         BCT   R4,PSTI02                                                        
         B     PSTINTX                                                          
*                                                                               
PSTI12   MVI   TRNLN,X'1D'         ELIMINATE THE NARRATIVE                      
         MVC   TRNNARR,SPACES                                                   
         MVC   TRNANAL,SVAGOFF                                                  
         NI    TRNSTAT,X'FF'-X'80'-X'04'    MAKE CREDIT AND UNHOLD              
*                                                                               
         ZAP   TRNAMNT,JOBPGRS                                                  
         TM    CLIOPT,PAYNET                                                    
         BZ    *+10                                                             
         ZAP   TRNAMNT,JOBPNET                                                  
*                                                                               
         LR    RF,R2                                                            
         SR    RE,RE                                                            
         IC    RE,TRNLN                                                         
         AR    RF,RE                                                            
*                                                                               
         USING LNKEL,RF                                                         
         MVC   LNKEL(LNKLNQ),SVELEM                                             
         SR    RE,RE                                                            
         IC    RE,LNKLN            ADD LINK ELEMENT                             
         AR    RF,RE                                                            
         MVI   0(RF),0             MARK END OF RECORD                           
*                                                                               
         USING BIND,R5                                                          
         L     R5,AWRKTAB                                                       
         L     R4,BININ                                                         
         LA    R5,BINTABLE                                                      
         LR    R1,R4                                                            
         BCTR  R1,0                SUBTRACT 1 FOR TOTAL                         
         LTR   R1,R1                                                            
         BZ    PSTI16              NOTHING BUT A TOTAL                          
*                                                                               
         USING FFTELD,RF                                                        
         MVI   FFTEL,FFTELQ                                                     
         MVI   FFTTYPE,FFTTWRKC                                                 
         MVI   FFTSEQ,0                                                         
         MHI   R1,L'FFTWORK+L'FFTWAMT                                           
         STC   R1,FFTDLEN                                                       
         AHI   R1,FFTLN1Q+L'FFTDLEN                                             
         STC   R1,FFTLN                                                         
         LA    RF,FFTDATA                                                       
*                                                                               
         USING WRKD,R5                                                          
         USING FFTDATA,RF                                                       
PSTI14   LA    R6,WRKACCUM                                                      
         CLI   WRKCDE,X'FF'                                                     
         BE    PSTI16                                                           
         MVC   FFTWORK,WRKCDE                                                   
         ZAP   FFTWAMT,JOBPGRS                                                  
         TM    CLIOPT,PAYNET                                                    
         BZ    *+10                                                             
         ZAP   FFTWAMT,JOBPNET                                                  
         LA    R5,WRKLNQ(R5)                                                    
         AHI   RF,L'FFTWORK+L'FFTWAMT                                           
         BCT   R4,PSTI14                                                        
         SHI   RF,L'FFTWORK+L'FFTWAMT                                           
*                                                                               
PSTI16   MVI   0(RF),0             MARK END OF RECORD                           
*                                                                               
         MVC   PSHDACC,SVICR                                                    
         OC    SVICR,SVICR         DO WE HAVE AN OVERRIDE?                      
         BNZ   *+10                YES                                          
         MVC   PSHDACC,SVVEND      NO, USE VENDOR THEN                          
*                                                                               
         MVC   PSHDANAL,SPACES                                                  
*                                                                               
         MVC   PSHDSBAC,JOBCODE    CONTRA IS STUDIO JOB FOR SB                  
         MVC   PSHDSBNM,JOBNAME                                                 
         CLC   PSHDACC+1(2),=C'SB'                                              
         BE    PSTI18                                                           
*                                                                               
         MVC   PSHDSBAC,SVAGKEY    CONTRA IS AGENCY JOB FOR SC                  
         MVC   PSHDSBNM,SVAGACN                                                 
         CLC   PSHDACC+1(2),=C'SC'                                              
         BE    PSTI24                                                           
*                                                                               
         MVC   PSHDSBAC,SPACES     CONTRA IS AGENCY CLIENT FOR                  
         MVC   PSHDSBAC(6),SVAGKEY   ALL OTHERS, EXCEPT SR                      
         MVC   PSHDSBNM,SVAGCLIN                                                
         CLC   PSHDACC+1(2),=C'SR'                                              
         BNE   PSTI24                                                           
*                                                                               
         MVC   PSHDSBAC,MEDNAME    CONTRA IS BILLING SOURCE FOR SR              
         MVC   PSHDSBNM,SPACES                                                  
*                                                                               
PSTI18   OI    TRNSTAT,X'80'        AMOUNT IS A MINUS DEBIT FOR SR/SB           
         ZAP   DUB,TRNAMNT                                                      
         MP    DUB,=P'-1'                                                       
         ZAP   TRNAMNT,DUB                                                      
*                                                                               
         CP    TRNAMNT,HIAMT       TEST TRANSACTION AMOUNT TOO LARGE            
         BH    PSTI20                                                           
         CP    TRNAMNT,LOAMT       TEST TRANSACTION AMOUNT TOO SMALL            
         BL    PSTI20                                                           
*                                                                               
         USING MDTELD,RF                                                        
         BAS   RE,SET1A            INITIALIZE MEDIA ELEMENT                     
         ZAP   DUB,TRNAMNT         FILL IN COMMISSION AMOUNT                    
         CVB   RE,DUB                                                           
         STCM  RE,15,MDTGRS                                                     
         STCM  RE,15,MDTNET                                                     
         STCM  RE,15,MDTRECV                                                    
         B     PSTI22                                                           
*                                                                               
         USING MDPELD,RF                                                        
PSTI20   BAS   RE,SET6A            INITIALIZE MEDIA ELEMENT                     
         ZAP   MDPGRS,TRNAMNT                                                   
         ZAP   MDPNET,TRNAMNT                                                   
         ZAP   MDPRECV,TRNAMNT                                                  
*                                                                               
PSTI22   SR    RE,RE                                                            
         IC    RE,1(RF)                                                         
         AR    RF,RE                                                            
         MVI   0(RF),0             MARK END OF RECORD                           
*                                                                               
PSTI24   BAS   RE,PUTTAPE                                                       
*                                                                               
         USING INTD,R5                                                          
         L     R5,AINTRWK          GENERATE SORT RECORD FOR REPORT              
         LA    R1,INTRLNQ                                                       
         SLL   R1,16                                                            
         ST    R1,INTRLN                                                        
*                                                                               
         MVI   INTRTYP,INTREQU                                                  
         MVC   INTRSTUD,SVSTUD     STUDIO TYPE                                  
         MVC   INTRMED,JOBLET      MEDIA CODE                                   
         MVC   INTRSACC,JOBCODE+3  STUDIO JOB                                   
*                                                                               
         MVC   INTRDATE,DATE3      DATE                                         
         MVC   INTRAJOB,SVAGACC    AGENCY JOB                                   
         MVC   INTRCACC,PSHDACC+1                                               
*                                                                               
         MVC   INTRBILL(7),SHTBILNO                                             
*                                                                               
         ZAP   INTRAMT,JOBPGRS     AMOUNT                                       
         TM    CLIOPT,PAYNET                                                    
         BZ    *+10                                                             
         ZAP   INTRAMT,JOBPNET                                                  
*                                                                               
         GOTO1 ADSORTER,DMCB,=C'PUT',(R5)                                       
         MVI   ALSORT,1                                                         
*                                                                               
PSTINTX  B     POSTX                                                            
         DROP  R5                                                               
         EJECT                                                                  
***********************************************************************         
*              ROUTINE TO WRITE WORKER RECORDS AND TRAILER                      
***********************************************************************         
*                                                                               
PUTTAPE  NTR1                                                                   
         CLC   PSHDACC+1(2),=C'SI' ALWAYS DO IT FOR INCOME                      
         BE    PUTT02                                                           
         CLC   PSHDACC+1(2),=C'SJ' AND PRODUCTION                               
         BE    PUTT02                                                           
         CLC   PSHDACC+1(2),=C'SR' AND SR                                       
         BE    PUTT02                                                           
         CLC   PSHDACC+1(2),=C'1C' AND 1C                                       
         BE    PUTT02                                                           
         CLC   PSHDACC+1(2),=C'12' AND 12                                       
         BE    PUTT02                                                           
         CLC   PSHDACC+1(2),=C'11' AND 11                                       
         BE    PUTT02                                                           
         CLC   PSHDACC+1(2),TAXUL  AND GST OR PST                               
         BE    PUTT02                                                           
         CP    TRNAMNT,=P'0'       DON'T WRITE ZERO POSTINGS                    
         BE    POSTX                                                            
                                                                                
PUTT02   TM    TRNSTAT,X'80'                                                    
         BZ    *+10                                                             
         AP    TAPECASH,TRNAMNT                                                 
         AP    TAPECNT,=P'1'                                                    
         SR    R3,R3                                                            
         IC    R3,1(R2)                                                         
*                                                                               
PUTT04   AR    R2,R3                                                            
         CLI   0(R2),0                                                          
         BE    PUTT06                                                           
         IC    R3,1(R2)                                                         
         LTR   R3,R3               CHECK ZERO LENGTH ELEMENT                    
         BNZ   PUTT04                                                           
         MVI   0(R2),0                                                          
*                                                                               
PUTT06   LA    R2,1(R2)                                                         
         LA    R3,AREA                                                          
         SR    R2,R3                                                            
         STH   R2,AREA                                                          
         BAS   RE,ADDPOST                                                       
         B     POSTX                                                            
         EJECT                                                                  
***********************************************************************         
*              FORMAT THE MEDIA TRANSFER ELEMENT                                
***********************************************************************         
*                                                                               
         USING JOBD,R6                                                          
         USING MDTELD,RF                                                        
SET1A    XC    MDTEL(MDTLNQ),MDTEL                                              
         MVI   MDTEL,MDTELQ                                                     
         MVI   MDTLN,MDTLNQ                                                     
         MVI   MDTSYS,C'J'                                                      
         MVC   MDTMED,JOBCODE+9                                                 
         MVC   MDTCLI,CLICODE+3                                                 
         MVC   MDTPRD,PRDCODE+6                                                 
         MVC   MDTJOB,JOBCODE+9                                                 
         MVC   MDTMOS,DATE3                                                     
         MVC   MDTDSCP,JOBNAME                                                  
         TM    JOBOPT,JBSTUDIO     IS THIS A STUDIO JOB?                        
         BZR   RE                  NO, OK TO EXIT                               
         MVC   MDTMED,SVAGJOB     YES, USE AGENCY ACCOUNT & NAME                
         MVC   MDTCLI,SVAGCLI                                                   
         MVC   MDTPRD,SVAGPRO                                                   
         MVC   MDTJOB,SVAGJOB                                                   
         MVC   MDTDSCP,SVAGACN                                                  
         BR    RE                                                               
         DROP  RF                                                               
         EJECT                                                                  
***********************************************************************         
* FORMAT THE MEDIA TRANSFER ELEMENT PACKED                                      
***********************************************************************         
                                                                                
         USING JOBD,R6                                                          
         USING MDPELD,RF                                                        
SET6A    XC    MDPEL(MDPLNQ),MDPEL                                              
         MVI   MDPEL,MDPELQ                                                     
         MVI   MDPLN,MDPLNQ                                                     
         MVI   MDPSYS,MDPSPROD                                                  
         ZAP   MDPGRS,=P'0'            BILLING (GROSS)                          
         ZAP   MDPNET,=P'0'            PAYABLE (EXTERNAL)                       
         ZAP   MDPCOM,=P'0'            INCOME  (COMMISSION)                     
         ZAP   MDPCD,=P'0'             CASH DISCOUNT                            
         ZAP   MDPINTL,=P'0'           INCOME (INTERNAL)                        
         ZAP   MDPRECV,=P'0'           ACCOUNTS RECEIVABLE                      
         ZAP   MDPVAT,=P'0'            VAT AMOUNT                               
         MVC   MDPMED,JOBCODE+9                                                 
         MVC   MDPCLI,CLICODE+3                                                 
         MVC   MDPPRD,PRDCODE+6                                                 
         MVC   MDPJOB,JOBCODE+9                                                 
         MVC   MDPMOS,DATE3                                                     
         MVC   MDPDSCP,JOBNAME                                                  
         TM    JOBOPT,JBSTUDIO     IS THIS A STUDIO JOB?                        
         BZR   RE                  NO, OK TO EXIT                               
         MVC   MDPMED,SVAGJOB     YES, USE AGENCY ACCOUNT & NAME                
         MVC   MDPCLI,SVAGCLI                                                   
         MVC   MDPPRD,SVAGPRO                                                   
         MVC   MDPJOB,SVAGJOB                                                   
         MVC   MDPDSCP,SVAGACN                                                  
         BR    RE                                                               
         DROP  RF                                                               
         EJECT                                                                  
***********************************************************************         
*              BUILD RECORD FOR INTERNAL INVOICE REGISTER             *         
***********************************************************************         
*                                                                               
         USING ACPROFSD,R1                                                      
BUILDINV L     R1,APROFILE                                                      
         CLI   ACPPFC30,C'Y'       SUPPRESS THIS REPORT                         
         BER   RE                  YES                                          
*                                                                               
         ST    RE,SAVERE                                                        
         ST    R4,SAVER4                                                        
*                                                                               
         USING INVRD,R5                                                         
         L     R5,AINVRWK                                                       
         LA    R1,INVRLNQ                                                       
         SLL   R1,16                                                            
         ST    R1,INVRLEN                                                       
*                                                                               
         L     R4,ADTRANS                                                       
         MVI   INVRTYP,INVREQU                                                  
         MVC   INVRCLI(12),PSHDSBAC+3    JOB                                    
         MVC   INVROTH,SAVOTH                                                   
         MVC   INVRACC,PSHDACC+3      SK ACCOUNT                                
         MVC   INVRDTE,TRNDATE                                                  
         MVC   INVRREF,TRNREF-TRNELD(R4)                                        
         ZAP   INVRAMT,TRNAMNT                                                  
         MVC   INVRWRK,SVANAL                                                   
         MVC   INVRBILL,SPACES                                                  
         MVC   INVRBILL(7),SHTBILNO                                             
         GOTO1 ADSORTER,DMCB,=C'PUT',(R5)                                       
         MVI   ALSORT,1                                                         
*                                                                               
         L     R4,SAVER4                                                        
         L     RE,SAVERE                                                        
         BR    RE                                                               
         EJECT                                                                  
***********************************************************************         
*              MOVE THE WORKCODE/AMOUNT ELEMENT IN                    *         
***********************************************************************         
*                                                                               
MOVEFFT  MVC   0(L'SVDBELM,RF),SVDBELM                                          
         AHI   RF,L'SVDBELM                                                     
         BR    RE                                                               
         EJECT                                                                  
***********************************************************************         
*              BUILD X'48' ELEMENTS                                   *         
***********************************************************************         
*                                                                               
         USING VBIEL,R2                                                         
         USING GSTD,R5                                                          
BUILD48  NTR1                                                                   
         LR    R2,RF                                                            
         LA    R5,BUFWK                                                         
         XC    GSTKEY(GSTLNQ),GSTKEY                                            
         MVI   GSTTYPE,GSTTYPE5                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),1                           
         TM    DMCB+8,X'80'                                                     
         BO    BUILDX                                                           
         B     BUILD04                                                          
*                                  ELSE GET NEXT RECORD                         
BUILD02  MVI   BYTE,GSTTYPE5                                                    
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),1                         
         TM    DMCB+8,X'80'                                                     
         BO    BUILDX                                                           
*                                                                               
         USING JOBD,R6                                                          
BUILD04  CLI   GSTTYPE,GSTTYPE5                                                 
         BNE   BUILDX              NOT A GST RECORD                             
         CLI   GSTCODE,X'FF'       TOTAL RECORD?                                
         BE    BUILD02             YES, SKIP IT                                 
         XC    VBIEL(VBILNQ),VBIEL                                              
         MVI   VBIEL,VBIELQ                                                     
         MVI   VBILN,VBILNQ                                                     
         MVC   VBITYPE,GSTCODE                                                  
         MVC   VBIRATE,GSTRATE                                                  
         MVC   VBIINDS,GSTINDS                                                  
         MVC   VBIDATE,GSTDATE                                                  
         MVC   VBIACCT,GSTACCT                                                  
*                                                                               
         LA    R6,GSTACCUM                                                      
         CP    JOBGST,=P'0'        ANY GST CALCULATED ?                         
         BNE   BUILD06             YES                                          
         CP    JOBVBAS,=P'0'       NO, ANY BASIS USED ?                         
         BE    BUILD02             NO, GET NEXT RECORD THEN                     
*                                                                               
BUILD06  GOTO1 SHR,DMCB,('SUBRSHR',(RC))                                        
         ZAP   VBIVAT,JOBGST       SAVE GST                                     
         ZAP   VBIGROSS,JOBVGRS         GROSS                                   
         ZAP   VBICOMM,JOBCOMM          AND COMMISSION                          
         TM    CLIOPT,PAYNET       IF PAY=NET                                   
         BZ    BUILD08                                                          
         ZAP   VBIGROSS,JOBVNET    GROSS NOW IS NET                             
         ZAP   VBICOMM,=P'0'       AND COMMISSION IS ZERO                       
*                                                                               
BUILD08  SR    RE,RE                                                            
         IC    RE,VBILN                                                         
         AR    R2,RE                                                            
         B     BUILD02                                                          
*                                                                               
BUILDX   LR    RF,R2                                                            
         XIT1  REGS=(RF)                                                        
         DROP  R2,R5,R6                                                         
         EJECT                                                                  
***********************************************************************         
*              BUILD X'50' ELEMENTS                                   *         
***********************************************************************         
*                                                                               
         USING SCIELD,R2                                                        
         USING GSTD,R5                                                          
BUILD50  NTR1                                                                   
         LR    R2,RF                                                            
         LA    R5,BUFWK                                                         
         XC    GSTKEY(GSTLNQ),GSTKEY                                            
         MVI   GSTTYPE,GSTTYPE5                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),(R4)                        
         TM    DMCB+8,X'80'                                                     
         BO    BLD5006                                                          
         B     BLD5004                                                          
*                                  ELSE GET NEXT RECORD                         
BLD5002  MVI   BYTE,GSTTYPE5                                                    
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),(R4)                      
         TM    DMCB+8,X'80'                                                     
         BO    BLD5006                                                          
*                                                                               
         USING JOBD,R6                                                          
BLD5004  CLI   GSTTYPE,GSTTYPE5                                                 
         BNE   BLD5006             NOT A GST RECORD                             
         CLI   GSTCODE,X'FF'       TOTAL RECORD?                                
         BE    BLD5002             YES, SKIP IT                                 
         XC    SCIEL(SCILN3Q),SCIEL                                             
         MVI   SCIEL,SCIELQ                                                     
         MVI   SCILN,SCILN3Q                                                    
         MVI   SCITYPE,SCITTAXP                                                 
         MVC   SCISUBPT,GSTCODE                                                 
*                                                                               
         LA    R6,GSTACCUM                                                      
         CP    JOBGST,=P'0'        ANY GST CALCULATED ?                         
         BE    BLD5002             NO, GET NEXT RECORD THEN                     
         GOTO1 SHR,DMCB,('SUBRSHR',(RC))                                        
         ZAP   SCIAMNT,JOBGST      YES, GET GST AMOUNT                          
         ZAP   SCIBASE,JOBVBAS      AND BASE                                    
*                                                                               
         SR    RE,RE                                                            
         IC    RE,SCILN                                                         
         AR    R2,RE                                                            
         B     BLD5002                                                          
*                                                                               
         USING PSTD,R5                                                          
BLD5006  LA    R5,BUFWK                                                         
         XC    PSTKY(PSTLNQ),PSTKY                                              
         MVI   PSTTYPE,PSTTYPE7                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),(R4)                        
         TM    DMCB+8,X'80'                                                     
         BO    BLD50X                                                           
         B     BLD5010                                                          
*                                                                               
BLD5008  MVI   BYTE,PSTTYPE7                                                    
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),(R4)                      
         TM    DMCB+8,X'80'                                                     
         BO    BLD50X                                                           
*                                                                               
         USING JOBD,R6                                                          
BLD5010  CLI   PSTTYPE,PSTTYPE7                                                 
         BNE   BLD50X              NOT A PST RECORD                             
         CLI   PSTCODE,X'FF'       TOTAL RECORD?                                
         BE    BLD5008             YES, SKIP IT                                 
         XC    SCIEL(SCILN3Q),SCIEL                                             
         MVI   SCIEL,SCIELQ                                                     
         MVI   SCILN,SCILN3Q                                                    
         MVI   SCITYPE,SCITTQST                                                 
         MVC   SCISUBPT,PSTCODE                                                 
         MVC   SCISUBPR,PSTPROV                                                 
*                                                                               
         LA    R6,PSTACCUM                                                      
         CP    JOBPST,=P'0'        ANY PST CALCULATED ?                         
         BE    BLD5008             NO, GET NEXT RECORD THEN                     
         GOTO1 SHR,DMCB,('SUBRSHR',(RC))                                        
         ZAP   SCIAMNT,JOBPST      YES, GET PST AMOUNT                          
         ZAP   SCIBASE,JOBPBAS      AND BASE                                    
*                                                                               
         SR    RE,RE                                                            
         IC    RE,SCILN                                                         
         AR    R2,RE                                                            
         B     BLD5008                                                          
*                                                                               
BLD50X   LR    RF,R2                                                            
         XIT1  REGS=(RF)                                                        
         DROP  R2,R5,R6                                                         
         EJECT                                                                  
***********************************************************************         
*              BUILD X'7D' ELEMENTS                                   *         
***********************************************************************         
*                                                                               
         USING PBIEL,R2                                                         
         USING PSTD,R5                                                          
BUILD7D  NTR1                                                                   
         LR    R2,RF                                                            
         LA    R5,BUFWK                                                         
         XC    PSTKY(PSTLNQ),PSTKY                                              
         MVI   PSTTYPE,PSTTYPE7                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),1                           
         TM    DMCB+8,X'80'                                                     
         BO    BLD7DX                                                           
         B     BLD7D04                                                          
*                                                                               
BLD7D02  MVI   BYTE,PSTTYPE7                                                    
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),1                         
         TM    DMCB+8,X'80'                                                     
         BO    BLD7DX                                                           
*                                                                               
         USING JOBD,R6                                                          
BLD7D04  CLI   PSTTYPE,PSTTYPE7                                                 
         BNE   BLD7DX              NOT A PST RECORD                             
         CLI   PSTCODE,X'FF'       TOTAL RECORD?                                
         BE    BLD7D02             YES, SKIP IT                                 
         XC    PBIEL(PBILNQ),PBIEL                                              
         MVI   PBIEL,PBIELQ                                                     
         MVI   PBILN,PBILNQ                                                     
         MVC   PBITYPE,PSTCODE                                                  
         MVC   PBIRATE,PSTRATE                                                  
         MVC   PBIINDS,PSTINDS                                                  
         MVC   PBIDATE,PSTDATE                                                  
         MVC   PBIACCT,PSTACCT                                                  
         MVC   PBIPRV,PSTPROV                                                   
*                                                                               
         LA    R6,PSTACCUM                                                      
         CP    JOBPST,=P'0'        ANY PST CALCULATED ?                         
         BNE   BLD7D06             YES                                          
         CP    JOBPBAS,=P'0'       NO, ANY BASIS USED ?                         
         BE    BLD7D02             NO, GET NEXT RECORD THEN                     
*                                                                               
BLD7D06  GOTO1 SHR,DMCB,('SUBRSHR',(RC))                                        
         ZAP   PBIPST,JOBPST       SAVE PST                                     
         ZAP   PBIGROSS,JOBPGRS         GROSS                                   
         ZAP   PBICOMM,JOBCOMM          AND COMMISSION                          
         TM    CLIOPT,PAYNET       IF PAY=NET                                   
         BZ    BLD7D08                                                          
         ZAP   PBIGROSS,JOBPNET    GROSS NOW IS NET                             
         ZAP   PBICOMM,=P'0'       AND COMMISSION IS ZERO                       
*                                                                               
BLD7D08  SR    RE,RE                                                            
         IC    RE,PBILN                                                         
         AR    R2,RE                                                            
         B     BLD7D02                                                          
*                                                                               
BLD7DX   LR    RF,R2                                                            
         XIT1  REGS=(RF)                                                        
         DROP  R2,R5,R6                                                         
         EJECT                                                                  
***********************************************************************         
*              FORMAT THE INCOME ELEMENT                              *         
***********************************************************************         
*                                                                               
*              FORMAT X'B7' ELEMENTS                                            
*                                                                               
         USING INCELD,R1                                                        
FORMB7   NTR1                                                                   
         L     R1,APREVB7          ADD PREVIOUS INCOME NOT PROCESSED            
         CLI   0(R1),X'FF'         NO PREVIOUS                                  
         BE    FRMB7X                                                           
*                                                                               
FRMB702  CLI   0(R1),0                                                          
         BE    FRMB7X              NONE OR DONE                                 
         CLI   INCWRKC,X'EE'       IS THIS ONE USED?                            
         BE    FRMB704             YES                                          
         MP    INCAMNT,=P'-1'      REVERSE THE SIGN ON PREVIOUS                 
         MP    INCINAM,=P'-1'                                                   
         OC    INCCACC,INCCACC                                                  
         BNZ   *+10                                                             
         MVC   INCCACC,SVJOBCR+1                                                
         OC    INCDACC,INCDACC                                                  
         BNZ   *+10                                                             
         MVC   INCDACC,SVJOBDR+1                                                
         TM    INCOPT,INCEST+INCTOT                                             
         BNZ   FRMB704                                                          
         XC    INCCACC(L'INCCACC+L'INCDACC),INCCACC                             
         ZAP   INCINAM,=P'0'                                                    
*                                                                               
FRMB704  SR    RE,RE                                                            
         IC    RE,1(R1)                                                         
         BCTR  RE,0                                                             
         LA    R1,1(RE,R1)         NEXT ITEM IN TABLE                           
         B     FRMB702                                                          
*                                                                               
FRMB7X   XIT1                                                                   
         DROP  R1                                                               
         EJECT                                                                  
***********************************************************************         
*              ADD INCOME ELEMENT                                     *         
***********************************************************************         
*                                                                               
*              BUILD X'B7' ELEMENTS                                             
*                                                                               
         USING INCELD,R1                                                        
BUILDB7  NTR1                                                                   
         L     R1,ACURRB7          ADD INCOME ELEMENTS FROM TABLE               
*                                                                               
BLDB702  CLI   0(R1),0                                                          
         BE    BLDB704             NONE OR DONE, SEE IF ANY PREVIOUS            
         ZIC   RE,1(R1)                                                         
         BCTR  RE,0                                                             
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RF),0(R1)       ELEMENT TO IO AREA FROM TABLE                
         LA    RF,1(RE,RF)         NEXT IO AREA                                 
         LA    R1,1(RE,R1)         NEXT ITEM IN TABLE                           
         B     BLDB702                                                          
*                                                                               
BLDB704  L     R1,APREVB7          ADD PREVIOUS INCOME NOT PROCESSED            
         CLI   0(R1),X'FF'         NO PREVIOUS                                  
         BE    BLDB7X                                                           
*                                                                               
BLDB706  CLI   0(R1),0                                                          
         BE    BLDB7X              NONE OR DONE                                 
         ZIC   RE,1(R1)                                                         
         BCTR  RE,0                                                             
         CLI   INCWRKC,X'EE'       ALREADY PROCESSED ?                          
         BE    BLDB708             YES, SKIP IT                                 
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RF),0(R1)       ELEMENT TO IO AREA FROM TABLE                
         LA    RF,1(RE,RF)         NEXT IO AREA                                 
*                                                                               
BLDB708  LA    R1,1(RE,R1)         NEXT ITEM IN TABLE                           
         B     BLDB706                                                          
*                                                                               
BLDB7X   XIT1  REGS=(RF)                                                        
         DROP  R1                                                               
         EJECT                                                                  
***********************************************************************         
*              GET 12 ACCOUNT FOR INTERNAL INCOME POSTINGS            *         
***********************************************************************         
*                                                                               
*              GET 12 ACCOUNT                                                   
*                                                                               
         USING ACTRECD,R2                                                       
         USING INCELD,R5                                                        
GET12    NTR1                                                                   
         MVC   INC12ACC,SPACES     CLEAR 12 ACCOUNT                             
         MVC   INC12NME,SPACES     AND THE NAME                                 
         MVC   XTRACST,SPACES      AND THE COST ACCOUNT                         
*                                                                               
         L     R2,AIO2             READ SI ACCOUNT FROM TABLE                   
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,QCOMPANY                                                 
         MVC   ACTKULA(L'INCCACC),INCCACC                                       
         GOTO1 DATAMGR,DMCB,DMRDHI,FILNME,(R2),(R2)                             
         CLI   DMCB+8,0            FIND IT?                                     
         BNE   GET12X              NO, DON'T GET THE 12 ACCOUNT                 
         LR    RF,R2                                                            
         AH    RF,DATADISP                                                      
*                                                                               
GET1202  CLI   0(RF),0                                                          
         BNE   *+6                                                              
         DC    H'0'                                                             
         CLI   0(RF),X'2C'                                                      
         BE    GET1208                                                          
         CLI   0(RF),X'30'                                                      
         BE    GET1206                                                          
*                                                                               
GET1204  SR    RE,RE                                                            
         IC    RE,1(RF)                                                         
         AR    RF,RE                                                            
         B     GET1202                                                          
*                                                                               
         USING RSTELD,RF                                                        
GET1206  MVC   XTRACST(L'RSTCOSTG),RSTCOSTG                                     
         B     GET1210                                                          
*                                                                               
         USING SPAELD,RF                                                        
GET1208  CLI   SPATYPE,SPATANAL                                                 
         BNE   GET1204                                                          
         MVC   XTRACST(L'XTRACST),SPAAULA                                       
*                                                                               
GET1210  MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,QCOMPANY                                                 
         MVC   ACTKUNT(2),=C'12'                                                
         MVC   ACTKACT(L'XTRACST),XTRACST                                       
         MVC   INC12ACC,0(R2)                                                   
         GOTO1 DATAMGR,DMCB,DMRDHI,FILNME,(R2),(R2)                             
         CLC   0(15,R2),INC12ACC                                                
         BNE   GET12X                                                           
         LA    R3,INC12NME                                                      
         GOTO1 SHR,DMCB,('SUBRNAM',(RC))                                        
*                                                                               
GET12X   XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
*              UPDATE CYCLE RECORD WITH BILLING DATA                            
***********************************************************************         
*                                                                               
         USING JCBRECD,R4                                                       
         USING GOBLOCKD,R6                                                      
UPCYCLE  NTR1                                                                   
         L     R4,ACOMBUF                                                       
         L     R6,ADGOBLOC                                                      
         XC    JCBKEY,JCBKEY                                                    
         MVI   JCBKTYP,JCBKTYPQ                                                 
         MVI   JCBKSUB,JCBKSUBQ                                                 
         MVC   JCBKCUL,GOSELCUL                                                 
         MVC   JCBKCLI,GOSELCLI                                                 
         MVC   JCBKPRO,GOSELPRO                                                 
         MVC   JCBKJOB,GOSELJOB                                                 
         GOTO1 DATAMGR,DMCB,DMREAD,FILNME,(R4),(R4)                             
         CLI   DMCB+8,0            FIND IT ?                                    
         BE    *+6                 YES                                          
*                                                                               
UPCYCL1  DC    H'0'                MUST HAVE IT BY NOW                          
*                                                                               
UPCYCL2  AH    R4,DATADISP                                                      
*                                                                               
UPCYCL4  CLI   0(R4),0             END OF RECORD ?                              
         BE    UPCYCL1             YES, ERROR                                   
         CLI   0(R4),BCYELQ        CYCLE ELEMENT ?                              
         BE    UPCYCL8             YES                                          
*                                                                               
UPCYCL6  SR    R0,R0               KEEP LOOKING                                 
         IC    R0,1(R4)                                                         
         AR    R4,R0                                                            
         B     UPCYCL4                                                          
*                                                                               
         USING BCYELD,R4                                                        
UPCYCL8  OC    BCYBILD,BCYBILD     WAS THIS ONE BILLED ?                        
         BNZ   UPCYCL6             YES, LOOK AT NEXT ONE                        
         CLC   QAPPL+6(2),BCYMON   NO, MUST BE THE ONE                          
         BE    UPCYCL10                                                         
         TM    BCYSTAT,BCYSMON     CHECK IF HIGHER DATE ALSO ?                  
         BZ    UPCYCL1                                                          
         CLC   QAPPL+6(2),BCYMON   YES, IS IT HIGHER ?                          
         BNH   UPCYCL1             NO                                           
*                                                                               
UPCYCL10 ZAP   BCYESTA,ESTIMATE                                                 
         ZAP   BCYBILA,AMOUNTSJ                                                 
         MVC   BCYREF,BILLREF                                                   
         MVC   BCYBILD,TODAY2                                                   
         CLI   RCWRITE,C'N'        ARE WE WRITING TO THE FILE ?                 
         BE    UPCYCLX             NO                                           
         L     R4,ACOMBUF          READDRESS BUFFER                             
         GOTO1 DATAMGR,DMCB,DMWRT,FILNME,(R4),(R4)                              
*                                                                               
UPCYCLX  XIT1                                                                   
         DROP  R4,R6                                                            
         EJECT                                                                  
***********************************************************************         
*              OPEN POSTING FILE                                                
***********************************************************************         
*                                                                               
OPENPOST DC    0H'0'                                                            
         OI    ID+13,X'01'         ALLOW DUP KEYS                               
         MVC   ID(2),ORIGINUM                                                   
         PACK  DUB(2),RCDATE+3(3)                                               
         MVC   ID+6(1),DUB                                                      
         MVI   ID+7,C'P'                                                        
         MVC   ID+2(3),=C'A21'                                                  
         TM    BILLMODE,UNBILL                                                  
         BZ    *+10                                                             
         MVC   ID+2(3),=C'A23'                                                  
         MVC   COMMAND,=CL6'OPEN'                                               
         BAS   RE,FILE                                                          
         B     POSTX                                                            
         EJECT                                                                  
***********************************************************************         
*              WORKER INTERFACE                                                 
***********************************************************************         
*                                                                               
ADDPOST  MVC   COMMAND,=CL6'ADD'                                                
         B     FILE                                                             
*                                                                               
CLOSPOST MVC   COMMAND,=CL6'CLOSE'                                              
         B     FILE                                                             
*                                                                               
KEEPPOST MVC   COMMAND,=CL6'KEEP'                                               
         B     FILE                                                             
*                                                                               
FILE     NTR1                                                                   
         LA    R3,AREA                                                          
         L     R4,APOSTBUF                                                      
         TM    BILLMODE,DRAFT                                                   
         BO    FILEX                                                            
         CLI   RCPOSTNG,C'N'                                                    
         BE    FILEX                                                            
*                                                                               
         GOTO1 WORKER,DMCB,COMMAND,(R4),ID,(R3)                                 
         TM    DMCB+8,X'C0'                                                     
         BZ    FILEX                                                            
*                                  ERROR ON ADD TO WORKER FILE                  
         MVC   P,SPACES                                                         
         MVC   P(42),=C'*WORKER FILE FULL - STOP ALL FILE MARKERS*'             
         TM    DMCB+8,X'80'                                                     
         BO    *+10                                                             
         MVC   P(42),=C'*WORKER FILE DISK ERROR - CANNOT ADD ID = '             
         L     R2,DMCB+8           ADDRESS OF KEY                               
         MVC   DOUBLE(2),0(R2)                                                  
         LH    R3,DOUBLE                                                        
         CVD   R3,DOUBLE                                                        
         UNPK  DOUBLE+2(6),DOUBLE                                               
         OI    DOUBLE+7,X'F0'                                                   
         MVC   P+42(3),DOUBLE+5                                                 
         MVC   P+45(23),=C', REPLY = ''OK'' FOR DUMP'                           
*                                                                               
WKERR2   GOTO1 LOGIO,WORK,1,(68,P)                                              
         GOTO1 (RF),(R1),0,(2,DUB)                                              
         CLC   DUB(2),=C'OK'                                                    
         BNE   WKERR2                                                           
         DC    H'0'                NOW DIE                                      
*                                                                               
FILEX    B     POSTX                                                            
         EJECT ,                                                                
         GETELN R2,DATADISP,ELCODE,3                                            
*                                                                               
         DROP  R9,RA,RB                                                         
*                                                                               
         LTORG                                                                  
         EJECT ,                                                                
*                                  CODES AND NAMES FOR SK REVERSAL              
POSTCD   DS    PL6                                                              
INCOME   DS    PL6                                                              
*                                                                               
         DS    0D                                                               
AREA     DS    CL2000              BUILD TAPE RECORDS HERE                      
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*              ADD TO SUB-ACCOUNT TABLE                               *         
***********************************************************************         
*                                                                               
ADD2SUB  NTR1  BASE=*,LABEL=*                                                   
         L     RE,ASUBTAB          CLEAR SUBTAB                                 
         LA    RF,(SUBTABL*SUBTABM)                                             
         SR    R1,R1                                                            
         MVCL  RE,R0                                                            
                                                                                
         MVI   SUBTABN,0           CLEAR SUBTAB COUNTER                         
                                                                                
         L     R1,ADACC            GET JOB FIRST                                
         MVI   BYTE,0                                                           
         BRAS  RE,ADD2TAB                                                       
                                                                                
         LA    R1,COMMAC           COMMISSION ACCOUNT                           
         BRAS  RE,ADD2TAB                                                       
                                                                                
         MVC   WORK,SPACES                                                      
         MVC   WORK(L'COMMAC),COMMAC                                            
         MVI   WORK+2,C'K'                                                      
         LA    R1,WORK                                                          
         TM    JOBOPT,JOBSK                                                     
         BZ    *+8                                                              
         BRAS  RE,ADD2TAB                                                       
                                                                                
         CP    SKINC,=P'0'                                                      
         BE    *+8                                                              
         BRAS  RE,ADD2TAB                                                       
                                                                                
         MVI   BYTE,X'80'                                                       
         LA    R1,RECEIVBL         RECEIVABLE                                   
         L     R5,ARETAIL                                                       
         USING RTLD,R5                                                          
         LTR   R5,R5                                                            
         BZ    ADD2SUB2                                                         
         CLI   RTLRECV,X'40'                                                    
         BNH   ADD2SUB2                                                         
         LA    R1,RTLRECV                                                       
                                                                                
ADD2SUB2 BRAS  RE,ADD2TAB                                                       
         DROP  R5                                                               
                                                                                
         LA    R1,COSTING          COSTING                                      
         TM    CMPOPT,POSTCOST                                                  
         BZ    ADD2SUB4                                                         
         BRAS  RE,ADD2TAB                                                       
                                                                                
         MVI   BYTE,0                                                           
         LA    R1,SUSPAC           SUSPENSE                                     
         BRAS  RE,ADD2TAB                                                       
                                                                                
         MVC   WORK,SPACES                                                      
         MVC   WORK(L'SUSPAC),SUSPAC                                            
         MVI   WORK+2,C'1'                                                      
         LA    R1,WORK                                                          
         BRAS  RE,ADD2TAB                                                       
                                                                                
ADD2SUB4 LA    R1,CDACCT                                                        
         CLI   PROF9,C'G'          GROSS CD OPTION ?                            
         BNE   ADD2SUB6            NO                                           
         BRAS  RE,ADD2TAB                                                       
                                                                                
ADD2SUB6 BRAS  RE,ADDTAX           ADD GST/PST ACCOUNT, IF ANY                  
                                                                                
ADD2SUBX XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
*              ADD CONTRA SK FLIP TO SUB-ACCOUNT TABLE                *         
***********************************************************************         
*                                                                               
ADDSUB2  NTR1  BASE=*,LABEL=*                                                   
         L     RE,ASUBTAB          CLEAR SUBTAB                                 
         LA    RF,(SUBTABL*SUBTABM)                                             
         SR    R1,R1                                                            
         MVCL  RE,R0                                                            
                                                                                
         MVI   SUBTABN,0           CLEAR SUBTAB COUNTER                         
                                                                                
         LA    R1,PSHDACC          SK FIRST                                     
         MVI   BYTE,X'80'                                                       
         BRAS  RE,ADD2TAB                                                       
                                                                                
         MVC   WORK,SPACES         SI NEXT                                      
         MVC   WORK(L'ACTKCULA),PSHDACC                                         
         MVI   WORK+2,C'I'                                                      
         MVI   BYTE,0                                                           
         LA    R1,WORK                                                          
         BRAS  RE,ADD2TAB                                                       
                                                                                
         TM    CMPOPT,POSTCOST                                                  
         BZ    ADDSUB2X                                                         
         LA    R1,COSTING          COSTING                                      
         MVI   BYTE,X'80'                                                       
         BRAS  RE,ADD2TAB                                                       
                                                                                
         MVC   WORK,SPACES         SUSPENSE                                     
         MVC   WORK(L'ACTKCULA),SUSPAC                                          
         LA    R1,SUSPAC                                                        
         CLI   SIAC,C' '                                                        
         BE    *+10                                                             
         MVC   WORK+3(L'SIAC),SIAC                                              
         LA    R1,WORK                                                          
         MVI   BYTE,0                                                           
         BRAS  RE,ADD2TAB                                                       
                                                                                
ADDSUB2X XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
*              ADD TYPE 49 OR TRANSFER FILP TO SUB-ACCOUNT TABLE      *         
***********************************************************************         
*                                                                               
ADDSUB3  NTR1  BASE=*,LABEL=*                                                   
         L     RE,ASUBTAB          CLEAR SUBTAB                                 
         LA    RF,(SUBTABL*SUBTABM)                                             
         SR    R1,R1                                                            
         MVCL  RE,R0                                                            
                                                                                
         MVI   SUBTABN,0           CLEAR SUBTAB COUNTER                         
                                                                                
         LA    R1,SKACCT           SK FIRST                                     
         MVI   BYTE,X'80'                                                       
         BRAS  RE,ADD2TAB                                                       
                                                                                
         LA    R1,SIACCT           SI NEXT                                      
         MVI   BYTE,0                                                           
         BRAS  RE,ADD2TAB                                                       
                                                                                
         TM    CMPOPT,POSTCOST                                                  
         BZ    ADDSUB3X                                                         
         LA    R1,COSTING          COSTING                                      
         MVI   BYTE,X'80'                                                       
         BRAS  RE,ADD2TAB                                                       
                                                                                
         MVC   WORK,SPACES         SUSPENSE                                     
         MVC   WORK(L'ACTKULA),SUSPAC                                           
         LA    R1,SUSPAC                                                        
         CLI   SIAC,C' '                                                        
         BE    *+10                                                             
         MVC   WORK+3(L'SIAC),SIAC                                              
         LA    R1,WORK                                                          
         MVI   BYTE,0                                                           
         BRAS  RE,ADD2TAB                                                       
                                                                                
ADDSUB3X XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
*              LOOK FOR GST/PST AND ADD ACCOUNTS TO SUBTAB            *         
***********************************************************************         
*                                                                               
ADDTAX   NTR1  BASE=*,LABEL=*                                                   
         USING GSTD,R5                                                          
         LA    R5,BUFWK                                                         
         XC    GSTKEY(GSTLNQ),GSTKEY                                            
         MVI   GSTTYPE,GSTTYPE5                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),1                           
         TM    DMCB+8,X'80'                                                     
         BO    ADDTAX6             NO GST RECORDS                               
                                                                                
         CLI   GSTTYPE,GSTTYPE5                                                 
         BNE   ADDTAX6             NOT A GST RECORD                             
         B     ADDTAX4                                                          
                                                                                
ADDTAX2  MVI   BYTE,GSTTYPE5                                                    
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),1                         
         TM    DMCB+8,X'80'                                                     
         BO    ADDTAX6                                                          
*                                                                               
ADDTAX4  OC    GSTACCT,GSTACCT     DO WE HAVE AN ACCOUNT ?                      
         BZ    ADDTAX2             NO, GET NEXT ONE                             
         CLI   GSTCODE,X'FF'       TOTAL RECORD?                                
         BE    ADDTAX2             YES, SKIP IT                                 
                                                                                
         MVI   BYTE,0                                                           
         LA    R1,GSTACCT          GST ACCOUNT                                  
         BRAS  RE,ADD2TAB                                                       
         B     ADDTAX2             LOOK FOR MORE                                
         DROP  R5                                                               
                                                                                
         USING PSTD,R5                                                          
ADDTAX6  LA    R5,BUFWK                                                         
         XC    PSTKY(PSTLNQ),PSTKY                                              
         MVI   PSTTYPE,PSTTYPE7                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),1                           
         TM    DMCB+8,X'80'                                                     
         BO    ADDTAXX                                                          
                                                                                
         CLI   PSTTYPE,PSTTYPE7                                                 
         BNE   ADDTAXX             NOT A PST RECORD                             
         B     ADDTAX10                                                         
                                                                                
ADDTAX8  MVI   BYTE,PSTTYPE7                                                    
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),1                         
         TM    DMCB+8,X'80'                                                     
         BO    ADDTAXX                                                          
*                                                                               
ADDTAX10 OC    PSTACCT,PSTACCT     DO WE HAVE AN ACCOUNT ?                      
         BZ    ADDTAX8             NO, GET NEXT ONE                             
         CLI   PSTCODE,X'FF'       TOTAL RECORD?                                
         BE    ADDTAX8             YES, SKIP IT                                 
                                                                                
         MVI   BYTE,0                                                           
         LA    R1,PSTACCT          PST ACCOUNT                                  
         BRAS  RE,ADD2TAB                                                       
         B     ADDTAX8             LOOK FOR MORE                                
         DROP  R5                                                               
                                                                                
ADDTAXX  XIT1                                                                   
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*              FIT ACCOUNT INTO TABLE                                 *         
***********************************************************************         
*                                                                               
         USING SUBTABD,RF                                                       
ADD2TAB  NTR1  BASE=*,LABEL=*                                                   
         L     RF,ASUBTAB            RF=A(TABLE OF PRIMARY ACCOUNTS)            
         LHI   R0,SUBTABM            R0=MAX NUMBER OF ENTRIES IN TABLE          
                                                                                
ADD2TAB2 OC    0(SUBTABL,RF),0(RF)   VACANT SPOT?                               
         BZ    ADD2TAB6              YES                                        
         CLC   SUBSTA,BYTE                                                      
         BNE   ADD2TAB4                                                         
         CLC   SUBACC,1(R1)                                                     
         BE    ADD2TABX              YES, LEAVE IT                              
                                                                                
ADD2TAB4 AHI   RF,SUBTABL            BUMP TO NEXT TABLE ENTRY                   
         BCT   R0,ADD2TAB2                                                      
         B     ADD2TABX                                                         
                                                                                
ADD2TAB6 MVC   SUBSTA,BYTE                                                      
         MVC   SUBACC,1(R1)                                                     
         IC    RF,SUBTABN          INCREMENT NUMBER OF TABLE ENTRIES            
         AHI   RF,1                                                             
         STC   RF,SUBTABN                                                       
                                                                                
ADD2TABX XIT1                                                                   
         DROP  RF                                                               
         EJECT                                                                  
***********************************************************************         
*              FORMAT ELEMENT TO CARRY WORKCODE AND AMOUNT            *         
***********************************************************************         
*                                                                               
*              BUILD X'DB' ELEMENT WITH WORKCODE AND SJ AMOUNT                  
*                                                                               
         USING FFTELD,R5                                                        
BUILDDB  NTR1  BASE=*,LABEL=*                                                   
         LA    R5,SVDBELM                                                       
         MVI   FFTEL,FFTELQ                                                     
         MVI   FFTLN,FFTLN1Q+L'FFTDLEN+L'FFTWORK+L'FFTWAMT                      
         MVI   FFTTYPE,FFTTWRKC                                                 
         MVI   FFTSEQ,0                                                         
         MVI   FFTDLEN,L'FFTWORK+L'FFTWAMT                                      
*                                                                               
BLDDBX   XIT1                                                                   
         DROP  R5                                                               
         EJECT                                                                  
***********************************************************************         
*              FORMAT ELEMENT TO CARRY WORKCODE                       *         
***********************************************************************         
*                                                                               
*              BUILD X'C5' ELEMENTS FROM WORKCODE PASSED AT 0(R1)               
*                                                                               
         USING RFLELD,R2                                                        
BUILDC5  NTR1  BASE=*,LABEL=*                                                   
         LR    R2,RF                                                            
         XC    RFLEL(RFLLNQ),RFLEL                                              
         MVI   RFLEL,RFLELQ                                                     
         MVI   RFLLN,RFLLNQ+L'SVANAL                                            
         MVI   RFLTYPE,RFLWC                                                    
         MVC   RFLDATA(L'SVANAL),0(R1)                                          
*                                                                               
         SR    RE,RE                                                            
         IC    RE,RFLLN                                                         
         AR    R2,RE                                                            
*                                                                               
BLDC5X   LR    RF,R2                                                            
         XIT1  REGS=(RF)                                                        
         DROP  R2                                                               
         EJECT                                                                  
***********************************************************************         
*              BUILD X'C0' ELEMENT AND ADD IT                         *         
***********************************************************************         
*                                                                               
         USING APEELD,R2                                                        
BUILDC0  NTR1  BASE=*,LABEL=*                                                   
         L     R1,ASUBTAB          R1=A(TABLE OF ANALYSIS ACCOUNTS)             
         SR    R0,R0                                                            
         ICM   R0,1,SUBTABN        R0=NUMBER OF TABLE ENTRIES                   
         BZ    BLDC0X                                                           
                                                                                
         LR    R2,RF                                                            
                                                                                
         MVI   APEEL,APEELQ                                                     
         MVI   APELN,APELN1Q                                                    
         MVI   APENUM,0                                                         
                                                                                
         USING SUBTABD,R1                                                       
BLDC02   CLC   SUBACC,PSHDACC+1                                                 
         BE    BLDC04                                                           
         CLC   SUBACC,PSHDSBAC+1                                                
         BE    BLDC04                                                           
                                                                                
         SR    RE,RE                                                            
         IC    RE,APELN                                                         
         LA    RE,APEELD(RE)                                                    
         USING APENTRY,RE          RE=A(APEEL ENTRY)                            
         MVC   APENSTAT,SUBSTA                                                  
         MVC   APENACT,SUBACC                                                   
         LA    RF,APENACT+L'APENACT-1                                           
         CLI   0(RF),C' '          LOCATE END OF ACCOUNT CODE                   
         BH    *+12                                                             
         MVI   0(RF),0             AND DROP TRAILING SPACES                     
         BCT   RF,*-12                                                          
         AHI   RF,1                                                             
         SR    RF,RE               RF=L'SUB-ELEMENT                             
         STC   RF,APENLEN                                                       
         DROP  RE                                                               
                                                                                
         SR    RE,RE               INCREMENT ELEMENT LENGTH                     
         IC    RE,APELN                                                         
         AR    RE,RF                                                            
         STC   RE,APELN                                                         
         IC    RE,APENUM           INCREMENT NUMBER OF SUB-ELEMENTS             
         AHI   RE,1                                                             
         STC   RE,APENUM                                                        
                                                                                
BLDC04   AHI   R1,SUBTABL          BUMP TO NEXT TABLE ENTRY                     
         BCT   R0,BLDC02                                                        
                                                                                
         SR    RE,RE                                                            
         IC    RE,APELN                                                         
         AR    R2,RE                                                            
         LR    RF,R2                                                            
                                                                                
BLDC0X   XIT1  REGS=(RF)                                                        
         DROP  R1,R2                                                            
         EJECT                                                                  
         TITLE 'AC21 - PRODUCTION BILLING - PRINTING ROUTINES'                  
PRNTR    DS    0D                                                               
         NMOD1 0,*PRNT*,RA,R9                                                   
         L     RC,0(R1)                                                         
         MVC   PRNTMODE,0(R1)                                                   
         CLI   PRNTMODE,PRNTALL                                                 
         BE    PRT                                                              
         CLI   PRNTMODE,PRNTDUE                                                 
         BE    DUELNE                                                           
         CLI   PRNTMODE,PRNTOTC                                                 
         BE    TOTCHR                                                           
         CLI   PRNTMODE,PRNTGRP                                                 
         BE    GRPBIL                                                           
         CLI   PRNTMODE,PRNTCOM                                                 
         BE    COMMPRT                                                          
PRNTX    XIT1                                                                   
         EJECT                                                                  
*                                                                               
PRT      MVI   PRINTED,C'Y'        INDICATE WE PRINTED SOMETHING                
         MVC   HEAD7,SPACES        CLEAR HEAD7,8, 9 AND 10                      
         MVC   HEAD8,SPACES                                                     
         MVC   HEAD9,SPACES                                                     
         MVC   HEAD10,SPACES                                                    
*                                                                               
         MVC   HEAD1+33(L'AC@PRD),AC@PRD                                        
         TM    BILLOPT,MEDIANM                                                  
         BZ    PRT8                                                             
         MVC   HEAD1+33(10),SPACES                                              
         GOTO1 SHR,DMCB,('SUBRCOST',(RC))     MEDIA VALUE AND COSTING           
         LA    RF,HEAD1+31                                                      
         LA    RE,11                                                            
         LA    R1,MEDNAME+14                                                    
*                                                                               
PRT4     CLI   0(R1),C' '                                                       
         BNE   PRT6                                                             
         LA    RF,1(RF)                                                         
         BCTR  RE,0                                                             
         BCT   R1,PRT4                                                          
*                                                                               
PRT6     EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RF),MEDNAME+3                                                
*                                                                               
PRT8     DS    0H                                                               
         GOTO1 UNDERLIN,DMCB,(12,HEAD1+31),HEAD2+31                             
         MVC   HEAD3+9(6),CLICODE+3 CLIENT                                      
*                                                                               
         MVC   HEAD4+9(3),PRDCODE+6  PRODUCT                                    
*                                                                               
         MVC   HEAD6+9(6),JOBCODE+9    JOB                                      
         MVC   HEAD5+9(1),JOBLET   MEDIA                                        
*                                                                               
         CLI   QOPT1,C'S'                                                       
         BE    PRT12                                                            
         CLI   PROF1,C'Y'          SUPRESS                                      
         BE    PRT12                                                            
         CLI   PROF1,C'S'          SUPRESS                                      
         BE    PRT12                                                            
         CLI   PROF1,C'G'          GROSS                                        
         BE    PRT10                                                            
         MVC   HEAD5+29(L'AC@EST),AC@EST                                        
         MVI   HEAD5+29+L'AC@EST,C'('                                           
         MVC   HEAD5+29+L'AC@EST+1(L'AC@NET),AC@NET                             
         MVC   HEAD5+29+L'AC@EST+1+L'AC@NET(2),=C')='                           
         CURED (P6,ESTIMATE),(10,HEAD5+44),2,ALIGN=LEFT                         
         B     PRT12                                                            
*                                                                               
PRT10    MVC   HEAD5+29(L'AC@EST),AC@EST                                        
         MVI   HEAD5+29+L'AC@EST,C'('                                           
         MVC   HEAD5+29+L'AC@EST+1(L'AC@GROSS),AC@GROSS                         
         MVC   HEAD5+29+L'AC@EST+1+L'AC@GROSS(2),=C')='                         
         CURED (P6,GRSSEST),(10,HEAD5+46),2,ALIGN=LEFT                          
*                                                                               
PRT12    MVC   HEAD5+16(12),MEDNAME+3                                           
         MVC   HEAD3+16(36),CLINAME                                             
         MVC   HEAD4+16(36),PRDNAME                                             
         MVC   HEAD6+16(36),JOBNAME                                             
         MVC   HEAD1+11(8),BILLDTE                                              
         USING ACPROFSD,R1                                                      
         L     R1,APROFILE                                                      
         CLI   ACPPFC31,C'Y'       PRINT MMMDD/YY FORMAT?                       
         BNE   PRT13               NO                                           
         GOTO1 DATCON,DMCB,(4,BILLDTE),(8,HEAD1+11)                             
         DROP  R1                                                               
*                                                                               
PRT13    LA    R4,HEAD3+55                                                      
         L     R2,ARTLNAME                                                      
         LTR   R2,R2                                                            
         BZ    PRT14                    NOT RETAIL BILL                         
         MVC   HEAD3+55(36),0(R2)       RETAILER NAME                           
         LA    R4,HEAD4+55                                                      
         L     R2,ARTLADDR              AND ADDRESS                             
         LTR   R2,R2                                                            
         BZ    PRT14                                                            
         LA    R5,4                                                             
         MVC   0(L'ADRADD1,R4),0(R2)                                            
         LA    R2,L'ADRADD1(R2)                                                 
         LA    R4,132(R4)                                                       
         BCT   R5,*-14                                                          
         B     PRT20                                                            
*                                                                               
PRT14    L     R2,ADLVCADD         LOOK FOR ADDRESSES                           
         LTR   R2,R2                                                            
         BNZ   PRT16                                                            
         L     R2,ADLVBADD                                                      
         LTR   R2,R2                                                            
         BNZ   PRT16                                                            
         L     R2,ADLVAADD                                                      
         LTR   R2,R2                                                            
         BZ    PRT20                                                            
*                                                                               
         USING ADRELD,R2                                                        
PRT16    DS    0H                  OUTPUT AN ADDRESS                            
         SR    R5,R5                                                            
         ICM   R5,1,ADRNUM                                                      
         BZ    PRT20                                                            
         LA    R3,ADRADD1                                                       
*                                                                               
PRT18    MVC   0(26,R4),0(R3)                                                   
         LA    R3,26(R3)                                                        
         LA    R4,132(R4)                                                       
         BCT   R5,PRT18                                                         
*                                                                               
PRT20    MVC   HEAD1+67(10),LNGBILNO                                            
*                                                                               
         CLC   BILLINFO,SPACES     TEST FOR 'PRINT ON BILLS'                    
         BE    PRT21               NO                                           
         OC    BILLINFO,SPACES                                                  
         LA    RE,BILLINFO+L'BILLINFO-1                                         
         LA    R1,L'BILLINFO       FIND L'STRING                                
         CLI   0(RE),C' '          TEST FOR A SIGNIFICANT CHARACTER             
         BNE   *+14                                                             
         BCTR  RE,0                                                             
         BCT   R1,*-10                                                          
         B     PRT21               REALLY A NULL STRING                         
*                                                                               
         LA    RE,HEAD8+55                                                      
         CLC   ORIGINUM,=X'3579'   IS THIS WNCH?                                
         BE    *+18                                                             
         CLC   ORIGINUM,=X'357A'   OR WNCHB?                                    
         BE    *+8                                                              
         LA    RE,HEAD7+1                                                       
         BCTR  R1,0                DO VARIABLE LENGTH MOVE TO                   
         EX    R1,*+8              TRY TO AVOID OVERWRITING 4TH                 
         B     *+10                ADDRESS LINE                                 
         MVC   0(0,RE),BILLINFO                                                 
*                                                                               
PRT21    TM    JOBOPT,FUNDED       IS JOB FUNDED?                               
         BZ    PRT21A              NO                                           
*                                                                               
         L     R4,ADGOBLOC                                                      
         USING GOBLOCKD,R4                                                      
         L     R4,GOAEXT                                                        
         USING GOXBLKD,R4                                                       
         CLI   GOPAB,C'Y'          YES, ARE WITH PRINTING AUTH#?                
         BNE   PRT21A              NO                                           
*                                                                               
         LA    RE,GOANT+L'GOANT-1  YES, FIND LENGTH OF DESCRIPTION              
         LA    R1,L'GOANT                                                       
         CLI   0(RE),C' '                                                       
         BH    *+14                                                             
         BCTR  RE,0                                                             
         BCT   R1,*-10                                                          
         B     PRT21A              NO DESCRIPTION, SKIP IT                      
*                                                                               
         LA    RE,HEAD7+1                                                       
         CLC   0(L'BILLINFO,RE),SPACES   ANY POB?                               
         BE    *+8                       NO                                     
         LA    RE,HEAD7+50               YES, SKIP PAST IT                      
*                                                                               
         BCTR  R1,0                MOVE OUT DESCRIPTION                         
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RE),GOANT                                                    
         LA    RE,1(RE,R1)                                                      
         MVC   1(L'SVAUTH,RE),SVAUTH                                            
         DROP  R4                                                               
*                                                                               
PRT21A   CLI   PROF14,C'Y'                                                      
         BE    PRT22A             SUPPRESS DUE DATE                             
         MVC   HEAD2+55(L'AC@DUEDT),AC@DUEDT                                    
         MVC   HEAD2+55+L'AC@DUEDT+1(L'DUEDAT),DUEDAT                           
*                                                                               
PRT22A   MVC   HEAD1+55(L'AC@BILC),AC@BILC                                      
         CLI   PROF28,C'Y'        USE INVOICE INSTEAD OF BILL?                  
         BNE   PRT22              NO                                            
         MVC   HEAD1+55(L'AC@BILC),SPACES                                       
         MVC   HEAD1+55(L'AC@INV),AC@INV                                        
*                                                                               
PRT22    CLI   SHIPDATE,0                                                       
         BE    PRT23                                                            
         SR    RF,RF                                                            
         IC    RF,SHIPDATE         NUMBER OF DAYS BEFORE DUE DATE               
         LNR   RF,RF                                                            
         GOTO1 ADDAY,DMCB,DUE6,WORK,(RF)                                        
         GOTO1 DATCON,DMCB,(0,WORK),(8,WORK+6)                                  
         MVC   HEAD2+1(L'AC@SHIP),AC@SHIP                                       
         MVC   HEAD2+1+L'AC@SHIP+1(8),WORK+6                                    
*                                                                               
PRT23    CLC   SVEA,SPACES                                                      
         BE    *+16                                                             
         MVC   HEAD8+16(3),=C'EA='                                              
         MVC   HEAD8+20(14),SVEA                                                
         CLC   SVAC,SPACES                                                      
         BE    *+10                                                             
         MVC   HEAD8+56(14),SVAC                                                
         CLC   SVBI,SPACES                                                      
         BE    *+10                                                             
         MVC   HEAD8+36(15),SVBI                                                
         CLC   SVBU,SPACES                                                      
         BE    PRT24                                                            
         MVC   HEAD8+71(3),=C'BG='                                              
         MVC   HEAD8+74(15),SVBU                                                
*                                                                               
PRT24    OC    SVAGACC,SVAGACC     DO WE HAVE AN AGENCY JOB?                    
         BZ    PRT27               NO                                           
         LA    R3,SOFTAB                                                        
*                                                                               
PRT25    SR    R5,R5                                                            
         ICM   R5,3,0(R3)          GET FIRST DISPLACEMENT                       
         AR    R5,RC                                                            
         CLC   0(L'SOFTH1,R5),SPACES                                            
         BNE   PRT26                                                            
         MVC   0(10,R5),=C'AGENCY JOB'                                          
         MVC   11(L'SVAGACC,R5),SVAGACC                                         
         B     PRT27                                                            
*                                                                               
PRT26    LA    R3,2(R3)                                                         
         CLI   0(R3),X'FF'                                                      
         BNE   PRT25                                                            
*                                                                               
PRT27    LA    R0,6                ONLY PRINT FIRST 6 FIELDS                    
         LA    R1,SOFTH1                                                        
         LA    R3,SOFTAB                                                        
*                                                                               
PRT28    CLC   0(L'SOFTH1,R1),SPACES                                            
         BE    PRT30               NO MORE SOFT HEADLINES                       
         SR    R5,R5                                                            
         ICM   R5,3,0(R3)          DISPLACEMENT TO HEADLINE FIELD               
         AR    R5,RC               R5=TO HEADLINE FIELD                         
         CLC   0(L'SOFTH1,R5),SPACES                                            
         BNE   *+14                                                             
         MVC   0(L'SOFTH1-1,R5),0(R1) DATA TO HEADLINE                          
         LA    R1,L'SOFTH1(R1)                                                  
         LA    R3,2(R3)                                                         
         CLI   0(R3),X'FF'                                                      
         BNE   PRT28                                                            
*                                                                               
PRT30    MVC   SPACING,MYSPACE                                                  
         L     RE,APROFILE                                                      
         USING ACPROFSD,RE                                                      
         MVC   WORK(1),ACPPFO16                                                 
         CLI   WORK,X'00'          DO WE HAVE AN OPTION AT THIS LEVEL ?         
         BNE   PRT32               YES                                          
         MVC   WORK(1),ACPPFL16    NO, LOOK FOR LEDGER LEVEL THEN               
         CLI   WORK,X'00'          DO WE HAVE AN OPTION AT THIS LEVEL ?         
         BNE   PRT32               YES                                          
         MVC   WORK(1),ACPPFC16    NO, USE AGENCY LEVEL THEN                    
*                                                                               
         USING RUNXTRAD,RF                                                      
PRT32    L     RF,VEXTRAS                                                       
         CLI   WORK,C'B'           B=PRINT NAME ONLY                            
         BE    *+12                                                             
         CLI   WORK,C'Y'           Y=PRINT NAME AND ADDRESS                     
         BNE   *+10                                                             
         MVC   UPPER1+33(33),ORIGNME                                            
         CLI   WORK,C'A'           A=PRINT ADDRESS ONLY                         
         BE    *+12                                                             
         CLI   WORK,C'Y'           Y=PRINT NAME AND ADDRESS                     
         BNE   *+10                                                             
         MVC   UPPER2+33(33),ORIGADD   ORIGIN ADDRESS TO HEADLINES              
         CLI   RTLEDG,0              IF NO DISTRIBUTION SCHEME                  
         BE    PRT34                   OK TO PRINT                              
         CLI   RTLMODE,RTLPRNT        IF IN RETAIL PRINT MODE                   
         BE    PRT34                   OK TO PRINT                              
         MVI   RTLMODE,RTLDTLS          ELSE, SAVE DETAIL PRINT LINES           
         GOTO1 RTL,DMCB,(RC)           SAVE DETAIL LINES FOR RETAIL             
         CLI   RTLMODE,RTLDTLS          HAS ROUTINE SAVED LINE                  
         BE    PRNTAX                   IF IT HAS DON'T PRINT                   
*                                                                               
PRT34    GOTO1 ACREPORT                 ELSE, PRINT IT                          
         MVI   MYSPACE,2                                                        
*                                                                               
PRNTAX   B     PRNTX                                                            
         DROP  RE                                                               
         EJECT                                                                  
*              PRINT INVOICE TOTALS                                             
*                                                                               
DUELNE   MVI   DUESW,C'Y'                                                       
         USING JOBD,R6                                                          
         GOTO1 SHR,DMCB,('SUBRPOB',(RC))                                        
         LA    R6,JOBDTL           R6 TO ACCUM LINE                             
         TM    BILLTYPE,SPECIAL                                                 
         BO    DUEL02                                                           
         LA    R6,JOBTOT                                                        
         TM    BILLTYPE,PROG                                                    
         BNO   DUEL02                                                           
         LA    R6,JOBCHG                                                        
*                                                                               
DUEL02   MVC   DUETOT,0(R6)        SAVE DUE LINE TOTALS                         
         LA    R1,48                                                            
         CLI   PROF9,C'G'                                                       
         BNE   *+8                                                              
         LA    R1,49               NEED EXTRA LINE FOR GROSS OPTION             
         EX    R1,*+8                                                           
         B     *+8                                                              
         CLI   LINE,0                                                           
         BNH   *+8                                                              
         MVI   FORCEHED,C'Y'                                                    
         MVI   P+1,C'-'                                                         
         MVC   P+2(82),P+1                                                      
         MVI   MYSPACE,1                                                        
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
*                                                                               
         TM    BILLMODE,UNBILL                                                  
         BZ    DUEL05                                                           
*                                                                               
         MVC   P+1(L'AC@TOREV),AC@TOREV                                         
         MVC   P+20(2),QSELECT                                                  
         MVI   P+22,C'-'                                                        
         MVC   P+23(4),QSELECT+2                                                
         GOTO1 DATCON,DMCB,(0,QEND),(8,P+28)                                    
*                                                                               
         TM    RUNOPT,NEEDGST+NEEDPST   DOING ANY TAXES?                        
         BNZ   DUEL03                   YES                                     
*                                                                               
         MVC   TEMPWK,0(R6)                                                     
         GOTO1 SHR,DMCB,('SUBRTOT',(RC))                                        
         CLI   P+83,C'-'                                                        
         BNE   *+10                                                             
         MVC   P+83(2),=C'CR'                                                   
         MVI   MYSPACE,1                                                        
         CLC   P+73(11),SPACES                                                  
         BNE   *+14                                                             
         MVC   P+80(L'AC@NIL),AC@NIL                                            
         MVI   DUESW,C'N'                                                       
         MVI   MYSPACE,1                                                        
         B     DUEL14                                                           
*                                                                               
DUEL03   MVC   TEMPWK,0(R6)                                                     
         GOTO1 SHR,DMCB,('SUBRFORM',(RC))                                       
         CLI   P+83,C'-'                                                        
         BNE   *+10                                                             
         MVC   P+83(2),=C'CR'                                                   
         MVI   MYSPACE,1                                                        
         CLC   P+73(11),SPACES                                                  
         BNE   *+14                                                             
         MVC   P+80(L'AC@NIL),AC@NIL                                            
         MVI   DUESW,C'N'          NOTHING DUE                                  
         MVI   MYSPACE,1                                                        
*                                                                               
         CP    JOBGST-JOBD(L'JOBGST,R6),=P'0'                                   
         BNE   DUEL04                                                           
         CP    JOBPST-JOBD(L'JOBPST,R6),=P'0'                                   
         BE    DUEL14                                                           
*                                                                               
DUEL04   GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
*                                                                               
         GOTO1 RECAP,DMCB,(RC)     PRINT TAX BY CODE                            
*                                                                               
         MVC   P+1(L'AC@TAMTD),AC@TAMTD                                         
         MVC   TEMPWK,0(R6)                                                     
         GOTO1 SHR,DMCB,('SUBRTOT',(RC))                                        
         CLI   P+83,C'-'                                                        
         BNE   *+10                                                             
         MVC   P+83(2),=C'CR'                                                   
         MVI   MYSPACE,1                                                        
         CLC   P+73(11),SPACES                                                  
         BNE   *+14                                                             
         MVC   P+80(L'AC@NIL),AC@NIL                                            
         MVI   DUESW,C'N'                                                       
         MVI   MYSPACE,1                                                        
         B     DUEL14                                                           
*                                                                               
DUEL05   TM    RUNOPT,NEEDGST                                                   
         BZ    *+14                                                             
         CP    JOBGST-JOBD(L'JOBGST,R6),=P'0'                                   
         BNE   DUEL06                                                           
         TM    RUNOPT,NEEDPST                                                   
         BZ    DUEL08                                                           
         CP    JOBPST-JOBD(L'JOBPST,R6),=P'0'                                   
         BE    DUEL08                                                           
*                                                                               
DUEL06   MVC   P+1(L'AC@ABTAX),AC@ABTAX                                         
         MVC   TEMPWK,0(R6)                                                     
         GOTO1 SHR,DMCB,('SUBRFORM',(RC))                                       
         CLI   P+83,C'-'                                                        
         BNE   *+10                                                             
         MVC   P+83(2),=C'CR'                                                   
         MVI   MYSPACE,1                                                        
         CLC   P+73(11),SPACES                                                  
         BNE   *+14                                                             
         MVC   P+80(L'AC@NIL),AC@NIL                                            
         MVI   DUESW,C'N'          NOTHING DUE                                  
         MVI   MYSPACE,1                                                        
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
*                                                                               
         GOTO1 RECAP,DMCB,(RC)  PRINT TAX BY CODE                               
*                                                                               
DUEL08   MVC   P+1(L'AC@TAMTD),AC@TAMTD                                         
         MVC   TEMPWK,0(R6)                                                     
         GOTO1 SHR,DMCB,('SUBRTOT',(RC))                                        
         CLI   P+83,C'-'                                                        
         BNE   *+10                                                             
         MVC   P+83(2),=C'CR'                                                   
         MVI   MYSPACE,1                                                        
         CLC   P+73(11),SPACES                                                  
         BNE   *+14                                                             
         MVC   P+80(L'AC@NIL),AC@NIL                                            
         MVI   DUESW,C'N'                                                       
         MVI   MYSPACE,1                                                        
*                                                                               
         TM    BILLTYPE,ESTIM                                                   
         BZ    DUEL14                                                           
         MVC   P+18(15),BILLNAME   XXXPC ESTIMATE                               
         LA    R1,P+18                                                          
         LA    RF,10                                                            
*                                                                               
DUEL10   CLC   0(6,R1),=C'PC EST'                                               
         BE    DUEL12                                                           
         LA    R1,1(R1)                                                         
         BCT   RF,DUEL10                                                        
         B     DUEL14                                                           
*                                                                               
DUEL12   MVC   0(L'AC@PCTOE,R1),AC@PCTOE                                        
*                                                                               
DUEL14   GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
         LA    R5,P+51                                                          
         TM    CLIOPT,PAYNET                                                    
         BZ    *+8                                                              
         LA    R5,P+20                                                          
*                                                                               
         TM    GRPOPT,GRPBILL       GROUP REQUEST                               
         BO    *+10                                                             
         MVC   0(L'AC@PAA,R5),AC@PAA                                            
         CLI   PROF9,C'G'                                                       
         BNE   DUEL16                                                           
*                       FOR FOOTE, CONE(FCTO) SKIP MESSAGE FOR NOW              
         CLI   RCCOMPFL,X'5F'   C.D. SHOULD HAVE GONE TO SIMD AT BATCH          
         BE    DUEL16           TIME. THIS WILL SHOULD THEM FROM                
*                               DEDUCTING C.D.                                  
         CP    SAVCD,=P'0'                                                      
         BE    DUEL16                                                           
         MVC   P,SPACES                                                         
         SH    R5,=H'27'                                                        
         MVC   0(L'AC@IFDED,R5),AC@IFDED                                        
         CURED SAVCD,(11,31(R5)),2,MINUS=YES                                    
*                                                                               
DUEL16   TM    BILLOPT,CREDIT                                                   
         BZ    DUEL18                                                           
         MVC   P,SPACES                                                         
         LA    R5,P+71                                                          
         TM    CLIOPT,PAYNET                                                    
         BZ    *+8                                                              
         LA    R5,P+40                                                          
         MVC   0(L'AC@CRAM,R5),AC@CRAM                                          
         CLI   PROF9,C'G'                                                       
         BNE   DUEL18                                                           
*                                                                               
         CLI   RCCOMPFL,X'5F'   C.D. SHOULD HAVE GONE TO SIMD AT BATCH          
         BE    DUEL18           TIME. THIS WILL SHOULD THEM FROM                
*                                                                               
         CP    SAVCD,=P'0'                                                      
         BE    DUEL18                                                           
         MVC   0(L'AC@PLCD,R5),AC@PLCD                                          
         LA    R5,132(R5)          R4 TO PFOURTH                                
         MVC   0(L'AC@PRVDE,R5),AC@PRVDE                                        
*                                                                               
DUEL18   MVI   MYSPACE,1                                                        
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
         MVI   P+1,C'-'                                                         
         MVC   P+2(82),P+1                                                      
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
         MVI   TAXHEAD,C'N'        INDICATE NO HEADINGS YET                     
*                                  GST RECAP BY RATE                            
         USING GSTD,R5                                                          
         LA    R5,BUFWK                                                         
         XC    GSTKEY(GSTLNQ),GSTKEY                                            
         MVI   GSTTYPE,GSTTYPE5                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),1                           
         TM    DMCB+8,X'80'                                                     
         BO    DUEL32                                                           
*                                                                               
         CLI   GSTTYPE,GSTTYPE5                                                 
         BNE   DUEL32              NOT A GST RECORD                             
*                                                                               
         USING JOBD,R6                                                          
DUEL20   CLI   GSTCODE,X'FF'       TOTAL RECORD?                                
         BE    DUEL21              YES, SKIP IT                                 
         LA    R6,GSTACCUM                                                      
         CP    JOBGST,=P'0'        DO WE HAVE ANY GST ?                         
         BNE   DUEL22              YES                                          
         CP    JOBVBAS,=P'0'       NO, DO WE HAVE A BASIS ?                     
         BNE   DUEL22              YES, PRINT HEADING                           
*                                                                               
DUEL21   MVI   BYTE,GSTTYPE5                                                    
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),1                         
         TM    DMCB+8,X'80'                                                     
         BO    DUEL32                                                           
         B     DUEL20                                                           
*                                                                               
DUEL22   MVI   MYSPACE,2                                                        
         MVC   P+48(L'AC@TAXAN),AC@TAXAN                                        
         MVC   PSECOND+48(L'AC$TAXAN),AC$TAXAN                                  
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
*                                                                               
         MVI   MYSPACE,1                                                        
         MVC   P+24(L'AC@TAX),AC@TAX                                            
         MVC   PSECOND+24(L'AC@TAX),=C'----'                                    
         MVC   P+30(L'AC@ACC#),AC@ACC#                                          
         MVC   PSECOND+30(L'AC$ACC#),AC$ACC#                                    
         MVC   P+51(L'AC@BASIS),AC@BASIS                                        
         MVC   PSECOND+51(L'AC$BASIS),AC$BASIS                                  
         MVC   P+63(L'AC@RATE),AC@RATE                                          
         MVC   PSECOND+63(L'AC$RATE),AC$RATE                                    
         MVC   P+77(L'AC@AMT),AC@AMT                                            
         MVC   PSECOND+77(L'AC$AMT),AC$AMT                                      
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
         MVC   P+24(L'AC@VAT1),AC@VAT1                                          
         MVI   TAXHEAD,C'Y'        WE PRINTED HEADINGS                          
*                                                                               
         CLI   PROF18,C'Y'         PRINT REGISTRATION NUMBER ?                  
         BNE   DUEL24              NO                                           
         CLC   SVGSTREG,SPACES                                                  
         BNH   DUEL24                                                           
         MVC   P+31(L'SVGSTREG),SVGSTREG                                        
         GOTO1 RIGHT,DMCB,P+31,L'SVGSTREG                                       
*                                                                               
DUEL24   CLI   GSTCODE,X'FF'       TOTAL RECORD?                                
         BE    DUEL28              YES, SKIP IT                                 
         LA    R6,GSTACCUM                                                      
         CP    JOBGST,=P'0'        DO WE HAVE ANY GST ?                         
         BNE   DUEL25              YES                                          
         CP    JOBVBAS,=P'0'       NO, DO WE HAVE A BASIS ?                     
         BE    DUEL28              NO, GET NEXT ONE                             
*                                                                               
DUEL25   GOTO1 SHR,DMCB,('SUBRSHR',(RC))                                        
         CURED JOBVBAS,(11,P+47),2,MINUS=YES                                    
         TM    GSTINDS,VBIIDC3     ARE THERE 3 DECIMALS PLACES?                 
         BZ    DUEL26                                                           
         CURED GSTRATE,(8,P+61),3,MINUS=YES,TRAIL=%                             
         B     DUEL27                                                           
*                                                                               
DUEL26   CURED GSTRATE,(7,P+62),2,MINUS=YES,TRAIL=%                             
*                                                                               
DUEL27   CURED JOBGST,(11,P+74),2,MINUS=YES                                     
         MVI   MYSPACE,1                                                        
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
*                                                                               
DUEL28   MVI   BYTE,GSTTYPE5                                                    
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),1                         
         TM    DMCB+8,X'80'                                                     
         BZ    DUEL24                                                           
*                                  PST RECAP BY RATE                            
         USING PSTD,R5                                                          
DUEL32   LA    R5,BUFWK                                                         
         XC    PSTKY(PSTLNQ),PSTKY                                              
         MVI   PSTTYPE,PSTTYPE7                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),1                           
         TM    DMCB+8,X'80'                                                     
         BO    DUEL48                                                           
*                                                                               
         CLI   PSTTYPE,PSTTYPE7                                                 
         BNE   DUEL48              NOT A PST RECORD                             
*                                                                               
         CLI   TAXHEAD,C'Y'        DID WE PRINT HEADINGS YET?                   
         BE    DUEL33              YES, SKIP THIS                               
         MVI   MYSPACE,2                                                        
         MVC   P+48(L'AC@TAXAN),AC@TAXAN                                        
         MVC   PSECOND+48(L'AC$TAXAN),AC$TAXAN                                  
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
*                                                                               
         MVI   MYSPACE,1                                                        
         MVC   P+24(L'AC@TAX),AC@TAX                                            
         MVC   PSECOND+24(L'AC@TAX),=C'----'                                    
         MVC   P+30(L'AC@ACC#),AC@ACC#                                          
         MVC   PSECOND+30(L'AC$ACC#),AC$ACC#                                    
         MVC   P+51(L'AC@BASIS),AC@BASIS                                        
         MVC   PSECOND+51(L'AC$BASIS),AC$BASIS                                  
         MVC   P+63(L'AC@RATE),AC@RATE                                          
         MVC   PSECOND+63(L'AC$RATE),AC$RATE                                    
         MVC   P+77(L'AC@AMT),AC@AMT                                            
         MVC   PSECOND+77(L'AC$AMT),AC$AMT                                      
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
         MVC   P+24(L'AC@VAT1),AC@VAT1                                          
*                                                                               
DUEL33   CLI   PROF18,C'Y'         PRINT REGISTRATION NUMBER ?                  
         BNE   DUEL34              NO                                           
         CLC   PSTREG,SPACES                                                    
         BNH   DUEL34                                                           
         MVC   P+31(L'PSTREG),PSTREG                                            
         GOTO1 RIGHT,DMCB,P+31,L'PSTREG                                         
         MVC   LASTNAME,SPACES                                                  
*                                                                               
         USING JOBD,R6                                                          
DUEL34   CLI   PSTCODE,X'FF'       TOTAL RECORD?                                
         BE    DUEL36              YES, SKIP IT                                 
         LA    R6,PSTACCUM                                                      
         CP    JOBPST,=P'0'        DO WE HAVE ANY PST ?                         
         BNE   DUEL38              YES                                          
         CP    JOBPBAS,=P'0'       NO, DO WE HAVE A BASIS ?                     
         BNE   DUEL38              YES, PRINT HEADING                           
*                                                                               
DUEL36   MVI   BYTE,PSTTYPE7                                                    
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),1                         
         TM    DMCB+8,X'80'                                                     
         BO    DUEL46                                                           
         B     DUEL33                                                           
*                                                                               
DUEL38   MVI   MYSPACE,1                                                        
         CLC   LASTNAME,PSTNAME    SAME NAME AS BEFORE?                         
         BE    DUEL42              YES                                          
         MVC   P+24(L'PSTNAME),PSTNAME                                          
         MVC   LASTNAME,PSTNAME                                                 
*                                                                               
DUEL42   GOTO1 SHR,DMCB,('SUBRSHR',(RC))                                        
         CURED JOBPBAS,(11,P+47),2,MINUS=YES                                    
*                                                                               
         TM    PSTINDS,PBIIDC3                                                  
         BZ    DUEL44                                                           
         CURED PSTRATE,(8,P+61),3,MINUS=YES,TRAIL=%                             
         B     DUEL45                                                           
*                                                                               
DUEL44   CURED PSTRATE,(7,P+62),2,MINUS=YES,TRAIL=%                             
*                                                                               
DUEL45   CURED JOBPST,(11,P+74),2,MINUS=YES                                     
         MVI   MYSPACE,1                                                        
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
         B     DUEL36                                                           
*                                                                               
DUEL46   MVI   P+24,C'-'           UNDERLINE PST ANALYSIS                       
         MVC   P+25(60),P+24                                                    
         MVI   MYSPACE,2                                                        
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
*                                                                               
DUEL48   CLI   RTLEDG,0                 IF RETAIL SCHEME                        
         BNE   DUEL50                   HOLD UP POSTINGS                        
         GOTO1 POST,DMCB,('POSTBILL',(RC))                                      
*                                                                               
DUEL50   BAS   RE,ADDTOSUM         ADD TO CLIENT/PROD ETC. SUMMARIES            
         TM    GRPOPT,GRPBILL                                                   
         BNO   DUEL52              NOT A GROUP BILL                             
         MVI   BYTE,TRATYPE2       ADD PRODUCTION CHARGES TO GROUP              
         GOTO1 BUFFALO,DMCB,=C'ADD',(BYTE,ABUFF),1,(X'80',2)                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),(X'80',1)                    
         MVI   BYTE,TRATYPE3       ADD MEDIA CHARGES TO GROUP                   
         GOTO1 BUFFALO,DMCB,=C'ADD',(BYTE,ABUFF),1,(X'80',2)                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),(X'80',1)                    
         MVI   BYTE,MRCTYPE4       ADD RECAP TO GROUP                           
         GOTO1 BUFFALO,DMCB,=C'ADD',(BYTE,ABUFF),1,(X'80',2)                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),(X'80',1)                    
         MVI   BYTE,GSTTYPE5       ADD GST TO GROUP                             
         GOTO1 BUFFALO,DMCB,=C'ADD',(BYTE,ABUFF),1,(X'80',2)                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),(X'80',1)                    
         MVI   BYTE,GSTTYPE6       ADD GST (MEDIA) TO GROUP                     
         GOTO1 BUFFALO,DMCB,=C'ADD',(BYTE,ABUFF),1,(X'80',2)                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),(X'80',1)                    
         MVI   BYTE,PSTTYPE7       ADD PST TO GROUP                             
         GOTO1 BUFFALO,DMCB,=C'ADD',(BYTE,ABUFF),1,(X'80',2)                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),(X'80',1)                    
         MVI   BYTE,PSTTYPE8       ADD PST (MEDIA) TO GROUP                     
         GOTO1 BUFFALO,DMCB,=C'ADD',(BYTE,ABUFF),1,(X'80',2)                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),(X'80',1)                    
*                                                                               
DUEL52   B     PRNTX                                                            
         DROP  R6                                                               
         EJECT                                                                  
*              ADD A BILL TO PRODUCT AND CLIENT SUMMARIES                       
*                                                                               
         USING SUMD,R5                                                          
         USING JOBD,R6                                                          
ADDTOSUM NTR1                                                                   
         LA    R6,JOBTOT                                                        
         TM    BILLTYPE,PROG                                                    
         BZ    *+8                                                              
         LA    R6,JOBCHG                                                        
         ZAP   SAVECOMM,JOBCOMM   SAVE THE COMMISSION                           
         TM    CLIOPT,NOCOMM+PAYNET                                             
         BZ    ADDT02                                                           
         SP    JOBGRS,JOBCOMM      PAY=NET AND SUPPRESS                         
         SP    JOBPGRS,JOBCOMM                                                  
         SP    JOBVGRS,JOBCOMM                                                  
         TM    CLIOPT,NOCOMM                                                    
         BNO   ADDT02                                                           
         ZAP   JOBCOMM,=P'0'                                                    
*                                                                               
ADDT02   LA    R5,BUFWK                                                         
         XC    SUMKEY(SUMLNQ),SUMKEY                                            
         MVC   SUMBILNO,SPACES                                                  
         MVC   SUMBILNO(7),SHTBILNO      BILL NUMBER MM-NNNN                    
*                                                                               
         L     R2,ADACC                                                         
         MVI   SUMTYPE,SUMTYPE1                                                 
         MVC   SUMMED,JOBLET            MEDIA                                   
         MVC   SUMCLI(12),3(R2)         CLI/PRD/JOB                             
         MVC   SUMOTH,SAVOTH                                                    
         OC    BILLNO,BILLNO            DRAFT BILLING                           
         BNZ   *+10                                                             
         ZAP   BILLNO,=P'1'                                                     
         ZAP   DUB,BILLNO                                                       
         CVB   R1,DUB                                                           
         STCM  R1,7,SUMBILB             BINARY BILL NUMBER                      
         MVC   SUMACCUM(JOBLNQ),JOBBK   ACCUMULATORS                            
*                                                                               
         GOTO1 BUFFALO,DMCB,=C'PUT',ABUFF,(R5)                                  
         XC    SUMCLI,SUMCLI                                                    
         XC    SUMPRD,SUMPRD                                                    
         XC    SUMJOB,SUMJOB                                                    
         XC    SUMOTH,SUMOTH                                                    
         XC    SUMBILB,SUMBILB                                                  
         MVI   SUMCLI,X'FF'                                                     
         BASR  RE,RF               MEDIA TOTAL                                  
         MVI   SUMCLI,0                                                         
         MVI   SUMMED,X'FF'                                                     
         BASR  RE,RF               GRAND TOTAL(LEVEL 1 = PRODUCT)               
*                                             (LEVEL 2 = CLIENT)                
*                                                                               
*              BUILD RECORD FOR PROD. BILLING INVOICE REGISTER                  
*                                                                               
         USING PBRD,R5                                                          
         LA    R5,PBRWK                                                         
         LA    R1,PBRLNQ                                                        
         SLL   R1,16                                                            
         ST    R1,PBRLEN                                                        
         MVI   PBRTYP,PBREQU       RECORD TYPE                                  
         SR    R1,R1                                                            
         ICM   R1,3,RUNCNT           COUNT NUMBER OF INVOICES                   
         AH    R1,=H'1'                                                         
         STCM  R1,3,RUNCNT         KEEP REPORT IN ORDER CREATED                 
         MVC   PBRCNT,RUNCNT                                                    
         L     R2,ADACC                                                         
         MVC   PBRCLI(3),3(R2)          CLI                                     
         MVC   PBRMED,JOBLET            MEDIA                                   
         MVC   PBRPRD(9),6(R2)          PRD/JOB                                 
         MVC   PBROTH,SAVOTH            OTHER                                   
         GOTO1 DATCON,DMCB,(4,BILLDTE),(1,PBRDTE)                               
         MVC   PBRBILL,SPACES                                                   
         MVC   PBRBILL(7),SHTBILNO          BILL NUMBER                         
         MVC   PBRACCUM(JOBLNQ),JOBBK   ACCUMULATORS                            
         GOTO1 ADSORTER,DMCB,=C'PUT',(R5)                                       
         MVI   ALSORT,1            SO ADDRESS IS NOT ZERO                       
         EJECT                                                                  
*                                                                               
*              BUILD RECORD FOR REGISTER OF TARGET ACCOUNTS                     
*                                                                               
         USING RTAD,R5                                                          
         L     R5,ARTAWK                                                        
         LA    R1,RTALNQ                                                        
         SLL   R1,16                                                            
         ST    R1,RTALEN                                                        
         MVI   RTATYP,RTAEQU           RECORD TYPE                              
         L     R2,ADACC                                                         
         MVC   RTACLI(12),3(R2)         CLI/PRD/JOB                             
         MVC   RTAOTH,SAVOTH            OTHER                                   
         MVC   RTAACCUM(JOBLNQ),JOBBK   ACCUMULATORS                            
         GOTO1 DATCON,DMCB,(4,RCDATE),(1,RTADTE)                                
         MVC   RTABILL,SPACES                                                   
         MVC   RTABILL(7),SHTBILNO       BILL NUMBER                            
         MVC   RTAREC,RECEIVBL+3        RECEIVABLE ACCOUNT                      
         MVC   RTACOST,COSTING+3        COSTING ACCOUNT                         
         MVC   RTASALES,PRODNUM+3       SALES ACCOUNT                           
         CLI   PROF6,C'Y'                                                       
         BNE   ADDT04              DON'T WANT TARGET REGISTER                   
         GOTO1 ADSORTER,DMCB,=C'PUT',(R5)                                       
         MVI   ALSORT,1            SO ADDRESS IS NOT ZERO                       
*                                                                               
*              BUILD RECORD FOR INCOME REGISTER                                 
*                                                                               
         USING INCD,R5                                                          
ADDT04   LA    R5,INCBUF                                                        
         LA    R1,INCRLNQ                                                       
         SLL   R1,16                                                            
         ST    R1,INCRLEN                                                       
         MVI   INCRTYP,INCREQU         RECORD TYPE                              
         L     R2,ADACC                                                         
         MVC   INCRCLI(12),3(R2)       CLI/PRD/JOB                              
         MVC   INCRBILL,SPACES                                                  
         MVC   INCRBILL(7),SHTBILNO    BILL NUMBER                              
*                                                                               
         L     R2,ACURRB7          GET TABLE OF ELEMENTS                        
*                                                                               
         USING INCELD,R2                                                        
ADDT05   CLI   0(R2),0             NO ENTRIES OR END ?                          
         BE    ADDT06              YES                                          
         MVC   INCRWRK,INCWRKC     SAVE WORKCODE                                
         ZAP   INCRAMT,INCAMNT       AMOUNT                                     
         MVC   INCRCR,INCCACC        CREDIT ACCOUNT                             
         MVC   INCRDR,INCDACC        DEBIT ACCOUNT                              
         ZAP   INCRIAM,INCINAM       INCOME AMOUNT                              
         GOTO1 ADSORTER,DMCB,=C'PUT',(R5)                                       
         MVI   ALSORT,1            SO ADDRESS IS NOT ZERO                       
         LA    R2,INCLN2Q(R2)                                                   
         B     ADDT05                                                           
*                                                                               
ADDT06   L     R2,APREVB7          GET REST OF POSTINGS                         
*                                                                               
ADDT07   CLI   0(R2),0             NO ENTRIES OR END ?                          
         BE    ADDT09              YES                                          
         CLI   0(R2),X'FF'         NO ENTRIES ?                                 
         BE    ADDT09              YES                                          
         CLI   INCWRKC,X'EE'       UNUSED ?                                     
         BE    ADDT08              YES, SKIP IT                                 
         MVC   INCRWRK,INCWRKC     SAVE WORKCODE                                
         ZAP   INCRAMT,INCAMNT       AMOUNT                                     
         MVC   INCRCR,INCCACC        CREDIT ACCOUNT                             
         MVC   INCRDR,INCDACC        DEBIT ACCOUNT                              
         ZAP   INCRIAM,INCINAM       INCOME AMOUNT                              
         GOTO1 ADSORTER,DMCB,=C'PUT',(R5)                                       
         MVI   ALSORT,1            SO ADDRESS IS NOT ZERO                       
*                                                                               
ADDT08   LA    R2,INCLN2Q(R2)                                                   
         B     ADDT07                                                           
*                                                                               
*              BUILD RECORD FOR MEDIA SUMMARY PAGE                              
*                                                                               
         USING MESD,R5                                                          
ADDT09   LA    R5,MESWK                                                         
         XC    MESWK(MESKLEN),MESWK                                             
         MVC   MESCDE,JOBLET            MEDIA                                   
         MVC   MESACCUM(JOBLNQ),JOBBK   ACCUMULATORS                            
         GOTO1 SHR,DMCB,('SUBRBIN',(RC)),(R5),AMEDTAB                           
         MVI   MESCDE,X'FF'                                                     
         GOTO1 SHR,DMCB,('SUBRBIN',(RC)),(R5),AMEDTAB                           
*                                                                               
         TM    CLIOPT,NOCOMM+PAYNET                                             
         BZ    DUELNEX                                                          
         AP    JOBGRS,SAVECOMM     IF PAY = NET                                 
         AP    JOBPGRS,SAVECOMM                                                 
         AP    JOBVGRS,SAVECOMM                                                 
         TM    CLIOPT,NOCOMM                                                    
         BNO   DUELNEX                                                          
         ZAP   JOBCOMM,SAVECOMM                                                 
*                                                                               
DUELNEX  B     PRNTX                                                            
         DROP  R6                                                               
         EJECT                                                                  
*              TOTAL CHARGES LINE                                               
*                                                                               
         USING JOBD,R6                                                          
TOTCHR   TM    JOBOPT,JOBMEDT       MEDIA CHARGES ON JOB                        
         BO    TOTC04                                                           
         BAS   RE,CDPRT            PRINT CD LINE                                
         TM    BILLTYPE,TOTAL                                                   
         BO    TOTC02              FOR TOTAL BILL                               
         TM    BILLTYPE,ESTIM                                                   
         BNO   PRNTX                                                            
         TM    BILLMODE,UNBILL     OR UNBILLING PERCENT EST.                    
         BNO   PRNTX                                                            
*                                                                               
TOTC02   MVC   P+1(L'AC@TCRGS),AC@TCRGS                                         
         LA    R6,JOBCHG                                                        
         MVC   TEMPWK,0(R6)                                                     
         GOTO1 SHR,DMCB,('SUBRFORM',(RC))                                       
         MVC   JOBDTL(JOBLNQ),ZEROS                                             
         MVC   JOBWKC(JOBLNQ),ZEROS                                             
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
         B     PRNTX                                                            
*                                                                               
TOTC04   MVC   P+1(L'AC@TPRCG),AC@TPRCG                                         
         LA    R6,JOBCHG                                                        
         CP    JOBNET,=P'0'                                                     
         BE    TOTC06                                                           
         MVC   TEMPWK,0(R6)                                                     
         GOTO1 SHR,DMCB,('SUBRFORM',(RC))                                       
         TM    BILLTYPE,ONELNE                                                  
         BNO   *+14                                                             
         MVC   P,SPACES                                                         
         B     TOTC06                                                           
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
*                                                                               
TOTC06   MVC   P,SPACES                                                         
         BAS   RE,TOTTRN           PRINT MEDIA CHARGES                          
         BAS   RE,CDPRT            NOW THE TOTAL CASH DISCOUNT                  
         B     TOTC02                                                           
         DROP  R6                                                               
         EJECT                                                                  
*              PRINT CHARGES TRANSFERRED FROM MEDIA                             
*                                                                               
         USING TRAD,R5                                                          
TOTTRN   NTR1                                                                   
         LA    R5,BUFWK                                                         
         XC    TRAKEY(TRALNQ),TRAKEY                                            
         MVI   TRATYPE,TRATYPE3                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),1                           
         TM    DMCB+8,X'80'                                                     
         BO    PRNTX                                                            
*                                                                               
         CLI   TRATYPE,TRATYPE3                                                 
         BNE   PRNTX               NOT A MEDIA TRANSACTION                      
*                                                                               
TOTT02   CLI   TRAWKC,0                                                         
         BE    TOTT04              SKIP JOB HEADER                              
         CLI   TRAWKC,X'FF'                                                     
         BE    TOTT12              JOB TOTAL FOR MEDIA CHARGES                  
         CLI   TRAREF,0                                                         
         BE    TOTT06              FIRST FOR WORKCODE                           
         CLI   TRAREF,X'FF'                                                     
         BL    TOTT08              REFERENCE DETAIL LINE                        
         BE    TOTT10              WORK CODE TOTAL LINE                         
*                                                                               
TOTT04   MVI   BYTE,TRATYPE3                                                    
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),1                         
         TM    DMCB+8,X'80'                                                     
         BO    PRNTX                                                            
         B     TOTT02                                                           
*                                                                               
TOTT06   MVC   P+1(2),TRAWKC                                                    
         MVC   P+4(20),TRANAME                                                  
         TM    BILLTYPE,ONELNE                                                  
         BNO   *+14                                                             
         MVC   P,SPACES                                                         
         B     TOTT04                                                           
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
         B     TOTT04                                                           
*                                                                               
TOTT08   LA    R6,TRAACCUM                                                      
         MVC   TEMPWK,0(R6)                                                     
         GOTO1 SHR,DMCB,('SUBRFORM',(RC))                                       
         CLC   P,SPACES                                                         
         BE    TOTT04              NOTHING GOOD TO PRINT                        
         MVC   P+2(L'AC@DOCC),AC@DOCC    DETAIL DOCUMENT LINE                   
         MVI   P+2+L'AC@DOCC,C'='                                               
         MVC   P+2+L'AC@DOCC+1(L'TRAREF),TRAREF                                 
         TM    BILLTYPE,ONELNE                                                  
         BNO   *+14                                                             
         MVC   P,SPACES                                                         
         B     TOTT04                                                           
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
         B     TOTT04                                                           
*                                                                               
TOTT10   MVC   P+1(L'AC@TFOR),AC@TFOR                                           
         MVC   P+1+L'AC@TFOR+1(L'TRAWKC),TRAWKC                                 
         MVC   P+1+L'AC@TFOR+1+L'TRAWKC+1(20),TRANAME                           
         LA    R6,TRAACCUM                                                      
         MVC   TEMPWK,0(R6)                                                     
         GOTO1 SHR,DMCB,('SUBRFORM',(RC))                                       
         TM    BILLTYPE,ONELNE                                                  
         BNO   *+14                                                             
         MVC   P,SPACES                                                         
         B     TOTT04                                                           
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
         B     TOTT04                                                           
*                                                                               
*                                  TOTAL MEDIA CHARGES                          
TOTT12   CLI   TRABIL,X'FF'        IS THIS THE FINAL TOTAL ?                    
         BE    TOTT14              YES                                          
         CLI   TRABIL,C'Y'         NO, IS THIS BILLABLE TOTAL ?                 
         BNE   TOTT04              NO, KEEP LOOKING                             
         MVC   JOBMED(JOBLNQ),TRAACCUM  SAVE TOTAL BILLABLE MEDIA               
         B     TOTT04                                                           
*                                                                               
TOTT14   MVC   P+1(L'AC@TMEDC),AC@TMEDC                                         
         LA    R3,P+73                                                          
         LA    R6,TRAACCUM                                                      
         MVC   TEMPWK,0(R6)                                                     
         GOTO1 SHR,DMCB,('SUBRFORM',(RC))                                       
         TM    BILLTYPE,ONELNE                                                  
         BNO   *+14                                                             
         MVC   P,SPACES                                                         
         B     TOTT16                                                           
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
*                                                                               
TOTT16   DS    0H                                                               
         MVC   JOBDTL(JOBLNQ),TRAACCUM   SAVE TOTAL ALL MEDIA                   
         GOTO1 SHR,DMCB,('SUBRSUML',(RC))     ADD MEDIA COSTS                   
         B     PRNTX                                                            
         EJECT                                                                  
*              DEAL WITH CASH DISCOUNT FOR JOB TOTALS                           
*                                                                               
CDPRT    NTR1                                                                   
         CP    SAVCD,=P'0'                                                      
         BE    PRNTX                                                            
         CLI   PROF9,C'G'          BILL GROSS DEDUCT CD(MEMO)                   
         BE    PRNTX                                                            
         MVC   P+1(L'AC@CSHDS),AC@CSHDS                                         
*                                                                               
         ZAP   DUB,SAVCD                                                        
         MP    DUB,=P'-1'                                                       
         CURED (P8,DUB),(11,P+73),2,MINUS=YES                                   
*                                                                               
         CLI   QOPT5,C'Y'          OPTION TO SUPPRESS NET/COMMISSION            
         BE    CDPRT2                                                           
         CLI   PROF4,C'Y'                                                       
         BE    CDPRT2                                                           
         CURED (P8,DUB),(11,P+41),2,MINUS=YES                                   
*                                                                               
CDPRT2   GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
*                                                                               
         USING JOBD,R6                                                          
         LA    R6,JOBCHG           SHOW TOTAL DUE                               
         SP    JOBGRS,JOBCD                                                     
         SP    JOBNET,JOBCD                                                     
         LA    R6,JOBTOT               TOTAL JOB                                
         SP    JOBGRS,JOBCD        MINUS THE CD                                 
         SP    JOBNET,JOBCD                                                     
         LA    R6,JOBMED           AND MEDIA TOTAL                              
         SP    JOBGRS,JOBCD        MINUS THE CD                                 
         SP    JOBNET,JOBCD                                                     
         B     PRNTX                                                            
         DROP  R6                                                               
         EJECT                                                                  
*              GROUP SUMMARY BILL                                               
*                                                                               
GRPBIL   DS    0D                                                               
         MVI   GRPMODE,1                                                        
         LA    R5,BUFWK                                                         
         USING TRAD,R5                                                          
         XC    TRAKEY(TRALNQ),TRAKEY                                            
         MVI   TRATYPE,TRATYPE2                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),2                           
         TM    DMCB+8,X'80'                                                     
         BO    GRPB16                                                           
*                                                                               
         CLI   TRATYPE,TRATYPE2                                                 
         BNE   GRPB16              NO GROUP RECORDS                             
*                                                                               
         MVI   RCSUBPRG,10                                                      
         MVC   PAGE,=H'1'                                                       
         MVI   FORCEHED,C'Y'                                                    
         MVI   MEDIA,0                                                          
*                                                                               
GRPB02   CLI   TRAMED,X'FF'                                                     
         BE    GRPB14              END OF GROUP BILL                            
         CLI   TRAPRD,X'FF'                                                     
         BE    GRPB12              END OF MEDIA                                 
         CLI   TRAWKC,X'FF'                                                     
         BE    GRPB10              END OF JOB                                   
         CLI   TRAWKC,0                                                         
         BNE   GRPB08              WORKCODE LINE                                
*                                                                               
*                                  FIRST FOR JOB                                
         CLC   TRAMED,MEDIA                                                     
         BE    GRPB04              ALREADY HAVE MEDIA                           
         MVC   MEDIA,TRAMED                                                     
         GOTO1 SHR,DMCB,('SUBRMED',(RC))                                        
         L     R2,AMEL                                                          
         USING PMDELD,R2                                                        
         MVC   P+1(12),PMDDESC    MEDIA NAME                                    
         MVC   GRPMEDIA,PMDSPACE                                                
*                                                                               
GRPB04   MVC   P+22(6),TRAJOB      JOB                                          
         MVC   P+40(36),TRANAME    JOB NAME                                     
         CLC   TRABLPR,SPACES                                                   
         BE    *+10                                                             
         MVC   PSECOND+40(50),TRABLPR     PRINT ON BILLS                        
         BAS   RE,GRPRNT                                                        
*                                                                               
GRPB06   MVI   BYTE,TRATYPE2                                                    
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),2                         
         TM    DMCB+8,X'80'                                                     
         BO    GRPB16                                                           
         B     GRPB02                                                           
*                                                                               
*                                  WORKCODE LINE                                
GRPB08   MVC   P+23(2),TRAWKC     WORKCODE                                      
         MVC   P+26(20),TRANAME    AND NAME                                     
         LA    R3,P+73                                                          
         LA    R6,TRAACCUM                                                      
         USING JOBD,R6                                                          
         ZAP   DUB,JOBGRS                                                       
         CURED (P8,DUB),(11,0(R3)),2,MINUS=YES                                  
         BAS   RE,GRPRNT          PRINT THE LINE                                
         B     GRPB06                                                           
*                                                                               
*                                  JOB TOTAL LINE                               
         USING JOBD,R6                                                          
GRPB10   LA    R6,TRAACCUM                                                      
         ZAP   DUB,JOBCD                                                        
         BZ    GRPB11                                                           
         MVC   P+26(L'AC@CSHDS),AC@CSHDS                                        
         MP    DUB,=P'-1'          MAKE AMOUNT NEGATIVE                         
         CURED (P8,DUB),(11,P+73),2,MINUS=YES                                   
         BAS   RE,GRPRNT                                                        
*                                                                               
GRPB11   ZAP   DUB,JOBGRS                                                       
         CURED (P8,DUB),(11,WORK+20),2,MINUS=YES                                
         GOTO1 UNDERLIN,DMCB,(11,WORK+20),P+73   UNDERLINE BEFORE TOTAL         
*                                                                               
         TM    RUNOPT,NEEDGST      ARE WE DOING GST LOGIC?                      
         BO    GRPB11C             YES                                          
         TM    RUNOPT,NEEDPST      NO, ARE WE DOING PST LOGIC?                  
         BZ    GRPB11A             NO                                           
*                                                                               
GRPB11C  MVC   PSECOND+40(L'AC@ABTAX),AC@ABTAX                                  
         LA    R3,PSECOND+73                                                    
         ZAP   DUB,JOBGRS                                                       
         SP    DUB,JOBCD                                                        
         CURED (P8,DUB),(11,0(R3)),2,MINUS=YES                                  
         MVI   SPACING,1                                                        
         BAS   RE,GRPRNT          PRINT THE LINE                                
*                                                                               
         CP    JOBGST,=P'0'                                                     
         BE    GRPB11D                                                          
         MVC   P+40(L'AC@GSTAM),AC@GSTAM                                        
         CURED JOBGST,(11,P+73),2,MINUS=YES                                     
         MVI   SPACING,1                                                        
         BAS   RE,GRPRNT          PRINT THE LINE                                
*                                                                               
GRPB11D  TM    RUNOPT,NEEDPST                                                   
         BZ    GRPB11B                                                          
         CP    JOBPST,=P'0'                                                     
         BE    GRPB11B                                                          
         MVC   P+40(L'SVPSTNME),SVPSTNME                                        
         MVC   P+40+1+L'SVPSTNME(L'AC@AMT),AC@AMT                               
         CURED JOBPST,(11,P+73),2,MINUS=YES                                     
         MVI   SPACING,1                                                        
         BAS   RE,GRPRNT          PRINT THE LINE                                
*                                                                               
GRPB11B  CURED JOBPGRS,(11,WORK+20),2,MINUS=YES                                 
         GOTO1 UNDERLIN,DMCB,(11,WORK+20),P+73   UNDERLINE BEFORE TOTAL         
*                                                                               
GRPB11A  MVC   PSECOND+40(L'AC@TAMTD),AC@TAMTD                                  
         LA    R3,PSECOND+73                                                    
         ZAP   DUB,JOBPGRS                                                      
         CURED (P8,DUB),(11,0(R3)),2,MINUS=YES                                  
         MVI   SPACING,3                                                        
         BAS   RE,GRPRNT          PRINT THE LINE                                
         B     GRPB06                                                           
*                                                                               
*                                  MEDIA LINE                                   
GRPB12   MVC   P+1(L'AC@TOTAL),AC@TOTAL                                         
         MVC   MEDIA,TRAMED                                                     
         GOTO1 SHR,DMCB,('SUBRMED',(RC))                                        
         L     R2,AMEL                                                          
         USING PMDELD,R2                                                        
         MVC   P+1+L'AC@TOTAL+1(12),GRPMEDIA+3  MEDIA NAME                      
         LA    R3,P+73                                                          
         LA    R6,TRAACCUM                                                      
         USING JOBD,R6                                                          
         ZAP   DUB,JOBPGRS                                                      
         CURED (P8,DUB),(11,0(R3)),2,MINUS=YES                                  
         MVI   SPACING,2                                                        
         BAS   RE,GRPRNT          PRINT THE LINE                                
         B     GRPB06                                                           
*                                                                               
*                                  TOTAL LINE                                   
GRPB14   MVC   P+1(L'AC@TPRD),AC@TPRD                                           
         LA    R3,P+73                                                          
         LA    R6,TRAACCUM                                                      
         USING JOBD,R6                                                          
         ZAP   DUB,JOBPGRS                                                      
         CURED (P8,DUB),(11,0(R3)),2,MINUS=YES                                  
         MVI   SPACING,2                                                        
         BAS   RE,GRPRNT          PRINT THE LINE                                
         GOTO1 POST,DMCB,('POSTGRP',(RC)) ONE RECEIVABLE POSTING                
         L     R2,ADHEIRB                                                       
         BAS   RE,CMM                                                           
         L     R2,ADHEIRA                                                       
         BAS   RE,CMM                                                           
         BAS   RE,CMMWPP                                                        
         BAS   RE,GRPSUM           NOW DO THE RECAP                             
*                                                                               
GRPB16   MVI   BYTE,TRATYPE2                                                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),1,(X'80',2)                  
         NI    GRPOPT,ALL-GRPNUM     TURN-OFF NUMBER ASSIGNED                   
         B     GRPBILX                                                          
         DROP  R6                                                               
         EJECT                                                                  
*              RECAP BY MEDIA                                                   
*                                                                               
         USING MRCD,R5                                                          
GRPSUM   NTR1                                                                   
         MVI   GRPMODE,2                                                        
         LA    R5,BUFWK                                                         
         XC    MRCKEY(MRCLNQ),MRCKEY                                            
         MVI   MRCTYPE,MRCTYPE4                                                 
         GOTO1 BUFFALO,DMCB,=C'HIGH',(0,ABUFF),(R5),2                           
         TM    DMCB+8,X'80'                                                     
         BO    GRPBILX                                                          
*                                                                               
         CLI   MRCTYPE,MRCTYPE4                                                 
         BNE   GRPBILX             NO SUMMARY RECORDS                           
*                                                                               
         MVI   RCSUBPRG,10                                                      
         MVC   PAGE,=H'1'                                                       
         MVI   FORCEHED,C'Y'                                                    
*                                                                               
GRPS02   CLI   MRCMED,X'FF'                                                     
         BE    GRPS04              END OF RECAP BILL                            
*                                                                               
*                                  JOB TOTAL LINE                               
         MVC   P+22(15),MRCMED     MEDIA OR WORKCODE NAME                       
         LA    R3,P+73                                                          
         LA    R6,MRCACCUM                                                      
         USING JOBD,R6                                                          
         ZAP   DUB,JOBPGRS                                                      
         CURED (P8,DUB),(11,0(R3)),2,MINUS=YES                                  
         BAS   RE,GRPRNT          PRINT THE MEDIA LINE                          
*                                                                               
         MVI   BYTE,MRCTYPE4                                                    
         GOTO1 BUFFALO,DMCB,=C'SEQ',(BYTE,ABUFF),(R5),2                         
         TM    DMCB+8,X'80'                                                     
         BNO   GRPS02                                                           
*                                                                               
GRPS04   BAS   RE,GRPRNT                                                        
         MVC   P+22(L'AC@TAMTD),AC@TAMTD                                        
         LA    R3,P+73                                                          
         LA    R6,MRCACCUM                                                      
         ZAP   DUB,JOBPGRS          PRINT AMOUNT DUE                            
         CURED (P8,DUB),(11,0(R3)),2,MINUS=YES                                  
         GOTO1 UNDERLIN,DMCB,(11,0(R3)),(0,132(R3))                             
         MVC   PTHIRD,PSECOND      DOUBLE UNDER LINE                            
         BAS   RE,GRPRNT         PRINT THE TOTAL LINE                           
         MVI   BYTE,MRCTYPE4                                                    
         GOTO1 BUFFALO,DMCB,=C'CLEAR',(BYTE,ABUFF),1,(X'80',2)                  
         B     GRPBILX                                                          
         DROP  R6                                                               
         EJECT                                                                  
*              PRINT ROUTINE FOR GROUP BILL                                     
*                                                                               
GRPRNT   NTR1                                                                   
         MVC   HEAD1+11(8),BILLDTE                                              
         MVC   HEAD1+30(L'AC@RECAP),AC@RECAP                                    
         CLI   GRPMODE,1                                                        
         BNE   GRPR01                                                           
         MVC   HEAD1+30(L'AC@RECAP),SPACES                                      
         MVC   HEAD1+30(L'AC@PRD),AC@PRD                                        
         MVC   HEAD1+30+L'AC@PRD+1(L'AC@BIL),AC@BIL                             
*                                                                               
GRPR01   GOTO1 UNDERLIN,DMCB,(30,HEAD1+30),HEAD2+30                             
         MVC   HEAD1+55(L'AC@BILC),AC@BILC                                      
         MVI   HEAD1+67,C'*'                                                    
         MVC   HEAD1+68(L'AC@DRAFT),AC@DRAFT                                    
         MVI   HEAD1+68+L'AC@DRAFT,C'*'                                         
         TM    BILLMODE,DRAFT                                                   
         BO    GRPR02                                                           
         MVC   HEAD1+67(2),BILLREF                                              
         MVI   HEAD1+69,C'-'                                                    
         MVC   HEAD1+70(4),BILLREF+2                                            
*                                                                               
GRPR02   MVC   HEAD3+1(L'AC@CLINT),AC@CLINT                                     
         MVC   HEAD3+9(3),CLICODE+3       CLIENT CODE                           
         MVC   HEAD3+16(36),CLINAME                                             
*                                                                               
         MVC   HEAD4+1(L'AC@PRO),AC@PRO                                         
         MVC   HEAD4+9(3),PRDCODE+6       PRODUCT CODE                          
         MVC   HEAD4+16(36),PRDNAME                                             
*                                                                               
         USING ADRELD,R2                                                        
         ICM   R2,15,ADLVBADD      USE PRODUCT LEVEL ADDRESS                    
         BNZ   *+12                                                             
         ICM   R2,15,ADLVAADD      OR CLIENT LEVEL ADDRESS                      
         BZ    GRPR06                                                           
         SR    R5,R5                                                            
         ICM   R5,1,ADRNUM                                                      
         BZ    GRPR06                                                           
         LA    R3,ADRADD1                                                       
         LA    R4,HEAD3+55                                                      
*                                                                               
GRPR04   MVC   0(26,R4),0(R3)      ADDRESS TO HEADLINES                         
         LA    R3,26(R3)                                                        
         LA    R4,132(R4)                                                       
         BCT   R5,GRPR04                                                        
*                                                                               
GRPR06   CLI   PROF14,C'Y'                                                      
         BE    GRPR08             SUPPRESS DUE DATE                             
         MVC   HEAD2+55(L'AC@DUEDT),AC@DUEDT                                    
         MVC   HEAD2+55+L'AC@DUEDT+1(L'DUEDAT),DUEDAT                           
*                                                                               
GRPR08   CLI   GRPMODE,1                                                        
         BNE   GRPR10                                                           
         MVC   HEAD11+1(L'AC@PRD),AC@PRD                                        
         MVC   HEAD11+22(L'AC@JOBNU),AC@JOBNU                                   
         MVC   HEAD11+40(L'AC@JOBN),AC@JOBN                                     
         MVC   HEAD12+1(L'AC@PRD),DASHES                                        
         MVC   HEAD12+22(L'AC@JOBNU),DASHES                                     
         MVC   HEAD12+40(L'AC@JOBN),DASHES                                      
*                                                                               
GRPR10   MVC   HEAD11+76(L'AC@AMT),AC@AMT                                       
         MVC   HEAD12+76(L'AC@AMT),DASHES                                       
         DS    0H                                                               
         GOTO1 ACREPORT                                                         
         B     GRPBILX                                                          
*                                                                               
GRPBILX  B     PRNTX                                                            
*                                                                               
GRPMODE  DS    CL1                                                              
GRPMEDIA DS    CL15                                                             
         EJECT                                                                  
*              PRINT JOB COMMNETS                                               
COMMPRT  MVI   COMMENTS,AFTER                                                   
         L     R2,ADACC                                                         
         BAS   RE,CMM                                                           
         L     R2,ADHEIRB                                                       
         BAS   RE,CMM                                                           
         L     R2,ADHEIRA                                                       
         BAS   RE,CMM                                                           
*                                                                               
         BAS   RE,CMMWPP           PRINT WPP COMMENTS                           
         B     CMMXIT                                                           
*                                                                               
CMM      NTR1  0H                                                               
         NI    COMMENTS,ALL-COMREAD                                             
         SR    R3,R3                                                            
         L     RF,ADACC                                                         
         MVI   ELCODE,X'3E'                                                     
         BAS   RE,GETEL4                                                        
         BNE   CMMXIT                                                           
         B     CMM04                                                            
*                                                                               
CMM02    L     R2,SAVR2            RESTORE ADDRESS OF LAST 3E                   
         MVI   ELCODE,X'3E'                                                     
         BAS   RE,NEXTEL4                                                       
         BNE   CMMXIT                                                           
*                                                                               
         USING SCMELD,R2                                                        
CMM04    ST    R2,SAVR2            SAVE ADDRESS OF THIS 3E                      
         CLI   SCMTYPE,C'M'       IGNORE OLD TYPE                               
         BE    CMM02                                                            
         CLI   SCMTYPE,0          AND PURE DATA                                 
         BE    CMM02                                                            
*                                                                               
         TM    SCMTYPE,X'80'      BILL COMMENT                                  
         BZ    CMM02                                                            
         TM    COMMENTS,BEFORE                                                  
         BO    CMM06                                                            
         TM    SCMTYPE,X'04'                                                    
         BZ    CMM02                                                            
         B     CMM08                                                            
*                                                                               
CMM06    TM    SCMTYPE,X'08'                                                    
         BZ    CMM02                                                            
*                                                                               
CMM08    CLI   PROF5,C'Y'                                                       
         BNE   CMM14               OPTION FOR COMMENT MEDIA MATCH               
         LA    R1,SCMNARR                                                       
*                                                                               
CMM10    CLI   0(R1),C' '                                                       
         BNE   CMM12                                                            
         LA    R1,1(R1)                                                         
         B     CMM10                                                            
*                                                                               
CMM12    CLC   JOBLET,0(R1)                                                     
         BNE   CMM02                                                            
*                                                                               
CMM14    XC    COMMKEY,COMMKEY     NOW READ A STANDARD COMMENT                  
         MVI   COMMKEY,X'0C'                                                    
         MVC   COMMKEY+1(1),QCOMPANY                                            
         MVC   COMMKEY+2(6),SCMNARR                                             
         OI    COMMENTS,COMREAD                                                 
         L     R2,ACOMBUF                                                       
         MVC   MYKEYSV,COMMKEY                                                  
         GOTO1 DATAMGR,DMCB,DMRDHI,FILNME,COMMKEY,(R2)                          
         CLC   MYKEYSV,0(R2)                                                    
         BNE   CMM02               DIDNT FIND IT                                
         AH    R2,DATADISP                                                      
*                                                                               
         LR    RE,R2                                                            
         SR    RF,RF               NOW COUNT THE NUMER OF LINES                 
*                                                                               
CMM16    CLI   0(RE),0             IN THE COMMENT                               
         BE    CMM18                                                            
         CLI   0(RE),X'3E'                                                      
         BNE   *+8                                                              
         LA    RF,1(RF)                                                         
         IC    R3,1(RE)                                                         
         AR    RE,R3                                                            
         B     CMM16                                                            
*                                                                               
CMM18    IC    R3,MAXLINES         SEE IF ALL THE COMMENT WILL FIT              
         SR    RE,RE                                                            
         IC    RE,LINE                                                          
         SR    R3,RE                                                            
         CR    RF,R3               NEEDED VS WHAT IS LEFT                       
         BNH   CMM20                                                            
         MVI   FORCEHED,C'Y'                                                    
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
*                                                                               
CMM20    SR    R3,R3                                                            
         CLI   0(R2),0                                                          
         BE    CMM02                                                            
         CLI   0(R2),X'3E'                                                      
         BE    CMM24                                                            
*                                                                               
CMM22    IC    R3,1(R2)                                                         
         AR    R2,R3                                                            
         B     CMM20                                                            
*                                                                               
CMM24    IC    R3,SCMLN                                                         
         SH    R3,=H'5'                                                         
         EX    R3,*+8                                                           
         B     *+10                                                             
         MVC   P+1(0),SCMNARR                                                   
         MVI   MYSPACE,1                                                        
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
         B     CMM22               GET NEXT ELEMENT                             
*                                                                               
CMMXIT   B     PRNTX                                                            
*                                                                               
CMMWPP   NTR1  0H                                                               
         LA    R2,CMMWPPT                                                       
*                                                                               
CMMWP02  CLI   0(R2),X'FF'                                                      
         BE    CMMWPX                                                           
         CLC   1(2,R2),ALPHAID                                                  
         BE    CMMWP04                                                          
         AHI   R2,L'CMMWPPT                                                     
         B     CMMWP02                                                          
*                                                                               
CMMWP04  SR    R3,R3                                                            
         XC    COMMKEY,COMMKEY                                                  
         MVI   COMMKEY,X'0C'                                                    
         MVC   COMMKEY+1(1),0(R2)                                               
         MVC   COMMKEY+2(6),3(R2)                                               
         OI    COMMENTS,COMREAD                                                 
         L     R2,ACOMBUF                                                       
         MVC   MYKEYSV,COMMKEY                                                  
         GOTO1 DATAMGR,DMCB,DMRDHI,FILNME,COMMKEY,(R2)                          
         CLC   MYKEYSV,0(R2)                                                    
         BNE   CMMWPX              DIDNT FIND IT                                
         AH    R2,DATADISP                                                      
*                                                                               
         LR    RE,R2                                                            
         SR    RF,RF               NOW COUNT THE NUMER OF LINES                 
*                                                                               
CMMWP06  CLI   0(RE),0             IN THE COMMENT                               
         BE    CMMWP08                                                          
         CLI   0(RE),X'3E'                                                      
         BNE   *+8                                                              
         LA    RF,1(RF)                                                         
         IC    R3,1(RE)                                                         
         AR    RE,R3                                                            
         B     CMMWP06                                                          
*                                                                               
CMMWP08  IC    R3,MAXLINES         SEE IF ALL THE COMMENT WILL FIT              
         SR    RE,RE                                                            
         IC    RE,LINE                                                          
         SR    R3,RE                                                            
         CR    RF,R3               NEEDED VS WHAT IS LEFT                       
         BNH   CMMWP10                                                          
         MVI   FORCEHED,C'Y'                                                    
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
*                                                                               
CMMWP10  SR    R3,R3                                                            
         CLI   0(R2),0                                                          
         BE    CMMWPX                                                           
         CLI   0(R2),X'3E'                                                      
         BE    CMMWP14                                                          
*                                                                               
CMMWP12  IC    R3,1(R2)                                                         
         AR    R2,R3                                                            
         B     CMMWP10                                                          
*                                                                               
CMMWP14  IC    R3,SCMLN                                                         
         SH    R3,=H'5'                                                         
         EX    R3,*+8                                                           
         B     *+10                                                             
         MVC   P+1(0),SCMNARR                                                   
         MVI   MYSPACE,1                                                        
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
         B     CMMWP12             GET NEXT ELEMENT                             
*                                                                               
CMMWPX   B     PRNTX                                                            
         EJECT ,                                                                
         GETELN R2,DATADISP,ELCODE,4                                            
         SPACE 2                                                                
CMMWPPT  DS    0CL9                                                             
         DC    XL1'B2',CL2'YP',CL6'WPPCOM'    YSHNY                             
         DC    XL1'4A',CL2'YN',CL6'WPPCOM'    YNRO                              
         DC    XL1'5A',CL2'JG',CL6'WPPCOM'    CWSFS                             
         DC    XL1'9E',CL2'WW',CL6'WPPCOM'    WWSFS                             
         DC    XL1'93',CL2'M2',CL6'WPPCOM'    MENYA                             
         DC    XL1'50',CL2'H7',CL6'WPPCOM'    MSNY                              
         DC    XL1'E3',CL2'JW',CL6'WPPCOM'    JWNY                              
         DC    X'FF'                                                            
*                                                                               
*              TABLE OF DISPLACEMENTS FOR SOFTHEADS                             
*                                                                               
SOFTAB   DC    AL2(HEAD7-ACWORKD+1)                                             
         DC    AL2(HEAD7-ACWORKD+45)                                            
         DC    AL2(HEAD8-ACWORKD+1)                                             
         DC    AL2(HEAD8-ACWORKD+45)                                            
         DC    AL2(HEAD9-ACWORKD+1)                                             
         DC    AL2(HEAD9-ACWORKD+45)                                            
         DC    AL2(HEAD10-ACWORKD+1)                                            
         DC    AL2(HEAD10-ACWORKD+45)                                           
         DC    X'FF'                                                            
*                                                                               
GSTDETLU DC    CL43'   --------        --------      ----------'                
*                                                                               
DASHES   DC    20C'-'                                                           
*                                                                               
         DROP  R9,RA,RB                                                         
*                                                                               
         LTORG                                                                  
         EJECT ,                                                                
SAVR2    DS    F                   A(ADDRESS OF LAST 3E ELEMENT)                
SAVECOMM DS    PL6                                                              
*                                                                               
PBRWK    DS    CL(PBRLNQ)          WORK FOR PROD BILL RECORDS                   
INCBUF   DS    CL(INCRLNQ)         WORKAREA FOR INCOME RECORDS                  
         TITLE 'AC21 - PRODUCTION BILLING - RETAIL ROUTINES'                    
RTLR     DS    0D                                                               
         NMOD1 0,*RTL*,RA                                                       
         L     RC,0(,R1)                                                        
         CLI   RTLMODE,RTLINIT                                                  
         BE    RTLR02                   FIRST TIME INITIALIZATION               
         CLI   RTLMODE,RTLINI2                                                  
         BE    RTLR21                   INITIALIZATION PART 2                   
         CLI   RTLMODE,RTLDTLS                                                  
         BE    RTLR48                   SAVE DETAIL PRINT LINES                 
         CLI   RTLMODE,RTLPRNT                                                  
         BE    RTLR54                   CALCULATE SHARE/PRINT/POST              
RTLRXIT  XIT1                                                                   
         EJECT                                                                  
*              AT PROCACC BUILD RETAIL TABLE                                    
*                                                                               
RTLR02   MVC   KEY,SPACES                                                       
         LA    R3,KEY                                                           
         USING TRNRECD,R3                                                       
         MVC   TRNKCPY,RCCOMPFL     BUILD KEY FOR RETAIL LEDGER                 
         MVI   TRNKUNT,C'3'                                                     
         MVC   TRNKLDG,RTLEDG                                                   
         BAS   R9,RTLHIGH                                                       
         CLC   KEY,KEYSAVE                                                      
         BE    *+6                                                              
         DC    H'0'                     INVALID LEDGER                          
         MVC   LEVARECV(120),SPACES                                             
         MVC   RTLJOBFL,SPACES          ASSUME NO UNITS BY JOB                  
         MVI   RTLTYPE,0                                                        
         LA    R4,IOAREA                                                        
         MVI   ELCODE,X'14'                                                     
         BAS   RE,GETEL5                                                        
         BE    *+6                                                              
         DC    H'0'                     NO LEDGER ELEMENT                       
         USING LDGELD,R4                                                        
         TM    LDGSTAT,X'01'           100% TYPE                                
         BNO   *+8                                                              
         MVI   RTLTYPE,C'P'                                                     
         LA    R4,IOAREA                                                        
         MVI   ELCODE,X'16'                                                     
         BAS   RE,GETEL5                                                        
         BE    *+6                      GET HEIRARCHY ELEMENT                   
         DC    H'0'                                                             
         MVC   SVHEIR,0(R4)             SAVE ELEMENT                            
         LA    R3,IOAREA                                                        
*                                                                               
         USING RTLD,R5                                                          
RTLR04   BAS   R9,RTLSEQ                                                        
         CLC   TRNKEY(3),KEYSAVE     SAME LEDGER                                
         BE    *+6                                                              
         DC    H'0'                    NO RECORDS                               
         CLI   TRNKACT,C'*'                                                     
         BNE   RTLR06                  PASSED THE STAR ACCOUNT(S)               
         CLC   TRNKCULC,JOBCODE        UNITS BY JOB                             
         BNE   RTLR04                                                           
         LA    R4,IOAREA                                                        
         BAS   R9,GETSCHM              GET SCHEME ELEMENT                       
         BNE   RTLR04                                                           
         MVC   RTLJOBFL,JOBCODE        SET SWITCH TO FILTER BY JOB              
         B     RTLR04                                                           
*                                                                               
RTLR06   DS    0H                                                               
         ZAP   TOTUNITS,=P'0'                                                   
         L     R5,ADSTRB               DISTRIBUTOR TABLE                        
         ST    R5,ARETSTRT         SAVE THE ADDRESS FOR POSTINGS                
         MVI   0(R5),X'FF'             END OF TABLE                             
         EJECT                                                                  
*              DETERMINE LEVEL FOR THIS RECORD                                  
RTLR08   DS    0H                                                               
         SR    R3,R3                                                            
         LA    R0,1                                                             
         LA    R6,SVHEIR                                                        
         USING ACLELD,R6                                                        
         LA    R6,ACLVALS                                                       
*                                                                               
RTLR10   CLI   0(R6),12                IS THIS ACCOUNT LEVEL                    
         BNE   *+12                                                             
         LA    R0,4                    4 IS ACCOUNT LEVEL                       
         B     RTLR12                                                           
         IC    R3,0(R6)                DISP. TO NEXT LEVEL                      
         LA    R2,IOAREA+3(R3)         R2 TO NEXT LEVEL IN KEY                  
         CLI   0(R2),X'40'                                                      
         BNH   RTLR12                  FIELD BLANK                              
         LA    R6,16(R6)               NEXT LEVEL IN HEIRARCHY                  
         AH    R0,=H'1'                                                         
         B     RTLR10                                                           
*                                                                               
RTLR12   STC   R0,ACCLVL               SAVE LEVEL NUMBER                        
         LA    R3,IOAREA                                                        
         CLI   TRNKCULC,C' '           ACCOUNT (ANY LEVEL)                      
         BE    RTLR14                                                           
         CLI   ACCLVL,4                                                         
         BNE   RTLR20              CONTRA ACCOUNT (HIGH)                        
         B     RTLR16              CONTRA ACCOUNT (LOW)                         
*                                                                               
RTLR14   LR    R1,R0                                                            
         BCTR  R1,0                                                             
         MH    R1,=H'30'                                                        
         LA    R1,LEVARECV(R1)         R1 TO RECEIVABLE FIELD                   
         LA    R3,5                    R3 = NUMBER OF                           
         SR    R3,R0                   LOWER LEVELS TO CLEAR                    
         MH    R3,=H'30'                                                        
         BCTR  R3,0                                                             
         EX    R3,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R1),SPACES          CLEAR LOWER RECEIVABLES                  
         BAS   R9,GETRECV              GET REC'V AND COST ACCOUNT               
         CLI   ACCLVL,4                IS THIS ACCOUNT LEVEL                    
         BNE   RTLR20                  IF NOT DON'T NEED SCHEME                 
         LA    R3,RTLNME                                                        
         BAS   R9,GETNME               GET DISTRIBUTOR NAME                     
         LA    R3,RTLADDR                                                       
         BAS   R9,GETADDR              GET DISTRIBUTOR ADDRESS                  
*                                                                               
RTLR16   DS    0H                                                               
         LA    R4,IOAREA               ->   RECORD                              
         LR    R3,R4                   ->   RECORD                              
         MVI   FREETYPE,FFTTCOMR       SPECIAL   COMMISSION RATE                
         BAS   R9,GETFFTYP             GET  FREE FORM TYPE                      
         BNE   RTLR17                  NO,  SKIP                                
*                                                                               
         USING FFTELD,R4               MAP  FREE FORM TYPE ELEMENT              
         ZAP   SVRTLCOM,FFTDATA(4)     SAVE COMMISSION     RATE                 
         MVC   SVRTLACT,TRNKCULA       SAVE COMMISSION     ACCOUNT              
         DROP  R4                                                               
*                                                                               
RTLR17   DS    0H                                                               
         CLC   TRNKCULC,RTLJOBFL       FILTER BY JOB                            
         BNE   RTLR20                                                           
*                                                                               
         LA    R4,IOAREA                                                        
         BAS   R9,GETSCHM              GET SCHEME ELEMENT                       
         BNE   RTLR20                                                           
         MVC   RTLRECV,SPACES          INIT RECEIVABLE                          
         MVC   RTLCOST,SPACES          COST AND                                 
         MVC   RTLCHG,ZEROS            ACCUMS                                   
         MVC   RTLPRV,ZEROS                                                     
         MVC   RTLNET,ZEROS                                                     
         ZAP   RTLCMTOT,=P'0'          COMMISSION TOTAL AMOUNT                  
         MVI   RTLSTAT,0                                                        
         TM    BILLMODE,UNBILL         IF MODE IS UNBILLING AC23                
         BZ    *+8                                                              
         OI    RTLSTAT,RTLNBILL        MAKE IT NON-BILLABLE FOR NOW             
         USING DSCELD,R4                                                        
         ZAP   DUB,DSCVAL              SAVE UNITS/PERCENT                       
         ZAP   RTLPCT,DUB                                                       
         ZAP   RTLPGST,DUB                                                      
         ZAP   RTLUNT,DUB                                                       
         AP    TOTUNITS,DUB            ADD TO TOTAL UNITS                       
         MVC   RTLDIS,IOAREA           SAVE DISTRIBUTOR CODE                    
         LA    R1,LEVARECV             GET RECEIVABLE CODE                      
         LA    R0,4                    FROM SEVERAL LEVELS                      
*                                                                               
RTLR18   CLI   0(R1),X'40'                                                      
         BE    *+10                                                             
         MVC   RTLRECV,0(R1)                                                    
         CLI   15(R1),X'40'                                                     
         BE    *+10                                                             
         MVC   RTLCOST,15(R1)                                                   
         LA    R1,30(,R1)                                                       
         BCT   R0,RTLR18                                                        
*                                                                               
         LA    R3,IOAREA           ->   RECORD                                  
         CLC   TRNKCULA,SVRTLACT   SAVED     RETAIL    COMMISSION ACT ?         
         BNE   RTLR19              NO,  SKIP                                    
         ZAP   RTLCRATE,SVRTLCOM   GET  SAVED     COMMISSION     RATE           
         OI    RTLSTAT,RTLCOMM     SAY  SPECIAL   COMMISSION     RATE           
         OI    RTLOPT,RTLSCOMM     SAY  SPECIAL   COMMISSION     RATE           
*                                                                               
RTLR19   LA    R5,RTLLNQ(,R5)      NEXT ENTRY     IN   TABLE                    
         MVI   0(R5),X'FF'                                                      
*                                                                               
RTLR20   BAS   R9,RTLSEQ                                                        
         LA    R3,IOAREA                                                        
         CLC   TRNKEY(3),KEYSAVE   SAME LEDGER                                  
         BE    RTLR08                                                           
         B     RTLRXIT             RETURN    TO   CALLER                        
         EJECT ,                                                                
*              AT PROCACC RETAIL INITIALIZATION PART 2                          
*                                                                               
RTLR21   L     R5,ADSTRB                                                        
         CP    TOTUNITS,=P'0'                                                   
         BP    RTLR22                                                           
         MVC   P+2(L'AC@SCM),AC@SCM    NO DISTRIBUTION PERCENTS                 
         MVI   P+2+L'AC@SCM,C'='                                                
         MVC   P+2+L'AC@SCM+1(L'RTLEDG+L'SCHEME),RTLEDG                         
         MVC   P+2+L'AC@SCM+1+L'RTLEDG+L'SCHEME+1(L'AC@NDIST),AC@NDIST          
         MVI   RTLEDG,0                                                         
         MVI   FCRDTRNS,C'N'                                                    
         MVI   FCRDEST,C'N'                                                     
         MVI   BILLTYPE,NOTBILL                                                 
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
         B     RTLR46                                                           
*                                                                               
RTLR22   CLI   RTLTYPE,C'P'            IS IT A PERCENT LEDGER                   
         BNE   RTLR24                                                           
         CP    TOTUNITS,=P'1000000'    DOES IT ADD TO 100%                      
         BE    RTLR24                                                           
         MVC   P+2(L'AC@SCM),AC@SCM    DISTRIBUTION PERCENTS NOT 100            
         MVC   P+2+L'AC@SCM+1(L'RTLEDG+L'SCHEME),RTLEDG                         
         MVC   P+2+L'AC@SCM+1+L'RTLEDG+L'SCHEME+1(L'AC@PC100),AC@PC100          
         MVI   RTLEDG,0                                                         
         MVI   FCRDTRNS,C'N'                                                    
         MVI   FCRDEST,C'N'                                                     
         MVI   BILLTYPE,NOTBILL                                                 
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
         B     RTLR46                                                           
*                                                                               
RTLR24   CLI   RTLTYPE,C'P'            IF IT'S PERCENT LEDGER                   
         BE    RTLR26                  JUST LOOK FOR END OF TABLE               
         ZAP   PL16,RTLUNT             UNITS                                    
         MP    PL16,=P'10000000'                                                
         DP    PL16,TOTUNITS           DIVIDED BY TOTAL                         
         SRP   PL16(10),64-1,5         PERCENT ROUNDED                          
         ZAP   RTLPCT,PL16(10)         SAVED IN TABLE                           
         ZAP   RTLPGST,PL16(10)        SAVED IN TABLE                           
*                                                                               
RTLR26   LA    R5,RTLLNQ(R5)                                                    
         CLI   0(R5),X'FF'             END OF TABLE                             
         BNE   RTLR24                                                           
         EJECT                                                                  
*              LOOK FOR PREVIOUS BILLING                                        
*              ADD TABLE ENTRY FOR ANYONE WHO HAD BILLING                       
*              AND HAS NOW BEEN REMOVED FROM SCHEME                             
*                                                                               
RTLR28   MVC   KEY,SPACES                                                       
         LA    R3,KEY                                                           
         USING TRNRECD,R3                                                       
         MVC   TRNKCULA,JOBCODE         JOB KEY                                 
         MVC   TRNKWORK,=C'99'          BILLING RECORDS                         
         BAS   R9,RTLHIGH                                                       
*                                                                               
RTLR30   CLC   KEY(17),KEYSAVE                                                  
         BNE   RTLR44                   END OF BILLING RECORDS                  
         L     R5,ADSTRB                                                        
         LA    R3,IOAREA                                                        
         LA    R2,TRNRECD+ACCORFST                                              
         CLI   0(R2),X'44'              SKIP NON-TRANSACTIONS                   
         BNE   RTLR42                                                           
         TM    BILLMODE,UNBILL          FOR UNBILLING                           
         BNO   RTLR32                   ONLY WANT ITEM TO UNBILL                
         GOTO1 DATCON,DMCB,(1,TRNKDATE),(2,WORK)                                
         CLC   WORK(2),END2                                                     
         BNE   RTLR42                                                           
         USING TRNELD,R2                                                        
         CLC   TRN2DAY,USEDATE          IS DATE RUN CORRECT ?                   
         BNE   RTLR42                   NO                                      
*                                                                               
RTLR32   CLI   0(R5),X'FF'              END OF TABLE                            
         BE    RTLR34                                                           
         CLC   TRNKCULC,RTLDIS          IS DISTRIBUTOR ALREADY IN TABLE         
         BE    RTLR40                                                           
         LA    R5,RTLLNQ(R5)                                                    
         B     RTLR32                                                           
*                                                                               
RTLR34   MVC   RTLDIS,TRNKCULC          ADD OLD DISTRIBUTOR TO TABLE            
         MVC   RTLRECV,SPACES                                                   
         MVC   RTLCOST,SPACES                                                   
         ZAP   RTLPCT,=P'0'                                                     
         ZAP   RTLPGST,=P'0'                                                    
         ZAP   RTLUNT,=P'0'                                                     
         ZAP   RTLCRATE,=P'0'                                                   
         ZAP   RTLCMTOT,=P'0'                                                   
         MVC   RTLCHG,ZEROS                                                     
         MVC   RTLPRV,ZEROS                                                     
         MVC   RTLNET,ZEROS                                                     
         MVI   RTLSTAT,RTLOLD           MARK OLD(REMOVED) RETAILER              
         TM    BILLMODE,UNBILL          IF UNBILLING                            
         BZ    *+8                                                              
         MVI   RTLSTAT,RTLNBILL         MARK AS NOT BILLABLE FOR NOW            
         MVC   SAVBILL,IOAREA           SAVE KEY OF BILL                        
         MVC   KEY,SPACES                                                       
         MVC   KEY(3),RTLDIS            READ DISTRIBUTOR RECORD                 
         LA    R6,SVHEIR                                                        
         LA    R6,ACLVALS                                                       
*                                                                               
RTLR36   SR    R3,R3                    TO GET RECEIVABLE ACCOUNT               
         IC    R3,0(R6)                 LENGTH OF HIGH LEVEL KEY                
         BCTR  R3,0                                                             
         EX    R3,*+8                                                           
         B     *+10                                                             
         MVC   KEY+3(0),RTLDIS+3                                                
         BAS   R9,RTLREAD               READ ALL LEVELS FOR DISTRIBUTOR         
         CLI   DMCB+8,0                                                         
         BNE   RTLR38                                                           
         LA    R1,RTLRECV                                                       
         BAS   R9,GETRECV               GET REC'V AND COST ACCOUNTS             
         LA    R3,RTLNME                                                        
         BAS   R9,GETNME                GET DISTRIBUTOR NAME                    
         LA    R3,RTLADDR                                                       
         BAS   R9,GETADDR               GET DISTRIBUTOR ADDRESS                 
*                                                                               
RTLR38   CLI   0(R6),12                 END OF HEIRARCHY                        
         BE    *+12                                                             
         LA    R6,16(R6)                NEXT LEVEL IN HEIRARCHY                 
         BNE   RTLR36                   CHECK NEXT LEVEL                        
         GOTO1 DATAMGR,DMCB,DMREAD,FILNME,SAVBILL,IOAREA                        
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                     CAN'T READ LAST BILL                    
         LA    R6,RTLLNQ(R5)                                                    
         MVI   0(R6),X'FF'              NEW END OF TABLE                        
*                                                                               
RTLR40   ZAP   SIGN,=P'-1'              REVERSE SIGN                            
         LA    R3,RTLPRV                ADD TO PREVIOUS TOTAL                   
         BAS   R9,ADDRBILL              GET PREVIOUS BILL AMOUNTS               
         TM    BILLMODE,UNBILL                                                  
         BNO   RTLR42                                                           
         USING TRNELD,R2                                                        
         CP    TRNRTPCT,=P'0'           IF THIS WAS A REVERSAL                  
         BE    RTLR42                   LEAVE IT UNBILLABLE                     
         NI    RTLSTAT,X'FF'-RTLNBILL   AND TURN OFF UNBILLING                  
         OI    RTLSTAT,RTLOLD           REMOVE ALL RETAILERS                    
         MVC   RTLBIL,TRNREF       SAVE OLD BILL NUMBER                         
         MVC   TRNUNBIL,TODAY2     UNBILL DATE                                  
         CLI   RCWRITE,C'N'        ARE WE WRITING TO THE FILE ?                 
         BE    RTLR42              NO                                           
         GOTO1 DATAMGR,DMCB,DMWRT,FILNME,IOAREA,IOAREA                          
*                                                                               
RTLR42   BAS   R9,RTLSEQ                                                        
         B     RTLR30                                                           
*                                                                               
*              END OF INITIALIZATION ROUTINE                                    
*                                                                               
RTLR44   DS    0H                                                               
         L     R5,APRNTAB               SET ADDRESS OF NEXT PRINT SAVE          
         ST    R5,ANXTPRT                                                       
         MVI   0(R5),X'FF'                                                      
         B     RTLRXIT                                                          
*                                                                               
RTLR46   MVC   KEY,SPACES          RESET KEY BEFORE ERROR EXIT                  
         LA    R3,KEY                                                           
         MVC   TRNKCULA,JOBCODE                                                 
         B     RTLRXIT                                                          
         EJECT                                                                  
*              SAVE DETAIL PRINT LINES - UNTIL PREVIOUS BILLS                   
*                                                                               
RTLR48   CLC   SVANAL,=C'99'                                                    
         BE    *+12                     IF PREVIOUS BILLS                       
         CLI   MODE,LASTEST             OR TOTAL LINE FOR % EST                 
         BNE   RTLR50                                                           
         MVC   MID1,SPACES              CLEAR MIDLINES                          
         MVC   MID2,SPACES                                                      
         LA    R0,4                     AND PRINT LINES                         
         LA    R1,P                                                             
         MVC   0(132,R1),SPACES                                                 
         LA    R1,132(R1)                                                       
         BCT   R0,*-10                                                          
         B     RTLRXIT                                                          
*                                                                               
RTLR50   L     R2,ANXTPRT               A(NEXT PRINT LINE)                      
         MVC   0(1,R2),SPACING          SAVE THE SPACING VALUE                  
         LA    R2,1(R2)                                                         
         OC    MID1,SPACES                                                      
         CLC   MID1,SPACES                                                      
         BE    RTLR52                   IF NOT SPACES                           
         MVI   0(R2),X'10'              MIDLINE INDICATOR                       
         LA    R2,1(R2)                                                         
         MVC   0(132,R2),MID1                                                   
         MVC   MID1,SPACES                                                      
         LA    R2,132(R2)                                                       
         MVC   0(132,R2),MID2                                                   
         MVC   MID2,SPACES                                                      
         LA    R2,132(R2)                                                       
*                                                                               
RTLR52   LA    R0,4                     AND UP TO 4 LINES OF PRINT              
         LA    R1,P                                                             
         BAS   R9,RTLSVP                                                        
*                                                                               
         ST    R2,ANXTPRT               A(NEXT LINE)                            
         MVI   0(R2),X'FF'              MARK END OF TEXT                        
         B     RTLRXIT                                                          
*                                                                               
*              SAVE AND CLEAR PRINT LINES                                       
RTLSVP   OC    0(132,R1),SPACES                                                 
         CLC   0(132,R1),SPACES                                                 
         BER   R9                                                               
         MVC   0(132,R2),0(R1)                                                  
         MVC   0(132,R1),SPACES                                                 
         LA    R2,132(R2)                                                       
         LA    R1,132(R1)                                                       
         BCT   R0,RTLSVP                                                        
         BR    R9                                                               
         EJECT                                                                  
*              GET RETAILER SHARE OF TOTAL CHARGES                              
*                                                                               
         USING JOBD,R6                                                          
RTLR54   DS    0H                                                               
         CLI   PROF9,C'G'               ONLY SHOW AFTER DUE AMOUNT              
         BE    RTLR56                                                           
         LA    R6,TOTCHG                SUBTRACT C.D FROM TOTAL CHARGES         
         SP    JOBNET,JOBCD                                                     
         SP    JOBGRS,JOBCD                                                     
*                                                                               
RTLR56   L     R5,ADSTRB                                                        
         MVC   POSTOT,ZEROS             TOTAL RETAILER POSTINGS                 
         MVC   BILLTOT,ZEROS            AND PREVIOUS BILLS                      
*                                                                               
RTLR58   MVC   RTLCHG,TOTCHG            MOVE IN TOTAL - CHARGES                 
         LA    R6,RTLCHG                                                        
         LA    R4,JOBNET                THEN GET                                
         BAS   R9,SHARE                 SHARE OF NET/COMM/CD                    
         ZAP   JOBGRS,JOBNET            RECALCULATE GROSS                       
         AP    JOBGRS,JOBCOMM                                                   
*                                                                               
         ZAP   JOBVGRS,JOBNET           RECALCULATE GST GROSS                   
         AP    JOBVGRS,JOBCOMM                                                  
         AP    JOBVGRS,JOBGST                                                   
*                                                                               
         ZAP   JOBPGRS,JOBVGRS          RECALCULATE PST GROSS                   
         AP    JOBPGRS,JOBPST                                                   
*                                                                               
         ZAP   JOBVNET,JOBNET           RECALCULATE GST NET                     
         AP    JOBVNET,JOBGST                                                   
*                                                                               
         ZAP   JOBPNET,JOBVNET          RECALCULATE PST NET                     
         AP    JOBPNET,JOBPST                                                   
*                                                                               
         ZAP   JOBVBAS,JOBVNET          RECALCULATE GST BASIS                   
         TM    CLIOPT,PAYNET                                                    
         BO    *+10                                                             
         ZAP   JOBVBAS,JOBVGRS                                                  
*                                                                               
         ZAP   JOBPBAS,JOBPNET          RECALCULATE PST BASIS                   
         TM    CLIOPT,PAYNET                                                    
         BO    *+10                                                             
         ZAP   JOBPBAS,JOBPGRS                                                  
*                                                                               
         MVC   RTLNET,RTLCHG            POST = CHARGES(PROG & SPECIAL)          
         TM    BILLTYPE,TOTAL+ESTIM                                             
         BZ    RTLR60                                                           
         LA    R4,RTLPRV                FOR TOTAL AND %EST ADD BILLS            
         LA    R6,RTLNET                TO GET POSTINGS AND AMOUNT DUE          
         BAS   R9,ADDAMTS                                                       
*                                                                               
RTLR60   TM    RTLSTAT,RTLOLD           IF  OLD RETAILERS                       
         BZ    RTLR62                                                           
         MVC   RTLNET,RTLPRV            POSTINGS ARE PREVIOUS BILLS             
         B     RTLR64                                                           
*                                                                               
RTLR62   LA    R4,RTLNET                ADD RETAILER POSTINGS                   
         LA    R6,POSTOT                TO ACCUM FOR TOTAL POSTING              
         BAS   R9,ADDAMTS                                                       
         LA    R4,RTLPRV                AND TOTAL BILLS                         
         LA    R6,BILLTOT                                                       
         BAS   R9,ADDAMTS                                                       
*                                                                               
RTLR64   TM    BILLTYPE,TOTAL      IS THIS A TOTAL BILL ?                       
         BZ    RTLR66              NO                                           
         CLI   QOPT3,C'R'          YES, IS THIS A DEMAND TOTAL ?                
         BE    RTLR68              YES, SKIP OVER THIS                          
*                                                                               
RTLR66   LA    R0,4                                                             
         LA    R6,RTLNET                IF ALL POSTINGS ARE ZERO                
         CP    0(L'JOBNET,R6),=P'0'                                             
         BNE   RTLR68                                                           
         LA    R6,L'JOBNET(R6)                                                  
         BCT   R0,*-14                                                          
         OI    RTLSTAT,RTLNBILL         MAKE IT NOT BILLABLE                    
*                                                                               
RTLR68   LA    R5,RTLLNQ(R5)                                                    
         CLI   0(R5),X'FF'                                                      
         BNE   RTLR58                                                           
         EJECT                                                                  
*              POST ROUNDING DIFFERENCES                                        
*              TO FIRST ENTRY IN TABLE                                          
*                                                                               
         TM    BILLMODE,UNBILL          FOR UNBILLING                           
         BO    RTLR72                   NO NEED TO ROUND                        
         LA    R6,TOTCHG                TOTAL CHARGES                           
         ZAP   DUB,JOBNET               TOTAL CREDIT TO INVENTORY               
         ZAP   DUB2,JOBINT              TOTAL INTERNAL INCOME                   
*                                                                               
         LA    R6,BILLTOT                                                       
         TM    BILLTYPE,TOTAL+ESTIM     FOR TOTAL AND ESTIMATE                  
         BZ    *+10                                                             
         AP    DUB,JOBNET               REDUCED BY PREVIOUS BILLS               
*                                                                               
         LA    R6,POSTOT                INDIVIDUAL POSTINGS                     
         ZAP   DUB1,JOBNET                                                      
*                                                                               
         SP    DUB,DUB1                 TOTAL LESS SUM OF INDIVIDUALS           
         SP    DUB2,JOBINT                                                      
*                                                                               
         AP    JOBNET,DUB               FIX THE NET                             
         AP    JOBGRS,DUB                       GROSS                           
         AP    JOBINT,DUB2                      INTERNAL INCOME                 
*                                                                               
         AP    JOBVNET,DUB                      VNET                            
         AP    JOBVGRS,DUB                      VGROSS                          
         AP    JOBVBAS,DUB                      VBASE                           
*                                                                               
         AP    JOBPGRS,DUB                      PGROSS                          
         AP    JOBPNET,DUB                      PNET                            
         AP    JOBPBAS,DUB                      PBASE                           
*                                                                               
         L     R5,ADSTRB                                                        
         LA    R6,RTLNET                RETAILER ACCUM LINE                     
         AP    JOBNET,DUB               ADD DIFFERENCE TO FIRST ENTRY           
         AP    JOBGRS,DUB               SO INVOICE ADDS ACROSS                  
         AP    JOBINT,DUB2                      INTERNAL INCOME                 
*                                                                               
         AP    JOBVGRS,DUB              FIX VGROSS                              
         AP    JOBVNET,DUB                  VNET                                
         AP    JOBVBAS,DUB                  AND VBASE ALSO                      
*                                                                               
         AP    JOBPGRS,DUB              FIX PGROSS                              
         AP    JOBPNET,DUB                  PNET                                
         AP    JOBPBAS,DUB                  AND PBASE ALSO                      
*                                                                               
         LA    R6,RTLCHG                ADD TO CHARGES SO IT ADDS DOWN          
         AP    JOBNET,DUB                                                       
         AP    JOBGRS,DUB                                                       
*                                                                               
         AP    JOBVNET,DUB                                                      
         AP    JOBVGRS,DUB                                                      
         AP    JOBVBAS,DUB                                                      
*                                                                               
         AP    JOBPNET,DUB                                                      
         AP    JOBPGRS,DUB                                                      
         AP    JOBPBAS,DUB                                                      
*                                       FIX THE PERCENTAGE                      
         ZAP   PL16,JOBNET              RETAIL CHARGE                           
         MP    PL16,=P'10000000'                                                
         LA    R6,TOTCHG                                                        
         CP    JOBNET,=P'0'             IF TOTAL NET NOT ZERO NO DIVIDE         
         BNE   RTLR70                                                           
         TM    BILLTYPE,PROG            IF TOTAL ZERO AND PROGRESSIVE           
         BO    RTLRXIT                     EXIT                                 
         B     RTLR72                   IF NOT PROGRESSIVE, SKIP DIVIDE         
*                                                                               
RTLR70   DP    PL16,JOBNET+2(6)         DIVIDED BY TOTAL CHARGE                 
         SRP   PL16(10),64-1,5                                                  
         ZAP   RTLPCT,PL16(10)                                                  
         EJECT                                                                  
*              PRINT BILL FOR EACH ENTRY IN DISTRIBUTOR TABLE                   
*                                                                               
RTLR72   L     R5,ADSTRB                                                        
         TM    BILLOPT,OLDNUM           USING ORGINIAL INVOICE NUMBER           
         BO    RTLR74                   FOR REVERSAL                            
         OC    BILLNO,BILLNO                                                    
         BNZ   *+10                                                             
         ZAP   BILLNO,=P'1'                                                     
         SP    BILLNO,=P'1'             ADJUST FOR FIRST BILL                   
*                                                                               
RTLR74   TM    RTLSTAT,RTLNBILL         NO BILLING                              
         BO    RTLR98                                                           
         ST    R5,ARETAIL                                                       
         MVI   FORCEHED,C'Y'                                                    
         MVC   SAVRECV,RECEIVBL        SAVE RECEIVABLE CODE                     
         MVC   SAVCOST,COSTING         SAVE COSTING CODE                        
         CLI   RTLRECV,X'40'                                                    
         BNH   *+10                                                             
         MVC   RECEIVBL,RTLRECV        OVERRIDE RECEIVABLE                      
         CLI   RTLCOST,X'40'                                                    
         BNH   *+10                                                             
         MVC   COSTING,RTLCOST         OVERRIDE COSTING                         
         LA    R1,RTLNME                                                        
         ST    R1,ARTLNAME              PASS A(RETAILER NAME)                   
         LA    R1,RTLADDR               AND ADDRESS                             
         CLC   RTLADDR,SPACES           IF ANY                                  
         BE    *+8                                                              
         ST    R1,ARTLADDR                                                      
         TM    BILLMODE,UNBILL          FOR UNBILLING                           
         BNO   RTLR75                                                           
         MVC   QSELECT(6),RTLBIL        QSELECT HAS ORIGINAL NUMBER             
         TM    BILLOPT,OLDNUM           USE OLD NUMBER?                         
         BNO   RTLR75                                                           
         PACK  BILLNO,RTLBIL+2(4)                                               
         B     RTLR76                                                           
*                                                                               
RTLR75   AP    BILLNO,=P'1'             NEXT BILL NUMBER                        
         UNPK  RTLBIL+2(4),BILLNO                                               
         OI    RTLBIL+5,X'F0'                                                   
         MVC   RTLBIL(2),BILLREF        USE NEW PREFIX                          
*                                                                               
RTLR76   MVC   BILLREF,RTLBIL                                                   
         TM    BILLMODE,DRAFT                                                   
         BO    RTLR77                                                           
         MVC   SHTBILNO+3(4),RTLBIL+2   MM-NNNN                                 
         LA    R1,LNGBILNO+5            MEDIA-MM-NNNN                           
         MVC   0(4,R1),RTLBIL+2                                                 
*                                                                               
RTLR77   ZAP   FULL,BILLNO              ADD ONE TO LAST BILL NUMBER             
         AP    FULL,=P'1'               FOR THE NEXT TIME                       
         L     R1,ANUMAFT               A(CLIENT, MEDIA OR AGENCY ELEM)         
         LTR   R1,R1                                                            
         BZ    *+14                     DRAFT BILLING                           
         UNPK  2(4,R1),FULL             FORMAT IS CHARACTER                     
         OI    5(R1),X'F0'                                                      
         L     R2,APRNTAB                                                       
         CLI   0(R2),X'FF'                                                      
         BE    RTLR86                   NO DETAILS TO PRINT                     
         TM    BILLMODE,UNBILL          NO DETAILS OR TOTAL                     
         BO    RTLR88                   OR SHARE FOR UNBILLING                  
*                                                                               
RTLR78   MVC   SPACING,0(R2)            FIRST IS SPACING VALUE                  
         LA    R2,1(R2)                                                         
*                                                                               
         CLI   0(R2),X'FF'              END OF PRINT                            
         BE    RTLE84                                                           
         CLI   0(R2),X'10'              IF NEXT IS SPACING VALUE                
         BL    RTLE84                   NEW SPACING VALUE - PRINT IT            
         BH    RTLR80                   PRINT LINE                              
         MVC   MID1,1(R2)               SET-UP MIDLINES                         
         MVC   MID2,133(R2)                                                     
         LA    R2,265(R2)                                                       
         MVI   FORCEMID,C'Y'                                                    
*                                                                               
RTLR80   LA    R1,P                     UP TO  4 PRINT LINES                    
         LA    R0,4                                                             
*                                                                               
RTLR82   MVC   0(132,R1),0(R2)                                                  
         LA    R1,132(R1)                                                       
         LA    R2,132(R2)               NEXT LINE IN TABLE                      
         CLI   0(R2),X'FF'                                                      
         BE    RTLE84                   END OF TABLE                            
         CLI   0(R2),X'40'                                                      
         BL    RTLE84                   NEW SPACING VALUE                       
         BCT   R0,RTLR82                                                        
*                                                                               
RTLE84   MVC   MYSPACE,SPACING                                                  
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
         CLI   0(R2),X'FF'              END OF DETAIL                           
         BNE   RTLR78                   IF NOT PRINT NEXT LINES                 
         EJECT                                                                  
RTLR86   BAS   RE,TOTLNE                PRINT C.D., TOTAL AND SHARE             
*                                                                               
RTLR88   MVC   JOBCHG,RTLCHG            REPLACE JOB TOTALS FOR PRINT            
         MVC   JOBTOT,RTLNET                                                    
         LA    R6,RTLNET                                                        
         ZAP   SAVCD,JOBCD              CURRENT C.D.                            
         TM    BILLMODE,UNBILL          FOR UNBILLING                           
         BNO   *+14                                                             
         MVC   JOBCHG,RTLNET            REVERSE NET AMOUNT                      
         B     RTLR94                   SKIP TO AMOUNT DUE                      
*                                                                               
         TM    BILLTYPE,TOTAL+ESTIM     FOR TOTAL BILL OR %ESTIMATE             
         BNZ   *+12                                                             
         TM    RTLSTAT,RTLOLD           AND A NOW ZERO PCT RETAILER             
         BNO   RTLR90                                                           
         ZAP   SIGN,=P'-1'                                                      
         BAS   RE,PRVBIL                PRINT PREVIOUS BILLS                    
         CLI   ANYBILLS,C'Y'                                                    
         BNE   RTLR94                                                           
         MVI   P+1,C'*'                                                         
         MVC   P+2(L'AC@PRVBS),AC@PRVBS                                         
         MVI   P+2+L'AC@PRVBS,C'*'                                              
         MVI   MYSPACE,1                                                        
         MVC   TEMPWK,DSTRBILL          PRINT TOTAL PREVIOUS                    
         GOTO1 SHR,DMCB,('SUBRFORM',(RC))                                       
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
         TM    RTLSTAT,RTLOLD           FOR OLD RETAILERS                       
         BZ    RTLR94                   MAKE OLD BILLS LOOK LIKE                
         MVC   JOBCHG,RTLPRV            NEGATIVE CHARGES                        
         B     RTLR92                   THEN THE DUE LINE                       
*                                                                               
RTLR90   TM    BILLTYPE,PROG                                                    
         BNO   RTLR92                                                           
         GOTO1 PRNT,DMCB,('PRNTDUE',(RC))   AMOUNT DUE LINE                     
         CLI   PREVOPT,C'Y'             SUPPRESS PREVIOUS BILLS                 
         BE    RTLR96                                                           
         ZAP   SIGN,=P'1'               PREVIOUS BILLS AS POSITIVE              
         BAS   RE,PRVBIL                GET PREVIOUS BILLS                      
         CLI   ANYBILLS,C'Y'                                                    
         BNE   RTLR96                                                           
         MVC   P+1(L'AC@TJOB),AC@TJOB                                           
         LA    R4,RTLCHG                                                        
         LA    R6,DSTRBILL              ADD CHARGES TO BILLS                    
         BAS   R9,ADDAMTS                                                       
         MVC   TEMPWK,DSTRBILL          PRINT TOTAL                             
         GOTO1 SHR,DMCB,('SUBRFORM',(RC))                                       
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
         MVC   P+1(13),=C'* AMOUNT DUE *'                                       
         MVC   TEMPWK,RTLCHG            AND AMOUNT DUE LINE                     
         GOTO1 SHR,DMCB,('SUBRFORM',(RC))                                       
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
         B     RTLR96                                                           
*                                                                               
RTLR92   TM    BILLTYPE,SPECIAL                                                 
         BZ    RTLR94                                                           
         MVC   JOBDTL,RTLCHG                                                    
*                                                                               
RTLR94   GOTO1 PRNT,DMCB,('PRNTDUE',(RC))  AMOUNT DUE LINE                      
*                                                                               
RTLR96   GOTO1 PRNT,DMCB,('PRNTCOM',(RC)) PRINT JOB COMMENTS                    
         MVC   RECEIVBL,SAVRECV         RESTORE RECEIVABLE CODE                 
         MVC   COSTING,SAVCOST          RESTORE COSTING CODE                    
*                                                                               
RTLR98   LA    R5,RTLLNQ(R5)            NEXT DISTRIBUTOR                        
         XC    ARTLNAME,ARTLNAME        CLEAR A(RETAIL NAME)                    
         XC    ARTLADDR,ARTLADDR        AND ADDRESS                             
         CLI   0(R5),X'FF'                                                      
         BNE   RTLR74                                                           
         EJECT                                                                  
*                                                                               
*               MAKE POSTINGS FOR EACH ENTRY IN THE TABLE                       
*                                                                               
         L     R5,ADSTRB                                                        
         ZAP   SAVBNUM,BILLNO           SAVE CURRENT BILL NUMBER                
         MVC   SAVMED,JOBMED            SAVE MEDIA COSTS                        
         ZAP   SAVSKINC,SKINC           SAVE SK INCOME                          
         ZAP   PRVCD,=P'0'                                                      
*                                                                               
*                                       SPECIAL POSTINGS ZERO RETAILERS         
RTLR100  TM    RTLSTAT,RTLNBILL                                                 
         BO    RTLR102                  NOT BILLABLE                            
         PACK  BILLNO,RTLBIL+2(4)       THIS BILL NUMBER                        
         MVC   BILLREF,RTLBIL                                                   
         LA    R6,RTLNET                                                        
         ZAP   SAVCD,JOBCD              CURRENT C.D.                            
         LA    R6,RTLPRV                                                        
         ZAP   PRVCD,JOBCD              PREVIOUS C.D.                           
         ZAP   PL16,SAVSKINC                                                    
         MP    PL16,RTLPCT                                                      
         SRP   PL16,64-6,5                                                      
         ZAP   SKINC,PL16               SHARE OF SK INCOME                      
         MVC   JOBMED,SAVMED                                                    
         LA    R4,JOBMED                                                        
         BAS   R9,SHARE                 GET SHARE OF MEDIA COSTS                
         MVC   JOBTOT,RTLNET                                                    
         MVC   JOBCHG,RTLNET                                                    
         ST    R5,ARETAIL                                                       
         MVC   SAVRECV,RECEIVBL        SAVE RECEIVABLE CODE                     
         MVC   SAVCOST,COSTING         SAVE COSTING CODE                        
         CLI   RTLRECV,X'40'                                                    
         BNH   *+10                                                             
         MVC   RECEIVBL,RTLRECV        OVERRIDE RECEIVABLE                      
         CLI   RTLCOST,X'40'                                                    
         BNH   *+10                                                             
         MVC   COSTING,RTLCOST         OVERRIDE COSTING                         
         GOTO1 POST,DMCB,('POSTBILL',(RC))       DO THE POSTINGS                
         MVC   RECEIVBL,SAVRECV         RESTORE RECEIVABLE CODE                 
         MVC   COSTING,SAVCOST          RESTORE COSTING CODE                    
*                                                                               
RTLR102  LA    R5,RTLLNQ(R5)                                                    
         CLI   0(R5),X'FF'                                                      
         BNE   RTLR100                                                          
         MVC   BILLNO,SAVBNUM           RESTORE NUMBER                          
         ZAP   SKINC,SAVSKINC           RESTORE SK INCOME                       
         MVC   JOBMED,SAVMED            RESTORE MEDIA COSTS                     
         MVC   KEY,SPACES               RE-READ LASTIO MONACC IO                
         L     R3,LASTIO                TO RE-SET MONACC SEQUENCE               
         MVC   KEY(15),0(R3)                                                    
         BAS   R9,RTLHIGH                                                       
         B     RTLRXIT                                                          
         EJECT                                                                  
*              GET PREVIOUS BILLING                                             
*                                                                               
PRVBIL   NTR1                                                                   
         MVC   DSTRBILL,ZEROS           CLEAR BILL TOTALS                       
         MVI   ANYBILLS,C'N'                                                    
         LA    R3,KEY                                                           
         USING TRNRECD,R3                                                       
         MVC   KEY,SPACES                                                       
         MVC   TRNKCULA,JOBCODE         BUILD KEY FOR 99 BILLING                
         MVC   TRNKWORK,=C'99'                                                  
         MVC   TRNKCULC,RTLDIS          BY DISTRIBUTOR                          
         BAS   R9,RTLHIGH                                                       
         CLC   KEY,KEYSAVE                                                      
         BNE   RTLRXIT                  NO BILLING                              
         MVC   MID1+1(L'AC@PRVBS),AC@PRVBS                                      
         MVI   MID2+1,C'-'                                                      
         MVC   MID2+2(13),MID2+1                                                
         MVI   FORCEMID,C'Y'                                                    
*                                                                               
PRVB02   LA    R3,IOAREA                                                        
         LA    R2,TRNRECD+ACCORFST                                              
         CLI   0(R2),X'44'                                                      
         BNE   PRVB10                                                           
         USING TRNELD,R2                                                        
         MVI   ANYBILLS,C'Y'                                                    
         LA    R3,DSTRBILL              ADD TO DISTRIBUTOR TOTAL                
         BAS   R9,ADDRBILL              ADD PREV. BILLS                         
         CLI   RTLMODE,0                                                        
         BE    PRVB10                   NOT PRINTING THIS TIME                  
*                                                                               
         MVC   TEMPWK,BILLDTL           BILLING AMOUNTS                         
         GOTO1 SHR,DMCB,('SUBRFORM',(RC))   FORMATED                            
         MVC   P+1(15),TRNNARR          BILL TYPE                               
         LA    R1,P+1                                                           
         LA    R3,10                                                            
*                                                                               
PRVB04   CLC   0(6,R1),=C'PC EST'                                               
         BE    PRVB06                                                           
         LA    R1,1(R1)                                                         
         BCT   R3,PRVB04                                                        
         B     PRVB08                                                           
*                                                                               
PRVB06   MVC   0(L'AC@PCTOE,R1),AC@PCTOE                                        
*                                                                               
PRVB08   MVC   PSECOND+12(6),TRNREF     INVOICE NUMBER  AND DATE                
         GOTO1 DATCON,DMCB,(1,TRNDATE),(8,PSECOND+1)                            
         MVI   MYSPACE,1                                                        
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
*                                                                               
PRVB10   BAS   R9,RTLSEQ                                                        
         CLC   KEY,KEYSAVE              SAME JOB AND DISTRIBUTOR                
         BE    PRVB02                                                           
         MVC   MID1,SPACES                                                      
         MVC   MID2,SPACES                                                      
         MVI   FORCEMID,C'N'                                                    
         B     RTLRXIT                                                          
         EJECT                                                                  
*              ADD/SUBTRACT  A BILLING RECORD TO ACCUMS                         
*                                                                               
         USING TRNELD,R2                                                        
         USING JOBD,R6                                                          
ADDRBILL DS    0H                                                               
         LR    R4,R2                                                            
         TM    BILLMODE,UNBILL         FOR UNBILLING                            
         BZ    *+10                                                             
         ZAP   SIGN,=P'-1'             REVERVSE THE SIGN                        
         LA    R6,BILLDTL                                                       
         MVC   BILLDTL,ZEROS           INITIALIZE DETAIL                        
         MVC   SAVTRND,TRNDATE                                                  
         ZAP   DUB,TRNAMNT                                                      
         MP    DUB,SIGN                                                         
         AP    JOBNET,DUB              ADD NET TO NET                           
         AP    JOBGRS,DUB                         GROSS                         
*                                                                               
         AP    JOBVNET,DUB                        GST NET                       
         AP    JOBVGRS,DUB                        GST GROSS                     
*                                                                               
         AP    JOBPNET,DUB                        PST NET                       
         AP    JOBPGRS,DUB                        PST GROSS                     
*                                                                               
         CLI   TRNLN,121                                                        
         BNE   ADDR02                                                           
         ZAP   DUB,TRNBLCOM                                                     
         MP    DUB,SIGN                                                         
         AP    JOBCOMM,DUB             COMMISSION TO COMMISSION                 
         AP    JOBGRS,DUB                            GROSS                      
         AP    JOBVGRS,DUB                           GST GROSS                  
         AP    JOBPGRS,DUB                           PST GROSS                  
*                                                                               
         OC    TRNBINTI,TRNBINTI   ANYTHING THERE?                              
         BZ    ADDR02              MAKE SURE BEFORE ADDING                      
         ZAP   DUB,TRNBINTI        INTERNAL INCOME                              
         MP    DUB,SIGN                                                         
         AP    JOBINT,DUB                                                       
*                                                                               
ADDR02   MVI   ELCODE,VBIELQ                                                    
         BAS   RE,NEXTEL5                                                       
         BNE   ADDR04                                                           
         USING VBIEL,R4                                                         
         ZAP   DUB,VBIVAT                                                       
         ZAP   SAVGST,VBIVAT                                                    
         MP    DUB,SIGN                                                         
         ZAP   DUB1,VBIGROSS                                                    
         MP    DUB1,SIGN                                                        
         AP    JOBGST,DUB          ADD TO JOBVAT                                
         AP    JOBVNET,DUB                GST NET                               
         AP    JOBVGRS,DUB                GST GROSS                             
         AP    JOBVBAS,DUB1                                                     
         SP    JOBVBAS,DUB                                                      
*                                                                               
         ZAP   JOBPGRS,JOBVGRS                                                  
         ZAP   JOBPNET,JOBVNET                                                  
         B     ADDR02              GET MORE IF THERE                            
*                                                                               
ADDR04   LR    R4,R2                                                            
*                                                                               
         USING PBIEL,R4                                                         
ADDR06   MVI   ELCODE,PBIELQ                                                    
         BAS   RE,NEXTEL5                                                       
         BNE   ADDR10                                                           
         ZAP   DUB,PBIPST                                                       
         MP    DUB,SIGN                                                         
         ZAP   DUB1,PBIGROSS                                                    
         MP    DUB1,SIGN                                                        
         AP    JOBPST,DUB          ADD TO JOBPST                                
         AP    JOBPNET,DUB                PST NET                               
         AP    JOBPGRS,DUB                PST GROSS                             
         AP    JOBPBAS,DUB1                                                     
         SP    JOBPBAS,DUB                                                      
*                                                                               
         CLC   PBIPRV,=C'PQ'                                                    
         BNE   ADDR06                                                           
*                                                                               
         LA    R1,SAVTRND                                                       
         TM    BILLMODE,UNBILL     ARE WE UNBILLING ?                           
         BZ    *+8                 NO, USE BILL DATE                            
         LA    R1,CALLDATE         YES, USE UNBILL DATE                         
         CLC   0(3,R1),=X'B30101'  SEE IF 2013                                  
         BL    ADDR06                                                           
         SP    JOBPBAS,SAVGST                                                   
         B     ADDR06              GET MORE IF THERE                            
*                                                                               
ADDR10   LA    R0,JOBBKCNT             ADD TO DISTRIBUTOR TOTAL                 
         AP    0(L'JOBNET,R3),0(L'JOBNET,R6)                                    
         LA    R3,L'JOBNET(,R3)                                                 
         LA    R6,L'JOBNET(,R6)                                                 
         BCT   R0,*-14                                                          
         BR    R9                                                               
         DROP  R4,R6                                                            
         EJECT ,                                                                
*                                                                               
         USING JOBD,R4                                                          
*                                                                               
SHARE    LA    R0,5                SHARE OF NET/COMM/GST/PST/INT                
         ST    R4,SAVER4           SAVE R4                                      
*                                                                               
SHAR02   ZAP   PL16,0(L'JOBNET,R4) AMOUNT                                       
         MP    PL16,RTLPCT         TIMES PCT                                    
         SRP   PL16,64-6,5         ROUNDED                                      
         ZAP   0(L'JOBNET,R4),PL16 THIS DISTRIBUTOR AMOUNT                      
         LA    R4,L'JOBNET(,R4)                                                 
         BCT   R0,SHAR02                                                        
*                                                                               
         LA    R4,JOBMED           ->   MEDIA CHARGES                           
         C     R4,SAVER4           IF   MEDIA CHARGES,                          
         BE    SHAREEX                  THEN  SKIP                              
         TM    RTLOPT,RTLSCOMM     SPECIAL COMMISSION RATE SOMEWHERE?           
         BZ    SHAREEX             NO,  SKIP                                    
         L     R4,SAVER4           RESTORE R4                                   
         ZAP   JOBCOMM,RTLCMTOT    GET  COMMISSION TOTAL                        
*                                                                               
SHAREEX  BR    R9                                                               
*                                                                               
         DROP  R4                                                               
         EJECT ,                                                                
*                                                                               
*                                                                               
ADDAMTS  LA    R0,JOBBKCNT              ADD ACCUMS R4 TO R6                     
*                                                                               
ADDA02   AP    0(L'JOBNET,R6),0(L'JOBNET,R4)                                    
         LA    R6,L'JOBNET(,R6)                                                 
         LA    R4,L'JOBNET(,R4)                                                 
         BCT   R0,ADDA02                                                        
         BR    R9                                                               
         EJECT                                                                  
*               CASH DISCOUNT AND TOTAL CHARGES                                 
*                                                                               
TOTLNE   NTR1                                                                   
         TM    BILLTYPE,ONELNE                                                  
         BZ    TOTL02                                                           
         CLI   PROF17,C'Y'                                                      
         BE    TOTL08                                                           
*                                                                               
TOTL02   CP    SAVCD,=P'0'                                                      
         BE    TOTL06                                                           
         CLI   PROF9,C'G'               BILL GROSS DEDUCT CD(MEMO)              
         BE    TOTL06                                                           
         MVC   P+1(L'AC@CSHDS),AC@CSHDS                                         
         B     TOTL04                                                           
*                                                                               
TOTL04   DS    0H                                                               
         ZAP   DUB,SAVCD                                                        
         MP    DUB,=P'-1'                                                       
         CURED (P8,DUB),(11,P+73),2,MINUS=YES                                   
         CLI   QOPT5,C'Y'          OPTION TO SUPPRESS NET/COMMISSION            
         BE    TOTL05                                                           
         CLI   PROF4,C'Y'                                                       
         BE    TOTL05                                                           
         CURED (P8,DUB),(11,P+41),2,MINUS=YES                                   
*                                                                               
TOTL05   GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
*                                                                               
TOTL06   MVC   P+1(L'AC@TOTAL),AC@TOTAL                                         
         MVC   TEMPWK,TOTCHG            TOTAL CHARGES TO PRINT                  
         GOTO1 SHR,DMCB,('SUBRFORM',(RC))                                       
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
*                                                                               
TOTL08   MVC   P+1(L'AC@YSHRE),AC@YSHRE                                         
         CURED RTLPCT,(9,P+12),4,ALIGN=LEFT                                     
         LA    R4,P+13                                                          
         CLI   0(R4),C' '                                                       
         BE    *+12                                                             
         LA    R4,1(R4)                                                         
         B     *-12                                                             
         MVI   0(R4),C'%'                                                       
         CLI   RTLTYPE,C'P'              TYPE IS PERCENT                        
         BE    TOTL10                    NO NEED TO SHOW UNITS                  
         CP    RTLUNT,=P'0'                                                     
         BE    TOTL10                                                           
         LA    R4,2(R4)                  EDIT (XXXX UNITS)                      
         MVI   0(R4),C'('                                                       
         CURED RTLUNT,(10,1(R4)),2,ALIGN=LEFT                                   
         CLI   0(R4),C' '                                                       
         BE    *+12                                                             
         LA    R4,1(R4)                                                         
         B     *-12                                                             
         MVC   1(L'AC@UNITS,R4),AC@UNITS                                        
         MVI   1+L'AC@UNITS(R4),C')'                                            
*                                                                               
TOTL10   MVC   TEMPWK,RTLCHG             RETAIL SHARE TO PRINT                  
         GOTO1 SHR,DMCB,('SUBRFORM',(RC))                                       
         GOTO1 PRNT,DMCB,('PRNTALL',(RC))                                       
         B     RTLRXIT                                                          
         EJECT ,                                                                
*              GET MATCHING 62 ELEMENT                                          
*                                                                               
         USING DSCELD,R4                                                        
GETSCHM  MVI   ELCODE,X'62'                                                     
         BAS   RE,GETEL5                                                        
         BNER  R9                                                               
*                                                                               
GETS02   CLC   DSCCODE,SCHEME     FIND 62 ELEMENT WITH PROPER SCHEME            
         BNE   GETS04                                                           
         CP    DSCVAL,=P'0'       IGNORE ZERO ALLOCATION                        
         BE    GETS04                                                           
         CR    RB,RB                                                            
         BR    R9                                                               
*                                                                               
GETS04   BAS   RE,NEXTEL5                                                       
         BNER  R9                                                               
         B     GETS02                                                           
         EJECT                                                                  
*              GET RECEIVABLE ELEMENT                                           
         USING RBRELD,R4                                                        
GETRECV  LA    R4,IOAREA                                                        
         MVI   ELCODE,X'2B'                                                     
         BAS   RE,GETEL5                                                        
         BNER  R9                                                               
         CLI   RBRRECB,X'40'      NO RECEIVABLE                                 
         BNH   GETREC2                                                          
         MVC   0(1,R1),RCCOMPFL                                                 
         MVC   1(14,R1),RBRRECB  BUILD RECEIVABLE ENTRY                         
*                                                                               
GETREC2  CLI   RBRCOST,X'40'      NO COST                                       
         BNHR  R9                                                               
         MVC   15(1,R1),RCCOMPFL                                                
         MVC   16(14,R1),RBRCOST  BUILD COST ENTRY                              
         BR    R9                                                               
         EJECT ,                                                                
*              GET MATCHING FREE FORM ELEMENT                                   
*                                                                               
         USING FFTELD,R4           MAP  FREE FORM ELEMENT                       
GETFFTYP MVI   ELCODE,FFTELQ       X'DB'     ELEMENT                            
         BAS   RE,GETEL5           GET  ELEMENT                                 
         BNER  R9                  NONE,     RETURN                             
*                                                                               
GETFFT02 CLC   FFTTYPE,FREETYPE    FIND DB   EL   WITH PROPER TYPE              
         BNE   GETFFT04                                                         
         CR    RB,RB               SET  CONDITION CODE TO   EQUAL               
         BR    R9                  RETURN    TO   CALLER                        
*                                                                               
GETFFT04 BAS   RE,NEXTEL5          GET  NEXT ELEMENT                            
         BNER  R9                  NONE,     RETURN                             
         B     GETFFT02            CHECK     THE  ELEMENT                       
         EJECT ,                                                                
*              GET NAME ELEMENT                                                 
         USING NAMELD,R4                                                        
GETNME   MVC   0(36,R3),SPACES                                                  
         LA    R4,IOAREA                                                        
         MVI   ELCODE,X'20'                                                     
         BAS   RE,GETEL5                                                        
         BE    *+6                                                              
         DC    H'0'                                                             
         SR    R1,R1                                                            
         IC    R1,NAMLN                                                         
         SH    R1,=H'3'                                                         
         EX    R1,*+6                                                           
         BR    R9                                                               
         MVC   0(0,R3),NAMEREC                                                  
         EJECT                                                                  
*              GET ADDRESS ELEMENT                                              
         USING ADRELD,R4                                                        
GETADDR  MVC   0(4*L'ADRADD1,R3),SPACES                                         
         LA    R4,IOAREA                                                        
         MVI   ELCODE,X'22'                                                     
         BAS   RE,GETEL5                                                        
         BNER  R9                                                               
         SR    R0,R0                                                            
         IC    R0,ADRNUM                                                        
         LA    R4,ADRADD1                                                       
         MVC   0(L'ADRADD1,R3),0(R4)                                            
         LA    R3,L'ADRADD1(R3)                                                 
         LA    R4,L'ADRADD1(R4)                                                 
         BCT   R0,*-14                                                          
         BR    R9                                                               
         EJECT                                                                  
*        DATAMGR ROUTINES                                                       
*                                                                               
RTLHIGH  MVC   COMMAND,DMRDHI                                                   
         MVC   KEYSAVE,KEY                                                      
         B     RTLDMR                                                           
*                                                                               
RTLSEQ   MVC   COMMAND,DMRSEQ                                                   
         B     RTLDMR                                                           
*                                                                               
RTLREAD  MVC   COMMAND,DMREAD                                                   
*                                                                               
RTLDMR   MVC   IOAREA(ACCORLEN),SPACES                                          
         MVC   IOAREA(L'KEY),KEY                                                
         GOTO1 DATAMGR,DMCB,COMMAND,FILNME,IOAREA,IOAREA                        
         MVC   KEY,IOAREA                                                       
         BR    R9                                                               
         SPACE 3                                                                
         GETELN R4,DATADISP,ELCODE,5                                            
         EJECT ,                                                                
         LTORG                                                                  
*                                                                               
         DROP  RA,RB                                                            
         EJECT ,                                                                
APRNTAB  DC    A(PRNTAB)                                                        
ANXTPRT  DC    A(PRNTAB)                                                        
*                                                                               
DSTRBILL DS    CL(JOBLNQ)               DISTRIBUTOR PREVIOUS BILLS              
BILLDTL  DS    CL(JOBLNQ)               BILL DETAIL                             
POSTOT   DS    CL(JOBLNQ)               TOTAL POSTING FOR ACTIVE                
BILLTOT  DS    CL(JOBLNQ)               TOTAL PREVIOUS BILLS                    
*                                                                               
LEVARECV DS    CL30                     LEVEL A REC'V & COST ACCOUNTS           
LEVBRECV DS    CL30                     LEVEL B REC'V & COST ACCOUNTS           
LEVCRECV DS    CL30                     LEVEL C REC'V & COST ACCOUNTS           
LEVDRECV DS    CL30                     LEVEL D REC'V & COST ACCOUNTS           
*                                                                               
SVHEIR   DS    CL66                     HEIRARCHY ELEMENT                       
SAVBILL  DS    CL42                                                             
SAVBNUM  DS    PL4                      SAVE BILL NUMBER                        
SAVMED   DS    CL(JOBLNQ)               SAVE MEDIA COSTS                        
SAVSKINC DS    PL6                      SAVE SK INCOME                          
SAVRECV  DS    CL15                     SAVED RECEIVABLE CODE                   
SAVCOST  DS    CL15                     SAVED COST CODE                         
*                                                                               
RTLJOBFL DC    CL15' '                  FILTER BY JOB                           
RTLTYPE  DC    X'00'                    P=100%                                  
TOTUNITS DC    PL6'0'                   TOTAL SCHEME UNITS                      
PL16     DC    PL16'0'                                                          
SIGN     DC    PL1'1'                                                           
ANYBILLS DS    CL1                                                              
ACCLVL   DS    CL1                      LEVEL OF CURRENT RECORD                 
*                                                                               
SVRTLACT DC    CL15' '                  SAVE RETAIL COMMISSION ACCOUNT          
SVRTLCOM DC    PL6'0'                   SAVE RETAIL COMMISSION RATE             
*                                                                               
IOAREA   DS    CL2000                                                           
*                                                                               
*                                  TABLE OF PRINT LINES                         
PRNTAB   DS    0D                                                               
         DS    2500CL132                                                        
         TITLE 'AC21 - PRODUCTION BILLING - SHARED SUBROUTINES'                 
SHRR     DS    0D                                                               
         NMOD1 0,*SHRR*                                                         
         L     RC,0(,R1)                                                        
         MVC   SUBRMODE,0(R1)                                                   
         CLI   SUBRMODE,SUBRMED    01                                           
         BE    GETMEL                                                           
         CLI   SUBRMODE,SUBRCOST   02                                           
         BE    GTMDVAL                                                          
         CLI   SUBRMODE,SUBRSUML   03                                           
         BE    SUMLIN                                                           
         CLI   SUBRMODE,SUBRBIN    04                                           
         BE    BINADD                                                           
         CLI   SUBRMODE,SUBRNAM    05                                           
         BE    NAMOUT                                                           
         CLI   SUBRMODE,SUBRFORM   06                                           
         BE    FORMAT                                                           
         CLI   SUBRMODE,SUBRTOT    07                                           
         BE    FORMTOT                                                          
         CLI   SUBRMODE,SUBRSUM    08                                           
         BE    FORMSUM                                                          
         CLI   SUBRMODE,SUBRREG    09                                           
         BE    FORMREG                                                          
         CLI   SUBRMODE,SUBRSHR    10                                           
         BE    GETSHR                                                           
         CLI   SUBRMODE,SUBRCCOM   11 CALCULATE RETAIL COMMISSION               
         BE    CALCCOMM                                                         
         CLI   SUBRMODE,SUBRPOB    12 PERCENT OF BILLING                        
         BE    CALCPOB                                                          
SHRX     XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
*              ROUTINE TO FIND MEDIA ELEMENT                          *         
***********************************************************************         
*                                                                               
GETMEL   L     R2,ADCOMP                                                        
         AH    R2,DATADISP                                                      
*                                                                               
GETM02   CLI   0(R2),0                                                          
         BNE   *+6                                                              
         DC    H'0'                MISSING MEDIA ELEMENT                        
         CLI   0(R2),X'11'                                                      
         BE    GETM06                                                           
*                                                                               
GETM04   ZIC   R0,1(R2)                                                         
         AR    R2,R0                                                            
         B     GETM02                                                           
*                                                                               
         USING PMDELD,R2                                                        
GETM06   CLC   PMDCODE,MEDIA                                                    
         BNE   GETM04              NO MATCH LOOK FOR NEXT                       
         ST    R2,AMEL             SAVE ADDRESS OF ELEMENT                      
         B     SHRX                                                             
         EJECT                                                                  
***********************************************************************         
*              GET MEDIA ELEMENT - COSTING/INCOME ACCOUNTS            *         
***********************************************************************         
*                                                                               
GTMDVAL  DS    0D                                                               
         MVC   MEDIA,JOBLET                                                     
         GOTO1 SHR,DMCB,('SUBRMED',(RC))   GET MEDIA ELEMENT                    
         L     R2,AMEL                                                          
*                                                                               
         USING PMDELD,R2                                                        
         MVC   MEDNAME,PMDSPACE                                                 
         CLI   MODE,PROCACC                                                     
         BNE   GTMDXIT                                                          
         MVC   SUSPAC,SPACES                                                    
         MVC   SUSPAC(1),QCOMPANY                                               
         MVC   SUSPAC+1(3),=C'123' START WITH ACCOUNT CODE 3                    
*                                                                               
         MVC   PRCDACCT,SPACES                                                  
         MVC   PRCDACCT(1),QCOMPANY                                             
         MVC   PRCDACCT+1(4),=C'SIMP'                                           
*                                                                               
         MVC   CDACCT,SPACES                                                    
         MVC   CDACCT(1),QCOMPANY                                               
         MVC   CDACCT+1(4),=C'SIMD'                                             
*                                                                               
         CLI   PMDANAL,X'41'      ANY OVERRIDE ?                                
         BL    *+10                NO                                           
         MVC   SUSPAC+3(1),PMDANAL                                              
         CLI   PMDLN,PMDLN2Q    IS THIS A NEW ELEMENT ?                         
         BL    GTMD02              NO                                           
         CLI   PMDCOST,X'41'      YES, ANY COST ANALYSIS ACCOUNT ?              
         BL    *+10                NO                                           
         MVC   SUSPAC+3(L'PMDCOST),PMDCOST                                      
*                                                                               
         CLI   PMDPRCD,X'41'      YES, ANY PRINT CD ACCOUNT ?                   
         BL    *+10                NO                                           
         MVC   PRCDACCT,PMDPRCD   YES, SAVE IT                                  
*                                                                               
GTMD02   CLI   PMDCSHD,X'41'      YES, ANY CD ACCOUNT ?                         
         BL    *+10                NO                                           
         MVC   CDACCT,PMDCSHD     YES, SAVE IT                                  
         OC    COMMAC,COMMAC       DID WE GET INCOME ACCT FROM GETOPT?          
         BNZ   *+10                YES, USE IT                                  
         MVC   COMMAC,PMDCOM1     NO, GET IT FROM MEDIA                         
         NI    BILLOPT,ALL-MEDIANM                                              
         CLI   PMDLN,X'46'                                                      
         BL    GTMD04                                                           
         TM    PMDSTAT,X'80'                                                    
         BZ    GTMD04                                                           
         OI    BILLOPT,MEDIANM                                                  
*                                                                               
GTMD04   DS    0H                                                               
         L     R4,AIO2               READ INCOME ACCOUNT                        
         MVC   0(42,R4),SPACES                                                  
         MVC   0(15,R4),COMMAC                                                  
*                                                                               
         GOTO1 DATAMGR,DMCB,DMREAD,FILNME,(R4),(R4)                             
         CLC   0(15,R4),COMMAC                                                  
         BNE   GTMD12                                                           
         LR    RF,R4                                                            
         AH    RF,DATADISP                                                      
*                                                                               
GTMD06   CLI   0(RF),0                                                          
         BE    GTMD12                                                           
         CLI   0(RF),RSTELQ       GET STATUS ELEMENT                            
         BE    GTMD08                                                           
         CLI   0(RF),SPAELQ       GET SPECIAL POSTING ELEMENT                   
         BE    GTMD11                                                           
*                                                                               
GTMD07   ZIC   R4,1(RF)                                                         
         AR    RF,R4                                                            
         B     GTMD06                                                           
*                                                                               
         USING RSTELD,RF                                                        
GTMD08   OC    RSTCCTR,SPACES                                                   
         CLI   RSTCCTRR,0          IF ZERO START AT COSTING+7                   
         BE    *+20                                                             
         LA    R4,COSTING+2                                                     
         ZIC   R0,RSTCCTRR         INSERT STARTING POINT NUMBER                 
         AR    R4,R0               POINT TO NEW STARTING POINT                  
         B     *+8                                                              
         LA    R4,COSTING+7        COSTING ACCOUNT                              
         LA    R3,3                                                             
         LA    R5,RSTCCTR                                                       
*                                                                               
GTMD10   CLI   0(R5),C' '                                                       
         BE    *+10                                                             
         MVC   0(1,R4),0(R5)       REPLACE OVERRIDES IN COSTING KEY             
         LA    R5,1(R5)                                                         
         LA    R4,1(R4)                                                         
         BCT   R3,GTMD10                                                        
         B     GTMD07                                                           
*                                                                               
         USING SPAELD,RF                                                        
GTMD11   CLI   SPATYPE,SPATANAL     LOOK FOR ANALYSIS POINTER                   
         BNE   GTMD07                                                           
         MVC   SUSPAC+3(L'SPAAULA-2),SPAAULA                                    
         B     GTMD07                                                           
*                                                                               
GTMD12   L     R4,AIO2          READ ACCOUNT KEY                                
         MVC   0(42,R4),SPACES                                                  
         L     R2,ADACC                                                         
         MVC   0(15,R4),0(R2)                                                   
*                                                                               
GTMDXIT  B     SHRX                                                             
         EJECT                                                                  
***********************************************************************         
*              ADD DETAIL LINE TO HIGHER LEVELS                       *         
***********************************************************************         
*                                                                               
SUMLIN   DS    0D                                                               
         LA    R0,3                WORKCODE/CHARGES/ACCOUNT                     
         LA    R2,JOBWKC                                                        
*                                                                               
SUML02   LA    R1,JOBBKCNT                                                      
         LA    R6,JOBDTL                                                        
*                                                                               
SUML04   AP    0(L'JOBNET,R2),0(L'JOBNET,R6)                                    
         LA    R2,L'JOBNET(,R2)                                                 
         LA    R6,L'JOBNET(,R6)                                                 
         BCT   R1,SUML04           NUMBER OF BUCKETS                            
         BCT   R0,SUML02           NUMBER OF LEVELS                             
         B     SHRX                                                             
         EJECT                                                                  
***********************************************************************         
*              ROUTINE TO ADD TO A BINSRCH TABLE                      *         
*              PARAM1              A(RECORD TO BE ADDED)              *         
*              PARAM2              A(BINSRCH PARAMS)                  *         
***********************************************************************         
*                                                                               
         USING BIND,R5                                                          
BINADD   DS    0D                                                               
         L     R3,4(R1)            A(RECORD)                                    
         L     R5,8(R1)            BINSRCH PARAMETERS                           
         MVC   DMCB+8(16),BININ                                                 
         LA    R2,BINTABLE                                                      
         GOTO1 BINSRCH,DMCB,(1,(R3)),(R2)                                       
         OC    DMCB(4),DMCB                                                     
         BNZ   *+6                                                              
         DC    H'0'                TABLE IS FULL                                
         MVC   BININ,DMCB+8        UPDATE COUNT                                 
         CLI   DMCB,1                                                           
         BE    BINXIT              NOT FOUND - ADDED                            
         L     R4,DMCB             A(RECORD FOUND)                              
         ZIC   R6,BINFRST          DISP. TO FIRST BUCKET                        
         AR    R4,R6               RECORD FOUND                                 
         AR    R3,R6               NEW RECORD                                   
         ZIC   R0,BINNUMB          NUMBER OF BUCKETS                            
         TM    BINSTAT,X'80'                                                    
         BO    BINBIN              DATA IS BINARY                               
         AP    0(8,R4),0(8,R3)     ADD NEW TO OLD                               
         LA    R4,8(R4)                                                         
         LA    R3,8(R3)                                                         
         BCT   R0,*-14                                                          
         B     BINXIT                                                           
*                                                                               
BINBIN   L     RE,0(R3)                                                         
         L     RF,0(R4)                                                         
         AR    RF,RE                                                            
         ST    RF,0(R4)                                                         
         LA    R3,4(R3)                                                         
         LA    R4,4(R4)                                                         
         BCT   R0,BINBIN                                                        
*                                                                               
BINXIT   B     SHRX                                                             
         EJECT                                                                  
***********************************************************************         
*              EXTRACT NAME                                           *         
***********************************************************************         
*                                                                               
         USING NAMELD,R2                                                        
NAMOUT   DS    0D                                                               
         MVC   0(36,R3),SPACES                                                  
         AH    R2,DATADISP                                                      
         SR    RF,RF                                                            
*                                                                               
NAMO02   CLI   0(R2),0                                                          
         BE    NAMOXIT                                                          
         CLI   0(R2),X'20'                                                      
         BE    NAMO04                                                           
         IC    RF,1(R2)                                                         
         AR    R2,RF                                                            
         B     NAMO02                                                           
*                                                                               
NAMO04   IC    RF,NAMLN                                                         
         SH    RF,=H'3'                                                         
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R3),NAMEREC                                                  
*                                                                               
NAMOXIT  B     SHRX                                                             
         EJECT ,                                                                
***********************************************************************         
*              FORMAT A LINE OF ACCUMULATORS                          *         
***********************************************************************         
*                                                                               
         USING JOBD,R6                                                          
*                                                                               
FORMAT   DS    0D                                                               
         LA    R6,TEMPWK                                                        
         NI    BILLOPT,ALL-CREDIT                                               
         TM    CLIOPT,PAYNET                                                    
         BZ    FORM02                                                           
         CP    0(L'JOBNET,R6),=P'0'                                             
         BNL   FORM02                                                           
         OI    BILLOPT,CREDIT                                                   
*                                                                               
FORM02   LA    R3,P+39                                                          
         LA    R4,JOBNET                                                        
         BAS   RE,FORM08                                                        
*                                                                               
         LA    R3,P+55                                                          
         LA    R4,JOBCOMM                                                       
         BAS   RE,FORM08                                                        
*                                                                               
         LA    R3,P+71                                                          
         LA    R4,JOBGRS                                                        
         TM    CLIOPT,PAYNET                                                    
         BO    FORM04                                                           
         CP    JOBGRS,=P'0'                                                     
         BNL   *+8                                                              
         OI    BILLOPT,CREDIT                                                   
*                                                                               
FORM04   BAS   RE,FORM08                                                        
         CLI   QOPT5,C'Y'          OPTION TO SUPPRESS NET/COMMISSION            
         BE    FORM06                                                           
         CLI   PROF4,C'Y'                                                       
         BNE   FORMXIT                                                          
*                                                                               
FORM06   MVC   P+39(30),SPACES                                                  
         B     FORMXIT                                                          
*                                                                               
FORM08   ST    RE,SAVERE                                                        
         CP    0(L'JOBNET,R4),=P'0'                                             
         BER   RE                                                               
         CURED (P8,0(R4)),(13,0(R3)),2,MINUS=YES                                
         ORG   *-2                                                              
         CP    0(8,R4),=P'-99999999'                                            
         BL    FORM08A             NO COMMAS IF A MILLION OR MORE               
         CP    0(8,R4),=P'99999999'                                             
         BH    FORM08A                                                          
         CLI   PROF25,C'Y'         PRINTING COMMAS?                             
         BNE   *+8                 NO                                           
         OI    CURPEDT1-CURPARMD(R1),CURPCOMY                                   
*                                                                               
FORM08A  BASR  RE,RF                                                            
         L     RE,SAVERE                                                        
         BR    RE                                                               
*                                                                               
FORM10   ST    RE,SAVERE                                                        
         CP    0(L'JOBNET,R4),=P'0'                                             
         BER   RE                                                               
         CURED (P8,0(R4)),(13,0(R3)),2,MINUS=YES,ALIGN=LEFT                     
         ORG   *-2                                                              
         CP    0(8,R4),=P'-99999999'                                            
         BL    FORM10A             NO COMMAS IF A MILLION OR MORE               
         CP    0(8,R4),=P'99999999'                                             
         BH    FORM10A                                                          
         CLI   PROF25,C'Y'         PRINTING COMMAS?                             
         BNE   *+8                 NO                                           
         OI    CURPEDT1-CURPARMD(R1),CURPCOMY                                   
*                                                                               
FORM10A  BASR  RE,RF                                                            
         L     RE,SAVERE                                                        
         BR    RE                                                               
*                                                                               
FORMXIT  B     SHRX                                                             
         DROP  R6                                                               
         EJECT                                                                  
***********************************************************************         
*              FORMAT A LINE OF TOTALS INCLUDING GST & PST            *         
***********************************************************************         
*                                                                               
FORMTOT  DS    0D                                                               
         USING JOBD,R6                                                          
         LA    R6,TEMPWK                                                        
         NI    BILLOPT,ALL-CREDIT                                               
         TM    CLIOPT,PAYNET                                                    
         BZ    FORMT02                                                          
         CP    0(L'JOBPNET,R6),=P'0'                                            
         BNL   FORMT02                                                          
         OI    BILLOPT,CREDIT                                                   
*                                                                               
FORMT02  LA    R3,P+39                                                          
         LA    R4,JOBPNET                                                       
         BAS   RE,FORM08                                                        
*                                                                               
         LA    R3,P+55                                                          
         LA    R4,JOBCOMM                                                       
         BAS   RE,FORM08                                                        
*                                                                               
         LA    R3,P+71                                                          
         LA    R4,JOBPGRS                                                       
         BAS   RE,FORM08                                                        
         TM    CLIOPT,PAYNET                                                    
         BO    FORMT04                                                          
         CP    JOBPGRS,=P'0'                                                    
         BNL   FORMT04                                                          
         OI    BILLOPT,CREDIT                                                   
*                                                                               
FORMT04  CLI   QOPT5,C'Y'          OPTION TO SUPPRESS NET/COMMISSION            
         BE    FORMT06                                                          
         CLI   PROF4,C'Y'                                                       
         BNE   FORMXIT                                                          
*                                                                               
FORMT06  MVC   P+39(30),SPACES                                                  
         B     FORMXIT                                                          
         DROP  R6                                                               
         EJECT                                                                  
***********************************************************************         
*              FORMAT A LINE OF DATA FOR SUMMARIES                    *         
***********************************************************************         
*                                                                               
FORMSUM  DS    0D                                                               
         USING JOBD,R6                                                          
         LA    R6,TEMPWK                                                        
         NI    BILLOPT,ALL-CREDIT                                               
         TM    CLIOPT,PAYNET                                                    
         BZ    FORMS02                                                          
         CP    0(L'JOBNET,R6),=P'0'                                             
         BNL   FORMS02                                                          
         OI    BILLOPT,CREDIT                                                   
*                                                                               
FORMS02  LA    R3,P+39                                                          
         LA    R4,JOBNET           NET AMOUNT (EXCLUDING GST & PST)             
         BAS   RE,FORM08                                                        
*                                                                               
         LA    R3,P+55                                                          
         LA    R4,JOBCOMM          COMMISSION AMOUNT                            
         BAS   RE,FORM08                                                        
*                                                                               
         LA    R3,P+71                                                          
         LA    R4,JOBPGRS          GROSS AMOUNT (INCLUDING GST & PST)           
         TM    CLIOPT,PAYNET                                                    
         BO    FORMS04                                                          
         CP    JOBPGRS,=P'0'                                                    
         BNL   *+8                                                              
         OI    BILLOPT,CREDIT                                                   
*                                                                               
FORMS04  BAS   RE,FORM08                                                        
         TM    RUNOPT,NEEDGST      ARE WE DOING GST LOGIC?                      
         BZ    FORMS06             NO                                           
         LA    R3,P+85                                                          
         LA    R4,JOBGST           GST AMOUNT                                   
         BAS   RE,FORM08                                                        
*                                                                               
         TM    RUNOPT,NEEDPST      ARE WE DOING PST LOGIC?                      
         BZ    FORMS06             NO                                           
         LA    R3,PSECOND+88                                                    
         LA    R4,JOBPST           PST AMOUNT                                   
         BAS   RE,FORM08                                                        
*                                                                               
FORMS06  CLI   QOPT5,C'Y'          OPTION TO SUPPRESS NET/COMMISSION            
         BE    FORMS08                                                          
         CLI   PROF4,C'Y'                                                       
         BNE   FORMXIT                                                          
*                                                                               
FORMS08  MVC   P+39(30),SPACES                                                  
         B     FORMXIT                                                          
         DROP  R6                                                               
         EJECT                                                                  
***********************************************************************         
*              FORMAT A LINE FOR THE BILLING INVOICE REGISTER         *         
***********************************************************************         
*                                                                               
         USING JOBD,R6                                                          
         USING ACPROFSD,R5                                                      
FORMREG  DS    0D                                                               
         LA    R6,TEMPWK                                                        
         L     R5,APROFILE                                                      
         LA    R3,P+39                                                          
         LA    R4,JOBPGRS          GROSS AMOUNT (INCLUDING GST & PST)           
         BAS   RE,FORM08                                                        
*                                                                               
         LA    R3,P+55                                                          
         LA    R4,JOBNET           NET AMOUNT (EXCLUDING GST & PST)             
         BAS   RE,FORM08                                                        
*                                                                               
         LA    R3,P+70                                                          
         LA    R4,JOBCOMM          COMMISSION                                   
         BAS   RE,FORM08                                                        
*                                                                               
         ZAP   DOUBLE,JOBPGRS      GROSS                                        
         CLI   PROF9,C'Y'          C.D. ALREADY IN GROSS COLUMN                 
         BE    *+10                                                             
         AP    DOUBLE,JOBCD                                                     
         LA    R3,P+83                                                          
         LA    R4,DOUBLE                                                        
         CP    DOUBLE,=P'0'                                                     
         BNE   *+10                                                             
         MVC   P+89(L'AC@NIL),AC@NIL                                            
         BAS   RE,FORM08                                                        
*                                                                               
         CLI   ACPPFC19,C'Y'       PRINT GST INSTEAD OF CD ?                    
         BNE   FORMR02             NO                                           
         LA    R3,P+97             YES                                          
         LA    R4,JOBGST           GST AMOUNT                                   
         BAS   RE,FORM08                                                        
*                                                                               
         LA    R3,PSECOND+100      DO PST ALSO                                  
         LA    R4,JOBPST           PST AMOUNT                                   
         BAS   RE,FORM08                                                        
         B     FORMR04                                                          
*                                                                               
FORMR02  CLI   QOPT5,C'Y'          SUPPRESS NET AND COMMISSION?                 
         BE    FORMR03             YES                                          
         CLI   PROF4,C'Y'                                                       
         BE    FORMR03                                                          
*                                                                               
         LA    R3,P+97                                                          
         LA    R4,JOBCD            CASH DISCOUNT                                
         CP    JOBCD,=P'0'                                                      
         BE    *+8                                                              
         BAS   RE,FORM08                                                        
*                                                                               
FORMR03  CLI   ACPPFC20,C'Y'       PRINT GST AS SECOND LINE ?                   
         BNE   FORMR04             NO                                           
         CP    JOBGST,=P'0'        DO WE HAVE ANY GST ?                         
         BE    FORMR04             NO, SKIP IT                                  
         MVC   PSECOND+70(L'AC@VAT1),AC@VAT1                                    
         MVI   PSECOND+70+L'AC@VAT1,C'='                                        
         LA    R3,PSECOND+74       YES                                          
         LA    R4,JOBGST           GST AMOUNT                                   
         BAS   RE,FORM10                                                        
*                                                                               
         CP    JOBPST,=P'0'        DO WE HAVE ANY PST ?                         
         BE    FORMR04             NO, SKIP IT                                  
         MVC   PTHIRD+67(L'SVPSTNME),SVPSTNME                                   
         MVI   PTHIRD+67+L'SVPSTNME,C'='                                        
         LA    R3,PTHIRD+74        YES                                          
         LA    R4,JOBPST           PST AMOUNT                                   
         BAS   RE,FORM10                                                        
*                                                                               
FORMR04  B     FORMXIT                                                          
         DROP  R5,R6                                                            
         EJECT ,                                                                
***********************************************************************         
*              CALCULATE RETAIL SHARES OF GST AND PST                 *         
*              R6 = GST/PST ACCUMS                                    *         
***********************************************************************         
*                                                                               
         USING RTLD,R5                                                          
         USING JOBD,R6                                                          
*                                                                               
GETSHR   DS    0D                                                               
         CLI   RTLEDG,0            RETAIL?                                      
         BE    GETSHRX             NO, NO SPLIT                                 
*                                                                               
         ST    R6,SAVER6           SAVE R6                                      
         L     R5,ARETAIL                                                       
         LA    R0,JOBLNQ/8                                                      
*                                                                               
GETSHR2  ZAP   PK16,0(L'JOBNET,R6) AMOUNT                                       
         MP    PK16,RTLPGST        X PCT                                        
         SRP   PK16,64-6,5         ROUNDED                                      
         ZAP   0(L'JOBNET,R6),PK16 THIS DISTRIBUTOR AMOUNT                      
         LA    R6,L'JOBNET(,R6)                                                 
         BCT   R0,GETSHR2                                                       
*                                                                               
         TM    RTLOPT,RTLSCOMM     SPECIAL COMMISSION RATE SOMEWHERE ?          
         BZ    GETSHRX             NO,  SKIP                                    
         L     R6,SAVER6           RESTORE R6                                   
         ZAP   JOBCOMM,RTLCMTOT    GET  COMMISSION TOTAL                        
*                                                                               
GETSHRX  B     SHRX                                                             
         DROP  R5,R6                                                            
         EJECT ,                                                                
***********************************************************************         
*              CALCULATE RETAIL COMMISSION                            *         
*                                                                     *         
*        INPUT:                                                       *         
*          P2       - ADDRESS OF   NET         AMOUNT (PACKED 8 BYTES)*         
*          P3       - ADDRESS OF   COMMISSION  RATE   (PACKED 4 BYTES)*         
*          P4       - ADDRESS OF   COMMISSION  AMOUNT (PACKED 6 BYTES)*         
*                                                                     *         
*        ASSUMES:                                                     *         
*          COMMISSIONABLE     ITEM                                    *         
*          SPECIAL    COMMISSION   RATES                              *         
*                                                                     *         
*        OUTPUT:                                                      *         
*          COMMISSIONABLE     AMOUNT                                  *         
*          DISTRIBUTOR        TABLE            UPDATED                *         
*                                                                     *         
*        USES:                                                        *         
*          ADSTRB   - ADDRESS OF   DISTRIBUTOR TABLE                  *         
*          PK16     - PACKED  16   WORK AREA                          *         
*                                                                     *         
***********************************************************************         
*                                                                               
         USING RTLD,R5             MAP  DISTRIBUTOR    RECORD                   
*                                                                               
CALCCOMM DS    0H                                                               
         L     R5,ADSTRB           ->   DISTRIBUTION   TABLE                    
         L     R2,4(,R1)           ->   NET            AMOUNT                   
         L     R3,8(,R1)           ->   COMMISSION     RATE                     
         L     R4,12(,R1)          ->   COMMISSION     AMOUNT                   
         ZAP   0(6,R4),=P'0'       INITIALIZE     COMMISSION     AMOUNT         
*                                                                               
CALC10   DS    0H                  CALCULATE DISTRIBUTOR    COMMISSION          
         ZAP   PK16,0(8,R2)        GET  NET  AMOUNT                             
         MP    PK16,RTLPCT         TIMES     DISTRIBUTOR'S  PERCENTAGE          
*                                  MAINTAIN  EIGHT     DECIMAL   PLACES         
*                                                                               
         TM    RTLSTAT,RTLCOMM     SPECIAL   COMMISSION     RATE ?              
         BO    CALC20              YES, SKIP                                    
         MP    PK16,0(4,R3)        TIMES     BASE COMMISSION     RATE           
         SRP   PK16,64-12,5        ROUND     TO   TWO  DECIMAL   PLACES         
         B     CALC30              CONTINUE                                     
*                                                                               
CALC20   DS    0H                  SPECIAL   DISTRIBUTOR    COMMISSION          
         MP    PK16,RTLCRATE       TIMES     SPECIAL   COMM RATE                
         SRP   PK16,64-12,5        ROUND     TO   TWO  DECIMAL   PLACES         
*                                                                               
CALC30   DS    0H                  FINISH    DISTRIBUTOR    COMMISSION          
         AP    RTLCMTOT,PK16       ADD  TO   DISTRIBUTOR    SUM                 
         AP    0(6,R4),PK16        ADD  TO   COMMISSION     AMOUNT              
         LA    R5,RTLLNQ(,R5)      ->   NEXT DISTRIBUTOR                        
         CLI   0(R5),X'FF'         ANY  MORE DISTRIBUTORS ?                     
         BNE   CALC10              YES, CONTINUE                                
*                                                                               
         B     SHRX                RETURN    TO   CALLER                        
         DROP  R5                                                               
         EJECT                                                                  
***********************************************************************         
*              CALCULATE PERCENT OF BILLING                           *         
***********************************************************************         
*                                                                               
         USING JOBD,R6                                                          
CALCPOB  DS    0D                                                               
*                                                                               
         CP    TOTPB,=P'0'         NO DOLLARS?                                  
         BE    CALCPOBX            DON'T CALCULATE                              
         CLI   SVPBBIL,C'N'        ARE WE DOING POB?                            
         BE    CALCPOBX            NO                                           
*                                                                               
         OC    SVPBPCT,SVPBPCT     ANY PERCENT?                                 
         BZ    CALCPOBX            NO                                           
         ZAP   PL13,SVPBPCT        YES, IS IT ZERO?                             
         BZ    CALCPOBX            YES, DON'T CALCULATE                         
*                                                                               
         MP    PL13,TOTPB                                                       
         SRP   PL13,64-8,5                                                      
         ZAP   SVPBAMT,PL13        SAVE PERCENTAGE AMOUNT                       
*                                                                               
         CLI   SVPBBIL,C'U'        ARE WE UNBILLING THIS?                       
         BE    CALCPOBX            YES, EXIT HERE                               
*                                                                               
         LA    R6,JOBDTL           DO A POSTRANS                                
         MVC   JOBBK(JOBLNQ),ZEROS                                              
         ZAP   JOBNET,SVPBAMT                                                   
         ZAP   JOBGRS,SVPBAMT                                                   
*                                                                               
         ZAP   JOBVNET,SVPBAMT                                                  
         ZAP   JOBVGRS,SVPBAMT                                                  
         ZAP   JOBVBAS,SVPBAMT                                                  
*                                                                               
         ZAP   JOBPNET,SVPBAMT                                                  
         ZAP   JOBPGRS,SVPBAMT                                                  
         ZAP   JOBPBAS,SVPBAMT                                                  
         GOTO1 SHR,DMCB,('SUBRSUML',(RC))  ADD DETAIL LINE TOTALS               
*                                                                               
         MVC   P+1(L'SVPBWRK),SVPBWRK                                           
         MVC   P+4(L'SVPBWRKN),SVPBWRKN                                         
         CURED (P8,SVPBAMT),(13,P+39),2,MINUS=YES                               
         CURED (P8,SVPBAMT),(13,P+71),2,MINUS=YES                               
         GOTO1 ACREPORT                                                         
*                                                                               
         USING MRCD,R5                                                          
         LA    R5,BUFWK                                                         
         XC    BUFWK(MRCLNQ),BUFWK                                              
         MVC   MRCACCUM(JOBLNQ),JOBDTL                                          
         MVI   MRCTYPE,MRCTYPE4                                                 
         MVI   MRCMED,X'FF'                                                     
         GOTO1 BUFFALO,DMCB,=C'PUT',ABUFF,(R5)                                  
*                                                                               
         MVC   MRCMED(12),MEDNAME+3                                             
         MVC   MRCMED,SVPBWRKN                                                  
         BASR  RE,RF                                                            
*                                                                               
CALCPOBX B     SHRX                                                             
         DROP  R5,R6                                                            
         DROP  RB                                                               
         EJECT                                                                  
         LTORG                                                                  
         TITLE 'AC21 - PRODUCTION BILLING - END OF JOB  ROUTINES'               
ENDR     DS    0D                                                               
         NMOD1 0,*ENDR*                                                         
         L     RC,0(R1)                                                         
*                                                                               
         USING ACPROFSD,RE                                                      
         L     RE,APROFILE                                                      
         CLI   ACPPFC26,C'Y'       SUPPRESS EXTRA REQUEST PAGE?                 
         BE    SUMM00              YES                                          
*                                                                               
         MVC   WORK(L'QUESTOR),QUESTOR SAVE THE REQUESTOR                       
         MVC   QRECORD+2(L'QRECORD-2),SPACES                                    
         MVC   QRECORD2,SPACES                                                  
         MVC   QUESTOR,=C'INVOICE REG'                                          
         MVI   SKIPSPEC,C'R'                                                    
         GOTO1 ACREPORT                                                         
         MVC   QUESTOR,WORK        RESTORE IT                                   
*                                                                               
*                                  PRODUCTION INVOICE REGISTER                  
*                                                                               
         USING ACPROFSD,RE                                                      
SUMM00   L     RE,APROFILE                                                      
         MVI   RCSUBPRG,3                                                       
         CLI   ACPPFC19,C'Y'       ARE WE PRINTING GST INSTEAD OF CD ?          
         BNE   *+8                 NO                                           
         MVI   RCSUBPRG,13         YES, CHANGE SPEC                             
         DROP  RE                                                               
*                                                                               
         MVC   PAGE,=H'1'                                                       
         MVI   FORCEHED,C'Y'                                                    
         ZAP   LINES,=P'0'                                                      
         MVC   LASTCLI,SPACES                                                   
         MVC   JOBDTL(JOBLNQ),ZEROS   USE FOR CLIENT TOTALS                     
         OC    ALSORT,ALSORT                                                    
         BZ    MEDSUM              NO SORT RECORDS DO MEDIA SUMMARY             
*                                                                               
SUMM02   GOTO1 ADSORTER,DMCB,=C'GET'                                            
         L     R5,DMCB+4                                                        
         ST    R5,ALSORT           ADDRESS OF LAST SORT RECORD                  
         LTR   R5,R5                                                            
         BNZ   SUMM04                                                           
         B     SUMM12                                                           
*                                                                               
         USING PBRD,R5                                                          
SUMM04   CLI   PBRTYP,PBREQU       PROD. BILLING RECORD                         
         BNE   SUMM12              IF NOT DO LAST TOTAL                         
         CLC   LASTCLI,SPACES                                                   
         BE    SUMM06              FIRST TIME                                   
         CLC   PBRCLI,LASTCLI      SAME CLIENT                                  
         BNE   SUMM12              IF NOT SAME CLIENT DO TOTAL                  
*                                                                               
*              FORMAT A DETAIL LINE                                             
*                                                                               
SUMM06   MVC   LASTCLI,PBRCLI                                                   
         AP    LINES,=P'1'                                                      
         CP    LINES,=P'1'                                                      
         BNE   SUMM08                                                           
         L     RE,APROFILE                                                      
         USING ACPROFSD,RE                                                      
         CLI   ACPPFC11,C'Y'         NEW PAGE PER CLIENT(COMPANY)               
         BNE   SUMM08                                                           
         MVI   FORCEHED,C'Y'                                                    
*                                                                               
SUMM08   GOTO1 ACREPORT                                                         
         MVC   P+1(1),PBRJOB                                                    
         MVC   P+3(3),PBRCLI                                                    
         MVC   P+7(3),PBRPRD                                                    
         MVC   P+11(6),PBRJOB                                                   
         GOTO1 DATCON,DMCB,(1,PBRDTE),(9,P+22)                                  
         MVC   P+29(10),PBRBILL                                                 
         MVC   TEMPWK,PBRACCUM                                                  
         GOTO1 SHR,DMCB,('SUBRREG',(RC))                                        
         L     RE,APROFILE                                                      
         USING ACPROFSD,RE                                                      
         CLI   ACPPFC12,C'Y'       DOUBLE SPACE REGISTER(COMPANY)               
         BNE   *+8                                                              
         MVI   SPACING,2                                                        
         GOTO1 ACREPORT                                                         
*                                                                               
*              ADD ACCUMS TO CLIENT TOTAL                                       
*                                                                               
         LA    R2,JOBDTL           CLIENT TOTAL                                 
         LA    R1,JOBBKCNT                                                      
         LA    R4,PBRACCUM                                                      
*                                                                               
SUMM10   AP    0(L'JOBNET,R2),0(L'JOBNET,R4)                                    
         LA    R2,L'JOBNET(R2)                                                  
         LA    R4,L'JOBNET(R4)                                                  
         BCT   R1,SUMM10           NUMBER OF BUCKETS                            
         B     SUMM02                                                           
*                                                                               
*              CLIENT TOTAL                                                     
*                                                                               
SUMM12   CP    LINES,=P'1'                                                      
         BNH   SUMM14              ONLY ONE LINE FOR CLIENT                     
         MVC   P+1(L'AC@TCLI),AC@TCLI                                           
         MVC   P+1+L'AC@TCLI+1(L'LASTCLI),LASTCLI                               
         MVC   TEMPWK,JOBDTL                                                    
         GOTO1 SHR,DMCB,('SUBRREG',(RC))                                        
         GOTO1 ACREPORT                                                         
*                                                                               
SUMM14   ZAP   LINES,=P'0'                                                      
         MVC   JOBDTL(JOBLNQ),ZEROS                                             
         OC    ALSORT,ALSORT                                                    
         BZ    MEDSUM              END OF SORT DO MEDIA SUMMARY                 
         CLI   PBRTYP,PBREQU                                                    
         BNE   MEDSUM              NOT A PBR RECORD                             
         B     SUMM06                                                           
         DROP  R5,RE                                                            
         EJECT                                                                  
*              MEDIA TOTALS AT END OF REGISTER                                  
*                                                                               
         USING BIND,R5                                                          
         USING ACPROFSD,RE                                                      
MEDSUM   L     R5,AMEDTAB                                                       
         L     RE,APROFILE                                                      
         MVI   RCSUBPRG,2                                                       
         CLI   ACPPFC19,C'Y'       ARE WE PRINT GST INSTEAD OF CD ?             
         BNE   *+8                 NO                                           
         MVI   RCSUBPRG,12         YES, CHANGE SPEC                             
         CLI   ACPPFC32,C'Y'       SUPPRESS THIS REPORT                         
         BE    INTREG                                                           
         DROP  RE                                                               
*                                                                               
         OC    BININ,BININ                                                      
         BZ    INTREG              NOTHING IN TABLE NEXT SUMMARY                
         LA    R5,BINTABLE                                                      
*                                                                               
         USING MESD,R5                                                          
         MVI   FORCEHED,C'Y'                                                    
*                                                                               
MEDS02   CLI   MESCDE,X'FF'                                                     
         BE    MEDS06              RUN TOTALS                                   
         MVC   MEDIA,MESCDE        MEDIA CODE                                   
         MVC   P+1(12),MESNME      AND NAME                                     
         MVC   TEMPWK,MESACCUM                                                  
         GOTO1 SHR,DMCB,('SUBRREG',(RC))                                        
         CLC   P+16(100),SPACES                                                 
         BE    MEDS04                                                           
         GOTO1 ACREPORT                                                         
*                                                                               
MEDS04   LA    R5,MESLNQ(R5)                                                    
         B     MEDS02                                                           
*                                                                               
MEDS06   GOTO1 ACREPORT                                                         
         MVC   TEMPWK,MESACCUM                                                  
         GOTO1 SHR,DMCB,('SUBRREG',(RC))                                        
         MVC   P+1(L'AC@TOTRN),AC@TOTRN                                         
         GOTO1 ACREPORT                                                         
         B     INTREG                                                           
         DROP  R5                                                               
         EJECT                                                                  
*              INTERNAL INVOICE REGISTER                                        
*                                                                               
         USING INVRD,R5                                                         
INTREG   L     R5,ALSORT                                                        
         LTR   R5,R5                                                            
         BZ    RTAREG              IF NONE LOOK FOR TARGET REGISTER             
         CLI   INVRTYP,INVREQU                                                  
         BNE   RTAREG              NOT INTERNAL REGISTER RECORD                 
*                                                                               
         ZAP   DOUBLE,=P'0'                                                     
         ZAP   SKJTOT,=P'0'                                                     
         ZAP   LASTOT,=P'0'                                                     
         MVI   RCSUBPRG,5                                                       
         MVI   FORCEHED,C'Y'                                                    
*                                                                               
INTR01   MVC   LASTJOB,INVRCLI                                                  
         MVC   P+1(12),INVRCLI     JOB NO                                       
*                                                                               
INTR02   MVC   LASTACC,INVRACC                                                  
         MVC   P+14(12),INVRACC    INCOME ACCOUNT                               
*                                                                               
INTR03   MVC   LASTDTE,INVRDTE                                                  
         GOTO1 DATCON,DMCB,(1,INVRDTE),(8,P+31)                                 
*                                                                               
INTR04   MVC   LASTBILL,INVRBILL                                                
         MVC   P+42(10),INVRBILL                                                
*                                                                               
INTR04A  MVC   P+55(6),INVRREF                                                  
         MVC   P+64(2),INVRWRK                                                  
         CURED INVRAMT,(13,P+67),2,MINUS=YES                                    
         ZAP   LASTOT,INVRAMT                                                   
         AP    SKJTOT,INVRAMT                                                   
         AP    DOUBLE,INVRAMT                                                   
         GOTO1 ACREPORT                                                         
*                                                                               
         GOTO1 ADSORTER,DMCB,=C'GET'                                            
         L     R5,DMCB+4                                                        
         ST    R5,ALSORT           ADDRESS OF LAST SORT RECORD                  
         LTR   R5,R5                                                            
         BZ    INTR06                                                           
*                                                                               
INTR05   CLI   INVRTYP,INVREQU                                                  
         BNE   INTR06              END OF INVOICE REGISTER                      
         CLC   LASTJOB,INVRCLI     JOB CHANGE, PRINT TOTALS                     
         BNE   INTR06                                                           
         CLC   LASTACC,INVRACC                                                  
         BNE   INTR02                                                           
         CLC   LASTDTE,INVRDTE                                                  
         BNE   INTR03                                                           
         CLC   LASTBILL,INVRBILL                                                
         BNE   INTR04                                                           
         B     INTR04A                                                          
*                                                                               
INTR06   CP    SKJTOT,LASTOT                                                    
         BE    INTR08                                                           
         GOTO1 ACREPORT            SKIP A LINE                                  
         MVI   P+1,C'*'                                                         
         MVC   P+2(L'AC@TJOB),AC@TJOB                                           
         MVI   P+2+L'AC@TJOB,C'*'                                               
         CURED SKJTOT,(13,P+67),2,MINUS=YES                                     
         GOTO1 ACREPORT                                                         
         GOTO1 ACREPORT            SKIP A LINE                                  
*                                                                               
INTR08   ZAP   SKJTOT,=P'0'                                                     
         OC    ALSORT,ALSORT                                                    
         BZ    INTR10              END OF SORT DO RUN TOTAL                     
         CLI   INVRTYP,INVREQU                                                  
         BE    INTR01                                                           
*                                                                               
INTR10   CP    DOUBLE,=P'0'                                                     
         BE    RTAREG                                                           
         MVC   P+1(L'AC@TOTRN),AC@TOTRN                                         
         CURED (P8,DOUBLE),(13,P+67),2,MINUS=YES                                
         GOTO1 ACREPORT                                                         
         B     RTAREG                                                           
         DROP  R5                                                               
         EJECT                                                                  
*              REGISTER OF TARGET ACCOUNTS                                      
*                                                                               
         USING RTAD,R5                                                          
RTAREG   L     R5,ALSORT                                                        
         LTR   R5,R5                                                            
         BZ    RTAREGX             IF NONE LOOK FOR NEXT REGISTER               
         CLI   RTATYP,RTAEQU                                                    
         BNE   RTAREGX             NOT TARGET REGISTER RECORD                   
*                                                                               
         MVI   RCSUBPRG,7                                                       
         MVI   FORCEHED,C'Y'                                                    
         MVC   PAGE,=H'1'                                                       
*                                                                               
RTAR02   MVC   P+1(1),RTAJOB                                                    
         MVC   P+3(3),RTACLI                                                    
         MVC   P+7(3),RTAPRD                                                    
         MVC   P+11(6),RTAJOB                                                   
         GOTO1 DATCON,DMCB,(1,RTADTE),(9,P+22)                                  
         MVC   P+29(10),RTABILL                                                 
         MVC   P+40(12),RTAREC                                                  
         MVC   P+55(12),RTACOST                                                 
         MVC   P+71(12),RTASALES                                                
         GOTO1 ACREPORT                                                         
*                                                                               
         GOTO1 ADSORTER,DMCB,=C'GET'                                            
         L     R5,DMCB+4                                                        
         ST    R5,ALSORT           ADDRESS OF LAST SORT RECORD                  
         LTR   R5,R5                                                            
         BNZ   RTAR04                                                           
         B     RTAREGX                                                          
*                                                                               
RTAR04   CLI   RTATYP,RTAEQU                                                    
         BNE   RTAREGX                                                          
         B     RTAR02                                                           
*                                                                               
RTAREGX  B     INCREG                                                           
         DROP  R5                                                               
         EJECT                                                                  
*              INCOME REGISTER                                                  
*                                                                               
         USING INCD,R5                                                          
INCREG   L     R5,ALSORT                                                        
         LTR   R5,R5                                                            
         BZ    INCREGX             IF NONE LOOK FOR NEXT REGISTER               
         CLI   INCRTYP,INCREQU                                                  
         BNE   INCREGX                                                          
*                                                                               
         MVI   RCSUBPRG,15                                                      
         MVI   FORCEHED,C'Y'                                                    
         MVC   PAGE,=H'1'                                                       
         ZAP   SKJTOT,=P'0'        JOB LEVEL INCOME AMOUNT                      
         ZAP   LASTOT,=P'0'        FINAL INCOME AMOUNT                          
         ZAP   DUB,=P'0'           JOB LEVEL SB/SI AMOUNT                       
         ZAP   DOUBLE,=P'0'        FINAL SB/SI AMOUNT                           
*                                                                               
INCR02   MVC   P+1(3),INCRCLI                                                   
         MVC   P+5(3),INCRPRO                                                   
         MVC   P+9(6),INCRJOB                                                   
         MVC   P+23(10),INCRBILL                                                
         MVC   LASTJOB,INCRCLI     SAVE THE JOB NUMBER                          
*                                                                               
INCR04   MVC   P+36(2),INCRWRK                                                  
         CURED INCRAMT,(11,P+43),2,MINUS=YES                                    
         AP    SKJTOT,INCRAMT                                                   
         AP    LASTOT,INCRAMT                                                   
         CP    INCRIAM,=P'0'                                                    
         BE    INCR06                                                           
         MVC   P+55(14),INCRCR                                                  
         MVC   P+86(14),INCRDR                                                  
         CURED INCRIAM,(11,P+73),2,MINUS=YES,ALIGN=RIGHT                        
         AP    DUB,INCRIAM                                                      
         AP    DOUBLE,INCRIAM                                                   
*                                                                               
INCR06   GOTO1 ACREPORT                                                         
*                                                                               
         GOTO1 ADSORTER,DMCB,=C'GET'                                            
         L     R5,DMCB+4                                                        
         ST    R5,ALSORT           ADDRESS OF LAST SORT RECORD                  
         LTR   R5,R5                                                            
         BZ    INCR08                                                           
*                                                                               
         CLI   INCRTYP,INCREQU                                                  
         BNE   INCR10                                                           
         CLC   LASTJOB,INCRCLI                                                  
         BE    INCR04                                                           
*                                                                               
INCR08   MVI   P+1,C'*'                                                         
         MVC   P+2(L'AC@TJOB),AC@TJOB                                           
         MVI   P+2+L'AC@TJOB,C'*'                                               
         CURED SKJTOT,(11,P+43),2,MINUS=YES                                     
         CURED DUB,(11,P+73),2,MINUS=YES,ALIGN=RIGHT                            
         GOTO1 ACREPORT                                                         
*                                                                               
         ZAP   SKJTOT,=P'0'                                                     
         ZAP   DUB,=P'0'                                                        
         OC    ALSORT,ALSORT                                                    
         BZ    INCR10                                                           
         CLI   INCRTYP,INCREQU                                                  
         BNE   INCR10                                                           
         B     INCR02                                                           
*                                                                               
INCR10   MVI   P+1,C'*'                                                         
         MVC   P+2(L'AC@TOTRN),AC@TOTRN                                         
         MVI   P+2+L'AC@TOTRN,C'*'                                              
         CURED LASTOT,(11,P+43),2,MINUS=YES                                     
         CURED DOUBLE,(11,P+73),2,MINUS=YES,ALIGN=RIGHT                         
         GOTO1 ACREPORT                                                         
*                                                                               
INCREGX  B     INTEREG                                                          
         DROP  R5                                                               
         EJECT                                                                  
*              INTERCOMPANY REGISTER                                            
*                                                                               
         USING INTD,R5                                                          
INTEREG  L     R5,ALSORT                                                        
         LTR   R5,R5                                                            
         BZ    INTERX              IF NONE, DO TOTALS                           
         CLI   INTRTYP,INTREQU                                                  
         BNE   INTERX                                                           
*                                                                               
         MVI   RCSUBPRG,16                                                      
         MVI   FORCEHED,C'Y'                                                    
         MVC   PAGE,=H'1'                                                       
         ZAP   SKJTOT,=P'0'        HOLD JOB TOTAL                               
         ZAP   LASTOT,=P'0'        HOLD FINAL TOTAL                             
*                                                                               
INTER02  MVC   P+1(4),INTRSTUD                                                  
         MVC   LASTSTUD,INTRSTUD   SAVE STUDIO TYPE                             
         GOTO1 ACREPORT                                                         
*                                                                               
INTER03  MVC   P+3(1),INTRMED                                                   
         MVC   P+7(3),INTRSCLI                                                  
         MVC   P+11(3),INTRSPRO                                                 
         MVC   P+15(6),INTRSJOB                                                 
         GOTO1 DATCON,DMCB,(1,INTRDATE),(8,P+22)                                
         MVC   P+34(10),INTRBILL                                                
         CURED INTRAMT,(11,P+49),2,MINUS=YES                                    
         MVC   P+63(12),INTRAJOB                                                
         MVC   P+79(14),INTRCACC                                                
         AP    SKJTOT,INTRAMT                                                   
         AP    LASTOT,INTRAMT                                                   
         GOTO1 ACREPORT                                                         
*                                                                               
         GOTO1 ADSORTER,DMCB,=C'GET'                                            
         L     R5,DMCB+4                                                        
         ST    R5,ALSORT           ADDRESS OF LAST SORT RECORD                  
         LTR   R5,R5                                                            
         BZ    INTER06                                                          
*                                                                               
INTER04  CLI   INTRTYP,INTREQU                                                  
         BNE   INTER06                                                          
         CLC   LASTSTUD,INTRSTUD                                                
         BE    INTER03                                                          
*                                                                               
INTER06  MVI   P+1,C'*'                                                         
         MVC   P+2(L'AC@STDIO),AC@STDIO                                         
         MVC   P+2+1+L'AC@STDIO(L'AC@TYPE),AC@TYPE                              
         MVC   P+2+1+1+L'AC@STDIO+L'AC@TYPE(L'INTRSTUD),LASTSTUD                
         MVI   P+2+1+1+1+L'AC@STDIO+L'AC@TYPE+L'INTRSTUD,C'*'                   
         CURED SKJTOT,(11,P+49),2,MINUS=YES                                     
         GOTO1 ACREPORT                                                         
*                                                                               
INTER08  ZAP   SKJTOT,=P'0'                                                     
         OC    ALSORT,ALSORT                                                    
         BZ    INTER10                                                          
         CLI   INTRTYP,INTREQU                                                  
         BNE   INTER10                                                          
         B     INTER02                                                          
*                                                                               
INTER10  MVI   P+1,C'*'                                                         
         MVC   P+2(L'AC@TOTRN),AC@TOTRN                                         
         MVI   P+2+L'AC@TOTRN,C'*'                                              
         CURED LASTOT,(11,P+49),2,MINUS=YES                                     
         GOTO1 ACREPORT                                                         
*                                                                               
INTERX   B     EXCEREG                                                          
         DROP  R5                                                               
         EJECT                                                                  
*              EXCEPTION REGISTER                                               
*                                                                               
         USING EXCD,R5                                                          
EXCEREG  L     R5,ALSORT                                                        
         LTR   R5,R5                                                            
         BZ    EXCERX              IF NONE, DO TOTALS                           
         CLI   EXCRTYP,EXCREQU                                                  
         BNE   EXCERX                                                           
*                                                                               
         MVI   RCSUBPRG,19                                                      
         MVI   FORCEHED,C'Y'                                                    
         MVC   PAGE,=H'1'                                                       
*                                                                               
EXCER02  MVC   P+1(L'EXCRSCLI),EXCRSCLI                                         
         MVC   P+5(L'EXCRSPRO),EXCRSPRO                                         
         MVC   P+9(L'EXCRSJOB),EXCRSJOB                                         
         MVC   P+18(L'EXCRSTUD),EXCRSTUD                                        
         MVC   P+25(L'EXCRAJOB),EXCRAJOB                                        
         GOTO1 DATCON,DMCB,(1,EXCRDATE),(8,P+39)                                
         MVC   P+49(L'EXCRBILL),EXCRBILL                                        
         MVC   P+61(L'EXCRMSG),EXCRMSG                                          
         GOTO1 ACREPORT                                                         
*                                                                               
         GOTO1 ADSORTER,DMCB,=C'GET'                                            
         L     R5,DMCB+4                                                        
         ST    R5,ALSORT           ADDRESS OF LAST SORT RECORD                  
         LTR   R5,R5                                                            
         BZ    EXCERX                                                           
         CLI   EXCRTYP,EXCREQU                                                  
         BE    EXCER02                                                          
*                                                                               
EXCERX   B     POBREG                                                           
         DROP  R5                                                               
         EJECT                                                                  
*              REGISTER OF POB POSTINGS                                         
*                                                                               
         USING POBD,R5                                                          
POBREG   L     R5,ALSORT                                                        
         LTR   R5,R5                                                            
         BZ    POBREGX             IF NONE LOOK FOR NEXT REGISTER               
         CLI   POBTYP,POBEQU                                                    
         BNE   POBREGX             NOT POB RECORD                               
*                                                                               
         MVI   RCSUBPRG,20                                                      
         MVI   FORCEHED,C'Y'                                                    
         MVC   PAGE,=H'1'                                                       
*                                                                               
POBR2    MVC   P+1(L'POBCLI),POBCLI                                             
         MVC   P+5(L'POBPRD),POBPRD                                             
         MVC   P+9(L'POBJOB),POBJOB                                             
         MVC   P+18(L'POBACC),POBACC                                            
         MVC   P+33(L'POBWC),POBWC                                              
         MVC   P+38(L'POBBILL),POBBILL                                          
         CURED POBAMT,(11,P+48),2,MINUS=YES                                     
         GOTO1 ACREPORT                                                         
*                                                                               
         GOTO1 ADSORTER,DMCB,=C'GET'                                            
         L     R5,DMCB+4                                                        
         ST    R5,ALSORT           ADDRESS OF LAST SORT RECORD                  
         LTR   R5,R5                                                            
         BZ    POBREGX                                                          
*                                                                               
         CLI   POBTYP,POBEQU                                                    
         BE    POBR2                                                            
*                                                                               
POBREGX  DS    0H                                                               
         B     NOBREG                                                           
         DROP  R5                                                               
         EJECT                                                                  
*              REGISTER OF NON-BILLABLE JOBS                                    
*                                                                               
         USING NOBD,R5                                                          
NOBREG   L     R5,ALSORT                                                        
         LTR   R5,R5                                                            
         BZ    NOBREGX             IF NONE LOOK FOR NEXT REGISTER               
         CLI   NOBTYP,NOBEQU                                                    
         BNE   NOBREGX             NOT NON-BILLABLE RECORD                      
*                                                                               
         MVI   RCSUBPRG,11                                                      
         MVI   FORCEHED,C'Y'                                                    
         MVC   PAGE,=H'1'                                                       
*                                                                               
NOBR02   MVC   P+1(3),NOBCLI                                                    
         MVC   P+5(3),NOBPRD                                                    
         MVC   P+9(6),NOBJOB                                                    
         MVC   LASTJOB,NOBCLI                                                   
*                                                                               
NOBR04   MVC   P+17(L'NOBDATA),NOBDATA                                          
         GOTO1 ACREPORT                                                         
*                                                                               
         GOTO1 ADSORTER,DMCB,=C'GET'                                            
         L     R5,DMCB+4                                                        
         ST    R5,ALSORT           ADDRESS OF LAST SORT RECORD                  
         LTR   R5,R5                                                            
         BZ    NOBREGX                                                          
*                                                                               
         CLI   NOBTYP,NOBEQU                                                    
         BNE   NOBREGX                                                          
         CLC   LASTJOB,NOBCLI                                                   
         BNE   NOBR02                                                           
         B     NOBR04                                                           
*                                                                               
NOBREGX  DS    0H                                                               
         B     CONSUM                                                           
         DROP  R5                                                               
         EJECT                                                                  
*              PRINT LAST PAGE FOR CONTROL                                      
*                                                                               
CONSUM   DS    0D                                                               
         L     R4,LOGOC                                                         
         USING LOGOD,R4                                                         
         MVI   LOGOTYPE,C'E'                                                    
         GOTO1 LOGO,DMCB,(R4)                                                   
*                                                                               
         DS    0H                                                               
         TM    BILLMODE,DRAFT                                                   
         BO    ENDRX                                                            
         CLI   RCFFPARM,C'T'       IS THIS A TEST RUN?                          
         BE    ENDRX               YES, SKIP THIS                               
*                                                                               
         GOTO1 PRINT,DMCB,=C'CLOSE'                                             
*                                                                               
         L     RF,VEXTRAS                                                       
         USING RUNXTRAD,RF                                                      
*                                                                               
         GOTO1 TRACK,DMCB,ACWORKD,TAPECASH,MARKED,TAPECNT,ID                    
         ORG   *-2                                                              
         TM    RUNOPT,TESTRUN      IS THIS A TEST RUN?                          
         BZ    *+8                 NO                                           
         OI    0(R1),X'40'         YES, TELL ACTRACK                            
         BASR  RE,RF                                                            
*                                                                               
         GOTO1 POSTWRK,DMCB,ACWORKD,(C'R',ID)                                   
*                                                                               
ENDRX    XIT                                                                    
         DROP  R4,RF                                                            
         EJECT ,                                                                
         LTORG                                                                  
         TITLE 'AC21 - PRODUCTION BILLING - POST GST TO BUFFALO'                
POSTG    DS    0D                                                               
         NMOD1 0,*POSTG,RA                                                      
         L     RC,0(R1)                                                         
         USING GSTD,R5                                                          
         TM    RUNOPT,NEEDGST      ARE WE DOING GST LOGIC?                      
         BZ    POSTGX              NO, EXIT                                     
         OC    SVGSTCOD,SVGSTCOD   DO WE HAVE ANY GST DATA?                     
         BZ    POSTGX              NO, EXIT                                     
*                                                                               
         LA    R5,BUFWK                                                         
         XC    BUFWK(GSTLNQ),BUFWK                                              
         MVI   GSTTYPE,GSTTYPE5                                                 
         TM    WKCOPT,WKCMT        IS THIS A MEDIA TRANSFER ?                   
         BZ    *+8                 NO                                           
         MVI   GSTTYPE,GSTTYPE6    YES, DIFFERENT TYPE                          
         MVC   GSTACCUM(JOBLNQ),JOBDTL    ACCUMS                                
         MVC   GSTCODE,SVGSTCOD                                                 
         MVC   GSTRATE,SVGSTRAT                                                 
         MVC   GSTINDS,SVGSTIND                                                 
         MVC   GSTACCT,SVGSTACC                                                 
         MVC   GSTDATE,SVGSTDAT                                                 
         GOTO1 BUFFALO,DMCB,=C'PUT',ABUFF,(R5)                                  
         MVC   GSTCODE,EFFS                                                     
         MVC   GSTRATE,EFFS                                                     
         MVC   GSTACCT,EFFS                                                     
         BASR  RE,RF               PUT OUT TOTAL RECORD                         
*                                                                               
POSTGX   XIT                                                                    
         DROP  R5                                                               
         LTORG                                                                  
         EJECT ,                                                                
         TITLE 'AC21 - PRODUCTION BILLING - POST PST TO BUFFALO'                
POSTP    DS    0D                                                               
         NMOD1 0,*POSTP,RA                                                      
         L     RC,0(R1)                                                         
         USING PSTD,R5                                                          
         TM    RUNOPT,NEEDPST      ARE WE DOING PST LOGIC?                      
         BZ    POSTPX              NO, EXIT                                     
         OC    SVPSTCOD,SVPSTCOD   DO WE HAVE ANY PST DATA?                     
         BZ    POSTPX              NO, EXIT                                     
*                                                                               
         LA    R5,BUFWK                                                         
         XC    BUFWK(PSTLNQ),BUFWK                                              
         MVI   PSTTYPE,PSTTYPE7                                                 
         TM    WKCOPT,WKCMT        IS THIS A MEDIA TRANSFER ?                   
         BZ    *+8                 NO                                           
         MVI   PSTTYPE,PSTTYPE8    YES, DIFFERENT TYPE                          
         MVC   PSTACCUM(JOBLNQ),JOBDTL    ACCUMS                                
         MVC   PSTCODE,SVPSTCOD                                                 
         MVC   PSTRATE,SVPSTRAT                                                 
         MVC   PSTINDS,SVPSTIND                                                 
         MVC   PSTACCT,SVPSTACC                                                 
         MVC   PSTDATE,SVPSTDAT                                                 
         MVC   PSTPROV,SVPSTPRV                                                 
         MVC   PSTNAME,SVPSTNME                                                 
         MVC   PSTREG,SVPSTREG                                                  
         GOTO1 BUFFALO,DMCB,=C'PUT',ABUFF,(R5)                                  
         MVC   PSTCODE,EFFS                                                     
         MVC   PSTRATE,EFFS                                                     
         MVC   PSTACCT,EFFS                                                     
         BASR  RE,RF               PUT OUT TOTAL RECORD                         
*                                                                               
POSTPX   XIT                                                                    
         DROP  R5                                                               
         LTORG                                                                  
         EJECT                                                                  
EFFS     DC    15X'FF'                                                          
SKJTOT   DS    PL6                 FOR 'SK' POSTINGS WITHIN JOB                 
LASTJOB  DS    CL12                                                             
LASTACC  DS    CL12                                                             
LASTBILL DS    CL10                                                             
LASTDTE  DS    CL3                                                              
LASTOT   DS    PL6                                                              
LASTSTUD DS    CL4                                                              
LINES    DS    PL3                                                              
         TITLE 'A21 - PRODUCTION BILLING - TABLES AND WORK AREAS'               
*                                  MEDIA SUMMARY TABLE                          
MEDTAB   DS    0D                                                               
         DC    F'0'                NUMBER IN TABLE                              
         DC    AL4(MESLNQ)         RECORD LENGTH                                
         DC    AL4(MESKLEN)        DISP. TO KEY/ KEY LENGTH                     
         DC    F'100'              MAX. IN TABLE                                
         DC    AL1(JOBBKCNT)       NUMBER OF BUCKETS                            
         DC    AL1(MESBK-MESD)     DISP. TO BUCKETS                             
         DC    X'00'               PACKED                                       
         DC    AL1(0)                                                           
         DS    (100*MESLNQ)C       TABLE                                        
*                                                                               
*                                  MISCELLANEOUS BUFFER                         
*                                                                               
COMBUF   DS    0D                                                               
         DS    2000C                                                            
*                                                                               
*                                  IO AREA                                      
IO2      DS    0D                                                               
         DS    2000C                                                            
*                                                                               
*                                  TABLE OF B2 ELEMENTS                         
ESTPOOL  DS    0D                                                               
         DS    2000C                                                            
*                                                                               
*                                  TABLE OF PREVIOUS B7 ELEMENTS                
PREVB7   DS    0D                                                               
         DS    CL(INCLN2Q*10)                                                   
*                                                                               
*                                  TABLE OF CURRENT B7 ELEMENTS                 
CURRB7   DS    0D                                                               
         DS    CL(INCLN2Q*10)                                                   
*                                                                               
*                                  TABLE OF DATA BY AGENCY WORKCODE             
WRKTAB   DS    0D                                                               
         DC    F'0'                NUMBER IN TABLE                              
         DC    AL4(WRKLNQ)         RECORD LENGTH                                
         DC    AL4(WRKKLEN)        DISP. TO KEY/ KEY LENGTH                     
         DC    F'100'              MAX. IN TABLE                                
         DC    AL1(JOBBKCNT)       NUMBER OF BUCKETS                            
         DC    AL1(WRKBK-WRKD)     DISP. TO BUCKETS                             
         DC    X'00'               PACKED                                       
         DC    AL1(0)                                                           
         DS    (100*WRKLNQ)C       TABLE                                        
*                                                                               
*                                  TABLE OF USER RECORDS                        
USRPOOL  DS    0D                                                               
         DS    CL(USRREC*USRNUM)                                                
*                                                                               
*                                  TABLE OF VATICAN INFORMATION                 
VATBUFF  DS    0D                                                               
         DC    XL(VTCLNQ)'00'                                                   
*                                                                               
*                                  TABLE OF GST INFORMATION                     
SVTABLE  DS    0D                                                               
         DS    CL(SVTABLNQ*TAXNUM)                                              
*                                                                               
*                                  TABLE OF ACCOUNTS FOR APEEL ELEMENT          
SUBTAB   DS    0D                                                               
         DS    CL(SUBTABL*SUBTABM)                                              
*                                                                               
*                                  TARGET REGISTER RECORDS                      
RTAWK    DS    0D                                                               
         DS    CL(RTALNQ)                                                       
*                                                                               
*                                  WORK FOR NON-BILLABLE RECORDS                
NOBWK    DS    0D                                                               
         DS    CL(NOBLNQ)                                                       
*                                                                               
*                                  INTERNAL INVOICE RECORDS                     
INVRWK   DS    0D                                                               
         DS    CL(INVRLNQ)                                                      
*                                                                               
*                                  INTERCOMPANY RECORDS                         
INTRWK   DS    0D                                                               
         DS    CL(INTRLNQ)                                                      
*                                                                               
*                                  STUDIO RECORDS                               
EXCRWK   DS    0D                                                               
         DS    CL(EXCRLNQ)                                                      
*                                                                               
*                                  POSTING BUFFER FOR WORKER FILE               
POSTBUF  DS    0D                                                               
         DC    4500X'00'                                                        
*                                                                               
*                                  TABLE OF DISTRIBUTION RECORDS                
DSTRB    DS    0D                                                               
         DS    (MAXDSTB)CL(RTLLNQ)                                              
*                                                                               
*                                  PERCENT OF BILLING                           
POBWK    DS    0D                                                               
         DS    CL(POBLNQ)                                                       
*                                                                               
*                                                                               
MAXDSTB  EQU   600                 MAXIMUM NUMBER OF DISTRIBUTORS               
*                                                                               
*                                  SPECS TO SHOW REQUEST DETAILS                
MYSPECS  DS    0D                                                               
         DC    100X'00'                                                         
         ORG   MYSPECS                                                          
         SPROG 0,1,2,3,4,5,6,7,8,9                                              
         ACDEF F1,2,REQDETS                                                     
         ORG                                                                    
*                                                                               
         BUFF  LINES=500,                                              X        
               ROWS=2,                                                 X        
               COLUMNS=14,                                             X        
               FLAVOR=PACKED,                                          X        
               COMMENT=86,                                             X        
               KEYLIST=(29,A)                                                   
         TITLE 'DSECT FOR EQUATES AND COMMON DATA FIELDS (R7)'                  
BILLD    DSECT                                                                  
*                                                                               
DUB1     DS    D                                                                
DUB2     DS    D                                                                
DUB3     DS    D                                                                
*                                                                               
AMEL     DS    F                   A(MEDIA ELEMENT)                             
ALSORT   DS    F                   A(LAST SORT RECORD)                          
SAVERE   DS    F                   SAVE RETURN REGISTER                         
SAVERTL  DS    F                   A(RETAIL RECORD)                             
SAVER1   DS    F                   SAVE REGISTER 1                              
SAVER4   DS    F                   SAVE REGISTER 4                              
SAVER6   DS    F                   SAVE REGISTER 6                              
*                                                                               
RELO     DS    F                                                                
PEREST   DS    F                   PERCENT OF ESTIMATE                          
AWCEL    DS    F                                                                
*                                                                               
*                                  MODES AND MODE EQUATES                       
BILLMODE DS    X                                                                
BILL     EQU   X'80'               21                                           
ORIG     EQU   X'40'                                                            
DRAFT    EQU   X'20'               22                                           
UNBILL   EQU   X'10'               23                                           
RERUN    EQU   X'08'                                                            
*                                                                               
PRNTMODE DS    CL1                 PRINTING MODES                               
PRNTALL  EQU   1                   PRINT ALL LINES                              
PRNTDUE  EQU   2                   PRINT AMOUNT DUE LINE                        
PRNTOTC  EQU   3                   PRINT TOTAL CHARGES LINE                     
PRNTGRP  EQU   4                   PRINT GROUP SUMMARIES                        
PRNTCOM  EQU   5                   PRINT JOB COMMENTS                           
*                                                                               
POSTMODE DS    CL1                 POSTING MODES                                
POSTOPEN EQU   1                   OPEN WORKER FILE                             
POSTBILL EQU   2                   POST A REGULAR BILL                          
POSTSK   EQU   3                   POST SK REVERSAL                             
POSTGRP  EQU   4                   POST GROUP BILL                              
POSTEST  EQU   5                   REVERSE ESTIMATES PRODUCTION                 
POSTCLSE EQU   6                   CLOSE WORKER FILE                            
POSTINTR EQU   7                   MAKE INTERCOMPANY POSTINGS                   
*                                                                               
SUBRMODE DS    CL1                 SUB-ROUTINE MODES                            
SUBRMED  EQU   1                   GET MEDIA CODE                               
SUBRCOST EQU   2                   GET COSTING ACCOUNT                          
SUBRSUML EQU   3                   ADD TO SUMMARY LINE                          
SUBRBIN  EQU   4                   ADD TO BIN TABLE                             
SUBRNAM  EQU   5                   NAME OUT                                     
SUBRFORM EQU   6                   FORMAT A LINE OF ACCUMS                      
SUBRTOT  EQU   7                   FORMAT TOTALS INCLUDING GST & PST            
SUBRSUM  EQU   8                   FORMAT DETAIL FOR SUMMARY BILL               
SUBRREG  EQU   9                   FORMAT DETAIL FOR INVOICE REG                
SUBRSHR  EQU   10                  DO RETAIL SHARE OF GST/PST                   
SUBRCCOM EQU   11                  CALCULATE RETAIL COMMISSION                  
SUBRPOB  EQU   12                  CALCULATE PERCENT OF BILLING                 
*                                                                               
RTLMODE  DS    CL1                 RETAIL MODES                                 
RTLINIT  EQU   1                   INITIALIZATION                               
RTLINI2  EQU   4                   INITIALIZATION PART 2                        
RTLDTLS  EQU   2                   SAVE DETAIL PRINT LINES                      
RTLPRNT  EQU   3                   PRINT/POST MULTIPLE INVOICES                 
*                                                                               
RTLOPT   DS    XL1                 RETAIL OPTIONS                               
RTLSCOMM EQU   X'80'               SPECIAL COMMISSION RATE SOMEWHERE            
*                                                                               
BILLTYPE DS    X                                                                
PROG     EQU   X'80'                                                            
TOTAL    EQU   X'40'                                                            
ONELNE   EQU   X'20'                                                            
ESTIM    EQU   X'10'                                                            
SPECIAL  EQU   X'08'                                                            
ALL      EQU   X'FF'                                                            
NOTBILL  EQU   X'00'                                                            
*                                                                               
CLIOPT   DS    X                                                                
CLISUM   EQU   X'80'               PRINT CLIENT SUMMARY                         
PROSUM   EQU   X'40'               PRINT PRODUCT SUMMARY                        
COMMISN  EQU   X'10'               TAKE COMMISSION                              
ESTREQ   EQU   X'08'               ESTIMATE REQUIRED                            
PAYNET   EQU   X'04'               PAY NET                                      
UNHOLD   EQU   X'02'               AUTO UNHOLD                                  
NOCOMM   EQU   X'01'               PAY NET AND DON'T PRINT COMMISSION           
*                                                                               
CLIOPT2  DS    X                                                                
USELONG  EQU   X'80'               USE WORKCODE LONG NAMES                      
*                                                                               
GRPOPT   DS    X                                                                
GRPBILL  EQU   X'80'               GROUP BILLING                                
GRPNUM   EQU   X'40'               GROUP BILL NUMBER SET                        
*                                                                               
ESTOPT   DS    X                                                                
NOESTCM  EQU   X'80'               NO COMM. ON ESTIMATE OR SPECIAL              
NOESTDL  EQU   X'40'               NO DETAILS ON ESTIMATE BILLS                 
UNAPP    EQU   X'20'               JOB HAS UNAPPROVED ESTIMATE                  
ESTCODE  EQU   X'10'               PRINT WORKCODE ONLY                          
ESTBOTH  EQU   X'08'               PRINT WORKCODE AND NAME                      
*                                                                               
RUNOPT   DS    X                                                                
WRITLVA  EQU   X'40'               WRITE LEVEL A                                
WRITMED  EQU   X'20'               WRITE MEDIA                                  
WRITLG   EQU   X'10'               WRITE LEDGER                                 
NEEDGST  EQU   X'08'               APPLY GST                                    
CANAGY   EQU   X'04'               CANADIAN AGENCY                              
NEEDPST  EQU   X'02'               APPLY PST                                    
TESTRUN  EQU   X'01'               TEST RUN                                     
*                                                                               
BILLOPT  DS    X                                                                
CLINUM   EQU   X'80'               CLIENT BILL NUMBER                           
MEDNUM   EQU   X'40'               MEDIA BILL NUMBER                            
OLDNUM   EQU   X'20'               USE OLD NUMBER                               
AGYNUM   EQU   X'10'               AGENCY BILL NUMBER                           
CREDIT   EQU   X'08'               CREDIT BILL                                  
CASHD    EQU   X'04'               CASH DISCOUNT ON ITEM                        
MEDIANM  EQU   X'02'               PRINT MEDIA NAME IN HEAD LINE                
WRITE    EQU   X'01'               WRITE TRANSACTION                            
*                                                                               
COMMENTS DS    X                                                                
BEFORE   EQU   X'08'               PRINT BEFORE DATA                            
AFTER    EQU   X'04'               PRINT AFTER DATA                             
COMREAD  EQU   X'80'               READ A STANDARD COMMENT                      
*                                                                               
CMPOPT   DS    X                                                                
POSTCOST EQU   X'80'               MAKE COSTING POSTINGS                        
ESTSK    EQU   X'40'               %EST. JOBS TO SK                             
*                                                                               
REQOPT   DS    X                                                                
REQPRDO  EQU   X'80'               PRODUCTION ONLY                              
REQMEDO  EQU   X'40'               MEDIA ONLY                                   
REQAPPO  EQU   X'20'               APPROVED ONLY                                
*                                                                               
JOBOPT   DS    X                                                                
JOBMEDT  EQU   X'80'               JOB HAS TRANSFER FROM MEDIA                  
JOBSK    EQU   X'40'               %EST. JOB INCOME POSTED TO SK                
JOBX     EQU   X'20'               JOB IS AN X-JOB                              
JBSTUDIO EQU   X'10'               JOB IS A STUDIO                              
POSTAGY  EQU   X'08'               MAKE AGENCY POSTINGS                         
FUNDED   EQU   X'04'               JOB IS FUNDED                                
*                                                                               
WKCOPT   DS    X                                                                
WKCDTLC  EQU   X'80'               PRINT WORK-CODE DETAILS/CLIENT LEVEL         
WKCDTL   EQU   X'40'               PRINT WC DETAILS/WORK-CODE LEVEL             
WKCMT    EQU   X'20'               MEDIA TRANSFER WORK-CODE                     
*                                                                               
INCOPT   DS    X                   OPTION FOR INTERNAL INCOME                   
INCEST   EQU   X'80'                                                            
INCTOT   EQU   X'40'                                                            
*                                                                               
BILLCODE DS    X                   1-BYTE CODE REPRESENTING BILLTYPE            
*                                                                               
USRREC   EQU   62                  MAXIMUM LENGTH OF USER RECORD                
USRNUM   EQU   6                   MAXIMUM NUMBER OF USER RECORDS               
TAXNUM   EQU   90                  MAXIMUM NUMBER OF SVTABLE ENTRIES            
         EJECT                                                                  
*                                 PROGRAM PROFILES                              
*                                                                               
PROFS    DS    0CL48                                                            
PROF1    DS    CL1                 SUPPRESS ESTIMATE VALUE                      
PROF2    DS    CL1                 PRINT VENDOR INVOICE NUMBER                  
PROF3    DS    CL1                 SUPPRESS VENDOR NAME                         
PROF4    DS    CL1                 SUPPRESS NET AND COMMISSION                  
PROF5    DS    CL1                 MATCH JOB MEDIA/COMMENT                      
PROF6    DS    CL1                 PRINT TARGET ACCOUNT REISTER                 
PROF7    DS    CL1                 PRINT REQUEST DETAILS (DRAFT)                
*                                  EXCLUDE TALENT 1 XTRA DAY (A21)              
PROF8    DS    CL1                 SUPPRESS PREVIOUS BILLS                      
PROF9    DS    CL1                 CASH DISCOUNT BY WORK-CODE                   
PROF10   DS    CL1                 PRINT TRANSFER INFORMATION                   
PROF11   DS    CL1                 NEW PAGE PER CLIENT ON REGISTER              
PROF12   DS    CL1                 DOUBLE SPACE REGISTER            (C)         
PROF13   DS    CL1                 BILL APPROVED ITEMS ONLY                     
PROF14   DS    CL1                 SUPPRESS DUE DATE                            
PROF15   DS    CL1                 USE MOS FOR INVOICE NUMBER       (C)         
*                                  EXCLUDE TALENT 1 XTRA DAY (A22)              
PROF16   DS    CL1                 PRINT NAME/ADDRESS IN HEADLINE (COL)         
PROF17   DS    CL1                 SUPRESS TOTAL FOR 1 LINE RETAIL              
PROF18   DS    CL1                 PRINT REGISTRATION # ON BILL                 
PROF19   DS    CL1                 PRINT GST INSTEAD OF CD ON REG   (C)         
PROF20   DS    CL1                 PRINT GST AS SECOND LINE         (C)         
PROF21   DS    CL1                 PRINT WORKCODE LONG NAME                     
PROF22   DS    CL1                 EXCLUDE TAXES FROM BILLINGS (LIVE)           
PROF23   DS    CL1                 SHIP DATE                    (N)             
PROF24   DS    CL1                 BILL# PREFIX (0=MM,1=MY,2=YM) (LIVE)         
*                                  PRINT NON-BILLABLE DETAILS (DRAFT)           
PROF25   DS    CL1                 PRINT COMMAS ON BILL                         
PROF26   DS    CL1                 DO NOT PRINT EXTRA REQUEST AT END            
PROF27   DS    CL1                 USE LONG INVOICE NUMBER                      
PROF28   DS    CL1                 DISPLAY INVOICE INSTEAD OF BILL NO           
PROF29   DS    CL1                                                              
PROF30   DS    CL1                 SUPPRESS INVOICE REGISTER REPORT             
PROF31   DS    CL1                 USE MMMDD/YY FORMAT FOR BILLDATE             
PROF32   DS    CL1                                                              
PROF33   DS    CL1                                                              
PROF34   DS    CL1                                                              
PROF35   DS    CL1                                                              
PROF36   DS    CL1                                                              
PROF37   DS    CL1                                                              
PROF38   DS    CL1                                                              
PROF39   DS    CL1                                                              
PROF40   DS    CL1                                                              
PROF41   DS    CL1                                                              
PROF42   DS    CL1                                                              
PROF43   DS    CL1                                                              
PROF44   DS    CL1                                                              
PROF45   DS    CL1                                                              
PROF46   DS    CL1                                                              
PROF47   DS    CL1                                                              
PROF48   DS    CL1                                                              
         EJECT                                                                  
*                                  MISCELLANEOUS STORAGE                        
ZEROS    DS    CL(JOBLNQ)                                                       
*                                                                               
JOBDTL   DS    CL(JOBLNQ)          ACCUMS FOR DETAIL                            
JOBWKC   DS    CL(JOBLNQ)          ACCUMS FOR WORK-CODE TOTAL                   
JOBCHG   DS    CL(JOBLNQ)          ACCUMS FOR TOTAL CHARGES                     
JOBTOT   DS    CL(JOBLNQ)          ACCUMS FOR ACCOUNT TOTAL                     
JOBPOST  DS    CL(JOBLNQ)          ACCUMS FOR ACCOUNT POSTINGS                  
JOBMED   DS    CL(JOBLNQ)          ACCUMS FOR ACCOUNT MEDIA TOTALS              
GRPTOT   DS    CL(JOBLNQ)          ACCUMS FOR GROUP BILL                        
TEMPWK   DS    CL(JOBLNQ)          TEMP ACCUMS FOR FORMAT ROUTINE               
DUETOT   DS    CL(JOBLNQ)          SAVED DUE LINE - IF HOLDING PRINT            
TOTCHG   DS    CL(JOBLNQ)          SAVED TOTAL CHARGES - FOR RETAIL             
SUBDTL   DS    CL(JOBLNQ)          ACCUMS FOR ADDABILL/SUBABILL                 
*                                                                               
BUFWK    DS    CL(SUMLNQ)          WORK AREA FOR BUFFALO RECORDS                
MESWK    DS    CL(MESLNQ)          WORK FOR MEDIA SUMMARY RECORDS               
WRKWK    DS    CL(WRKLNQ)          WORK FOR WORKCODE SUMMARY RECORDS            
*                                                                               
EPTYPE   DS    CL1                 ESTIMATED PRODUCTION                         
EPRTYPE  DS    CL1                 REVERSAL OF ESTIMATED PROD.                  
EPRFILT2 DS    CL1                 FILTER 2 VALUSE AFTER REVERSING EP           
ESTTYPE  DS    CL1                 NEW BILL TYPE FOR %EST JOBS                  
*                                                                               
ELCODE   DS    CL1                 ELEMENT CODE FOR GETEL                       
SAVOTH   DS    CL9                 OTHER NUMBER FROM OTHNUM                     
LNGBILNO DS    CL10                LONG CHARACTER BILL NUMBER                   
SHTBILNO DS    CL7                 SHORT BILL NUMBER                            
JOBLET   DS    CL1                 JOB MEDIA                                    
PREVOPT  DS    C                   SUPPRESS PREVIOUS BILLING OPTION             
*                                                                               
GRPTYPE  DS    CL1                 TYPE OF GROUP BILL                           
RUNCNT   DS    CL2                 RELATIVE INVOICE NUMBER                      
SVPRBLPR DS    CL50                PRINT ON BILLS                               
MYSPACE  DS    CL1                                                              
FILNME   DS    CL8                 "ACCOUNT"                                    
*                                                                               
ESTIMATE DS    PL6                                                              
GRSSEST  DS    PL6                 GROSS ESTIMATE                               
SPECAMNT DS    PL8                                                              
TOTPB    DS    PL8                                                              
*                                                                               
COSTING  DS    CL15                COSTING (1C) ACCOUNT                         
SUSPAC   DS    CL15                SUSPENSE (12) ACCOUNT                        
CONTRA   DS    CL15                TYPE 49 CONTRA (1R) ACCOUNT                  
*                                                                               
XTRACST  DS    CL12                INTERNAL INCOME COST CODE                    
SIAC     DS    CL12                12 COST CODE OVERRIDE                        
SINM     DS    CL36                12 COST CODE OVERRIDE NAME                   
*                                                                               
RECEIVBL DS    CL15                ALWAYS HAVE A RECEIVABLE                     
BILLNAME DS    CL15                                                             
MEDNAME  DS    CL15                                                             
*                                                                               
SKACCT   DS    CL15                SK CONTRA ACCOUNT FOR TYPE 41/49             
SKACCTN  DS    CL36                CONTRA NAME                                  
SIACCT   DS    CL15                SI CONTRA ACCOUNT FOR TYPE 41/49             
SIACCTN  DS    CL36                CONTRA NAME                                  
*                                                                               
CLICODE  DS    CL15                                                             
CLINAME  DS    CL36                                                             
PRDCODE  DS    CL15                                                             
PRDNAME  DS    CL36                                                             
JOBCODE  DS    CL15                ALWAYS HAVE JOB                              
JOBNAME  DS    CL36                                                             
PRODNUM  DS    CL15                PRODUCT NUMBER OR SALES ACCOUNT              
PRODNAM  DS    CL36                                                             
*                                                                               
SALENUM  DS    CL15                SALES ACCOUNT                                
SALENAM  DS    CL36                                                             
*                                                                               
COMMAC   DS    CL15                COMMISSION ACCOUNT                           
CDACCT   DS    CL15                CASH DISCOUNT ACCOUNT                        
PRCDACCT DS    CL15                PRINT CASH DISCOUNT ACCOUNT                  
*                                                                               
SVAGKEY  DS    0CL15               AGENCY JOB FROM LINK ELEMENT                 
SVAGCUL  DS    CL3                                                              
SVAGACC  DS    0CL12                                                            
SVAGCLI  DS    CL3                                                              
SVAGPRO  DS    CL3                                                              
SVAGJOB  DS    CL6                                                              
*                                                                               
SVAGCLIN DS    CL36                CLIENT NAME                                  
SVAGACN  DS    CL36                AGENCY JOB NAME                              
SVAGOFF  DS    CL2                 AGENCY OFFICE CODE                           
SVAGHOLD DS    CL1                 AGENCY HOLD OPTION                           
SVAGXJOB DS    XL1                 X-JOB INDICATOR                              
*                                                                               
SVELEM   DS    CL(LNKLNQ)          LINK ELEMENT                                 
SVSTUD   DS    CL4                 STUDIO TYPE FROM LINK ELEMENT                
SVAGWC   DS    CL2                 AGENCY WORKCODE FROM OPTIONS                 
SVBDB    DS    CL15                BILLING DEBIT ACCOUNT FROM OPTIONS           
SVICR    DS    CL15                INTERCO CREDIT ACCOUNT FROM OPTIONS          
SVVEND   DS    CL15                VENDOR FROM STUDIO TYPE RECORD               
SVVENDN  DS    CL36                VENDOR NAME                                  
SVZERO   DS    C                   OPTION FOR GROSS BILLINGS AMOUNT             
SVAUTH   DS    CL(L'JFNNUM)        SAVED AUTHORIZATION NUMBER                   
SVDBELM  DS    CL(FFTLN1Q+L'FFTDLEN+L'FFTWORK+L'FFTWAMT)                        
*                                                                               
SVEA     DS    CL14                                                             
SVAC     DS    CL14                                                             
SVBI     DS    CL15                                                             
SVBU     DS    CL15                                                             
*                                                                               
SVPBWRK  DS    CL2                 SAVE PB WORKCODE                             
SVPBWRKN DS    CL36                SAVE PB WORKCODE NAME                        
SVPBPCT  DS    PL5                 SAVE PB PERCENTAGE                           
SVPBACC  DS    CL15                SAVE PB ACCOUNT                              
SVPBNAM  DS    CL36                SAVE PB ACCOUNT NAME                         
SVPBAMT  DS    PL8                 SAVE PB AMOUNT                               
SVPBBIL  DS    C                   PB BILL MODE                                 
*                                                                               
OFFC     DS    CL2                                                              
TAXUL    DS    CL2                 U/L FOR GST/PST POSTINGS                     
CURCOD   DS    CL3                 CURRENCY CODE                                
CTRYCOD  DS    CL1                 COUNTRY CODE                                 
*                                                                               
BILLINFO DS    CL50                                                             
*                                                                               
CALLDATE DS    CL3                 DATE USED FOR VATICAN CALL                   
RCDAY2   DS    CL2                                                              
ENDATE   DS    CL3                                                              
DUEDAT   DS    CL8                 MMMDD/YY                                     
DUE6     DS    CL6                 YYMMDD                                       
DUE2     DS    CL2                                                              
SVDUE    DS    CL8                                                              
SVDUE6   DS    CL6                                                              
SVDUE2   DS    CL2                                                              
MOS      DS    CL2                                                              
MY       DS    CL2                     MONTH/YEAR                               
YM       DS    CL2                     YEAR/MONTH                               
DATE3    DS    CL3                                                              
USEDATE  DS    CL2                 DATE BILLING ORIGINALLY RUN (TODAY)          
USEBILL  DS    CL2                 DATE BILLING DATED (TRNKDATE)                
BILLDTE  DS    CL8                 START DATE,DATE=, OR TODAY'S DATE            
TODAY2   DS    CL2                 TODAY'S DATE                                 
TODAY3   DS    XL3                 TODAY'S DATE                                 
TODAYP   DS    XL3                 TODAY'S DATE                                 
END2     DS    CL2                                                              
OBDATE   DS    XL2                 ORIGINAL BILL DATE                           
OBDATP   DS    PL3                 ORIGINAL BILL DATE (PACKED)                  
SHIPDATE DS    XL1                 SHIP DATE (DAYS BEFORE DUE DATE)             
*                                                                               
LASTMED  DS    CL1                 SAVE AREA FOR LAST MEDIA USED                
LASTNAME DS    CL6                 SAVE AREA FOR LAST PROVINCE NAME             
SPECSW   DS    CL1                 SWITCH TO SHOW REQUEST DETAILS               
SVANINC  DS    C                   INDICATOR FOR INCOME WORKCODE                
*                                                                               
UNITS    DS    PL3                 NUMBER OF UNITS                              
PRICE    DS    PL4                 UNIT PRICE                                   
*                                                                               
COMMRATE DS    PL4                 COMMISSION RATE                              
COMMSTAT DS    CL1                 COMMISSION STATUS X'80'                      
*                                                                               
SCIUNET  DS    PL6                 NET AMOUNT BILLED                            
*                                                                               
SVGSTRAT DS    XL2                 SAVE GST RATE                                
SVGSTIND DS    X                   SAVE GST RATE INDICATOR                      
SVGSTDAT DS    PL3                 SAVE GST EFFECTIVE DATE                      
SVGSTACC DS    CL15                SAVE GST ACCOUNT CODE                        
SVGSTCOD DS    CL1                 SAVE GOTAXCOD                                
SVGSTREG DS    CL12                SAVE GST REGISTRATION NUMBER                 
*                                                                               
SVPSTRAT DS    XL2                 SAVE PST RATE                                
SVPSTIND DS    X                   SAVE PST RATE INDICATOR                      
SVPSTDAT DS    PL3                 SAVE PST EFFECTIVE DATE                      
SVPSTACC DS    CL15                SAVE PST ACCOUNT CODE                        
SVPSTCOD DS    CL1                 SAVE GOPSTCOD                                
SVPSTPRV DS    CL2                 SAVE PST PROVINCE CODE                       
SVPSTNME DS    CL6                 SAVE PST PROVINCE NAME                       
SVPSTREG DS    CL12                SAVE PST REGISTRATION NUMBER                 
*                                                                               
HGSTCOD  DS    CL1                 SAVE AREA FOR GST CODE                       
HGSTDAT  DS    PL3                 SAVE AREA FOR GST DATE                       
*                                                                               
HPSTCOD  DS    CL2                 SAVE AREA FOR PST CODE                       
HPSTDAT  DS    PL3                 SAVE AREA FOR PST DATE                       
HPSTPRV  DS    PL2                 SAVE AREA FOR PST PROVINCE CODE              
*                                                                               
MEDIA    DS    CL1                                                              
BILLREF  DS    CL6                 BILL NUMBER MM9999/YM9999/MY9999             
BILLNO   DS    PL4                                                              
REBILLNO DS    CL6                 RE-RUN BILL NUMBER                           
SVANAL   DS    CL2                 WORK CODE                                    
SVANALN  DS    CL36                DESCRIPTION                                  
SVJOBCR  DS    CL15                JOB LEVEL INCOME CREDIT ACCOUNT              
SVJOBDR  DS    CL15                JOB LEVEL INCOME DEBIT ACCOUNT               
SVWKCCR  DS    CL15                WORKCODE LEVEL INCOME CREDIT ACCOUNT         
SVWKCDR  DS    CL15                WORKCODE LEVEL INCOME DEBIT ACCOUNT          
*                                                                               
SVINCPR  DS    PL6                 PREVIOUS INCOME AMOUNT                       
*                                                                               
INC12ACC DS    CL15                INTERNAL INCOME 12 ACCOUNT                   
INC12NME DS    CL36                INTERNAL INCOME 12 ACCOUNT NAME              
*                                                                               
COMMAND  DS    CL6                                                              
ID       DS    CL16                                                             
MNTH     DS    CL2                                                              
LASTCLI  DS    CL3                                                              
COMMKEY  DS    CL49                                                             
SAVEKEY  DS    CL49                                                             
MYKEYSV  DS    CL32                                                             
*                                                                               
SAVCD    DS    PL6                                                              
PRVCD    DS    PL6                                                              
WCODECD  DS    PL6                 WORKCODE CASH DISCOUNT                       
*                                                                               
AMOUNT11 DS    PL6                 AMOUNT OF 11 POSTING                         
AMOUNT12 DS    PL6                 AMOUNT OF 12 POSTING                         
AMOUNTSJ DS    PL6                 AMOUNT OF SJ POSTING                         
AMOUNTSR DS    PL6                 AMOUNT OF SR POSTING                         
AMOUNTGS DS    PL6                 AMOUNT OF GST POSTING                        
AMOUNTPS DS    PL6                 AMOUNT OF PST POSTING                        
*                                                                               
GRPINT   DS    PL6                 INTERNAL INCOME FOR GROUP LEVEL              
GRPCD    DS    PL6                 CASH DISCOUNT FOR GROUP LEVEL                
GRP11    DS    PL6                 AMOUNT11 FOR GROUP LEVEL                     
GRP12    DS    PL6                 AMOUNT12 FOR GROUP LEVEL                     
GRPSJ    DS    PL6                 AMOUNTSJ FOR GROUP LEVEL                     
GRPSR    DS    PL6                 AMOUNTSR FOR GROUP LEVEL                     
GRPGST   DS    PL6                 AMOUNTGS FOR GROUP LEVEL                     
GRPPST   DS    PL6                 AMOUNTPS FOR GROUP LEVEL                     
*                                                                               
AMOUNT   DS    PL6                 NET                                          
CASH     DS    PL6                 CASH DISCOUNT                                
COMMISH  DS    PL6                 COMMISSION                                   
HOURS    DS    PL3                 HOURS                                        
RATE     DS    PL4                 RATE                                         
*                                                                               
PL13     DS    PL13                                                             
PK16     DS    PL16                                                             
*                                                                               
TOTBL    DS    PL8                                                              
TOTCOM   DS    PL8                                                              
TAPECNT  DS    PL8                                                              
TAPECASH DS    PL8                                                              
MARKED   DS    PL8                                                              
SKINC    DS    PL6                                                              
SKGRS    DS    PL6                                                              
*                                                                               
DUESW    DS    CL1                                                              
*                                                                               
USERPID  DS    XL(L'MCRHPSWD)      USER PID                                     
*                                                                               
NARR     DS    CL(8*21)                                                         
CHOPWRK  DS    CL123                                                            
BILLDLNQ EQU   *-BILLD                                                          
                                                                                
         TITLE 'DSECT FOR TABLES AND EXRTNS (R8)'                               
BILLD2   DSECT                                                                  
SUBTABM  EQU   32                  MAXIMUM # OF SUBTAB ENTRIES                  
SUBTABN  DS    X                   ACTUAL # OF SUBTAB ENTRIES                   
*                                                                               
ARTLNAME DS    A                   A(RETAILER NAME)                             
ARTLADDR DS    A                   A(RETAILER ADDRESS)                          
ARETAIL  DS    A                   A(RETAILER ENTRY)                            
ANUMAFT  DS    A                   A(6 BYTE NUMBER FIELD)                       
ARETSTRT DS    A                   A(FIRST RETAILER ENTRY)                      
*                                                                               
ATYPES   DS    0A                                                               
FORMLINE DS    V                   FORMAT A DETAIL LINE ON BILL                 
GETWORK  DS    V                   GET WORKCODE ADDRESS                         
BILLE5   DS    V                   UPDATE GDAEL ELEMENT                         
UBILLE5  DS    V                   UPDATE GDAEL ELEMENT                         
PROSUMY  DS    V                   PRODUCT SUMMARY                              
CLISUMY  DS    V                   CLIENT SUMMARY                               
WARNMSG  DS    V                   WARNING ROUTINE                              
BILLNUM  DS    V                   GET BILL NUMBER AND DATE                     
GETRATE  DS    V                   GET GST AND PST RATES                        
GETINC   DS    V                   GET INCOME ACCOUNTS FOR ESTIMATES            
RECAP    DS    V                   TAX TOTALS BY CODE                           
GETCUR   DS    V                   GET CURRENCY CODE                            
FILTER   DS    V                   EXTRACT SPECIAL VALUES AND FILTER            
PRNT     DS    V                   PRINT ROUTINES                               
POST     DS    V                   POST ROUTINES                                
SHR      DS    V                   SHARED SUB-ROUTINES                          
RTL      DS    V                   RETAIL ROUTINES                              
END      DS    V                   END OF JOB ROUTINES                          
POSTGST  DS    V                   POST GST TO BUFFALO                          
POSTPST  DS    V                   POST PST TO BUFFALO                          
*                                                                               
AMEDTAB  DS    A                                                                
ACOMBUF  DS    A                                                                
AIO2     DS    A                                                                
APOSTBUF DS    A                                                                
AMYSPECS DS    A                                                                
ABUFF    DS    A                                                                
AESTPOOL DS    A                                                                
AUSRPOOL DS    A                                                                
AVATBUFF DS    A                                                                
ASVTABLE DS    A                                                                
ASUBTAB  DS    A                                                                
ARTAWK   DS    A                                                                
ANOBWK   DS    A                                                                
AINVRWK  DS    A                                                                
AINTRWK  DS    A                                                                
AEXCRWK  DS    A                                                                
APREVB7  DS    A                                                                
ACURRB7  DS    A                                                                
AWRKTAB  DS    A                                                                
ADSTRB   DS    A                   RETAIL DISTRIBUTION TABLE                    
APOBWK   DS    A                   PERCENT OF BILLING                           
*                                                                               
UNDERLIN DS    V                                                                
CASHVAL  DS    V                                                                
SQUASHER DS    V                                                                
RIGHT    DS    V                                                                
TRACK    DS    V                                                                
*                                                                               
VATICAN  DS    V                                                                
*                                                                               
APHASES  DS    0A                  ** ADDRESSES OF LOADED PHASES **             
POSTWRK  DS    A                                                                
*                                                                               
ORIGNME  DS    CL33                ORIGIN NAME                                  
ORIGADD  DS    CL33                ORIGIN ADDRESS                               
*                                                                               
RTLEDG   DS    CL1                 RETAIL LEDGER                                
SCHEME   DS    CL2                 SCHEME                                       
*                                                                               
FREETYPE DS    CL1                 FREE FORM TYPE                               
*                                                                               
SAVEPN   DS    PL6                 TYPE 47 TOTAL NET                            
SAVEPC   DS    PL6                 TYPE 47 TOTAL COMMISSION                     
*                                                                               
SAVGST   DS    PL6                 SAVE GST IN CASE NEEDED                      
SAVTRND  DS    PL3                 99 TRANSACTION BILL DATE                     
*                                                                               
LONGREF  DS    CL20                LONG INVOICE NUMBER (FFTTINVN)               
*                                                                               
SOFTH1   DS    10CL44              SOFT HEADLINES                               
         DS    2D                                                               
PRINTED  DS    C                                                                
ARCHIVE  DS    C                                                                
TAXHEAD  DS    C                   TAX ANALYSIS HEADING PRINTED                 
         TITLE 'DATA DICTIONARY ENTRIES'                                        
DICO     DS    0C                                                               
         DSDDL PRINT=YES                                                        
         DS    XL1                                                              
         TITLE 'BUFFALO DSECTS'                                                 
*                                  TYPE 1 BUFFALO RECORDS                       
*                                  (CLIENT/PRODUCT SUMMARY)                     
SUMD     DSECT                                                                  
SUMKEY   DS    0C                                                               
SUMTYPE  DS    CL1                 TYPE                                         
SUMTYPE1 EQU   1                   TYPE 1 = CLIENT/PRODUCT SUMARY               
*                                           LEVEL 1 PRODUCT SUMMARY             
*                                           LEVEL 2 CLIENT SUMMARY              
*                                                                               
SUMSORT  DS    0CL28                                                            
SUMMED   DS    CL1                 MEDIA                                        
SUMCLI   DS    CL3                 CLIENT                                       
SUMPRD   DS    CL3                 PRODUCT                                      
SUMJOB   DS    CL6                 JOB                                          
SUMOTH   DS    CL9                 OTHER NUMBER                                 
SUMBILB  DS    CL3                 BINARY BILL NUMBER                           
SUMKLNQ  EQU   *-SUMKEY                                                         
SUMXTRA  DS    0CL36                                                            
SUMBILNO DS    CL10                BILL NUMBER                                  
SUMBILDT DS    CL3                 BILL DATE PWOS                               
         DS    CL26                SPARE                                        
         DS    CL50                SPARE                                        
SUMXTLNQ EQU   *-SUMXTRA                                                        
SUMACCUM DS    (JOBLNQ)C                                                        
SUMLNQ   EQU   *-SUMD                                                           
         EJECT                                                                  
*                                  TYPE 2 AND 3 BUFFALO RECORDS                 
*                                  (WORK CODES)                                 
TRAD     DSECT                                                                  
TRAKEY   DS    0C                                                               
TRATYPE  DS    CL1                 TYPE                                         
TRATYPE2 EQU   2                   TYPE 2 = PRODUCTION CHARGES                  
TRATYPE3 EQU   3                   TYPE 3 = MEDIA TRANSFER CHARGES              
*                                           LEVEL 1 JOB                         
*                                           LEVEL 2 GROUP                       
*                                                                               
TRASORT  DS    0CL28                                                            
TRAMED   DS    CL1                 MEDIA                                        
TRAPRD   DS    CL3                 PRODUCT                                      
TRAJOB   DS    CL6                 JOB                                          
TRAWKC   DS    CL2                 WORKCODE                                     
TRAREF   DS    CL6                 REFERENCE                                    
TRABIL   DS    CL1                 BILL INDICATOR(MEDIA TRANSFERS ONLY)         
         DS    CL9                 SPARE                                        
TRAKLNQ  EQU   *-TRAKEY                                                         
TRAXTRA  DS    0CL36                                                            
TRANAME  DS    CL36                JOB NAME                                     
TRABLPR  DS    CL50                PRINT ON BILLS                               
TRAXTLNQ EQU   *-TRAXTRA                                                        
TRAACCUM DS    CL(JOBLNQ)                                                       
TRALNQ   EQU   *-TRAD                                                           
         EJECT                                                                  
*                                  TYPE 4 BUFFALO RECORDS                       
*                                  (MEDIA RECAP)                                
MRCD     DSECT                                                                  
MRCKEY   DS    0C                                                               
MRCTYPE  DS    CL1                 TYPE                                         
MRCTYPE4 EQU   4                   TYPE 4 = MEDIA TYPE                          
*                                           LEVEL 1 JOB                         
*                                           LEVEL 2 GROUP                       
*                                                                               
MRCSORT  DS    0CL28                                                            
MRCMED   DS    CL15                MEDIA OR WORKCODE NAME                       
         DS    CL10                SPARE                                        
MRCKLNQ  EQU   *-MRCKEY                                                         
MRCXTRA  DS    0CL36                                                            
MRCNAME  DS    CL36                JOB NAME                                     
         DS    CL53                SPARE                                        
MRCXTLNQ EQU   *-MRCXTRA                                                        
MRCACCUM DS    CL(JOBLNQ)                                                       
MRCLNQ   EQU   *-MRCD                                                           
         EJECT                                                                  
*                                  TYPE 5 AND 6 BUFFALO RECORDS                 
*                                  (GST RECAP)                                  
GSTD     DSECT                                                                  
GSTKEY   DS    0C                                                               
GSTTYPE  DS    CL1                 TYPE                                         
GSTTYPE5 EQU   5                   TYPE 5 = REGULAR TRANSACTIONS                
GSTTYPE6 EQU   6                   TYPE 6 = MEDIA TRANSFERS                     
*                                                                               
GSTSORT  DS    0CL28                                                            
GSTRATE  DS    XL2                 GST RATE                                     
GSTINDS  DS    X                   GST RATE DECIMALS 0=2, X'80'=3               
GSTCODE  DS    CL1                 GST CODE                                     
GSTACCT  DS    CL15                GST ACCOUNT CODE                             
         DS    CL9                 SPARE                                        
GSTKLNQ  EQU   *-GSTKEY                                                         
GSTXTRA  DS    0CL86                                                            
GSTDATE  DS    PL3                 GST EFFECTIVE DATE                           
         DS    CL83                SPARE                                        
GSTXTLNQ EQU   *-GSTXTRA                                                        
GSTACCUM DS    CL(JOBLNQ)                                                       
GSTLNQ   EQU   *-GSTD                                                           
         EJECT                                                                  
*                                  TYPE 7 AND 8 BUFFALO RECORDS                 
*                                  (PST RECAP)                                  
PSTD     DSECT                                                                  
PSTKY    DS    0C                                                               
PSTTYPE  DS    CL1                 TYPE                                         
PSTTYPE7 EQU   7                   TYPE 7 = REGULAR TRANSACTIONS                
PSTTYPE8 EQU   8                   TYPE 8 = MEDIA TRANSFERS                     
*                                                                               
PSTSORT  DS    0CL28                                                            
PSTRATE  DS    XL2                 PST RATE                                     
PSTINDS  DS    X                   PST RATE DECIMALS 0=2, X'40'=3               
PSTCODE  DS    CL1                 PST CODE                                     
PSTACCT  DS    CL15                PST ACCOUNT CODE                             
PSTPROV  DS    CL2                 PST PROVINCE CODE                            
PSTNAME  DS    CL6                 PST PROVINCE NAME                            
         DS    CL1                 SPARE                                        
PSTKLNQ  EQU   *-PSTKY                                                          
PSTXTRA  DS    0CL86                                                            
PSTDATE  DS    PL3                 PST EFFECTIVE DATE                           
PSTREG   DS    CL12                REGISTRATION NUMBER                          
         DS    CL71                SPARE                                        
PSTXTLNQ EQU   *-PSTXTRA                                                        
PSTACCUM DS    CL(JOBLNQ)                                                       
PSTLNQ   EQU   *-PSTD                                                           
         TITLE 'SORTER DSECTS'                                                  
*                                  PROD. BILLING INVOICE REGISTER               
PBRD     DSECT                                                                  
PBRLEN   DS    F                   RECORD LENGTH                                
PBRKY    DS    0C                                                               
PBRTYP   DS    CL1                 TYPE                                         
PBREQU   EQU   1                   PROD. BILLING REGISTER                       
PBRCNT   DS    CL2                 RELATIVE INVOICE NUMBER                      
PBRCLI   DS    CL3                 CLIENT                                       
PBRMED   DS    CL1                 MEDIA                                        
PBRPRD   DS    CL3                 PRODUCT                                      
PBRJOB   DS    CL6                 JOB                                          
PBROTH   DS    CL9                 OTHER NUMBER                                 
PBRKLNQ  EQU   *-PBRKY                                                          
PBRDTE   DS    CL3                 DATE PWOS                                    
PBRBILL  DS    CL10                BILL NUMBER                                  
PBRACCUM DS    CL(JOBLNQ)          ACCUMULATORS - SEE JOBD                      
PBRLNQ   EQU   *-PBRD                                                           
         EJECT                                                                  
*                                  INTERNAL INVOICE REGISTER                    
INVRD    DSECT                                                                  
INVRLEN  DS    F                   RECORD LENGTH                                
INVRKEY  DS    0C                                                               
INVRTYP  DS    CL1                 TYPE                                         
INVREQU  EQU   2                   INTERNAL INVOICE                             
INVRCLI  DS    CL3                 CLIENT                                       
INVRPRD  DS    CL3                 PRODUCT                                      
INVRJOB  DS    CL6                 JOB                                          
INVRWRK  DS    CL2                 WORKCODE                                     
INVROTH  DS    CL9                 OTHER NUMBER                                 
INVRBILL DS    CL10                BILL NUMBER                                  
INVRKLNQ EQU   *-INVRKEY                                                        
INVRACC  DS    CL12                SK ACCOUNT                                   
INVRDTE  DS    CL3                 SK ITEM DATE PWOS                            
INVRREF  DS    CL6                 SK ITEM REFERENCE                            
INVRAMT  DS    PL8                 SK AMOUNT                                    
INVRLNQ  EQU   *-INVRD                                                          
         EJECT                                                                  
*                                  REGISTER OF TARGET ACCOUNTS                  
RTAD     DSECT                                                                  
RTALEN   DS    F                   RECORD LENGTH                                
RTAKEY   DS    0C                                                               
RTATYP   DS    CL1                 TYPE                                         
RTAEQU   EQU   3                   REGISTER OF TARGET ACCOUNTS                  
RTACLI   DS    CL3                 CLIENT                                       
RTAPRD   DS    CL3                 PRODUCT                                      
RTAJOB   DS    CL6                 JOB                                          
RTAOTH   DS    CL9                 OTHER NUMBER                                 
RTAKLNQ  EQU   *-RTAKEY                                                         
RTADTE   DS    CL3                 DATE PWOS                                    
RTABILL  DS    CL10                BILL NUMBER                                  
RTAREC   DS    CL12                RECEIVABLE ACCOUNT                           
RTACOST  DS    CL12                COSTING ACCOUNT                              
RTASALES DS    CL12                SALES ACCOUNT                                
RTAACCUM DS    CL(JOBLNQ)          ACCUMULATORS - SEE JOBD                      
RTALNQ   EQU   *-RTAD                                                           
         EJECT                                                                  
*                                  INCOME REGISTER                              
INCD     DSECT                                                                  
INCRLEN  DS    F                   RECORD LENGTH                                
INCRKEY  DS    0C                                                               
INCRTYP  DS    CL1                 TYPE                                         
INCREQU  EQU   4                   INCOME REGISTER                              
INCRCLI  DS    CL3                 CLIENT                                       
INCRPRO  DS    CL3                 PRODUCT                                      
INCRJOB  DS    CL6                 JOB                                          
INCRWRK  DS    CL2                 WORKCODE                                     
         DS    CL6                 SPARE                                        
INCKLNQ  EQU   *-INCRKEY                                                        
INCRBILL DS    CL10                BILL NUMBER                                  
INCRAMT  DS    PL6                 INCOME AMOUNT                                
INCRCR   DS    CL14                INCOME CREDIT ACCOUNT                        
INCRDR   DS    CL14                INCOME DEBIT ACCOUNT                         
INCRIAM  DS    PL6                 INCOME AMOUNT                                
INCRLNQ  EQU   *-INCD                                                           
         EJECT                                                                  
*                                  INTERCOMPANY REGISTER                        
INTD     DSECT                                                                  
INTRLN   DS    F                   RECORD LENGTH                                
INTRKEY  DS    0C                                                               
INTRTYP  DS    CL1                 TYPE                                         
INTREQU  EQU   5                   INTERCOMPANY POSTING                         
INTRSTUD DS    CL4                 STUDIO TYPE                                  
INTRMED  DS    CL1                 MEDIA CODE                                   
INTRSACC DS    0CL12               STUDIO ACCOUNT                               
INTRSCLI DS    CL3                  CLIENT                                      
INTRSPRO DS    CL3                  PRODUCT                                     
INTRSJOB DS    CL6                  JOB                                         
INTRKLNQ EQU   *-INTRKEY                                                        
INTRDATE DS    PL3                 DATE                                         
INTRBILL DS    CL10                BILL NUMBER                                  
INTRAMT  DS    PL8                 POSTING AMOUNT                               
INTRAJOB DS    CL12                AGENCY JOB                                   
INTRCACC DS    CL14                CREDIT ACCOUNT                               
INTRLNQ  EQU   *-INTD                                                           
         EJECT                                                                  
*                                  EXCEPTION REGISTER                           
EXCD     DSECT                                                                  
EXCRLN   DS    F                   RECORD LENGTH                                
EXCRKEY  DS    0C                                                               
EXCRTYP  DS    CL1                 TYPE                                         
EXCREQU  EQU   6                   STUDIO REGISTER                              
EXCRSTUD DS    CL4                 STUDIO TYPE                                  
EXCRSACC DS    0CL12               STUDIO ACCOUNT                               
EXCRSCLI DS    CL3                  CLIENT                                      
EXCRSPRO DS    CL3                  PRODUCT                                     
EXCRSJOB DS    CL6                  JOB                                         
EXCRKLNQ EQU   *-EXCRKEY                                                        
EXCRDATE DS    PL3                 DATE                                         
EXCRBILL DS    CL10                BILL NUMBER                                  
EXCRAJOB DS    CL12                AGENCY JOB                                   
EXCRMSG  DS    CL60                WARNING MESSAGE                              
EXCRLNQ  EQU   *-EXCD                                                           
         EJECT                                                                  
*                                  NON-BILLABLE JOB RECORDS                     
POBD     DSECT                                                                  
POBLN    DS    F                   RECORD LENGTH                                
POBKEY   DS    0C                                                               
POBTYP   DS    CL1                 TYPE                                         
POBEQU   EQU   7                   SUMMARY OF RETAINER JOBS                     
POBBIL   DS    CL1                 BILLING STATUS                               
POBCLI   DS    CL3                 CLIENT                                       
POBPRD   DS    CL3                 PRODUCT                                      
POBJOB   DS    CL6                 JOB                                          
         DS    CL8                                                              
POBKLNQ  EQU   *-POBKEY                                                         
POBACC   DS    CL14                ACCOUNT                                      
POBWC    DS    CL2                 WORKCODE                                     
POBBILL  DS    CL10                BILL NUMBER                                  
POBAMT   DS    PL8                 POB AMOUNT                                   
POBLNQ   EQU   *-POBD                                                           
         EJECT                                                                  
NOBD     DSECT                                                                  
NOBLEN   DS    F                   RECORD LENGTH                                
NOBKEY   DS    0C                                                               
NOBTYP   DS    CL1                 TYPE                                         
NOBEQU   EQU   8                   SUMMARY OF NON-BILLABLE JOBS                 
NOBCLI   DS    CL3                 CLIENT                                       
NOBPRD   DS    CL3                 PRODUCT                                      
NOBJOB   DS    CL6                 JOB                                          
NOBRSN   DS    CL1                 REASON CODE                                  
         DS    CL8                                                              
NOBKLNQ  EQU   *-NOBKEY                                                         
NOBDATA  DS    CL60                NARRATIVE                                    
NOBLNQ   EQU   *-NOBD                                                           
         EJECT                                                                  
         TITLE 'BINSRCH DSECTS'                                                 
*                                  MEDIA SUMMARY RECORDS                        
MESD     DSECT                                                                  
MESCDE   DS    CL1                 MEDIA CODE                                   
         DS    CL3                 SPARE                                        
MESKLEN  EQU   *-MESD                                                           
MESNME   DS    CL12                MEDIA NAME                                   
MESBK    EQU   *                                                                
MESACCUM DS    CL(JOBLNQ)          ACCUMULATORS - SEE JOBD                      
MESLNQ   EQU   *-MESD                                                           
         EJECT                                                                  
*                                  WORKCODE SUMMARY RECORDS                     
WRKD     DSECT                                                                  
WRKCDE   DS    CL2                 WORKCODE                                     
         DS    CL2                 SPARE                                        
WRKKLEN  EQU   *-WRKD                                                           
WRKBK    EQU   *                                                                
WRKACCUM DS    CL(JOBLNQ)          ACCUMULATORS - SEE JOBD                      
WRKLNQ   EQU   *-WRKD                                                           
         EJECT                                                                  
*                                  BINSRCH PARAMETER LIST                       
BIND     DSECT                                                                  
BININ    DS    F                   NUMBER IN TABLE                              
BINLEN   DS    F                   RECORD LENGTH                                
BINDISP  DS    CL1                 DISPLACEMENT IN RECORD                       
BINKEY   DS    CL3                 KEY LENGTH                                   
BINMAX   DS    F                   MAXIMUM NUMBER IN TABLE                      
BINNUMB  DS    CL1                 NUMBER OF BUCKETS                            
BINFRST  DS    CL1                 DISP. TO FIRST BUCKET                        
BINSTAT  DS    CL1                 X'80' BINARY DATA                            
         DS    CL1                 SPARE                                        
BINTABLE DS    0CL1                                                             
         TITLE 'MISCELLANEOUS DSECTS'                                           
*                                  BILLTAB                                      
BILLTD   DSECT                                                                  
BILLEN   DS    0CL20                                                            
BILLNME  DS    CL15                BILLING TYPE NAME                            
BILLCDE  DS    CL1                 BILLING CODE                                 
BILLTRNS DS    CL1                 READ TRANSACTIONS Y OR N                     
BILLEST  DS    CL1                 READ ESTIMATES Y OR N                        
BILLCOD  DS    CL1                 BILL TYPE CODE (TRNBTYPE)                    
BILLTYP  DS    XL1                 BILL TYPE                                    
         EJECT                                                                  
*                                  JOB ACCUMULATOR                              
JOBD     DSECT                                                                  
JOBBK    EQU   *                                                                
JOBNET   DS    PL8                 NET                                          
JOBCOMM  DS    PL8                 COMMISSION                                   
JOBGST   DS    PL8                 GST AMOUNT (GST RATE*JOBVBAS)                
JOBPST   DS    PL8                 PST AMOUNT (PST RATE*JOBPBAS)                
JOBINT   DS    PL8                 INTERNAL INCOME                              
*                                                                               
JOBCD    DS    PL8                 CASH DISCOUNT                                
JOBGRS   DS    PL8                 GROSS                                        
*                                                                               
JOBVBAS  DS    PL8                 JOBNET OR JOBGRS LESS CD                     
JOBVNET  DS    PL8                 JOBNET PLUS JOBGST                           
JOBVGRS  DS    PL8                 JOBGRS PLUS JOBGST                           
*                                                                               
JOBPBAS  DS    PL8                 JOBVBAS PLUS JOBGST                          
JOBPNET  DS    PL8                 JOBVNET PLUS JOBPST                          
JOBPGRS  DS    PL8                 JOBVGRS PLUS JOBPST                          
*                                                                               
JOBFUDGE DS    PL8                 I NEED THIS FOR ZERO TOTALS                  
*                                                                               
JOBBKCNT EQU   (*-JOBBK)/8         NUMBER OF BUCKETS                            
JOBLNQ   EQU   *-JOBD                                                           
         EJECT                                                                  
*                                  DISTRIBUTOR RECORD                           
RTLD     DSECT                                                                  
RTLDIS   DS    CL15                ACCOUNT CODE                                 
RTLNME   DS    CL36                NAME                                         
RTLADDR  DS    CL(4*L'ADRADD1)     ADDRESS                                      
RTLRECV  DS    CL15                RECEIVABLE ACCOUNT                           
RTLCOST  DS    CL15                COST ACCOUNT                                 
RTLPCT   DS    PL5                 PERCENT                                      
RTLPGST  DS    PL5                 PERCENT (UNROUNDED)                          
RTLUNT   DS    PL5                 UNITS                                        
RTLBIL   DS    CL6                 BILL NUMBER                                  
RTLSTAT  DS    XL1                 STATUS                                       
RTLOLD   EQU   X'80'               NO LONGER ACTIVE                             
RTLNBILL EQU   X'40'               BILLING DUE                                  
RTLCOMM  EQU   X'20'               SPECIAL COMMISSION RATE                      
RTLCRATE DS    PL4                 COMMISSION RATE (XX.XXXX%)                   
RTLCMTOT DS    PL8                 COMMISSION TOTAL AMOUNT                      
RTLCHG   DS    CL(JOBLNQ)          CHARGES                                      
RTLPRV   DS    CL(JOBLNQ)          PREVIOUS BILLS                               
RTLNET   DS    CL(JOBLNQ)          NET POSTINGS                                 
RTLLNQ   EQU   *-RTLD                                                           
         EJECT                                                                  
*                                  GST/PST SAVE TABLE                           
SVTABD   DSECT                                                                  
SVTYPE   DS    CL1                 G=GST, P=PST                                 
SVCODE   DS    CL1                 TAX CODE                                     
SVPROV   DS    CL2                 PROVINCE CODE (PST ONLY)                     
SVRATE   DS    XL2                 TAX RATE                                     
SVINDS   DS    X                   TAX RATE DECIMALS                            
SVNAME   DS    CL6                 PROVINCE NAME                                
SVACCT   DS    CL15                POSTING ACCOUNT                              
SVREG    DS    CL12                REGISTRATION NUMBER                          
SVDATE   DS    PL3                 EFFECTIVE DATE                               
SVTABLNQ EQU   *-SVTABD                                                         
         EJECT                                                                  
SUBTABD  DSECT                                                                  
SUBACT   DS    0C                                                               
SUBSTA   DS    XL(L'APENSTAT)      STATUS                                       
SUBACC   DS    CL(L'APENACT)       ACCOUNT                                      
SUBTABL  EQU   *-SUBTABD                                                        
         EJECT                                                                  
       ++INCLUDE ACVATICAND                                                     
         EJECT                                                                  
       ++INCLUDE DDCTRYEQUS                                                     
         EJECT                                                                  
GOBLOCKD DSECT                                                                  
       ++INCLUDE ACGOBLOCK                                                      
         EJECT                                                                  
GOXBLKD  DSECT                                                                  
       ++INCLUDE ACGOXBLOCK                                                     
         EJECT                                                                  
JBLOCKD  DSECT                                                                  
       ++INCLUDE ACJOBBLOCK                                                     
         EJECT                                                                  
       ++INCLUDE ACJOBBERD                                                      
         EJECT                                                                  
       ++INCLUDE ACWCNTABD                                                      
         EJECT                                                                  
*ACGENFILE                                                                      
         PRINT OFF                                                              
       ++INCLUDE ACGENFILE                                                      
         PRINT ON                                                               
*ACREPWORKD                                                                     
         PRINT OFF                                                              
       ++INCLUDE ACREPWORKD                                                     
         PRINT ON                                                               
*ACMASTD                                                                        
         PRINT OFF                                                              
       ++INCLUDE ACMASTD                                                        
         PRINT ON                                                               
*ACGENMODES                                                                     
         PRINT OFF                                                              
       ++INCLUDE ACGENMODES                                                     
         PRINT ON                                                               
*ACREPPROFD                                                                     
         PRINT OFF                                                              
       ++INCLUDE ACREPPROFD                                                     
         PRINT ON                                                               
*DDLOGOD                                                                        
         PRINT OFF                                                              
       ++INCLUDE DDLOGOD                                                        
         PRINT ON                                                               
*DDREPXTRAD                                                                     
         PRINT OFF                                                              
       ++INCLUDE DDREPXTRAD                                                     
         PRINT ON                                                               
*DDREMOTED                                                                      
         PRINT OFF                                                              
       ++INCLUDE DDREMOTED                                                      
         PRINT ON                                                               
*DDREPMASTD                                                                     
         PRINT OFF                                                              
       ++INCLUDE DDREPMASTD                                                     
         PRINT ON                                                               
*ACGENPOST                                                                      
         PRINT OFF                                                              
       ++INCLUDE ACGENPOST                                                      
         PRINT ON                                                               
*ACDDEQUS                                                                       
         PRINT OFF                                                              
       ++INCLUDE ACDDEQUS                                                       
         PRINT ON                                                               
*DDCUREDITD                                                                     
         PRINT OFF                                                              
       ++INCLUDE DDCUREDITD                                                     
         PRINT ON                                                               
* DDCOREQUS                                                                     
         PRINT OFF                                                              
       ++INCLUDE DDCOREQUS                                                      
         PRINT ON                                                               
* CTGENFILE                                                                     
         PRINT OFF                                                              
       ++INCLUDE CTGENFILE                                                      
         PRINT ON                                                               
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'109ACREP2102 12/22/14'                                      
         END                                                                    
