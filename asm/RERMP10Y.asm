*          DATA SET RERMP10Y   AT LEVEL 070 AS OF 09/20/00                      
*PHASE T81018A                                                                  
T81018   TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE'                           
***********************************************************************         
*============================= UPDATE LOG ============================*         
*   DATE   LVL USER   DESCRIPTION                                     *         
* -------- --- ----   ------------------------------------------------*         
* Jul19/00 067 GLEE - Bug fix (use label, not register)               *         
*                                                                     *         
* Jul07/00 066 GLEE - Support auto-PUT upgrade for E- & P- tracks     *         
*                                                                     *         
* Jun29/00 065 GLEE - Support "AVGn" day codes                        *         
*                                                                     *         
*                                                                     *         
*                                                                     *         
* jun30/00     bu   - remove references to GLV1GOTO per mel h.        *         
*                                                                     *         
* Jun22/00 063 GLEE - Bug fix--don't Refresh List Table if Input Parms*         
*                      gets cleared (ie. FldHdr+4=x80 & FldHdr+5=0)   *         
*                                                                     *         
* May31/00 062 GLEE - More changes for debugging purposes             *         
*                                                                     *         
* May24/00 061 GLEE - More trace throughout for debugging purposes    *         
*                                                                     *         
* Apr24/00 060 GLEE - Ability to display "VAR" on the detail lines    *         
*                                                                     *         
* Apr06/00 059 GLEE - Put trace throughout for debugging purposes     *         
*                                                                     *         
* Mar07/00 058 GLEE - Adjust QHs referenced thru DBACTSQH & DBACTEQH  *         
*                                                                     *         
* Feb17/00 057 GLEE - Use LPSTTN station in List Table entries        *         
*                                                                     *         
* Feb02/00 056 GLEE - Clean up some commented code                    *         
*              GLEE - Comment out the intermediate CCVHPT call        *         
*                                                                     *         
* Nov10/99 055 GLEE - Re-linked for new RMPC7 screen                  *         
*              GLEE - Display asteriks if field can't fit SHR value   *         
*                                                                     *         
* Oct22/99 054 GLEE - Set DBFILE=INV when extracting demos            *         
*                                                                     *         
* Oct22/99 053 GLEE - Move XDV# routine to SUBR07                     *         
*                                                                     *         
* Oct13/99 052 GLEE - Enable AutoPFM via options field                *         
*                                                                     *         
* Oct12/99 051 GLEE - New optn flag-OPDFDDSO-to indicate for DDS only *         
*                                                                     *         
* Aug12/99 033 GLEE - Check code elem to see if track created w/ OPROJ*         
*                                                                     *         
* Jun10/99 032 GLEE - Hardcode for WKMGT & WCPXT call letter reuse    *         
*                                                                     *         
* May18/99 031 GLEE - Support footnote updateing with profile         *         
*                                                                     *         
* May11/99 030 GLEE - Use BEST=A option to retrieve NOR programs      *         
*                                                                     *         
* May10/99 029 GLEE - Fix bug inside BIT# routine w/ fudging logic    *         
*              GLEE - Skip unweighing if cumulative factor is zero    *         
*                                                                     *         
* Apr07/99 028 GLEE - Group SYSD fields containing track info together*         
*                                                                     *         
* Apr07/99 027 GLEE - Format HPV upgrade                              *         
*                                                                     *         
* Apr06/99 026 GLEE - Force DBLOCK input parms for DEMOMATH calls     *         
*                                                                     *         
* Apr02/99 025 GLEE - Handle DEMAND calls where DEMHOOK3 isn't called *         
*                                                                     *         
* Mar12/99 024 GLEE - Do not reset DF1BUNIV on EVERY DEMAND call      *         
*              GLEE - Normalize PUTs and TOTs as well                 *         
*                                                                     *         
* Mar11/99 023 GLEE - Format MMU upgrade                              *         
*                                                                     *         
* Mar01/99 022 GLEE - Skip demo recd manipulation in DEMHOOK3 if just *         
*                      pulling demo values from inventory tracks      *         
*                                                                     *         
* Feb19/99 021 GLEE - Move SDV# routine to SUBR07                     *         
*                                                                     *         
* Feb18/99 020 GLEE - Normalize rtgs & imps when imp-based            *         
*                                                                     *         
* Feb18/99 019 GLEE - Set up SUBR07 sub-routine pool                  *         
*                                                                     *         
* Feb12/99 018 GLEE - New option to pull PUTs from an alternate dy/tim*         
*                                                                     *         
* Jan18/99 017 GLEE - Fix bug in GIR# routine                         *         
*              GLEE - Support operand #4 in HPT upgrade               *         
*                                                                     *         
* Jan05/99 016 GLEE - Make more room in SYSSPARE                      *         
*              GLEE - Initialize TMPQLFY to blank in RKS# routine     *         
*                                                                     *         
* Nov06/98 015 GLEE - Provide error msg if BIT# fails to build track  *         
*                                                                     *         
* Nov05/98 014 GLEE - Skip DEMUP call if no x'5E' element in record   *         
*                                                                     *         
* Nov04/98 013 GLEE - Code to support new PUT formula feature         *         
*                                                                     *         
* Oct29/98 012 GLEE - Update-ftnote-on-save default to NO for ABC only*         
*                                                                     *         
* Sep29/98 011 GLEE - Fudge in normal select code when needed         *         
*                                                                     *         
* Sep29/98 010 GLEE - Fix bug with displaying demo category           *         
*                   - Clear option values on key change               *         
*                                                                     *         
* Sep02/98 009 GLEE - Support overriding of footnote                  *         
*                   - Move BIT#, FNR#, UAE#, and PLR# rtns to SUBR06  *         
*                                                                     *         
* Sep02/98 008 GLEE - Support  Expand Demos  function                 *         
*                                                                     *         
* Aug31/98 007 GLEE - Move LTFT4 & LTFPURE flags to LTFLAG2           *         
*                     Comment out calculation of CUMDEMV in CCV#      *         
*                     Support auto-select of PAV lines                *         
*                                                                     *         
* Aug31/98 006 GLEE - Set up SUBR06 sub-routine pool                  *         
*                                                                     *         
* Aug31/98 005 GLEE - Fix bug in validating demo category input parm  *         
*                   - Various bug fixes                               *         
*                                                                     *         
* Aug31/98 004 GLEE - Use  R7  as third base register in main NMOD    *         
*                                                                     *         
* Aug28/98 003 GLEE - Reorganize sub-routine pools                    *         
*                                                                     *         
* Aug27/98 002 GLEE - Set up a generalized GETEL macro routine        *         
*                   - Set up generalized exit routines                *         
*                                                                     *         
* Aug27/98 001 GLEE - Archived source to GLRERMP18                    *         
*                   - Clean up some old clutter                       *         
*                   - Re-leveled back to 001                          *         
*                                                                     *         
* May15/96 NTE GLEE - The code delimited by *^^COCO and *^^EOCOCO are *         
*                      per Chris.  She asked to suppress the restric- *         
*                      tions imposed on whether a track is an actual  *         
*                      book or a P- or E-book.                        *         
***********************************************************************         
         EJECT                                                                  
RMP18    CSECT                                                                  
         PRINT NOGEN                                                            
         NMOD1 LOCWRKL,T81018**,R9,R7,RR=RE,CLEAR=YES                           
                                                                                
         LR    R0,RC               HOLD ONTO ADDRESS OF IUN WORK AREA           
         L     RC,0(R1)                                                         
         USING GEND,RC                                                          
         L     RA,ATWA                                                          
         USING CONHEADH-64,RA                                                   
         L     R8,ASYSD                                                         
         USING SYSD,R8                                                          
                                                                                
         ST    RE,RELO                                                          
         ST    RB,MYBASE1                                                       
         ST    R9,MYBASE2                                                       
         ST    R7,MYBASE3                                                       
         ST    R0,AIUNWRK                                                       
                                                                                
         AHI   R0,IUNWRKL           BUMP PAST IUN WORK AREA                     
         ST    R0,ARM18WRK          = A(RMP18 WORK AREA)                        
         LR    RF,R0                                                            
         MVC   0(8,RF),=C'*RM18WK*'                                             
*                                                                               
         BAS   RE,MYINIT           INITIALIZATION                               
*                                                                               
         DS    0H                  CHECK GENCON MODES                           
         CLI   MODE,VALKEY                                                      
         BE    VKEY                                                             
         CLI   MODE,VALREC                                                      
         BE    VREC                                                             
         B     XIT                                                              
*                                                                               
YES      SR    RC,RC                                                            
NO       LTR   RC,RC                                                            
XIT      XIT1                                                                   
                                                                                
XIT_RTRN DS    0H                  EXIT PROGRAM AND RETURN TO CALLER            
         CLI   CALLSP,0             MAKE SURE THERE WAS A CALLER                
         BH    *+6                                                              
         DC    H'0'                                                             
         SR    R2,R2                LET GENCON DECIDE WHERE CURSOR GOES         
         MVI   PFKEY,12             SIMULATE THE HIT OF PF12                    
         MVI   GOAGAIN,C'Y'                                                     
         GOTO1 ERREX2                                                           
         EJECT                                                                  
***********************************************************************         
*========================= MY INITIALIZATION =========================*         
         DS    0H                                                               
MYINIT   NTR1                                                                   
*                                                                               
         DS    0H                  CHECK IF PHASE IS CALLED CORRECTLY           
         MVI   MYCALLER,0                                                       
         ZICM  R1,CALLSP,(1)                                                    
         BZ    MI02X                                                            
         BCTR  R1,0                                                             
         MH    R1,=H'3'                                                         
         LA    R1,CALLSTCK(R1)                                                  
                                                                                
         MVC   MYCALLER,0(R1)       REMEMBER WHO CALLED THIS PHASE              
         CLI   0(R1),SCINVTRA      INV/TRACKS                                   
         BE    MI02X                                                            
         CLI   0(R1),SCINVLST      INV/LIST                                     
         BE    MI02X                                                            
         CLI   0(R1),SCINVDLS      INV/DLIST                                    
         BE    *+6                                                              
         DC    H'0'                                                             
MI02X    EQU   *                                                                
                                                                                
         DS    0H                  GET SYSTEM INPUT NUMBER                      
         XC    DUB,DUB                                                          
         MVC   DUB(4),=X'FEFFFFFF'                                              
         GOTO1 SWITCH,DUB                                                       
         ZICM  RF,DUB+1,(7)         RF-->SYSFAC                                 
         L     RE,VSSB-SYSFACD(RF)  RE-->SSB                                    
         MVC   MYSSBSIN,SSBSIN-SSBD(RE)                                         
                                                                                
*                                                                               
         DS    0H                                                               
         MVI   FIRSTIME,C'N'                                                    
         CLC   IRO1TIM,=C'HI'      <===THIS IS A ZERO-INTENSFIED FIELD          
         BE    MI04X                                                            
         MVI   FIRSTIME,C'Y'                                                    
         MVC   IRO1TIM,=C'HI'                                                   
         OI    IRO1TIMH+6,X80                                                   
         XC    SVSSBSIN,SVSSBSIN                                                
         XC    DIDTHIS(2),DIDTHIS                                               
         XC    PVGOSTAC,PVGOSTAC                                                
MI04X    EQU   *                                                                
                                                                                
*                                                                               
         DS    0H                                                               
         CLC   SVSSBSIN,MYSSBSIN   SAME TRANSACTION?                            
         BE    MI06X                YEP                                         
         MVC   DUNTHAT(2),DIDTHIS   NO, GET TRACE FROM PREV TRANSACTION         
         XC    DIDTHIS(2),DIDTHIS    INIT TRACE FOR THIS TRANSACTION            
         MVC   PVGOSTAC,GOSTACK      GET GOSUB STACK FROM PREV TRNSCT'N         
         XC    GOSTACK(GOSTACKL),GOSTACK INIT GOSTACK FOR THIS TRNSCT'N         
MI06X    EQU   *                                                                
                                                                                
*                                                                               
         DS    0H                  SET UP ADCONS OF TABLES & ROUTINES           
         L     R2,=A(DISPTAB-RMP18)                                             
         LA    R2,RMP18(R2)                                                     
         LA    R0,DISPTABQ                                                      
                                                                                
MI10     DS    0H                                                               
         ZICM  R1,0(R2),(3)                                                     
         LA    RE,RMP18            RE = BASE OF TABLE/ROUTINE                   
         ZICM  RF,2(R2),(3)                                                     
         BZ    *+12                                                             
         LA    RF,GEND(RF)                                                      
         L     RE,0(RF)                                                         
         AR    R1,RE               R1 = A(TABLE OR ROUTINE)                     
         ZICM  RF,4(R2),(3)                                                     
         A     RF,ASYSD            RF-->PLACE TO STORE ADDRESS                  
         ZICM  RE,6(R2),(3)        SEE IF THERE IS ANOTHER PLACE                
         BZ    *+10                 NOPE                                        
         A     RE,0(RF)             YEP, GET NEW STORAGE ADDRESS                
         LR    RF,RE                                                            
         ST    R1,0(RF)                                                         
         LA    R2,L'DISPTAB(R2)                                                 
         BCT   R0,MI10                                                          
*                                                                               
         DS    0H                  SET UP LABELS IN BIGAREA                     
         L     R2,=A(LBLTAB-RMP18)                                              
         LA    R2,RMP18(R2)                                                     
         LA    R0,LBLTABQ                                                       
                                                                                
MI20     DS    0H                                                               
         ZICM  R1,0(R2),(3)                                                     
         A     R1,ATIA             R1 = A(TO PUT LABEL)                         
         MVC   0(8,R1),2(R2)        AND MOVE LABEL IN                           
         LA    R2,L'LBLTAB(R2)                                                  
         BCT   R0,MI20                                                          
*                                                                               
MI40     DS    0H                                                               
         MVI   IOOPT,C'Y'          CONTROL MY OWN ADDREC AND PUTREC             
         MVI   ACTELOPT,C'N'       DON'T MONITOR ACTIVITY                       
         MVC   AIO,AIO1                                                         
         MVC   MYSCRNUM,TWASCR     SET SCREEN NUMBER                            
         OI    CONSERVH+6,X80+X01  FOR PFKEYS TO WORK                           
         OI    GENSTAT1,RDUPAPPL   WE CONTROL READ FOR UPDATE                   
*                                                                               
         DS    0H                  MOVE PROFILE TO LOCAL WORKNG STORAGE         
         LR    RF,RA                                                            
         AH    RF,=AL2(SFMPROFS-CONHEADH)                                       
         USING SVDSECT,RF                                                       
         MVC   RMPPROFS,SVPGPBIT                                                
         DROP  RF                                                               
*                                                                               
         DS    0H                  TRANSLATE DATA DICT TERMS                    
         XC    DMCB(6*4),DMCB                                                   
         LA    R1,DMCB                                                          
         USING DICTATED,R1                                                      
         MVI   DDACTN,DDACTNL                                                   
         MVI   DDRETN,DDCASEL                                                   
         MVI   DDRETN,C'M'         (NO IDEA WHY THIS YIELDS LOWER CASE)         
         MVI   DDSYS,8                                                          
         MVI   DDLANG,C' '                                                      
         L     RE,=A(DCLIST-RMP18)                                              
         A     RE,MYBASE1                                                       
         STCM  RE,7,DDIADR                                                      
         LA    RE,DSLIST                                                        
         STCM  RE,7,DDOADR                                                      
         GOTO1 DICTATE,(R1)                                                     
         DROP  R1                                                               
                                                                                
         NI    RE@OPTS,XFF-X40     CHANGE FROM C'O' TO C'o'                     
*                                                                               
         XC    ACURFORC,ACURFORC                                                
         LA    R0,IROLDTAH+(LLACTH-LLINED)                                      
         ST    R0,A1SELFLD         A(1ST SELECT FIELD)                          
*                                                                               
         DS    0H                  SET COLUMN HEADERS FOR LIST                  
         LA    R2,IROLHEDH                                                      
         USING LLINED,R2                                                        
         CLC   LLACT,=C'Actn'      WAS IT SET BEFORE?                           
         BE    MI78                 YES, DON'T SET THEM AGAIN                   
         MVC   LLACT,=C'Actn'      ACTION                                       
         MVI   LLDHSRC,C'S'        SOURCE                                       
         MVC   LLDHFLCD,=C'F/C'    FILE/CODE                                    
         MVC   LLDHBOOK,=C'Book'   BOOK                                         
         MVC   LLDHSTTN,=C'Sttn'   STATION                                      
         MVC   LLDHTITL,=C'Title'  PROGRAM TITLE                                
         MVC   LLDHDAY,=C'Day'     FILE/CODE                                    
         MVC   LLDHSTIM,=C'Start'  START TIME                                   
         MVC   LLDHQHRS,=C'QHs'    # OF QUARTER HOURS                           
         MVC   LLDHWPIN,=C'W/P/I#' WEEK/PURE/INVENTORY NUMBER                   
         MVC   LLDHDRTG,=C'RTG'    DEMO RATING                                  
         MVC   LLDHDSHR,=C'SHR'    DEMO SHARE                                   
         MVC   LLDHDPUT,=C'PUT'    DEMO PUT                                     
         OI    LLACTH+6,X80                                                     
         OI    LLDISH+6,X80                                                     
         DROP  R2                                                               
MI78     EQU   *                                                                
*                                                                               
         MVC   DEFLTBK,=X'530B'                                                 
*                                                                               
         MVC   DSP1EL,=Y(RINVPEL-RINVREC)                                       
*                                                                               
         MVC   DCFILTP,=C'TP '                                                  
         MVC   DCFILPAV,=C'PAV'                                                 
         MVC   DCFILIUN,=C'IUN'                                                 
         MVC   DCFILINV,=C'INV'                                                 
*                                                                               
         DS    0H                  GET TYPE OF DEMO CALC PRECISION              
         MVI   MYTAPEP,0            ASSUME BOOK (RTG) BASED                     
         TM    RMPPROFS+RMPIMPSB,RMPIMPSA                                       
         BZ    *+8                                                              
         MVI   MYTAPEP,C'Y'         TAPE (IMP) BASED, AS PER PROFILE            
*                                                                               
         DS    0H                  TASKS FOR 1ST TIME AROUND                    
         CLI   FIRSTIME,C'Y'        IS THIS THE 1ST TIME AROUND?                
         BNE   MI89                  NO                                         
*                                                                               
         DS    0H                   LOAD DEFAULT (PROFILE-CTRL) SCREEN          
         OI    SCRNFLG,SCRFXPDM      ASSUME DFLT TO XPND DEMO SCRN              
         NI    SCRNFLG,XFF-SCRFLIST                                             
         TM    RMPPROFS+RMPRXPDB,RMPRXPDA  PROFILE = XPND DEMOS?                
         BNZ   MI82G                        YEP                                 
         XI    SCRNFLG,SCRFLIST+SCRFXPDM                                        
MI82G    EQU   *                                                                
         MVI   GOSUBN,LSCR#          LOAD SCREEN                                
         GOTO1 AGOSUB                                                           
MI89     EQU   *                                                                
                                                                                
*                                                                               
MIX      DS    0H                                                               
         MVC   SVSSBSIN,MYSSBSIN                                                
         B     XIT                                                              
***********************************************************************         
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (VALKEY)'                  
***********************************************************************         
*======================== VALIDATE KEY ROUTINE =======================*         
VKEY     DS    0H                                                               
*                                                                               
         XC    INPUTKEY(IKLNQ),INPUTKEY                                         
*                                                                               
         NI    CHNGFLG1,XFF-CF1KEY                                              
         NI    MISCFLG1,XFF-MF1GDPLY  DON'T FORCE TO DISPLAY, YET               
         NI    MISCFLG1,XFF-MF1GOPFM  ASSUME AUTO-PFM NOT REQUESTED             
         NI    DPLYFLG1,XFF-DF1FTNOT  ASSUME DON'T NEED TO DSPLY FTNOTE         
         NI    DPLYFLG1,XFF-DF1OPTN   ASSUME DON'T NEED TO RE-DSPLY OPT         
         NI    RECDFLG1,XFF-RF1DEL-RF1DNXST                                     
*                                     ASSUME RECD EXISTS & NOT DELETED          
         NI    MISCFLG1,X'FF'-(MF1TDFTP+MF1TDFTT)                               
         NI    UPGFLAG,XFF-UPGFPUT    ASSUME AUTO PUT-UPGRADE NOT APPLD         
                                                                                
         OI    MISCFLG1,MF1RDDEL   READ DELETED RECORDS                         
                                                                                
         XC    AMNISTRT,AMNISTRT                                                
         XC    AMNIEND,AMNIEND                                                  
         XC    OPTR,OPTR           NO OPTIONS REQUIRED                          
         XC    OPTX,OPTX            NOR DIS-ALLOWED                             
         XC    MYTEXT(MYTEXTL),MYTEXT                                           
                                                                                
*                                                                               
         DS    0H                  FILL IN STUFF FROM INEFFTAB                  
         OC    INEFFTAB,INEFFTAB                                                
         BZ    VK005X                                                           
         MVC   IROINV,INEFFTAB+1                                                
         MVI   IROINVH+5,4                                                      
         OI    IROINVH+6,X80                                                    
         MVC   IROEFFD,(INEFFTAB+1)+4                                           
         MVI   IROEFFDH+5,8                                                     
         OI    IROEFFDH+6,X80                                                   
         XC    INEFFTAB,INEFFTAB                                                
VK005X   EQU   *                                                                
*                                                                               
*-------------------------- VALIDATE STATION -------------------------*         
*                                                                               
         LA    R2,IROSTTNH         STATION                                      
         BAS   RE,KYCHNGED          SEE IF THIS KEY FIELD CHANGED               
         GOTO1 ANY                  MUST HAVE A STATION INPUT                   
         GOTO1 VALISTA              VALIDATE THE STATION INPUTTED               
         OI    4(R2),X20                                                        
                                                                                
         MVC   IKSTTN,WORK         HOLD ONTO KEY FIELD INPUT                    
         CLI   IKSTTN+4,C' '                                                    
         BNE   *+8                                                              
         MVI   IKSTTN+4,C'T'                                                    
         CLI   WORK+40,C' '        CHECK FOR SATELLITES                         
         BE    *+10                                                             
         MVC   IKSTTN+4(1),WORK+40                                              
*                                                                               
*--------------------- VALIDATE INVENTORY NUMBER ---------------------*         
*                                                                               
         LA    R2,IROINVH          INVENTORY NUMBER                             
         BAS   RE,KYCHNGED          SEE IF THIS KEY FIELD CHANGED               
         GOTO1 ANY                  MUST HAVE AN INVENTORY # INPUT              
         OI    4(R2),X20                                                        
                                                                                
         MVC   IKINV,WORK          HOLD ONTO KEY FIELD INPUT                    
*                                                                               
*--------------------------- EFFECTIVE DATE --------------------------*         
*                                                                               
         XC    IKEFFDB,IKEFFDB                                                  
         XC    IKEFFDC,IKEFFDC                                                  
         LA    R2,IROEFFDH         EFFECTIVE DATE                               
         BAS   RE,KYCHNGED          SEE IF THIS KEY FIELD CHANGED               
         CLI   5(R2),0                                                          
         BH    VK035                                                            
*&&DO                                                                           
         DS    0H                  NO EFFECTIVE DATE INPUTTED                   
         NI    MISCFLG1,XFF-MF1RDDEL  DON'T READ DELETED RECDS                  
         CLI   ACTNUM,ANROVER         OKAY FOR ACTION=ROVER                     
         BE    VK039                                                            
         B     MISSFLD                 OTHERWISE, MISSING INPUT FIELD           
*&&                                                                             
*                                                                               
         DS    0H                  NO EFFECTIVE DATE INPUTTED                   
         NI    MISCFLG1,XFF-MF1RDDEL  DON'T READ DELETED RECDS                  
         CLI   ACTNUM,ANROVER         OKAY FOR ACTION=ROVER                     
         BNE   MISSFLD                 OTHERWISE, MISSING INPUT FIELD           
*                                                                               
         MVI   GOSUBN,BIK#                                                      
         GOTO1 AGOSUB                                                           
*                                                                               
         GOTO1 GETINV                                                           
*                                                                               
         GOTO1 DATCON,DMCB,(3,KEY+21),(5,IROEFFD)                               
         MVI   IROEFFDH+5,8                                                     
         OI    IROEFFDH+6,X'80'                                                 
*                                                                               
VK035    DS    0H                                                               
         GOTO1 DATVAL,DMCB,(0,8(R2)),WORK                                       
         OC    DMCB(4),DMCB                                                     
         BZ    INVLFLD                                                          
         GOTO1 DATCON,DMCB,(0,WORK),(3,IKEFFDB)                                 
         GOTO1 DATCON,DMCB,(0,WORK),(2,IKEFFDC)                                 
                                                                                
VK039    DS    0H                                                               
         OI    4(R2),X20                                                        
*                                                                               
*-------------------------- VALIDATE SOURCE --------------------------*         
*                                                                               
         LA    R2,IROSRCH          SOURCE (RATING SERVICE)                      
         CLI   CALLSP,0             IF CALLED FROM ANOTHER SCREEN,              
         BE    VK042                                                            
         CLI   MYCALLER,SCINVLST     (UNLESS SCREEN IS INV/LIST)                
         BE    VK042                                                            
         CLI   MYCALLER,SCINVDLS     (UNLESS SCREEN IS INV/DLIST)               
         BE    VK042                                                            
         CLI   5(R2),0               THERE MAY BE NOTHING IN KEY FIELD          
         BH    VK042                                                            
         B     VKX_RTRN              IF SO, RETURN DIRECTLY TO CALLER           
                                                                                
VK042    DS    0H                                                               
         CLI   5(R2),0             IF NO INPUT IN FIELD,                        
         BH    *+20                                                             
         MVI   8(R2),C'N'           DEFAULT TO NSI,                             
         OI    6(R2),X80             TRANSMIT FIELD,                            
         MVI   5(R2),1               FUDGE IN INPUT LENGTH,                     
         OI    4(R2),X80             AND FUDGE "INPUT THIS TIME" BIT            
                                                                                
         BAS   RE,KYCHNGED          SEE IF THIS KEY FIELD CHANGED               
         GOTO1 ANY                                                              
                                                                                
         MVC   OURBYTE,5(R2)                                                    
         LA    R0,WORK                                                          
         MVI   GOSUBN,VSRC#                                                     
         GOTO1 AGOSUB                                                           
         BNE   INVLFLD                                                          
         CLC   TMPRSVC,=C'NHT'      NHT NO GOOD IN KEY                          
         BE    INVLFLD                                                          
         MVC   IKRSVC,TMPRSVC                                                   
         MVC   IKSRC,TMPSRC                                                     
         OI    4(R2),X20                                                        
*                                                                               
*--------------------------- VALIDATE BOOK ---------------------------*         
*                                                                               
         LA    R2,IROBOOKH         BOOK                                         
         CLI   CALLSP,0             IF CALLED FROM ANOTHER SCREEN,              
         BE    VK052                                                            
         CLI   MYCALLER,SCINVLST     (UNLESS SCREEN IS INV/LIST)                
         BE    VK052                                                            
         CLI   MYCALLER,SCINVDLS     (UNLESS SCREEN IS INV/DLIST)               
         BE    VK052                                                            
         CLI   5(R2),0               THERE MAY BE NOTHING IN KEY FIELD          
         BH    VK052                                                            
         B     VKX_RTRN              IF SO, RETURN DIRECTLY TO CALLER           
                                                                                
VK052    DS    0H                                                               
         BAS   RE,KYCHNGED          SEE IF THIS KEY FIELD CHANGED               
*                                                                               
         CLI   MYCALLER,SCINVLST     IF CALLED FROM INV/LIST SCREEN             
         BE    *+8                                                              
         CLI   MYCALLER,SCINVDLS      OR CALLED FROM INV/DLIST SCREEN           
         BE    *+8                                                              
         B     VK054G                                                           
         TM    IROSRCH+4,X40          FOR THE FIRST TIME,                       
         BNZ   VK054G                                                           
         CLI   5(R2),0                AND NOTHING IN BOOK FIELD,                
         BNE   VK054G                                                           
         MVI   OURINFCD,ENTFLDQ       DISPLAY INFO MSG INSTEAD OF ERR           
         B     OURINFO                                                          
VK054G   EQU   *                                                                
         GOTO1 ANY                                                              
                                                                                
         XC    DUB,DUB             CLEAR OUTPUT AREAS                           
         MVI   BYTE,0                                                           
         GOTO1 BOOKVAL,DMCB,(IKRSVC,(R2)),(1,DUB),(C'B',SCANNER),BYTE           
         CLI   4(R1),1                                                          
         BNE   INVLFLD                                                          
                                                                                
         MVC   IKFRBK,DUB          SET BITS AND BOOK                            
         MVC   IKBTYP,BYTE          AND BOOK TYPE                               
*                                                                               
** GET SOURCE CODE FOR RINVKSRC **                                              
*                                                                               
         LA    R1,GKSIPARM                                                      
         USING GKSPARMD,R1                                                      
         XC    GKSPARMD(GKSPARML),GKSPARMD                                      
         MVC   GKSPBKBT,IKFRBTS                                                 
         MVC   GKSPBTYP,IKBTYP                                                  
         DROP  R1                                                               
         GOTO1 VGETKSRC,DMCB,(C'B',GKSIPARM),GKSOPARM                           
         CLI   DMCB+4,0                                                         
         BNE   INVLFLD                                                          
                                                                                
         MVC   IKKSRC,GKSOPARM+(GKSPKSRC-GKSPARMD)                              
         OI    4(R2),X20                                                        
         EJECT                                                                  
* The key has been validated.  Now is a good time to restore those              
*  values saved in the previous transaction if the key hasn't changed.          
                                                                                
         DS    0H                                                               
         CLI   CALLSP,0            IF CALLED FROM INV/TRACKS SCREEN,            
         BH    VK062A               RESTORE FOR INV/TRACKS SAVED DATA           
         TM    CHNGFLG1,CF1KEY     IF KEY DID NOT CHANGE,                       
         BZ    VK062A               RESTORE PREVIOUS SAVED DATA                 
         B     VK064                                                            
                                                                                
VK062A   DS    0H                                                               
         OI    DIDTHIS,DIDRTI#     TRACE--DOING RESTORE TIA                     
         MVI   GOSUBN,RTI#                                                      
         GOTO1 AGOSUB                                                           
*                                                                               
VK064    DS    0H                                                               
         TM    CHNGFLG1,CF1KEY     IF KEY DID NOT CHANGE,                       
         BZ    VK064A               REMEMBER PREVIOUS SAVED DATA                
         B     VK066                                                            
                                                                                
VK064A   DS    0H                                                               
         OI    DIDTHIS,DIDSPRV#    TRACE--DOING SAVE PREVIOUS VALUES            
         MVI   GOSUBN,SPRV#        SAVE PREVIOUS VALUES                         
         GOTO1 AGOSUB                                                           
*                                                                               
VK066    DS    0H                                                               
         B     VK070                                                            
*                                                                               
*----------------------- VALIDATE OPTIONS FIELD ----------------------*         
*                                                                               
VK070    DS    0H                                                               
         NI    CHNGFLG1,XFF-CF1OPT                                              
         TM    CHNGFLG1,CF1KEY     DID A KEY FIELD CHANGE?                      
         BO    VK080                YES, DON'T VALIDATE OPTIONS                 
*                                                                               
         LA    RE,IROOPT1H                                                      
         LH    RF,DLASTINP                                                      
         A     RF,ATWA                                                          
         STM   RE,RF,AMNISTRT      SET START/END TO MDFY FOR NEXT INPUT         
                                                                                
         L     R3,=A(MGFOPT-RMP18) NEED TO MERGE OPTION FIELDS                  
         A     R3,MYBASE1                                                       
         MVI   GOSUBN,MGF#                                                      
         GOTO1 AGOSUB                                                           
*                                                                               
         LA    R2,BLOCK            BLOCK CONTAINS MERGED FIELDS                 
         TM    4(R2),X80           WAS FIELD INPUTTED THIS TIME?                
         BZ    VK074                NO, DON'T SET FLAG(BUT VALIDATE)            
         OI    CHNGFLG1,CF1OPT      YES, AN OPTION CHANGED                      
                                                                                
**          ALWAYS VALIDATE OPTIONS ON KEY CHANGE WHETHER FIELD                 
**          MARKED AS CHANGED OR NOT BECAUSE SOME OPTIONS ARE                   
**          BROUGHT IN FROM THE RECORD (IE: UPGRADES) WHICH NEED                
**          TO SET VALUES       -FJD 9/20/00                                    
VK074    DS    0H                                                               
         OI    DIDTHIS,DIDVOPT     TRACE--VALIDATING OPTIONS                    
         BAS   RE,VALOPT            GO VALIDATE OPTIONS                         
         BE    VK078                                                            
*                                                                               
         DS    0H                  INVALID OPTION ENCOUNTERED                   
         L     R3,=A(MGFOPT-RMP18)  DETERMINE WHERE TO PUT CURSOR               
         A     R3,MYBASE1                                                       
                                                                                
VK076A   DS    0H                                                               
         ZICM  R2,0(R3),(3)        IF END OF TABLE REACHED,                     
         BZ    VK076B                                                           
         LA    R2,T810FFD(R2)      R2-->AN OPTION FLD THAT WAS MERGED           
         ZIC   RE,5(R2)            RE = L(INPUT IN THIS OPTN FLD)               
         ZIC   RF,FLDDSPL          RF = DISPL INTO OPTN FLD                     
         CR    RE,RF               IF L(INPUT) > DSPL INTO FIELD,               
         BH    VK076B               THIS IS THE FLD TO PUT CURSOR ON            
         SR    RF,RE               ELSE, KEEP REDUCING FLDDSPL                  
         STC   RF,FLDDSPL                                                       
         LA    R3,2(R3)                                                         
         B     VK076A                                                           
                                                                                
VK076B   DS    0H                  SET TIOB FOR CURSOR POSITION                 
         OR    R2,R2                DOES R2 POINT TO AN OPTIONS FIELD?          
         BNZ   *+8                                                              
         LA    R2,IROOPT1H           NO, POINT IT TO 1ST OPTION FIELD           
         L     R1,SYSPARMS                                                      
         L     RF,0(R1)             RF-->TIOB                                   
         USING TIOBD,RF                                                         
         OI    TIOBINDS,TIOBSETC                                                
         LR    R0,R2                                                            
         S     R0,ATWA                                                          
         STH   R0,TIOBCURD                                                      
         MVC   TIOBCURI,FLDDSPL                                                 
         DROP  RF                                                               
                                                                                
         B     OURERROR                                                         
*                                                                               
VK078    DS    0H                  OPTIONS INPUTTED ARE VALID                   
         ZICM  RE,0(R3),(3)                                                     
*&&DO                                                                           
         BZ    VK080                                                            
*&&                                                                             
         BZ    VK078X                                                           
         A     RE,ATWA                                                          
         OI    4(RE),X20            TURN ON "FIELD HAS BEEN VALIDATED"          
         LA    R3,2(R3)                                                         
         B     VK078                                                            
VK078X   EQU   *                                                                
                                                                                
*                                                                               
         DS    0H                  CHECK SPECIFICALLY FOR AUTO-PFM              
         CLI   OPVPFMTB,C'P'        IF IT IS,                                   
         BNE   *+12                                                             
         OI    DPLYFLG1,DF1OPTN      SET TO RE-DISPLAY OPTIONS                  
         OI    MISCFLG1,MF1GOPFM     AND REMEMBER TO CALL GLOBBER               
                                                                                
                                                                                
VK080    DS    0H                                                               
*                                                                               
*--------------------- MISCELLANEOUS VALKEY TASKS --------------------*         
*                                                                               
VK100    DS    0H                                                               
                                                                                
         DS    0H                  GET INVENTORY RECORD                         
         MVI   GOSUBN,BIK#          BUILD KEY TO INVENTORY RECORD               
         GOTO1 AGOSUB                                                           
         MVC   SAVEKEY,KEY           AND HOLD ONTO IT                           
                                                                                
         MVI   MYRDUPDT,C'N'                                                    
         MVI   GOSUBN,GIR#         GET INVENTORY RECORD                         
         GOTO1 AGOSUB               KEY & AIO CONTAINS INV KEY & RECD           
         BE    VK110                                                            
*                                                                               
         DS    0H                  COULD NOT GET INV RECD                       
         CLI   OURERRCD,0           IF ERROR CODE NOT SET,                      
         BE    *+12                  DON'T GO TO ERROR ROUTINE YET              
         LA    R2,IROSTTNH          PLACE CURSOR HERE IN CASE OF ERROR          
         B     VKERROR                                                          
*                                                                               
         OI    RECDFLG1,RF1DNXST    TRACK DOES NOT EXIST                        
*                                                                               
         MVI   GOSUBN,GHI#         GET HEADER INFORMATION                       
         GOTO1 AGOSUB                                                           
*                                                                               
         MVI   GOSUBN,BST#           BUILD SKELETON TRACK                       
         GOTO1 AGOSUB                                                           
*                                                                               
VK110    DS    0H                                                               
         L     R6,AIO                                                           
         USING RINVREC,R6                                                       
         TM    RINVCNTL,X80        IF RECORD MARKED FOR DELETION,               
         BZ    *+8                                                              
         OI    RECDFLG1,RF1DEL      REMEMBER IT FOR OUR USE                     
         DROP  R6                                                               
*                                                                               
VK120    DS    0H                                                               
                                                                                
         BAS   RE,SETUP                                                         
*                                                                               
*---------------------------- VALKEY EXITS ---------------------------*         
*                                                                               
VKX      DS    0H                                                               
         B     XIT                                                              
                                                                                
VKX_RTRN DS    0H                                                               
         B     XIT_RTRN                                                         
         EJECT                                                                  
*-------------------------- SETUP PROCEDURE --------------------------*         
                                                                                
* At entry,                                                                     
*   KEY = key of inventory record,                                              
*   AIO = A(inventory record)                                                   
                                                                                
         DS    0H                                                               
SETUP    NTR1                                                                   
                                                                                
         L     R6,AIO                                                           
         USING REINVRCD,R6                                                      
         CLC   RINVKSTD,IKEFFDB     IF THE INPUT IS DIFFERENT FROM RCD          
         BE    SU010                                                            
         MVC   WORK,MYSPACES                                                    
         GOTO1 DATCON,DMCB,(3,RINVKSTD),(5,WORK)                                
         MVC   IROEFFD,WORK         PUT EFFECTIVE DATE ON SCREEN                
         OI    IROEFFDH+6,X80        AND TRANSMIT IT                            
         DROP  R6                                                               
                                                                                
                                                                                
SU010    DS    0H                                                               
         MVI   GOSUBN,GHI#         GET HEADER INFORMATION                       
         GOTO1 AGOSUB                                                           
*                                                                               
         TM    CHNGFLG1,CF1KEY      IF KEY CHANGED,                             
         BZ    SU050                                                            
         NI    SELFLAG1,XFF-SF1RSTKC  RESET THESE ON KEY CHANGE,                
         NI    DEMFLAG1,XFF-DF1RSTKC                                            
         XC    TRKINFO(TRKINFOL),TRKINFO                                        
*                                                                               
         MVI   GOSUBN,GFN#           GET FOOTNOTE FOR TRACK                     
         GOTO1 AGOSUB                                                           
         OI    DPLYFLG1,DF1FTNOT      AND FLAG TO DISPLAY IT                    
*                                                                               
         MVI   GOSUBN,XFD#           EXTRACT "FROM" DATA                        
         GOTO1 AGOSUB                                                           
*                                                                               
         DS    0H                    SET UP DEMOLIST                            
         MVC   DEMOLIST(DEMOLSTL),DEMLSTDC                                      
         MVC   DEMOLIST+2(1),FDDEMC                                             
         MVC   DEMOLIST+5(1),FDDEMC                                             
         MVC   DEMOLIST+8(1),FDDEMC                                             
                                                                                
         MVI   GOSUBN,CSA#           CLEAR (SYSSPARE) STORAGE AREAS,            
         GOTO1 AGOSUB                                                           
         MVI   GOSUBN,LNS#           LOCATE NEXT SLOT IN LIST TABLE             
         GOTO1 (RF)                                                             
                                                                                
         MVI   GOSUBN,ILT#           INITIALIZE LIST TABLE                      
         GOTO1 (RF)                                                             
         MVI   SNLDSPLY,1             START DISPLAY FROM 1ST ENTRY              
         CLI   NLTNTRY,0                                                        
         BH    *+8                                                              
         MVI   SNLDSPLY,0              UNLESS THERE ARE NO ENTRIES              
                                                                                
         MVI   GOSUBN,BLD#           BUILD (MY) LIST DIRECTORY                  
         GOTO1 (RF)                                                             
                                                                                
         MVI   GOSUBN,IXDT#          INIT EXPANDED DEMOS TABLE                  
         GOTO1 AGOSUB                                                           
*                                                                               
         DS    0H                  EXTRACT DEMO VALUES FROM TRACK               
         L     R6,AIO               POINT R6 TO TRACK RECORD                    
         LA    RF,DEMOLIST                                                      
         ST    RF,ADEMLIST          SET ADDRESS OF THE DEMO LIST                
         MVI   GOSUBN,XDV#                                                      
         GOTO1 AGOSUB                                                           
         MVC   CUMDEMV(CUMDEMVL),THISDEMV                                       
                                                                                
         MVI   GOSUBNXD,XDXDV#     EXTRACT DEM VALUES FOR EXPANDED DEMS         
         MVI   GOSUBN,XDPTR#                                                    
         GOTO1 AGOSUB                                                           
*                                                                               
         DS    0H                  SET ADD COMBO DEMOFLAG                       
         NI    DEMFLAG1,XFF-DF1ADCMB                                            
                                                                                
         CLI   TRKCUME,C'T'         TOTAL FLAG FROM HISTORY ELEMS               
         BNE   *+12                                                             
         OI    DEMFLAG1,DF1ADCMB                                                
         B     SU032X                                                           
                                                                                
         TM    SELFLAG1,SF1AL1ES    WITH NO SELECTIONS                          
         BNZ   *+20                                                             
         CLI   FDADCMBO,C'Y'         AND FROM DETAILS INDICATE ADDING           
         BNE   *+12                                                             
         OI    DEMFLAG1,DF1ADCMB                                                
         B     SU032X                                                           
                                                                                
SU032X   EQU   *                                                                
                                                                                
*                                                                               
         DS    0H                                                               
         MVI   GOSUBN,IOV#         CLEAR OPTION VALUES                          
         GOTO1 AGOSUB                                                           
                                                                                
*                                                                               
* If the track doesn't exist, then fudge those Input Parameter fields           
*  with data as modified.                                                       
                                                                                
         DS    0H                                                               
         TM    RECDFLG1,RF1DNXST                                                
         BZ    SU038X                                                           
                                                                                
         OI    DIDTHIS,DIDFUDIP     TRACE--FUDGING INPUT PARAMS FIELDS          
         LA    R2,IROIPSCH          START @ FIELD                               
         LA    R3,IROIPTEH          END @ FIELD                                 
         SR    R0,R0                                                            
                                                                                
SU038B   DS    0H                                                               
         CLI   5(R2),0              IF THERE IS DATA,                           
         BE    *+8                                                              
         OI    4(R2),X80             FUDGE IT AS "INPUT THIS TIME"              
                                                                                
         DS    0H                   BUMP TO NEXT FIELD                          
         IC    R0,0(R2)                                                         
         AR    R2,R0                                                            
         CR    R2,R3                                                            
         BNH   SU038B                                                           
SU038X   EQU   *                                                                
*                                                                               
         B     SU100                                                            
*                                                                               
** KEY DID NOT CHANGE **                                                        
*                                                                               
SU050    DS    0H                  KEY DID NOT CHANGE                           
         B     SU100                                                            
                                                                                
                                                                                
SU100    DS    0H                                                               
         B     SUX                                                              
*                                                                               
SUX      DS    0H                                                               
         B     XIT                                                              
                                                                                
         EJECT                                                                  
*------------------------- TEST CHANGE OF KEY ------------------------*         
*                                                                               
KYCHNGED DS    0H                                                               
         TM    4(R2),X20                                                        
         BZ    KYCH10                                                           
         TM    4(R2),X80                                                        
         BZR   RE                                                               
KYCH10   OI    CHNGFLG1,CF1KEY                                                  
         BR    RE                                                               
         EJECT                                                                  
*-------------------------- VALIDATE OPTIONS -------------------------*         
                                                                                
* At entry,                                                                     
*   R2-->options field.                                                         
* On a clean exit,                                                              
*   CC set to equal.                                                            
* On an error exit,                                                             
*   CC set to not equal,                                                        
*   MYTEXT(1) = l(text replace in error msg) or 0,                              
*   MYTEXT+1  = text replace if MYTEXT<>0,                                      
*   FLDDSPL   = displacement to sub-field w/ error,                             
*   OURERRCD  = error code.                                                     
                                                                                
         DS    0H                                                               
VALOPT   NTR1                                                                   
         MVI   FLDDSPL,0                                                        
         MVI   GOSUBN,IOV#                                                      
         GOTO1 AGOSUB                                                           
*                                                                               
         CLI   5(R2),0                                                          
         BE    VOPT200                                                          
*                                                                               
         MVI   OURERRCD,IFLDQ                                                   
         MVI   SCANLNTH,70                                                      
         GOTO1 SCANNER,DMCB,(SCANLNTH,(R2)),(X'8A',BUFF),0                      
         SR    R0,R0                                                            
         ICM   R0,1,DMCB+4                                                      
         BZ    VOPTXN              ERROR                                        
         STC   R0,NOPTN                                                         
*                                                                               
         MVI   COUNTER,0                                                        
         LA    R3,BUFF             R3-->SCANNER BLOCK                           
*                                                                               
** VALIDATE OPTION KEYWORD **                                                   
*                                                                               
VOPT020  DS    0H                  RUN THRU OPTION KEYWORDS TABLE               
         L     R4,ARM18WRK                                                      
         L     R4,(AOPTTAB-RM18WRKD)(R4)                                        
         USING OPTDSECT,R4                                                      
                                                                                
         MVC   FLDDSPL,4(R3)       HOLD ONTO DISPLACEMENT INTO FIELD            
                                                                                
VOPT022  DS    0H                                                               
         CLI   0(R4),EOT           IF END OF OPTION KEYWORD TABLE,              
         BNE   VOPT024                                                          
         MVI   OURERRCD,INVOQ                                                   
         B     VOPTXN               THEN INPUT IS INVALID                       
                                                                                
VOPT024  DS    0H                                                               
         ZICM  RF,OPDKYTB,(3)                                                   
         LA    RF,OPTDSECT(RF)     RF-->TABLE OF NAMES FOR ENTRY                
                                                                                
VOPT030  DS    0H                                                               
         CLI   0(RF),EOT           IF AT END OF NAME TABLE,                     
         BE    VOPT036              IT'S NOT THIS OPTION ENTRY                  
         ZIC   R1,0(RF)                                                         
         ZIC   RE,0(R3)            RE = LENGTH OF INPUTTED KEYWORD              
         CR    R1,RE               L(KYWD IN TABLE) VS L(KYWD INPUTTED)         
         BL    VOPT033              LOW: TRY ANOTHER NAME                       
         BCTR  RE,0                                                             
         EXCLC RE,12(R3),1(RF)     IF THEY MATCH,                               
         BE    VOPT040              THEN THIS IS THE OPTION ENTRY               
                                                                                
VOPT033  DS    0H                                                               
         LA    RF,1(R1,RF)         ELSE, CHECK NEXT NAME IN TABLE               
         B     VOPT030                                                          
                                                                                
VOPT036  DS    0H                  BUMP TO NEXT OPTION ENTRY                    
         ZIC   R1,OPDNTRYL                                                      
         AR    R4,R1                                                            
         B     VOPT022                                                          
*                                                                               
VOPT040  DS    0H                  OPTION ENTRY LOCATED                         
         TM    OPDFLAG,OPDFDDSO     IS THIS OPTION ONLY FOR DDS?                
         BZ    VOPT041X                                                         
         CLI   TWAOFFC,C'*'          YES, IS THIS A DDS OFFICE?                 
         BE    VOPT041X                                                         
                                                                                
         MVI   OURERRCD,OOVFQ                                                   
         MVI   MYTEXT+0,3                                                       
         MVC   MYTEXT+1(3),=C'DDS'                                              
         B     VOPTXN                                                           
VOPT041X EQU   *                                                                
*                                                                               
         DS    0H                                                               
         MVC   DUB(4),OPTI                                                      
         NC    DUB(4),OPDOPTB       IS THIS OPTION DUPLICATED?                  
         BZ    VOPT043                                                          
         MVI   OURERRCD,DUPOQ        YES, DUPLICATED OPTION KEYWORD             
         B     VOPTXN                                                           
                                                                                
VOPT043  DS    0H                                                               
         MVC   DUB(4),OPTX                                                      
         NC    DUB(4),OPDOPTB       IS THIS OPTION COMPATIBLE?                  
         BZ    VOPT046                                                          
         MVI   OURERRCD,IOCBQ        NO, INVALID OPTN COMBO                     
         B     VOPTXN                                                           
         EJECT                                                                  
*                                                                               
** INDIVIDUAL OPTIONS' VALIDATIONS **                                           
*                                                                               
                                                                                
VOPT046  DS    0H                                                               
         MVI   MYTEXT,0                                                         
         MVC   MYTEXT+1(MYTEXTL-1),MYSPACES                                     
         B     VOUPG                                                            
                                                                                
                                                                                
VOUPG    DS    0H                  UPGRADE FORMULA                              
         CLI   OPDNUMB,OPNUPGD                                                  
         BNE   VOUPGX                                                           
*                                                                               
*^^COCO                                                                         
         PRINT OFF                                                              
*&&DO                                                                           
         TM    IKFRBTS,BBPBK+BBEBK  ONLY VALID FOR P- & E-BOOKS                 
         BNZ   VOUPGX                                                           
                                                                                
         LA    R3,MYTEXT+1                                                      
         MVC   0(2,R3),=C'E-'                                                   
         MVI   3(R3),C'&&'                                                      
         MVC   5(2,R3),=C'P-'                                                   
         MVC   8(5,R3),=C'books'                                                
         MVI   MYTEXT,13                                                        
         MVI   OURERRCD,OOVFQ                                                   
         B     VOPTXN10                                                         
*&&                                                                             
         PRINT ON                                                               
*^^EOCOCO                                                                       
*                                                                               
VOUPGX   EQU   *                                                                
                                                                                
                                                                                
VOCUM    DS    0H                  CUMULATIVE VALUE TYPE                        
         CLI   OPDNUMB,OPNCUME                                                  
         BNE   VOCUMX                                                           
*                                                                               
*^^COCO                                                                         
         PRINT OFF                                                              
*&&DO                                                                           
         TM    IKFRBTS,BBEBK        ONLY VALID FOR E-BOOKS                      
         BNZ   VOCUMX                                                           
                                                                                
         LA    R3,MYTEXT+1                                                      
         MVC   0(2,R3),=C'E-'                                                   
         MVC   2(5,R3),=C'books'                                                
         MVI   MYTEXT,7                                                         
         MVI   OURERRCD,OOVFQ                                                   
         B     VOPTXN10                                                         
*&&                                                                             
         PRINT ON                                                               
*^^EOCOCO                                                                       
*                                                                               
VOCUMX   EQU   *                                                                
                                                                                
                                                                                
         ST    R4,AOPTNTRY                                                      
         OC    OPTR,OPDRQOPT       OTHER OPTIONS REQUIRED                       
         OC    OPTX,OPDNAOPT       OTHER OPTIONS NOT ALLOWED                    
         B     VOPT050                                                          
         EJECT                                                                  
*                                                                               
** VALIDATE OPTION VALUE **                                                     
*                                                                               
VOPT050  DS    0H                                                               
         MVC   FLDDSPL,8(R3)       HOLD ONTO DISPLACEMENT INTO FIELD            
                                                                                
         TM    OPDFLAG,OPDFKYWD                                                 
         BO    VOPT060                                                          
                                                                                
         CLI   1(R3),0             THERE S/B DATA INPUT TO VALIDATE             
         BH    *+12                                                             
         MVI   OURERRCD,MODQ                                                    
         B     VOPTXN                                                           
                                                                                
         TM    OPDFLAG,OPDFVRTN                                                 
         BO    VOPT080                                                          
         TM    OPDFLAG,OPDFVTBL                                                 
         BO    VOPT100                                                          
         DC    H'0'                                                             
*                                                                               
*** OPTION VALUE VALID VIA KEYWORD ***                                          
*                                                                               
VOPT060  DS    0H                                                               
         CLI   1(R3),0             SHOULD NOT HAVE OPTION DATA                  
         BE    *+12                                                             
         MVI   OURERRCD,OSKQ                                                    
         B     VOPTXN                                                           
*                                                                               
         ZICM  R5,OPDODSPL,(3)                                                  
         LA    R5,SYSD(R5)         R5-->OUTPUT AREA FOR OPTION DATA             
         ZIC   R1,0(R5)            R1 = # OF VALUES FOR OPTION SO FAR           
         CLM   R1,1,OPDMXNDV       DO WE HAVE MAX AMOUNT ALREADY                
         BL    VOPT062                                                          
         MVI   OURERRCD,TMODQ       YES, TOO MANY OPTN DATA ERROR               
         B     VOPTXN                                                           
                                                                                
VOPT062  DS    0H                                                               
         LA    R0,1(R1)                                                         
         STC   R0,0(R5)            UPDATE # OF VALUES FOR OPTION                
         ZIC   RF,OPDOLEN          RF = L(OPTION OUTPUT)                        
         SR    R0,R0                                                            
         MR    R0,RF                                                            
         LA    R0,1(R1,R5)         SET DESTINATION ADDRESS                      
         LR    R1,RF               SET DESTINATION LENGTH                       
*                                                                               
         ZICM  R5,OPDVLTB,(3)                                                   
         LA    R5,OPTDSECT(R5)     R5-->VALUE(S) FOR KEYWORD                    
         LA    RE,1(R5)            SET SOURCE ADDRESS                           
         ZIC   RF,0(R5)            SET SOURCE LENGTH                            
                                                                                
         MVCL  R0,RE               USE MVCL IN CASE L'DEST <> L'SOURCE          
                                                                                
         B     VOPT150                                                          
*                                                                               
*** OPTION VALUE VALIDATED VIA ROUTINE ***                                      
*                                                                               
VOPT080  DS    0H                                                               
         LA    R0,BLOCK                                                         
         LA    R1,480              L'BLOCK                                      
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE               CLEAR  BLOCK  FOR OUTPUT                     
*                                                                               
         MVC   GOSUBN,OPDRTNUM                                                  
         GOTO1 AGOSUB                                                           
         BNE   VOPTXN10            (ROUTINE SHOULD SET ALL ERROR INFO)          
*                                                                               
         ZIC   R0,OPDOLEN          R0 = OUTPUT LENGTH                           
         ZICM  R5,OPDODSPL,(3)                                                  
         LA    R5,SYSD(R5)         R5-->OUTPUT AREA FOR OPTION DATA             
         ZIC   RE,0(R5)            RE = # OF OUTPUT VALUES SO FAR               
         STH   R0,HALF                                                          
         MH    RE,HALF                                                          
         LA    RE,1(RE,R5)         RE-->DESTINATION FOR OPTION VALUE            
         LA    RF,BLOCK            RF-->OPTION VALUES RETURNED FROM RTN         
                                                                                
VOPT083  DS    0H                                                               
         LR    R1,R0               R1 = OUTPUT LENGTH                           
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         OC    0(0,RF),0(RF)       ANY MORE OUTPUT?                             
         BZ    VOPT090              NOPE                                        
                                                                                
         CLC   0(1,R5),OPDMXNDV    DO WE HAVE MAX # DATA VALUE ALREADY?         
         BL    VOPT086                                                          
         MVI   OURERRCD,TMODQ       YES, TOO MANY OPTN DATA ERROR               
         B     VOPTXN                                                           
                                                                                
VOPT086  DS    0H                                                               
         EXMVC R1,0(RE),0(RF)      MOVE OPTION DATA TO STORAGE                  
         AR    RE,R0               BUMP TO NEXT STORAGE LOCATION                
         AR    RF,R0               BUMP TO NEXT DATA VALUE SOURCE               
         ZIC   R1,0(R5)                                                         
         LA    R1,1(R1)                                                         
         STC   R1,0(R5)            UPDATE # OF DATA VALUES                      
         B     VOPT083                                                          
*                                                                               
VOPT090  DS    0H                                                               
         B     VOPT150                                                          
*                                                                               
*** OPTION VALUE VALIDATED VIA TABLE ***                                        
*                                                                               
VOPT100  DS    0H                                                               
         ZICM  R2,OPDTBDSP,(3)                                                  
         A     R2,MYBASE1          R2-->TABLE OF VALID OPTION VALUES            
*                                                                               
         SR    R1,R1                                                            
VOPT112  DS    0H                                                               
         ZICM  R0,0(R2),(1)        IF L(TABLE DATA) = 0,                        
         BNZ   VOPT114                                                          
         MVI   OURERRCD,IODVQ       EOT REACHED AND INPUT IS INVALID            
         B     VOPTXN                                                           
                                                                                
VOPT114  DS    0H                                                               
         IC    R1,1(R3)            R1 = L(INPUT DATA)                           
         CR    R0,R1               L(TABLE DATA) VS L(INPUT DATA)               
         BL    VOPT116              LOW: INSUFFICIENT FOR COMPARISON            
         BCTR  R1,0                                                             
         EXCLC R1,22(R3),2(R2)                                                  
         BE    VOPT120                                                          
                                                                                
VOPT116  DS    0H                  BUMP TO NEXT TABLE ENTRY                     
         ZIC   RF,1(R2)             RF = L(VALUE TO STORE)                      
         AR    RF,R0                R0 = L(TABLE DATA)                          
         LA    R2,2(RF,R2)          R2 BUMPED TO NEXT TABLE ENTRY               
         B     VOPT112                                                          
*                                                                               
VOPT120  DS    0H                  OPTION DATA INPUTTED IS VALID                
         LR    RF,R0                RF = L(TABLE DATA)                          
         LA    RF,2(RF,R2)          RF-->VALUE TO STORE FOR OPTION              
                                                                                
         ZICM  R5,OPDODSPL,(3)                                                  
         LA    R5,SYSD(R5)         R5-->PLACE TO STORE OPTION VALUE             
         CLC   0(1,R5),OPDMXNDV    DO WE HAVE MAX # DATA VALUE ALREADY?         
         BL    VOPT123                                                          
         MVI   OURERRCD,TMODQ                                                   
         B     VOPTXN                                                           
                                                                                
VOPT123  DS    0H                                                               
         ZIC   RE,0(R5)            RE = # OF DATA VALUES SO FAR                 
         LA    R1,1(RE)                                                         
         STC   R1,0(R5)             UPDATE IT                                   
         ZIC   R1,OPDOLEN          R1 = L(OPTION DATA VALUE)                    
         STH   R1,HALF                                                          
         MH    RE,HALF                                                          
         LA    RE,1(RE,R5)         RE-->DESTINATION FOR OPTION VALUE            
         BCTR  R1,0                                                             
         EXMVC R1,0(RE),0(RF)                                                   
*                                                                               
         B     VOPT150                                                          
*                                                                               
** OPTION INPUTTED IS VALID **                                                  
*                                                                               
VOPT150  DS    0H                                                               
         OC    OPTI,OPDOPTB        REMEMBER THAT IT WAS INPUTTED                
                                                                                
         ZIC   R1,COUNTER          ANY MORE SCANNER ENTRIES?                    
         LA    R1,1(R1)                                                         
         CLM   R1,1,NOPTN                                                       
         BNL   VOPT200              NOPE, FINISHED W/ OPTIONS                   
         STC   R1,COUNTER                                                       
         ZIC   R1,SCANLNTH                                                      
         LA    R3,22(R3,R1)         YEP, BUMP TO NEXT SCANNER ENTRY             
         B     VOPT020                                                          
*                                                                               
VOPT200  DS    0H                                                               
         MVC   DUB(4),OPTR         TEST ALL REQUIRED OPTIONS INPUTTED           
         NC    DUB(4),OPTI                                                      
         CLC   DUB(4),OPTR                                                      
         BE    VOPT220              YEP, THEY'RE ALL HERE                       
                                                                                
         L     R4,ARM18WRK                                                      
         L     R4,(AOPTTAB-RM18WRKD)(R4)  LOCATE MISSING OPTION                 
VOPT212  DS    0H                                                               
         CLI   0(R4),EOT           IF END OF OPTIONS TABLE REACHED,             
         BNE   *+6                                                              
         DC    H'0'                 SOMETHING'S AMISS                           
         MVC   DUB(4),OPTI                                                      
         NC    DUB(4),OPTR                                                      
         XC    DUB(4),OPTR         DUB(4) CONTAINS OPTIONS MISSING              
         NC    DUB(4),OPDOPTB      IS THIS AN OPTION MISSING?                   
         BNZ   VOPT214              YES                                         
         ZIC   R0,OPDNTRYL          NO, TRY NEXT ENTRY                          
         AR    R4,R0                                                            
         B     VOPT212                                                          
                                                                                
VOPT214  DS    0H                  MOVE KEYWORD LEN & NAME INTO MYTEXT          
         ZICM  RF,OPDKYTB,(3)                                                   
         LA    RF,OPTDSECT(RF)                                                  
         ZIC   RE,0(RF)                                                         
         EXMVC RE,MYTEXT,0(RF)                                                  
         MVI   OURERRCD,ROMQ                                                    
         B     VOPTXN10                                                         
*                                                                               
VOPT220  DS    0H                                                               
         B     VOPTXY                                                           
         DROP  R4                                                               
                                                                                
                                                                                
VOPTXN   DS    0H                                                               
         MVI   MYTEXT,0            NO TEXT REPLACE W/IN ERROR MESSAGE           
                                                                                
VOPTXN10 DS    0H                                                               
         B     NO                                                               
*                                                                               
VOPTXY   DS    0H                                                               
         B     YES                                                              
***********************************************************************         
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (VALREC)'                  
***********************************************************************         
*========================== VALIDATE RECORD ==========================*         
VREC     DS    0H                                                               
                                                                                
         DS    0H                  INITIALIZATION                               
         XC    OURERRCD(3),OURERRCD  NO ERROR, INFO, NOR WRNG MSGS YET          
         XC    MYTEXT(MYTEXTL),MYTEXT                                           
                                                                                
         XC    A1SELCH,A1SELCH      NOTHING MODIFIED YET                        
*                                                                               
VR002    DS    0H                  DISPLAY RECD FIRST IF:                       
         TM    MISCFLG1,MF1GDPLY    SPECIFICALLY SAID TO GO DISPLAY             
         BO    VR004                                                            
         TM    CHNGFLG1,CF1KEY      A KEY FIELD CHANGED                         
         BO    VR004                                                            
         B     VR020               OTHERWISE, EXECUTE VALREC LOGIC              
                                                                                
VR004    DS    0H                  GO STRAIGHT TO DISPLAY LOGIC                 
         MVI   PFKEY,0              IGNORE PFKEY                                
         B     DREC                                                             
*                                                                               
** VALIDATE SELECT CODES FIRST **                                               
*                                                                               
VR020    DS    0H                                                               
         MVI   GOSUBN,TSL#         TEST SELECT FIELDS                           
         GOTO1 AGOSUB                                                           
         ICM   R2,15,FULL                                                       
         BNZ   OURERROR                                                         
                                                                                
         MVI   GOSUBN,PSL#         PROCESS SELECT FIELDS                        
         GOTO1 (RF)                                                             
                                                                                
*                                                                               
         DS    0H                  SET DEMO FLAG                                
         NI    DEMFLAG1,XFF-DF1ADCMB                                            
                                                                                
         CLI   OPVCUMTB,C'T'        "CUME=TOTAL" OPTION                         
         BNE   *+12                                                             
         OI    DEMFLAG1,DF1ADCMB                                                
         B     VR025X                                                           
                                                                                
         TM    SELFLAG1,SF1AL1ES    WITH NO SELECTIONS                          
         BNZ   *+20                                                             
         CLI   FDADCMBO,C'Y'         AND FROM DETAILS INDICATE ADDING           
         BNE   *+12                                                             
         OI    DEMFLAG1,DF1ADCMB                                                
         B     VR025X                                                           
                                                                                
VR025X   EQU   *                                                                
                                                                                
*                                                                               
** VALIDATE CODE **                                                             
*                                                                               
VR030    DS    0H                                                               
         LA    R2,IROCODEH                                                      
*                                                                               
         MVC   DUB(2),IROCODE      MOVE DATA IN CODE FIELD INTO DUB             
         OC    DUB(2),MYSPACES                                                  
                                                                                
*                                                                               
         DS    0H                  LOOK UP CODE IN TABLE                        
         LA    R0,CODETABQ                                                      
         L     RF,ARM18WRK                                                      
         L     RF,(ACODETAB-RM18WRKD)(RF)                                       
*                                                                               
VR032    DS    0H                   START OF LOOP                               
         CLC   DUB(2),0(RF)                                                     
         BE    VR038                 CODE IS VALID                              
         LA    RF,L'CODETAB(RF)                                                 
         BCT   R0,VR032                                                         
                                                                                
*                                                                               
         DS    0H                  VALIDATE CODE AS MONTH/YEAR                  
         LA    R0,MONTABL                                                       
         LA    RF,MONTAB                                                        
*                                                                               
VR034    DS    0H                   LOOK UP MONTH                               
         CLC   DUB(1),0(RF)                                                     
         BE    *+12                                                             
         LA    RF,1(RF)                                                         
         B     VR034                                                            
*                                                                               
         DS    0H                   VALIDATE YEAR                               
         CLI   DUB+1,C'0'                                                       
         BL    INVLFLD                                                          
         CLI   DUB+1,C'9'                                                       
         BH    INVLFLD                                                          
         B     VR038               CODE IS VALID                                
                                                                                
*                                                                               
VR038    DS    0H                                                               
         CLC   DUB(2),=C'PJ'       IF CODE IS PJ                                
         BNE   VR038D                                                           
         CLI   OPVUPGNM,0                                                       
         BNE   VR038D                                                           
         LA    R2,IROOPT1H                                                      
         B     MISSFLD              AN UPGRADE EXPRESSION IS NEEDED             
VR038D   EQU   *                                                                
*                                                                               
         MVC   XFCODE,DUB                                                       
*                                                                               
** "VALIDATE" FOOTNOTE **                                                       
*                                                                               
VR040    EQU   *                                                                
         DS    0H                                                               
         LA    R2,IROFTNTH                                                      
         TM    4(R2),X80           WAS FOOTNOTE FIELD TOUCHED?                  
         BZ    VR044X               NOPE, THAT'S GOOD                           
*                                                                               
         DS    0H                                                               
         OI    IROFNLBH+6,X80      SET TO TRANSMIT FOONOTE FLAG                 
         MVC   WORK(L'TRKFTNT),TRKFTNT                                          
         CLI   5(R2),0             ANY INPUT?                                   
         BH    *+12                                                             
         OI    DPLYFLG1,DF1FTNOT    NO, FLAG TO RE-DISPLAY FOOTNOTE             
         B     VR044G                                                           
                                                                                
         GOTO1 ANY                  YES, GET INPUT INTO  WORK                   
VR044G   EQU   *                                                                
*                                                                               
         DS    0H                  SET FOOTNOTE FLAG                            
         MVI   IROFNLB+L'IROFNLB-1,C' '   ASSUME NO OVERRIDE                    
         CLC   WORK(L'TRKFTNT),TRKFTNT                                          
         BE    *+8                                                              
         MVI   IROFNLB+L'IROFNLB-1,C'*'   INPUT <> FTNT IN TRACK                
*                                                                               
VR044X   EQU   *                                                                
                                                                                
*                                                                               
         DS    0H                                                               
         LA    R2,IROUPFNH                                                      
         TM    4(R2),X80           WAS THIS FIELD TOUCHED?                      
         BZ    VR047X               NOPE, THAT'S GOOD                           
*                                                                               
         DS    0H                                                               
         CLI   5(R2),0             IF NO INPUT,                                 
         BNE   *+12                                                             
         MVI   8(R2),C'Y'           DEFAULT TO "YES"                            
         OI    6(R2),X80                                                        
*                                                                               
         CLI   8(R2),C'Y'                                                       
         BE    VR047G                                                           
         CLI   8(R2),C'N'                                                       
         BE    VR047G                                                           
         B     INVLFLD                                                          
VR047G   EQU   *                                                                
*                                                                               
         CLI   8(R2),C'N'               IF "NO" INPUTTED,                       
         BNE   *+12                                                             
         CLI   IROFNLB+L'IROFNLB-1,C'*'  FOOTNOTE CAN'T BE OVERRIDDEN           
         BE    INVLFLD                                                          
*                                                                               
VR047X   EQU   *                                                                
                                                                                
*                                                                               
** VALIDATE INPUT PARAMETERS **                                                 
*                                                                               
VR050    DS    0H                                                               
         XC    INPUTPRM(INPTPRML),INPUTPRM                                      
         XC    A1LPCH,A1LPCH                                                    
         XC    A1IPDATA,A1IPDATA                                                
         NI    CHNGFLG1,XFF-CF1IP                                               
         NI    CHNGFLG1,XFF-CF1IPDC                                             
         NI    INPMFLG1,XFF-IPF1ALL                                             
                                                                                
         LA    RE,IROOPT1H                                                      
         LH    RF,DLASTINP                                                      
         A     RF,ATWA                                                          
         STM   RE,RF,AMNISTRT      SET START/END TO MDFY FOR NEXT INPUT         
                                                                                
*                                                                               
*** VALIDATE INPUT PARAMETER: SOURCE ***                                        
*                                                                               
         LA    R2,IROIPSCH                                                      
         MVI   BYTE,IPF1SC         SET FOR SOURCE INPUT                         
         BAS   RE,VRIPCH           GENERIC INPUT PARM FIELD ROUTINE             
                                                                                
         DS    0H                  SET LIST PARAMETER FOR SOURCE                
         MVC   WORK(3),IKRSVC       DEFAULT TO SOURCE FROM KEY                  
         MVC   WORK+3(1),IKSRC                                                  
         CLI   IKSTTN+4,C'H'       SWITCH RTG SRV TO NHT IN IP FLD              
         BNE   *+8                                                              
         CLI   IKRSVC,C'N'         KEY SOURCE IS NSI?                           
         BNE   *+14                                                             
         MVC   WORK(3),=C'NHT'                                                  
         MVI   WORK+3,C'H'                                                      
*                                                                               
         ZICM  R1,5(R2),(1)         CHECK IF ANY SOURCE INPUT                   
         BZ    VR066                 IF NONE, STICK TO DEFAULT                  
         STC   R1,OURBYTE                                                       
         LA    R0,8(R2)                                                         
         MVI   GOSUBN,VSRC#                                                     
         GOTO1 AGOSUB                                                           
         BNE   INVLSRC                                                          
         MVC   WORK(3),TMPRSVC                                                  
         MVC   WORK+3(1),TMPSRC                                                 
                                                                                
         CLC   IROIPSC,WORK        IF FULL SOURCE NAME NOT SHOWN,               
         BE    VR066                                                            
         MVC   IROIPSC,WORK         DISPLAY IT                                  
         OI    IROIPSCH+6,X80                                                   
                                                                                
VR066    DS    0H                                                               
         MVC   IPRSVC,WORK                                                      
         MVC   IPSRC,WORK+3                                                     
                                                                                
*                                                                               
*** VALIDATE INPUT PARAMETER: FILE ***                                          
*                                                                               
VR070    DS    0H                                                               
         LA    R2,IROIPFLH                                                      
         MVI   BYTE,IPF1FL         SET FOR FILE INPUT                           
         BAS   RE,VRIPCH           GENERIC INPUT PARM FIELD ROUTINE             
                                                                                
         DS    0H                  SET LIST PARAMETER FOR FILE                  
         MVC   WORK(3),FDFILE       DEFAULT TO FILE IN "FROM DATA"              
         MVC   WORK+3(1),FDTPTT                                                 
         ZICM  R1,5(R2),(1)         CHECK IF ANY FILE INPUT                     
         BZ    VR076                 IF NONE, STICK TO DEFAULT                  
                                                                                
         BCTR  R1,0                                                             
         MVI   WORK+3,0                                                         
         MVC   WORK(3),DCFILPAV                                                 
         EXCLC R1,8(R2),DCFILPAV                                                
         BE    VR076                                                            
         MVC   WORK(3),DCFILIUN                                                 
         EXCLC R1,8(R2),DCFILINV                                                
         BE    VR076                                                            
         MVC   WORK(3),DCFILTP                                                  
         MVI   WORK+3,C'P'                                                      
         EXCLC R1,8(R2),DCFILTP                                                 
         BE    VR076                                                            
         MVI   WORK+3,C'T'                                                      
         EXCLC R1,8(R2),=C'TT '                                                 
         BE    VR076                                                            
         B     INVLFIL             INVALID FILE ENCOUNTERED                     
                                                                                
VR076    DS    0H                                                               
         MVC   IPFILE,WORK                                                      
         MVC   IPTPTT,WORK+3                                                    
         CLI   IPSRC,C'H'                                                       
         BNE   *+12                                                             
         CLI   IPTPTT,C'P'         TP N/A FOR NHT FILE                          
         BE    INVFLSRC                                                         
*                                                                               
*** VALIDATE INPUT PARAMETER: BOOK ***                                          
*                                                                               
VR090    DS    0H                                                               
         LA    R2,IROIPBKH                                                      
         MVI   BYTE,IPF1BK         SET FOR BOOK INPUT                           
         BAS   RE,VRIPCH           GENERIC INPUT PARM FIELD ROUTINE             
                                                                                
         DS    0H                  SET LIST PARAMETER FOR BOOK & BTYPE          
         MVC   WORK(L'IPFRBK),FDFRBK                                            
         MVC   WORK+L'IPFRBK(L'IPBTYP),FDBTYP                                   
         MVI   TMPWKN,0                                                         
                                                                                
         CLI   5(R2),0             IF FIELD HAS NO INPUT,                       
         BE    VR096                USE "FROM" DATA                             
         CLI   5(R2),3             L(INPUT) SHOULD BE AT LEAST 3                
         BL    INVLBK                                                           
                                                                                
         BAS   RE,VRGETFLD         GET TWA FIELD INTO MYFLD                     
                                                                                
         DS    0H                  CHECK FOR SPECIFIC WEEK REQUESTED            
         ZIC   R1,MYFLDH+5                                                      
         LA    RF,MYFLDD-2(R1)      RF-->2ND TO LAST CHAR OF INPUT              
         CLI   0(RF),C'-'           THIS IS HOW A SPECIFIC IS REQUESTED         
         BNE   VR092X                                                           
         CLI   1(RF),C'1'           WEEK NUMBER MUST BE ONE                     
         BL    INVLBK                                                           
         CLI   1(RF),C'4'            THROUGH FOUR                               
         BH    INVLBK                                                           
         MVC   TMPWKN,1(RF)                                                     
         NI    TMPWKN,X'0F'                                                     
         XC    0(2,RF),0(RF)        CLEAR AWAY WEEK SPECIFICATION               
         SH    R1,=H'2'                                                         
         STC   R1,MYFLDH+5           FOR BOOKVAL VALIDATION                     
VR092X   EQU   *                                                                
                                                                                
         XC    DUB,DUB                                                          
         GOTO1 BOOKVAL,DMCB,(IPRSVC,MYFLD),(1,DUB),(C'B',SCANNER),DUB+4         
         CLI   4(R1),1             TEST IF BOOK INPUT IS VALID                  
         BNE   INVLBK                                                           
         TM    DUB,X80             CAN'T BE "SUPPRESS CPP/CPM"                  
         BO    INVLBK                                                           
         TM    DUB,X'2E'           IF THESE SPECIAL OPTIONS,                    
         BZ    VR093                                                            
         CLC   IPFILE,DCFILIUN      FILE MUST BE 'IUN'                          
         BNE   INVLBK                                                           
                                                                                
VR093    DS    0H                                                               
         MVC   WORK(L'IPFRBK),DUB  GET INPUTTED BOOK (AND BITS)                 
         MVC   WORK+L'IPFRBK(L'IPBTYP),DUB+4                                    
                                                                                
VR096    DS    0H                                                               
         MVC   IPFRBK,WORK                                                      
         MVC   IPBTYP,WORK+L'IPFRBK                                             
         MVC   IPWKN,TMPWKN                                                     
                                                                                
*                                                                               
*** VALIDATE INPUT PARAMETER: STATION ***                                       
*                                                                               
VR100    DS    0H                                                               
         LA    R2,IROIPSTH                                                      
         MVI   BYTE,IPF1ST         SET FOR STATION INPUT                        
         BAS   RE,VRIPCH           GENERIC INPUT PARM FIELD ROUTINE             
                                                                                
         DS    0H                  SET LIST PARAMETER FOR STATION               
         MVC   WORK(L'IPSTTN),IKSTTN                                            
         CLI   5(R2),0                                                          
         BE    VR110                                                            
                                                                                
         MVC   MY_CSTAT,CSTAT      (IN CASE CSTAT GETS CHANGED)                 
         MVI   GOSUBN,VSTA#        USE THIS ROUTINE TO VALIDATE STATION         
         GOTO1 AGOSUB                                                           
         MVC   CSTAT,MY_CSTAT      (IN CASE CSTAT GOT CHANGED)                  
         BNE   INVLSTA              THEN AN ERROR OCCURRED                      
                                                                                
         MVC   WORK+4(1),WORK+40   GET SATELLITE IF THERE IS ONE                
         CLI   WORK+4,C' '                                                      
         BNE   *+8                                                              
         MVI   WORK+4,C'T'                                                      
                                                                                
VR110    DS    0H                                                               
         MVC   IPSTTN,WORK                                                      
*                                                                               
         CLC   IPFILE,DCFILIUN                                                  
         BE    VR120                                                            
         CLI   IPSTTN+4,C'H'                                                    
         BNE   *+12                                                             
         CLI   IPSRC,C'H'                                                       
         BNE   INVSRCST                                                         
                                                                                
*                                                                               
*** VALIDATE INPUT PARAMETER: PURE/INVENTORY # ***                              
*                                                                               
VR120    DS    0H                                                               
         LA    R2,IROIPPIH                                                      
         MVI   BYTE,IPF1PI                                                      
         BAS   RE,VRIPCH                                                        
*                                                                               
         DS    0H                                                               
         CLC   IPFILE,DCFILPAV                                                  
         BE    VR125                                                            
         CLC   IPFILE,DCFILIUN                                                  
         BE    VR130                                                            
                                                                                
         CLI   5(R2),0                                                          
         BE    VR139                                                            
         B     INVLFLD                                                          
                                                                                
*                                                                               
VR125    DS    0H                  VALIDATE AS PURE NUMBER                      
         XC    IPINVN,IPINVN        INVENTORY NUMBER MEANINGLESS                
         XC    WORK(L'IPPURE),WORK  SET DEFAULT PURE NUMBER                     
*                                                                               
         CLI   5(R2),0                                                          
         BE    VR129                                                            
         CLI   5(R2),3                                                          
         BL    INVLFLD                                                          
         CLI   IPSTTN+4,C'H'                                                    
         BNE   VR126                                                            
         L     RF,ACOMFACS                                                      
         L     RF,(CHEXIN-COMFACSD)(RF)                                         
         GOTO1 (RF),DMCB,8(R2),WORK,4                                           
         MVC   IPPURE,WORK                                                      
         B     VR139                                                            
*                                                                               
VR126    DS    0H                   QTR HOUR MUST BE 00-99                      
         CLI   8(R2),C'0'                                                       
         BL    INVLFLD                                                          
         CLI   8(R2),C'9'                                                       
         BH    INVLFLD                                                          
         CLI   9(R2),C'0'                                                       
         BL    INVLFLD                                                          
         CLI   9(R2),C'9'                                                       
         BH    INVLFLD                                                          
                                                                                
         PACK  DUB,8(2,R2)                                                      
         CVB   R0,DUB                                                           
         STC   R0,WORK              QUARTER HOUR                                
*                                                                               
         DS    0H                   DAY                                         
         CLI   8+2(R2),C'D'          TYPICAL                                    
         BE    VR127A                                                           
         CLI   8+2(R2),C'E'          WEEKEND                                    
         BE    VR127A                                                           
         CLI   8+2(R2),C'0'                                                     
         BL    INVLFLD                                                          
         CLI   8+2(R2),C'9'                                                     
         BH    INVLFLD                                                          
                                                                                
VR127A   DS    0H                                                               
         GOTO1 VINVDAY,DMCB,1,(0,10(R2)),(0,WORK+1),0  PAV DAY CODE             
*                                                                               
         DS    0H                   WEEK                                        
         CLI   5(R2),3               WAS WEEK SPECIFIED?                        
         BE    VR129                  NOPE, PURE NUMBER CAN BE 3 CHARS          
                                                                                
         ZIC   RF,8+3(R2)                                                       
         SR    RE,RE                                                            
         SLDL  RE,28                 RE HAS 4 HIGH ORDER BITS                   
         SRL   RF,28                 RF HAS 4 LOW  ORDER BITS                   
         CH    RF,=H'7'              0-7, A-G                                   
         BH    INVLFLD                                                          
         SLL   RF,1                  STORE WK IN BIT POSITNS 4, 5, & 6          
         EX    RF,*+8                                                           
         B     *+8                                                              
         OI    WORK+1,0                                                         
                                                                                
         CH    RE,=H'15'             IF RE <> 15,                               
         BNE   VR128B                 THEN WEEK INPUT WAS NOT A DIGIT           
         LTR   RF,RF                 IF THE INPUT IS C'0',                      
         BZ    VR128D                 HANDLE IT DIFFERENTLY                     
         B     VR129                                                            
                                                                                
VR128B   DS    0H                    WEEK INPUT NOT A DIGIT                     
         CLI   8+3(R2),X'C0'          IT CAN'T BE C'{'                          
         BE    INVLFLD                                                          
         CH    RE,=H'12'              CAN ONLY BE LETTERS A-G                   
         BNE   INVLFLD                                                          
                                                                                
VR128D   DS    0H                                                               
         OI    WORK+1,X01           LOW ORDER BIT ON FOR ZERO & A-G             
         B     VR129                                                            
                                                                                
VR129    DS    0H                                                               
         MVC   IPPURE,WORK                                                      
         B     VR139                                                            
                                                                                
*                                                                               
VR130    DS    0H                  VALIDATE AS INVENTORY NUMBER                 
         XC    IPPURE,IPPURE        PURE NUMBER MEANINGLESS                     
         MVC   WORK(L'IPINVN),IKINV SET DEFAULT INVENTORY NUMBER                
*                                                                               
         CLI   5(R2),0                                                          
         BE    VR133                                                            
         CLI   5(R2),3                                                          
         BL    INVLFLD                                                          
                                                                                
         MVC   WORK(L'IPINVN),MYSPACES                                          
         ZIC   R1,5(R2)                                                         
         BCTR  R1,0                                                             
         EXMVC R1,WORK,8(R2)                                                    
*                                                                               
VR133    DS    0H                                                               
         MVC   IPINVN,WORK                                                      
         B     VR139                                                            
                                                                                
*                                                                               
VR139    EQU   *                                                                
                                                                                
*                                                                               
*** VALIDATE INPUT PARAMETER: DAY ***                                           
*                                                                               
VR140    DS    0H                                                               
         LA    R2,IROIPDYH                                                      
         MVI   BYTE,IPF1DY         SET FOR DAY INPUT                            
         BAS   RE,VRIPCH           GENERIC INPUT PARM FIELD ROUTINE             
                                                                                
         DS    0H                  SET LIST PARAMETER FOR DAY                   
         MVI   WORK,0                                                           
                                                                                
         CLI   5(R2),0                                                          
         BE    VR150                                                            
         OC    IPPURE,IPPURE        PURE NUMBER CONFLICTS W/ DAY/TIME           
         BNZ   INVLFLD                                                          
                                                                                
*                                                                               
         DS    0H                  VALIDATE FOR "VAR"                           
         CLC   IPFILE,DCFILPAV      APPLICABLE TO PAV                           
         BNE   VR142X                                                           
         CLI   5(R2),3              MUST ENTER ALL THREE CHARACTERS             
         BNE   VR142X                                                           
         CLC   8(3,R2),=C'VAR'                                                  
         BNE   VR142X                                                           
         MVI   WORK,X'90'                                                       
         B     VR150                                                            
VR142X   EQU   *                                                                
                                                                                
*                                                                               
         DS    0H                  VALIDATE FOR "AVN" OR "AVGN"                 
         CLC   IPFILE,DCFILPAV      APPLICABLE TO PAV                           
         BNE   VR143X                                                           
         ZIC   RF,5(R2)                                                         
         SHI   RF,2                                                             
         BNP   VR143X                                                           
         EXCLC RF,8(R2),=C'AVG'     LOOK FOR "AV" OR "AVG"                      
         BNE   VR143X                NOPE                                       
         LA    RE,8+1(RF,R2)        RE-->LAST CHAR OF INPUT                     
         CLI   0(RE),C'2'           SHOULD BE BETWEEN 2                         
         BL    VR143X                                                           
         CLI   0(RE),C'6'            AND 6 DAYS                                 
         BH    VR143X                                                           
         MVC   WORK(1),0(RE)                                                    
         NI    WORK,X'9F'           X'90' BITS ==> VAR OR AVG-N                 
         B     VR150                                                            
VR143X   EQU   *                                                                
                                                                                
         DS    0H                                                               
         GOTO1 DAYVAL,DMCB,(5(R2),8(R2)),WORK,WORK+1                            
         CLI   WORK,0                                                           
         BE    INVLDAY                                                          
                                                                                
VR150    DS    0H                                                               
         MVC   IPIDAY,WORK                                                      
                                                                                
*                                                                               
*** VALIDATE INPUT PARAMETER: TIME/EFFECTIVE DATE ***                           
*                                                                               
VR160    DS    0H                                                               
         LA    R2,IROIPTEH                                                      
         MVI   BYTE,IPF1TE         SET FOR TIME/EFFDATE INPUT                   
         BAS   RE,VRIPCH           GENERIC INPUT PARM FIELD ROUTINE             
*                                                                               
         DS    0H                                                               
         CLC   IPFILE,DCFILIUN                                                  
         BE    VR166                                                            
                                                                                
*                                                                               
         DS    0H                  VALIDATE AS TIME                             
         XC    IPEFFD,IPEFFD        EFFECTIVE DATE MEANINGLESS                  
         XC    IPTIME,IPTIME        SET DEFAULT FOR TIME                        
                                                                                
         CLI   5(R2),0                                                          
         BE    VR170                                                            
                                                                                
         OC    IPPURE,IPPURE        PURE NUMBER CONFLICTS W/ DAY/TIME           
         BNZ   INVLFLD                                                          
                                                                                
         GOTO1 TIMVAL,DMCB,(5(R2),8(R2)),WORK                                   
         CLI   0(R1),XFF                                                        
         BE    INVLTIM                                                          
         MVC   IPTIME,WORK                                                      
         B     VR170                                                            
                                                                                
*                                                                               
VR166    DS    0H                  VALIDATE AS DATE                             
         XC    IPTIME,IPTIME        TIME MEANINGLESS                            
         MVC   IPEFFD,IKEFFDC       SET DEFAULT EFFECTIVE DATE                  
                                                                                
         CLI   5(R2),0                                                          
         BE    VR170                                                            
                                                                                
         GOTO1 DATVAL,DMCB,(0,8(R2)),WORK+2                                     
         ICM   R0,15,0(R1)                                                      
         BZ    INVLDAT                                                          
                                                                                
         DS    0H                                                               
         GOTO1 DATCON,(R1),(0,WORK+2),(2,WORK),0                                
         MVC   IPEFFD,WORK                                                      
         B     VR170                                                            
                                                                                
VR170    DS    0H                                                               
*                                                                               
*** VALIDATE INPUT PARAMETER: DEMO CATEGORY ***                                 
*                                                                               
VR180    DS    0H                                                               
         LA    R2,IROIPDCH                                                      
         TM    4(R2),X80           WAS IT INPUTTED THIS TIME?                   
         BZ    VR200                NOPE, SKIP THIS VALIDATION                  
                                                                                
         OI    CHNGFLG1,CF1IPDC     YES, FLAG THAT SOMETHING CHANGED            
                                                                                
         DS    0H                  NOW DO THE SPECIFICS OF THE CHANGE           
         MVC   WORK(L'IPDEMC),FDDEMC                                            
         CLI   5(R2),0                                                          
         BE    VR190                                                            
                                                                                
         DS    0H                  BUILD DBLOCK FOR DEMOVAL                     
         L     R5,ADBLOCK                                                       
         USING DBLOCKD,R5                                                       
         LR    R0,R5                                                            
         LA    R1,DBLOCK1X-DBLOCK1                                              
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE               CLEAR DBLOCK                                 
         MVC   DBFILE,IPFILE                                                    
         MVC   DBCOMFCS,ACOMFACS                                                
         MVI   DBSELMED,C'T'                                                    
         MVC   DBSELSRC,IPRSVC                                                  
         MVC   DBSELAGY,TWAAGY                                                  
         MVI   BYTE,C'S'                                                        
         CLC   DBFILE,DCFILPAV                                                  
         BNE   *+8                                                              
         MVI   BYTE,0                                                           
                                                                                
         GOTO1 DEMOVAL,DMCB,(1,(R2)),(1,DUB),(BYTE,DBLOCKD),0                   
         CLI   0(R1),0                                                          
         BNE   INVLFLD                                                          
         DROP  R5                                                               
                                                                                
         MVC   WORK(L'IPDEMC),DUB+2   GET DEMO CATEGORY #                       
                                                                                
VR190    DS    0H                                                               
         MVC   IPDEMC,WORK                                                      
                                                                                
         LA    RF,DEMOLIST         UPDATE DEMOLIST TO HAVE NEW CATEGORY         
VR195    CLI   0(RF),XFF                                                        
         BE    VR200                                                            
         MVC   2(1,RF),IPDEMC                                                   
         LA    RF,3(RF)                                                         
         B     VR195                                                            
                                                                                
                                                                                
VR200    DS    0H                                                               
         EJECT                                                                  
*                                                                               
** VALIDATE EXPANDED DEMOS **                                                   
*                                                                               
         DS    0H                                                               
         NI    CHNGFLG1,XFF-CF1XDDC                                             
         TM    SCRNFLG,SCRFXPDM                                                 
         BZ    VR209                                                            
*                                                                               
         MVI   GOSUBNXD,XDDMVL#                                                 
         MVI   GOSUBN,XDPTR#                                                    
         GOTO1 AGOSUB                                                           
         BE    VR209                                                            
         CLI   OURERRCD,0                                                       
         BE    INVLFLD                                                          
         B     VKERROR                                                          
VR209    EQU   *                                                                
                                                                                
*                                                                               
         B     VR300                                                            
         EJECT                                                                  
*                                                                               
** STUFF TO DO BASED ON THIS TIME'S INPUT **                                    
*                                                                               
VR300    DS    0H                                                               
         NI    VRFLAG1,XFF-VRF1TSKS                                             
                                                                                
                                                                                
*                                                                               
*** DELETE LIST TABLE ENTRIES & LOCATE NEXT ENTRY ***                           
*                                                                               
         TM    SELFLAG1,SF1DEL                                                  
         BO    VR307                                                            
                                                                                
         B     VR309                                                            
*                                                                               
VR307    DS    0H                                                               
         MVI   GOSUBN,DLTN#        DELETE LIST TABLE ENTRIES                    
         GOTO1 AGOSUB                                                           
                                                                                
         MVI   GOSUBN,LNS#         LOCATE NEXT SLOT & COUNT # ENTRIES           
         GOTO1 (RF)                                                             
                                                                                
         CLC   SNLDSPLY,NLTNTRY                                                 
         BNH   *+10                                                             
         MVC   SNLDSPLY,NLTNTRY                                                 
                                                                                
         OI    VRFLAG1,VRF1DLN                                                  
*                                                                               
VR309    EQU   *                                                                
                                                                                
*                                                                               
*** REFRESH LIST TABLE & LOCATE NEXT ENTRY ***                                  
*                                                                               
         TM    CHNGFLG1,CF1IP                                                   
         BZ    *+12                IF ANY INPUT PARAMETER MODIFIED              
         TM    INPMFLG1,IPF1ALL                                                 
         BNZ   VR315                AND THERE IS INPUT PARAMETER DATA           
                                                                                
         TM    SELFLAG1,SF1DSLCT+SF1DSLCTXD                                     
         BZ    *+12                IF A DE-SELECTION LEAVES                     
         TM    SELFLAG1,SF1AL1ES+SF1AL1ESXD                                     
         BZ    VR315                US WITH NO ENTRIES SELECTED                 
                                                                                
         B     VR319                                                            
*                                                                               
VR315    DS    0H                                                               
         MVI   GOSUBN,RLT#         REFRESH LIST TABLE                           
         GOTO1 AGOSUB                                                           
                                                                                
         MVI   GOSUBN,LNS#         LOCATE NEXT SLOT & COUNT # ENTRIES           
         GOTO1 (RF)                                                             
                                                                                
         OI    VRFLAG1,VRF1RLT                                                  
*                                                                               
VR319    EQU   *                                                                
                                                                                
*                                                                               
*** RE-BUILD LIST TABLE ***                                                     
*                                                                               
         TM    CHNGFLG1,CF1IP      IF ANY INPUT PARAMETERS MODIFIED             
         BZ    *+12                                                             
         TM    INPMFLG1,IPF1ALL     AND THERE IS INPUT PARAMETER DATA           
         BNZ   VR325                                                            
                                                                                
         TM    SELFLAG1,SF1AL1ES+SF1AL1ESXD IF NO ENTRIES SELECTED, AND         
         BNZ   *+20                                                             
         TM    CHNGFLG1,CF1IP       INPUT PARAMETER MODIFIED                    
         BO    VR325                                                            
         TM    SELFLAG1,SF1DSLCT+SF1DSLCTXD   OR DE-SELECTION WAS DONE          
         BNZ   VR325                                                            
                                                                                
         B     VR329                                                            
*                                                                               
VR325    DS    0H                                                               
                                                                                
         MVI   GOSUBN,BLT#         RE-BUILD LIST TABLE                          
         MVI   BYTE,VRF1BLT         AND SET FLAG                                
         TM    INPMFLG1,IPF1ALL                                                 
         BNZ   *+12                                                             
         MVI   GOSUBN,ILT#          OR INITIALIZE IT IF NO INPUT PARMS          
         MVI   BYTE,VRF1ILT          AND SET FLAG AGAIN                         
         OC    VRFLAG1,BYTE         REMEMBER IF WE BUILD OR INIT TABLE          
         GOTO1 AGOSUB                                                           
                                                                                
         MVI   SNLDSPLY,1           START DISPLAY FROM 1ST ENTRY                
         CLI   NLTNTRY,0                                                        
         BH    VR326X                                                           
         TM    INPMFLG1,IPF1ALL                                                 
         BNZ   NODEMFND                                                         
         MVI   SNLDSPLY,0            UNLESS THERE ARE NO ENTRIES                
VR326X   EQU   *                                                                
*                                                                               
VR329    EQU   *                                                                
                                                                                
*                                                                               
*** RE-BUILD LIST DIRECTORY ***                                                 
*                                                                               
         TM    VRFLAG1,VRF1BLT+VRF1ILT                                          
         BNZ   VR335               IF "BUILT/INIT LIST TABLE" FLAGGED           
         TM    CHNGFLG1,CF1IP                                                   
         BO    VR335               IF ANY INPUT PARAMETER CHANGED               
         TM    SELFLAG1,SF1SLECT+SF1DSLCT+SF1SLECTXD+SF1DSLCTXD                 
         BNZ   VR335               IF ANYTHING SELECTED/DESELECTED              
         TM    VRFLAG1,VRF1DLN                                                  
         BO    VR335               IF ANY ENTRIES DELETED                       
                                                                                
         B     VR339                                                            
*                                                                               
VR335    DS    0H                                                               
         MVI   GOSUBN,BLD#                                                      
         GOTO1 AGOSUB                                                           
                                                                                
         OI    VRFLAG1,VRF1BLD                                                  
*                                                                               
VR339    EQU   *                                                                
                                                                                
*                                                                               
*** SEED DEMO VALUES ***                                                        
*                                                                               
         TM    VRFLAG1,VRF1BLT+VRF1ILT                                          
         BNZ   VR345               IF "BUILT/INIT LIST TABLE" FLAGGED           
         TM    CHNGFLG1,CF1IPDC                                                 
         BO    VR345               IF DEMO CATEGORY INPUT PARM CHANGED          
                                                                                
         B     VR349                                                            
*                                                                               
VR345    DS    0H                                                               
         MVI   GOSUBN,SDV#                                                      
         GOTO1 AGOSUB                                                           
                                                                                
         OI    VRFLAG1,VRF1SDV                                                  
*                                                                               
VR349    EQU   *                                                                
                                                                                
*                                                                               
*** RECALCULATE CUMULATIVE VALUES ***                                           
*                                                                               
         TM    CHNGFLG1,CF1IPDC    IF DEMO CATEGORY FIELD INPUTTED              
         BO    VR355                                                            
         TM    SELFLAG1,SF1SLECT+SF1DSLCT                                       
         BNZ   VR355               IF ANYTHING SELECTED/DESELECTED              
         TM    SELFLAG1,SF1DELSEL                                               
         BO    VR355               IF ANY SELECTED ITEM IS DELETED              
         TM    CHNGFLG1,CF1OPT                                                  
         BO    VR355               IF OPTIONS MODIFIED                          
                                                                                
         B     VR359                                                            
                                                                                
*                                                                               
VR355    DS    0H                   RECALCULATE CUM VALUES                      
         TM    SELFLAG1,SF1AL1ES     IF AT LEAST ONE ENTRY SELECTED,            
         BZ    VR355BX                                                          
         CLI   HOWLT,HLTBUILT         IF LIST TABLE WAS BUILT,                  
         BE    VR356                   GO BUILD INVENTORY TRACK                 
         MVI   SELTYPE,C'S'                                                     
         MVI   GOSUBN,SST#            ELSE, IF SELECTED <> TRACK                
         GOTO1 AGOSUB                                                           
         BNE   VR356                   GO BUILD INVENTORY TRACK                 
VR355BX  EQU   *                                                                
         CLC   TRKUPGD,OPVUPGTB                                                 
         BNE   VR356                                                            
         CLC   TRKADTP,OPVADPTB                                                 
         BNE   VR356                                                            
         CLC   TRKCUME,OPVCUMTB      IF CUME OPTNS AGREE,                       
         BE    *+20                   DON'T WASTE TIME TO BUILD TRACK           
         CLI   TRKCUME,C'T'           IF NOT, THEN IF EITHER OPTION             
         BE    VR356                                                            
         CLI   OPVCUMTB,C'T'           SAYS TO TOTAL,                           
         BE    VR356                   THEN BUILD INV TRACK                     
                                                                                
         L     R6,AIO                                                           
         B     VR357                                                            
                                                                                
*                                                                               
VR356    DS    0H                  BUILD A TRACK THAT REFLECTS INPUT            
         MVI   SELTYPE,C'S'                                                     
         NI    RECDFLG1,XFF-RF1TKSAV                                            
         MVI   GOSUBN,BIT#                                                      
         GOTO1 AGOSUB                                                           
         BE    *+18                                                             
         MVC   MYTEXT+1(30),=C'Can''t calculate average values'                 
         MVI   MYTEXT+0,30                                                      
         B     VRERROR                                                          
*                                                                               
         L     R6,AIO3              AIO3 = A(BUILT INVENTORY RECORD)            
                                                                                
*                                                                               
VR357    DS    0H                  R6-->INVENTORY RECORD                        
         LA    RF,DEMOLIST                                                      
         ST    RF,ADEMLIST          SET ADDRESS OF THE DEMO LIST                
         MVI   GOSUBN,XDV#          EXTRACT DEMO VALUES FROM IT                 
         GOTO1 AGOSUB                                                           
         MVC   CUMDEMV(CUMDEMVL),THISDEMV                                       
                                                                                
VR358    DS    0H                                                               
         OI    VRFLAG1,VRF1CUM                                                  
                                                                                
*                                                                               
VR359    EQU   *                                                                
                                                                                
*                                                                               
*** RECALCULATE EXPANDED DEMO VALUES ***                                        
*                                                                               
         DS    0H                  RECALCULATE EXPANDED DEMOS IF:               
         TM    SELFLAG1,SF1SLECT+SF1DSLCT+SF1SLECTXD+SF1DSLCTXD                 
         BNZ   VR365                SELECTED OR DE-SELECTED                     
         TM    SELFLAG1,SF1DELSEL                                               
         BO    VR365                A SELECTED ITEM IS DELETED                  
         TM    CHNGFLG1,CF1XDDC                                                 
         BO    VR365                EXPANDED DEMO CATEGORY FLD MODFYD           
         TM    CHNGFLG1,CF1OPT                                                  
         BO    VR365                OPTIONS MODIFIED                            
                                                                                
         B     VR369                                                            
                                                                                
*                                                                               
VR365    DS    0H                   RECALCULATE VALUES FOR EXPANDED DEM         
         TM    SELFLAG1,SF1AL1ES+SF1AL1ESXD                                     
         BZ    VR365BX                                                          
         CLI   HOWLT,HLTBUILT         IF LIST TABLE WAS BUILT,                  
         BE    VR366                   GO BUILD INVENTORY TRACK                 
                                                                                
         MVI   SELTYPE,C'E'                                                     
         TM    SELFLAG1,SF1AL1ESXD                                              
         BO    *+8                                                              
         MVI   SELTYPE,C'S'                                                     
         MVI   GOSUBN,SST#            ELSE, IF SELECTED <> TRACK                
         GOTO1 AGOSUB                                                           
         BNE   VR366                   GO BUILD INVENTORY TRACK                 
VR365BX  EQU   *                                                                
*                                                                               
         DS    0H                  NOTHING SELECTED                             
         CLC   TRKUPGD,OPVUPGTB                                                 
         BNE   VR366                                                            
         CLC   TRKADTP,OPVADPTB                                                 
         BNE   VR366                                                            
         CLC   TRKCUME,OPVCUMTB      IF CUME OPTNS AGREE,                       
         BE    *+20                   DON'T WASTE TIME TO BUILD TRACK           
         CLI   TRKCUME,C'T'           IF NOT, THEN IF EITHER OPTION             
         BE    VR366                                                            
         CLI   OPVCUMTB,C'T'           SAYS TO TOTAL,                           
         BE    VR366                   THEN BUILD INV TRACK                     
*                                                                               
         DS    0H                  USE EXISTING TRACK ON FILE                   
         L     R6,AIO                                                           
         B     VR367                                                            
                                                                                
*                                                                               
VR366    DS    0H                  BUILD A TRACK THAT REFLECTS INPUT            
         MVI   SELTYPE,C'E'                                                     
         TM    SELFLAG1,SF1AL1ESXD                                              
         BO    *+8                                                              
         MVI   SELTYPE,C'S'                                                     
         NI    RECDFLG1,XFF-RF1TKSAV                                            
         MVI   GOSUBN,BIT#                                                      
         GOTO1 AGOSUB                                                           
         BE    *+18                                                             
         MVC   MYTEXT+1(30),=C'Can''t calculate average values'                 
         MVI   MYTEXT+0,30                                                      
         B     VRERROR                                                          
*                                                                               
         L     R6,AIO3              AIO3 = A(BUILT INVENTORY RECORD)            
                                                                                
*                                                                               
VR367    DS    0H                  R6-->INVENTORY RECORD                        
         MVI   GOSUBNXD,XDXDV#      EXTRACT DEM VALS FOR EXPANDED DEMS          
         MVI   GOSUBN,XDPTR#                                                    
         GOTO1 AGOSUB                                                           
                                                                                
VR368    DS    0H                                                               
         OI    VRFLAG1,VRF1XDM                                                  
                                                                                
*                                                                               
VR369    EQU   *                                                                
         EJECT                                                                  
*                                                                               
** SAVE INVENTORY TRACK **                                                      
*                                                                               
* The rule here is that we can not save when the user simultaneously            
*  hits PF10 to save AND modifies options or input parameters or                
*  select/deselects entry(s).  Saving a track record is only                    
*  for INV/ROVER.                                                               
                                                                                
VR400    DS    0H                                                               
         CLI   PFKEY,PFQSAVE                                                    
         BNE   VR449                                                            
                                                                                
         DS    0H                  CHECK IF PF10 IS VALID HERE                  
         CLI   ACTNUM,ANROVER                                                   
         BNE   INVLPFK                                                          
         TM    DPLYFLG1,DF1PFSAV                                                
         BZ    INVLPFK                                                          
         TM    CHNGFLG1,CF1OPT                                                  
         BNZ   NSVCOPT                                                          
         TM    CHNGFLG1,CF1IP                                                   
         BNZ   NSVCLP                                                           
         TM    SELFLAG1,SF1SLECT+SF1DSLCT                                       
         BNZ   NSVDSEL                                                          
         TM    SELFLAG1,SF1AL1ES                                                
         BZ    INVLPFK                                                          
                                                                                
         MVI   ACTVWHY,C'C'        SET REASON FOR ACTIVITY                      
         TM    RECDFLG1,RF1DNXST   IF TRACK DID NOT EXIST,                      
         BZ    *+8                                                              
         MVI   ACTVWHY,C'A'         THEN REASON IS ADD                          
         MVI   SELTYPE,C'S'                                                     
         OI    RECDFLG1,RF1TKSAV                                                
         MVI   GOSUBN,BIT#         BUILD INVENTORY TRACK                        
         GOTO1 AGOSUB               AIO3=A(RESULT)                              
         BE    *+18                                                             
         MVC   MYTEXT+1(16),=C'Can''t save track'                               
         MVI   MYTEXT+0,16                                                      
         B     VRERROR                                                          
                                                                                
*                                                                               
         TM    RECDFLG1,RF1DNXST   IF RECORD DID NOT EXIST,                     
         BO    VR430                ADD IT TO FILE                              
                                                                                
         L     RF,AIO1             RF-->ORIG INVENTORY TRACK                    
         MVC   KEY(L'RINVKEY),0(RF)                                             
         MVI   RDUPDATE,C'Y'       READ FOR UPDATE                              
         GOTO1 READ                                                             
         CLC   KEY(L'RINVKEY),KEYSAVE                                           
         BE    *+6                                                              
         DC    H'0'                                                             
         MVI   RDUPDATE,C'Y'       READ FOR UPDATE                              
         GOTO1 GETREC              ESTABLISH DISK ADDRESS                       
                                                                                
         MVC   AIO,AIO3                                                         
         GOTO1 PUTREC                                                           
         MVC   AIO,AIO1            RESTORE I/O AREA FOR GENCON                  
         B     VR433X                                                           
                                                                                
VR430    DS    0H                  ADD RECORD TO FILE                           
         MVI   GOSUBN,FNR#          FIX NEW INVENTORY RECORD                    
         GOTO1 AGOSUB                                                           
                                                                                
         MVC   AIO,AIO3                                                         
         GOTO1 ADDREC                                                           
         MVC   AIO,AIO1            RESTORE I/O AREA FOR GENCON                  
         B     VR433X                                                           
*                                                                               
VR433X   EQU   *                                                                
         NI    RECDFLG1,XFF-RF1TKSAV                                            
                                                                                
*                                                                               
         DS    0H                                                               
         CLI   IROUPFN,C'Y'        IF UPDATING FOOTNOTE ON SAVE,                
         BNE   VR435X                                                           
*&&DO                                                                           
         CLC   TWAAGY,=C'N2'        AND IF CLIENT IS ABC,                       
         BNE   VR435X                                                           
*&&                                                                             
         TM    RMPPROFS+RMPRUFNB,RMPRUFNA  AND DON'T UPDT FTNT PRFL ON,         
         BNO   VR435X                                                           
         MVI   IROUPFN,C'N'         CHANGE IT TO DON'T UPDATE                   
         OI    IROUPFNH+6,X80       WHEN A TRACK IS ADDED                       
VR435X   EQU   *                                                                
                                                                                
*                                                                               
         DS    0H                                                               
         MVI   GOSUBN,PLR#         GO PROCESS LTRANS REQUEST                    
         GOTO1 AGOSUB                                                           
                                                                                
*                                                                               
         DS    0H                                                               
         MVI   GOSUBN,GFN#         GO GET NEW FOOTNOTE                          
         GOTO1 AGOSUB                                                           
         OI    DPLYFLG1,DF1FTNOT    AND FLAG TO DISPLAY IT                      
         B     VR449                                                            
                                                                                
*                                                                               
VR449    EQU   *                                                                
         EJECT                                                                  
*                                                                               
** DELETE INVENTORY TRACK (ACTION=TKDELETE) **                                  
*                                                                               
         DS    0H                                                               
         CLI   ACTNUM,ANTKDELE     CAN ONLY DELETE W/ THIS ACTION               
         BNE   VR549                                                            
         CLI   PFKEY,0             DO NOT DELETE IF PFKEY<>0                    
         BNE   VR549                                                            
         TM    RECDFLG1,RF1DEL     NO NEED IF MARKED DELETED ALREADY            
         BO    VR540                                                            
                                                                                
         B     VR510                                                            
                                                                                
*                                                                               
*** GET RECORD FOR UPDATING ***                                                 
*                                                                               
VR510    DS    0H                                                               
         L     RF,AIO1             RF-->ORIG INVENTORY TRACK                    
         MVC   KEY(L'RINVKEY),0(RF)                                             
         MVI   RDUPDATE,C'Y'       READ FOR UPDATE                              
         GOTO1 READ                                                             
         CLC   KEY(L'RINVKEY),KEYSAVE                                           
         BE    *+6                                                              
         DC    H'0'                                                             
         MVI   RDUPDATE,C'Y'       READ FOR UPDATE                              
         GOTO1 GETREC              ESTABLISH DISK ADDRESS                       
                                                                                
*                                                                               
**** MARK FOR DELETIONS ****                                                    
*                                                                               
         LA    R6,KEY                                                           
         USING RINVKEY,R6                                                       
         OI    RINVKEY+L'RINVKEY,X80    MARK DIRECTORY ITEM                     
         DROP  R6                                                               
                                                                                
         L     R6,AIO                                                           
         USING RINVREC,R6                                                       
         OI    RINVCNTL,X80             MARK RECORD                             
         DROP  R6                                                               
                                                                                
*                                                                               
**** UPDATE ACTIVITY ELEMENT ****                                               
*                                                                               
         DS    0H                  R6-->INVENTORY RECORD (TRACK)                
         MVI   ACTVWHY,C'C'         SET REASON FOR ACTIVITY                     
         MVI   GOSUBN,UAE#                                                      
         GOTO1 AGOSUB                                                           
         B     VR520                                                            
                                                                                
*                                                                               
*** PUT RECORD BACK INTO FILE ***                                               
*                                                                               
VR520    DS    0H                                                               
         GOTO1 PUTREC                                                           
         GOTO1 WRITE                                                            
*                                                                               
         DS    0H                                                               
         MVI   GOSUBN,PLR#         GO PROCESS LTRANS REQUEST                    
         GOTO1 AGOSUB                                                           
                                                                                
         B     VR540                                                            
                                                                                
*                                                                               
*** RECORD MARKED FOR DELETION ALREADY ***                                      
*                                                                               
VR540    DS    0H                                                               
         MVI   OURINFCD,RDELQ      SET MSG TO DISPLAY                           
         B     VR549                                                            
*                                                                               
VR549    EQU   *                                                                
         EJECT                                                                  
*                                                                               
** RESTORE INVENTORY TRACK (ACTION=TKRESTOR) **                                 
*                                                                               
         DS    0H                                                               
         CLI   ACTNUM,ANTKREST     CAN ONLY RESTORE W/ THIS ACTION              
         BNE   VR599                                                            
         CLI   PFKEY,0             DO NOT RESTORE IF PFKEY<>0                   
         BNE   VR599                                                            
         TM    RECDFLG1,RF1DEL     NO NEED IF RECORD NOT DELETED                
         BZ    VR599                                                            
                                                                                
         B     VR560                                                            
                                                                                
*                                                                               
*** GET RECORD FOR UPDATING ***                                                 
*                                                                               
VR560    DS    0H                                                               
         L     RF,AIO1             RF-->ORIG INVENTORY TRACK                    
         MVC   KEY(L'RINVKEY),0(RF)                                             
         MVI   RDUPDATE,C'Y'       READ FOR UPDATE                              
         OI    DMINBTS,X08         READ DELETES ALSO                            
         GOTO1 READ                                                             
         NI    DMINBTS,XFF-X08                                                  
         CLC   KEY(L'RINVKEY),KEYSAVE                                           
         BE    *+6                                                              
         DC    H'0'                                                             
         MVI   RDUPDATE,C'Y'       READ FOR UPDATE                              
         OI    DMINBTS,X08         READ DELETES ALSO                            
         GOTO1 GETREC              ESTABLISH DISK ADDRESS                       
         NI    DMINBTS,XFF-X08                                                  
                                                                                
*                                                                               
**** UNMARK DELETIONS ****                                                      
*                                                                               
         LA    R6,KEY                                                           
         USING RINVKEY,R6                                                       
         NI    RINVKEY+L'RINVKEY,XFF-X80  UNMARK DIRECTORY ITEM                 
         DROP  R6                                                               
                                                                                
         L     R6,AIO                                                           
         USING RINVREC,R6                                                       
         NI    RINVCNTL,XFF-X80           MARK RECORD                           
         DROP  R6                                                               
                                                                                
*                                                                               
**** UPDATE ACTIVITY ELEMENT ****                                               
*                                                                               
         DS    0H                  R6-->INVENTORY RECORD (TRACK)                
         MVI   ACTVWHY,C'C'         SET REASON FOR ACTIVITY                     
         MVI   GOSUBN,UAE#                                                      
         GOTO1 AGOSUB                                                           
         B     VR570                                                            
                                                                                
*                                                                               
*** PUT RECORD BACK INTO FILE ***                                               
*                                                                               
VR570    DS    0H                                                               
         GOTO1 PUTREC                                                           
         GOTO1 WRITE                                                            
*                                                                               
         DS    0H                                                               
         MVI   GOSUBN,PLR#         GO PROCESS LTRANS REQUEST                    
         GOTO1 AGOSUB                                                           
                                                                                
         B     VR590                                                            
                                                                                
*                                                                               
*** RECORD RESTORED ***                                                         
*                                                                               
VR590    DS    0H                                                               
         MVI   OURINFCD,RRSTQ      SET MSG TO DISPLAY                           
         B     VR599                                                            
*                                                                               
VR599    EQU   *                                                                
         EJECT                                                                  
*                                                                               
** EXIT VALREC **                                                               
*                                                                               
VRX      DS    0H                                                               
         B     DREC                GO AND RE-DISPLAY                            
                                                                                
                                                                                
* Little helper routine to test if a input parameter field changed.             
* At entry,                                                                     
*   R2-->list parameter field,                                                  
*   BYTE=input parameter flag.                                                  
* At exit,                                                                      
*   INPMFLG1 has input flag on if there was data for input,                     
*   CF1IP on in CHNGFLG1 if field was modified, and                             
*   A1LPCH set if not already set.                                              
* **WARNING** Do NOT clobber RE!                                                
                                                                                
VRIPCH   DS    0H                                                               
         CLI   5(R2),0             IS THERE DATA FOR THIS INPUT PARM?           
         BE    VRIPCH09                                                         
         OC    INPMFLG1,BYTE        YES, TURN ON RESPECTIVE FLAG                
         OC    A1IPDATA,A1IPDATA    FIRST INPUT PARM FIELD W/ DATA?             
         BNZ   *+8                                                              
         ST    R2,A1IPDATA           YES, SET ADDRESS OF FIELD                  
VRIPCH09 EQU   *                                                                
                                                                                
         TM    4(R2),X80           FIELD MODIFIED?                              
         BZR   RE                   NO, RETURN TO CALLER NOW                    
         OI    CHNGFLG1,CF1IP                                                   
         OC    A1LPCH,A1LPCH       1ST INPUT PARAMETER FIELD CHANGED?           
         BNZR  RE                   NOPE                                        
         ST    R2,A1LPCH            YES, SET ADDRESS OF FIELD                   
         BR    RE                                                               
                                                                                
                                                                                
* Little helper routine to extract a TWA field into MYFLD.                      
* At entry,                                                                     
*   R2-->TWA field.                                                             
                                                                                
         DS    0H                                                               
VRGETFLD NTR1                                                                   
         XC    MYFLD(MYFLDL),MYFLD                                              
         ZIC   R1,0(R2)                                                         
         CLI   0(R2),MYFLDL                                                     
         BNH   *+8                                                              
         LA    R1,MYFLDL                                                        
         BCTR  R1,0                                                             
         EXMVC R1,MYFLD,0(R2)                                                   
         B     XIT                                                              
***********************************************************************         
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (VALIDATION ERRORS+        
               )'                                                               
***********************************************************************         
*========================= VALIDATION ERRORS =========================*         
                                                                                
VKERROR  DS    0H                  (ERROR CODE MUST BE SET)                     
VRERROR  EQU   VKERROR             (ERROR CODE MUST BE SET)                     
         B     OURERROR                                                         
                                                                                
MISSFLD  DS    0H                  MISSING INPUT FIELD ERROR                    
         MVI   OURERRCD,MFLDQ                                                   
         B     OURERROR                                                         
                                                                                
INVLFLD  DS    0H                  INVALID FIELD ERROR                          
         MVI   OURERRCD,IFLDQ                                                   
         B     OURERROR                                                         
                                                                                
RCDNTFND DS    0H                  RECORD NOT FOUND                             
         MVI   OURERRCD,RNFQ                                                    
         B     OURERROR                                                         
                                                                                
INVLSRC  DS    0H                  INVALID SOURCE                               
         MVI   OURERRCD,ISRCQ                                                   
         B     OURERROR                                                         
                                                                                
INVLBK   DS    0H                  INVALID BOOK                                 
         MVI   OURERRCD,IBKQ                                                    
         B     OURERROR                                                         
                                                                                
INVLFIL  DS    0H                  INVALID FILE                                 
         MVI   OURERRCD,IFILQ                                                   
         B     OURERROR                                                         
                                                                                
INVLSTA  DS    0H                  INVALID STATION                              
         MVI   OURERRCD,ISTAQ                                                   
         B     OURERROR                                                         
                                                                                
INVLDAY  DS    0H                  INVALID DAY                                  
         MVI   OURERRCD,IDAYQ                                                   
         B     OURERROR                                                         
                                                                                
INVLTIM  DS    0H                  INVALID DAY                                  
         MVI   OURERRCD,ITIMQ                                                   
         B     OURERROR                                                         
                                                                                
NSVCOPT  DS    0H                  WILL NOT SAVE AFTER OPTIONS CHANGE           
         MVI   OURWRNCD,NSV1Q                                                   
         B     OURWARN                                                          
                                                                                
NSVDSEL  DS    0H                  WILL NOT SAVE AFTER SELECT/DESELECT          
         MVI   OURWRNCD,NSV2Q                                                   
         B     OURWARN                                                          
                                                                                
NSVCLP   DS    0H                  WILL NOT SAVE AFTER LIST PARMS CHNGE         
         MVI   OURWRNCD,NSV3Q                                                   
         B     OURWARN                                                          
                                                                                
INVLPFK  DS    0H                  INVALID PF KEY                               
         LA    R2,IROSTTNH          POINT R2 TO A VALID FIELD                   
         MVI   OURERRCD,IPFKQ                                                   
         B     OURERROR                                                         
                                                                                
INVLDAT  DS    0H                  INVALID DATE                                 
         MVI   OURERRCD,IDATQ                                                   
         B     OURERROR                                                         
                                                                                
NOINVHDR DS    0H                  INVENTORY HEADER NOT FOUND                   
         MVI   OURERRCD,NHDRQ                                                   
         B     OURERROR                                                         
                                                                                
TKNOTXST DS    0H                  TRACK DISPLAYED DOES NOT EXIST               
         MVI   OURWRNCD,TDNEQ                                                   
         B     OURWARN                                                          
                                                                                
NODEMFND DS    0H                  NO DEMOGRAPHIC DATA FOUND                    
         MVI   OURERRCD,NDDFQ                                                   
         B     OURERROR                                                         
                                                                                
INVSRCST DS    0H                  INVALID SRC/STTN COMBO                       
         MVI   OURERRCD,SRCSTQ                                                  
         B     OURERROR                                                         
                                                                                
INVFLSRC DS    0H                  INVALID FIL/SRC COMBO                        
         MVI   OURERRCD,FLSRCQ                                                  
         B     OURERROR                                                         
                                                                                
***********************************************************************         
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (DISPREC)'                 
***********************************************************************         
*=========================== DISPLAY RECORD ==========================*         
DREC     DS    0H                                                               
                                                                                
         MVI   NLNDSPLY,0          NO LINES DISPLAYED THUS FAR                  
         NI    DPLYFLG1,XFF-DF1PFSAV                                            
                                                                                
*                                                                               
** LOAD SCREENS, IF NECESSARY **                                                
*                                                                               
         DS    0H                                                               
         CLI   OPVXDSNM,0                                                       
         BE    *+16                                                             
         CLI   OPVXDSTB,C'Y'                                                    
         BE    DRLSCRXD                                                         
         B     DRLSCRLI                                                         
                                                                                
         TM    SELFLAG1,SF1AL1ESXD                                              
         BNZ   DRLSCRXD                                                         
                                                                                
         TM    RMPPROFS+RMPRXPDB,RMPRXPDA                                       
         BNZ   DRLSCRXD                                                         
         B     DRLSCRLI                                                         
                                                                                
*                                                                               
DRLSCRLI DS    0H                  LOAD REGULAR LIST SCREEN                     
         TM    SCRNFLG,SCRFLIST     IS IT LOADED ALREADY?                       
         BZ    DRLSCRGO              NO, GO LOAD IT                             
         B     DRLSCRX                                                          
*                                                                               
DRLSCRXD DS    0H                  LOAD EXPANDED DEMO SCREEN                    
         TM    SCRNFLG,SCRFXPDM     IS IT LOADED ALREADY?                       
         BZ    DRLSCRGO              NO, GO LOAD IT                             
         B     DRLSCRX                                                          
                                                                                
*                                                                               
DRLSCRGO DS    0H                  LOAD SCREEN                                  
         XI    SCRNFLG,SCRFLIST+SCRFXPDM  SET SCREEN TO LOAD                    
         MVI   GOSUBN,LSCR#                                                     
         GOTO1 AGOSUB                                                           
DRLSCRX  EQU   *                                                                
*                                                                               
         MVI   GOSUBN,CPRTF#       GO SET PROTECTION OF FIELDS                  
         GOTO1 AGOSUB                                                           
                                                                                
*                                                                               
** STUFF TO DISPLAY ON KEY CHANGE **                                            
*                                                                               
         TM    CHNGFLG1,CF1KEY     DID KEY CHANGE?                              
         BZ    DR008X               NO, SKIP THIS                               
*                                                                               
         DS    0H                  DISPLAY TRANSFER CODE                        
         MVC   IROCODE,XFCODE                                                   
         OI    IROCODEH+6,X80                                                   
*                                                                               
         DS    0H                  DISPLAY DAY/TIME OF INVENTORY HDR            
         XC    IROIHDT,IROIHDT                                                  
         LA    R3,IROIHDT           FORMAT DAY & TIME INTO FIELD                
                                                                                
         MVC   TMPIDAY,HDRIDAY                                                  
         MVI   GOSUBN,TID#           TRANSLATE DAY                              
         GOTO1 AGOSUB                                                           
         ZIC   R1,BYTE               R1=L(CONVERTED DAY)                        
         BCTR  R1,0                                                             
         EXMVC R1,0(R3),WORK                                                    
         AR    R3,R1                                                            
         MVI   1(R3),C'/'                                                       
         LA    R3,2(R3)                                                         
                                                                                
         MVC   TMPSETM,HDRTIME                                                  
         MVI   GOSUBN,TMT#           TRANSLATE TIMES                            
         GOTO1 AGOSUB                                                           
         ZIC   R1,BYTE               R1=L(CONVERTED TIMES)                      
         BCTR  R1,0                                                             
         EXMVC R1,0(R3),WORK                                                    
         OI    IROIHDTH+6,X80                                                   
*                                                                               
         DS    0H                  DISPLAY PROGRAM TITLE OF INV HEADER          
         MVC   IROIHPG,HDRPRGNA                                                 
         OI    IROIHPGH+6,X80                                                   
*                                                                               
         DS    0H                  DISPLAY OPTION(S) SAVED W/ TRACK             
         OI    DPLYFLG1,DF1OPTTK    SET TO DISPLAY OPTNS SAVED IN TRK           
         MVI   GOSUBN,SOD#          SET OPTIONS TO DISPLAY                      
         GOTO1 AGOSUB                                                           
                                                                                
         XC    DUMUPGD,DUMUPGD      (EXTRA WORK FOR UPGRADES)                   
         MVI   GOSUBN,FOF#          DISPLAY THEM IN OPTIONS FIELD               
         GOTO1 (RF)                                                             
         MVC   TRKUPGD,DUMUPGD      (EXTRA WORK FOR UPGRADES)                   
*                                                                               
         DS    0H                                                               
         OI    IROUPFNH+6,X80                                                   
         MVI   IROUPFN,C'Y'        SET UP UPDATE FOOTNOTE ON SAVE               
*&&DO                                                                           
         CLC   TWAAGY,=C'N2'       IF AGENCY IS ABC,                            
         BNE   DR006X                                                           
*&&                                                                             
         TM    RMPPROFS+RMPRUFNB,RMPRUFNA  IF DON'T UPDT FTNT PRFL ON,          
         BNO   DR006X                                                           
         TM    RECDFLG1,RF1DNXST    AND THE TRACK DOES EXIST,                   
         BO    DR006X                                                           
         MVI   IROUPFN,C'N'         SET TO DON'T UPDATE FTNOTE ON SAVE          
DR006X   EQU   *                                                                
*                                                                               
         DS    0H                  CLEAR INPUT PARAMETER FIELDS                 
         TM    RECDFLG1,RF1DNXST    (IF RECORD EXISTS)                          
         BNZ   DR008X                                                           
                                                                                
         LA    R2,IROIPSCH          START @ FIELD                               
         LA    R3,IROIPTEH          END @ FIELD                                 
         SR    R0,R0                                                            
                                                                                
DR008B   DS    0H                                                               
         IC    R0,0(R2)             R0 = L(TWA FIELD)                           
         LR    R1,R0                                                            
         SH    R1,=H'8'                                                         
         TM    1(R2),X02                                                        
         BZ    *+8                                                              
         SH    R1,=H'8'                                                         
         BCTR  R1,0                 R1 = LENGTH FOR  EX  INSTRUCTIONS           
         EX    R1,*+8                                                           
         B     *+10                                                             
         OC    8(0,R2),8(R2)        ANYTHING IN DATA PORTION OF FIELD?          
         BZ    *+18                  NO                                         
         EX    R1,*+4                                                           
         XC    8(0,R2),8(R2)         YES, CLEAR IT OUT                          
         OI    6(R2),X80              AND TRANSMIT FIELD                        
                                                                                
         DS    0H                   BUMP TO NEXT FIELD                          
         AR    R2,R0                                                            
         CR    R2,R3                                                            
         BNH   DR008B                                                           
*                                                                               
         DS    0H                  CLEAR OTHER STUFF FOR INPUT PARMS            
         NI    CHNGFLG1,XFF-CF1IP                                               
         NI    INPMFLG1,XFF-IPF1ALL                                             
         XC    INPUTPRM(INPTPRML),INPUTPRM                                      
DR008X   EQU   *                                                                
                                                                                
*                                                                               
DR00ROP  DS    0H                  (FORCE) RE-DISPLAY OF OPTIONS                
         TM    DPLYFLG1,DF1OPTN                                                 
         BZ    DR00ROPX                                                         
*                                                                               
         DS    0H                   DISPLAY OPTION(S)                           
         NI    DPLYFLG1,XFF-DF1OPTTK  WANT TO JUST RE-DISPLAY OPTNS FOR         
         TM    UPGFLAG,UPGFPUT         > AUTO PUT-UPGRADE APPLIED               
         BO    DR00ROPG                                                         
         TM    MISCFLG1,MF1GOPFM       > AUTO-PFM REQUEST                       
         BO    DR00ROPG                                                         
         OI    DPLYFLG1,DF1OPTTK      ELSE, DISPLAY OPTNS SAVED IN TRK          
DR00ROPG EQU   *                                                                
                                                                                
         MVI   GOSUBN,SOD#           SET OPTIONS TO DISPLAY                     
         GOTO1 AGOSUB                                                           
*                                                                               
         XC    DUMUPGD,DUMUPGD       (EXTRA WORK FOR UPGRADES)                  
         MVI   GOSUBN,FOF#           DISPLAY THEM IN OPTIONS FIELD              
         GOTO1 (RF)                                                             
         TM    DPLYFLG1,DF1OPTTK     IF NOT DISPLAYING OPTN FROM TRACK,         
         BZ    *+10                   DON'T UPDATE TRACK DATA FIELDS            
         MVC   TRKUPGD,DUMUPGD       (EXTRA WORK FOR UPGRADES)                  
*                                                                               
         TM    UPGFLAG,UPGFPUT       WAS PUT-UPGD AUTO APPLIED?                 
         BZ    DR00ROPPX              NOPE                                      
         LA    R3,OPVUPGTB                                                      
         MVI   GOSUBN,FUPG#                                                     
         GOTO1 AGOSUB                                                           
         ZICM  R1,BUFF+0,(1)                                                    
         BZ    DR00ROPPX                                                        
         STC   R1,MYTEXT+0                                                      
         BCTR  R1,0                                                             
         EXMVC R1,MYTEXT+1,BUFF+1    DISPLAY UPGD FORMULA IN INFO MSG           
         MVI   OURINFCD,UPAPPLQ                                                 
DR00ROPPX EQU  *                                                                
*                                                                               
         NI    DPLYFLG1,XFF-DF1OPTN                                             
DR00ROPX EQU   *                                                                
*                                                                               
         DS    0H                  DISPLAY DEMO CATEGORY NAME                   
         MVC   TMPDEMC,FDDEMC                                                   
         TM    CHNGFLG1,CF1KEY      ON KEY CHANGES                              
         BNZ   DR009B                                                           
         MVC   TMPDEMC,IPDEMC                                                   
         CLI   IROIPDCH+5,0         WHEN DEMO CATEGORY FIELD IS BLANK           
         BE    DR009B                                                           
         B     DR009X                                                           
DR009B   EQU   *                                                                
                                                                                
*                                                                               
         DS    0H                                                               
         MVC   WORK,MYSPACES                                                    
                                                                                
         DS    0H                   BUILD DEMO LIST (IN DUB)                    
         MVI   DUB+0,0                                                          
         MVI   DUB+1,C'R'            ARBITRARILY USE RATINGS                    
         MVC   DUB+2(1),TMPDEMC                                                 
         MVI   DUB+3,XFF             END OF DEMO LIST                           
                                                                                
         DS    0H                   GET DEMO NAME                               
         L     R5,ADBLOCK                                                       
         USING DBLOCKD,R5                                                       
         MVC   DBFILE,DCFILTP                                                   
         MVC   DBCOMFCS,ACOMFACS                                                
         MVI   DBSELSRC,C'N'                                                    
         MVI   DBSELMED,C'T'                                                    
         MVC   DBSELAGY,TWAAGY                                                  
         GOTO1 DEMOCON,DMCB,(1,DUB),(7,WORK),(C'S',DBLOCKD),0                   
         DROP  R5                                                               
                                                                                
         MVC   IROIPDC,WORK        MOVE NAME OF DEMO CATEGORY                   
         OI    IROIPDCH+6,X80       AND TRANSMIT FIELD                          
DR009X   EQU   *                                                                
                                                                                
*                                                                               
         DS    0H                  CHECK FOR AUTO-PFM REQUESTED                 
         TM    MISCFLG1,MF1GOPFM    AND REMEMBER TO CALL GLOBBER                
         BZ    DR00PFMX                                                         
         NI    MISCFLG1,XFF-MF1GOPFM                                            
                                                                                
         OC    TRKDA,TRKDA          MAKE SURE WE HAVE D/A TOO!                  
         BZ    DR00PFMX                                                         
*                                                                               
         DS    0H                   SET UP TO GO TO PFM VIA GLOBBER             
         MVI   GOSUBN,GPFM#                                                     
         GOTO1 AGOSUB                                                           
         BE    *+22                  IF RETURNED WITH AN ERROR,                 
         MVI   OURERRCD,XCTLQ         SET TO DISPLAY ERROR MESSAGE              
         MVI   MYTEXT+0,4                                                       
         MVC   MYTEXT+1(4),=C'$PFM'                                             
         B     OURERROR                                                         
*                                                                               
         B     DRX                                                              
DR00PFMX EQU   *                                                                
                                                                                
*                                                                               
** HANDLE PF KEYS **                                                            
*                                                                               
DR010    DS    0H                                                               
         CLI   PFKEY,0             IF A PF KEY WAS PRESSED,                     
         BE    DR014X                                                           
         BAS   RE,DOPFKEY           PROCESS IT                                  
         BE    DR014X                                                           
         LA    R2,IROSTTNH                                                      
         CLI   OURINFCD,0          MESSAGE IS EITHER AN INFORMATIONAL           
         BNE   OURINFO                                                          
         CLI   OURWRNCD,0           OR WARNING                                  
         BNE   OURWARN                                                          
         DC    H'0'                                                             
DR014X   EQU   *                                                                
                                                                                
*                                                                               
** DISPLAY FOOTNOTE **                                                          
*                                                                               
         DS    0H                  DISPLAY FOOTNOTE OF INV TRACK                
         TM    DPLYFLG1,DF1FTNOT    NEED TO DISPLAY FOOTNOTE?                   
         BZ    DR016X                NOPE                                       
                                                                                
         MVC   IROFTNT,TRKFTNT                                                  
         OI    IROFTNTH+6,X80                                                   
         MVI   IROFNLB+L'IROFNLB-1,C' '                                         
         OI    IROFNLBH+6,X80                                                   
         NI    DPLYFLG1,XFF-DF1FTNOT DON'T RE-DSPLY FTNOTE UNTIL NEEDED         
DR016X   EQU   *                                                                
                                                                                
*                                                                               
** DISPLAY LISTTAB ENTRIES **                                                   
*                                                                               
         DS    0H                                                               
         MVI   GOSUBN,CLA#         CLEAR LIST AREA ON SCREEN                    
         GOTO1 AGOSUB                                                           
*                                                                               
         CLI   NLTNTRY,0           IF NOTHING TO LIST,                          
         BH    DR022X                                                           
         TM    RECDFLG1,RF1DNXST    1) SEE IF RECORD EXISTS                     
         BZ    *+12                                                             
         MVI   OURWRNCD,TDNEQ           IF NOT, DISPLAY A WRNG MSG              
         B     DR060                                                            
         MVI   OURINFCD,DCPLXQ      ELSE, DISPLAY INFO MESSAGE NOW              
         B     DR060                                                            
DR022X   EQU   *                                                                
*                                                                               
         ZICM  R4,SNLDSPLY,(1)     START W/ 1ST ENTRY TO BE DISPLAYED           
         BNZ   *+6                                                              
         DC    H'0'                                                             
         BCTR  R4,0                                                             
         A     R4,AMLSTDIR                                                      
*                                                                               
         DS    0H                                                               
         LA    R2,IROLDTAH         POINT TO FIRST DISPLAY LINE                  
         USING LLINED,R2                                                        
*                                                                               
*** FILL-UP LIST DISPLAY LINES ***                                              
*                                                                               
DR030    DS    0H                                                               
         CLI   0(R4),EOT           SEE IF ANY MORE ENTRIES IN DIRECTORY         
         BE    DR060                                                            
*&&DO                                                                           
         CLI   NLNDSPLY,MXLSTLNS   MAKE SURE WE'RE W/IN BOUNDS                  
*&&                                                                             
         CLC   NLNDSPLY,NLSTLNS    MAKE SURE WE'RE W/IN BOUNDS                  
         BNL   DR060                                                            
*                                                                               
         DS    0H                  POINT TO ENTRY IN LIST TABLE                 
         ZIC   R5,0(R4)                                                         
         BCTR  R5,0                                                             
         MH    R5,=Y(LISTTABQ)                                                  
         A     R5,ALISTTAB                                                      
         USING LISTTABD,R5                                                      
*                                                                               
         TM    LTFLAG,LTFSEL       IF ITEM WAS SELECTED,                        
         BZ    *+8                                                              
         MVI   8(R2),C'*'           DISPLAY IT AS SO                            
         TM    LTFLAG,LTFSELXD     IF SELECTED TO EXPAND DEMO,                  
         BZ    *+8                                                              
         MVI   8(R2),C'E'                                                       
*                                                                               
         LA    RF,LTWTOVXD                                                      
         TM    LTFLAG,LTFSLWTXD    IF ITEM WAS SEL W/ WGT TO EXPND DEM,         
         BO    DR033G                                                           
         LA    RF,LTWGTOV                                                       
         TM    LTFLAG,LTFSELWT     IF ITEM WAS SELECTED W/ A WEIGHT,            
         BO    DR033G                                                           
*&&DO                                                                           
         BZ    DR033X                                                           
*&&                                                                             
         B     DR033X                                                           
DR033G   EQU   *                                                                
                                                                                
*&&DO                                                                           
         ZIC   R1,LTWGTOV                                                       
*&&                                                                             
         ZIC   R1,0(RF)                                                         
         CVD   R1,DUB                                                           
         UNPK  9(L'LLACT-1,R2),DUB  DISPLAY THE WEIGHT ALSO                     
         OI    8+(L'LLACT-1)(R2),X'F0'                                          
DR033X   EQU   *                                                                
*                                                                               
         MVC   LLDSRC,LTSRC        SOURCE                                       
*                                                                               
         MVC   LLDDFILE,LTFILE     FILE                                         
                                                                                
         CLC   LLDDFILE,DCFILTP     IF TIME PERIOD FILE,                        
         BNE   *+16                                                             
         TM    LTFLAG2,LTF2T4        CHECK FOR FOUR-WEEK/TYPICAL                
         BO    *+8                                                              
         MVI   LLDDFILE+1,C'T'       IF TYPICAL, DISPLAY AS C'TT'               
                                                                                
         CLI   LLDDFILE,C'I'        IF INVENTORY FILE,                          
         BNE   *+10                                                             
         MVC   LLDDCODE,LTCODE       PUT IN CODE AS WELL                        
         MVC   LLDDSTTN,LTSTTN     STATION                                      
         MVC   LLDDTITL,LTPGNAM    PROGRAM TITLE                                
*                                                                               
         CLI   LTSTTN+4,C'H'       NETWORK RECD?                                
         BNE   *+8                                                              
         MVI   LLDDSTTN+3,C'-'     FROM 'TEL H' TO TEL-H'                       
*                                                                               
         MVC   TMPSRC(1),LTSRC                                                  
         MVC   TMPFRBTS,LTFRBTS                                                 
         MVC   TMPBTYP,LTBTYP                                                   
         MVI   GOSUBN,GKS#                                                      
         GOTO1 AGOSUB               GET TMPKSRC IN ORDER                        
         MVI   GOSUBN,RKS#                                                      
         GOTO1 (RF)                  TO SET TMPQLFY                             
                                                                                
         MVC   TMPBOOK,LTBOOK                                                   
         MVC   TMPBTYP,LTBTYP                                                   
         MVC   TMPWKN,LTWKN                                                     
         MVI   GOSUBN,TBK#                                                      
         GOTO1 AGOSUB                                                           
                                                                                
         LA    R1,L'LLDDBOOK-1                                                  
         LA    RF,LLDDBOOK                                                      
         CLI   TMPQLFY,C' '        IF QUALIFIER IS A BLANK,                     
         BE    *+16                 DON'T DISPLAY IT                            
         MVC   0(1,RF),TMPQLFY                                                  
         LA    RF,1(RF)                                                         
         BCTR  R1,0                                                             
         EXMVC R1,0(RF),WORK       BOOK (W/ BOOK TYPE)                          
*                                                                               
         MVC   TMPIDAY,LTIDAY                                                   
         MVI   GOSUBN,TID#                                                      
         GOTO1 AGOSUB                                                           
*&&DO                                                                           
                                                                                
         ZIC   R1,LTPURE+1         SEE IF IT'S SOME TYPE OF ROTATION            
         SRL   R1,4                                                             
         CHI   R1,9                 SEE IF REGULAR M,TU,W,...,M-F,M-SU          
         BL    *+16                 (NON-PAV FILES TAKE THIS BRANCH)            
         MVC   WORK,MYSPACES                                                    
         MVC   WORK(3),=C'VAR'                                                  
*&&                                                                             
                                                                                
         MVC   LLDDDAY,WORK        DAY(S)                                       
*                                                                               
         XC    TMPSETM,TMPSETM                                                  
         MVC   TMPSTIM,LTSTIME                                                  
         MVI   GOSUBN,TMT#                                                      
         GOTO1 AGOSUB                                                           
         MVC   LLDDSTIM,WORK       START TIME                                   
*                                                                               
         DS    0H                  WEEKS/PURE#/INVENTORY#                       
         MVC   WORK,MYSPACES                                                    
         MVC   WORK(4),LTINVN       ASSUME INVENTORY NUMBER                     
         MVI   LLDDWPIN,C'I'        (INDICATE IT ON DISPLAY)                    
         CLI   LTFILE,C'I'                                                      
         BE    DR044                                                            
         MVC   TMPWKS,LTWKS         ASSUME ACTIVE WEEKS                         
         MVI   GOSUBN,TWK#                                                      
         GOTO1 AGOSUB                                                           
         CLC   WORK(4),MYSPACES                                                 
         BNE   *+8                                                              
         CLI   LTSTTN+4,C'H'       FOR NHT ONLY                                 
         BNE   *+10                                                             
         MVC   WORK+1(3),=C'N/A'     NO ACTIVE WEEKS IS FLAGGED N/A             
         MVI   LLDDWPIN,C'W'        (INDICATE IT ON DISPLAY)                    
         TM    LTFLAG,LTFMIXWK      IF MIXED ACTIVE WEEKS,                      
         BZ    *+8                                                              
         MVI   WORK+4,C'*'           INDICATE IT W/ AN "*"                      
         CLI   LTFILE,C'T'                                                      
         BE    DR044                                                            
         TM    LTFLAG2,LTF2PURE                                                 
         BZ    DR044                                                            
         MVC   TMPPURE(2),LTPURE                                                
*                                                                               
         CLI   LTSTTN+4,C'H'       NETWORK RECD?                                
         BE    DR38                                                             
         MVI   GOSUBN,TPUR#         TRANSLATE PURE NUMBER                       
         GOTO1 (RF)                                                             
         B     DR40                                                             
*                                                                               
DR38     L     RF,ACOMFACS         FOR NHT, PURE# IS PRG# IN HEX                
         L     RF,(CHEXOUT-COMFACSD)(RF)                                        
         GOTO1 (RF),DMCB,LTPURE,WORK,2                                          
*                                                                               
DR40     MVI   LLDDWPIN,C'P'        (INDICATE IT ON DISPLAY)                    
         MVI   WORK+4,C' '          REMOVE ANY INDICATORS FOR PURE #            
                                                                                
DR044    DS    0H                                                               
         MVC   LLDDWPIN+1(5),WORK  WEEK/PURE#/INVENTORY#                        
*                                                                               
         ZIC   R1,LTNQHR                                                        
         EDIT  (R1),(L'LLDDQHRS,LLDDQHRS),FILL=0                                
*                                                                               
         L     R1,LTRDEMV                                                       
         EDIT  (R1),(L'LLDDDRTG,LLDDDRTG),1,ZERO=NOBLANK                        
                                                                                
         L     R1,LTSDEMV                                                       
         CHI   R1,100*10                                                        
         BL    *+18                                                             
         MVI   LLDDDSHR,C'*'                                                    
         MVC   LLDDDSHR+1(L'LLDDDSHR-1),LLDDDSHR                                
         B     DR044SHRX                                                        
         EDIT  (R1),(L'LLDDDSHR,LLDDDSHR),1,ZERO=NOBLANK                        
DR044SHRX EQU  *                                                                
                                                                                
         L     R1,LTPDEMV                                                       
         EDIT  (R1),(L'LLDDDPUT,LLDDDPUT),1,ZERO=NOBLANK                        
         DROP  R5                                                               
*                                                                               
         OI    LLDISH+6,X80        TRANSMIT DISPLAY DATA LINE                   
         ZIC   R1,NLNDSPLY                                                      
         LA    R1,1(R1)                                                         
         STC   R1,NLNDSPLY         UPDATE # OF LINES DISPLAYED                  
                                                                                
         LA    R2,SZLSTLIN(R2)                                                  
         LA    R4,L'MLSTDIR(R4)                                                 
         B     DR030                                                            
         DROP  R2                                                               
*                                                                               
*** DONE LISTING THIS TIME AROUND ***                                           
*                                                                               
DR060    DS    0H                                                               
         ZICM  R1,SNLDSPLY,(1)                                                  
         BZ    *+6                                                              
         BCTR  R1,0                                                             
         ZIC   R0,NLNDSPLY                                                      
         AR    R1,R0                                                            
         STC   R1,ENLDSPLY         REMEMBER LAST ENTRY DISPLAYED                
                                                                                
         DS    0H                  SET MORE PREVIOUS/NEXT INDICATORS            
         MVC   WORK,MYSPACES                                                    
         CLI   NLNDSPLY,0                                                       
         BE    DR066                                                            
         CLI   SNLDSPLY,1                                                       
         BNH   *+10                                                             
         MVC   WORK(2),=C'<<'                                                   
         CLC   SNLDSPLY,NLTNTRY                                                 
         BNL   *+10                                                             
         MVC   WORK+3(2),=C'>>'                                                 
DR066    MVC   IROMPNI,WORK                                                     
         OI    IROMPNIH+6,X80                                                   
*                                                                               
** DISPLAY CUMULATIVE DEMO VALUES **                                            
*                                                                               
DR070    DS    0H                                                               
         XC    IRORDEM,IRORDEM                                                  
         XC    IROSDEM,IROSDEM                                                  
         XC    IROPDEM,IROPDEM                                                  
         XC    IROFLG,IROFLG                                                    
         OI    IRORDEMH+6,X80                                                   
         OI    IROSDEMH+6,X80                                                   
         OI    IROPDEMH+6,X80                                                   
         OI    IROFLGH+6,X80                                                    
*                                                                               
         DS    0H                  FORMAT CUMULATIVE VALUES                     
         L     R1,CUMRDEMV                                                      
         EDIT  (R1),(L'IRORDEM,IRORDEM),1,ZERO=NOBLANK                          
                                                                                
         L     R1,CUMSDEMV                                                      
         CHI   R1,100*10                                                        
         BL    *+18                                                             
         MVI   IROSDEM,C'*'                                                     
         MVC   IROSDEM+1(L'IROSDEM-1),IROSDEM                                   
         B     DR074SHRX                                                        
         EDIT  (R1),(L'IROSDEM,IROSDEM),1,ZERO=NOBLANK                          
DR074SHRX EQU  *                                                                
                                                                                
         L     R1,CUMPDEMV                                                      
         EDIT  (R1),(L'IROPDEM,IROPDEM),1,ZERO=NOBLANK                          
         TM    DEMFLAG1,DF1ADCMB   IF NUMBERS REPRESENT A TOTAL,                
         BZ    *+16                                                             
         MVC   IROSDEM,=C' N/A'     SUPPRESS SHARES                             
         MVC   IROPDEM,=C' N/A'     AND PUTS                                    
                                                                                
         TM    SELFLAG1,SF1AL1ES                                                
         BZ    *+8                                                              
         MVI   IROFLG,C'*'                                                      
*                                                                               
         DS    0H                  DISPLAY DEMO OVERRIDE FLAGS                  
         LA    R0,3                                                             
         LA    R2,IROAVD1H          R2-->AREA TO DISPLAY FLAG                   
         LA    R3,DEMOVRDS          R3-->OVERRIDE FLAGS                         
                                                                                
DR077    DS    0H                                                               
         MVC   8+3(1,R2),0(R3)      MOVE IN FLAG (IF ANY)                       
         OI    6(R2),X80                                                        
                                                                                
         ZIC   R1,0(R2)                                                         
         AR    R2,R1                BUMP TO NEXT AREA ON SCREEN                 
         LA    R3,L'DEMOVRDS(R3)    BUMP TO NEXT FLAG                           
         BCT   R0,DR077                                                         
                                                                                
*                                                                               
** DISPLAY EXPANDED DEMOS **                                                    
*                                                                               
DR080    DS    0H                                                               
         TM    SCRNFLG,SCRFXPDM    IS EXPANDED DEMOS SCREEN ACTIVATED?          
         BZ    DR084X               NOPE                                        
*                                                                               
         MVI   GOSUBNXD,XDCLA#     CLEAR EXPANDED DEMO AREA FIRST               
         MVI   GOSUBN,XDPTR#                                                    
         GOTO1 AGOSUB                                                           
         MVI   GOSUBNXD,XDDIS#                                                  
         MVI   GOSUBN,XDPTR#                                                    
         GOTO1 (RF)                                                             
DR084X   EQU   *                                                                
         B     DR090                                                            
                                                                                
*                                                                               
** DISPLAY PF KEYS **                                                           
*                                                                               
DR090    DS    0H                                                               
         LH    R3,DPFLINEH                                                      
         A     R3,ATWA             R3-->HEADER OF PF LINE                       
         OI    6(R3),X80                                                        
         MVC   8(L'IROPFLN,R3),MYSPACES                                         
         LA    R3,8(R3)                                                         
         USING PFLINED,R3                                                       
                                                                                
         MVC   PFLSCRLL,RE@10PF                                                 
*                                                                               
         CLI   ACTNUM,ANROVER      PF10=SAVE ONLY FOR INV/ROVER                 
         BNE   DR092X                                                           
*^^GYL - suppress for now (3/27/96)                                             
*&&DO                                                                           
         TM    IKFRBTS,BBPBK        AND PROJECTED BOOKS                         
         BNZ   DR092G                                                           
*&&                                                                             
*^^                                                                             
*^^COCO                                                                         
         PRINT OFF                                                              
*&&DO                                                                           
         TM    IKFRBTS,BBEBK        OR ESTIMATE BOOKS                           
         BZ    DR092X                                                           
*&&                                                                             
         PRINT ON                                                               
*^^EOCOCO                                                                       
         TM    SELFLAG1,SF1AL1ES     W/ AT LEAST 1 SELECTION                    
         BNZ   DR092G                                                           
         B     DR092X                                                           
                                                                                
DR092G   DS    0H                                                               
         MVC   PFLSAVE,RE@PF10S                                                 
         OI    DPLYFLG1,DF1PFSAV                                                
DR092X   EQU   *                                                                
*                                                                               
         CLI   CALLSP,0                                                         
         BE    DR098                                                            
         MVC   PFLPF12,RE@PF12N                                                 
         CLI   MYCALLER,SCINVLST   CAME FROM LIST SCREEN?                       
         BE    DR098               YES - PF 12=NEXT                             
         CLI   MYCALLER,SCINVDLS   CAME FROM DLIST SCREEN?                      
         BE    DR098               YES - PF 12=NEXT                             
         CLI   ITSHNSEL,1                                                       
         BH    DR098                                                            
         MVC   PFLPF12,RE@PF12R                                                 
DR098    EQU   *                                                                
         DROP  R3                                                               
                                                                                
*                                                                               
DR100    DS    0H                                                               
*                                                                               
DRX      DS    0H                                                               
         CLI   OURWRNCD,0          DO I WANT TO DISPLAY AN WARN MSG?            
         BNE   OURWARN              YES, GO DO IT                               
         CLI   OURINFCD,0          DO I WANT TO DISPLAY AN INFO MSG?            
         BNE   OURINFO              YES, GO DO IT                               
                                                                                
         TM    RECDFLG1,RF1DEL     RECORD MARKED FOR DELETION                   
         BZ    *+24                                                             
         MVI   OURINFCD,RDELQ                                                   
         CLI   ACTNUM,ANTKREST     ACTN=TKRESTOR                                
         BNE   *+8                                                              
         MVI   OURINFCD,NTRRSTQ                                                 
         B     OURINFO                                                          
                                                                                
         CLI   ACTNUM,ANTKDELE     ACTN=TKDELETE                                
         BNE   *+12                                                             
         MVI   OURINFCD,NTRDELQ                                                 
         B     OURINFO                                                          
                                                                                
         DS    0H                  POSITION CURSOR                              
         L     R2,A1SELFLD          TRY THE 1ST SEL FIRST                       
         TM    1(R2),X20                                                        
         BZ    DRX_15                                                           
         LA    R2,IROIPDCH          TRY DEMO CATEGORY NEXT                      
         TM    1(R2),X20                                                        
         BZ    DRX_15                                                           
         L     R2,AFRSTKEY          USE 1ST KEY FIELD AS LAST RESORT            
DRX_15   EQU   *                                                                
         ST    R2,ACURFORC                                                      
                                                                                
         OI    DIDTHIS,DIDDRX      TRACE--EXITING DISPLAY RECD ROUTINE          
         MVI   GOSUBN,STI#         SAVE OFF STUFF IN TIA                        
         GOTO1 AGOSUB                                                           
                                                                                
         B     XIT                                                              
         EJECT                                                                  
*============================ DO PFKEY TASKS =========================*         
DOPFKEY  NTR1                                                                   
         CLI   SNLDSPLY,0          IF NOTHING TO LIST,                          
         BE    DPKYXX               JUST TAKE A CLEAN EXIT                      
                                                                                
         CLI   PFKEY,5                                                          
         BE    PF05                                                             
         CLI   PFKEY,6                                                          
         BE    PF06                                                             
         CLI   PFKEY,7                                                          
         BE    PF07                                                             
         CLI   PFKEY,8                                                          
         BE    PF08                                                             
         CLI   PFKEY,PFQSAVE                                                    
         BE    PF10                                                             
         MVI   PFKEY,0                                                          
         B     DPKYXX                                                           
*                                                                               
** TOP **                                                                       
*                                                                               
PF05     DS    0H                                                               
         CLI   SNLDSPLY,1          IF AT TOP ALREADY,                           
         BNE   *+12                                                             
         MVI   OURWRNCD,WTOPQ       GIVE WARNING MESSAGE                        
         B     NO                                                               
                                                                                
         LA    RF,1                                                             
         B     DPKYX                                                            
*                                                                               
** BOTTOM **                                                                    
*                                                                               
PF06     DS    0H                                                               
         CLC   ENLDSPLY,NLTNTRY    IF AT BOTTOM ALREADY,                        
         BNE   *+12                                                             
         MVI   OURWRNCD,WBOTQ       IF SO, DISPLAY WARNING MSG                  
         B     NO                                                               
                                                                                
         ZIC   RF,NLTNTRY          ELSE, SET 1ST ENTRY                          
*&&DO                                                                           
         LA    RE,MXLSTLNS                                                      
         CLI   NLTNTRY,MXLSTLNS                                                 
*&&                                                                             
         ZIC   RE,NLSTLNS                                                       
         CLC   NLTNTRY,NLSTLNS                                                  
         BH    *+6                                                              
         LR    RE,RF                                                            
         SR    RF,RE                                                            
         LA    RF,1(RF)             TO BE DISPLAYED ON LIST                     
         B     DPKYX                                                            
*                                                                               
** SCROLL UP **                                                                 
*                                                                               
PF07     DS    0H                                                               
         CLI   SNLDSPLY,1          AT TOP ALREADY?                              
         BH    *+12                                                             
         MVI   OURWRNCD,WTOPQ       YES, DISPLAY "WARNING" MSG                  
         B     NO                                                               
                                                                                
         ZIC   RF,SNLDSPLY                                                      
         BCTR  RF,0                                                             
         B     DPKYX                                                            
*                                                                               
** SCROLL DOWN **                                                               
*                                                                               
PF08     DS    0H                                                               
         CLC   SNLDSPLY,NLTNTRY    AT BOTTOM ALREADY?                           
         BL    *+12                                                             
         MVI   OURWRNCD,WBOTQ       YES, DISPLAY "WARNING" MSG                  
         B     NO                                                               
                                                                                
         ZIC   RF,SNLDSPLY                                                      
         LA    RF,1(RF)                                                         
         B     DPKYX                                                            
*                                                                               
** SAVE INVENTORY TRACK **                                                      
*                                                                               
PF10     DS    0H                                                               
         MVI   OURINFCD,RECSVQ     DISPLAY "RECORD SAVED" MSG                   
         ZIC   RF,SNLDSPLY                                                      
         B     DPKYX                                                            
*                                                                               
DPKYX    DS    0H                  PFKEY WAS GOOD, RF = START NTRY #            
         STC   RF,SNLDSPLY                                                      
DPKYXX   DS    0H                                                               
         B     YES                                                              
***********************************************************************         
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (MISCELLANEOUS)'           
***********************************************************************         
*===================== SUBROUTINE POOL INTERFACE =====================*         
                                                                                
         DS    0H                                                               
GOSUB    NTR1  BASE=MYBASE1,LABEL=N                                             
         L     R9,MYBASE2                                                       
         L     R7,MYBASE3                                                       
                                                                                
         L     RE,4(RD)            PUT EYECATCHER IN MYSELF                     
         MVC   0(3,RE),=C'+GO'                                                  
         MVC   3(1,RE),GOSUBN                                                   
         SR    RE,RE                AND CLEAR  RE  JUST TO BE SAFE              
                                                                                
*                                                                               
         DS    0H                  PUSH ROUTINE # INTO STACK                    
         CLI   GOSUBN,ILT#          KEEP THIS ONE                               
         BE    GOSUB15K                                                         
         CLI   GOSUBN,RLT#          KEEP THIS ONE                               
         BE    GOSUB15K                                                         
         CLI   GOSUBN,BLT#          KEEP THIS ONE                               
         BE    GOSUB15K                                                         
         CLI   GOSUBN,TSL#          KEEP THIS ONE                               
         BE    GOSUB15K                                                         
         CLI   GOSUBN,PSL#          KEEP THIS ONE                               
         BE    GOSUB15K                                                         
         CLI   GOSUBN,SPRV#         KEEP THIS ONE                               
         BE    GOSUB15K                                                         
         CLI   GOSUBN,RPRV#         KEEP THIS ONE                               
         BE    GOSUB15K                                                         
         CLI   GOSUBN,STI#          KEEP THIS ONE                               
         BE    GOSUB15K                                                         
         CLI   GOSUBN,RTI#          KEEP THIS ONE                               
         BE    GOSUB15K                                                         
         CLI   GOSUBN,CSA#          KEEP THIS ONE                               
         BE    GOSUB15K                                                         
         B     GOSUB15X             ALL OTHERS, KEEP OFF STACK FOR NOW          
*                                                                               
GOSUB15K DS    0H                                                               
         ZIC   R1,GOSTACK+0         R1 = N'ENTRIES IN STACK                     
         CHI   R1,MXGSTACK           CAN WE FIT ANYMORE?                        
         BL    *+12                                                             
         MVI   GOSTACK+0,XFF          NO, INDICATE OVERFLOW                     
         B     GOSUB15X                                                         
                                                                                
         LA    RF,GOSTACK+1(R1)     RF-->NEXT AVAILABLE SLOT                    
         MVC   0(1,RF),GOSUBN                                                   
         AHI   R1,1                                                             
         STC   R1,GOSTACK+0         UPDATE N'ENTRIES                            
GOSUB15X EQU   *                                                                
                                                                                
*                                                                               
         DS    0H                                                               
         L     RE,=A(SUBRTNTB-RMP18)                                            
         LA    RE,RMP18(RE)                                                     
                                                                                
GOSUB22  DS    0H                                                               
         CLI   0(RE),EOT                                                        
         BNE   *+6                                                              
         DC    H'0'                                                             
         CLC   GOSUBN,0(RE)                                                     
         BNH   *+12                                                             
         LA    RE,L'SUBRTNTB(RE)                                                
         B     GOSUB22                                                          
*                                                                               
         ZICM  RF,1(RE),(3)                                                     
         A     RF,MYBASE1                                                       
                                                                                
*                                                                               
GOSUBGO  DS    0H                                                               
         L     R7,ASPOOLD                                                       
         GOTO1 (RF),(RC)                                                        
*                                                                               
         DS    0H                                                               
         XIT1                                                                   
***********************************************************************         
         EJECT                                                                  
***********************************************************************         
*============================ GETEL MACRO  ===========================*         
                                                                                
         PRINT GEN                                                              
         GETEL R3,DATADISP,ELCODE                                               
         PRINT NOGEN                                                            
                                                                                
***********************************************************************         
         EJECT                                                                  
***********************************************************************         
*======================== MISCELLANEOUS STUFF ========================*         
                                                                                
*----------------- EXIT AND DISPLAY MESSAGE ROUTINES -----------------*         
                                                                                
OURERROR DS    0H                                                               
         MVI   BYTE,C'E'                                                        
         B     XMSGGO                                                           
                                                                                
OURWARN  DS    0H                                                               
         MVI   BYTE,C'W'                                                        
         B     XMSGGO                                                           
                                                                                
OURINFO  DS    0H                                                               
         MVI   BYTE,C'I'                                                        
         B     XMSGGO                                                           
                                                                                
XMSGGO   DS    0H                                                               
         GOTO1 AXMSGRTN,DMCB,(BYTE,(RC))                                        
         B     XIT                                                              
                                                                                
                                                                                
***********************************************************************         
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (LTORG && CONSTANT+        
               S)'                                                              
***********************************************************************         
*========================= LTORG & CONSTANTS =========================*         
         LTORG                                                                  
                                                                                
                                                                                
MYSPACES DC    CL(L'SPACES)' '                                                  
*                                                                               
DEMLSTDC DC    X'00D90000E20000D700FF'   DEMO LIST W/ DELIMITER                 
*                                                                               
MONTAB   DC    C'NFMAYJO'                                                       
MONTABL  EQU   *-MONTAB                                                         
                                                                                
                                                                                
MAINL    EQU   *-RMP18                                                          
         DS    0CL(X'3000'-MAINL+1)                                             
***********************************************************************         
                                                                                
                                                                                
         DROP  R7,R8,R9,RA,RB,RC                                                
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR01)'                  
***********************************************************************         
*======================== SUBROUTINE POOL ONE ========================*         
                                                                                
* At entry,                                                                     
*   RA-->TWA,                                                                   
*   R8-->SYSD,                                                                  
*   R7-->SPOOLD,                                                                
*   R1-->GEND,                                                                  
*   GOSUBN = equated sub-routine number.                                        
                                                                                
         ORG   RMP18+X'2000'                                                    
         ORG                                                                    
SUBR01Q  EQU   (((*-RMP18+X'0FFF')/X'1000')*X'1000')                            
                                                                                
         ORG   RMP18+SUBR01Q                                                    
SUBR01   NMOD1 0,**1801**                                                       
         LR    RC,R1                                                            
         USING GEND,RC             RC=A(GENCON WORK AREA)                       
         USING CONHEADH-64,RA      RA=A(TWA)                                    
         USING SYSD,R8             R8=A(SYSD)                                   
         USING SPOOLD,R7           R7=A(SPOOL WORK AREA)                        
                                                                                
         ZIC   R1,GOSUBN                                                        
         BCTR  R1,0                                                             
         SLL   R1,2                                                             
         B     R01_00(R1)                                                       
                                                                                
ILT#     EQU   (R01_01-*)/4+1      INITIALIZE LIST TABLE                        
RLT#     EQU   (R01_02-*)/4+1      REFRESH LIST TABLE                           
BLT#     EQU   (R01_03-*)/4+1      BUILD LIST TABLE                             
PLT#     EQU   (R01_04-*)/4+1      PUT ENTRY INTO LIST TABLE                    
                                                                                
R01_00   DS    0H                                                               
R01_01   B     INITLSTB            INITIALIZE LIST TABLE                        
R01_02   B     RFRSHLTB            REFRESH LIST TABLE                           
R01_03   B     BLDLSTAB            BUILD LIST TABLE                             
R01_04   B     PUTLSTAB            PUT AN ENTRY INTO LIST TABLE                 
R01#     EQU   (*-R01_00)/4                                                     
         DC    H'0'                                                             
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR01--ILT#)'            
*----------------------- INITIALIZE LIST TABLE -----------------------*         
                                                                                
* Initializes LISTTAB w/ information found in inventory record.  If             
*  demo history elements (RIDHEL) exist, then LISTTAB is initialized            
*  with all such elements found.  Otherwise, LISTTAB will be created            
*  using the from data of the inventory record.                                 
* At entry,                                                                     
*   AIO = A(inventory record)                                                   
                                                                                
INITLSTB DS    0H                                                               
         MVI   NLTNTRY,0           NO LIST TABLE ENTRIES YET                    
         NI    SELFLAG1,XFF-SF1AL1ES-SF1AL1ESXD NO SELECTIONS YET               
         MVI   TRKCUME,0           ASSUME DEMOS WERE NOT TOTALLED               
                                                                                
         DS    0H                  CLEAR LIST PARAMETERS AREA                   
         XC    LISTPARM(LISTPRML),LISTPARM                                      
*                                                                               
         MVC   LPDEMC,FDDEMC       SET DEMO CATEGORY INTO LIST PARMS            
                                                                                
*                                                                               
         TM    RECDFLG1,RF1DNXST   IF RECD DOES NOT EXIST,                      
         BO    ILTX                 EXIT NOW                                    
                                                                                
*                                                                               
         L     R6,AIO                                                           
         MVC   DATADISP,DSP1EL                                                  
         EJECT                                                                  
         LR    R3,R6                                                            
         MVI   ELCODE,RIDHCDQ                                                   
         MVI   TYPELP,TLPHIST                                                   
         BRAS  RE,GETEL                                                         
         BNE   ILT100              NO HISTORY FOUND--USE FROM DATA              
*                                                                               
** INIT TABLE W/ DEMO HISTORY **                                                
*                                                                               
         DS    0H                  R3-->FIRST RIDHEL ELEMENT                    
         USING RIDHEL,R3                                                        
         TM    RIDHFLG,RIDHFTOT                                                 
         BZ    *+8                                                              
         MVI   TRKCUME,C'T'         "CUME=TOTAL" WAS IN EFFECT                  
         DROP  R3                                                               
                                                                                
*                                                                               
ILT020   DS    0H                  R3-->RIDHEL ELEMENT                          
         XC    LISTPARM(LISTPRML),LISTPARM                                      
                                                                                
         USING RIDHEL,R3                                                        
         MVC   LPFILE,RIDHFIL       FILE                                        
         MVC   LPSRC,RIDHSRC        SOURCE                                      
         MVC   LPSTTN,RIDHSTTN      STATION                                     
         MVC   LPFRBTS,RIDHFRBT     FROM BOOK BITS                              
         MVC   LPBOOK,RIDHBK        BOOK                                        
         MVC   LPBTYP,RIDHBTYP      BOOK TYPE                                   
         MVC   LPWTOV,RIDHWTOV      WEIGHT OVERRIDE                             
         MVI   LPTMCHG,0            TURN OFF TIME CHANGE FLAG                   
         MVC   LPDEMC,FDDEMC                                                    
*^^FIX--SPECIAL FIX TO "EXTRACT" FROM BITS (GLEE)                               
         MVC   WORK+8(5),=C'FEB97'                                              
         MVI   WORK+5,5                                                         
         MVI   WORK+0,13                                                        
         GOTO1 BOOKVAL,DMCB,(LPSRC,WORK),(1,DUB),SCANNER                        
         MVC   LPFRBTS,DUB                                                      
*^^EOFIX--SPECIAL FIX TO "EXTRACT" FROM BITS (GLEE)                             
                                                                                
         CLC   LPFILE,DCFILPAV                                                  
         BE    ILT030                                                           
         CLC   LPFILE,DCFILTP                                                   
         BE    ILT040                                                           
         CLC   LPFILE,DCFILIUN                                                  
         BE    ILT050                                                           
         DC    H'0'                                                             
                                                                                
                                                                                
ILT030   DS    0H                  PAV FILE                                     
         MVI   LPNOR,C'N'           ASSUME NOT A NORMAL PROGRAM                 
         TM    RIDHFLG,RIDHFNOR                                                 
         BZ    *+8                                                              
         MVI   LPNOR,C'Y'           IT'S A NOR PROGRAMMING                      
                                                                                
         MVC   LPPURE,RIDHPURE      USE PURE # TO GET BACK THE PROGRAM          
         TM    RIDHFLG,RIDHFPUR     IF PROGRAM REQUESTED VIA PURE #,            
         BZ    *+8                                                              
         OI    LPFLAG,LPFPURE        FLAG IT AS SUCH                            
                                                                                
         MVI   LPBEST,0                                                         
*                                                                               
         B     ILT080                                                           
                                                                                
                                                                                
ILT040   DS    0H                  TP  FILE                                     
         MVC   LPIDAY,RIDHIDY       USE DAYS                                    
         MVC   LPTIME,RIDHSETM       AND TIMES                                  
         MVC   LPWKN,RIDHWK          AND WEEK NUMBER                            
*                                                                               
         MVI   LPTPTT,C'T'          ASSUME TYPICAL TIME                         
         TM    RIDHFLG,RIDHFTP4                                                 
         BZ    *+8                                                              
         MVI   LPTPTT,C'P'          USE 4-WEEK AVERAGE INSTEAD                  
*                                                                               
         B     ILT080                                                           
                                                                                
                                                                                
ILT050   DS    0H                  INV FILE                                     
         MVC   LPINVN,RIDHINVN      INVENTORY NUMBER                            
         MVC   LPEFFDT,RIDHEFFD     EFFECTIVE DATE                              
*                                                                               
         B     ILT080                                                           
         DROP  R3                                                               
                                                                                
                                                                                
ILT080   DS    0H                                                               
         MVI   GOSUBN,PLT#                                                      
         GOTO1 AGOSUB                                                           
                                                                                
         MVI   ELCODE,RIDHCDQ      RESET ELEMENT CODE                           
         BRAS  RE,NEXTEL                                                        
         BE    ILT020                                                           
                                                                                
         B     ILT500              NO MORE HISTORY ELEMENTS TO PUT              
         EJECT                                                                  
*                                                                               
** CREATE TABLE W/ FROM DATA **                                                 
*                                                                               
ILT100   DS    0H                                                               
         L     R2,AINVLIST                                                      
         CLI   0(R2),EOT                                                        
         BE    ILT400                                                           
                                                                                
         DS    0H                                                               
         MVC   LPSRC,IKSRC         SET SOURCE TO INPUTTED SRC                   
         MVC   LPFRBK,FDFRBK                                                    
         MVC   LPSTTN,FDSTTN                                                    
         MVC   LPBTYP,FDBTYP                                                    
         MVI   LPWKN,0                                                          
         MVC   LPTMCHG,HDRTMCHG     TIME CHANGE FLAG                            
         MVC   LPDEMC,FDDEMC                                                    
*                                                                               
ILT140   DS    0H                                                               
         MVI   LPIDAY,0                                                         
         XC    LPTIME,LPTIME                                                    
         XC    LPPURE,LPPURE                                                    
         XC    LPINVN,LPINVN                                                    
         XC    LPEFFDT,LPEFFDT                                                  
         MVI   LPWTOV,0                                                         
                                                                                
         CLI   FDFTYP,C'P'         TAPE TRANSFER                                
         BE    ILT150                                                           
         CLI   FDFTYP,C'I'         INVENTORY FILE TRANSFER                      
         BE    ILT200                                                           
         DC    H'0'                                                             
*                                                                               
*** TAPE TRANSFER ***                                                           
*                                                                               
         USING INVLD,R2                                                         
ILT150   DS    0H                                                               
         TM    ILTYP,ILTADD        DO WE ADD COMBOS?                            
         BZ    ILT160                                                           
         OI    DEMFLAG1,DF1ADCMB    YES, SET FLAG TO DO SO                      
*                                                                               
ILT160   DS    0H                                                               
         TM    ILTYP,ILTIVN        IS IT AN INVENTORY NUMBER?                   
         BO    ILT165                                                           
                                                                                
         DS    0H                   SET DAY/TIME IN LIST PARMS                  
         MVC   LPIDAY,ILDAY                                                     
         MVC   LPTIME,ILSTIM                                                    
         B     ILT170                                                           
                                                                                
ILT165   DS    0H                   SET PURE NUMBER VALUE                       
         MVC   LPPURE,ILNUMB         (1ST TWO BYTES OF ILNUMB)                  
         OI    LPFLAG,LPFPURE                                                   
         B     ILT170                                                           
*                                                                               
ILT170   DS    0H                  SET FILE (FOR DBFILE)                        
         TM    CODECTL,CDMIXPT                                                  
         BO    ILT174                                                           
         TM    CODECTL,CDPAV                                                    
         BO    ILT176                                                           
         TM    CODECTL,CDTP                                                     
         BO    ILT178                                                           
         DC    H'0'                                                             
                                                                                
ILT174   DS    0H                   MIXING PAV & TP FILES                       
         TM    ILTYP,ILTIVN          IF THIS ENTRY HAS PURE NUMBER,             
         BO    ILT176                 GO FOR PAV                                
         B     ILT178                 ELSE, USE TP                              
                                                                                
ILT176   DS    0H                   SET FOR PAV INFO                            
         MVC   LPFILE,DCFILPAV                                                  
         MVI   LPBEST,0                                                         
         B     ILT179                                                           
                                                                                
ILT178   DS    0H                   SET FOR TIME PERIOD INFO                    
         MVC   LPFILE,DCFILTP                                                   
         MVC   LPTPTT,FDTPTT                                                    
         B     ILT179                                                           
                                                                                
ILT179   EQU   *                                                                
*                                                                               
         TM    ILTYP,ILTWOV         IF THERE IS A WEIGHT OVERRIDE,              
         BZ    *+10                                                             
         MVC   LPWTOV,ILWT           USE IT                                     
*                                                                               
         B     ILT250                                                           
                                                                                
*                                                                               
*** INVENTORY FILE TRANSFER ***                                                 
*                                                                               
ILT200   DS    0H                                                               
         TM    ILTYP,ILTADD        DO WE ADD COMBOS?                            
         BZ    *+8                                                              
         OI    DEMFLAG1,DF1ADCMB    YES, SET FLAG TO DO SO                      
*                                                                               
*^^GLEE - This Test-under-Mask was commented out because it provides            
*^^GLEE -  a flaw in the logic.  We better have an inventory number             
*^^GLEE -  if we are to look up the inventory file.                             
*&&DO                                                                           
         TM    ILTYP,ILTIVN        IS ENTRY AN INVENTORY NUMBER ENTRY?          
         BZ    ILT220               NO, SKIP IT                                 
                                                                                
*&&                                                                             
         MVC   LPFILE,DCFILIUN     DEMO FILE                                    
         MVC   LPINVN,ILNUMB       INVENTORY NUMBER                             
                                                                                
         DS    0H                  EFFECTIVE DATE                               
         GOTO1 DATCON,DMCB,(3,ILDATE),(2,WORK),0                                
         MVC   LPEFFDT,WORK                                                     
*                                                                               
ILT220   DS    0H                                                               
         TM    ILTYP,ILTWOV         IF THERE IS A WEIGHT OVERRIDE,              
         BZ    *+10                                                             
         MVC   LPWTOV,ILWT           USE IT                                     
*                                                                               
         B     ILT250                                                           
                                                                                
                                                                                
                                                                                
ILT250   DS    0H                  LIST PARAMETERS ALL SET                      
         MVI   TYPELP,TLPXFER                                                   
         MVI   GOSUBN,PLT#                                                      
         GOTO1 AGOSUB                                                           
                                                                                
         CLI   INVLQ(R2),EOT       AT END OF INV LIST TABLE?                    
         BE    ILT300               YES, EXIT LOOP                              
         LA    R2,INVLQ(R2)                                                     
         B     ILT140                                                           
         DROP  R2                                                               
*                                                                               
ILT300   DS    0H                  FINISHED PUTTING INTO LISTTAB                
         B     ILT500                                                           
         EJECT                                                                  
*                                                                               
** CREATE TABLE W/ INVENTORY HEADER DEFINITION **                               
*                                                                               
ILT400   DS    0H                                                               
         MVC   LPSRC,IKSRC         SET SOURCE TO INPUTTED SOURCE                
                                                                                
         DS    0H                  SET LIST PARAMETERS W/ FROM DATA             
         MVC   LPFILE,FDFILE        DEMO FILE                                   
         MVC   LPFRBK,FDFRBK        FROM BOOK (INCLUDING BITS)                  
         MVC   LPSTTN,FDSTTN        STATION                                     
         CLI   LPSTTN+4,C'H'        IF NHTI STATION,                            
         BNE   *+8                                                              
         MVI   LPSRC,C'H'            THEN FORCE SOURCE TO NHT                   
         MVC   LPBTYP,FDBTYP        BOOK TYPE                                   
         MVI   LPWKN,0                                                          
         MVC   LPTPTT,FDTPTT        TYPICAL/4WK-AVG (IF TIME PERIOD)            
         MVC   LPTMCHG,HDRTMCHG     TIME CHANGE FLAG                            
         MVC   LPDEMC,FDDEMC        DEMO CATEGORY                               
                                                                                
         CLI   FDFTYP,C'P'                                                      
         BE    ILT420                                                           
         CLI   FDFTYP,C'I'                                                      
         BE    ILT460                                                           
                                                                                
ILT420   DS    0H                  LIST PARMS FOR TAPE TRANSFER                 
         LR    R3,R6                                                            
         MVI   ELCODE,X'CE'                                                     
         BRAS  RE,GETEL                                                         
         BNE   ILT550                                                           
                                                                                
ILT422   DS    0H                  R3-->RINVZEL ELEMENT                         
         USING RINVZEL,R3                                                       
         MVC   LPIDAY,RINVZDAY      (INTERNAL) DAY                              
         MVC   LPTIME,RINVZTIM      START/END TIMES                             
         DROP  R3                                                               
*                                                                               
         TM    CODECTL,CDMIXPT     IF NOT MIXED PAV & TP FILES                  
         BNO   ILT440               THEN GO PUT ENTRIES NOW                     
                                                                                
ILT432   DS    0H                  PUT PAV & TP ENTRIES INTO LIST TABLE         
         BAS   RE,SETPTFIL          GO SET FILE                                 
         BE    ILT440                CC EQU ==> GO PUT ENTRIES                  
         MVC   LPFILE,FDFILE         CC NEQ ==> RESET FILE VALUES               
         MVC   LPTPTT,FDTPTT                                                    
         B     ILT445                 AND MOVE ON W/ NEXT PARAMETERS            
*                                                                               
ILT440   DS    0H                                                               
         MVI   TYPELP,TLPIDEF                                                   
         MVI   GOSUBN,PLT#                                                      
         GOTO1 AGOSUB                                                           
                                                                                
         TM    CODECTL,CDMIXPT     IF MIXED PAV & TP FILES                      
         BO    ILT432               THEN DON'T MOVE ON YET                      
                                                                                
ILT445   DS    0H                                                               
         BRAS  RE,NEXTEL                                                        
         BE    ILT422                                                           
         B     ILT480                                                           
*                                                                               
ILT460   DS    0H                  LIST PARMS FOR INVENTORY TRANSFER            
         MVC   LPINVN,IKINV                                                     
         MVC   LPEFFDT,IKEFFDC                                                  
                                                                                
         MVI   TYPELP,TLPIDEF                                                   
         MVI   GOSUBN,PLT#                                                      
         GOTO1 AGOSUB                                                           
         B     ILT480                                                           
*                                                                               
ILT480   DS    0H                  FINISHED PUTTING INTO LISTTAB                
         B     ILT500                                                           
         EJECT                                                                  
*                                                                               
** FINISHED PUTTING INTO LISTTAB **                                             
*                                                                               
ILT500   DS    0H                                                               
         MVI   GOSUBN,SDV#          SEED DEMO VALUES INTO TABLE                 
         GOTO1 AGOSUB                                                           
                                                                                
         MVI   GOSUBN,BLD#          BUILD LIST DIRECTORY                        
         GOTO1 (RF)                                                             
*                                                                               
ILT550   DS    0H                                                               
         MVI   HOWLT,HLTINIT        REMEMBER THAT LISTTAB WAS IN'LIZED          
*                                                                               
ILTX     DS    0H                                                               
         J     XIT                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR01--RLT#)'            
*------------------------- REFRESH LIST TABLE ------------------------*         
                                                                                
RFRSHLTB DS    0H                                                               
         SR    R1,R1               COUNTS # OF ENTRIES SELECTED                 
         L     RE,ALISTTAB                                                      
         USING LISTTABD,RE                                                      
                                                                                
RLT10    DS    0H                  FIND THE 1ST NON-SELECTED ENTRY              
         CLI   0(RE),EOT                                                        
         BE    RLT30                                                            
         TM    LTFLAG,LTFALLSEL                                                 
         BZ    RLT20                                                            
         LA    RE,LISTTABQ(RE)                                                  
         LA    R1,1(R1)            UPDATE COUNT OF SELECTED ENTRIES             
         B     RLT10                                                            
         DROP  RE                                                               
*                                                                               
RLT20    DS    0H                                                               
         LA    RF,LISTTABQ(RE)                                                  
         USING LISTTABD,RF                                                      
                                                                                
RLT22    DS    0H                                                               
         CLI   0(RF),EOT                                                        
         BE    RLT30                                                            
         TM    LTFLAG,LTFALLSEL    IF ENTRY WAS SELECTED,                       
         BZ    RLT24                                                            
         MVC   0(LISTTABQ,RE),0(RF)  MOVE IT UP TO NEXT AVAILABLE SLOT,         
         LA    R1,1(R1)                                                         
         STC   R1,(LTNTRY-LISTTABD)(RE)  ASSIGN A NEW ENTRY #                   
         LA    RE,LISTTABQ(RE)                                                  
                                                                                
RLT24    DS    0H                  BUMP PAST NON-SELECTED ENTRY                 
         LA    RF,LISTTABQ(RF)                                                  
         B     RLT22                                                            
*                                                                               
RLT30    DS    0H                  REACHED LAST ENTRY                           
         ST    RE,ANLTNTRY          STORE A(NEXT AVAILABLE SLOT)                
         LA    RF,MXLTNTRY          MAX # OF ENTRIES IN TABLE,                  
         STC   R1,NLTNTRY            LESS # OF ENTRIES IN TABLE,                
         SR    RF,R1                 YIELDS # OF SLOTS LEFT                     
         BZ    RLTX                                                             
         BP    *+6                                                              
         DC    H'0'                                                             
         MH    RF,=Y(LISTTABQ)                                                  
         SR    R0,R0                                                            
         SR    R1,R1                                                            
         MVCL  RE,R0                CLEAR REMAINING PORTION OF TABLE            
         DROP  RF                                                               
*                                                                               
RLTX     DS    0H                                                               
         J     XIT                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR01--BLT#)'            
*-------------------------- BUILD LIST TABLE -------------------------*         
                                                                                
* Rebuilds LISTTAB (leaving selected entries intact) given a set of             
*  input parameters (fields prefixed w/ 'IP').  The only fields which           
*  might not be set are the days and times, in which case we go back            
*  to the inventory record for them.                                            
* At entry,                                                                     
*  AIO = A(inventory record).                                                   
                                                                                
BLDLSTAB DS    0H                                                               
         XC    LISTPARM(LISTPRML),LISTPARM                                      
         MVI   TYPELP,TLPUINP                                                   
*                                                                               
         DS    0H                  SET LIST PARAMETERS                          
         MVC   LPSRC,IPSRC          SOURCE CODE                                 
         MVC   LPFILE,IPFILE        FILE                                        
         MVC   LPTPTT,IPTPTT        ALL WEEK/TYPICAL (TP ONLY)                  
         MVC   LPSTTN,IPSTTN        STATION                                     
         MVC   LPFRBK,IPFRBK        BITS & BOOKS                                
         MVC   LPBTYP,IPBTYP        BOOK TYPE                                   
         MVC   LPIDAY,IPIDAY        DAY                                         
         MVC   LPTIME,IPTIME        TIMES                                       
         MVC   LPWKN,IPWKN          WEEK NUMBER                                 
         MVC   LPTMCHG,HDRTMCHG     TIME CHANGE FLAG                            
         CLC   LPFILE,DCFILPAV                                                  
         BNE   *+8                                                              
         MVI   LPBEST,C'A'                                                      
         OC    IPPURE,IPPURE                                                    
         BZ    *+14                                                             
         OI    LPFLAG,LPFPURE                                                   
         MVC   LPPURE,IPPURE        PURE NUMBER                                 
         MVC   LPINVN,IPINVN        INVENTORY NUMBER                            
         MVC   LPEFFDT,IPEFFD       EFFECTIVE DATE                              
*                                                                               
         OC    IPPURE,IPPURE       IF THERE IS A PURE NUMBER                    
         BNZ   BLT015                                                           
         OC    IPINVN,IPINVN        OR AN INVENTORY NUMBER,                     
         BNZ   BLT015               DON'T WORRY IF DAY/TIME SET OR NOT          
                                                                                
         OC    IPIDAY,IPIDAY       DAY SET?                                     
         BZ    BLT030               NO                                          
         OC    IPTIME,IPTIME       TIME SET?                                    
         BZ    BLT030               NO                                          
                                                                                
BLT015   EQU   *                                                                
*                                                                               
         DS    0H                  BUILD DUMMY RINVZEL ELEMENT                  
         XC    DUMRINVZ,DUMRINVZ                                                
         LA    R3,DUMRINVZ                                                      
         USING RINVZEL,R3                                                       
         MVI   RINVZCOD,X'CE'                                                   
         MVI   RINVZLEN,10                                                      
         MVC   RINVZDAY,IPIDAY                                                  
         MVC   RINVZTIM,IPTIME                                                  
         MVI   RINVZEL+10,0                                                     
         DROP  R3                                                               
                                                                                
         B     BLT050                                                           
*                                                                               
BLT030   DS    0H                  USE DAY AND/OR TIME FROM INV RECD            
         L     R3,AIO                                                           
         MVI   ELCODE,X'CE'                                                     
         MVC   DATADISP,DSP1EL                                                  
         BRAS  RE,GETEL                                                         
         BNE   BLT100                                                           
*                                                                               
BLT050   DS    0H                  R3-->RINVZEL ELEMENT                         
         USING RINVZEL,R3                                                       
         OC    IPIDAY,IPIDAY       IF DAY WAS NOT SET,                          
         BNZ   *+10                                                             
         MVC   LPIDAY,RINVZDAY      SET DAY LIST PARAMETER                      
         OC    IPTIME,IPTIME       IF TIME WAS NOT SET,                         
         BNZ   *+10                                                             
         MVC   LPTIME,RINVZTIM      SET TIME LIST PARAMETER                     
         DROP  R3                                                               
*                                                                               
         OC    LPFILE,LPFILE       IF FILE IS SET ALREADY,                      
         BNZ   BLT080               GO PUT ENTRIES INTO LIST TABLE              
         TM    CODECTL,CDMIXPT     IF NOT MIXED PAV & TP FILES,                 
         BNO   BLT090               THEN DON'T GO PUT ENTRIES                   
                                                                                
BLT060   DS    0H                  PUT PAV & TP ENTRIES INTO LIST TABLE         
         BAS   RE,SETPTFIL          GO SET FILE                                 
         BE    BLT080                CC EQU ==> GO PUT ENTRIES                  
         MVC   LPFILE,IPFILE         CC NEQ ==> RESET FILE VALUES               
         MVC   LPTPTT,IPTPTT                                                    
         B     BLT090                 AND MOVE ON W/ NEXT PARAMETERS            
*                                                                               
BLT080   DS    0H                                                               
         MVI   GOSUBN,PLT#         PUT ENTRIES INTO LIST TABLE                  
         GOTO1 AGOSUB                                                           
                                                                                
         TM    CODECTL,CDMIXPT     IF NOT MIXED PAV & TP FILES,                 
         BNO   BLT090               GET NEXT PARAMETERS                         
         TM    INPMFLG1,IPF1FL     IF FILE WAS INPUTTED,                        
         BNZ   BLT090               GET NEXT PARAMTERS                          
         B     BLT060              ELSE, SET FILE AGAIN FOR SAME PARMS          
*                                                                               
BLT090   DS    0H                                                               
         BRAS  RE,NEXTEL                                                        
         BE    BLT050                                                           
                                                                                
*                                                                               
BLT100   DS    0H                  FINISHED PUTTING INTO LISTTAB                
         MVI   HOWLT,HLTBUILT       REMEMBER THAT LIST TABLE WAS BUILT          
*                                                                               
BLTX     DS    0H                                                               
         J     XIT                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR01--PLT#)'            
*------------------------ PUT INTO LIST TABLE ------------------------*         
                                                                                
* Given the list parameters, this routine puts together a LISTTAB               
*  entry (by calling DEMAND), which will get enterred into the table.           
* At entry,                                                                     
*   ANLTNTRY = A(next available slot in LISTTAB),                               
*   NLTNTRY  = # of entries in LISTTAB so far,                                  
*   List Params (fields w/ prefix 'LP') are set                                 
                                                                                
PUTLSTAB DS    0H                                                               
*                                                                               
** SET UP DBLOCK **                                                             
*                                                                               
         MVC   TMPDFIL,LPFILE                                                   
         MVC   TMPBTYP,LPBTYP                                                   
         MVC   TMPFRBTS,LPFRBTS                                                 
         MVC   TMPBOOK,LPBOOK                                                   
         MVC   TMPSTTN,LPSTTN                                                   
         MVC   TMPWKN,LPWKN                                                     
         MVC   TMPTMCHG,LPTMCHG                                                 
         MVI   TMPPGDUR,C'Y'                                                    
         MVC   TMPSRC,LPSRC                                                     
                                                                                
         CLC   LPFILE,DCFILTP                                                   
         BE    PLT100                                                           
         CLC   LPFILE,DCFILPAV                                                  
         BE    PLT150                                                           
         CLC   LPFILE,DCFILIUN                                                  
         BE    PLT200                                                           
         DC    H'0'                                                             
                                                                                
                                                                                
                                                                                
PLT100   DS    0H                  TIME PERIOD SPECIFIC PARAMETERS              
         MVC   TMPIDAY,LPIDAY                                                   
         MVC   TMPSETM,LPTIME                                                   
         CLI   LPTPTT,C'P'                                                      
         BNE   *+8                                                              
         OI    TMPFLAG2,LTF2T4                                                  
*                                                                               
         B     PLT250                                                           
                                                                                
                                                                                
                                                                                
PLT150   DS    0H                  PROGRAM AVG SPECIFIC PARAMETERS              
         MVC   TMPPURE(2),LPPURE                                                
         MVC   TMPIDAY,LPIDAY                                                   
         MVC   TMPSETM,LPTIME                                                   
         MVC   TMPBEST,LPBEST                                                   
*                                                                               
         CLI   TMPSTTN+4,C'H'      NHTI? M-F REQUEST? LK FOR M-F RECD           
         BNE   PLT250                                                           
*        CLI   TMPIDAY,X'7C'                                                    
*        BE    *+12                                                             
*        CLI   TMPIDAY,X'7F'                                                    
*        BNE   *+8                                                              
         MVI   TMPBEST,C'L'        ALWAYS SET TO 'L' = EXACT MATCH              
         B     PLT250                                                           
                                                                                
PLT200   DS    0H                  INVENTORY FILE SPECIFIC PARAMETERS           
         MVC   TMPINVN,LPINVN       INVENTORY NUMBER                            
         MVC   TMPCDATE,LPEFFDT     EFFECTIVE DATE                              
*                                                                               
         B     PLT250                                                           
                                                                                
                                                                                
PLT250   DS    0H                  BUILD DBLOCK                                 
         MVI   GOSUBN,BDB#                                                      
         GOTO1 AGOSUB                                                           
*                                                                               
         ZAP   NDMDCALL,=P'0'      INITIALIZE # OF DEMAND CALLS                 
*                                                                               
         B     PLT300                                                           
         EJECT                                                                  
*                                                                               
** CALL DEMAND **                                                               
*                                                                               
PLT300   DS    0H                                                               
         L     R5,ADBLOCK                                                       
         USING DBLOCKD,R5                                                       
                                                                                
*                                                                               
PLT304   DS    0H                                                               
         MVI   POSTFLG1,PSTF1DTL    POST DETAIL LINE                            
         CLC   DBFILE,DCFILTP       IF FILE IS NOT TP,                          
         BNE   PLT309                ONLY POST DETAIL LINES                     
         MVC   TMPIDAY,DBSELDAY                                                 
         MVI   GOSUBN,CND#          COUNT # OF DAYS                             
         GOTO1 AGOSUB                                                           
         CLI   TMPNDAY,1            IF NOT MULTIPLE DAYS,                       
         BNH   PLT309                ONLY POST DETAIL LINES                     
         OI    POSTFLG1,PSTF1SUM     ELSE, POST SUMMARY LINE AS WELL            
         XC    SUMLT,SUMLT                                                      
         CLI   TYPELP,TLPHIST        AND IF THIS IS INV'S HISTORY,              
         BNE   PLT309                                                           
         NI    POSTFLG1,XFF-PSTF1DTL  DON'T POST DETAIL LINES                   
PLT309   EQU   *                                                                
         MVC   ONLTNTRY,ANLTNTRY                                                
         NI    DEMFLAG1,XFF-DF1RDOK  ASSUME DEMO-FILE READ NOT OK               
         AP    NDMDCALL,=P'1'        INCREMENT # OF DEMAND CALLS                
         XC    DMCB(6*4),DMCB                                                   
         GOTO1 DEMAND,DMCB,DBLOCKD,DEMHOOK                                      
         DROP  R5                                                               
                                                                                
         TM    DEMFLAG1,DF1RDOK    ANY "GOOD" DATA PASSED TO HOOK?              
         BZ    PLT400               NO, MAY NEED SPECIAL PROCESSING             
                                                                                
*                                                                               
         DS    0H                  "GOOD" DATA PASSED TO DEMAND HOOK            
         MVI   GOSUBN,LNS#                                                      
         GOTO1 AGOSUB                                                           
*                                                                               
         DS    0H                                                               
         TM    POSTFLG1,PSTF1SUM   IF SUMMARY LINE NEEDED,                      
         BZ    PLT319                                                           
         TM    DEMFLAG1,DF1RDOK     AND "GOOD" DATA PASSED TO DEMHOOK,          
         BZ    PLT319                                                           
         BAS   RE,PLTSUM            GO POST IT INTO LISTTAB                     
PLT319   EQU   *                                                                
*                                                                               
         B     PLTX                                                             
         EJECT                                                                  
*                                                                               
** SPECIAL PROCESSING FOR NON-OKAY DEMAND CALLS **                              
*                                                                               
PLT400   DS    0H                                                               
         CLC   LPFILE,DCFILPAV                                                  
         BE    PLT420                                                           
         B     PLTX                                                             
                                                                                
*                                                                               
PLT420   DS    0H                  PAV FILE                                     
         CP    NDMDCALL,=P'1'       IF DEMAND CALLED MORE THAN ONCE,            
         BH    PLTX                  ATTEMPT TO "RE-GET" DATA FAILED            
         TM    LPIDAY,X'90'         IF "VAR" OR "AVG-n" REQUESTED,              
         BO    PLTX                  DON'T ATTEMPT TO "RE-GET" DATA             
         L     R5,ADBLOCK                                                       
         USING DBLOCKD,R5                                                       
*        CLI   DBSELSTA+4,C'H'         RESET DBBEST FOR M-F IND DAYS            
*        BNE   *+12                                                             
*        MVI   DBBEST,C'A'                                                      
*        MVI   TMPBEST,C'A'                                                     
         DROP  R5                                                               
         MVC   TMPIDAY,LPIDAY                                                   
         MVI   GOSUBN,CND#                                                      
         GOTO1 AGOSUB                                                           
         CLI   TMPNDAY,1            SKIP IF NOT A ROTATION                      
         BNH   PLTX                                                             
                                                                                
         MVI   GOSUBN,SDTL#         BREAK OUT DAYS IN THE ROTATION              
         GOTO1 AGOSUB                                                           
         B     PLT300                                                           
                                                                                
                                                                                
PLTX     DS    0H                                                               
         J     XIT                                                              
         EJECT                                                                  
*                                                                               
** DEMAND HOOK **                                                               
*                                                                               
* At entry,                                                                     
*   ANLTNTRY = A(next available slot in LISTTAB),                               
*   NLTNTRY  = # of entries in LISTTAB so far,                                  
*   TYPELP   = type of list parms in DEMAND call,                               
*   R5-->DBLOCK.                                                                
                                                                                
DEMHOOK  DS    0H                                                               
DMHK     NTR1                                                                   
         XC    TMPS(TMPSL),TMPS                                                 
         USING DBLOCKD,R5                                                       
                                                                                
*                                                                               
** CHECK NON FILE-SPECIFIC DATA **                                              
*                                                                               
         DS    0H                  TEST FOR CORRECT WEEK                        
         MVC   WORK,SPACES                                                      
         GOTO1 DEFINE,MYDMCB,=C'WEEK',DBLOCK,WORK                               
         SR    R1,R1                                                            
         ICM   R1,1,DBSELWKN       R1 = WEEK REQUESTED                          
         BZ    *+22                 OK IF NONE REQUESTED                        
         LA    R1,WORK(R1)         R1-->ACTIVE WEEK                             
         NI    0(R1),X'0F'          (REMOVE ZONE)                               
         CLC   0(1,R1),DBSELWKN    MATCH WEEK TO CHECK FOR ACTIVE-NESS          
         BNE   DMHKNNO              EXIT HOOK IF WEEK WASN'T ACTIVE             
                                                                                
         B     DMHK005                                                          
*                                                                               
DMHKNNO  DS    0H                                                               
         ZICM  RF,DBDIVSOR,(3)                                                  
         ZICM  RE,DBFACTOR,(3)                                                  
         SR    RF,RE                                                            
         STCM  RF,3,DBDIVSOR                                                    
                                                                                
         B     DMHKX                                                            
                                                                                
*                                                                               
** CHECK FILE-SPECIFIC DATA **                                                  
*                                                                               
DMHK005  DS    0H                                                               
         CLC   DBFILE,DCFILPAV                                                  
         BE    DMHKPAV                                                          
                                                                                
         B     DMHK010                                                          
                                                                                
                                                                                
DMHKPAV  DS    0H                  FILE = PAV                                   
         CLI   TYPELP,TLPHIST       PERFORM CHECK IF HISTORY LOOK-UP            
         BNE   DMHKP10                                                          
                                                                                
         L     RF,DBAQUART                                                      
         USING PHELEM,RF                                                        
         MVI   TMPNOR,C'N'         ASSUME NOT NORMAL PROGRAM                    
         CLI   PHDTYPE,1           0=NORMAL, 1=FULL CYCLE                       
         BE    *+8                                                              
         MVI   TMPNOR,C'Y'          IT'S A NORMAL PROGRAM                       
         DROP  RF                                                               
                                                                                
         CLC   LPNOR,TMPNOR        MATCH?                                       
         BNE   DMHKPNO              NO, EXIT HOOK NOW                           
*                                                                               
DMHKP10  DS    0H                                                               
         B     DMHK010                                                          
*                                                                               
DMHKPNO  DS    0H                                                               
         B     DMHKNNO                                                          
         EJECT                                                                  
                                                                                
*                                                                               
** EXTRACT PERTINENT INFORMATION **                                             
*                                                                               
DMHK010  DS    0H                                                               
         OI    DEMFLAG1,DF1RDOK    "GOOD" DATA PASSED TO DEMHOOK                
                                                                                
*                                                                               
*** NON FILE-SPECIFIC INFORMATION ***                                           
*                                                                               
* ie. file, media, source, station, book, book type, days,                      
*      and program name                                                         
                                                                                
         DS    0H                  FILE                                         
         MVC   TMPDFIL,DBFILE                                                   
*                                                                               
         DS    0H                  MEDIA                                        
         MVC   TMPMED,DBACTMED                                                  
*                                                                               
         DS    0H                  STATION                                      
*&&DO                                                                           
         MVC   TMPSTTN,DBACTSTA                                                 
*&&                                                                             
         MVC   TMPSTTN,LPSTTN                                                   
*                                                                               
         DS    0H                  BOOK                                         
         MVC   TMPBOOK,DBACTBK                                                  
*                                                                               
         DS    0H                  BOOK TYPE                                    
         MVC   TMPBTYP,DBBTYPE                                                  
*                                                                               
         DS    0H                  WEEK NUMBER                                  
         MVC   TMPWKN,DBSELWKN                                                  
*                                                                               
         DS    0H                  DAY(S)                                       
         MVC   WORK,SPACES                                                      
         GOTO1 DEFINE,MYDMCB,=C'DAY',DBLOCKD,WORK                               
         MVC   TMPIDAY,WORK                                                     
*                                                                               
         DS    0H                  PROGRAM NAME                                 
         MVC   WORK,SPACES                                                      
         GOTO1 DEFINE,MYDMCB,=C'PROGRA',DBLOCKD,WORK                            
         MVC   TMPPGNAM,WORK                                                    
*                                                                               
         DS    0H                  SOURCE                                       
         MVC   TMPSRC,DBACTSRC                                                  
*                                                                               
         DS    0H                  WEIGHT OVERRIDES                             
         MVC   TMPWTOV,LPWTOV                                                   
         CLI   LPWTOV,0                                                         
         BE    DMHK017X                                                         
         CLI   TYPELP,TLPHIST                                                   
         BNE   *+8                                                              
         OI    TMPFLAG,LTFSELWT                                                 
         CLI   TYPELP,TLPXFER                                                   
         BNE   *+8                                                              
         OI    TMPFLAG,LTFXFRWT                                                 
DMHK017X EQU   *                                                                
*                                                                               
         DS    0H                  WEIGHT FACTOR W/ WEEKS                       
         ICM   R0,3,DBFACTOR                                                    
         STC   R0,TMPWT_WK                                                      
*                                                                               
         DS    0H                                                               
         MVI   GOSUBN,GADQT#                                                    
         GOTO1 AGOSUB                                                           
         EJECT                                                                  
*                                                                               
*** FILE-SPECIFIC INFORMATION ***                                               
*                                                                               
DMHK020  DS    0H                                                               
         L     RF,DEFINE                                                        
         LA    R1,MYDMCB                                                        
*                                                                               
         CLC   DBFILE,DCFILPAV                                                  
         BE    DMHK100                                                          
         CLC   DBFILE,DCFILTP                                                   
         BE    DMHK200                                                          
         CLC   DBFILE,DCFILIUN                                                  
         BE    DMHK300                                                          
         DC    H'0'                                                             
                                                                                
                                                                                
                                                                                
DMHK100  DS    0H                  PAV FILE                                     
                                                                                
         DS    0H                   # OF QUARTER HOURS                          
         MVC   WORK,SPACES                                                      
         GOTO1 (RF),(R1),=C'TOTD',DBLOCKD,WORK                                  
         MVC   TMPNQHR,WORK                                                     
         MVC   TMPQH_WK,WORK                                                    
                                                                                
         CLI   DBACTSRC,C'N'        IF SOURCE IS NSI,                           
         BNE   *+10                                                             
         MVC   TMPWT_WK,WORK         USE TOTDUR FOR WGT FACTOR W/ WKS           
*                                                                               
         DS    0H                   TIMES                                       
         MVC   WORK,SPACES                                                      
         GOTO1 (RF),(R1),=C'TIME',DBLOCKD,WORK                                  
         MVC   TMPSETM,WORK+2        START & END TIMES                          
*                                                                               
         DS    0H                   ACTIVE WEEKS                                
         MVC   WORK,SPACES                                                      
         GOTO1 (RF),(R1),=C'WEEK',DBLOCKD,WORK                                  
         MVC   TMPWKS,WORK                                                      
*                                                                               
         DS    0H                   PURE NUMBER                                 
         MVC   WORK,SPACES                                                      
         GOTO1 (RF),(R1),=C'PURE',DBLOCKD,WORK                                  
         MVC   TMPPURE(2),WORK                                                  
         CLI   DBSELMED,C'N'                                                    
         BNE   DMHK120                                                          
         L     RF,ACOMFACS                                                      
         L     RF,(CHEXIN-COMFACSD)(RF)                                         
         GOTO1 (RF),(R1),WORK+3,WORK,4                                          
         MVC   TMPPURE(2),WORK                                                  
         L     RF,DEFINE                                                        
         LA    R1,MYDMCB                                                        
*                                                                               
DMHK120  TM    LPFLAG,LPFPURE                                                   
         BZ    *+8                                                              
         OI    TMPFLAG2,LTF2PURE                                                
*                                                                               
         DS    0H                  NOR PROGRAM FLAG                             
         L     RF,DBAQUART                                                      
         USING PHELEM,RF                                                        
         MVI   TMPNOR,C'N'         ASSUME NOT NORMAL PROGRAM                    
         CLI   PHDTYPE,1           0=NORMAL, 1=FULL CYCLE                       
         BE    *+8                                                              
         MVI   TMPNOR,C'Y'          IT'S A NORMAL PROGRAM                       
         DROP  RF                                                               
*                                                                               
         DS    0H                  FROM BITS                                    
         MVI   TMPQLFY,C' '         SET QUALIFIER                               
         MVI   GOSUBN,GFBT#         SOURCE & BOOK SET FROM ABOVE                
         GOTO1 AGOSUB               FROM BITS RETURNED IN TMPFRBTS              
*                                                                               
         B     DMHK399                                                          
                                                                                
                                                                                
                                                                                
DMHK200  DS    0H                  TIME PERIOD FILE                             
                                                                                
         DS    0H                   NUMBER OF QUARTER HOURS                     
         MVC   WORK,SPACES                                                      
         GOTO1 (RF),(R1),=C'TIME',DBLOCKD,WORK                                  
         MVC   TMPNQHR,WORK+6                                                   
         MVC   TMPSTIM,WORK+2       START TIME                                  
         MVC   TMPETIM,WORK+4       END   TIME                                  
*                                                                               
         DS    0H                   ACTIVE WEEKS                                
         MVC   WORK,SPACES                                                      
         GOTO1 (RF),(R1),=C'WEEK',DBLOCKD,WORK                                  
         MVC   TMPWKS,WORK                                                      
*                                                                               
         CLI   DBTPTT,C'P'          IF 4-WEEK AVERAGE,                          
         BNE   *+8                                                              
         OI    TMPFLAG2,LTF2T4       FLAG IT                                    
*                                                                               
         DS    0H                  FROM BITS                                    
         MVI   TMPQLFY,C' '         SET QUALIFIER                               
         MVI   GOSUBN,GFBT#         SOURCE & BOOK SET FROM ABOVE                
         GOTO1 AGOSUB               FROM BITS RETURNED IN TMPFRBTS              
*                                                                               
         DS    0H                  GET QUARTER HOURS W/ WEEKS                   
         SR    R0,R0                                                            
         ZICM  RF,TMPWKS,(8)                                                    
         SLL   RF,4                 (REMOVE TOP 4 BITS)                         
         LA    R1,4                                                             
                                                                                
         SR    RE,RE                                                            
         SLDL  RE,1                                                             
         AR    R0,RE                                                            
         BCT   R1,*-8                                                           
                                                                                
         IC    R1,TMPNQHR          (R1 S/B 0 FROM ABOVE BCT)                    
         MR    R0,R0                                                            
         STC   R1,TMPQH_WK                                                      
*                                                                               
         B     DMHK399                                                          
                                                                                
                                                                                
                                                                                
DMHK300  DS    0H                  INVENTORY FILE                               
                                                                                
         DS    0H                   TIMES                                       
         MVC   WORK,SPACES                                                      
         GOTO1 (RF),(R1),=C'TIME',DBLOCKD,WORK                                  
         MVC   TMPSETM,WORK+2        START/END TIMES                            
         MVC   TMPNQHR,WORK+6        NUMBER OF QUARTER HOURS                    
         MVC   TMPQH_WK,WORK+6       NUMBER OF QUARTER HOURS W/ WEEKS           
*                                                                               
         MVC   TMPINVN,DBSELINV     INVENTORY NUMBER                            
*                                                                               
         DS    0H                   GET FROM BITS                               
         L     RE,DBAREC                                                        
         USING RINVKEY,RE                                                       
         MVC   TMPKSRC,RINVKSRC                                                 
         DROP  RE                                                               
         MVI   GOSUBN,RKS#                                                      
         GOTO1 AGOSUB                FROM BITS RETURNED IN TMPFRBTS             
                                                                                
*                                                                               
         DS    0H                   OTHER STUFF FROM EXTENDED DBLOCK            
         ICM   R2,15,DBEXTEND                                                   
DMHK322  BNZ   *+6                                                              
         DC    H'0'                                                             
         CLC   0(4,R2),=C'RINV'                                                 
         BE    DMHK324                                                          
         ICM   R2,15,4(R2)                                                      
         B     DMHK322                                                          
                                                                                
DMHK324  DS    0H                                                               
         USING DBXINVWK,R2                                                      
         MVC   TMPCDATE,DBXIEFFD     EFFECTIVE START DATE                       
         DROP  R2                                                               
*                                                                               
         DS    0H                   TRANSFER CODE                               
         L     R3,DBAREC                                                        
         MVI   ELCODE,X'CD'                                                     
         MVC   DATADISP,DSP1EL                                                  
         BRAS  RE,GETEL                                                         
         BNE   DMHK330X                                                         
         USING RINVCEL,R3                                                       
         MVC   TMPCODE,RINVCODE                                                 
         DROP  R3                                                               
DMHK330X EQU   *                                                                
*                                                                               
                                                                                
         DS    0H                  USE FOOTNOTE AS PROGRAM NAME                 
         MVC   WORK,SPACES                                                      
         GOTO1 DEFINE,MYDMCB,=C'TRAK',DBLOCKD,WORK                              
         MVC   TMPPGNAM,WORK                                                    
*                                                                               
         B     DMHK399                                                          
DMHK399  EQU   *                                                                
                                                                                
                                                                                
                                                                                
         DS    0H                  CHECK END TIME RETURNED FROM DEFINE          
         OC    TMPETIM,TMPETIM      IF ZEROES,                                  
         BNZ   *+10                                                             
         MVC   TMPETIM,=H'2400'      CHANGE IT TO 12 MIDNIGHT                   
         DROP  R5                                                               
         EJECT                                                                  
*                                                                               
** UPDATE TABLE W/ CURRENT INFORMATION **                                       
*                                                                               
         DS    0H                  BUILD ENTRY IN  WORK                         
         XC    WORK,WORK                                                        
LTW      USING LISTTABD,WORK                                                    
         MVC   LTW.LTSRC,TMPSRC                                                 
         MVC   LTW.LTFRBK,TMPFRBK                                               
         MVC   LTW.LTBTYP,TMPBTYP                                               
         MVC   LTW.LTWKN,TMPWKN                                                 
         MVC   LTW.LTFILE,TMPDFIL                                               
         MVC   LTW.LTCODE,TMPCODE                                               
         MVC   LTW.LTSTTN,TMPSTTN                                               
         MVC   LTW.LTPURE,TMPPURE                                               
         MVC   LTW.LTIDAY,TMPIDAY                                               
         MVC   LTW.LTTIME,TMPSETM                                               
         MVC   LTW.LTNOR,TMPNOR                                                 
         MVC   LTW.LTEFFDT,TMPCDATE                                             
                                                                                
         OC    TMPINVN,TMPINVN                                                  
         BZ    *+10                                                             
         MVC   LTW.LTINVN,TMPINVN   INVENTORY NUMBER                            
                                                                                
         MVC   LTW.LTPGNAM,TMPPGNAM                                             
         MVC   LTW.LTWKS,TMPWKS                                                 
         MVC   LTW.LTWGTOV,TMPWTOV                                              
         OC    LTW.LTFLAG,TMPFLAG                                               
         OC    LTW.LTFLAG2,TMPFLAG2                                             
                                                                                
*                                                                               
         DS    0H                                                               
         TM    POSTFLG1,PSTF1DTL                                                
         BZ    DMHK499                                                          
*                                                                               
         DS    0H                  LOCATE ENTRY IN LISTTAB                      
         L     R4,ANLTNTRY          R4-->PLACE TO START SEARCH                  
         USING LISTTABD,R4                                                      
         LA    R0,MXLTNTRY                                                      
                                                                                
         LA    R1,LTKEYL-1                     COMPARE ENTIRE KEY               
         CLC   LTW.LTFILE,DCFILTP               UNLESS TP FILE,                 
         BNE   *+8                                                              
         LA    R1,((LTIDAY-LTKEY)+L'LTIDAY)-1    CMPRE UNTIL START TIME         
                                                                                
DMHK412  DS    0H                                                               
         OC    0(LISTTABQ,R4),0(R4)                                             
         BZ    DMHK414                                                          
         EXCLC R1,LTKEY,LTW.LTKEY  R1 HAS COMPARE LEN FROM ABOVE                
         BE    DMHK420                                                          
         LA    R4,LISTTABQ(R4)                                                  
         BCT   R0,DMHK412                                                       
         B     DMHKX               TOO MANY LIST ENTRIES                        
         DC    H'0'                TOO MANY LIST ENTRIES                        
                                                                                
DMHK414  DS    0H                  NEED TO ADD ENTRY TO LIST TABLE              
         MVC   LISTTABD(LISTTABQ),LTW.LISTTABD                                  
         ZIC   R1,NLTNTRY                                                       
         LA    R1,1(R1)                                                         
         STC   R1,NLTNTRY          UPDATE # OF ENTRIES IN LISTTAB               
         STC   R1,LTNTRY           ASSIGN # TO ENTRY                            
                                                                                
         CLI   TYPELP,TLPHIST      IF THIS IS PART OF INV'S HISTORY             
*&&DO                                                                           
         BNE   DMHK414X                                                         
*&&                                                                             
         BE    DMHK414T             GO FLAG AS SELECTED                         
         CLI   TYPELP,TLPUINP      IF USER-INPUTTED LIST PARAMETERS             
         BNE   *+22                                                             
         CLC   LTW.LTFILE,DCFILPAV         AND THIS ENTRY IS FROM PAV,          
         BNE   *+12                                                             
         TM    RMPPROFS+RMPRASPB,RMPRASPA  AND PAV AUTO-SELECT ON,              
         BO    DMHK414P                    GO FLAG AS SELECTED                  
         B     DMHK414X                                                         
                                                                                
DMHK414P DS    0H                                                               
         OI    SELFLAG1,SF1SLECT    FLAG THAT SOMETHING WAS SELECTED            
                                                                                
DMHK414T DS    0H                                                               
         OI    LTFLAG,LTFSEL        FLAG IT SELECTED,                           
         OI    SELFLAG1,SF1AL1ES    AND FLAG AT LEAST 1 ENTRY SELECTED          
                                                                                
DMHK414X EQU   *                                                                
*                                                                               
DMHK420  DS    0H                  R4-->LIST TABLE ENTRY TO UPDATE              
*&&DO                                                                           
                                                                                
         CLI   TYPELP,TLPHIST      UPDATE IF THIS IS INV'S HISTORY              
         BE    DMHK425                                                          
         TM    LTFLAG,LTFSEL        ELSE, IF ENTRY IS SELECTED,                 
         BO    DMHK440               DON'T UPDATE                               
*&&                                                                             
                                                                                
DMHK425  DS    0H                  UPDATE # OF QUARTER HOURS                    
         ZIC   R0,LTNQHR                                                        
         ZIC   R1,TMPNQHR                                                       
         AR    R0,R1                                                            
         STC   R0,LTNQHR                                                        
                                                                                
         DS    0H                  UPDATE # OF QUARTER HOURS W/ WEEKS           
         ZIC   R0,LTQH_WK                                                       
         ZIC   R1,TMPQH_WK                                                      
         AR    R0,R1                                                            
         STC   R0,LTQH_WK                                                       
                                                                                
         DS    0H                  UPDATE WEIGHT FACTOR-WITH-WEEKS              
         ZIC   R0,LTWT_WK                                                       
         ZIC   R1,TMPWT_WK                                                      
         AR    R0,R1                                                            
         STC   R0,LTWT_WK                                                       
*                                                                               
DMHK440  DS    0H                  "START PROG/END PROG", IF DIFFERENT          
         CLC   LTPGNAM,LTW.LTPGNAM                                              
         BE    DMHK449                                                          
                                                                                
         MVI   LTPGNAM+(L'LTPGNAM/2),C'/'                                       
         LA    R1,L'LTPGNAM-(L'LTPGNAM/2)-1                                     
         BCTR  R1,0                                                             
         EXMVC R1,LTPGNAM+(L'LTPGNAM/2)+1,LTW.LTPGNAM                           
DMHK449  EQU   *                                                                
*                                                                               
         DS    0H                                                               
         CLC   LTFILE,DCFILTP      IF TIME PERIOD FILE,                         
         BNE   *+10                                                             
         MVC   LTETIME,TMPETIM      RESET END TIME (TO A LATER END TIM)         
*                                                                               
         DS    0H                                                               
         CLC   LTWKS,LTW.LTWKS     CHECK IF PROGRAMS HAVE MIXED WEEKS           
         BE    *+8                                                              
         OI    LTFLAG,LTFMIXWK                                                  
*                                                                               
DMHK499  EQU   *                                                                
         DROP  R4                                                               
         EJECT                                                                  
*                                                                               
** UPDATE SUMMARY ENTRY **                                                      
*                                                                               
         TM    POSTFLG1,PSTF1SUM                                                
         BZ    DMHK599                                                          
                                                                                
*                                                                               
         DS    0H                                                               
         LA    R4,SUMLT            POINT R4 TO SUMMARY ENTRY                    
         USING LISTTABD,R4                                                      
         OC    LTKEY(LTKEYL),LTKEY                                              
         BNZ   DMHK519                                                          
         MVC   LISTTABD(LISTTABQ),LTW.LISTTABD                                  
                                                                                
         USING DBLOCKD,R5                                                       
         MVI   TMPQHAF,100         SET QUARTER HOUR ADJUSTMENT FACTOR           
         CLC   =AL2(DBDQUXTD),DBDQTAB+0 USING XTND FOR D/Q ENTRIES?             
         BNE   DMHK513X                  NOPE, LEAVE ADJ FACTOR ALONE           
         L     RF,ADBDQD                 YES, QH ADJ FCTR IS B4 D/QHs           
         SHI   RF,(DBDQXFXL-(DBDQADJF-DBDQXTND))  RF-->ADJ FACTOR               
         ZICM  R1,0(RF),(3)                       R1 = ADJ FACTOR,              
         SHI   R1,100                              MAKE IT 100-BASED            
         LCR   R1,R1                                                            
         STC   R1,TMPQHAF                          AND SAVE IT                  
DMHK513X EQU   *                                                                
                                                                                
         MVI   GOSUBN,QTM#          NEED TO CONVRT FROM QH TO MIL TIME          
         ZIC   R1,DBACTSQH                                                      
         BCTR  R1,0                                                             
         STC   R1,TMPQHR                                                        
         GOTO1 AGOSUB                                                           
         MVC   LTSTIME,TMPMTIM       ACTUAL REQUESTED START TIME                
         MVC   TMPQHR,DBACTEQH                                                  
         GOTO1 (RF)                                                             
         MVC   LTETIME,TMPMTIM       ACTUAL REQUESTED END TIME                  
         DROP  R5                                                               
                                                                                
         MVC   LTNQHR,TMPNQHR                                                   
         MVC   LTQH_WK,TMPQH_WK                                                 
         MVC   LTWT_WK,TMPWT_WK                                                 
         B     DMHK599                                                          
DMHK519  EQU   *                                                                
                                                                                
*                                                                               
         DS    0H                                                               
         SR    R0,R0                                                            
         SR    R1,R1                                                            
*                                                                               
         DS    0H                  UPDATE # OF QUARTER HOURS                    
         IC    R0,LTNQHR                                                        
         IC    R1,TMPNQHR                                                       
         AR    R0,R1                                                            
         STC   R0,LTNQHR                                                        
*                                                                               
         DS    0H                  UPDATE # OF QUARTER HOURS W/ WEEKS           
         IC    R0,LTQH_WK                                                       
         IC    R1,TMPQH_WK                                                      
         AR    R0,R1                                                            
         STC   R0,LTQH_WK                                                       
*                                                                               
         DS    0H                  UPDATE WEIGHT FACTOR-WITH-WEEKS              
         ZIC   R0,LTWT_WK                                                       
         ZIC   R1,TMPWT_WK                                                      
         AR    R0,R1                                                            
         STC   R0,LTWT_WK                                                       
*                                                                               
         DS    0H                  "START PROG/END PROG", IF DIFFERENT          
         CLC   LTPGNAM,LTW.LTPGNAM                                              
         BE    DMHK549                                                          
                                                                                
         MVI   LTPGNAM+(L'LTPGNAM/2),C'/'                                       
         LA    R1,L'LTPGNAM-(L'LTPGNAM/2)-1                                     
         BCTR  R1,0                                                             
         EXMVC R1,LTPGNAM+(L'LTPGNAM/2)+1,LTW.LTPGNAM                           
DMHK549  EQU   *                                                                
*                                                                               
         DS    0H                                                               
         CLC   LTWKS,LTW.LTWKS     CHECK IF PROGRAMS HAVE MIXED WEEKS           
         BE    *+8                                                              
         OI    LTFLAG,LTFMIXWK                                                  
                                                                                
*                                                                               
DMHK599  EQU   *                                                                
         DROP  R4                                                               
                                                                                
*                                                                               
         DROP  LTW                                                              
*                                                                               
DMHKX    DS    0H                                                               
         J     XIT                                                              
                                                                                
                                                                                
* Little routine to put summary entry into LISTTAB.                             
* At entry,                                                                     
*   ANLTNTRY = A(next available slot in LISTTAB)                                
*   ONLTNTRY = A(NEXT AVAILABLE SLOT IN LISTTAB) PRIOR TO DEMAND CALL           
* At exit,                                                                      
*   ANLTNTRY = A(next available slot in LISTTAB)                                
PLTSUM   NTR1                                                                   
         ICM   R5,15,ANLTNTRY      IF NO SLOT AVAILABLE,                        
         BZ    PLTSUMX              EXIT NOW                                    
*                                                                               
                                                                                
         DS    0H                  MAKE ADJUSTMENTS TO SUMMARY LINE             
         LA    R4,SUMLT                                                         
         USING LISTTABD,R4                                                      
         MVC   LTIDAY,LPIDAY        SET SUMMARY DAY TO REQUEST DAY              
         DROP  R4                                                               
                                                                                
*                                                                               
         DS    0H                                                               
         L     R4,ONLTNTRY                                                      
         USING LISTTABD,R4                                                      
*                                                                               
PLTSUM32 DS    0H                                                               
         CR    R4,R5                                                            
         BNL   PLTSUM39                                                         
*                                                                               
         CLC   LTKEY(LTKEYL),SUMLT+(LTKEY-LISTTABD)                             
         BE    PLTSUMX                                                          
         LA    R4,LISTTABQ(R4)                                                  
         B     PLTSUM32                                                         
PLTSUM39 EQU   *                                                                
                                                                                
*                                                                               
         DS    0H                  ADD ENTRY TO LISTTAB                         
         MVC   LISTTABD(LISTTABQ),SUMLT                                         
         CLI   TYPELP,TLPHIST      IF THIS IS PART OF INV'S HISTORY,            
         BNE   *+12                                                             
         OI    LTFLAG,LTFSEL        FLAG IT SELECTED,                           
         OI    SELFLAG1,SF1AL1ES    AND FLAG AT LEAST 1 ENTRY SELECTED          
*                                                                               
         DS    0H                                                               
         ZIC   R1,NLTNTRY                                                       
         LA    R1,1(R1)                                                         
         STC   R1,NLTNTRY          UPDATE # OF ENTRIES IN LISTTAB               
         STC   R1,LTNTRY           ASSIGN # TO ENTRY                            
*                                                                               
         MVI   GOSUBN,LNS#                                                      
         GOTO1 AGOSUB                                                           
*                                                                               
PLTSUMX  DS    0H                                                               
         J     XIT                                                              
         DROP  R4                                                               
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR01--MISC STUF+        
               F)'                                                              
*--------------------- SUBR01 MISCELLANEOUS STUFF --------------------*         
                                                                                
* Little helper routine to set the demo file for PT (PAV & TP)                  
*  transfers.                                                                   
* At exit,                                                                      
*  LPFILE   = demo file from which to get data                                  
*  LPTPTT   = typical time or 4-week average for TP file                        
*  CC equal ==> go get data from file specified in LPFILE                       
*  CC neqal ==> don't get any more data                                         
                                                                                
SETPTFIL NTR1                                                                   
         OC    LPFILE,LPFILE       IF FILE IS NOT SET YET,                      
         BNZ   *+14                                                             
         MVC   LPFILE,DCFILPAV      SET TO GET PAV DATA FIRST                   
         J     YES                                                              
                                                                                
         CLC   LPFILE,DCFILPAV     IF FILE IS PAV,                              
         BNE   *+18                                                             
         MVC   LPFILE,DCFILTP       SET TO GET TP DATA NEXT                     
         MVI   LPTPTT,C'T'                                                      
         J     YES                                                              
                                                                                
         CLC   LPFILE,DCFILTP      IF FILE IS TP,                               
         BNE   *+8                                                              
         J     NO                   TELL CALLER FINISHED SETTING FILES          
                                                                                
         DC    H'0'                                                             
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR01--LTORG && +        
               CONSTANTS)'                                                      
*------------------------- LTORG & CONSTANTS -------------------------*         
         LTORG                                                                  
                                                                                
                                                                                
SUBR01L  EQU   *-SUBR01                                                         
         DS    0CL(X'1000'-SUBR01L+1)                                           
***********************************************************************         
                                                                                
         DROP  R7,R8,RA,RB,RC                                                   
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR02)'                  
***********************************************************************         
*======================== SUBROUTINE POOL TWO ========================*         
                                                                                
* At entry,                                                                     
*   RA-->TWA,                                                                   
*   R8-->SYSD,                                                                  
*   R7-->SPOOLD,                                                                
*   R1-->GEND,                                                                  
*   GOSUBN = equated sub-routine number.                                        
                                                                                
SUBR02Q  EQU   (((*-RMP18+X'0FFF')/X'1000')*X'1000')                            
                                                                                
         ORG   RMP18+SUBR02Q                                                    
SUBR02   NMOD1 0,**1802**                                                       
         LR    RC,R1                                                            
         USING GEND,RC             RC=A(GENCON WORK AREA)                       
         USING CONHEADH-64,RA      RA=A(TWA)                                    
         USING SYSD,R8             R8=A(SYSD)                                   
         USING SPOOLD,R7           R7=A(SPOOL WORK AREA)                        
                                                                                
         ZIC   R1,GOSUBN                                                        
         SH    R1,=Y(R01#)         SUBTRACT FOR SUB-RTN # 2                     
         BCTR  R1,0                                                             
         SLL   R1,2                                                             
         B     R02_00(R1)                                                       
                                                                                
VSRC#    EQU   ((R02_01-*)/4+1)+R01#  VALIDATE SOURCE                           
VSTA#    EQU   ((R02_02-*)/4+1)+R01#  VALIDATE STATION                          
VUPG#    EQU   ((R02_03-*)/4+1)+R01#  VALIDATE UPGRADE OPTION                   
FUPG#    EQU   ((R02_04-*)/4+1)+R01#  FORMAT UPGRADE                            
BIK#     EQU   ((R02_05-*)/4+1)+R01#  BUILD KEY TO INVENTORY RECORD             
GIR#     EQU   ((R02_06-*)/4+1)+R01#  GET INVENTORY RECORD                      
BST#     EQU   ((R02_07-*)/4+1)+R01#  BUILD SKELETON TRACK                      
GHI#     EQU   ((R02_08-*)/4+1)+R01#  GET HEADER INFORMATION                    
GFBT#    EQU   ((R02_09-*)/4+1)+R01#  GET FROM BITS                             
GKS#     EQU   ((R02_10-*)/4+1)+R01#  GET KEY SOURCE                            
RKS#     EQU   ((R02_11-*)/4+1)+R01#  REVERSE KEY SOURCE                        
GFN#     EQU   ((R02_12-*)/4+1)+R01#  GET FOOTNOTE                              
                                                                                
R02_00   DS    0H                                                               
R02_01   B     VALSRC                 VALIDATE SOURCE                           
R02_02   B     MYVALSTA               VALIDATE STATION                          
R02_03   B     VALUPGD                VALIDATE UPGRADE OPTION                   
R02_04   B     FMTUPGD                FORMAT UPGRADE                            
R02_05   B     BINVKEY                BUILD KEY TO INVENTORY RECORD             
R02_06   B     GINVRCD                GET INVENTORY RECORD                      
R02_07   B     BLDSKLTK               BUILD SKELETON TRACK                      
R02_08   B     GTHDRINF               GET HEADER INFORMATION                    
R02_09   B     GETFRBTS               GET FROM BITS                             
R02_10   B     GETKSRC                GET KEY SOURCE                            
R02_11   B     REVKSRC                REVERSE KEY SOURCE                        
R02_12   B     GTFTNOTE               GET FOOTNOTE                              
R02#     EQU   ((*-R02_00)/4)+R01#                                              
         DC    H'0'                                                             
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR02--VSRC#)'           
*------------------- VALIDATE SOURCE (RATING SERVICE) ----------------*         
                                                                                
* Validates a field containing a variable-length source (rating srvce).         
* At entry,                                                                     
*   OURBYTE = length of data to validate,                                       
*   R0      = A(test specimen).                                                 
* At exit,                                                                      
*   TMPRSVC = 3-CHAR RATING SERVICE CODE,                                       
*   TMPSRC  = 1-CHAR SOURCE CODE,                                               
*   CC set to equal if valid source,                                            
*   CC set to not equal if invalid source.                                      
                                                                                
VALSRC   DS    0H                                                               
         XC    TMPSRC,TMPSRC                                                    
                                                                                
*                                                                               
         CLI   OURBYTE,L'RSVCTAB   IF LENGTH > MAX,                             
         BNH   *+6                                                              
         DC    H'0'                 SOMETHING'S INTERNALLY WRONG                
                                                                                
*                                                                               
         ZIC   R1,OURBYTE                                                       
         BCTR  R1,0                R1 = LEN FOR EX COMPARE                      
         LR    RE,R0               RE = A(TEST SPECIMEN)                        
         L     RF,ARM18WRK                                                      
         L     RF,(ARSVCTAB-RM18WRKD)(RF)                                       
                                                                                
VSRC020  DS    0H                                                               
         CLI   0(RF),EOT           IF END OF TABLE REACHED,                     
         BE    VSRCXN               SEND BACK INVALID FLAG                      
         EXCLC R1,0(RE),0(RF)                                                   
         BE    *+12                                                             
         LA    RF,L'RSVCTAB(RF)                                                 
         B     VSRC020                                                          
         MVC   TMPRSVC,0(RF)       SOURCE IS VALID                              
         MVC   TMPSRC,3(RF)        GET SOURCE CODE TOO                          
*                                                                               
         B     VSRCXY                                                           
                                                                                
*                                                                               
VSRCXN   DS    0H                                                               
         J     NO                                                               
                                                                                
VSRCXY   DS    0H                                                               
         J     YES                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR02--VSTA#)'           
*-------------------------- VALIDATE STATION -------------------------*         
                                                                                
* This validate station routine was copied for the most part from the           
*  VSTA (ie. GOTO1 VALISTA,DMCB,...) routine in the root phase.                 
*  Having a copy of the station validation code in this program allows          
*  us to handle station input errors in the manner that other errors            
*  are handled in this program.                                                 
* At entry,                                                                     
*   R2-->field header of station field (there must be input in fld).            
* At exit,                                                                      
*   WORK(5)      contains the station call letters,                             
*   WORK+40(1) = 1 or 2 if satellite station,                                   
*   CC set to equal for valid station input, else, CC set to not equal.         
                                                                                
MYVALSTA DS    0H                                                               
         MVC   WORK,SPACES         INITIALIZE OUTPUT AREA                       
         LA    R0,BLOCK                                                         
         LA    R1,L'BLOCK                                                       
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE               CLEAR BLOCK                                  
*                                                                               
         GOTO1 SCANNER,DMCB,(R2),(1,BLOCK),C',=,-'                              
         LA    R4,BLOCK                                                         
*                                                                               
         DS    0H                  VALIDATE CALL LETTERS                        
         CLI   0(R4),3              CALL LETTERS ARE AT LEAST 3                 
         BL    VSTAXN                                                           
         CLI   0(R4),4               AND AT MOST 4 CHARACTERS LONG              
         BH    VSTAXN                                                           
         TM    2(R4),X'40'          THEY ALSO HAVE TO BE ALPHABETIC             
         BZ    VSTAXN                                                           
         MVC   WORK(4),12(R4)       SAVE CALL LETTERS                           
*                                                                               
         DS    0H                  VALIDATE MEDIA                               
         CLI   1(R4),2              LENGTH SHOULDN'T BE GREATER THAN 2          
         BH    VSTAXN                                                           
         ZICM  R1,1(R4),(1)                                                     
         BZ    VSTA100              IF NO MEDIA INPUTTED, DEFAULT TO TV         
         BCTR  R1,0                                                             
         EX    R1,VSTATV            TV, LEAVE BLANK                             
         BE    VSTA100                                                          
         MVI   WORK+4,C'A'          AM = A                                      
         EX    R1,VSTAAM                                                        
         BE    VSTA100                                                          
         MVI   WORK+4,C'F'          FM = F                                      
         EX    R1,VSTAFM                                                        
         BE    VSTA100                                                          
         MVI   WORK+4,C'C'          CM = C                                      
         EX    R1,VSTACM                                                        
         BE    VSTA100                                                          
                                                                                
         CLI   1(R4),1                                                          
         BH    VSTAXN                                                           
         MVI   WORK+40,C'H'                                                     
         MVI   WORK+4,C'H'         NETWORK NHTI FILE?                           
         EX    R1,VSTANHT                                                       
         BE    VSTA100                                                          
         MVI   WORK+4,C' '         MAY BE A SATELLITE STATION                   
         MVI   WORK+40,C'1'                                                     
         EX    R1,VSTA1                                                         
         BE    VSTA100                                                          
         MVI   WORK+40,C'2'                                                     
         EX    R1,VSTA2                                                         
         BE    VSTA100                                                          
                                                                                
         B     VSTAXN               NONE OF THE ABOVE, IT'S INVALID             
*                                                                               
VSTA100  DS    0H                                                               
                                                                                
         B     VSTAXY                                                           
                                                                                
                                                                                
VSTAXN   DS    0H                                                               
         J     NO                                                               
VSTAXY   DS    0H                                                               
         J     YES                                                              
                                                                                
                                                                                
* Should not fall through and execute these.                                    
                                                                                
VSTATV   CLC   22(0,R4),=C'TV'                                                  
VSTAAM   CLC   22(0,R4),=C'AM'                                                  
VSTAFM   CLC   22(0,R4),=C'FM'                                                  
VSTACM   CLC   22(0,R4),=C'CM'                                                  
VSTA1    CLC   22(0,R4),=C'1'                                                   
VSTA2    CLC   22(0,R4),=C'2'                                                   
STALF    CLC   22(0,R4),=C'LF'                                                  
VSTANHT  CLC   22(0,R4),=C'H '                                                  
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR02--VUPG#)'           
*-------------------- VALIDATE UPGRADE EXPRESSION --------------------*         
                                                                                
* Validates an upgrade expression specified in the options field.               
* At entry,                                                                     
*   R3-->SCANNER entry w/ upgrade expression in 2nd half,                       
*   R4-->entry of option keyword for upgrade.                                   
* On exit when upgrade expression valid,                                        
*   CC set to equal,                                                            
*   BLOCK contains option data to be stored.                                    
* On exit when upgrade expression invalid,                                      
*   CC set to not equal,                                                        
*   OURERRCD = appropriate error code,                                          
*   FLDDSPL  = displacement of error input,                                     
*   MYTEXT   = text for text replace (if there are any).                        
* NOTE: Do NOT clobber BUFF here!                                               
                                                                                
VALUPGD  DS    0H                                                               
         MVI   OURERRCD,0                                                       
         MVI   MYTEXT,0                                                         
         MVC   FLDDSPL,8(R3)                                                    
*                                                                               
         DS    0H                  BUILD DUMMY TWA FIELD IN WORK                
         ZIC   R0,1(R3)                                                         
         LR    R1,R0                                                            
         BCTR  R1,0                                                             
         EXMVC R1,WORK+8,22(R3)     FIELD DATA                                  
         XC    WORK(8),WORK                                                     
         STC   R0,WORK+5                                                        
         LA    R1,8+1(R1)                                                       
         STC   R1,WORK              FIELD HEADER                                
                                                                                
         MVI   BYTE,C'Y'           SUPPORT ONE DECIMAL PRECISION                
         GOTO1 UPVAL,DMCB,WORK,(BYTE,BLOCK),('UPVALCH',ACOMFACS)                
         CLI   0(R1),0                                                          
         BNE   VUPG010                                                          
         MVI   OURERRCD,IUPGQ                                                   
         B     VUPGXN                                                           
                                                                                
*                                                                               
VUPG010  DS    0H                  CHECK IF UPGRADE IS ALLOWED                  
         L     RE,ARM18WRK                                                      
         L     RE,(AUPGKWTB-RM18WRKD)(RE)  RE-->TABLE OF UPGDS ALLOWED          
         LA    RF,BLOCK                                                         
         USING RAVLNEL,RF                                                       
                                                                                
         MVC   BYTE,RAVLNTYP       HOLD ONTO UPGRADE TYPE                       
         TM    BYTE,X80+X40        TEST IF ONE DECIMAL PRECISION                
         BNM   *+8                                                              
         XI    BYTE,X40             YES, TURN IT OFF FOR COMPARE                
*                                                                               
VUPG012  DS    0H                                                               
         CLI   0(RE),EOT           END-OF-TABLE REACHED                         
         BE    VUPG015              UPGRADE IS NOT ALLOWED                      
         ZIC   R1,1(RE)            R1 = BIT MASK VALUE FOR BRANCHING            
         CLC   BYTE,0(RE)                                                       
         EX    R1,*+4                                                           
         BC    0,VUPG019                                                        
         LA    RE,L'UPGKYWTB(RE)                                                
         B     VUPG012                                                          
         DROP  RF                                                               
                                                                                
VUPG015  DS    0H                  UPGRADE NOT ALLOWED                          
         MVI   OURERRCD,UNAQ        SET ERROR CODE                              
         LA    R0,22(R3)                                                        
         LR    R1,R0                                                            
VUPG015B CLI   0(R1),UPVALCH                                                    
         BE    VUPG015D                                                         
         LA    R1,1(R1)                                                         
         B     VUPG015B                                                         
VUPG015D SR    R1,R0                                                            
         BP    *+6                                                              
         DC    H'0'                                                             
         STC   R1,MYTEXT            SET EXTRA MESSAGE TEXT                      
         BCTR  R1,0                                                             
         EXMVC R1,MYTEXT+1,22(R3)                                               
         B     VUPGXN                                                           
                                                                                
VUPG019  EQU   *                                                                
         B     VUPGXY                                                           
                                                                                
*                                                                               
VUPGXY   DS    0H                                                               
         J     YES                                                              
VUPGXN   DS    0H                                                               
         J     NO                                                               
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR02--FUPG#)'           
*--------------------------- FORMAT UPGRADE --------------------------*         
                                                                                
* Translates an upgrade element into a displayable upgrade formula.             
*  Routine also sets DUMUPGD to reflect the actual upgrade element.             
                                                                                
* At entry,                                                                     
*  R3-->upgrade element (may have extraneous operands).                         
* At exit,                                                                      
*  DUMUPGD contains actual upgd elem corresponding to upgd expression,          
*  BUFF+1 contains upgrade expression in display format,                        
*  BUFF = L(displayable upgrade).                                               
                                                                                
FMTUPGD  DS    0H                                                               
         USING RAVLNEL,R3                                                       
DU       USING RAVLNEL,DUMUPGD                                                  
*                                                                               
         DS    0H                  INITIALIZE OUTPUT AREA                       
         MVI   BUFF,0                                                           
         LA    R2,BUFF+1                                                        
         XC    0(256,R2),0(R2)                                                  
         XC    DUMUPGD,DUMUPGD                                                  
         MVI   OURBYTE,0            OURBYTE USED FOR # OF DECIMAL PLACE         
                                                                                
*                                                                               
         DS    0H                                                               
         NI    UPGFLAG,XFF-UPGFDECP   ASSUME IT'S NOT ONE DECIMAL PREC          
         MVC   BYTE,RAVLNTYP          HOLD ONTO UPGRADE TYPE                    
         TM    BYTE,X80+X40           TEST IF ONE DECIMAL PREC                  
         BNM   *+12                                                             
         XI    BYTE,X40                YES, ADJUST UPGRADE TYPE                 
         OI    UPGFLAG,UPGFDECP                                                 
*                                                                               
         L     RE,ARM18WRK                                                      
         L     RE,(AUPGKWTB-RM18WRKD)(RE)                                       
FUPG022  DS    0H                                                               
         CLI   0(RE),EOT                                                        
         BNE   *+6                                                              
         DC    H'0'                                                             
         ZIC   R1,1(RE)            R1 = MASK BIT VALUE FOR BRANCHING            
         CLC   BYTE,0(RE)                                                       
         EX    R1,*+4                                                           
         BC    0,FUPG025                                                        
         LA    RE,L'UPGKYWTB(RE)                                                
         B     FUPG022                                                          
                                                                                
FUPG025  DS    0H                                                               
         MVC   DU.RAVLNEL(RAVLNOPS-RAVLNEL),RAVLNEL                             
         ZICM  RF,2(RE),(3)                                                     
         A     RF,MYBASE1                                                       
         BR    RF                                                               
                                                                                
*                                                                               
** RATING UPGRADE **                                                            
*                                                                               
FURTG    DS    0H                                                               
         MVC   0(3,R2),=C'RTG'                                                  
         LA    R2,3(R2)                                                         
         BAS   RE,FUINSCH                                                       
*                                                                               
         DS    0H                  FIRST OPERAND                                
         ZICM  R1,RAVLNOP1,(3)                                                  
         STCM  R1,3,DU.RAVLNOP1                                                 
         BAS   RE,FUEDTLFT                                                      
         BAS   RE,FUMOVE                                                        
*                                                                               
         DS    0H                  SECOND OPERAND (OPTIONAL)                    
         ZICM  R1,RAVLNOP2,(3)                                                  
         BZ    FURTG050                                                         
                                                                                
         STCM  R1,3,DU.RAVLNOP2                                                 
         LA    RF,FUEDTLFT         GET SET TO EDIT NUMERIC VALUE                
         LH    R0,=H'500'                                                       
         TM    UPGFLAG,UPGFDECP                                                 
         BZ    *+8                                                              
         MH    R0,=H'10'                                                        
         CR    R1,R0                                                            
         BL    *+14                                                             
         MVC   BYTE,RAVLNBT                                                     
         LA    RF,FUBOOK            OR BOOK                                     
         BASR  RE,RF                                                            
                                                                                
         BAS   RE,FUINSCH                                                       
         BAS   RE,FUMOVE                                                        
         B     FURTG050                                                         
*                                                                               
FURTG050 DS    0H                                                               
         B     FUPG100                                                          
                                                                                
*                                                                               
** HUT/PUT/SHR UPGRADE **                                                       
*                                                                               
FUHPS    DS    0H                                                               
         CLI   RAVLNCAT,C'P'       PUT UPGRADE?                                 
         BE    FUHPS070                                                         
         OC    RAVLNOP1,RAVLNOP1   SHARE UPGRADE?                               
         BZ    FUHPS040                                                         
                                                                                
*                                                                               
         DS    0H                  IT'S AN HUT UPGRADE                          
         MVC   0(3,R2),=C'HUT'                                                  
         LA    R2,3(R2)                                                         
         BAS   RE,FUINSCH                                                       
*                                                                               
         ZICM  R1,RAVLNOP1,(3)      FIRST OPERAND                               
         STCM  R1,3,DU.RAVLNOP1                                                 
         LA    RF,FUEDTLFT           GET SET TO EDIT NUMERIC VALUE              
         LH    R0,=H'500'                                                       
         TM    UPGFLAG,UPGFDECP                                                 
         BZ    *+8                                                              
         MH    R0,=H'10'                                                        
         CR    R1,R0                                                            
         BL    *+14                                                             
         MVC   BYTE,RAVLNBT                                                     
         LA    RF,FUBOOK              OR BOOK                                   
         BASR  RE,RF                                                            
         BAS   RE,FUMOVE                                                        
*                                                                               
         ZICM  R1,RAVLNOP2,(3)      SECOND OPERAND (OPTIONAL)                   
         BZ    FUHPS030                                                         
                                                                                
         STCM  R1,3,DU.RAVLNOP2                                                 
         LA    RF,FUEDTLFT           GET SET TO EDIT NUMERIC VALUE              
         LH    R0,=H'500'                                                       
         TM    UPGFLAG,UPGFDECP                                                 
         BZ    *+8                                                              
         MH    R0,=H'10'                                                        
         CR    R1,R0                                                            
         BL    *+14                                                             
         MVC   BYTE,RAVLNBT                                                     
         LA    RF,FUBOOK              OR BOOK                                   
         BASR  RE,RF                                                            
         BAS   RE,FUINSCH                                                       
         BAS   RE,FUMOVE                                                        
         B     FUHPS030                                                         
*                                                                               
FUHPS030 DS    0H                                                               
         B     FUHPS100             FINISHED W/ HUT UPGRADE                     
                                                                                
*                                                                               
FUHPS040 DS    0H                  SHARE UPGRADE                                
         MVC   0(2,R2),=C'SH'                                                   
         LA    R2,2(R2)                                                         
         BAS   RE,FUINSCH                                                       
*                                                                               
         ZICM  R1,RAVLNOP2,(3)      SECOND OPERAND                              
         STCM  R1,3,DU.RAVLNOP2                                                 
         BAS   RE,FUEDTLFT                                                      
         BAS   RE,FUMOVE                                                        
         B     FUHPS060                                                         
*                                                                               
FUHPS060 DS    0H                                                               
         B     FUHPS100             FINISHED W/ SHARE UPGRADE                   
                                                                                
*                                                                               
FUHPS070 DS    0H                  PUT UPGRADE                                  
         MVC   0(3,R2),=C'PUT'                                                  
         LA    R2,3(R2)                                                         
         BAS   RE,FUINSCH                                                       
*                                                                               
         ZICM  R1,RAVLNOP1,(3)      FIRST OPERAND                               
         STCM  R1,3,DU.RAVLNOP1                                                 
         MVC   BYTE,RAVLNBT                                                     
         BAS   RE,FUBOOK                                                        
         BAS   RE,FUMOVE                                                        
*                                                                               
         ZICM  R1,RAVLNOP2,(3)      SECOND OPERAND                              
         BZ    FUHPS074X             IF NOT ZERO,                               
         CH    R1,=H'1000'                                                      
         BNL   FUHPS074X              AND LESS THAN 1000,                       
         MVI   OURBYTE,1              DISPLAY IT AS NN.N                        
         BAS   RE,FUEDTLFT                                                      
         BAS   RE,FUINSCH                                                       
         BAS   RE,FUMOVE                                                        
FUHPS074X EQU  *                                                                
         B     FUHPS090                                                         
*                                                                               
FUHPS090 DS    0H                                                               
         B     FUHPS100             FINISHED W/ PUT UPGRADE                     
                                                                                
*                                                                               
FUHPS100 DS    0H                                                               
         B     FUPG100                                                          
                                                                                
*                                                                               
** INDEX UPGRADE **                                                             
*                                                                               
FUIDX    DS    0H                                                               
         MVC   0(2,R2),=C'IX'                                                   
         LA    R2,2(R2)                                                         
         BAS   RE,FUINSCH                                                       
*                                                                               
         DS    0H                  FIRST OPERAND                                
         ZICM  R1,RAVLNOP1,(3)                                                  
         STCM  R1,3,DU.RAVLNOP1                                                 
         BAS   RE,FUEDTLFT                                                      
         BAS   RE,FUMOVE                                                        
         B     FUPG100                                                          
                                                                                
*                                                                               
** HPT UPGRADE **                                                               
*                                                                               
FUHPT    DS    0H                                                               
         MVC   0(3,R2),=C'HPT'                                                  
         CLI   RAVLNCAT,C'V'       IF THIS IS TRUE,                             
         BNE   *+8                                                              
         MVI   2(R2),C'V'           SET UPGRADE NAME TO "HPV"                   
         MVI   3(R2),UPVALCH                                                    
         LA    R2,4(R2)                                                         
*                                                                               
         ZICM  R1,RAVLNOP1,(3)     FIRST OPERAND                                
         STCM  R1,3,DU.RAVLNOP1                                                 
         MVC   BYTE,RAVLNBT                                                     
         BAS   RE,FUBOOK            IS A BOOK                                   
         BAS   RE,FUMOVE                                                        
*                                                                               
         ZICM  R1,RAVLNOP3,(3)     THIRD OPERAND                                
         STCM  R1,3,DU.RAVLNOP3                                                 
         CLI   RAVLNCAT,C'V'        "HPV" IS A NEW UPGD,                        
         BNE   *+8                                                              
         MVI   OURBYTE,1             SO VALUES ALWAYS HAVE 1 DEC PRECSN         
         BAS   RE,FUEDTLFT          IS A NUMERIC VALUE                          
         BAS   RE,FUINSCH                                                       
         BAS   RE,FUMOVE                                                        
*                                                                               
         ZICM  R1,RAVLNOP4,(3)     FOURTH OPERAND,                              
         BZ    FUHPT039             IF IT'S THERE,                              
         STCM  R1,3,DU.RAVLNOP4                                                 
         CLI   RAVLNCAT,C'V'        "HPV" IS A NEW UPGD,                        
         BNE   *+8                                                              
         MVI   OURBYTE,1             SO VALUES ALWAYS HAVE 1 DEC PRECSN         
         BAS   RE,FUEDTLFT          IS A NUMERIC VALUE                          
         BAS   RE,FUINSCH                                                       
         BAS   RE,FUMOVE                                                        
FUHPT039 EQU   *                                                                
*                                                                               
         B     FUPG100                                                          
                                                                                
*                                                                               
** Y4S UPGRADE **                                                               
*                                                                               
FUY4S    DS    0H                                                               
         MVC   0(3,R2),=C'Y4S'                                                  
         LA    R2,3(R2)                                                         
*                                                                               
         B     FUPG100                                                          
                                                                                
*                                                                               
** PINDEX & PIM UPGRADE **                                                      
*                                                                               
FUPIX    DS    0H                                                               
         MVC   0(2,R2),=C'PI'                                                   
         B     FUPSI                                                            
                                                                                
*                                                                               
** SINDEX & SIM UPGRADE **                                                      
*                                                                               
FUSIX    DS    0H                                                               
         MVC   0(2,R2),=C'SI'                                                   
         B     FUPSI                                                            
                                                                                
*                                                                               
*** PINDEX & SINDEX AND PIM & SIM UPGRADE ***                                   
*                                                                               
FUPSI    DS    0H                                                               
         MVC   2(1,R2),RAVLNCAT                                                 
         LA    R0,3                                                             
         CLI   RAVLNCAT,C'N'        WERE BOOKS SPECIFIED?                       
         BNE   *+14                  NO                                         
         MVC   3(3,R2),=C'DEX'       YES, COMPLETE THE WORD "INDEX"             
         LA    R0,6                                                             
         AR    R2,R0                                                            
         MVI   0(R2),UPVALCH                                                    
         LA    R2,1(R2)                                                         
*                                                                               
         DS    0H                  CHECK FOR INVENTORY FILE                     
         TM    RAVLNTYP,X20                                                     
         BZ    *+16                                                             
         MVI   0(R2),C'I'           IF YES, THE "I" S/B IN 2ND POSITION         
         LA    R2,1(R2)                                                         
         BAS   RE,FUINSCH                                                       
*                                                                               
FUPSI030 DS    0H                  FIRST OPERAND                                
         ZICM  R1,RAVLNOP1,(3)                                                  
         STCM  R1,3,DU.RAVLNOP1                                                 
         MVC   BYTE,RAVLNBT                                                     
         BAS   RE,FUBOOK                                                        
         BAS   RE,FUMOVE                                                        
*                                                                               
         DS    0H                  SECOND OPERAND                               
         ZICM  R1,RAVLNOP2,(3)                                                  
         STCM  R1,3,DU.RAVLNOP2                                                 
         BAS   RE,FUINSCH                                                       
         LA    RF,FUBOOK            ASSUME IT'S A BOOK                          
         CLI   RAVLNCAT,C'N'                                                    
         BE    *+8                                                              
         CLI   RAVLNCAT,C'M'                                                    
         BE    *+8                                                              
         LA    RF,FUEDTLFT                                                      
         BASR  RE,RF                                                            
         BAS   RE,FUMOVE            MOVE DATA INTO OUTPUT AREA                  
*                                                                               
         DS    0H                  OPTIONAL ADDITIONAL OPERANDS                 
         CLI   RAVLNCAT,C'N'        APPLICABLE WHEN BOOKS SPECIFIED             
         BE    FUPSI053                                                         
         CLI   RAVLNCAT,C'M'        APPLICABLE WHEN BOOKS SPECIFIED             
         BE    FUPSI053                                                         
         B     FUPIX069                                                         
                                                                                
FUPSI053 DS    0H                                                               
         ZICM  R1,RAVLNOP3,(3)     THIRD OPERAND                                
         BZ    FUPIX069                                                         
         STCM  R1,3,DU.RAVLNOP3                                                 
         BAS   RE,FUINSCH                                                       
         BAS   RE,FUBOOK                                                        
         BAS   RE,FUMOVE                                                        
                                                                                
         ZICM  R1,RAVLNOP4,(3)     FOURTH OPERAND                               
         BZ    FUPIX069                                                         
         STCM  R1,3,DU.RAVLNOP4                                                 
         BAS   RE,FUINSCH                                                       
         BAS   RE,FUBOOK                                                        
         BAS   RE,FUMOVE                                                        
FUPIX069 EQU   *                                                                
*                                                                               
         B     FUPG100                                                          
                                                                                
*                                                                               
** PAVERAGE UPGRADE **                                                          
*                                                                               
FUPVG    DS    0H                                                               
         MVC   0(2,R2),=C'PA'                                                   
         B     FUPSA                                                            
                                                                                
*                                                                               
** SAVERAGE UPGRADE **                                                          
*                                                                               
FUSVG    DS    0H                                                               
         MVC   0(2,R2),=C'SA'                                                   
         B     FUPSA                                                            
                                                                                
*                                                                               
*** PAVERAGE & SAVERAGE UPGRADE ***                                             
*                                                                               
FUPSA    DS    0H                                                               
         MVC   2(1,R2),RAVLNCAT                                                 
         LA    R0,3                                                             
         CLI   RAVLNCAT,C'N'        WERE BOOKS SPECIFIED?                       
         BNE   *+14                  NO                                         
         MVC   2(2,R2),=C'VG'        YES, COMPLETE THE ABBREV "AVG"             
         LA    R0,4                                                             
         AR    R2,R0                                                            
         BAS   RE,FUINSCH                                                       
*                                                                               
         DS    0H                  CHECK FOR INVENTORY FILE                     
         TM    RAVLNTYP,X20                                                     
         BZ    *+16                                                             
         MVI   0(R2),C'I'           IF YES, THE "I" S/B IN 2ND POSITION         
         LA    R2,1(R2)                                                         
         BAS   RE,FUINSCH                                                       
*                                                                               
         B     FUPSI030             USE SAME LOGIC AS PINDEX & SINDEX           
                                                                                
*                                                                               
** DEMO UPGRADE **                                                              
*                                                                               
FUDEM    DS    0H                                                               
         XC    DUB,DUB                                                          
         MVC   DUB+1(2),RAVLNTYP                                                
         TM    DUB+1,X80+X40                                                    
         BNM   *+8                                                              
         XI    DUB+1,X40                                                        
         MVI   DUB+3,XFF           DEMO LIST                                    
         MVI   BYTE,6              OUTPUT TYPE                                  
                                                                                
         MVI   GOSUBN,TDM#                                                      
         GOTO1 AGOSUB                                                           
                                                                                
         MVC   0(6,R2),WORK        DEMO CATEGORY                                
         LA    R2,6(R2)                                                         
*                                                                               
         BAS   RE,FUINSCH                                                       
         ZICM  R1,RAVLNOP1,(3)                                                  
         STCM  R1,3,DU.RAVLNOP1                                                 
         BAS   RE,FUEDTLFT                                                      
         BAS   RE,FUMOVE                                                        
*                                                                               
         B     FUPG100                                                          
         EJECT                                                                  
*                                                                               
** MMU UPGRADE **                                                               
*                                                                               
FUMMU    DS    0H                                                               
         MVC   0(3,R2),=C'MMU'                                                  
         AHI   R2,3                                                             
         BAS   RE,FUINSCH                                                       
*                                                                               
         DS    0H                  FIRST OPERAND                                
         ZICM  R1,RAVLNOP1,(3)                                                  
         STCM  R1,3,DU.RAVLNOP1                                                 
         MVC   BYTE,RAVLNBT                                                     
         BAS   RE,FUBOOK                                                        
         BAS   RE,FUMOVE                                                        
*                                                                               
         DS    0H                  SECOND OPERAND                               
         ZICM  R1,RAVLNOP2,(3)                                                  
         STCM  R1,3,DU.RAVLNOP2                                                 
         MVC   BYTE,RAVLNBT                                                     
         BAS   RE,FUBOOK                                                        
         BAS   RE,FUINSCH                                                       
         BAS   RE,FUMOVE                                                        
                                                                                
*                                                                               
         DS    0H                                                               
         B     FUPG100                                                          
         EJECT                                                                  
                                                                                
                                                                                
FUPG100  DS    0H                  FINISH EDITTING UPGRADE EXPRESSION           
         LA    R0,BUFF+1                                                        
         SR    R2,R0                                                            
         STC   R2,BUFF                                                          
                                                                                
*                                                                               
         J     XIT                                                              
         DROP  R3,DU                                                            
                                                                                
                                                                                
                                                                                
* Helper routine to left-align the editted value in R1.                         
* At exit,                                                                      
*  WORK contains editted value,                                                 
*  HALF = L(editted value).                                                     
                                                                                
         DS    0H                                                               
FUEDTLFT NTR1                                                                   
* NOTE: Since we need to make the number of decimal places soft,                
*        the EDIT macro is expanded here to enable it.                          
                                                                                
*&&DO                                                                           
         EDIT  (R1),(17,WORK),ALIGN=LEFT,WRK=WORK+17,ZERO=NOBLANK               
*&&                                                                             
         LR    R0,R1                                                            
         CVD   R0,DUB                                                           
*                                                                               
         TM    UPGFLAG,UPGFDECP     IF DECIMAL PRECISION FLAG ON                
         BZ    *+8                                                              
         MVI   OURBYTE,1             ALWAYS SET TO ONE DEC PLACE                
*                                                                               
         ZIC   RE,OURBYTE           RE = # OF DECIMAL PLACES                    
         LA    RF,EDTSTRNG+0        RF-->INIT STRING, NO DECIMAL                
         LTR   RE,RE                                                            
         BZ    *+8                                                              
         LA    RF,EDTSTRNG+1        RF-->INIT STRING, >0 DECIMAL                
         MVC   (WORK+17)+00(17),0(RF)                                           
                                                                                
         LA    RF,(WORK+17)+15                                                  
         SR    RF,RE                                                            
         MVI   0(RF),X'21'          "SIGNIFICANCE STARTER" FOR ED INSTR         
         LTR   RE,RE                IF DECIMAL PLACE NEEDED,                    
         BZ    *+8                                                              
         MVI   1(RF),X'4B'           MOVE IN DECIMAL POINT                      
*                                                                               
         ED    WORK+17(17),DUB+2                                                
         MVC   WORK(17),WORK+17+17-(17)                                         
         LA    R0,17                                                            
         CLI   WORK,C' '                                                        
         BNE   *+18                                                             
         MVC   WORK(17),WORK+1                                                  
         MVI   WORK+17-1,C' '                                                   
         BCT   R0,*-18                                                          
*                                                                               
         STH   R0,HALF                                                          
         MVI   OURBYTE,0            RESET # OF DECIMAL PLACES                   
         XIT1                                                                   
                                                                                
                                                                                
                                                                                
* Helper routine to format book value in R1, and booktype in BYTE.              
* At exit,                                                                      
*  WORK contains editted book,                                                  
*  HALF = L(editted book).                                                      
                                                                                
         DS    0H                                                               
FUBOOK   NTR1                                                                   
         STCM  R1,3,TMPBOOK                                                     
         MVC   TMPBTYP,BYTE                                                     
         MVI   TMPWKN,0                                                         
         MVI   GOSUBN,TBK#                                                      
         GOTO1 AGOSUB                                                           
*                                                                               
         SR    R1,R1               GET LENGTH OF FORMATTED BOOK                 
         LA    RF,WORK             WORK CONTAINS FORMATTED BOOK                 
                                                                                
FUBOOK10 DS    0H                                                               
         LA    R1,1(R1)                                                         
         LA    RF,1(RF)                                                         
         CLI   0(RF),C' '                                                       
         BH    FUBOOK10                                                         
         STH   R1,HALF                                                          
         XIT1                                                                   
                                                                                
                                                                                
* Helper routine to move display-able data into output area.                    
* At entry,                                                                     
*   R2-->output area                                                            
*   WORK contains display-able data                                             
*   HALF = L(display-able data to move)                                         
* At exit,                                                                      
*   R2-->next available area for output                                         
* !!WARNING!! Do NOT clobber  WORK, HALF, & RE  in this routine                 
                                                                                
FUMOVE   DS    0H                                                               
         LH    R1,HALF                                                          
         BCTR  R1,0                                                             
         EX    R1,*+4                                                           
         MVC   0(0,R2),WORK                                                     
         AH    R2,HALF                                                          
         BR    RE                                                               
                                                                                
                                                                                
* Helper routine to insert special character that gets passed to UPVAL          
* At entry,                                                                     
*   R2-->output area                                                            
* At exit,                                                                      
*   R2-->next available area for output                                         
* !!WARNING!! Do NOT clobber  RE  in this routine                               
                                                                                
FUINSCH  DS    0H                                                               
         MVI   0(R2),UPVALCH                                                    
         LA    R2,1(R2)                                                         
         BR    RE                                                               
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR02--BIK#)'            
*------------------------ BUILD INVENTORY KEY ------------------------*         
*                                                                               
BINVKEY  DS    0H                                                               
         XC    KEY,KEY                                                          
IVK      USING REINVRCD,KEY                                                     
         MVI   IVK.RINVKTYP,X'12'                                               
         MVC   IVK.RINVKREP,AGENCY                                              
         MVC   IVK.RINVKSTA,IKSTTN                                              
         MVC   IVK.RINVKINV,IKINV                                               
         MVC   IVK.RINVKSTD,IKEFFDB                                             
         MVC   IVK.RINVKSRC,IKKSRC                                              
         MVC   IVK.RINVKBK,IKBOOK                                               
         DROP  IVK                                                              
         J     XIT                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR02--GIR#)'            
*------------------------ GET INVENTORY RECORD -----------------------*         
                                                                                
* Gets an inventory record.  An effective date may or may not be                
*  supplied.  If it is given, routine will look for the record with the         
*  exact or next effective date as the given one.  If it is not given,          
*  routine will just find the record with the latest effective date.            
* At exit,                                                                      
*  CC equal  ==> record was found                                               
*  CC nequal ==> "record not found" situation.  OURERRCD may                    
*                 or may not be set                                             
*  SAVEKEY = key of inventory record attempted to get                           
         PRINT OFF                                                              
* Gets an inventory record.  An effective date may or may not be                
*  supplied.  If it is given, routine will look for the record with the         
*  latest effective date not after the given one.  If it is not given,          
*  routine will just look for the record with the latest effective              
*  date.  In either case, the rest of the key must match the given              
*  input.  Otherwise, "record not found" situation is returned.                 
         PRINT ON                                                               
                                                                                
GINVRCD  DS    0H                                                               
         MVI   OURERRCD,0                                                       
                                                                                
*                                                                               
         DS    0H                                                               
         LA    R6,KEY                                                           
         USING RINVREC,R6                                                       
                                                                                
*                                                                               
** MATCH ON STATION, INVENTORY # **                                             
*                                                                               
         DS    0H                                                               
         MVI   GOSUBN,BIK#                                                      
         GOTO1 AGOSUB                                                           
                                                                                
         ZICM  R0,IKEFFDB,(7)                                                   
         BNZ   *+8                                                              
         LA    R0,1                                                             
         STCM  R0,7,RINVKSTD       (FORCE IN A NON-ZERO DATE)                   
         XC    RINVKSRC,RINVKSRC                                                
         XC    RINVKBK,RINVKBK                                                  
         GOTO1 HIGH                                                             
         CLC   RINVKEY(IKYINVL),KEYSAVE                                         
         BE    *+12                                                             
         MVI   OURERRCD,NHDRQ       NO INVENTORY HEADER                         
         B     GIRXN                 EXIT W/ ERROR                              
                                                                                
*                                                                               
** MATCH ON STATION, INVENTORY #, EFF DATE **                                   
*                                                                               
         DS    0H                  KEY HAS CORRECT STTN & INV#                  
         MVC   SAVEKEY,RINVKEY     HOLD ONTO THE KEY                            
*                                                                               
         OC    IKEFFDB,IKEFFDB     IF EFFECTIVE DATE GIVEN,                     
         BZ    *+10                                                             
         MVC   RINVKSTD,IKEFFDB     MOVE IT INTO KEY                            
*                                                                               
         DS    0H                  CHECK FOR MATCHING EFFECTIVE DATE            
         XC    RINVKSRC,RINVKSRC                                                
         XC    RINVKBK,RINVKBK                                                  
                                                                                
*                                                                               
GIR054   DS    0H                  CHECK NXT REC FOR EQL OR LATER EFFDT         
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(IKYINVL),KEYSAVE                                             
         BNH   *+14                                                             
         MVC   RINVKEY,SAVEKEY                                                  
         B     GIR059                                                           
                                                                                
         OC    IKEFFDB,IKEFFDB                                                  
         BZ    *+14                                                             
         CLC   RINVKSTD,IKEFFDB                                                 
         BNL   GIR059                                                           
                                                                                
         MVC   SAVEKEY,RINVKEY                                                  
         MVI   RINVKSRC,XFF                                                     
         MVC   RINVKBK,=X'FFFF'                                                 
         B     GIR054                                                           
GIR059   EQU   *                                                                
*                                                                               
         CLC   RINVKSTD,IKEFFDB     MAKE SURE EFF DATE IN KEY                   
         BNL   *+12                  IS NOT LOWER THAN THE ONE GIVEN            
         MVI   OURERRCD,NHDRQ                                                   
         B     GIRXN                                                            
                                                                                
*                                                                               
** MATCH ON ENTIRE INVENTORY KEY **                                             
*                                                                               
         DS    0H                  KEY HAS CORRECT STTN, INV#, & EFFDT          
         MVC   RINVKSRC,IKKSRC                                                  
         MVC   RINVKBK,IKBOOK                                                   
                                                                                
         MVC   SAVEKEY,RINVKEY                                                  
                                                                                
*                                                                               
         DS    0H                  READ HIGH FOR RECORD                         
         MVC   RDUPDATE,MYRDUPDT                                                
         TM    MISCFLG1,MF1RDDEL                                                
         BZ    *+8                                                              
         OI    DMINBTS,X08                                                      
         GOTO1 HIGH                                                             
         NI    DMINBTS,XFF-X08                                                  
         CLC   RINVKEY,KEYSAVE                                                  
         BNE   GIRXN               EXIT W/O SETTING ERROR CODE                  
                                                                                
         DS    0H                                                               
         MVC   TRKDA,RINVKEY+(L'RINVKEY+1)    GET DISK ADDRESS                  
                                                                                
*                                                                               
         DS    0H                  GO AND GET THE RECORD                        
         TM    MISCFLG1,MF1RDDEL                                                
         BZ    *+8                                                              
         OI    DMINBTS,X08                                                      
         GOTO1 GETREC                                                           
         NI    DMINBTS,XFF-X08                                                  
                                                                                
         B     GIRXY                                                            
         DROP  R6                                                               
                                                                                
                                                                                
GIRXN    DS    0H                                                               
         J     NO                                                               
GIRXY    DS    0H                                                               
         J     YES                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR02--BST#)'            
*------------------------ BUILD SKELETON TRACK -----------------------*         
                                                                                
* Builds a dummy inventory track with user-inputted key.                        
* At entry,                                                                     
*   SAVEKEY = key to build dummy inventory track with                           
* At exit,                                                                      
*   AIO1 = A(dummy inventory track).                                            
                                                                                
BLDSKLTK DS    0H                                                               
                                                                                
         L     R6,AIO1                                                          
                                                                                
*                                                                               
** CLEAR I/O AREA **                                                            
*                                                                               
         LR    R0,R6                                                            
         LA    R1,L'IO                                                          
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
                                                                                
*                                                                               
** PUT KEY IN **                                                                
*                                                                               
         MVI   GOSUBN,BIK#                                                      
         GOTO1 AGOSUB                                                           
                                                                                
         LR    R3,R6                                                            
         MVC   0(L'RINVKEY,R3),SAVEKEY                                          
         AH    R3,DSP1EL                                                        
                                                                                
*                                                                               
** PUT TRANSFER FROM ELEMENT IN **                                              
*                                                                               
         USING RINVFREL,R3                                                      
         MVI   RINVFRCD,X'03'                                                   
         MVI   RINVFRLN,RINVFRDT-RINVFREL                                       
         MVC   RINVFRST,IKSTTN      STATION                                     
         MVC   RINVFRBK,IKFRBK      FROM BOOK                                   
         MVI   RINVFRTY,C' '                                                    
         MVI   RINVFRPR,C'R'        ROVER                                       
         MVC   RINVFRBT,IKBTYP      BOOKTYPE                                    
         DROP  R3                                                               
                                                                                
         LA    R3,RINVFRDT-RINVFREL(R3)                                         
                                                                                
*                                                                               
** PUT (DEMO) BOOK ELEMENT IN **                                                
*                                                                               
         MVC   0(2,R3),=X'5E07'                                                 
         MVC   2(3,R3),DCFILIUN                                                 
         MVC   5(2,R3),DEFLTBK                                                  
                                                                                
         LA    R3,7(R3)                                                         
                                                                                
*                                                                               
** PUT CODE ELEMENT IN **                                                       
*                                                                               
         USING RINVCEL,R3                                                       
         MVI   RINVCCOD,X'CD'                                                   
         MVI   RINVCLEN,RINVCLNQ                                                
         MVC   RINVCODE,SPACES                                                  
*                                                                               
         TM    MISCFLG1,MF1TDFTP   TRANSFER DEFAULT = TP?                       
         BZ    *+10                                                             
         MVC   RINVCODE,=C'TP'                                                  
*                                                                               
         TM    MISCFLG1,MF1TDFTT   TRANSFER DEFUALT = TT?                       
         BZ    *+10                                                             
         MVC   RINVCODE,=C'TT'                                                  
*                                                                               
*                                                                               
         TM    IKFRBTS,BBEBK                                                    
         BZ    *+8                                                              
         MVI   RINVCSET,C'E'                                                    
         TM    IKFRBTS,BBPBK                                                    
         BZ    *+8                                                              
         MVI   RINVCSET,C'P'                                                    
         TM    IKFRBTS,BBSS                                                     
         BZ    *+8                                                              
         MVI   RINVCSET,C'S'                                                    
         DROP  R3                                                               
                                                                                
         LA    R3,RINVCLNQ(R3)                                                  
                                                                                
*                                                                               
** PUT DAY/TIME ELEMENT IN **                                                   
*                                                                               
         USING RINVZEL,R3                                                       
         MVI   RINVZCOD,X'CE'                                                   
         MVI   RINVZLEN,RINVZLNQ                                                
         MVC   RINVZDAY,HDRIDAY                                                 
         MVC   RINVZTIM,HDRTIME                                                 
         DROP  R3                                                               
                                                                                
         LA    R3,RINVZLNQ(R3)                                                  
                                                                                
*                                                                               
** FINISHED BUILDING SKELETON RECORD **                                         
*                                                                               
         SR    R3,R6                                                            
         LA    R3,1(R3)                                                         
         STCM  R3,3,RINVLEN-RINVREC(R6)                                         
                                                                                
*                                                                               
         J     XIT                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR02--GHI#)'            
*----------------------- GET HEADER INFORMATION ----------------------*         
                                                                                
* Gets header information for the inventory track requested.                    
                                                                                
GTHDRINF DS    0H                                                               
         XC    HDRINFO(HDRINFOL),HDRINFO                                        
*                                                                               
         XC    TMPS(TMPSL),TMPS                                                 
         MVC   TMPDFIL,DCFILIUN                                                 
         MVC   TMPSRC,IKSRC                                                     
         MVC   TMPFRBTS,IKFRBTS                                                 
         MVC   TMPSTTN,IKSTTN                                                   
         MVC   TMPINVN,IKINV                                                    
         GOTO1 DATVAL,DMCB,(0,IROEFFD),WORK                                     
         ICM   R0,15,DMCB          USE 'ICM' AND NOT 'OC' SAVES 2 BYTES         
         BNZ   *+6                                                              
         DC    H'0'                                                             
         GOTO1 DATCON,DMCB,(0,WORK),(2,TMPCDATE)                                
                                                                                
         MVI   GOSUBN,BDB#         GO BUILD DBLOCK                              
         GOTO1 AGOSUB                                                           
*                                                                               
         L     R5,ADBLOCK                                                       
         USING DBLOCKD,R5                                                       
         MVI   DBSTYPE,0           IGNORE WHATEVER WAS PUT HERE                 
                                                                                
         GOTO1 DEMAND,DMCB,DBLOCKD,DEMHOOK2,0,0,0,0                             
         DROP  R5                                                               
*                                                                               
         J     XIT                                                              
         EJECT                                                                  
*                                                                               
** DEMAND HOOK #2 **                                                            
*                                                                               
* At entry,                                                                     
*   R5-->DBLOCK.                                                                
                                                                                
DEMHOOK2 DS    0H                                                               
DHK2     NTR1                                                                   
                                                                                
         USING DBLOCKD,R5                                                       
*                                                                               
         L     RF,DBAREC                                                        
         USING REINVRCD,RF                                                      
*                                                                               
         CLI   RINVKSRC,0          HEADER?                                      
         BNE   DHK2005                                                          
*                                                                               
         TM    RINVATD,X'40'       TP TRANSFER?                                 
         BZ    *+8                                                              
         OI    MISCFLG1,MF1TDFTP                                                
*                                                                               
         TM    RINVATD,X'20'       TT TRANSFER?                                 
         BZ    *+8                                                              
         OI    MISCFLG1,MF1TDFTT                                                
*                                                                               
DHK2005  DS    0H                                                               
         ICM   R6,15,DBEXTEND                                                   
         BZ    DHK2X                                                            
         DROP  R5,RF                                                            
*                                                                               
DHK2012  DS    0H                                                               
         CLC   0(4,R6),=C'RINV'                                                 
         BE    DHK2020                                                          
         ICM   R6,15,4(R6)                                                      
         BNZ   DHK2012                                                          
         B     DHK2X                                                            
*                                                                               
DHK2020  DS    0H                  R6-->EXTENSION LINK                          
         USING DBXINVWK,R6                                                      
         MVC   HDRIDAY,DBXIDAY                                                  
         MVC   HDRTIME,DBXISTIM                                                 
         MVC   HDRPRGNA,DBXIPROG                                                
         MVC   HDRTMCHG,DBXITMCH                                                
         B     DHK2X                                                            
         DROP  R6                                                               
*                                                                               
DHK2X    DS    0H                                                               
         J     XIT                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR02--GFBT#)'           
*--------------------------- GET FROM BITS ---------------------------*         
                                                                                
* This routine gets the BOOKVAL from bits given a source, qualifier,            
*  and a book.                                                                  
* At entry,                                                                     
*   TMPSRC   = rating service                                                   
*   TMPQLFY  = qualifier                                                        
*   TMPBOOK  = book                                                             
* At exit,                                                                      
*   TMPFRBTS = BOOKVAL from bits                                                
                                                                                
GETFRBTS DS    0H                                                               
*                                                                               
** BUILD DUMMY TWA FIELD **                                                     
*                                                                               
         XC    MYFLD(MYFLDL),MYFLD                                              
         LA    R4,MYFLDD                                                        
                                                                                
*                                                                               
         DS    0H                   RATING SERVICE                              
         MVC   0(1,R4),TMPSRC                                                   
         CLI   TMPSRC,C'H'           IF SOURCE IS NHTI,                         
         BNE   *+8                                                              
         MVI   0(R4),C'N'             CHANGE IT TO NSI FOR BOOKVAL              
         MVI   1(R4),C','                                                       
         LA    R4,2(R4)                                                         
*                                                                               
         DS    0H                   QUALIFIER                                   
         CLI   TMPQLFY,C' '                                                     
         BE    *+14                                                             
         MVC   0(1,R4),TMPQLFY                                                  
         LA    R4,1(R4)                                                         
*                                                                               
         DS    0H                   BOOK                                        
         MVC   FULL+0(2),TMPBOOK                                                
         MVI   FULL+2,0                                                         
         GOTO1 DATCON,MYDMCB,(3,FULL),(6,(R4)),0                                
         LA    R4,6(R4)                                                         
*                                                                               
         DS    0H                   SET UP TWA HEADER                           
         LA    R0,MYFLDD                                                        
         SR    R4,R0                                                            
         STC   R4,MYFLDH+5           L(DATA)                                    
         LA    R4,L'MYFLDH(R4)                                                  
         STC   R4,MYFLDH+0           L(TWA FIELD)                               
                                                                                
*                                                                               
** GET BOOKVAL FROM BITS **                                                     
*                                                                               
         GOTO1 BOOKVAL,MYDMCB,MYFLD,(1,DUB),(0,SCANNER),0                       
         CLI   MYDMCB+4,1                                                       
         BE    *+6                                                              
         DC    H'0'                                                             
         MVC   TMPFRBTS,DUB        BOOKVAL FROM BITS                            
                                                                                
*                                                                               
** EXIT ROUTINE **                                                              
*                                                                               
         J     XIT                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR02--GKS#)'            
*--------------------------- GET KEY SOURCE --------------------------*         
                                                                                
* Gets "key source" given the book bits and a rating service.                   
* At entry,                                                                     
*   TMPFRBTS = book bits,                                                       
*   TMPSRC   = rating service.                                                  
*   TMPBTYP  = book type.                                                       
* At exit,                                                                      
*   TMPKSRC  = "key source" and CC set to equal if found,                       
*   CC set to not equal if not found.                                           
                                                                                
GETKSRC  DS    0H                                                               
         MVI   TMPKSRC,0                                                        
                                                                                
         XC    GKSIPARM,GKSIPARM                                                
         XC    GKSOPARM,GKSOPARM                                                
                                                                                
         LA    R1,GKSIPARM                                                      
         USING GKSPARMD,R1                                                      
         MVC   GKSPBKBT,TMPFRBTS                                                
         MVC   GKSPBTYP,TMPBTYP                                                 
         DROP  R1                                                               
         GOTO1 VGETKSRC,DMCB,(C'B',GKSIPARM),GKSOPARM                           
         CLI   DMCB+4,0                                                         
         BNE   GKSXN                                                            
                                                                                
         MVC   TMPKSRC,GKSOPARM+(GKSPKSRC-GKSPARMD)                             
                                                                                
         B     GKSXY                                                            
                                                                                
                                                                                
GKSXN    DS    0H                                                               
         J     NO                                                               
                                                                                
GKSXY    DS    0H                                                               
         J     YES                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR02--RKS#)'            
*------------------------- REVERSE KEY SOURCE ------------------------*         
                                                                                
* Reverses "key source" to get the book bits and book type.                     
* At entry,                                                                     
*   TMPKSRC   = "key source".                                                   
* At exit,                                                                      
*   TMPSRC(1) = rating service,                                                 
*   TMPFRBTS  = book bits,                                                      
*   TMPBTYP   = book type,                                                      
*   TMPQLFY   = qualifier,                                                      
*   CC set to equal if translation okay,                                        
*   CC set to not equal if translation not okay.                                
                                                                                
REVKSRC  DS    0H                                                               
         XC    TMPSRC,TMPSRC                                                    
         MVI   TMPFRBTS,0                                                       
         MVI   TMPBTYP,0                                                        
         MVI   TMPQLFY,C' '                                                     
*                                                                               
         XC    GKSIPARM,GKSIPARM                                                
         XC    GKSOPARM,GKSOPARM                                                
                                                                                
*                                                                               
         DS    0H                  GET RTG SVCE, QLFYR, & BKTYPE                
         LA    R3,GKSIPARM                                                      
         USING GKSPARMD,R3                                                      
         MVC   GKSPKSRC,TMPKSRC                                                 
         DROP  R3                                                               
         GOTO1 VGETKSRC,DMCB,(C'K',GKSIPARM),GKSOPARM                           
         CLI   DMCB+4,0                                                         
         BNE   RKSXN                                                            
                                                                                
         LA    R3,GKSOPARM                                                      
         USING GKSPARMD,R3                                                      
         MVC   TMPSRC(1),GKSPRSVC   RETURN: RATING SERVICE                      
         MVC   TMPBTYP,GKSPBTYP     RETURN: BOOK TYPE                           
         MVC   TMPQLFY,GKSPQLFY     RETURN: QUALIFIER                           
         DROP  R3                                                               
                                                                                
*                                                                               
         DS    0H                  GET BOOKVAL BITS                             
         LA    R3,GKSOPARM                                                      
         USING GKSPARMD,R3                                                      
                                                                                
         DS    0H                   BUILD DUMMY TWA FIELD                       
         XC    MYFLD(MYFLDL),MYFLD                                              
         LA    RE,MYFLDD                                                        
         LR    RF,RE                                                            
         CLI   GKSPQLFY,C' '                                                    
         BE    *+14                                                             
         MVC   0(1,RF),GKSPQLFY                                                 
         LA    RF,1(RF)                                                         
         MVC   0(5,RF),=C'DEC99'     FUDGE IN ANY VALID MONTH/YEAR              
         LA    RF,5(RF)                                                         
         SR    RF,RE                                                            
         STC   RF,MYFLDH+5                                                      
         LA    RF,8(RF)                                                         
         STC   RF,MYFLDH+0                                                      
                                                                                
         GOTO1 BOOKVAL,DMCB,(GKSPRSVC,MYFLD),(1,DUB),SCANNER,0                  
         CLI   DMCB+4,1                                                         
         BNE   RKSXN                                                            
         MVC   TMPFRBTS,DUB         RETURN: BOOKVAL BITS                        
         DROP  R3                                                               
                                                                                
*                                                                               
         B     RKSXY                                                            
                                                                                
                                                                                
RKSXN    DS    0H                                                               
         J     NO                                                               
                                                                                
RKSXY    DS    0H                                                               
         J     YES                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR02--GFN#)'            
*---------------------------- GET FOOTNOTE ---------------------------*         
                                                                                
* Gets footnote of the inventory track requested.                               
                                                                                
GTFTNOTE DS    0H                                                               
         MVC   TRKFTNT,SPACES                                                   
*                                                                               
         XC    TMPS(TMPSL),TMPS                                                 
         MVC   TMPDFIL,DCFILIUN                                                 
         MVC   TMPSRC,IKSRC                                                     
         MVC   TMPFRBTS,IKFRBTS                                                 
         MVC   TMPSTTN,IKSTTN                                                   
         MVC   TMPINVN,IKINV                                                    
         MVC   TMPBOOK,IKBOOK                                                   
         MVC   TMPBTYP,IKBTYP                                                   
         MVC   TMPCDATE,IKEFFDC                                                 
         OC    IKEFFDC,IKEFFDC                                                  
         BNZ   GFN009                                                           
         GOTO1 DATVAL,DMCB,(0,IROEFFD),WORK                                     
         ICM   R0,15,DMCB          USE 'ICM' AND NOT 'OC' SAVES 2 BYTES         
         BNZ   *+6                                                              
         DC    H'0'                                                             
         GOTO1 DATCON,DMCB,(0,WORK),(2,TMPCDATE)                                
GFN009   EQU   *                                                                
                                                                                
         MVI   GOSUBN,BDB#         GO BUILD DBLOCK                              
         GOTO1 AGOSUB                                                           
*                                                                               
         L     R5,ADBLOCK                                                       
         USING DBLOCKD,R5                                                       
         GOTO1 DEMAND,DMCB,DBLOCKD,DEMHOOK4,0,0,0,0                             
         DROP  R5                                                               
*                                                                               
         J     XIT                                                              
         EJECT                                                                  
*                                                                               
** DEMAND HOOK #4 **                                                            
*                                                                               
* At entry,                                                                     
*   R5-->DBLOCK.                                                                
                                                                                
DEMHOOK4 DS    0H                                                               
DHK4     NTR1                                                                   
                                                                                
         USING DBLOCKD,R5                                                       
         MVC   WORK,SPACES                                                      
         GOTO1 DEFINE,MYDMCB,=C'TRAK',DBLOCKD,WORK                              
         MVC   TRKFTNT,WORK                                                     
         DROP  R5                                                               
                                                                                
*                                                                               
DHK4X    DS    0H                                                               
         J     XIT                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR02--LTORG && +        
               CONSTANTS)'                                                      
*------------------------- LTORG & CONSTANTS -------------------------*         
         LTORG                                                                  
                                                                                
                                                                                
EDTSTRNG DC    X'404040404040202020202020202020202020'                          
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR02--MISC STUF+        
               F)'                                                              
*--------------------- SUBR02 MISCELLANEOUS STUFF --------------------*         
                                                                                
SUBR02L  EQU   *-SUBR02                                                         
         DS    0CL(X'1000'-SUBR02L+1)                                           
***********************************************************************         
                                                                                
         DROP  R7,R8,RA,RB,RC                                                   
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR03)'                  
***********************************************************************         
*======================= SUBROUTINE POOL THREE =======================*         
                                                                                
* At entry,                                                                     
*   RA-->TWA,                                                                   
*   R8-->SYSD,                                                                  
*   R7-->SPOOLD,                                                                
*   R1-->GEND,                                                                  
*   GOSUBN = equated sub-routine number.                                        
                                                                                
SUBR03Q  EQU   (((*-RMP18+X'0FFF')/X'1000')*X'1000')                            
                                                                                
         ORG   RMP18+SUBR03Q                                                    
SUBR03   NMOD1 0,**1803**                                                       
         LR    RC,R1                                                            
         USING GEND,RC             RC=A(GENCON WORK AREA)                       
         USING CONHEADH-64,RA      RA=A(TWA)                                    
         USING SYSD,R8             R8=A(SYSD)                                   
         USING SPOOLD,R7           R7=A(SPOOL WORK AREA)                        
                                                                                
         ZIC   R1,GOSUBN                                                        
         SH    R1,=Y(R02#)         SUBTRACT FOR SUB-RTN # 3                     
         BCTR  R1,0                                                             
         SLL   R1,2                                                             
         B     R03_00(R1)                                                       
                                                                                
CCV#     EQU   ((R03_01-*)/4+1)+R02#  CALCULATE CUMULATIVE DEMO VALUES          
GDV#     EQU   ((R03_02-*)/4+1)+R02#  GET DEMO VALUES                           
                                                                                
R03_00   DS    0H                                                               
R03_01   B     CALCUMVL               CALCULATE CUMULATIVE DEMO VALUES          
R03_02   B     GTDEMVAL               GET DEMO VALUES                           
                                                                                
R03#     EQU   ((*-R03_00)/4)+R02#                                              
         DC    H'0'                                                             
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR03--CCV#)'            
*----------------------- CALCULATE DEMO VALUES -----------------------*         
                                                                                
* Routine calculates the cumulative demo values of all selected items           
*  in LISTTAB.                                                                  
* At entry,                                                                     
*  LPDEMC = demo category.                                                      
*  SELTYPE = type of selection to process                                       
* At exit,                                                                      
*   BUFF    = cumulative inventory track,                                       
*   CUMDEMV =     "      RTG/SHR/PUT demo values.                               
                                                                                
CALCUMVL DS    0H                                                               
*                                                                               
** CLEAR WORKING AREAS **                                                       
*                                                                               
         LA    R0,BUFF             USE  BUFF  AS A CUMULATIVE AREA              
         LA    R1,2000              2000 BYTES SHOULD BE ENOUGH                 
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
                                                                                
         XC    CUMFCTR,CUMFCTR                                                  
         XC    CUMNQH,CUMNQH                                                    
         XC    CUMSHR(CUMSHRL),CUMSHR                                           
                                                                                
         XC    MATHFAC,MATHFAC                                                  
                                                                                
         CLI   NLTNTRY,0           ANY ENTRIES IN LIST TABLE?                   
         BE    CCVX                 NO, EXIT NOW                                
*                                                                               
** ACCUMULATE SELECTED ENTRIES OF LISTTAB **                                    
*                                                                               
         XC    FNWORK(FNWORKL),FNWORK   CLEAR FOOTNOTE WORK AREA                
*                                                                               
         OI    DEMFLAG1,DF1FRINV        ASSUME FROM INVENTORY FILE              
         NI    DEMFLAG1,XFF-DF1BUNIV    DON'T HAVE BASE UNIVS YET               
*                                                                               
         L     R4,ALISTTAB                                                      
         USING LISTTABD,R4                                                      
                                                                                
CCV032   DS    0H                  START OF LOOP                                
         CLI   0(R4),EOT                                                        
         BE    CCV200                                                           
                                                                                
         MVI   BYTE,LTFSEL                                                      
         CLI   SELTYPE,C'S'                                                     
         BE    CCV033G                                                          
         MVI   BYTE,LTFSELXD                                                    
         CLI   SELTYPE,C'E'                                                     
         BE    CCV033G                                                          
         DC    H'0'                                                             
CCV033G  EQU   *                                                                
         NC    BYTE,LTFLAG         WAS THIS ENTRY SELECTED?                     
         BZ    CCV150               NO, DO NEXT ITEM                            
*                                                                               
*** SET UP DBLOCK ***                                                           
*                                                                               
         XC    TMPS(TMPSL),TMPS                                                 
         MVC   TMPSRC,LTSRC                                                     
                                                                                
CCV042   DS    0H                                                               
         MVC   TMPDFIL,LTFILE                                                   
         MVC   TMPBTYP,LTBTYP                                                   
         MVC   TMPFRBK,LTFRBK                                                   
         MVC   TMPSTTN,LTSTTN                                                   
         MVC   TMPIDAY,LTIDAY                                                   
         MVC   TMPSETM,LTTIME                                                   
         MVC   TMPPURE(2),LTPURE                                                
         MVC   TMPFLAG,LTFLAG                                                   
         MVC   TMPFLAG2,LTFLAG2                                                 
         MVC   TMPINVN,LTINVN                                                   
         MVC   TMPCDATE,LTEFFDT                                                 
         MVI   TMPBEST,0                                                        
         CLI   LTNOR,C'Y'          IF NOR PROGRAM                               
         BNE   *+8                                                              
         MVI   TMPBEST,C'A'         NEED TO USE THE "ALL" OPTION                
         MVI   TMPTMCHG,0          NO ADJSTMNT NEEDED FOR TIME CHG MKT          
                                                                                
         MVI   TMPPGDUR,0          DO NOT WEIGHTING W/ WEEKS                    
         TM    RMPPROFS+RMP_WKWB,RMP_WKWA                                       
         BZ    *+8                                                              
         MVI   TMPPGDUR,C'Y'        UNLESS PROFILE SAYS TO DO SO                
                                                                                
         MVI   GOSUBN,BDB#         GO BUILD DBLOCK                              
         GOTO1 AGOSUB                                                           
         L     R5,ADBLOCK                                                       
         USING DBLOCKD,R5                                                       
*                                                                               
         DS    0H                  MORE THINGS TO SET                           
         OC    DBSELDAY,DBSELDAY                                                
         BNZ   *+14                                                             
         OC    DBSELTIM,DBSELTIM                                                
         BZ    CCV060                                                           
         NI    DEMFLAG1,XFF-DF1WGTOV  NO WEIGHT OVERRIDE W/ DAY & TIME          
*                                                                               
CCV060   DS    0H                  SOME SPECIAL STUFF                           
         CLC   DBSELSTA(4),=C'UNIV'                                             
         BE    CCV065                                                           
         CLC   DBSELSTA(4),=C'TELE'                                             
         BE    CCV065                                                           
         B     CCV069                                                           
                                                                                
CCV065   DS    0H                                                               
         CLC   DBSELBK,=X'590B'    NOV/89                                       
         BNE   CCV069                                                           
         MVC   DBSELRMK(2),=AL2(98)                                             
CCV069   EQU   *                                                                
*                                                                               
         B     CCV100                                                           
         EJECT                                                                  
*                                                                               
*** CALL DEMAND ***                                                             
*                                                                               
CCV100   DS    0H                                                               
         L     R0,AIO3             AIO3 USED AS INTERIM RECORD AREA             
         LA    R1,L'IO                                                          
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE               CLEAR IT PRIOR TO DEMAND CALLS               
                                                                                
         XC    TOTSHR(TOTSHRL),TOTSHR   CLEAR SHARE ACCUMULATOR AREA            
         NI    DEMFLAG1,XFF-DF1RSTDC    RESET FLAGS BEFORE DEMAND CALL          
                                                                                
         DS    0H                                                               
         CLI   DBFILE,C'I'                                                      
         BNE   *+10                                                             
         MVC   DBFILE,DCFILIUN                                                  
                                                                                
         DS    0H                                                               
         MVI   DMDCALLR,C'C'       DEMAND CALLER IS "CALC-CUM-VALUES"           
         XC    DMCB(6*4),DMCB                                                   
         GOTO1 DEMAND,DMCB,DBLOCKD,DEMHOOK3                                     
*                                                                               
         DS    0H                                                               
         TM    DEMFLAG1,DF1RDOK    DID WE MAKE IT INTO HOOK OKAY?               
         BZ    CCV150               NOPE, MOVE TO NEXT ENTRY                    
*                                                                               
         DS    0H                                                               
         TM    DEMFLAG1,DF1HKMAD   DID HOOK DO A  MAD  OPERATION?               
         BZ    CCV125               NOPE, NO NEED TO UNWEIGH                    
                                                                                
         L     R6,AIO3                                                          
         ZICM  R0,DBDIVSOR,(3)     USE DBDIVSOR FROM DEMAND CALL                
         ST    R0,DIVISOR                                                       
         MVI   GOSUBN,UNW#                                                      
         GOTO1 AGOSUB                                                           
                                                                                
         ST    R0,DIVISOR                                                       
         LA    R2,TOTSHR                                                        
         LA    R3,HOMSHR                                                        
         BAS   RE,DIVSHR           UNWEIGH TOTAL SHARES INTO HOMSHR             
CCV125   EQU   *                                                                
         PRINT OFF                                                              
*&&DO                                                                           
                                                                                
*                                                                               
*** GET H/P/T LINE FOR INTERIM RECD ***                                         
*                                                                               
         DS    0H                  INVENTORY-IZE INTERIM RECORD                 
         L     R3,AIO1              R3-->ORIGINAL INVENTORY RECORD              
         L     R6,AIO3              R6-->INTERIM RECORD (FROM HOOK)             
         USING RINVREC,R6                                                       
         MVC   RINVKEY,0(R3)        COPY KEY OVER TO INTERIM RECD               
*                                                                               
         DS    0H                   COPY ELEMENTS OVER TO INTERIM REC           
         LA    R3,(RINVPEL-RINVREC)(R3)                                         
CCV132   DS    0H                                                               
         CLI   0(R3),0                                                          
         BE    CCV139                                                           
                                                                                
         L     RF,ARM18WRK                                                      
         L     RF,(ATBELCPY-RM18WRKD)(RF)   SEE IF ELEM S/B COPIED OVER         
CCV134   DS    0H                                                               
         CLI   0(RF),EOT             IF END OF TABLE,                           
         BE    CCV138                 ELEMENT IS NOT TO BE COPIED               
         CLC   0(1,R3),0(RF)                                                    
         BE    CCV136                                                           
         LA    RF,L'TABELCPY(RF)                                                
         B     CCV134                                                           
                                                                                
CCV136   DS    0H                                                               
         GOTO1 HELLO,DMCB,(C'P',=C'REPFILE'),(R6),(R3),0                        
         CLI   12(R1),0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
                                                                                
CCV138   DS    0H                  BUMP TO NEXT ELEMENT IN ORIG TRACK           
         ZIC   R0,1(R3)                                                         
         AR    R3,R0                                                            
         B     CCV132                                                           
*                                                                               
CCV139   EQU   *                                                                
                                                                                
                                                                                
         MVI   FROMTYPE,FRMTYPIV   ASSUME RECD FROM INVENTORY FILE              
         MVC   DBFILE,DCFILINV       RECORD FROM INVENTORY FILE?                
         BE    *+12                   YES                                       
         MVI   FROMTYPE,0             NO, RESET FROM TYPE                       
         NI    DEMFLAG1,XFF-DF1FRINV   AND TURN OFF FLAG                        
                                                                                
         BAS   RE,CCVHPT           INTERIM NEEDS H/P/T FOR INV HDR TIME         
         DROP  R6                                                               
*&&                                                                             
         PRINT ON                                                               
                                                                                
                                                                                
         DS    0H                  MAD INTERIM RECD TO CUMULATIVE AREA          
         MVC   MTHIFIL,DCFILINV                                                 
         MVC   MTHOFIL,DCFILINV                                                 
         MVC   MTHOSRC,=C'NSI'                                                  
         LA    R0,1                USE WEIGHT OF 1                              
         TM    DEMFLAG1,DF1ADCMB    FOR A TOTAL CUMULATIVE VALUE                
         BNZ   CCV143X                                                          
         ZIC   R0,LTWGTOV          USE OVERRIDE WEIGHT                          
         CLI   SELTYPE,C'S'                                                     
         BNE   *+12                                                             
         TM    LTFLAG,LTFSELWT+LTFXFRWT IF ANY EXISTS                           
         BNZ   CCV143X                                                          
         IC    R0,LTWTOVXD                                                      
         CLI   SELTYPE,C'E'                                                     
         BNE   *+12                                                             
         TM    LTFLAG,LTFSLWTXD                                                 
         BNZ   CCV143X                                                          
         ZICM  R0,DBDIVSOR,(3)     USE DBDIVSOR FROM DEMAND CALL                
CCV143X  EQU   *                                                                
         ST    R0,MTHFCTR                                                       
                                                                                
         DS    0H                                                               
         MVI   GOSUBN,CDBK#                                                     
         GOTO1 AGOSUB                                                           
                                                                                
         MVC   DBFILE,DCFILINV                                                  
         MVI   DBINTFIL,C'I'                                                    
         MVI   DBINTMED,C'U'                                                    
         MVI   DBACTMED,C'U'                                                    
         MVI   DBACTSRC,C'N'                                                    
         MVC   DBCOMFCS,ACOMFACS                                                
         MVC   DBSELAGY,TWAAGY                                                  
         L     RE,AIO3                                                          
         ST    RE,DBAREC                                                        
         LA    RE,(RINVPEL-RINVREC)(RE)                                         
         ST    RE,DBAQUART                                                      
                                                                                
         L     RF,DBCOMFCS                                                      
         L     RF,(CDEMOMTH-COMFACSD)(RF)                                       
         GOTO1 (RF),DMCB,=C'MAD',AIO3,BUFF,MATHFAC                              
                                                                                
         LA    R3,CUMSHR                                                        
         BAS   RE,GETSHR           ACCUMULATE SHARES IN CUMSHR                  
                                                                                
         DS    0H                                                               
         A     R0,CUMFCTR          UPDATE CUMULATIVE FACTOR TO                  
         ST    R0,CUMFCTR           ACCOUNT FOR MULTIPLE DEMAND CALLS           
         DROP  R5                                                               
         EJECT                                                                  
*                                                                               
*** BUMP TO NEXT LISTTAB ENTRY ***                                              
*                                                                               
CCV150   DS    0H                                                               
         LA    R4,LISTTABQ(R4)                                                  
         B     CCV032                                                           
         DROP  R4                                                               
         EJECT                                                                  
*                                                                               
** FINISHED ACCUMULATING SELECTED LISTTAB ENTRIES **                            
*                                                                               
CCV200   DS    0H                  UNWEIGH CUMULATIVE RECORD                    
         LA    R0,1                                                             
         CLI   OPVCUMTB,C'T'                                                    
         BE    CCV204X                                                          
         L     R0,CUMFCTR                                                       
CCV204X  EQU   *                                                                
         LTR   R0,R0               IF CUMULATIVE FACTOR IS ZERO,                
         BZ    CCV209X              THERE'S NOTHING TO UNWEIGH                  
         ST    R0,DIVISOR                                                       
         LA    R6,BUFF                                                          
         MVI   GOSUBN,UNW#                                                      
         GOTO1 AGOSUB                                                           
                                                                                
         DS    0H                                                               
         MVC   DIVISOR,CUMFCTR                                                  
         LA    R2,CUMSHR                                                        
         LA    R3,HOMSHR                                                        
         BAS   RE,DIVSHR           UNWEIGH CUMULATIVE SHRES INTO HOMSHR         
CCV209X  EQU   *                                                                
                                                                                
*                                                                               
*** INVENTORY-IZE CUMULATIVE RECORD ***                                         
*                                                                               
         DS    0H                                                               
         L     R3,AIO1             R3-->ORIGINAL INVENTORY RECORD               
         LA    R6,BUFF                                                          
         USING RINVREC,R6                                                       
         MVC   RINVKEY,0(R3)       COPY KEY OVER TO CUMULATIVE RECD             
*                                                                               
         DS    0H                  COPY ELEMENTS OVER TO CUMULATIVE REC         
         LA    R3,(RINVPEL-RINVREC)(R3)                                         
CCV212   DS    0H                                                               
         CLI   0(R3),0                                                          
         BE    CCV219                                                           
                                                                                
         L     RF,ARM18WRK                                                      
         L     RF,(ATBELCPY-RM18WRKD)(RF)  SEE IF ELEM S/B COPIED OVER          
CCV214   DS    0H                                                               
         CLI   0(RF),EOT            IF END OF TABLE,                            
         BE    CCV218                ELEMENT IS NOT TO BE COPIED                
         CLC   0(1,R3),0(RF)                                                    
         BE    CCV216                                                           
         LA    RF,L'TABELCPY(RF)                                                
         B     CCV214                                                           
                                                                                
CCV216   DS    0H                                                               
         GOTO1 HELLO,DMCB,(C'P',=C'REPFILE'),(R6),(R3),0                        
         CLI   12(R1),0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         DROP  R6                                                               
                                                                                
CCV218   DS    0H                  BUMP TO NEXT ELEMENT IN ORIG TRACK           
         ZIC   R0,1(R3)                                                         
         AR    R3,R0                                                            
         B     CCV212                                                           
*                                                                               
CCV219   EQU   *                                                                
                                                                                
*                                                                               
         DS    0H                  FUDGE X'CD' ELEMENT                          
         LR    R3,R6                                                            
         MVC   DATADISP,DSP1EL                                                  
         MVI   ELCODE,X'CD'                                                     
         BRAS  RE,GETEL                                                         
         BNE   CCV224                                                           
         USING RINVCEL,R3                                                       
         NI    RINVCTYP,XFF-X80     TURN OFF "FROM DATA START W/ '+'"           
         CLI   OPVCUMTB,C'T'                                                    
         BNE   *+8                                                              
         OI    RINVCTYP,X80          UNLESS WE'RE TOTALLING                     
         MVC   RINVCODE,XFCODE      MOVE IN CODE                                
         DROP  R3                                                               
CCV224   EQU   *                                                                
                                                                                
*                                                                               
         DS    0H                  FORCE IN INV HEADER'S DAY/TIME               
         XC    ELEM,ELEM                                                        
         LA    R4,ELEM                                                          
         USING RINVZEL,R4                                                       
*                                                                               
         L     R3,AIO1              R3-->ORIGINAL TRACK                         
         MVI   ELCODE,X'CE'                                                     
         MVC   DATADISP,DSP1EL                                                  
         BRAS  RE,GETEL                                                         
         BNE   CCV227D                                                          
                                                                                
         ZIC   R1,1(R3)                                                         
         BCTR  R1,0                                                             
         EXMVC R1,RINVZEL,0(R3)                                                 
         B     CCV227F                                                          
                                                                                
CCV227D  DS    0H                                                               
         MVI   RINVZCOD,X'CE'                                                   
         MVI   RINVZLEN,RINVZLNQ                                                
         MVC   RINVZBK,FDFRBK                                                   
CCV227F  EQU   *                                                                
*                                                                               
         DS    0H                   PUT INV HDR DAY/TIME INTO TRACK             
         MVC   RINVZDAY,HDRIDAY                                                 
         MVC   RINVZTIM,HDRTIME                                                 
                                                                                
         GOTO1 HELLO,DMCB,(C'P',=C'REPFILE'),(R6),RINVZEL,0                     
         CLI   DMCB+12,0                                                        
         BE    *+6                                                              
         DC    H'0'                                                             
         DROP  R4                                                               
                                                                                
*                                                                               
CCV230   DS    0H                  PUT PROGRAM FOOTNOTE ELEMENT IN              
         LA    R3,ELEM                                                          
         USING RPGMELM,R3                                                       
         XC    RPGMELM(RPGMELML),RPGMELM                                        
         MVI   RPGMELM,X'01'                                                    
         MVI   RPGMELLN,RPGMELML                                                
         MVI   RPGMLIN,1                                                        
         MVC   RPGMNAME,SPACES                                                  
                                                                                
         MVC   TMPBOOK,FNWB1BK                                                  
         MVC   TMPBTYP,FNWB1BT                                                  
         MVI   TMPWKN,0                                                         
         MVI   GOSUBN,TBK#                                                      
         GOTO1 AGOSUB              WORK HAS FORMATTED BOOK                      
*                                                                               
         OC    FNWB2,FNWB2                                                      
         BNZ   CCV232                                                           
*                                                                               
         DS    0H                  USE PROGRAM TITLES FOR FOOTNOTES             
         MVC   RPGMFBK,WORK                                                     
         MVC   RPGMNAME,FNWPROG1                                                
         CLC   FNWPROG1,FNWPROG2                                                
         BE    CCV231X                                                          
         MVI   RPGMNAME+7,C'/'                                                  
         MVC   RPGMNAME+8(7),FNWPROG2                                           
         MVI   RPGMNAME+15,C' '                                                 
CCV231X  EQU   *                                                                
         B     CCV234                                                           
*                                                                               
CCV232   DS    0H                  USE BOOKS FOR FOOTNOTES                      
         MVC   RPGMFBK,=C'MLTBK'    INDICATE MULTIPLE BOOKS                     
         MVC   RPGMNAME(7),WORK     WORK HAS FIRST BOOK FORMATTED               
         MVC   TMPBOOK,FNWB2BK                                                  
         MVC   TMPBTYP,FNWB2BT                                                  
         MVI   GOSUBN,TBK#                                                      
         GOTO1 AGOSUB               WORK HAS SECOND BOOK FORMATTED              
         MVI   RPGMNAME+7,C'/'                                                  
         MVC   RPGMNAME+8(7),WORK                                               
         MVI   RPGMNAME+15,C' '                                                 
         B     CCV234                                                           
*                                                                               
CCV234   DS    0H                  PUT RPGMELM INTO RECORD                      
         GOTO1 HELLO,DMCB,(C'P',=C'REPFILE'),(R6),RPGMELM,0                     
         CLI   12(R1),0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         DROP  R3                                                               
                                                                                
*                                                                               
*** SET ALTERNATE DAY/TIMES FOR PUTs IN CUMULATIVE RECORD ***                   
*                                                                               
         DS    0H                                                               
         CLI   OPVADPNM,0          ANY ALT DAYTIMES FOR PUTS INPUTTED?          
         BE    CCV237X              NOPE!                                       
*                                                                               
         LA    R3,BUFF             CAN WE OVERRIDE DAY/TIME IN RINVZEL?         
         MVI   ELCODE,X'CE'                                                     
         MVC   DATADISP,DSP1EL                                                  
         BRAS  RE,GETEL                                                         
         BNE   CCV237X              NO RINVZEL ELEM--IGNORE ALTRNTE D/T         
                                                                                
         USING RINVZEL,R3                                                       
         MVC   RINVZDAY,OPVADPTB+0 OVERRIDE ALTERNATE DAYS                      
         MVC   RINVZTIM,OPVADPTB+1  AND TIMES FOR DEMUP CALL                    
         DROP  R3                                                               
*                                                                               
         DS    0H                                                               
         XC    ELEM,ELEM                                                        
         LA    R3,ELEM                                                          
         USING RINVMEL,R3                                                       
         MVI   RINVMCOD,RINVMCDQ                                                
         MVI   RINVMLEN,RINVMLNQ                                                
         MVI   RINVMIND,RINVMIADP                                               
         MVC   RINVMDAY,OPVADPTB+0                                              
         MVC   RINVMTIM,OPVADPTB+1                                              
*                                                                               
         GOTO1 HELLO,DMCB,(C'P',=C'REPFILE'),BUFF,RINVMEL,0                     
         CLI   12(R1),0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         DROP  R3                                                               
CCV237X  EQU   *                                                                
                                                                                
*                                                                               
*** APPLY UPGRADE TO CUMULATIVE RECORD ***                                      
*                                                                               
         DS    0H                                                               
         LA    R3,(RINVPEL-RINVREC)(R6)                                         
         MVI   ELCODE,X'5E'        MAKE SURE X'5E' ELEM EXISTS                  
         BRAS  RE,FIRSTEL                                                       
         BNE   CCV249               IF NOT, DON'T UPGRADE RECORD                
                                                                                
*                                                                               
         DS    0H                  SET FROM TYPE                                
         MVI   FROMTYPE,FRMTYPIV    ASSUME FROM INVENTORY FILE                  
         TM    DEMFLAG1,DF1FRINV    IS IT FROM INVENTORY FILE?                  
         BNZ   *+8                   YEP                                        
         MVI   FROMTYPE,0            NOPE                                       
                                                                                
*                                                                               
         DS    0H                                                               
         CLI   OPVUPGNM,0          ANY UPGRADE INPUTTED?                        
         BE    CCV245               NO, GET H/P/T LINE INSTEAD                  
                                                                                
         LA    R6,BUFF             R6-->CUMULATIVE RECORD                       
         USING RINVREC,R6                                                       
         LA    R0,RINVPEL           R0=A(1ST ELEMENT)                           
                                                                                
         DS    0H                                                               
         MVI   OURBYTE,0                                                        
         CLI   MYTAPEP,C'Y'                                                     
         BNE   *+8                                                              
         MVI   OURBYTE,C'I'                                                     
         XC    DEMODUB,DEMODUB                                                  
         MVC   DEMODUB+0(4),=C'RI2='    PASS IN                                 
         MVC   DEMODUB+4(2),RINVKREP     2-CHAR REP CODE                        
         MVC   DEMODUB+6(1),HDRTMCHG     TIME CHANGE FLAG                       
         MVC   BYTE,RINVREC+DMKIVRQ     REMEMBER DATA @ RINVREC+DMKIVRQ         
         MVI   RINVREC+DMKIVRQ,0        PREVENT UT/TP PROBLEM                   
         GOTO1 DEMUP,DMCB,(FROMTYPE,(R0)),(OURBYTE,OPVUPGTB),ACOMFACS, +        
               DEMODUB,HOMSHR                                                   
         MVC   RINVREC+DMKIVRQ(1),BYTE  RESTORE  DATA @ RINVREC+DMKIVRQ         
         DROP  R6                                                               
                                                                                
         DS    0H                  ADD UPGRADE ELEM TO CUMULATIVE RECD          
         GOTO1 HELLO,DMCB,(C'P',=C'REPFILE'),BUFF,OPVUPGTB,0                    
         CLI   12(R1),0                                                         
         BE    CCV249                                                           
         DC    H'0'                                                             
                                                                                
*                                                                               
CCV245   DS    0H                  NO UPGRADE FORMULA--GET H/P/T LINE           
         LA    R6,BUFF              POINT R6 TO CUMULATIVE RECORD               
         BAS   RE,CCVHPT             AND GET H/P/T LINE FOR IT                  
                                                                                
*                                                                               
CCV249   EQU   *                                                                
                                                                                
*                                                                               
*** RESTORE DAY/TIME (X'CE') ELEMENT INTO TRACK ***                             
*                                                                               
         DS    0H                                                               
         GOTO1 HELLO,DMCB,(C'D',=C'REPFILE'),(X'CE',(R6)),0,0                   
*                                                                               
         L     R3,AIO1                                                          
         MVC   DATADISP,DSP1EL                                                  
         MVI   ELCODE,X'CE'                                                     
         BRAS  RE,GETEL                                                         
                                                                                
CCV254B  DS    0H                                                               
         BNE   CCV254X                                                          
         GOTO1 HELLO,DMCB,(C'P',=C'REPFILE'),(R6),(R3),0                        
         CLI   DMCB+12,0                                                        
         BE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         BRAS  RE,NEXTEL                                                        
         B     CCV254B                                                          
CCV254X  EQU   *                                                                
                                                                                
                                                                                
                                                                                
CCVX     DS    0H                                                               
         J     XIT                                                              
         EJECT                                                                  
* DEMAND hook #3.  We take the demo records passed back by DEMAND and           
*  accumulate them into an interim record.  The procedure for getting           
*  each demo record accounted for in the interim record is a three-             
*  step process:                                                                
*   1) get demo record into IUN format,                                         
*   2) convert from IUN format to IUN record, and                               
*   3) multiply by factor and add results to the interim record.                
* At entry,                                                                     
*   R4-->LISTTAB entry,                                                         
*   R5-->DBLOCKD.                                                               
                                                                                
DEMHOOK3 DS    0H                                                               
DHK3     NTR1                                                                   
         USING LISTTABD,R4                                                      
         USING DBLOCKD,R5                                                       
*                                                                               
         DS    0H                  CHECKS FOR SPECIFIC FILE DATA                
         CLC   DBFILE,DCFILPAV                                                  
         BE    DHK3PAV                                                          
                                                                                
         B     DHK3005                                                          
                                                                                
                                                                                
DHK3PAV  DS    0H                  FILE = PAV                                   
         L     RF,DBAQUART                                                      
         USING PHELEM,RF                                                        
         MVI   TMPNOR,C'N'         ASSUME NOT NORMAL PROGRAM                    
         CLI   PHDTYPE,1           0=NORMAL, 1=FULL CYCLE                       
         BE    *+8                                                              
         MVI   TMPNOR,C'Y'          IT'S A NORMAL PROGRAM                       
         DROP  RF                                                               
                                                                                
         CLC   LTNOR,TMPNOR                                                     
         BNE   DHK3PNO                                                          
*                                                                               
         DS    0H                   MATCH ON ACTIVE WEEKS                       
         MVC   WORK,SPACES                                                      
         GOTO1 DEFINE,DMCB,=C'WEEK',DBLOCKD,WORK                                
         CLI   DBSELMED,C'N'       BYPASS WEEKS COMPARISON                      
         BE    *+14                                                             
         CLC   LTWKS,WORK                                                       
         BNE   DHK3PNO                                                          
*                                                                               
         DS    0H                   PAV RECORD IS GOOD                          
         B     DHK3005                                                          
*                                                                               
DHK3PNO  DS    0H                                                               
         ZICM  RF,DBDIVSOR,(3)                                                  
         ZICM  RE,DBFACTOR,(3)                                                  
         SR    RF,RE                                                            
         STCM  RF,3,DBDIVSOR                                                    
                                                                                
         B     DHK3X                                                            
         EJECT                                                                  
*                                                                               
DHK3005  DS    0H                  SAVE OFF DBLOCK IN DEMAND CALL               
         OI    DEMFLAG1,DF1RDOK     MADE IT INTO THE HOOK                       
*                                                                               
         L     R0,ASVDBLK                                                       
         LA    R1,SVDBLCKX-SVDBLOCK                                             
         LA    RE,DBLOCKD                                                       
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
                                                                                
*                                                                               
         DS    0H                  HANDLE PROGRAM TITLE FOOTNOTES               
         OC    FNWB1,FNWB1          IF VERY FIRST BOOK,                         
         BNZ   *+16                                                             
         MVC   FNWB1BK,DBACTBK       REMEMBER ACTUAL BOOK                       
         MVC   FNWB1BT,DBBTYPE       AND BOOK TYPE                              
                                                                                
         OC    FNWB2,FNWB2          IF SOMETHING IN HERE ALREADY,               
         BNZ   DHK3007B              WE'RE USING BOOKS FOR FOOTNOTE             
         CLC   FNWB1BK,DBACTBK      IF CURRENT BK <> 1ST BOOK,                  
         BNE   DHK3007B              WE'RE USING BOOKS FOR FOOTNOTE             
         CLC   FNWB1BT,DBBTYPE      IF CURRENT BT <> 1ST BOOK TYPE,             
         BNE   DHK3007B              WE'RE USING BOOKS FOR FOOTNOTE             
         B     DHK3007G             ELSE, KEEP USING PRG NAMES                  
DHK3007B MVC   FNWB2BK,DBACTBK                                                  
         MVC   FNWB2BT,DBBTYPE                                                  
         B     DHK3007X                                                         
                                                                                
DHK3007G DS    0H                   GET PROGRAM NAMES FOR FOOTNOTE              
         MVC   WORK,SPACES                                                      
         LA    RE,=C'PROGRA'                                                    
         MVI   MYDMCB,6                                                         
         CLI   DBFILE,C'I'                                                      
         BNE   *+12                                                             
         LA    RE,=C'TRAK'                                                      
         MVI   MYDMCB,4                                                         
         STCM  RE,7,MYDMCB+1                                                    
         GOTO1 DEFINE,MYDMCB,,DBLOCKD,WORK                                      
                                                                                
         LA    RF,WORK                                                          
         MVC   FNWPROG2,0(RF)                                                   
         OC    FNWPROG1,FNWPROG1                                                
         BNZ   *+10                                                             
         MVC   FNWPROG1,0(RF)                                                   
         B     DHK3007X                                                         
                                                                                
DHK3007X EQU   *                                                                
                                                                                
*                                                                               
         DS    0H                                                               
         CLI   DMDCALLR,C'G'       DID "GET-DEM-VALUE" RTN CALL DEMAND?         
         BNE   *+14                 YES, AND                                    
         CLC   DBFILE,DCFILIUN       IS THIS AN INVENTORY ITEM?                 
         BE    DHK3100                YES, JUST COPY IT TO INTERIM RECD         
                                                                                
*                                                                               
         L     R2,AIO3             AIO3 USED AS INTERIM AREA                    
         CLI   0(R2),0             HAS IT BEEN INITIALIZED?                     
         BNE   DHK3010                                                          
         USING RINVREC,R2                                                       
         MVI   RINVKTYP,X'12'               NO, SET IT UP--INV REC CODE         
         MVC   RINVLEN,=Y(RINVPEL-RINVREC)  DUMMY IUN RECORD LENGTH             
         DROP  R2                                                               
*                                                                               
DHK3010  DS    0H                                                               
         ZICM  R0,DBFACTOR,(3)     USE WEIGHT SET BY DEMAND                     
         ST    R0,MTHFCTR          SET FACTOR                                   
         ST    R5,MTHCFACS         SET A(DBLOCK) IN MATHBLOCK                   
         MVC   MTHIFIL,DCFILINV                                                 
         MVC   MTHOFIL,DCFILINV                                                 
         MVC   MTHOSRC,=C'NSI'                                                  
*                                                                               
         LA    R3,TOTSHR           ACCUMULATE SHARES INTO TOTSHR                
         BAS   RE,GETSHR                                                        
*                                                                               
         L     R3,AIUNWRK                                                       
         LR    R0,R3                                                            
         LA    R1,IUNWRKL                                                       
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE               CLEAR IUN WORK AREA                          
*                                                                               
         USING RINVREC,R3                                                       
         MVI   RINVKTYP,X'12'               NO, SET IT UP--INV REC CODE         
         MVC   RINVLEN,=Y(RINVPEL-RINVREC)  DUMMY RECORD LENGTH                 
         DROP  R3                                                               
                                                                                
         LA    R3,1000(R3)                                                      
         USING IUNRECD,R3                                                       
                                                                                
         GOTO1 REGETIUN,MYDMCB,(10,DBLOCKD),IUNRECD                             
                                                                                
         L     RF,ASVDBLK                                                       
         CLC   DBFILE-DBLOCK(3,RF),DCFILIUN  <--WAS JUST (,RF) ??               
         BE    DHK3024                                                          
         LA    R0,IUNNEW                                                        
         LA    R1,IUNNEWX-IUNNEW                                                
         LA    RE,IUNOLD                                                        
         LA    RF,IUNOLDX-IUNOLD                                                
         MVCL  R0,RE               COPY OLD VALUES TO NEW                       
DHK3024  EQU   *                                                                
                                                                                
         DS    0H                                                               
         CLI   MYTAPEP,C'Y'        IF IMPRESSIONS BASED,                        
         BNE   DHK3035X                                                         
         L     R2,ARM18WRK                                                      
         AHI   R2,BASEUNIV-RM18WRKD                                             
         TM    DEMFLAG1,DF1BUNIV      AND DON'T HAVE BASE UNIV YET,             
         BNZ   DHK3035M                                                         
         MVC   0(BASEUNVL,R2),IUNIVS   GO GET THEM                              
         OI    DEMFLAG1,DF1BUNIV                                                
         B     DHK3035X                                                         
DHK3035M DS    0H                     OTHERWISE,                                
         MVI   GOSUBN,NMVL#            GO NORMALIZE DEMO VALUES                 
         GOTO1 AGOSUB                                                           
         MVC   IUNIVS(IUNNVALS*4),0(R2) AND USE THE BASE UNIVERSES              
DHK3035X EQU   *                                                                
                                                                                
         DS    0H                  SET SHARE VALUES IN IUN RECORD               
         GOTO1 DEMOUT,MYDMCB,(C'L',SHARES),DBLOCKD,ISHOMES,0                    
*                                                                               
         DS    0H                  SET UP DBLOCK FOR DEMAINT CALL               
         MVI   GOSUBN,CDBK#         CLEAR DBLOCK POINTED TO BY R5               
         GOTO1 AGOSUB                                                           
                                                                                
         MVC   DBFILE,DCFILINV                                                  
         MVI   DBACTMED,C'U'                                                    
         MVC   DBCOMFCS,ACOMFACS                                                
         MVC   DBSELAGY,TWAAGY                                                  
         L     RE,ASVDBLK                                                       
         MVC   DBACTBK,(DBACTBK-DBLOCK)(RE)                                     
         MVC   DBFACTOR,(DBFACTOR-DBLOCK)(RE)                                   
         MVC   DBDIVSOR,(DBDIVSOR-DBLOCK)(RE)                                   
         MVC   DBTAPEP,(DBTAPEP-DBLOCK)(RE)                                     
         L     RE,AIUNWRK                                                       
         ST    RE,DBAREC           SET A(RECORD)                                
         LA    RE,(RINVPEL-RINVREC)(RE)                                         
         ST    RE,DBAQUART         SET A(QH ELEM)                               
         LA    R0,IUNRECL/4                                                     
         STCM  R0,3,DBNUMVLS       SET NUMBER OF VALUES                         
         L     RF,DBCOMFCS                                                      
         L     RF,(CDEMAINT-COMFACSD)(RF)                                       
         MVC   OFORMAT(7),=C'INVUIUN'                                           
         MVC   OFORMAT+7(2),=X'530B'                                            
         CLI   DBTAPEP,C'Y'                                                     
         BNE   *+10                                                             
         MVC   OFORMAT+7(2),=X'5A0B'                                            
         MVI   OFORMAT+9,0                                                      
         GOTO1 (RF),MYDMCB,=C'PUT',DBLOCKD,IUNRECD,OFORMAT                      
         DROP  R3                                                               
                                                                                
         DS    0H                                                               
         MVI   DBINTFIL,C'I'       FORCE INTERNAL FILE = "INVENTORY"            
         MVI   DBINTMED,C'U'       FORCE INTERNAL MEDIA = "UPGRADE"             
         MVI   DBACTSRC,C'N'       FORCE ACTUAL SOURCE = NIELSEN                
         L     RF,DBCOMFCS                                                      
         L     RF,(CDEMOMTH-COMFACSD)(RF)                                       
         GOTO1 (RF),MYDMCB,=C'MAD',DBAREC,AIO3,MATHFAC                          
         OI    DEMFLAG1,DF1HKMAD                                                
*                                                                               
         B     DHK3800                                                          
         EJECT                                                                  
DHK3100  DS    0H                  COPY RECORD TO INTERIM RECORD                
         CLC   DBFILE,DCFILIUN      FOR INVENTORY TRACKS                        
         BE    DHK3110                                                          
         B     DHK3195                                                          
                                                                                
*                                                                               
DHK3110  DS    0H                                                               
         L     RE,DBAREC                                                        
         ZICM  RF,(RINVLEN-RINVREC)(RE),(3)                                     
         L     R0,AIO3                                                          
         LR    R1,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
DHK3195  EQU   *                                                                
         B     DHK3800                                                          
         EJECT                                                                  
DHK3800  DS    0H                  RESTORE DBLOCK USED IN DEMAND CALL           
         LA    R0,DBLOCKD                                                       
         LA    R1,DBLOCK1X-DBLOCK1                                              
         L     RE,ASVDBLK                                                       
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
*                                                                               
DHK3X    DS    0H                                                               
         J     XIT                                                              
         DROP  R4,R5                                                            
         EJECT                                                                  
                                                                                
* Routine to get shares and update shares accumulators.                         
* At entry,                                                                     
*   R3-->output area                                                            
*   R5-->DBLOCK.                                                                
                                                                                
         DS    0H                                                               
GETSHR   NTR1                                                                   
         USING DBLOCKD,R5                                                       
         MVC   HALF,DBACTBK        SAVE ACTUAL BOOK                             
         XC    HOMSHR(HOMSHRL),HOMSHR                                           
                                                                                
         OC    DBAQUART,DBAQUART   IF NO DBAQUART,                              
         BZ    GETSHR05X            THERE BE NO SHARES                          
         GOTO1 DEMOUT,MYDMCB,(C'P',DEMOSHR),DBLOCKD,HOMSHR                      
GETSHR05X EQU  *                                                                
                                                                                
         MVC   DBACTBK,HALF        RESTORE ACTUAL BOOK VALUE                    
         DROP  R5                                                               
*                                                                               
         DS    0H                  ACCUMULATE THE SHARES                        
         LA    R0,3                 R0 = COUNTER                                
         SR    R1,R1                R1 = INDEX INTO VALUES                      
                                                                                
GETSHR10 DS    0H                                                               
         L     RE,HOMSHR(R1)                                                    
         MH    RE,MTHFCTR+2                                                     
         LR    RF,RE                                                            
         A     RE,0(R1,R3)                                                      
         ST    RE,0(R1,R3)         UPDATE SHARES                                
         LA    R1,4(R1)                                                         
         BCT   R0,GETSHR10                                                      
*                                                                               
         J     XIT                                                              
         EJECT                                                                  
                                                                                
* Routine to divide accumulated shares by accumulated weighting factor.         
* At entry,                                                                     
*   R2      = A(accumulated shares),                                            
*   R3      = A(output area),                                                   
*   DIVISOR = accumulated factor.                                               
                                                                                
         DS    0H                                                               
DIVSHR   NTR1                                                                   
         LA    R0,3                R0 = COUNTER                                 
         MVI   GOSUBN,DIV#         DIVIDE ROUTINE                               
                                                                                
DIVSHR10 DS    0H                                                               
         SR    RE,RE                                                            
         L     RF,0(R2)                                                         
         STM   RE,RF,DIVIDEND      SET TOTAL WEIGHTED SHARE IN DIVIDEND         
         GOTO1 AGOSUB                                                           
         MVC   0(4,R3),QUOTIENT    QUOTIENT HAS UNWEIGHTED SHARE                
                                                                                
         LA    R2,4(R2)                                                         
         LA    R3,4(R3)                                                         
         BCT   R0,DIVSHR10                                                      
*                                                                               
         J     XIT                                                              
         EJECT                                                                  
* Routine to get H/P/T line for inventory-ized records.                         
* At entry,                                                                     
*   R6-->inventory-ized record                                                  
*   HOMSHR = home shares                                                        
*   MYTAPEP = precision indicator--c'Y' means to do imp-based calcs             
*   FROMTYPE = from file indicator--c'I' means came from inventory file         
                                                                                
CCVHPT   NTR1                                                                   
         USING RINVREC,R6                                                       
         XC    DUMUPGD,DUMUPGD     BUILD FORCED UPGRADE ELEMENT                 
                                                                                
*                                                                               
** BUILD UPGRADE ELEMENT **                                                     
*                                                                               
         DS    0H                   BUILD INDEX  100  UPGRADE                   
         XC    WORK,WORK                                                        
         MVC   WORK+8(6),=C'IX,100'                                             
         MVI   WORK+0,14                                                        
         MVI   WORK+5,6                                                         
         GOTO1 UPVAL,DMCB,(1,WORK),DUMUPGD,ACOMFACS                             
         CLI   DUMUPGD+1,0         CHECK ELEM LENGTH FOR ERROR                  
         BNE   *+6                                                              
         DC    H'0'                 SOMETHING'S SCREWED UP!                     
                                                                                
*                                                                               
** CALL DEMUP TO GET H/P/T **                                                   
*                                                                               
         XC    DEMODUB,DEMODUB                                                  
         MVC   DEMODUB+0(4),=C'RI2='    PASS IN                                 
         MVC   DEMODUB+4(2),RINVKREP     2-CHAR REP CODE                        
         MVC   DEMODUB+6(1),HDRTMCHG     TIME CHANGE FLAG                       
         LA    R0,RINVPEL                                                       
         MVI   OURBYTE,0                                                        
         CLI   MYTAPEP,C'Y'                                                     
         BNE   *+8                                                              
         MVI   OURBYTE,C'I'                                                     
         MVC   BYTE,RINVREC+DMKIVRQ     REMEMBER DATA @ RINVREC+DMKIVRQ         
         MVI   RINVREC+DMKIVRQ,0        PREVENT UT/TP PROBLEM                   
         GOTO1 DEMUP,DMCB,(FROMTYPE,(R0)),(OURBYTE,DUMUPGD),ACOMFACS,  +        
               DEMODUB,HOMSHR                                                   
         MVC   RINVREC+DMKIVRQ(1),BYTE  RESTORE  DATA @ RINVREC+DMKIVRQ         
         DROP  R6                                                               
                                                                                
*                                                                               
         J     XIT                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR03--GDV#)'            
*-------------------------- GET DEMO VALUES --------------------------*         
                                                                                
* Get demo values for a single entry in LISTTAB.                                
* At entry,                                                                     
*   R4-->LISTTAB entry (to pass into DEMHOOK3),                                 
*   Parameters for DEMAND call (fields w/ prefix 'TMP') are set.                
* At exit,                                                                      
*   DEMVALS = RTG/SHR/PUT demo values.                                          
                                                                                
GTDEMVAL DS    0H                                                               
         USING LISTTABD,R4                                                      
*                                                                               
         XC    DEMVALS(DEMVALSL),DEMVALS                                        
*                                                                               
         MVI   GOSUBN,BDB#                                                      
         GOTO1 AGOSUB                                                           
         L     R5,ADBLOCK                                                       
         USING DBLOCKD,R5                                                       
*                                                                               
** CALL DEMAND **                                                               
*                                                                               
         DS    0H                                                               
         L     R0,AIO3             AIO3 USED AS INTERIM RECORD AREA             
         LA    R1,L'IO                                                          
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE               CLEAR IT PRIOR TO DEMAND CALLS               
                                                                                
         XC    TOTSHR(TOTSHRL),TOTSHR   CLEAR SHARE ACCUMULATOR AREA            
         NI    DEMFLAG1,XFF-DF1BUNIV    DON'T HAVE BASE UNIVS YET               
         NI    DEMFLAG1,XFF-DF1RSTDC    RESET FLAGS BEFORE DEMAND CALL          
*                                                                               
         DS    0H                                                               
         MVI   DMDCALLR,C'G'       DEMAND CALLER IS "GET-DEMO-VALUES"           
         XC    DMCB(6*4),DMCB                                                   
         GOTO1 DEMAND,DMCB,DBLOCKD,DEMHOOK3                                     
*                                                                               
** UNWEIGH INTERIM RECORD **                                                    
*                                                                               
         DS    0H                                                               
         TM    DEMFLAG1,DF1RDOK    DID WE MAKE IT INTO HOOK OKAY?               
         BZ    GDV125               NOPE!                                       
*                                                                               
         DS    0H                                                               
         TM    DEMFLAG1,DF1HKMAD   DID HOOK DO A  MAD  OPERATION?               
         BZ    GDV125               NOPE, NO NEED TO UNWEIGH                    
         PRINT OFF                                                              
*&&DO                                                                           
*                                                                               
         CLI   DBFILE,C'I'                                                      
         BNE   *+10                                                             
         MVC   DBFILE,DCFILINV     USE THIS FILE FOR DEMOMATH                   
*                                                                               
         MVI   DUB,0               NETWORK FUDGE                                
         CLI   DBSELMED,C'N'                                                    
         BNE   *+18                                                             
         MVC   DUB(1),DBSELSRC                                                  
         MVI   DBSELMED,C'T'                                                    
         MVI   DBSELSRC,C'N'                                                    
*                                                                               
         DS    0H                                                               
         LA    R0,DBLOCKD                                                       
         ST    R0,MTHCFACS                                                      
         MVC   MTHIFIL,DCFILINV                                                 
         MVC   MTHOFIL,DCFILINV                                                 
         MVC   MTHOSRC,=C'NSI'                                                  
         ZICM  R0,DBDIVSOR,(3)     USE DBDIVSOR FROM DEMAND CALL                
         ST    R0,MTHFCTR                                                       
                                                                                
         L     RF,ACOMFACS                                                      
         L     RF,(CDEMOMTH-COMFACSD)(RF)                                       
         GOTO1 (RF),DMCB,=C'DIVIDE',AIO3,AIO3,MATHFAC                           
         CLI   DUB,0               NON-ZERO MEANS RESET FROM FUDGE              
         BE    *+14                                                             
         MVI   DBSELMED,C'N'                                                    
         MVC   DBSELSRC,DUB                                                     
*&&                                                                             
         PRINT ON                                                               
*                                                                               
         L     R6,AIO3                                                          
         ZICM  R0,DBDIVSOR,(3)     USE DBDIVSOR FROM DEMAND CALL                
         ST    R0,DIVISOR                                                       
         MVI   GOSUBN,UNW#                                                      
         GOTO1 AGOSUB                                                           
GDV125   EQU   *                                                                
                                                                                
*                                                                               
** EXTRACT DEMO VALUES **                                                       
*                                                                               
         L     R6,AIO3                 POINT R6 TO INTERIM RECORD               
         LA    RF,DEMOLIST                                                      
         ST    RF,ADEMLIST             SET ADDRESS OF THE DEMO LIST             
         MVI   GOSUBN,XDV#                                                      
         GOTO1 AGOSUB                                                           
         MVC   DEMVALS(DEMVALSL),THISDEMV                                       
*                                                                               
         J     XIT                                                              
         DROP  R4                                                               
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR03--LTORG && +        
               CONSTANTS)'                                                      
*------------------------- LTORG & CONSTANTS -------------------------*         
         LTORG                                                                  
                                                                                
                                                                                
DEMOSHR  DS    0XL3                                                             
         DC    X'81',C'S',AL1(1)                                                
         DC    X'81',C'S',AL1(2)                                                
         DC    X'81',C'S',AL1(3)                                                
         DC    X'FF'                                                            
                                                                                
SHARES   DS    0XL3                                                             
         DC    X'00',C'S',AL1(1)                                                
         DC    X'00',C'S',AL1(2)                                                
         DC    X'00',C'S',AL1(3)                                                
         DC    X'FF'                                                            
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR03--MISC STUF+        
               F)'                                                              
*--------------------- SUBR03 MISCELLANEOUS STUFF --------------------*         
                                                                                
SUBR03L  EQU   *-SUBR03                                                         
         DS    0CL(X'1000'-SUBR03L+1)                                           
***********************************************************************         
                                                                                
         DROP  R7,R8,RA,RB,RC                                                   
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR04)'                  
***********************************************************************         
*======================== SUBROUTINE POOL FOUR =======================*         
                                                                                
* At entry,                                                                     
*   RA-->TWA,                                                                   
*   R8-->SYSD,                                                                  
*   R7-->SPOOLD,                                                                
*   R1-->GEND,                                                                  
*   GOSUBN = equated sub-routine number.                                        
                                                                                
SUBR04Q  EQU   (((*-RMP18+X'0FFF')/X'1000')*X'1000')                            
                                                                                
         ORG   RMP18+SUBR04Q                                                    
SUBR04   NMOD1 0,**1804**                                                       
         LR    RC,R1                                                            
         USING GEND,RC             RC=A(GENCON WORK AREA)                       
         USING CONHEADH-64,RA      RA=A(TWA)                                    
         USING SYSD,R8             R8=A(SYSD)                                   
         USING SPOOLD,R7           R7=A(SPOOL WORK AREA)                        
                                                                                
         ZIC   R1,GOSUBN                                                        
         SH    R1,=Y(R03#)         SUBTRACT FOR SUB-RTN # 3                     
         BCTR  R1,0                                                             
         SLL   R1,2                                                             
         B     R04_00(R1)                                                       
                                                                                
DIV#     EQU   ((R04_01-*)/4+1)+R03#  DIVIDE LOGIC                              
QTM#     EQU   ((R04_02-*)/4+1)+R03#  CONVERT QH TO MILITARY TIME               
TBK#     EQU   ((R04_03-*)/4+1)+R03#  TRANSLATE BOOK                            
TID#     EQU   ((R04_04-*)/4+1)+R03#  TRANSLATE INTERNAL DAY                    
TMT#     EQU   ((R04_05-*)/4+1)+R03#  TRANSLATE MILITARY TIME                   
TWK#     EQU   ((R04_06-*)/4+1)+R03#  TRANSLATE WEEKS                           
TPUR#    EQU   ((R04_07-*)/4+1)+R03#  TRANSLATE PURE NUMBER                     
TDM#     EQU   ((R04_08-*)/4+1)+R03#  TRANSLATE DEMO                            
LNS#     EQU   ((R04_09-*)/4+1)+R03#  LOCATE NXT AVAILABLE LISTTAB SLOT         
CND#     EQU   ((R04_10-*)/4+1)+R03#  COUNT # OF DAYS                           
TSL#     EQU   ((R04_11-*)/4+1)+R03#  TEST FOR SELECTION                        
PSL#     EQU   ((R04_12-*)/4+1)+R03#  PROCESS SELECT FIELDS                     
SST#     EQU   ((R04_13-*)/4+1)+R03#  SELECTED SAME AS TRACK?                   
SPRV#    EQU   ((R04_14-*)/4+1)+R03#  SAVE PREVIOUS VALUES                      
RPRV#    EQU   ((R04_15-*)/4+1)+R03#  RESTORE PREVIOUS VALUES                   
STI#     EQU   ((R04_16-*)/4+1)+R03#  SAVE (TABLES IN) TIA AREA                 
RTI#     EQU   ((R04_17-*)/4+1)+R03#  RESTORE (TABLES IN) TIA AREA              
IOV#     EQU   ((R04_18-*)/4+1)+R03#  INITIALIZE OPTION VALUES                  
SOD#     EQU   ((R04_19-*)/4+1)+R03#  SET OPTIONS TO DISPLAY                    
FOF#     EQU   ((R04_20-*)/4+1)+R03#  FORMAT OPTIONS FIELD                      
XFD#     EQU   ((R04_21-*)/4+1)+R03#  EXTRACT FROM DATA                         
                                                                                
R04_00   DS    0H                                                               
R04_01   B     DIVIDE                 DIVIDE LOGIC                              
R04_02   B     QHRTOMIL               CONVERT QH TO MILITARY TIME               
R04_03   B     TRSLTBK                TRANSLATE BOOK                            
R04_04   B     TRSLTIDY               TRANSLATE INTERNAL DAY                    
R04_05   B     TRSLTMTM               TRANSLATE MILITARY TIME                   
R04_06   B     TRSLTWK                TRANSLATE WEEKS                           
R04_07   B     TRSLTPUR               TRANSLATE PURE NUMBER                     
R04_08   B     TRSLTDEM               TRANSLATE DEMO                            
R04_09   B     LNXTSLOT               LOCATE NXT AVAILABLE LISTTAB SLOT         
R04_10   B     COUNTDAY               COUNT NUMBER OF DAYS                      
R04_11   B     TESTSEL                TEST FOR SELECTION                        
R04_12   B     PROCSEL                PROCESS SELECT FIELDS                     
R04_13   B     SELSMTRK               SELECTED SAME AS TRACK?                   
R04_14   B     SAVEPREV               SAVE PREVIOUS VALUES                      
R04_15   B     RSTRPREV               RESTORE PREVIOUS VALUES                   
R04_16   B     SAVETIA                SAVE (TABLES IN) TIA AREA                 
R04_17   B     RSTRTIA                RESTORE (TABLES IN) TIA AREA              
R04_18   B     INITOPTV               INITIALIZE OPTION VALUES                  
R04_19   B     SETOPTDP               SET OPTIONS TO DISPLAY                    
R04_20   B     FMTOPTFD               FORMAT OPTIONS FIELD                      
R04_21   B     XFROMDTA               EXTRACT "FROM" DATA                       
R04#     EQU   ((*-R04_00)/4)+R03#                                              
         DC    H'0'                                                             
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR04--DIV#)'            
*------------------------ GENERIC DIVIDE LOGIC -----------------------*         
                                                                                
* At entry, DIVIDEND, DIVISOR are set.                                          
* At exit, QUOTIENT and REMAINDR are set.                                       
                                                                                
DIVIDE   DS    0H                                                               
         XC    QUOTIENT,QUOTIENT                                                
         XC    REMAINDR,REMAINDR                                                
                                                                                
         ICM   RF,15,DIVISOR       IF DIVISOR IS ZERO,                          
         JZ    XIT                  CALLER GETS ZERO BACK                       
         OC    DIVIDEND,DIVIDEND   IF DIVIDEND IS ZERO                          
         JZ    XIT                  CALLER GETS ZERO BACK ALSO                  
                                                                                
         DS    0H                  CALCULATE QUOTIENT                           
         LM    R0,R1,DIVIDEND                                                   
         SLDA  R0,1                DOUBLE DIVIDEND                              
         DR    R0,RF                                                            
         LTR   R1,R1                                                            
         BM    *+8                                                              
         AH    R1,=H'1'                                                         
         SRA   R1,1                                                             
         ST    R1,QUOTIENT                                                      
                                                                                
         DS    0H                  CALCULATE REMAINDER                          
         AH    R0,=H'1'                                                         
         SRA   R0,1                                                             
         ST    R0,REMAINDR                                                      
                                                                                
         J     XIT                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR04--QTM#)'            
*---------- ROUTINE TO CONVERT QUARTER HOUR TO MILITARY TIME ---------*         
                                                                                
* At entry,                                                                     
*   TMPQHR  = input quarter hour,                                               
*   TMPMED  = media.                                                            
*   TMPQHAF = quarter hour adjustment factor                                    
* At exit,                                                                      
*   TMPMTIM = output military time.                                             
                                                                                
QHRTOMIL DS    0H                                                               
         ZIC   RF,TMPQHAF          RF = 100-BASED ADJUSTMENT FACTOR             
         SHI   RF,100              RF = ZERO-BASED ADJUSTMENT FACTOR            
*                                                                               
         DS    0H                                                               
         SR    R0,R0                                                            
         ZIC   R1,TMPQHR                                                        
         AR    R1,RF               ADD ADJUSTMENT FACTOR TO QH                  
         BNM   *+8                  IF NEGATIVE,                                
         AHI   R1,96                 ADD 96 TO RESULT                           
         CHI   R1,96               IF EQUAL TO OR GREATER END-OF-DAY,           
         BL    *+8                                                              
         SHI   R1,96                SUBTRACT 96 FROM RESULT                     
                                                                                
         D     R0,=F'4'                                                         
         LA    R1,5(R1)            BASE = 5AM IF RADIO,                         
         CLI   TMPMED,C'R'                                                      
         BE    *+8                                                              
         LA    R1,1(R1)             ELSE, BASE = 6AM                            
         CH    R1,=H'24'           TEST AFTER MIDNIGHT                          
         BNH   *+8                                                              
         SH    R1,=H'24'           YES - GO BACK ONE DAY                        
         MH    R1,=H'100'                                                       
         MH    R0,=H'15'                                                        
         AR    R1,R0               R1 CONTAINS MILITARY TIME                    
         STCM  R1,3,TMPMTIM                                                     
*                                                                               
         J     XIT                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR04--TBK#)'            
*--------------------------- TRANSLATE BOOK --------------------------*         
                                                                                
* At entry,                                                                     
*   TMPBOOK = book to translate.                                                
*   TMPBTYP = book type, if applicable.                                         
*   TMPWKN  = week number, if applicable.                                       
* At exit,                                                                      
*   WORK    = converted book.                                                   
                                                                                
TRSLTBK  DS    0H                                                               
                                                                                
         MVC   WORK,SPACES                                                      
*^^TEMPFIX 3/26/96                                                              
         OC    TMPBOOK,TMPBOOK                                                  
         BZ    TBKX                                                             
*^^TEMPFIX                                                                      
         LA    R2,WORK                                                          
         XC    DUB,DUB                                                          
         MVC   DUB(L'TMPBOOK),TMPBOOK                                           
                                                                                
         GOTO1 DATCON,DMCB,(X'83',DUB),(6,(R2))                                 
         MVC   3(2,R2),4(R2)       REMOVE SLASH                                 
         LA    R2,5(R2)                                                         
         MVI   0(R2),C' '                                                       
                                                                                
         CLI   TMPBTYP,0           IF THERE IS A BOOKTYPE,                      
         BE    TBK029                                                           
         MVI   0(R2),C'('           TACK IT ON                                  
         MVC   1(1,R2),TMPBTYP                                                  
         MVI   2(R2),C')'                                                       
         LA    R2,3(R2)                                                         
TBK029   EQU   *                                                                
                                                                                
*                                                                               
         DS    0H                  FORMAT WEEK NUMBER                           
         CLI   TMPWKN,0                                                         
         BE    TBK039                                                           
         MVI   0(R2),C'-'                                                       
         MVC   1(1,R2),TMPWKN                                                   
         OI    1(R2),X'F0'                                                      
         LA    R2,2(R2)                                                         
TBK039   EQU   *                                                                
                                                                                
*                                                                               
TBKX     DS    0H                                                               
         J     XIT                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR04--TID#)'            
*----------------------- TRANSLATE INTERNAL DAY ----------------------*         
                                                                                
* At entry,                                                                     
*   TMPIDAY = day code to translate.                                            
* At exit,                                                                      
*   WORK    = converted day in compressed format,                               
*   BYTE    = length of converted day output.                                   
                                                                                
TRSLTIDY DS    0H                                                               
                                                                                
         MVC   WORK,SPACES                                                      
         XC    DUB,DUB                                                          
         MVC   DUB(L'TMPIDAY),TMPIDAY                                           
*^^TEMPFIX 3/26/96                                                              
         CLI   DUB,0                                                            
         BNE   *+12                                                             
         MVI   BYTE,1                                                           
         B     TIDX                                                             
*^^TEMPFIX                                                                      
         TM    DUB,X'90'           SPECIAL FORMATTING FOR AVG-N                 
         BO    TID050                                                           
                                                                                
         GOTO1 UNDAY,DMCB,DUB,WORK                                              
*                                                                               
         CLI   WORK+7,0            IF L(OUTPUT) IS GREATER THAN 7,              
         BE    TID020                                                           
         MVC   WORK,SPACES          GET IT IN MTWTFSS FORMAT                    
         GOTO1 UNDAY,DMCB,DUB,(X'07',WORK)                                      
*                                                                               
TID020   DS    0H                  DETERMINE LENGTH OF OUTPUT                   
         LA    R0,WORK                                                          
         LA    R1,WORK+6            MAX OUTPUT LEN IS 7                         
         CLI   0(R1),0              FIND FIRST NON-NULL CHARACTER               
         BNE   *+8                                                              
         BCT   R1,*-8                WHILE BUMPING BACKWARDS                    
         SR    R1,R0                SOMETHING'S AMISS IF NEGATIVE               
         BNM   *+6                                                              
         DC    H'0'                                                             
         LA    R1,1(R1)             ADJUST FOR OFF-BY-ONE ERROR                 
         STC   R1,BYTE                                                          
         B     TIDX                                                             
                                                                                
*                                                                               
TID050   DS    0H                  FORMAT SPECIAL AS "AVGn"                     
         MVC   WORK+0(3),=C'AVG'                                                
         MVC   WORK+3(1),DUB                                                    
         OI    WORK+3,X'F0'                                                     
         MVI   BYTE,4                                                           
         B     TIDX                                                             
                                                                                
*                                                                               
TIDX     DS    0H                                                               
         J     XIT                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR04--TMT#)'            
*---------------------- TRANSLATE MILITARY TIME ----------------------*         
                                                                                
* At entry,                                                                     
*   TMPSETM = time(s) to translate.                                             
* At exit,                                                                      
*   WORK    = converted time in AM/PM mode,                                     
*   BYTE    = length of converted time.                                         
                                                                                
TRSLTMTM DS    0H                                                               
                                                                                
         MVC   WORK,SPACES                                                      
         XC    DUB,DUB                                                          
         MVC   DUB(L'TMPSETM),TMPSETM                                           
                                                                                
         GOTO1 UNTIME,DMCB,DUB,WORK                                             
*                                                                               
         DS    0H                  DETERMINE LENGTH OF OUTPUT                   
*^^TEMPFIX 3/26/96                                                              
         CLI   WORK,0                                                           
         BNE   *+8                                                              
         MVI   WORK,C' '                                                        
*^^TEMPFIX                                                                      
         LA    R0,WORK                                                          
         LA    R1,WORK+10           MAX OUTPUT LEN IS 11                        
         CLI   0(R1),0              FIND FIRST NON-NULL CHARACTER               
         BNE   *+8                                                              
         BCT   R1,*-8                WHILE BUMPING BACKWARDS                    
         SR    R1,R0                SOMETHING'S AMISS IF NEGATIVE               
         BNM   *+6                                                              
         DC    H'0'                                                             
         LA    R1,1(R1)             ADJUST FOR OFF-BY-ONE ERROR                 
         STC   R1,BYTE                                                          
*                                                                               
         J     XIT                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR04--TWK#)'            
*-------------------------- TRANSLATE WEEKS --------------------------*         
                                                                                
* At entry,                                                                     
*   TMPWKS  = active weeks to translate.                                        
* At exit,                                                                      
*   WORK(4) = printable active weeks.                                           
                                                                                
TRSLTWK  DS    0H                                                               
         MVC   WORK(4),SPACES                                                   
                                                                                
         TM    TMPWKS,X08                                                       
         BZ    *+8                                                              
         MVI   WORK+0,C'1'                                                      
         TM    TMPWKS,X04                                                       
         BZ    *+8                                                              
         MVI   WORK+1,C'2'                                                      
         TM    TMPWKS,X02                                                       
         BZ    *+8                                                              
         MVI   WORK+2,C'3'                                                      
         TM    TMPWKS,X01                                                       
         BZ    *+8                                                              
         MVI   WORK+3,C'4'                                                      
*                                                                               
         J     XIT                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR04--TPUR#)'           
*----------------------- TRANSLATE PURE NUMBER -----------------------*         
                                                                                
* At entry,                                                                     
*   TMPPURE(2) = pure number to translate.                                      
* At exit,                                                                      
*   WORK(4)    = printable pure number.                                         
                                                                                
TRSLTPUR DS    0H                                                               
         L     R5,ADBLOCK                                                       
         USING DBLOCKD,R5                                                       
         LR    R0,R5                 CLEAR DBLOCK                               
         LA    R1,DBLOCK1X-DBLOCK1                                              
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
         MVC   DBFILE,DCFILPAV       SET UP DBLOCK : FILE (PAV<==>PURE)         
         L     RF,AIO2                                                          
         ST    RF,DBAREC             SET UP DBLOCK : A(RECORD)                  
         USING PRKEY,RF                                                         
         XC    PRKEY(24),PRKEY                                                  
         LA    R0,PRFRSTEL                                                      
         ST    R0,DBAQUART           SET UP DBLOCK : A(1ST ELEMENT)             
         MVC   PRKMINOR,TMPPURE      SET PURE NUMBER IN PAV RECORD              
         DROP  RF                                                               
*                                                                               
         MVC   WORK,SPACES                                                      
         GOTO1 DEFINE,DMCB,=C'PURE',DBLOCKD,WORK+4                              
         MVC   WORK(4),WORK+4+3                                                 
         DROP  R5                                                               
*                                                                               
         J     XIT                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR04--TDM#)'            
*--------------------------- TRANSLATE DEMO --------------------------*         
                                                                                
* At entry,                                                                     
*   DUB  = demo list to translate,                                              
*   BYTE = output type.                                                         
* At exit,                                                                      
*   WORK = converted demo.                                                      
                                                                                
TRSLTDEM DS    0H                                                               
         MVC   WORK,SPACES                                                      
*                                                                               
         L     R5,ADBLOCK                                                       
         USING DBLOCKD,R5                                                       
         MVC   DBFILE,DCFILTP                                                   
         MVC   DBCOMFCS,ACOMFACS                                                
         MVI   DBSELSRC,C'N'                                                    
         MVI   DBSELMED,C'T'                                                    
         MVC   DBSELAGY,TWAAGY                                                  
         GOTO1 DEMOCON,DMCB,(1,DUB),(BYTE,WORK),(C'S',DBLOCKD),0                
         DROP  R5                                                               
*                                                                               
TDMX     DS    0H                                                               
         J     XIT                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR04--LNS#)'            
*-------------------------- LOCATE NEXT SLOT -------------------------*         
                                                                                
* Locates the next available slot and counts the number of entries in           
*  LISTTAB.                                                                     
* At exit,                                                                      
*   ANLTNTRY = A(next avail slot) or nulls if table is full,                    
*   NLTNTRY  = # of entries in table so far.                                    
                                                                                
LNXTSLOT DS    0H                                                               
         XC    ANLTNTRY,ANLTNTRY                                                
*                                                                               
         LA    R0,MXLTNTRY         R0 = LOOP COUNTER                            
         LR    R1,R0                                                            
         L     RF,ALISTTAB         RF-->LIST TABLE                              
                                                                                
LNS10    DS    0H                                                               
         CLI   0(RF),EOT                                                        
         BE    LNS20                                                            
         LA    RF,LISTTABQ(RF)                                                  
         BCT   R0,LNS10                                                         
         B     LNS30                                                            
*                                                                               
LNS20    DS    0H                  FOUND NEXT AVAILABLE SLOT                    
         ST    RF,ANLTNTRY                                                      
         B     LNS30                                                            
*                                                                               
LNS30    DS    0H                  CALC # OF ENTRIES IN TABLE                   
         SR    R1,R0                                                            
         STC   R1,NLTNTRY                                                       
         B     LNSX                                                             
*                                                                               
LNSX     DS    0H                                                               
         J     XIT                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR04--CND#)'            
*------------------------ COUNT NUMBER OF DAYS -----------------------*         
                                                                                
* Counts the number of days specified in TMPIDAY.                               
* At exit,                                                                      
*   TMPNDAY = # of days                                                         
                                                                                
COUNTDAY DS    0H                                                               
         SR    R0,R0                                                            
         SR    RE,RE                                                            
         ZICM  RF,TMPIDAY,(8)                                                   
         SLL   RF,1                                                             
                                                                                
         OR    RF,RF                                                            
         BZ    *+16                                                             
         SLDL  RE,1                                                             
         AR    R0,RE                                                            
         SR    RE,RE                                                            
         B     *-14                                                             
                                                                                
         STC   R0,TMPNDAY                                                       
         J     XIT                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR04--TSL#)'            
*----------------------- MODIFY FOR NEXT INPUT -----------------------*         
                                                                                
* Routine validates the select fields on the screen, and informs if             
*  there is at least one selected item in the ENTIRE list.                      
* At exit,                                                                      
*   FULL = return code--A(fld w/ error) or NULLS if no error                    
                                                                                
TESTSEL  DS    0H                                                               
         NI    SELFLAG1,XFF-SF1AL1ES-SF1AL1ESXD-SF1DEL-SF1DELSEL                
         SR    R2,R2                                                            
         MVI   OURERRCD,0                                                       
         CLI   NLTNTRY,0           ANY ENTRIES IN LIST TABLE?                   
         BE    TSLX                 NO, EXIT NOW                                
*                                                                               
         MVI   COUNTER,1                                                        
         MVC   TMPNLTN,NLTNTRY                                                  
         L     R4,AMLSTDIR                                                      
*                                                                               
** ENTRIES BEFORE THE ONES DISPLAYED ON SCREEN **                               
*                                                                               
TSL020   DS    0H                                                               
         CLI   0(R4),EOT           IF WE ARE AT END OF LIST DIRECTORY,          
         BNE   *+6                                                              
         DC    H'0'                 THEN SOMETHING'S WRONG                      
         CLC   COUNTER,SNLDSPLY    ARE WE AT DISPLAYED ITEMS YET?               
         BE    TSL050               YES, LEAVE THIS LOOP                        
                                                                                
         DS    0H                  CHECK FOR ANY SELECTED ENTRIES               
         TM    SELFLAG1,SF1AL1ES+SF1AL1ESXD                                     
         BO    TSL030               UNLESS WE'VE FOUND ONE ALREADY              
                                                                                
         BAS   RE,TSLPNTRY         POINT R5 TO LISTTAB ENTRY                    
         USING LISTTABD,R5                                                      
         TM    LTFLAG,LTFSEL        WAS THIS ENTRY PREVIOUSLY SELECTED?         
         BZ    *+8                   NOPE                                       
         OI    SELFLAG1,SF1AL1ES     YEP, AT LEAST 1 ENTRY SELECTED             
         TM    LTFLAG,LTFSELXD      WAS THIS ENTRY PREVIOUSLY SELECTED?         
         BZ    *+8                   NOPE                                       
         OI    SELFLAG1,SF1AL1ESXD   YEP, AT LEAST 1 NTRY SEL XPND DEMO         
         DROP  R5                                                               
                                                                                
TSL030   DS    0H                                                               
         BAS   RE,TSLBUMP          BUMP TO NEXT ITEM IN LIST DIRECTORY          
         B     TSL020                                                           
*                                                                               
** ENTRIES BEING DISPLAYED ON SCREEN **                                         
*                                                                               
*** TEST DISPLAY LINES WITH DATA ***                                            
*                                                                               
TSL050   DS    0H                                                               
         LA    R2,IROLDTAH                                                      
         MVI   OURERRCD,ISELQ                                                   
*                                                                               
TSL060   DS    0H                                                               
         CLC   COUNTER,ENLDSPLY    ARE WE PAST DISPLAYED ITEMS YET?             
         BH    TSL100               YEP, LEAVE THIS LOOP                        
                                                                                
         CLI   5(R2),0             DOES THIS SEL FIELD HAVE INPUT?              
         BE    TSL095               NO, THERE IS NOTHING TO VALIDATE            
         BAS   RE,TSLPNTRY          YES, POINT R5 TO LISTTAB ENTRY              
         USING LISTTABD,R5                                                      
*                                                                               
         DS    0H                  VALIDATE 1ST POSITION OF SEL FIELD           
         CLI   8(R2),C'*'           AN '*' IS GOOD                              
         BNE   TSL062                                                           
         TM    LTFLAG,LTFSEL         IF ENTRY WAS PREVIOUSLY SELECTED           
         BO    TSL069                                                           
         B     TSLXN                                                            
                                                                                
TSL062   DS    0H                   AN 'S' IS A VALID SELECT CODE               
         MVC   WORK(1),8(R2)                                                    
         OI    WORK,X40                                                         
         CLI   WORK,SELQWTWK                                                    
         BE    TSL067                                                           
         CLI   WORK,SELQNORM                                                    
         BE    TSL069                                                           
         CLI   WORK,SELQXPDM         SELECT TO EXPAND DEMOS                     
         BNE   *+12                                                             
         CLI   TWAOFFC,C'*'           (ONLY FOR DDS, FOR NOW)                   
         BE    TSL069                                                           
         CLI   WORK,SELQDEL          SELECT TO DELETE                           
         BE    TSL066                                                           
         B     TSLXN                                                            
                                                                                
TSL066   DS    0H                  ENTRY SELECTED FOR DELETION                  
         CLI   5(R2),1                 L(INPUT) MUST = 1                        
         BH    TSLXN                                                            
         CLI   TMPNLTN,1               CAN'T DELETE THE ONLY ENTRY              
         BH    *+12                                                             
         MVI   OURERRCD,CDLEQ                                                   
         B     TSLXN                                                            
         TM    LTFLAG,LTFSEL+LTFSELXD  IF ENTRY NOT SELECTED,                   
         BNZ   TSL066GX                                                         
         TM    SELFLAG1,SF1AL1ES        & NO ENTRIES NORMALLY SELECTED,         
         BO    TSL066GX                                                         
         TM    INPMFLG1,IPF1ALL         & NO INPUT PARMS ENTERRED,              
         BNZ   *+12                                                             
         MVI   OURERRCD,CDTHQ           ENTRY CAN'T BE DELETED                  
         B     TSLXN                                                            
TSL066GX EQU   *                                                                
*                                                                               
         DS    0H                                                               
         ZIC   R1,TMPNLTN          UPDATE TEMP # OF LISTTAB ENTRIES             
         BCTR  R1,0                                                             
         STC   R1,TMPNLTN           TO REFLECT ENTRIES TO BE DELETED            
         B     TSL069                                                           
                                                                                
TSL067   DS    0H                  SELECT CODE = 'W'                            
         CLI   5(R2),1              ONLY ONE CHAR INPUT ALLOWED                 
         BNE   TSLXN                                                            
         ZICM  R0,LTWT_WK,(1)       GET WEIGHT FACTOR W/ WEEKS                  
         BZ    TSLXN                 ERROR, IF ZERO                             
         CVD   R0,DUB                                                           
         UNPK  9(3,R2),DUB          FORMAT # QHS INTO SEL FIELD                 
         OI    9+2(R2),X'F0'                                                    
         MVI   8(R2),SELQNORM       FUDGE IN NORMAL SELECT CODE                 
         MVI   5(R2),4              FUDGE L(INPUT DATA IN SEL FLD)              
         B     TSL069                                                           
                                                                                
TSL069   DS    0H                                                               
         CLI   5(R2),1             IF L(INPUT) = 1,                             
         BE    TSL090               DON'T VALIDATE THIS SEL FLD ANYMORE         
*                                                                               
         DS    0H                  L'INPUT > 1                                  
         CLI   9(R2),C'0'          VALIDATE FOR WEIGHT OVERRIDE                 
         BL    TSL078                                                           
*                                                                               
         ZIC   R1,5(R2)            R1 = L(Actn) INPUT                           
         BCTR  R1,0                R1 = L(WEIGHT INPUT)                         
         LR    R0,R1               USE R0 AS LOOP COUNTER                       
         BCTR  R1,0                USE R1 FOR  EX  INSTRUCTIONS BELOW           
         LA    RF,9(R2)            RF-->WEIGHT INPUT                            
                                                                                
TSL069B  DS    0H                                                               
         CLI   0(RF),C'0'           MAKE SURE EACH CHAR IS BETW/ 0              
         BL    TSLXN                                                            
         CLI   0(RF),C'9'            AND 9 INCLUSIVE                            
         BH    TSLXN                                                            
         LA    RF,1(RF)                                                         
         BCT   R0,TSL069B                                                       
                                                                                
TSL076   DS    0H                                                               
         EXCLC R1,9(R2),=C'000'    WEIGHT OF ZERO IS INVALID                    
         BE    TSLXN                                                            
                                                                                
         EX    R1,*+8              MAKE SURE WEIGHT USED                        
         B     *+10                                                             
         PACK  DUB,8+1(0,R2)                                                    
         CVB   R1,DUB                                                           
         CLM   R1,3,=Y(255)         FITS IN ONE BYTE                            
         BH    TSLXN                                                            
                                                                                
         B     TSL090                                                           
                                                                                
TSL078   DS    0H                                                               
         B     TSLXN                INVALID FOR NOW                             
                                                                                
         DROP  R5                                                               
*                                                                               
TSL090   DS    0H                  SELECT FIELD HAS VALID INPUT                 
         MVC   WORK(1),8(R2)                                                    
         OI    WORK,X40                                                         
         CLI   WORK,SELQXPDM        SELECT TO EXPAND DEMOS                      
         BNE   *+12                                                             
         OI    SELFLAG1,SF1AL1ESXD   HAS ITS OWN FLAG                           
         B     TSL090X                                                          
                                                                                
         CLI   WORK,SELQDEL         SELECT TO DELETE                            
         BNE   *+12                                                             
         OI    SELFLAG1,SF1DEL       HAS ITS OWN FLAG                           
         B     TSL090X                                                          
                                                                                
         OI    SELFLAG1,SF1AL1ES    AT LEAST 1 ENTRY HAS BEEN SELECTED          
TSL090X  EQU   *                                                                
*                                                                               
TSL095   DS    0H                  MOVE ON                                      
         LA    R2,SZLSTLIN(R2)      BUMP R2 TO NEXT SEL FIELD                   
         BAS   RE,TSLBUMP           BUMP LIST DIRECTORY POINTER                 
         B     TSL060                                                           
*                                                                               
*** TEST DISPLAY LINES W/O DATA ***                                             
*                                                                               
TSL100   DS    0H                  R2-->1ST EMPTY DISPLAY LINE                  
         LH    RF,DLASTLLN                                                      
         A     RF,ATWA             RF-->LAST SELECT FIELD ON SCREEN             
         MVI   OURERRCD,IFLDQ                                                   
                                                                                
TSL110   DS    0H                  START OF LOOP                                
         CR    R2,RF                HAVE WE DONE LAST SEL FIELD?                
         BH    TSL150                YES, LEAVE LOOP                            
                                                                                
         CLI   5(R2),0              SHOULD NOT HAVE ANY INPUT HERE              
         BNE   TSLXN                 AN ERROR IF IT DOES                        
         LA    R2,SZLSTLIN(R2)                                                  
         B     TSL110                                                           
*                                                                               
** ENTRIES AFTER THE ONES DISPLAYED ON SCREEN **                                
*                                                                               
TSL150   DS    0H                  R4-->NEXT ENTRY # AFTER LAST DSPLYD          
         SR    R2,R2               SET FOR GOOD "RETURN CODE"                   
         MVI   OURERRCD,0                                                       
         TM    SELFLAG1,SF1AL1ES+SF1AL1ESXD   FIND ANY SEL ENTRIES YET?         
         BO    TSL200               YEP, SKIP THIS SECTION                      
*                                                                               
TSL160   DS    0H                                                               
         CLC   COUNTER,NLTNTRY     HAVE WE GONE THRU ENTIRE LIST?               
         BH    TSL200               YEP, SKIP THIS SECTION                      
                                                                                
         BAS   RE,TSLPNTRY         POINT R5 TO LISTTAB ENTRY                    
         USING LISTTABD,R5                                                      
         TM    LTFLAG,LTFSEL       IF ENTRY WAS PREVIOUSLY SELECTED,            
         BZ    *+8                                                              
         OI    SELFLAG1,SF1AL1ES    WE HAVE AT LEAST 1 SEL ENTRY                
         TM    LTFLAG,LTFSELXD      WAS THIS ENTRY PREVIOUSLY SELECTED?         
         BZ    *+8                   NOPE                                       
         OI    SELFLAG1,SF1AL1ESXD   YEP, AT LEAST 1 NTRY SEL XPND DEMO         
                                                                                
         TM    SELFLAG1,SF1AL1ES+SF1AL1ESXD                                     
         BO    TSL200              EXIT--FOUND WHAT WE'RE LOOKING FOR           
         DROP  R5                                                               
*                                                                               
TSL170   DS    0H                                                               
         BAS   RE,TSLBUMP                                                       
         B     TSL160                                                           
*                                                                               
** GONE THROUGH ENTIRE LIST TABLE **                                            
*                                                                               
TSL200   DS    0H                                                               
         B     TSLX                                                             
*                                                                               
TSLXN    DS    0H                  R2-->SELECT FIELD W/ INVALID INPUT           
         LA    RE,IROOPT1H                                                      
         LH    RF,DLASTINP                                                      
         A     RF,ATWA                                                          
         STM   RE,RF,AMNISTRT      SET START/END TO MDFY FOR NEXT INPUT         
         MVI   GOSUBN,MNI#                                                      
         GOTO1 AGOSUB                                                           
         B     TSLX                                                             
*                                                                               
TSLX     DS    0H                                                               
         ST    R2,FULL             SET "RETURN CODE" ON EXIT                    
         J     XIT                                                              
                                                                                
                                                                                
* Little helper routine to point R5 to the corresponding LISTTAB                
*  entry that R4 is pointing to in the list directory.  Make sure               
*  only R5 gets changed here.                                                   
                                                                                
TSLPNTRY DS    0H                                                               
         ZIC   R5,0(R4)                                                         
         BCTR  R5,0                                                             
         MH    R5,=Y(LISTTABQ)                                                  
         A     R5,ALISTTAB                                                      
         BR    RE                                                               
                                                                                
                                                                                
* Little helper routine to bump R4 to the next item in the list                 
*  directory.  Make sure only R4 and R1 gets changed.                           
                                                                                
TSLBUMP  DS    0H                                                               
         LA    R4,L'MLSTDIR(R4)                                                 
         ZIC   R1,COUNTER                                                       
         LA    R1,1(R1)                                                         
         STC   R1,COUNTER                                                       
         BR    RE                                                               
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR04--PSL#)'            
*----------------------- MODIFY FOR NEXT INPUT -----------------------*         
                                                                                
* Routine processes those entries being displayed on the screen.  It            
*  informs us if an entry got selected or de-selected.                          
                                                                                
PROCSEL  DS    0H                                                               
         NI    SELFLAG1,XFF-SF1SLECT-SF1DSLCT-SF1SLECTXD-SF1DSLCTXD             
         ZICM  R4,SNLDSPLY,(1)                                                  
         BZ    PSLX                                                             
*                                                                               
         STC   R4,COUNTER                                                       
         BCTR  R4,0                                                             
         A     R4,AMLSTDIR                                                      
         LA    R2,IROLDTAH                                                      
*                                                                               
PSL020   DS    0H                 START OF LOOP                                 
         TM    4(R2),X80           FLD GOT INPUT THIS TIME AROUND?              
         BZ    PSL060               NOPE                                        
*                                                                               
         OC    A1SELCH,A1SELCH     FIRST SEL FIELD THAT GOT MODIFIED?           
         BNZ   *+8                                                              
         ST    R2,A1SELCH           YES, HOLD ONTO ITS ADDRESS                  
*                                                                               
         BAS   RE,PSLPNTRY         POINT R5 TO LISTTAB ENTRY                    
         USING LISTTABD,R5                                                      
*                                                                               
         CLI   5(R2),0             IF THERE IS NO INPUT,                        
         BH    PSL030                                                           
         TM    LTFLAG,LTFSELXD      AND PREVSLY SEL FOR EXPAND DEMO,            
         BO    PSL024                                                           
         TM    LTFLAG,LTFSEL        AND THIS ENTRY PREVIOUSLY SELECTED          
         BO    PSL026                                                           
         B     PSL060                                                           
                                                                                
PSL024   DS    0H                  NO INPUT, PRVSLY SEL FOR EXPAND DEMO         
         OI    SELFLAG1,SF1DSLCTXD   FLAG THAT IT GOT DE-SELECTED               
         XI    LTFLAG,LTFSELXD       DE-SELECT IT IN LISTTAB                    
         NI    LTFLAG,XFF-LTFSLWTXD  AND TURN OFF "SEL W/ WGHT" FLAG            
         MVI   LTWTOVXD,0            AND NO WEIGHT IN SELECTION                 
         B     PSL060                                                           
                                                                                
PSL026   DS    0H                  NO INPUT, PRVSLY SELECTED                    
         OI    SELFLAG1,SF1DSLCT     FLAG THAT IT GOT DE-SELECTED,              
         XI    LTFLAG,LTFSEL         AND DE-SELECT IT IN LISTTAB                
         NI    LTFLAG,XFF-LTFSELWT   AND TURN OFF "SEL W/ WGHT" FLAG            
         MVI   LTWGTOV,0             AND NO WEIGHT IN SELECTION                 
         B     PSL060                                                           
                                                                                
*                                                                               
PSL030   DS    0H                  THERE IS INPUT IN SEL FIELD,                 
         MVC   WORK(1),8(R2)                                                    
         CLI   WORK,C'*'            NORMAL SELECT?                              
         BE    PSL036                                                           
         OI    WORK,X40                                                         
         CLI   WORK,SELQXPDM        SELECT TO EXPAND DEMOS?                     
         BE    PSL034                                                           
         CLI   WORK,SELQNORM        NORMAL SELECT?                              
         BE    PSL036                                                           
         CLI   WORK,SELQDEL         SELECT TO DELETE?                           
         BE    PSL038                                                           
         DC    H'0'                                                             
                                                                                
PSL034   DS    0H                  INPUT = "SELECT TO EXPAND DEMOS"             
         TM    LTFLAG,LTFSELXD                                                  
         BO    PSL040                                                           
         OI    SELFLAG1,SF1SLECTXD  FLAG THAT SOMETHING GOT SELECTED            
         XI    LTFLAG,LTFSELXD                                                  
         B     PSL040                                                           
                                                                                
PSL036   DS    0H                  INPUT = "NORMAL SELECT"                      
         TM    LTFLAG,LTFSEL        AND THIS ENTRY PREVIOUSLY NOT SEL,          
         BO    *+12                                                             
         OI    SELFLAG1,SF1SLECT     FLAG THAT IT GOT SELECTED,                 
         XI    LTFLAG,LTFSEL         AND MARK IT IN LISTTAB                     
                                                                                
         TM    LTFLAG,LTFSELXD      WAS ENTRY PRVSLY SEL TO EXPND DEMO?         
         BNO   *+12                  NOPE                                       
         OI    SELFLAG1,SF1DSLCTXD   YES, FORCE IT TO BE DE-SELECTED,           
         XI    LTFLAG,LTFSELXD        & DE-SELECT EXPND DEMO IN LISTTAB         
                                                                                
         B     PSL040                                                           
                                                                                
PSL038   DS    0H                  INPUT = "SELECT TO DELETE"                   
         OI    SELFLAG1,SF1DEL                                                  
         TM    LTFLAG,LTFSEL+LTFSELXD                                           
         BZ    *+8                                                              
         OI    SELFLAG1,SF1DELSEL   INDICATE "DELETE SELECTED ENTRY"            
         OI    LTFLAG,LTFDEL                                                    
         NI    LTFLAG,XFF-LTFSEL-LTFSELXD-LTFSELWT-LTFSLWTXD                    
         MVI   LTWGTOV,0                                                        
         MVI   LTWTOVXD,0                                                       
         B     PSL040                                                           
                                                                                
PSL040   DS    0H                                                               
         CLI   5(R2),1             IF L'INPUT > 1,                              
         BH    PSL045               GET ADDITIONAL SELECT INFORMATION           
                                                                                
         DS    0H                  L(INPUT) = 1                                 
         TM    LTFLAG,LTFSELXD      IS ENTRY SELECTED TO EXPAND DEMO?           
         BNO   PSL041X               NO                                         
         TM    LTFLAG,LTFSLWTXD      YES, WAS THERE A WEIGHT OVERRIDE?          
         BNO   PSL041T                NO                                        
         MVI   LTWTOVXD,0             YES, BUT NO MORE WEIGHT,                  
         XI    LTFLAG,LTFSLWTXD        TURN OFF "SEL W/ WEIGHT" FLAG,           
         OI    SELFLAG1,SF1SLECTXD     AND FLAG AN ENTRY GOT SELECTED           
PSL041T  EQU   *                                                                
         B     PSL059                                                           
PSL041X  EQU   *                                                                
                                                                                
         DS    0H                  L(INPUT) = 1                                 
         TM    LTFLAG,LTFSELWT     WAS ENTRY PREVSLY SELECTED W/ WGHT?          
         BZ    PSL042X              NO                                          
         MVI   LTWGTOV,0            YES, BUT NO MORE WEIGHT THIS TIME,          
         XI    LTFLAG,LTFSELWT       TURN OFF "SEL W/ WGHT" FLAG,               
         OI    SELFLAG1,SF1SLECT     AND FLAG AN ENTRY GOT SELECTED             
         TM    LTFLAG,LTFSLWTXD      WAS THERE A XPND DEM WGT OVERRIDE?         
         BNO   PSL042X                NO                                        
         MVI   LTWTOVXD,0             YES, BUT NO MORE WEIGHT,                  
         XI    LTFLAG,LTFSLWTXD        TURN OFF "SEL W/ WEIGHT" FLAG,           
         OI    SELFLAG1,SF1SLECTXD     AND FLAG AN ENTRY GOT SELECTED           
PSL042X  EQU   *                                                                
         B     PSL059                                                           
                                                                                
PSL045   DS    0H                  GET WEIGHT INPUTTED IN SEL FIELD             
         ZIC   R1,5(R2)                                                         
         SH    R1,=H'2'            R1 = EX L'SOURCE FOR  PACK  INSTRN           
         EX    R1,*+8                                                           
         B     *+10                                                             
         PACK  DUB,8+1(0,R2)       WEIGHT CAN BE 1-3 DIGIT INPUT                
         CVB   R1,DUB                                                           
         LA    RF,LTWTOVXD                                                      
         TM    LTFLAG,LTFSELXD                                                  
         BO    *+8                                                              
         LA    RF,LTWGTOV                                                       
*&&DO                                                                           
         CLM   R1,1,LTWGTOV        SAME AS WEIGHT ALREADY IN LISTTAB?           
*&&                                                                             
         CLM   R1,1,0(RF)          SAME AS WEIGHT ALREADY IN LISTTAB?           
         BE    PSL059                                                           
*&&DO                                                                           
         STC   R1,LTWGTOV           NO, STORE NEW WEIGHT,                       
*&&                                                                             
         STC   R1,0(RF)             NO, STORE NEW WEIGHT,                       
                                                                                
         TM    LTFLAG,LTFSELXD                                                  
         BNO   *+12                                                             
         OI    LTFLAG,LTFSLWTXD      FLAG SEL W/ WEIGHT IN LISTTAB,             
         OI    SELFLAG1,SF1SLECTXD   AND FLAG AN ENTRY GOT SELECTED             
                                                                                
         TM    LTFLAG,LTFSEL                                                    
         BNO   *+12                                                             
         OI    LTFLAG,LTFSELWT       FLAG SEL W/ WEIGHT IN LISTTAB,             
         OI    SELFLAG1,SF1SLECT     AND FLAG AN ENTRY GOT SELECTED             
PSL059   EQU   *                                                                
                                                                                
         DROP  R5                                                               
*                                                                               
                                                                                
PSL060   DS    0H                                                               
         BAS   RE,PSLBUMP          BUMP TO NEXT ITEM IN LIST DIRECTORY          
         CLC   COUNTER,ENLDSPLY                                                 
         BH    PSLX                                                             
         B     PSL020                                                           
*                                                                               
PSLX     DS    0H                                                               
         J     XIT                                                              
                                                                                
                                                                                
* Little helper routine to point R5 to the corresponding LISTTAB                
*  entry that R4 is pointing to in the list directory.  Make sure               
*  only R5 gets changed here.                                                   
                                                                                
PSLPNTRY DS    0H                                                               
         ZIC   R5,0(R4)                                                         
         BCTR  R5,0                                                             
         MH    R5,=Y(LISTTABQ)                                                  
         A     R5,ALISTTAB                                                      
         BR    RE                                                               
                                                                                
                                                                                
* Little helper routine to bump R2 to the next select field, and                
*  R4 to the next item in the list directory.  Make sure only                   
*  R1, R2, and R4 gets changed.                                                 
                                                                                
PSLBUMP  DS    0H                                                               
         LA    R2,SZLSTLIN(R2)                                                  
         LA    R4,L'MLSTDIR(R4)                                                 
         ZIC   R1,COUNTER                                                       
         LA    R1,1(R1)                                                         
         STC   R1,COUNTER                                                       
         BR    RE                                                               
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR04--SST#)'            
*---------------------- SELECTED SAME AS TRACK? ----------------------*         
                                                                                
* Checks if selected entries in LISTTAB matches the demo history                
*  elements in the track                                                        
* At entry,                                                                     
*  AIO = A(original track)                                                      
*  SELTYPE = type of selection to process                                       
                                                                                
SELSMTRK DS    0H                                                               
                                                                                
         CLI   NLTNTRY,0           ANY ENTRIES?                                 
         BE    SSTXN                NO, EXIT W/ CC NEQUAL                       
                                                                                
*                                                                               
** COPY ORIGINAL TRACK **                                                       
*                                                                               
         L     RE,AIO                         A(SOURCE)                         
         ZICM  RF,(RINVLEN-RINVREC)(RE),(3)   L(SOURCE)                         
         L     R0,AIO2                        A(DESTINATION                     
         LR    R1,RF                          L(DESTINATION)                    
         MVCL  R0,RE                                                            
                                                                                
*                                                                               
** START MATCHING SELECTED ENTRIES TO DEMO HISTORY ELEMS **                     
*                                                                               
         MVI   BYTE,SF1AL1ES                                                    
         CLI   SELTYPE,C'S'                                                     
         BE    SST022G                                                          
         MVI   BYTE,SF1AL1ESXD                                                  
         CLI   SELTYPE,C'E'                                                     
         BE    SST022G                                                          
         DC    H'0'                                                             
SST022G  EQU   *                                                                
         NC    BYTE,SELFLAG1       IF NO ENTRIES SELECTED,                      
         BZ    SST100               THEN DON'T BOTHER                           
                                                                                
*                                                                               
         L     R6,AIO2                                                          
         USING RINVREC,R6                                                       
         L     R4,ALISTTAB                                                      
         USING LISTTABD,R4                                                      
         MVI   COUNTER,0                                                        
         MVI   ELCODE,RIDHCDQ      ELCODE AND DATADISP SHOULD                   
         MVC   DATADISP,DSP1EL      REMAIN CONSTANT THROUGOUT ROUTINE           
                                                                                
SST032   DS    0H                  START OF LOOP                                
         TM    LTFLAG,LTFSEL        ENTRY SELECTED?                             
         BZ    SST088                NOPE, IGNORE IT                            
                                                                                
*                                                                               
*** FIND MATCHING DEMO HISTORY ELEM FOR LISTTAB ENTRY ***                       
*                                                                               
         DS    0H                   BUILD DEMO HISTORY ELEMENT                  
         XC    ELEM,ELEM                                                        
         LA    R3,ELEM                                                          
         USING RIDHEL,R3                                                        
         MVI   RIDHCD,RIDHCDQ      ELEMENT CODE                                 
         MVI   RIDHLEN,RIDHELLN       "    LENGTH                               
         MVC   RIDHFIL,LTFILE      DEMO FILE                                    
         MVC   RIDHSRC,LTSRC       DEMO SOURCE                                  
         MVC   RIDHSTTN,LTSTTN     STATION                                      
         MVC   RIDHBK,LTBOOK       BOOK                                         
         MVC   RIDHBTYP,LTBTYP     BOOK TYPE                                    
         MVC   RIDHFRBT,LTFRBTS    FROM BOOK BITS                               
*&&DO                                                                           
         TM    LTFLAG,LTFSELWT     IF SELECTED W/ A WEIGHT,                     
         BZ    *+10                                                             
         MVC   RIDHWTOV,LTWGTOV     MOVE IN WEIGHT OVERRIDE                     
*&&                                                                             
                                                                                
         MVI   BYTE,LTFSELWT                                                    
         LA    RF,LTWGTOV                                                       
         CLI   SELTYPE,C'S'                                                     
         BE    SST035G                                                          
         MVI   BYTE,LTFSLWTXD                                                   
         LA    RF,LTWTOVXD                                                      
         CLI   SELTYPE,C'E'                                                     
         BE    SST035G                                                          
         DC    H'0'                                                             
SST035G  EQU   *                                                                
         NC    BYTE,LTFLAG         IF SELECTED W/ A WEIGHT,                     
         BZ    *+10                                                             
         MVC   RIDHWTOV,0(RF)       MOVE IN WEIGHT OVERRIDE                     
                                                                                
         TM    LTFLAG2,LTF2T4                                                   
         BZ    *+8                                                              
         OI    RIDHFLG,RIDHFTP4                                                 
         TM    OPVCUMTB,C'T'                                                    
         BZ    *+8                                                              
         OI    RIDHFLG,RIDHFTOT                                                 
                                                                                
         CLC   LTFILE,DCFILPAV                                                  
         BE    SST040                                                           
         CLC   LTFILE,DCFILTP                                                   
         BE    SST045                                                           
         CLC   LTFILE,DCFILIUN                                                  
         BE    SST050                                                           
         DC    H'0'                                                             
*                                                                               
SST040   DS    0H                  PAV FILE                                     
         CLI   LTNOR,C'Y'           IF NOR PROGRAM,                             
         BNE   *+8                                                              
         OI    RIDHFLG,RIDHFNOR      TURN FLAG ON                               
         TM    LTFLAG,LTF2PURE      IF REQUESTED BY PURE NUMBER,                
         BZ    *+8                                                              
         OI    RIDHFLG,RIDHFPUR      FLAG IT AS SUCH                            
                                                                                
         MVC   RIDHPURE,LTPURE      MOVE IN PURE NUMBER                         
         B     SST060                                                           
*                                                                               
SST045   DS    0H                  TP  FILE                                     
         MVC   RIDHIDY,LTIDAY       MOVE IN DAYS                                
         MVC   RIDHSETM,LTTIME       AND TIMES                                  
         MVC   RIDHWK,LTWKN          AND WEEK NUMBER                            
         B     SST060                                                           
*                                                                               
SST050   DS    0H                  IUN FILE                                     
         MVC   RIDHINVN,LTINVN      MOVE IN INVENTORY NUMBER                    
         MVC   RIDHEFFD,LTEFFDT      AND EFFECTIVE DATE                         
         B     SST060                                                           
         DROP  R3                                                               
                                                                                
*                                                                               
SST060   DS    0H                  FIND DEMO HIST ELEMENT IN RECORD             
         LR    R3,R6                                                            
         BRAS  RE,GETEL                                                         
         BNE   SSTXN                IF NOT FOUND, SELECTED <> TRACK             
                                                                                
SST062   DS    0H                                                               
         CLI   0(R3),0                                                          
         BE    SSTXN                                                            
         CLC   0(RIDHELLN,R3),ELEM                                              
         BE    SST070                                                           
                                                                                
         ZIC   R0,1(R3)                                                         
         AR    R3,R0                                                            
         B     SST062                                                           
                                                                                
*                                                                               
SST070   DS    0H                  DEMO HISTORY FOUND--DELETE IT                
         LA    RE,RIDHELLN(R3)      RE=A(SOURCE)                                
         ZICM  RF,RINVLEN,(3)                                                   
         AR    RF,R6                                                            
         SR    RF,RE                RF=L(SOURCE)                                
         LR    R0,R3                R0=A(DESTINATION)                           
         LR    R1,RF                R1=L(DESTINATION)                           
         MVCL  R0,RE                SHIFT REST OF RECORD OVER ELEM              
         SR    R0,R6                R0 = NEW LENGTH OF RECORD                   
         STCM  R0,3,RINVLEN                                                     
         B     SST088                                                           
         DROP  R6                                                               
                                                                                
*                                                                               
SST088   DS    0H                  BUMP TO NEXT LISTTAB ENTRY                   
         LA    R4,LISTTABQ(R4)      BUMP POINTER                                
         ZIC   R1,COUNTER           INCREMENT COUNTER                           
         LA    R1,1(R1)                                                         
         CLM   R1,1,NLTNTRY                                                     
         BNL   *+12                                                             
         STC   R1,COUNTER                                                       
         B     SST032                                                           
         DROP  R4                                                               
*                                                                               
         B     SST100                                                           
                                                                                
*                                                                               
** FINISHED LOOPING THROUGH LISTTAB **                                          
*                                                                               
SST100   DS    0H                                                               
         L     R3,AIO2                                                          
         MVI   ELCODE,RIDHCDQ                                                   
         MVC   DATADISP,DSP1EL                                                  
         BRAS  RE,GETEL                                                         
         BE    SSTXN                                                            
         B     SSTXY                                                            
                                                                                
*                                                                               
** EXITS **                                                                     
*                                                                               
SSTXY    DS    0H                                                               
         J     YES                                                              
                                                                                
SSTXN    DS    0H                                                               
         J     NO                                                               
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR04--SPRV# && +        
               RPRV#)'                                                          
*------------------------ SAVE PREVIOUS VALUES -----------------------*         
                                                                                
* This routine saves the pertinent data that the previous transaction           
*  ended up with.  This is done so that if an error is encountered              
*  in a validation routine, then we'll be able to reset them back               
*  for the next time around.                                                    
                                                                                
SAVEPREV DS    0H                                                               
         MVI   BYTE,C'S'                                                        
         BAS   RE,SRDOIT                                                        
*                                                                               
         J     XIT                                                              
                                                                                
                                                                                
*---------------------- RESTORE PREVIOUS VALUES ----------------------*         
                                                                                
RSTRPREV DS    0H                                                               
         MVI   BYTE,C'R'                                                        
         BAS   RE,SRDOIT                                                        
*                                                                               
         J     XIT                                                              
                                                                                
                                                                                
* Little helper routine for save/restore previous values functions.             
                                                                                
         DS    0H                                                               
SRDOIT   NTR1                                                                   
         L     RE,ARM18WRK                                                      
         L     RE,(ASRTAB-RM18WRKD)(RE) RE-->TABLE OF SAVE/RESTORE INFO         
         LA    R4,SRTABQ           R4 = LOOP COUNTER                            
*                                                                               
SRDOIT10 DS    0H                                                               
         ZICM  RF,0(RE),(3)                                                     
         LA    RF,SYSD(RF)                                                      
         L     R0,0(RF)                                                         
                                                                                
         ZICM  RF,2(RE),(3)                                                     
         LA    RF,SYSD(RF)                                                      
         L     R2,0(RF)                                                         
                                                                                
         ZICM  R1,4(RE),(3)                                                     
         LR    R3,R1                                                            
                                                                                
         LA    RF,X'20'            20: R2=A(DESTINATION), R0=A(SOURCE)          
         CLI   BYTE,C'S'                                                        
         BE    SRDOIT20                                                         
         LA    RF,X'02'            02: R0=A(DESTINATION), R2=A(SOURCE)          
         CLI   BYTE,C'R'                                                        
         BE    SRDOIT20                                                         
         DC    H'0'                                                             
                                                                                
SRDOIT20 DS    0H                                                               
         EX    RF,*+8              RF CONTAINS A(2 EVEN-ODD PAIR REGS)          
         B     *+6                                                              
         MVCL  0,0                                                              
                                                                                
         LA    RE,L'SRTAB(RE)                                                   
         BCT   R4,SRDOIT10                                                      
*                                                                               
         J     XIT                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR04--STI# && R+        
               TI#)'                                                            
*--------------------------- SAVE TIA TABLES -------------------------*         
                                                                                
* saves TIA tables into TEMPSTR                                                 
                                                                                
SAVETIA  DS    0H                                                               
         LA    R0,=C'DMWRT'                                                     
         B     SRTIA                                                            
                                                                                
                                                                                
*-------------------------- RESTORE TIA TABLES -----------------------*         
                                                                                
* restores TIA tables from TEMPSTR                                              
                                                                                
RSTRTIA  DS    0H                                                               
         LA    R0,=C'DMREAD'                                                    
         B     SRTIA                                                            
                                                                                
                                                                                
                                                                                
* Little helper routine to save/restore TIA.                                    
                                                                                
SRTIA    DS    0H                                                               
         MVI   DMCB+8,PAGEQ        3RD PARAMETER                                
         MVI   DMCB+9,0                                                         
         MVC   DMCB+10(2),TWATRM                                                
         MVC   DMCB+20(2),=C'L='   6TH PARAMETER                                
         MVC   DMCB+22(2),=Y(TIASVLEN)                                          
         GOTO1 DATAMGR,DMCB,(R0),=C'TEMPSTR',,ATIA,0                            
         J     XIT                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR04--IOV#)'            
*---------------------- INITIALIZE OPTION VALUES ---------------------*         
                                                                                
INITOPTV DS    0H                                                               
         MVI   NOPTN,0             CLEAR # OF OPTIONS                           
         XC    OPTI,OPTI           CLEAR OPTIONS INPUTTED                       
*                                                                               
         LA    R0,OPTVALS                                                       
         LA    R1,OPTVALSQ                                                      
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
         J     XIT                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR04--SOD#)'            
*----------------------- SET OPTIONS TO DISPLAY ----------------------*         
                                                                                
* Routine is called on a change of key.  It looks through the inventory         
*  track of the new key and picks out data to display in the options            
*  field.  This is to help the user see what options were in use when           
*  the track was created or saved.                                              
* At entry,                                                                     
*   AIO = A(inventory record).                                                  
* At exit,                                                                      
*   OPTVALS set to corresponding data found in inventory record.                
                                                                                
SETOPTDP DS    0H                                                               
         TM    DPLYFLG1,DF1OPTTK   SET OPTION VALUES FROM TRACK?                
         BZ    *+10                 NO                                          
         XC    OPTVALS(OPTVALSQ),OPTVALS                                        
                                                                                
*                                                                               
** UPGRADE FORMULAE **                                                          
*                                                                               
         DS    0H                                                               
         TM    DPLYFLG1,DF1OPTTK   SET OPTION VALUES FROM TRACK?                
         BZ    SODUPGX              NO                                          
*^^COCO                                                                         
         PRINT OFF                                                              
*&&DO                                                                           
         TM    IKFRBTS,BBPBK+BBEBK APPLICABLE TO P- OR E- BOOKS                 
         BZ    SODUPGX                                                          
*&&                                                                             
         PRINT ON                                                               
*^^EOCOCO                                                                       
*                                                                               
         L     R3,AIO                                                           
         MVI   ELCODE,X'05'                                                     
         MVC   DATADISP,=Y(RINVPEL-RINVREC)                                     
                                                                                
         BRAS  RE,GETEL                                                         
         B     SODUPG15                                                         
SODUPG10 BRAS  RE,NEXTEL                                                        
SODUPG15 BNE   SODUPGX                                                          
                                                                                
         USING RAVLNEL,R3                                                       
         MVC   BYTE,RAVLNTYP       HOLD ONTO UPGRADE TYPE                       
         TM    BYTE,X80+X40        TEST IF DECIMAL PRECISION                    
         BNM   *+8                                                              
         XI    BYTE,X40             YES, TURN IT OFF FOR COMPARE                
*                                                                               
         L     RE,ARM18WRK                                                      
         L     RE,(AUPGKWTB-RM18WRKD)(RE)  CHK IF UPGD ALLOWED ON SCRN          
SODUPG22 DS    0H                                                               
         CLI   0(RE),EOT           END-OF-TABLE REACHED,                        
         BE    SODUPG10             UPGRADE NOT ALLOWED HERE                    
         ZIC   R1,1(RE)            R1 = MASK BIT VALUE FOR  BNL                 
         CLC   BYTE,0(RE)                                                       
         EX    R1,*+4                                                           
         BC    0,SODUPG25                                                       
         LA    RE,L'UPGKYWTB(RE)                                                
         B     SODUPG22                                                         
                                                                                
SODUPG25 DS    0H                                                               
         MVC   OPVUPGTB,RAVLNEL                                                 
         MVI   OPVUPGNM,1                                                       
         DROP  R3                                                               
*                                                                               
SODUPGX  EQU   *                                                                
                                                                                
*                                                                               
** CUMULATIVE VALUE TYPE **                                                     
*                                                                               
         DS    0H                                                               
         TM    DPLYFLG1,DF1OPTTK   SET OPTION VALUES FROM TRACK?                
         BZ    SODCUMX              NO                                          
                                                                                
*^^COCO                                                                         
         PRINT OFF                                                              
*&&DO                                                                           
         TM    IKFRBTS,BBEBK       APPLICABLE TO E- BOOKS                       
         BZ    SODCUMX                                                          
*&&                                                                             
         PRINT ON                                                               
*^^EOCOCO                                                                       
*                                                                               
         L     R3,AIO                                                           
         MVI   ELCODE,RIDHCDQ                                                   
         BRAS  RE,GETEL                                                         
         BNE   SODCUMX                                                          
                                                                                
         USING RIDHEL,R3                                                        
         TM    RIDHFLG,RIDHFTOT                                                 
         BO    SODCUM20                                                         
         B     SODCUMX                                                          
         DROP  R3                                                               
                                                                                
SODCUM20 DS    0H                                                               
         MVI   OPVCUMTB,C'T'                                                    
         MVI   OPVCUMNM,1                                                       
*                                                                               
SODCUMX  EQU   *                                                                
                                                                                
*                                                                               
** ALTERNATE DAYS & TIMES FOR PUTs **                                           
*                                                                               
         DS    0H                                                               
         TM    DPLYFLG1,DF1OPTTK   SET OPTION VALUES FROM TRACK?                
         BZ    SODADPX              NO                                          
                                                                                
*                                                                               
         DS    0H                                                               
         L     R3,AIO                                                           
         MVI   ELCODE,RINVMCDQ                                                  
         BRAS  RE,GETEL                                                         
         BNE   SODADPX                                                          
*                                                                               
         USING RINVMEL,R3                                                       
         CLI   RINVMIND,RINVMIADP  LOOK FOR ALTERNATE D/T FOR PUTS              
         BNE   SODADPX                                                          
                                                                                
         MVC   OPVADPTB,RINVMDAY                                                
         MVI   OPVADPNM,1                                                       
                                                                                
         MVC   TRKADTP,RINVMDAY    SET TRACK'S EXISTING ALT DAYS/TIMES          
         DROP  R3                                                               
*                                                                               
SODADPX  EQU   *                                                                
                                                                                
*                                                                               
** AUTO-PFM **                                                                  
*                                                                               
         DS    0H                                                               
         MVI   OPVPFMNM,0          NEVER RE-DISPLAY AUTO-PFM OPTION             
         XC    OPVPFMTB(OPVPFMMX*L'OPVPFMTB),OPVPFMTB                           
                                                                                
*                                                                               
         J     XIT                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR04--FOF#)'            
*------------------------ FORMAT OPTIONS FIELD -----------------------*         
                                                                                
* Formats options into options field in SCANNER format.                         
* At entry,                                                                     
*   options to be formatted have values in the OPV fields.                      
* At exit,                                                                      
*   BLOCK = dummy TWA field containing formatted options.                       
                                                                                
FMTOPTFD DS    0H                                                               
         XC    BLOCK(256),BLOCK                                                 
         LA    R2,BLOCK+8                                                       
         L     R4,ARM18WRK                                                      
         L     R4,(AOPTTAB-RM18WRKD)(R4)                                        
         USING OPTDSECT,R4                                                      
                                                                                
*                                                                               
** FORMAT & BUILD OPTIONS INTO BLOCK **                                         
*                                                                               
FOF010   DS    0H                                                               
         CLI   0(R4),EOT           END OF KEYWORD TABLE?                        
         BE    FOF300               YEP, BLOCK CONTAINS ALL OPTIONS             
                                                                                
         ZICM  R5,OPDODSPL,(3)                                                  
         LA    R5,SYSD(R5)                                                      
         CLI   0(R5),0                                                          
         BE    FOF200                                                           
                                                                                
         MVI   COUNTER,0                                                        
         LA    R3,1(R5)            R3-->OPTION DATA VALUE                       
                                                                                
*                                                                               
*** GET OPTION DATA GIVEN OPTION DATA VALUE ***                                 
*                                                                               
FOF030   DS    0H                                                               
         MVI   BUFF,0                                                           
         MVC   BUFF+1(256),BUFF                                                 
                                                                                
         TM    OPDFLAG,OPDFKYWD                                                 
         BO    FOF100                                                           
         TM    OPDFLAG,OPDFVRTN                                                 
         BO    FOF060                                                           
         TM    OPDFLAG,OPDFVTBL                                                 
         BO    FOF080                                                           
         DC    H'0'                                                             
                                                                                
*                                                                               
FOF060   DS    0H                  FORMAT OPTION VALUE VIA ROUTINE              
         MVC   GOSUBN,OPDRTFMT                                                  
         GOTO1 AGOSUB                                                           
         B     FOF100                                                           
                                                                                
*                                                                               
FOF080   DS    0H                  FORMAT OPTION VALUE VIA TABLE                
         ZICM  R6,OPDTBDSP,(3)                                                  
         A     R6,MYBASE1          R6-->TABLE OF VALUES                         
                                                                                
FOF082   DS    0H                                                               
         ZICM  R0,0(R6),(5)        CONTENTS OF R0: 00L100L2                     
         ST    R0,FULL              WHERE, L1 & L2 ARE 1-BYTE LENGTHS           
         LA    R6,2(R6)                                                         
                                                                                
         LH    RF,FULL                                                          
         AR    RF,R6               RF-->INTERNAL OPTION VALUE                   
         LH    R1,FULL+2                                                        
         BCTR  R1,0                                                             
         EXCLC R1,0(R3),0(RF)      MATCH THE ONE IN OPV FIELD?                  
         BE    FOF086                                                           
         LA    RF,1(RF,R1)                                                      
         LR    R6,RF               R6-->NEXT TABLE ENTRY                        
         B     FOF082                                                           
                                                                                
FOF086   DS    0H                                                               
         LH    R1,FULL                                                          
         STC   R1,BUFF                                                          
         BCTR  R1,0                                                             
         EXMVC R1,BUFF+1,0(R6)                                                  
         B     FOF100                                                           
                                                                                
*                                                                               
*** MOVE OPTION KEYWORD & DATA INTO BLOCK ***                                   
*                                                                               
FOF100   DS    0H                                                               
         LA    R0,BLOCK+8          CHECK IF WE NEED TO INSERT COMMA             
         CR    R0,R2                                                            
         BNH   *+6                                                              
         DC    H'0'                                                             
         BE    FOF110                                                           
         MVI   0(R2),C','                                                       
         LA    R2,1(R2)                                                         
                                                                                
*                                                                               
FOF110   DS    0H                  TEST IF KEYWORD NEEDED                       
         CLI   COUNTER,0            IF FIRST OPTION DATA                        
         BE    FOF115                KEYWORD NEEDED                             
                                                                                
         B     FOF130               KEYWORD NOT NEEDED                          
                                                                                
FOF115   DS    0H                  MOVE IN KEYWORD                              
         ZICM  RF,OPDKYTB,(3)                                                   
         LA    RF,OPTDSECT(RF)     RF-->KEYWORD TABLE                           
         ZIC   R1,0(RF)                                                         
         BCTR  R1,0                                                             
         EXMVC R1,0(R2),1(RF)                                                   
         LA    R2,1(R2,R1)                                                      
                                                                                
         TM    OPDFLAG,OPDFKYWD    IF ONLY KEYWORD NEEDED,                      
         BO    FOF150               WE DON'T NEED OPTION DATA                   
         MVI   0(R2),C'='                                                       
         LA    R2,1(R2)                                                         
         B     FOF130                                                           
                                                                                
*                                                                               
FOF130   DS    0H                  MOVE IN OPTION DATA                          
         ZIC   R1,BUFF                                                          
         BCTR  R1,0                                                             
         EXMVC R1,0(R2),BUFF+1                                                  
         LA    R2,1(R2,R1)                                                      
         B     FOF150                                                           
                                                                                
*                                                                               
*** BUMP TO NEXT OPTION DATA VALUE ***                                          
*                                                                               
FOF150   DS    0H                                                               
         ZIC   R1,COUNTER                                                       
         LA    R1,1(R1)                                                         
         CLM   R1,1,0(R5)          HAVE WE DONE THEM ALL YET?                   
         BNL   FOF200               YEP, WE'RE DONE FOR THIS KEYWORD            
         STC   R1,COUNTER                                                       
         ZIC   R1,OPDOLEN                                                       
         AR    R3,R1               BUMP TO NEXT OPTION DATA VALUE               
         B     FOF030                                                           
                                                                                
*                                                                               
*** BUMP TO NEXT OPTION KEYWORD ***                                             
*                                                                               
FOF200   DS    0H                                                               
         ZIC   R1,OPDNTRYL                                                      
         AR    R4,R1                                                            
         B     FOF010                                                           
         DROP  R4                                                               
         EJECT                                                                  
*                                                                               
** PLACE RESULTS IN OPTIONS FIELD **                                            
*                                                                               
FOF300   DS    0H                                                               
         LA    R0,BLOCK+8                                                       
         SR    R2,R0                                                            
         STC   R2,BLOCK+5                                                       
         LA    R2,8(R2)                                                         
         STC   R2,BLOCK                                                         
                                                                                
         L     R3,=A(MGFOPT-RMP18)                                              
         A     R3,MYBASE1                                                       
         MVI   GOSUBN,UMF#                                                      
         GOTO1 AGOSUB                                                           
                                                                                
*                                                                               
         J     XIT                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR04--XFD#)'            
*------------------------ EXTRACT "FROM" DATA ------------------------*         
                                                                                
* At entry,                                                                     
*   AIO = A(inventory record)                                                   
* At exit,                                                                      
*   fields prefixed with 'FD' are filled.                                       
                                                                                
XFROMDTA DS    0H                                                               
         XC    FROMDATA(FROMDATL),FROMDATA                                      
*                                                                               
         L     R6,AIO                                                           
         MVC   DATADISP,DSP1EL                                                  
*                                                                               
         DS    0H                  GET FROM BOOK, STATION, & BOOK TYPE          
         LR    R3,R6                                                            
         MVI   ELCODE,X'03'                                                     
         BRAS  RE,GETEL                                                         
         BNE   XFD020                                                           
         USING RINVFREL,R3                                                      
         MVC   FDFRBK,RINVFRBK                                                  
         MVC   FDSTTN,RINVFRST                                                  
         MVC   FDBTYP,RINVFRBT                                                  
         MVC   FDFTYP,RINVFRTY     FROM TYPE (P/I)                              
                                                                                
         CLI   FDFTYP,C'I'         IF TAPE TRANSFER,                            
         BNE   *+10                                                             
         MVC   FDFILE,DCFILIUN      FORCE FILE TO BE INVENTORY                  
                                                                                
         MVI   GOSUBN,BIL#         BUILD INVENTORY LIST FROM RINVFRDT           
         GOTO1 AGOSUB                                                           
         DROP  R3                                                               
                                                                                
*                                                                               
XFD020   DS    0H                  GET TRANSFER CODE                            
         LR    R3,R6                                                            
         MVI   ELCODE,X'CD'                                                     
         BRAS  RE,GETEL                                                         
         BNE   XFD030                                                           
         USING RINVCEL,R3                                                       
         MVC   XFCODE,RINVCODE                                                  
                                                                                
         TM    RINVCTYP,X40        WAS TRACK CREATED W/ OPROJ?                  
         BZ    XFD022G              NOPE                                        
         MVI   FDFTYP,C'I'          YES, FORCE TYPE                             
         MVC   FDFILE,DCFILIUN       & FILE TO INVENTORY,                       
         L     RF,AINVLIST           AND NULLIFY THE INVENTORY LIST             
         MVI   0(RF),EOT                                                        
XFD022G  EQU   *                                                                
         DROP  R3                                                               
                                                                                
         DS    0H                  GET CODE CONTROL BITS                        
         LA    R0,CODETABQ                                                      
         L     RF,ARM18WRK                                                      
         L     RF,(ACODETAB-RM18WRKD)(RF)                                       
XFD025   CLC   XFCODE,0(RF)                                                     
         BE    XFD025A                                                          
         LA    RF,L'CODETAB(RF)                                                 
         BCT   R0,XFD025                                                        
XFD025A  MVC   CODECTL,2(RF)                                                    
         OC    FDFILE,FDFILE        DON'T SET FILE IF ALREADY SET               
         BNZ   *+10                                                             
         MVC   FDFILE,3(RF)                                                     
                                                                                
         DS    0H                  GET FOUR-WEEK/TYPICAL INDICATOR              
         MVI   FDTPTT,C'P'          4 WEEK                                      
         CLC   XFCODE,=C'TP'                                                    
         BE    XFD027X                                                          
         MVI   FDTPTT,C'T'          TYPICAL                                     
         CLC   XFCODE,=C'TT'                                                    
         BE    XFD027X                                                          
         MVI   FDTPTT,0             NOT APPLICABLE                              
XFD027X  EQU   *                                                                
                                                                                
*                                                                               
XFD030   DS    0H                  GET DEMO CATEGORY NUMBER                     
         MVI   FDDEMC,DNHOMES       USE HOMES AS DEFAULT                        
*                                                                               
         DS    0H                  SOME MORE EFFORT TO DETERMINE FILE           
         OC    FDFILE,FDFILE        IF FILE ALREADY SET,                        
         BNZ   XFD50                 SKIP THIS LOGIC NOW                        
         TM    CODECTL,CDMIXPT      IF IT CAN BE PAV & TP,                      
         BO    XFD50                 THIS EFFORT IS USELESS                     
         TM    CODECTL,CDPAV+CDINV  IF IT CAN'T BE PAV NOR INV,                 
         BZ    XFD50                 THIS EFFORT IS ALSO USELESS                
         MVC   FDFILE,DCFILIUN                                                  
         CLI   FDFTYP,C'I'                                                      
         BE    XFD50                                                            
         MVC   FDFILE,DCFILPAV                                                  
         CLI   FDFTYP,C'P'                                                      
         BE    XFD50                                                            
         DC    H'0'                                                             
                                                                                
*                                                                               
XFD50    DS    0H                                                               
                                                                                
*                                                                               
XFDX     DS    0H                                                               
         J     XIT                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR04--LTORG && +        
               CONSTANTS)'                                                      
*------------------------- LTORG & CONSTANTS -------------------------*         
         LTORG                                                                  
                                                                                
                                                                                
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR04--MISC STUF+        
               F)'                                                              
*--------------------- SUBR04 MISCELLANEOUS STUFF --------------------*         
                                                                                
SUBR04L  EQU   *-SUBR04                                                         
         DS    0CL(X'1000'-SUBR04L+1)                                           
***********************************************************************         
                                                                                
         DROP  R7,R8,RA,RB,RC                                                   
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR05)'                  
***********************************************************************         
*======================== SUBROUTINE POOL FIVE =======================*         
                                                                                
* At entry,                                                                     
*   RA-->TWA,                                                                   
*   R8-->SYSD,                                                                  
*   R7-->SPOOLD,                                                                
*   R1-->GEND,                                                                  
*   GOSUBN = equated sub-routine number.                                        
                                                                                
SUBR05Q  EQU   (((*-RMP18+X'0FFF')/X'1000')*X'1000')                            
                                                                                
         ORG   RMP18+SUBR05Q                                                    
SUBR05   NMOD1 0,**1805**                                                       
         LR    RC,R1                                                            
         USING GEND,RC             RC=A(GENCON WORK AREA)                       
         USING CONHEADH-64,RA      RA=A(TWA)                                    
         USING SYSD,R8             R8=A(SYSD)                                   
         USING SPOOLD,R7           R7=A(SPOOL WORK AREA)                        
                                                                                
         ZIC   R1,GOSUBN                                                        
         SH    R1,=Y(R04#)         SUBTRACT FOR SUB-RTN # 4                     
         BCTR  R1,0                                                             
         SLL   R1,2                                                             
         B     R05_00(R1)                                                       
                                                                                
CDBK#    EQU   ((R05_01-*)/4+1)+R04#  CLEAR DBLOCK AREA                         
BDB#     EQU   ((R05_02-*)/4+1)+R04#  BUILD DBLOCK                              
SDBX#    EQU   ((R05_03-*)/4+1)+R04#  SET UP A LINK IN DBEXTEND AREA            
SDTL#    EQU   ((R05_04-*)/4+1)+R04#  SET DAY/TIME LIST                         
BIL#     EQU   ((R05_05-*)/4+1)+R04#  BUILD INVENTORY LIST                      
BLD#     EQU   ((R05_06-*)/4+1)+R04#  BUILD (MY) LIST DIRECTORY                 
CSA#     EQU   ((R05_07-*)/4+1)+R04#  CLEAR (SYSSPARE) STORAGE AREAS            
CLA#     EQU   ((R05_08-*)/4+1)+R04#  CLEAR LIST AREA                           
CPRTF#   EQU   ((R05_09-*)/4+1)+R04#  CHANGE PROTECTION OF FIELDS               
MGF#     EQU   ((R05_10-*)/4+1)+R04#  MERGE TWA FIELDS                          
UMF#     EQU   ((R05_11-*)/4+1)+R04#  UN-MERGE FIELDS                           
MNI#     EQU   ((R05_12-*)/4+1)+R04#  MODIFY FOR NEXT INPUT                     
                                                                                
R05_00   DS    0H                                                               
R05_01   B     CLRDBLK             CLEAR DBLOCK AREA                            
R05_02   B     BLDBLOCK            BUILD DBLOCK                                 
R05_03   B     STDBXLNK               SET UP A LINK IN DBEXTEND AREA            
R05_04   B     SETDYTML               SET DAY/TIME LIST                         
R05_05   B     BLDIVLST               BUILD INVENTORY LIST                      
R05_06   B     BMLSTDIR               BUILD (MY) LIST DIRECTORY                 
R05_07   B     CLRAREAS               CLEAR (SYSSPARE) STORAGE AREAS            
R05_08   B     CLRLSTAR               CLEAR LIST AREA                           
R05_09   B     CPRTFLD                CHANGE PROTECTION OF FIELDS               
R05_10   B     MERGFLDS               MERGE TWA FIELDS                          
R05_11   B     UNMRGFLD               UN-MERGE FIELDS                           
R05_12   B     MODNXTIN               MODIFY FOR NEXT INPUT                     
R05#     EQU   ((*-R05_00)/4)+R04#                                              
         DC    H'0'                                                             
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR05--CDBK#)'           
*------------------------- CLEAR DBLOCK AREA -------------------------*         
                                                                                
* Clears the area pointed to by ADBLOCK.                                        
                                                                                
CLRDBLK  DS    0H                                                               
         L     R0,ADBLOCK                                                       
         LA    R1,DBLOCK1X-DBLOCK1                                              
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
         J     XIT                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR05--BDB#)'            
*---------------------------- BUILD DBLOCK ---------------------------*         
                                                                                
* Builds the demo block (DBLOCK) and extended DBLOCK areas for the              
*  DEMAND calls made in this program.  AIO2 is used for DEMAND i/o,             
*  and the media is always TV (for now).                                        
* At entry,                                                                     
*   TMPS values are set.                                                        
                                                                                
BLDBLOCK DS    0H                                                               
         L     R5,ADBLOCK                                                       
         USING DBLOCKD,R5                                                       
*                                                                               
** CLEAR DBLOCK AND EXTENSION AREAS **                                          
*                                                                               
         MVI   GOSUBN,CDBK#                                                     
         GOTO1 AGOSUB                                                           
                                                                                
         L     R0,ADBXTND                                                       
         LA    R1,DBXTND1X-DBXTND1                                              
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
** SET UP DBLOCK **                                                             
*                                                                               
*** NON FILE-SPECIFIC INFORMATION ***                                           
*                                                                               
         MVC   DBFILE,TMPDFIL                                                   
         MVC   DBAREC,AIO2                                                      
         MVI   DBFUNCT,DBGETDEM                                                 
         MVC   DBCOMFCS,ACOMFACS                                                
         MVC   DBBTYPE,TMPBTYP                                                  
         MVC   DBSELSRC,TMPSRC                                                  
         CLI   TMPSTTN+4,C'H'      IF NHTI STATION,                             
         BNE   *+8                                                              
         MVI   DBSELSRC,C'H'        THEN FORCE SOURCE TO NHTI                   
                                                                                
         MVC   DBSELBK,TMPBOOK                                                  
         MVI   DBSELMED,C'T'                                                    
         CLI   DBSELSRC,C'H'       IF SOURCE IS NHTI,                           
         BNE   *+8                                                              
         MVI   DBSELMED,C'N'        MEDIA HAS GOTTA BE NETWORK                  
                                                                                
         MVC   DBSELSTA,TMPSTTN                                                 
         CLC   TMPSTTN,=C'WCPXT'      IF LOOKING UP WCPXT,                      
         BNE   *+20                                                             
         CLC   TMPBOOK,=X'610B'        AND BOOK IS NOV97 OR PRIOR,              
         BH    *+10                                                             
         MVC   DBSELSTA,=C'WKMGT'      FORCE IT BACK TO WKMGT                   
                                                                                
         MVC   DBSELAGY,TWAAGY                                                  
         MVC   DBSELWKN,TMPWKN                                                  
         MVC   DBTAPEP,MYTAPEP                                                  
         MVC   DBTIMCHG,TMPTMCHG                                                
         MVC   DBPRGDUR,TMPPGDUR                                                
         MVI   TMPPGDUR,0          RESET AFTER PICKED UP BY DBLOCK              
         EJECT                                                                  
*                                                                               
*** FILE-SPECIFIC INFORMATION ***                                               
*                                                                               
         DS    0H                  FILE SPECIFIC PARAMETERS                     
         CLC   DBFILE,DCFILPAV                                                  
         BE    BDBP                                                             
         CLC   DBFILE,DCFILTP                                                   
         BE    BDBT                                                             
         CLC   DBFILE,DCFILIUN                                                  
         BE    BDBI                                                             
         DC    H'0'                                                             
                                                                                
                                                                                
                                                                                
BDBP     DS    0H                  PROGRAM AVG SPECIFIC PARAMETERS              
         CLI   DBSELMED,C'N'                                                    
         BE    BDBP010                                                          
         MVI   DBFUNCT,DBGETPUR                                                 
         MVC   DBSELPUR,TMPPURE      OR PURE NUMBER                             
         OC    TMPPURE(2),TMPPURE                                               
         BNZ   BDBP019                                                          
         MVI   DBFUNCT,DBGETDEM                                                 
         MVC   DBSELDAY,TMPIDAY      DAY(S)                                     
         MVC   DBSELTIM,TMPSETM       AND TIMES,                                
         B     BDBP019                                                          
*                                                                               
BDBP010  MVI   DBFUNCT,DBGETDEM      FOR NHTI FUNCT ALWAYS GETDEM               
         MVC   DBSELPRG,TMPPURE                                                 
         OC    TMPPURE(2),TMPPURE                                               
         BNZ   *+16                                                             
         MVC   DBSELDAY,TMPIDAY      DAY(S)                                     
         MVC   DBSELTIM,TMPSETM       AND TIMES,                                
                                                                                
BDBP019  EQU   *                                                                
*                                                                               
         MVC   DBBEST,TMPBEST                                                   
*                                                                               
         B     BDB100                                                           
                                                                                
                                                                                
                                                                                
BDBT     DS    0H                  TIME PERIOD SPECIFIC PARAMETERS              
         MVC   DBSELDAY,TMPIDAY     DAY(S)                                      
         MVC   DBSELTIM,TMPSETM     TIME(S)                                     
*                                                                               
         MVI   DBTPTT,C'T'          DEFAULT TO TYPICAL TIME                     
         TM    TMPFLAG2,LTF2T4                                                  
         BZ    *+8                                                              
         MVI   DBTPTT,C'P'           UNLESS 4-WEEK AVG REQUESTED                
*                                                                               
         B     BDB100                                                           
                                                                                
                                                                                
                                                                                
BDBI     DS    0H                  INVENTORY FILE SPECIFIC PARAMETERS           
         MVC   DUB(4),=C'RINV'      SET LINK IN DBEXTEND AREA                   
         MVC   DUB+4(4),ADBXTRIN                                                
         MVI   GOSUBN,SDBX#                                                     
         GOTO1 AGOSUB                                                           
                                                                                
         ICM   RF,15,FULL           FULL=A(LINK) ON RETURN                      
         BNZ   *+6                                                              
         DC    H'0'                 CAN'T DO MUCH W/O LINK                      
         USING DBXINVWK,RF                                                      
         MVC   DBXIWID,=C'RINV'                                                 
         DROP  RF                                                               
                                                                                
         CLI   TMPSTTN+4,C'H'      IF NHTI STATION,                             
         BNE   *+8                                                              
         MVI   DBSELSRC,C'N'        THEN CHG SOURCE BACK TO NSI                 
                                                                                
         MVI   DBSELMED,C'U'        MEDIA = (U)pgrade                           
         MVC   DBSELINV,TMPINVN     INVENTORY NUMBER                            
         OC    TMPINVN,TMPINVN       IF NULLS, SOMETHING IS WRONG               
         BNZ   *+8                    ALREADY--SO WE'RE PASSING IN AN           
         MVI   DBSELINV,X80           INTENTIONAL INVALID INVENTORY #           
         MVC   DBSELDAT,TMPCDATE    EFFECTIVE DATE                              
                                                                                
         MVI   DBSELDAY,0                                                       
         MVC   DBSELTIM,=AL2(0600,2959)   DON'T LET DEMAND FUDGE TIMES          
*                                                                               
         MVI   GOSUBN,GKS#                                                      
         GOTO1 AGOSUB                                                           
         MVC   DBSTYPE,TMPKSRC      KEY SOURCE                                  
*                                                                               
         B     BDB100                                                           
                                                                                
                                                                                
                                                                                
BDB100   DS    0H                                                               
         J     XIT                                                              
         DROP  R5                                                               
                                                                                
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR05--SDBX#)'           
*------------------------- SET DBEXTEND AREA -------------------------*         
                                                                                
* Sets up a link in the DBEXTEND area.                                          
* At entry,                                                                     
*   DUB(4)   = link identification if want to match to an existing link         
*            = x'00000000' if link must be added,                               
*   DUB+4(4) = A(link),                                                         
*   R5       = A(DBLOCK).                                                       
* At exit,                                                                      
*   FULL     = address of link, zeroes if no link set up.                       
                                                                                
STDBXLNK DS    0H                                                               
         XC    FULL,FULL                                                        
*                                                                               
         DS    0H                  GET R2 TO START OF EXTENSION AREA            
         USING DBLOCKD,R5                                                       
         ICM   R2,15,DBEXTEND                                                   
         BNZ   SDBX020                                                          
                                                                                
         L     R2,DUB+4            USE A(CALLER'S LINK) IF DBEXTEND=0           
         STCM  R2,15,DBEXTEND                                                   
         B     SDBX040              AND MAKE IT THE LAST LINK                   
         DROP  R5                                                               
                                                                                
*                                                                               
SDBX020  DS    0H                  BUMP TO APPROPRIATE LINK                     
         ICM   R0,15,4(R2)          GET ADDRESS OF NEXT LINK                    
         BZ    SDBX030               IF ZERO, ADD CALLER'S LINK                 
                                                                                
         LR    R2,R0                "BUMPED" TO NEXT LINK                       
         OC    DUB(4),DUB           IF LOOKING FOR MATCH,                       
         BZ    SDBX020                                                          
         CLC   DUB(4),0(R2)          AND LINKS' IDS MATCH,                      
         BNE   SDBX020                                                          
         B     SDBX050               PASS BACK ADDR OF CURRENT LINK             
                                                                                
*                                                                               
SDBX030  DS    0H                  ADD CALLER'S LINK TO END                     
         MVC   4(4,R2),DUB+4        SET THE NEXT ADDR INTO LAST LINK            
         ICM   R2,15,4(R2)          BUMP TO THE NEW LAST LINK                   
         B     SDBX040                                                          
                                                                                
*                                                                               
SDBX040  DS    0H                  R2-->LAST LINK                               
         XC    4(4,R2),4(R2)        ZERO OUT THE NEXT ADDRESS                   
         B     SDBX050               NOPE                                       
                                                                                
*                                                                               
SDBX050  DS    0H                                                               
         ST    R2,FULL             RETURN ADDRESS OF MATCHED/ADDED LINK         
         B     SDBXX                                                            
                                                                                
*                                                                               
SDBXX    DS    0H                                                               
         J     XIT                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR05--SDTL#)'           
*------------------------- SET DAY/TIME LIST -------------------------*         
                                                                                
* Breaks out the days that are set in the DBLOCK and sets them                  
*  individually, along with the times, in the 'DYTM' link of the                
*  DBEXTEND area.                                                               
* At entry,                                                                     
*   DBLOCK is set                                                               
* At exit,                                                                      
*   DBSELDAY & DBSELTIM are set to nulls                                        
*   C'DYTM' link put into DBEXTEND area                                         
                                                                                
SETDYTML DS    0H                                                               
         L     R3,ADTLAREA                                                      
         USING DBXTLD,R3                                                        
                                                                                
*                                                                               
         DS    0H                                                               
         MVC   DBXTLID,=C'DYTM'    SET ID IN LINK                               
*                                                                               
         LA    R2,DBXTLIST         SET DAYS/TIMES                               
         LA    R1,B'01000000'      R1=MASK FOR AN INDIVIDUAL DAY                
         LA    R0,7                R0=COUNTER                                   
         SR    RE,RE                                                            
         L     R5,ADBLOCK                                                       
         USING DBLOCKD,R5                                                       
                                                                                
SDTL032  DS    0H                                                               
         IC    RE,DBSELDAY         GET ROTATION                                 
         NR    RE,R1               EXTRACT AN INDIVIDUAL DAY                    
         BZ    SDTL034                                                          
         STC   RE,0(R2)            PUT INDIVIDUAL DAY INTO LINK                 
         MVC   1(4,R2),DBSELTIM    PUT TIMES INTO LINK                          
         LA    R2,L'DBXTLIST(R2)                                                
SDTL034  SRL   R1,1                SET MASK TO GET NEXT INDIVIDUAL DAY          
         BCT   R0,SDTL032                                                       
                                                                                
         MVI   DBSELDAY,0          SET TO NULLS                                 
         XC    DBSELTIM,DBSELTIM    SO DEMAND WILL USE DYTM LIST                
                                                                                
*                                                                               
         DS    0H                                                               
         XC    DUB,DUB                                                          
         ST    R3,DUB+4                                                         
         MVI   GOSUBN,SDBX#        SET DYTM LINK INTO DBEXTEND AREA             
         GOTO1 AGOSUB                                                           
         DROP  R5                                                               
                                                                                
*                                                                               
         DS    0H                                                               
         J     XIT                                                              
         DROP  R3                                                               
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR05--BIL#)'            
*------------------------ BUILD INVENTORY LIST -----------------------*         
                                                                                
* Builds a so-called "inventory list" (as referred to in RERMP11) from          
*  the RINVFRDT field of the RINVFREL element.                                  
* At entry,                                                                     
*   R3-->RINVFREL element.                                                      
                                                                                
BLDIVLST DS    0H                                                               
         L     R0,AINVLIST                                                      
         LA    R1,INVLISTX-INVLIST                                              
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE               CLEAR INVENTORY LIST AREA                    
*                                                                               
         DS    0H                  CHECK IF ANY RINVFRDT DATA                   
         USING RINVFREL,R3                                                      
         CLI   RINVFRLN,RINVFRDT-RINVFREL                                       
         BE    BILX                                                             
         CLI   RINVFRLN,RINVFRDT-RINVFREL+1   THIS IS JUST                      
         BH    BIL020                                                           
         CLI   RINVFRDT,0                      TO PROTECT MYSELF                
         BE    BILX                                                             
         DROP  R3                                                               
*                                                                               
BIL020   DS    0H                  BUILD DUMMY TWA FIELD W/ RINVFRDT            
         XC    BLOCK(256),BLOCK                                                 
         USING RINVFREL,R3                                                      
         LA    R0,RINVFRDT-RINVFREL                                             
         ZIC   R1,RINVFRLN                                                      
         SR    R1,R0                                                            
         STC   R1,BLOCK+5                                                       
         BCTR  R1,0                                                             
         EXMVC R1,BLOCK+8,RINVFRDT                                              
         LA    R1,8+1(R1)                                                       
         STC   R1,BLOCK                                                         
         DROP  R3                                                               
                                                                                
         DS    0H                  RUN SCANNER THROUGH RINVFRDT DATA            
         MVI   SCANLNTH,10                                                      
         GOTO1 SCANNER,DMCB,(SCANLNTH,BLOCK),BUFF,0                             
         ZICM  R0,DMCB+4,(1)                                                    
         BNZ   BIL030                                                           
         DC    H'0'                                                             
                                                                                
BIL030   DS    0H                                                               
         STC   R0,COUNTER                                                       
         LA    R4,BUFF                                                          
         L     R2,AINVLIST                                                      
         USING INVLD,R2                                                         
         MVC   ILFLE,FDFTYP        MOVE IN FROM TYPE                            
         MVI   INVLQ(R2),EOT       ASSUME THIS IS LAST ENTRY IN INV LST         
                                                                                
                                                                                
BILPFX   DS    0H                  ASSUME PREFIX                                
         CLI   0(R4),0              MAKE SURE THERE IS INPUT                    
         BH    BILPFX10                                                         
         BAS   RE,BILBSCAN          SEE IF NEXT ENTRY HAS INPUT                 
         BP    BILPFX                                                           
         B     BILX                 EXIT IF THERE SEEMS TO BE NO INPUT          
                                                                                
BILPFX10 DS    0H                                                               
         CLI   12(R4),C'+'                                                      
         BE    BILPFX20                                                         
         CLI   12(R4),C'/'                                                      
         BE    BILPFX30                                                         
         CLI   12(R4),C'#'         NTI PROG NUMBER                              
         BE    BILNHT                                                           
         B     BILSTA              NO PREFIX FOUND                              
                                                                                
BILPFX20 DS    0H                                                               
         OI    ILTYP,ILTADD        FLAG FOR "ADD" EXPRESSION                    
         MVI   FDADCMBO,C'Y'       INDICATE DEMOS WERE ADDED                    
         B     BILPFX50                                                         
                                                                                
BILPFX30 DS    0H                                                               
         B     BILPFX50            FOOTNOTE SUPPRESSION--LET IT PASS            
                                                                                
BILPFX50 DS    0H                  REMOVE PREFIX & DECREMENT LENGTH             
         CLI   0(R4),1              PREFIX SHOULDN'T BE ALONE                   
         BH    *+6                                                              
         DC    H'0'                                                             
         ZIC   RF,0(R4)                                                         
         BCTR  RF,0                                                             
         STC   RF,0(R4)             NEW LENGTH                                  
         BCTR  RF,0                                                             
         EXMVC RF,12(R4),13(R4)     SHIFT DATA 1 BYTE TO LEFT                   
         LA    RF,12+1(RF,R4)                                                   
         MVI   0(RF),C' '           BLANK OUT LAST CHAR                         
*                                                                               
BILSTA   DS    0H                  ASSUME STATION                               
         ZIC   R0,0(R4)             CHECK IF 1ST IS A DAY                       
                                                                                
*             CHECK IF FIRST IS A NON-STANDARD ROTATION                         
         GOTOR CHKNSR,DMCB,((R0),12(R4)),DUB                                    
         CLI   DUB,0                                                            
         BNE   BILDYT05            YEP, 1ST IS A NON-STANDARD ROTATION          
                                                                                
         GOTO1 VINVDAY,DMCB,((R0),12(R4)),DUB,DUB+1,DAYVAL                      
         CLI   DUB,0                                                            
         BNE   BILDYT05              YEP, 1ST ENTRY IS A DAY EXPRESSION         
                                                                                
         DS    0H                   SEE IF 1ST IS A STATION                     
         GOTO1 VPAVSTA,DMCB,12(R4),DUB                                          
         CLI   DMCB+4,XFF                                                       
         BE    BILNUM                NOPE, 1ST ENTRY NOT A STATION              
         MVC   FDSTTN,DUB            YEP, SAVE STATION                          
         MVC   FDMED,DUB+5            AND MEDIA                                 
         CLI   COUNTER,2            STATION MUST BE FOLLOWED                    
         BNL   BILSKIP               BY SOMETHING ELSE                          
         DC    H'0'                                                             
*                                                                               
*              NHTI PRG NUMBER (# PREFIX)                                       
*                                                                               
BILNHT   DS    0H                                                               
         LA    R1,13(R4)           IF 5-CHAR INPUT W/# PREFIX                   
         CLI   0(R4),4                                                          
         BNE   *+8                                                              
         LA    R1,12(R4)           4-CHAR INPUT: PROGRAM # ONLY                 
         ST    R1,DMCB                                                          
         L     RF,ACOMFACS                                                      
         L     RF,(CHEXIN-COMFACSD)(RF)                                         
         GOTO1 (RF),DMCB,,ILNUMB,4                                              
         OC    DMCB+12(4),DMCB+12                                               
         BNZ   *+6                                                              
         DC    H'0'                                                             
         CLI   0(R4),5                                                          
         BNE   *+18                                                             
         MVC   12(4,R4),13(R4)     SHIFT DATA 1 BYTE TO LEFT                    
         MVI   16(R4),C' '                                                      
         MVI   0(R4),4             SET NEW LENGTH TO 4                          
         MVC   ILFLE,FDFTYP        MOVE IN FROM TYPE                            
         MVI   INVLQ(R2),EOT       ASSUME THIS IS LAST ENTRY IN INV LST         
         B     BILNUM60                                                         
*                                                                               
BILNUM   DS    0H                  ASSUME INVENTORY/PURE NUMBER                 
         SR    R0,R0                                                            
         MVC   ILFLE,FDFTYP        MOVE IN FROM TYPE                            
         MVI   INVLQ(R2),EOT       ASSUME THIS IS LAST ENTRY IN INV LST         
                                                                                
         TM    RMPPROFS,X80        IS THIS A SELF-DEFINED INVENTORY?            
         BZ    BILNUM10                                                         
         CLI   12(R4),C'*'                                                      
         BNE   BILNUM10                                                         
         MVC   12(4,R4),13(R4)                                                  
         B     BILNUM20                                                         
                                                                                
BILNUM10 DS    0H                                                               
         CLI   0(R4),3             INVENTORY NUMBER MUST BE 3                   
         BL    BILDYT                                                           
         CLI   0(R4),4              OR 4 CHARACTERS LONG                        
         BH    BILDYT                                                           
                                                                                
         CLI   12(R4),C'0'         QTR HOUR NUMBER MUST BE 00 - 99              
         BL    BILDYT                                                           
         CLI   12(R4),C'9'                                                      
         BH    BILDYT                                                           
         CLI   13(R4),C'0'                                                      
         BL    BILDYT                                                           
         CLI   13(R4),C'9'                                                      
         BH    BILDYT                                                           
                                                                                
BILNUM20 DS    0H                                                               
         CLI   FDFTYP,C'I'                                                      
         BNE   BILNUM25                                                         
         MVC   ILNUMB,12(R4)       MOVE INVENTORY NUMBER OUT                    
         OC    ILNUMB,SPACES                                                    
         B     BILNUM60                                                         
                                                                                
BILNUM25 DS    0H                                                               
         PACK  DUB,12(2,R4)                                                     
         CVB   R1,DUB                                                           
         STC   R1,ILNUMB           QUARTER HOUR NUMBER                          
                                                                                
         CLI   14(R4),C'D'         TYPICAL                                      
         BE    BILNUM30                                                         
         CLI   14(R4),C'E'         WEEKEND                                      
         BE    BILNUM30                                                         
         CLI   14(R4),C'0'                                                      
         BL    *+16                                                             
         CLI   14(R4),C'9'                                                      
         BH    *+8                                                              
         B     BILNUM30                                                         
         DC    H'0'                                                             
                                                                                
BILNUM30 DS    0H                                                               
         MVC   ILNUMB+1(1),14(R4)                                               
         CLI   ILFLE,C'I'                                                       
         BE    BILNUM50                                                         
         GOTO1 VINVDAY,DMCB,1,(0,14(R4)),(0,ILNUMB+1)  PAV DAY CODE             
                                                                                
         CLI   0(R4),3             PURE 3 CHAR CODE                             
         BE    BILNUM60             IS OK                                       
         ZIC   RF,15(R4)           START WEEK (4TH CHAR)                        
         SR    RE,RE                                                            
         SLDL  RE,28               RE HAS 4 HIGH ORDER BITS                     
         SRL   RF,28               RF HAS 4 LOW  ORDER BITS                     
         CH    RF,=H'7'            0-7 , A-G                                    
         BNH   *+6                                                              
         DC    H'0'                                                             
         SLL   RF,1                SHIFT TO BIT POSITIONS 4, 5, & 6             
         EX    RF,*+8                                                           
         B     *+8                                                              
         OI    ILNUMB+1,0                                                       
                                                                                
         CH    RE,=H'15'           IF RE <> X'F0',                              
         BNE   BILNUM44             THEN IT'S NOT A DIGIT                       
         LTR   RF,RF               IF THE DIGIT IS 0,                           
         BZ    BILNUM46             HANDLE IT DIFFERENTLY                       
         B     BILNUM60                                                         
                                                                                
BILNUM44 DS    0H                  IT'S NOT A DIGIT                             
         CH    RE,=H'12'            THEN IT BETTER BE A X'C0'                   
         BE    *+6                                                              
         DC    H'0'                                                             
                                                                                
BILNUM46 DS    0H                                                               
         OI    ILNUMB+1,X01        LOW ORDER ON FOR ZERO & A-G                  
         B     BILNUM60                                                         
                                                                                
BILNUM50 DS    0H                                                               
         MVI   ILNUMB+2,C'0'       DEFAULT LENGTH                               
         CLI   0(R4),3                                                          
         BE    BILNUM60                                                         
         MVC   ILNUMB+2(1),15(R4)  LENGTH OR SPECIAL INPUT CODE                 
                                                                                
BILNUM60 DS    0H                                                               
         OI    ILTYP,ILTIVN        IT IS AN INVENTORY NUMBER                    
         MVI   ILWT,1              WEIGHT                                       
                                                                                
         CLI   1(R4),0             ANY OVERRIDING WEIGHT?                       
         BE    BILDAT               NOPE                                        
         OC    8(4,R4),8(R4)                                                    
         BNZ   *+6                                                              
         DC    H'0'                WEIGHT S/B NUMBERIC                          
         CLC   8(4,R4),=F'99'      99 SHOULD BE ENOUGH                          
         BNH   *+6                                                              
         DC    H'0'                                                             
         MVC   ILWT,11(R4)         MOVE WEIGHT TO LIST                          
         OI    ILTYP,ILTWOV         AND INDICATE WEIGHT OVERRIDE                
*                                                                               
BILDAT   DS    0H                  A (EFFCTVE) DATE MAY FOLLOW INV #            
         CLI   ILFLE,C'P'                                                       
         BE    BILNEXT                                                          
         CLI   COUNTER,2            IS THERE ANOTHER ENTRY LEFT?                
         BL    BILNEXT               NOPE                                       
                                                                                
         ZIC   R5,SCANLNTH           YES, CHECK IF IT'S A DATE                  
         LA    R5,22(R5,R4)                                                     
         GOTO1 DATVAL,DMCB,(0,12(R5)),DUB                                       
         OC    DMCB,DMCB            IS IT A VALID DATE?                         
         BZ    BILNEXT                                                          
         CLI   1(R5),0               YES, THEN IT SHOULDN'T HAVE                
         BE    *+6                    A SECOND HALF                             
         DC    H'0'                                                             
                                                                                
         LR    R4,R5               BUMP TO SCANNER ENTRY W/ DATE                
         ZIC   R1,COUNTER                                                       
         BCTR  R1,0                                                             
         STC   R1,COUNTER          DECREMENT LOOP COUNTER                       
         GOTO1 DATCON,DMCB,(0,DUB),(3,ILDATE)                                   
         B     BILNEXT                                                          
*                                                                               
BILDYT   DS    0H                  DAY & TIME EXPRESSIONS                       
         ZIC   R0,0(R4)                                                         
                                                                                
         GOTOR CHKNSR,DMCB,((R0),12(R4)),DUB                                    
         CLI   DUB,0                                                            
         BNE   BILDYT05            FIRST IS A NON-STANDARD ROTATION             
                                                                                
         GOTO1 VINVDAY,DMCB,((R0),12(R4)),DUB,DUB+1,DAYVAL                      
         CLI   DUB,0                                                            
         BNE   BILDYT05                                                         
         B     BILBAD              IF STILL INVALID, FILE IS MESSED UP          
                                                                                
BILDYT05 DS    0H                                                               
         CLI   1(R4),0             SHOULD NOT HAVE 2ND HALF OF FIELD            
         BE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         CLI   ILFLE,C'I'                                                       
         BE    BILDYT30                                                         
         OI    ILTYP,ILTFDT+ILTLDT                                              
                                                                                
BILDYT20 DS    0H                  CHECK FOR MULTIPLE DAYS                      
         ZIC   R0,0(R4)                                                         
*             CHECK FOR NON-STANDARD ROTATION DAY EXPRESSION                    
         GOTOR CHKNSR,DMCB,((R0),12(R4)),DUB                                    
         CLI   DUB,0               IF NON-STANDARD DAY FOUND                    
         BNE   BILDYT23            THEN, USE IT                                 
*                                  ELSE, CHECK FOR REGULAR DAY                  
         GOTO1 DAYVAL,DMCB,((R0),12(R4)),DUB,DUB+1                              
         CLI   DUB,0                                                            
         BE    BILDYT35            NOT A DAY EXPRESSION ANYMORE                 
BILDYT23 OC    ILDAY,DUB                                                        
                                                                                
         DS    0H                  CHECKING FOR MULTIPLE DAYS                   
         BAS   RE,BILBSCAN                                                      
         BP    BILDYT20             YES THERE IS MORE                           
         DC    H'0'                                                             
                                                                                
BILDYT25 DS    0H                                                               
         CLI   ILDAY,0             ANY DAY EXPRESSIONS FOUND?                   
         BNE   BILDYT35             YES (R0 = L'INPUT OF NEXT ENTRY)            
         DC    H'0'                                                             
                                                                                
BILDYT30 DS    0H                  EXPECT NEXT ENTRY TO BE A TIME EXP           
         BAS   RE,BILBSCAN          BUMP TO NEXT SCANNER ENTRY                  
         BP    *+6                                                              
         DC    H'0'                                                             
         ZIC   R0,0(R4)            R0 = L(TIME EXPRESSION)                      
                                                                                
BILDYT35 DS    0H                  MAKE SURE R0 = L(TIME EXP)                   
         GOTO1 TIMVAL,DMCB,((R0),12(R4)),DUB+4                                  
         CLI   DMCB,XFF                                                         
         BNE   *+6                                                              
         DC    H'0'                                                             
         CLC   DUB+6(2),=H'2400'                                                
         BNH   *+6                                                              
         DC    H'0'                                                             
                                                                                
         CLI   ILFLE,C'P'                                                       
         BNE   BILDYT33                                                         
         MVC   ILTIME,DUB+4                                                     
         B     BILNEXT                                                          
*                                                                               
BILDYT33 DS    0H                                                               
         GOTO1 VHRTOQH,DMCB,DUB+4,FULL                                          
         ZIC   R0,FULL                                                          
         STC   R0,ILNUMB           QUARTER-HOUR CODE                            
         MVC   ILNUMB+1(1),DUB     INV DAY CODE                                 
         MVI   ILNUMB+2,C'0'       PROGRAM LENGTH                               
                                                                                
         MVI   ILWT,1              WEIGHT                                       
         OI    ILTYP,ILTFDT+ILTLDT  FIRST & LAST                                
                                                                                
         OC    DUB+6(2),DUB+6      ANY END TIME?                                
         BZ    BILNEXT              NOPE                                        
                                                                                
         GOTO1 VHRTOQH,DMCB,DUB+6,FULL                                          
         ZIC   RF,FULL                                                          
         LR    RE,R0                                                            
         SR    RF,RE               END QH MINUS START QH                        
         BCTR  RF,0                                                             
         LTR   RF,RF                                                            
         BNP   BILNEXT                                                          
         NI    ILTYP,XFF-ILTIVN-ILTLDT                                          
                                                                                
BILDYT36 DS    0H                                                               
         MVC   INVLQ(INVLQ,R2),0(R2)  SET UP NEXT OUTPUT AREA                   
         LA    R2,INVLQ(R2)                                                     
         MVI   INVLQ(R2),EOT          ASSME THIS LAST NTRY IN INV LST           
         LA    RE,1(RE)               NEXT QUARTER HOUR                         
         STC   RE,ILNUMB                                                        
         NI    ILTYP,XFF-ILTIVN-ILTFDT-ILTLDT                                   
         BCT   RF,BILDYT36                                                      
         OI    ILTYP,ILTLDT           LAST IN LIST                              
                                                                                
BILBAD   DS    0H                  FILE IS MESSED UP                            
         B     BILNEXT              IGNORE IT FOR NOW                           
                                                                                
BILNEXT  DS    0H                  BUMP TO NEXT OUTPUT AREA                     
         LA    R2,INVLQ(R2)                                                     
*                                                                               
BILSKIP  DS    0H                  BUMP TO NEXT SCANNER ENTRY                   
         BAS   RE,BILBSCAN                                                      
         BNP   BILX                 NO MORE ENTRIES LEFT                        
         CLI   0(R4),0              IF THIS ENTRY HAS NO DATA,                  
         BE    BILSKIP               GET NEXT ENTRY                             
         CLI   FDSTTN+4,C'H'                                                    
         BE    BILNHT                                                           
         B     BILNUM              MORE "FROM DETAILS" TO GET                   
         DROP  R2                                                               
*                                                                               
BILX     DS    0H                                                               
         J     XIT                                                              
                                                                                
                                                                                
* Little helper routine to bump R4 to next scanner entry and decrement          
*  COUNTER, the number of scanner entries left.                                 
* NOTE: R1 will get clobbered here!                                             
                                                                                
BILBSCAN DS    0H                  BUMP TO NEXT SCANNER ENTRY                   
         ZIC   R1,SCANLNTH                                                      
         LA    R4,22(R1,R4)                                                     
         IC    R1,COUNTER                                                       
         BCTR  R1,0                                                             
         STC   R1,COUNTER                                                       
         LTR   R1,R1               RETURN CONDITION CODE                        
         BR    RE                                                               
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR05--CSA#)'            
*------------------------ CLEAR STORAGE AREAS ------------------------*         
*                                                                               
CLRAREAS DS    0H                                                               
         LA    RF,TABCLRQ          RF = COUNTER                                 
         L     R4,=A(TABCLR-RMP18)                                              
         A     R4,MYBASE1                                                       
                                                                                
CSA10    DS    0H                  SET FULL TO BASE OF STORAGE AREA             
         MVC   FULL,ATIA                                                        
         CLI   0(R4),C'I'                                                       
         BE    CSA20                                                            
         MVC   FULL,ASYSD                                                       
         CLI   0(R4),C'S'                                                       
         BE    CSA20                                                            
         DC    H'0'                                                             
CSA20    DS    0H                                                               
         ZICM  R0,1(R4),(3)                                                     
         A     R0,FULL             R0-->AREA TO CLEAR                           
         ZICM  R1,3(R4),(3)        R1=LENGTH TO CLEAR                           
         SR    R2,R2                                                            
         SR    R3,R3                                                            
         MVCL  R0,R2               GO CLEAR AREA                                
         LA    R4,L'TABCLR(R4)                                                  
         BCT   RF,CSA10                                                         
*                                                                               
CSAX     DS    0H                                                               
         J     XIT                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR05--BLD#)'            
*--------------------- BUILD (MY) LIST DIRECTORY ---------------------*         
                                                                                
* Builds the list directory that dictates the order the LISTTAB entries         
*  will appear on display.  For practical purposes, the selected items          
*  will be first in the directory, followed by the non-selected ones.           
                                                                                
BMLSTDIR DS    0H                                                               
         L     R4,AMLSTDIR                                                      
*                                                                               
** CLEAR AREA FOR LIST DIRECTORY **                                             
*                                                                               
         XC    0(MLSTDIRX-MLSTDIR,R4),0(R4)                                     
                                                                                
*                                                                               
** RESET FLAG IN LISTTAB ENTRIES **                                             
*                                                                               
         DS    0H                                                               
         ZICM  R0,NLTNTRY,(1)                                                   
         BZ    BLD019                                                           
*                                                                               
         L     R2,ALISTTAB                                                      
         USING LISTTABD,R2                                                      
         NI    LTFLAG2,XFF-LTF2ELD                                              
         LA    R2,LISTTABQ(R2)                                                  
         BCT   R0,*-8                                                           
         DROP  R2                                                               
BLD019   EQU   *                                                                
                                                                                
*                                                                               
** BUILD LIST DIRECTORY **                                                      
*                                                                               
         CLI   NLTNTRY,0           IF NOTHING TO LIST,                          
         BE    BLDX                 EXIT NOW                                    
*                                                                               
         MVI   HALF,LTFSEL         GET SELECTED ENTRIES FIRST                   
*                                                                               
BLD030   DS    0H                  LOOP THROUGH LISTTAB                         
         ZIC   R0,NLTNTRY                                                       
         L     R2,ALISTTAB                                                      
         USING LISTTABD,R2                                                      
                                                                                
BLD033   DS    0H                                                               
         CLI   0(R2),EOT                                                        
         BE    BLD040                                                           
                                                                                
         TM    LTFLAG2,LTF2ELD     ENTRY ENTERRED INTO LIST DRCTRY YET?         
         BO    BLD036               YES, DON'T RE-ENTER ENTRY                   
                                                                                
         MVC   HALF+1(1),LTFLAG    MOVE FLAGS TO WORK AREA                      
         NC    HALF+1(1),HALF      XTRACT CORRESPDNG "SELECT" FLAG ONLY         
         CLC   HALF+1(1),HALF      CORRESPONDS TO WHAT WE WANT?                 
         BNE   BLD036                 NOPE, BUMP TO NEXT ENTRY                  
         MVC   0(L'LTNTRY,R4),LTNTRY  YES, ADD ENTRY # TO DIRECTORY             
         LA    R4,L'LTNTRY(R4)                                                  
         OI    LTFLAG2,LTF2ELD         AND TURN FLAG ON IN ENTRY                
                                                                                
BLD036   DS    0H                  BUMP TO NEXT LISTTAB ENTRY                   
         LA    R2,LISTTABQ(R2)                                                  
         BCT   R0,BLD033                                                        
         DROP  R2                                                               
*                                                                               
BLD040   DS    0H                                                               
         CLI   HALF,LTFSEL         WERE WE PROCESSING SELECTED ONES?            
         BNE   *+12                                                             
         MVI   HALF,LTFSELXD        YES, NOW DO EXPAND DEMOS ITEMS              
         B     BLD030                                                           
                                                                                
         CLI   HALF,LTFSELXD       WERE WE PROCESSING EXPAND DEMOS?             
         BNE   *+12                                                             
         MVI   HALF,0               YES, NOW DO NON-SELECTED ITEMS              
         B     BLD030                                                           
                                                                                
         CLI   HALF,0              WERE WE PROCESSING NON-SELCTED ONES?         
         BE    BLD050               YES, DONE BUILDING LIST DIRECTORY           
         DC    H'0'                 SOMETHING'S AMISS                           
*                                                                               
BLD050   DS    0H                                                               
         MVI   0(R4),EOT           END OF LIST DIRECTORY                        
         B     BLDX                                                             
*                                                                               
BLDX     DS    0H                                                               
         J     XIT                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR05--CLA#)'            
*-------------------------- CLEAR LIST AREA --------------------------*         
                                                                                
* Clears and transmits the area on the screen used for list display.            
                                                                                
CLRLSTAR DS    0H                                                               
         LA    R2,IROLDTAH         START                                        
         LH    RF,DLASTLLN                                                      
         A     RF,ATWA                                                          
         LA    RF,SZLSTLIN(RF)     RF-->FINISH                                  
                                                                                
CLA010   DS    0H                                                               
         CR    R2,RF               IF PAST END OF LAST LIST LINE                
         BNL   CLA020               DON'T GO ANY FURTHER                        
                                                                                
         ZICM  R0,0(R2),(1)        R0 = L(TWA HEADER & FIELD)                   
         BNZ   *+6                                                              
         DC    H'0'                                                             
                                                                                
         DS    0H                  CALCULATE LENGTH FOR EX INSTRUCTION          
         LR    R1,R0                                                            
         LA    RE,8+1                                                           
         TM    1(R2),X02            CHECK FOR EXTENDED FLD HEADER               
         BZ    *+8                                                              
         LA    RE,8(RE)                                                         
         SR    R1,RE                R1 = EXECUTED LENGTH                        
                                                                                
         DS    0H                  CLEAR DATA FIELD                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         XC    8(0,R2),8(R2)                                                    
                                                                                
         DS    0H                  TRANSMIT FIELD                               
         OI    6(R2),X80                                                        
                                                                                
         DS    0H                  BUMP TO NEXT TWA FIELD                       
         AR    R2,R0                                                            
         B     CLA010                                                           
*                                                                               
CLA020   DS    0H                                                               
*                                                                               
         J     XIT                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR05--CPRTF#)'          
*---------------------- CHANGE FIELD PROTECTION ----------------------*         
                                                                                
* Toggles the protection of certain fields (those whose field ID is             
*  listed in FPRTTAB) depending on the action.                                  
*                                                                               
* **WARNING** Do NOT clobber R0 in body of routine!                             
                                                                                
CPRTFLD  DS    0H                                                               
                                                                                
         SR    R0,R0               WANT NULLS IN 3 H.O.B. OF R0                 
         LA    R2,IROOPT1H         START HERE                                   
                                                                                
CPRTF010 DS    0H                                                               
         ICM   R0,1,0(R2)          EXIT LOOP IF END OF TWA REACHED              
         BZ    CPRTF060                                                         
         TM    1(R2),X02           SKIP FIELD IF NO XTEND FLD HEADER            
         BZ    CPRTF050                                                         
                                                                                
         LR    R3,R0                                                            
         SH    R3,=H'8'                                                         
         AR    R3,R2               R3-->EXTENDED FIELD HEADER                   
                                                                                
         L     R4,ARM18WRK                                                      
         L     R4,(AFPRTTAB-RM18WRKD)(R4)                                       
         LA    R1,FPRTTABQ                                                      
CPRTF022 CLC   0(1,R3),0(R4)       MATCH FIELD ID TO THOSE IN TABLE             
         BE    CPRTF030                                                         
         LA    R4,L'FPRTTAB(R4)                                                 
         BCT   R1,CPRTF022                                                      
         B     CPRTF050            NO MATCH, SKIP THIS FIELD                    
                                                                                
CPRTF030 DS    0H                                                               
         ZICM  RF,1(R4),(3)                                                     
         A     RF,MYBASE1          RF-->TEST ROUTINE FOR FIELD                  
         BASR  RE,RF               GO PERFORM TEST FOR FIELD                    
                                                                                
         DS    0H                  RF-->INSTR TO EXEC AFTER TEST ABOVE          
         BASR  RE,RF               GO CHANGE PROTECTION OF FIELD                
         OI    6(R2),X80            AND TRANSMIT IT                             
                                                                                
CPRTF050 DS    0H                  BUMP TO NEXT FIELD                           
         AR    R2,R0                                                            
         B     CPRTF010                                                         
*                                                                               
CPRTF060 DS    0H                                                               
         J     XIT                                                              
                                                                                
                                                                                
* Tests to determine a field's protection.  RF will point to                    
*  instruction to execute upon return.                                          
* !!WARNING!! Do NOT clobber RE!                                                
                                                                                
CPRTFT1  DS    0H                  TEST #1                                      
         LA    RF,PRTFLD                                                        
         CLI   ACTNUM,ANROVER                                                   
         BNE   CPRTFT1X                                                         
         LA    RF,UPRTFLD                                                       
CPRTFT1X EQU   *                                                                
         BR    RE                                                               
                                                                                
                                                                                
CPRTFT2  DS    0H                  TEST #2                                      
         LA    RF,PRTFLD            WANT FIELD TO BE PROTECTED                  
         CLI   ACTNUM,ANROVER                                                   
         BNE   CPRTFT2X             IF ACTION <> ROVER                          
         TM    IKFRBTS,BBEBK                                                    
         BZ    CPRTFT2X             OR IF BOOK NOT AN EST BOOK                  
         LA    RF,UPRTFLD                                                       
CPRTFT2X EQU   *                                                                
         BR    RE                                                               
                                                                                
                                                                                
CPRTFT3  DS    0H                  TEST #3                                      
         LA    RF,PRTFLD            WANT FIELD TO BE PROTECTED                  
         CLI   ACTNUM,ANROVER                                                   
         BNE   CPRTFT3X              IF ACTION <> ROVER                         
         TM    CHNGFLG1,CF1KEY                                                  
         BZ    CPRTFT3D              IF KEY CHANGED                             
*&&DO                                                                           
         CLC   TWAAGY,=C'N2'          AND AGENCY IS ABC                         
         BNE   CPRTFT3G                                                         
*&&                                                                             
         TM    RMPPROFS+RMPRUFNB,RMPRUFNA  AND DON'T UPDT FTNT PRFL ON,         
         BNO   CPRTFT3G                                                         
         TM    RECDFLG1,RF1DNXST                                                
         BZ    CPRTFT3X               AND RECORD EXISTS                         
         B     CPRTFT3G               BUT IF RECD EXIST==>UNPROTECT FLD         
CPRTFT3D EQU   *                                                                
         CLI   IROUPFN,C'N'                                                     
         BE    CPRTFT3X              IF UPDATE FOOTNOTE ON SAVE                 
CPRTFT3G LA    RF,UPRTFLD           WANT FIELD TO BE UNPROTECTED                
CPRTFT3X EQU   *                                                                
         BR    RE                                                               
                                                                                
                                                                                
* Should not fall through and execute the following instructions:               
                                                                                
PRTFLD   OI    1(R2),X20           PROTECT FIELD                                
         BR    RE                                                               
                                                                                
UPRTFLD  NI    1(R2),XFF-X20       UNPROTECT FIELD                              
         BR    RE                                                               
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR05--MGF#)'            
*-------------------------- MERGE TWA FIELDS -------------------------*         
                                                                                
* Merges those TWA fields specified in a table to form a single field.          
*  The resulting field will not have an extended field header.                  
* At entry,                                                                     
*   R3-->table of TWA fields.                                                   
* At exit,                                                                      
*   BLOCK contains the combined field.                                          
                                                                                
MERGFLDS DS    0H                                                               
         XC    BLOCK(256),BLOCK                                                 
*                                                                               
         DS    0H                  INITIALIZE FIELD HEADER                      
         XC    DUB,DUB                                                          
         MVI   DUB+4,X'0F'-X01      ASSUME THESE INPUT INDICATORS ON            
                                                                                
         SR    R4,R4               USE R4 FOR LENGTH OF NEW FIELD               
*                                                                               
MGF20    DS    0H                                                               
         ZICM  RE,0(R3),(3)        GET DISPL OF FIELD HEADER                    
         BZ    MGF50                NULLS MEAN END OF TABLE                     
         A     RE,ATWA                                                          
                                                                                
         DS    0H                  SET INPUT INDICATORS                         
         MVC   BYTE,4(RE)                                                       
         NI    BYTE,X'F0'           TURN THESE                                  
         OC    DUB+4(1),BYTE         ON IN HEADER OF MERGED FIELD               
         MVC   BYTE,4(RE)                                                       
         OI    BYTE,X'F0'                                                       
         NC    DUB+4(1),BYTE         OFF IN HEADER OF MERGED FIELD              
                                                                                
         DS    0H                  APPEND DATA TO NEW FIELD                     
         ZICM  R1,5(RE),(1)                                                     
         BZ    MGF40                                                            
         LA    RF,BLOCK+8(R4)       RF-->LOCATION TO APPEND NEW DATA            
         AR    R4,R1                UPDATE L(NEW FIELD)                         
         CH    R4,=Y(255-8)          IF GREATER THAN MAX ALLOWED,               
         BNH   *+6                                                              
         DC    H'0'                   THEN WE SHOULDN'T GO ON                   
         BCTR  R1,0                                                             
         EXMVC R1,0(RF),8(RE)        ELSE, APPEND DATA ONTO NEW FIELD           
*                                                                               
MGF40    DS    0H                                                               
         LA    R3,2(R3)            BUMP TO NEXT FLD HEADER IN TABLE             
         B     MGF20                                                            
*                                                                               
MGF50    DS    0H                  SET NEW FIELD HEADER                         
         MVC   BLOCK(8),DUB                                                     
         STC   R4,BLOCK+5                                                       
         LA    R4,8(R4)                                                         
         STC   R4,BLOCK                                                         
*                                                                               
         J     XIT                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR05--UMF#)'            
*-------------------------- UN-MERGE FIELDS --------------------------*         
                                                                                
* At entry,                                                                     
*  R3-->table of TWA fields,                                                    
*  BLOCK contains field to be separated.                                        
                                                                                
UNMRGFLD DS    0H                                                               
                                                                                
         ZIC   RE,BLOCK+5                                                       
         LA    RF,BLOCK+8                                                       
                                                                                
UMF010   DS    0H                                                               
         ZICM  R2,0(R3),(3)        R2 = DISPL OF TWA FIELD                      
         BZ    UMFX                 NULLS MEANS EOT                             
         A     R2,ATWA             R2-->TWA FIELD TO PUT DATA                   
                                                                                
         ZIC   R1,0(R2)            TOTAL LENGTH OF FIELD                        
         SH    R1,=H'8'             LESS L(HEADER)                              
         BP    *+6                                                              
         DC    H'0'                                                             
         TM    1(R2),X02                                                        
         BZ    *+14                                                             
         SH    R1,=H'8'             LESS L(EXTENDED HEADER)                     
         BP    *+6                                                              
         DC    H'0'                                                             
                                                                                
         DS    0H                  R1 = L(DATA PORTION) OF TWA FIELD            
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         XC    8(0,R2),8(R2)       CLEAR DATA PORTION OF TWA FIELD              
         LA    R1,1(R1)             RESTORE LENGTH                              
         MVI   5(R2),0                                                          
         MVI   7(R2),0                                                          
         OI    6(R2),X80           TRANSMIT FIELD                               
                                                                                
         LTR   RE,RE               ANY MORE DATA LEFT?                          
         BZ    UMF030               NO, LEAVE FIELD EMPTY                       
         CR    R1,RE                                                            
         BNH   *+6                                                              
         LR    R1,RE               R1 = L(DATA) TO MOVE INTO TWA FIELD          
         LR    R0,R1               REMEMBER IT IN R0                            
                                                                                
         BCTR  R1,0                                                             
         EXMVC R1,8(R2),0(RF)      MOVE DATA INTO TWA FIELD                     
         STC   R0,5(R2)             AND SET INPUT AND                           
         STC   R0,7(R2)             OUTPUT LENGTHS                              
*&&DO                                                                           
         TM    1(R2),X20           IF FIELD IS NOT PROTECTED,                   
         BO    *+8                                                              
         OI    6(R2),X01            MODIFY FIELD FOR NEXT AS WELL               
*&&                                                                             
                                                                                
UMF030   DS    0H                                                               
         LA    R3,2(R3)            BUMP TO DISP OF NEXT TWA FIELD               
         LTR   RE,RE               IF NO MORE DATA TO MOVE,                     
         BZ    UMF010               DON'T NEED TO BUMP SOURCE POINTER           
                                                                                
         AR    RF,R0               BUMP SOURCE POINTER                          
         SR    RE,R0               DECREMENT L(SOURCE DATA) REMAINING           
         B     UMF010                                                           
*                                                                               
UMFX     DS    0H                                                               
         J     XIT                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR05--MNI#)'            
*----------------------- MODIFY FOR NEXT INPUT -----------------------*         
                                                                                
* Bumps through the specified section of the screen and                         
*  turns on the "change to modified field for next input" flag (x'01'           
*  in FLDHDR+6) for those fields which were inputted this time.                 
*  Routine is usually called when an error occurred during a validation         
*  so that we know which fields to validate in the next transaction.            
* At entry,                                                                     
*   AMNISTRT = start-at address on TWA,                                         
*   AMNIEND  = end-at address on TWA.                                           
                                                                                
MODNXTIN DS    0H                                                               
         ICM   R2,15,AMNISTRT      USE R2 TO BUMP THROUGH SCRN PORTION          
         BZ    MNIX                                                             
         L     R3,AMNIEND          R3 = END AT ADDRESS                          
*                                                                               
MNI10    DS    0H                                                               
         CLI   0(R2),0             AT END OF SCREEN?                            
         BNE   *+6                                                              
         DC    H'0'                 YEAH, SOMETHING'S WRONG                     
         TM    1(R2),X20           SKIP OVER PROTECTED FIELDS                   
         BO    MNI20                                                            
                                                                                
         TM    4(R2),X80           WAS IT MODIFIED THIS TIME?                   
         BZ    MNI20                                                            
         OI    6(R2),X80+X01        YES, KEEP IT MODFIED UNTL VLDATED           
*                                                                               
MNI20    DS    0H                  BUMP TO NEXT FIELD                           
         ZIC   R0,0(R2)                                                         
         AR    R2,R0                                                            
                                                                                
         CR    R2,R3               CHECK FOR ENDING CONDITION                   
         BL    MNI10                                                            
         BE    MNIX                                                             
         DC    H'0'                                                             
*                                                                               
MNIX     DS    0H                                                               
         J     XIT                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR05--MISC STUF+        
               F)'                                                              
*--------------------- SUBR05 MISCELLANEOUS STUFF --------------------*         
                                                                                
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR05--LTORG && +        
               CONSTANTS)'                                                      
*------------------------- LTORG & CONSTANTS -------------------------*         
         LTORG                                                                  
                                                                                
                                                                                
SUBR05L  EQU   *-SUBR05                                                         
         DS    0CL(X'1000'-SUBR05L+1)                                           
***********************************************************************         
                                                                                
         DROP  R7,R8,RA,RB,RC                                                   
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR06)'                  
***********************************************************************         
*======================== SUBROUTINE POOL SIX ========================*         
                                                                                
* At entry,                                                                     
*   RA-->TWA,                                                                   
*   R8-->SYSD,                                                                  
*   R7-->SPOOLD,                                                                
*   R1-->GEND,                                                                  
*   GOSUBN = equated sub-routine number.                                        
                                                                                
SUBR06Q  EQU   (((*-RMP18+X'0FFF')/X'1000')*X'1000')                            
                                                                                
         ORG   RMP18+SUBR06Q                                                    
SUBR06   NMOD1 0,**1806**                                                       
         LR    RC,R1                                                            
         USING GEND,RC             RC=A(GENCON WORK AREA)                       
         USING CONHEADH-64,RA      RA=A(TWA)                                    
         USING SYSD,R8             R8=A(SYSD)                                   
         USING SPOOLD,R7           R7=A(SPOOL WORK AREA)                        
                                                                                
         ZIC   R1,GOSUBN                                                        
         SH    R1,=Y(R05#)         SUBTRACT FOR SUB-RTN # 5                     
         BCTR  R1,0                                                             
         SLL   R1,2                                                             
         B     R06_00(R1)                                                       
                                                                                
LSCR#    EQU   ((R06_01-R06_00)/4+1)+R05#  LOAD SCREEN                          
IXDT#    EQU   ((R06_02-R06_00)/4+1)+R05#  INITIALIZE EXPANDED DEMO TBL         
XDPTR#   EQU   ((R06_03-R06_00)/4+1)+R05#  EXPND DEMOS "SMART"-POINTER          
XDXDV#   EQU   ((R06_04-R06_00)/4+1)+R05#  EXPND DEMOS EXTRACT DEM VALS         
XDCLA#   EQU   ((R06_05-R06_00)/4+1)+R05#  EXPND DEMOS CLEAR AREA               
XDDIS#   EQU   ((R06_06-R06_00)/4+1)+R05#  EXPND DEMOS DISPLAY DEMOS            
XDDMVL#  EQU   ((R06_07-R06_00)/4+1)+R05#  EXPND DEMOS VALIDATE DEMOS           
DLTN#    EQU   ((R06_08-R06_00)/4+1)+R05#  DELETE LIST TABLE ENTRIES            
BIT#     EQU   ((R06_09-R06_00)/4+1)+R05#  BUILD INVENTORY TRACK                
FNR#     EQU   ((R06_10-R06_00)/4+1)+R05#  FIX NEW RECORD                       
UAE#     EQU   ((R06_11-R06_00)/4+1)+R05#  UPDATE ACTIVITY ELEMENT              
PLR#     EQU   ((R06_12-R06_00)/4+1)+R05#  PROCESS LTRANS REQUEST               
VADP#    EQU   ((R06_13-R06_00)/4+1)+R05#  VALIDATE ALT DY/TM FOR PUTS          
FADP#    EQU   ((R06_14-R06_00)/4+1)+R05#  FORMAT ALT DY/TM FOR PUTS            
                                                                                
R06_00   DS    0H                                                               
R06_01   B     LOADSCRN               LOAD SCREEN                               
R06_02   B     INITXDTB               INITIALIZE EXPANDED DEMOS TABLE           
R06_03   B     XPNDPTR                EXPANDED DEMOS "SMART"-POINTER            
R06_04   B     XDXDMVAL               EXPANDED DEMOS EXTRACT DEM VALS           
R06_05   B     XDCLAREA               EXPANDED DEMOS CLEAR AREA                 
R06_06   B     XDDISXD                EXPANDED DEMOS DISPLAY DEMOS              
R06_07   B     XDDMVAL                EXPANDED DEMOS VALIDATE DEMOS             
R06_08   B     DELTNTRY               DELETE LIST TABLE ENTRIES                 
R06_09   B     BLDIVTRK               BUILD INVENTORY TRACK                     
R06_10   B     FXNEWREC               FIX NEW RECORD                            
R06_11   B     UPACTVEL               UPDATE ACTIVITY ELEMENT                   
R06_12   B     PRCLTRNS               PROCESS LTRANS REQUEST                    
R06_13   B     VALADTP                VALIDATE ALT DY/TM FOR PUTS               
R06_14   J     FMTADTP                FORMAT ALT DY/TM FOR PUTS                 
R06#     EQU   ((*-R06_00)/4)+R05#                                              
         DC    H'0'                                                             
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR06--LSCR#)'           
*---------------------------- LOAD SCREEN ----------------------------*         
                                                                                
* At entry,                                                                     
*   SCRNFLG   indicates which screen to load                                    
* At exit,                                                                      
*   NLSTLNS = # of list lines available to list LISTTAB entries                 
*   DLASTLLN = displacement to last display list line                           
*   DLASTINP = displacement to last input field                                 
*   DPFLINEH = displacement to header for PFline                                
                                                                                
LOADSCRN DS    0H                                                               
         TM    SCRNFLG,SCRFLIST                                                 
         BO    LSCRLI                                                           
         TM    SCRNFLG,SCRFXPDM                                                 
         BO    LSCRXD                                                           
         DC    H'0'                                                             
                                                                                
*                                                                               
** Original ROVER list screen **                                                
*                                                                               
LSCRLI   DS    0H                                                               
         MVI   BYTE,SCINVROV                                                    
         BAS   RE,LSCRCALL         "LOAD" SCREEN INTO BUFF                      
         BE    *+6                                                              
         DC    H'0'                                                             
                                                                                
*                                                                               
         DS    0H                  APPEND & TRANSMIT SCREEN                     
         LA    R2,IROXPDMH                                                      
         ST    R2,FULL              FULL = DESTINATION TO APPEND SCREEN         
         LA    R2,IROXPDMH-CONTAGH                                              
         LA    R2,BUFF(R2)          R2-->STARTING POINT OF SOURCE               
         BAS   RE,LSCRXMMV                                                      
                                                                                
*                                                                               
         DS    0H                  SET VARIABLES                                
         MVI   NLSTLNS,MXLSTLNS     # OF AVAILBLE LIST LINES                    
*                                                                               
         L     R0,ATWA                                                          
                                                                                
         LA    R2,IROLDTZH                                                      
         SR    R2,R0                                                            
         STH   R2,DLASTLLN          DISPLACEMENT LAST DISPLAY LIST LINE         
                                                                                
         STH   R2,DLASTINP          DISPLACEMENT TO LAST INPUT FIELD            
                                                                                
         LA    R2,IROPFLNH                                                      
         SR    R2,R0                                                            
         STH   R2,DPFLINEH          DISPLACEMENT TO PF LINE                     
*                                                                               
         B     LSCR049                                                          
                                                                                
*                                                                               
** ROVER expanded demos **                                                      
*                                                                               
LSCRXD   DS    0H                                                               
         MVI   BYTE,SCINVXDM                                                    
         BAS   RE,LSCRCALL         "LOAD" SCREEN INTO BUFF                      
         BE    *+6                                                              
         DC    H'0'                                                             
                                                                                
*                                                                               
         DS    0H                  APPEND & TRANSMIT SCREEN                     
         LA    R2,IR2XPDMH                                                      
         ST    R2,FULL              FULL = DESTINATION TO APPEND SCREEN         
         LA    R2,BUFF              R2-->STARTING POINT OF SOURCE               
         BAS   RE,LSCRXMMV                                                      
                                                                                
*                                                                               
         DS    0H                  SET VARIABLES                                
         MVI   NLSTLNS,MXLSLNXD     # OF AVAILBLE LIST LINES                    
*                                                                               
         L     R0,ATWA                                                          
                                                                                
         LA    R2,MXLSLNXD-1                                                    
         MH    R2,=Y(SZLSTLIN)                                                  
         LA    R2,IROLDTAH(R2)                                                  
         SR    R2,R0                                                            
         STH   R2,DLASTLLN          DISPLACEMENT LAST DISPLAY LIST LINE         
                                                                                
         LA    R2,IR2XDC6H                                                      
         SR    R2,R0                                                            
         STH   R2,DLASTINP          DISPLACEMENT TO LAST INPUT FIELD            
                                                                                
         LA    R2,IR2PFLNH                                                      
         SR    R2,R0                                                            
         STH   R2,DPFLINEH          DISPLACEMENT TO PF LINE                     
*                                                                               
         B     LSCR049                                                          
                                                                                
*                                                                               
LSCR049  EQU   *                                                                
                                                                                
*                                                                               
         DS    0H                                                               
         B     LSCRX                                                            
                                                                                
*                                                                               
** EXIT **                                                                      
*                                                                               
LSCRX    DS    0H                                                               
         J     XIT                                                              
                                                                                
                                                                                
* Little helper routine to call CALLOV to move screen into BUFF                 
* At entry,                                                                     
*   BYTE = screen number to load                                                
* At exit,                                                                      
*   CC set to Equal if CALLOV returned no errors                                
*   CC set to NEqual if CALLOV returned w/ errors                               
                                                                                
LSCRCALL NTR1                                                                   
         GOTO1 CALLOV,DMCB,(BYTE,BUFF),0                                        
         CLI   DMCB+4,XFF                                                       
         JE    NO                                                               
         J     YES                                                              
                                                                                
                                                                                
* Little helper routine to append screen to TWA and transmit it                 
* At entry,                                                                     
*   FULL = destination in TWA to move to                                        
*   R2  -->source to move from                                                  
* **WARNING** R0, R1 & R3 gets clobbered, but do NOT clobber RE!                
                                                                                
LSCRXMMV DS    0H                                                               
         LR    R3,R2               USE R3 TO BUMP THROUGH FIELDS                
         SR    R0,R0                                                            
                                                                                
         CLI   0(R3),0             END OF SCREEN YET?                           
         BE    *+18                                                             
         OI    6(R3),X80            TRANSMIT FIELD                              
         IC    R0,0(R3)                                                         
         AR    R3,R0                BUMP TO NEXT FIELD                          
         B     *-18                                                             
                                                                                
         MVC   1(2,R3),=X'0101'    TRANSMIT ENTIRE SCREEN                       
         LA    R3,3(R3)                                                         
         SR    R3,R2               R3 = L(SCREEN TO APPEND TO TWA)              
         L     R0,FULL                                                          
         LR    R1,R3                                                            
         MVCL  R0,R2                                                            
                                                                                
         BR    RE                                                               
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR06--IXDT#)'           
*------------------ INITIALIZE EXPANDED DEMOS TABLE ------------------*         
                                                                                
INITXDTB DS    0H                                                               
         L     R2,AXPNDMTB                                                      
         XC    0(XPNDMTBL,R2),0(R2)                                             
         USING XPNDMTBD,R2                                                      
         LA    R3,XDDFLTDC                                                      
*                                                                               
IXDT012  DS    0H                                                               
         CLI   0(R3),EOT                                                        
         BE    IXDT018                                                          
                                                                                
         MVC   XDTDEMC,0(R3)       MOVE IN DEMO CATEGORY                        
         MVI   XDTRIMOD,C'R'       SET MODIFIER TO RATINGS                      
         MVI   XDTSHMOD,C'S'       SET MODIFIER TO SHARES                       
         MVI   XDTPTMOD,C'P'       SET MODIFIER TO PUTs                         
                                                                                
         LA    R2,XPNDMTBQ(R2)                                                  
         LA    R3,L'XDDFLTDC(R3)                                                
         B     IXDT012                                                          
IXDT018  EQU   *                                                                
         MVI   0(R2),EOT           SET EOT MARKER IN EXPAND DEMO TABLE          
         DROP  R2                                                               
                                                                                
*                                                                               
         DS    0H                                                               
         J     XIT                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR06--XDPTR#)'          
*------------------- EXPANDED DEMOS "SMART"-POINTER ------------------*         
                                                                                
* Acts as a pointer to a column of expanded demos, and calls the                
*  appropriate routine to perform a function on that column                     
* At entry,                                                                     
*   GOSUBNXD = routine number to call for each column of expanded demos         
* At exit,                                                                      
*   CC set to equal if everything went okay                                     
*   CC set to not equal otherwise                                               
                                                                                
XPNDPTR  DS    0H                                                               
         MVC   AXDTNTRY,AXPNDMTB                                                
*                                                                               
         TM    SCRNFLG,SCRFXPDM    EXPANDED DEMO SCREEN LOADED?                 
         BZ    XPTR004G             NOPE                                        
         LA    R0,IR2XDC1H                                                      
         ST    R0,AXDDEMC                                                       
         LA    R0,IR2XDRIH                                                      
         ST    R0,AXDRI                                                         
         LA    R0,IR2XDSHH                                                      
         ST    R0,AXDSH                                                         
         LA    R0,IR2XDPTH                                                      
         ST    R0,AXDPT                                                         
XPTR004G EQU   *                                                                
                                                                                
*                                                                               
** PROCESS EXPANDED DEMOS COLUMNS **                                            
*                                                                               
         MVI   COUNTER,0                                                        
                                                                                
*                                                                               
XDPTR022 DS    0H                                                               
         CLI   COUNTER,MXEXPNDM    REACHED LAST COLUMN OF EXPANDED DEM?         
         BNL   XDPTR029                                                         
*                                                                               
         MVC   GOSUBN,GOSUBNXD                                                  
         GOTO1 AGOSUB              CALL ROUTINE TO PROCESS COLUMN               
         BNE   XDPTRXN                                                          
*                                                                               
         DS    0H                  BUMP POINTERS                                
         LA    RF,XPNDMTBQ                                                      
         A     RF,AXDTNTRY                                                      
         ST    RF,AXDTNTRY          EXPANDED DEMOS DEMO TABLE ENTRY             
                                                                                
         TM    SCRNFLG,SCRFXPDM    EXPANDED DEMO SCREEN LOADED?                 
         BZ    XPTR026X             NOPE                                        
         LA    R1,1                                                             
         LA    RF,AXDDEMC           DEMO CATEGORY                               
         BAS   RE,XDPTRBMP                                                      
         LA    R1,2                                                             
         LA    RF,AXDRI             RATINGS/IMPRESSION                          
         BAS   RE,XDPTRBMP                                                      
         LA    R1,2                                                             
         LA    RF,AXDSH             SHARES                                      
         BAS   RE,XDPTRBMP                                                      
         LA    R1,2                                                             
         LA    RF,AXDPT             PUTs/TOTALS                                 
         BAS   RE,XDPTRBMP                                                      
XPTR026X EQU   *                                                                
*                                                                               
         DS    0H                  UPDATE LOOP COUNTER                          
         ZIC   R1,COUNTER                                                       
         LA    R1,1(R1)                                                         
         STC   R1,COUNTER                                                       
         B     XDPTR022                                                         
XDPTR029 EQU   *                                                                
*                                                                               
         B     XDPTRXY                                                          
                                                                                
*                                                                               
** EXITS **                                                                     
*                                                                               
XDPTRXN  DS    0H                                                               
         J     NO                                                               
*                                                                               
XDPTRXY  DS    0H                                                               
         J     YES                                                              
                                                                                
                                                                                
                                                                                
* Little helper routine to bump an expanded demo field to the                   
*  next column                                                                  
* At entry,                                                                     
*   R1 = # of fields that actually need to be bypassed                          
*   RF-->Pointer to be bumped                                                   
* At exit,                                                                      
*   RF-->updated pointer                                                        
* !!WARNING!! R0 & R2 will clobbered, but do NOT clobber RE here                
                                                                                
XDPTRBMP DS    0H                                                               
         SR    R0,R0                                                            
         L     R2,0(RF)            R2 = POINTER TO BE BUMPED                    
*                                                                               
         ICM   R0,1,0(R2)                                                       
         BNZ   *+6                                                              
         DC    H'0'                                                             
         AR    R2,R0                                                            
         BCT   R1,*-12                                                          
*                                                                               
         ST    R2,0(RF)            STORE UPDATED POINTER                        
         BR    RE                                                               
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR06--XDXDV#)'          
*--------------- EXTRACT DEMO VALUES FOR EXPANDED DEMOS --------------*         
                                                                                
* At entry,                                                                     
*   AXDTNTRY = A(expanded demos table entry)                                    
*   AXDDEMC  = A(expanded demos demo category field)                            
*   AXDRI    = A(expanded demos ratings/impressions field)                      
*   AXDSH    = A(expanded demos shares field)                                   
*   AXDPT    = A(expanded demos puts/totals field)                              
*   R6       = A(inventory track record)                                        
* At exit,                                                                      
*   CC set to equal if everything okay,                                         
*   CC set to not equal otherwise                                               
                                                                                
XDXDMVAL DS    0H                                                               
         XC    XDDEMLST(XDDMLSTL),XDDEMLST                                      
                                                                                
*                                                                               
         DS    0H                                                               
         L     R3,AXDTNTRY                                                      
         USING XPNDMTBD,R3                                                      
*                                                                               
         DS    0H                  BUILD DEMO LIST                              
         MVC   XDDEMLST+1(1),XDTRIMOD                                           
         MVC   XDDEMLST+2(1),XDTDEMC                                            
         MVC   XDDEMLST+4(1),XDTSHMOD                                           
         MVC   XDDEMLST+5(1),XDTDEMC                                            
         MVC   XDDEMLST+7(1),XDTPTMOD                                           
         MVC   XDDEMLST+8(1),XDTDEMC                                            
         MVI   XDDEMLST+9,XFF                                                   
*                                                                               
         DS    0H                  CLEAR DEMO VALUES & INITIALIZE FLAGS         
         XC    XDTRIVAL,XDTRIVAL                                                
         NI    XDTRIFLG,XFF-XDTRIFOV                                            
         XC    XDTSHVAL,XDTSHVAL                                                
         NI    XDTSHFLG,XFF-XDTSHFOV                                            
         XC    XDTPTVAL,XDTPTVAL                                                
         NI    XDTPTFLG,XFF-XDTPTFOV                                            
                                                                                
*                                                                               
         DS    0H                  GET DEMO VALUES & OVERRIDE FLAGS             
         LA    R0,XDDEMLST                                                      
         ST    R0,ADEMLIST                                                      
         MVI   GOSUBN,XDV#                                                      
         GOTO1 AGOSUB                                                           
                                                                                
*                                                                               
         DS    0H                  SEED VALS INTO EXPANDED DEM TBL NTRY         
         MVC   XDTRIVAL,THISDEMV+0  RTG/IMP DEMO VALUE                          
         CLI   DEMOVRDS+0,C'*'      WAS IT AN OVERRIDE?                         
         BNE   *+8                                                              
         OI    XDTRIFLG,XDTRIFOV     YES, FLAG IT                               
                                                                                
         MVC   XDTSHVAL,THISDEMV+4  SHARE   DEMO VALUE                          
         CLI   DEMOVRDS+1,C'*'      WAS IT AN OVERRIDE?                         
         BNE   *+8                                                              
         OI    XDTSHFLG,XDTSHFOV     YES, FLAG IT                               
                                                                                
         MVC   XDTPTVAL,THISDEMV+8  PUT/TTL DEMO VALUE                          
         CLI   DEMOVRDS+2,C'*'      WAS IT AN OVERRIDE?                         
         BNE   *+8                                                              
         OI    XDTPTFLG,XDTPTFOV     YES, FLAG IT                               
         DROP  R3                                                               
                                                                                
*                                                                               
         DS    0H                                                               
         J     YES                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR06--XDCLA#)'          
*---------------------- CLEAR EXPANDED DEMOS AREA --------------------*         
                                                                                
* At entry,                                                                     
*   AXDTNTRY = A(expanded demos table entry)                                    
*   AXDDEMC  = A(expanded demos demo category field)                            
*   AXDRI    = A(expanded demos ratings/impressions field)                      
*   AXDSH    = A(expanded demos shares field)                                   
*   AXDPT    = A(expanded demos puts/totals field)                              
*   R6       = A(inventory track record)                                        
* At exit,                                                                      
*   CC set to equal if everything okay,                                         
*   CC set to not equal otherwise                                               
                                                                                
XDCLAREA DS    0H                                                               
                                                                                
*                                                                               
         DS    0H                  DEMO CATEGORY FIELD                          
         L     RF,AXDDEMC                                                       
         LA    R0,1                                                             
         BAS   RE,XDCLAHLP                                                      
*                                                                               
         DS    0H                  RATINGS/IMPRESSIONS FIELD                    
         L     RF,AXDRI                                                         
         LA    R0,2                                                             
         BAS   RE,XDCLAHLP                                                      
*                                                                               
         DS    0H                  SHARES FIELD                                 
         L     RF,AXDSH                                                         
         LA    R0,2                                                             
         BAS   RE,XDCLAHLP                                                      
*                                                                               
         DS    0H                  PUT/TOTALS FIELD                             
         L     RF,AXDPT                                                         
         LA    R0,2                                                             
         BAS   RE,XDCLAHLP                                                      
                                                                                
*                                                                               
         DS    0H                                                               
         J     YES                                                              
                                                                                
                                                                                
                                                                                
* Little helper routine to clear consecutive fields                             
* At entry,                                                                     
*   R0 = # of fields to clear                                                   
*   RF-->Field header of field to clear                                         
                                                                                
XDCLAHLP NTR1                                                                   
         SR    R1,R1                                                            
                                                                                
XDCLAHLPB DS   0H                                                               
         IC    R1,0(RF)                                                         
         LR    RE,R1                                                            
         SH    RE,=H'9'                                                         
         TM    1(RF),X02           TEST FOR EXTENDED FIELD HEADER               
         BZ    *+8                                                              
         SH    RE,=H'8'                                                         
         EX    RE,*+8                                                           
         B     *+10                                                             
         XC    8(0,RF),8(RF)                                                    
         OI    6(RF),X80                                                        
         AR    RF,R1                                                            
         BCT   R0,XDCLAHLPB                                                     
         J     XIT                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR06--XDDIS#)'          
*----------------------- DISPLAY EXPANDED DEMOS ----------------------*         
                                                                                
* At entry,                                                                     
*   AXDTNTRY = A(expanded demos table entry)                                    
*   AXDDEMC  = A(expanded demos demo category field)                            
*   AXDRI    = A(expanded demos ratings/impressions field)                      
*   AXDSH    = A(expanded demos shares field)                                   
*   AXDPT    = A(expanded demos puts/totals field)                              
*   R6       = A(inventory track record)                                        
* At exit,                                                                      
*   CC set to equal if everything okay,                                         
*   CC set to not equal otherwise                                               
                                                                                
XDDISXD  DS    0H                                                               
         L     R3,AXDTNTRY                                                      
         USING XPNDMTBD,R3                                                      
*                                                                               
         OC    XDTDEMC,XDTDEMC     ANYTHING TO DISPLAY?                         
         BZ    XDDISXY              NO, EXIT NOW                                
                                                                                
*                                                                               
** DEMO CATEGORY NAME **                                                        
*                                                                               
         XC    DUB,DUB                                                          
         MVC   DUB+1(1),XDTRIMOD                                                
         MVC   DUB+2(1),XDTDEMC                                                 
         MVI   DUB+3,XFF           DELIMITER FOR DEMOLIST                       
         MVI   BYTE,6              OUTPUT TYPE                                  
                                                                                
         MVI   GOSUBN,TDM#                                                      
         GOTO1 AGOSUB                                                           
*                                                                               
         L     R2,AXDDEMC                                                       
         MVC   8(6,R2),WORK                                                     
                                                                                
*                                                                               
** RATINGS/IMPRESSIONS DEMO VALUE **                                            
*                                                                               
         DS    0H                                                               
         L     R2,AXDRI                                                         
*                                                                               
         ICM   R1,15,XDTRIVAL                                                   
         EDIT  (R1),(L'IR2XDRI,8(R2)),1,ZERO=NOBLANK                            
*                                                                               
         TM    XDTRIFLG,XDTRIFOV                                                
         BZ    XDDISRI29                                                        
         ZIC   RF,0(R2)                                                         
         AR    RF,R2                                                            
         MVI   8(RF),C'*'                                                       
XDDISRI29 EQU  *                                                                
                                                                                
*                                                                               
** SHARE DEMO VALUE **                                                          
*                                                                               
         DS    0H                                                               
         L     R2,AXDSH                                                         
*                                                                               
         ICM   R1,15,XDTSHVAL                                                   
         EDIT  (R1),(L'IR2XDSH,8(R2)),1,ZERO=NOBLANK                            
         TM    DEMFLAG1,DF1ADCMB                                                
         BZ    *+16                                                             
         MVC   8(L'IR2XDSH,R2),SPACES                                           
         MVC   8+(L'IR2XDSH-3)(3,R2),=C'N/A'    RIGHT-JUSTIFIED                 
*                                                                               
         TM    XDTSHFLG,XDTSHFOV                                                
         BZ    XDDISSH29                                                        
         ZIC   RF,0(R2)                                                         
         AR    RF,R2                                                            
         MVI   8(RF),C'*'                                                       
XDDISSH29 EQU  *                                                                
                                                                                
*                                                                               
** PUTS/TOTALS DEMO VALUE **                                                    
*                                                                               
         DS    0H                                                               
         L     R2,AXDPT                                                         
*                                                                               
         ICM   R1,15,XDTPTVAL                                                   
         EDIT  (R1),(L'IR2XDPT,8(R2)),1,ZERO=NOBLANK                            
         TM    DEMFLAG1,DF1ADCMB                                                
         BZ    *+16                                                             
         MVC   8(L'IR2XDPT,R2),SPACES                                           
         MVC   8+(L'IR2XDPT-3)(3,R2),=C'N/A'    RIGHT-JUSTIFIED                 
*                                                                               
         TM    XDTPTFLG,XDTPTFOV                                                
         BZ    XDDISPT29                                                        
         ZIC   RF,0(R2)                                                         
         AR    RF,R2                                                            
         MVI   8(RF),C'*'                                                       
XDDISPT29 EQU  *                                                                
                                                                                
         DROP  R3                                                               
                                                                                
*                                                                               
XDDISXY  DS    0H                                                               
         J     YES                                                              
                                                                                
                                                                                
         DS    0XL((L'IR2XDPT-3)+1)  PREVENTS CLOBBERING OF FLD HEADER          
         DS    0XL((L'IR2XDSH-3)+1)  PREVENTS CLOBBERING OF FLD HEADER          
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR06--XDDMVL#)'         
*----------------------- VALIDATE DEMO CATEGORY ----------------------*         
                                                                                
* At entry,                                                                     
*   AXDTNTRY = A(expanded demos table entry)                                    
*   AXDDEMC  = A(expanded demos demo category field)                            
*   AXDRI    = A(expanded demos ratings/impressions field)                      
*   AXDSH    = A(expanded demos shares field)                                   
*   AXDPT    = A(expanded demos puts/totals field)                              
*   R6       = A(inventory track record)                                        
* At exit,                                                                      
*   CC set to equal if everything okay,                                         
*   CC set to not equal otherwise                                               
*     - ACURFORC = A(field with error)                                          
*     - OURERRCD = 0 if demo category inputted is invalid                       
*                <>0 if other kinds of error                                    
                                                                                
XDDMVAL  DS    0H                                                               
         MVI   OURERRCD,0          ASSUME NO ERROR                              
*                                                                               
         L     R2,AXDDEMC                                                       
         TM    4(R2),X80           WAS IT INPUTTED THIS TIME?                   
         BZ    XDDMVLXY             NOPE                                        
         OI    CHNGFLG1,CF1XDDC     YEP!                                        
                                                                                
*                                                                               
         L     R3,AXDTNTRY                                                      
         USING XPNDMTBD,R3                                                      
*                                                                               
         XC    XPNDMTBD(XPNDMTBQ),XPNDMTBD                                      
                                                                                
*                                                                               
         DS    0H                                                               
         XC    DUB,DUB             INITIALIZE OUTPUT AREA                       
*                                                                               
         DS    0H                  BUILD DBLOCK FOR DEMOVAL                     
         MVI   GOSUBN,CDBK#                                                     
         GOTO1 AGOSUB                                                           
*                                                                               
         L     R5,ADBLOCK                                                       
         USING DBLOCKD,R5                                                       
         MVC   DBFILE,IPFILE                                                    
         MVC   DBCOMFCS,ACOMFACS                                                
         MVI   DBSELMED,C'T'                                                    
         MVC   DBSELSRC,IPRSVC                                                  
         MVC   DBSELAGY,TWAAGY                                                  
         MVI   BYTE,C'S'                                                        
         CLC   DBFILE,DCFILPAV                                                  
         BNE   *+8                                                              
         MVI   BYTE,0                                                           
                                                                                
         GOTO1 DEMOVAL,DMCB,(1,(R2)),(1,DUB),(BYTE,DBLOCKD),0                   
         CLI   DMCB+0,0                                                         
         BNE   XDDMVLXN                                                         
         DROP  R5                                                               
                                                                                
*                                                                               
         DS    0H                                                               
         CLC   XDTDEMC,DUB+2       MATCH ON DEMO CATEGORY?                      
         BNE   XDDMVL32                                                         
         CLC   XDTRIMOD,DUB+1      MATCH ON MODIFIER?                           
         BNE   XDDMVL32                                                         
         B     XDDMVL39                                                         
*                                                                               
XDDMVL32 DS    0H                                                               
         MVC   XDTDEMC,DUB+2       DEMO CATEGORY                                
                                                                                
         MVC   XDTRIMOD,DUB+1      RTG/IMPS                                     
                                                                                
         MVI   XDTSHMOD,C'S'       SHARES                                       
                                                                                
         DS    0H                  PUTS/TOTS                                    
         MVI   XDTPTMOD,C'P'                                                    
         CLI   DUB+1,C'R'                                                       
         BE    *+8                                                              
         MVI   XDTPTMOD,C'Q'                                                    
XDDMVL39 EQU   *                                                                
*                                                                               
         B     XDDMVLXY                                                         
         DROP  R3                                                               
                                                                                
*                                                                               
** EXITS **                                                                     
*                                                                               
XDDMVLXN DS    0H                                                               
         ST    R2,ACURFORC                                                      
         J     NO                                                               
*                                                                               
XDDMVLXY DS    0H                                                               
         J     YES                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR06--DLTN#)'           
*---------------------- DELETE LIST TABLE ENTRIES --------------------*         
                                                                                
DELTNTRY DS    0H                                                               
         SR    R1,R1               COUNTS # OF ENTRIES NOT SEL-FOR-DEL          
         L     RE,ALISTTAB                                                      
         USING LISTTABD,RE                                                      
                                                                                
DLTN010  DS    0H                  FIND 1ST ENTRY SELECTED-FOR-DELETE           
         CLI   0(RE),EOT                                                        
         BE    DLTN030                                                          
         TM    LTFLAG,LTFDEL                                                    
         BNZ   DLTN020                                                          
         LA    RE,LISTTABQ(RE)                                                  
         LA    R1,1(R1)            UPDATE CNT OF NON SEL-FOR-DEL NTRYS          
         B     DLTN010                                                          
         DROP  RE                                                               
*                                                                               
DLTN020  DS    0H                                                               
         LA    RF,LISTTABQ(RE)                                                  
         USING LISTTABD,RF                                                      
                                                                                
DLTN022  DS    0H                                                               
         CLI   0(RF),EOT                                                        
         BE    DLTN030                                                          
         TM    LTFLAG,LTFDEL       IF ENTRY WAS NOT SEL-FOR-DEL,                
         BNZ   DLTN024                                                          
         MVC   0(LISTTABQ,RE),0(RF)  MOVE IT UP TO NEXT AVAILABLE SLOT,         
         LA    R1,1(R1)                                                         
         STC   R1,(LTNTRY-LISTTABD)(RE)  ASSIGN A NEW ENTRY #                   
         LA    RE,LISTTABQ(RE)                                                  
                                                                                
DLTN024  DS    0H                  BUMP FRONT POINTER TO NEXT ENTRY             
         LA    RF,LISTTABQ(RF)                                                  
         B     DLTN022                                                          
*                                                                               
DLTN030  DS    0H                  REACHED LAST ENTRY                           
         ST    RE,ANLTNTRY          STORE A(NEXT AVAILABLE SLOT)                
         LA    RF,MXLTNTRY          MAX # OF ENTRIES IN TABLE,                  
         STC   R1,NLTNTRY            LESS # OF ENTRIES IN TABLE,                
         SR    RF,R1                 YIELDS # OF SLOTS LEFT                     
         BZ    DLTNX                                                            
         BP    *+6                                                              
         DC    H'0'                                                             
         MH    RF,=Y(LISTTABQ)                                                  
         SR    R0,R0                                                            
         SR    R1,R1                                                            
         MVCL  RE,R0                CLEAR REMAINING PORTION OF TABLE            
         DROP  RF                                                               
*                                                                               
DLTNX    DS    0H                                                               
         J     XIT                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR06--BIT#)'            
*----------------------- BUILD INVENTORY TRACK -----------------------*         
                                                                                
* Builds an inventory record out of selected entries in LISTTAB.  If            
*  there are no selected entries, then it uses all the entries to               
*  build the inventory track.                                                   
* At entry,                                                                     
*   AIO1 = A(original inventory track record).                                  
*   ACTVWHY = reason for activity                                               
*   SELTYPE = type of select to process                                         
*   RF1TKSAV on ==> building track to write back to file                        
* At exit,                                                                      
*   AIO3 = A(inventory track built).                                            
*   CC set to equal if track built okay,                                        
*   CC set to not equal otherwise, and OURERRCD is set                          
                                                                                
BLDIVTRK DS    0H                                                               
         CLI   NLTNTRY,0           ANY ENTRIES?                                 
         BE    BITXY                NO, EXIT NOW                                
*                                                                               
         MVI   FUDGED,C'N'         ASSUME NOT FUDGING                           
                                                                                
         MVI   BYTE,SF1AL1ES                                                    
         CLI   SELTYPE,C'S'                                                     
         BE    BIT005G                                                          
         MVI   BYTE,SF1AL1ESXD                                                  
         CLI   SELTYPE,C'E'                                                     
         BE    BIT005G                                                          
         DC    H'0'                                                             
BIT005G  EQU   *                                                                
         NC    BYTE,SELFLAG1       ANY ENTRIES SELECTED?                        
         BNZ   BIT030               YES                                         
                                                                                
*                                                                               
** FUDGE EACH ENTRY AS SELECTED **                                              
*                                                                               
         TM    RECDFLG1,RF1DNXST   IF TRACK DOESN'T EXIST,                      
         BNZ   BIT030               DON'T FUDGE ENTRIES AS SELECTED             
*                                                                               
         DS    0H                                                               
         LA    R1,LTFLAG-LISTTABD                                               
         MVI   BYTE,LTFSEL                                                      
         CLI   SELTYPE,C'S'                                                     
         BE    BIT021X                                                          
         LA    R1,LTFLAG-LISTTABD                                               
         MVI   BYTE,LTFSELXD                                                    
         CLI   SELTYPE,C'E'                                                     
         BE    BIT021X                                                          
         DC    H'0'                                                             
BIT021X  EQU   *                                                                
*                                                                               
         ZIC   R0,NLTNTRY                                                       
         L     R4,ALISTTAB                                                      
         USING LISTTABD,R4                                                      
                                                                                
BIT022   DS    0H                                                               
         LA    RF,LISTTABD(R1)                                                  
         XC    0(1,RF),BYTE        EXCLUSIVE OR SHOULD TURN FLAG ON             
         LA    R4,LISTTABQ(R4)                                                  
         BCT   R0,BIT022                                                        
         DROP  R4                                                               
BIT022X  EQU   *                                                                
         MVI   FUDGED,C'Y'         REMEMBER THAT ENTRIES WERE FUDGED            
                                                                                
*                                                                               
** BUILD INVENTORY TRACK **                                                     
*                                                                               
BIT030   DS    0H                                                               
         CLI   OPVUPGNM,0          IF WE ALREADY HAVE UPGRADE FORMULA,          
         BH    BIT032X              SKIP AUTO-UPGRADE PROCESS                   
         TM    IKFRBTS,BBPBK       IF TRACK IS NOT A P-                         
         BO    *+8                                                              
         TM    IKFRBTS,BBEBK        OR AN E- TRACK,                             
         BO    *+8                                                              
         B     BIT032X               SKIP AUTO-UPGRADE PROCESS                  
         CLI   IKBOOK+1,0          IF MONTH IS ZERO (ESTyy BOOK),               
         BE    BIT032X              SKIP AUTO-UPGRADE PROCESS                   
         TM    RMPPROFS+RMPRDPUB,RMPRDPUA  IF AUTO-UPGRADE IS OFF,              
         BZ    BIT032X                      SKIP AUTO-UPGRADE PROCESS           
*                                                                               
         DS    0H                  SET FOR AUTO UPGRADE                         
         L     R6,AIO1                                                          
         GOTO1 BLDDEFUP                                                         
         BNE   BIT032X              IF ERROR, SKIP AUTO-UPGRADE                 
         MVC   OPVUPGTB(UPGDLNQ),ELEM                                           
         MVI   OPVUPGNM,1                                                       
         OI    UPGFLAG,UPGFPUT                                                  
         OI    DPLYFLG1,DF1OPTN                                                 
BIT032X  EQU   *                                                                
                                                                                
*                                                                               
         DS    0H                                                               
         MVI   GOSUBN,CCV#         BUILD TRACK W/ DEMO (& OTHER) ELEMS          
         GOTO1 AGOSUB               IN  BUFF  AREA                              
         LA    R6,BUFF                                                          
*                                                                               
         CLI   SELTYPE,C'S'                                                     
         BNE   BIT070                                                           
         TM    SELFLAG1,SF1AL1ES   IF NO ENTRIES SELECTED,                      
         BZ    BIT070               NO DEMO HISTORY ELEMS TO ADD                
         TM    RECDFLG1,RF1TKSAV   IF TRACK NOT BEING WRITTEN TO FILE,          
         BZ    BIT070               NO DEMO HISTORY ELEMS TO ADD                
                                                                                
                                                                                
         DS    0H                  ADD DEMO HISTORY ELEMENTS                    
         MVI   COUNTER,0                                                        
         L     R4,ALISTTAB                                                      
         USING LISTTABD,R4                                                      
*                                                                               
         MVC   UPSHFRBK,LTFRBK     INITIALIZE TO BOOK OF 1ST ENTRY              
*                                                                               
BIT035   DS    0H                                                               
         TM    LTFLAG,LTFSEL       WAS THIS ENTRY SELECTED?                     
         BZ    BIT065               NO, NOT PART OF DEMO HISTORY                
                                                                                
         CLC   UPSHFRBK,LTFRBK     ANY CHANGE IN SHARE BOOK?                    
         BE    *+10                                                             
         XC    UPSHFRBK,UPSHFRBK    YES, THEN DON'T USE ANY AT ALL              
                                                                                
         XC    ELEM,ELEM                                                        
         LA    R3,ELEM                                                          
         USING RIDHEL,R3                                                        
         MVI   RIDHCD,RIDHCDQ      ELEMENT CODE                                 
         MVI   RIDHLEN,RIDHELLN       "    LENGTH                               
         MVC   RIDHFIL,LTFILE      DEMO FILE                                    
         MVC   RIDHSRC,LTSRC       DEMO SOURCE                                  
         MVC   RIDHSTTN,LTSTTN     STATION                                      
         MVC   RIDHBK,LTBOOK       BOOK                                         
         MVC   RIDHBTYP,LTBTYP     BOOK TYPE                                    
         MVC   RIDHFRBT,LTFRBTS    FROM BOOK BITS                               
         TM    LTFLAG,LTFSELWT     IF SELECTED W/ A WEIGHT,                     
         BZ    *+10                                                             
         MVC   RIDHWTOV,LTWGTOV     MOVE IN WEIGHT OVERRIDE                     
         TM    LTFLAG2,LTF2T4                                                   
         BZ    *+8                                                              
         OI    RIDHFLG,RIDHFTP4                                                 
         TM    OPVCUMTB,C'T'                                                    
         BZ    *+8                                                              
         OI    RIDHFLG,RIDHFTOT                                                 
                                                                                
         CLC   LTFILE,DCFILPAV                                                  
         BE    BIT040                                                           
         CLC   LTFILE,DCFILTP                                                   
         BE    BIT045                                                           
         CLC   LTFILE,DCFILIUN                                                  
         BE    BIT050                                                           
         DC    H'0'                                                             
*                                                                               
BIT040   DS    0H                  PAV FILE                                     
         CLI   LTNOR,C'Y'           IF NOR PROGRAM,                             
         BNE   *+8                                                              
         OI    RIDHFLG,RIDHFNOR      TURN FLAG ON                               
         TM    LTFLAG,LTF2PURE      IF REQUESTED BY PURE NUMBER,                
         BZ    *+8                                                              
         OI    RIDHFLG,RIDHFPUR      FLAG IT AS SUCH                            
                                                                                
         MVC   RIDHPURE,LTPURE      MOVE IN PURE NUMBER                         
         B     BIT060                                                           
*                                                                               
BIT045   DS    0H                  TP  FILE                                     
         MVC   RIDHIDY,LTIDAY       MOVE IN DAYS                                
         MVC   RIDHSETM,LTTIME       AND TIMES                                  
         MVC   RIDHWK,LTWKN          AND WEEK NUMBER                            
         B     BIT060                                                           
*                                                                               
BIT050   DS    0H                  IUN FILE                                     
         MVC   RIDHINVN,LTINVN      MOVE IN INVENTORY NUMBER                    
         MVC   RIDHEFFD,LTEFFDT      AND EFFECTIVE DATE                         
         B     BIT060                                                           
*                                                                               
BIT060   DS    0H                  ADD ELEMENT TO RECORD                        
         GOTO1 HELLO,DMCB,(C'P',SYSFIL),(R6),(R3),0                             
         CLI   12(R1),0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         DROP  R3                                                               
*                                                                               
BIT065   DS    0H                  BUMP TO NEXT LISTTAB ENTRY                   
         LA    R4,LISTTABQ(R4)                                                  
         ZIC   R1,COUNTER                                                       
         LA    R1,1(R1)                                                         
         CLM   R1,1,NLTNTRY                                                     
         BNL   *+12                                                             
         STC   R1,COUNTER                                                       
         B     BIT035                                                           
         DROP  R4                                                               
*                                                                               
         B     BIT070                                                           
                                                                                
*                                                                               
** UN-FUDGE EACH ENTRY AS SELECTED **                                           
*                                                                               
BIT070   DS    0H                                                               
         CLI   FUDGED,C'Y'         WAS ANYTHING FUDGED?                         
         BNE   BIT079               NO                                          
*                                                                               
         LA    R1,LTFLAG-LISTTABD                                               
         MVI   BYTE,LTFSEL                                                      
         CLI   SELTYPE,C'S'                                                     
         BE    BIT071X                                                          
         LA    R1,LTFLAG2-LISTTABD                                              
         MVI   BYTE,LTFSELXD                                                    
         CLI   SELTYPE,C'E'                                                     
         BE    BIT071X                                                          
         DC    H'0'                                                             
BIT071X  EQU   *                                                                
*                                                                               
         ZIC   R0,NLTNTRY                                                       
         L     R4,ALISTTAB                                                      
         USING LISTTABD,R4                                                      
                                                                                
BIT072   DS    0H                                                               
         LA    RF,LISTTABD(R1)                                                  
         XC    0(1,RF),BYTE                                                     
         LA    R4,LISTTABQ(R4)                                                  
         BCT   R0,BIT072                                                        
         DROP  R4                                                               
*                                                                               
BIT079   EQU   *                                                                
                                                                                
*                                                                               
** ADJUST UPGRADE ELEMENT **                                                    
*                                                                               
         DS    0H                                                               
         LR    R3,R6                                                            
         MVI   ELCODE,X'05'                                                     
         MVC   DATADISP,DSP1EL                                                  
         BRAS  RE,GETEL                                                         
         BNE   BIT089                                                           
         USING RAVLNEL,R3                                                       
*                                                                               
         DS    0H                  FUDGE IN A SHARE BOOK                        
         OC    RAVLNOP1,RAVLNOP1                                                
         BZ    BIT089                                                           
         OC    RAVLNOP2,RAVLNOP2                                                
         BNZ   BIT089                                                           
         MVC   RAVLNOP2,UPSHFRBK+1                                              
*                                                                               
BIT089   EQU   *                                                                
         DROP  R3                                                               
                                                                                
*                                                                               
** UPDATE FOOTNOTE **                                                           
*                                                                               
         DS    0H                                                               
         MVC   WORK,SPACES                                                      
                                                                                
*                                                                               
         DS    0H                                                               
         CLI   IROUPFN,C'Y'             UPDATE FOOTNOTE ON SAVE?                
         BNE   BIT092YX                                                         
         CLI   IROFNLB+L'IROFNLB-1,C'*'  YEP, WAS FOOTNOTE OVERRIDDEN?          
         BNE   BIT094                     NOPE, USE SYSTEM-GENERATED            
         LA    R2,IROFTNTH                YEP, USE USER-INPUTTED FTNOTE         
         GOTO1 ANY                         (MOVE IT INTO  WORK)                 
         B     BIT092X                                                          
BIT092YX EQU   *                                                                
*                                                                               
         CLI   IROUPFN,C'N'        DON'T UPDATE FOOTNOTE ON SAVE                
         BNE   BIT092NX                                                         
         MVC   WORK(L'TRKFTNT),TRKFTNT                                          
         B     BIT092X                                                          
BIT092NX EQU   *                                                                
         DC    H'0'                                                             
*                                                                               
BIT092X  EQU   *                                                                
*                                                                               
         DS    0H                                                               
         LR    R3,R6                                                            
         MVI   ELCODE,X'01'                                                     
         MVC   DATADISP,DSP1EL                                                  
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         USING RPGMELM,R3                                                       
         MVC   RPGMNAME,WORK                                                    
         DROP  R3                                                               
                                                                                
*                                                                               
BIT094   EQU   *                                                                
                                                                                
*                                                                               
** UPDATE ACTIVITY ELEMENT **                                                   
*                                                                               
         DS    0H                  R6-->INVENTORY RECORD (TRACK)                
         MVI   GOSUBN,UAE#                                                      
         GOTO1 AGOSUB                                                           
                                                                                
*                                                                               
** COPY RECORD TO I/O3 **                                                       
*                                                                               
         L     R0,AIO3                        A(DESTINATION)                    
         LA    R1,L'IO                        L(DESTINATION)                    
         LR    RE,R6                          A(SOURCE)                         
         ZICM  RF,(RINVLEN-RINVREC)(R6),(3)   L(SOURCE)                         
         MVCL  R0,RE                                                            
         BC    8+2,*+12            OKAY IF L'DEST >= L'SOURCE                   
         MVI   OURERRCD,TLNGQ       ELSE, RETURN AN ERROR MSG                   
         B     BITXN                                                            
*                                                                               
BITXY    DS    0H                                                               
         J     YES                                                              
                                                                                
BITXN    DS    0H                                                               
         J     NO                                                               
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR06--FNR#)'            
*--------------------------- FIX NEW RECORD --------------------------*         
                                                                                
* This routine polishes up the new inventory track record before it             
*  gets added to the file.  It makes sure that the data in the descrip-         
*  tive elements reflect the numbers given in the demo elements.  It            
*  uses the first selected LISTTAB entry displayed as the reference.            
* At entry,                                                                     
*   AIO3 = A(new inventory track record to fix).                                
                                                                                
FXNEWREC DS    0H                                                               
*                                                                               
** FIND FIRST SELECTED LISTTAB ENTRY DISPLAYED **                               
*                                                                               
         L     RF,AMLSTDIR                                                      
FNR012   CLI   0(RF),EOT                                                        
         BNE   *+6                                                              
         DC    H'0'                                                             
         ZIC   R4,0(RF)                                                         
         BCTR  R4,0                                                             
         MH    R4,=Y(LISTTABQ)                                                  
         A     R4,ALISTTAB                                                      
         USING LISTTABD,R4                                                      
         TM    LTFLAG,LTFSEL                                                    
         BNZ   FNR019                                                           
         LA    RF,1(RF)                                                         
         B     FNR012                                                           
FNR019   EQU   *                                                                
                                                                                
*                                                                               
         MVC   DATADISP,DSP1EL                                                  
                                                                                
*                                                                               
** FIX RINVFREL ELEMENT **                                                      
*                                                                               
         L     R3,AIO3                                                          
         MVI   ELCODE,X'03'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         USING RINVFREL,R3                                                      
         MVC   RINVFRST,LTSTTN                                                  
         MVC   RINVFRBK,LTFRBK                                                  
         MVI   RINVFRTY,C'P'                                                    
         CLI   LTFILE,C'I'                                                      
         BNE   *+8                                                              
         MVI   RINVFRTY,C'I'                                                    
         MVC   RINVFRBT,LTBTYP                                                  
         DROP  R3                                                               
                                                                                
*                                                                               
** FIX RINVZEL ELEMENT **                                                       
*                                                                               
         L     R3,AIO3                                                          
         MVI   ELCODE,X'CE'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         USING RINVZEL,R3                                                       
         MVC   RINVZBK,LTFRBK                                                   
         DROP  R3                                                               
                                                                                
*                                                                               
** EXIT ROUTINE **                                                              
*                                                                               
         J     XIT                                                              
         DROP  R4                                                               
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR06--UAE#)'            
*---------------------- UPDATE ACTIVITY ELEMENT ----------------------*         
                                                                                
* Updates the activity element in the inventory track addressed by R6.          
*  If no activity element is found, then one will be created and added          
*  to the record.                                                               
* At entry,                                                                     
*   R6-->inventory track.                                                       
*   ACTVWHY = reason for activity                                               
                                                                                
UPACTVEL DS    0H                                                               
                                                                                
         GOTO1 HELLO,DMCB,(C'G',SYSFIL),(X'EF',(R6)),0,0                        
         CLI   12(R1),0                                                         
         BE    UAE014                                                           
         CLI   12(R1),X'06'                                                     
         BE    UAE016                                                           
         DC    H'0'                                                             
*                                                                               
UAE014   DS    0H                  ELEMENT FOUND                                
         ZICM  R3,12+1(R1),(7)                                                  
         USING RINVAEL,R3                                                       
         MVC   RINVALST,BTODAY                                                  
         MVC   RINVAWHY,ACTVWHY                                                 
         DROP  R3                                                               
         B     UAE019                                                           
*                                                                               
UAE016   DS    0H                  ELEMENT NOT FOUND                            
         XC    ELEM,ELEM                                                        
         LA    R3,ELEM              BUILD ACTIVITY ELEMENT                      
         USING RINVAEL,R3                                                       
         MVI   RINVACOD,X'EF'        ELEMENT CODE                               
         MVI   RINVALEN,12              "    LENGTH                             
         MVC   RINVAFST,BTODAY       DATE OF FIRST ACTIVITY                     
         MVC   RINVALST,BTODAY        "   "  LAST     "                         
         MVC   RINVAWHY,ACTVWHY                                                 
                                                                                
         DS    0H                                                               
         GOTO1 HELLO,DMCB,(C'P',SYSFIL),(R6),(R3),0                             
         CLI   12(R1),0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         DROP  R3                                                               
         B     UAE019                                                           
*                                                                               
UAE019   EQU   *                                                                
                                                                                
*                                                                               
         J     XIT                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR06--PLR#)'            
*----------------------- PROCESS LTRANS REQUEST ----------------------*         
*                                                                               
PRCLTRNS DS    0H                                                               
         MVC   MY_CSTAT,CSTAT      REMEMBER STATION  CSTAT                      
         CLC   CSTAT,IKSTTN        MAKE SURE CORRECT STATION IN  CSTAT          
         BNE   *+10                                                             
         MVC   CSTAT,IKSTTN                                                     
         GOTO1 VLTRANS                                                          
         MVC   CSTAT,MY_CSTAT      RESTORE STATION IN  CSTAT                    
                                                                                
*                                                                               
         DS    0H                                                               
         J     XIT                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR06--VADP#)'           
*---------- VALIDATE ALTERNATE DAY/TIME FOR PUTS EXPRESSION ----------*         
                                                                                
* Validates a day/time expression specified in the options field.               
* At entry,                                                                     
*   R3-->SCANNER entry w/ day/time expression in 2nd half,                      
*   R4-->entry of option keyword for day/time.                                  
* On exit when day/time expression valid,                                       
*   CC set to equal,                                                            
*   BLOCK contains option data to be stored.                                    
* On exit when day/time expression invalid,                                     
*   CC set to not equal,                                                        
*   OURERRCD = appropriate error code,                                          
*   FLDDSPL  = displacement of error input,                                     
*   MYTEXT   = text for text replace (if there are any).                        
* NOTE: Do NOT clobber BUFF here!                                               
                                                                                
VALADTP  DS    0H                                                               
         MVI   OURERRCD,0                                                       
         MVI   MYTEXT,0                                                         
         MVC   FLDDSPL,8(R3)                                                    
*                                                                               
         DS    0H                  BUILD DUMMY TWA FIELD IN WORK                
         ZIC   R0,1(R3)                                                         
         LR    R1,R0                                                            
         BCTR  R1,0                                                             
         EXMVC R1,WORK+8,22(R3)     FIELD DATA                                  
         XC    WORK(8),WORK                                                     
         STC   R0,WORK+5                                                        
         LA    R1,8+1(R1)                                                       
         STC   R1,WORK              FIELD HEADER                                
                                                                                
         GOTO1 SCANNER,DMCB,('SCANLDAY',WORK),(1,BLOCK),X'6B7E6B61'             
         CLI   DMCB+4,0                                                         
         BNE   *+12                                                             
         MVI   OURERRCD,IFLDQ                                                   
         B     VADPXN                                                           
                                                                                
*                                                                               
         DS    0H                  VALIDATE DAY                                 
         CLI   BLOCK+00,0           ANY DAY INPUT?                              
         BH    *+12                                                             
         MVI   OURERRCD,IDAYQ        NO, FLAG AS ERROR                          
         B     VADPXN                                                           
*                                                                               
         DS    0H                   BUILD DUMMY TWA FIELD IN WORK               
         ZIC   R0,BLOCK+00                                                      
         LR    R1,R0                                                            
         BCTR  R1,0                                                             
         EXMVC R1,WORK+8,BLOCK+12   FIELD DATA                                  
         XC    WORK(8),WORK                                                     
         STC   R0,WORK+5                                                        
         AHI   R0,8                                                             
         STC   R0,WORK              FIELD HEADER                                
                                                                                
         GOTO1 DAYVAL,DMCB,(WORK+5,WORK+8),MYWORK,MYWORK+1                      
         CLI   MYWORK,0                                                         
         BNE   *+12                                                             
         MVI   OURERRCD,IDAYQ                                                   
         B     VADPXN                                                           
                                                                                
*                                                                               
         DS    0H                  VALIDATE TIME                                
         CLI   BLOCK+01,0           ANY TIME INPUT?                             
         BH    *+12                                                             
         MVI   OURERRCD,ITIMQ        NO, FLAG AS ERROR                          
         B     VADPXN                                                           
*                                                                               
         DS    0H                   BUILD DUMMY TWA FIELD IN WORK               
         ZIC   R0,BLOCK+01                                                      
         LR    R1,R0                                                            
         BCTR  R1,0                                                             
         EXMVC R1,WORK+8,BLOCK+22   FIELD DATA                                  
         XC    WORK(8),WORK                                                     
         STC   R0,WORK+5                                                        
         AHI   R0,8                                                             
         STC   R0,WORK              FIELD HEADER                                
                                                                                
         GOTO1 TIMVAL,DMCB,(WORK+5,WORK+8),MYWORK+1                             
         CLI   DMCB+0,XFF                                                       
         BNE   *+12                                                             
         MVI   OURERRCD,ITIMQ                                                   
         B     VADPXN                                                           
                                                                                
*                                                                               
         DS    0H                  PASS DAY/TIMES BACK TO CALLER                
         MVC   BLOCK(L'OPVADPTB),MYWORK                                         
*                                                                               
         B     VADPXY                                                           
                                                                                
*                                                                               
VADPXY   DS    0H                                                               
         J     YES                                                              
VADPXN   DS    0H                                                               
         J     NO                                                               
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR06--FADP#)'           
*----------- FORMAT ALTERNATE DAY/TIME FOR PUTS EXPRESSION -----------*         
                                                                                
* Translates a day/time expression to display the alternate day/times           
*  for PUTs                                                                     
                                                                                
* At entry,                                                                     
*  R3-->day/time expression                                                     
* At exit,                                                                      
*  BUFF+1 contains day/time expression in display format,                       
*  BUFF = L(displayable day/time).                                              
                                                                                
FMTADTP  DS    0H                                                               
         MVI   BUFF,0                                                           
         LA    R2,BUFF+1                                                        
         XC    0(256,R2),0(R2)     INITIALIZE OUTPUT AREA                       
                                                                                
*                                                                               
         DS    0H                  FORMAT DAY                                   
         MVC   TMPIDAY,0(R3)                                                    
         MVI   GOSUBN,TID#          TRANSLATE DAY                               
         GOTO1 AGOSUB                                                           
         ZIC   R1,BYTE              R1=L(CONVERTED DAY)                         
         BCTR  R1,0                                                             
         EXMVC R1,0(R2),WORK                                                    
         AR    R2,R1                                                            
         MVI   1(R2),C'/'                                                       
         AHI   R2,1+1                                                           
                                                                                
*                                                                               
         DS    0H                  FORMAT TIME                                  
         MVC   TMPSETM,1(R3)                                                    
         MVI   GOSUBN,TMT#          TRANSLATE TIMES                             
         GOTO1 AGOSUB                                                           
         ZIC   R1,BYTE              R1=L(CONVERTED TIMES)                       
         BCTR  R1,0                                                             
         EXMVC R1,0(R2),WORK                                                    
         LA    R2,1(R2,R1)                                                      
                                                                                
*                                                                               
         DS    0H                                                               
         LA    R0,BUFF                                                          
         SR    R2,R0                                                            
         STC   R2,BUFF                                                          
*                                                                               
         J     YES                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR06--MISC STUF+        
               F)'                                                              
*--------------------- SUBR06 MISCELLANEOUS STUFF --------------------*         
                                                                                
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR06--LTORG && +        
               CONSTANTS)'                                                      
*------------------------- LTORG & CONSTANTS -------------------------*         
         LTORG                                                                  
                                                                                
                                                                                
XDDFLTDC DC    AL1(42,48,92,98,142,148,EOT)                                     
         DS    0XL(MXEXPNDM-(*-XDDFLTDC-1)+1)                                   
                                                                                
                                                                                
SUBR06L  EQU   *-SUBR06                                                         
         DS    0CL(X'1000'-SUBR06L+1)                                           
***********************************************************************         
                                                                                
         DROP  R7,R8,RA,RB,RC                                                   
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR07)'                  
***********************************************************************         
*======================= SUBROUTINE POOL SEVEN =======================*         
                                                                                
* At entry,                                                                     
*   RA-->TWA,                                                                   
*   R8-->SYSD,                                                                  
*   R7-->SPOOLD,                                                                
*   R1-->GEND,                                                                  
*   GOSUBN = equated sub-routine number.                                        
                                                                                
SUBR07Q  EQU   (((*-RMP18+X'0FFF')/X'1000')*X'1000')                            
                                                                                
         ORG   RMP18+SUBR07Q                                                    
SUBR07   NMOD1 0,**1807**                                                       
         LR    RC,R1                                                            
         USING GEND,RC             RC=A(GENCON WORK AREA)                       
         USING CONHEADH-64,RA      RA=A(TWA)                                    
         USING SYSD,R8             R8=A(SYSD)                                   
         USING SPOOLD,R7           R7=A(SPOOL WORK AREA)                        
                                                                                
         ZIC   R1,GOSUBN                                                        
         AHI   R1,-(R06#)          SUBTRACT FOR SUB-RTN # 6                     
         BCTR  R1,0                                                             
         SLL   R1,2                                                             
         B     R07_00(R1)                                                       
                                                                                
NMVL#    EQU   ((R07_01-R07_00)/4+1)+R06#  NORMALIZE DEMO VALUES                
NMLZ#    EQU   ((R07_02-R07_00)/4+1)+R06#  NORMALIZING ROUTINE                  
SDV#     EQU   ((R07_03-R07_00)/4+1)+R06#  SEED DEMO VALUES                     
UNW#     EQU   ((R07_04-R07_00)/4+1)+R06#  UNWEIGH (IUN) RECORD                 
GPFM#    EQU   ((R07_05-R07_00)/4+1)+R06#  GO TO $PFM                           
XDV#     EQU   ((R07_06-R07_00)/4+1)+R06#  EXTRACT DEMO VALUES                  
GADQT#   EQU   ((R07_07-R07_00)/4+1)+R06#  GET A(DBDQD ENTRIES)                 
                                                                                
R07_00   DS    0H                                                               
R07_01   B     NRMDEMVL               NORMALIZE DEMO VALUES                     
R07_02   B     NORMALIZ               NORMALIZING ROUTINE                       
R07_03   B     SEEDMVAL               SEED DEMO VALUES                          
R07_04   B     UNWEIGH                UNWEIGH (IUN) RECORD                      
R07_05   B     GOPFM                  GO TO $PFM                                
R07_06   B     XTRCTDMV               EXTRACT DEMO VALUES                       
R07_07   B     GETADQTB               GET A(DBDQD ENTRIES)                      
R07#     EQU   ((*-R07_00)/4)+R06#                                              
         DC    H'0'                                                             
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR07--NMVL#)'           
*----------------------- NORMALIZE DEMO VALUES -----------------------*         
                                                                                
* At entry,                                                                     
*   R3-->demo values in IUNRECD format                                          
* At exit,                                                                      
*   Normalized values seeded in IUNRECD format                                  
                                                                                
NRMDEMVL DS    0H                                                               
         LR    R6,R3               R6-->IUNRECD                                 
                                                                                
*                                                                               
         DS    0H                                                               
         L     R2,ARM18WRK                                                      
         AHI   R2,BASEUNIV-RM18WRKD R2-->BASE UNIVERSES FOR NORMALIZING         
*                                                                               
         LHI   R0,NRMVLTBQ                                                      
         L     R5,=A(NRMVLTAB-RMP18)                                            
         A     R5,MYBASE1          R5-->TABLE OF VALUES TO NORMALIZE            
*                                                                               
NMVL022  DS    0H                                                               
         ZICM  R3,0(R5),(3)                                                     
         AR    R3,R6                R3-->CURR UNIVERSES TO CREATE INDEX         
         ZICM  R4,2(R5),(3)                                                     
         AR    R4,R6                R4-->VALUES TO BE NORMALIZED                
         MVI   GOSUBN,NMLZ#                                                     
         GOTO1 AGOSUB                                                           
         AHI   R5,L'NRMVLTAB        BUMP TO NEXT SET OF VALUES                  
         BCT   R0,NMVL022                                                       
                                                                                
*                                                                               
         DS    0H                                                               
         J     YES                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR07--NMLZ#)'           
*---------------------------- NORMALIZING ----------------------------*         
                                                                                
* At entry,                                                                     
*   R2-->base values to index to                                                
*   R3-->current values to create index with                                    
*   R4-->values to be normalized                                                
* At exit,                                                                      
*   Values to be normalized replaced by normalized values                       
                                                                                
NORMALIZ DS    0H                                                               
                                                                                
*                                                                               
         DS    0H                                                               
         LHI   R0,IUNNVALS         R0 = LOOP COUNTER                            
*                                                                               
NMLZ010  DS    0H                                                               
         OC    0(4,R4),0(R4)       IF VALUE IS ZERO,                            
         BZ    NMLZ018              NORMALIZING IS JUST A WASTE OF TIME         
                                                                                
         SR    RE,RE                                                            
         L     RF,0(R4)                                                         
         LHI   R1,1                                                             
         OC    0(4,R3),0(R3)                                                    
         BZ    *+12                                                             
         L     R1,0(R3)                                                         
         M     RE,0(R2)                                                         
         ST    R1,DIVISOR                                                       
         STM   RE,RF,DIVIDEND                                                   
         MVI   GOSUBN,DIV#                                                      
         GOTO1 AGOSUB               QUOTIENT = NORMALIZED VALUE                 
                                                                                
         MVC   0(4,R4),QUOTIENT    REPLACE VALUE W/ NORMALIZED VALUE            
*                                                                               
NMLZ018  DS    0H                                                               
         AHI   R2,4                                                             
         AHI   R3,4                                                             
         AHI   R4,4                                                             
         BCT   R0,NMLZ010                                                       
                                                                                
*                                                                               
         DS    0H                                                               
         J     YES                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR07--SDV#)'            
*-------------------------- SEED DEMO VALUES -------------------------*         
                                                                                
* At entry,                                                                     
*   LISTTAB contains entries to be listed                                       
*   LPDEMC  = demo category number.                                             
                                                                                
SEEDMVAL DS    0H                                                               
         CLI   NLTNTRY,0           ANY ENTRIES IN LIST TABLE?                   
         BE    SDVX                 NO, EXIT NOW                                
*                                                                               
         L     R4,ALISTTAB                                                      
         USING LISTTABD,R4                                                      
                                                                                
SDV032   DS    0H                  START OF LOOP                                
         CLI   0(R4),EOT                                                        
         BE    SDV050                                                           
                                                                                
         XC    TMPS(TMPSL),TMPS                                                 
                                                                                
         DS    0H                   SET PARAMS TO GET DEMOS VALUES              
         MVC   TMPSRC,LTSRC                                                     
                                                                                
SDV035   DS    0H                                                               
         MVC   TMPDFIL,LTFILE                                                   
         MVC   TMPFRBK,LTFRBK                                                   
         MVC   TMPBTYP,LTBTYP                                                   
         MVC   TMPWKN,LTWKN                                                     
         MVC   TMPSTTN,LTSTTN                                                   
         MVC   TMPPURE(2),LTPURE                                                
         MVC   TMPINVN,LTINVN                                                   
         MVC   TMPIDAY,LTIDAY                                                   
         MVC   TMPSETM,LTTIME                                                   
         MVC   TMPCDATE,LTEFFDT                                                 
         MVC   TMPFLAG,LTFLAG                                                   
         MVC   TMPFLAG2,LTFLAG2                                                 
         MVC   TMPDEMC,LPDEMC       DEMO CATEGORY                               
         MVI   TMPBEST,0                                                        
         CLI   LTNOR,C'Y'           IF NOR PROGRAM                              
         BNE   *+8                                                              
         MVI   TMPBEST,C'A'          NEED TO USE THE "ALL" OPTION               
         MVI   TMPTMCHG,0                                                       
*                                                                               
         DS    0H                                                               
         MVI   GOSUBN,GDV#          GO GET DEMO VALUES                          
         GOTO1 AGOSUB                                                           
                                                                                
         DS    0H                   SET DEMO VALUES INTO ENTRY                  
         MVC   LTRDEMV,DEMVALS+0                                                
         MVC   LTSDEMV,DEMVALS+4                                                
         MVC   LTPDEMV,DEMVALS+8                                                
                                                                                
         DS    0H                   PROCESS NEXT ENTRY                          
         LA    R4,LISTTABQ(R4)                                                  
         B     SDV032                                                           
*                                                                               
SDV050   DS    0H                                                               
         DROP  R4                                                               
*                                                                               
SDVX     DS    0H                                                               
         J     XIT                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR07--UNW#)'            
*------------------------ UNWEIGH (INV) RECORD -----------------------*         
                                                                                
* Routine unweighs record that has been accumulated using DEMOMATH.             
*  The record must be an inventory record.  This routine resets the             
*  DBLOCK and the MATHFAC block.                                                
* At entry,                                                                     
*   R5-->DBLOCK area                                                            
*   R6-->inventory record                                                       
*   DIVISOR = unweighting factor                                                
                                                                                
UNWEIGH  DS    0H                                                               
         USING DBLOCKD,R5                                                       
*                                                                               
         DS    0H                  SAVE CALLER'S DBLOCK                         
         L     R0,ASVDBLK                                                       
         LA    R1,SVDBLCKX-SVDBLOCK                                             
         LA    RE,DBLOCKD                                                       
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
                                                                                
*                                                                               
         DS    0H                  RESET DBLOCK                                 
         MVI   GOSUBN,CDBK#         CLEAR DBLOCK POINTED TO BY R5               
         GOTO1 AGOSUB                                                           
                                                                                
         MVC   DBFILE,DCFILINV                                                  
         MVC   DBCOMFCS,ACOMFACS                                                
         MVC   DBSELAGY,TWAAGY                                                  
         MVI   DBINTFIL,C'I'        FORCE INTERNAL FILE = "INVENTORY"           
         MVI   DBINTMED,C'U'        FORCE INTERNAL MEDIA = "UPGRADE"            
         MVI   DBACTSRC,C'N'        FORCE ACTUAL SOURCE = NIELSEN               
         MVI   DBACTMED,C'U'        FORCE ACTUAL MEDIA = "UPGRADE"              
         ST    R6,DBAREC            SET A(RECORD)                               
         LA    R0,(RINVPEL-RINVREC)(R6)                                         
         ST    R0,DBAQUART          SET A(QH ELEM)                              
                                                                                
*                                                                               
         DS    0H                  RESET MATCHFAC                               
         LA    R0,DBLOCKD                                                       
         ST    R0,MTHCFACS                                                      
         MVC   MTHFCTR,DIVISOR                                                  
         MVC   MTHIFIL,DCFILINV                                                 
         MVC   MTHOFIL,DCFILINV                                                 
         MVC   MTHOSRC,=C'NSI'                                                  
                                                                                
*                                                                               
         DS    0H                                                               
         L     RF,ACOMFACS                                                      
         L     RF,(CDEMOMTH-COMFACSD)(RF)                                       
         GOTO1 (RF),DMCB,=C'DIVIDE',(R6),(R6),MATHFAC                           
                                                                                
*                                                                               
         DS    0H                  RESTORE CALLER'S DBLOCK                      
         L     RE,ASVDBLK                                                       
         LA    RF,SVDBLCKX-SVDBLOCK                                             
         LA    R0,DBLOCKD                                                       
         LR    R1,RF                                                            
         MVCL  R0,RE                                                            
         DROP  R5                                                               
                                                                                
*                                                                               
UNWX     DS    0H                                                               
         J     XIT                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR07--GPFM#)'           
*----------------------------- GO TO $PFM ----------------------------*         
                                                                                
* Routine interfaces with GLOBBER to call $PFM to display the track             
* At entry,                                                                     
*   TRKDA = disk address of track                                               
* At exit,                                                                      
*   CC equal if returned successfully                                           
*   CC nequl otherwise                                                          
                                                                                
GOPFM    DS    0H                                                               
         L     R2,ACOMFACS                                                      
         USING COMFACSD,R2                                                      
                                                                                
*                                                                               
         DS    0H                                                               
         XC    ELEM,ELEM                                                        
         LA    RE,ELEM                                                          
         USING GLPFMFIL,RE                                                      
         MVC   GLPFMFIL(6),=C'REPFIL'                                           
         MVC   GLPFMDA,TRKDA                                                    
         MVI   GLPFMFLG,C'*'                                                    
         MVC   GLPFMELI,=C'FI'                                                  
         DROP  RE                                                               
                                                                                
         GOTO1 CGLOBBER,DMCB,=C'PUTD',ELEM,54,GLPFMCDQ                          
         CLI   DMCB+08,0                                                        
         BNE   GPFMXN                                                           
*                                                                               
         DS    0H                                                               
         XC    ELEM,ELEM                                                        
         LA    RE,ELEM                                                          
         USING GLVXFRSY,RE                                                      
         MVC   GLVXFRSY,=C'REP'                                                 
         MVC   GLVXFRPR,=C'RMP'                                                 
         MVC   GLVXTOSY,=C'REP'                                                 
         MVC   GLVXTOPR,=C'PFM'                                                 
***>>>   OI    GLVXFLG1,GLV1GOTO+GLV1SEPS                                       
         OI    GLVXFLG1,GLV1SEPS                                                
         DROP  RE                                                               
                                                                                
         GOTO1 CGLOBBER,DMCB,=C'PUTD',ELEM,14,GLVXCTL                           
         CLI   DMCB+08,0                                                        
         BNE   GPFMXN                                                           
         DROP  R2                                                               
                                                                                
*                                                                               
** EXITS **                                                                     
*                                                                               
GPFMXY   DS    0H                                                               
         J     YES                                                              
*                                                                               
GPFMXN   DS    0H                                                               
         J     NO                                                               
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR07--XDV#)'            
*------------------------ EXTRACT DEMO VALUES ------------------------*         
                                                                                
* Extracts demo values from an inventory track record.                          
* Indicates if there are any demo overrides.                                    
* At entry,                                                                     
*   ADEMLIST = A(list of demos to get),                                         
*   R6       = A(inventory track record).                                       
* At exit,                                                                      
*   DEMOVRDS = flags for demo overrides                                         
*   THISDEMV = extracted demo values.                                           
* NOTE:  DBLOCK area addressed by ADBLOCK will get creamed here.                
                                                                                
XTRCTDMV DS    0H                                                               
         XC    THISDEMV,THISDEMV   CLEAR OUTPUT AREA FOR DEMO VALUES            
*                                                                               
         DS    0H                  CLEAR DBLOCK                                 
         MVI   GOSUBN,CDBK#                                                     
         GOTO1 AGOSUB                                                           
*                                                                               
         DS    0H                  SET UP DBLOCK                                
         L     R5,ADBLOCK                                                       
         USING DBLOCKD,R5                                                       
         MVC   DBFILE,DCFILINV           FILE=INV                               
         ST    R6,DBAREC                 A(RECORD)                              
         LA    R0,(RINVPEL-RINVREC)(R6)  A(1ST ELEMENT)                         
         ST    R0,DBAQUART                                                      
         MVC   DBCOMFCS,ACOMFACS         A(COMFACS)                             
*                                                                               
         DS    0H                                                               
         GOTO1 DEMOUT,MYDMCB,(C'L',ADEMLIST),DBLOCKD,THISDEMV                   
         DROP  R5                                                               
*                                                                               
         DS    0H                  FLAG DEMO OVERRIDES                          
         LA    R2,DEMOVRDS          R2-->PLACE TO STORE FLAGS                   
         L     R3,ADEMLIST          R3-->DEMOLIST                               
         XC    ELEM,ELEM                                                        
         LA    R4,ELEM              R4-->DEMO OVERRIDE ELEMENT                  
         USING RINVNOEL,R4                                                      
         MVI   RINVNOCD,X'DE'                                                   
                                                                                
XDV062   DS    0H                                                               
         CLI   0(R3),XFF                                                        
         BE    XDV069                                                           
                                                                                
         MVC   RINVNOTP,1(R3)       DEMO MODIFIER                               
         MVC   RINVNODM,2(R3)       DEMO CATEGORY                               
         LA    R0,(RINVNODM+L'RINVNODM-RINVNOEL)-2                              
                                                                                
         MVI   0(R2),C' '           ASSUME NO DEMO OVERRIDE                     
         GOTO1 HELLO,MYDMCB,(C'G',=C'REPFILE'),(RINVNOCD,(R6)),        +        
               ((R0),RINVNOEL+2),0                                              
         CLI   MYDMCB+12,0          WAS THERE A DEMO OVERRIDE?                  
         BNE   *+8                                                              
         MVI   0(R2),C'*'            YES, FLAG IT                               
         DROP  R4                                                               
                                                                                
         LA    R2,1(R2)             BUMP TO NEXT TWA FIELD                      
         LA    R3,3(R3)             BUMP TO NEXT DEMOLIST ENTRY                 
         B     XDV062                                                           
XDV069   EQU   *                                                                
                                                                                
*                                                                               
         J     XIT                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR07--GADQT#)'          
*------------------------ GET A(DAY/QH TABLE) ------------------------*         
                                                                                
* At entry,                                                                     
*   ADBLOCK  = A(DBLOCK)                                                        
* At exit,                                                                      
*   ADBDQD   = A(Internal day/qhr table)                                        
                                                                                
GETADQTB DS    0H                                                               
         L     R5,ADBLOCK                                                       
         USING DBLOCKD,R5                                                       
                                                                                
*                                                                               
         DS    0H                                                               
         LA    R3,DBDQD             PICK UP ADDR DIRECTLY FROM HERE             
         CLC   =AL2(DBDQUXTD),DBDQTAB+0   DO WE NEED TO LOOK IN XTND?           
         BNE   GADQT12X                    NOPE                                 
*                                                                               
         DS    0H                                                               
         LA    RF,DBEXTEND-4                                                    
GADQT12G DS    0H                   LOOK THROUGH DBEXTEND                       
         ICM   RF,15,4(RF)                                                      
         BZ    GADQT12X                                                         
         CLC   0(4,RF),DBDQTAB+2     FOR NAME GIVEN HERE                        
         BNE   GADQT12G                                                         
         LA    R3,DBDQXFXL(RF)                                                  
GADQT12X EQU   *                                                                
*                                                                               
         DS    0H                                                               
         ST    R3,ADBDQD                                                        
         DROP  R5                                                               
                                                                                
*                                                                               
         DS    0H                                                               
         J     XIT                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR07--MISC STUF+        
               F)'                                                              
*--------------------- SUBR07 MISCELLANEOUS STUFF --------------------*         
                                                                                
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBR07--LTORG && +        
               CONSTANTS)'                                                      
*------------------------- LTORG & CONSTANTS -------------------------*         
         LTORG                                                                  
                                                                                
                                                                                
SUBR07L  EQU   *-SUBR07                                                         
         DS    0CL(X'1000'-SUBR07L+1)                                           
***********************************************************************         
                                                                                
         DROP  R7,R8,RA,RB,RC                                                   
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBRXM)'                  
***********************************************************************         
*==================== EXIT WITH MESSAGE ROUTINES =====================*         
                                                                                
* Exits which leave RMP18 entirely and displays a message go through            
*  this routine.                                                                
* At entry,                                                                     
*   MYTEXT has length and text of text-replace.                                 
                                                                                
SUBRXMQ  EQU   (((*-RMP18+X'00FF')/X'100')*X'100')                              
                                                                                
         ORG   RMP18+SUBRXMQ                                                    
XMSGRTN  NMOD1 0,**18XM**                                                       
         SR    RC,RC                                                            
         ICM   RC,7,1(R1)                                                       
         USING GEND,RC                                                          
         L     RA,ATWA                                                          
         USING CONHEADH-64,RA                                                   
         L     R8,ASYSD                                                         
         USING SYSD,R8                                                          
         L     R7,ASPOOLD                                                       
         USING SPOOLD,R7                                                        
                                                                                
         MVC   MSGTYPE,0(R1)       GET MESSAGE TYPE                             
         XC    CONHEAD,CONHEAD     CLEAR THE WAY FOR THE MESSAGE                
                                                                                
         CLI   MSGTYPE,C'E'        EXIT W/ AN ERROR MSG                         
         BE    XMERR                                                            
         CLI   MSGTYPE,C'W'        EXIT W/ A WARNING MSG                        
         BE    XMWRN                                                            
         CLI   MSGTYPE,C'I'        EXIT W/ AN INFO  MSG                         
         BE    XMINF                                                            
         DC    H'0'                                                             
                                                                                
                                                                                
ALLMSGX  DS    0H                                                               
         OI    DIDTHIS,DIDALLMX    TRACE--EXITED THRU MSGS ROUTINES             
         MVI   GOSUBN,STI#         SAVE OFF STUFF IN TIA                        
         GOTO1 AGOSUB                                                           
*                                                                               
         DS    0H                                                               
         GOTO1 AERREX                                                           
         J     XIT                                                              
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBRXM--ERR MSGS)+        
               '                                                                
*--------------------------- ERROR MESSAGES --------------------------*         
                                                                                
* These messages require the user to re-input (the correct) data for a          
*  response.  Previous values are restored, if the key did not change,          
*  and fields modified this time around will appear modified in the             
*  next transaction.                                                            
* At entry, R2-->field to put cursor.                                           
                                                                                
XMERR    DS    0H                                                               
         TM    CHNGFLG1,CF1KEY     IF KEY DID NOT CHANGE,                       
         BO    XME002                                                           
         MVI   GOSUBN,RPRV#         RESET VALUES TO WHAT THEY WERE              
         GOTO1 AGOSUB                                                           
                                                                                
XME002   DS    0H                                                               
         MVI   GOSUBN,MNI#         KEEP MODIFIED FIELDS FOR NEXT INPUT          
         GOTO1 AGOSUB                                                           
                                                                                
         LA    RE,IROIPSCH         START OF LINE                                
         LA    RF,IROPDEMH         END OF LINE                                  
         CR    RE,R2               IF PLACE OF ERROR OCCURRED                   
         BH    XME004                                                           
         CR    RF,R2                ON THIS LINE,                               
         BL    XME004                                                           
         SR    R0,R0                                                            
XME003A  CR    RE,RF                TRANSMIT THE ENTIRE LINE                    
         BH    XME004                                                           
         OI    6(RE),X80                                                        
         IC    R0,0(RE)                                                         
         AR    RE,R0                                                            
         B     XME003A                                                          
*                                                                               
XME004   DS    0H                                                               
         MVI   MSGSYS,0            ASSUME CONNECTED SYS NOT OVERRIDED           
         OI    MISCFLG1,MF1ERRQ                                                 
                                                                                
         DS    0H                                                               
         MVC   AERREX,ERREX        SET ADDRESS OF ERREX ROUTINE                 
         CLI   OURERRCD,ERRX#                                                   
         BNH   XMERRGO                                                          
         MVC   AERREX,ERREX2        TO GO OFF TO                                
         MVC   CONHEAD(9),=C'**ERROR**'                                         
         LA    R1,CONHEAD+10                                                    
         CLI   OURERRCD,ERRX2#                                                  
         BNH   XMERRGO                                                          
         DC    H'0'                                                             
                                                                                
XMERRGO  DS    0H                                                               
         CLI   OURERRCD,0                                                       
         BH    *+6                                                              
         DC    H'0'                                                             
         CLI   OURERRCD,XMERRQ                                                  
         BL    *+6                                                              
         DC    H'0'                                                             
                                                                                
         ZIC   RF,OURERRCD         BRANCH OFF TO SET ERROR MESSAGE              
         STC   RF,PRVMSGCD         REMEMBER MESSAGE CODE                        
         BCTR  RF,0                                                             
         SLL   RF,2                                                             
         B     XMERR00(RF)                                                      
                                                                                
MFLDQ    EQU   ((XMERR01-XMERR00)/4)+1                                          
IFLDQ    EQU   ((XMERR02-XMERR00)/4)+1                                          
RNFQ     EQU   ((XMERR03-XMERR00)/4)+1                                          
ISELQ    EQU   ((XMERR04-XMERR00)/4)+1                                          
ISRCQ    EQU   ((XMERR05-XMERR00)/4)+1                                          
IBKQ     EQU   ((XMERR06-XMERR00)/4)+1                                          
IFILQ    EQU   ((XMERR07-XMERR00)/4)+1                                          
ISTAQ    EQU   ((XMERR08-XMERR00)/4)+1                                          
IDAYQ    EQU   ((XMERR09-XMERR00)/4)+1                                          
ITIMQ    EQU   ((XMERR10-XMERR00)/4)+1                                          
INVOQ    EQU   ((XMERR11-XMERR00)/4)+1                                          
IOCBQ    EQU   ((XMERR12-XMERR00)/4)+1                                          
TMODQ    EQU   ((XMERR13-XMERR00)/4)+1                                          
MODQ     EQU   ((XMERR14-XMERR00)/4)+1                                          
IODVQ    EQU   ((XMERR15-XMERR00)/4)+1                                          
IUPGQ    EQU   ((XMERR16-XMERR00)/4)+1                                          
ROMQ     EQU   ((XMERR17-XMERR00)/4)+1                                          
DUPOQ    EQU   ((XMERR18-XMERR00)/4)+1                                          
IPFKQ    EQU   ((XMERR19-XMERR00)/4)+1                                          
OOVFQ    EQU   ((XMERR20-XMERR00)/4)+1                                          
UNAQ     EQU   ((XMERR21-XMERR00)/4)+1                                          
OSKQ     EQU   ((XMERR22-XMERR00)/4)+1                                          
IDATQ    EQU   ((XMERR23-XMERR00)/4)+1                                          
NHDRQ    EQU   ((XMERR24-XMERR00)/4)+1                                          
NDDFQ    EQU   ((XMERR25-XMERR00)/4)+1                                          
SRCSTQ   EQU   ((XMERR26-XMERR00)/4)+1                                          
FLSRCQ   EQU   ((XMERR27-XMERR00)/4)+1                                          
CDLEQ    EQU   ((XMERR28-XMERR00)/4)+1                                          
CDTHQ    EQU   ((XMERR29-XMERR00)/4)+1                                          
TLNGQ    EQU   ((XMERR30-XMERR00)/4)+1                                          
XCTLQ    EQU   ((XMERR31-XMERR00)/4)+1                                          
                                                                                
*                                                                               
XMERR00  DS    0H                                                               
XMERR01  B     MFLD                MISSING INPUT FIELD                          
XMERR02  B     IFLD                INVALID INPUT FIELD                          
XMERR03  B     RNF                 RECORD NOT FOUND                             
XMERR04  B     ISEL                INVALID SELECT CODE                          
XMERR05  B     ISRC                INVALID SOURCE                               
XMERR06  B     IBOOK               INVALID BOOK                                 
XMERR07  B     IFILE               INVALID FILE                                 
XMERR08  B     ISTA                INVALID STATION                              
XMERR09  B     IDAY                INVALID DAY                                  
XMERR10  B     ITIME               INVALID TIME                                 
XMERR11  B     INVO                INVALID OPTION KEYWORD                       
XMERR12  B     IOCB                INVALID OPTION COMBINATION                   
XMERR13  B     TMOD                TOO MANY OPTION DATA VALUES                  
XMERR14  B     MOD                 MISSING OPTION DATA                          
XMERR15  B     IODV                INVALID OPTION DATA VALUE                    
XMERR16  B     IUPG                INVALID UPGRADE EXPRESSION                   
XMERR17  B     ROPTMISS            REQUIRED OPTION MISSING                      
XMERR18  B     DUPOPT              DUPLICATED OPTION KEYWORD                    
XMERR19  B     IPFK                INVALID PF KEY                               
XMERR20  B     OOVF                OPTION ONLY VALID FOR (&T)                   
XMERR21  B     UNA                 UPGRADE NOT ALLOWED (&T)                     
XMERR22  B     OSK                 OPTION SPECIFIED BY KEYWORD ONLY             
XMERR23  B     IDAT                INVALID DATE EXPRESSION                      
XMERR24  B     NHDR                INVENTORY HEADER NOT FOUND                   
XMERR25  B     NDDF                NO DEMOGRAPHIC DATA FOUND                    
XMERR26  B     SRCST               INVALID SOURCE/STATION COMBINATION           
XMERR27  B     FLSRC               INVALID FILE/SOURCE COMBINATION              
XMERR28  B     CDLE                CAN'T DELETE LAST ENTRY                      
XMERR29  B     CDTH                TRACK HISTORY CAN NOT BE DELETED NOW         
XMERR30  B     TLNG                &T (RECORD IS TOO LONG)                      
XMERR31  B     XCTL                ERROR TRANSFERRING CONTROL TO &T             
ERRX#    EQU   ((*-XMERR00)/4)+1                                                
                                                                                
ERRX2#   EQU   ((*-XMERR00)/4)+1                                                
                                                                                
XMERRQ   EQU   ((*-XMERR00)/4)+1                                                
         EJECT                                                                  
                                                                                
MFLD     DS    0H                  MISSING INPUT FIELD                          
         MVI   ERROR,MISSING                                                    
         B     ERREXIT                                                          
*                                                                               
IFLD     DS    0H                  INVALID INPUT FIELD                          
         MVI   ERROR,INVALID                                                    
         B     ERREXIT                                                          
*                                                                               
RNF      DS    0H                  RECORD NOT FOUND                             
         MVI   ERROR,NOTFOUND                                                   
         B     ERREXIT                                                          
*                                                                               
ISEL     DS    0H                  INVALID SELECT CODE                          
         MVC   MSGNUM2,=H'221'                                                  
         MVI   MSGSYS,GTGENSYS                                                  
         B     ERRGTXT                                                          
*                                                                               
ISRC     DS    0H                  INVALID SOURCE                               
         MVC   MSGNUM2,=H'82'                                                   
         MVI   MSGSYS,15                                                        
         B     ERRGTXT                                                          
*                                                                               
IBOOK    DS    0H                  INVALID BOOK                                 
         MVC   MSGNUM2,=H'91'                                                   
         MVI   MSGSYS,15                                                        
         B     ERRGTXT                                                          
*                                                                               
IFILE    DS    0H                  INVALID FILE                                 
         MVC   MSGNUM2,=H'80'                                                   
         MVI   MSGSYS,15                                                        
         B     ERRGTXT                                                          
*                                                                               
ISTA     DS    0H                  INVALID STATION                              
         MVC   MSGNUM2,=H'92'                                                   
         MVI   MSGSYS,15                                                        
         B     ERRGTXT                                                          
*                                                                               
IDAY     DS    0H                  INVALID DAY                                  
         MVC   MSGNUM2,=H'100'                                                  
         MVI   MSGSYS,15                                                        
         B     ERRGTXT                                                          
*                                                                               
ITIME    DS    0H                  INVALID TIME                                 
         MVC   MSGNUM2,=H'101'                                                  
         MVI   MSGSYS,15                                                        
         B     ERRGTXT                                                          
*                                                                               
INVO     DS    0H                  INVALID OPTION KEYWORD                       
         MVC   MSGNUM2,=H'206'                                                  
         MVI   MSGSYS,GTGENSYS                                                  
         B     ERRGTXT                                                          
*                                                                               
IOCB     DS    0H                  INVALID OPTION COMBINATION                   
         MVC   MSGNUM2,=AL2(RR#IOCMB)                                           
         B     ERRGTXT                                                          
*                                                                               
TMOD     DS    0H                  TOO MANY OPTION DATA VALUES                  
         MVC   MSGNUM2,=AL2(RR#TMOD)                                            
         B     ERRGTXT                                                          
*                                                                               
MOD      DS    0H                  MISSING OPTION DATA                          
         MVC   MSGNUM2,=AL2(RR#MOPTD)                                           
         B     ERRGTXT                                                          
*                                                                               
IODV     DS    0H                  INVALID OPTION DATA VALUE                    
         MVC   MSGNUM2,=H'209'                                                  
         MVI   MSGSYS,GTGENSYS                                                  
         B     ERRGTXT                                                          
*                                                                               
IUPG     DS    0H                  INVALID UPGRADE EXPRESSION                   
         MVC   MSGNUM2,=AL2(RR#IUPGX)                                           
         B     ERRGTXT                                                          
*                                                                               
ROPTMISS DS    0H                  REQUIRE OPTION MISSING                       
         MVC   MSGNUM2,=AL2(RR#ROPTM)                                           
         B     ERRGTXT                                                          
*                                                                               
DUPOPT   DS    0H                  DUPLICATED OPTION KEYWORD                    
         MVC   MSGNUM2,=H'208'                                                  
         MVI   MSGSYS,GTGENSYS                                                  
         B     ERRGTXT                                                          
*                                                                               
IPFK     DS    0H                  INVALID PF KEY                               
         MVC   MSGNUM2,=AL2(RR#IPFKY)                                           
         MVC   ACURFORC,AFRSTKEY                                                
         B     ERRGTXT                                                          
*                                                                               
OOVF     DS    0H                  OPTION ONLY VALID FOR (&T)                   
         MVC   MSGNUM2,=AL2(RR#OVLDF)                                           
         B     ERRGTXT                                                          
*                                                                               
UNA      DS    0H                  UPGRADE NOT ALLOWED (&T)                     
         MVC   MSGNUM2,=AL2(RR#UPNA)                                            
         B     ERRGTXT                                                          
*                                                                               
OSK      DS    0H                  OPTION SPECIFIED BY KEYWORD ONLY             
         MVC   MSGNUM2,=AL2(RR#OPSKW)                                           
         B     ERRGTXT                                                          
*                                                                               
IDAT     DS    0H                  INVALID DATE EXPRESSION                      
         MVC   MSGNUM2,=H'6'                                                    
         MVI   MSGSYS,GTGENSYS                                                  
         B     ERRGTXT                                                          
*                                                                               
NHDR     DS    0H                  INVENTORY HEADER NOT FOUND                   
         MVC   MSGNUM2,=AL2(RR#HDRNF)                                           
         B     ERRGTXT                                                          
*                                                                               
NDDF     DS    0H                  NO DEMOGRAPHIC DATA FOUND                    
         MVC   MSGNUM2,=AL2(RR#NDDF)                                            
         MVC   ACURFORC,A1IPDATA                                                
         B     ERRGTXT                                                          
*                                                                               
SRCST    DS    0H                  INVALID SRC/STN COMBO                        
         MVC   MSGNUM2,=AL2(RR#SRCST)                                           
         MVC   ACURFORC,A1IPDATA                                                
         B     ERRGTXT                                                          
*                                                                               
FLSRC    DS    0H                  INVALID FIL/SRC COMBO                        
         MVC   MSGNUM2,=AL2(RR#FLSRC)                                           
         MVC   ACURFORC,A1IPDATA                                                
         B     ERRGTXT                                                          
*                                                                               
CDLE     DS    0H                  CAN'T DELETE LAST ENTRY                      
         MVC   MSGNUM2,=AL2(RR#CDLE)                                            
         B     ERRGTXT                                                          
*                                                                               
CDTH     DS    0H                  TRACK HISTORY CAN NOT BE DELETED NOW         
         MVC   MSGNUM2,=AL2(RR#CDTH)                                            
         B     ERRGTXT                                                          
*                                                                               
TLNG     DS    0H                  &T (RECORD IS TOO LONG)                      
         MVC   MSGNUM2,=AL2(RR#2LONG)                                           
         B     ERRGTXT                                                          
*                                                                               
XCTL     DS    0H                  ERROR TRANSFERRING CONTROL TO &T             
         MVC   MSGNUM2,=AL2(RR#XCTLE)                                           
         B     ERRGTXT                                                          
         EJECT                                                                  
ERRGTXT  DS    0H                  TELL GENCON TO GOTO GETTXT                   
         OI    GENSTAT2,USGETTXT                                                
         LA    R1,GETTXTCB                                                      
         USING GETTXTD,R1                                                       
         XC    GTBLOCK,GTBLOCK                                                  
         MVI   GTMAXL,L'CONHEAD     MAX L(OUTPUT AREA)                          
         MVI   GTMTYP,GTMERR        ERROR TYPE MSG                              
         MVC   GTMSGNO,MSGNUM2      ERROR #                                     
         MVC   GTMSYS,MSGSYS        IN CASE CONNECTED SYS OVERRIDED             
         LA    RF,CONHEADH                                                      
         STCM  RF,7,GTAOUT          A(OUTPUT AREA)                              
         CLI   MYTEXT,0            ANY REPLACE TEXT?                            
         BE    *+18                                                             
         MVC   GTLTXT,MYTEXT        YES, PUT LENGTH IN                          
         LA    RF,MYTEXT+1                                                      
         STCM  RF,7,GTATXT           AS WELL AS THE ADDR OF THE TEXT            
         DROP  R1                                                               
         MVI   ERROR,0                                                          
         B     ERREXIT                                                          
                                                                                
                                                                                
ERREXIT  DS    0H                                                               
         LR    R0,R2               SAVE DISPL OF FIELD                          
         S     R0,ATWA                                                          
         STH   R0,PRVFDSP                                                       
         OC    ACURFORC,ACURFORC   WANT TO FORCE CURSOR ELSEWHERE?              
         BZ    *+8                                                              
         L     R2,ACURFORC          YEP                                         
                                                                                
         B     ALLMSGX                                                          
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBRXM--WRN MSGS)+        
               '                                                                
*-------------------------- WARNING MESSAGES -------------------------*         
                                                                                
* These are messages where the user needs to hit <Enter> only for a             
*  response (for acknowledgment).  Previous values are restored,                
*  except in the case when the key changed in the same transaction.             
                                                                                
XMWRN    DS    0H                                                               
         TM    CHNGFLG1,CF1KEY     IF KEY DID NOT CHANGE,                       
         BO    XMW002                                                           
         MVI   GOSUBN,RPRV#         RESET VALUES TO WHAT THEY WERE              
         GOTO1 AGOSUB                                                           
                                                                                
XMW002   DS    0H                                                               
         LA    RE,IROOPT1H                                                      
         LH    RF,DLASTLLN                                                      
         A     RF,ATWA                                                          
         STM   RE,RF,AMNISTRT      SET START/END TO MDFY FOR NEXT INPUT         
         MVI   GOSUBN,MNI#         KEEP MODIFIED FIELDS FOR NEXT INPUT          
         GOTO1 AGOSUB                                                           
                                                                                
         MVI   MSGSYS,0            ASSUME CONNECTED SYS NOT OVERRIDED           
         MVC   AERREX,ERREX                                                     
         LA    R2,IROSTTNH         FORCE CURSOR TO KEY                          
                                                                                
         DS    0H                                                               
         CLI   OURWRNCD,0                                                       
         BH    *+6                                                              
         DC    H'0'                                                             
         CLI   OURWRNCD,XMWRNQ                                                  
         BL    *+6                                                              
         DC    H'0'                                                             
                                                                                
         ZIC   RF,OURWRNCD         BRANCH OFF TO SET WARNING MESSAGE            
         STC   RF,PRVMSGCD         REMEMBER MESSAGE CODE                        
         BCTR  RF,0                                                             
         SLL   RF,2                                                             
         B     XMWRN00(RF)                                                      
                                                                                
WTOPQ    EQU   ((XMWRN01-XMWRN00)/4)+1                                          
WBOTQ    EQU   ((XMWRN02-XMWRN00)/4)+1                                          
NSV1Q    EQU   ((XMWRN03-XMWRN00)/4)+1                                          
NSV2Q    EQU   ((XMWRN04-XMWRN00)/4)+1                                          
NSV3Q    EQU   ((XMWRN05-XMWRN00)/4)+1                                          
TDNEQ    EQU   ((XMWRN06-XMWRN00)/4)+1                                          
                                                                                
XMWRN00  DS    0H                                                               
XMWRN01  B     WTOP                TOP OF LIST                                  
XMWRN02  B     WBOT                BOTTOM OF LIST                               
XMWRN03  B     NSV1                WILL NOT SAVE AFTER OPTIONS CHANGE           
XMWRN04  B     NSV2                WILL NOT SAVE AFTER SELECT/DESELECT          
XMWRN05  B     NSV3                WILL NOT SAVE AFTER LIST PARMS CHNGE         
XMWRN06  B     TDNE                TRACK DISPLAYED DOES NOT EXIST               
WRNX#    EQU   ((*-XMWRN00)/4)+1                                                
                                                                                
XMWRNQ   EQU   ((*-XMWRN00)/4)+1                                                
         EJECT                                                                  
WTOP     DS    0H                       TOP OF LIST                             
         MVC   MSGNUM2,=AL2(RW#TOPLI)                                           
         B     WRNGTXT                                                          
*                                                                               
WBOT     DS    0H                       BOTTOM OF LIST                          
         MVC   MSGNUM2,=AL2(RW#BOTLI)                                           
         B     WRNGTXT                                                          
*                                                                               
NSV1     DS    0H                       WILL NOT SAVE AFTER OPTIONS CHG         
         MVC   MSGNUM2,=AL2(RW#NSV)                                             
         LA    RE,MYTEXT+1                                                      
         LR    RF,RE                                                            
         MVC   0(L'RE@OPTS,RF),RE@OPTS                                          
         LA    RF,L'RE@OPTS+1(RF)                                               
         MVC   0(L'RE@CHA,RF),RE@CHA                                            
         LA    RF,L'RE@CHA(RF)                                                  
         SR    RF,RE                                                            
         STC   RF,MYTEXT                                                        
         LA    R2,IROOPT1H         OVRRIDE CURSR TO OPTIONS FIELD               
         B     WRNGTXT                                                          
*                                                                               
NSV2     DS    0H                       WILL NOT SAVE AFTER SEL/DESEL           
         MVC   MSGNUM2,=AL2(RW#NSV)                                             
         LA    RE,MYTEXT+1                                                      
         LR    RF,RE                                                            
         MVC   0(L'RE@SEL,RF),RE@SEL                                            
         MVC   L'RE@SEL(3,RF),=C'/de'                                           
         LA    RF,L'RE@SEL+3(RF)                                                
         MVC   0(L'RE@SEL,RF),RE@SEL                                            
         LA    RF,L'RE@SEL(RF)                                                  
         SR    RF,RE                                                            
         STC   RF,MYTEXT                                                        
         MVC   ACURFORC,A1SELCH    OVRRIDE CURSR TO 1ST SEL FLD CHNGED          
         B     WRNGTXT                                                          
*                                                                               
NSV3     DS    0H                       WILL NOT SAVE AFTER LST PRM CHG         
         MVC   MSGNUM2,=AL2(RW#NSV)                                             
         LA    RE,MYTEXT+1                                                      
         LR    RF,RE                                                            
         MVC   0(L'RE@LP,RF),RE@LP                                              
         LA    RF,L'RE@LP+1(RF)                                                 
         MVC   0(L'RE@CHA,RF),RE@CHA                                            
         LA    RF,L'RE@CHA(RF)                                                  
         SR    RF,RE                                                            
         STC   RF,MYTEXT                                                        
         MVC   ACURFORC,A1LPCH     OVRRIDE CURSR TO 1ST SEL FLD CHNGED          
         B     WRNGTXT                                                          
*                                                                               
TDNE     DS    0H                       TRACK DISPLAYED DOES NOT EXIST          
         MVC   MSGNUM2,=AL2(RW#TNXST)                                           
         B     WRNGTXT                                                          
         EJECT                                                                  
WRNGTXT  DS    0H                  TELL GENCON TO GOTO GETTXT                   
         OI    GENSTAT2,USGETTXT                                                
         LA    R1,GETTXTCB                                                      
         USING GETTXTD,R1                                                       
         XC    GTBLOCK,GTBLOCK                                                  
         MVI   GTMAXL,L'CONHEAD     MAX L(OUTPUT AREA)                          
         MVI   GTMTYP,GTMWRN        ERROR TYPE MSG                              
         MVC   GTMSGNO,MSGNUM2      ERROR #                                     
         MVC   GTMSYS,MSGSYS        IN CASE CONNECTED SYS OVERRIDED             
         LA    RF,CONHEADH                                                      
         STCM  RF,7,GTAOUT          A(OUTPUT AREA)                              
         CLI   MYTEXT,0            ANY REPLACE TEXT?                            
         BE    *+18                                                             
         MVC   GTLTXT,MYTEXT        YES, PUT LENGTH IN                          
         LA    RF,MYTEXT+1                                                      
         STCM  RF,7,GTATXT           AS WELL AS THE ADDR OF THE TEXT            
         DROP  R1                                                               
         B     WRNEXIT                                                          
                                                                                
                                                                                
WRNEXIT  DS    0H                                                               
         MVI   ERROR,0                                                          
         ICM   R0,15,ACURFORC      OVERRIDE CURSOR POSITION                     
         BZ    *+6                                                              
         LR    R2,R0                YEP                                         
                                                                                
         B     ALLMSGX                                                          
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBRXM--INF MSGS)+        
               '                                                                
*---------------------------- INFO MESSAGES --------------------------*         
                                                                                
* At entry, R2-->appropriate field to put cursor on.                            
                                                                                
XMINF    DS    0H                                                               
         MVI   MSGSYS,0            ASSUME CONNECTED SYS NOT OVERRIDED           
         XC    ACURFORC,ACURFORC                                                
         LA    R1,CONHEAD                                                       
                                                                                
         DS    0H                                                               
         MVC   AERREX,ERREX        SET ADDRESS OF ERREX ROUTINE                 
         CLI   OURINFCD,INFX#                                                   
         BL    XMINFGO                                                          
         MVC   AERREX,ERREX2        TO GO OFF TO                                
         CLI   OURINFCD,INFX2#                                                  
         BL    XMINFGO                                                          
         DC    H'0'                                                             
                                                                                
XMINFGO  DS    0H                                                               
         CLI   OURINFCD,0                                                       
         BH    *+6                                                              
         DC    H'0'                                                             
         CLI   OURINFCD,XMINFQ                                                  
         BL    *+6                                                              
         DC    H'0'                                                             
                                                                                
         ZIC   RF,OURINFCD         BRANCH OFF TO SET INFO MESSAGE               
         STC   RF,PRVMSGCD         REMEMBER MESSAGE CODE                        
         BCTR  RF,0                                                             
         SLL   RF,2                                                             
         B     XMINF00(RF)                                                      
                                                                                
DCPLXQ   EQU   ((XMINF01-XMINF00)/4)+1  DATA TOO COMPLEX TO DISPLAY             
RECSVQ   EQU   ((XMINF02-XMINF00)/4)+1  RECORD SAVED - ENTER NEXT               
NTRDELQ  EQU   ((XMINF03-XMINF00)/4)+1  REC DSPLYED - PRESS ENTR TO DEL         
RDELQ    EQU   ((XMINF04-XMINF00)/4)+1  REC DISPLAYED IS DELETED                
NTRRSTQ  EQU   ((XMINF05-XMINF00)/4)+1  REC DSPLYED - PRESS ENTR TO RST         
RRSTQ    EQU   ((XMINF06-XMINF00)/4)+1  REC RESTORED - ENTER NXT RQST           
NSUPQ    EQU   ((XMINF07-XMINF00)/4)+1  FUNCTION NOT SUPPORTED YET              
ENTFLDQ  EQU   ((XMINF08-XMINF00)/4)+1  PLEASE ENTER FIELDS AS REQUIRED         
UPAPPLQ  EQU   ((XMINF09-XMINF00)/4)+1  "&T" UPGRADE APPLIED TO TRACK           
                                                                                
XMINF00  DS    0H                                                               
XMINF01  B     DCPLX                                                            
XMINF02  B     RECSV               RECORD SAVED - ENTER NEXT                    
XMINF03  B     NTRDEL              RCRD DISPLAYED - PRESS ENTER TO DEL          
XMINF04  B     RDEL                RECORD DISPLAYED IS DELETED                  
XMINF05  B     NTRRST              RCRD DISPLAYED - PRESS ENTER TO RSTR         
XMINF06  B     RRST                RECORD RESTORED - ENTER NEXT REQUEST         
XMINF08  B     ENTFLD              PLEASE ENTER FIELDS AS REQUIRED              
XMINF09  B     UPAPPL              "&T" UPGRADE APPLIED TO TRACK                
INFX#    EQU   ((*-XMINF00)/4)+1                                                
                                                                                
XMINF07  B     NSUP                                                             
INFX2#   EQU   ((*-XMINF00)/4)+1                                                
                                                                                
XMINFQ   EQU   ((*-XMINF00)/4)+1                                                
         EJECT                                                                  
DCPLX    DS    0H                       DATA TOO COMPLEX TO DISPLAY             
         MVC   MSGNUM2,=AL2(RI#DCPLX)                                           
         MVC   ACURFORC,AFRSTKEY                                                
         B     INFGTXT                                                          
*                                                                               
RECSV    DS    0H                       RECORD SAVED - ENTER NEXT               
         MVC   MSGNUM2,=AL2(2045)                                               
         MVI   MSGSYS,GTGENSYS                                                  
         B     INFGTXT                                                          
*                                                                               
NTRDEL   DS    0H                       REC DSPLYED - PRESS NTR TO DEL          
         MVC   MSGNUM2,=AL2(24)                                                 
         MVC   ACURFORC,AFRSTKEY                                                
         MVI   MSGSYS,GTGENSYS                                                  
         B     INFGTXT                                                          
*                                                                               
RDEL     DS    0H                       RECORD DISPLAYED IS DELETED             
         MVC   MSGNUM2,=AL2(RI#RDIDL)                                           
         MVC   ACURFORC,AFRSTKEY                                                
         B     INFGTXT                                                          
*                                                                               
NTRRST   DS    0H                       REC DSPLYED - PRESS NTR TO RSTR         
         MVC   MSGNUM2,=AL2(25)                                                 
         MVC   ACURFORC,AFRSTKEY                                                
         MVI   MSGSYS,GTGENSYS                                                  
         B     INFGTXT                                                          
*                                                                               
RRST     DS    0H                       RECORD RSTORED - ENTER NXT RQST         
         MVC   MSGNUM2,=AL2(8)                                                  
         MVC   ACURFORC,AFRSTKEY                                                
         MVI   MSGSYS,GTGENSYS                                                  
         B     INFGTXT                                                          
*                                                                               
ENTFLD   DS    0H                       PLEASE ENTER FIELDS AS REQUIRED         
         MVC   MSGNUM2,=AL2(2)                                                  
         ST    R2,ACURFORC                                                      
         MVI   MSGSYS,GTGENSYS                                                  
         B     INFGTXT                                                          
*                                                                               
UPAPPL   DS    0H                       "&T" UPGRADE APPLIED TO TRACK           
         MVC   MSGNUM2,=AL2(RI#UPAPP)                                           
         LA    R0,IROOPT1H                                                      
         ST    R0,ACURFORC                                                      
         B     INFGTXT                                                          
*                                                                               
NSUP     DS    0H                       FUNCTION NOT SUPPORTED YET              
         MVC   0(26,R1),=C'Function not supported yet'                          
         B     INFEXIT                                                          
*                                                                               
         EJECT                                                                  
INFGTXT  DS    0H                  TELL GENCON TO GOTO GETTXT                   
         OI    GENSTAT2,USGETTXT                                                
         LA    R1,GETTXTCB                                                      
         USING GETTXTD,R1                                                       
         XC    GTBLOCK,GTBLOCK                                                  
         MVI   GTMAXL,L'CONHEAD     MAX L(OUTPUT AREA)                          
         MVI   GTMTYP,GTMINF        ERROR TYPE MSG                              
         MVC   GTMSGNO,MSGNUM2      ERROR #                                     
         MVC   GTMSYS,MSGSYS        IN CASE CONNECTED SYS OVERRIDED             
         LA    RF,CONHEADH                                                      
         STCM  RF,7,GTAOUT          A(OUTPUT AREA)                              
         CLI   MYTEXT,0            ANY REPLACE TEXT?                            
         BE    *+18                                                             
         MVC   GTLTXT,MYTEXT        YES, PUT LENGTH IN                          
         LA    RF,MYTEXT+1                                                      
         STCM  RF,7,GTATXT           AS WELL AS THE ADDR OF THE TEXT            
         DROP  R1                                                               
         B     INFEXIT                                                          
                                                                                
                                                                                
INFEXIT  DS    0H                                                               
         OC    ACURFORC,ACURFORC   NEED TO SET CURSOR?                          
         BNZ   INFEXITX             NOPE                                        
         MVC   ACURFORC,AFRSTKEY   PLACE CURSOR ON 1ST KEY FIELD,               
                                                                                
INFEXITX DS    0H                                                               
         MVI   ERROR,0                                                          
         B     ALLMSGX                                                          
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBRXM--LTORG && +        
               CONSTANTS)'                                                      
*-------------------------- LTORG & CONSTANTS ------------------------*         
         LTORG                                                                  
                                                                                
                                                                                
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SUBRXM--MISC STUF+        
               F)'                                                              
*--------------------- SUBRXM MISCELLANEOUS STUFF --------------------*         
                                                                                
SUBRXML  EQU   *-XMSGRTN                                                        
         DS    0CL(X'1000'-SUBRXML+1)                                           
***********************************************************************         
         DROP  R7,R8,RA,RB,RC                                                   
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE'                           
***********************************************************************         
*========================== RMP18's EQUATES ==========================*         
                                                                                
EOT      EQU   X'00'               END OF TABLE MARKER                          
                                                                                
ANROVER  EQU   18                  ACTNUM FOR ROVER                             
ANTKDELE EQU   20                    "     "  TKDELETE                          
ANTKREST EQU   21                    "     "  TKRESTOR                          
PHINVTRA EQU   X'17'               PHASE NUMBER FOR INV/TRACKS                  
PHINVROV EQU   X'18'               PHASE NUMBER FOR INV/ROVER                   
PHINVDOV EQU   X'19'               PHASE NUMBER FOR INV/DOVER                   
PHINVLST EQU   X'10'               PHASE NUMBER FOR INV/LIST                    
SCINVTRA EQU   X'E8'               SCREEN NUMBER FOR INV/TRACKS                 
SCINVROV EQU   X'E7'               SCREEN NUMBER FOR INV/ROVER                  
SCINVDOV EQU   X'E6'               SCREEN NUMBER FOR INV/DOVER                  
SCINVLST EQU   X'D8'               SCREEN NUMBER FOR INV/LIST                   
SCINVDLS EQU   X'DA'               SCREEN NUMBER FOR INV/DLIST                  
SCINVXDM EQU   X'C7'               SCREEN NUMBER FOR INV/ROVER XPND DEM         
*                                                                               
SELQNORM EQU   C'S'                NORMAL SELECT                                
SELQWTWK EQU   C'W'                SELECT TO WEIGHT W/ WEEKS                    
SELQXPDM EQU   C'E'                SELECT TO EXPAND DEMOS                       
SELQDEL  EQU   C'D'                SELECT TO DELETE                             
*                                                                               
DNHOMES  EQU   1                   DEMO CATEGORY # FOR HOMES                    
MXLTNTRY EQU   60                  MAX ENTRIES FOR LIST TABLE                   
MXGSTACK EQU   15                  MAX ENTRIES FOR GOSUB STACK                  
PAGEQ    EQU   2                   TWA PAGE # FOR TEMPSTR                       
UPGDLNQ  EQU   14                  LENGTH OF UPGRADE ELEMENT                    
UPVALCH  EQU   C'/'                SPECIAL CHARACTER TO DDUPVAL                 
SCANLDAY EQU   12                  SCANNER LENGTH FOR DAY/TIMES INPUT           
IKYINVL  EQU   RINVKINV-RINVREC+L'RINVKINV                                      
DMKIVRQ  EQU   (RINVPEL-RINVREC)-(DRFRSTEL-DRKEY)                               
TIASVLEN EQU   BIGENDSV-BIGAREA                                                 
IUNWRKL  EQU   IUNRECL+1000                                                     
LOCWRKL  EQU   IUNWRKL+RM18WRKL                                                 
                                                                                
SZLSTLIN EQU   IROLDTAH-IROLHEDH           SIZE OF ONE LIST LINE                
SZLSTSPC EQU   IROLDTZH-IROLDTAH+SZLSTLIN  TOTAL SIZE OF LIST AREA              
SZLSPCXD EQU   IROXPDMH-IROLDTAH           TTL SZ LST AREA W/ XPND DEMS         
MXLSTLNS EQU   SZLSTSPC/SZLSTLIN           NUMBER OF LIST LINES                 
MXLSLNXD EQU   SZLSPCXD/SZLSTLIN           # OF LST LINES W/ XPND DEMOS         
MXEXPNDM EQU   6                           MAX # OF EXPANDED DEMOS              
                                                                                
*                                 ********* BIT MANIPULATIONS *********         
XFF      EQU   X'FF'                                                            
X80      EQU   X'80'                                                            
X40      EQU   X'40'                                                            
X20      EQU   X'20'                                                            
X10      EQU   X'10'                                                            
X08      EQU   X'08'                                                            
X04      EQU   X'04'                                                            
X02      EQU   X'02'                                                            
X01      EQU   X'01'                                                            
X00      EQU   X'00'                                                            
                                                                                
*                                 ************* BOOK BITS *************         
BBARB    EQU   X00                 ARBITRON                                     
BBMFX    EQU   BBARB               MEDIAFAX                                     
BBNSI    EQU   X40                 NIELSEN                                      
BBSRC    EQU   X40+X01             STRATEGY                                     
                                                                                
BBPBK    EQU   X04                 PROJECTED BOOK                               
BBTP     EQU   X08                 TIME PERIOD                                  
BBSS     EQU   X02                 SPECIAL SURVEY                               
BBEBK    EQU   X20                 ESTIMATED BOOK                               
         EJECT                                                                  
*                                 ********** PF KEYS EQUATES **********         
PFQSAVE  EQU   10                  PF10=SAVE                                    
                                                                                
*                                 *********** OPTION EQUATES **********         
OPNUPGD  EQU   1                   UPGRADE                                      
OPBUPGD  EQU   X'00000001'                                                      
OPNCUME  EQU   2                   CUMULATIVE VALUE TYPE                        
OPBCUME  EQU   X'00000002'                                                      
OPNXDSC  EQU   3                   EXPAND DEMO SCREEN                           
OPBXDSC  EQU   X'00000004'                                                      
OPNADTP  EQU   4                   ALTERNATE DAY/TIMES FOR PUTS                 
OPBADTP  EQU   X'00000008'                                                      
OPNPFM   EQU   5                   AUTO-PFM (NON-"STICKY" OPTION)               
OPBPFM   EQU   X'00000010'                                                      
***********************************************************************         
         EJECT                                                                  
***********************************************************************         
*=============================== TABLES ==============================*         
                                                                                
*                                  TABLE OF DISPLACEMENTS                       
DISPTAB  DS    0XL(2+2+2+2)                                                     
         DC    AL2(GOSUB-RMP18,0,AGOSUB-SYSD,0)                                 
         DC    AL2(XMSGRTN-RMP18,0,AXMSGRTN-SYSD,0)                             
         DC    AL2(SRTAB-RMP18,0,ARM18WRK-SYSD,ASRTAB-RM18WRKD)                 
         DC    AL2(DAYTAB-RMP18,0,ARM18WRK-SYSD,ADAYTAB-RM18WRKD)               
         DC    AL2(CODETAB-RMP18,0,ARM18WRK-SYSD,ACODETAB-RM18WRKD)             
         DC    AL2(TABELCPY-RMP18,0,ARM18WRK-SYSD,ATBELCPY-RM18WRKD)            
         DC    AL2(FPRTTAB-RMP18,0,ARM18WRK-SYSD,AFPRTTAB-RM18WRKD)             
         DC    AL2(RSVCTAB-RMP18,0,ARM18WRK-SYSD,ARSVCTAB-RM18WRKD)             
         DC    AL2(UPGKYWTB-RMP18,0,ARM18WRK-SYSD,AUPGKWTB-RM18WRKD)            
         DC    AL2(OPTTABLE-RMP18,0,ARM18WRK-SYSD,AOPTTAB-RM18WRKD)             
         DC    AL2(MLSTDIR-BIGAREA,ATIA-GEND,AMLSTDIR-SYSD,0)                   
         DC    AL2(LISTTAB-BIGAREA,ATIA-GEND,ALISTTAB-SYSD,0)                   
         DC    AL2(INVLIST-BIGAREA,ATIA-GEND,AINVLIST-SYSD,0)                   
         DC    AL2(XPNDMTAB-BIGAREA,ATIA-GEND,AXPNDMTB-SYSD,0)                  
         DC    AL2(DBLOCK1-BIGAREA,ATIA-GEND,ADBLOCK-SYSD,0)                    
         DC    AL2(DBXTND1-BIGAREA,ATIA-GEND,ADBXTND-SYSD,0)                    
         DC    AL2(DBXTRINV-BIGAREA,ATIA-GEND,ADBXTRIN-SYSD,0)                  
         DC    AL2(DTLAREA-BIGAREA,ATIA-GEND,ADTLAREA-SYSD,0)                   
         DC    AL2(SVDBLOCK-BIGAREA,ATIA-GEND,ASVDBLK-SYSD,0)                   
         DC    AL2(SVLP-BIGAREA,ATIA-GEND,ASVLP-SYSD,0)                         
         DC    AL2(SVLSTB-BIGAREA,ATIA-GEND,ASVLSTB-SYSD,0)                     
         DC    AL2(SVMLDR-BIGAREA,ATIA-GEND,ASVMLDR-SYSD,0)                     
         DC    AL2(SVOPTV-BIGAREA,ATIA-GEND,ASVOPTV-SYSD,0)                     
         DC    AL2(SVLTCTL-BIGAREA,ATIA-GEND,ASVLTCTL-SYSD,0)                   
         DC    AL2(LISTPARM-SYSD,ASYSD-GEND,ALISTPRM-SYSD,0)                    
         DC    AL2(OPTVALS-SYSD,ASYSD-GEND,AOPTVALS-SYSD,0)                     
         DC    AL2(LSTTBCTL-SYSD,ASYSD-GEND,ALTTBCTL-SYSD,0)                    
DISPTABQ EQU   (*-DISPTAB)/(L'DISPTAB)                                          
                                                                                
                                                                                
SUBRTNTB DS    0XL(1+2)                                                         
         DC     AL1(R01#),AL2(SUBR01-RMP18)                                     
         DC     AL1(R02#),AL2(SUBR02-RMP18)                                     
         DC     AL1(R03#),AL2(SUBR03-RMP18)                                     
         DC     AL1(R04#),AL2(SUBR04-RMP18)                                     
         DC     AL1(R05#),AL2(SUBR05-RMP18)                                     
         DC     AL1(R06#),AL2(SUBR06-RMP18)                                     
         DC     AL1(R07#),AL2(SUBR07-RMP18)                                     
         DC    AL1(EOT)                                                         
                                                                                
                                                                                
LBLTAB   DS    0XL(2+8)            TABLE OF LABELS FOR BIG STORAGE              
         DC    AL2(MLDIRLBL-BIGAREA),CL8'*MLSDIR*'                              
         DC    AL2(LSTBLABL-BIGAREA),CL8'*LSTTAB*'                              
         DC    AL2(INVLLABL-BIGAREA),CL8'*INVLST*'                              
         DC    AL2(XPNDLABL-BIGAREA),CL8'*XPNDEM*'                              
         DC    AL2(DBLKLABL-BIGAREA),CL8'*DBLOCK*'                              
         DC    AL2(DBXTLABL-BIGAREA),CL8'*DBXTND*'                              
         DC    AL2(SVDBLABL-BIGAREA),CL8'*SVDBLK*'                              
         DC    AL2(SVLPLABL-BIGAREA),CL8'**SVLP**'                              
         DC    AL2(SVLTLABL-BIGAREA),CL8'*SVLSTB*'                              
         DC    AL2(SVMLLABL-BIGAREA),CL8'*SVMLDR*'                              
         DC    AL2(SVOPLABL-BIGAREA),CL8'*SVOPTV*'                              
LBLTABQ  EQU   (*-LBLTAB)/(L'LBLTAB)                                            
                                                                                
                                                                                
TABCLR   DS    0XL(1+2+2)          STORAGES TO CLEAR                            
         DC    C'I',AL2(MLSTDIR-BIGAREA),AL2(MLSTDIRX-MLSTDIR)                  
         DC    C'I',AL2(LISTTAB-BIGAREA),AL2(LISTTABX-LISTTAB)                  
         DC    C'I',AL2(DBLOCK1-BIGAREA),AL2(DBLOCK1X-DBLOCK1)                  
         DC    C'I',AL2(DBXTND1-BIGAREA),AL2(DBXTND1X-DBXTND1)                  
         DC    C'I',AL2(SVDBLOCK-BIGAREA),AL2(SVDBLCKX-SVDBLOCK)                
         DC    C'S',AL2(LISTPARM-SYSD),AL2(LISTPRMX-LISTPARM)                   
         DC    C'S',AL2(MYTEXT-SYSD),AL2(MYTEXTX-MYTEXT)                        
TABCLRQ  EQU   (*-TABCLR)/(L'TABCLR)                                            
                                                                                
                                                                                
SRTAB    DS    0XL(2+2+2)          TABLE OF SAVE/RESTORE INFO                   
         DC    AL2(AMLSTDIR-SYSD,ASVMLDR-SYSD,MLSTDIRX-MLSTDIR)                 
         DC    AL2(ALISTTAB-SYSD,ASVLSTB-SYSD,LISTTABX-LISTTAB)                 
         DC    AL2(ALISTPRM-SYSD,ASVLP-SYSD,LISTPRMX-LISTPARM)                  
         DC    AL2(AOPTVALS-SYSD,ASVOPTV-SYSD,OPTVALSQ)                         
         DC    AL2(ALTTBCTL-SYSD,ASVLTCTL-SYSD,LSTTBCTQ)                        
SRTABQ   EQU   (*-SRTAB)/L'SRTAB                                                
         EJECT                                                                  
DCLIST   DS    0C                  DATA DICTIONARY ESCAPE SEQUENCES             
         DCDDL RE#10PF,L'RE@10PF,L                                              
         DCDDL RE#PF10S,L'RE@PF10S,L                                            
         DCDDL RE#PF12R,L'RE@PF12R,L                                            
         DCDDL RE#PF12N,L'RE@PF12N,L                                            
         DCDDL RE#CHA,L'RE@CHA,L                                                
         DCDDL RE#OPTS,L'RE@OPTS,L                                              
         DCDDL RE#SEL,L'RE@SEL,L                                                
         DCDDL RE#LP,L'RE@LP,L                                                  
DCLISTX  EQU   *                                                                
                                                                                
                                                                                
TABELCPY DS    0X                  TABLE OF ELEMENTS TO COPY                    
         DC     XL1'02'             TEXT FILTER ELEMENT                         
         DC     XL1'03'             TRANSFER FROM ELEMENT                       
         DC     XL1'CD'             CODE ELEMENT                                
         DC     XL1'EF'             ACTIVITY ELEMENT                            
         DC     AL1(EOT)                                                        
                                                                                
                                                                                
*^^COCO                                                                         
         PRINT OFF                                                              
*&&DO                                                                           
FPRTTAB  DS    0XL(1+2)            FIELDS WHOSE PROTECTN CAN BE TOGGLE          
         DC     AL1(010),AL2(CPRTFT1-RMP18)  OPTION FIELD                       
         DC     AL1(020),AL2(CPRTFT2-RMP18)  INPUT PARM: SOURCE                 
         DC     AL1(022),AL2(CPRTFT2-RMP18)    "    "  : FILE                   
         DC     AL1(024),AL2(CPRTFT2-RMP18)    "    "  : BOOK                   
         DC     AL1(026),AL2(CPRTFT2-RMP18)    "    "  : STATION                
         DC     AL1(028),AL2(CPRTFT2-RMP18)    "    "  : PURE/INV #             
         DC     AL1(030),AL2(CPRTFT2-RMP18)    "    "  : DAY                    
         DC     AL1(032),AL2(CPRTFT2-RMP18)    "    "  : TIME/EFFDATE           
         DC     AL1(034),AL2(CPRTFT1-RMP18)    "    "  : DEMO CATEGORY          
         DC     AL1(050),AL2(CPRTFT2-RMP18)  ACTION (SELECT) FIELD              
FPRTTABQ EQU    (*-FPRTTAB)/L'FPRTTAB                                           
*&&                                                                             
         PRINT ON                                                               
*^^EOCOCO                                                                       
FPRTTAB  DS    0XL(1+2)            FIELDS WHOSE PROTECTN CAN BE TOGGLE          
         DC     AL1(010),AL2(CPRTFT1-RMP18)  OPTION FIELD                       
         DC     AL1(014),AL2(CPRTFT3-RMP18)  FOOTNOTE FIELD                     
         DC     AL1(016),AL2(CPRTFT1-RMP18)  UPDATE FOOTNOTE ON SAVE?           
         DC     AL1(020),AL2(CPRTFT1-RMP18)  INPUT PARM: SOURCE                 
         DC     AL1(022),AL2(CPRTFT1-RMP18)    "    "  : FILE                   
         DC     AL1(024),AL2(CPRTFT1-RMP18)    "    "  : BOOK                   
         DC     AL1(026),AL2(CPRTFT1-RMP18)    "    "  : STATION                
         DC     AL1(028),AL2(CPRTFT1-RMP18)    "    "  : PURE/INV #             
         DC     AL1(030),AL2(CPRTFT1-RMP18)    "    "  : DAY                    
         DC     AL1(032),AL2(CPRTFT1-RMP18)    "    "  : TIME/EFFDATE           
         DC     AL1(034),AL2(CPRTFT1-RMP18)    "    "  : DEMO CATEGORY          
         DC     AL1(050),AL2(CPRTFT1-RMP18)  ACTION (SELECT) FIELD              
         DC     AL1(060),AL2(CPRTFT1-RMP18)  EXPANDED DEMO   FIELDS             
FPRTTABQ EQU    (*-FPRTTAB)/L'FPRTTAB                                           
         EJECT                                                                  
DAYTAB   DS    0X                  DAY TABLE (SEE DAYTABD)                      
         DC    X'0',X'40',X'10',CL3'MON'                                        
         DC    X'0',X'20',X'20',CL3'TUE'                                        
         DC    X'0',X'10',X'30',CL3'WED'                                        
         DC    X'0',X'08',X'40',CL3'THU'                                        
         DC    X'0',X'04',X'50',CL3'FRI'                                        
         DC    X'0',X'02',X'60',CL3'SAT'                                        
         DC    X'0',X'01',X'70',CL3'SUN'                                        
         DC    C'T',X'7C',X'95',CL3'M-F'                                        
         DC    C'P',X'7C',X'00',CL3'M-F'                                        
         DC    C'P',X'7F',X'80',CL3'M-S'                                        
         DC    X'FF',X'FF',X'FF',CL3'???'                                       
DAYTABQ  EQU   (*-DAYTAB)/(DYTLEN)                                              
                                                                                
                                                                                
CODETAB  DS    0XL(2+1+3)                                                       
         DC    C'  ',AL1(CDPAV),CL3'PAV'                                        
         DC    C'PR',AL1(CDPAV),CL3'PAV'                                        
         DC    C'TP',AL1(CDTP),CL3'TP '                                         
         DC    C'TT',AL1(CDTP),CL3'TP '                                         
         DC    C'PJ',AL1(CDPAV+CDINV),AL3(0)                                    
         DC    C'ES',AL1(CDPAV+CDINV),AL3(0)                                    
         DC    C'PT',AL1(CDMIXPT),AL3(0)                                        
         DC    C'PA',AL1(CDPAV),AL3(0)                                          
CODETABQ EQU   (*-CODETAB)/L'CODETAB                                            
         DC    XL2'0000',AL1(CDPAV+CDINV),AL3(0)                                
                                                                                
                                                                                
MGFOPT   DS    0AL2                TABLE OF TWA OPTION FIELDS TO MERGE          
         DC    AL2(IROOPT1H-T810FFD)                                            
         DC    AL2(IROOPT2H-T810FFD)                                            
         DC    AL2(0)                                                           
MGFOPTX  EQU   *                                                                
                                                                                
                                                                                
CUMTYPTB DS    0X                  TABLE OF CUMULATIVE VALUE TYPES              
         DC     AL1(5,L'OPVCUMTB),CL5'TOTAL',CL(L'OPVCUMTB)'T'                  
         DC     AL1(3,L'OPVCUMTB),CL3'AVG',CL(L'OPVCUMTB)'A'                    
         DC    AL1(EOT)                                                         
                                                                                
                                                                                
YESNOTAB DS    0X                  TABLE OF YES/NO VALUES                       
         DC     AL1(3,1),CL3'YES',CL1'Y'                                        
         DC     AL1(2,1),CL2'NO',CL1'N'                                         
         DC    AL1(EOT)                                                         
                                                                                
                                                                                
RSVCTAB  DS    0CL(3+1)            TABLE OF VALID RATING SERVICES               
         DC     CL3'NSI',C'N'       NIELSEN                                     
         DC     CL3'MFX',C'M'       MEDIAFAX                                    
         DC     CL3'SRC',C'S'       STRATEGY RESEARCH                           
         DC     CL3'NHT',C'H'       NETWORK - NHTI FILE                         
         DC    AL1(EOT)                                                         
         EJECT                                                                  
UPGKYWTB DS    0XL(1+1+2)          TABLE OF VALID UPGRADE TYPES                 
         DC    AL1(2),XL1'80',AL2(FURTG-RMP18)   RTG Upgrade                    
         DC    AL1(3),XL1'80',AL2(FUHPS-RMP18)   HUT/PUT/SHR Upgrades           
         DC    AL1(4),XL1'80',AL2(FUIDX-RMP18)   INDEX Upgrade                  
         DC    AL1(6),XL1'80',AL2(FUHPT-RMP18)   HPT Upgrade                    
         DC    AL1(8),XL1'80',AL2(FUY4S-RMP18)   Y4S Upgrade                    
         DC    AL1(9),XL1'80',AL2(FUMMU-RMP18)   MMU Upgrade                    
         DC    XL1'0B',XL1'80',AL2(FUPIX-RMP18)  PINDEX Upgrade                 
         DC    XL1'0C',XL1'80',AL2(FUSIX-RMP18)  SINDEX Upgrade                 
         DC    XL1'0D',XL1'80',AL2(FUPVG-RMP18)  PAVG   Upgrade                 
         DC    XL1'0E',XL1'80',AL2(FUSVG-RMP18)  SAVG   Upgrade                 
         DC    XL1'2B',XL1'80',AL2(FUPIX-RMP18)  PINDEX Upgrade (INV)           
         DC    XL1'2C',XL1'80',AL2(FUSIX-RMP18)  SINDEX Upgrade (INV)           
         DC    XL1'2D',XL1'80',AL2(FUPVG-RMP18)  PAVG   Upgrade (INV)           
         DC    XL1'2E',XL1'80',AL2(FUSVG-RMP18)  SAVG   Upgrade (INV)           
         DC    CL1'A',XL1'B0',AL2(FUDEM-RMP18)   DEMO Upgrade                   
         DC    AL1(EOT)                                                         
                                                                                
                                                                                
NRMVLTAB DS    0XL(2+2)            TABLE OF VALUES TO NORMALIZE                 
         DC     AL2(IUNIVS-IUNRECD),AL2(IOLDRTG-IUNRECD)                        
         DC     AL2(IUNIVS-IUNRECD),AL2(IOLDIMP-IUNRECD)                        
         DC     AL2(IUNIVS-IUNRECD),AL2(IOLDHPT-IUNRECD)                        
         DC     AL2(IUNIVS-IUNRECD),AL2(IOLDTOT-IUNRECD)                        
         DC     AL2(IUNIVS-IUNRECD),AL2(INEWRTG-IUNRECD)                        
         DC     AL2(IUNIVS-IUNRECD),AL2(INEWIMP-IUNRECD)                        
         DC     AL2(IUNIVS-IUNRECD),AL2(INEWHPT-IUNRECD)                        
         DC     AL2(IUNIVS-IUNRECD),AL2(INEWTOT-IUNRECD)                        
NRMVLTBQ EQU   ((*-NRMVLTAB)/L'NRMVLTAB)                                        
         EJECT                                                                  
*---------------------------- SOURCE TABLE ---------------------------*         
                                                                                
* This table was imported from RERMP0B.  The difference is that                 
*  RERMP0B has a branch address in bytes 2-4, while this overlay has            
*  a 3-byte code of the rating service.  Another difference is that             
*  the end of this table is marked w/ EOT.                                      
* A new source, Mediafax, is also added to this table.  It is equated           
*  to Arbitron because that is what BOOKVAL does.                               
*    Byte 1      RINVKSRC value                                                 
*    Byte 2-4    3-byte rating service                                          
*    Byte 5      BOOKVAL book-type bits                                         
*    Byte 6      book-type character for printing                               
                                                                                
SRCTAB   DS    0XL(L'STKSRC+L'STRSVC+L'STBVBITS+L'STPCHAR)                      
STKSRC   DS     CL1                KEY SOURCE                                   
STRSVC   DS     CL3                RATING SERVICE                               
STBVBITS DS     XL1                BOOKVAL BITS                                 
STPCHAR  DS     CL1                CHARACTER FOR PRINTING                       
         ORG   SRCTAB                                                           
                                                                                
         DC    CL1'A',CL3'MFX',AL1(BB_M),CL1' '   MFX                           
         DC    CL1'B',CL3'MFX',AL1(BB_MP),CL1'P'      PROJECTED                 
         DC    CL1'C',CL3'MFX',AL1(BB_MT),CL1'T'      TIME PERIOD               
         DC    CL1'D',CL3'MFX',AL1(BB_MS),CL1'S'      SPECIAL SURVEY            
         DC    CL1'E',CL3'MFX',AL1(BB_ME),CL1'E'      ESTIMATED                 
                                                                                
         DC    CL1'A',CL3'ARB',AL1(BB_A),CL1' '   ARB                           
         DC    CL1'B',CL3'ARB',AL1(BB_AP),CL1'P'      PROJECTED                 
         DC    CL1'C',CL3'ARB',AL1(BB_AT),CL1'T'      TIME PERIOD               
         DC    CL1'D',CL3'ARB',AL1(BB_AS),CL1'S'      SPECIAL SURVEY            
         DC    CL1'E',CL3'ARB',AL1(BB_AE),CL1'E'      ESTIMATED                 
                                                                                
         DC    CL1'N',CL3'NSI',AL1(BB_N),CL1' '   NSI                           
         DC    CL1'O',CL3'NSI',AL1(BB_NP),CL1'P'      PROJECTED                 
         DC    CL1'P',CL3'NSI',AL1(BB_NT),CL1'T'      TIME PERIOD               
         DC    CL1'Q',CL3'NSI',AL1(BB_NS),CL1'S'      SPECIAL SURVEY            
         DC    CL1'R',CL3'NSI',AL1(BB_NE),CL1'E'      ESTIMATED                 
                                                                                
         DC    CL1'T',CL3'SRC',AL1(BB_S),CL1' '   SRC                           
         DC    CL1'U',CL3'SRC',AL1(BB_SP),CL1'P'      PROJECTED                 
         DC    CL1'X',CL3'SRC',AL1(BB_SE),CL1'E'      ESTIMATED                 
                                                                                
         DC    XL1'FF',CL3'   ',XL1'00',CL1' '                                  
         DC    AL1(EOT)                                                         
                                                                                
                                                                                
                                                                                
BB_A     EQU   BBARB               ARB                                          
BB_AP    EQU   BBARB+BBPBK          "  PROJECTED                                
BB_AT    EQU   BBARB+BBTP           "  TIME PERIOD                              
BB_AS    EQU   BBARB+BBSS           "  SPECIAL SURVEY                           
BB_AE    EQU   BBARB+BBEBK          "  ESTIMATED                                
                                                                                
BB_M     EQU   BBMFX               MFX                                          
BB_MP    EQU   BBMFX+BBPBK          "  PROJECTED                                
BB_MT    EQU   BBMFX+BBTP           "  TIME PERIOD                              
BB_MS    EQU   BBMFX+BBSS           "  SPECIAL SURVEY                           
BB_ME    EQU   BBMFX+BBEBK          "  ESTIMATED                                
                                                                                
BB_N     EQU   BBNSI               NSI                                          
BB_NP    EQU   BBNSI+BBPBK          "  PROJECTED                                
BB_NT    EQU   BBNSI+BBTP           "  TIME PERIOD                              
BB_NS    EQU   BBNSI+BBSS           "  SPECIAL SURVEY                           
BB_NE    EQU   BBNSI+BBEBK          "  ESTIMATED                                
                                                                                
BB_S     EQU   BBSRC               SRC                                          
BB_SP    EQU   BBSRC+BBPBK          "  PROJECTED                                
BB_ST    EQU   BBSRC+BBTP           "  TIME PERIOD                              
BB_SS    EQU   BBSRC+BBSS           "  SPECIAL SURVEY                           
BB_SE    EQU   BBSRC+BBEBK          "  ESTIMATED                                
         EJECT                                                                  
*--------------------------- OPTIONS TABLE ---------------------------*         
                                                                                
OPTTABLE DS    0X                  SEE OPTDSECT                                 
*                                                                               
OP01     DS    0X                  UPT=                                         
         DC    AL1(OPNUPGD),AL1(OP01X-OP01)                                     
         DC    AL1(OPDFVRTN)                                                    
         DC    AL1(VUPG#,FUPG#)                                                 
         DC    AL4(OPBUPGD)                                                     
         DC    AL4(0)                                                           
         DC    AL4(0)                                                           
         DC    AL1(OPVUPGMX),AL1(L'OPVUPGTB),AL2(OPVUPGNM-SYSD)                 
         DC    AL2(OP01NAM1-OP01,0)                                             
OP01NAM1 DC    AL1(OP01NAMX-OP01NAM1-1),C'UPT'                                  
OP01NAMX DC    AL1(EOT)                                                         
OP01X    EQU   *                                                                
*                                                                               
OP02     DS    0X                  CUME=                                        
         DC    AL1(OPNCUME),AL1(OP02X-OP02)                                     
         DC    AL1(OPDFVTBL)                                                    
         DC    AL2(CUMTYPTB-RMP18)                                              
         DC    AL4(OPBCUME)                                                     
         DC    AL4(0)                                                           
         DC    AL4(0)                                                           
         DC    AL1(OPVCUMMX),AL1(L'OPVCUMTB),AL2(OPVCUMNM-SYSD)                 
         DC    AL2(OP02NAM2-OP02,0)                                             
OP02NAM2 DC    AL1(OP02NAMX-OP02NAM2-1),C'CUME'                                 
OP02NAMX DC    AL1(EOT)                                                         
OP02X    EQU   *                                                                
*                                                                               
OP03     DS    0X                  EXPAND=                                      
         DC    AL1(OPNXDSC),AL1(OP03X-OP03)                                     
         DC    AL1(OPDFVTBL)                                                    
         DC    AL2(YESNOTAB-RMP18)                                              
         DC    AL4(OPBXDSC)                                                     
         DC    AL4(0)                                                           
         DC    AL4(0)                                                           
         DC    AL1(OPVXDSMX),AL1(L'OPVXDSTB),AL2(OPVXDSNM-SYSD)                 
         DC    AL2(OP03NAME-OP03,0)                                             
OP03NAME DC    AL1(OP03NAMX-OP03NAME-1),C'EXPAND'                               
OP03NAMX DC    AL1(EOT)                                                         
OP03X    EQU   *                                                                
*                                                                               
OP04     DS    0X                  ALTPUT=                                      
         DC    AL1(OPNADTP),AL1(OP04X-OP04)                                     
         DC    AL1(OPDFVRTN)                                                    
         DC    AL1(VADP#,FADP#)                                                 
         DC    AL4(OPBADTP)                                                     
         DC    AL4(0)                                                           
         DC    AL4(0)                                                           
         DC    AL1(OPVADPMX),AL1(L'OPVADPTB),AL2(OPVADPNM-SYSD)                 
         DC    AL2(OP04NAME-OP04,0)                                             
OP04NAME DC    AL1(OP04NAMX-OP04NAME-1),C'ALTPUT'                               
OP04NAMX DC    AL1(EOT)                                                         
OP04X    EQU   *                                                                
*                                                                               
OP05     DS    0X                  PFM                                          
         DC    AL1(OPNPFM),AL1(OP05X-OP05)                                      
         DC    AL1(OPDFKYWD+OPDFDDSO)                                           
         DC    AL1(0,0)                                                         
         DC    AL4(OPBPFM)                                                      
         DC    AL4(0)                                                           
         DC    AL4(0)                                                           
         DC    AL1(OPVPFMMX),AL1(L'OPVPFMTB),AL2(OPVPFMNM-SYSD)                 
         DC    AL2(OP05NAME-OP05,OP05VALS-OP05)                                 
OP05NAME DC    AL1(OP05NAMX-OP05NAME-1),C'PFM'                                  
OP05NAMX DC    AL1(EOT)                                                         
OP05VALS DC    AL1(OP05VALX-OP05VALS-1),CL(L'OPVPFMTB)'P'                       
OP05VALX DC    AL1(EOT)                                                         
OP05X    EQU   *                                                                
*                                                                               
OPTZ     DC    AL1(EOT)                                                         
                                                                                
         EJECT                                                                  
***********************************************************************         
*        SUBSIDIARY ROUTINES A.L.(AFTER LEE)                                    
***********************************************************************         
                                                                                
****************************************************************                
*                                                              *                
*        CHECK FOR NON-STANDARD ROTATION REQUEST EXPRESSION    *                
*              P1=ADDR OF EXPRESSION,P2=ADDR FOR OUTPUT BYTE   *                
*                                                              *                
****************************************************************                
*                                                                               
CHKNSR   NTR1  BASE=*,LABEL=*                                                   
*                                  VALIDATE FOR "AVN" OR "AVGN"                 
                                                                                
         ZICM  R2,1(R1),3          R2 POINTS AT EXPRESSION TO CHECK             
         ZIC   RF,0(R1)            RF HAS EXPRESSION LENGTH                     
         L     R3,4(R1)            ADDR FOR 1 BYTE OUTPUT                       
*                                                                               
                                                                                
                                                                                
CHKNS10  CHI   RF,3                MUST ENTER ALL THREE CHARACTERS              
         BNE   CHKNS50             IF NOT 3 CHAR, CHECK IF AV(G)N               
         CLC   0(3,R2),=C'VAR'     MATCH?                                       
         BNE   CHKNS50              NO                                          
         MVI   0(R3),X'90'          YES, SET DAYCODE                            
         B     CHKNSX                                                           
*                                                                               
CHKNS50  SHI   RF,2                SUB 1 FOR END DIGIT+1 FOR EX INSTR           
         BNP   CHKNSNO             TOO SHORT TO BE VALID NSR REQUEST            
         EXCLC RF,0(R2),=C'AVG'     LOOK FOR "AV" OR "AVG"                      
         BNE   CHKNSNO               NOPE                                       
*                                    FOUND, CONTINUE                            
         LA    RE,1(RF,R2)         RE-->LAST CHAR OF INPUT                      
         CLI   0(RE),C'2'           SHOULD BE BETWEEN 2                         
         BL    CHKNSNO                                                          
         CLI   0(RE),C'6'           AND 6 DAYS                                  
         BH    CHKNSNO                                                          
         MVC   0(1,R3),0(RE)                                                    
         NI    0(R3),X'9F'          X'90' BITS ==> VAR OR AVG-N                 
         B     CHKNSX                                                           
                                                                                
CHKNSNO  MVI   0(R3),0                                                          
*                                                                               
CHKNSX   XIT1                                                                   
*                                                                               
         EJECT                                                                  
         LTORG                                                                  
         DROP  RB                                                               
         EJECT                                                                  
                                                                                
***********************************************************************         
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (RERMPWORKD)'              
***********************************************************************         
*============================= RERMPWORKD ============================*         
       ++INCLUDE RERMPWORKD                                                     
***********************************************************************         
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (SYSD)'                    
***********************************************************************         
*========================== SYSD'S SYSSPARE ==========================*         
                                                                                
SYSD     DSECT                                                                  
         ORG   SYSSPARE                                                         
*---------------------------- COMMON AREA ----------------------------*         
                                                                                
       ++INCLUDE RERMPITSYP                                                     
                                                                                
                                                                                
*----------------------- OWNED BY RERMP18 ONLY -----------------------*         
                                                                                
*                                 ******** TRACKING INFORMATION *******         
MYSSBSIN DS    XL(L'SSBSIN)                                                     
SVSSBSIN DS    XL(L'MYSSBSIN)                                                   
                                                                                
LSTTBCTL DS   0X                                                                
NLTNTRY  DS    XL1                 # OF LIST TABLE ENTRIES                      
SNLDSPLY DS    XL1                 START ENTRY FOR LIST DISPLAY                 
ENLDSPLY DS    XL1                 END   ENTRY FOR LIST DISPLAY                 
LSTTBCTX EQU  *                                                                 
LSTTBCTQ EQU  LSTTBCTX-LSTTBCTL                                                 
                                                                                
DIDTHIS  DS    XL1                 TRACE FOR CURRENT TRANSACTION                
DIDRTI#  EQU    X80                 RESTORED TIA                                
DIDSPRV# EQU    X40                 SAVED PREVIOUS VALUES                       
DIDVOPT  EQU    X20                 VALIDATED OPTIONS                           
DIDFUDIP EQU    X10                 FUDGED INPUT PARAMETERS AS MODIF'D          
DIDDRX   EQU    X08                 EXITED DISPLAY RECORD ROUTINE               
DIDALLMX EQU    X04                 EXITED THRU ALLMSGX ROUTINE                 
DIDTHIS2 DS    XL1                 TRACE FOR CURRENT TRANSACTION #2             
DUNTHAT  DS    XL(L'DIDTHIS)       TRACE FOR PREVIOUS TRANSACTION               
DUNTHAT2 DS    XL(L'DIDTHIS2)      TRACE FOR PREVIOUS TRANSACTION #2            
                                                                                
*                                 ************** WORK AREA ************         
DEMODUB  DS    D                   EXTRA STORAGE FOR DEMUP                      
DIVIDEND DS    D                                                                
DIVISOR  DS    F                                                                
REMAINDR DS    F                                                                
QUOTIENT DS    F                                                                
RELO     DS    F                                                                
MYDMCB   DS    6F                                                               
MYWORK   DS    XL(L'WORK)                                                       
                                                                                
*                                 ************** ADDRESSES ************         
MYBASE1  DS    A                   A(1ST 4096 BYTES OF THIS PROGRAM)            
MYBASE2  DS    A                   A(2ND 4096 BYTES OF THIS PROGRAM)            
MYBASE3  DS    A                   A(3RD 4096 BYTES OF THIS PROGRAM)            
AIUNWRK  DS    A                   A(IUN WORK AREA)                             
ARM18WRK DS    A                   A(RMP18 WORK AREA)                           
ASUBRTN  DS    A                   A(SUBROUTINE POOL TO USE)                    
AERREX   DS    A                   A(ERREX ROUTINE) TO USE                      
A1SELFLD DS    A                   A(1ST SELECT FIELD)                          
AOPTNTRY DS    A                   A(OPTTABLE ENTRY)                            
ANLTNTRY DS    A                   A(NEXT AVAILABLE SLOT IN LIST TABLE)         
ONLTNTRY DS    A                   OLD VALUE OF ANLTNTRY                        
AMNISTRT DS    A                   A(START FIELD) FOR MNI# ROUTINE              
AMNIEND  DS    A                   A(END FIELD) FOR MNI# ROUTINE                
A1SELCH  DS    A                   A(1ST SELECT FIELD CHANGED)                  
A1LPCH   DS    A                   A(1ST LIST PARM FIELD CHANGED)               
A1IPDATA DS    A                   A(1ST INPUT PARM FIELD W/ DATA)              
ADEMLIST DS    A                   A(DEMO LIST TO CALL DEMOUT WITH)             
AXDTNTRY DS    A                   A(EXPANDED DEMOS TABLE ENTRY)                
AXDDEMC  DS    A                   A(EXPANDED DEMOS DEMO CATEGORY FLD)          
AXDRI    DS    A                   A(EXPANDED DEMOS RTG/IMP FLD)                
AXDSH    DS    A                   A(EXPANDED DEMOS SHARES  FLD)                
AXDPT    DS    A                   A(EXPANDED DEMOS PUT/TOT FLD)                
ADBDQD   DS    A                   A(DBDQD ENTRIES)                             
PRVFDSP  DS    H                   FIELD DISP FROM PREV TRANSACTION             
DSP1EL   DS    H                   DISPL TO 1ST ELEM OF INV RECORD              
DPFLINEH DS    H                   DISPL TO HEADER OF PFLINE                    
DLASTLLN DS    H                   DISPL TO LAST DISPLAY LIST LINE              
DLASTINP DS    H                   DISPL TO LAST INPUT FIELD                    
         DS    H                   (DUMMY TO KEEP FULL-WORD ALIGNMENT)          
                                                                                
         DS    0A                  ADDRESSES OF TABLES/ROUTINES                 
AGOSUB   DS    A                    A(SUBROUTINE POOL INTERFACE)                
AXMSGRTN DS    A                    A(EXIT W/ MSG ROUTINE)                      
AMLSTDIR DS    A                    A(MY LIST DIRECTORY)                        
ALISTTAB DS    A                    A(LIST TABLE)                               
AINVLIST DS    A                    A(INVENTORY LIST)                           
AXPNDMTB DS    A                    A(EXPAND DEMOS TABLE)                       
ADBLOCK  DS    A                    A(DBLOCK)                                   
ADBXTND  DS    A                    A(DBEXTEND)                                 
ADBXTRIN DS    A                    A(DBEXTEND AREA FOR DBXINVWK)               
ADTLAREA DS    A                    A(DBEXTEND AREA FOR DBXTLD)                 
ASVDBLK  DS    A                    A(SAVE DBLOCK)                              
ASVLP    DS    A                    A(SAVE LP AREA)                             
ASVLSTB  DS    A                    A(SAVE LISTTAB AREA)                        
ASVMLDR  DS    A                    A(SAVE MLSTDIR AREA)                        
ASVOPTV  DS    A                    A(SAVE OPTVALS AREA)                        
ASVLTCTL DS    A                    A(SAVE LISTTAB CONTROL DATA)                
ALISTPRM DS    A                    A(LIST PARAMETERS)                          
AOPTVALS DS    A                    A(OPTION VALUES)                            
ALTTBCTL DS    A                    A(LISTTAB CONTROL DATA)                     
                                                                                
*                                 ************ DEMO VALUES ************         
CUMDEMV  DS    0F                  CUMULATIVE DEMO VALUES                       
CUMRDEMV DS    F                    CUMULATIVE RATING                           
CUMSDEMV DS    F                        "      SHARE                            
CUMPDEMV DS    F                        "      PUT                              
CUMDEMVX EQU   *                                                                
CUMDEMVL EQU   CUMDEMVX-CUMDEMV                                                 
                                                                                
*                                 ************* INPUT DATA ************         
INPUTKEY DS    0C                  INPUT TO KEY FIELDS                          
IKSTTN   DS    CL5                  STATION                                     
IKINV    DS    CL4                  INVENTORY NUMBER                            
IKEFFDB  DS    XL3                  EFFECTIVE DATE (BINARY)                     
IKEFFDC  DS    XL2                  EFFECTIVE DATE (COMPRESSED)                 
IKRSVC   DS    CL3                  RATING SERVICE                              
IKSRC    DS    CL1                  SOURCE CODE                                 
IKKSRC   DS    XL1                  SOURCE CODE FOR RINVKSRC                    
IKFRBK   DS    0XL3                 FROM BOOK                                   
IKFRBTS  DS    XL1                   BITS                                       
IKBOOK   DS    XL2                   BOOK                                       
IKBTYP   DS    CL1                  BOOKTYPE                                    
IKLNQ    EQU   *-INPUTKEY                                                       
                                                                                
INPUTPRM DS    0C                  INPUT TO PARAMETER FIELDS                    
IPRSVC   DS     CL3                 RATING SERVICE                              
IPSRC    DS     CL1                 SOURCE                                      
IPFILE   DS     CL3                 DEMO FILE                                   
IPTPTT   DS     CL1                 4 WK AVG OR TYPICAL TIME TP INFO            
IPFRBK   DS     0XL3                FROM BOOK                                   
IPBITS   DS      XL1                 FROM BITS                                  
IPBOOK   DS      XL2                 BOOK                                       
IPBTYP   DS     CL1                 BOOK TYPE                                   
IPWKN    DS     XL1                 WEEK NUMBER (1-4)                           
IPSTTN   DS     CL5                 STATION                                     
IPPURE   DS     XL2                 PURE NUMBER                                 
IPINVN   DS     CL4                 INVENTORY NUMBER                            
IPIDAY   DS     XL1                 DAY                                         
IPTIME   DS     0XL4                TIMES                                       
IPSTIM   DS      XL2                 START TIME                                 
IPETIM   DS      XL2                 END   TIME                                 
IPEFFD   DS     XL2                 EFFECTIVE DATE (COMPRESSED)                 
IPDEMC   DS     XL1                 DEMO CATEGORY                               
INPTPRMX EQU   *                                                                
INPTPRML EQU   INPTPRMX-INPUTPRM                                                
                                                                                
FROMDATA DS    0X                  FROM DATA                                    
FDFILE   DS     CL3                 DEMO FILE                                   
FDTPTT   DS     CL1                 4 WK AVG OR TYPICAL TIME TP INFO            
FDFTYP   DS     CL1                 FROM TYPE (P/I)                             
FDMED    DS     CL1                 MEDIA                                       
FDFRBK   DS     0XL3                BOOK                                        
FDBITS   DS      XL1                 BITS                                       
FDBOOK   DS      XL2                 BOOK                                       
FDSTTN   DS     CL5                 STATION                                     
FDBTYP   DS     CL1                 BOOK TYPE                                   
FDDEMC   DS     XL1                 DEMO CATEGORY                               
XFCODE   DS     CL2                 TRANSFER CODE                               
FDADCMBO DS     CL1                 ADD DEMOS COMBO FLAG                        
FROMDATX EQU   *                                                                
FROMDATL EQU   FROMDATX-FROMDATA                                                
                                                                                
LISTPARM DS    0X                  PARAMETERS TO PRODUCE LIST                   
LPFUNCT  DS    XL1                  DEMAND REQUEST FUNCTION                     
LPSRC    DS    CL1                  SOURCE                                      
LPFILE   DS    CL3                  DEMO FILE                                   
LPTPTT   DS    CL1                  4 WK AVG OR TYPICAL TIME TP INFO            
LPSTTN   DS    CL5                  STATION                                     
LPFRBK   DS    0XL3                 FROM BOOK                                   
LPFRBTS  DS    XL1                   BITS                                       
LPBOOK   DS    XL2                   BOOK                                       
LPBTYP   DS    CL1                  BOOKTYPE                                    
LPWKN    DS    XL1                  WEEK NUMBER (1-4)                           
LPPURE   DS    XL2                  PURE NUMBER                                 
LPINVN   DS    CL4                  INVENTORY NUMBER                            
LPIDAY   DS    XL1                  INTERNAL DAY                                
LPTIME   DS    0XL4                 MILITARY START & END TIMES                  
LPSTIM   DS    XL2                   START TIME                                 
LPETIM   DS    XL2                   END   TIME                                 
LPNOR    DS    CL1                  NOR PROGRAMMING                             
LPBEST   DS    CL1                  BEST/ALL PROGRAMMING                        
LPEFFDT  DS    XL2                  EFFECTIVE START DATE                        
LPWTOV   DS    XL1                  OVERRIDE WEIGHT                             
LPTMCHG  DS    CL1                  TIME CHANGE FLAG                            
LPFLAG   DS    XL1                  FLAG                                        
LPFPURE  EQU    RIDHFPUR             REQUESTED VIA PURE # (PAV ONLY)            
LPDEMC   DS    XL1                  DEMO CATEGORY NUMBER                        
LPDEMLST DS    XL(3+1)              DEMO LIST + TERMNATR (1 DEMO ONLY)          
LISTPRMX EQU   *                                                                
LISTPRML EQU   LISTPRMX-LISTPARM                                                
                                                                                
*                                 ************ HEADER INFO ************         
HDRINFO  DS    0X                                                               
HDRIDAY  DS     XL1                 (INTERNAL) DAY                              
HDRTIME  DS     0XL4                TIMES                                       
HDRSTIM  DS      XL2                 START                                      
HDRETIM  DS      XL2                 END                                        
HDRTMCHG DS     CL1                 TIME CHANGE FLAG                            
HDRPRGNA DS     CL27                PROGRAM NAME                                
HDRINFOX EQU   *                                                                
HDRINFOL EQU   HDRINFOX-HDRINFO                                                 
                                                                                
*                                 ************* TRACK INFO ************         
TRKINFO  DS    0X                                                               
TRKDA    DS     XL4                 DISK ADDRESS OF TRACK                       
TRKFTNT  DS     CL16                FOOTNOTE                                    
TRKUPGD  DS    XL(UPGDLNQ)         UPGRADE ELEMENT FROM TRACK RECORD            
TRKCUME  DS    XL(L'OPVCUMTB)      CUMULATIVE OPTN FROM TRACK RECORD            
TRKADTP  DS    XL(L'OPVADPTB)      ALTERNATE DAYS/TIMES FOR PUTS                
TRKINFOX EQU   *                                                                
TRKINFOL EQU   TRKINFOX-TRKINFO                                                 
                                                                                
*                                 ******* PROGRAM TITLE FOOTNOTE ******         
FNWORK   DS    0X                                                               
FNWB1    DS     0XL(2+1)            FIRST BOOK INFO                             
FNWB1BK  DS      XL2                                                            
FNWB1BT  DS      CL1                                                            
FNWB2    DS     0XL(2+1)            SECOND BOOK INFO                            
FNWB2BK  DS      XL2                                                            
FNWB2BT  DS      CL1                                                            
FNWPROG1 DS     CL16                NAME OF FIRST PROGRAM                       
FNWPROG2 DS     CL16                NAME OF SECOND PROGRAM                      
FNWORKX  EQU   *                                                                
FNWORKL  EQU   FNWORKX-FNWORK                                                   
                                                                                
*                                 ******** (DEMO) SUMMARY INFO ********         
SUMLT    DS    XL(LISTTABQ)        LISTTAB ENTRY FOR SUMMARY LINE               
SUMINFO  DS    0X                                                               
SUMNQHR  DS     XL(L'LTNQHR)       NUMBER OF QUARTER HOURS                      
SUMQH_WK DS     XL(L'LTQH_WK)      TOTAL # OF QUARTER HOURS WITH WEEKS          
SUMPGNAM DS     XL(L'LTPGNAM)      PROGRAM NAME                                 
SUMINFOX EQU   *                                                                
SUMINFOL EQU   SUMINFOX-SUMINFO                                                 
                                                                                
*                                 ************ TEMP STORAGE ***********         
TMPS     DS   0X                                                                
TMPRSVC  DS    CL3                 TEMP STORAGE FOR RATING SERVICE              
TMPSRC   DS    CL1                  "      "     "  SOURCE                      
TMPKSRC  DS    CL1                  "      "     "  KEY SOURCE                  
TMPFRBK  DS    0XL3                 "      "     "  FROM BOOK                   
TMPFRBTS DS     XL1                 "      "     "   BITS                       
TMPBOOK  DS     XL2                 "      "     "   BOOK                       
TMPDFIL  DS    CL3                  "      "     "  FILE                        
TMPCODE  DS    CL2                  "      "     "  TRANSFER CODE               
TMPSTTN  DS    CL5                  "      "     "  STATION                     
TMPINVN  DS    CL4                  "      "     "  INVENTORY NUMBER            
TMPPURE  DS    CL4                  "      "     "  PURE NUMBER                 
TMPBTYP  DS    CL1                  "      "     "  BOOK TYPE                   
TMPWKN   DS    XL1                  "      "     "  WEEK NUMBER (1-4)           
TMPIDAY  DS    XL1                  "      "     "  INTERNAL DAY                
TMPNDAY  DS    XL1                  "      "     "  NUMBER OF DAYS              
TMPKDAY  DS    XL1                  "      "     "  KEY DAY                     
TMPSETM  DS    0XL4                 "      "     "  TIMES                       
TMPSTIM  DS     XL2                 "      "     "   START TIME                 
TMPETIM  DS     XL2                 "      "     "   END TIME                   
TMPNOR   DS    CL1                  "      "     "  NOR PROGRAM FLAG            
TMPNQHR  DS    XL1                  "      "     "  # OF QUARTER HOURS          
TMPQH_WK DS    XL1                  "      "     "  # QH WITH WEEKS             
TMPWKS   DS    XL1                  "      "     "  WEEKS                       
TMPBEST  DS    CL1                  "      "     "  BEST/ALL                    
TMPPGNAM DS    CL13                 "      "     "  PROGRAM NAME                
TMPDEMC  DS    XL1                  "      "     "  DEMO CATEGORY               
TMPMTIM  DS    XL2                  "      "     "  MILITARY TIME               
TMPMED   DS    CL1                  "      "     "  MEDIA                       
TMPQHR   DS    XL1                  "      "     "  QUARTER HOUR                
TMPBDATE DS    XL3                  "      "     "  BINARY DATE                 
TMPCDATE DS    XL2                  "      "     "  COMPRESSED DATE             
TMPWTOV  DS    XL1                  "      "     "  OVERRIDE WEIGHT             
TMPWT_WK DS    XL1                  "      "     "  WGT FACTOR W/ WEEKS         
TMPFLAG  DS    XL1                  "      "     "  FLAGS                       
TMPFLAG2 DS    XL1                  "      "     "  FLAGS #2                    
TMPQLFY  DS    CL1                  "      "     "  QUALIFIER                   
TMPTMCHG DS    CL1                  "      "     "  TIME CHANGE FLAG            
TMPPGDUR DS    CL1                  "      "     "  WGT W/ WEEKS FLAG           
TMPNLTN  DS    XL1                  "      "     "  # LISTTAB ENTRIES           
TMPQHAF  DS    XL1                  "      "     "  QH ADJUSTMENT FACTR         
TMPSX    EQU  *                                                                 
TMPSL    EQU  TMPSX-TMPS                                                        
                                                                                
CUMFCTR  DS    F                   CUMLTV FACTOR FOR MULT. DEMAND CALLS         
CUMNQH   DS    H                   CUMULATIVE # OF QUARTER HOURS                
DEMNQH   DS    H                                                                
OURBYTE  DS    XL1                 ANOTHER 1-BYTE WORKING STORAGE               
NLNDSPLY DS    XL1                 # OF LINES DISPLAYED                         
GOSUBN   DS    XL1                 SUBROUTINE NUMBER                            
GOSUBNXD DS    XL1                 SUBROUTINE NUMBER FOR EXPANDED DEMOS         
MYRDUPDT DS    XL1                 MY VERSION OF RDUPDATE                       
MSGNUM2  DS    XL2                                                              
MSGSYS   DS    XL1                                                              
MSGTYPE  DS    CL1                 (E)RROR, (W)ARNING, OR (I)NFO                
PRVMSGCD DS    XL1                 PREVIOUS ERROR/WARNING/INFO CODE             
OURERRCD DS    XL1                 MY ERROR   CODE                              
OURWRNCD DS    XL1                 MY WARNING CODE                              
OURINFCD DS    XL1                 MY INFO    CODE                              
COUNTER  DS    XL1                                                              
FLDDSPL  DS    XL1                 DISPL OF SUB-FIELD INTO FIELD                
SCANLNTH DS    XL1                 L'RHS OF SCANNER BLOCK ENTRY                 
NOPTN    DS    XL1                 NUMBER OF OPTIONS INPUTTED                   
OPTI     DS    AL4                 THE OPTIONS INPUTTED                         
OPTR     DS    AL4                 OPTIONS REQUIRED                             
OPTX     DS    AL4                 OPTIONS NOT ALLOWED                          
                                                                                
*                                 *********** MISCELLANEOUS ***********         
UPSHFRBK DS    XL(1+2)             SHARE "FROM BITS-BOOK" FOR UPGRADES          
ACTVWHY  DS    CL1                 REASON FOR ACTIVITY                          
MYCALLER DS    XL1                 SCREEN THAT CALLED THIS PHASE                
MY_CSTAT DS    CL(L'CSTAT)         SAVE FIELD FOR CSTAT                         
NDMDCALL DS    PL1                 NUMBER OF DEMAND CALLS                       
NLSTLNS  DS    XL1                 NUMBER OF AVAILABLE LIST LINES               
                                                                                
*                                 *************** FLAGS ***************         
FIRSTIME DS    CL1                 1st TIME OVLY CALLED SNCE SCR LOADED         
                                                                                
MISCFLG1 DS    XL1                 MISC FLAG #1                                 
MF1GDPLY EQU    X80                 GO TO DISPLAY LOGIC                         
MF1RDDEL EQU    X20                 CAN READ DELETED RECORDS AS WELL            
MF1GOPFM EQU    X10                 AUTO-PFM REQUESTED                          
MF1ERRQ  EQU    X01                                                             
MF1TDFTP EQU    X02                 TRANSFER DEFAULT = TP                       
MF1TDFTT EQU    X04                 TRANSFER DEFAULT = TT                       
MF1RSTKC EQU   0                   RESET THESE ON KEY CHANGE                    
                                                                                
RECDFLG1 DS    XL1                 FLAGS ABOUT RECORD (TRACK)                   
RF1DEL   EQU    X80                 RECORD MARKED FOR DELETION                  
RF1DNXST EQU    X40                 TRACK DOES NOT EXIST                        
RF1TKSAV EQU    X20                 IN PROCESS OF WRITING TRACK TO FILE         
                                                                                
DPLYFLG1 DS    XL1                 DISPLAY FLAG #1                              
DF1PFSAV EQU    X80                 DISPLAYED PFKEY FOR SAVING                  
DF1FTNOT EQU    X40                 NEED TO DISPLAY FOOTNOTE                    
DF1OPTN  EQU    X20                 NEED TO RE-DISPLAY OPTIONS                  
DF1OPTTK EQU    X10                 DISPLAY THOSE OPTIONS SAVED W/ TRK          
                                                                                
CHNGFLG1 DS    XL1                 CHANGE FLAG #1                               
CF1KEY   EQU    X80                 A KEY FIELD HAS CHANGED                     
CF1OPT   EQU    X40                 OPTION FIELD HAS BEEN INPUTTED              
CF1IP    EQU    X20                 LIST PARAMETER HAS BEEN INPUTTED            
CF1IPDC  EQU    X10                 LIST PARAMETER DEMO CATGORY MODFYD          
CF1XDDC  EQU    X08                 EXPANDED DEMOS DEMO CATGORY MODFYD          
CF1KO    EQU   CF1KEY+CF1OPT                                                    
                                                                                
INPMFLG1 DS    XL1                 INPUT PARAMETER FLAG #1                      
IPF1SC   EQU    X80                 THERE IS SOURCE  INPUT                      
IPF1FL   EQU    X40                   "   "  FILE      "                        
IPF1BK   EQU    X20                   "   "  BOOK      "                        
IPF1ST   EQU    X10                   "   "  STATION   "                        
IPF1PI   EQU    X08                   "   "  PUR/IV#   "                        
IPF1DY   EQU    X04                   "   "  DAY       "                        
IPF1TE   EQU    X02                   "   "  TM/EFFD   "                        
IPF1ALL  EQU   IPF1SC+IPF1FL+IPF1BK+IPF1ST+IPF1PI+IPF1DY+IPF1TE                 
                                                                                
SELFLAG1 DS    XL1                 SELECT FLAG #1                               
SF1AL1ES EQU    X80                 AT LEAST 1 ITEM SELECTED IN LIST            
SF1SLECT EQU    X40                 AN ENTRY GOT SELECTED                       
SF1DSLCT EQU    X20                 AN ENTRY GOT DE-SELECTED                    
SF1DEL   EQU    X10                 AN ENTRY SELECTED FOR DELETION              
SF1AL1ESXD EQU  X08                 AT LEAST 1 ITEM SELECTED EXPND DEMO         
SF1SLECTXD EQU  X04                 AN ENTRY GOT SELECTED FOR EXPND DEM         
SF1DSLCTXD EQU  X02                 AN ENTRY GOT DE-SELECTED FOR "   "          
SF1DELSEL  EQU  X01                 DELETING A SELECTED ITEM                    
SF1RSTKC EQU   SF1AL1ES+SF1SLECT+SF1DSLCT+SF1AL1ESXD+SF1SLECTXD+SF1DSLC+        
               TXD+SF1DEL                                                       
                                                                                
VRFLAG1  DS    XL1                 VALREC FLAG #1                               
VRF1RLT  EQU    X80                 WENT TO REFRESH LIST TABLE                  
VRF1BLT  EQU    X40                 WENT TO BUILD LIST TABLE                    
VRF1BLD  EQU    X20                 WENT TO RE-BUILD LIST DIRECTORY             
VRF1SDV  EQU    X10                 WENT TO SEED DEMO VALUES                    
VRF1CUM  EQU    X08                 RECALCULATED CUMULATIVE VALUES              
VRF1ILT  EQU    X04                 WENT TO INITIALIZE LIST TABLE               
VRF1XDM  EQU    X02                 RECALCULATED EXPANDED DEMO VALUES           
VRF1DLN  EQU    X01                 RECALCULATED EXPANDED DEMO VALUES           
VRF1TSKS EQU   VRF1RLT+VRF1BLT+VRF1BLD+VRF1SDV+VRF1CUM+VRF1ILT+VRF1XDM++        
               VRF1DLN                                                          
                                                                                
DEMFLAG1 DS    XL1                 DEMO FLAG #1                                 
DF1ADCMB EQU    X80                 ADD DATA UP FOR COMBOS                      
DF1WGTOV EQU    X40                 WEIGHT OVERRIDE                             
DF1RDOK  EQU    X20                 DEMAND READ OK--"GOOD" DATA TO HOOK         
DF1FRINV EQU    X10                 FROM INVENTORY FILE                         
DF1BUNIV EQU    X08                 HAVE BASE UNIVS FOR NORMALIZING             
DF1HKMAD EQU    X04                 HOOK PERFORMED  MAD  OPERATION              
DF1RSTKC EQU   DF1ADCMB+DF1WGTOV   RESET THESE ON KEY CHANGE                    
DF1RSTDC EQU   DF1HKMAD+DF1RDOK    RESET THESE PRIOR TO DEMAND CALL             
                                                                                
TYPELP   DS    XL1                 TYPE OF LIST PARAMETERS                      
TLPIDEF  EQU    C'I'                INVENTORY RECORD "DEFINITION"               
TLPHIST  EQU    C'H'                HISTORY OF DATA IN INVENTORY RECD           
TLPUINP  EQU    C'U'                USER INPUTTED LIST PARAMS                   
TLPXFER  EQU    C'F'                "TRANSFER FROM" DATA                        
                                                                                
HOWLT    DS    CL1                 HOW LIST TABLE WAS CONSTRUCTED               
HLTINIT  EQU    C'I'                LIST TABLE WAS INITIALIZED                  
HLTBUILT EQU    C'B'                LIST TABLE WAS BUILT                        
                                                                                
CODECTL  DS    XL1                 CODE CONTROL BITS                            
CDPAV    EQU    X80                 CODE "IMPLIES" PAV FILE                     
CDINV    EQU    X40                  "       "     INV  "                       
CDTP     EQU    X20                  "       "     TP   "                       
CDMIXPT  EQU   CDPAV+CDTP            "       "     PAV & TP FILE                
                                                                                
MYTAPEP  DS    CL1                 TAPE (IMP) PRECISION WANTED (Y/N)            
                                                                                
UPGFLAG  DS    XL1                 UPGRADE FLAG                                 
UPGFDECP EQU    X80                 DECIMAL PRECISION                           
UPGFPUT  EQU    X40                 AUTO-APPLIED  PUT  UPGRADE                  
                                                                                
POSTFLG1 DS    XL1                 POSTING TO LISTTAB FLAG                      
PSTF1DTL EQU    X80                 POST "DETAIL" LINES                         
PSTF1SUM EQU    X40                 POST "SUMMARY" LINES                        
                                                                                
FROMTYPE DS    CL1                 FROM FILE TYPE PASSED TO DEMUP               
FRMTYPIV EQU    C'I'                INVENTORY                                   
                                                                                
SCRNFLG  DS    XL1                 FLAGS ABOUT SCREEN                           
SCRFLIST EQU    X80                 FULL LIST SCREEN IN EFFECT                  
SCRFXPDM EQU    X40                 EXPANDED DEMOS SCREEN IN EFFECT             
                                                                                
SELTYPE  DS    CL1                 THE SELECT TYPE TO PROCESS                   
                                                                                
FUDGED   DS    CL1                 (Y)ES/(N)O                                   
                                                                                
DMDCALLR DS    CL1                 THE ROUTINE CALLING DEMAND                   
                                                                                
*                                 ************** PROFILES *************         
RMPPROFS DS    CL8                 PROFILE SETTINGS                             
                                                                                
*                                 ************* CONSTANTS *************         
DCFILTP  DS    CL3                 C'TP '                                       
DCFILPAV DS    CL3                 C'PAV'                                       
DCFILIUN DS    CL3                 C'IUN'                                       
DCFILINV DS    CL3                 C'INV'                                       
                                                                                
*                                 ******* DATA DICTIONARY TERMS *******         
DSLIST   DS    0C                                                               
RE@10PF  DS     CL31               PF5=Top  6=Bottom  7=Up  8=Down              
RE@PF10S DS     CL7                10=Save                                      
RE@PF12R DS     CL7                12=Rtrn                                      
RE@PF12N DS     CL7                12=Next                                      
RE@CHA   DS     CL6                change                                       
RE@OPTS  DS     CL7                options                                      
RE@SEL   DS     CL6                select                                       
RE@LP    DS     CL10               list parms                                   
DSLISTX  EQU   *                                                                
                                                                                
         DS    0XL(L'RE@PF12R-L'RE@PF12N+1)                                     
         DS    0XL(L'RE@PF12N-L'RE@PF12R+1)                                     
                                                                                
*                                 ************* MATH BLOCK ************         
HOMSHR   DS    3F                  SHARE VALUES                                 
HOMSHRL  EQU   *-HOMSHR                                                         
TOTSHR   DS    3F                  SHARE ACCUMULATORS                           
TOTSHRL  EQU   *-TOTSHR                                                         
CUMSHR   DS    3F                  CUMULATIVE SHARE                             
CUMSHRL  EQU   *-CUMSHR                                                         
                                                                                
         DS    0F                                                               
MATHFAC  DS    0XL17                                                            
MTHCFACS DS     A                   A(DBLOCK)                                   
MTHFCTR  DS     F                   WEIGHTING FACTOR FOR MULT & DIVIDE          
MTHIFIL  DS     CL3                 INPUT FILE                                  
MTHOFIL  DS     CL3                 OUTPUT FILE                                 
MTHOSRC  DS     CL3                 OUTPUT SOURCE                               
                                                                                
OFORMAT  DS    XL10                OUTPUT FORMAT FOR DEMAINT CALLS              
                                                                                
DEFLTBK  DS    XL2                 DEFAULT BOOK (IUN) FOR DEMO BK ELEM          
                                                                                
GKSIPARM  DS   XL5                 REGETKSRC INPUT  BLOCK                       
GKSOPARM  DS   XL5                 REGETKSRC OUTPUT BLOCK                       
                                                                                
*                                 ************** BUFFERS **************         
SAVEKEY  DS    XL(L'RINVKEY)                                                    
                                                                                
GOSTACK  DS    0X                  GOSUB STACK (ONLY PUSH, NO POP)              
         DS     XL1                 N'ENTRIES IN STACK, XFF IF OVERFLOW         
         DS     XL(MXGSTACK)                                                    
GOSTACKL EQU   *-GOSTACK                                                        
                                                                                
PVGOSTAC DS    XL(GOSTACKL)        GOSUB STACK FOR PREVIOUS TRANSACTION         
                                                                                
DEMOLIST DS    3XL3,XL1            DEMO LIST--(RTG/SHR/PUT) CTGRY + FF          
DEMOLSTX EQU   *                                                                
DEMOLSTL EQU   DEMOLSTX-DEMOLIST                                                
                                                                                
XDDEMLST DS    3XL3,XL1            DEMO LIST--(RTG/SHR/PUT) CTGRY + FF          
XDDMLSTX EQU   *                   (FOR EXPANDED DEMOS)                         
XDDMLSTL EQU   XDDMLSTX-XDDEMLST                                                
                                                                                
DEMVALS  DS    3F                  3 DEMO CATEGORIES                            
DEMVALSX EQU   *                                                                
DEMVALSL EQU   DEMVALSX-DEMVALS                                                 
                                                                                
DEMOVRDS DS    3CL1                DEMO OVERRIDE FLAGS                          
DEMOVRDX EQU   *                                                                
DEMOVRDL EQU   DEMOVRDX-DEMOVRDS                                                
                                                                                
THISDEMV DS    XL(DEMVALSL)        THIS TIME'S DEMO VALUES                      
                                                                                
MYTEXT   DS    0X                  MISCELLANEOUS TEXT FIELD                     
         DS    XL1                  L'TEXT                                      
         DS    CL20                 THE TEXT ITSELF                             
MYTEXTX  EQU   *                                                                
MYTEXTL  EQU   MYTEXTX-MYTEXT                                                   
                                                                                
DUMRINVZ DS    XL(10+1)            AREA FOR DUMMY RINVZEL ELEMENT               
         DS    0XL((L'DUMRINVZ-1)-(RINVZDAY-RINVZEL+L'RINVZDAY))                
         DS    0X                   ENSURE ENOUGH ROOM TO HOLD DAY              
         DS    0XL((L'DUMRINVZ-1)-(RINVZTIM-RINVZEL+L'RINVZTIM))                
         DS    0X                   ENSURE ENOUGH ROOM TO HOLD TIME             
                                                                                
DUMUPGD  DS    XL(UPGDLNQ)         WORK AREA FOR UPGRADE ELEMENT                
                                                                                
MYFLD    DS    0X                  MY TWA FIELD WORK AREA                       
MYFLDH   DS     XL8                 MY WORKING FIELD HEADER                     
MYFLDD   DS     XL80                MY WORKING FIELD DATA                       
MYFLDL   EQU   *-MYFLD                                                          
         EJECT                                                                  
*                                 *********** OPTION VALUES ***********         
OPTVALS  DS    0C                                                               
                                                                                
OPVUPG   DS    0X                  OPTION VALUES FOR UPGRADES                   
OPVUPGMX EQU    1                       MAX # OF VALUES ALLOWED                 
OPVUPGNM DS     XL1                     # OF VALUES SO FAR                      
OPVUPGTB DS     (OPVUPGMX)XL(UPGDLNQ)   TABLE TO HOLD VALUES                    
OPVUPGQ  EQU   *-OPVUPG                                                         
                                                                                
OPVCUM   DS    0X                  OPTION VALUES FOR CUM VALUE TYPE             
OPVCUMMX EQU    1                       MAX # OF VALUES ALLOWED                 
OPVCUMNM DS     XL1                     # OF VALUES SO FAR                      
OPVCUMTB DS     (OPVCUMMX)CL1           TABLE TO HOLD VALUES                    
OPVCUMQ  EQU   *-OPVCUM                                                         
                                                                                
OPVXDS   DS    0X                  OPTION VALUES FOR EXPAND DEMO SCREEN         
OPVXDSMX EQU    1                       MAX # OF VALUES ALLOWED                 
OPVXDSNM DS     XL1                     # OF VALUES SO FAR                      
OPVXDSTB DS     (OPVXDSMX)CL1           TABLE TO HOLD VALUES                    
OPVXDSQ  EQU   *-OPVXDS                                                         
                                                                                
OPVADP   DS    0X                  OPTION VALUES FOR ALT DY/TM FOR PUTS         
OPVADPMX EQU    1                       MAX # OF VALUES ALLOWED                 
OPVADPNM DS     XL1                     # OF VALUES SO FAR                      
OPVADPTB DS     (OPVADPMX)XL(1+4)       TABLE TO HOLD VALUES                    
OPVADPQ  EQU   *-OPVADP                                                         
                                                                                
OPVPFM   DS    0X                  OPTION VALUES FOR AUTO-PFM                   
OPVPFMMX EQU    1                       MAX # OF VALUES ALLOWED                 
OPVPFMNM DS     XL1                     # OF VALUES SO FAR                      
OPVPFMTB DS     (OPVPFMMX)XL1           TABLE TO HOLD VALUES                    
OPVPFMQ  EQU   *-OPVPFM                                                         
                                                                                
OPTVALSQ EQU   *-OPTVALS                                                        
         EJECT                                                                  
                                                                                
*                                                                               
MYSSPREL EQU   *-SYSSPARE                                                       
SYSPREMN EQU   L'SYSSPARE-MYSSPREL   AMOUNT LEFT IN SYSSPARE                    
         DS    0XL(SYSPREMN+1)       CHECK AGAINST SYSSPARE LIMIT               
***********************************************************************         
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (TWA DSECTS)'              
***********************************************************************         
*================================ TWA ================================*         
                                                                                
*---------------------------- BASE SCREEN ----------------------------*         
       ++INCLUDE RERMPFFD                                                       
         EJECT                                                                  
*-------------------------- INV/ROVER SCREEN -------------------------*         
         ORG   CONTAGH                                                          
       ++INCLUDE RERMPE7D                                                       
                                                                                
                                                                                
                                                                                
*------------------ INV/ROVER EXPANDED DEMOS SCREEN ------------------*         
         ORG   IROXPDMH                                                         
       ++INCLUDE RERMPC7D                                                       
                                                                                
                                                                                
         DS    0XL(L'IROPFLN-L'IR2PFLN+1)                                       
         DS    0XL(L'IR2PFLN-L'IROPFLN+1)                                       
                                                                                
         DS    0XL(IROXPDM-IR2XPDM+1)                                           
         DS    0XL(IR2XPDM-IROXPDM+1)                                           
         EJECT                                                                  
*------------------------- SAVED STORAGE AREA ------------------------*         
         ORG                                                                    
* WARNING: This is not a good place to save information around.  This           
*           area may coincide with the field  SVLIST  defined in                
*           RERMP00 and may eventually clobber what was there.                  
*                                                                               
MYTWAL   EQU   *-CONHEADH                                                       
         DS    0CL(3520-L'SFMPROFS-MYTWAL)  GENCON & RERMP'S TWA LIMIT          
                                                                                
                                                                                
*------------------------------ DDGENTWA -----------------------------*         
         PRINT OFF                                                              
       ++INCLUDE DDGENTWA                                                       
         PRINT ON                                                               
         EJECT                                                                  
*----------------------------- RERMPWTWA -----------------------------*         
       ++INCLUDE RERMPWTWA                                                      
***********************************************************************         
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (DBLOCKD)'                 
***********************************************************************         
*============================= DEMO BLOCK ============================*         
                                                                                
* DEDBLOCK *                                                                    
DBLOCKD  DSECT                                                                  
         PRINT OFF                                                              
       ++INCLUDE DEDBLOCK                                                       
         PRINT ON                                                               
                                                                                
                                                                                
* DEDBEXTRAD *                                                                  
         PRINT OFF                                                              
       ++INCLUDE DEDBEXTRAD                                                     
         PRINT ON                                                               
***********************************************************************         
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (OTHER DSECTS)'            
***********************************************************************         
*============================ OTHER DSECTS ===========================*         
                                                                                
* DDSPOOLD                                                                      
* DDSPLWORKD                                                                    
* FASSB                                                                         
* FASYSFAC                                                                      
* FATIOB                                                                        
* FAGETTXTD                                                                     
* DDCOMFACS                                                                     
* DDGLOBEQUS                                                                    
* DDGLPFMD                                                                      
* DDGLVXCTLD                                                                    
* DDPERVALD                                                                     
* DDCOREQUS                                                                     
* DDDICTATED                                                                    
* REMSGEQUS                                                                     
* REDDEQUS                                                                      
* DEDEMFILE                                                                     
* RERMPPROF                                                                     
         PRINT OFF                                                              
       ++INCLUDE DDSPOOLD          (GENERAL PRINT AREAS)                        
       ++INCLUDE DDSPLWORKD        (GENERAL CONTROLLER AREAS)                   
       ++INCLUDE FASSB                                                          
       ++INCLUDE FASYSFAC                                                       
       ++INCLUDE FATIOB                                                         
       ++INCLUDE FAGETTXTD                                                      
       ++INCLUDE DDCOMFACS                                                      
       ++INCLUDE DDGLOBEQUS                                                     
       ++INCLUDE DDGLPFMD                                                       
       ++INCLUDE DDGLVXCTLD                                                     
       ++INCLUDE DDPERVALD                                                      
       ++INCLUDE DDCOREQUS                                                      
       ++INCLUDE DDDICTATED                                                     
       ++INCLUDE REMSGEQUS                                                      
       ++INCLUDE REDDEQUS                                                       
       ++INCLUDE DEDEMFILE                                                      
       ++INCLUDE RERMPPROF                                                      
         PRINT ON                                                               
***********************************************************************         
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (REGEN DSECTS)'            
***********************************************************************         
*============================ REGEN DSECTS ===========================*         
                                                                                
*------------------------------ REGENINV -----------------------------*         
REINVRCD DSECT                                                                  
       ++INCLUDE REGENINVA                                                      
         EJECT                                                                  
*------------------------------ REGENSTA -----------------------------*         
RSTARECD DSECT                                                                  
         PRINT OFF                                                              
       ++INCLUDE REGENSTA                                                       
         PRINT ON                                                               
                                                                                
                                                                                
*------------------------------ REGENAVL -----------------------------*         
RAVLRECD DSECT                                                                  
         PRINT OFF                                                              
       ++INCLUDE REGENAVL                                                       
         PRINT ON                                                               
***********************************************************************         
         TITLE 'RERMP18 - INVENTORY ROAM && OVERRIDE (MISC DSECTS)'             
***********************************************************************         
*======================== MISCELLANEOUS DSECTS =======================*         
                                                                                
*----------------------- OPTION KEYWORDS DSECT -----------------------*         
                                                                                
OPTDSECT DSECT                                                                  
OPDNUMB  DS    XL1                 INTERNAL OPTION NUMBER                       
OPDNTRYL DS    XL1                 L(OPTION KEYWORD ENTRY)                      
OPDFLAG  DS    XL1                 FLAGS ABOUT KEYWORD                          
OPDFKYWD EQU    X80                 OPTION IS VALID BY KEYWORD                  
OPDFVRTN EQU    X40                 VALIDATE DATA VIA ROUTINE                   
OPDFVTBL EQU    X20                 VALIDATE DATA VIA TABLE                     
*                                    EG. AL1(3,1),CL3'YES',CL1'Y'               
*                                        AL1(2,1),CL3'NO',CL1'N'                
*                                        AL1(EOT)                               
OPDFDDSO EQU    X01                 OPTION IS FOR DDS ONLY                      
                                                                                
OPDRTNUM DS    XL1                 VALIDATION ROUTINE # (OPDFVRTN)              
OPDRTFMT DS    XL1                 FORMATTING ROUTINE # (OPDFVRTN)              
         ORG   OPDRTNUM                                                         
OPDTBDSP DS    AL2                 VALIDATION TABLE DSPL (OPDFVTBL)             
         ORG                                                                    
                                                                                
OPDOPTB  DS    AL4                 OPTION'S BIT MASK                            
OPDRQOPT DS    AL4                 OTHER OPTIONS REQUIRED                       
OPDNAOPT DS    AL4                 OPTIONS NOT ALLOWED                          
OPDMXNDV DS    XL1                 MAX # OF DATA VALUES ALLOWED                 
OPDOLEN  DS    XL1                 OUTPUT ENTRY LENGTH                          
OPDODSPL DS    AL2                 DSPL FROM SYSD OF OUTPUT FIELD               
OPDKYTB  DS    AL2                 DSPL OF KEYWORD TABLE                        
OPDVLTB  DS    AL2                 DSPL OF VALUE TABLE                          
OPDFXLNQ EQU   *-OPTDSECT                                                       
         EJECT                                                                  
*------------------------ ENTRY IN LIST TABLE ------------------------*         
                                                                                
LISTTABD DSECT                                                                  
LTNTRY   DS    XL1                 NTH ENTRY                                    
                                                                                
LTKEY    DS    0X                  KEY                                          
LTSRC    DS     CL1                 SOURCE                                      
LTFILE   DS     CL3                 T=TIME PERIOD, P=PAV, I=INVENTORY           
LTCODE   DS     CL2                 TRANSFER CODE                               
LTFRBK   DS     0XL3                FROM BOOK                                   
LTFRBTS  DS      XL1                 BITS                                       
LTBOOK   DS      XL2                 BOOK                                       
LTBTYP   DS     CL1                 BOOK TYPE                                   
LTWKN    DS     XL1                 WEEK NUMBER (1-4)                           
LTSTTN   DS     CL5                 STATION                                     
LTPURE   DS     XL2                 PURE NUMBER                                 
LTINVN   DS     CL4                 INVENTORY NUMBER                            
LTIDAY   DS     XL1                 INTERNAL DAY                                
LTTIME   DS     0XL4                TIMES                                       
LTSTIME  DS      XL2                 MILITARY START TIME                        
LTETIME  DS      XL2                 MILITARY END   TIME                        
LTNOR    DS     CL1                NORMAL PGM (X'00'/C'N'/C'Y')                 
LTEFFDT  DS     XL2                 EFFECTIVE DATE (COMPRESSED)                 
LTKEYL   EQU   *-LTKEY             L(KEY)                                       
                                                                                
LTDATA   DS    0X                  DATA                                         
LTPGNAM  DS     CL13                PROGRAM NAME                                
LTWKS    DS     XL1                 ACTIVE WEEKS                                
LTWGTOV  DS     XL1                 WEIGHT OVERRIDE                             
LTWTOVXD DS     XL1                 WEIGHT OVERRIDE FOR EXPANDED DEMOS          
LTNQHR   DS     XL1                 # OF QUARTER HOURS                          
LTQH_WK  DS     XL1                 # OF QUARTER HOURS INCLUDING WEEKS          
LTWT_WK  DS     XL1                 WEIGHT FACTOR INCLUDING WEEKS               
LTFLAG   DS     XL1                 FLAG                                        
LTFDEL   EQU     X80                 ENTRY SELECTED FOR DELETION                
LTFSLWTXD EQU    X20                 ENTRY SEL TO EXPAND DEMOS W/ WGHT          
LTFSELXD EQU     X10                 ENTRY IS SELECTED TO EXPAND DEMOS          
LTFMIXWK EQU     X08                 PROGRAMS HAVE MIXED ACTIVE WEEKS           
LTFXFRWT EQU     X04                 WEIGHT OVERRIDDEN IN TRANSFER              
LTFSELWT EQU     X02                 ENTRY SELECTED W/ WEIGHT                   
LTFSEL   EQU     X01                 ENTRY IS SELECTED                          
LTFALLSEL EQU   LTFSEL+LTFSELXD                                                 
LTFLAG2  DS     XL1                 MORE FLAGS                                  
LTF2T4   EQU     RIDHFTP4            GET 4-WEEK AVG (TIME PERIOD ONLY)          
LTF2PURE EQU     RIDHFPUR            REQUESTED VIA PURE # (PAV ONLY)            
LTF2ELD  EQU    X01                  ENTERRED INTO LIST DIRECTORY               
LTDEMVS  DS     0F                  DEMO VALUES                                 
LTRDEMV  DS      F                   RATINGS VALUE                              
LTSDEMV  DS      F                   SHARE VALUE                                
LTPDEMV  DS      F                   PUT VALUE                                  
LTDATAL  EQU   *-LTDATA            L(DATA)                                      
                                                                                
         DS    0F                                                               
LISTTABQ EQU   *-LISTTABD                                                       
         EJECT                                                                  
*------------------------ EXPANDED DEMOS TABLE -----------------------*         
                                                                                
XPNDMTBD DSECT                                                                  
XDTDEMC  DS    XL1                 DEMO CATEGORY                                
                                                                                
XDTRIMOD DS    CL1                 RTG/IMP MODIFIER                             
XDTRIVAL DS    XL4                 RTG/IMP DEMO VALUE                           
XDTRIFLG DS    XL1                 FLAG FOR RTG/IMP DEMO                        
XDTRIFOV EQU    X80                 DEMO IS AN OVERRIDE                         
                                                                                
XDTSHMOD DS    CL1                 SHARE   MODIFIER                             
XDTSHVAL DS    XL4                 SHARE   DEMO VALUE                           
XDTSHFLG DS    XL1                 FLAG FOR SHARE   DEMO                        
XDTSHFOV EQU    X80                 DEMO IS AN OVERRIDE                         
                                                                                
XDTPTMOD DS    CL1                 PUT/TOT MODIFIER                             
XDTPTVAL DS    XL4                 PUT/TOT DEMO VALUE                           
XDTPTFLG DS    XL1                 FLAG FOR PUT/TOT DEMO                        
XDTPTFOV EQU    X80                 DEMO IS AN OVERRIDE                         
                                                                                
XPNDMTBQ EQU   *-XPNDMTBD                                                       
         EJECT                                                                  
*-------------------------- REGETKSRC PARMS --------------------------*         
                                                                                
GKSPARMD DSECT                                                                  
GKSPRSVC DS    CL1                 RATING SERVICE                               
GKSPQLFY DS    CL1                 TRACK QUALIFIER/BK PREFIX                    
GKSPKSRC DS    XL1                 RINVKSRC FOR KEY                             
GKSPBKBT DS    XL1                 BOOKVAL BITS                                 
GKSPBTYP DS    CL1                 BOOK TYPE                                    
GKSPARMX EQU   *                                                                
GKSPARML EQU   GKSPARMX-GKSPARMD                                                
         DS    0XL(L'GKSIPARM-GKSPARML+1)                                       
         DS    0XL(GKSPARML-L'GKSIPARM+1)                                       
         DS    0XL(L'GKSOPARM-GKSPARML+1)                                       
         DS    0XL(GKSPARML-L'GKSOPARM+1)                                       
                                                                                
                                                                                
*----------------------------- DAY TABLE -----------------------------*         
                                                                                
DAYTABD  DSECT                                                                  
DYTFILE  DS    CL1                 FILE (X'00'==>ALL FILES)                     
DYTIDAY  DS    XL1                 INTERNAL DAY                                 
DYTKDAY  DS    XL1                 KEY DAY                                      
DYTNAME  DS    CL3                 NAME OF DAY(S)                               
DYTLEN   EQU   *-DAYTABD                                                        
         EJECT                                                                  
*----------------------------- LIST LINE -----------------------------*         
                                                                                
LLINED   DSECT                                                                  
*                                 ************ ACTION FIELD ***********         
LLACTH   DS    XL8                 HEADER                                       
LLACT    DS    CL4                 DATA                                         
LLACTX   DS    XL8                 EXTENDED FIELD HEADER                        
                                                                                
*                                 *********** DISPLAY FIELD ***********         
LLDISH   DS    XL8                 HEADER                                       
LLDIS    DS    0CL73               DATA                                         
                                                                                
LLDHSRC  DS      0CL1                                                           
LLDDSRC  DS      0CL1                                                           
LLDSRC   DS     CL1                 SOURCE                                      
         DS     XL1                                                             
                                                                                
LLDHFLCD DS      0CL3                                                           
LLDDFILE DS     CL3                 FILE                                        
         ORG    LLDDFILE+1                                                      
LLDDCODE DS     CL2                 CODE                                        
         ORG                                                                    
         DS     XL1                                                             
                                                                                
LLDHBOOK DS      0CL4                                                           
LLDDBOOK DS      0CL10                                                          
LLDBOOK  DS     CL10                BOOK                                        
         DS     XL1                                                             
                                                                                
LLDHSTTN DS      0CL4                                                           
LLDDSTTN DS      0CL5                                                           
LLDSTTN  DS     CL5                 STATION                                     
         DS     XL1                                                             
                                                                                
LLDHTITL DS      0CL5                                                           
LLDDTITL DS      0CL10                                                          
LLDTITL  DS     CL10                PROGRAM TITLE (NAME)                        
         DS     XL1                                                             
                                                                                
LLDHDAY  DS      0CL3                                                           
LLDDDAY  DS      0CL7                                                           
LLDDAY   DS     CL7                 DAY                                         
         DS     XL1                                                             
                                                                                
LLDHSTIM DS      0CL5                                                           
LLDDSTIM DS      0CL5                                                           
LLDSTIM  DS     CL5                 START TIME                                  
         DS     XL1                                                             
                                                                                
LLDHQHRS DS      0CL3                                                           
LLDDQHRS DS      0CL3                                                           
LLDQHRS  DS     CL3                 QUARTER HOURS                               
         DS     XL1                                                             
                                                                                
LLDHWPIN DS      0CL6                                                           
LLDDWPIN DS      0CL6                                                           
LLDWPIN  DS     CL6                 WEEKS/PURE/INVENTORY NUMBER                 
         DS     XL1                                                             
                                                                                
LLDHDRTG DS      0CL3                                                           
LLDDDRTG DS      0CL4                                                           
LLDDRTG  DS     CL4                 DEMO RATINGS                                
         DS     XL1                                                             
                                                                                
LLDHDSHR DS      0CL3                                                           
LLDDDSHR DS      0CL4                                                           
LLDDSHR  DS     CL4                 DEMO SHARES                                 
         DS     XL1                                                             
                                                                                
LLDHDPUT DS      0CL3                                                           
LLDDDPUT DS      0CL4                                                           
LLDDPUT  DS     CL4                 DEMO PUT                                    
                                                                                
         DS    0XL(L'LLDIS-(*-LLDIS)+1)                                         
         DS    0XL((*-LLDIS)-L'LLDIS+1)                                         
*                                                                               
LLINEQ   EQU   *-LLINED                                                         
         DS    0XL(SZLSTLIN-LLINEQ+1)                                           
         DS    0XL(LLINEQ-SZLSTLIN+1)                                           
         EJECT                                                                  
*----------------------------- PFKEY LINE ----------------------------*         
                                                                                
PFLINED  DSECT                                                                  
PFLSCRLL DS    CL(L'RE@10PF)       PF5=Top  6=Bottom  7=Up  8=Down              
         DS    CL8                                                              
PFLSAVE  DS    CL(L'RE@PF10S)      10=Save                                      
                                                                                
         ORG   (PFLINED+L'IROPFLN)-L'RE@PF12R                                   
PFLPF12  DS    CL(L'RE@PF12R)      12=Rtrn OR 12=Next                           
                                                                                
                                                                                
PFLINEX  EQU   *                                                                
PFLINEL  EQU   PFLINEX-PFLINED                                                  
                                                                                
                                                                                
*------------------------ INVENTORY LIST ENTRY -----------------------*         
                                                                                
* This DSECT is adopted from RERMP11.  It can also be found in                  
*  RERMP12 and RERMP30.                                                         
                                                                                
INVLD    DSECT                                                                  
ILREC    DS    0CL10                                                            
ILFLE    DS    CL1                 P=PAV, I=INVENTORY                           
ILTYP    DS    XL1                                                              
ILTIVN   EQU    X80                 INVENTORY NUMBER                            
ILTFDT   EQU    X40                 FIRST IN DAY/TIME EXP.                      
ILTLDT   EQU    X20                 LAST IN DAY/TIME EXP.                       
ILTADD   EQU    X08                 ADD EXPRESSION                              
ILTWOV   EQU    X04                 USER WEIGHTING OVERRIDE                     
ILWT     DS    XL1                 WEIGHT (BINARY)                              
ILDATA   DS    0XL7                                                             
ILTIME   DS     0XL4                TIME                                        
ILSTIM   DS      XL2                 START TIME                                 
ILETIM   DS      XL2                 END TIME                                   
ILDAY    DS     XL1                 DAY                                         
         DS     XL2                 SPARE                                       
         ORG   ILDATA                                                           
ILNUMB   DS     CL4                 NUMBER                                      
ILDATE   DS     CL3                 START DATE (Y/M/D BINARY)                   
INVLQ    EQU   *-INVLD                                                          
***********************************************************************         
         EJECT                                                                  
***********************************************************************         
*========================== IUN RECORD DSECT =========================*         
                                                                                
IUNRECD  DSECT                                                                  
                                                                                
                                                                                
IUNIVS   DS    (IUNNVALS)F        UNIVERSES                                     
                                                                                
                                                                                
IUNOLD   DS    0F                 ORIGINAL (OLD) BOOK VALUES                    
*                                                                               
IOLDRTG  DS    (IUNNVALS)F         RATINGS                                      
         ORG   IOLDRTG+IUNHMDSP                                                 
IUORHOME DS    F                                                                
*                                                                               
         ORG                                                                    
IOLDIMP  DS    (IUNNVALS)F         IMPRESSIONS                                  
*                                                                               
IOLDHPT  DS    (IUNNVALS)F         HUTS/PUTS                                    
         ORG   IOLDHPT+IUNHMDSP                                                 
IUOPHOME DS    F                                                                
*                                                                               
         ORG                                                                    
IOLDTOT  DS    (IUNNVALS)F         TSA TOTALS                                   
         ORG   IOLDTOT+IUNHMDSP                                                 
IUOQHOME DS    F                                                                
*                                                                               
         ORG                                                                    
IUNOLDX  EQU   *                                                                
                                                                                
                                                                                
IUNNEW   DS    0F                 NEW VALUES                                    
*                                                                               
INEWRTG  DS    (IUNNVALS)F         RATINGS                                      
         ORG   INEWRTG+IUNHMDSP                                                 
IUNRHOME DS    F                                                                
*                                                                               
         ORG                                                                    
INEWIMP  DS    (IUNNVALS)F         IMPRESSIONS                                  
*                                                                               
INEWHPT  DS    (IUNNVALS)F         HUTS/PUTS                                    
         ORG   INEWHPT+IUNHMDSP                                                 
IUNPHOME DS    F                                                                
*                                                                               
         ORG                                                                    
INEWTOT  DS    (IUNNVALS)F         TSA TOTALS                                   
         ORG   INEWTOT+IUNHMDSP                                                 
IUNQHOME DS    F                                                                
*                                                                               
         ORG                                                                    
IUNNEWX  EQU   *                                                                
                                                                                
                                                                                
         DS    0CL((IUNOLDX-IUNOLD)-(IUNNEWX-IUNNEW)+1)                         
         DS    0CL((IUNNEWX-IUNNEW)-(IUNOLDX-IUNOLD)+1)                         
                                                                                
                                                                                
IUNOTH   DS    0F                 OTHER VALUES                                  
ISHOMES  DS    F                                                                
ISMETA   DS    F                                                                
ISMETB   DS    F                                                                
*                                                                               
ILUNVS   DS    (IUNNVALS)F         LOONEYVERSES                                 
ILUNVX   EQU   *                                                                
                                                                                
                                                                                
IUNRECL  EQU   *-IUNRECD                                                        
                                                                                
                                                                                
IUNNVALS EQU   32                  # OF IUN VALUES                              
IUNLVALS EQU   IUNNVALS*4          LENGTH OF IUN VALUES                         
IUNHMNDX EQU   20                  INDEX TO HOMES RTGS IN IUN RTGS AREA         
IUNHMDSP EQU   IUNHMNDX*4          DISPL TO HOMES RTGS IN IUN RTGS AREA         
***********************************************************************         
         EJECT                                                                  
***********************************************************************         
*========================== BIG STORAGE AREA =========================*         
                                                                                
BIGAREA  DSECT                                                                  
                                                                                
                                                                                
         DS    0H                  1ST HALF RESERVED FOR INV/TRACKS             
         ORG   BIGAREA+X'2400'                                                  
                                                                                
                                                                                
MLDIRLBL DS    D                   *MLSDIR*                                     
MLSTDIR  DS    (MXLTNTRY)XL(L'LTNTRY)                                           
         DS    XL1                                                              
MLSTDIRX EQU   *                                                                
                                                                                
                                                                                
LSTBLABL DS    D                   *LSTTAB*                                     
LISTTAB  DS    (MXLTNTRY)XL(LISTTABQ)                                           
         DS    XL1                                                              
LISTTABX EQU   *                                                                
                                                                                
                                                                                
INVLLABL DS    D                   *INVLST*                                     
INVLIST  DS    20XL(INVLQ)                                                      
         DS    XL1                                                              
INVLISTX EQU   *                                                                
                                                                                
                                                                                
XPNDLABL DS    D                   *XPNDEM*                                     
XPNDMTAB DS    (MXEXPNDM)XL(XPNDMTBQ)                                           
         DS    XL1                                                              
XPNDMTBX EQU   *                                                                
XPNDMTBL EQU   XPNDMTBX-XPNDMTAB                                                
                                                                                
                                                                                
BIGENDSV EQU   *                   SAVE UP TO HERE INTO TEMPSTR                 
                                                                                
                                                                                
DBLKLABL DS    D                   *DBLOCK*                                     
DBLOCK1  DS    XL(L'DBLOCK)                                                     
         DS    XL14                (RESERVED)                                   
DBLOCK1X DS    0X                                                               
                                                                                
DBXTLABL DS    D                   *DBXTND*                                     
DBXTND1  DS    0XL256                                                           
DBXTRINV DS     XL(DBXINVWL)        C'RINV' (DBXINVWK)                          
DTLAREA  DS     0X                  C'DYTM' (DBXTLD)                            
         DS      XL(DBXTLIST-DBXTLD)                                            
         DS      8XL(L'DBXTLIST)                                                
DTLAREAX EQU    *                                                               
DTLAREAL EQU   DTLAREAX-DTLAREA                                                 
         DS    0XL(L'DBXTND1-(*-DBXTND1))                                       
DBXTND1X DS    0X                                                               
                                                                                
                                                                                
SVDBLABL DS    D                   *SVDBLK*                                     
SVDBLOCK DS    XL(DBLOCK1X-DBLOCK1)                                             
SVDBLCKX DS    0X                                                               
                                                                                
                                                                                
SVLPLABL DS    D                   **SVLP**                                     
SVLP     DS    (LISTPRMX-LISTPARM)XL1                                           
SVLPX    EQU   *                                                                
                                                                                
                                                                                
SVLTLABL DS    D                   *SVLSTB*                                     
SVLSTB   DS    (LISTTABX-LISTTAB)XL1                                            
SVLSTBX  EQU   *                                                                
                                                                                
                                                                                
SVMLLABL DS    D                   *SVMLDR*                                     
SVMLDR   DS    (MLSTDIRX-MLSTDIR)XL1                                            
SVMLDRX  EQU   *                                                                
                                                                                
                                                                                
SVOPLABL DS    D                   *SVOPTS*                                     
SVOPTV   DS    (OPTVALSQ)XL1                                                    
SVOPTVX  EQU   *                                                                
                                                                                
                                                                                
SVLCLABL DS    D                   *SVLTCT*                                     
SVLTCTL  DS    (LSTTBCTQ)XL1                                                    
SVLTCTLX EQU   *                                                                
                                                                                
MYTIALEN EQU   *-BIGAREA                                                        
         DS    0CL((X'4800'-MYTIALEN)+1)                                        
***********************************************************************         
         EJECT                                                                  
***********************************************************************         
*================== RERMP18'S LOCAL WORKING STORAGE ==================*         
                                                                                
RM18WRKD DSECT                                                                  
         DS    D                                                                
         DS    0A                  ADDRESSES OF TABLES/ROUTINES                 
ASRTAB   DS     A                   A(SRTAB)                                    
ADAYTAB  DS     A                   A(DAYTAB)                                   
ACODETAB DS     A                   A(CODETAB)                                  
ATBELCPY DS     A                   A(TABELCPY)                                 
AFPRTTAB DS     A                   A(FPRTTAB)                                  
ARSVCTAB DS     A                   A(RSVCTAB)                                  
AUPGKWTB DS     A                   A(UPGKYWTB)                                 
AOPTTAB  DS     A                   A(OPTTABLE)                                 
                                                                                
*                                                                               
         DS    0F                                                               
BASEUNIV DS     (IUNNVALS)F         BASE UNIVERSES FOR NORMALIZING              
BASEUNVL EQU    *-BASEUNIV                                                      
RM18WRKX EQU   *                                                                
RM18WRKL EQU   RM18WRKX-RM18WRKD                                                
***********************************************************************         
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'070RERMP10Y  09/20/00'                                      
         END                                                                    
