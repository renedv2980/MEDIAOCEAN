*          DATA SET SPREPBU02A AT LEVEL 063 AS OF 04/11/07                      
*PHASE SPBU02A                                                                  
*INCLUDE COVAIL                                                                 
*INCLUDE DDUCOM                                                                 
*INCLUDE GETUSER                                                                
*INCLUDE NETCOM                                                                 
*INCLUDE NETNET                                                                 
*INCLUDE PRTREC                                                                 
*INCLUDE SPFMTINO                                                               
*INCLUDE NETBLRDR                                                               
*INCLUDE BINSR31                                                                
         TITLE 'SPREPBU02 - NETPAK BILLING'                                     
SPBU02   CSECT                                                                  
         SPACE 2                                                                
***********************************************************************         
*    QOPT1 - REQUESTED COST TYPE                                                
*    QOPT2 - BILL TYPES (4-7)                                                   
*    QOPT3 - Y=SUPPRESS NETPAK COMMENTS                                         
*            O=USE OLD (SPOTPAK COMMENTS)                                       
*    QOPT4 - DAYPART FILTER                                                     
*    QOPT5 - MEDIA TYPE FILTER                                                  
*    QOPT5+1  - TYPE OF BILLING OF TRUE SEPARATE COMMISSION OPT (SCB)           
*               C=COMMISSION, N=NET, R=REG                                      
***********************************************************************         
         SPACE 2                                                                
         PRINT NOGEN                                                            
         NMOD1 0,SPBU02,R9                                                      
         SPACE 2                                                                
         B     PROC                                                             
PATCH    DC    32X'00'                                                          
*              BYTE 1  - X'80'=TRACE OUTPUT RECORDS                             
*                        X'04'=EDI OUTPUT TRACE                                 
*                        X'40'=TRACE UNIT RECORDS                               
*                        X'20'=TRACE NETPTAB (IN NETNU)                         
*                        X'10'=PRINT USER PROFILES                              
*                        X'01'=TRACE GETNUM READS                               
*                                                                               
TRCE     DC    C'N'      PATCH TO Y FOR SORT TRACE (IN AND OUT)                 
         SPACE 2                                                                
PROC     DS    0H                                                               
         L     RA,0(R1)                                                         
         LR    R8,RA                                                            
         AHI   R8,4096                                                          
         USING SPWORKD,RA,R8                                                    
         LA    RC,SPACEND                                                       
         USING BILWRKD,RC                                                       
*                                  SAVE BASE REGS FOR HEADHOOK                  
         L     RF,=A(SAVER8)                                                    
         ST    R8,0(RF)                                                         
         L     RF,=A(SAVERA)                                                    
         ST    RA,0(RF)                                                         
*                                                                               
         CLI   MODE,PROCBUY                                                     
         BH    *+8                                                              
         MVI   DONESW,C'N'         RESET ON PROCBUY AND 'FRSTS'                 
         CLI   MODE,RUNFRST                                                     
         BE    RUNF                                                             
         CLI   MODE,REQFRST                                                     
         BE    REQF                                                             
         CLI   MODE,CLTFRST                                                     
         BE    CLTF                                                             
         CLI   MODE,PGR1FRST                                                    
         BE    PGR1F                                                            
         CLI   MODE,PRDFRST                                                     
         BE    PRDF                                                             
         CLI   MODE,ESTFRST                                                     
         BE    ESTF                                                             
         CLI   MODE,MGR1FRST                                                    
         BE    MGR1F                                                            
         CLI   MODE,MGR1LAST                                                    
         BE    MGR1L                                                            
         CLI   MODE,MGR2LAST                                                    
         BE    MGR2L                                                            
         CLI   MODE,MGR3LAST                                                    
         BE    MGR3L                                                            
         CLI   MODE,MKTLAST                                                     
         BE    MKTL                                                             
         CLI   MODE,CLTLAST                                                     
         BE    CLTL                                                             
         CLI   MODE,REQLAST                                                     
         BE    REQL                                                             
         CLI   MODE,RUNLAST                                                     
         BE    RUNL                                                             
*                                                                               
         B     XIT                                                              
*                                                                               
         ANSR                                                                   
         EJECT                                                                  
*        RUNFRST                                                                
         SPACE 2                                                                
RUNF     DS    0H                                                               
*                                  PUT ADCONS IN COMMON STORAGE                 
         MVC   APATCH,=A(PATCH)                                                 
         MVC   ABUFFC,=A(BUFFALOC)                                              
         MVC   BINSR31,=V(BINSRCH) 31 BIT MODE                                  
         XC    ABILLEDI,ABILLEDI                                                
         L     RF,ADCONLST                                                      
         USING SPADCONS,RF                                                      
         MVC   ASPGTBFR,VSPGTBFR                                                
         MVC   ATSAROFF,TSAROFF                                                 
         DROP  RF                                                               
*                                                                               
         MVI   FFS,X'FF'                                                        
         MVC   FFS+1(L'FFS-1),FFS                                               
         MVI   DASHES,C'-'                                                      
         MVC   DASHES+1(L'DASHES-1),DASHES                                      
         MVC   XXMKT,=H'9998'      SPECIAL BILLING MARKET - 9998                
         MVC   XXSTA,=X'D6B5A4'    SPECIAL STATION - ZZZZ                       
*                                                                               
         L     RE,=A(LEVTOTS)      CLEAR LEVEL TOTS, ONE ACCUM @ A TIME         
         LHI   RF,TOTSIZE-BFORML   BEGIN OF BDFORM ,BINARY DATA                 
         AR    RF,RE                                                            
         LA    R0,MAXLEVS          BCT COUNTER                                  
*                                                                               
RUNF10   ZAP   0(ACCUMLQ,RE),=P'0'                                              
         LA    RE,ACCUMLQ(RE)      NEXT ACCUMULATOR                             
         CR    RE,RF               DONE WITH THIS LEVEL'S ACCUMULATORS?         
         BL    RUNF10                                                           
         CR    RE,RF               AT THIS POINT RE SHOULD POINT                
         BE    *+6                 PAST LAST ACCUMULATOR (FOR TEST)             
         DC    H'0'                                                             
         XC    0(BFORML,RE),0(RE)  GOT TO BINARY FORMULA DATA                   
         LA    RE,BFORML(RE)       POINT TO NEXT LEVEL'S ACCUMULATORS           
         LHI   RF,TOTSIZE-BFORML   BEGIN OF NEXT LEVEL BINARY DATA              
         AR    RF,RE                                                            
         BCT   R0,RUNF10           CLEAR NEXT LEVEL'S ACCUMULATORS              
*                                                                               
         MVI   RQMGOPT,C'Y'        MAKEGOODS TO BE IN MISSED MONTH              
*                                  (ALSO CONTROLLED BY CLIENT OPTION)           
         L     RF,=A(LINTAB)                                                    
         LHI   R0,LINTABN                                                       
         MVC   0(132,RF),SPACES                                                 
         LA    RF,132(RF)                                                       
         BCT   R0,*-10                                                          
         MVC   ANXTLIN,=A(LINTAB)                                               
         MVI   PRSW,C'N'                                                        
*                                                                               
         SR    R0,R0               SET BINSRCH PARS FOR BHOLDTAB                
         L     R1,=A(BHOLDTAB)                                                  
         SR    R2,R2                                                            
         LHI   R3,BHOLDTRL                                                      
         LHI   R4,BHOLDTKL                                                      
         LHI   R5,BHLTBN                                                        
         STM   R0,R5,BHLPARS                                                    
*                                  GET STORAGE FOR INVTAB                       
         L     R0,=A(INVTABRL*INVTBN)                                           
         GETMAIN RU,LV=(0),LOC=(ANY,ANY)                                        
         LTR   R1,R1                                                            
         BNZ   *+6                                                              
         DC    H'0'                                                             
         ST    R1,AINVTAB                                                       
*                                  GET STORAGE FOR PKGTAB                       
         L     R0,=A(PKGTABLQ*PKGTBN)                                           
         GETMAIN RU,LV=(0),LOC=(ANY,ANY)                                        
         LTR   R1,R1                                                            
         BNZ   *+6                                                              
         DC    H'0'                                                             
         ST    R1,APKGTAB                                                       
*                                  GET STORAGE FOR PEPTAB                       
         L     R0,=A(PEPTABRL*PEPTBN+8)                                         
         GOTO1 =V(COVAIL),DMCB,C'GET',(R0),(R0)                                 
         OC    4(4,R1),4(R1)                                                    
         BNZ   *+6                                                              
         DC    H'0'                                                             
         L     RF,4(R1)            START OF CORE                                
         LR    RE,RF                                                            
         A     RE,8(R1)            PLUS LENGTH                                  
*                                                                               
         L     R6,VMASTC           SET END AS NEW DUMP LIMIT                    
         USING MASTD,R6                                                         
*                                                                               
         CLI   MCRECOVR,C'W'                                                    
         BNE   *+8                                                              
         MVI   UPDTSOON,C'Y'       UPDATIVE SOON FLAG                           
*                                                                               
         ST    RE,MCDMPEND                                                      
         MVC   0(8,RF),=C'*PEPTAB*'                                             
         LA    RF,8(RF)                                                         
         ST    RF,APEPTAB                                                       
*                                  SET BINSRCH PARMS FOR PEPTAB                 
         SR    R0,R0                                                            
         L     R1,APEPTAB                                                       
         SR    R2,R2                                                            
         LHI   R3,PEPTABRL                                                      
         LHI   R4,PEPTABKL                                                      
         LHI   R5,PEPTBN                                                        
         STM   R0,R5,PEPPARS                                                    
*                                  SET BINSRCH PARMS FOR TRDTAB                 
         SR    R0,R0                                                            
         L     R1,=A(TRADETB)                                                   
         SR    R2,R2                                                            
         LHI   R3,TRDTABRL                                                      
         LHI   R4,TRDTABKL                                                      
         LHI   R5,TRADEMAX                                                      
         STM   R0,R5,TRDPARS                                                    
*                                  SET BINSR31 PARMS FOR INVTAB                 
         LHI   R3,INVTABRL                                                      
         LHI   R4,INVTABKL                                                      
         L     R5,=A(INVTBN)                                                    
         STM   R2,R5,INVPARS+8                                                  
*                                                                               
         SR    R0,R0               SET CLIENT LIST BINSRCH PARMS                
         L     R1,=A(CLTTAB)                                                    
         SR    R2,R2                                                            
         LHI   R3,3                                                             
         LHI   R4,3                                                             
         LHI   R5,CLTBMAX                                                       
         STM   R0,R5,CLTPARS                                                    
*                                  BINSRCH PARMS FOR PROD SPLIT TABLE           
         L     R1,=A(SPLTAB)                                                    
         LHI   R3,SPLTABRL                                                      
         LHI   R4,SPLTKYLQ         KEY LENGTH (PRODUCT/ESTIMATE)                
         LHI   R5,SPLTPMAX                                                      
         STM   R0,R5,SPLPARS                                                    
*                                  SET BINSR31 PARMS FOR PKGTAB                 
         LHI   R3,PKGTABLQ         LENGTH OF ENTRY                              
         LHI   R4,PKGKEYLQ         KEY LENGTH                                   
         LHI   R5,PKGTBN                                                        
         STM   R2,R5,PKGPARS+8                                                  
*                                  SET BINSRCH PARMS FOR PEFFTAB                
         L     R1,=A(PEFFTAB)                                                   
         LHI   R3,PEFFTLN          LENGTH OF ENTRY                              
         LHI   R4,PEFFKLN          KEY LENGTH                                   
         LHI   R5,PEFFMAX                                                       
         STM   R0,R5,PEFFPARS                                                   
*                                                                               
         XC    NBUFFADR,NBUFFADR                                                
         XC    NBUFFLN,NBUFFLN                                                  
*                                                                               
         L     R3,MCUTL            A(UTL)                                       
         USING UTLD,R3                                                          
         MVC   TSYS,MCS2SENO       SWITCH TO SPOT SYSTEM                        
         OC    TSYS,TSYS           IF 0, SKIP OPENING FILES                     
         BZ    RUNF50                                                           
         L     R4,ADBUY            USE AS WORK AREA FOR OPEN                    
         GOTO1 DATAMGR,DMCB,=C'OPEN',=C'SPOT',=C'NSTAFILEX',(R4)                
RUNF50   MVC   TSYS,MCIDSENO       SWITCH BACK TO NET SYSTEM                    
         DROP  R3                                                               
         DROP  R6                                                               
*                                                                               
         GOTO1 DYNALLOC,DMCB,(C'A',=C'OUT     ')                                
         CLI   DMCB+4,0                                                         
         BE    RUNFX                                                            
         MVI   OUTDDFLG,C'Y'       "OUT" DD STATEMENT IS PRESENT                
         OPEN  (OUT,OUTPUT)        OPEN BILL HEADER BUFFER FILE                 
*                                                                               
RUNFX    DS    0H                                                               
         J     XIT                                                              
*                                                                               
*        REQFRST                                                                
*                                                                               
REQF     DS    0H                                                               
*                                                                               
         CLI   INV#ERR,C'Y'        DID ANY PRIOR REQUEST CAUSE...               
         BNE   *+12                ...A GETNUM ERROR?                           
         MVI   ERR,INVNERR         YES: SKIP ALL SUBSEQUENT REQUESTS            
         BRAS  RE,ERRPROC                                                       
*                                                                               
         MVI   PROOFSW,C'N'                                                     
         CLC   QPROG,=C'DU'        BILLING PROOF RUN                            
         BNE   *+8                                                              
         MVI   PROOFSW,C'Y'                                                     
*                                                                               
         CLI   QINVREG,C'R'        INVOICE REGISTER REQUESTED?                  
         BNE   *+8                                                              
         MVI   DOINVREG,C'Y'       YES                                          
*                                                                               
         MVI   NS2SW,C'N'                                                       
         CLC   =C'MC',QAGY         FOR MCCANN CLT = NS2 & NHC                   
         BNE   REQF03              PRINT UP TO 8 EST UCOMS                      
         CLC   =C'NS2',QCLT                                                     
         BE    *+14                                                             
         CLC   =C'NHC',QCLT                                                     
         BNE   *+8                                                              
*                                                                               
         MVI   NS2SW,C'Y'                                                       
*                                                                               
         MVI   WMTSW,C'N'                                                       
*                                                                               
REQF03   MVI   MM3SW,C'N'          DU MM3 SPECIAL FISCAL CALENDAR               
         CLC   =C'DU',QAGY         SPECIAL FISCAL CALENDAR                      
         BNE   REQF03K             (ALSO SAME FOR MMM AND MMH)                  
         CLC   =C'MM3',QCLT                                                     
         BE    REQF03G                                                          
         CLC   =C'MMM',QCLT                                                     
         BE    REQF03G                                                          
         CLC   =C'MMH',QCLT                                                     
         BNE   *+8                                                              
REQF03G  MVI   MM3SW,C'Y'                                                       
*                                                                               
REQF03K  MVI   PGSW2,C'N'                                                       
         CLC   =C'DU',QAGY         SPECIAL FISCAL CALENDAR                      
         BNE   REQF03K4                                                         
         CLC   =C'PG1',QCLT                                                     
         BE    REQF03K7                                                         
         CLC   =C'PG2',QCLT                                                     
         BE    REQF03K7                                                         
         CLC   =C'PG3',QCLT                                                     
         BE    REQF03K7                                                         
         CLC   =C'PG4',QCLT                                                     
         BE    REQF03K7                                                         
         CLC   =C'PG5',QCLT                                                     
         BE    REQF03K7                                                         
         CLC   =C'PGG',QCLT                                                     
         BE    REQF03K7                                                         
*                                                                               
REQF03K4 CLC   =C'H9',QAGY                                                      
         BNE   REQF04                                                           
         CLC   =C'HPG',QCLT                                                     
         BE    REQF03K7                                                         
         CLC   =C'HP1',QCLT                                                     
         BE    REQF03K7                                                         
         CLC   =C'PGB',QCLT                                                     
         BE    REQF03K7                                                         
         CLC   =C'PGP',QCLT                                                     
         BNE   REQF04                                                           
*                                                                               
REQF03K7 MVI   PGSW2,C'Y'                                                       
*                                                                               
REQF04   MVI   PGSW,C'N'                                                        
         CLC   =C'H9',QAGY          FOR H9 PGB,HPG/1 & DU PG1,PG2,PG4           
         BNE   REQF04F              ??? NOT SURE WHY NOT PG3???                 
*                                                                               
         CLC   =C'PGB',QCLT         PRINT UDEF NEXT TO PRD NAME                 
         BE    REQF05                                                           
         CLC   =C'HPG',QCLT                                                     
         BE    REQF05                                                           
         CLC   =C'HP1',QCLT                                                     
         BE    REQF05                                                           
*                                                                               
REQF04F  CLC   =C'DU',QAGY                                                      
         BNE   REQF06                                                           
*                                                                               
         CLC   =C'PG1',QCLT                                                     
         BE    REQF05                                                           
         CLC   =C'PG2',QCLT                                                     
         BE    REQF05                                                           
         CLC   =C'PG4',QCLT                                                     
         BE    REQF05                                                           
         CLC   =C'PG5',QCLT                                                     
         BE    REQF05                                                           
         CLC   =C'PGG',QCLT                                                     
         BE    REQF05                                                           
*                                                                               
         CLC   =C'WMT',QCLT                                                     
         BNE   REQF06                                                           
         MVI   WMTSW,C'Y'                                                       
         B     REQF06                                                           
                                                                                
*                                                                               
REQF05   MVI   PGSW,C'Y'                                                        
*                                                                               
REQF06   MVI   MSSW,C'N'           CLEAR                                        
         CLC   =C'TH',QAGY         FOR ZENY CLT SPP                             
         BNE   *+14                                                             
         CLC   =C'SPP',QCLT                                                     
         BE    REQF06D                                                          
         CLC   =C'H7',QAGY         FOR MINDSHARE CLT = BMS, NV, KK              
         BNE   REQF06F             PRINT EST UDEFS                              
         CLC   =C'NV ',QCLT                                                     
         BE    REQF06D                                                          
         CLC   =C'KK ',QCLT                                                     
         BE    REQF06D                                                          
         CLC   =C'BMS',QCLT                                                     
         BNE   *+8                                                              
REQF06D  MVI   MSSW,C'Y'                                                        
*                                                                               
REQF06F  MVI   LORSW,C'N'          CLEAR                                        
         CLC   =C'MC',QAGY         FOR MCCANN'S L'OREAL CLIENTS                 
         BNE   REQF07              PUT S-MED ELEMS FOR MANALS                   
         CLC   =C'COS',QCLT                                                     
         BE    *+14                                                             
         CLC   =C'CSH',QCLT                                                     
         BNE   *+8                                                              
         MVI   LORSW,C'Y'                                                       
*                                                                               
REQF07   MVI   CORPOPT,C' '        CLEAR                                        
         CLC   QCORPRD,SPACES      DOING CORPORATE PRD OVERRIDE?                
         BNH   *+8                                                              
         MVI   CORPOPT,C'Y'                                                     
         CLC   QPRD,=C'POL'        POL => ALL                                   
         BNE   *+10                                                             
         MVC   QPRD,=C'ALL'                                                     
         XC    SAVPRD,SAVPRD                                                    
         XC    SAVPRDC,SAVPRDC                                                  
         XC    SAVPGR,SAVPGR                                                    
         MVC   FEEDNAME,SPACES                                                  
         XC    PEPTABN,PEPTABN     CLEAR PEPTAB                                 
         XC    SPLPARSN,SPLPARSN   CLEAR SPLIT TABLE                            
         XC    INVTABN,INVTABN     CLEAR INVOICE TABLE                          
         MVC   SVQSTART,QSTART     SAVE QSTART/END                              
         MVC   SVQEND,QEND                                                      
         MVC   PAGE,=H'1'                                                       
         MVI   FCRDBUYS,C'Y'       ACTIVATE READING OF BUYS                     
         MVI   FCRDGOAL,C'B'       SPONSOR: READ BILLS FOR MKTLIST              
**DEIS** MVI   RQESTTST,C'Y'       ACTIVATE ESTTEST MODE                        
*                                                                               
         MVI   ACTSW,C'N'                                                       
         MVI   ONENTRY,C'N'                                                     
         L     RF,=A(MOSLIST)                                                   
         MVI   0(RF),X'FF'         CLEAR MOS LIST                               
*                                                                               
         ZAP   NBTOTG,=P'0'        CLEAR REQUEST CHECKING TOTALS                
         ZAP   NBTOTN,=P'0'                                                     
*        ZAP   NBTOTG2,=P'0'                                                    
         ZAP   OBTOTG,=P'0'                                                     
         ZAP   OBTOTN,=P'0'                                                     
         ZAP   OBTOTG2,=P'0'                                                    
         ZAP   DBTOTG,=P'0'                                                     
         ZAP   DBTOTN,=P'0'                                                     
         ZAP   DBTOTG2,=P'0'                                                    
         ZAP   UBTOTG,=P'0'                                                     
         ZAP   UBTOTN,=P'0'                                                     
         ZAP   UBTOTG2,=P'0'                                                    
*                                                                               
         MVC   SORTTRCE,TRCE                                                    
*                                                                               
         L     RE,=A(CTYPTAB)      CLEAR CHARGE TYPE TABLE                      
         LHI   RF,CTYPTMAX*CTYPTBL                                              
         XCEF                                                                   
         L     R1,=A(CTYPTAB)      INIT 1ST ROW TO PACKED                       
         MVI   0(R1),X'FF'                                                      
         LA    R1,CTYPBRK(R1)      POINT TO $$                                  
         LA    RF,ROWTL/ACCUMLQ    # IF ORDERED AND BILLED $$                   
*                                                                               
REQF08   ZAP   0(ACCUMLQ,R1),=P'0' ZAP $$ FIELDS                                
         LA    R1,ACCUMLQ(R1)      NEXT FIELD                                   
         BCT   RF,REQF08                                                        
*                                                                               
         MVI   FCRDBUYS,C'N'       NO SPONSOR BUY READ                          
         MVI   FCRDGOAL,C'N'       OR BILL READ                                 
*                                                                               
         MVC   TYPE,QOPT2          BILLING TYPE IS QOPT2                        
         CLI   TYPE,C' '                                                        
         BNE   *+8                                                              
         MVI   TYPE,C'4'                                                        
*                                                                               
         MVC   DPTFILT,QOPT4       DAYPART FILTER                               
         MVC   MEDFILT,QOPT5       MEDIA FILTER                                 
*                                  (N=NET,C=CABLE,S=SYND,ETC)                   
*                                  **NOTE - DAYPART AND MEDIA FILTERS**         
*                                   TO SUPPORT AN 'ALL SEPARATELY'              
*                                   MODE WOULD REQUIRE PUTTING                  
*                                   THESE FIELDS IN THE VARIOUS                 
*                                   LEVEL TABLES. ALSO WOBILL WOULD             
*                                   HAVE TO SET BLDPT AND BLMED                 
*                                   DIFFERENTLY                                 
*                                                                               
         MVC   SAVTRACE,RCTRACE                                                 
*                                  STANDARDIZE QEST (ALL + BLANK = NO)          
         CLC   QEST,=C'ALL'                                                     
         BE    *+12                                                             
         CLI   QEST,C' '                                                        
         BNE   *+10                                                             
         MVC   QEST,=C'NO '                                                     
*                                  SET VALUES FOR RUN-DATE FILTERING            
         ZIC   R1,TODAYB                                                        
         SR    R0,R0                                                            
         D     R0,=F'10'                                                        
         M     R0,=F'10'                                                        
         STC   R1,DECADE           80,90,00,ETC.                                
         MVC   YEARDIG,TODAY+1     GET YEAR WITHIN DECADE                       
         NI    YEARDIG,X'FF'-X'F0' ISOLATE YEAR DIGIT                           
*                                                                               
         J     XIT                                                              
         SPACE 3                                                                
*        CLTFRST                                                                
CLTF     DS    0H                                                               
*                                                                               
         BRAS  RE,CFIRST                                                        
         J     XIT                                                              
         SPACE 2                                                                
PGR1F    DS    0H                                                               
         OC    BRKTAB,BRKTAB       BUILT ALREADY?                               
         BNZ   PGR1FX                                                           
         BRAS  RE,BLDTAB           BUILD KEY TABLE NOW                          
*                                                                               
PGR1FX   J     XIT                                                              
         SPACE 2                                                                
*        PRDFRST                                                                
PRDF     DS    0H                                                               
*                                                                               
         L     R2,ADPRD                                                         
         USING PRDHDR,R2                                                        
*                                  SET BILL FORMULA EFFECTIVE DATE              
         XC    EFFDTE,EFFDTE                                                    
         XC    PRDFORM,PRDFORM     CLEAR PRODUCT FORMULA                        
         XC    ESTFORM,ESTFORM     CLEAR ESTIMATE FORMULA                       
         CLI   BFROPT,C'N'         DONE IF DOING NEW BFR'S                      
         BNE   PRDF3               (IGNORE OLD)                                 
         OC    PBILLBAS(5),PBILLBAS                                             
         BNZ   *+14                                                             
         MVC   EFFDTE,AAABILDT                                                  
         B     PRDF3                                                            
         MVC   EFFDTE,PBILLDT      EFFECTIVE Y/M OF SERVICE                     
         MVC   PRDFORM,PBILLBAS    HOLD FORMULA                                 
*                                                                               
PRDF3    DS    0H                                                               
         LA    R3,WORK             ADD TO PEFFTAB                               
         XC    WORK(PEFFTLN),WORK                                               
         USING PEFFTBD,R3                                                       
         MVC   PEFFPRD,PRD                                                      
         MVC   PEFFEFD,EFFDTE                                                   
         MVI   PEFFFLG,0                                                        
         TM    POPT1,POPT1_NOBILL                                               
         BZ    *+8                                                              
         OI    PEFFFLG,PEFFNBQ     DON'T BILL THIS PRODUCT                      
         GOTO1 BINSRCH,PEFFPARS,(1,PEFFTBD)                                     
         SR    RF,RF                                                            
         ICM   RF,7,0(R1)                                                       
         BNZ   *+6                                                              
         DC    H'0'                PEFFTAB FULL                                 
         DROP  R3                                                               
*                                                                               
         CLI   PREVSW,C'P'         IF PREVIOUS ONLY                             
         BE    *+14                                                             
         CP    MANGRS,=P'0'        OR MANUAL BILL                               
         BE    *+8                                                              
         MVI   FCRDBUYS,C'N'       SET NO TO READ BUYS                          
         J     XIT                                                              
         DROP  R2                                                               
         SPACE 2                                                                
*        ESTFRST                                                                
ESTF     DS    0H                                                               
*              SET COST2 OPTION                                                 
*              NOTE- SET AGAIN AT FEST IN 'C' ASSEMBLY                          
*                                                                               
         L     R2,ADEST            ESTIMATE HEADER                              
         USING ESTHDR,R2                                                        
*                                                                               
         CLI   ETYPE,C'S'          DON'T BILL STEWARDSHIP ESTIMATES             
         BE    *+12                                                             
         CLI   ETYPE,C'B'          DON'T BILL BARTER ESTIMATES                  
         BNE   ESTF5               WILL ONLY WORK IN CASE OF SINGLE EST         
*                                  FOR ALL EST WILL SET MASK FOR NETIO          
*                                  IN ESTMASK                                   
         CLI   ESTQ,C'1'           IF SINGLE EST REQ...                         
         BNE   *+12                                                             
         MVI   ERR,ESTERR          ...GENERATE ERROR MESSAGE                    
         BRAS  RE,ERRPROC                                                       
*                                                                               
         MVI   MODE,ESTLAST                                                     
         J     XIT                                                              
*                                                                               
ESTF5    MVI   COST2SW,C'N'                                                     
         CLI   COST2CSW,C'Y'       IF COST2 OPTION AT CLIENT LEVEL              
         BNE   *+16                                                             
         TM    ECOST2,X'80'        COST2 ACTIVE?                                
         BNZ   *+8                                                              
         MVI   COST2SW,C'Y'                                                     
*                                                                               
         MVC   ESTFORM,EBILLBAS    HOLD FORMULA                                 
         CLI   ESTQ,C'1'           SINGLE ESTIMATE REQUEST?                     
         BNE   ESTF10              NO                                           
*                                                                               
         CLI   SCBOPT,C'Y'         SEPARATE COMMISSION BILLING OPTION?          
         BNE   ESTF10                                                           
         CLI   PROFB2B+1,0                                                      
         BE    ESTF10                                                           
         ZIC   RF,PROFB2B+1        FILTER POSITION                              
         LA    RF,EPROF-1(RF)                                                   
*                                                                               
         CLI   SCBNCSW,C'R'        FOR REGULAR ESTIMATE RUNS (R)                
         BNE   *+18                                                             
         CLC   0(1,RF),PROFB2B+2   IS VALUE EQUAL                               
         BE    ESTF10              YES, OK                                      
         B     *+14                NO, REJECT                                   
*                                                                               
*                                  SEPARATE COMMISSION RUNS (S OR C)            
         CLC   0(1,RF),PROFB2B+2   IS VALUE EQUAL                               
         BNE   ESTF10              NO, OK - ELSE REJECT                         
*                                                                               
         MVI   ERR,ESTERR                                                       
         BRAS  RE,ERRPROC                                                       
*                                                                               
ESTF10   DS    0H                                                               
         J     XIT                                                              
         DROP  R2                                                               
         SPACE 2                                                                
*        MGR1FRST                                                               
MGR1F    DS    0H                                                               
         OC    BRKTAB,BRKTAB       HAVE BUILT KEY TABLE?                        
         BNZ   *+8                                                              
         BRAS  RE,BLDTAB           IF NOT - DO IT NOW                           
*                                                                               
         J     XIT                                                              
         EJECT                                                                  
*        MGR1LAST                                                               
MGR1L    DS    0H                                                               
         L     R3,AMGR1BRK                                                      
         B     MGRXL                                                            
         SPACE 2                                                                
*        MGR2LAST                                                               
MGR2L    DS    0H                                                               
         L     R3,AMGR2BRK                                                      
         B     MGRXL                                                            
         SPACE 2                                                                
*        MGR3LAST                                                               
MGR3L    DS    0H                                                               
         L     R3,AMGR3BRK                                                      
         B     MGRXL                                                            
         SPACE 2                                                                
MGRXL    DS    0H                                                               
         LTR   R3,R3                                                            
         JZ    XIT                 LEVEL NOT USED                               
         CLI   MGRBKTS,C'Y'        IF MGR BUCKETS                               
         JE    XIT                 DON'T DO 1 MGR AT A TIME                     
         C     R3,AINVBRK                                                       
         JH    XIT                 LEVEL 'BELOW' INVOICE BREAK                  
         CLC   APRDBRK,AINVBRK                                                  
         JH    XIT                 PRODUCT 'BELOW' INVOICE BREAK                
         MVC   KPRD,BPRD                                                        
         MVC   KPRDC,PRD                                                        
         B     DOBILLS                                                          
         SPACE 2                                                                
*        MKTLAST                                                                
MKTL     DS    0H                                                               
         CLC   AMKTBRK,AINVBRK                                                  
         JH    XIT                 LEVEL 'BELOW' INVOICE BREAK                  
         CLC   APRDBRK,AINVBRK                                                  
         JH    XIT                                                              
         MVC   KPRD,BPRD                                                        
         MVC   KPRDC,PRD                                                        
         B     DOBILLS                                                          
         EJECT                                                                  
*        CLIENT LAST                                                            
         SPACE 2                                                                
CLTL     DS    0H                                                               
         MVI   KPRD,0              SET TO DO ALL PRODUCTS                       
         XC    KPRDC,KPRDC                                                      
         CLI   PRDQ,C'A'                                                        
         BE    *+16                                                             
         MVC   KPRD,BPRD           OR ONE PRODUCT                               
         MVC   KPRDC,PRD                                                        
*                                                                               
DOBILLS  DS    0H                                                               
         CLI   DONESW,C'D'                                                      
         BE    CLTL2                                                            
         MVI   DONESW,C'D'                                                      
*                                                                               
         MVI   NETNUMOD,C'R'       SET FOR READ                                 
         GOTO1 =A(NETNU),DMCB,0                                                 
         BRAS  RE,RNBILL           MUST LOOK FOR MANUALS                        
*                                                                               
         L     RF,ABUFFC                                                        
         ICM   RF,15,BUFFSOFA-BUFFALOD(RF)                                      
         BZ    *+8                 NO DATA                                      
         BRAS  RE,RDBUFF                                                        
*                                                                               
         GOTO1 BUFFALO,DMCB,=C'RESET',ABUFFC                                    
         OC    NBUFFADR,NBUFFADR   MAY NOT HAVE DONE                            
         BZ    CLTL2               PREVIOUS COVAIL                              
         GOTO1 =V(COVAIL),DMCB,C'RESB',NBUFFADR,NBUFFLN,ABUFFC                  
*                                                                               
CLTL2    DS    0H                                                               
         CLI   MODE,CLTLAST                                                     
         JNE   XIT                                                              
*                                                                               
         CLI   AORLOPT,C'C'        AOR RECAP AT CLIENT LEVEL?                   
         BNE   *+12                NO                                           
         MVI   AORLCTL,C'P'        SET TO PRINT AOR RECAP                       
         BRAS  RE,AORINV                                                        
*                                                                               
         MVI   QPGR,C' '           CLEAR SO CLT=ALL REQUESTS WILL BE OK         
*                                                                               
         CLI   PROFB1S+3,C'Y'      USING NEW UNIT BILLING REC?                  
         BE    CLTL3               YES: CAN'T EXAMINE OLD UNIT BILLING          
*                                                                               
*                                  TEST DISCREPANT TOTALS                       
*                                   BETWEEN UNIT DETAILS AND HEADERS            
         ZAP   MYPACKED,DBTOTG     SPOT DETAILS  **GROSS**                      
         AP    MYPACKED,NBTOTG     MANUALS                                      
         CP    MYPACKED,OBTOTG                                                  
         BNE   CLTL2C                                                           
         ZAP   DOUBLE,DBTOTN       SPOT DETAILS  **NET**                        
         AP    DOUBLE,NBTOTN       MANUALS                                      
         CP    DOUBLE,OBTOTN                                                    
         BNE   CLTL2C                                                           
         CLI   COST2SW,C'Y'        IS IT COS2 BILL ?                            
         BNE   CLTL3               NO, DONE                                     
         CP    DBTOTG2,OBTOTG2     OTHERWISE COMPARE COS2 $$                    
         BE    CLTL3                                                            
*                                                                               
CLTL2C   MVC   P(8),=C'HEADERS:'                                                
         MVC   P+10(6),=C'GROSS='                                               
         EDIT  OBTOTG,(17,P+16),2,CR=YES                                        
         MVC   P+40(4),=C'NET='                                                 
         EDIT  OBTOTN,(17,P+44),2,CR=YES                                        
         CLI   COST2SW,C'Y'        IS IT COS2 BILL ?                            
         BNE   CLTL2F              NO, SKIP                                     
         MVC   P+70(7),=C'GROSS2=' ELSE PUT OUT COS2 TOTALS                     
         EDIT  OBTOTG2,(17,P+77),2,CR=YES                                       
*                                                                               
CLTL2F   MVC   P2(6),=C'UNITS:'                                                 
         MVC   P2+10(6),=C'GROSS='                                              
         EDIT  MYPACKED,(17,P2+16),2,CR=YES                                     
         MVC   P2+40(4),=C'NET='                                                
         EDIT  (P8,DOUBLE),(17,P2+44),2,CR=YES                                  
         CLI   COST2SW,C'Y'        IS IT COS2 BILL ?                            
         BNE   CLT2DIE             NO, SKIP                                     
         MVC   P2+70(7),=C'GROSS2='                                             
         EDIT  DBTOTG2,(17,P2+77),2,CR=YES                                      
CLT2DIE  BRAS  RE,PRNT                                                          
         DC    H'0'                                                             
*                                                                               
*                                  TEST DISCREPANT TOTALS                       
*                                   BETWEEN UBILL RECS AND BILL HEADERS         
CLTL3    ZAP   MYPACKED,UBTOTG     UNIT BILLING DETAILS GROSS                   
         AP    MYPACKED,NBTOTG     MANUALS                                      
         CP    MYPACKED,OBTOTG                                                  
         BNE   CLTL3C                                                           
         ZAP   DOUBLE,UBTOTN       UNIT BILLING DETAILS NET                     
         AP    DOUBLE,NBTOTN       MANUALS                                      
         CP    DOUBLE,OBTOTN                                                    
         BNE   CLTL3C                                                           
         CLI   COST2SW,C'Y'        IS IT COS2 BILL ?                            
         JNE   XIT                 NO, DONE                                     
         CP    UBTOTG2,OBTOTG2                                                  
         JE    XIT                                                              
*                                                                               
CLTL3C   MVC   P(8),=C'HEADERS:'                                                
         MVC   P+10(6),=C'GROSS='                                               
         EDIT  OBTOTG,(17,P+16),2,CR=YES                                        
         MVC   P+40(4),=C'NET='                                                 
         EDIT  OBTOTN,(17,P+44),2,CR=YES                                        
         CLI   COST2SW,C'Y'        IS IT COS2 BILL ?                            
         BNE   CLTL3F              NO, SKIP                                     
         MVC   P+70(7),=C'GROSS2='                                              
         EDIT  OBTOTG2,(17,P+77),2,CR=YES                                       
*                                                                               
CLTL3F   MVC   P2(6),=C'UBILL:'                                                 
         MVC   P2+10(6),=C'GROSS='                                              
         EDIT  MYPACKED,(17,P2+16),2,CR=YES                                     
         MVC   P2+40(4),=C'NET='                                                
         EDIT  (P8,DOUBLE),(17,P2+44),2,CR=YES                                  
         CLI   COST2SW,C'Y'        IS IT COS2 BILL ?                            
         BNE   CLT3DIE             NO, SKIP                                     
         MVC   P2+70(7),=C'GROSS2='                                             
         EDIT  UBTOTG2,(17,P2+77),2,CR=YES                                      
CLT3DIE  BRAS  RE,PRNT                                                          
         DC    H'0'                                                             
         SPACE 3                                                                
*        RUN LAST                                                               
RUNL     DS    0H                                                               
         BRAS  RE,INVREG                                                        
*                                                                               
         CLI   OUTMODE,C'D'        IN DIRECT DATASET EDI MODE                   
         JNE   XIT                                                              
         GOTOR BILLEDI,DMCB,('EDMCLS',0)   CLOSE EDI NOW                        
         J     XIT                 ELSE HAVE CLOSED FOR EACH INVOICE            
         SPACE 3                                                                
*        REQLAST                                                                
REQL     DS    0H                                                               
         CLI   ACTSW,C'Y'          ANY ACTIVITY?                                
         BE    *+12                YES                                          
         MVI   ERR,NOBILERR        NO BILLING GENERATED                         
         BRAS  RE,ERRPROC                                                       
*                                                                               
         CLI   UPDTSOON,C'Y'       UPDATIVE SOON?                               
         JNE   XIT                 NO, DONE                                     
         BRAS  RE,UNLOCK           ALLOW THE NEXT UPDATIVE SOON                 
         CLI   QINVREG,C'B'        WANT BT IN STEAD OF INV REGISTER ?           
         JNE   XIT                                                              
         XC    REQHDR,REQHDR       YES: GENERATE BT TURNAROUND                  
         L     RF,VMASTC                                                        
         USING MASTD,RF                                                         
         CLC   MCORIGID,MCREMPQK   IF ORIGIN AND DESTINATION IDS DIFFER         
         BE    *+10                                                             
         MVC   REQDEST,MCREMPQK    THEN PUT BT TO DESTINATION ID                
         DROP  RF                                                               
         MVC   REQUEST,SPACES                                                   
         MVC   QPROG-QAREA+REQUEST,=C'BT'                                       
         MVC   QAGY-QAREA+REQUEST,QAGY                                          
         MVC   QMED-QAREA+REQUEST,QMED                                          
         MVC   QCLT-QAREA+REQUEST,=C'ALL'                                       
         MVC   QPRD-QAREA+REQUEST,=C'ALL'                                       
         MVC   QEST-QAREA+REQUEST,=C'ALL'                                       
         MVC   QSTART-QAREA+REQUEST,TODAY                                       
         MVC   QEND-QAREA+REQUEST,TODAY                                         
         MVI   QOPT1-QAREA+REQUEST,C'N'                                         
         MVC   QUESTOR-QAREA+REQUEST(5),=C'*SOON'                               
         GOTO1 DATAMGR,DMCB,=C'DMADD',=C'REQUEST',WORK,REQHDR                   
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         J     XIT                                                              
         SPACE 2                                                                
         DROP  RB,R9                                                            
         SPACE 3                                                                
         LTORG                                                                  
*        UNLOCK UPDATIVE SOON REQUESTS                                          
*                                                                               
UNLOCK   NMOD1 0,UNLOCK                                                         
         LA    RC,SPACEND                                                       
*                                                                               
         CLI   UPDTSOON,C'Y'       UPDATIVE SOON?                               
         BNE   UNLOCKX                                                          
*                                                                               
         XC    LKUPKEY,LKUPKEY     YES -- UNLOCK UPDATIVE SOONS                 
L        USING LKKEYD,LKUPKEY                                                   
         L     R1,UTL                                                           
         MVC   L.LOCKSE,4(R1)                                                   
         MVC   L.LOCKAGY,AGENCY                                                 
         MVC   L.LOCKRTY,=C'NB'                                                 
         CP    MANGRS,=P'0'        IS THIS A MANUAL BILL ?                      
         BNE   UNLOCK5             YES, DONE                                    
         MVC   L.LKNBCLT,QCLT                                                   
         CLI   ESTQ,C'1'           IF SINGLE EST, PUT IT IN                     
         BNE   *+10                                                             
         MVC   L.LKNBEST,QEST                                                   
*                                                                               
         CLI   MEDFILT,C' '        DO WE HAVE SUBMEDIA FITER ?                  
         BNH   *+14                                                             
         MVI   L.LKNBNET,C'*'                                                   
         MVC   L.LKNBNET+1(1),MEDFILT                                           
*                                                                               
         CLI   QSTA,C' '           ANY STATION ?                                
         BNH   UNLOCK5                                                          
         CLC   =C'ALL',QSTA                                                     
         BE    UNLOCK5                                                          
         MVC   L.LKNBNET,QSTA                                                   
         DROP  L                                                                
*                                                                               
UNLOCK5  XC    DMCB(4),DMCB                                                     
         MVC   DMCB+4(3),=X'D9000A'                                             
         MVI   DMCB+7,QLOCKET                                                   
         L     RF,ACOMFACS                                                      
         L     RF,(CCALLOV-COMFACSD)(RF)                                        
         GOTO1 (RF),DMCB                                                        
         CLI   4(R1),X'FF'                                                      
         BNE   *+6                                                              
         DC    H'0'                                                             
         L     RF,DMCB                                                          
*                                                                               
UNLOCK10 GOTO1 (RF),DMCB,('LKUNLKQ',LKUPKEY),ACOMFACS                           
         CLI   4(R1),2             TEST TABLE BUSY                              
         BE    UNLOCK10                                                         
*                                                                               
UNLOCKX  DS    0H                                                               
         XIT1                                                                   
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
         TITLE 'SPREPBU02 -  FIRST FOR CLIENT'                                  
CFIRST   NMOD1 0,CFIRST                                                         
         LA    RC,SPACEND                                                       
*                                                                               
         L     R3,ADCLT                                                         
         USING CLTHDR,R3                                                        
*                                                                               
         XC    BRKTAB,BRKTAB                                                    
         XC    PEFFPARN,PEFFPARN   CLEAR PEFFTAB                                
*                                                                               
         L     RE,=A(BHOLDTAB)     CLEAR BHOLD TABLE                            
         LHI   RF,BHOLDTBL                                                      
         XCEF                                                                   
         BRAS  RE,BLDBHLDT         BUILD TABLE OF BHOLD RECS                    
*                                                                               
         MVC   QSTART,SVQSTART      RESTORE ORIGINAL QSTART AND QEND            
         MVC   QEND,SVQEND                                                      
         CLC   =C'ALL',QCLT         FOR 'ALL' CLIENT REQUEST                    
         BE    *+12                                                             
         CLI   QCLT,C'*'            OR ALL FOR OFFICE                           
         BNE   *+12                                                             
         MVI   QSAVE+QCLT-QRECORD,0  FORCE CLIENT CHANGE                        
         MVI   QPGR,C' '           CLEAR PGR TO BE SET FROM PROFILES            
*                                                                               
         OC    PROFB1,PROFB1       IF NO B1 PROFILE (HOW POSSIBLE???)           
         BZ    CLTF3               GET IT NOW                                   
         CLC   QAGY,QSAVE+(QAGY-QRECORD) AGY/MED/CLIENT BREAK (WAS JUST         
         BNE   CLTF3                      AGY/MED: GPLA 10/5/93)                
         CLC   QMED,QSAVE+(QMED-QRECORD)                                        
         BNE   CLTF3                                                            
         CLC   QCLT,QSAVE+(QCLT-QRECORD)                                        
         BNE   CLTF3                                                            
         CLC   MEDFILT,QSAVE+65    MEDIA (STATION TYPE) FILTER                  
         BE    *+8                                                              
CLTF3    BRAS  RE,AGMPROC          GET AGM BILLING PROFILE                      
*                                                                               
         MVI   COST2CSW,C'N'       COST2 OPTION                                 
         OC    CCOST2,CCOST2                                                    
         BZ    *+8                                                              
         MVI   COST2CSW,C'Y'                                                    
*                                                                               
         CLC   QAGY,QSAVE+(QAGY-QRECORD) AGY/MED/CLIENT BREAK?                  
         BNE   CLTF4                                                            
         CLC   QMED,QSAVE+(QMED-QRECORD)                                        
         BNE   CLTF4                                                            
         CLC   QCLT,QSAVE+(QCLT-QRECORD)                                        
         BE    CLTF8                                                            
*                                  READ AAA PRDHDR                              
*                                  FOR ADDRESS AND FORMULA                      
CLTF4    DS    0H                                                               
         MVC   AADDRS(132),SPACES                                               
         MVC   AADDRS+132(L'AADDRS-132),SPACES                                  
         XC    AAAFORM,AAAFORM                                                  
         L     RF,=A(AAAELIST)                                                  
         MVC   0(AAAELSTL,RF),FFS                                               
*                                                                               
         MVC   KEY1,KEY                                                         
         USING PRDHDR,RE                                                        
         LA    RE,KEY                                                           
         MVC   PKEY,CKEY           BUILD PRODUCT HEADER KEY FOR                 
         MVC   PKEYPRD,=C'AAA'      PRODUCT AAA                                 
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BNE   CLTF5                                                            
*                                                                               
         MVC   AREC,=A(STABUCKC)   READ INTO STABUCKC                           
         GOTO1 GET                                                              
         L     RE,AREC                                                          
         CLC   =C'NONE',PADDR1                                                  
         BE    CLTF4A                                                           
         CLC   =C'XX',PADDR1                                                    
         BE    CLTF4A                                                           
         CLC   =C'X ',PADDR1                                                    
         BE    CLTF4A                                                           
         CLI   PADDR1,C'A'                                                      
         BL    CLTF4A                                                           
         MVC   AADDR1(L'PADDR1),PADDR1                                          
         MVC   AADDR2(L'PADDR2),PADDR2                                          
         MVC   AADDR3(L'PADDR3),PADDR3                                          
         MVC   AADDR4(L'PADDR4),PADDR4                                          
*                                                                               
CLTF4A   DS    0H                                                               
         MVC   AAAFORM,PBILLDT     DATE, BASE + COMMISSION                      
*                                                                               
*                                  BUILD LIST OF ANY AAA EST FORMULAS           
         CLI   BFROPT,C'N'         SKIP IF USING NEW BFR RECS                   
         BNE   CLTF5                                                            
*                                                                               
         L     R6,=A(AAAELIST)     START OF AAA ESTIMATE LIST                   
         USING AAAELSTD,R6                                                      
         MVC   KEY,PKEY                                                         
         DROP  RE                                                               
*                                                                               
CLTF4B   DS    0H                                                               
         GOTO1 SEQ                                                              
         CLC   KEY(7),KEYSAVE      SAME AGENCY/MEDIA/CLIENT/PRODUCT?            
         BNE   CLTF5               NO, DONE                                     
*                                                                               
         OC    KEY+8(5),KEY+8      ESTIMATE HEADER?                             
         BNZ   CLTF4B              NO                                           
*                                                                               
         GOTO1 GET                                                              
         L     RF,AREC                                                          
         USING ESTHDR,RF                                                        
         MVC   AAAELEST,EKEYEST    ESTIMATE NO.                                 
         MVC   AAAELFOR,EBILLBAS   FORMULA                                      
         DROP  RF                                                               
*                                                                               
         LA    R6,AAAELSTL(R6)                                                  
         MVC   0(AAAELSTL,R6),FFS  SET EOL                                      
         C     R6,=A(AAAELSTX)                                                  
         BL    CLTF4B                                                           
         DC    H'0'                TABLE FULL                                   
         DROP  R6                                                               
*                                                                               
CLTF5    DS    0H                                                               
         CLI   QPGR,C' '                                                        
         BNE   CLTF5D                                                           
*                                  MUST BUILD OWN PRDLIST IF NO PRDGRP          
         L     R4,PRDLIST                                                       
         L     R5,VCLIST                                                        
*                                                                               
CLTF5B   DS    0H                                                               
         CLI   0(R5),0             EOL                                          
         BE    CLTF5D                                                           
         XC    0(2,R4),0(R4)                                                    
         MVC   2(4,R4),0(R5)       MNEMONIC AND CODE                            
         LA    R5,4(R5)                                                         
         LA    R4,6(R4)                                                         
         B     CLTF5B                                                           
*                                                                               
CLTF5D   DS    0H                                                               
         MVC   KEY,KEY1                                                         
         GOTO1 HIGH                RESTORE SEQ                                  
*                                                                               
         CLC   SVAGMINV,AGMSTANO   CHANGE OF INVNO CONTROLS?                    
         BE    *+14                                                             
         MVC   SVAGMINV,AGMSTANO                                                
         B     CLTF6                                                            
*                                                                               
         CLC   SVAGMOCT,AGMOCTL    IF AGMOCTL HAS CHANGED                       
         BNE   CLTF6                                                            
         CLI   AGMOCTL,0           IF DOING BY OFFICE                           
         BE    CLTF5F                                                           
         CLC   SVOFF,COFFICE       AND OFFICE HAS CHANGED                       
         BNE   CLTF6               GET NEW STARTING INVNO                       
*                                                                               
CLTF5F   DS    0H                                                               
         CLC   QAGY,QSAVE+(QAGY-QRECORD) AGY/MED/CLIENT BREAK?                  
         BNE   CLTF5H                                                           
         CLC   QMED,QSAVE+(QMED-QRECORD)                                        
         BNE   CLTF5H                                                           
         CLC   QCLT,QSAVE+(QCLT-QRECORD)                                        
         BE    CLTF10                                                           
*                                                                               
CLTF5H   DS    0H                                                               
         CLC   (QPROG-QRECORD)+QSAVE,QPROG  FIRST TIME                          
         BNE   CLTF6               YES                                          
         CLI   AGMSEQ,C'C'         SEQUENCE BY CLIENT?                          
         BE    CLTF6                                                            
         CLI   AGMSEQ,C'D'         ALSO BY CLIENT                               
         BNE   CLTF8                                                            
*                                                                               
CLTF6    DS    0H                  GET FIRST INVOICE NO.                        
         XC    INVNO,INVNO                                                      
         GOTOR GETNUM,DMCB,INVNO,PINVNO                                         
         B     CLTF10                                                           
*                                                                               
CLTF8    DS    0H                  REDO INVOICE NO TO GET RIGHT MEDIA           
         MVC   W(1),TODAYB+1       SET MONTH FOR GETNUM                         
         GOTOR GETNUM,DMCB,(1,INVNO),PINVNO                                     
*                                  CHECK FOR MANUAL AMOUNTS                     
CLTF10   DS    0H                                                               
         XC    MANBIN(MANBINLQ),MANBIN     CLEAR TO BINARY                      
         ZAP   MANGRS,=P'0'        ZAP PACKED FIELDS IN MANUALS                 
         ZAP   MANNET,=P'0'        ( YKVA )                                     
         ZAP   PKBIG,=P'0'         FOR MP & DP                                  
*                                                                               
         L     RF,VMASTC           RERUN=MM/DD/YY CONTROL CARD IS...            
         MVC   IGNDATE,MCRERUND-MASTD(RF) ...THE DEFAULT IGNORE DATE            
*                                                                               
         MVI   PREVSW,0                                                         
         MVI   PKGREQ,0                                                         
         MVI   NETOPT,0                                                         
         MVC   CTYPQ,QCTYP         SET COST TYPE                                
*                                                                               
         CLC   =C'ONLY PREV',QMANUAL    ONLY PREVIOUS BILLS                     
         BNE   *+12                                                             
         MVI   PREVSW,C'P'                                                      
         B     CLTF50                                                           
*                                                                               
         CLC   =C'PREV',QMANUAL                                                 
         BNE   *+12                                                             
         MVI   PREVSW,C'Y'                                                      
         B     CLTF50                                                           
*                                                                               
         CLC   =C'NO PREV',QMANUAL NO PREVIOUS BILLS                            
         BNE   *+12                                                             
         MVI   PREVSW,C'N'                                                      
         B     CLTF50                                                           
*                                                                               
         CLC   =C'NO PRIOR',QMANUAL                                             
         BE    CLTF50                                                           
*                                                                               
         CLC   =C'PKG=',QMANUAL    PACKAGE REQUEST                              
         BNE   CLTF10G                                                          
         PACK  DUB,QMANUAL+4(3)                                                 
         CVB   R0,DUB                                                           
         STC   R0,PKGREQ                                                        
         B     CLTF50                                                           
*                                                                               
CLTF10G  DS    0H                                                               
         CLC   =C'OLD',QMANUAL                                                  
         BNE   *+12                                                             
         MVI   NETOPT,C'O'                                                      
         B     CLTF50                                                           
*                                                                               
         CLC   =C'TIME',QMANUAL                                                 
         BNE   *+12                                                             
         MVI   CTYPQ,C'T'                                                       
         B     CLTF50                                                           
*                                                                               
         CLC   =C'INT',QMANUAL                                                  
         BNE   *+12                                                             
         MVI   CTYPQ,C'I'                                                       
         B     CLTF50                                                           
*                                                                               
         CLC   QMANUAL,SPACES                                                   
         BE    CLTF50                                                           
         CLC   =C'P=',QMANUAL      PCT                                          
         BE    CLTF20                                                           
         CLC   =C'R=',QMANUAL      REVERSAL                                     
         BE    CLTF30                                                           
         CLC   =C'I=',QMANUAL      IGNORE DATE                                  
         BE    CLTF34                                                           
         CLI   QMANUAL,C'G'                                                     
         BNE   CLTF39              ERROR                                        
*                                                                               
         CLI   COST2CSW,C'Y'       NO MANUAL FOR COST2-STYLE BILLING            
         BE    CLTF39                                                           
*                                                                               
         PACK  DUB,QMANUAL+2(10)   GROSS                                        
         CP    DUB,=P'0'                                                        
         BE    CLTF39                                                           
         CLI   QMANUAL+2,C'-'      NEGATIVE?                                    
         BNE   *+10                                                             
         MP    DUB,=P'-1'                                                       
         MVC   MANGRS,DUB                                                       
         MVC   MANNET,DUB                                                       
         CLI   QMANUAL+1,C'F'      FEE BASIS - GROSS = NET                      
         BE    CLTF14                                                           
*                                                                               
         ZAP   MYPACKED,=P'100'    NORMAL 85 NET                                
         ZAP   DOUBLE,=P'85'                                                    
         CLI   CPROF+14,C'0'       NO SPECIAL RATE                              
         BE    CLTF12                                                           
         CLI   CPROF+14,C'3'       N RATE  85/100                               
         BE    CLTF12                                                           
         ZAP   DOUBLE,=P'100'                                                   
         CLI   CPROF+14,C'1'       S RATE  100/100                              
         BE    CLTF12                                                           
         CLI   CPROF+14,C'2'       F RATE  100/100                              
         BE    CLTF12                                                           
         ZAP   MYPACKED,=P'105'                                                 
         CLI   CPROF+14,C'4'       Q RATE  100/105                              
         BE    CLTF12                                                           
         ZAP   MYPACKED,=P'115'                                                 
         CLI   CPROF+14,C'5'       V RATE  100/115                              
         BE    CLTF12                                                           
         ZAP   DOUBLE,=P'85'                                                    
         ZAP   MYPACKED,=P'90'                                                  
         CLI   CPROF+14,C'6'       X RATE  90/85                                
         BE    CLTF12                                                           
*                                                                               
         ZAP   MYPACKED,=P'100'    DEFAULT TO 85/100                            
CLTF12   DS    0H                                                               
         ZAP   PKBIG,DUB           PUT AMOUNT                                   
         MP    PKBIG,DOUBLE                                                     
         DP    PKBIG,MYPACKED                                                   
         MVC   MANNET,PKQUOT                                                    
*                                                                               
CLTF14   DS    0H                                                               
         B     CLTF50                                                           
*                                                                               
*                                  PCT                                          
CLTF20   DS    0H                                                               
         PACK  DUB,QMANUAL+2(5)    2 DECIMALS                                   
         CVB   R0,DUB                                                           
         ST    R0,MANPCT                                                        
         LTR   R0,R0                                                            
         BZ    CLTF39                                                           
         B     CLTF50                                                           
*                                                                               
*                                  REVERSAL INVOICE NUMBER                      
CLTF30   DS    0H                                                               
         LA    R2,QMANUAL+2                                                     
         GOTO1 DATCON,DMCB,(R2),(2,MANRVDTP)                                    
*                                                                               
         XC    DMCB,DMCB                                                        
         GOTO1 =V(SPFMTINO),DMCB,,(C'P',QMANUAL+8)                              
         L     RF,DMCB+4                                                        
         OC    0(2,RF),0(RF)       IF NULLS -> INVALID                          
         BZ    CLTF39                                                           
         MVC   MANRVNO,0(RF)                                                    
*                                                                               
         MVI   FCRDBUYS,C'N'       SUPPRESS READING OF BUYS                     
         MVI   PREVSW,C'Y'                                                      
         B     CLTF50                                                           
*                                                                               
*                                  'IGNORE' DATE                                
CLTF34   DS    0H                                                               
         LA    R2,QMANUAL+2                                                     
         GOTO1 DATCON,DMCB,(R2),(2,IGNDATE)                                     
         B     CLTF50                                                           
*                                                                               
CLTF39   DS    0H                                                               
         MVI   ERR,MANERR                                                       
         BRAS  RE,ERRPROC                                                       
*                                                                               
CLTF50   DS    0H                                                               
         BRAS  RE,SETDATE                                                       
*                                                                               
         CLI   SCBOPT,C'Y'         IF SEPARATE COMMISSION OPTION                
         BNE   CLTF50D                                                          
         CLC   =C'ALL',QCLT        SKIP IF CLIENT ALL REQUEST                   
         BE    *+12                                                             
         CLI   QCLT,C'*'                                                        
         BNE   *+12                                                             
         MVI   MODE,CLTLAST                                                     
         B     CLXF14D                                                          
*                                                                               
         CLI   PROFB2B+1,0         HAVE ESTIMATE FILTER PROFILE?                
         BNH   CLTF50D                                                          
         CLC   =C'NO ',QEST        AND QEST = NO                                
         BE    *+14                                                             
         CLC   =C'ALL',QEST        OR ALL                                       
         BNE   CLTF50C                                                          
*                                                                               
*                                  SET FILTERS IN REQUEST CARD                  
         CLI   QESTEND,C' '        INITIALIZE IF BLANK                          
         BH    *+10                                                             
         MVC   QESTEND,=C'***'                                                  
*                                                                               
         ZIC   RF,PROFB2B+1                                                     
         LA    RF,QESTEND-1(RF)                                                 
         MVC   0(1,RF),PROFB2B+2   SET VALUE IN REQUEST CARD                    
         CLI   SCBNCSW,C'R'        FOR 'REGULAR' RUNS OK AS IS                  
         BE    *+8                 ELSE SET TO LOWER CASE                       
         NI    0(RF),X'FF'-X'40'   FOR 'ALL EXCEPT'                             
         B     CLTF50D                                                          
*                                                                               
CLTF50C  DS    0H                                                               
         CLI   QESTEND,C'0'        NO ESTIMATE RANGE REQUESTS ALLOWED           
         BL    CLTF50D                                                          
         MVI   ERR,ESTERR                                                       
         BRAS  RE,ERRPROC                                                       
*                                                                               
CLTF50D  DS    0H                                                               
         L     R9,MEDBUFF                                                       
         USING MEDBLOCK,R9                                                      
         XC    MEDNUMWK,MEDNUMWK                                                
         XC    MEDNUMMO,MEDNUMMO                                                
         MVC   MEDNUMMO+3(1),NMOS                                               
         XC    MEDNUMQT,MEDNUMQT                                                
         MVC   MEDNUMPE,=F'1'                                                   
         MVC   MEDLCHNK,=F'200'                                                 
         MVI   MEDEXTDM,0                                                       
         MVI   MEDEXTAC,C'Y'                                                    
*                                                                               
         GOTO1 MEDPRDRD,DMCB,SPWORKD                                            
*                                                                               
         ICM   R0,15,BQSTARTP      SAVE START AND END DATES                     
         MVC   WORK(L'QSTART),QSTART                                            
         MVC   WORK+L'QSTART(L'QEND),QEND                                       
*                                                                               
         GOTO1 MEDDATE,DMCB,SPWORKD                                             
         OC    REQYM,REQYM         START AND END REQUESTED?                     
         BNZ   CLTF52              NO                                           
*                                                                               
         STCM  R0,15,BQSTARTP      YES - RESTORE DATES (IMPORTANT ONLY          
         MVC   QSTART,WORK           WHEN DATES DO NOT COINCIDE WITH            
         MVC   QEND,WORK+6           'WEEK' START AND END)                      
*                                                                               
         L     RF,MEDAFRST         AND ADJUST MEDIA PERIOD                      
         MVC   0(4,RF),BQSTARTP    (THERE WILL ONLY BE 1 PERIOD)                
         DROP  R9                                                               
*                                                                               
CLTF52   DS    0H                                                               
*                                                                               
*                                  SET PRODUCT AND ESTIMATE Q'S                 
         MVI   ESTQ,C'S'           SERIES                                       
         CLI   QESTEND,C' '                                                     
         BH    CLXF6                                                            
         MVI   ESTQ,C'A'           ALL                                          
         CLC   =C'NO',QEST                                                      
         BE    CLXF6                                                            
         MVI   ESTQ,C'1'           ONE ESTIMATE                                 
*                                                                               
CLXF6    DS    0H                                                               
         MVI   PRDQ,C'A'           ALL                                          
         CLI   QPRD,C'0'                                                        
         BNL   CLXF7                                                            
         CLI   QPRD,C' '                                                        
         BNH   CLXF7                                                            
         CLC   QPRD,=C'ALL'                                                     
         BE    CLXF7                                                            
         CLC   QPRD,=C'POL'                                                     
         BE    CLXF7                                                            
         CLI   PGSW,C'Y'           FOR P&G LEAVE AS IF ALL, SO IT DOES          
         BE    CLXF7               NOT GET INTO HEADLINES                       
         CLI   WMTSW,C'Y'          FOR WMT LEAVE AS IF ALL, SO IT DOES          
         BE    CLXF7               NOT GET INTO HEADLINES                       
         MVI   PRDQ,C'1'           ONE PRODUCT                                  
*                                                                               
CLXF7    DS    0H                                                               
         MVI   PGRQ,C'N'           NO PGRS                                      
         CLI   QPGR,C' '                                                        
         BE    CLXF8                                                            
         MVI   PGRQ,C'A'           ALL PGRS                                     
         CLC   QPRD,=C'ALL'                                                     
         BE    CLXF8                                                            
         CLI   QPRD,C' '                                                        
         BE    CLXF8                                                            
         MVI   PGRQ,C'*'           MORE THAN 1 PGR                              
         CLI   QPRD+1,C'*'                                                      
         BE    CLXF8                                                            
         CLI   QPRD+2,C'*'                                                      
         BE    CLXF8                                                            
         MVI   PGRQ,C'1'           1 PGR                                        
*                                                                               
CLXF8    DS    0H                                                               
         MVI   MGRQ,C'N'           NO MGRS                                      
         MVI   MKTQ,C'A'           ALL MARKETS                                  
         CLI   QMKT,C'0'                                                        
         BL    *+8                                                              
         MVI   MKTQ,C'1'           1 MARKET                                     
*                                                                               
         CP    MANGRS,=P'0'                                                     
         BE    CLXF12                                                           
         CLI   PRDQ,C'1'                                                        
         BNE   CLTF39                                                           
         CLI   ESTQ,C'1'                                                        
         BNE   CLTF39                                                           
*                                                                               
CLXF12   DS    0H                                                               
         CLI   QPGR,C' '                                                        
         BNE   CLXF14D                                                          
         BRAS  RE,BLDTAB           IF NO PGR'S, BUILD KEY TABLE NOW             
*                                                                               
CLXF14D  DS    0H                                                               
         MVC   SVOFF,COFFICE       SAVE OFFICE CODE                             
         MVC   SVAGMOCT,AGMOCTL    SAVE AGMOCTL                                 
*                                  EDI ACTIVATION                               
         MVI   OUTMODE,C'D'        ASSUME DATASET OUTPUT                        
         CLC   =C'*EDI',QUESTOR     IF QUESTOR BEGINS WITH '*EDI'               
         BE    CLXF14E                                                          
         MVI   OUTMODE,C'W'        ELSE WORKER FILE OUTPUT                      
         CLI   PROOFSW,C'Y'        SKIP IF DRAFT BILLING                        
         BE    CLXF14D4                                                         
         CLI   RCWRITE,C'Y'        ...OR IF WRITE=NO                            
         BNE   CLXF14D4                                                         
*                                                                               
         CLI   PROFB1A+5,C'Y'      EDI CLIENT?                                  
         BE    CLXF14E                                                          
*                                                                               
CLXF14D4 DS    0H                                                               
         LA    RF,=X'07FE'         DUMMY EDI ROUTINE                            
         B     CLXF14F                                                          
*                                                                               
CLXF14E  DS    0H                                                               
         CLI   OUTMODE,C'D'        IF WRITING TO DATASET...                     
         BNE   CLXF14E3                                                         
*                                                                               
         BC    0,CLXF14E3          ONLY PRIME THE DATSET ONCE                   
         MVI   *-3,X'F0'                                                        
         OPEN  (EDIOUT,OUTPUT)     OPEN AND CLOSE DATASET, TO PRIME FOR         
         CLOSE EDIOUT               READING EVEN IF IT'S EMPTY                  
*                                                                               
CLXF14E3 DS    0H                                                               
         L     RF,=A(BILLEDI)      USE REAL EDI ROUTINE                         
*                                                                               
CLXF14F  DS    0H                                                               
         ST    RF,ABILLEDI                                                      
*                                  FOR DIRECT DATASET MODE                      
         J     XIT                                                              
         DROP  R3                                                               
         SPACE 2                                                                
         LTORG                                                                  
         TITLE 'BLDTAB - BUILD SORT/BREAK CONTROL TABLE'                        
BLDTAB   NMOD1 0,BLDTAB                                                         
         LA    RC,SPACEND                                                       
*                                                                               
*                                  READ B5 PROFILE                              
*                                  MOVE PROFILE INTO BRKEQV                     
*                                                                               
         OI    BRKTYP+2,X'04'      SET COST TYPE REQUEST FOR NETWORK            
*                                                                               
         MVI   BRKMKT+2,0          MARKET NOT REQUIRED                          
         MVI   BRKPGM+2,X'04'      BUT PROGRAM                                  
         MVI   BRKDSC+2,X'04'      AND SPOT DESC ARE                            
         MVI   PROFB4+3,C'N'       AND SUPPRESS MARKETS AND MGRS                
         MVI   PROFB4+4,C'N'                                                    
*                                                                               
         XC    X,X                                                              
         MVC   X(6),PROFB4         HOLD PROFILE IN X                            
*                                                                               
         MVI   PRDMKT,C'P'         PRODUCT HIGHER THAN MARKET                   
         CLI   X+4,C'R'            UNLESS MARKET OPTION = R                     
         BNE   BT01                                                             
         MVI   X+4,C'T'            THEN RESET TO T                              
         CLI   X+1,C'T'            PRODUCT MUST ALSO BE T                       
         BNE   BT01                                                             
         MVI   PRDMKT,C'M'         AND SET MARKET HIGHER THAN PRODUCT           
BT01     DS    0H                                                               
*                                                                               
*              IF REQUEST FOR SINGLE SET PROFILE TO SEPARATE                    
         CLI   PGRQ,C'1'                                                        
         BNE   *+8                                                              
         MVI   X+0,C'S'                                                         
         CLI   PRDQ,C'1'                                                        
         BNE   *+8                                                              
         MVI   X+1,C'S'                                                         
         CLI   ESTQ,C'1'                                                        
         BNE   *+8                                                              
         MVI   X+2,C'S'                                                         
         CLI   MGRQ,C'1'                                                        
         BNE   *+8                                                              
         MVI   X+3,C'S'                                                         
         CLI   MKTQ,C'1'                                                        
         BNE   *+16                                                             
         CLI   QMED,C'N'                                                        
         BE    *+8                                                              
         MVI   X+4,C'S'                                                         
*                                                                               
         CLI   X+5,C'T'            IF STATION TOGETHER THEN                     
         BNE   BT101                                                            
         CLI   QMED,C'N'           EXCEPT FOR NETWORK                           
         BE    BT101                                                            
         CLI   X+4,C'S'                                                         
         BE    *+8                                                              
         MVI   X+4,C'T'            THEN MARKET MUST BE TOG OR SEPARATE          
*                                                                               
BT101    DS    0H                                                               
         MVI   X+6,C'N'            NO SPOT DETAILS                              
         MVI   X+7,C'N'                                                         
         MVI   SPOTSW,C'N'                                                      
         OC    PROFBN(14),PROFBN   UNLESS HAVE SPECIAL PROFILE                  
         BZ    BT100                                                            
         CLI   PROFBN+2,C'N'                                                    
         BE    BT100                                                            
         CP    MANGRS,=P'0'        OR IF MANUAL                                 
         BNE   BT100                                                            
         MVI   SPOTSW,C'Y'                                                      
         MVC   X+6(1),PROFBN       PKG CONTROL                                  
         MVI   X+7,C'T'            SPOT CONTROL                                 
         MVC   PROGSW,PROFBN+2     SPOT SEQ.                                    
         MVC   ZUOPT,PROFBN+4      ZERO UNIT OPTION                             
         CLI   PKGREQ,0            IF PACKAGE REQUEST                           
         BE    *+8                                                              
         MVI   X+6,C'S'            SET PKG TO SEPARATE                          
*                                                                               
BT100    DS    0H                                                               
         MVI   X+8,C'N'                                                         
         CLI   NETOPT,C'O'                                                      
         BE    BT100B                                                           
         CLI   QMED,C'N'                                                        
         BNE   BT100B                                                           
         MVC   X+8(1),TICTL        COST TYPE CONTROL, USE T/I                   
         CLI   CTYPQ,C'2'          UNLESS SPECIFICALLY REQUEST SPCLS            
         BNE   *+10                                                             
         MVC   X+8(1),SPCLCTL                                                   
*                                                                               
BT100B   DS    0H                                                               
         CP    MANGRS,=P'0'        FOR MANUALS                                  
         BE    *+12                                                             
         MVI   X+8,C'S'            T/I SEPARATE                                 
         B     BT100C                                                           
*                                                                               
         CLI   CTYPQ,C' '          SPECIFIC COST TYPE REQUESTED?                
         BE    *+16                                                             
         CLI   CTYPQ,C'1'          AND NOT A GROUP OF TYPES                     
         BNL   *+8                                                              
         MVI   X+8,C'S'            YES, TREAT COST AS SEPARATE                  
*                                                                               
BT100C   MVI   X+9,C'N'            DAYPART IS N OR S (NOT T)                    
         CLI   DPTSEP,C'N'                                                      
         BE    *+10                                                             
         MVC   X+9(1),DPTSEP                                                    
*                                  NETOPT O = OLD ONLY, N = NEW ONLY            
         CLI   QMED,C'N'                                                        
         BNE   BT100D                                                           
         CLI   NETOPT,C'O'                                                      
         BE    BT100D                                                           
         MVI   NETOPT,C'N'                                                      
         CLI   PROFB2+9,0                                                       
         BNE   BT100D                                                           
         CLI   SPOTSW,C'Y'                                                      
         BE    BT100D                                                           
         MVI   NETOPT,C'O'                                                      
*                                                                               
BT100D   DS    0H                                                               
         CP    MANGRS,=P'0'        IF MANUAL                                    
         BE    BT100F                                                           
         MVC   X+3(5),=C'NNNNN'    SUPPRESS MGR,MARKET,STATION, ETC.            
         CLI   CTYPQ,C'T'          FOR TIME AND INTEGRATION MANUAL              
         BE    BT100F                                                           
         CLI   CTYPQ,C'I'          DON'T SUPPRESS COST TYPE                     
         BE    BT100F                                                           
         MVI   X+8,C'N'                                                         
BT100F   XC    WORK,WORK                                                        
         MVC   WORK(BRKEQVL),BRKEQV                                             
         LA    R2,WORK                                                          
*                                                                               
         MVC   PGR1DQ(1,R2),X+0    PGR1                                         
         MVC   PGR2DQ(1,R2),X+0    PGR2                                         
         MVC   PGR3DQ(1,R2),X+0    PGR3                                         
         MVC   PRDDQ(1,R2),X+1     PRODUCT                                      
         MVC   ESTDQ(1,R2),X+2     ESTIMATE                                     
         MVC   MGR1DQ(1,R2),X+3    MGR1                                         
         MVC   MGR2DQ(1,R2),X+3    MGR2                                         
         MVC   MGR3DQ(1,R2),X+3    MGR3                                         
         MVC   MKTDQ(1,R2),X+4     MARKET                                       
         MVC   STADQ(1,R2),X+5     STATION                                      
         MVC   PKGDQ(1,R2),X+6     PKG                                          
         MVC   PGMDQ(1,R2),X+7     PGM                                          
         MVC   DESCDQ(1,R2),X+7    DESC                                         
*                                  PERIOD (13)                                  
*                                  PERIOD GROUP (14)                            
         MVC   CTYPDQ(1,R2),X+8    TYPE - TIME OR INT                           
         MVC   DPTDQ(1,R2),X+9     DAYPART                                      
*                                                                               
         CLI   STADQ(R2),C'N'      STA CAN'T BE N IF HAVE SPOT DETAIL           
         BNE   *+16                                                             
         CLI   DESCDQ(R2),C'N'                                                  
         BE    *+8                                                              
         MVI   STADQ(R2),C'T'                                                   
*                                                                               
         CLI   STADQ(R2),C'S'      STATION MUST BE S IF PACKAGE IS S            
         BE    BT101B                                                           
         CLI   PKGDQ(R2),C'S'                                                   
         BNE   BT101B                                                           
         CLI   PKGNMOPT,0          UNLESS DOING PKG NAME (GROUP) OPTION         
         BNE   BT101B                                                           
         MVI   STADQ(R2),C'S'      NET SEPARATE                                 
*                                                                               
BT101B   DS    0H                                                               
         CLI   PROGSW,C'P'                                                      
         BE    *+22                                                             
         XC    PGMDQ(3,R2),DESCDQ(R2) SWAP PROG AND DESC TO CHANGE SORT         
         XC    DESCDQ(3,R2),PGMDQ(R2)                                           
         XC    PGMDQ(3,R2),DESCDQ(R2)                                           
*                                                                               
         MVI   PERDQ(R2),C'S'      PRIOR SEPARATE                               
         CLI   PRIOR,C'1'          IF 1 - 3                                     
         BNL   BT1A                                                             
         MVI   PERDQ(R2),C'T'      PRIOR TOGETHER                               
         CLI   PRIOR,X'CB'         IF A - C (OR FUDGED: X'C4' - X'CB')          
         BNH   BT1A                                                             
         MVC   PERDQ(1,R2),PRIOR   PERIOD                                       
*                                                                               
BT1A     DS    0H                                                               
         CLI   PRIOR,C'N'          IF NO PRIOR                                  
         BNE   *+8                                                              
         MVI   PERDQ(R2),C'S'      TREAT AS SEPARATE                            
*                                                                               
         MVI   PERGDQ(R2),C'N'     NO PERIOD GROUP                              
         CLI   PRIOR,C'U'          25 MOS SEP                                   
         BNE   *+8                                                              
         MVI   PERDQ(R2),C'S'                                                   
*                                                                               
         CLI   PRIOR,C'V'          25 MOS TOG                                   
         BNE   *+8                                                              
         MVI   PERDQ(R2),C'T'                                                   
*                                                                               
         CLI   PRIOR,C'M'          UNLESS DOING CURRENT MONTH SEPARATE          
         BNE   *+12                                                             
         MVI   PERDQ(R2),C'T'                                                   
         MVI   PERGDQ(R2),C'S'                                                  
*                                                                               
         CLI   BFRMOS,C'S'         SEPARATE BFR MOS OPTION                      
         BNE   *+12                                                             
         MVI   PERDQ(R2),C'T'                                                   
         MVI   PERGDQ(R2),C'S'                                                  
*                                  SET PERIOD GROUP TO SEPARATE                 
*                                   AND USE AS DUMMY INVOICE BREAK              
         LR    RF,R2                                                            
         LHI   R0,11                                                            
BT1B     DS    0H                                                               
         CLI   0(RF),C'S'                                                       
         BE    BT1D                                                             
         LA    RF,L'BRKEQV(RF)                                                  
         BCT   R0,BT1B                                                          
         MVI   PERGDQ(R2),C'S'     PERIOD GROUP TO S                            
*                                                                               
BT1D     DS    0H                  SET PAGE BREAK                               
         SR    RF,RF                                                            
         ICM   RF,1,PROFB4+7                                                    
         BZ    BT3                                                              
         AHI   RF,2                ADJUST FOR PGR AND MGR LUMPING               
         CLI   PROFB4+7,4                                                       
         BL    *+8                                                              
         AHI   RF,2                                                             
         MHI   RF,L'BRKEQV                                                      
         LA    RF,WORK-L'BRKEQV(RF)                                             
         LA    RE,WORK                                                          
*                                                                               
BT2B     DS    0H                                                               
         CLI   0(RE),C'T'                                                       
         BNE   *+8                                                              
         OI    2(RE),X'80'         PAGE BREAK                                   
         LA    RE,L'BRKEQV(RE)                                                  
         CR    RE,RF                                                            
         BNH   BT2B                                                             
*                                                                               
BT3      DS    0H                  SET RECAP LEVEL                              
         SR    RF,RF                                                            
         ICM   RF,1,PROFB4+6                                                    
         BZ    BT3B                                                             
         AHI   RF,2                ADJUST FOR PGR AND MGR LUMPING               
         CLI   PROFB4+6,4                                                       
         BL    *+8                                                              
         AHI   RF,2                                                             
         MHI   RF,L'BRKEQV                                                      
         LA    RF,WORK-L'BRKEQV(RF)                                             
         LA    RE,WORK                                                          
*                                                                               
BT3A     DS    0H                                                               
         OI    2(RE),X'40'         RECAP LEVEL                                  
         LA    RE,L'BRKEQV(RE)                                                  
         CR    RE,RF                                                            
         BNH   BT3A                                                             
*                                                                               
BT3B     DS    0H                                                               
         MVC   BFORMAT,PROFB4+11   BILL FORMAT                                  
         MVC   DFORMAT,PROFB4+12   DETAIL BACK-UP FORMAT                        
*                                                                               
         CLI   PROFBNX+0,C'Y'      UNLESS BNX PROFILE SAYS                      
         BE    BT3C                 TO STAY WITH 1                              
         CLI   BFORMAT,1           CHANGE FORMAT 1 (WITH INVOICE NO'S)          
         BNE   *+8                                                              
         MVI   BFORMAT,5           TO FORMAT 5 (NO INVOICE NO'S)                
         CLI   DFORMAT,1                                                        
         BNE   *+8                                                              
         MVI   DFORMAT,5                                                        
*                                                                               
BT3C     DS    0H                                                               
         CP    MANGRS,=P'0'        FOR MANUAL BILLING                           
         BE    *+16                                                             
         CLI   BFORMAT,5           CHANGE LONG FORMAT TO                        
         BNE   *+8                                                              
         MVI   BFORMAT,8           BILLABLE FORMAT                              
*                                                                               
         CLI   DFORMAT,0           LET DETAIL BACK-UP FORMAT                    
         BNE   *+10                                                             
         MVC   DFORMAT,BFORMAT     DEFAULT TO NORMAL FORMAT                     
*                                  SET GROSS/NET CONTROL                        
         MVC   GNSW,PROFB4+13      GROSS/NET                                    
         MVI   COMMSW,C'N'         NO COMMISSION                                
         CLI   GNSW,C'1'           IF G OR N                                    
         BL    BT3E                                                             
         MVI   GNSW,C'G'           1 = G WITH COMMISSION                        
         BE    *+8                                                              
         MVI   GNSW,C'N'           2 = N WITH COMMISSION                        
         MVI   COMMSW,C'Y'                                                      
*                                                                               
BT3E     DS    0H                                                               
         MVC   LSTOPT,PROFB4+14                                                 
*                                                                               
         LA    RF,LSTOTAB          SEE IF KEEPING REVERSED & REVERSALS          
         MVI   SHOWREV,C'N'                                                     
BT3F     CLC   LSTOPT,0(RF)                                                     
         BNE   *+18                                                             
         MVC   LSTOPT,1(RF)                                                     
         MVI   SHOWREV,C'Y'                                                     
         B     BT3FB                                                            
*                                                                               
         LA    RF,L'LSTOTAB(RF)    NXT ENTRY                                    
         CLI   0(RF),X'FF'                                                      
         BNE   BT3F                                                             
*                                                                               
******   CLI   LSTOPT,C'A'         PREV IN ACTUAL ?                             
******   BNE   *+8                                                              
******   MVI   SHOWREV,C'Y'        YES, SHOW REVERSED AND REVERSALS             
*                                                                               
BT3FB    DS    0H                                                               
         CLI   PRDMKT,C'M'         MARKET TO BE HIGHER THAN PRODUCT?            
         BNE   BT3J                                                             
*                                  SWAP MARKET AND PRODUCT CLTS                 
         MVC   X(15),WORK                                                       
         MVC   WORK(12),WORK+15                                                 
         MVC   WORK+12(15),X                                                    
*                                                                               
BT3J     DS    0H                                                               
*                                                                               
*                                  S=SEPARATE                                   
*                                  T=TOGETHER                                   
*                                  N=NO                                         
         LHI   R0,BRKEQVL/L'BRKEQV                                              
BT4      DS    0H                                                               
         CLI   0(R2),C'N'                                                       
         BNE   BT4D                                                             
         MVI   0(R2),X'F0'         SET N'S LAST                                 
         CLI   1(R2),X'10'         BUT SET PRODUCT                              
         BNE   *+8                                                              
         MVI   0(R2),X'FE'         AFTER OTHER N'S                              
*                                                                               
BT4D     DS    0H                                                               
         LA    R2,L'BRKEQV(R2)                                                  
         BCT   R0,BT4                                                           
*                                                                               
         CLI   DPTSEP,C'T'      IF DAYPARTS TOGETHER, MOVE IT UP                
         BNE   BT4K             SHIFT ENTRIES AFTER PKG TO INSRT DAYPT          
         LA    R2,WORK                                                          
         XC    WK,WK                                                            
         MVC   WK(18),PGMDQ(R2) LEN=L'BRKEQV * # OF ENTR AFT PKG                
         MVC   PGMDQ(L'BRKEQV,R2),DPTDQ(R2) PUT DPT AFTER PKG                   
         MVC   DESCDQ(18-3,R2),WK           LAST 3 BYTES EXCLUDED               
*                                  SORT ON PROFILE BYTE (POSITION)              
BT4K     LHI   R0,BRKEQVL/L'BRKEQV                                              
         GOTO1 XSORT,DMCB,WORK,(R0),L'BRKEQV,1,0                                
*                                  BUILD BRKTAB                                 
         LA    R2,WORK                                                          
         LA    R3,BRKTAB                                                        
         USING BRKTABD,R3                                                       
         XC    BRKTAB,BRKTAB                                                    
         SR    R7,R7                                                            
         XC    ABRKS(ABRKSL),ABRKS CLEAR CONTROL ADDRESSES                      
         XC    ATOTS(LATOTS),ATOTS                                              
         XC    ALEVS(LALEVS),ALEVS                                              
         XC    LEVCTLS(LLEVCTLS),LEVCTLS                                        
*                                                                               
BT6      DS    0H                                                               
         SR    RF,RF                                                            
         ICM   RF,1,1(R2)          CODE                                         
         BZ    *+16                                                             
         BAS   RE,BTTAB-4(RF)                                                   
         LA    R2,L'BRKEQV(R2)                                                  
         B     BT6                                                              
*                                                                               
         CLI   SORTTRCE,C'Y'       IF TRACING, PRINT A TABLE OF KEY             
         BNE   BT6K                FIELDS AND THEIR SEQUENCE                    
*                                                                               
         MVC   P(55),=C'FIELDS IN THE SORTKEY APPEAR IN THE FOLLOWING SE        
               EQUENCE:'                                                        
         GOTO1 REPORT                                                           
         LA    R3,BRKTAB                                                        
         LA    R2,BRKNAME          TABLE OF BREAK NAMES                         
         USING BRKNAMD,R2                                                       
         LA    RF,BRKNAML(R2)      POINT TO THE END                             
*                                                                               
BT6C     CLC   BRKNCOD,BRKCODE+3     FIND ENTRY IN BRKNAME TABLE                
         BE    *+16                                                             
         LA    R2,BRKNL(R2)        NXT ENTRY                                    
         CR    R2,RF               PAST THE END OF TAB ?                        
         BL    BT6C                                                             
         DC    H'0'                                                             
*                                                                               
         MVC   P(L'BRKNNAM),BRKNNAM                                             
         MVC   P+L'BRKNNAM+1(17),=C'FOR THE LENGTH OF'                          
         L     R4,BRKLENM1         GET LENGTH-1                                 
         AHI   R4,1                                                             
         EDIT  (R4),(2,P+L'BRKNNAM+19)                                          
         GOTO1 REPORT                                                           
*                                                                               
         LA    R2,BRKNAME          TABLE OF BREAK NAMES                         
         LA    RF,BRKNAML(R2)      POINT TO THE END                             
         LA    R3,BRKL(R3)         NXT BRAKE CODE                               
         OC    BRKCODE,BRKCODE     EOT ?                                        
         BNZ   BT6C                                                             
         DROP  R2                                                               
*                                                                               
BT6K     L     R9,ABUFFC                                                        
         USING BUFFALOD,R9                                                      
*                                                                               
         MVC   BUFFLCOM,=A(SORTCMLQ)  RESET COMMENT LENGTH                      
*                                                                               
         ST    R7,SORTKLEN         ACCUMULATED KEY LENGTH                       
         A     R7,BUFFLCOM                                                      
         A     R7,BUFFLDTA                                                      
         ST    R7,SORTRLEN                                                      
         LA    R7,SORTREC                                                       
         A     R7,SORTKLEN                                                      
         ST    R7,ASORTCOM                                                      
         A     R7,BUFFLCOM                                                      
         ST    R7,ASORTDTA                                                      
*                                                                               
* THE FOLLOWING CODE WILL FORCE $ FIELDS TO BE DOUBLE WORD ALIGNED              
*                                                                               
         L     R1,ASORTDTA                                                      
         SR    R0,R0                                                            
         D     R0,=F'8'            CHK ALIGNMENT                                
         LTR   R0,R0               ANY REMAINDER                                
         BZ    BT8                 NO, FINISHED                                 
         LHI   R1,8                IF NOT DOUBLE WD,                            
         SR    R1,R0               SEE HOW MANY BYTES TO ADD                    
         LR    R0,R1                                                            
         A     R1,ASORTDTA         ADD THAT # TO ALIGN SORTDATA                 
         ST    R1,ASORTDTA                                                      
         LR    R1,R0                                                            
         A     R0,SORTRLEN         ADD TO FIX REC LEN                           
         ST    R0,SORTRLEN                                                      
         A     R1,BUFFLCOM         AND TO FIX BUFF COMMENT                      
         ST    R1,BUFFLCOM                                                      
*                                                                               
*                                  RECALCULATE MAX LINES                        
BT8      L     RF,BUFFCRMX                                                      
         M     RE,BUFFLALL                                                      
         D     RE,SORTRLEN                                                      
         ST    RF,BUFFCRMX                                                      
*                                                                               
         MVC   BUFFLIST(1),SORTKLEN+3     SET LENGTH OF KEY                     
         MVC   BUFFLKEY,SORTKLEN                                                
         MVC   BUFFLALL,SORTRLEN   SET LENGTH OF RECORD                         
         MVI   BUFFDOPT,C'Y'                                                    
         MVI   BUFFXOPT,BUFFXBIG   DON'T COMPRESS LARGE NUMBERS                 
*                                                                               
         GOTO1 BUFFALO,DMCB,=C'SET',ABUFFC                                      
         OC    NBUFFADR,NBUFFADR   HAVE WE ALREADY DONE A COVAIL?               
         BNZ   BT9                                                              
*                                                                               
         GOTO1 =V(COVAIL),DMCB,C'SETB',150000,100000,ABUFFC                     
         OC    4(4,R1),4(R1)       COVAIL ERROR?                                
         BNZ   *+6                                                              
         DC    H'0'                                                             
         MVC   ABUFFC,12(R1)       NEW BUFFALOC                                 
         MVC   NBUFFADR,4(R1)      SAVE NEW BUFFER ADDRESS                      
         MVC   NBUFFLN,8(R1)       AND LENGTH                                   
         B     BT9B                                                             
*                                                                               
BT9      DS    0H                                                               
         GOTO1 =V(COVAIL),DMCB,C'RESB',NBUFFADR,NBUFFLN,ABUFFC                  
*                                                                               
BT9B     DS    0H                                                               
         DROP  R9                                                               
*                                                                               
*                                  SET A(TOTALS)                                
         L     R3,ALOWBRK          START AT END OF BRKTAB AND BACK UP           
         LA    R0,BRKTAB                                                        
         L     R4,=A(LEVTOTS)                                                   
BT10     DS    0H                                                               
         L     RF,BRKCODE                                                       
         LA    RF,ATOTS(RF)                                                     
         ST    R4,0(RF)                                                         
         AHI   R4,TOTSIZE                                                       
         SHI   R3,BRKL                                                          
         CR    R3,R0                                                            
         BNL   BT10                                                             
*                                                                               
         OC    AINVBRK,AINVBRK     IF NO INVOICE LEVEL BREAK                    
         BNZ   *+12                ESTABLISHED                                  
         MVI   ERR,PLEVERR         RETURN ERROR                                 
         BRAS  RE,ERRPROC                                                       
*                                                                               
         CLC   AINVBRK,APMSELO                                                  
         BNH   *+10                                                             
         MVC   APMSELO,AINVBRK                                                  
         CP    MANGRS,=P'0'        IF MANUAL                                    
         BE    *+10                                                             
         XC    ARECAP,ARECAP       THEN NO RECAPS                               
         CLC   APAGBRK,AINVBRK                                                  
         BNL   *+10                                                             
         MVC   APAGBRK,AINVBRK                                                  
         OC    ARECAP,ARECAP                                                    
         BZ    *+20                                                             
         CLC   ARECAP,AINVBRK      IF RECAP OPTION IS NOT LOGICAL               
         BNL   *+10                                                             
         MVC   ARECAP,AINVBRK      SET TO INVOICE BREAK                         
*                                                                               
         MVC   SVPAGBRK,APAGBRK    SAVE PAGE LEVEL                              
         MVC   SVLOWTOG,ALOWTOG    AND LOWEST TOGETHER                          
*                                  CHANGE CONTROL FROM T TO P                   
*                                  FOR TOGETHERS ON SEPARATE PAGE               
         LA    R3,BRKTAB                                                        
         XC    AHITOG,AHITOG                                                    
BT11     DS    0H                                                               
         OC    BRKCODE,BRKCODE                                                  
         BZ    BT11D                                                            
         CLI   BRKCTL1,C'T'                                                     
         BNE   BT11B                                                            
         C     R3,APAGBRK                                                       
         BH    BT11A                                                            
         MVI   BRKCTL1,C'P'                                                     
         LA    RF,LEVCTLS                                                       
         A     RF,BRKCODE                                                       
         MVI   0(RF),C'P'                                                       
         B     BT11B                                                            
*                                                                               
BT11A    DS    0H                                                               
         OC    AHITOG,AHITOG       SAVE HIGHEST TOGETHER BREAK                  
         BNZ   *+8                                                              
         ST    R3,AHITOG                                                        
*                                                                               
BT11B    DS    0H                                                               
         LA    R3,BRKL(R3)                                                      
         B     BT11                                                             
*                                                                               
BT11D    DS    0H                                                               
         J     XIT                                                              
         SPACE 3                                                                
BTTAB    DS    0F                                                               
         B     BTPGR1                                                           
         B     BTPGR2                                                           
         B     BTPGR3                                                           
         B     BTPRD                                                            
         B     BTEST                                                            
         B     BTMGR1                                                           
         B     BTMGR2                                                           
         B     BTMGR3                                                           
         B     BTMKT                                                            
         B     BTSTA                                                            
         B     BTPKG                                                            
         B     BTPGM                                                            
         B     BTDESC                                                           
         B     BTPER                                                            
         B     BTPERG                                                           
         B     BTCTYP                                                           
         B     BTDPT                                                            
*                                                                               
         SPACE 2                                                                
BTPGR1   DS    0H                                                               
         ZIC   R4,PGR1LEN                                                       
         B     BTALL                                                            
         SPACE 2                                                                
BTPGR2   DS    0H                                                               
         ZIC   R4,PGR2LEN                                                       
         ZIC   R0,PGR1LEN                                                       
         SR    R4,R0                                                            
         B     BTALL                                                            
         SPACE 2                                                                
BTPGR3   DS    0H                                                               
         ZIC   R4,PGR3LEN                                                       
         ZIC   R0,PGR2LEN                                                       
         SR    R4,R0                                                            
         B     BTALL                                                            
         SPACE 2                                                                
BTPRD    DS    0H                                                               
         LHI   R4,3                                                             
         B     BTALL                                                            
         SPACE 2                                                                
BTEST    DS    0H                                                               
         LHI   R4,1                                                             
         B     BTALL                                                            
         SPACE 2                                                                
BTMGR1   DS    0H                                                               
         ZIC   R4,MGR1LEN                                                       
         B     BTALL                                                            
         SPACE 2                                                                
BTMGR2   DS    0H                                                               
         ZIC   R4,MGR2LEN                                                       
         ZIC   R0,MGR1LEN                                                       
         SR    R4,R0                                                            
         B     BTALL                                                            
         SPACE 2                                                                
BTMGR3   DS    0H                                                               
         ZIC   R4,MGR3LEN                                                       
         ZIC   R0,MGR2LEN                                                       
         SR    R4,R0                                                            
         B     BTALL                                                            
         SPACE 2                                                                
BTMKT    DS    0H                                                               
         LHI   R4,2                                                             
         B     BTALL                                                            
         SPACE 2                                                                
BTPER    EQU   BTEST                                                            
BTDPT    EQU   BTEST                                                            
*                                                                               
BTPERG   DS    0H                                                               
         LHI   R4,1                1 BYTE                                       
         CLI   BFRMOS,C'S'         UNLESS BILLFORM SEPARATION                   
         BNE   *+8                                                              
         LHI   R4,2                THEN 2 (2-BYTE TSAR RECORD NUMBER)           
         B     BTALL                                                            
         SPACE 2                                                                
BTPGM    DS    0H                                                               
         LHI   R4,16                                                            
         B     BTALL                                                            
         SPACE 2                                                                
BTDESC   DS    0H                                                               
         LHI   R4,6                                                             
         B     BTALL                                                            
         SPACE 2                                                                
BTPKG    DS    0H                                                               
         SR    R4,R4                                                            
         ICM   R4,1,PKGNMOPT       LENGTH FOR PKG NAME                          
         BNZ   *+8                                                              
         LHI   R4,1                                                             
         B     BTALL                                                            
         SPACE 2                                                                
BTCTYP   DS    0H                                                               
         LHI   R4,6                                                             
         B     BTALL                                                            
         SPACE 2                                                                
BTSTA    DS    0H                                                               
         LHI   R4,3                                                             
         B     BTALL                                                            
         SPACE 2                                                                
BTALL    DS    0H                                                               
         LTR   R4,R4               BYPASS = LENGTH = 0                          
         BNZ   *+10                                                             
         MVI   0(R2),C'N'                                                       
         BR    RE                                                               
*                                                                               
         CLI   0(R2),X'F0'         BYPASSED?                                    
         BL    *+14                                                             
         MVI   0(R2),C'N'          RESET FF TO N                                
         TM    2(R2),X'0F'         OK TO BYPASS?                                
         BZR   RE                  YES                                          
*                                                                               
         TM    2(R2),X'01'                                                      
         BZ    *+8                                                              
         ST    R3,APMSELO          SAVE 'LOWEST' (HIGH IN CORE)                 
*                                   OF PRODUCT,MARKET,STATION,ESTIMATE          
         TM    2(R2),X'02'                                                      
         BZ    BTALL6                                                           
         ST    R3,APEPLO           SAVE 'LOWEST' OF PRD-EST-PER                 
         OC    APEPHI,APEPHI                                                    
         BNZ   *+8                                                              
         ST    R3,APEPHI           SAVE 'HIGHEST'                               
*                                                                               
BTALL6   DS    0H                                                               
         ZIC   RF,1(R2)                                                         
         ST    RF,BRKCODE          CODE                                         
         ST    R7,BRKDISP          DISPLACEMENT = ACCUMULATED LENGTH            
         AR    R7,R4                                                            
         BCTR  R4,0                                                             
         ST    R4,BRKLENM1         LENGTH OF FIELD - 1                          
*                                                                               
         MVC   BRKCTL1,0(R2)       CONTROL BYTE                                 
*                                                                               
         ST    R3,ALOWBRK          SAVE A(LOWEST BREAK)                         
         LA    RF,ABRKS-4                                                       
         A     RF,BRKCODE                                                       
         ST    R3,0(RF)            SET A(THIS LEVEL BREAK)                      
*                                                                               
         CLI   BRKCTL1,C'T'                                                     
         BNE   BTALL7                                                           
         C     R3,APERBRK                                                       
         BE    BTALL7                                                           
         C     R3,ACTYPBRK                                                      
         BE    BTALL7                                                           
         C     R3,APGMBRK                                                       
         BE    BTALL7                                                           
         ST    R3,ALOWTOG          LOWEST 'TOGETHER' (EXC PER AND CTYP)         
*                                   (AND PGM (DESC USED INSTEAD))               
BTALL7   DS    0H                                                               
         LA    RF,ALEVS                                                         
         A     RF,BRKCODE                                                       
         LA    R0,SORTREC                                                       
         A     R0,BRKDISP                                                       
         ST    R0,0(RF)            SET A(FIELD)                                 
         LA    RF,LEVCTLS                                                       
         A     RF,BRKCODE                                                       
         MVC   0(4,RF),BRKCTL1                                                  
         CLI   0(R2),C'S'                                                       
         BNE   *+8                                                              
         ST    R3,AINVBRK          A(LEVEL FOR NEW INVOICE)                     
         CLI   0(R2),C'N'                                                       
         BE    BTALL8                                                           
         TM    2(R2),X'80'                                                      
         BZ    *+8                                                              
         ST    R3,APAGBRK          A(PAGE BREAK LEVEL)                          
         TM    2(R2),X'40'                                                      
         BZ    *+8                                                              
         ST    R3,ARECAP           A(RECAP LEVEL)                               
BTALL8   DS    0H                                                               
         LA    R3,BRKL(R3)                                                      
         BR    RE                                                               
         DROP  R3                                                               
         SPACE 3                                                                
BRKNAME  DS    0CL3                                                             
         DC    AL1(4*PGR1EQ),CL10'PGR1'                                         
         DC    AL1(4*PGR2EQ),CL10'PGR2'                                         
         DC    AL1(4*PGR3EQ),CL10'PGR3'                                         
         DC    AL1(4*PRDEQ),CL10'PRODUCT'                                       
         DC    AL1(4*ESTEQ),CL10'ESTIMATE'                                      
         DC    AL1(4*MGR1EQ),CL10'MGR1'                                         
         DC    AL1(4*MGR2EQ),CL10'MGR2'                                         
         DC    AL1(4*MGR3EQ),CL10'MGR3'                                         
         DC    AL1(4*MKTEQ),CL10'MARKET'                                        
         DC    AL1(4*STAEQ),CL10'STATION'                                       
         DC    AL1(4*PKGEQ),CL10'PACKAGE'                                       
         DC    AL1(4*PGMEQ),CL10'PROGRAM'                                       
         DC    AL1(4*DESCEQ),CL10'SPOT DESC'                                    
         DC    AL1(4*PEREQ),CL10'PERIOD'                                        
         DC    AL1(4*PERGEQ),CL10'PERIOD GRP'                                   
         DC    AL1(4*CTYPEQ),CL10'COST TYPE'                                    
         DC    AL1(4*DPTEQ),CL10'DAYPART'                                       
BRKNAML  EQU   *-BRKNAME                                                        
         SPACE 3                                                                
*                                  TABLE OF BREAK CODES AND LENGTHS             
*                                  BYTE 1 - GETS FILLED IN FROM PROFILE         
*                                  BYTE 2 - CODE                                
*                                  BYTE 3 - CONTROL GROUP                       
*                                  X'01' = PRD,ESTIMATE,MARKET,STATION          
*                                  X'02' = PRD,ESTIMATE,PERIOD                  
*                                  X'04' = NECESSARY FOR OTHER REASON           
*                                          (COST TYPE FOR NETWORK)              
BRKEQV   DS    0CL3                                                             
         DC    X'00',AL1(4*PGR1EQ),X'00'          PGR1                          
         DC    X'00',AL1(4*PGR2EQ),X'00'          PGR2                          
         DC    X'00',AL1(4*PGR3EQ),X'00'          PGR3                          
         DC    X'00',AL1(4*PRDEQ),X'03'           PRODUCT                       
         DC    X'00',AL1(4*ESTEQ),X'03'           ESTIMATE                      
         DC    X'00',AL1(4*MGR1EQ),X'00'          MGR1                          
         DC    X'00',AL1(4*MGR2EQ),X'00'          MGR2                          
         DC    X'00',AL1(4*MGR3EQ),X'00'          MGR3                          
BRKMKT   DC    X'00',AL1(4*MKTEQ),X'01'           MARKET                        
BRKSTA   DC    X'00',AL1(4*STAEQ),X'01'           STATION                       
         DC    X'00',AL1(4*PKGEQ),X'00'           PACKAGE                       
BRKPGM   DC    X'00',AL1(4*PGMEQ),X'00'           PROGRAM                       
BRKDSC   DC    X'00',AL1(4*DESCEQ),X'00'          SPOT DESC                     
         DC    X'00',AL1(4*PEREQ),X'02'           PERIOD                        
         DC    X'00',AL1(4*PERGEQ),X'00'          PERIOD GROUP                  
BRKTYP   DC    X'00',AL1(4*CTYPEQ),X'00'          COST TYPE                     
BRKDPT   DC    X'00',AL1(4*DPTEQ),X'00'           DAYPART                       
BRKEQVL  EQU   *-BRKEQV                                                         
         SPACE 3                                                                
LSTOTAB  DS    0XL2                                                             
         DC    C'WY'                                                            
         DC    C'SR'                                                            
         DC    C'CA'                                                            
         DC    X'FF'                                                            
LSTOTBL  EQU   *-LSTOTAB                                                        
         LTORG                                                                  
         EJECT                                                                  
         TITLE 'GETNUM - GET AND FORMAT INVOICE NUMBER'                         
GETNUM   NMOD1 0,GETNUM                                                         
         LA    RC,SPACEND                                                       
*                                                                               
*PARM1  BYTE  0   NON-ZERO MEANS FORMAT ONLY                                    
*       BYTES 1-3 A(CURRENT INVNO) - IF # IS NULLS READ FOR NEW                 
*PARM2  BYTES 1-3 A(INVOICE NUMBER DISPLAY)                                     
*                                                                               
         ST    R1,SAVR1                                                         
         LM    R2,R3,0(R1)                                                      
         CLI   0(R1),0                                                          
         BNE   GN32                JUST FORMAT GIVEN NUMBER                     
*                                                                               
         MVI   RCTRACE,C'N'        SUPPRESS TRACE                               
         UNPK  W(1),TODAY+1(1)     PUT YM IN ONE BYTE                           
         NI    W,X'FF'-X'0F'                                                    
         OC    W(1),TODAYB+1                                                    
         OC    0(2,R2),0(R2)                                                    
         BNZ   GN22                DON'T SEARCH FILE                            
*                                                                               
         OI    DMINBTS,X'08'       PASS DELETES, SO WE DON'T REUSE NUMS         
         MVI   DMOUTBTS,X'FF'-X'02' DELETED RECORDS ARE OK                      
*                                                                               
         XC    HALF,HALF                                                        
*                                                                               
         CLC   =C'*INVNUM',QUESTOR FORCE INVOICE NUMBER SET?                    
         BE    *+12                                                             
         CLI   PROOFSW,C'Y'        ELSE IF DRAFT BILLING                        
         BE    GN20                SKIP INVOICE NUM SEARCH                      
*                                                                               
         BAS   RE,GNOFFSET         SET TABLE FOR OFFICE CHECKING                
*                                                                               
         MVC   KEY1,KEY            PRESERVE KEY                                 
         XC    KEY,KEY                                                          
KEY@     USING BKEY,KEY                                                         
         MVC   KEY@.BKEYAM,BAGYMD  USE REQUEST MEDIA                            
         CLI   AGMSEQ,C'A'         UNLESS BY AGY                                
         BE    *+12                                                             
         CLI   AGMSEQ,C'D'         OR BY CLIENT ACROSS MEDIA                    
         BNE   *+12                                                             
         NI    KEY@.BKEYAM,X'FF'-X'0F'                                          
         OI    KEY@.BKEYAM,X'01'   ELSE, SET FIRST MEDIA                        
*                                                                               
         CLI   AGMSEQ,C'C'                                                      
         BE    GN3D                                                             
         CLI   AGMSEQ,C'D'                                                      
         BNE   GN3E                                                             
GN3D     DS    0H                                                               
         MVC   KEY@.BKEYCLT,BCLT   SET CLIENT                                   
GN3E     DS    0H                                                               
         GOTO1 HIGH                                                             
         B     GN4B                                                             
GN4      DS    0H                                                               
         GOTO1 SEQ                                                              
GN4B     DS    0H                                                               
KS       USING BKEY,KEYSAVE                                                     
         CLC   KEY@.BKEYTYPE,KS.BKEYTYPE   STARTS WITH X'00'?                   
         BNE   GN6                                                              
         CLC   KEY@.BKEYAM,KS.BKEYAM    SAME AGY/MED?                           
         BNE   GN6                                                              
         CLI   AGMSEQ,C'C'                                                      
         BE    *+12                                                             
         CLI   AGMSEQ,C'D'                                                      
         BNE   GN4D                                                             
*                                                                               
         CLC   KEY@.BKEYCLT,KS.BKEYCLT  SAME CLIENT?                            
         BNE   GN6D                                                             
         B     GN4E                                                             
         DROP  KS                                                               
*                                                                               
GN4D     DS    0H                  AGMSEQ NOT CLIENT BASED (C OR D)             
         CLI   AGMOCTL,0           DOING OFFICES?                               
         BE    GN4E                NO, OK                                       
         GOTO1 BINSRCH,CLTPARS,KEY@.BKEYAM  BAGYMD + CLIENT                     
         CLI   0(R1),1             IF IN LIST, OK                               
         BNE   GN4E                                                             
         MVI   KEY@.BKEYPRD,X'FF'  ELSE FORCE SKIP TO NEXT CLIENT               
         B     GN3E                                                             
*                                                                               
GN4E     DS    0H                                                               
         OC    INRSQYM,INRSQYM     HAVE RESEQUENCE DATE?                        
         BZ    GN5                 NO- RESEQUENCE WITHIN MONTH                  
*                                                                               
         ZIC   R4,KEY@.BKEYMBIL    BILLED YEAR/MONTH                            
         SRL   R4,4                YEAR DIGIT OF BILL                           
         ZIC   RE,DECADE                                                        
         CLM   R4,1,YEARDIG        COMPARE TO YEAR OF TODAY                     
         BNH   *+8                 IF NOT HIGH, OK                              
         SHI   RE,10               ELSE BACK UP TO PREVIOUS DECADE              
         AR    RE,R4                                                            
         STC   RE,FULL             CALCULATED YEAR OF BILL                      
*                                                                               
         MVC   FULL+1(1),KEY@.BKEYMBIL  BILLED YEAR/MONTH                       
         NI    FULL+1,X'FF'-X'F0'  ISOLATE MONTH                                
*                                                                               
         CLC   FULL(2),INRSQYM     TEST KEY VS. RESEQUENCE DATE                 
         BL    GN4                 SKIP BILLS BEFORE RESEQUENCE YM              
*                                                                               
*&&DO                                                                           
         CLI   PROFB1X+8,C'Y'      DO WE NEED DECADE TEST?                      
         BE    GN4F                YES                                          
         CLC   FULL(2),INRSQYM     NO, RETEST KEY YM                            
         BL    GN4                                                              
         BH    GN5B                                                             
         BE    GN4H                                                             
GN4F     DS    0H                  DO DECADE TEST                               
*&&                                                                             
         USING BILLREC,R7                                                       
         GOTO1 GETBILL                                                          
         L     R7,ADBILL                                                        
         CLC   BDATE,INRSQDAT      TEST FULL BILL DATE                          
         BL    GN4                                                              
         B     GN5B                                                             
*                                                                               
GN4H     DS    0H                                                               
         CLC   INRSQDA,=C'01'      IF WITHIN MONTH MUST READ BILL               
         BE    GN5B                UNLESS START DATE IS 01                      
         CLC   BKEY,KEY            ALREADY HAVE BILL RECORD?                    
         BE    GN4J                                                             
         GOTO1 GETBILL                                                          
         L     R7,ADBILL                                                        
GN4J     DS    0H                                                               
         CLC   BDATE+4(2),INRSQDA  SKIP IF BEFORE RSQ DAY                       
         BL    GN4                                                              
         B     GN5B                                                             
*                                                                               
GN5      DS    0H                  NO SPECIAL SEQUENCING                        
         CLC   KEY@.BKEYMBIL,W     YM                                           
         BNE   GN4                                                              
*&&DO                                                                           
         CLI   PROFB1X+8,C'Y'      DO WE NEED DECADE TEST...                    
         BNE   GN5B                FOR UNCLOSED-OUT 10 YEAR OLD BILLS?          
*&&                                                                             
         GOTO1 GETBILL                                                          
         L     R7,ADBILL                                                        
         CLC   BDATE(2),TODAY      COUNT ONLY THIS YEAR'S BILLS                 
         BNE   GN4                                                              
         DROP  R7                                                               
*                                                                               
GN5B     DS    0H                                                               
         L     RF,APATCH           TRACE PASSING BILLS?                         
         TM    0(RF),X'01'                                                      
         BZ    GN5F                NO                                           
         GOTO1 PRNTBL,DMCB,=C'PASSING BILL',KEY,C'DUMP',18,=C'1D'               
*                                                                               
GN5F     DS    0H                                                               
         CLC   HALF,KEY@.BKEYINV   INVOICE NO.                                  
         BNL   GN4                                                              
         MVC   HALF,KEY@.BKEYINV                                                
         B     GN4                                                              
*                                                                               
GN6      DS    0H                  END OF AGY/MEDIA                             
         CLI   AGMSEQ,C'A'         TEST BY AGENCY                               
         BE    GN7                                                              
GN6D     CLI   AGMSEQ,C'D'         OR BY CLIENT ACROSS MEDIA                    
         BNE   GN20                                                             
GN7      DS    0H                  TRY NEXT MEDIA                               
         CLI   KEY@.BKEYTYPE,0     START OF BUYS                                
         BNE   GN20                                                             
         MVC   BYTE,KEY@.BKEYAM                                                 
         NI    BYTE,X'FF'-X'0F'                                                 
         CLC   BYTE,BAGYMD                                                      
         BH    GN20                END OF AGY                                   
         CLI   AGMSEQ,C'D'         IF BY CLIENT WITHIN MEDIA                    
         BE    *+14                YES                                          
         MVC   KEYSAVE,KEY         ELSE JUST CONTINUE                           
         B     GN4B                                                             
*                                  BY CLIENT WITHIN MEDIA                       
         CLC   KEY@.BKEYCLT,BCLT   IF HAVEN'T REACHED CLIENT                    
         BL    GN3D                TRY WITHIN THIS MEDIA                        
         TM    KEY@.BKEYAM,X'0F'   ELSE, BUMP TO NEXT MEDIA                     
         BO    GN20                                                             
         ZIC   RF,KEY@.BKEYAM                                                   
         AHI   RF,1                                                             
         STC   RF,KEY@.BKEYAM                                                   
         B     GN3D                                                             
         DROP  KEY@                                                             
*                                  HAVE HIGHEST NO.                             
GN20     DS    0H                                                               
         LH    RF,HALF                                                          
         AHI   RF,1                                                             
         STH   RF,0(R2)                                                         
         CLC   0(2,R2),AGMSTANO                                                 
         BNL   *+10                                                             
         MVC   0(2,R2),AGMSTANO                                                 
         B     GN23                                                             
*                                  BUMP TO NEXT NO.                             
GN22     DS    0H                                                               
         LH    RF,0(R2)                                                         
         AHI   RF,1                                                             
         STH   RF,0(R2)                                                         
*                                  CHECK INV. NO. AGAINST SKIP RANGES           
GN23     DS    0H                                                               
         OC    AGMSKIP,AGMSKIP                                                  
         BZ    GN31                                                             
         CLC   0(2,R2),AGMSKP1S                                                 
         BL    GN31                                                             
         CLC   0(2,R2),AGMSKP1E                                                 
         BNL   GN31                                                             
         MVC   0(2,R2),AGMSKP1E                                                 
         LH    RF,0(R2)                                                         
         AHI   RF,1                                                             
         STH   RF,0(R2)                                                         
*                                                                               
GN31     DS    0H                                                               
         CLC   0(2,R2),=H'9999'    NO BILL OVER 9999                            
         BNH   GN32                                                             
         CLI   PROFB1X+10,C'Y'     UNLESS ALLOW ALPHANUMERIC INVOICES           
         BNE   *+14                                                             
         CLC   0(2,R2),=H'16000'   THEN NO BILL OVER 16,000                     
         BNH   *+10                                                             
*                                                                               
         MVI   INV#ERR,C'Y'        REMEMBER THAT WE DIED HERE                   
         DC    H'0'                                                             
*                                  FORMAT INVOICE NUMBER                        
*        NOTE- SPFMTINO REPLACES OLD INVOICE FORMATTING CODE                    
GN32     DS    0H                                                               
         MVC   GNWORK,TODAYB       SET BY CALLER, NOT ALWAYS TODAY              
         NI    W,X'FF'-X'F0'       ISOLATE MONTH IN W                           
         MVC   GNWORK+1(1),W                                                    
         MVI   GNWORK+2,X'01'      DAY=01 FOR GOOD MEASURE                      
         GOTO1 DATCON,DMCB,(3,GNWORK),W                                         
*                                                                               
         GOTO1 =V(SPFMTINO),DMCB,W,(2,(R2)),(QMED,PROFB1),PROFB1X               
         L     RF,DMCB             A(FULL INVOICE NUMBER)                       
         MVC   0(10,R3),0(RF)                                                   
*******  L     RF,DMCB+8           A(MONTH)                                     
*******  MVC   SVINVMO,0(RF)                                                    
         L     RF,DMCB+4           A(INV NUMBER) MN-NNNN                        
         MVC   SVINVMO(2),0(RF)    DON'T NEED THE DASH                          
         MVC   SVINVMO+2(4),3(RF)                                               
*                                                                               
         NI    DMINBTS,X'FF'-X'08' NO LONGER PASS DELETES                       
         MVI   DMOUTBTS,X'FF'      NO DATAMGR ERRORS ARE ACCEPTABLE             
         MVC   RCTRACE,SAVTRACE                                                 
*                                                                               
         J     XIT                                                              
         EJECT                                                                  
***********************************************************************         
*                                                                               
*        GNOFFSET - SET FOR OFFICE CHECKING                                     
*                                                                               
*              NOTE - MULTI-MEDIA CODE TAKEN FROM SPOT                          
*                     BUT NOT REALLY USED HERE (SEE GNMEDLST)                   
***********************************************************************         
         SPACE 2                                                                
GNOFFSET NTR1                                                                   
*                                                                               
         XC    CLTPARSN,CLTPARSN   CLEAR CLIENT TABLE                           
         CLI   AGMOCTL,0           ANY OFFICE CHECKING                          
         BE    GNOSX               NO, DONE                                     
         XC    WK,WK               CLEAR LIST OF OFFICES                        
         LA    R4,DUB              START OF MEDIA LIST                          
*                                                                               
         MVC   DUB,BAGYMD          DO JUST THIS MEDIA                           
         MVI   DUB+1,X'FF'                                                      
         CLI   AGMSEQ,C'A'         IF NOT SEQUENCING BY AGENCY                  
         BNE   GNOS2                                                            
         MVC   DUB,GNMEDLST        ELSE DO ALL MEDIA                            
         LHI   RF,L'GNMEDLST-1     BUILD LIST OF BAGYMD'S                       
         LA    R1,DUB                                                           
         MVC   BYTE,BAGYMD                                                      
         NI    BYTE,X'FF'-X'0F'    ISOLATE AGENCY                               
         OC    0(1,R1),BYTE                                                     
         LA    R1,1(R1)                                                         
         BCT   RF,*-10                                                          
*                                                                               
GNOS2    DS    0H                                                               
         LHI   R3,16               BCT COUNTER FOR OFFICE LIST                  
         CLI   AGMOCTL,C'*'        OFFICE SEQUENCING?                           
         BNE   GNOS4                                                            
         L     R2,ADCLT                                                         
         MVC   WK(1),COFFICE-CLTHDR(R2)  SET THIS OFFICE IN LIST                
         B     GNOS6                                                            
*                                                                               
GNOS4    XC    WK,WK               IF NOT 0 OR *, SHOULD BE OFFICE LIST         
         XC    WORK,WORK           READ '$X' PROFILE                            
         LA    RF,WORK                                                          
         USING PROFKD,RF                                                        
         MVI   PROFKSYS,C'S'                                                    
         MVC   PROFKPGM(2),=C'0$'                                               
         MVC   PROFKPGM+2(L'AGMOCTL),AGMOCTL   OFFICE LIST CODE                 
         MVC   PROFKAGN,AGY                                                     
         MVC   PROFKMED,MED                                                     
         DROP  RF                                                               
         GOTO1 GETPROF,DMCB,(X'A0',WORK),WK,DATAMGR,,WORK+16                    
         GOTOR PRNTPROF,DMCB,WORK,WK,WORK+16                                    
*                           SEE IF THERE'S AN EXTENSION TO THAT PROF            
         DS    0H                                                               
         XC    WORK,WORK       READ '$XA' PROFILE EXTENSION                     
         LA    RF,WORK                                                          
         USING PROFKD,RF                                                        
         MVI   PROFKSYS,C'S'-X'40' LOWER-CASE 'S'                               
         MVC   PROFKPGM(3),=C'$ A'                                              
         MVC   PROFKPGM+1(L'AGMOCTL),AGMOCTL   OFFICE LIST CODE                 
         MVC   PROFKAGN,AGY                                                     
         MVC   PROFKMED,MED                                                     
         DROP  RF                                                               
         GOTO1 GETPROF,DMCB,(X'A0',WORK),WK+16,DATAMGR,,WORK+16                 
         LA    R5,WK+16                                                         
         OC    WK+16(PROFINFL),WK+16   DOES THE PROFILE EXIST?                  
         BZ    GNOS5                                                            
         GOTOR PRNTPROF,DMCB,WORK,WK+16,WORK+16                                 
         LA    R5,WK+32                                                         
         AHI   R3,16               ADD ANOTHER 16 POSSIBLE OFFICES              
*                                                                               
GNOS5    DS    0H                                                               
         XC    WORK,WORK       READ '$XB' PROFILE EXTENSION                     
         LA    RF,WORK                                                          
         USING PROFKD,RF                                                        
         MVI   PROFKSYS,C'S'-X'40' LOWER-CASE 'S'                               
         MVC   PROFKPGM(3),=C'$ B'                                              
         MVC   PROFKPGM+1(L'AGMOCTL),AGMOCTL   OFFICE LIST CODE                 
         MVC   PROFKAGN,AGY                                                     
         MVC   PROFKMED,MED                                                     
         DROP  RF                                                               
         GOTO1 GETPROF,DMCB,(X'A0',WORK),(R5),DATAMGR,,WORK+16                  
         OC    0(PROFINFL,R5),0(R5)   DOES THE PROFILE EXIST?                   
         BZ    GNOS6                                                            
         GOTOR PRNTPROF,DMCB,WORK,(R5),WORK+16                                  
         AHI   R3,16               ADD ANOTHER 16 POSSIBLE OFFICES              
*                                                                               
GNOS6    DS    0H                  READ OFFC/CLT PASSIVES FOR EACH OFFC         
         LA    R2,WK               LIST OF OFFICES                              
         MVI   BYTE2,0             CLIENT OFFICE NOT YET SEEN IN LIST           
*                                                                               
GNOS8    DS    0H                                                               
         CLI   0(R2),0             NOT AN OFFICE                                
         BE    GNOS12                                                           
         CLI   0(R2),C'0'          NOT AN OFFICE                                
         BE    GNOS12                                                           
*                                                                               
         L     RF,ADCLT                                                         
         CLC   COFFICE-CLTHDR(,RF),0(R2) IS THIS THE CLIENT OFFICE?             
         BNE   *+8                                                              
         MVI   BYTE2,1             YES: IT'S IN THE LIST                        
*                                                                               
         XC    KEY,KEY                                                          
KEY@     USING CLTPHDR,KEY                                                      
         MVI   KEY@.CPKEYTYP,CPKEYTYQ   OFFICE/CLIENT PASSIVES                  
         MVI   KEY@.CPKEYSUB,CPKEYSBQ                                           
         MVC   KEY@.CPKEYAM,0(R4)       AGENCY/MEDIA                            
         MVC   KEY@.CPKEYOFF,0(R2)      OFFICE CODE                             
         GOTO1 HIGH                                                             
         B     GNOS10B                                                          
*                                                                               
GNOS10   DS    0H                                                               
         GOTO1 SEQ                                                              
GNOS10B  DS    0H                                                               
         CLC   KEY(10),KEYSAVE                                                  
         BNE   GNOS12                                                           
         MVC   FULL(L'CPKEYAM),KEY@.CPKEYAM      AGENCY/MEDIA                   
         MVC   FULL+1(L'CPKEYCLT),KEY@.CPKEYCLT  CLIENT                         
         GOTO1 BINSRCH,CLTPARS,(1,FULL)                                         
         OC    1(3,R1),1(R1)                                                    
         BNZ   GNOS10              NEXT POINTER                                 
         DC    H'0'                CLIENT TABLE FULL                            
*                                                                               
GNOS12   DS    0H                                                               
         LA    R2,1(R2)            NEXT OFFICE                                  
         BCT   R3,GNOS8                                                         
*                                                                               
         CLI   BYTE2,1             IS CLIENT OFFICE IN OFFICE LIST?             
         BE    *+12                YES                                          
         MVI   ERR,OFFCERR         NO: INVALID PROFILE SETUP                    
         BRAS  RE,ERRPROC                                                       
*                                                                               
         LA    R4,1(R4)            NEXT MEDIA                                   
         CLI   0(R4),X'FF'                                                      
         BNE   GNOS2                                                            
         DROP  KEY@                                                             
*                                                                               
GNOSX    DS    0H                                                               
         J     XIT                                                              
*                                                                               
GNMEDLST DC    XL2'03FF'           MEDIA LIST (NETWORK ONLY)                    
         SPACE 2                                                                
         LTORG                                                                  
         TITLE 'AGMPROC - HANDLE AGENCY/MEDIA PROFILE'                          
AGMPROC  NMOD1 0,AGMPROC                                                        
         LA    RC,SPACEND                                                       
*                                                                               
         XC    PROFB1X,PROFB1X     FIRST GET EXTENSION PROFILE                  
         XC    WORK,WORK                                                        
         LA    R5,WORK                                                          
         USING PROFKD,R5                                                        
         MVI   PROFKSYS,C'S'-X'40' LOWER-CASE 'S'                               
         MVC   PROFKPGM,=C'B1X'                                                 
         MVC   PROFKAGN,AGY                                                     
         MVC   PROFKMED,MED                                                     
*                                                                               
         CLI   MEDFILT,C' '                                                     
         BNH   *+10                IF SUB-MEDIA FILTER IS PRESENT...            
         MVC   PROFKMED,MEDFILT    READ PROFILE FOR IT                          
*                                                                               
         MVC   PROFKCLI,CLIENT                                                  
         L     R4,ADCLT                                                         
         USING CLTHDR,R4                                                        
         MVI   PROFKOI2,C'*'       SET OFFICE CODE                              
         MVC   PROFKOCD,COFFICE                                                 
         GOTO1 GETPROF,DMCB,(X'A0',WORK),PROFB1X,DATAMGR,,WORK+16               
         GOTOR PRNTPROF,DMCB,WORK,PROFB1X,WORK+16                               
*                                                                               
         XC    PROFB1S,PROFB1S     GET SB1S PROFILE (SYSTEMS ONLY)              
         MVI   PROFKSYS,C'S'-X'40' LOWER-CASE 'S'                               
         MVC   PROFKPGM,=C'B1S'                                                 
         GOTO1 GETPROF,DMCB,(X'E0',WORK),PROFB1S,DATAMGR,,WORK+16               
         GOTOR PRNTPROF,DMCB,WORK,PROFB1S,WORK+16                               
*                                                                               
*******  CLI   PROFB1X+10,0        MAXLINES OVERRIDE?                           
*******  BNH   *+10                                                             
*******  MVC   MAXLINES,PROFB1X+10                                              
*                                                                               
         XC    INRSQYM,INRSQYM     CLEAR INVOICE NO.                            
         XC    INRSQDA,INRSQDA     CLEAR RESEQUENCE DATE                        
         OC    PROFB1X(3),PROFB1X                                               
         BZ    AGMP3                                                            
*                                                                               
         GOTO1 DATCON,DMCB,(3,PROFB1X),INRSQDAT   FULL DATE                     
         GOTO1 DATCON,DMCB,INRSQDAT,INRSQDAT                                    
         GOTO1 DATCON,DMCB,INRSQDAT,(3,PROFB1X)                                 
         MVC   INRSQYM,PROFB1X                                                  
*                                                                               
         OC    INRSQYM,INRSQYM                                                  
         BZ    AGMP3                                                            
*                                                                               
         ZIC   R0,PROFB1X+2        DAY                                          
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  INRSQDA,DUB                                                      
*                                                                               
AGMP3    DS    0H                                                               
*                                  READ B1 PROFILE                              
         XC    WORK,WORK                                                        
         MVI   PROFKSYS,C'S'                                                    
         MVC   PROFKPGM,=C'OB1'                                                 
         MVC   PROFKAGN,AGY                                                     
         MVC   PROFKMED,MED        MEDIA                                        
*                                                                               
         CLI   MEDFILT,C' '                                                     
         BNH   *+10                IF SUB-MEDIA FILTER IS PRESENT...            
         MVC   PROFKMED,MEDFILT    READ PROFILE FOR IT                          
*                                                                               
         MVC   PROFKCLI,CLIENT                                                  
         MVI   PROFKOI2,C'*'       SET OFFICE CODE                              
         MVC   PROFKOCD,COFFICE                                                 
         GOTO1 GETPROF,DMCB,(X'A0',WORK),PROFB1,DATAMGR,,WORK+16                
         GOTOR PRNTPROF,DMCB,WORK,PROFB1,WORK+16                                
         MVC   W(16),PROFB1                                                     
         DROP  R5                                                               
*                                                                               
*                                  MEDIA EXP                                    
*                                  *=BLANK, **=USE MEDIA CODE                   
         CLI   W+2,C'*'                                                         
         BNE   *+8                                                              
         MVI   W+2,C' '                                                         
         CLI   W+3,C'*'                                                         
         BNE   *+8                                                              
         MVI   W+3,C' '                                                         
         CLC   W+2(2),SPACES                                                    
         BNE   *+10                                                             
         MVC   W+2(L'MED),MED                                                   
*                                                                               
         MVC   AGMEXP,W+2          MEDIA EXP                                    
         MVC   AGMFMT,W+4          FORMAT                                       
         MVC   AGMSEQ,W+5          SEQUENCE CONTROL                             
*                                                                               
         MVC   AGMOCTL,W+9         OFFICE CONTROL                               
         CLI   AGMOCTL,C'0'        ZERO IS NO OFFICE CHECK                      
         BNE   *+8                                                              
         MVI   AGMOCTL,0           SET 0 TO NULL                                
         CLI   AGMOCTL,C'*'        * IS OK                                      
         BE    *+16                                                             
         CLI   AGMOCTL,C'A'        LOWER THAN A MAY BE LEFT                     
         BNL   *+8                 OVER FROM EARLIER USE                        
         MVI   AGMOCTL,0           SET TO NULL                                  
*                                                                               
         MVC   AGMCLOPT,W+12       OPTION FOR 1 CLIENT/PAGE ON REGISTER         
         MVC   AGMFORMS,W+13       PAPER TYPE (D=DDS)                           
         MVC   AGMCLNO,W+14        CLIENT INTERFACE NO. OPTION                  
         MVC   AGMTITL,W+10                                                     
*                                  START NO. AND SKIPS                          
         LA    R2,W+6                                                           
         LA    R3,AGMSTANO                                                      
         LHI   R0,3                                                             
AGMP4    DS    0H                                                               
         ZIC   RF,0(R2)                                                         
         MHI   RF,100                                                           
         STH   RF,0(R3)                                                         
         LA    R2,1(R2)                                                         
         LA    R3,2(R3)                                                         
         BCT   R0,AGMP4                                                         
*                                                                               
         OC    AGMSTANO,AGMSTANO                                                
         BNZ   *+8                                                              
         MVI   AGMSTANO+1,1        START AT 1 NOT ZERO                          
         LH    RF,AGMSKP1E         ADJUST END OF RANGES                         
         LTR   RF,RF                                                            
         BZ    *+12                                                             
         AHI   RF,99                                                            
         STH   RF,AGMSKP1E                                                      
*                                                                               
         CLI   W+11,C'Y'           INTERFACE OPTION                             
         BNE   *+6                                                              
         DC    H'0'                DEIS SAYS THIS OPTION ISN'T USED             
*                                                                               
         J     XIT                                                              
         DROP  R4                                                               
         SPACE 3                                                                
         LTORG                                                                  
         TITLE 'SETDATE - MASSAGE QSTART + QEND'                                
SETDATE  NMOD1 0,SETDATE                                                        
         LA    RC,SPACEND                                                       
*                                  READ B2 PROFILE                              
         XC    WORK,WORK                                                        
         LA    R5,WORK                                                          
         USING PROFKD,R5                                                        
         MVI   PROFKSYS,C'S'                                                    
         MVC   PROFKPGM,=C'OB2'                                                 
         MVC   PROFKAGN,AGY                                                     
         MVC   PROFKMED,MED                                                     
*                                                                               
         CLI   MEDFILT,C' '                                                     
         BNH   *+10                IF SUB-MEDIA FILTER IS PRESENT...            
         MVC   PROFKMED,MEDFILT    READ PROFILE FOR IT                          
*                                                                               
         MVC   PROFKCLI,CLIENT                                                  
         L     RF,ADCLT                                                         
         LA    RF,COFFICE-CLTHDR(,RF)                                           
         MVI   PROFKOI2,C'*'       SET OFFICE CODE                              
         MVC   PROFKOCD,0(RF)                                                   
         GOTO1 GETPROF,DMCB,(X'A0',WORK),PROFB2,DATAMGR,,WORK+16                
         GOTOR PRNTPROF,DMCB,WORK,PROFB2,WORK+16                                
*                                                                               
*                                  READ TYPE PROFILE INTO PROFB4                
         MVC   PROFKPGM+2(L'TYPE),TYPE                                          
         GOTO1 GETPROF,DMCB,(X'A0',WORK),PROFB4,DATAMGR,,WORK+16                
         GOTOR PRNTPROF,DMCB,WORK,PROFB4,WORK+16                                
         OC    PROFB4,PROFB4                                                    
         BNZ   *+12                                                             
         MVI   ERR,TYPERR          NO PROFILE                                   
         BRAS  RE,ERRPROC                                                       
*                                  READ TYPE PROFILE EXT INTO PROFB4A           
         XC    PROFB4A,PROFB4A                                                  
         MVI   PROFKSYS,C'S'-X'40' LOWER-CASE 'S'                               
         MVC   PROFKPGM,=C'B A'                                                 
         MVC   PROFKPGM+1(L'TYPE),TYPE                                          
         GOTO1 GETPROF,DMCB,(X'A0',WORK),PROFB4A,DATAMGR,,WORK+16               
         GOTOR PRNTPROF,DMCB,WORK,PROFB4A,WORK+16                               
*                                                                               
         MVC   PCTCTL,PROFB4A+0    PERCENTAGE BILLING CONTROL OPTION            
         CLI   PCTCTL,C' '                                                      
         BH    *+8                                                              
         MVI   PCTCTL,C'P'         DEFAULT IS TAKE % OF PREVIOUS                
*                                                                               
         XC    PROFBN,PROFBN                                                    
         MVI   DPTSEP,C'N'                                                      
         CLI   PROFB2+9,C'0'       COST TYPE CONTROL (OLD POSITION)             
         BNE   *+8                                                              
         MVI   PROFB2+9,0                                                       
         CLI   PROFB2+9,0                                                       
         BNE   *+8                                                              
         MVI   PROFB2+9,C'N'       FORCE TO LUMP                                
         MVC   TICTL,PROFB2+9                                                   
         MVC   SPCLCTL,PROFB2+9                                                 
         CLI   QMED,C'N'                                                        
         BNE   SETD24                                                           
         CLI   NETOPT,C'O'                                                      
         BE    SETD24                                                           
*                                  TRY FOR NETWORK PROFILE                      
         MVI   PROFKSYS,C'S'-X'40' LOWER-CASE 'S'                               
         MVC   PROFKPGM,=C'B N'                                                 
         MVC   PROFKPGM+1(L'TYPE),TYPE  LOOK FIRST FOR SB4N - SB7N              
SETD02   DS    0H                                                               
         GOTO1 GETPROF,DMCB,(X'A0',WORK),PROFBN,DATAMGR,,WORK+16                
         GOTOR PRNTPROF,DMCB,WORK,PROFBN,WORK+16                                
         CLI   PROFBN+15,C'Y'      IGNORE THIS PROFILE?                         
         BNE   *+10                                                             
         XC    PROFBN,PROFBN                                                    
         OC    PROFBN,PROFBN       DID WE FIND ANYTHING                         
         BNZ   SETD02B                                                          
         CLI   PROFKSYS,C'S'       UNLESS WE WERE LOOKING FOR BN                
         BNE   *+14                                                             
         CLC   PROFKPGM,=C'OBN'                                                 
         BE    SETD02B                                                          
         MVI   PROFKSYS,C'S'       TRY FOR IT NOW                               
         MVC   PROFKPGM,=C'OBN'                                                 
         B     SETD02                                                           
*                                                                               
SETD02B  DS    0H                                                               
         CLI   PROFBN+8,C'*'       TIME/INTEGRATION CONTROL                     
         BNH   *+10                                                             
         MVC   TICTL,PROFBN+8                                                   
         CLI   PROFBN+9,C'*'       SPECIAL CHARGE CONTROL                       
         BNH   *+10                                                             
         MVC   SPCLCTL,PROFBN+9                                                 
         CLI   DPTFILT,C' '        IF HAVE DPTFILT DON'T SET DPTSEP             
         BH    SETD02F             (SEEMS SAFER TO LEAVE AS IS)                 
         MVC   DPTSEP,PROFBN+12    DAYPART CONTROL (S=SEPARATE, N=NO,           
         OC    DPTSEP,DPTSEP                               T=TOGETHER)          
         BNZ   *+8                                                              
         MVI   DPTSEP,C'N'         IF ZERO PUT IN DEFAULT                       
*                                                                               
SETD02F  CLI   CTYPQ,C' '          ANY COST TYPE REQUESTED?                     
         BNE   SETD03              YES, OK                                      
         MVC   CTYPQ,PROFBN+10     NO, SET DEFAULT FROM PROFILE                 
         CLI   CTYPQ,C'A'          IF NULL, *, ETC                              
         BNL   *+8                                                              
         MVI   CTYPQ,C'3'          SET TO 'ALL TYPES'                           
*                                                                               
SETD03   DS    0H                                                               
         CLI   CTYPQ,C'3'          IF DOING ALL TYPES                           
         BNE   SETD03B             THEN T/1 AND SPECIAL CONTROL                 
         CLC   PROFBN+8(1),PROFBN+9   MUST BE EQUAL                             
         BE    SETD03B                                                          
         MVI   ERR,COSTPERR                                                     
         BRAS  RE,ERRPROC                                                       
*                                                                               
SETD03B  DS    0H                                                               
         XC    PROFBNX,PROFBNX     BNX PROFILE                                  
         MVI   PROFKSYS,C'S'-X'40' LOWER-CASE 'S'                               
         MVC   PROFKPGM,=C'BNX'                                                 
         GOTO1 GETPROF,DMCB,(X'A0',WORK),PROFBNX,DATAMGR,,WORK+16               
         GOTOR PRNTPROF,DMCB,WORK,PROFBNX,WORK+16                               
*                                                                               
         MVC   PKGNMOPT,PROFBNX+2  PACKAGE NAME OPTION                          
         MVC   ZLOPT,PROFBNX+3     ZERO LINE OPTION                             
*                                  FOR SPOT IS PROFB2+10)                       
*                                                                               
SETD24   DS    0H                  READ B3 PROFILE FOR DATE CONTROLS            
         MVI   PROFKSYS,C'S'                                                    
         MVC   PROFKPGM,=C'OB3'                                                 
         GOTO1 GETPROF,DMCB,(X'A0',WORK),X,DATAMGR,,WORK+16                     
         GOTOR PRNTPROF,DMCB,WORK,X,WORK+16                                     
         OC    X(16),X             ANY PROFILE?                                 
         BZ    *+16                NO                                           
         MVC   SPOTPROF+2(1),X     REPLACE CALENDAR VALUES                      
         MVC   SPOTPROF+6(3),X+1                                                
*                                                                               
         CLI   SPOTPROF+2,0        IF BROADCAST-BASED...                        
         BNE   *+8                 ... DISABLE BROADCAST/CALENDAR MIX           
         MVI   PROFBN+13,C'N'      (IT DOESN'T WORK AND ISN'T NEEDED)           
*                                                                               
*                                  TRY FOR RETAIL PROFILE - B9                  
         MVI   FCGETSTA,C'N'       DON'T GET STATIONS IF NOT RETAIL             
         XC    PROFB9,PROFB9                                                    
         MVI   PROFKSYS,C'S'                                                    
         MVC   PROFKPGM,=C'OB9'                                                 
         GOTO1 GETPROF,DMCB,(X'A0',WORK),PROFB9,DATAMGR,,WORK+16                
         GOTOR PRNTPROF,DMCB,WORK,PROFB9,WORK+16                                
*                                                                               
         CLI   PROFB9+13,C'Y'      FOR BACKER STATION SPECIAL                   
         BNE   *+8                                                              
         MVI   FCGETSTA,C'Y'       NEED STATIONS                                
*                                                                               
         OC    PROFB1X+14(2),PROFB1X+14                                         
         BZ    SETD25C                                                          
         MVC   FULL(2),PROFB1X+14  Y2K STUFF FOR INVNO YM                       
         MVI   FULL+2,1                                                         
         GOTO1 DATCON,DMCB,(3,FULL),(0,DUB)                                     
         GOTO1 DATCON,DMCB,(0,DUB),(3,FULL)                                     
         MVC   PROFB1X+14(2),FULL                                               
*                                                                               
SETD25C  DS    0H                                                               
         MVC   XPEROPT,PROFB1X+7   CROSS PERIOD BILLING                         
         MVC   SPLITOPT,PROFB1X+5                                               
         CLI   SPLITOPT,C' '                                                    
         BH    *+8                                                              
         MVI   SPLITOPT,C'N'                                                    
         CLI   SPLITOPT,C'N'                                                    
         BE    SETD25B2                                                         
         CLC   =C'ALL',QPRD        FOR SPLITS, PRODUCT MUST BE ALL              
         BE    SETD25B2                                                         
         MVI   ERR,SPLTERR                                                      
         BRAS  RE,ERRPROC                                                       
*                                                                               
SETD25B2 DS    0H                                                               
         XC    PROFB1A,PROFB1A     B1A PROFILE                                  
         MVI   PROFKSYS,C'S'-X'40' LOWER-CASE 'S'                               
         MVC   PROFKPGM,=C'B1A'                                                 
         GOTO1 GETPROF,DMCB,(X'A0',WORK),PROFB1A,DATAMGR,,WORK+16               
         GOTOR PRNTPROF,DMCB,WORK,PROFB1A,WORK+16                               
*                                                                               
         XC    PROFB2A,PROFB2A     AOR PROFILE                                  
         MVI   PROFKSYS,C'S'-X'40' LOWER-CASE 'S'                               
         MVC   PROFKPGM,=C'B2A'                                                 
         GOTO1 GETPROF,DMCB,(X'A0',WORK),PROFB2A,DATAMGR,,WORK+16               
         GOTOR PRNTPROF,DMCB,WORK,PROFB2A,WORK+16                               
*                                                                               
         MVI   AORLOPT,C'N'                                                     
         MVC   AORSW,PROFB2A+0                                                  
         CLI   PROFBN+3,C'D'       IF DOING ACT MINUS ASS PLUS INT              
         BE    *+12                                                             
         CLI   PROFBN+3,C'E'       IF DOING ACTUAL MINUS ASSIGNED               
         BNE   *+8                                                              
         MVI   AORSW,C'N'          NO AOR                                       
         CLI   AORSW,C'Y'                                                       
         BNE   *+10                                                             
         MVC   AORLOPT,PROFB2A+1                                                
         CLI   AORLOPT,C' '                                                     
         BH    *+8                                                              
         MVI   AORLOPT,C'N'                                                     
*                                                                               
         XC    PROFB2B,PROFB2B     GET B2 EXT PROFILE (B2B)                     
         MVI   PROFKSYS,C'S'-X'40' LOWER-CASE 'S'                               
         MVC   PROFKPGM,=C'B2B'                                                 
         GOTO1 GETPROF,DMCB,(X'A0',WORK),PROFB2B,DATAMGR,,WORK+16               
         GOTOR PRNTPROF,DMCB,WORK,PROFB2B,WORK+16                               
         DROP  R5                                                               
*                                                                               
         MVC   SCBOPT,PROFB2B+0    'TRUE' (SCB) SEPARATE COMMISSION OPT         
         MVI   SCBNCSW,0                                                        
         CLI   SCBOPT,C'Y'         IF ON                                        
         BNE   SETD25B4                                                         
         MVC   SCBNCSW,QOPT5+1                                                  
         CLI   QOPT5+1,C'C'        MUST HAVE BILL TYPE (C=COMMISSION)           
         BE    SETD25B4                                                         
         CLI   QOPT5+1,C'N'        (N=NET)                                      
         BE    SETD25B4                                                         
         CLI   QOPT5+1,C'R'        (R=REGULAR, NO SEPARATE COMMISSION)          
         BE    SETD25B4                                                         
*                                                                               
         MVI   ERR,SCBERR                                                       
         BRAS  RE,ERRPROC                                                       
*                                                                               
SETD25B4 DS    0H                                                               
         MVC   NCOMOPT,PROFBN+5    NETWORK COMMENT OPTION                       
         CLI   NCOMOPT,C' '                                                     
         BH    *+8                                                              
         MVI   NCOMOPT,C'N'                                                     
         MVC   FORMBOPT,PROFBN+7   BILL FORMULA BASIS OPTION                    
         CLI   FORMBOPT,0          DEFAULT IS A=ALL CHARGE TYPES                
         BNE   *+8                                                              
         MVI   FORMBOPT,C'A'                                                    
*                                                                               
         MVC   BFROPT,PROFB1X+11   OPTION TO READ NEW FORMULA RECS              
         CLI   PROFB4A+10,C'Y'     DIFFR BILL FORM FOR TIME & INT ?             
         BE    *+12                YES, MAKE 'N' IN ORDER TO HAVE BOTH          
         CLI   BFROPT,C' '                                    FORMULAS          
         BH    *+8                                                              
         MVI   BFROPT,C'N'                                                      
*                                                                               
         MVC   BFRMOS,PROFB1X+12   MOS OPTION FOR NEW FORMULA RECS              
         CLI   BFRMOS,C' '                                                      
         BH    *+8                                                              
         MVI   BFRMOS,C'N'                                                      
*                                                                               
*                                  INVOICE DATE                                 
         LA    R4,QINVDATE         FROM 2ND REQUEST CARD                        
         CLI   QINVDATE,C' '                                                    
         BH    *+8                                                              
         LA    R4,TODAY            ELSE USE TODAY                               
*                                                                               
         MVC   EINVDTE,0(R4)                                                    
         GOTO1 DATCON,DMCB,(R4),(5,PINVDTE)                                     
         GOTO1 DATCON,DMCB,(R4),(3,BINVDTE)                                     
         GOTO1 DATCON,DMCB,(R4),(2,BINVDTEP)                                    
*                                  DUE DATE CALCULATION                         
         CLI   QDUEDAYS,C' '                                                    
         BNH   SETD26                                                           
         PACK  DUB,QDUEDAYS                                                     
         CVB   R0,DUB                                                           
         STC   R0,BYTE                                                          
         B     SETD28                                                           
*                                                                               
SETD26   DS    0H                                                               
         MVC   BYTE,PROFB2                                                      
*                                                                               
SETD28   DS    0H                                                               
         MVC   PDUEDTE,SPACES                                                   
         MVC   EDUEDTE,SPACES                                                   
         XC    BDUEDTE,BDUEDTE                                                  
         XC    BDUEDTEP,BDUEDTEP                                                
         MVC   PSHPDTE,SPACES                                                   
         CLI   BYTE,0                                                           
         BE    SETD30              IF NO DUE DATE, NO SHIP DATE                 
*                                                                               
         ZIC   R0,BYTE                                                          
         GOTO1 ADDAY,DMCB,EINVDTE,EDUEDTE,(R0)                                  
         GOTO1 DATCON,DMCB,EDUEDTE,(5,PDUEDTE)                                  
         GOTO1 DATCON,DMCB,EDUEDTE,(3,BDUEDTE)                                  
         GOTO1 DATCON,DMCB,EDUEDTE,(2,BDUEDTEP)                                 
*                                                                               
         MVC   BYTE,PROFB2B+3      SHIPPING DATE CONTROL                        
         CLI   BYTE,0                                                           
         BE    SETD30                                                           
         ZIC   R0,BYTE                                                          
         LCR   R0,R0               BACK UP N DAYS                               
         GOTO1 ADDAY,DMCB,EDUEDTE,WORK,(R0)                                     
         GOTO1 DATCON,DMCB,WORK,(5,PSHPDTE)                                     
*                                                                               
SETD30   DS    0H                                                               
         CLI   PROFB2+8,C'4'                                                    
         BL    SETD30A                                                          
         CLC   TYPE,PROFB2+8       VALID BILLING TYPE?                          
         BNH   SETD30A                                                          
         MVI   ERR,TYPERR                                                       
         BRAS  RE,ERRPROC                                                       
*                                                                               
SETD30A  DS    0H                                                               
         MVC   TESTFLAG,PROFB2+7   USE TEST OPT ONLY IF NOT SET IN REQ.         
         CLI   PROOFSW,C'Y'        PROOF BILLING IS ALWAYS TEST                 
         BNE   *+8                                                              
         MVI   TESTFLAG,C'T'                                                    
         MVI   ADJSEP,C'Y'         SEPARATE ADJUSTMENT INVOICE                  
         CLI   PROFB2+3,C'Y'                                                    
         BE    *+8                                                              
         MVI   ADJSEP,C'N'                                                      
*                                                                               
         CLI   PROFB2+3,C'A'       AOR                                          
         BNE   *+8                 (ALSO SET BY PROFB2A+0)                      
         MVI   AORSW,C'Y'                                                       
         CLI   PROFBN+3,C'D'       IF DOING ACT MINUS ASS PLUS INT              
         BE    *+12                                                             
         CLI   PROFBN+3,C'E'       IF DOING ACTUAL MINUS ASSIGNED               
         BNE   *+8                                                              
         MVI   AORSW,C'N'          NO AOR                                       
*                                                                               
         CLI   AORLOPT,C'C'        IF AOR                                       
         BNE   SETD30A4            'CLIENT LIST' MODE                           
         CLI   ADJSEP,C'Y'         SEPARATE ADJ. INVOICE IS NOT GOOD            
         BE    SETD30A3                                                         
         CLI   TICTL,C'S'          SO IS SEPARATE COST TYPES                    
         BE    SETD30A3                                                         
         CLI   SPCLCTL,C'S'                                                     
         BE    SETD30A3                                                         
         CLI   DPTSEP,C'S'         AND SEPARATE DAYPARTS                        
         BNE   SETD30A4                                                         
*                                                                               
SETD30A3 DS    0H                                                               
         MVI   ERR,AORPERR                                                      
         BRAS  RE,ERRPROC                                                       
*                                                                               
SETD30A4 DS    0H                                                               
         MVI   STRIPOPT,C'Y'       SET TO DO STRIP COLUMN                       
         CLI   PROFB4A+8,C'N'      ELSE Y OR N FROM B4-7A PROFILE               
         BNE   *+8                                                              
         MVI   STRIPOPT,C'N'                                                    
*                                                                               
         MVC   BOXNO,PROFB2+4                                                   
         MVC   PAYOPT,PROFB4+10                                                 
         MVC   TAXOPT,PROFB2+12                                                 
         CLI   TAXOPT,0                                                         
         BNE   *+8                                                              
         MVI   TAXOPT,C'N'                                                      
*                                                                               
         CLI   QPRIORMD,C'T'       PRIOR MONTHS SPECIFIED IN REQUEST?           
         BNE   SETD30A9            NO, CHECK B4 PROFILE                         
         PACK  DUB,QPRIORMO        GET NUMBER OF PRIOR MONTHS...                
         CVB   R0,DUB                                                           
         STC   R0,PRIOR                                                         
         OI    PRIOR,X'C0'         PRIOR = X'C4'..X'CB'                         
         B     SETD30B                                                          
*                                                                               
SETD30A9 DS    0H                                                               
         MVC   PRIOR,PROFB4+9                                                   
         CLC   =C'NO PRIOR',QMANUAL                                             
         BNE   *+8                                                              
         MVI   PRIOR,C'N'                                                       
         MVI   NMOS,1              NO PRIOR MONTHS                              
         CLI   PRIOR,C'N'                                                       
         BE    SETD31                                                           
         MVI   NMOS,X'0D'          13 MONTHS BY DEFAULT                         
         CLI   PRIOR,C'C'          A-C = 1-3 PRIOR MOS SEPARATE                 
         BNH   SETD30B                                                          
         CLI   PRIOR,C'1'          AND 1-3 = 1-3 PRIORS TOGETHER                
         BNL   SETD30B                                                          
         CLI   PRIOR,C'U'          IF U OR V -> 25 MONTHS                       
         BL    SETD31                                                           
         MVI   NMOS,MAXMOS                                                      
         B     SETD31                                                           
SETD30B  DS    0H                                                               
         ZIC   RF,PRIOR                                                         
         AHI   RF,1                                                             
         STC   RF,NMOS                                                          
         NI    NMOS,X'FF'-X'F0'                                                 
SETD31   DS    0H                                                               
         CLI   BFRMOS,C'Y'      IF MOS ALLOWED ON NEW BILL FORMULA RECS         
*                               (NOTE- VALUE OF S IS OK FOR SEPARATE)           
         BNE   SETD31A9                                                         
         CLI   PRIOR,C'S'       THEN MUST HAVE SEPARATE BILLS PER MOS           
         BE    SETD31A9                                                         
         CLI   PRIOR,C'U'                                                       
         BE    SETD31A9                                                         
         CLI   PRIOR,C'N'                                                       
         BE    SETD31A9                                                         
         CLI   PRIOR,C'1'          CHECK FOR 1,2,3 ...                          
         BL    *+12                                                             
         CLI   PRIOR,C'3'         ... NOTHING ELSE IS ALLOWED                   
         BNH   SETD31A9                                                         
         MVI   ERR,MOSERR                                                       
         BRAS  RE,ERRPROC                                                       
*                                                                               
SETD31A9 DS    0H                                                               
         MVC   ZBOPT,PROFB2+5      ZERO BILL OPTION                             
*                                                                               
*                                  IF USER WANTS ZERO BILLS ON A                
*                                  PARTICULAR BILLTYPE, THEN HE CAN'T           
*                                  SPECIFY FORMAT 7, 8, OR 9 FOR THAT           
*                                  BILLTYPE, BECAUSE THOSE FORMATS              
*                                  AUTOMATICALLY SUPPRESS ZERO BILLS            
         CP    MANGRS,=P'0'                                                     
         BNE   SETD31C1            MANUAL BILLS ARE ALWAYS OK                   
         CLC   TYPE,ZBOPT          IF USER WANTS TO SEE ZERO BILLS              
         BNE   SETD31C1                                                         
         CLI   ZLOPT,C'A'          USING ZBOPT FOR THIS BILL                    
         BE    *+14                IF ALSO SUPPRESSING 0 LINES, ERROR           
         CLC   TYPE,ZLOPT                                                       
         BNE   *+12                                                             
         MVI   ERR,ZBZLOPER        0 BILL/0 LINE OPT'S INCOMPATIBILITY          
         BRAS  RE,ERRPROC                                                       
*                                                                               
         CLI   PROFB4+11,7         ZBOPT IS PRESENT: WHAT'S THE FORMAT?         
         BL    SETD31C1                                                         
         CLI   PROFB4+11,9                                                      
         BH    SETD31C1                                                         
         MVI   ERR,ZBOPTERR        PRINT ZERO BILLS OR NOT? WHO KNOWS?          
         BRAS  RE,ERRPROC                                                       
*                                                                               
SETD31C1 DS    0H                                                               
         MVC   ORIGTYPE,PROFB2+6   TYPE NOT TO MARK DETAILS                     
         CP    MANGRS,=P'0'                                                     
         BE    *+12                                                             
         MVI   NMOS,1                                                           
         MVI   PRIOR,C'N'          NO PRIOR IF MANUAL                           
         CLI   PROFB2+1,C'*'       DON'T CHECK PGR                              
         BE    SETD32                                                           
         CLI   PROFB4+0,C'N'       PGRS NOT USED FOR THIS TYPE                  
         BE    SETD32                                                           
         CLI   QPGR,C' '           IF NO PGR ON REQUEST                         
         BH    *+10                                                             
         MVC   QPGR,PROFB2+1       SET FROM PROFILE                             
         CLC   QPGR,PROFB2+1                                                    
         BE    SETD32                                                           
         MVI   ERR,PGRERR                                                       
         BRAS  RE,ERRPROC                                                       
*                                                                               
SETD32   DS    0H                                                               
*                                  SET MGR BUCKETS OPTION                       
         MVI   MGRBKTS,C'N'                                                     
         L     RF,ADCLT                                                         
         LA    RF,CEXTRA+2-CLTHDR(,RF)                                          
*                                                                               
         CLI   PROFB2+2,C'*'       DON'T CHECK MGR                              
         BE    SETD34                                                           
         CLI   PROFB4+3,C'N'       MGRS NOT USED FOR THIS TYPE                  
         BE    SETD34                                                           
*                                                                               
         MVI   ERR,MGRERR          MGR'S NOT USED IN NETPAK                     
         BRAS  RE,ERRPROC                                                       
*                                                                               
SETD34   DS    0H                                                               
*                                  SET CANADIAN NETWORK OPTION                  
         XC    CNETSTRT,CNETSTRT                                                
         CLI   QMED,C'N'           MUST BE NET                                  
         BNE   SETD34D                                                          
         L     RF,ADAGY                                                         
         CLI   AGYPROF+7-AGYHDR(RF),C'C'    MUST BE CANADA                      
         BNE   SETD34D                                                          
*                                  CHANGE X'YM' TO X'YYMM'                      
* Y2K???                                                                        
         MVC   BYTE,PROFB2+11                                                   
         CLI   BYTE,0                                                           
         BE    SETD34D                                                          
         NI    BYTE,X'FF'-X'0F'                                                 
         ZIC   RE,BYTE                                                          
         SRL   RE,4                                                             
         AHI   RE,70               70'S                                         
         CLI   BYTE,X'80'                                                       
         BNL   *+8                                                              
         AHI   RE,10               80'S                                         
         STC   RE,CNETSTRT                                                      
*                                                                               
         MVC   CNETSTRT+1(1),PROFB2+11                                          
         NI    CNETSTRT+1,X'FF'-X'F0'                                           
*                                                                               
SETD34D  DS    0H                                                               
         OC    MANBIN(MANBINLQ),MANBIN                                          
         BNZ   SETD35              IGNORE PROFILE PERCENTAGE                    
         CP    MANGRS,=P'0'        CAN'T OC PACKED                              
         BNE   SETD35              IGNORE PROFILE PERCENTAGE                    
         CP    MANNET,=P'0'                                                     
         BNE   SETD35              IGNORE PROFILE PERCENTAGE                    
         ZIC   RF,PROFB4+15        TAKE FROM PROFILE                            
         MHI   RF,100                                                           
         ST    RF,MANPCT                                                        
SETD35   DS    0H                                                               
         MVI   PCTNET,C'Y'         PCT ON BOTH GROSS + NET                      
         CLC   MANPCT,=F'14900'    BUT, IF OVER 149 PCT                         
         BNH   SETD36                                                           
         L     RF,MANPCT                                                        
         SHI   RF,10000            SUBTRACT 100 PCT AND TAKE                    
         ST    RF,MANPCT                                                        
         MVI   PCTNET,C'N'         PCT OF GROSS ONLY                            
SETD36   DS    0H                                                               
         MVC   NEWSTART,PROFB2+14  STARTING YM FOR NEW BILLING                  
         OC    NEWSTART,NEWSTART                                                
         BNZ   *+14                                                             
         MVC   NEWSTART,FFS        NOT USING                                    
         B     SETD36D                                                          
*                                                                               
         MVC   FULL(2),NEWSTART    Y2K STUFF                                    
         MVI   FULL+2,1                                                         
         GOTO1 DATCON,DMCB,(3,FULL),(0,DUB)                                     
         GOTO1 DATCON,DMCB,(0,DUB),(3,FULL)                                     
         MVC   NEWSTART,FULL                                                    
*                                                                               
SETD36D  DS    0H                                                               
         XC    REQYM,REQYM                                                      
         CLI   QSTART+4,C' '       IF FULL DATE GIVEN                           
         BE    SETD3                                                            
*                                  SET BQSTARTP + BQENDP NOW                    
         GOTO1 DATCON,DMCB,QSTART,(2,BQSTARTP)                                  
         GOTO1 DATCON,DMCB,QEND,(2,BQENDP)                                      
SETD3    DS    0H                                                               
*                                  IN WORK SET QSTART - 2YRS                    
*                                          AND QEND +  1 YR                     
         MVC   WORK(L'QSTART),QSTART                                            
         MVC   WORK+4(2),=C'01'                                                 
         GOTO1 DATCON,DMCB,(0,WORK),(0,WORK)                                    
         CLI   QSTART+4,C' '       IF ONLY MOS GIVEN                            
         BH    SETD3D                                                           
         GOTO1 DATCON,DMCB,(0,WORK),(3,DUB)  ALSO SET REQYM                     
         MVC   REQYM,DUB                                                        
*                                                                               
SETD3D   DS    0H                                                               
         MVC   WORK+6(6),WORK                                                   
*                                                                               
         GOTO1 ADDAY,DMCB,(C'Y',WORK),WORK,-3     SUBTRACT TWO YEARS            
*                                                                               
         GOTO1 ADDAY,DMCB,(C'Y',WORK+6),WORK+6,1  ADD ONE YEAR                  
*                                                                               
         CLC   WORK+2(2),=C'12'    IF MONTH HIGHER THAN 12                      
         BNH   *+16                                                             
         MVC   WORK+2(2),=C'12'    SET IT TO 12 TO GIVE MOBILE                  
         MVC   WORK+8(2),=C'12'    REAL DATES TO WORK WITH                      
*                                                                               
         ZIC   R0,SPOTPROF+2       DATE CONTROL                                 
         CLI   PGSW2,C'Y'          IS IT P&G?                                   
         BNE   *+12                                                             
         IC    R0,=C'P'            CALL TO GET SPECIAL FISCAL CALENDAR          
         B     *+16                                                             
*                                                                               
         CLI   MM3SW,C'Y'          IS IT MM3?                                   
         BNE   *+8                                                              
         IC    R0,=C'M'            CALL TO GET SPECIAL FISCAL CALENDAR          
*                                  BUILD LONG LIST OF DATE PAIRS                
         GOTO1 MOBILE,DMCB,(50,WORK),((R0),X)                                   
*                                  FIND FIRST PERIOD OF A NEW YEAR              
         LA    R2,X                                                             
SETD4    DS    0H                                                               
         BAS   RE,CKNEWYR          NEW YEAR?                                    
         BE    *+12                YES                                          
         LA    R2,4(R2)                                                         
         B     SETD4                                                            
*                                  BUILD  A LIST OF YM, START-END               
         L     R3,=A(STABUCKC)                                                  
SETD7    DS    0H                                                               
         ZIC   R0,2(R2)                                                         
         SRL   R0,1                                                             
         STC   R0,BYTE             YEAR                                         
         SR    R4,R4               FOR PER SEQUENCE WITHIN YR                   
SETD8    DS    0H                                                               
         AHI   R4,1                                                             
         MVC   0(1,R3),BYTE        YEAR                                         
         STC   R4,1(R3)            MONTH                                        
         MVC   2(4,R3),0(R2)       START-END OF PER                             
         LA    R3,6(R3)                                                         
         LA    R2,4(R2)                                                         
         CLI   0(R2),X'FF'                                                      
         BE    SETD12              EOL                                          
         BAS   RE,CKNEWYR          NEW YEAR?                                    
         BE    SETD7               YES                                          
         B     SETD8                                                            
*                                                                               
*              NOW FIND PER THAT MATCHES REQUEST                                
*                                                                               
*        NOTE-'CROSS PERIOD BILLING IS DIFFERENT IN SPOT                        
*        AND NET. IN SPOT START AND END DATES ARE PICKED UP                     
*        UP FROM THE ESTIMATE HEADER. IN NET THEY ARE TAKEN FROM                
*        THE REQUEST. IN BOTH CASES EVERYTHING IS CARRIED                       
*        AS IF IN THE FIRST MONTH. IN NET CROSS PERIOD IS                       
*        TREATED THE SAME AS 'PARTIAL'                                          
*                                                                               
SETD12   DS    0H                                                               
         L     R3,=A(STABUCKC)                                                  
SETD13   DS    0H                                                               
         MVI   PARTIAL,C'N'                                                     
         OC    REQYM,REQYM         IF YM REQUEST                                
         BZ    SETD14                                                           
         CLC   REQYM,0(R3)         MATCH PERIOD                                 
         BH    SETD16                                                           
         MVC   BQSTARTP,2(R3)      SET START                                    
         MVC   BQENDP,4(R3)        SET END                                      
         BE    SETD20                                                           
SETD13B  DS    0H                                                               
         MVI   ERR,DATERR2                                                      
         BRAS  RE,ERRPROC                                                       
SETD14   DS    0H                                                               
*                                  ELSE IS START-END REQUEST                    
         MVI   PRIOR,C'N'                                                       
         MVI   PARTIAL,C'N'                                                     
         CLC   BQSTARTP,2(R3)                                                   
         BNE   *+14                                                             
         CLC   BQENDP,4(R3)                                                     
         BE    SETD20              EXACT WHOLE PERIOD REQUEST                   
         CLC   BQSTARTP,4(R3)                                                   
         BH    SETD16                                                           
         CLC   BQSTARTP,2(R3)                                                   
         BL    SETD13B             NOT WITHIN A PERIOD                          
         CLI   XPEROPT,C'Y'        IF CROSS PERIOD ALLOWED USE                  
         BE    *+14                THE FIRST PERIOD WITHIN REQUEST              
         CLC   BQENDP,4(R3)        ELSE CHECK END WITHIN PERIOD                 
         BH    SETD13B             NOT WITHIN A PERIOD                          
*                                                                               
         MVI   PARTIAL,C'Y'        PARTIAL PERIOD BILLING                       
*                                  NOTE- MAY BE CROSS PERIOD                    
         CLI   XPEROPT,C'Y'        IF CROSS PERIOD ALLOWED                      
         BNE   *+8                                                              
         MVI   PROFBN+13,C'N'      DISABLE BROADCAST/CALENDAR MIX               
         B     SETD20              (IT DOESN'T WORK AND ISN'T MEEDED)           
*                                                                               
SETD16   DS    0H                                                               
         LA    R3,6(R3)                                                         
         B     SETD13                                                           
*                                                                               
SETD20   DS    0H                  HAVE MATCHING PERIOD                         
         MVC   CURPER,0(R3)        SAVE CURRENT PER                             
         LHI   R2,6                                                             
         CLI   PRIOR,C'N'                                                       
         BE    SETD22                                                           
*                                  ***SET PERLIST***                            
*                                                                               
*                                  IF PRIOR BACK UP MAXMOS PERIODS              
*                                  OR UNTIL REACH NEWSTART                      
*                                  OR UNTIL REACH 'N' MONTHS BACK               
         SR    R2,R2                                                            
         ZIC   R0,NMOS                                                          
         BCTR  R0,0                                                             
SETD21   DS    0H                                                               
         CLC   0(2,R3),NEWSTART                                                 
         BL    SETD21B                                                          
         BE    SETD21D                                                          
         SHI   R3,6                                                             
         AHI   R2,6                                                             
         BCT   R0,SETD21                                                        
         B     SETD21D                                                          
SETD21B  DS    0H                                                               
         LTR   R2,R2                                                            
         BNZ   SETD21D                                                          
         MVI   ERR,DATERR                                                       
         BRAS  RE,ERRPROC                                                       
*                                                                               
SETD21D  DS    0H                                                               
         AHI   R2,6                                                             
SETD22   DS    0H                                                               
         XC    PERLIST(PERLSTLQ),PERLIST                                        
         BCTR  R2,0                                                             
         EX    R2,*+8                                                           
         B     *+10                                                             
         MVC   PERLIST(0),0(R3)                                                 
         LA    RF,PERLIST+1(R2)                                                 
         MVI   0(RF),X'FF'         SET END OF LIST MARKER                       
*                                                                               
         CLI   PGSW2,C'Y'          IF SPECIAL FISCAL SAVE END DATE              
         BNE   SETD23                                                           
         LA    RF,PERLIST(R2)      POINT TO END OF PERLIST                      
         AHI   RF,-1               POINT TO ENDING PERIOD                       
         GOTO1 DATCON,DMCB,(2,0(RF)),QENDPG                                     
*                                                                               
PERLST   USING PERLISTD,PERLIST                                                 
SETD23   CLC   PERLST.PERLMOS,NEWSTART                                          
         BNL   *+12                                                             
         MVI   ERR,DATERR                                                       
         BRAS  RE,ERRPROC                                                       
*                                                                               
         CLI   PARTIAL,C'Y'         FOR PARTIALS (NOTE - MAY BE                 
         BNE   *+16                  CROSS PERIOD)                              
         MVC   PERLST.PERLSTRT,BQSTARTP  USE REQUEST START-END                  
         MVC   PERLST.PERLEND,BQENDP                                            
*                                                                               
         OC    REQYM,REQYM          START-END REQUESTED?                        
         BZ    SETDATEX             YES                                         
*                                                                               
         MVC   BQSTARTP,PERLST.PERLSTRT                                         
         DROP  PERLST                                                           
*                                   SET DERIVED START-END DATE IN RQST          
         GOTO1 DATCON,DMCB,(2,BQSTARTP),QSTART                                  
         GOTO1 DATCON,DMCB,(2,BQENDP),QEND                                      
*                                                                               
SETDATEX DS    0H                                                               
         J     XIT                                                              
         EJECT                                                                  
*                                  FIND START OF NEW YEAR                       
*                                  1) A PERIOD THAT SPANS YEAR CHANGE           
*                                     AND BEGINS NO FURTHER AWAY                
*                                     FROM 12/31 THAN IT ENDS                   
*                             OR   2) A PERIOD THAT STARTS BEFORE 1/14          
*                                                                               
CKNEWYR  NTR1                                                                   
*                                                                               
         MVC   DUB(4),0(R2)                                                     
         NI    DUB,X'FF'-X'FE'     STRIP YEAR                                   
         CLC   DUB(2),NEWYRLO                                                   
         BL    CKNYYES                                                          
*                                                                               
         CLC   DUB(2),PDDEC                                                     
         BNH   CKNYNO                                                           
*                                                                               
         NI    DUB+2,X'FF'-X'FE'                                                
         CLC   DUB+2(2),PDDEC                                                   
         BH    CKNYNO                                                           
*                                                                               
         NI    DUB+1,X'FF'-X'E0'   ISOLATE DAY                                  
         ZIC   RF,DUB+1                                                         
         LHI   R0,30                                                            
         SR    R0,RF                                                            
         BNP   CKNYYES             STARTS ON 30TH OR 31ST                       
         STC   R0,DUB+4                                                         
*                                                                               
         NI    DUB+3,X'FF'-X'E0'   ISOLATE DAY                                  
         CLC   DUB+4(1),DUB+3                                                   
         BNH   CKNYYES                                                          
*                                                                               
CKNYNO   J     NO                                                               
*                                                                               
CKNYYES  J     YES                                                              
         SPACE 2                                                                
NEWYRLO  DC    X'002E'             JAN14                                        
PDDEC    DC    X'0180'             DEC00                                        
         SPACE 3                                                                
         LTORG                                                                  
         EJECT                                                                  
         EJECT                                                                  
         TITLE 'TOSORT - PASS RECORDS TO SORT/BUFFALO'                          
TOSORT   NMOD1 SPLWRKL,TOSORT                                                   
         LR    R9,RC                                                            
         USING SPLWRKD,R9                                                       
         LA    RC,SPACEND                                                       
*                                                                               
         CLI   SPLITOPT,C'N'       DOING SPLITS?                                
         BNE   *+12                                                             
         BAS   RE,TSSEND                                                        
         B     TSX                                                              
*                                  PRODUCT SPLITS                               
         MVI   BYTE3,0             THIS'LL INDICATE IF REC WAS PUT              
*                                  INTO BINSRCH TABLE                           
         XC    WORK,WORK                                                        
         L     RF,APRD             PRODUCT CODE (ALPHA SEQ CODE)                
         MVC   WORK(3),0(RF)                                                    
         L     RF,AEST             ESTIMATE                                     
         MVC   WORK+L'PRD(1),0(RF)     CHECK IF ALREADY IN BINS TABLE           
*                                                                               
         GOTO1 BINSRCH,SPLPARS,WORK                                             
         CLI   0(R1),1             IS IT THERE ?                                
         BE    TS4                 NO, PUT IT                                   
         MVC   SPLAENT,0(R1)       SAVE A(TABLE ENTRY)                          
         MVI   SPLAENT,0           CLEAR HOB                                    
         MVI   BYTE3,C'Y'                                                       
         B     TS42                DONE                                         
*                                                                               
TS4      DS    0H                  READ FOR SPLIT RECORD                        
         MVC   WK,KEY              SAVE KEY                                     
         XC    KEY,KEY                                                          
         LA    R5,KEY                                                           
         USING SPBRECD,R5                                                       
         MVI   SPBKTYP,SPBKTYPQ                                                 
         MVI   SPBKSUB,SPBKSUBQ                                                 
         MVC   SPBKAGMD,BAGYMD                                                  
         MVC   SPBKCLT,BCLT                                                     
*                                                                               
         CLI   TSMODE,C'U'         FOR 'UNIT MODE'                              
         BE    TS6B                PRODUCT CODE WILL BE OK ALREADY              
*                                  ACTUAL CODE, NOT ALPHA SEQ                   
         L     R1,APRD             ELSE PRODUCT CODE (ALPHA SEQ)                
*        ZIC   RF,0(R1)                                                         
*        MHI   RF,4                PRDLTAB ENTRY SIZE IS 4                      
*        L     RE,VCLIST                                                        
*        LA    RE,0(RE,RF)                                                      
         MVC   SPBKPRD,0(R1)                                                    
         B     TS7                                                              
*                                                                               
TS6B     DS    0H                  HAVE PRODUCT CODE, GET MNEMONIC              
         L     RF,APRD                                                          
*        L     RE,VCLIST                                                        
*                                                                               
*S6D     DS    0H                                                               
*        CLI   0(RE),0             EOL, PRODUCT NOT FOUND                       
*        BNE   *+6                                                              
*        DC    H'0'                                                             
*        CLC   3(1,RE),0(RF)                                                    
*        BE    *+12                                                             
*        LA    RE,4(RE)                                                         
*        B     TS6D                                                             
         MVC   SPBKPRD,0(RF)                                                    
*                                                                               
TS7      DS    0H                                                               
         L     RF,AEST             ESTIMATE                                     
         MVC   SPBKEST,0(RF)                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE     IF %'S FOUND, OK                             
         BNE   TS40                ELSE DON'T SPLIT                             
*                                                                               
         CLI   TSMODE,C'U'         IF MODE U                                    
         BNE   *+12                AND HAVE SPLITS FOR THIS UNIT                
         MVI   USPLTSW,C'Y'        SAY SO                                       
         B     TSX                 AND DONE                                     
*                                                                               
         GOTO1 BINSRCH,SPLPARS,(1,WORK)  NOW ADD THIS TO TABLE                  
         OC    1(3,R1),1(R1)                                                    
         BNZ   *+6                                                              
         DC    H'0'                TOO MANY SPLIT PRODUCTS                      
*                                                                               
         MVC   SPLAENT,0(R1)       SAVE A(TABLE ENTRY)                          
         MVI   SPLAENT,0           CLEAR HOB                                    
         MVI   BYTE3,C'Y'                                                       
         CLI   0(R1),1             SHOULD NOT BE THERE                          
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R5,APEPTAB          USE PEPTAB AS IO AREA                        
         ST    R5,AREC                                                          
         GOTO1 GET                                                              
*                                                                               
         LA    R5,SPBFSTEL                                                      
         L     R6,SPLAENT          A(TABLE ENTRY)                               
         USING SPLENTD,R6                                                       
         LA    R6,SPLKLEN(R6)      POINT TO FIRST SHARE ENTRY                   
         SR    R7,R7                                                            
         DROP  R5                                                               
*                                                                               
TS36     DS    0H                                                               
         CLI   0(R5),0             EOR                                          
         BE    TS40                                                             
         CLI   0(R5),NETPCDQ       TYPE ELEMENT                                 
         BNE   *+16                                                             
         CLI   NETPID-NETYPE(R5),X'02'  MUST BE PERCENT, NOT $                  
         BNE   TS40                SKIP                                         
         B     TS36D                                                            
*                                                                               
         CLI   0(R5),NECELCDQ      DATA ELEMENT                                 
         BE    TS37                                                             
*                                                                               
TS36D    DS    0H                                                               
         ZIC   R0,1(R5)                                                         
         AR    R5,R0                                                            
         B     TS36                                                             
*                                                                               
TS37     DS    0H                                                               
         AHI   R7,1                COUNT ELEMENTS                               
         CHI   R7,SPLTSMAX         TEST VS. MAX SHARES                          
         BNH   *+6                                                              
         DC    H'0'                TOO MANY SHARES                              
         USING NECEL,R5                                                         
*        L     RF,VCLIST           GET PRODUCT ALPHA SEQ                        
*        LR    R0,RF                                                            
*                                                                               
*S38D    DS    0H                                                               
*        CLI   0(RF),0                                                          
*        BNE   *+6                                                              
*        DC    H'0'                BAD PRODUCT                                  
*        CLC   0(3,RF),NECPRD                                                   
*        BE    *+12                                                             
*        LA    RF,4(RF)                                                         
*        B     TS38D                                                            
*                                                                               
*        SR    RF,R0                                                            
*        SRL   RF,2                                                             
*        STC   RF,0(R6)            SET PRODUCT ALPHA SEQ                        
         MVC   0(L'SPLSPRD,R6),NECPRD      SPLIT PRODUCT                        
         MVC   L'SPLSPRD(L'SPLSHARE,R6),NECPCT                                  
         LA    R6,SPLSLEN(R6)      NEXT SHARE                                   
         B     TS36D               NEXT ELEMENT                                 
         DROP  R5,R6                                                            
*                                                                               
TS40     DS    0H                                                               
         MVC   KEY,WK              RESTORE SEQ                                  
         GOTO1 HIGH                                                             
*                                                                               
TS42     DS    0H                                                               
         CLI   TSMODE,C'U'         FOR UNIT SPLIT TEST MODE                     
         BNE   *+12                                                             
         MVI   USPLTSW,C'Y'                                                     
         B     TSX                 DONE NOW, ONLY NEED TO SET SWITCH            
*                                                                               
         CLI   BYTE3,C'Y'          IS THIS FROM TABLE ?                         
         BNE   *+18                NO, DONE, PUT TO SORT                        
         L     R2,SPLAENT          A(TABLE ENTRY)                               
         USING SPLENTD,R2                                                       
         OC    SPLSPRD(SPLSLEN),SPLSPRD   IF FIRST SPLIT IS 0,NO SPLIT          
         BNZ   *+12                                                             
*                                                                               
         BAS   RE,TSSEND                                                        
         B     TSX                                                              
*                                                                               
         LA    R2,SPLKLEN(R2)      POINT TO FIRST SHARE ENTRY                   
         LHI   R3,SPLTSMAX         MAX SHARES                                   
         XC    SPLWRKA(SPLWRKL),SPLWRKA     CLEAR WORK AREA                     
         LA    R1,SPLWRK           ZAP $ FIELDS IN WORK (YKVA)                  
         LA    RF,ROW$L*8(R1)                                                   
         BRAS  RE,ZAPSTR                                                        
*                                                                               
         L     R4,ASORTDTA         START OF ORDERED/BILLED DATA                 
         LA    R5,SPLWRK                                                        
         MVC   SPLORIGD(ROW$L,R5),0(R4)   SKIP NUMBER OF SPOTS                  
         MVC   SPLORIGD+ROW$L(ROW$L,R5),ROWHL(R4)                               
*                                                                               
TS46     DS    0H                                                               
         OC    SPLSPRD(SPLSLEN),SPLSPRD        NULL IS EOL                      
         BZ    TSX                                                              
*                                                                               
         ICM   RF,15,L'SPLSPRD(R2)             PCT FOR THIS PRODUCT             
         A     RF,SPLPCUME         CUME PCT                                     
         ST    RF,SPLPCUME                                                      
*                                                                               
         LA    R5,SPLWRK                                                        
         LHI   R6,SPLWLEN/ACCUMLQ      NUMBER OF AMOUNTS                        
*                                                                               
TS48     DS    0H                                                               
         L     R0,SPLPCUME                                                      
         CVD   R0,DUB              % TO PACKED                                  
         ZAP   PKBIG,SPLORIGD(ACCUMLQ,R5)  FOR MULTIPLICATION                   
         MP    PKBIG,DUB           APPLY %                                      
         SRP   PKBIG,1,0           FOR ROUNDING                                 
         ZAP   MYPACKED,=P'1000000'  SET DIVISOR                                
         DP    PKBIG,MYPACKED      DIVIDE BY ??                                 
         SRP   PKQUOT,64-1,5       ROUND                                        
         MVC   MYPACKED,PKQUOT                                                  
         SP    MYPACKED,SPLACUMD(ACCUMLQ,R5)  LESS PREV AMNT CUME               
         MVC   SPLAMTD(ACCUMLQ,R5),MYPACKED   = THIS PROD SHARE                 
         MVC   SPLACUMD(ACCUMLQ,R5),PKQUOT    SET NEW CUME AMNT                 
*                                                                               
         LA    R5,ACCUMLQ(R5)       NEXT AMOUNT                                 
         BCT   R6,TS48                                                          
*                                                                               
         L     RF,ASORTDTA         SET SPLIT RESULTS IN RECORD                  
         LA    R5,SPLWRK+SPLAMTD                                                
         MVC   0(ROW$L,RF),0(R5)   BYPASS NO. OF SPOTS                          
         MVC   ROWHL(ROW$L,RF),ROW$L(R5)                                        
         L     RF,APRD                                                          
         MVC   0(3,RF),SPLPRD                                                   
         BAS   RE,TSSEND           SEND TO SORT                                 
*                                                                               
         LA    R2,SPLSLEN(R2)      NEXT PRODUCT SHARE                           
         BCT   R3,TS46                                                          
*                                                                               
TSX      J     XIT                                                              
         SPACE 2                                                                
TSSEND   NTR1                                                                   
*                                                                               
         CLI   SORTTRCE,C'Y'                                                    
         BNE   TSS4                                                             
         GOTO1 PRNTBL,DMCB,=C'SORT IN',SORTREC,C'DUMP',SORTRLEN,=C'1D'          
*                                                                               
TSS4     DS    0H                                                               
         GOTO1 BUFFALO,DMCB,=C'PUT',ABUFFC,SORTREC                              
*                                                                               
         J     XIT                                                              
         DROP  R9                                                               
         SPACE 2                                                                
         LTORG                                                                  
         SPACE 2                                                                
*                                                                               
*                                                                               
BLDBHLDT NTR1  BASE=*,LABEL=*     BUILD TABLE OF BHOLD RECS FOR CLT             
         LA    RC,SPACEND                                                       
         XC    XSPKEY,XSPKEY                                                    
         LA    R3,XSPKEY           BUILD BHOLD RECORD KEY                       
         USING BHLNRECD,R3                                                      
         MVI   BHLNKSYS,BHLNKSYQ   X'0E07' RECORDS                              
         MVI   BHLNKSTP,BHLNKSTQ                                                
         MVC   BHLNKAM,BAGYMD      AGENCY/MEDIA                                 
         MVC   BHLNKCLI,BCLT       CLIENT                                       
         MVC   XSPKEYSV,XSPKEY                                                  
*                                                                               
         GOTO1 DATAMGR,DMCB,DMRDHI,=C'XSPDIR',XSPKEYSV,XSPKEY                   
         B     BLDHL15                                                          
*                                                                               
BLDHL10  GOTO1 DATAMGR,DMCB,DMRSEQ,=C'XSPDIR',,XSPKEY                           
*                                                                               
BLDHL15  CLI   DMCB+8,0                                                         
         BZ    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLC   BHLNKEY(BHLNKPRD-BHLNKEY),XSPKEYSV   COMP INCL CLIENT            
         BNE   BLDBHX              NOTHING ELSE FOR THIS CLIENT                 
*                                                                               
         GOTO1 DATAMGR,DMCB,GETREC,=C'XSPFIL',BHLNDA,A(XSPIO),DMWORKX           
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R6,=A(XSPIO)                                                     
         USING HLDELD,R6                                                        
*                                                                               
         LA    R6,BHLNELDQ(R6)     POINT TO 1ST ELEM                            
         CLI   0(R6),HLDELCDQ      SHOULD BE X'10' ELEM                         
         BE    *+6                                                              
         DC    H'0'                                                             
         CLC   TODAYP,HLDELDAT     PAST EFFECTIVE DATE ?                        
         BH    BLDHL10             YES, SKIP                                    
*                                                                               
         XC    WK,WK               USE TO BUILD A REC FOR MY TABLE              
         LA    R2,WK                                                            
         USING BHOLDTD,R2                                                       
         MVC   BHLDAM,BHLNKAM                                                   
         MVC   BHLDCLT,BHLNKCLI                                                 
         MVC   BHLDPRD,BHLNKPRD                                                 
         MVC   BHLDEST,BHLNKEST                                                 
         MVC   BHLDNET,BHLNKNET                                                 
         MVC   BHLDMOS,HLDELMOS                                                 
         MVC   BHLDPKG,HLDELPKG                                                 
*                                                                               
         GOTO1 BINSRCH,BHLPARS,(1,WK)                                           
         OC    1(3,R1),1(R1)                                                    
         BNZ   *+6                                                              
         DC    H'0'                TABLE FULL                                   
         CLI   0(R1),1             IF REC WAS NOT FOUND,IT GOT INSERTD          
         B     BLDHL10                                                          
*                                  ADD TOTALS IN                                
BLDBHX   XIT1                                                                   
         SPACE 2                                                                
         LTORG                                                                  
*                                                                               
*                                                                               
SPLWRKD  DSECT                                                                  
         DS    0D                                                               
SPLWRKA  DS    0X                                                               
SPLPCUME DS    XL4                 PCT CUME                                     
SPLAENT  DS    XL4                 A(TABLE ENTRY)                               
SPLWRK   DS    (ROW$L*8)X                                                       
SPLWLEN  EQU   ROW$L*2                                                          
SPLORIGD EQU   0                   ORIGINAL AMOUNTS                             
SPLACUMD EQU   SPLWLEN             AMOUNT CUMES                                 
SPLAMTD  EQU   SPLWLEN*2           SHARE AMOUNTS                                
SPLWRKL  EQU   *-SPLWRKA                                                        
*                                                                               
SPLENTD  DSECT                     SPLITTAB ENTRY                               
SPLPRD   DS    CL3                 MASTER PRODUCT WHICH'LL BE SPLIT             
SPLEST   DS    X                   ESTIMATE                                     
SPLKLEN  EQU   *-SPLENTD                                                        
SPLSPRD  DS    CL3                 SPLIT PRODUCT                                
SPLSHARE DS    XL4                 %                                            
SPLSLEN  EQU   *-SPLSPRD           SHARE LEN                                    
         TITLE 'PRNT - PRINT CONTROL MODULE'                                    
SPBU02   CSECT                                                                  
PRNT     NMOD1 0,BILLPRNT                                                       
         LA    RC,SPACEND                                                       
*                                                                               
         MVC   SAVMODE,MODE                                                     
         MVI   MODE,0              LET REPORT DO ALL HEADLINE LEVELS            
         CLI   RCSUBPRG,100        SPECIAL TO GET CATEGORY HEADLINES            
         BNE   PRNT4               AND NOT PRINT ANYTHING                       
*                                                                               
         MVC   MIDHOOK,=A(BILHEAD)                                              
         XC    HEADHOOK,HEADHOOK                                                
         MVI   FORCEHED,C'N'                                                    
         MVI   LINE,0                                                           
         MVI   FORCEMID,C'Y'                                                    
*                                  CLEAR ALL P'S                                
         LA    R1,P                                                             
         LHI   R0,14                                                            
         MVC   0(132,R1),SPACES                                                 
         LA    R1,132(R1)                                                       
         BCT   R0,*-10                                                          
*                                                                               
         GOTO1 REPORT                                                           
         MVI   RCSUBPRG,0                                                       
         XC    MIDHOOK,MIDHOOK                                                  
         B     PRNTX                                                            
         SPACE 2                                                                
PRNT4    DS    0H                                                               
         CLI   SAVMODE,RUNLAST                                                  
         BE    *+8                                                              
         MVI   RCSUBPRG,10                                                      
*                                                                               
         MVC   HEADHOOK,=A(BILHEAD)                                             
         CLI   PRSW,C'C'           CLEAR LINES                                  
         BE    PRNT24                                                           
         CLI   SORTTRCE,C'Y'                                                    
         BE    PRNT5                                                            
         CLI   SORTTRCE,C'O'                                                    
         BE    PRNT5                                                            
         CLI   PRSW,C'N'                                                        
         BNE   PRNT8                                                            
PRNT5    DS    0H                                                               
         GOTO1 REPORT                                                           
         B     PRNTX                                                            
*                                                                               
PRNT8    DS    0H                                                               
         CLI   PRSW,C'F'                                                        
         BE    PRNT20                                                           
*                                  HOLD PRINT LINES                             
         CLI   PRSW,C'M'           'MERGE UP'?                                  
         BNE   PRNT8W                                                           
*                                                                               
         CLC   P2,SPACES           MUST BE SINGLE LINE                          
         BNE   PRNT8W                                                           
         CLC   P(21),SPACES        BLANK IN DESC                                
         BNE   PRNT8W                                                           
         CLC   P,SPACES            NON-SPACES                                   
         BE    PRNT8W                                                           
*                                                                               
         SR    R4,R4                                                            
         L     R2,ANXTLIN                                                       
PRNT8F   DS    0H                                                               
         SHI   R2,132                                                           
         C     R2,=A(LINTAB)       BEFORE START                                 
         BL    PRNT8M                                                           
         CLC   21(111,R2),SPACES   COLUMNS CLEAR                                
         BNE   PRNT8M                                                           
         CLC   0(21,R2),SPACES     DESC NOT CLEAR                               
         BE    PRNT8M                                                           
*                                                                               
         LR    R4,R2               SAVE A(LINE)                                 
         B     PRNT8F                                                           
PRNT8M   DS    0H                                                               
         LTR   R4,R4               NO LINE IS OK FOR MERGE                      
         BZ    PRNT8W                                                           
*                                                                               
         MVC   21(111,R4),P+21     MERGE LINES                                  
         MVC   P,SPACES                                                         
         CLI   SPACING,1                                                        
         BNH   PRNTX                                                            
         L     R2,ANXTLIN          MULT SPACING AFTER MERGE                     
         B     PRNT10                                                           
         B     PRNTX                                                            
*                                                                               
PRNT8W   DS    0H                                                               
         LHI   R0,14                                                            
         L     R1,=A(LINTABX)      END OF LINTAB                                
         L     R2,ANXTLIN                                                       
         LA    R4,P                                                             
PRNT9    DS    0H                                                               
         CLC   0(132,R4),SPACES                                                 
         BE    PRNT10                                                           
         MVC   0(132,R2),0(R4)                                                  
         MVC   0(132,R4),SPACES    CLEAR LINE                                   
         LA    R2,132(R2)                                                       
         CR    R2,R1               PAST THE END ?                               
         BL    *+6                                                              
         DC    H'0'                                                             
         LA    R4,132(R4)                                                       
         BCT   R0,PRNT9                                                         
PRNT10   DS    0H                  ADJUST FOR SPACING                           
         CLI   SPACING,2                                                        
         BL    PRNT11                                                           
         ZIC   R0,SPACING                                                       
         BCTR  R0,0                                                             
         MVI   0(R2),0                                                          
         LA    R2,132(R2)                                                       
         BCT   R0,*-8                                                           
PRNT11   DS    0H                                                               
         ST    R2,ANXTLIN                                                       
         MVI   SPACING,1                                                        
         B     PRNTX                                                            
*                                                                               
*                                  FLUSH PRINT LINES                            
*                                                                               
PRNT20   DS    0H                                                               
         MVI   PRSW,C'N'                                                        
         CLC   ANXTLIN,=A(LINTAB)                                               
         BE    PRNTX                                                            
*                                  FIRST COUNT LINES                            
         L     R5,ANXTLIN                                                       
         S     R5,=A(LINTAB)                                                    
         SR    R4,R4                                                            
         D     R4,=F'132'                                                       
         CHI   R5,25               NOT MUCH POINT IN REQUIRING                  
         BNH   *+8                 MORE THAN 25 LINES                           
         LHI   R5,25                                                            
         STC   R5,ALLOWLIN         NUMBER OF LINES                              
*                                                                               
         L     R2,=A(LINTAB)                                                    
PRNT22   DS    0H                                                               
         MVC   P,0(R2)                                                          
         GOTO1 REPORT                                                           
         LA    R2,132(R2)                                                       
         C     R2,ANXTLIN                                                       
         BL    PRNT22                                                           
*                                                                               
PRNT24   DS    0H                                                               
         MVC   ANXTLIN,=A(LINTAB)                                               
         L     RF,=A(LINTAB)                                                    
         LHI   R0,LINTABN                                                       
         MVC   0(132,RF),SPACES                                                 
         LA    RF,132(RF)                                                       
         BCT   R0,*-10                                                          
*                                                                               
         LA    RF,P                                                             
         LHI   R0,14                                                            
         MVC   0(132,RF),SPACES                                                 
         LA    RF,132(RF)                                                       
         BCT   R0,*-10                                                          
*                                                                               
PRNTX    DS    0H                                                               
         MVC   MODE,SAVMODE                                                     
         J     XIT                                                              
         SPACE 2                                                                
         LTORG                                                                  
         TITLE 'BILLBOX - READ AND PRINT REMITTANCE ADDRESS'                    
BILLBOX  NMOD1 BOXQ,BILLBOX                                                     
         LR    R9,RC                                                            
         USING BOXD,R9                                                          
         LA    RC,SPACEND                                                       
*                                                                               
         CLI   TESTFLAG,C'T'                                                    
         BNE   *+18                                                             
         MVC   P+20(22),=C'**** TEST BILLING ****'                              
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
*                                                                               
         CLI   PREVSW,C'P'                                                      
         BNE   BOX4                                                             
*                                                                               
         MVC   P1+20(37),=C'* THIS IS A MEMO INVOICE TO REVERSE *'              
         MVC   P2+20(37),=C'*         PREVIOUS BILLING          *'              
         MVC   P3+20(37),=C'*     DO NOT FORWARD TO CLIENT      *'              
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
*                                                                               
BOX4     DS    0H                                                               
         CLI   BOXNO,C'*'                                                       
         BNH   BOXX                                                             
*                                                                               
         LA    R4,WORK                                                          
         USING ADDRREC,R4                                                       
         MVI   ADDKTYPE,ADDKTYPQ                                                
         MVI   ADDKMED,C'T'                                                     
         MVC   ADDKCALL(3),=C'BOX'                                              
         MVC   ADDKCALL+3(L'BOXNO),BOXNO                                        
         MVI   ADDKCALL+4,C'T'                                                  
         MVC   ADDKAGY,AGY                                                      
         MVC   ADDKFILL,=C'000000'                                              
         CLC   ADDRKEY,BOXADDR                                                  
         BE    BOXPRT                                                           
         MVC   KEY(L'ADDRKEY),ADDRKEY                                           
         GOTO1 HIGHSTAD                                                         
         L     R4,ADSTATAD                                                      
         CLC   WORK(L'ADDRKEY),ADDRKEY    FOUND RIGHT RECORD?                   
         BNE   BOXX                                                             
         MVC   BOXADDR,ADDRREC                                                  
*                                                                               
BOXPRT   DS    0H                                                               
         LA    R4,BOXADDR                                                       
         MVC   P(24),=C'** REMITTANCE ADDRESS **'                               
         LA    R1,P+25                                                          
         MVC   0(L'ANAME,R1),ANAME                                              
         LA    R1,132(R1)                                                       
         MVC   0(L'A1LINE,R1),A1LINE                                            
         LA    R1,132(R1)                                                       
         MVC   0(L'A2LINE,R1),A2LINE                                            
         LA    R1,24(R1)                                                        
*                                                                               
         CLI   0(R1),C' '          SCAN BACKWARDS FOR BLANK                     
         BH    *+8                                                              
         BCT   R1,*-8                                                           
         MVI   1(R1),C','                                                       
         MVC   3(2,R1),A3LINE                                                   
         MVC   7(L'ABIGZIP,R1),ABIGZIP                                          
         DROP  R4                                                               
*                                                                               
         GOTO1 ABILLEDI,DMCB,('EDMRMA',0)   EDI                                 
*                                                                               
         BRAS  RE,PRNT                                                          
*                                                                               
BOXX     DS    0H                                                               
         J     XIT                                                              
         DROP R9                                                                
         SPACE 2                                                                
         LTORG                                                                  
BOXD     DSECT                                                                  
BOXADDR  DS    CL117                                                            
BOXQ     EQU   *-BOXD                                                           
         SPACE 2                                                                
         TITLE 'BILHEAD - HEADLINE ROUTINES  (HEADHOOK)'                        
SPBU02   CSECT                                                                  
BILHEAD  NMOD1 0,BILHEAD,R9                                                     
         L     R8,SAVER8                                                        
         L     RA,SAVERA                                                        
         LA    RC,SPACEND                                                       
         B     BH1                                                              
*                                                                               
BH1      DS    0H                                                               
*                                                                               
         CLI   RCSUBPRG,100        SPECIAL TO SAVE HEADLINES                    
         BE    BH50                                                             
         CLI   RCSUBPRG,20         INVOICE REGISTER                             
         BE    BH80                                                             
         CLI   RCSUBPRG,21         AOR INVOICE REGISTER                         
         BE    BH80                                                             
*                                  NORMAL HEADLINE ROUTINE                      
         CLI   AGMFORMS,C'D'       DDS+ PAPER                                   
         BE    BH1F                                                             
         CLI   AGMFORMS,C'A'       AGY ADDRESS ON AGY PAPER (HEAD 1)            
         BNE   *+14                                                             
         MVC   HEAD1+27(L'AGYADR),AGYADR                                        
         B     BH1G                                                             
*                                                                               
         CLI   AGMFORMS,C'B'       AGY ADDRESS ON AGY PAPER (HEAD 3)            
         BNE   BH2                                                              
         MVC   HEAD3+27(L'AGYADR),AGYADR                                        
         OC    HEAD3+27(L'AGYADR),SPACES                                        
         GOTO1 CENTER,DMCB,HEAD3+27,L'AGYADR                                    
         B     BH2                                                              
*                                                                               
BH1F     DS    0H                                                               
         MVC   HEAD1+27(L'AGYNM),AGYNM                                          
         MVC   HEAD2+27(L'AGYADR),AGYADR                                        
         OC    HEAD2,SPACES                                                     
         GOTO1 CENTER,DMCB,HEAD2+27,L'AGYADR                                    
BH1G     DS    0H                                                               
         OC    HEAD1,SPACES                                                     
         GOTO1 CENTER,DMCB,HEAD1+27,L'AGYNM                                     
*                                                                               
BH2      DS    0H                                                               
         CLI   SKIPSPEC,C'Y'                                                    
         BE    BHX                                                              
*                                                                               
         MVC   SPWD,SPACES                                                      
         MVC   SPWD+10(5),=C'SPOTS'     FOR NON-NETWORK                         
         CLI   QMED,C'N'                                                        
         BNE   *+10                                                             
         MVC   SPWD+10(5),=C'UNITS'     FOR NETWORK                             
*                                                                               
         LA    R4,HEAD5            START WITH HEAD5                             
         CLI   AGMFORMS,C'L'       IF 'LONG LOGO' FORMS                         
         BE    *+16                                                             
         CLI   AGMFORMS,C'B'       'LONG LOGO' FORMS (ADDRESS IN HEAD3)         
         BE    *+8                                                              
         LA    R4,HEAD4            ELSE USE HEAD 4                              
*                                                                               
         MVC   0(12,R4),=C'INVOICE DATE'                                        
         MVC   14(8,R4),PINVDTE    INVOICE DATE                                 
*                                                                               
         CLI   PDUEDTE,C' '                                                     
         BE    *+16                                                             
         MVC   132(8,R4),=C'DUE DATE'                                           
         MVC   132+14(8,R4),PDUEDTE    DUE DATE                                 
*                                                                               
         CLI   PSHPDTE,C' '                                                     
         BE    *+16                                                             
         MVC   264(9,R4),=C'SHIP DATE'                                          
         MVC   264+14(8,R4),PSHPDTE    SHIP DATE                                
*                                                                               
         MVC   66(11,R4),=C'INVOICE    '                                        
         MVC   132+75(4,R4),=C'PAGE'                                            
         LA    R6,132+80(R4)                                                    
         EDIT  (B2,PAGE),(3,0(R6))                                              
*                                                                               
         LR    R5,R4                                                            
*******  CLC   =C'BD',QAGY         FOR BBDO                                     
*******  BNE   *+8                                                              
*******  LA    R5,132(R4)          PUT MEDIA DOWN ONE LINE                      
*                                                                               
         CLI   MEDFILT,C'C'                                                     
         BNE   *+14                                                             
         MVC   32(8,R5),=C'CABLE TV'                                            
         B     BH4C                                                             
*                                                                               
         CLI   MEDFILT,C'S'                                                     
         BNE   *+14                                                             
         MVC   32(11,R5),=C'SYNDICATION'                                        
         B     BH4C                                                             
*                                                                               
         CLI   MEDFILT,C'D'                                                     
         BNE   BH2O                                                             
         MVC   32(13,R5),=C'NETWORK RADIO'                                      
         CLC   QAGY,=C'BN'                                                      
         BNE   BH4C                                                             
         MVC   32(15,R5),=C'SATELLITE RADIO'                                    
         B     BH4C                                                             
*                                                                               
BH2O     CLI   MEDFILT,C'O'                                                     
         BNE   BH3                                                              
         CLC   QAGY,=C'FM'                                                      
         BNE   *+14                                                             
         MVC   32(17,R5),=C'BROADCAST INVOICE'                                  
         B     BH4F                                                             
*                                                                               
         CLC   QAGY,=C'PC'                                                      
         BE    *+14                                                             
         CLC   QAGY,=C'TH'                                                      
         BNE   *+14                                                             
         MVC   32(19,R5),=C'EMERGING TECHNOLOGY'                                
         B     BH4F                                                             
*                                                                               
BH3      DS    0H                                                               
         MVC   32(10,R5),MEDNM     ELSE REGULAR MEDIA NAME                      
*                                                                               
BH4C     DS    0H                                                               
         LA    RF,47(R5)                                                        
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         MVC   2(13,RF),=C'MEDIA BILLING'                                       
BH4F     CLI   PASSNO,2                                                         
         BNE   BH5                                                              
         CLI   DUESW,C'R'          SKIP SUB HEAD FOR AOR                        
         BE    BH5                                                              
         CLI   DUESW,C'A'          OR COMMISSION ADJUSTMENT INVOICE             
         BE    BH5                                                              
         LA    R0,32-14(R5)                                                     
         SR    RF,R0               RF = LENGTH OF TITLE                         
         LA    RE,132+32(R5)                                                    
         SHI   RF,20                                                            
         BNP   *+10                                                             
         SRL   RF,1                                                             
         AR    RE,RF                                                            
*                                                                               
         MVC   0(20,RE),=C'** DETAIL BACK-UP **'                                
         CLI   AGMTITL,C'I'                                                     
         BNE   *+10                                                             
         MVC   0(21,RE),=C'** INVOICE BACK-UP **'                               
*                                                                               
BH5      DS    0H                                                               
         MVC   74(10,R4),PINVNO                                                 
         CLI   DUESW,C'R'          AOR                                          
         BNE   *+14                                                             
         MVC   132+58(9,R4),=C'** AOR **'                                       
         LA    R4,132(R4)                                                       
         CLI   TESTFLAG,C'T'                                                    
         BNE   *+10                                                             
         MVC   132+58(16,R4),=C'**TEST BILLING**'                               
*                                                                               
*                                  BILLING ADDRESS                              
BH5D     DS    0H                                                               
         LA    RF,AORADR1          USE AOR ADDRESSES                            
         CLI   DUESW,C'R'          FOR AOR BILL                                 
         BE    BH5D4                                                            
*                                  (NOTE - FOR MULTI-PRODUCT BILL AOR,          
*                                   ADDRESS WILL BE FROM LAST PRODUCT -         
*                                   UNLESS DOING PRD/EST/MOS LIST)              
*                                                                               
         LA    RF,BADDR1                                                        
         CLI   PROFB4A+13,C'Y'     USE PGROUP ADDRESS REGARDLESS?               
         BE    *+18                                                             
         CLC   APRDBRK,AINVBRK     IF MULTI-PRODUCT BILL                        
         BNH   BH5D3                                                            
         LA    RF,AADDR1           USE AAA ADDRESS                              
*                                                                               
         BAS   RE,PRGACHK          BUT CHECK IF HAVE PGR ADDRESS                
         BE    BH5D6               IF SO, PGRACHK WILL HAVE SET THEM            
         B     BH5D4                                                            
*                                                                               
BH5D3    DS    0H                  NOT MULTI-PRODUCT BILL                       
         LA    RF,BADDR1                                                        
         CLI   0(RF),C' '          IF NO PRODUCT ADDRESS                        
         BH    BH5D4                                                            
         CLI   PROFB4A+4,C'Y'      OPTION TO USE AAA                            
         BNE   *+8                                                              
         LA    RF,AADDR1                                                        
*                                                                               
BH5D4    DS    0H                                                               
         MVC   HEAD7+46(L'BADDR1),00(RF)                                        
         MVC   HEAD8+46(L'BADDR1),36(RF)                                        
         MVC   HEAD9+46(L'BADDR1),72(RF)                                        
         MVC   HEAD10+46(L'BADDR1),108(RF)                                      
         MVC   HEAD11+46(L'BADDR1),144(RF)                                      
*                                                                               
BH5D6    DS    0H                                                               
         GOTO1 ABILLEDI,DMCB,('EDMADD',0)   EDI (BILL ADDRESS)                  
*                                       PUT CATEGORY HEADLINES SAVED            
*                                       INTO REAL HEADLINES                     
         LA    R5,MYHEAD1                                                       
         LA    R4,HEAD8                                                         
         LHI   R0,6                                                             
         CLI   AGMFORMS,C'L'       'LONG LOGO' FORMS                            
         BE    BH5F                                                             
         CLI   AGMFORMS,C'B'       'LONG LOGO' FORMS (ADDRESS IN HEAD3)         
         BE    BH5F                                                             
         LA    R4,HEAD7                                                         
         LHI   R0,7                                                             
*                                                                               
BH5F     DS    0H                                                               
         CLI   DUESW,C'R'          FOR AOR                                      
         BNE   BH6                                                              
         CLI   AORLOPT,C'N'        AND DOING PRD/EST/MOS LIST                   
         BE    BH6                                                              
         MVC   MYHEADSV(L'MYHEADS/2),MYHEADS SAVE BEFORE CLEARING               
         MVC   MYHEADSV+L'MYHEADS/2(L'MYHEADS/2),MYHEADS+L'MYHEADS/2            
         LHI   R0,1                THEN ONLY CLIENT HEADLINES                   
         LA    RE,MYHEAD1                                                       
         MVI   L'MYHEAD1(RE),C' '                                               
*                                                                               
BH6      DS    0H                                                               
         MVC   0(L'MYHEAD1,R4),0(R5)                                            
         LA    R4,132(R4)                                                       
         LA    R5,L'MYHEAD1(R5)                                                 
         BCT   R0,BH6                                                           
*                                                                               
         CLI   0(R5),C' '          ANY MORE HEADLINES                           
         BNH   *+14                NO-OK                                        
         C     R5,FRSTCOM          IGNORE COMMENTS                              
         BNL   *+6                                                              
         DC    H'0'                TOO MANY HEADLINES                           
*                                                                               
         CLI   HEAD13,C' '                                                      
         BNE   *+8                                                              
         MVI   HEAD13,0            ENSURE 13 HEADLINES                          
*                                                                               
         LA    R2,MID1             USE MID LINES FOR COLUMN HEADLINES           
         USING ALINED,R2                                                        
         MVI   MID1+131,0          NO COLUMN HEADLINES ON ADJ. BILL             
         MVI   MID2+131,0                                                       
         CLI   DUESW,C'A'                                                       
         BE    BH40                                                             
         CLI   DUESW,C'R'          SPECIAL HEADLINES ON AOR BILLS               
         BE    BH36                                                             
*                                                                               
         MVC   GRSWD2,GRSWD        NORMAL SETTINGS FOR COLUMN HEADLINES         
         MVC   ORDWD2,ORDWD                                                     
         MVC   BLBLWD2,BLBLWD                                                   
         CLI   COST2SW,C'Y'                                                     
         BNE   BH6H                                                             
         MVC   GRSWD2,GRSWDC       COST2 SETTINGS FOR COLUMN HEADLINES          
         MVC   ORDWD2,ORDWDC                                                    
         MVC   BLBLWD2,BLBLWDC                                                  
*                                                                               
BH6H     DS    0H                                                               
         CLI   FORMAT,1                                                         
         BNE   BH10                                                             
*                                  FORMAT 1 - ORDERED,PREVIOUS, ETC             
         MVC   ALCOL1,NETWD                                                     
         CLI   GNSW,C'N'                                                        
         BE    *+10                                                             
         MVC   ALCOL1,GRSWD2                                                    
         MVC   ALCOL1+132,ORDWD2                                                
*                                                                               
         MVC   ALCOL2,PREVWD                                                    
         MVC   ALCOL2+132,BNWD                                                  
*                                                                               
BH9      DS    0H                                                               
         MVC   ALCOL3,LPWD                                                      
         MVC   ALCOL3+132,BLWD                                                  
*                                                                               
         MVC   ALCOL4+132,BDWD                                                  
         B     BH19                                                             
*                                                                               
BH10     DS    0H                                                               
         CLI   FORMAT,5                                                         
         BNE   BH11                                                             
*                                  FORMAT 5 - SPOTS, ORDERED, ETC               
         MVC   ALCOL1+132,SPWD                                                  
         MVC   ALCOL2,NETWD                                                     
         CLI   GNSW,C'N'                                                        
         BE    *+10                                                             
         MVC   ALCOL2,GRSWD2                                                    
         MVC   ALCOL2+132,ORDWD2                                                
         B     BH9                                                              
*                                                                               
BH11     DS    0H                                                               
         CLI   FORMAT,7                                                         
         BNE   BH11A                                                            
*                                  FORMAT 7 - SPOTS, BALANCE                    
         MVC   ALCOL3+132,SPWD                                                  
         MVC   ALCOL4,NETWD                                                     
         CLI   GNSW,C'N'                                                        
         BE    *+10                                                             
         MVC   ALCOL4,GRSWD2                                                    
         MVC   ALCOL4+132,BLBLWD2                                               
         B     BH11A4                                                           
*                                                                               
BH11A    DS    0H                                                               
         CLI   FORMAT,8                                                         
         BNE   BH11B                                                            
*                                  FORMAT 8 - BALANCE                           
         MVC   ALCOL3,NETWD                                                     
         CLI   GNSW,C'N'                                                        
         BE    *+10                                                             
         MVC   ALCOL3,GRSWD2                                                    
         MVC   ALCOL3+132,BLBLWD2                                               
*                                                                               
BH11A4   DS    0H                                                               
         CLI   SPOTCTL,C'Y'                                                     
         BNE   BH19                                                             
*                                  - SPOT DETAILS                               
         LA    R3,ALCOL1                                                        
         LA    R4,ALCOL2                                                        
*                                                                               
         MVC   132(16,R3),PROGWD                                                
         MVC   0(16,R4),DESCWD1                                                 
         MVC   132(16,R4),DESCWD2                                               
         B     BH19                                                             
*                                                                               
BH11B    DS    0H                                                               
         CLI   FORMAT,9                                                         
         BNE   BH12                                                             
*                                  FORMAT 9 - NET AND GROSS BALANCE             
         MVC   ALCOL3,GRSWD2                                                    
         MVC   ALCOL4,NETWD                                                     
         CLI   GNSW,C'N'                                                        
         BE    *+16                                                             
         MVC   ALCOL3,NETWD                                                     
         MVC   ALCOL4,GRSWD2                                                    
         MVC   ALCOL3+132,BLBLWD2                                               
         MVC   ALCOL4+132,BLBLWD2                                               
         CLI   SPOTCTL,C'Y'                                                     
         BNE   BH19                                                             
*                                  - SPOT DETAILS                               
         LA    R3,ALCOL1                                                        
         LA    R4,ALCOL2                                                        
*                                                                               
         CLI   CTYPCTL,C'T'        T/I TOGETHER?                                
         BE    BH11F                                                            
         MVC   132(16,R3),PROGWD                                                
         MVC   0(16,R4),DESCWD1                                                 
         MVC   132(16,R4),DESCWD2                                               
         B     BH19                                                             
*                                                                               
BH11F    DS    0H                                                               
         MVC   0(16,R3),PROGWD     YES - PROG+DATE/TIME IN COL1                 
         MVC   132(14,R3),DESCWD2+2                                             
         B     BH19                                                             
*                                                                               
BH12     DS    0H                                                               
         CLI   FORMAT,12                                                        
         BH    BH13                                                             
*                                  FORMAT 11,12  - ORDERED                      
         LA    RF,ALCOL4                                                        
         CLI   FORMAT,11                                                        
         BNE   *+8                                                              
         LA    RF,ALCOL3                                                        
         MVC   0(16,RF),NETWD                                                   
         CLI   GNSW,C'N'                                                        
         BE    *+10                                                             
         MVC   0(16,RF),GRSWD2                                                  
         MVC   132(16,RF),ORDWD2                                                
*                                                                               
         CLI   FORMAT,11                                                        
         BE    *+10                                                             
         MVC   ALCOL3,SPWD         SPOTS                                        
*                                                                               
         CLI   SPOTCTL,C'Y'                                                     
         BNE   BH19                                                             
*                                  - SPOT DETAILS                               
         LA    R3,ALCOL1                                                        
         LA    R4,ALCOL2                                                        
*                                                                               
         MVC   132(16,R3),PROGWD                                                
         MVC   0(16,R4),DESCWD1                                                 
         MVC   132(16,R4),DESCWD2                                               
         B     BH19                                                             
*                                                                               
BH13     DS    0H                                                               
*                                  FORMAT 13,14  GROSS AND NET                  
         MVC   ALCOL4,NETWD                                                     
         MVC   ALCOL3,GRSWD2                                                    
         CLI   GNSW,C'N'                                                        
         BE    *+16                                                             
         MVC   ALCOL4,GRSWD2                                                    
         MVC   ALCOL3,NETWD                                                     
         MVC   ALCOL4+132,ORDWD2                                                
         MVC   ALCOL3+132,ORDWD2                                                
*                                                                               
         CLI   FORMAT,13                                                        
         BE    *+10                                                             
         MVC   ALCOL2,SPWD         SPOTS                                        
*                                                                               
         CLI   SPOTCTL,C'Y'                                                     
         BNE   BH19                                                             
*                                  - SPOT DETAILS                               
         LA    R3,ALCOL1                                                        
         LA    R4,ALCOL2                                                        
*                                                                               
         CLI   CTYPCTL,C'T'        IF T/I TOGETHER                              
         BE    BH13F                                                            
         CLI   FORMAT,14           OR SHOWING SPOTS                             
         BE    BH13F                                                            
*                                                                               
         MVC   132(16,R3),PROGWD                                                
         MVC   0(16,R4),DESCWD1                                                 
         MVC   132(16,R4),DESCWD2                                               
         B     BH19                                                             
*                                                                               
BH13F    DS    0H                                                               
         MVC   0(16,R3),PROGWD     PROG + DATE/TIME IN COLUMN 1                 
         MVC   134(14,R3),DESCWD2+2                                             
         B     BH19                                                             
*                                                                               
BH19     DS    0H                  STRIP                                        
         CLI   STRIPOPT,C'N'                                                    
         BE    BH20                                                             
         MVC   96(3,R2),=C'NET'                                                 
         CLI   GNSW,C'N'                                                        
         BNE   *+10                                                             
         MVC   95(5,R2),=C'GROSS'                                               
         MVC   132+94(7,R2),=C'BILLING'                                         
*                                                                               
         CLI   COMMSW,C'N'                                                      
         BE    BH20                                                             
         MVC   ALSTRIP,COMMWD1     COMMISSION                                   
         MVC   ALSTRIP+132,COMMWD2                                              
         DROP  R2                                                               
*                                                                               
*                                  MONTH OF SERVICE                             
BH20     DS    0H                                                               
         CLI   FORMAT,1            FOR FORMAT 1 NO MONTH HEAD                   
         BH    *+18                                                             
         LA    R4,MID1+14                                                       
         MVC   132(6,R4),=C' UNITS'   BUT ALWAYS UNITS                          
         B     BH21F                                                            
*                                                                               
         CLI   PERCTL,C'T'                                                      
         BNE   BH22                                                             
         CLI   SPOTCTL,C'Y'        NO BILL PER HEADLINE FOR                     
         BE    BH22                SPOT DETAIL FORMAT                           
         LA    R4,MID1+22                                                       
*                                                                               
         CLI   SPOTPROF+2,2        CALENDAR MONTH?                              
         BNE   BH21B                                                            
         CLI   PROFBN+13,C'Y'      BROADCAST/CALENDAR MIX?                      
         BE    BH21E               YES, CALL IT JUST 'MONTH'                    
         MVC   0(8,R4),=C'CALENDAR'                                             
         MVC   132(6,R4),=C' MONTH'                                             
         B     BH21F                                                            
*                                                                               
BH21B    DS    0H                                                               
         CLI   SPOTPROF+2,0        BROADCAST MONTH                              
         BNE   *+20                                                             
         MVC   0(8,R4),=C'BROADCST'                                             
         MVC   132(6,R4),=C' MONTH'                                             
         B     BH21F                                                            
*                                                                               
         MVC   0(7,R4),=C'BILLING'                                              
         MVC   132(6,R4),=C'PERIOD'                                             
         B     BH21F                                                            
*                                                                               
BH21E    DS    0H                                                               
         MVC   132(6,R4),=C' MONTH'                                             
*                                                                               
BH21F    DS    0H                                                               
*                                  STATION                                      
*                    **NOTE -FORMATS CHANGED DUE TO SPOT DETAIL FMTS            
*                                  -WATCH FOR PROBLEM                           
*                                  -SEE ALSO LSTA IN  C                         
BH22     DS    0H                                                               
         CLI   STACTL,C'T'                                                      
         BNE   BH24                                                             
         CLC   ASTABRK,ALOWTOG                                                  
         BH    BH24                                                             
*                                                                               
         CLI   FORMAT,1            FOR FORMAT 1                                 
         BNE   BH22A6                                                           
         CLI   SPOTCTL,C'Y'        IF DOING UNITS                               
         BNE   BH22A6                                                           
         MVC   MID1+1(8),=C'NETWORK/'  ALWAYS NEED NET/PROG                     
         MVC   MID2+1(7),=C'PROGRAM'                                            
         B     BH24                                                             
*                                                                               
BH22A6   DS    0H                                                               
         CLI   PERCTL,C'T'                                                      
         BE    BH22B                                                            
*                                  SINGLE MOS                                   
         LA    R4,MID2+21                                                       
         CLI   FORMAT,5                                                         
         BH    *+8                                                              
         LA    R4,MID2+2                                                        
         CLI   SPOTCTL,C'Y'                                                     
         BNE   *+8                                                              
         LA    R4,MID2+5                                                        
         B     BH22D                                                            
*                                  MULTI MOS                                    
BH22B    DS    0H                                                               
         LA    R4,MID2+5                                                        
         CLI   SPOTCTL,C'Y'                                                     
         BNE   BH22C                                                            
*                                                                               
         MVC   0(7,R4),=C'NETWORK'                                              
         CLI   FORMAT,5            FOR FORMAT 5                                 
         BNE   *+10                                                             
         MVC   7(8,R4),=C'/PROGRAM'   PROG IN STUB                              
         B     BH24                                                             
*                                                                               
BH22C    DS    0H                                                               
         CLI   FORMAT,5                                                         
         BNL   *+8                                                              
         LA    R4,MID2+2                                                        
*                                                                               
BH22D    DS    0H                                                               
         MVC   0(7,R4),=C'STATION'                                              
         CLI   QMED,C'N'                                                        
         BNE   *+10                                                             
         MVC   0(7,R4),=C'NETWORK'                                              
*                                  MARKET                                       
BH24     DS    0H                                                               
         CLI   PRDMKT,C'M'         SKIP IF MARKET HIGHER THAN PRODUCT           
         BE    BH26                                                             
         CLC   AMKTBRK,APAGBRK     ONLY IF TOGETHER ON PAGE                     
         BNH   BH26                                                             
         CLC   AMKTBRK,ALOWTOG                                                  
         BH    BH26                                                             
         CLC   MID2(6),SPACES                                                   
         BE    *+14                                                             
         MVC   MID1(7),=C'MARKET/'                                              
         B     BH26                                                             
         MVC   MID2(6),=C'MARKET'                                               
*                                  ESTIMATE                                     
BH26     DS    0H                                                               
         CLC   ALOWTOG,AHITOG      ONLY ONE TOGETHER?                           
         BNE   BH40                                                             
*                                  YES - PRINT DESC HERE                        
         L     R0,ALOWTOG                                                       
         LA    R6,=C'ESTIMATE    '                                              
         C     R0,AESTBRK                                                       
         BE    BH28                                                             
         LA    R6,=C'PRODUCT     '                                              
         C     R0,APRDBRK                                                       
         BE    BH28                                                             
         LA    R6,MGR1BK                                                        
         C     R0,AMGR1BRK                                                      
         BE    BH28                                                             
         LA    R6,MGR2BK                                                        
         C     R0,AMGR2BRK                                                      
         BE    BH28                                                             
         LA    R6,MGR3BK                                                        
         C     R0,AMGR3BRK                                                      
         BE    BH28                                                             
         LA    R6,PGR1BK                                                        
         C     R0,APGR1BRK                                                      
         BE    BH28                                                             
         LA    R6,PGR2BK                                                        
         C     R0,APGR2BRK                                                      
         BE    BH28                                                             
         LA    R6,PGR3BK                                                        
         C     R0,APGR3BRK                                                      
         BE    BH28                                                             
         B     BH40                                                             
*                                                                               
BH28     DS    0H                                                               
         CLC   MID2(14),SPACES                                                  
         BNE   *+14                                                             
         MVC   MID2(12),0(R6)                                                   
         B     BH40                                                             
         CLC   10(2,R6),SPACES                                                  
         BNE   *+14                                                             
         MVC   MID2(10),0(R6)                                                   
         B     BH40                                                             
         GOTO1 CHOPPER,DMCB,(12,0(R6)),(10,MID1),(C'P',2)                       
         B     BH40                                                             
*                                                                               
BH36     DS    0H                  AOR BILLS                                    
         CLI   AORLOPT,C'N'        IF DOING AOR PRD/EST/MOS LIST                
         BE    BH40                NEED SPECIAL HEADLINES                       
         LA    R2,MID1             USE MID LINES FOR COLUMN HEADLINES           
         USING ALINED,R2                                                        
         MVC   ALCOL1(16),=C'      MONTH OF  '                                  
         MVC   ALCOL3(06),=C' BRAND'                                            
         MVC   ALCOL4(16),=C'     BRAND      '                                  
         LA    R2,132(R2)                                                       
         MVC   ALDESC(7),=C'PRODUCT'                                            
         MVC   ALCOL1(16),=C' EST   SERVICE  '                                  
         MVC   ALCOL2+2(12),=C'GROSS AMOUNT'                                    
         MVC   ALCOL3(14),=C'AGENCY%  BASIS'                                    
         MVC   ALCOL4(14),=C' AGENCY AMOUNT'                                    
         MVC   ALSTRIP+2(12),=C'BASIS AMOUNT'                                   
         B     BHX                 SKIP BILLING PERIOD                          
         DROP  R2                                                               
*                                                                               
BH40     DS    0H                                                               
         CLI   PERCTL,C'S'                                                      
         BNE   BHX                                                              
*                                                                               
         LA    R5,BQSTARTP-2                                                    
         OC    REQYM,REQYM         IS IT PARTIAL DATE REQUEST                   
         BZ    BH46                YES, DISPLAY RANGE OF DATES                  
         L     RF,APER                                                          
         ZIC   R5,0(RF)                                                         
         LA    R5,PERLIST(R5)                                                   
         USING PERLISTD,R5                                                      
         LA    R4,HEAD13                                                        
*                                                                               
         CLI   PROFBN+13,C'Y'      FOR BROADCAST/CALENDAR MIX                   
         BE    BH45                JUST CALL IT 'MONTH'                         
         CLI   SPOTPROF+2,0        BROADCAST MONTH                              
         BE    BH45A                                                            
         CLI   SPOTPROF+2,2        CALENDAR MONTH                               
         BE    BH45B                                                            
         B     BH46                DISPLAY START - END                          
*                                                                               
BH45     DS    0H                                                               
         MVC   56(5,R4),=C'MONTH'                                               
         B     BH45C                                                            
*                                                                               
BH45A    DS    0H                                                               
         MVC   46(15,R4),=C'BROADCAST MONTH'                                    
         B     BH45C                                                            
*                                                                               
BH45B    DS    0H                                                               
         MVC   46(14,R4),=C'CALENDAR MONTH'                                     
*                                                                               
BH45C    DS    0H                                                               
         GOTO1 DATCON,DMCB,(3,PERLMOS),(6,64(R4))  MMM/YY                       
         B     BHX                                                              
         DROP  R5                                                               
*                                                                               
BH46     DS    0H                                                               
         LA    R4,HEAD12                                                        
         LA    R6,132+46(R4)                                                    
         CLI   HEAD11+46,C' '      LAST ADDRESS LINE USED?                      
         BNH   *+12                                                             
         LA    R4,HEAD13           YES - PRINT DATES ON ONE LINE                
         LA    R6,18(R4)                                                        
         MVC   46(16,R4),=C'BILLING PERIOD -'                                   
         GOTO1 DATCON,DMCB,(2,2(R5)),(5,0(R6))                                  
         GOTO1 DATCON,DMCB,(2,4(R5)),(5,14(R6))                                 
         MVC   9(4,R6),=C'THRU'                                                 
         B     BHX                                                              
         EJECT                                                                  
*                                 HERE FROM DUMMY NON-PRINTING HEADLINE         
*                                  SETTING REPORT CALL                          
*                                  SAVE NEEDED LINES                            
BH50     DS    0H                                                               
*                                  FIRST ADJUST EST LINE IF NECESSARY           
         CLC   AESTBRK,APAGBRK     TEST EST TO BE IN B.MY HEADLINES             
         BH    BH51B               NO                                           
         CLC   =C'NO',QEST         FOR NO                                       
         BE    *+12                                                             
         CLI   QESTEND,C' '        AND RANGE                                    
         BE    BH51B                                                            
*                                  STATE ESTIMATE                               
         MVC   HEAD6,SPACES                                                     
         MVC   HEAD6(8),=C'ESTIMATE'                                            
         MVC   HEAD6+9(L'EST),EST                                               
         MVC   HEAD6+13(L'ESTNM),ESTNM                                          
*                                                                               
BH51B    DS    0H                                                               
         CLI   QMED,C'N'           CHANGE STATION                               
         BNE   *+16                                                             
         MVC   HEAD11(7),=C'NETWORK'   TO NETWORK                               
         MVC   HEAD11+15(L'STANAME),STANAME  NETWORK NAME (SET IN FSTA)         
*                                  ADD CLT. INTERFACE NO. AFTER CLTNAME         
         CLI   AGMCLNO,C'Y'        Y OR C MEANS YES                             
         BE    *+12                                                             
         CLI   AGMCLNO,C'C'                                                     
         BNE   BH52D                                                            
*                                                                               
         L     R7,ADCLT                                                         
         LA    R7,CCLTIFC-CLTHDR(,R7)                                           
         CLI   0(R7),C' '          NUMBER PRESENT?                              
         BNH   BH52D                                                            
*                                                                               
         LA    RF,HEAD1+45                                                      
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         MVI   3(RF),C'('                                                       
         MVC   4(8,RF),0(R7)                                                    
         LA    RF,8+4(RF)                                                       
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         MVI   1(RF),C')'                                                       
*                                                                               
BH52D    DS    0H                                                               
*                                  ADD ACCT NO AFTER PRODUCT NAME               
         CLI   AGMCLNO,C'C'        C OR X MEANS NO                              
         BE    BH53                                                             
         CLI   AGMCLNO,C'X'                                                     
         BE    BH53                                                             
*                                                                               
         L     R7,ADPRD                                                         
         MVC   FULL,PACCT-PRDHDR(R7)                                            
         CLI   FULL,C' '                                                        
         BNH   BH53                                                             
         CLC   FULL,=C'0000'                                                    
         BE    BH53                                                             
         OC    FULL+1(3),FULL+1                                                 
         BZ    BH53                                                             
         LA    R7,HEAD5+45                                                      
         CLI   0(R7),C' '                                                       
         BH    *+8                                                              
         BCT   R7,*-8                                                           
         MVI   3(R7),C'('                                                       
         MVC   4(4,R7),FULL                                                     
         MVI   8(R7),C')'                                                       
         CLI   FULL,X'FF'                                                       
         BNE   *+14                                                             
         UNPK  4(5,R7),FULL+1(3)                                                
         MVI   9(R7),C')'                                                       
*                                                                               
BH53     DS    0H                                                               
         MVI   BYTE,0                                                           
         OC    AMGR1BRK,AMGR1BRK   MGR'S IN HEADLINE?                           
         BZ    *+18                NO                                           
         CLC   AMGR1BRK,APAGBRK                                                 
         BH    *+8                 NO                                           
         OI    BYTE,X'40'          YES                                          
*                                                                               
         OC    APGR1BRK,APGR1BRK   PGR'S IN HEADLINE?                           
         BZ    *+18                NO                                           
         CLC   APGR1BRK,APAGBRK                                                 
         BH    *+8                 NO                                           
         OI    BYTE,X'80'          YES                                          
*                                                                               
         CLI   BYTE,0              NO MGRS AND NO PGRS                          
         BNE   *+14                                                             
         CLC   AMKTBRK,APAGBRK     AND NO MARKET                                
         BH    BH53Z               NO NEED FOR ALIGNING                         
*                                                                               
*                                  FIRST ALIGN ALL FIELDS LIKE PGRS             
*                                  AND MGRS- DESC(12),CODE(5)                   
*                                                                               
         MVC   X(45),HEAD6         SAVE ESTIMATE HEADLINE                       
*                                                                               
         MVC   WORK,HEAD1          ALIGN CLIENT AS DESC(12),CODE(5)             
         MVC   HEAD1+9(40),SPACES                                               
         MVC   HEAD1+13(3),WORK+9                                               
         MVC   HEAD1+20(30),WORK+13                                             
*                                                                               
         MVC   WORK,HEAD5          ALIGN PRODUCT AS DESC(12),CODE(5)            
         MVC   HEAD5+9(40),SPACES                                               
         MVC   HEAD5+13(3),WORK+9                                               
         MVC   HEAD5+20(30),WORK+13                                             
*                                                                               
         CLC   X(3),=C'ALL'        ALL ESTIMATES?                               
         BE    BH53C               THEN DON'T REALIGN ESTIMATE                  
         MVC   WORK,HEAD6          ALIGN ESTIMATE AS DESC(12),CODE(5)           
         MVC   HEAD6+9(40),SPACES                                               
         MVC   HEAD6+13(3),WORK+9                                               
         MVC   HEAD6+20(30),WORK+13                                             
*                                                                               
BH53C    MVC   WORK,HEAD10         MARKET                                       
         MVC   HEAD10+7(40),SPACES                                              
         MVC   HEAD10+13(4),WORK+7                                              
         MVC   HEAD10+20(24),WORK+12                                            
*                                                                               
*                                  FIND MAXIMUM CODE LENGTH                     
         LHI   R6,3                AT LEAST 3                                   
         CLC   AMKTBRK,APAGBRK                                                  
         BH    *+8                                                              
         LHI   R6,4                4 FOR MARKET                                 
         TM    BYTE,X'80'          HAVE PGRS?                                   
         BZ    BH53F               NO                                           
         ZIC   RF,PGR3LEN                                                       
         AHI   RF,1                                                             
         CR    RF,R6                                                            
         BNH   *+6                                                              
         LR    R6,RF                                                            
*                                                                               
BH53F    DS    0H                                                               
         TM    BYTE,X'40'          HAVE MGRS?                                   
         BZ    BH53H               NO                                           
         ZIC   RF,MGR3LEN                                                       
         AHI   RF,1                                                             
         CR    RF,R6                                                            
         BNH   *+6                                                              
         LR    R6,RF                                                            
*                                                                               
BH53H    DS    0H                                                               
         LA    R7,HEAD1+20                                                      
         LA    R5,HEAD1+15(R6)     TO ADDRESS                                   
*                                                                               
         LHI   R0,10                                                            
BH53J    MVC   0(40,R5),0(R7)                                                   
         LA    R5,132(R5)                                                       
         LA    R7,132(R7)                                                       
         BCT   R0,BH53J                                                         
*                                                                               
*                                  FIND MAX DESC LENGTH                         
         MVC   WORD,=F'8'          AT LEAST 8                                   
         TM    BYTE,X'80'          TBST HAVE PGRS                               
         BZ    BH53N               NO                                           
         LA    R7,PGR1BK                                                        
         BAS   RE,BHGETLEN         RETURNS FIELD 'WORD'                         
         LA    R7,PGR2BK                                                        
         BAS   RE,BHGETLEN                                                      
         LA    R7,PGR3BK                                                        
         BAS   RE,BHGETLEN                                                      
*                                                                               
BH53N    DS    0H                                                               
         TM    BYTE,X'40'          HAVE MGRS?                                   
         BZ    BH53P               NO                                           
         LA    R7,MGR1BK                                                        
         BAS   RE,BHGETLEN                                                      
         LA    R7,MGR2BK                                                        
         BAS   RE,BHGETLEN                                                      
         LA    R7,MGR3BK                                                        
         BAS   RE,BHGETLEN                                                      
*                                                                               
BH53P    DS    0H                                                               
         L     R6,WORD             FROM BHGETLEN                                
         CHI   R6,12               IF MAX LENGTH = 12                           
         BE    BH53T               NO ALIGNING NEEDED                           
*                                                                               
         LA    RE,HEAD1                                                         
         LA    R7,HEAD1+13         FROM ADDRESS                                 
         LA    R5,HEAD1+1(R6)      TO ADDRESS                                   
         LHI   R0,10                                                            
BH53R    CLC   0(7,RE),=C'ALL EST' HEAD6 MIGHT BE ALL ESTIMATES                 
         BE    *+10                DON'T ALIGN                                  
         MVC   0(50,R5),0(R7)                                                   
         LA    RE,132(RE)                                                       
         LA    R5,132(R5)                                                       
         LA    R7,132(R7)                                                       
         BCT   R0,BH53R                                                         
*                                                                               
BH53T    DS    0H                                                               
*                                  RESTORE ESTIMATE LINE                        
         CLC   AESTBRK,APAGBRK     NOT IF SEPARATE ESTIMATE PER PAGE            
         BNH   BH53Z                                                            
         CLC   QESTEND,SPACES      ONLY IF RANGE OR FILTERS                     
         BE    BH53Z                                                            
         MVC   HEAD6(45),X                                                      
*                                                                               
BH53Z    DS    0H                                                               
*                                  CLEAR MYHEADS                                
         LA    R4,MYHEADS                                                       
         LA    R0,(MYHEADSX-MYHEADS)/L'MYHEAD1                                  
         MVC   0(L'MYHEAD1,R4),SPACES                                           
         LA    R4,L'MYHEAD1(R4)                                                 
         BCT   R0,*-10                                                          
*                                                                               
         MVC   MYHEADSV(L'MYHEADS/2),MYHEADS   CLEAR SAVE AREA TOO              
         MVC   MYHEADSV+L'MYHEADS/2(L'MYHEADS/2),MYHEADS                        
*                                                                               
         LA    R4,MYHEADS                                                       
         MVC   MYHEAD1,HEAD1       CLIENT                                       
*                                                                               
         LA    R4,L'MYHEAD1(R4)                                                 
         LA    R3,BRKTAB                                                        
         USING BRKTABD,R3                                                       
*                                                                               
BH54     DS    0H                                                               
         OC    BRKCODE,BRKCODE                                                  
         BZ    BH60                                                             
         CLI   BRKCODE+3,STAEQ*4   BYPASS BREAKS 'BELOW' STATION                
         BH    BH55                                                             
*                                                                               
         C     R3,APAGBRK          FOR REG BULL PAGBRK IS LIMIT                 
         BH    BH56                                                             
         L     RF,BRKCODE                                                       
         MHI   RF,33               132/4 = INDEX INTO HEADLINES                 
         LA    RF,HEAD1(RF)        POINT TO PROPER HEADLINES                    
         MVC   0(L'MYHEAD1,R4),0(RF)                                            
         LA    R4,L'MYHEAD1(R4)    NEXT LINE                                    
BH55     DS    0H                                                               
         LA    R3,BRKL(R3)         NEXT LEVEL                                   
         B     BH54                                                             
BH56     DS    0H                                                               
         C     R3,AESTBRK                                                       
         BNE   BH55                                                             
*                                  EVEN IF ESTIMATE NOT ON BILL                 
*                                  PUT IT IN HEADLINES                          
         MVC   0(L'MYHEAD1,R4),HEAD6                                            
         B     BH55                                                             
*                                                                               
BH60     DS    0H                                                               
         CP    MANGRS,=P'0'        DON'T PRINT DAYPART ON MANUAL BILL           
         BNE   BH60D                                                            
         LA    RE,DPTFILT                                                       
         CLI   DPTFILT,C' '        IF HAVE DAYPART FILTER                       
         BH    BH60B                                                            
         CLI   DPTSEP,C'T'                                                      
         BE    BH60D                                                            
         ICM   RE,15,ADPT          OR DAYPART IS SEPARATE                       
         BZ    BH60D                                                            
*                                                                               
BH60B    CLI   0(R4),C' '          IS THIS LINE USED?                           
         BNH   *+8                                                              
         LA    R4,L'MYHEAD1(R4)                                                 
         MVC   0(7,R4),=C'DAYPART'                                              
*                                                                               
         BRAS  RE,GETDPT                                                        
         LA    R6,WORK                                                          
         USING NDPTHDRD,R6                                                      
         MVC   9(L'NDPTDPTA,R4),NDPTDPTA   USE 2-CHARACTER DAYPART              
         MVC   12(L'NDPTDES,R4),NDPTDES    14 CHARACTER DESCRIPTION             
         DROP  R6                                                               
*                                                                               
         LA    R4,L'MYHEAD1(R4)                                                 
*                                                                               
BH60D    DS    0H                                                               
         CLI   NCOMOPT,C'N'        NETWORK COMMENTS ACTIVE?                     
         BE    BH64                                                             
         CLI   QOPT3,C'Y'          SUPPRESS COMMENTS?                           
         BE    BH64                                                             
*                                                                               
         LA    R6,WORK                                                          
         USING NCOMBLKD,R6                                                      
         XC    WORK,WORK                                                        
         MVC   NCBAIO,ADCOMREC     IOA AREA                                     
         MVC   NCBDMGR,DATAMGR     DATAMGR                                      
         MVC   NCBNETB,=A(NETBLK)  NETBLOCK                                     
         MVC   NCBAHOOK,=A(NCHOOK) HOOK                                         
         MVI   NCBKDFL,C'Y'        SET TO DEFAULT TO HIGHER KEY                 
         MVC   NCBID+1(2),=C'*1'                                                
*                                                                               
         CLI   CTYPQ,C' '          IF SPECIFIC COST TYPE REQUESTED...           
         BE    *+12                                                             
         CLI   CTYPQ,C'1'          AND NOT A GROUP OF TYPES...                  
         BL    *+12                                                             
         CLI   SPCLCTL,C'S'        OR SPECIAL CHARGES ON SEP. BILLS...          
         BNE   BH60G                                                            
*                                                                               
         L     RF,=A(CTYPLST)      ... THEN USE PREFIX CHAR. FROM TABLE         
         USING CTYLD,RF                                                         
BH60E    L     RE,ACTYP                                                         
         CLC   0(1,RE),CTYLDISP    INTERNAL CODE                                
         BE    BH60F                                                            
         CLI   0(RF),X'FF'                                                      
         BNE   *+6                                                              
         DC    H'0'                                                             
         LA    RF,CTYLSTL(RF)                                                   
         B     BH60E                                                            
*                                                                               
BH60F    MVC   NCBID(L'CTYLCOMK),CTYLCOMK   COMMENT ID PREFIX                   
         B     BH61                                                             
         DROP  RF                                                               
*                                                                               
BH60G    CLI   CTYPQ,C'2'          BILL ONLY SPECIAL CHARGES?                   
         BNE   BH60H                                                            
         CLI   SPCLCTL,C'T'        YES: ALL SPECIAL CHARGES TOGETHER?           
         BE    *+12                                                             
         CLI   SPCLCTL,C'N'                                                     
         BNE   BH60H                                                            
         MVI   NCBID,C'C'          YES                                          
         B     BH61                                                             
*                                                                               
BH60H    MVI   NCBID,C'B'          ASSUME TIME AND INTEGRATION TOGETHER         
         CLI   CTYPCTL,C'S'                                                     
         BNE   BH61                                                             
         L     RF,ACTYP            NO, THEY ARE SEPARATE                        
         MVI   NCBID,C'T'          TIME ONLY                                    
         CLI   0(RF),X'00'                                                      
         BE    BH61                                                             
         MVI   NCBID,C'I'          INTEGRATION ONLY                             
*                                                                               
BH61     DS    0H                                                               
         MVC   NCBAM,BAGYMD        AGY/MEDIA                                    
         MVC   NCBCLT,BCLT                                                      
*                                                                               
         CLC   APRDBRK,APAGBRK     IS PRODUCT IN HEADLINES                      
         BH    *+20                NO                                           
         L     RF,ADPRD                                                         
         MVC   NCBPRD,PCODE+1-PRDHDR(RF)                                        
         MVC   NCBPRD3,PKEYPRD-PRDHDR(RF)                                       
*                                                                               
         CLC   AESTBRK,APAGBRK     IS ESTIMATE IN HEADLINES                     
         BH    *+14                NO                                           
         L     RF,ADEST                                                         
         MVC   NCBEST,EKEYEST-ESTHDR(RF)                                        
*                                                                               
         OC    ASTABRK,ASTABRK     IF NETWORK PRESENT                           
         BZ    *+20                                                             
         CLC   ASTABRK,APAGBRK     IS IT IN HEADLINES                           
         BH    *+10                NO                                           
         MVC   NCBNTWK,BIGSTA                                                   
*                                                                               
         OC    APKGBRK,APKGBRK     IF PACKAGE PRESENT                           
         BZ    BH62B                                                            
         CLC   APKGBRK,APAGBRK     IS IT IN HEADLINES                           
         BH    *+14                NO                                           
         L     RF,APKG                                                          
         MVC   NCBPKG,0(RF)                                                     
*                                                                               
BH62B    DS    0H                                                               
         ST    R4,FRSTCOM          SAVE A(FIRST COMMENT)                        
         ST    R4,FULL             SAVE A(NEXT AVAILABLE HEAD)                  
*                                                                               
         GOTO1 =V(NETCOM),DMCB,NCOMBLKD                                         
         CLI   NCBERROR,0                                                       
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
BH64     DS    0H                                                               
*                                                                               
*        PRINT USER FIELDS IN HEADLINES (IF THERE'S ROOM)                       
*                                                                               
         LA    R0,MYHEADS                                                       
         AHI   R0,MYHEADSX-MYHEADS R0 ==> A(MYHEADSX)                           
*                                                                               
         CR    R4,R0               ROOM FOR ANY MORE?                           
         BNL   BH70                                                             
         CLC   0(L'MYHEAD1,R4),SPACES                                           
         BNE   BH70                                                             
         MVC   W,SPACES                                                         
         GOTO1 =V(GETUSER),DMCB,(C'S',ADCLT),(C'P',ADPRD),(C':',W),0            
         TM    DMCB+4,CFLGSPQ+CFLGBHLQ   PRINT ON BILLING IN HEADLINES?         
         BNO   *+14                                                             
         MVC   0(L'MYHEAD1,R4),W   USER1 PRODUCT                                
         LA    R4,L'MYHEAD1(R4)    BUMP TO NEXT LINE                            
*                                                                               
         CR    R4,R0               ROOM FOR ANY MORE?                           
         BNL   BH70                                                             
         CLC   0(L'MYHEAD1,R4),SPACES                                           
         BNE   BH70                                                             
         MVC   W,SPACES                                                         
         GOTO1 =V(GETUSER),DMCB,(C'S',ADCLT),(C'P',ADPRD),0,(C':',W)            
         TM    DMCB+6,CFLGSPQ+CFLGBHLQ   PRINT ON BILLING IN HEADLINES?         
         BNO   *+14                                                             
         MVC   0(L'MYHEAD1,R4),W   USER2 PRODUCT                                
         LA    R4,L'MYHEAD1(R4)    BUMP TO NEXT LINE                            
*                                                                               
         CR    R4,R0               ROOM FOR ANY MORE?                           
         BNL   BH70                                                             
         CLC   0(L'MYHEAD1,R4),SPACES                                           
         BNE   BH70                                                             
         MVC   W,SPACES                                                         
         GOTO1 =V(GETUSER),DMCB,(C'S',ADCLT),(C'E',ADEST),(C':',W),0            
         TM    DMCB+4,CFLGSPQ+CFLGBHLQ   PRINT ON BILLING IN HEADLINES?         
         BNO   *+14                                                             
         MVC   0(L'MYHEAD1,R4),W   USER1 ESTIMATE                               
         LA    R4,L'MYHEAD1(R4)    BUMP TO NEXT LINE                            
*                                                                               
         CR    R4,R0               ROOM FOR ANY MORE?                           
         BNL   BH70                                                             
         CLC   0(L'MYHEAD1,R4),SPACES                                           
         BNE   BH70                                                             
         MVC   W,SPACES                                                         
         GOTO1 =V(GETUSER),DMCB,(C'S',ADCLT),(C'E',ADEST),0,(C':',W)            
         TM    DMCB+6,CFLGSPQ+CFLGBHLQ   PRINT ON BILLING IN HEADLINES?         
         BNO   BH70                                                             
         MVC   0(L'MYHEAD1,R4),W   USER2 ESTIMATE                               
*                                                                               
BH70     DS    0H                                                               
         B     BHX                                                              
         SPACE 2                                                                
*                                  INVOICE REGISTER HEADLINES                   
         SPACE 2                                                                
BH80     DS    0H                                                               
         CLI   TESTFLAG,C'T'                                                    
         BNE   *+10                                                             
         MVC   HEAD9+40(16),=C'**TEST BILLING**'                                
         SPACE 2                                                                
BHX      DS    0H                                                               
         CLC   MYHEADSV(L'MYHEAD1),SPACES                                       
         BE    BHXX                ANYTHING SAVED?                              
         MVC   MYHEADS(L'MYHEADS/2),MYHEADSV      YES, RESTORE                  
         MVC   MYHEADS+L'MYHEADS/2(L'MYHEADS/2),MYHEADSV+L'MYHEADS/2            
BHXX     J     XIT                                                              
         EJECT                                                                  
BHGETLEN NTR1                                                                   
*                                  GET LENGTH OF DESCRIPTION                    
*                                  AND SAVE HIGHEST IN FIELD 'WORD'             
         CLI   0(R7),C' '                                                       
         BNH   BHGETLNX                                                         
         LA    RF,11(R7)                                                        
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         SR    RF,R7                                                            
         LA    RF,1(RF)                                                         
         C     RF,WORD                                                          
         BNH   BHGETLNX                                                         
         ST    RF,WORD                                                          
*                                                                               
BHGETLNX J     XIT                                                              
         EJECT                                                                  
*                                  PROCESSING ROUTINE FOR NETCOM                
NCHOOK   NTR1                                                                   
*                                                                               
         L     R2,NCBAIO           IO AREA                                      
         LA    R2,27(R2)           FIRST ELEMENT                                
         L     R4,FULL             A(NEXT HEADLINE)                             
*                                                                               
NCH4     DS    0H                                                               
         LA    RF,MYHEADS          ROOM FOR ANY MORE?                           
         LA    RF,MYHEADSX-MYHEADS(RF)                                          
         CR    R4,RF                                                            
         BNL   NCH12               NO- DONE                                     
*                                                                               
         CLI   0(R2),0             EOR                                          
         BE    NCH12                                                            
         CLI   0(R2),X'02'         COMMENT ELEMENT                              
         BE    NCH6                                                             
*                                                                               
NCH5     DS    0H                                                               
         ZIC   R0,1(R2)                                                         
         AR    R2,R0                                                            
         B     NCH4                                                             
*                                                                               
NCH6     DS    0H                                                               
         USING NCOMELEM,R2                                                      
         ZIC   RF,NCOMELEN         ELEMENT LENGTH...                            
         SHI   RF,NCOMETXT-NCOMELEM  ... MINUS OVERHEAD = L'COMMENT             
         BCTR  RF,0                FOR EX                                       
         CHI   RF,44               45 IS MAX LENGTH                             
         BNH   *+8                                                              
         LHI   RF,44                                                            
         LA    RE,NCOMETXT                                                      
*                                  IF STARTS WITH /X/ X=MEDIA FILTER            
         CLI   NCOMETXT,C'/'                                                    
         BNE   NCH7                                                             
         CLI   NCOMETXT+2,C'/'                                                  
         BNE   NCH7                                                             
         CLI   NCOMETXT+1,C'/'     ACCEPT ///                                   
         BE    NCH7                                                             
         CLC   MEDFILT,NCOMETXT+1                                               
         BNE   NCH5                REJECT IF WRONG SUB-MEDIA                    
         SHI   RF,3                ADJUST LENGTH                                
         LA    RE,NCOMETXT+3       SKIP OVER /X/                                
         DROP  R2                                                               
*                                                                               
NCH7     DS    0H                                                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R4),0(RE)                                                    
*                                                                               
         ST    R3,SAVBRK           FOR EDI CALL                                 
         MVC   X(132),SPACES                                                    
         MVC   X(45),0(R4)                                                      
         GOTO1 ABILLEDI,DMCB,('EDMNCM',X)    EDI CALL                           
*                                                                               
         LA    R4,L'MYHEAD1(R4)                                                 
         B     NCH5                                                             
*                                                                               
NCH12    DS    0H                  DONE                                         
         ST    R4,FULL             A(NEXT HEAD)                                 
*                                                                               
         J     XIT                                                              
         DROP  R3                                                               
         DROP  R6                                                               
         EJECT                                                                  
*        PGRACHK - TRY FOR PRODUCT GROUP ADDRESS                                
*                                                                               
PRGACHK  NTR1                                                                   
*                                                                               
         CLI   PGR1CTL,C'S'        ONLY IF PGR SEPARATE                         
         BNE   PRGANO                                                           
         L     R2,ADPRDGRP                                                      
         LA    R2,PRGEL-PRGRECD(R2)                                             
*                                                                               
PRGA2    DS    0H                                                               
         CLI   0(R2),0             EOR                                          
         BE    PRGANO                                                           
         CLI   0(R2),X'20'         ADDRESS ELEMENT                              
         BNE   PRGA4                                                            
         USING PRGEL20,R2                                                       
*                                                                               
         CLC   PRGADDR1,SPACES                                                  
         BNH   PRGANO                                                           
         MVC   HEAD7+46(L'PRGADDR1),PRGADDR1                                    
         MVC   HEAD8+46(L'PRGADDR2),PRGADDR2                                    
         MVC   HEAD9+46(L'PRGADDR3),PRGADDR3                                    
         MVC   HEAD10+46(L'PRGADDR4),PRGADDR4                                   
         B     PRGAYES                                                          
*                                                                               
PRGA4    DS    0H                                                               
         ZIC   R0,1(R2)                                                         
         AR    R2,R0                                                            
         B     PRGA2                                                            
         DROP  R2                                                               
*                                                                               
PRGAYES  J     YES                 SET CC = IF FOUND ADDRESS                    
*                                                                               
PRGANO   J     NO                  SET CC NOT = IF NO ADDRESS                   
         SPACE 3                                                                
*                                  WORDS FOR HEADLINES                          
NETWD    DC    C'         NET    '                                              
GRSWD    DC    C'        GROSS   '                                              
ORDWD    DC    C'      ON ORDER  '                                              
BDWD     DC    C'   BALANCE DUE  '                                              
LPWD     DC    C' LESS PREVIOUS  '                                              
BLWD     DC    C'    BILLING     '                                              
PREVWD   DC    C'     PREVIOUS   '                                              
BNWD     DC    C'   BILL NUMBER  '                                              
BLBLWD   DC    C'      BILLABLE  '                                              
PROGWD   DC    C' PROGRAM        '                                              
DESCWD1  DC    C'   ANNOUNCEMENT '                                              
DESCWD2  DC    C'   DATE  LENGTH '                                              
COMMWD1  DC    C'      AGENCY    '                                              
COMMWD2  DC    C'    COMMISSION  '                                              
GAMTWD   DC    C'  GROSS AMOUNT  '                                              
NAMTWD   DC    C'    NET AMOUNT  '                                              
GRSWDC   DC    C'       COST TO  '                                              
ORDWDC   DC    C'        CLIENT  '                                              
BLBLWDC  DC    C'        CLIENT  '                                              
*                                                                               
SAVER8   DS    F                                                                
SAVERA   DS    F                                                                
*                                                                               
SPWD     DS    CL16                                                             
GRSWD2   DS    CL16                                                             
ORDWD2   DS    CL16                                                             
BLBLWD2  DS    CL16                                                             
*                                                                               
MYHEAD1  DS    0CL45                                                            
MYHEADS  DS    CL405                                                            
MYHEADSX EQU   *                                                                
MYHEADSV DS    CL405                                                            
         SPACE 3                                                                
         LTORG                                                                  
         SPACE 2                                                                
         DROP  R9                                                               
         TITLE 'PRNTPROF - TRACE USER PROFILE'                                  
PRNTPROF NMOD1 0,PRNTPROF                                                       
         LA    RC,SPACEND                                                       
*                                                                               
* P1: KEY PASSED TO GETPROF                                                     
* P2: RETURNED PROFILE VALUES FROM GETPROF                                      
* P3: ADDITIONAL RETURNED INFO FROM GETPROF                                     
*                                                                               
         L     RF,APATCH                                                        
         TM    0(RF),X'10'         PRINT USER PROFILES?                         
         BZ    PRNTPRFX            NO                                           
*                                                                               
         LM    R2,R4,0(R1)                                                      
*                                                                               
         USING PROFKD,R2                                                        
         USING PROFINFD,R4                                                      
*                                                                               
         OC    PROFIDAT,PROFIDAT   ANY ACTIVITY DATE PRESENT?                   
         BZ    PRNTPRFX            NO -- NO PROFILE WAS RETURNED                
*                                                                               
         MVC   P(PROFMSLQ),PROFMSG PREPARE TO PRINT PROFILE INFO                
         MVC   P(3),PROFKPGM                                                    
         TM    PROFKSYS,X'40'      SYSTEM IS LOWER CASE?                        
         BZ    *+14                                                             
         MVC   P(2),P+1            YES - PROGRAM IS 3 CHARS. LONG               
         MVI   P+2,C' '                                                         
         GOTO1 DATCON,DMCB,(3,PROFIDAT),(8,P+21)                                
*                                                                               
         OC    PROFIAGY,PROFIAGY   DEFAULT PROFILE RETURNED?                    
         BNZ   *+14                                                             
         MVC   P+PROFMSLQ(15),=C'*** DEFAULT ***'                               
         B     PRNTPRF8                                                         
*                                                                               
         MVC   P+PROFMSLQ(PROFDETQ),PROFDET                                     
         MVC   P+38(5),SPACES                                                   
         MVC   P+38(L'PROFIAGY),PROFIAGY                                        
         CLC   PROFIAGY,SPACES     NUMERIC USERID IN KEY?                       
         BNL   PRNTPRF5            NO                                           
         EDIT  PROFIAGY,(5,P+38),ALIGN=LEFT                                     
PRNTPRF5 MVC   P+51(3),SPACES                                                   
         MVC   P+51(L'PROFIMED),PROFIMED                                        
         CLI   PROFIMED,0                                                       
         BNE   *+10                                                             
         MVC   P+51(3),=C'ALL'                                                  
         MVC   P+63(3),SPACES                                                   
         MVC   P+63(L'PROFICLT),PROFICLT                                        
         OC    PROFICLT,PROFICLT                                                
         BNZ   *+10                                                             
         MVC   P+63(3),=C'ALL'                                                  
*                                                                               
PRNTPRF8 DS    0H                                                               
         GOTO1 REPORT                                                           
*                                                                               
         GOTO1 HEXOUT,DMCB,0(R3),P+1,16,=C'N'                                   
         MVC   P+40(16),0(R3)                                                   
         GOTO1 REPORT                                                           
         GOTO1 REPORT                                                           
*                                                                               
PRNTPRFX DS    0H                                                               
         J     XIT                                                              
         DROP  R2,R4                                                            
         SPACE 2                                                                
PROFMSG  DC    C'XXX PROFILE, UPDATED MMMDD/YY, '                               
PROFMSLQ EQU   *-PROFMSG                                                        
PROFDET  DC    C'AGENCY=XXXXX, MEDIA=XXX, CLIENT=CCC'                           
PROFDETQ EQU   *-PROFDET                                                        
         SPACE 2                                                                
         LTORG                                                                  
         TITLE 'ERRPROC - HANDLE ERRORS'                                        
ERRPROC  NMOD1 0,ERRPROC                                                        
         LA    RC,SPACEND                                                       
*                                                                               
         MVC   P(L'QAREA),QAREA                                                 
*                                                                               
         LA    R1,P                                                             
         LHI   R0,L'QAREA                                                       
         SR    RE,RE                                                            
*                                                                               
ERRP2    CLI   0(R1),X'FA'                                                      
         BL    *+16                                                             
         IC    RE,0(R1)                                                         
         SHI   RE,10                                                            
         STC   RE,0(R1)                                                         
*                                                                               
         LA    R1,1(R1)                                                         
         BCT   R0,ERRP2                                                         
*                                                                               
         IC    RE,ERR                                                           
         MHI   RE,40                                                            
         LA    RE,ERRLIST-40(RE)                                                
         MVC   P2(2),=C'**'                                                     
         MVC   P2+3(40),0(RE)                                                   
         MVI   SKIPSPEC,C'Y'                                                    
         MVI   FORCEHED,C'Y'                                                    
         MVI   PRSW,C'N'                                                        
         BRAS  RE,PRNT                                                          
         BRAS  RE,UNLOCK           ALLOW THE NEXT UPDATIVE SOON                 
         GOTO1 AENDREQ             NEXT REQUEST                                 
         SPACE 3                                                                
ERRLIST  DS    0C                                                               
         DC    CL40'INVALID PRODUCT GROUP'                        1             
         DC    CL40'INVALID MARKET GROUP'                         2             
         DC    CL40'NEW BILLING NOT EFFECTIVE FOR THIS DATE'      3             
         DC    CL40'NO BILLING GENERATED'                         4             
         DC    CL40'MANUAL AMOUNT ERROR'                          5             
         DC    CL40'INVALID BILLING PERIOD'                       6             
         DC    CL40'INVALID BILLING TYPE'                         7             
         DC    CL40'PROFILE INCOMPATIBILITY - ZERO INVOICES'      8             
         DC    CL40'PROFILE INCOMPATIBILITY - COST TYPE'          9             
         DC    CL40'PROFILE INCOMPATIBILITY - AOR'               10             
         DC    CL40'COMMISSION/NET/REG OPTION INVALID'           11             
         DC    CL40'INVALID ESTIMATE'                            12             
         DC    CL40'PROFILE ERROR - ALL LEVELS "N"'              13             
         DC    CL40'SPLIT PRD BILLING REQUIRES PRODUCT ''ALL'''  14             
         DC    CL40'MONTH OF SERVICE PROFILE ERROR'              15             
         DC    CL40'ZERO BILL / ZERO LINE OPTIONS CONFLICT'      16             
         DC    CL40'PRIOR INVOICE NUMBER EXCEEDED MAX ALLOWED'   17             
         DC    CL40'CLIENT OFFICE NOT PRESENT IN OFFICE LIST'    18             
         DC    CL40'REVERSAL INVOICE NUMBER IS NOT FOUND'        19             
         SPACE 3                                                                
PGRERR   EQU   1                                                                
MGRERR   EQU   2                                                                
DATERR   EQU   3                                                                
NOBILERR EQU   4                                                                
MANERR   EQU   5                                                                
DATERR2  EQU   6                                                                
TYPERR   EQU   7                                                                
ZBOPTERR EQU   8                                                                
COSTPERR EQU   9                                                                
AORPERR  EQU   10                                                               
SCBERR   EQU   11                                                               
ESTERR   EQU   12                                                               
PLEVERR  EQU   13                                                               
SPLTERR  EQU   14                                                               
MOSERR   EQU   15                                                               
ZBZLOPER EQU   16                                                               
INVNERR  EQU   17                                                               
OFFCERR  EQU   18                                                               
REVERR   EQU   19                                                               
         SPACE 3                                                                
         LTORG                                                                  
         TITLE 'SPBU2B - NETPAK BILLING - BOOK 2'                               
RNBILL   NMOD1 0,RNBILL                                                         
         LA    RC,SPACEND                                                       
*                                                                               
*                                  FOR NETPAK THIS ROUTINE IS FOR               
*                                  FINDING MANUAL BILLS TO BE REVERSED          
*                                                                               
         CP    MANGRS,=P'0'        MANUAL BILL?                                 
         BNE   RNBX                YES - NO PREVIOUS                            
         CLI   PREVSW,C'N'         OR IF 'NO PREVIOUS'                          
         BE    RNBX                                                             
         CLI   PCTCTL,C'N'         OR IF % BILLING OPTION                       
         BE    RNBX                SAYS NO PREVIOUS                             
*   SINCE PREVIOUS MANUAL BILLS GET APPLIED ONLY TO TIME OR INTEG               
*   TEST THAT TIME/INT CHARGES ARE IN REQUEST, OTHERWISE DON'T PROCESS          
         CLI   CTYPQ,C' '          'ALL TYPES'                                  
         BE    RNB2                                                             
         CLI   CTYPQ,C'3'          'ALL TYPES'                                  
         BE    RNB2                                                             
         CLI   CTYPQ,C'4'          TIME AND SPECIALS                            
         BE    RNB2                                                             
         CLI   CTYPQ,C'1'          TIME/INTEG                                   
         BE    RNB2                                                             
         CLI   CTYPQ,C'I'          INTEG                                        
         BE    RNB2                                                             
         CLI   CTYPQ,C'T'          TIME ONLY                                    
         BNE   RNBX                                                             
*                                                                               
*NB2     CLI   KPRD,X'FF'          IF POL                                       
*        BNE   *+8                                                              
*        MVI   KPRD,0              GET ALL PRODUCTS                             
RNB2     CLC   KPRDC,=C'POL'       IF POL                                       
         BNE   *+14                                                             
         MVI   KPRD,0              GET ALL PRODUCTS                             
         XC    KPRDC,KPRDC         GET ALL PRODUCTS                             
         XC    SAVPRDC,SAVPRDC     CLEAR PRODUCT SAVE AREAS                     
         MVI   SAVPRD,0                                                         
         XC    SAVPGR,SAVPGR                                                    
         XC    SAVPGRU,SAVPGRU                                                  
         XC    SORTREC,SORTREC     CLEAR REC (INCL PACKED FIELD) FIRST          
         L     R1,ASORTDTA         THEN ZAP ACCUMULATORS                        
         LA    RF,ROWTL(R1)        POINT PAST SORT DATA                         
         BRAS  RE,ZAPSTR                                                        
         MVC   KEY1,KEY            SAVE KEY                                     
         XC    KEY,KEY                                                          
*                                                                               
KEY@     USING STABUCKD,KEY                                                     
*        MVC   KEY@.STABKCOD,=X'0E01' RECORD TYPE                               
         MVC   KEY@.STABPCOD,=X'0E81' RECORD TYPE (PASSIVE)                     
         MVC   KEY@.STABPAM,BAGYMD                                              
         MVC   KEY@.STABPCLT,BCLT                                               
         OC    KPRDC,KPRDC                                                      
         BZ    RNB3                SKIP REST OF KEY NOW IF MULTI-PROD.          
         MVC   KEY@.STABPPRD,KPRDC                                              
RNB2EST  DS    0H                                                               
         MVC   KEY@.STABPEST,BEST                                               
*                                                                               
RNB2MKT  DS    0H                                                               
*        XC    KEY@.STABKMKT,KEY@.STABKMKT                                      
*        XC    KEY@.STABKSTA,KEY@.STABKSTA                                      
*        MVI   KEY@.STABKCUR,0                                                  
*                                                                               
RNB3     DS    0H                                                               
         GOTO1 HIGH                                                             
         B     RNB4B                                                            
RNB4     DS    0H                                                               
         GOTO1 SEQ                                                              
RNB4B    DS    0H                                                               
         CLC   KEY(5),KEYSAVE      AGM/CLIENT                                   
         BNE   RNB40                                                            
         OC    KPRDC,KPRDC                                                      
         BZ    *+14                                                             
         CLC   KPRDC,KEY@.STABPPRD  ONE PRODUCT MUST BE EQUAL                   
         BNE   RNB40                                                            
*                                  MULTI-PRODUCT SITUATION                      
         CLC   KEY@.STABPPRD,SAVPRDC                                            
         BE    RNB5D                                                            
         MVC   SAVPRDC,KEY@.STABPPRD                                            
*                                  GET PRODUCT ALPHA SEQ NO.                    
*        L     RF,VCLIST                                                        
*        LR    R0,RF                                                            
*                                                                               
*        CLC   SAVPRD,3(RF)                                                     
*        BE    *+12                                                             
*        LA    RF,4(RF)                                                         
*        B     *-14                                                             
*                                                                               
*        MVC   SAVPRDC,0(RF)                                                    
*        SR    RF,R0                                                            
*        SRL   RF,2                                                             
*        STC   RF,BYTE2            SAVE PRODUCT SEQ NO.                         
*                                                                               
         CLI   QPGR,C' '           PGRS?                                        
         BE    RNB6                NO                                           
*                                  YES                                          
         L     R2,PRDLIST                                                       
RNB5B    DS    0H                                                               
         CLC   KEY@.STABPPRD,2(R2)                                              
         BE    *+12                                                             
         LA    R2,6(R2)                                                         
         B     RNB5B                                                            
*                                                                               
*        MVC   SAVPRDC,2(R2)                                                    
         MVC   SAVPGR,0(R2)                                                     
         UNPK  WORK(5),SAVPGR(3)                                                
         MVC   SAVPGRU,WORK                                                     
*                                                                               
RNB5D    DS    0H                                                               
         CLI   PGRQ,C'A'                                                        
         BE    *+14                                                             
         CLC   SAVPGR,=X'9999'     NOT PGR OK                                   
         BE    RNB5F                                                            
         CLC   APGR1BRK,AINVBRK    IF PGR 'HIGHER' THAN INVBRK                  
         BH    RNB6                                                             
         OC    APGR1BRK,APGR1BRK                                                
         BZ    RNB6                                                             
         CLC   SAVPGR,BPGR+1       THEN CHECK RIGHT PGR                         
         BE    RNB6                YES                                          
*                                                                               
RNB5F    DS    0H                                                               
         ZIC   RF,KEY@.STABPPRD+2  BUMP TO NEXT PRODUCT                         
         AHI   RF,1                                                             
         STC   RF,KEY@.STABPPRD+2                                               
         B     RNB2EST             SET KEY FROM ESTIMATE DOWN                   
*                                                                               
RNB6     DS    0H                  ESTIMATE                                     
         CLI   BEST,0                                                           
         BE    RNB6F                                                            
*                                  ONE ESTIMATE OR SERIES                       
         CLC   KEY@.STABPEST,BEST                                               
         BL    RNB2EST                                                          
         BE    RNB7                                                             
         CLI   BESTEND,0                                                        
         BE    RNB6D                                                            
         CLC   KEY@.STABPEST,BESTEND                                            
         BNH   RNB7                                                             
*                                                                               
RNB6D    DS    0H                  ESTIMATE NOT OK                              
         OC    KPRDC,KPRDC                                                      
         BZ    RNB5F               NEXT PRODUCT IF MULTI-PRODUCT                
         B     RNB40               ELSE DONE                                    
*                                                                               
RNB6F    DS    0H                  MULTI-ESTIMATE                               
         CLC   PRD,=C'POL'                                                      
         BE    *+14                                                             
         OC    KPRDC,KPRDC         IF MULTI-PRODUCT                             
         BZ    RNB7                SKIP ESTIMATE ACTIVE TEST                    
*                                                                               
         ZIC   RF,KEY@.STABPEST                                                 
         LA    RF,ESTLST(RF)                                                    
         CLI   0(RF),0             ESTIMATE ACTIVE?                             
         BNE   RNB7                YES                                          
*                                                                               
*                                  BUMP TO NEXT ESTIMATE                        
         CLI   KEY@.STABPEST,X'FF' AFTER LAST ESTIMATE                          
         BE    RNB6D               NEXT PRODUCT                                 
         ZIC   RF,KEY@.STABPEST                                                 
         AHI   RF,1                                                             
         STC   RF,KEY@.STABPEST                                                 
         B     RNB2MKT                                                          
         DROP  KEY@                                                             
*                                                                               
RNB7     DS    0H                                                               
*                                  HAVE GOOD KEY                                
*                                  PASS EACH APPROPRIATE ELEM. TO SORT          
         L     R7,=A(STABUCKC)                                                  
         ST    R7,AREC                                                          
         USING STABUCK,R7                                                       
         GOTO1 GET                                                              
*                                                                               
         MVI   ELCODE,X'0E'                                                     
         LA    R2,STABELEM                                                      
         USING STABELEM,R2                                                      
         CLC   ELCODE,0(R2)                                                     
         BE    RNB13                                                            
RNB12    DS    0H                                                               
         BRAS  RE,NXTEL                                                         
         BNE   RNB30                                                            
*                                                                               
RNB13    DS    0H                                                               
         OC    MANRVDTP,MANRVDTP   'MANUAL' REVERSAL OF INVOICE?                
         BZ    RNB13B              NO                                           
         CLC   STABBDT,MANRVDTP                                                 
         BNE   RNB12                                                            
         MVC   HALF,STABINV                                                     
         NI    HALF,X'FF'-(STABINV_REVERSAL+STABINV_REVERSED)                   
         CLC   HALF,MANRVNO                                                     
         BNE   RNB12                                                            
*                                                                               
RNB13B   DS    0H                                                               
         OC    IGNDATE,IGNDATE     'IGNORE' DATE?                               
         BZ    *+14                NO                                           
         CLC   STABBDT,IGNDATE     YES, DROP ALL PREVIOUS ON OR AFTER           
         BNL   RNB12                                                            
*                                                                               
         CLI   PERCTL,C'T'                                                      
         BNE   RNB13D                                                           
*                                  IF MULTI-MONTH                               
         CLC   CURPER,EFFDTE       AND CURRENT AND NOT LOWER THAN               
         BL    RNB13D              FORMULA EFFECTIVE DATE                       
         CLC   STABPER,EFFDTE                                                   
         BL    RNB12               BYPASS ALL MONTHS BEFORE EFF. DATE           
*                                                                               
RNB13D   DS    0H                                                               
         LA    R3,PERLIST                                                       
         USING PERLISTD,R3                                                      
RNB14    DS    0H                                                               
         CLC   STABPER,PERLMOS     TEST DATE                                    
         BE    *+16                OK                                           
         BL    RNB12               NEXT ELEMENT                                 
         LA    R3,PERLISTL(R3)                                                  
         B     RNB14                                                            
*                                  BUILD SORT KEY USING BRKTAB                  
         LA    R0,PERLIST                                                       
         SR    R3,R0                                                            
         STC   R3,PERDISP          DISPLACEMENT OF DATE INTO PERLIST            
         DROP  R3                                                               
*                                                                               
         CLI   STABSTYP,0          IF BILL WAS WITH MEDIA FILTER                
         BE    *+14                                                             
         CLC   STABSTYP,MEDFILT    USE IT                                       
         BNE   RNB12                                                            
*                                                                               
         CLI   CTYPQ,C'I'          IF INTEGRATION REQUEST                       
         BNE   *+12                                                             
         TM    STABSTAT,STABSINT   MAKE SURE PREV BILL IS FOR INT               
         BZ    RNB12                                                            
*                                                                               
         CLI   CTYPQ,C'T'          IF TIME AND NO INTEG REQUEST                 
         BE    *+12                                                             
         CLI   CTYPQ,C'4'                                                       
         BNE   *+12                                                             
         TM    STABSTAT,STABSINT   PREV BILL IS NOT FOR INT                     
         BO    RNB12                                                            
*                                                                               
         XC    WTYP,WTYP            SET TYPE TO TIME                            
         TM    STABSTAT,STABSINT                                                
         BZ    *+8                                                              
         MVI   WTYP,INTEGQ                                                      
*                                                                               
         LA    R3,BRKTAB                                                        
         USING BRKTABD,R3                                                       
RNB18    DS    0H                                                               
         ICM   RF,15,BRKCODE                                                    
         BZ    *+16                                                             
         BAS   RE,RNBBRKS-4(RF)                                                 
         LA    R3,BRKL(R3)                                                      
         B     RNB18                                                            
*                                                                               
         CLI   LORSW,C'Y'          FOR L'OREAL PUT S-MED INTO COMMENT           
         BNE   RNB19                                                            
         L     R5,ASORTCOM         SET DISK ADDRESS IN COMMENT                  
         USING SORTCOMD,R5                                                      
         MVC   SORTSMED,STABSTYP   PUT SUB-MEDIA IN COMMENT                     
         CLI   SORTSMED,C' '       IF NO SUBMEDIA, PUT 'N'                      
         BH    RNB19                                                            
         MVI   SORTSMED,C'N'                                                    
         DROP  R5                                                               
*                                                                               
RNB19    L     R5,ASORTDTA                                                      
         LA    R5,ROWHL(R5)                                                     
         LR    R1,R5                                                            
         LA    RF,ROWHL(R1)        CLEAR BILLED FIELDS                          
         BRAS  RE,ZAPSTR                                                        
         L     R0,STABGRS          ACCUMS ARE PACKED, SO WE'LL HAVE TO          
         CVD   R0,0(R5)            CONVERT: GROSS                               
         L     R0,STABNET                   NET                                 
         CVD   R0,ACCUMLQ(R5)                                                   
*                                  NOTE - SPOTS = 0                             
         L     RF,ASORTCOM                                                      
         MVC   SORTDA-SORTCOMD(,RF),KEY+14   SAVE DISK ADDRESS                  
*                                                                               
         BRAS  RE,TOSORT                                                        
*                                                                               
*                                  INVOICE LIST POSTING                         
*                                  --------------------                         
*                                  NOTE -MANUAL BILLS ARE TIME (X'00')          
*                                                                               
         CLI   LSTOPT,C'N'                                                      
         BE    RNB12                                                            
         CLI   SHOWREV,C'Y'        KEEP REVERSALS                               
         BE    *+12                                                             
         TM    STABINV,STABINV_REVERSAL+STABINV_REVERSED                        
         BNZ   RNB12               SKIP REVERSALS AND REVERSED                  
*                                                                               
*                                  SAVE INVOICE FOR LISTING                     
         XC    X,X                                                              
         LA    R6,X                                                             
         USING INVLD,R6                                                         
         ZAP   INVLGRS,=P'0'       REC WILL BE ADDED IF NOT FOUND               
         ZAP   INVLNET,=P'0'       SO, SET PACKED $ FIELDS                      
         GOTO1 DATCON,DMCB,(2,STABBDT),(3,WORK)                                 
         MVC   INVLYRMO,WORK       BILL YEAR/MONTH                              
         MVC   INVLINV,STABINV     BILL INVOICE NO.                             
         NI    INVLINV,X'FF'-X'C0' TURN OF REVERCE BITS                         
*                                                                               
*                                  SET PRODUCT,EST,MTK AND PER                  
*                                  ON SEPARATE BILLS                            
         CLC   APRDBRK,AINVBRK                                                  
         BNH   RNB22A                                                           
         OC    APGR1BRK,APGR1BRK                                                
         BZ    RNB22B                                                           
         CLC   APGR1BRK,AINVBRK                                                 
         BH    RNB22B                                                           
RNB22A   DS    0H                                                               
*        L     RF,VCLIST                                                        
*        CLC   STABKPRD,3(RF)                                                   
*        BE    *+12                                                             
*        LA    RF,4(RF)                                                         
*        B     *-14                                                             
         MVC   INVLPRD,STABKSTA                                                 
RNB22B   DS    0H                                                               
         CLC   AESTBRK,AINVBRK                                                  
         BH    *+10                                                             
         MVC   INVLEST,STABKEST                                                 
         MVC   INVLTYP,WTYP        CHARGE TYPE                                  
*                                                                               
         CLC   APERBRK,AINVBRK                                                  
         BH    *+10                                                             
         MVC   INVLPER,STABPER                                                  
*                                                                               
         OC    ASTABRK,ASTABRK                                                  
         BZ    *+20                                                             
         CLC   ASTABRK,AINVBRK                                                  
         BH    *+10                                                             
         MVC   INVLSTA,XXSTA                                                    
*                                                                               
         ICM   RE,15,STABGRS       CONVERT TO PCKD FOR INVLGRS                  
         CVD   RE,INVLGRS          GROSS                                        
         ICM   RE,15,STABNET                                                    
         CVD   RE,INVLNET          NET                                          
*                                                                               
         L     RF,=A(MOSLIST)                                                   
RNB23    CLI   0(RF),X'FF'         ANYTHING IN MOS TABLE?                       
         BE    RNB23B              NO, PUT IN MOS                               
         CLC   STABPER,0(RF)                                                    
         BE    RNB23D                                                           
         LA    RF,2(RF)            EXAMINE NXT MOS                              
         B     RNB23                                                            
RNB23B   MVC   0(2,RF),STABPER                                                  
         MVI   2(RF),X'FF'                                                      
*                                                                               
RNB23D   LA    RE,*+10             SWITCH TO 31 BIT MODE                        
         O     RE,=X'80000000'                                                  
         BSM   0,RE                                                             
*                                                                               
         MVI   INVTABL,1           INSERT IF NOT FOUND                          
*                                                                               
         GOTO1 BINSR31,INVPARS,X                                                
         OC    1(3,R1),1(R1)                                                    
         BNZ   *+6                                                              
         DC    H'0'                TABLE FULL: MUST INCREASE INVTBN             
*                                                                               
         TM    0(R1),X'80'         ALREADY THERE                                
         BO    RNB25               NO - NEXT ELEMENT                            
*                                                                               
         L     R1,0(R1)            ADD INTO EXISTING ELEMENT                    
INVLTABD USING INVLD,R1                                                         
         AP    INVLTABD.INVLGRS,INVLGRS                                         
         AP    INVLTABD.INVLNET,INVLNET                                         
         DROP  INVLTABD                                                         
         DROP  R6                                                               
*                                                                               
RNB25    LA    RE,*+6              SWITCH BACK TO 24 BIT MODE                   
         BSM   0,RE                                                             
*                                                                               
         B     RNB12               NEXT ELEMENT                                 
*                                                                               
RNB30    DS    0H                                                               
         B     RNB4                NEXT RECORD                                  
         SPACE 3                                                                
RNB40    DS    0H                                                               
         MVC   KEY,KEY1            RESTORE SEQ                                  
         GOTO1 HIGH                                                             
         SPACE 2                                                                
RNBX     DS    0H                                                               
         J     XIT                                                              
         SPACE 3                                                                
RNBBRKS  DS    0F                                                               
         B     RNBPGR1                                                          
         B     RNBPGR2                                                          
         B     RNBPGR3                                                          
         B     RNBKPRD                                                          
         B     RNBKEST                                                          
         DC    A(0)                MGR1                                         
         DC    A(0)                MGR2                                         
         DC    A(0)                MGR3                                         
         DC    A(0)                MARKET                                       
         B     RNBKSTA                                                          
         B     RNBKPKG                                                          
         B     RNBKPGM                                                          
         B     RNBKDESC                                                         
         B     RNBKPER                                                          
         B     RNBPERG                                                          
         B     RNBKCTYP                                                         
*                                                                               
         SPACE 2                                                                
RNBPGR1  DS    0H                                                               
         LA    R4,SAVPGRU                                                       
         B     RNBKALL                                                          
         SPACE 2                                                                
RNBPGR2  DS    0H                                                               
         LA    R4,SAVPGRU                                                       
         ZIC   RF,PGR1LEN                                                       
         AR    R4,RF               POINT TO PGR2                                
         B     RNBKALL                                                          
         SPACE 2                                                                
RNBPGR3  DS    0H                                                               
         LA    R4,SAVPGRU                                                       
         ZIC   RF,PGR2LEN                                                       
         AR    R4,RF               POINT TO PGR3                                
         B     RNBKALL                                                          
         SPACE 2                                                                
RNBKPRD  DS    0H                                                               
         LA    R4,SAVPRDC          PRODUCT                                      
         B     RNBKALL                                                          
         SPACE 2                                                                
RNBKEST  DS    0H                                                               
         LA    R4,STABKEST                                                      
         B     RNBKALL                                                          
         SPACE 2                                                                
RNBKPER  DS    0H                                                               
         LA    R4,PERDISP                                                       
         B     RNBKALL                                                          
         SPACE 2                                                                
RNBKSTA  DS    0H                                                               
         LA    R4,XXSTA                                                         
         B     RNBKALL                                                          
         SPACE 2                                                                
RNBPERG  DS    0H                  PERIOD GROUP                                 
         LA    R4,=C'1'            PRIOR MONTHS                                 
         CLC   STABPER,CURPER                                                   
         BNE   RNBKALL                                                          
         CLI   PRIOR,C'M'                                                       
         BNE   RNBKALL                                                          
         LA    R4,=C'5'            CURRENT MONTH                                
         B     RNBKALL                                                          
         SPACE 2                                                                
RNBKPGM  DS    0H                                                               
         BR    RE                                                               
         SPACE 2                                                                
RNBKDESC DS    0H                                                               
         XC    WORK(10),WORK                                                    
         MVI   WORK,X'FC'                   PREVIOUS MANUAL                     
         MVC   WORK+1(L'PERDISP),PERDISP    NEED TO SEPARATE MONTHS             
         MVC   WORK+2(3),STABKSTA           AND PRODUCTS                        
         MVC   WORK+5(L'STABKEST),STABKEST  AND ESTIMATES                       
         LA    R4,WORK                                                          
         B     RNBKALL                                                          
         SPACE 2                                                                
RNBKPKG  DS    0H                                                               
         LA    R4,=X'FF'           'LAST' PACKAGE                               
         B     RNBKALL                                                          
         SPACE 2                                                                
RNBKCTYP DS    0H                  CHARGE TYPE TIME OR INT                      
         LA    R4,=X'000000000000'                                              
         MVC   0(1,R4),WTYP                                                     
         B     RNBKALL                                                          
         SPACE 2                                                                
RNBKALL  DS    0H                                                               
         LA    R5,SORTKEY                                                       
         A     R5,BRKDISP                                                       
         L     RF,BRKLENM1                                                      
         EX    RF,*+6                                                           
         BR    RE                                                               
         MVC   0(0,R5),0(R4)                                                    
         SPACE 2                                                                
         DROP  R2                                                               
         DROP  R3                                                               
         DROP  R7                                                               
         SPACE 2                                                                
         LTORG                                                                  
         TITLE 'WNBILL - WRITE NEW BILL RECORDS'                                
WNBILL   NMOD1 0,WNBILL                                                         
         LA    RC,SPACEND                                                       
*                                                                               
         MVC   SAVR1,DMCB+3        SAVE CALLING CODE                            
*                                                                               
         CLI   PASSNO,1            ONLY FOR PASS 1                              
         BNE   WNEXT                                                            
         CLI   SORTTRCE,C'Y'                                                    
         BNE   *+14                                                             
         MVC   P+1(6),=C'WNBILL'                                                
         BRAS  RE,PRNT                                                          
*                                                                               
         CLI   SAVR1,1             JUST POSTING TO PEPTAB                       
         BE    WN50                                                             
*                                  MARKING MANUAL BILLS                         
*                                                                               
         L     RF,ACTYP                                                         
         MVC   WTYP,0(RF)                                                       
         L     R4,ASORTDTA                                                      
*                                                                               
         XC    BYTE3,BYTE3                                                      
         L     RF,ADESC                                                         
         CLI   0(RF),X'FC'         PREVIOUS MANUAL                              
         BNE   WN3                                                              
         L     RF,=A(CTYPTAB)      SEE IF CAN USE COSTTYPE TABLE                
         ST    RF,FULL             KEEP CURRENT POINTER                         
         USING CTYPTABD,RF                                                      
         CLI   0(RF),X'FF'         EOT?                                         
         BE    WN3                                                              
WN2      CLI   CTYPTYP,INTEGQ      CANNOT BE HIGHER THEN INTEG                  
         BNH   *+6                                                              
         DC    H'0'                SOMETHING GOT SCREWED UP                     
         MVC   WTYP,CTYPTYP                                                     
         LA    R4,CTYPORD          POINT TO $$ IN CTYP TABLE                    
         MVI   BYTE3,C'Y'                                                       
         DROP  RF                                                               
*                                                                               
WN3      LA    RF,ROWTL(R4)        POINT PAST COMPARE RANGE                     
         LR    RE,R4                                                            
WN5      CP    0(ACCUMLQ,RE),=P'0'                                              
         BNE   WN7                                                              
         LA    RE,ACCUMLQ(RE)                                                   
         CR    RE,RF                                                            
         BL    WN5                                                              
         CLI   ZEROSW,C'Y'                                                      
         BNE   WN30                                                             
*                                                                               
WN7      L     R7,=A(STABUCKC)                                                  
         XC    0(256,R7),0(R7)                                                  
         ST    R7,AREC                                                          
*                                                                               
         L     RF,ADESC                                                         
         CLI   0(RF),X'FB'         CURRENT MANUAL                               
         BE    WN10                                                             
         CLI   0(RF),X'FC'         PREVIOUS MANUAL                              
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
*                                  PREVIOUS MANUAL                              
         L     RF,ASORTCOM         HAVE DISK ADDRESS                            
         MVC   KEY+14(L'SORTDA),SORTDA-SORTCOMD(RF)                             
         B     WN11                                                             
*                                                                               
WN10     DS    0H                  CURRENT MANUAL BILLS                         
         MVC   KEY1,KEY                                                         
         XC    KEY,KEY                                                          
KEY@     USING STABUCKD,KEY                                                     
*                                                                               
         MVC   KEY@.STABKCOD,=X'0E01'                                           
         MVC   KEY@.STABKAM,BAGYMD                                              
         MVC   KEY@.STABKCLT,BCLT                                               
*                                                                               
         L     RE,APRD                                                          
*        ZIC   RE,0(RF)            GET PRODUCT CODE FROM PRODUCT SEQ            
*        MHI   RE,4                                                             
*        L     RF,VCLIST                                                        
*        LA    RF,0(RF,RE)                                                      
         L     RF,VCLIST                                                        
         CLC   0(3,RE),0(RF)                                                    
         BE    *+12                                                             
         LA    RF,4(RF)                                                         
         B     *-14                                                             
*                                                                               
         MVC   KEY@.STABKPRD,3(RF) PRODUCT                                      
         MVC   KEY@.STABKSTA,0(RF) PUT 3 CHAR PROD INSTEAD OF STATION           
         L     RF,AEST                                                          
         MVC   KEY@.STABKEST,0(RF) ESTIMATE                                     
         MVC   KEY@.STABKMKT,XXMKT SET MARKET TO DUMMY                          
*                                  BUILD DUMMY RECORD FOR ADD                   
         USING STABUCK,R7                                                       
         MVC   STABUCK(13),KEY     INCLUDING STATUS                             
         XC    KEY@.STABKMKT(5),KEY@.STABKMKT CLEAR MKT/STA, MIGHT BE           
         DROP  KEY@                           OLD ZZZZ STATION                  
         MVC   STABLEN,=H'24'                                                   
         OI    STABCNTL,X'02'      NET SYSTEM INDICATOR                         
         MVC   STABAGYA,AGY                                                     
         MVI   BYTE2,C'A'          SET FOR ADD                                  
*                                  OR GET RECORD IF IT EXISTS                   
         GOTO1 HIGH                                                             
         CLC   KEY(7),KEYSAVE                                                   
         BNE   WN12                                                             
*                                                                               
WN11     DS    0H                                                               
         GOTO1 GET                                                              
*                                                                               
         MVI   BYTE2,C'P'          SET FOR PUT                                  
WN12     DS    0H                                                               
         MVI   BYTE,0              CLEAR RECORD ACTIVITY SWITCH                 
         XC    X,X                 BUILD ELEMENT IN X                           
         LA    R6,X                                                             
         USING STABELEM,R6                                                      
         MVC   STABELEM(2),=X'0E13'  LENGTH INCLUDING STABSTAT                  
         MVC   STABBDT,TODAYP                                                   
         MVC   STABINV,INVNO                                                    
         L     RF,APER                                                          
         ZIC   R5,0(RF)                                                         
         LA    R5,PERLIST(R5)                                                   
         MVC   STABPER,PERLMOS-PERLISTD(R5)                                     
         CLI   WTYP,INTEGQ        IS THIS INTEGRATION MANUAL ?                  
         BNE   *+8                                                              
         OI    STABSTAT,STABSINT                                                
*                                                                               
         LA    R2,WORK                                                          
         LHI   R0,ROWHL/ACCUMLQ    BCT                                          
WN14     DS    0H                                                               
         MVC   0(ACCUMLQ,R2),0(R4)              ORDERED R4 -> TO SRTDTA         
         SP    0(ACCUMLQ,R2),ROWHL(ACCUMLQ,R4)  LESS BILLED                     
         LA    R2,ACCUMLQ(R2)                                                   
         LA    R4,ACCUMLQ(R4)                                                   
         BCT   R0,WN14                                                          
*                                                                               
         LA    R1,W                                                             
         LA    RF,ROWHL(R1)                                                     
         BRAS  RE,ZAPSTR                                                        
         CP    WORK(ACCUMLQ),=P'-2100000000'                                    
         BH    WN14K                                                            
         AP    WORK(ACCUMLQ),=P'2000000000'                                     
         ZAP   W(ACCUMLQ),=P'-2000000000'                                       
WN14K    CVB   R1,WORK                                                          
         ST    R1,STABGRS          GROSS                                        
         CP    WORK+ACCUMLQ(ACCUMLQ),=P'-2100000000'                            
         BH    WN14R                                                            
         AP    WORK+ACCUMLQ(ACCUMLQ),=P'2000000000'                             
         ZAP   W+ACCUMLQ(ACCUMLQ),=P'-2000000000'                               
WN14R    CVB   R1,WORK+ACCUMLQ                                                  
         ST    R1,STABNET          NET                                          
         XC    STABSPTS,STABSPTS   SPOTS = 0                                    
         MVC   STABSTYP,MEDFILT    SET SUB-MEDIA FILTER IN ELEMENT              
*                                                                               
         OC    STABGRS,STABGRS     ZERO GROSS?                                  
         BNZ   WN15                NO                                           
         OC    STABNET,STABNET     ZERO NET?                                    
         BNZ   WN15                NO                                           
         OC    STABTAX,STABTAX     TAX?                                         
         BZ    WN30                NO - SKIP                                    
*                                                                               
*                                  FIND PLACE FOR ELEMENT AND ADD IT            
WN15     LA    R2,STABUCK                                                       
         LA    R2,24(R2)           BUMP TO FIRST ELEMENT                        
STABREC  USING STABELEM,R2                                                      
WN20     DS    0H                                                               
         CLI   0(R2),0             EOR                                          
         BE    WN22                                                             
         CLC   X(6),STABREC.STABELEM  COMPARE DATES                             
         BL    WN22                                                             
         OC    MANRVDTP,MANRVDTP   IS THIS A REVERSAL BILL?                     
         BZ    WN21                NO                                           
         CLC   STABREC.STABBDT,MANRVDTP                                         
         BNE   WN21                                                             
         CLC   STABREC.STABINV,MANRVNO                                          
         BNE   WN21                                                             
         OI    STABREC.STABINV,STABINV_REVERSED  SET ELEMENT REVERSED           
WN21     DS    0H                                                               
         ZIC   R0,1(R2)            NEXT ELEMENT                                 
         AR    R2,R0                                                            
         B     WN20                                                             
         DROP  STABREC                                                          
*                                                                               
WN22     DS    0H                                                               
         OC    MANRVDTP,MANRVDTP   IS THIS A REVERSAL BILL?                     
         BZ    *+8                                                              
         OI    STABINV,STABINV_REVERSAL   YES -- SET REVERSAL ELEMENT           
         GOTO1 RECUP,DMCB,STABUCK,X,(R2)                                        
*                                                                               
         MVI   BYTE,1              SET ACTIVITY FOR THIS RECORD                 
*                                  ADD INTO REQUEST TOTALS                      
         L     RE,STABGRS          KEPT IN BINARY IN STA BUCKET REC             
         CVD   RE,MYPACKED         PACK IT                                      
         AP    NBTOTG,MYPACKED     GROSS                                        
         L     RE,STABNET          KEPT IN BINARY IN REC                        
         CVD   RE,MYPACKED         PACK IT                                      
         AP    NBTOTN,MYPACKED     NET                                          
*                                                                               
         L     RF,APATCH                                                        
         TM    0(RF),X'80'         TRACE OUTPUT RECORDS?                        
         BZ    WN25                                                             
*                                                                               
         MVC   P(18),=C'MANUAL BILL RECORD'                                     
         CLI   BYTE,0                                                           
         BNE   *+18                                                             
         MVC   P+22(9),=C'NO CHANGE'                                            
         BRAS  RE,PRNT                                                          
         B     WN25                                                             
*                                                                               
         CLI   BYTE2,C'A'                                                       
         BNE   *+14                                                             
         MVC   P+22(5),=C'(ADD)'                                                
         B     WN24                                                             
         GOTO1 HEXOUT,DMCB,KEY+14,P+22,4,=C'N'                                  
WN24     GOTO1 =V(PRTREC),DMCB,(R7),(24,13),PRINT,HEXOUT,C'DOME',(30,P)         
*                                                                               
WN25     DS    0H                                                               
         XC    STABGRS,STABGRS     CLEAR FIELDS, WILL RE-USE THEM               
         XC    STABNET,STABNET     IF OVER 21M IN PREV BILLING                  
         CP    W(ACCUMLQ),=P'0'                                                 
         BE    WN26                                                             
         CVB   R1,W                                                             
         ST    R1,STABGRS          GROSS                                        
         ZAP   W(ACCUMLQ),=P'0'                                                 
         CP    W+ACCUMLQ(ACCUMLQ),=P'0'                                         
         BE    WN15                                                             
         CVB   R1,W+ACCUMLQ                                                     
         ST    R1,STABNET          NET                                          
         ZAP   W+ACCUMLQ(ACCUMLQ),=P'0'                                         
         B     WN15                                                             
WN26     CLI   BYTE,0              ANY ACTIVITY ON THIS RECORD?                 
         BE    WN35                                                             
         CLI   TESTFLAG,C'T'                                                    
         BE    WN28                                                             
         L     RF,PUT                                                           
         CLI   BYTE2,C'P'                                                       
         BE    *+8                                                              
         L     RF,ADD                                                           
         BASR  RE,RF                                                            
WN28     CLI   BYTE2,C'A'          NEED TO ADD PASSIVE ?                        
         BNE   WN35                                                             
         MVC   FULL,8(R1)          STORE DISK ADDR                              
         XC    KEY,KEY                                                          
KEY@     USING STABUCKD,KEY                                                     
*                                                                               
         MVC   KEY@.STABPCOD,=X'0E81'                                           
         MVC   KEY@.STABPAM,BAGYMD                                              
         MVC   KEY@.STABPCLT,BCLT                                               
         L     RE,APRD                                                          
         MVC   KEY@.STABPPRD,0(RE)                                              
         L     RE,AEST                                                          
         MVC   KEY@.STABPEST,0(RE)                                              
         OI    KEY@.STABKSTS,X'02' NET INDICATOR                                
         MVC   KEY@.STABDA,FULL         DISK ADDR                               
         DROP  KEY@                                                             
         CLI   TESTFLAG,C'T'                                                    
         BE    WN30                                                             
         CLI   RCWRITE,C'Y'        WRITE=YES?                                   
         BNE   WN30                                                             
         GOTO1 DATAMGR,DMCB,DMADD,=C'SPTDIR',KEY,KEY                            
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
WN30     DS    0H                                                               
         L     RF,APATCH                                                        
         TM    0(RF),X'80'         TRACE OUTPUT RECORDS?                        
         BZ    WN35                                                             
         CLI   BYTE2,C'A'          PASSIVE                                      
         BNE   WN35                                                             
         MVC   P(15),=C'PASSIVE POINTER'                                        
         GOTO1 HEXOUT,DMCB,KEY,P+20,20                                          
         BRAS  RE,PRNT                                                          
*                                                                               
WN35     CLI   BYTE3,C'Y'          ARE WE USING CTYP TAB?                       
         BNE   WNEXT               NO, DONE                                     
         L     RF,FULL                                                          
         LA    RF,CTYPTBL(RF)      NXT ENTRY                                    
         CLI   0(RF),X'FF'         EOT?                                         
         BE    WNEXT               DONE                                         
         ST    RF,FULL                                                          
         B     WN2                                                              
         DROP  R6                                                               
         DROP  R7                                                               
         SPACE 3                                                                
         EJECT                                                                  
*                                  ADD TO PRD-EST-PER TABLE                     
*                                                                               
WN50     DS    0H                                                               
         L     R4,BRKCODE-BRKTABD(R3)   R3 POINTS TO BREAK LEVEL                
         L     R4,ATOTS(R4)        POINT TO ACCUMULATOR                         
         LA    R5,PERLIST          DATE LIST                                    
         USING PERLISTD,R5                                                      
*                                                                               
WN58     DS    0H                                                               
         CLI   0(R5),0             SKIP NON-EXISTENT MONTHS                     
         BE    WN69                                                             
         CLI   0(R5),X'FF'                                                      
         BE    WN69                                                             
         LR    RF,R4               R4 -> TO ACCUMULATOR IN STORAGE              
         LA    RE,ROWL(R4)         POINT PAST ACCUMULATOR                       
WN58A1   CP    0(ACCUMLQ,RF),=P'0' CHECK FOR ANY $ IN ACCUMULATORS              
         BNE   WN58A                                                            
         LA    RF,ACCUMLQ(RF)      NEXT ACCUMULATOR                             
         CR    RF,RE                                                            
         BL    WN58A1                                                           
*                                                                               
         CLI   ZEROSW,C'Y'                                                      
         BNE   WN69                                                             
         CLC   CURPER,PERLMOS      FOR ZERO BILLS, STILL                        
         BNE   WN69                ONLY DO CURRENT MONTH                        
*                                                                               
WN58A    DS    0H                                                               
         LR    R3,R4               FIRST DO TIME CHARGES                        
WN58B    DS    0H                                                               
         LR    RF,R3                                                            
         CLC   0(ROWHL,RF),ROWHL(RF)  NO $                                      
         BNE   *+12                                                             
         CLI   ZEROSW,C'Y'                                                      
         BNE   WN68                                                             
*                                                                               
         LA    R2,W                                                             
         LHI   R0,ROWHL/ACCUMLQ    BCT                                          
WN59     DS    0H                                                               
         MVC   0(ACCUMLQ,R2),0(RF)              ORDERED                         
         SP    0(ACCUMLQ,R2),ROWHL(ACCUMLQ,RF)  LESS BILLED                     
         LA    R2,ACCUMLQ(R2)                                                   
         LA    RF,ACCUMLQ(RF)                                                   
         BCT   R0,WN59                                                          
*                                                                               
         XC    X,X                                                              
         LA    R2,X                                                             
         USING PEPTD,R2                                                         
         LA    R1,PEPTNAOS         POINT TO $ FIELDS IN PEPTD ...               
         LA    RF,L'PEPTNAOS+L'PEPTAORS(R1)                                     
         BRAS  RE,ZAPSTR           ... TO ZAP THEM                              
         L     RF,APRD                                                          
         MVC   PEPTPRD,0(RF)       PRODUCT                                      
         L     RF,AEST                                                          
         MVC   PEPTEST,0(RF)       ESTIMATE                                     
         CLI   PEPTEST,0                                                        
         BNE   *+6                                                              
         DC    H'0'                MUST HAVE A VALID ESTIMATE                   
*                            COULD HAVE BEEN ZLOPT=A AND FORMAT 1 OR 5          
         MVC   PEPTMOS,PERLMOS     YM                                           
*                                                                               
         L     RF,ADESC            CHECK FOR MANUAL BILL                        
         CLI   0(RF),X'FB'                                                      
         BL    WN59C                                                            
         MVC   PEPTMANG,W          GROSS                                        
         MVC   PEPTMANN,W+ACCUMLQ  NET                                          
         CLI   LORSW,C'Y'          IF L'OREAL PUT INTO ELEMS                    
         BNE   WN59F                                                            
*                                                                               
WN59C    L     RF,ASORTCOM         FINDOUT SUB MEDIA                            
         USING SORTCOMD,RF                                                      
         L     RE,=A(SMEDTAB)                                                   
         CLC   SORTSMED,0(RE)                                                   
         BE    *+18                                                             
         LA    RE,L'SMEDTAB(RE)                                                 
         CLI   0(RE),X'FF'                                                      
         BNE   *-18                                                             
         DC    H'0'                                                             
         DROP  RF                                                               
*                                                                               
         ZIC   RF,1(RE)                                                         
         MHI   RF,(L'PEPTGRSN*2)                                                
         LA    RE,PEPTNAOS                                                      
         AR    RE,RF                                                            
         MVC   0(L'PEPTGRSN,RE),W           GROSS                               
         MVC   L'PEPTGRSN(L'PEPTNETN,RE),W+ACCUMLQ   NET                        
*                                                                               
WN59F    MVC   PEPTGR2,W+ACMORD2-ACMORD GROSS2                                  
         CLI   PROFB2A+6,C'Y'      APPLYING AOR % ONLY TO TIME ?                
         BNE   *+10                                                             
         CR    R3,R4               ASSUME TIME AMOUNTS ARE ALWAYS FIRST         
         BNE   WN60                IF NOT TIME $$ DON'T ADD THEM IN             
         MVC   PEPTAGRS,W          AND AOR GROSS                                
         CLI   PROFB2A+5,C'Y'      BUT IF USING COST2 BASIS...                  
         BNE   *+10                                                             
         MVC   PEPTAGRS,W+ACMORD2-ACMORD   ... THEN PICK UP COST2 GROSS         
         MVC   PEPTANET,W+ACCUMLQ  AND AOR NET                                  
*                                                                               
WN60     GOTO1 BINSRCH,PEPPARS,(1,PEPTD)                                        
         OC    1(3,R1),1(R1)                                                    
         BNZ   *+6                                                              
         DC    H'0'                TABLE FULL                                   
         CLI   0(R1),1             IF SUCH REC NOT FOUND - INSERT               
         BE    WN68                                                             
*                                  ADD TOTALS IN                                
         L     R2,0(R1)            R2 -> TO EXISTING PEPTAB REC                 
*                                  X HAS REC PASSED TO BINSRCH WITH             
PEPD     USING PEPTD,X             SAME KEY                                     
         AP    PEPTGRSN,PEPD.PEPTGRSN                                           
         AP    PEPTNETN,PEPD.PEPTNETN                                           
         AP    PEPTGRSC,PEPD.PEPTGRSC                                           
         AP    PEPTNETC,PEPD.PEPTNETC                                           
         AP    PEPTGRSS,PEPD.PEPTGRSS                                           
         AP    PEPTNETS,PEPD.PEPTNETS                                           
         AP    PEPTGRSO,PEPD.PEPTGRSO                                           
         AP    PEPTNETO,PEPD.PEPTNETO                                           
         AP    PEPTGRSD,PEPD.PEPTGRSD                                           
         AP    PEPTNETD,PEPD.PEPTNETD                                           
         AP    PEPTMANG,PEPD.PEPTMANG                                           
         AP    PEPTMANN,PEPD.PEPTMANN                                           
         AP    PEPTGR2,PEPD.PEPTGR2                                             
         AP    PEPTAGRS,PEPD.PEPTAGRS                                           
         AP    PEPTANET,PEPD.PEPTANET                                           
*                                  CLEAR 'ALREADY DONE' BITS                    
         DROP  PEPD                                                             
         NI    PEPTSTAT,X'FF'-(PEPTSTRD+PEPTSTAD)                               
*                                                                               
WN68     DS    0H                                                               
         LA    R3,ROWTL(R3)        NEXT TYPE CHARGE                             
         LA    R0,ROWNL(R4)        END OF CHARGES?                              
         CR    R3,R0                                                            
         BL    WN58B                                                            
*                                                                               
WN69     DS    0H                                                               
         LA    R4,ROWL(R4)         NEXT MONTH                                   
         LA    R5,PERLISTL(R5)                                                  
         LA    R0,PERLISTX                                                      
         CR    R5,R0                                                            
         BL    WN58                                                             
         DROP  R5                                                               
         DROP  R2                                                               
*                                                                               
WNEXT    DS    0H                                                               
         J     XIT                                                              
         SPACE 3                                                                
         LTORG                                                                  
         TITLE 'WOBILL - WRITE OLD-STYLE BILL RECS'                             
WOBILL   NMOD1 0,WOBILL                                                         
         LA    RC,SPACEND                                                       
*                                                                               
         CLI   SORTTRCE,C'Y'                                                    
         BNE   *+14                                                             
         MVC   P+1(14),=C'WRITE OLD BILL'                                       
         BRAS  RE,PRNT                                                          
*                                                                               
         L     R7,ADBILL                                                        
         USING BILLREC,R7                                                       
*                                                                               
         XC    BILLREC,BILLREC                                                  
         MVC   BKEYAM,BAGYMD       AM                                           
         MVC   BKEYCLT,BCLT        CLIENT                                       
*                                  SET BILL MON IN ONE BYTE                     
         UNPK  BKEYMBIL,TODAY+1(1)                                              
         NI    BKEYMBIL,X'FF'-X'0F'                                             
         OC    BKEYMBIL,TODAYB+1                                                
         MVC   BKEYINV,INVNO                                                    
         MVC   BLINKS+4(L'AGY),AGY                                              
*                                                                               
         MVC   BINVNO,SVINVMO      SVINVMO IS SET IN GETNUM                     
******** LH    R0,INVNO            (BINVNO(2) IS NOW PRTD MONTH OR YM)          
******** CVD   R0,DUB                                                           
******** OI    DUB+7,X'0F'                                                      
******** UNPK  BINVNO+2(4),DUB                                                  
*                                                                               
         MVC   BDATE,TODAY                                                      
         MVI   BTYPE,C'B'                                                       
         MVC   BTYPE+1(L'TYPE),TYPE                                             
         MVC   BLMGR,SPACES                                                     
         MVC   BLMKT,SPACES                                                     
         CLI   QWEEKNO,C' '        ANYTHING IN WEEK FIELD?                      
         BNH   *+18                                                             
         PACK  DUB,QWEEKNO         PUT WEEK NUMBER IN                           
         CVB   R0,DUB                                                           
         STC   R0,BILWKNO                                                       
*                                                                               
         MVC   BCALNDR,SPOTPROF+2  TYPE OF CALENDAR                             
*                                                                               
         MVC   BMASPRD,MASPRDCD    MASTER PRODUCT CODE                          
         MVC   BMASPRDC,MASPRDCT   MASTER PRODUCT CODE 3CHAR ALPHA              
*                                                                               
         MVC   BQDATE,EINVDTE                                                   
         MVC   BDUEDATE,BDUEDTE                                                 
*                                                                               
         MVC   BLREVDAT,MANRVDTP   DATE OF REVERSED INVOICE                     
         MVC   BLREVINO,MANRVNO    REVERSED INVOICE NUMBER                      
         MVC   BILLUID,RCORIGID    REQUESTING USER ID                           
*                                                                               
*                                  CREATE BILLS FROM PRD-EST-PER TABLE          
         L     R4,APEPTAB          A(TABLE)                                     
         USING PEPTD,R4                                                         
         ICM   R6,15,PEPTABN       FOR BCT                                      
         BNZ   *+6                                                              
         DC    H'0'                                                             
*                                                                               
WO4      DS    0H                                                               
         MVC   BLEN,=Y(L'BILLREC)  INITIALIZE RECORD LENGTH                     
         CLI   DUESW,C'R'          UNLESS AOR BILL                              
         BE    WO4B                TEST ENTRY ALREADY DONE                      
         CLI   DUESW,C'A'          OR SEPARATE ADJUSTMENT INVOICE               
         BE    WO4A                                                             
         TM    PEPTSTAT,PEPTSTRD   REGULAR INVOICE ALREADY DONE?                
         BNZ   WO8B                YES, SKIP                                    
         OI    PEPTSTAT,PEPTSTRD   ELSE SET DONE                                
         B     WO4B                                                             
*                                                                               
WO4A     DS    0H                                                               
         TM    PEPTSTAT,PEPTSTAD   ADJUSTMENT INVOICE ALREADY DONE?             
         BNZ   WO8B                YES, SKIP                                    
         OI    PEPTSTAT,PEPTSTAD   ELSE SET DONE                                
*                                                                               
WO4B     DS    0H                  PRODUCT CODE                                 
***      ZIC   R2,PEPTPRD          GET PRODUCT CODE FROM PRODUCT SEQ            
***      MHI   R2,4                                                             
***      L     RF,VCLIST                                                        
***      LA    RF,0(RF,R2)                                                      
*                                                                               
*        MVC   BKEYPRD,0(RF)                                                    
         MVC   BKEYPRD,PEPTPRD                                                  
*                                                                               
         MVC   BKEYEST,PEPTEST     ESTIMATE                                     
         MVC   BKEYYSRV,PEPTMOS    YEAR OF SERVICE                              
         MVC   BKEYMSRV,PEPTMOS+1  MONTH OF SERVICE                             
         GOTO1 DATCON,DMCB,(3,PEPTMOS),DUB                                      
         MVC   BMONSERV,DUB                                                     
*                                                                               
         LA    R2,PERLIST                                                       
         LA    R1,PERLISTX                                                      
         USING PERLISTD,R2                                                      
WO5      DS    0H                                                               
         CLC   PEPTMOS,PERLMOS                                                  
         BE    *+16                                                             
         LA    R2,PERLISTL(R2)                                                  
         CR    R2,R1               PAST EOT ?                                   
         BL    WO5                                                              
         DC    H'0'                SHOULD NEVER HAPPEN                          
******** B     WO5                                                              
         MVC   BILSTADT,PERLSTRT   ACTUAL START DATE                            
         DROP  R2                                                               
*                                                                               
         MVI   BILSTAT2,0                                                       
         OC    MANRVDTP,MANRVDTP   IF A REVERSAL                                
         BZ    *+8                                                              
         OI    BILSTAT2,BSTRVSLQ   SET REVERSAL BIT ON                          
         CLI   PAYOPT,C'N'         IF CLEARED ONLY                              
         BE    *+8                                                              
         OI    BILSTAT2,BSTCLRDQ   SET THAT BIT ON                              
         CLI   PROFBN+3,C'D'       IF ACT MINUS ASS PLUS INT BILL               
         BE    *+12                                                             
         CLI   PROFBN+3,C'E'       IF ACUTAL MINUS ASSIGNED BILL                
         BNE   *+8                                                              
         OI    BILSTAT2,BSTAMAQ    SET THAT BIT ON                              
         CLI   COST2SW,C'Y'        IF COST2                                     
         BNE   *+8                                                              
         OI    BILSTAT2,BSTC2Q     SET COST2 BIT ON                             
*                                                                               
         MVI   BILSTAT,0                                                        
         CP    MANGRS,=P'0'        MANUAL BILL?                                 
         BE    *+8                                                              
         OI    BILSTAT,BSTMANQ                                                  
*                                                                               
         MVC   BILCTYP,PEPTCTYP    COST TYPE  (IF SEPARATE)                     
         MVC   BLPKG,PEPTPKG       PKG NUMBER (IF SEPARATE)                     
         MVC   BLPKGNM,PEPTPKGN    PKG NAME .LE. 5 CHARS (IF SEPARATE)          
*                                  (PKG AND PKGN WILL NOT BOTH EXIST)           
         CLI   DUESW,C'R'          IF THIS IS NOT AN AOR BILL                   
         BE    *+18                                                             
         OC    PEPTAORA,PEPTAORA   AND THERE IS AN AOR ACCOUNT                  
         BZ    *+8                                                              
         OI    BILSTAT,BSTCAORQ    THIS MUST BE AN AOR CLIENT BILL              
*                                                                               
         TM    PEPTSTAT,PEPTSTCO   COMM. ONLY BILL? (NOT ADJ. INVOICE)          
         BZ    *+8                                                              
         OI    BILSTAT,BSTCMONQ                                                 
*                                                                               
         CLI   SCBNCSW,C'N'        NET BILL IN SEPARATE COMM. SITUATION         
         BNE   *+8                                                              
         OI    BILSTAT,BSTSNETQ                                                 
*                                                                               
         CLI   SCBNCSW,C'C'        SCB TYPE COMMISSION BILL?                    
         BNE   WO5H                                                             
         CLI   DUESW,C'R'          AND NOT AOR                                  
         BE    WO6B                                                             
*                                                                               
         OI    BILSTAT,BSTSCOMQ    SEPARATE COMMISSION                          
         MVC   BAMT,=C'0000000000'                                              
         ZAP   BGRSP,=P'0'         CLEAR GROSS (PL6)                            
         XC    BNET,BNET                                                        
         ZAP   BNETP,=P'0'         AND NET (PL6)                                
         XC    BTAXAMT,BTAXAMT     AND TAX                                      
         ZAP   DUB,PEPTDUE         USE DUB NOT TO DESTROY PEPTDUE               
         SP    DUB,PEPTNETN        DUE LESS NET FOR ALL SUBMEDIA                
         SP    DUB,PEPTNETC                                                     
         SP    DUB,PEPTNETS                                                     
         SP    DUB,PEPTNETO                                                     
         SP    DUB,PEPTNETD                                                     
         CLI   LORSW,C'Y'          FOR L'OREAL MANUAL AMT ALREADY IN            
         BE    *+10                                                             
         SP    DUB,PEPTMANN        AND MANUAL                                   
         MVC   MYPACKED,DUB                                                     
         BRAS  RE,CKOVRFLO                                                      
         BNE   *+12                IF OVER 21M, DON'T WRITE BINARY OUT          
         CVB   R0,DUB                                                           
         STCM  R0,15,BACTUAL       =COMMISSION                                  
*                                                                               
         MVC   BACTP,MYPACKED+2    =COMMISSION (PL6)                            
*                                                                               
         XC    BCCGRS,BCCGRS       ZERO 2ND CURR FIELDS                         
         ZAP   BGRS2P,=P'0'                                                     
         XC    BCCNET,BCCNET                                                    
         ZAP   BNET2P,=P'0'                                                     
         XC    BCCTAX,BCCTAX                                                    
         XC    BCCACT,BCCACT                                                    
         ZAP   BACT2P,=P'0'                                                     
*                                                                               
*        NOTE- PUTTING GROSS AND NET IN SCB TYPE COMMISSION BILLS               
*              TO PROVIDE A CROSS CHECK WITH BUCKET RECORDS.                    
*                                                                               
         ZAP   MYPACKED,PEPTGRSN   ADD GROSS FOR ALL SUBMEDIA                   
         AP    MYPACKED,PEPTGRSC                                                
         AP    MYPACKED,PEPTGRSS                                                
         AP    MYPACKED,PEPTGRSO                                                
         AP    MYPACKED,PEPTGRSD                                                
         CLI   LORSW,C'Y'          FOR L'OREAL MANUAL AMT ALREADY IN            
         BE    *+10                                                             
         AP    MYPACKED,PEPTMANG   AND MANUAL                                   
*                                                                               
         BRAS  RE,CKOVRFLO                                                      
         UNPK  BAMT,MYPACKED       GROSS                                        
         MVC   BGRSP,MYPACKED+2    GROSS (PL6)                                  
         ZAP   MYPACKED,PEPTNETN   ADD NET FOR ALL SUBMEDIA                     
         AP    MYPACKED,PEPTNETC                                                
         AP    MYPACKED,PEPTNETS                                                
         AP    MYPACKED,PEPTNETO                                                
         AP    MYPACKED,PEPTNETD                                                
         CLI   LORSW,C'Y'                                                       
         BE    *+10                                                             
         AP    MYPACKED,PEPTMANN   AND MANUAL                                   
*                                                                               
         BRAS  RE,CKOVRFLO                                                      
         BNE   *+12                                                             
         CVB   R0,MYPACKED                                                      
         STCM  R0,15,BNET          NET                                          
*                                                                               
         MVC   BNETP,MYPACKED+2    NET (PL6)                                    
         MVC   MYPACKED,PEPTGR2                                                 
         BRAS  RE,CKOVRFLO                                                      
         BNE   *+12                                                             
         CVB   R0,PEPTGR2                                                       
         STCM  R0,15,BCCGRS        GROSS2 (COST2)                               
*                                                                               
         MVC   BGRS2P,PEPTGR2+2    GROSS2 (PL6)                                 
         CP    MANGRS,=P'0'        DON'T ADD FOR MANUAL BILL                    
         BE    *+12                                                             
         CLI   LORSW,C'Y'          FOR L'OREAL ADD ELEMS                        
         BNE   WO7                                                              
         BRAS  RE,ADDSMEL          OTHERWISE HAVE TO ADD SUBMED ELEM            
         B     WO7                                                              
*                                                                               
WO5H     DS    0H                                                               
         CLI   DUESW,C'A'          FOR ADJ. INVOICE ZERO GROSS AND NET          
         BNE   WO6B                                                             
*                                                                               
         MVC   BAMT,=C'0000000000'                                              
         ZAP   BGRSP,=P'0'         CLEAR GROSS (PL6)                            
         XC    BNET,BNET                                                        
         ZAP   BNETP,=P'0'         AND NET (PL6)                                
         ZAP   BGRS2P,=P'0'        CLEAR COS2 FIELDS (PL6)                      
         ZAP   BNET2P,=P'0'                                                     
         ZAP   BACT2P,=P'0'                                                     
*                                                                               
         MVC   MYPACKED,PEPTADJ                                                 
         BRAS  RE,CKOVRFLO                                                      
         BNE   *+12                                                             
         CVB   R0,PEPTADJ          ADJUSTMENT                                   
         STCM  R0,15,BACTUAL                                                    
*                                                                               
         MVC   BACTP,PEPTADJ+2     ADJUSTMENT (PL6)                             
         OC    BACTUAL,BACTUAL     ***SKIP IF NOT ADJUSTMENT AMOUNT (AT         
         BZ    WO8B                ***LEAST ONE ENTRY WILL BE NON-ZERO)         
         OI    BILSTAT,BSTSADJQ                                                 
         B     WO7                                                              
*                                                                               
WO6B     DS    0H                                                               
         CLI   DUESW,C'R'          FOR AOR INVOICE                              
         BNE   WO6C                                                             
         MVC   BAMT,=C'0000000000' CLEAR GROSS                                  
         ZAP   BGRSP,=P'0'         CLEAR GROSS (PL6)                            
         XC    BNET,BNET           AND NET                                      
         ZAP   BNETP,=P'0'         AND NET (PL6)                                
         ZAP   BGRS2P,=P'0'        CLEAR COS2 FIELDS (PL6)                      
         ZAP   BNET2P,=P'0'                                                     
         ZAP   BACT2P,=P'0'                                                     
*                                  SET ORIGINAL COMMISSION                      
         MVC   DUB,PEPTADUE        AOR DUE LESS NET                             
         SP    DUB,PEPTANET                                                     
         MVC   MYPACKED,DUB                                                     
         BRAS  RE,CKOVRFLO                                                      
         BNE   *+16                                                             
         CVB   RF,DUB                                                           
         STCM  RF,15,BAORCOM       AC (NOTE - OVERLAYS BNET IN BILLREC)         
         STCM  RF,15,BAORCOMN      ALSO SET IN NEW FIELD                        
*                                                                               
         MVC   BAORCOMP,MYPACKED+2 ALSO SET IN PACKED FIELD                     
*                                                                               
         MVC   MYPACKED,PEPTAOR    AOR AMOUNT                                   
         BRAS  RE,CKOVRFLO                                                      
         BNE   *+12                                                             
         CVB   R0,PEPTAOR                                                       
         STCM  R0,15,BACTUAL                                                    
*                                                                               
         MVC   BACTP,PEPTAOR+2                                                  
         CLI   PEPTAORA,C' '       SKIP IF NO AOR ACCOUNT                       
         BNH   WO8B                                                             
         OI    BILSTAT,BSTTAORQ    SET AOR BILL                                 
         CLI   AORLOPT,C'N'        IF AOR PRD/EST/MOS LIST                      
         BE    WO7                                                              
         MVC   BKEYINV,PEPTAORI    SET INVOICE NUMBER FROM PEPTAB               
         XC    DMCB,DMCB                                                        
         GOTO1 =V(SPFMTINO),DMCB,,(C'U',PEPTAORI)                               
         L     RF,DMCB+4                                                        
         OC    0(4,RF),0(RF)       IF NULLS -> INVALID                          
         BNZ   *+6                                                              
         DC    H'0'                                                             
         MVC   BINVNO+2(4),0(RF)                                                
******   SR    R0,R0                                                            
******   ICM   R0,3,PEPTAORI                                                    
******   CVD   R0,DUB                                                           
******   OI    DUB+7,X'0F'                                                      
******   UNPK  BINVNO+2(4),DUB     SET IN RECORD ALSO                           
         B     WO7                                                              
*                                                                               
WO6C     DS    0H                                                               
         ZAP   MYPACKED,PEPTGRSN   ADD GROSS FOR ALL SUBMEDIA                   
         AP    MYPACKED,PEPTGRSC                                                
         AP    MYPACKED,PEPTGRSS                                                
         AP    MYPACKED,PEPTGRSO                                                
         AP    MYPACKED,PEPTGRSD                                                
         CLI   LORSW,C'Y'                                                       
         BE    *+10                                                             
         AP    MYPACKED,PEPTMANG   AND MANUAL                                   
*                                                                               
         BRAS  RE,CKOVRFLO                                                      
         UNPK  BAMT,MYPACKED       GROSS                                        
         MVC   BGRSP,MYPACKED+2    GROSS (PL6)                                  
         ZAP   MYPACKED,PEPTNETN   ADD GROSS FOR ALL SUBMEDIA                   
         AP    MYPACKED,PEPTNETC                                                
         AP    MYPACKED,PEPTNETS                                                
         AP    MYPACKED,PEPTNETO                                                
         AP    MYPACKED,PEPTNETD                                                
         CLI   LORSW,C'Y'                                                       
         BE    *+10                                                             
         AP    MYPACKED,PEPTMANN   AND MANUAL                                   
*                                                                               
         BRAS  RE,CKOVRFLO                                                      
         BNE   *+12                                                             
         CVB   R0,MYPACKED         NET                                          
         STCM  R0,15,BNET                                                       
*                                                                               
         MVC   BNETP,MYPACKED+2    NET (PL6)                                    
         CP    MANGRS,=P'0'        DON'T ADD FOR MANUAL BILL                    
         BE    *+12                                                             
         CLI   LORSW,C'Y'          FOR L'OREAL ADD ELEMS                        
         BNE   *+8                                                              
         BRAS  RE,ADDSMEL          OTHERWISE HAVE TO ADD SUBMED ELEM            
*                                                                               
         MVC   DUB,PEPTDUE         ACTUAL (USE DUB NOT TO MODIFY IT)            
         CLI   ADJSEP,C'Y'         IF THIS IS NORMAL BILL                       
         BNE   *+10                BUT ADJUSTMENT IS SEPARATE                   
         SP    DUB,PEPTADJ         THEN SUBTR ADJ. FROM THIS BILL               
         MVC   MYPACKED,DUB                                                     
         BRAS  RE,CKOVRFLO                                                      
         BNE   *+12                                                             
         CVB   R0,DUB                                                           
         STCM  R0,15,BACTUAL                                                    
*                                                                               
         MVC   BACTP,MYPACKED+2                                                 
*                                                                               
         ZAP   BGRS2P,=P'0'        CLEAR COS2 FIELDS (PL6)                      
         ZAP   BNET2P,=P'0'                                                     
         ZAP   BACT2P,=P'0'                                                     
         CLI   COST2SW,C'Y'        COST2?                                       
         BNE   WO7                                                              
*                                                                               
         MVC   MYPACKED,PEPTGR2                                                 
         BRAS  RE,CKOVRFLO                                                      
         BNE   *+12                                                             
         CVB   R0,PEPTGR2          GROSS2                                       
         STCM  R0,15,BCCGRS                                                     
*                                                                               
         MVC   BGRS2P,PEPTGR2+2    GROSS2 (PL6)                                 
         MVC   BCCNET,BNET         NET (= AGY NET???, OR MAYBE ZERO???)         
         MVC   BNET2P,BNETP        NET2 (PL6)                                   
         MVC   BCCACT,BACTUAL      ACTUAL (DEFINITELY = AGY ACTUAL)             
         MVC   BACT2P,BACTP        ACT2 (PL6)                                   
*                                                                               
WO7      DS    0H                  SET MGR AND MARKET                           
         CLC   AMGR1BRK,AINVBRK    MGR SEPARATE?                                
         BH    *+10                                                             
         MVC   BLMGR,MGR3                                                       
         CLC   ASTABRK,AINVBRK     STATION SEPARATE?                            
         BH    *+10                                                             
         MVC   BLSTATN,BIGSTA      **NOTE- STATION OVERLAYS BLMGR)              
         CLC   AMKTBRK,AINVBRK     MARKET SEPARATE?                             
         BH    *+10                                                             
         MVC   BLMKT,MKT                                                        
*                                                                               
         MVC   BLDPT,DPTFILT       SET DAYPART FILTER                           
         MVC   BLMED,MEDFILT       AND SUB-MEDIA FILTER                         
*                                                                               
         CLI   DPTFILT,C' '        IF HAVE DPTFILT, OK                          
         BH    WO7D                                                             
         CLI   DPTSEP,C'S'                                                      
         BNE   WO7D                                                             
         ICM   RF,15,ADPT          ELSE MAY BE 'SEP'                            
         BZ    WO7D                                                             
         MVC   BLDPT,0(RF)         IN WHICH CASE SET IT IN RECORD               
*                                                                               
WO7D     DS    0H                                                               
*                                  ADD INTO REQUEST TOTALS                      
*        PACK  DUB,BAMT                                                         
         AP    OBTOTG,BGRSP                                                     
         CLI   DUESW,C'R'          FOR AOR SKIP NET                             
         BE    *+10                (IT IS REALLY AC FROM ORIGINAL BILL)         
*        ICM   R0,15,BNET                                                       
*        CVD   R0,DUB                                                           
         AP    OBTOTN,BNETP                                                     
*                                                                               
         CLI   COST2SW,C'Y'                                                     
         BNE   *+10                                                             
         AP    OBTOTG2,BGRS2P                                                   
*                                                                               
         MVC   BILBFP,PEPTBFP      BILL FORMULA PCT                             
         MVC   BILBFB,PEPTBFB      AND BASIS                                    
         MVC   BILSTABF,PEPTBFFL   AND BASIS FLAGS                              
*                                                                               
         OI    BILSTAT3,BSTCNV1Q+BSTCNV2Q  INDICATING PAST CONVERSIONS          
         CLI   UPDTSOON,C'Y'       UPDATIVE SOON?                               
         BNE   *+8                                                              
         OI    BILSTAT3,BSTSOONQ   WAS GENERATED VIA SOON                       
*                                                                               
         CLI   TESTFLAG,C'T'                                                    
         BE    WO8                                                              
*                                                                               
         OI    DMINBTS,X'08'       PASS DELETES                                 
         MVI   DMOUTBTS,X'FF'-X'02' DELETED RECORDS ARE OK                      
         MVC   KEY,BKEY            SEE IF KEY ALREADY ON FILE                   
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BNE   *+6                                                              
         DC    H'0'                                                             
         NI    DMINBTS,X'FF'-X'08' NO LONGER PASS DELETES                       
         MVI   DMOUTBTS,X'FF'      NO DATAMGR ERRORS ARE ACCEPTABLE             
*                                                                               
         CLI   RCWRITE,C'Y'                                                     
         BNE   WO8                                                              
         GOTO1 ADDBILL                                                          
         MVC   SVPACCT,PEPTPACT    SET PRODUCT ACCT NO FOR INTERFACE            
*                                                                               
WO8      DS    0H                                                               
         GOTO1 ABILLEDI,DMCB,('EDMHDR',0)   EDI CALL                            
*                                                                               
         CLI   QINVREG,C'B'        WANT BT IN STEAD OF INV REGISTER ?           
         BE    WO8A                YES, DON'T ADD THIS TO DATASET               
*                                                                               
         CLI   OUTDDFLG,C'Y'       IS "OUT" DD STATEMENT PRESENT?               
         BNE   WO8A                NO                                           
         L     RE,=A(STABUCKC)     PREPARE TO PUT HEADER TO SEQ FILE            
         SR    RF,RF                                                            
         ICM   RF,3,BLEN           L'RECORD                                     
         LR    R0,RF                                                            
         AHI   R0,4                L'RECORD +4(FOR RDW)                         
         STH   R0,0(RE)            PUT L'RECORD IN FIRST 2 BYTES OF RDW         
         XC    2(2,RE),2(RE)       CLEAR 2ND HALFWORD OF RDW                    
         LR    R1,RF               L'RECORD                                     
         LR    R0,R7               R0 = A(RECORD)                               
         LA    RE,4(RE)            COPY HEADER RECORD INTO I/O AREA+4           
         MVCL  RE,R0               VARIABLE LENGTH RECORD IS NOW BUILT          
         L     R3,=A(STABUCKC)     A(RECORD)                                    
         L     R2,=A(OUT)                                                       
         PUT   (R2),(R3)           WRITE TO SYSDA FILE                          
         MVI   HAVEBILL,C'Y'       WE CAN PRINT AN INVOICE REGISTER             
*                                                                               
WO8A     DS    0H                                                               
         L     RF,APATCH                                                        
         TM    0(RF),X'80'         TRACE RECORDS?                               
         BZ    WO8B                                                             
         SR    R0,R0                                                            
         ICM   R0,3,BLEN                                                        
         GOTO1 PRNTBL,DMCB,=C'ADDING BILL HEADER',BILLREC,C'DUMP',     +        
               (R0),=C'1D'                                                      
*                                                                               
WO8B     DS    0H                  CLEAR NON-AOR AMOUNT FIELDS                  
         CLI   ADJSEP,C'Y'         UNLESS SEPARATE COMMISSION ADJ.              
         BE    *+16                                                             
         TM    PEPTSTAT,PEPTSTRD   CLEAR AFTER REG BILL                         
         BNZ   WO8F                                                             
         B     WO9                                                              
*                                                                               
*                                  IF SEPARATE COMMISSION ADJUSTMENT            
         TM    PEPTSTAT,PEPTSTAD   CLEAR AFTER DOING IT                         
         BZ    WO9                                                              
*                                                                               
WO8F     DS    0H                                                               
         LA    RE,PEPTNAOS         POINT TO FIRST FIELD TO ZAP                  
         LA    RF,L'PEPTNAOS(RE)   POINT PAST LAST FIELD TO ZAP                 
WO8FA    ZAP   0(ACCUMLQ,RE),=P'0'                                              
         LA    RE,ACCUMLQ(RE)      NEXT AMOUNT                                  
         CR    RE,RF                                                            
         BL    WO8FA                                                            
*                                                                               
WO9      DS    0H                                                               
         A     R4,PEPTABL          NEXT PEPTAB ENTRY                            
         BCT   R6,WO4                                                           
*                                                                               
         J     XIT                                                              
*                                                                               
CKOVRFLO DS    0H                                                               
*                                                                               
         CP    MYPACKED,=P'9900000000'                                          
         BH    OVRFLO                                                           
         CP    MYPACKED,=P'-9900000000'                                         
         BL    OVRFLO                                                           
*                                                                               
         LA    R0,1                TO SET CC                                    
         CP    MYPACKED,=P'2147483647'  MAX POSITIVE FULLWORD VALUE             
         BH    *+16                                                             
         CP    MYPACKED,=P'-2147483648' MIN NEGATIVE FULLWORD VALUE             
         BL    *+6                 IF <21M, WRITE IT OUT                        
         SR    R0,R0               OK                                           
         LTR   R0,R0               DO NOT WRITE BINARY OUT                      
         BR    RE                                                               
*                                                                               
OVRFLO   DS    0H                                                               
         MVI   P,C'*'                                                           
         MVC   P+1(99),P                                                        
         MVI   P2,C'*'                                                          
         MVC   P2+1(99),P                                                       
         MVI   P3,0                                                             
         MVC   P4+20(36),=C'**ARITHMETIC OVERFLOW- CONTACT DDS**'               
         MVC   P5+20(36),=C'MAX ON PRODUCT/ESTIMATE/MOS EXCEEDED'               
         MVC   P6+5(10),=C'PRODUCT = '                                          
         MVC   P6+15(L'PRD),PRD    PUT IN PRODUCT                               
         MVC   P6+20(11),=C'ESTIMATE = '  ESTIMATE                              
         EDIT  (B1,PEPTEST),(3,P6+31),FILL=0                                    
         MVC   P6+35(6),=C'MOS = '        MOS                                   
         GOTO1 DATCON,DMCB,(3,PEPTMOS),(6,P6+41)                                
         MVC   P6+50(14),=C'AND AMOUNT IS '                                     
         EDIT  MYPACKED,(16,P6+64),2,COMMAS=YES,CR=YES                          
         MVC   P7+20(36),=C'WHICH IS GREATER THAN $99,000,000.00'               
         MVI   P8,0                                                             
         MVI   P9,C'*'                                                          
         MVC   P9+1(99),P9                                                      
         GOTO1 REPORT                                                           
         DC    H'0'                MUST DIE !!!!!!                              
         SPACE 3                                                                
         DROP  R4                                                               
         DROP  R7                                                               
*                                                                               
         LTORG                                                                  
         TITLE 'INVREG - INVOICE REGISTER MODULE'                               
INVREG   NMOD1 IRTOTSQ,INVREG,CLEAR=YES                                         
         LR    R6,RC               R6 - BASE REG FOR IRTOTSD                    
         USING IRTOTSD,R6                                                       
         LA    RC,SPACEND                                                       
*                                                                               
         CLI   DOINVREG,C'Y'       GENERATE INVOICE REGISTER?                   
         BNE   INVRX               NO                                           
         CLI   HAVEBILL,C'Y'       ANY BILL HEADERS GENERATED?                  
         BNE   INVRX               NO                                           
*                                                                               
         MVI   AORSW,0             AOR PASS CONTROL                             
*                                                                               
INVR04   DS    0H                                                               
         CLOSE OUT                 CLOSE AND RE-OPEN BILL HEADER FILE           
         OPEN  (OUT,INPUT)                                                      
*                                                                               
         MVC   QUESTOR,=C'INVOICE REG.' PRINT SMTH TO INDICATE INV REG          
         GOTO1 REQREP,DMCB         FORCE GENERATION OF REQUEST HEADER           
*                                                                               
         LA    R2,P                                                             
         USING ILINED,R2                                                        
         MVI   FORCEHED,C'Y'                                                    
         MVC   PAGE,=H'1'                                                       
         MVI   RCSUBPRG,20                                                      
         CLI   AORSW,2             AOR PASS                                     
         BNE   *+8                                                              
         MVI   RCSUBPRG,21                                                      
*                                                                               
         LA    R1,IRTOTS                                                        
         LA    RF,L'IRTOTS(R1)                                                  
         BRAS  RE,ZAPSTR           CLEAR IRITOTS                                
         XC    KEY1,KEY1                                                        
         ZAP   NBTOTG,=P'0'        CLEAR                                        
         ZAP   NBTOTN,=P'0'                                                     
*                                                                               
INVR2    DS    0H                                                               
         L     R5,=A(STABUCKC)                                                  
         LA    R7,4(R5)            R7 = A(BILL HEADER)                          
         USING BILLREC,R7                                                       
         L     R1,=A(OUT)          GET 1ST BILL HEADER RECORD (IF ANY)          
         GET   (R1),(R5)                                                        
*                                                                               
         TM    BILSTAT,BSTTAORQ    FOR AOR BILLS                                
         BZ    INVR3F                                                           
         CLI   AORSW,2             MUST BE AOR PASS                             
         BE    INVR3H                                                           
         MVI   AORSW,1             ELSE SET HAD AOR BILL                        
         B     INVR2               AND GET NEXT BILL                            
*                                                                               
INVR3F   DS    0H                  NOT AN AOR BILL                              
         CLI   AORSW,2             MUST NOT BE AOR PASS                         
         BE    INVR2                                                            
*                                                                               
INVR3H   DS    0H                  INVOICE BREAK?                               
         CLC   BKEY(4),KEY1                                                     
         BNE   *+14                                                             
         CLC   BKEYINV,KEY1+11                                                  
         BE    INVR16                                                           
*                                                                               
         OC    KEY1,KEY1                                                        
         BZ    INVR12                                                           
*                                                                               
         CP    NBTOTG,=P'1'        IF ONLY 1 INVOICE FOR THIS NUMBER            
         BNH   INVR6               DON'T PRINT A TOTAL                          
*                                                                               
         MVC   X(L'IRITOTS),IRITOTS                                             
         BAS   RE,IRFMTL                                                        
         MVC   ILINV,W                                                          
         MVC   ILPRD(5),=C'TOTAL'                                               
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
*                                                                               
INVR6    DS    0H                                                               
         LA    R1,IRITOTS                                                       
         LA    RF,L'IRITOTS(R1)                                                 
         BRAS  RE,ZAPSTR           CLEAR IRITOTS                                
         ZAP   NBTOTG,=P'0'                                                     
         ZAP   NBTOTN,=P'0'                                                     
*                                                                               
         CLC   BKEY(4),KEY1        CLIENT BREAK?                                
         BE    INVR16                                                           
         OC    KEY1,KEY1                                                        
         BZ    INVR12                                                           
*                                  FINISH UP LAST CLIENT                        
         MVC   X(L'IRCTOTS),IRCTOTS                                             
         MVC   TOTSTAR,=C'* '                                                   
         BAS   RE,IRFMTL                                                        
         MVC   P(7),=C'*CLIENT'                                                 
         MVC   P+8(L'SVCLUN),SVCLUN                                             
         MVC   P+12(7),=C'TOTALS*'                                              
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
*                                                                               
         LA    R3,IRCTOTS          ROLL TO MEDIA TOTALS                         
         LA    R4,IRMTOTS                                                       
         BAS   RE,IRROLL                                                        
*                                                                               
         LA    R1,IRCTOTS                                                       
         LA    RF,L'IRCTOTS(R1)                                                 
         BRAS  RE,ZAPSTR           CLEAR IRCTOTS                                
*                                                                               
         CLC   BKEY(2),KEY1        MEDIA BREAK?                                 
         BE    INVR14                                                           
*                                                                               
         MVC   X(L'IRMTOTS),IRMTOTS                                             
         MVC   TOTSTAR,=C'**'                                                   
         BAS   RE,IRFMTL                                                        
         MVC   P(16),=C'**MEDIA TOTALS**'                                       
         BRAS  RE,PRNT                                                          
         CLI   BKEY,X'FF'                                                       
         BE    INVR30                                                           
         LA    R1,IRMTOTS                                                       
         LA    RF,L'IRMTOTS(R1)                                                 
         BRAS  RE,ZAPSTR           CLEAR IRMTOTS                                
*                                                                               
*                                  NEW MEDIA                                    
INVR12   DS    0H                                                               
         CLI   BKEY,X'FF'                                                       
         BE    INVR30                                                           
         MVC   BYTE,BKEYAM                                                      
         NI    BYTE,X'FF'-X'F0'                                                 
         ZIC   R3,BYTE                                                          
         BCTR  R3,0                                                             
         MHI   R3,L'MEDLIST                                                     
         LA    R3,MEDLIST(R3)                                                   
         MVC   MED,0(R3)                                                        
         MVC   MEDNM,1(R3)                                                      
*                                                                               
         MVI   FORCEHED,C'Y'                                                    
*                                                                               
*                                  NEW CLIENT                                   
INVR14   DS    0H                                                               
         CLI   AGMCLOPT,C'N'                                                    
         BE    *+8                                                              
         MVI   FORCEHED,C'Y'                                                    
         MVC   P(6),=C'CLIENT'                                                  
*                                                                               
         XC    KEY,KEY             READ CLIENT                                  
         MVC   KEY(4),BKEY         TO SEE HOW TO UNPACK                         
         GOTO1 READ                                                             
         GOTO1 GETCLT                                                           
         L     RF,ADCLT                                                         
         ZIC   R0,CPROF+6-CLTHDR(RF)                                            
         GOTO1 CLUNPK,DMCB,((R0),BKEYCLT),SVCLUN                                
         MVC   P+7(L'SVCLUN),SVCLUN                                             
         MVC   P2(9),DASHES                                                     
         CLI   P+9,C' '                                                         
         BE    *+8                                                              
         MVI   P2+9,C'-'                                                        
         MVI   ALLOWLIN,6                                                       
         BRAS  RE,PRNT                                                          
         XC    EINVDTE,EINVDTE                                                  
*                                                                               
INVR16   DS    0H                                                               
         CLC   BQDATE,EINVDTE                                                   
         BE    INVR18                                                           
         GOTO1 DATCON,DMCB,BQDATE,(5,P+35)                                      
         MVC   P+21(14),=C'INVOICE DATE ='                                      
         MVI   ALLOWLIN,3                                                       
         BRAS  RE,PRNT                                                          
*                                                                               
INVR18   DS    0H                                                               
         MVC   ILINV(2),BINVNO     INVOICE NO.                                  
         MVI   ILINV+2,C'-'                                                     
         MVC   ILINV+3(4),BINVNO+2                                              
         MVI   ILINV+2,C'-'                                                     
         MVC   ILINV+3(4),BINVNO+2                                              
         MVI   ILINV+7,C' '                                                     
         MVC   W(L'ILINV),ILINV                                                 
*                                                                               
         MVC   ILPRD,BKEYPRD       PRODUCT                                      
*                                                                               
         ZIC   RF,BKEYEST          ESTIMATE                                     
         CVD   RF,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  ILEST,DUB                                                        
*                                                                               
         CLI   BCALNDR,10                                                       
         BNE   INVR20                                                           
*                                  SPECIAL CALENDAR PERIODS                     
*                                  SHOW AS MM/YY  MM= 01-13                     
         ZIC   RF,BKEYMSRV                                                      
         CVD   RF,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  ILPER(2),DUB                                                     
         MVI   ILPER+2,C'/'                                                     
         ZIC   RF,BKEYYSRV                                                      
         CVD   RF,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  ILPER+3(2),DUB                                                   
         B     INVR22                                                           
*                                                                               
INVR20   DS    0H                                                               
         GOTO1 DATCON,DMCB,(3,BKEYYSRV),(6,ILPER)                               
*                                                                               
INVR22   DS    0H                                                               
         MVC   ILTYPE,BTYPE                                                     
         TM    BILSTAT,BSTSCOMQ    SHOW SEPARATE COMMISSION BILL                
         BZ    *+8                                                              
         MVI   ILTYPE,C'C'         AS C4-C7                                     
*                                                                               
         MVC   ILMKT(4),BLMKT                                                   
         CLI   BLMKT,C' '                                                       
         BH    *+10                                                             
         MVC   ILMKT(5),BLMGR                                                   
*                                                                               
         LA    R1,X                                                             
         LA    RF,L'IRITOTS(R1)                                                 
         BRAS  RE,ZAPSTR           CLEAR X                                      
*                                                                               
         LA    R5,WORK                                                          
         USING SPBVALD,R5                                                       
         GOTO1 SPBVAL,DMCB,(C'B',BILLREC),SPBVALD,0                             
         ZAP   X(ACCUMLQ),SPBVGRSP EFFECTIVE GROSS                              
*                                                                               
         TM    BILSTAT,BSTTAORQ    FOR TRUE AOR BILLS                           
         BZ    INVR23D                                                          
         ICM   R0,15,BVATAMT       SET GST                                      
         CVD   R0,DUB                                                           
         AP    DUB,BACTP           PLUS ACTUAL                                  
         MVC   X+ACCUMLQ*2(ACCUMLQ),DUB                                         
         ZAP   X+ACCUMLQ*3(ACCUMLQ),BACTP   COMMISSION = ACTUAL                 
         B     INVR24                                                           
*                                                                               
INVR23D  DS    0H                                                               
         ZAP   X+ACCUMLQ(ACCUMLQ),SPBVNETP  EFFECTIVE NET                       
         ZAP   X+ACCUMLQ*2(ACCUMLQ),BACTP   ACTUAL                              
         DROP  R5                                                               
*                                                                               
         TM    BILSTAT,BSTCMONQ    COMMISSION-ONLY BILL?                        
         BZ    *+10                                                             
         ZAP   X+ACCUMLQ(ACCUMLQ),=P'0' IF SO SET NET=0(COMM. = ACTUAL)         
*                                                                               
         ZAP   DUB,X+ACCUMLQ*2(ACCUMLQ)         ACT                             
         SP    DUB,X+ACCUMLQ(ACCUMLQ)           -NET                            
         ZAP   X+ACCUMLQ*3(ACCUMLQ),DUB         = COMMISSION                    
*                                                                               
INVR24   DS    0H                                                               
         BAS   RE,IRFMTL                                                        
*                                                                               
         LA    R3,X                ROLL UP TO INVOICE TOTALS                    
         LA    R4,IRITOTS                                                       
         BAS   RE,IRROLL                                                        
*                                                                               
         AP    NBTOTG,=P'1'        ADD TO BILL COUNTER                          
*                                                                               
         LA    R3,X                ROLL UP TO CLIENT TOTALS                     
         LA    R4,IRCTOTS                                                       
         BAS   RE,IRROLL                                                        
*                                                                               
         MVI   ALLOWLIN,3                                                       
         MVC   KEY1,BKEY                                                        
         MVC   EINVDTE,BQDATE                                                   
         BRAS  RE,PRNT                                                          
         B     INVR2                                                            
*                                                                               
INVR29   DS    0H                  EOF ON DATASET                               
         MVI   BKEY,X'FF'                                                       
         MVC   BKEY+1(12),BKEY                                                  
         B     INVR3H                                                           
*                                                                               
INVR30   DS    0H                  DONE WITH A PASS                             
         CLI   AORSW,2             ALREADY DONE AOR PASS?                       
         BE    INVRX               YES, DONE                                    
         CLI   AORSW,1             NEED TO DO?                                  
         BNE   INVRX                                                            
         MVI   AORSW,2             YES                                          
         B     INVR04              RE-READ THE DATASET                          
*                                                                               
INVRX    DS    0H                                                               
         J     XIT                                                              
         EJECT                                                                  
*                                  FORMAT AMOUNTS                               
         SPACE 2                                                                
IRFMTL   NTR1                                                                   
*                                                                               
         LA    R1,X+ACCUMLQ*2      ACTUAL                                       
         LA    R5,ILCOL2                                                        
         BAS   RE,IRFEDT                                                        
         LA    R1,X+ACCUMLQ        NET                                          
         LA    R5,ILCOL3                                                        
         BAS   RE,IRFEDT                                                        
         LA    R1,X+ACCUMLQ*3      COMMISSION                                   
         LA    R5,ILCOL4                                                        
         BAS   RE,IRFEDT                                                        
         LA    R1,X                GROSS                                        
         LA    R5,ILSTRIP                                                       
         BAS   RE,IRFEDT                                                        
*                                                                               
         J     XIT                                                              
         DROP  R2                                                               
         DROP  R7                                                               
         DROP  R6                                                               
         SPACE 3                                                                
IRFEDT   NTR1                                                                   
*                                                                               
         EDIT  (P8,0(R1)),(16,0(R5)),2,COMMAS=YES,CR=YES                        
         CLI   14(R5),C' '                                                      
         BNE   *+10                                                             
         MVC   14(2,R5),TOTSTAR                                                 
         MVC   TOTSTAR,SPACES                                                   
*                                                                               
         J     XIT                                                              
         SPACE 3                                                                
*        IRROLL - ROLL UP TOTAL                                                 
*                                                                               
IRROLL   NTR1                                                                   
*                                                                               
         LHI   R0,4                4 AMOUNTS                                    
*                                                                               
IRROLL2  DS    0H                                                               
         AP    0(ACCUMLQ,R4),0(ACCUMLQ,R3)                                      
         LA    R4,ACCUMLQ(R4)                                                   
         LA    R3,ACCUMLQ(R3)                                                   
         BCT   R0,IRROLL2                                                       
                                                                                
         J     XIT                                                              
         SPACE 3                                                                
MEDLIST  DS    0CL11                                                            
         DC    C'TSPOT TV   '                                                   
         DC    C'RSPOT RADIO'                                                   
         DC    C'NNETWORK TV'                                                   
         DC    C'XNTWK RADIO'                                                   
         SPACE 2                                                                
         LTORG                                                                  
IRTOTSD  DSECT                                                                  
IRTOTS   DS    0XL96                                                            
IRITOTS  DS    XL32                ( 4 * PL8 )                                  
IRCTOTS  DS    XL32                                                             
IRMTOTS  DS    XL32                                                             
IRTOTSQ  EQU   *-IRTOTS                                                         
         SPACE 3                                                                
         TITLE 'SPBU2C - NETPAK BILLING - BOOK 3'                               
***********************************************************************         
*                                                                     *         
*        NOTE- THERE IS A BUG IN RDBUFF (PROBABLY AROUND RB6C).       *         
*              APPARENTLY IF THE DETAIL BACK-UP FORMAT IS ONE OF      *         
*              'SHORT' ONES AND THE MAIN BILL FORMAT IS NOT           *         
*              SOMETHING SOMETIMES GOES VERY WRONG.                   *         
*                                                                               
*        NOTE- BILL FORMULA RECORD OPTION (BFROPT) IS DIFFERENT       *         
*              IN NET AND SPOT. IN NET THERE IS NO MARKET LEVEL       *         
*              CODE OR RETAIL RELATED CODE. IT IS USED ONLY FOR       *         
*              FORMULAS BY MONTH.                                               
*                                                                     *         
*        FOR EDI, ADJUSTMENT BILL SHOULD SHOW PREVIOUS???             *         
*                                                                     *         
***********************************************************************         
*                                                                               
*                                                                               
SPBU02   CSECT                                                                  
*                                  READ BUFFER                                  
RDBUFF   NMOD1 0,RDBUFF                                                         
         LA    RC,SPACEND                                                       
*                                                                               
         MVC   SVMKTCTL,MKTCTL                                                  
*                                  SET LENGTH OF INVOICE BREAK                  
         L     R3,AINVBRK                                                       
         USING BRKTABD,R3                                                       
         L     RF,BRKDISP                                                       
         A     RF,BRKLENM1                                                      
         ST    RF,INVBKLEN                                                      
         DROP  R3                                                               
*                                                                               
RB0      DS    0H                                                               
         CLI   SORTTRCE,C'Y'                                                    
         BL    *+8                                                              
         MVI   RCTRACE,C'Y'                                                     
         XC    SORTREC,SORTREC     CLEAR REC (INCL PACKED FIELD) FIRST          
         L     R1,ASORTDTA         THEN ZAP ACCUMULATORS                        
         LA    RF,ROWTL(R1)        POINT PAST SORT DATA                         
         BRAS  RE,ZAPSTR                                                        
         XC    THISREC,THISREC                                                  
         L     R1,ASORTDTA                                                      
         LA    RE,SORTREC                                                       
         SR    R1,RE               GET DISP TO SORTDTA FR BEGIN OF REC          
         LR    R0,R1                                                            
         LA    R1,THISREC(R1)      GET TO DATA IN THISREC                       
         LA    RF,ROWTL(R1)                                                     
         BRAS  RE,ZAPSTR           ZAP $ FIELDS IN THISREC                      
         XC    OLDREC,OLDREC                                                    
         LR    R1,R0                                                            
         LA    R1,OLDREC(R1)                                                    
         LA    RF,ROWTL(R1)                                                     
         BRAS  RE,ZAPSTR           ZAP $ FIELDS IN OLDREC                       
         XC    PASSREC,PASSREC                                                  
         LR    R1,R0                                                            
         LA    R1,PASSREC(R1)                                                   
         LA    RF,ROWTL(R1)                                                     
         BRAS  RE,ZAPSTR           ZAP $ FIELDS IN PASSREC                      
         CLI   AORLOPT,C'C'        UNLESS CLIENT LEVEL AOR LIST                 
         BE    *+10                                                             
         XC    PEPTABN,PEPTABN     CLEAR PRD-EST-PER TABLE                      
         XC    ESTFORM,ESTFORM                                                  
         XC    AAEFORM,AAEFORM                                                  
*                                                                               
         CLC   AMKTBRK,AINVBRK                                                  
         BNH   RB1                                                              
         OC    AMGR1BRK,AMGR1BRK                                                
         BZ    RB1B                                                             
         CLC   AMGR1BRK,AINVBRK                                                 
         BH    RB1B                                                             
RB1      DS    0H                  IF MARKET OR MGR ON SEPARATE BILL            
         MVI   ORIGTYPE,C'0'       OVERRIDE OPTION NOT TO DETAIL MARK           
RB1B     DS    0H                                                               
         MVI   BILSW,C'N'                                                       
         MVI   NDUES,0                                                          
*                                                                               
         MVI   PASSNO,0            ALWAYS START WITH PASS 0                     
         BAS   RE,SETPASS                                                       
*                                                                               
RB2      DS    0H                                                               
         GOTO1 BUFFALO,DMCB,=C'HIGH',ABUFFC,THISREC,0                           
         B     RB4B                                                             
*                                                                               
RB4      DS    0H                                                               
         GOTO1 BUFFALO,DMCB,=C'SEQ',ABUFFC,THISREC,0                            
*                                                                               
RB4B     DS    0H                                                               
         LA    R3,BRKTAB                                                        
         USING BRKTABD,R3                                                       
         TM    DMCB+8,X'80'        EOF                                          
         BZ    RB6                                                              
         MVI   THISREC,X'FF'                                                    
         MVC   THISREC+1(L'THISREC-1),THISREC                                   
         L     R1,ASORTDTA                                                      
         LA    RE,SORTREC                                                       
         SR    R1,RE               DO 'OC' ONLY FOR KEY & COMMENT               
         BCTR  R1,R0                                                            
         EX    R1,*+8                                                           
         B     *+10                                                             
         OC    SORTREC(0),SORTREC                                               
         BNZ   RB8                                                              
         L     RE,ASORTDTA                                                      
         LA    RF,ROWTL(RE)                                                     
RB5      CP    0(ACCUMLQ,RE),=P'0'                                              
         BNE   RB8                                                              
         LA    RE,ACCUMLQ(RE)                                                   
         CR    RE,RF                                                            
         BL    RB5                                                              
         B     RB20                DONE IF NO DATA                              
*                                                                               
RB6      DS    0H                                                               
         L     RF,ASORTDTA         POINT TO DATA                                
         LA    R0,SORTREC                                                       
         SR    RF,R0                                                            
         LA    RF,THISREC(RF)      POINT TO DATA IN THISREC                     
*                                                                               
         OC    MANPCT,MANPCT       PCT= REQUEST?                                
         BZ    RB6C                NO                                           
*                                  YES - TAKE PCT OF GROSS + NET                
         L     R0,MANPCT           GROSS                                        
         CVD   R0,DUB              % TO PACKED                                  
         ZAP   PKBIG,0(ACCUMLQ,RF) PUT AMT INTO BIG FIELD FOR MULTIPLE          
         MP    PKBIG,DUB           APPLY %                                      
         SRP   PKBIG,1,0           FOR ROUNDING                                 
         ZAP   MYPACKED,=P'10000'  SET DIVISOR                                  
         DP    PKBIG,MYPACKED      DIVIDE BY ??                                 
         SRP   PKQUOT,64-1,5       ROUND                                        
         MVC   0(ACCUMLQ,RF),PKQUOT        PUT RESULT BACK                      
*                                                                               
         CLI   PCTNET,C'N'                                                      
         BE    RB6B2                                                            
         ZAP   PKBIG,ACCUMLQ(ACCUMLQ,RF) PUT AMOUNT INTO BIG FIELD              
         MP    PKBIG,DUB           APPLY %                                      
         SRP   PKBIG,1,0           FOR ROUNDING                                 
         ZAP   MYPACKED,=P'10000'  SET DIVISOR                                  
         DP    PKBIG,MYPACKED      DIVIDE BY ??                                 
         SRP   PKQUOT,64-1,5       ROUND                                        
         MVC   ACCUMLQ(ACCUMLQ,RF),PKQUOT  PUT RESULT BACK                      
*                                                                               
RB6B2    DS    0H                                                               
         CLI   PCTCTL,C'P'         P MEANS APPLY % TO PREVIOUS BILLING          
         BNE   RB6C                                                             
*                                                                               
         ZAP   PKBIG,ROWHL(ACCUMLQ,RF) BILLED GROSS INTO BIG FIELD              
         MP    PKBIG,DUB           APPLY %                                      
         SRP   PKBIG,1,0           FOR ROUNDING                                 
         ZAP   MYPACKED,=P'10000'  SET DIVISOR                                  
         DP    PKBIG,MYPACKED      DIVIDE BY ??                                 
         SRP   PKQUOT,64-1,5       ROUND                                        
         MVC   ROWHL(ACCUMLQ,RF),PKQUOT  PUT RESULT BACK                        
         CLI   PCTNET,C'N'         SKIP NET                                     
         BE    RB6C                                                             
*                                                                               
         ZAP   PKBIG,ROWHL+ACCUMLQ(ACCUMLQ,RF)  BILLED NET                      
         MP    PKBIG,DUB           APPLY %                                      
         SRP   PKBIG,1,0           FOR ROUNDING                                 
         ZAP   MYPACKED,=P'10000'  SET DIVISOR                                  
         DP    PKBIG,MYPACKED      DIVIDE BY ??                                 
         SRP   PKQUOT,64-1,5       ROUND                                        
         MVC   ROWHL+ACCUMLQ(ACCUMLQ,RF),PKQUOT  PUT RESULT BACK                
*                                                                               
RB6C     DS    0H                                                               
         MVC   SORTREC,THISREC                                                  
*                                                                               
         L     RE,ADESC                                                         
         CLI   0(RE),X'FC'         FOR REVERSAL OF MANUALS                      
         BNE   RB6C4                                                            
         LR    R1,RF                                                            
         LA    R5,ROWTL(R1)                                                     
RB6C2    CP    0(ACCUMLQ,R1),=P'0'                                              
         BNE   RB7                                                              
         LA    R1,ACCUMLQ(R1)                                                   
         CR    R1,R5                                                            
         BL    RB6C2                                                            
         B     RB4                                                              
*                                                                               
RB6C4    DS    0H                                                               
         CLI   0(RE),X'FA'         SKIP PREVIOUSLY BILLED UNITS                 
         BNE   RB7                                                              
         CLI   PASSNO,0            UNLESS PASS 0                                
         BE    RB7                                                              
         CLI   FORMAT,8            FOR FORMATS 7,8,9                            
         BE    RB4                 BYPASS PREVIOUS BILLED UNITS                 
         CLI   FORMAT,9                                                         
         BE    RB4                                                              
         CLI   FORMAT,7                                                         
         BE    RB4                                                              
*                                                                               
         CLI   ZLOPT,C'A'          ALSO, IF ZLOPT IS ON                         
         BE    *+14                                                             
         CLC   ZLOPT,TYPE                                                       
         BNE   RB7                                                              
*                                                                               
*                                  BYPASS PREVIOUS FOR FORMAT 1 AND 5           
         CLI   FORMAT,1                                                         
         BE    RB4                                                              
         CLI   FORMAT,5                                                         
         BE    RB4                                                              
*                                                                               
RB7      DS    0H                                                               
         MVC   TRCKWRD,=C'RB7  '                                                
         BAS   RE,TRCK                                                          
         L     R1,ASORTDTA                                                      
         LA    RE,SORTREC                                                       
         SR    R1,RE               DO 'OC' ONLY FOR KEY & COMMENT               
         BCTR  R1,R0                                                            
         EX    R1,*+8                                                           
         B     *+10                                                             
         OC    OLDKEY(0),OLDKEY                                                 
         BNZ   RB7C                                                             
*                                                                               
         L     R1,ASORTDTA         POINT TO DATA                                
         LA    RE,SORTREC                                                       
         SR    R1,RE                                                            
         LA    RE,OLDKEY(R1)       POINT TO DATA IN OLDKEY                      
         LA    R1,ROWTL(RE)        POINT PAST DATA IN OLDKEY                    
RB7B     CP    0(ACCUMLQ,RE),=P'0'                                              
         BNE   RB7C                                                             
         LA    RE,ACCUMLQ(RE)                                                   
         CR    RE,R1                                                            
         BL    RB7B                                                             
         B     RB15                BYPASS BREAK TEST                            
*                                                                               
RB7C     OC    BRKCODE,BRKCODE                                                  
         BNZ   *+6                                                              
         DC    H'0'                DUPLICATE KEY                                
         L     R6,BRKDISP                                                       
         LA    R7,OLDKEY(R6)                                                    
         LA    RE,THISKEY(R6)                                                   
         L     RF,BRKLENM1                                                      
         EX    RF,*+8                                                           
         B     *+10                                                             
         CLC   0(0,R7),0(RE)                                                    
         BNE   RB8                                                              
         LA    R3,BRKL(R3)                                                      
         B     RB7                                                              
*                                                                               
RB8      DS    0H                                                               
         MVC   TRCKWRD,=C'RB8  '                                                
         BAS   RE,TRCK                                                          
*                                  'LAST' BREAKS                                
         ST    R3,ATHISBRK         SAVE THIS BREAK                              
         CLI   PASSNO,0            IF PASS 0                                    
         BNE   RB8B                                                             
         C     R3,AINVBRK          AND INVOICE BREAK                            
         BH    RB18                                                             
*                                                                               
         CLI   BILSW,C'Y'          IF ACTIVITY, THEN NOT A 'ZERO BILL'          
         BNE   RB8A3                                                            
*                                                                               
         CP    BIGOGRS,OVERFLO     DO ANY KEY NUMBERS EXCEED MAXIMUM?           
         BH    RB8A2D                                                           
         CP    BIGONET,OVERFLO                                                  
         BH    RB8A2D                                                           
         CP    BIGBGRS,OVERFLO                                                  
         BH    RB8A2D                                                           
         CP    BIGBNET,OVERFLO                                                  
         BH    RB8A2D                                                           
         B     RB8A2K                                                           
*                                                                               
OVERFLO  DC    P'9900000000'       99,000,000.00                                
*                                                                               
RB8A2D   DS    0H                  ** COLUMN WIDTH OVERFLOW **                  
         MVI   FORCEHED,C'Y'                                                    
         MVI   P,C'*'                                                           
         MVC   P+1(79),P                                                        
         MVC   P2(80),P1                                                        
         MVC   P3(2),=C'**'                                                     
         MVC   P4(2),=C'**'                                                     
         MVC   P5(2),=C'**'                                                     
         MVC   P6(2),=C'**'                                                     
         MVC   P7(2),=C'**'                                                     
         MVC   P8(2),=C'**'                                                     
         MVC   P3+78(2),=C'**'                                                  
         MVC   P4+78(2),=C'**'                                                  
         MVC   P5+78(2),=C'**'                                                  
         MVC   P6+78(2),=C'**'                                                  
         MVC   P7+78(2),=C'**'                                                  
         MVC   P8+78(2),=C'**'                                                  
         MVC   P8(80),P1                                                        
         MVC   P9(80),P1                                                        
*                                                                               
         MVC   P4+5(38),=C'**COLUMN WIDTH OVERFLOW- CONTACT DDS**'              
         MVC   P4+45(11),=C'(MAXIMUM IS'                                        
         EDIT  (P6,OVERFLO),(15,P4+58),2,FLOAT=$,COMMAS=YES                     
         MVI   P4+73,C')'                                                       
*                                                                               
         MVC   P6+5(19),=C'     ORDERED -GROSS'                                 
         MVC   P7+5(19),=C'PREV. BILLED -GROSS'                                 
         EDIT  (P8,BIGOGRS),(16,P6+25),2,FLOAT=$,MINUS=YES,COMMAS=YES           
         EDIT  (P8,BIGBGRS),(16,P7+25),2,FLOAT=$,MINUS=YES,COMMAS=YES           
*                                                                               
         MVC   P6+48(4),=C'-NET'                                                
         MVC   P7+48(4),=C'-NET'                                                
         EDIT  (P8,BIGONET),(16,P6+56),2,FLOAT=$,MINUS=YES,COMMAS=YES           
         EDIT  (P8,BIGBNET),(16,P7+56),2,FLOAT=$,MINUS=YES,COMMAS=YES           
*                                                                               
         GOTO1 REPORT                                                           
         GOTO1 AENDREQ             AFTER OVERFLOW, NEXT REQUEST                 
*********B     RB8A4               ***USED TO BRANCH HERE**    (???)            
*                                  DO NON-ZERO BILL                             
RB8A2K   DS    0H                                                               
         MVI   PASSNO,1            PASS ONE                                     
         BAS   RE,SETPASS                                                       
         MVI   ZEROSW,C'N'                                                      
         B     RB14D                                                            
*                                                                               
RB8A3    DS    0H                                                               
*                                  ELSE END OF INVOICE ON PASS 0                
*                                  MEANS THIS IS A 'ZERO' BILL                  
*                                                                               
*                                  SHOULD I PRODUCE IT                          
*                                                                               
         CLC   TYPE,ZBOPT          NOT IF NOT RIGHT TYPE                        
         BNE   RB8A4                                                            
*                                                                               
         CLI   PRIOR,C'T'          NOT IF MULTI MONTH BILLS                     
         BE    RB8A4                                                            
         CLI   PRIOR,C'V'                                                       
         BE    RB8A4                                                            
         CLI   PRIOR,C'1'                                                       
         BNL   RB8A4                                                            
*                                                                               
*                                  ONLY FOR REQUESTED MONTH                     
         L     RF,ASORTDTA         CHECK IF OLDREC HAS ANYTHING                 
         LA    RE,SORTREC                                                       
         SR    RF,RE               DO 'OC' ONLY FOR KEY & COMMENT               
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         OC    OLDREC(0),OLDREC                                                 
         L     RE,APER                                                          
         BZ    *+8                IF NOT DO NOT USE OLDREC                      
         LA    RE,OLDREC-SORTREC(RE) USE 'OLDREC' PERIOD                        
         ZIC   RF,0(RE)                                                         
         LA    RF,PERLIST(RF)                                                   
         CLC   CURPER,PERLMOS-PERLISTD(RF)                                      
         BNE   RB8A4                                                            
*                                                                               
*                                  PRODUCE ZERO BILL                            
         MVI   PASSNO,1            PASS ONE                                     
         BAS   RE,SETPASS                                                       
         MVI   ZEROSW,C'Y'         SET PRODUCING ZERO BILL NOW                  
         B     RB14D                                                            
*                                                                               
RB8A4    DS    0H                  DO NOT PRODUCE BILL                          
*                                                                               
         ZAP   BIGOGRS,=P'0'       ZAP BIG TOTALS                               
         ZAP   BIGONET,=P'0'                                                    
         ZAP   BIGBGRS,=P'0'                                                    
         ZAP   BIGBNET,=P'0'                                                    
*                                                                               
         MVC   PASSREC,THISREC     SET RESTART POINT                            
         B     RB18                                                             
*                                                                               
RB8B     DS    0H                                                               
         L     R3,ALOWBRK                                                       
*                                                                               
         L     RF,ASORTDTA         CHECK IF OLDREC HAS ANYTHING                 
         LA    R1,SORTREC                                                       
         SR    RF,R1               DO 'OC' ONLY FOR KEY & COMMENT               
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         OC    OLDREC(0),OLDREC                                                 
         BZ    *+10                IF NOTHING IN OLDREC DO NOT USE IT           
         MVC   SORTREC,OLDREC                                                   
*                                  AT LOWEST LEVEL PUT INTO TOTALS              
         L     R1,APER                                                          
         ZIC   RF,0(R1)                                                         
         SR    RE,RE                                                            
         LHI   R0,PERLISTL                                                      
         DR    RE,R0                                                            
         MHI   RF,ROWL             RF = DISPLACEMENT INTO ACCUMULATOR           
         L     RE,BRKCODE                                                       
         A     RF,ATOTS(RE)        POINT TO THIS ACCUMULATOR                    
         L     R7,ASORTDTA                                                      
*                                  TEST COST TYPE                               
         MVI   BYTE,0              'TIME' IF NO TYPE                            
         ICM   R1,15,ACTYP                                                      
         BZ    *+10                                                             
         MVC   BYTE,0(R1)          SAVE COST TYPE                               
*                                                                               
         ZIC   R0,BYTE             POINT TO RIGHT COST TYPE SLOT                
         MHI   R0,ROWTL                                                         
         AR    RF,R0                                                            
         MVC   0(ROWTL,RF),0(R7)   MOVE DATA FROM SORTREC                       
*                                                                               
         L     R7,ATOTS(RE)                                                     
         AHI   R7,MAXMOS*ROWL      POINT TO TOTAL ROW                           
         ZIC   R0,BYTE                                                          
         MHI   R0,ROWTL                                                         
         AR    R7,R0               RIGHT COST TYPE SLOT                         
*                                                                               
         LHI   R0,ROWTL/ACCUMLQ    NUMBER OF ACCUMULATORS                       
RB9      DS    0H                   (ORDERED AND BILLED)                        
         AP    0(ACCUMLQ,R7),0(ACCUMLQ,RF)                                      
         LA    R7,ACCUMLQ(R7)                                                   
         LA    RF,ACCUMLQ(RF)                                                   
         BCT   R0,RB9                                                           
*                                  PUT INVOICE NO. INTO INVOICE LIST            
         L     R5,APER             PER NO IS INDEX                              
         ZIC   RF,0(R5)                                                         
         A     RF,=A(INVLIST)                                                   
         ZIC   R0,BYTE             USE COST TYPE TO POINT                       
         MHI   R0,INVLISTL         RIGHT INVLIST                                
         AR    RF,R0                                                            
         L     R5,ASORTCOM         A(INVOICE NO)                                
         USING SORTCOMD,R5                                                      
         OC    SORTINV,SORTINV     NO INVOICE NO. (AT +4)                       
         BZ    *+10                                                             
         MVC   0(L'SORTINV,RF),SORTINV                                          
         B     RB10B                                                            
         DROP  R5                                                               
*                                                                               
RB10     DS    0H                                                               
         SHI   R3,BRKL             BACK UP THRU LIST                            
*                                                                               
RB10B    DS    0H                                                               
         C     R3,ATHISBRK                                                      
         BL    RB14J               NO MORE                                      
*                                                                               
         L     RF,ASORTDTA         CHECK IF OLDREC HAS ANYTHING                 
         LA    RE,SORTREC                                                       
         SR    RF,RE               DO 'OC' ONLY FOR KEY & COMMENT               
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         OC    OLDREC(0),OLDREC                                                 
         BZ    *+10                IF NOTHING IN OLDREC DO NOT USE IT           
         MVC   SORTREC,OLDREC                                                   
*                                                                               
         C     R3,ALOWBRK          AT LOWEST BREAK                              
         BNE   RB11B                                                            
         CLC   ORIGTYPE,TYPE       OPTION NOT TO DETAIL MARK FILE               
         BE    RB11B                                                            
         GOTOR WNBILL,DMCB,1       POST TO PEPTAB                               
*                                                                               
*                                  ****IF DOING TRADE %****                     
*                             F/OUT TRADE AMOUNT AND PUT IT IN TRADETAB         
         L     RF,ACTYP            TRADE ONLY DONE FOR TIME                     
         CLI   0(RF),0                                                          
         BNE   RB11B                                                            
         L     RF,ASORTCOM                                                      
         SR    R1,R1                                                            
         ICM   R1,3,SORTTRDP-SORTCOMD(RF)      TRADE %                          
         BZ    RB11B               NO TRADE % ? DONE                            
         LHI   R0,100                                                           
         SR    R0,R1               FIND CASH %                                  
         CVD   R1,DUB              CONV % TO PKD FOR CALCULATION                
         CVD   R0,MYPACKED                                                      
*                                                                               
*                                                                               
         XC    X,X                                                              
         LA    R2,X                                                             
         USING TRADETD,R2                                                       
         LA    R1,TRDOTIME         POINT TO $ FIELDS IN TRADETB..               
         LA    RF,TRDAMTSL(R1)                                                  
         BRAS  RE,ZAPSTR           ... TO ZAP THEM                              
         L     RF,APRD                                                          
         MVC   TRADEPRD,0(RF)      PRODUCT                                      
         L     RF,AEST                                                          
         MVC   TRADEEST,0(RF)      ESTIMATE                                     
*                                                                               
*                                                                               
         L     RF,ASORTDTA                                                      
         ZAP   PKBIG,ACCUMLQ*2(ACCUMLQ,RF)    GET ORDRD CASH AMOUNT             
         BZ    RB10C               IF ZERO, CHECK BILLED $$                     
         MP    PKBIG,DUB           CASH$ TIMES TRADE%                           
         SRP   PKBIG,1,0           FOR ROUNDING                                 
         DP    PKBIG,MYPACKED      DIVIDE BY CASH%                              
         SRP   PKQUOT,64-1,5       ROUND                                        
*                                                                               
         ZAP   TRDOTIME,PKQUOT     ACCUMULATE ORDERED TRADE                     
*                                                                               
RB10C    ZAP   PKBIG,ROWHL+ACCUMLQ*2(ACCUMLQ,RF) GET BILLED CASH AMOUNT         
         BZ    RB10D               IF ZERO, PUT IN JUST ORDERED                 
         MP    PKBIG,DUB           CASH$ TIMES TRADE%                           
         SRP   PKBIG,1,0           FOR ROUNDING                                 
         DP    PKBIG,MYPACKED      DIVIDE BY CASH%                              
         SRP   PKQUOT,64-1,5       ROUND                                        
*                                                                               
         ZAP   TRDBTIME,PKQUOT     ACCUMULATE ORDERED TRADE                     
*                                                                               
RB10D    GOTO1 BINSRCH,TRDPARS,(1,TRADETD)                                      
         OC    1(3,R1),1(R1)                                                    
         BNZ   *+6                                                              
         DC    H'0'                TABLE FULL                                   
         CLI   0(R1),1             IF SUCH REC NOT FOUND - INSERT               
         BE    RB11B                                                            
*                                  ADD TOTALS IN                                
         L     R2,0(R1)            R2 -> TO EXISTING PEPTAB REC                 
*                                  X HAS REC PASSED TO BINSRCH WITH             
TRDD     USING TRADETD,X           SAME KEY                                     
         AP    TRDOTIME,TRDD.TRDOTIME                                           
         AP    TRDBTIME,TRDD.TRDBTIME                                           
         DROP  TRDD                                                             
         DROP  R2                                                               
*                                                                               
RB11B    DS    0H                                                               
         C     R3,AINVBRK                                                       
         BL    RB11D               BYPASS LAST'S IF 'ABOVE' INV BREAK           
*                                                                               
         MVI   BYTE,C'L'                                                        
         BAS   RE,RBTRCE                                                        
*                                                                               
         MVI   PRSW,C'H'           SET TO HOLD LINES                            
         MVI   BYTE3,C'L'          'L' = "LAST" BREAK                           
         BAS   RE,DOBREAK                                                       
*                                                                               
RB11D    DS    0H                                                               
         C     R3,AINVBRK                                                       
         BNE   RB13B                                                            
         BRAS  RE,ENDINV                                                        
*                                  CLEAR INVOICE ACCUMULATOR                    
         L     RF,BRKCODE                                                       
         L     RE,ATOTS(RF)                                                     
         LHI   RF,(MAXMOS+1)*ROWL  ONLY $ FIELDS                                
         AR    RF,RE               POINT PAST $ FIELDS IN THIS ROW              
         LR    R1,RE                                                            
         BRAS  RE,ZAPSTR           ZAP AMOUNTS                                  
*                                                                               
         XC    0(BFORML,RF),0(RF)  XC BINARY DATA                               
*                                                                               
         B     RB14B                                                            
*                                                                               
RB13B    DS    0H                                                               
         BRAS  RE,ROLLUP                                                        
         B     RB10                                                             
*                                                                               
RB14B    DS    0H                                                               
         MVC   TRCKWRD,=C'RB14B'                                                
         BAS   RE,TRCK                                                          
*                                                                               
         ZIC   RF,PASSNO           BUMP PASS NUMBER                             
         AHI   RF,1                                                             
         STC   RF,PASSNO                                                        
*                                                                               
         CLI   PASSNO,2                                                         
         BH    RB14H                                                            
         OC    ARECAP,ARECAP                                                    
         BZ    RB14B                                                            
         MVC   FORMAT,DFORMAT                                                   
         MVC   APAGBRK,SVPAGBRK    RESTORE BREAK CONTROLS                       
         MVC   ALOWTOG,SVLOWTOG                                                 
         MVC   SPOTCTL,SPOTSW      SPOT DETAIL ON BACK-UP                       
*                                                                               
*                                  SET COLS USEABLE FOR DESCRIPTIONS            
         MVI   TWOCOL,C'Y'         2 COLS AVALIBLE                              
         CLI   FORMAT,1            UNLESS FORMAT 1                              
         BNE   RB14D                                                            
         CLI   PERCTL,C'T'         AND PERIODS NOT TOGETHER                     
         BE    RB14D                                                            
         MVI   TWOCOL,C'N'                                                      
*                                                                               
RB14D    DS    0H                                                               
         MVC   TRCKWRD,=C'RB14D'                                                
         BAS   RE,TRCK                                                          
         XC    OLDREC,OLDREC       CLEAR ALL DATA FIRST                         
         L     R1,ASORTDTA                                                      
         LA    RF,SORTREC          THEN                                         
         SR    R1,RF                                                            
         LA    R1,OLDREC(R1)                                                    
         LA    RF,ROWTL(R1)                                                     
         BRAS  RE,ZAPSTR           ZAP $ FIELDS IN OLDREC                       
         MVC   THISREC,PASSKEY                                                  
         B     RB2                                                              
*                                                                               
RB14H    DS    0H                                                               
         MVC   PASSREC,THISREC                                                  
         MVI   PASSNO,0            BACK TO PASS 0                               
         BAS   RE,SETPASS                                                       
         MVI   BILSW,C'N'                                                       
*                                                                               
RB14J    DS    0H                                                               
         L     R3,ATHISBRK         RESTORE R3                                   
*                                                                               
RB15     DS    0H                                                               
         CLC   FFS,THISKEY         AT EOF DON'T DO 'FIRSTS'                     
         BE    RB20                                                             
*                                  'FIRSTS'                                     
RB16     DS    0H                                                               
         MVC   SORTREC,THISREC                                                  
         ICM   RF,15,BRKCODE                                                    
         BZ    RB19                                                             
         MVI   BYTE,C'F'                                                        
         BAS   RE,RBTRCE                                                        
         CLI   PASSNO,1                                                         
         BL    RB18                                                             
         BE    *+12                                                             
         C     R3,AINVBRK                                                       
         BL    RB17                                                             
*                                                                               
         MVI   PRSW,C'H'           SET TO HOLD LINES                            
         MVI   BYTE3,C'F'          'F' = "FIRST" BREAK                          
         BAS   RE,DOBREAK                                                       
*                                                                               
         C     R3,APAGBRK                                                       
         BNE   *+16                                                             
         MVI   RCSUBPRG,100        SET SPECIAL HEADLINES                        
         BRAS  RE,PRNT                                                          
         MVI   FORCEHED,C'Y'                                                    
*                                                                               
         C     R3,AINVBRK                                                       
         BNE   RB17                                                             
*                                  SPECIAL COMMENTS FOR SPECIAL BILLS           
         CLI   PAYOPT,C'Y'                                                      
         BNE   *+18                                                             
         MVC   P(61),=C'** ORDERED AMOUNTS ARE BASED ON STATION INVOICE+        
                CLEARANCES **'                                                  
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
*                                                                               
         OC    MANPCT,MANPCT                                                    
         BZ    RB16H                                                            
         MVC   P(14),=C'** AMOUNTS ARE'                                         
         LA    R4,P+15                                                          
         EDIT  (B4,MANPCT),(6,0(R4)),2,ALIGN=LEFT                               
         AR    R4,R0                                                            
         MVC   1(20,R4),=C'PERCENT OF ACTUAL **'                                
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
*                                                                               
RB16H    DS    0H                                                               
         OC    MANRVNO,MANRVNO                                                  
         BZ    RB16I                                                            
*                                                                               
         MVC   P(39),=C'** REVERSAL OF INVOICE MM-NN-NNNN DATED'                
         GOTO1 DATCON,DMCB,(2,MANRVDTP),(3,DUB)                                 
         MVC   W(1),DUB+1          MONTH                                        
         MVC   SVSVIMO,SVINVMO     SAVE SAVED INVNO MONTH                       
         MVC   THREE,TODAYB        SAVE TODAY, GETNUM NEEDS                     
         MVC   TODAYB(1),DUB       REVERSAL YEAR                                
         GOTOR GETNUM,DMCB,(1,MANRVNO),P+23                                     
         MVC   TODAYB,THREE        RESTORE TODAY                                
         MVC   SVINVMO,SVSVIMO     RESTORE SAVED INVNO MONTH                    
*                                                                               
         GOTO1 DATCON,DMCB,(2,MANRVDTP),(5,WORK)                                
         MVC   P+40(8),WORK                                                     
         MVC   P+40+9(2),=C'**'                                                 
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
*                                                                               
RB16I    DS    0H                                                               
         CLI   CTYPCTL,C'S'                                                     
         BNE   RB16J                                                            
****     CP    MANGRS,=P'0'        DON'T PRINT TYPE TITLE FOR                   
****     BNE   RB16J               MANUAL BILLING                               
         MVC   P(24),=C'** THIS INVOICE INCLUDES'                               
         L     R1,ACTYP                                                         
         L     RF,=A(CTYPLST)      FIND TYPE IN LIST                            
*                                                                               
         USING CTYLD,RF                                                         
RB16I6   CLC   0(1,R1),CTYLDISP    INTERNAL CODE                                
         BE    RB16I8                                                           
         CLI   0(RF),X'FF'                                                      
         BNE   *+6                                                              
         DC    H'0'                                                             
         LA    RF,CTYLSTL(RF)                                                   
         B     RB16I6                                                           
*                                                                               
RB16I8   DS    0H                                                               
         MVC   P+25(L'CTYLFNAM),CTYLFNAM                                        
         DROP  RF                                                               
*                                                                               
         LA    RF,P+25+20                                                       
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
*                                                                               
         MVC   2(13,RF),=C'COSTS ONLY **'                                       
         CP    MANGRS,=P'0'        DON'T PRINT TYPE TITLE FOR                   
         BNE   RB16I9              MANUAL BILLING                               
         GOTO1 ABILLEDI,DMCB,('EDMTXT',P)                                       
RB16I9   MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
*                                                                               
RB16J    DS    0H                                                               
         CLI   PKGCTL,C'S'         SEPARATE BY PACKAGE?                         
         BNE   RB16K                                                            
*                                                                               
         BRAS  RE,FNDPKG                                                        
         CLC   PKGNME(16),SPACES                                                
         BE    RB16K               THERE WAS NO PACKAGE TABLE                   
         MVC   P+10(11),=C'** PACKAGE='                                         
         MVC   P+22(16),PKGNME                                                  
         LA    RF,P+40                                                          
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         MVC   2(2,RF),=C'**'                                                   
         LA    R0,P+22                                                          
         SR    RF,R0                                                            
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   P2+22(0),DASHES                                                  
*                                                                               
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
*                                                                               
RB16K    DS    0H                                                               
         MVI   PUMODE,C'F'         USER FIELDS - FRONT OF BILL                  
         BRAS  RE,PRTUSER          USER FIELDS                                  
*                                                                               
RB17     DS    0H                                                               
         LA    R3,BRKL(R3)                                                      
         B     RB16                                                             
*                                                                               
RB18     DS    0H                                                               
         MVC   TRCKWRD,=C'RB18 '                                                
         BAS   RE,TRCK                                                          
*                                  PASS 0                                       
         L     R6,ASORTDTA                                                      
*                                  ADD TO BIG TOTALS                            
         CVD   R1,DUB                                                           
         AP    BIGOGRS,0(ACCUMLQ,R6)          ORDERED GROSS & NET               
         AP    BIGONET,ACCUMLQ(ACCUMLQ,R6)                                      
         AP    BIGBGRS,ROWHL(ACCUMLQ,R6)     BILLED GROSS & NET                 
         AP    BIGBNET,ROWHL+ACCUMLQ(ACCUMLQ,R6)                                
*                                                                               
         L     RF,ADESC                                                         
         CLI   0(RF),X'FA'         FOR PREVIOUSLY BILLED LUMP                   
         BNE   *+18                                                             
         CLC   0(ROW$L,R6),ROWHL(R6)  ANY BILLABLE $ (NOT SPOTS)?               
         BE    RB19                SAFE TO CLC, FIELDS SAME LEN (YKVA)          
         B     RB18D                                                            
*                                                                               
*                                  FOR UNITS                                    
RB18B    CLC   0(ROW$L,R6),ROWHL(R6)  ANY BILLABLE $ (NOT SPOTS)?               
         BE    RB19                                                             
*                                                                               
RB18D    DS    0H                                                               
         MVI   BILSW,C'Y'          SET ACTIVITY                                 
*                                                                               
RB19     DS    0H                                                               
         MVC   TRCKWRD,=C'RB19 '                                                
         BAS   RE,TRCK                                                          
         CLC   FFS,THISKEY                                                      
         BE    RB20                                                             
         MVC   OLDREC,THISREC                                                   
         B     RB4                                                              
*                                                                               
RB20     DS    0H                                                               
         MVI   PRSW,C'F'           PRINT ANY LEFTOVER LINES                     
         BRAS  RE,PRNT                                                          
         MVC   RCTRACE,SAVTRACE                                                 
         L     RE,=A(INVLIST)      CLEAR LINE INVOICE NUMBER LIST               
         LHI   RF,INVLISTL*NCTYPS                                               
         XCEF                                                                   
         XC    INVTABN,INVTABN                                                  
*                                                                               
         LA    RE,*+10                                                          
         O     RE,=X'80000000'     SWITCH TO 31 BIT MODE TO CLEAR               
         BSM   0,RE                                                             
         L     RF,AINVTAB          CLEAR INVTAB                                 
         XC    0(256,RF),0(RF)                                                  
         LA    RE,*+6                                                           
         BSM   0,RE                                                             
*                                                                               
         J     XIT                                                              
         EJECT                                                                  
SETPASS  NTR1                                                                   
*                                                                               
         ZAP   BIGOGRS,=P'0'       ZAP BIG TOTALS                               
         ZAP   BIGONET,=P'0'                                                    
         ZAP   BIGBGRS,=P'0'                                                    
         ZAP   BIGBNET,=P'0'                                                    
*                                                                               
         MVC   FORMAT,BFORMAT                                                   
         MVC   APAGBRK,SVPAGBRK    RESTORE                                      
         MVC   ALOWTOG,SVLOWTOG                                                 
         MVC   SPOTCTL,SPOTSW                                                   
         OC    ARECAP,ARECAP                                                    
         BZ    SETCOLS                                                          
*                                                                               
         MVC   APAGBRK,AINVBRK     FOR RECAP NO PAGE BRKS                       
         MVC   ALOWTOG,ARECAP                                                   
         MVI   SPOTCTL,C'N'        IF RECAP THEN NO SPOT DETAILS                
*                                  ON MAIN BILL                                 
*                                                                               
*                                  SET COLS USEABLE FOR DESCRIPTIONS            
SETCOLS  DS    0H                                                               
         MVI   TWOCOL,C'Y'         2 COLS AVALIBLE                              
         CLI   FORMAT,1            UNLESS FORMAT 1                              
         BNE   SETPASSX                                                         
         CLI   PERCTL,C'T'         AND PERIODS NOT TOGETHER                     
         BE    SETPASSX                                                         
         MVI   TWOCOL,C'N'                                                      
*                                                                               
SETPASSX J     XIT                                                              
         SPACE 3                                                                
RBTRCE   NTR1                                                                   
*                                                                               
         CLI   SORTTRCE,C'O'                                                    
         BL    RBTRCEX                                                          
*                                                                               
         MVC   P+1(L'PASSNO),PASSNO  BUILD HEADER NARRATION IN P                
         OI    P+1,C'0'                                                         
         MVC   P+4(L'BYTE),BYTE                                                 
         LA    RF,RDBUFF                                                        
         A     RF,BRKCODE                                                       
         AHI   RF,BRKLIST-RDBUFF-4                                              
         MVC   P+5(4),0(RF)                                                     
         GOTO1 PRNTBL,DMCB,(10,P),SORTREC,C'DUMP',SORTRLEN,=C'1D'               
         MVC   P,SPACES            CLEAR NARRATION                              
*                                                                               
RBTRCEX  J     XIT                                                              
         SPACE 2                                                                
*                                  SPECIAL TRACE OF 'KEYS'                      
TRCK     NTR1                                                                   
*                                                                               
         CLI   SORTTRCE,C'Y'                                                    
         BNH   TRCKX                                                            
*                                                                               
         MVC   P(L'TRCKWRD),TRCKWRD                                             
         MVC   P+6(4),=C'PASS'                                                  
         MVC   P+11(L'PASSNO),PASSNO                                            
         OI    P+11,C'0'                                                        
         MVI   P+12,C'0'           LEFT OVER FROM RETAIL BILLING                
*                                                                               
         MVC   P+14(5),=C'SORT='                                                
         GOTO1 HEXOUT,DMCB,SORTKEY,P+19,10,=C'N'                                
         MVC   P+40(5),=C'THIS='                                                
         GOTO1 HEXOUT,DMCB,THISKEY,P+45,10,=C'N'                                
         MVC   P+66(5),=C' OLD='                                                
         GOTO1 HEXOUT,DMCB,OLDKEY,P+71,10,=C'N'                                 
         MVC   P+92(5),=C'PASS='                                                
         GOTO1 HEXOUT,DMCB,PASSKEY,P+97,10,=C'N'                                
*                                                                               
         BRAS  RE,PRNT                                                          
*                                                                               
TRCKX    J     XIT                                                              
         SPACE 2                                                                
         LTORG                                                                  
         SPACE 3                                                                
TRCKWRD  DC    CL5' '                                                           
         SPACE 3                                                                
BRKLIST  DS    0C                                                               
         DC    C'PGR1'                                                          
         DC    C'PGR2'                                                          
         DC    C'PGR3'                                                          
         DC    C'PRD '                                                          
         DC    C'EST '                                                          
         DC    C'MGR1'                                                          
         DC    C'MGR2'                                                          
         DC    C'MGR3'                                                          
         DC    C'MKT '                                                          
         DC    C'STA '                                                          
         DC    C'PKG '                                                          
         DC    C'PGM '                                                          
         DC    C'DESC'                                                          
         DC    C'PER '                                                          
         DC    C'PERG'                                                          
         DC    C'CTYP'                                                          
         DC    C'DPT '                                                          
         EJECT                                                                  
DOBREAK  NMOD1 0,DOBREAK,R9                                                     
         LA    RC,SPACEND                                                       
*                                                                               
         L     RF,BRKCODE                                                       
         CLI   BYTE3,C'F'          COULD BE "FIRST" OR "LAST" BREAK             
         BNE   *+12                                                             
         BAS   RE,FRSTTAB-4(RF)    FIRST                                        
         B     *+8                                                              
         BAS   RE,LASTTAB-4(RF)    LAST                                         
*                                                                               
         J     XIT                                                              
         SPACE 3                                                                
*        'FIRSTS'                                                               
         SPACE 2                                                                
FRSTTAB  DS    0F                                                               
         B     FPGR1                                                            
         B     FPGR2                                                            
         B     FPGR3                                                            
         B     FPRD                                                             
         B     FEST                                                             
         B     FMGR1                                                            
         B     FMGR2                                                            
         B     FMGR3                                                            
         B     FMKT                                                             
         B     FSTA                                                             
         B     FPKG                                                             
         B     FPGM                                                             
         B     FDESC                                                            
         B     FPER                                                             
         B     FPERG                                                            
         B     FCTYP                                                            
         B     FDPT                                                             
         SPACE 3                                                                
*        'LASTS'                                                                
         SPACE 2                                                                
LASTTAB  DS    0F                                                               
         B     LPGR1                                                            
         B     LPGR2                                                            
         B     LPGR3                                                            
         B     LPRD                                                             
         B     LEST                                                             
         B     LMGR1                                                            
         B     LMGR2                                                            
         B     LMGR3                                                            
         B     LMKT                                                             
         B     LSTA                                                             
         B     LPKG                                                             
         B     LPGM                                                             
         B     LDESC                                                            
         B     LPER                                                             
         B     LPERG                                                            
         B     LCTYP                                                            
         B     LDPT                                                             
         EJECT                                                                  
*        FIRST FOR PRODUCT GROUP                                                
         SPACE 2                                                                
FPGR1    DS    0H                                                               
         LA    R5,PGR1             PGR1 DATA                                    
         B     FPGRA                                                            
         SPACE 2                                                                
FPGR2    DS    0H                                                               
         LA    R5,PGR2             PGR2 DATA                                    
         B     FPGRA                                                            
         SPACE 3                                                                
FPGR3    DS    0H                                                               
         LA    R5,PGR3             PGR3 DATA                                    
         SPACE 3                                                                
FPGRA    NTR1                                                                   
*                                                                               
         OC    ALOWTOG,ALOWTOG                                                  
         BZ    *+12                                                             
         C     R3,ALOWTOG          TEST IF TO APPEAR                            
         BH    FPGRAX              NO                                           
         L     RF,APGR1            POINT TO PRG1 FIELD                          
         ZIC   RE,PGR3LEN                                                       
*                                                                               
         XC    WORK(5),WORK                                                     
         BCTR  RE,0                                                             
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   WORK(0),0(RF)                                                    
         PACK  DUB(3),WORK(5)      PWOS PRG                                     
         CLC   DUB(2),SVPGRKEY+(PRGKGRP-PRGKEY) ALREADY HAVE PGR'S?             
         BE    FPGRA4              YES                                          
*                                                                               
         MVC   KEY,SVPGRKEY                                                     
         MVC   (PRGKGRP-PRGKEY)+KEY,DUB                                         
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BNE   FPGRA3                                                           
         GOTO1 GETPRDGR                                                         
         MVC   SVPGRKEY,KEY                                                     
         B     FPGRA3B                                                          
*                                                                               
FPGRA3   DS    0H                                                               
         MVC   PGR1+1(4),=C'999 '                                               
         MVC   PGR1NM,=CL24'*** UNDEFINED ***'                                  
         MVC   PGR2+1(4),=C'999 '                                               
         MVC   PGR2NM,=CL24'*** UNDEFINED ***'                                  
         MVC   PGR3+1(4),=C'999 '                                               
         MVC   PGR3NM,=CL24'*** UNDEFINED ***'                                  
*                                                                               
         MVC   (PRGKGRP-PRGKEY)+SVPGRKEY,=X'9999'                               
*                                                                               
FPGRA3B  DS    0H                                                               
         XC    SVMGRKEY,SVMGRKEY   RESET FOR MGR READS                          
*                                                                               
FPGRA4   DS    0H                                                               
         C     R3,APAGBRK          PGR 'HIGHER' THAN PAGE BREAK?                
         BNH   FPGRA10             YES                                          
*                                  PGR 'TOGETHER'                               
         CLC   P,SPACES                                                         
         BE    *+12                                                             
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT             CLEAR P                                      
*                                                                               
         OC    18(24,R5),SPACES                                                 
         CLC   ALOWTOG,AHITOG                                                   
         BNE   FPGRA5                                                           
*                                  IS ONLY TOGETHER                             
         MVC   P(5),0(R5)                                                       
         CLI   TWOCOL,C'Y'                                                      
         BNE   *+14                                                             
         MVC   P+6(24),18(R5)                                                   
         B     FPGRA5                                                           
         GOTO1 CHOPPER,DMCB,(24,18(R5)),(14,P+6),(C'P',2)                       
         B     FPGRA10                                                          
*                                                                               
FPGRA5   DS    0H                                                               
         MVC   P(12),6(R5)         DESC                                         
         LA    RF,P+12                                                          
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         MVC   2(5,RF),0(R5)       NUMBER                                       
*                                                                               
         CLI   TWOCOL,C'Y'                                                      
         BNE   *+14                                                             
         MVC   P2(24),18(R5)                                                    
         B     FPGRA6                                                           
         GOTO1 CHOPPER,DMCB,(24,18(R5)),(20,P2),(C'P',2)                        
*                                                                               
FPGRA6   DS    0H                                                               
         BAS   RE,ULINE                                                         
         B     FPGRA10                                                          
*                                  PRG IN HEADLINES                             
FPGRA10  DS    0H                                                               
         GOTO1 ABILLEDI,DMCB,('EDMPGR',0)   EDI CALL                            
*                                                                               
FPGRAX   DS    0H                                                               
         J     XIT                                                              
         EJECT                                                                  
*              FIRST FOR PRODUCT                                                
         SPACE 2                                                                
FPRD     NTR1                                                                   
*                                                                               
*&&DO                                                                           
         CLI   CTYPCTL,C'S'        IF COST TYPES SEPARATELY                     
         BNE   *+12                DON'T CLEAR TABLE HERE                       
         BAS   RE,PSTCTYP          PUT THIS CTYP INFO IN CTYPTAB                
         B     FPRD2                                                            
*                                  IF TOGETHER                                  
         L     RE,=A(CTYPTAB)      CLEAR CHARGE TYPE TABLE                      
         LHI   RF,CTYPTMAX*CTYPTBL                                              
         XCEF                                                                   
         L     R1,=A(CTYPTAB)      INIT 1ST ROW TO PACKED                       
         MVI   0(R1),X'FF'                                                      
         LA    R1,CTYPBRK(R1)      POINT TO $$                                  
         LA    RF,ROWTL(R1)        POINT PAST $$                                
         BRAS  RE,ZAPSTR                                                        
*&&                                                                             
*                                  NOTE - EVEN IF NOT PRINTING PRODUCT          
*                                  READ PRODUCT RECORD FOR BILL FORMULA         
*                                                                               
FPRD2    CLI   BFROPT,C'N'         IF NOT DOING NEW BFR'S                       
         BNE   *+18                                                             
         CLC   AESTBRK,APRDBRK     ESTIMATE 'HIGHER' THAN PRODUCT?              
         BNL   *+8                 NO                                           
         BAS   RE,SETEST           YES- TRY FOR ESTIMATE FORMULA                
*                                                                               
         BRAS  RE,GETAOR           GET ANY AOR INFO                             
*                                                                               
         L     R4,APRD                                                          
*        ZIC   R4,0(RF)            GET PRODUCT CODE FROM PRODUCT SEQ            
*        MHI   R4,4                                                             
*        L     RF,VCLIST                                                        
*        LA    R4,0(RF,R4)                                                      
         L     RF,ADCLT                                                         
         MVC   KEY(13),0(RF)                                                    
         MVC   (PKEYPRD-PRDHDR)+KEY,0(R4)      3-CHAR PRODUCT CODE              
         L     RF,ADPRD                                                         
         CLC   KEY(13),0(RF)       ALREADY HAVE PRDHDR?                         
         BE    FPRD4                                                            
         GOTO1 READ                                                             
         GOTO1 GETPRD                                                           
*                                                                               
FPRD4    DS    0H                                                               
         L     RF,ADPRD                                                         
         USING PRDHDR,RF                                                        
         MVC   PRDFORM,PBILLBAS    HOLD FORMULA                                 
         MVC   EFFDTE,PBILLDT      HOLD EFFECTIVE DATE                          
*                                                                               
         CLI   PRDCTL,C'N'         NOT PRINTING PRODUCT                         
         BE    FPRDX                                                            
         OC    ALOWTOG,ALOWTOG                                                  
         BZ    *+12                                                             
         C     R3,ALOWTOG          TEST IF TO APPEAR                            
         BH    FPRDX               NO                                           
*                                                                               
         MVC   BADDRS(132),SPACES                                               
         MVC   BADDRS+132(L'BADDRS-132),SPACES                                  
         CLC   =C'NONE',PADDR1                                                  
         BE    FPRD6                                                            
         CLC   =C'XX',PADDR1                                                    
         BE    FPRD6                                                            
         CLC   =C'X ',PADDR1                                                    
         BE    FPRD6                                                            
         CLI   PADDR1,C'A'                                                      
         BL    FPRD6                                                            
         MVC   BADDR1(L'PADDR1),PADDR1                                          
         MVC   BADDR2(L'PADDR2),PADDR2                                          
         MVC   BADDR3(L'PADDR3),PADDR3                                          
         MVC   BADDR4(L'PADDR4),PADDR4                                          
         DROP  RF                                                               
*                                                                               
FPRD6    DS    0H                                                               
         C     R3,APAGBRK          IS PRODUCT 'HIGHER' THAN PAGE BREAK?         
         BNH   FPRD10K             YES                                          
         CLI   PRDCTL,C'S'                                                      
         BE    FPRD10K                                                          
         CLC   P,SPACES                                                         
         BE    FPRD4B                                                           
         CLC   P(8),=C'PRODUCT-'   PREVENT PRINTING OF UNUSED                   
         BNE   FPRD6B              PRODUCT (CAN HAPPEN IN RETAIL)               
         MVC   P,SPACES                                                         
         MVC   P2,SPACES                                                        
         MVC   P3,SPACES                                                        
*                                                                               
FPRD6B   DS    0H                                                               
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT             CLEAR P                                      
*                                                                               
FPRD4B   DS    0H                                                               
*                                  PUT ACCT NO (IF ANY) IN X(7)                 
         CLI   AGMCLNO,C'C'        SUPPRESS IF B1 OPTION IS C                   
         BE    FPRD4D                                                           
         CLI   AGMCLNO,C'X'        OR X                                         
         BE    FPRD4D                                                           
         MVC   X(7),SPACES                                                      
         L     RF,ADPRD                                                         
         MVC   FULL,PACCT-PRDHDR(RF)                                            
         CLI   FULL,C' '                                                        
         BNH   FPRD4D                                                           
         CLC   FULL,=C'0000'                                                    
         BE    FPRD4D                                                           
         OC    FULL+1(3),FULL+1                                                 
         BZ    FPRD4D                                                           
         MVI   X,C'('                                                           
         MVC   X+1(4),FULL                                                      
         MVI   X+5,C')'                                                         
         CLI   FULL,X'FF'                                                       
         BNE   *+14                                                             
         UNPK  X+1(5),FULL+1(3)                                                 
         MVI   X+6,C')'                                                         
*                                                                               
FPRD4D   DS    0H                                                               
         OC    PRDNM,SPACES                                                     
         CLC   ALOWTOG,AHITOG      IS PRODUCT ONLY 'TOGETHER'?                  
         BE    FPRD5               YES                                          
*                                  PRODUCT NOT ONLY                             
         MVC   P(8),=C'PRODUCT-'                                                
         MVC   P+9(L'PRD),PRD                                                   
         MVC   P+14(7),X           ACCT NO.                                     
         CLI   TWOCOL,C'Y'                                                      
         BNE   *+14                                                             
         MVC   P2(L'PRDNM),PRDNM                                                
         B     FPRD4F                                                           
         GOTO1 CHOPPER,DMCB,(24,PRDNM),(20,P2),(C'P',2)                         
FPRD4F   DS    0H                                                               
         CLI   WMTSW,C'Y'                                                       
         BNE   FPRD4H                                                           
         MVC   W,SPACES                                                         
         GOTO1 =V(GETUSER),DMCB,(C'S',ADCLT),(C'E',ADEST),(C':',W),0            
         MVC   P2+24(20),W                                                      
         BRAS  RE,PRNT                                                          
         B     FPRD4K                                                           
*                                                                               
FPRD4H   DS    0H                                                               
         CLI   PGSW,C'Y'            ONLY FOR H9, PGB & DU PG1                   
         BNE   FPRD4K               PRINT UDEF NEXT TO PRD NAME                 
         MVC   W,SPACES                                                         
         GOTO1 =V(GETUSER),DMCB,(C'S',ADCLT),(C'E',ADEST),0,(C':',W)            
         MVC   P2+24(20),W                                                      
         BRAS  RE,PRNT                                                          
         MVC   W,SPACES             AND ACCOUNT #                               
         GOTO1 =V(GETUSER),DMCB,(C'S',ADCLT),(C'E',ADEST),(C':',W),0            
         MVC   P+24(21),W                                                       
*                                                                               
FPRD4K   C     R3,ALOWTOG                                                       
         BE    *+8                                                              
         BAS   RE,ULINE                                                         
         B     FPRD10K                                                          
*                                  PRODUCT ONLY 'TOGETHER'                      
FPRD5    DS    0H                                                               
         MVC   P(L'PRD),PRD                                                     
         MVC   W,SPACES                                                         
         MVC   W(L'PRDNM),PRDNM                                                 
         LA    RF,W+24             FLOAT ACCT NO AFTER                          
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         MVC   2(7,RF),X                                                        
         CLI   TWOCOL,C'Y'                                                      
         BNE   *+14                                                             
         MVC   P+4(33),W                                                        
         B     FPRD10                                                           
         GOTO1 CHOPPER,DMCB,(33,W),(16,P+4),(C'P',3)                            
FPRD10   DS    0H                                                               
         CLI   PGSW,C'Y'                                                        
         BNE   FPRD10K                                                          
         MVC   W,SPACES                                                         
         GOTO1 =V(GETUSER),DMCB,(C'S',ADCLT),(C'E',ADEST),0,(C':',W)            
         MVC   P+31(20),W                                                       
         BRAS  RE,PRNT                                                          
         MVC   W,SPACES                                                         
         GOTO1 =V(GETUSER),DMCB,(C'S',ADCLT),(C'E',ADEST),(C':',W),0            
         MVC   P+31(21),W                                                       
FPRD10K  GOTO1 ABILLEDI,DMCB,('EDMPRD',0)   EDI CALL                            
FPRDX    DS    0H                                                               
         J     XIT                                                              
*                                                                               
*        FIRST FOR ESTIMATE                                                     
*                                                                               
FEST     NTR1                                                                   
*                                                                               
*                                  NOTE-EVEN IF NOT PRINTING ESTIMATES          
*                                  READ EST RECORD FOR BILL FORMULA             
         BRAS  RE,GETAOR           GET ANY AOR INFO                             
         BAS   RE,SETEST                                                        
*                                                                               
         CLI   ESTCTL,C'N'         NOT PRINTING ESTIMATE                        
         BE    FESTX                                                            
         OC    ALOWTOG,ALOWTOG                                                  
         BZ    *+12                                                             
         C     R3,ALOWTOG          TEST IF TO APPEAR                            
         BH    FESTX               NO                                           
*                                                                               
         C     R3,APAGBRK          IS ESTIMATE 'HIGHER' THAN PAGE BREAK         
         BNH   FEST10K             YES                                          
         CLC   P,SPACES                                                         
         BE    *+12                                                             
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT             CLEAR P                                      
*                                                                               
         OC    ESTNM,SPACES                                                     
         CLC   ALOWTOG,AHITOG      IS ESTIMATE ONLY 'TOGETHER'                  
         BE    FEST5               YES                                          
*                                  ESTIMATE NOT ONLY                            
         MVC   P(8),=C'ESTIMATE'                                                
         MVC   P+9(L'EST),EST                                                   
         CLI   TWOCOL,C'Y'                                                      
         BNE   *+14                                                             
         MVC   P2(L'ESTNM),ESTNM                                                
         B     FEST3D                                                           
*                                                                               
         GOTO1 CHOPPER,DMCB,(24,ESTNM),(20,P2),(C'P',2)                         
FEST3D   DS    0H                                                               
         CLI   MSSW,C'Y'            ONLY FOR MINDSHARE CLT = BMS, NV            
         BNE   FEST4                                                            
         MVC   W,SPACES                                                         
         GOTO1 =V(GETUSER),DMCB,(C'S',ADCLT),(C'E',ADEST),(C':',W),0            
         MVC   P2+24(40),W                                                      
FEST4    C     R3,ALOWTOG                                                       
         BE    *+8                                                              
         BAS   RE,ULINE                                                         
         B     FEST10K                                                          
*                                  ESTIMATE IS ONLY TOGETHER                    
FEST5    DS    0H                                                               
         MVC   P(L'EST),EST                                                     
         CLI   TWOCOL,C'Y'                                                      
         BNE   *+14                                                             
         MVC   P+4(L'ESTNM),ESTNM                                               
         B     FEST10                                                           
*                                                                               
         GOTO1 CHOPPER,DMCB,(24,ESTNM),(16,P+4),(C'P',2)                        
FEST10   DS    0H                                                               
         CLI   MSSW,C'Y'                                                        
         BNE   FEST10K                                                          
         MVC   W,SPACES                                                         
         GOTO1 =V(GETUSER),DMCB,(C'S',ADCLT),(C'E',ADEST),(C':',W),0            
         MVC   P+24(40),W                                                       
FEST10K  GOTO1 ABILLEDI,DMCB,('EDMEST',0)   EDI CALL                            
FESTX    DS    0H                                                               
         J     XIT                                                              
         EJECT                                                                  
SETEST   NTR1                                                                   
*                                                                               
         L     RF,ADCLT            BUILD ESTIMATE KEY                           
         MVC   KEY,0(RF)                                                        
         L     R4,APRD                                                          
*        ZIC   R4,0(RE)                                                         
*        MHI   R4,4                                                             
*        L     R1,VCLIST                                                        
*        LA    R4,0(R1,R4)         GET ALPHA PRODUCT                            
KEY@     USING ESTHDR,KEY                                                       
         MVC   KEY@.EKEYPRD,0(R4)                                               
         L     RF,AEST                                                          
         MVC   KEY@.EKEYEST,0(RF)                                               
         L     R4,ADEST                                                         
         CLC   KEY@.EKEY,0(R4)     ALREADY HAVE ESTHDR?                         
         BNE   *+14                                                             
         CLC   EST,SPACES          GOT EST HEADER VIA GETEST BEFORE?            
         BH    SEST2               IF NOT, DO GETEST IN ORDER TO                
         DROP  KEY@                POPULATE WORKD FIELDS                        
*                                                                               
         GOTO1 READ                                                             
         GOTO1 GETEST                                                           
*                                                                               
SEST2    DS    0H                                                               
         L     RF,ADEST                                                         
         USING ESTHDR,RF                                                        
         MVC   ESTFORM,EBILLBAS    HOLD FORMULA                                 
*                                                                               
         XC    AAEFORM,AAEFORM                                                  
         L     RE,=A(AAAELIST)     SET AAA ESTIMATE FORMULA IF ANY              
         USING AAAELSTD,RE                                                      
SEST3    DS    0H                                                               
         CLC   0(AAAELSTL,RE),FFS  EOL?                                         
         BE    SEST5                                                            
         CLC   EKEYEST,AAAELEST    EST =                                        
         BE    *+12                                                             
         LA    RE,AAAELSTL(RE)                                                  
         B     SEST3                                                            
         MVC   AAEFORM,AAAELFOR                                                 
         DROP  RE                                                               
*                                                                               
SEST5    DS    0H                                                               
*              SET COST2 OPTION                                                 
*              NOTE- ALSO SET AT ESTF IN 'A' ASSEMBLY                           
*                    SO WILL HAVE IN NETNU                                      
*                                                                               
         MVI   COST2SW,C'N'                                                     
         CLI   COST2CSW,C'Y'       IF COST2 OPTION AT CLIENT LEVEL              
         BNE   SEST6                                                            
         TM    ECOST2,X'80'        COST2 ACTIVE?                                
         BNZ   *+8                                                              
         MVI   COST2SW,C'Y'                                                     
         DROP  RF                                                               
*                                                                               
SEST6    DS    0H                                                               
         J     XIT                                                              
         EJECT                                                                  
*        FIRST FOR MARKET GROUP                                                 
*                                                                               
FMGR1    DS    0H                                                               
FMGR2    DS    0H                                                               
FMGR3    DS    0H                                                               
FMGRA    BR    RE                                                               
         SPACE 2                                                                
FMKT     BR    RE                                                               
         SPACE 2                                                                
FPERG    DS    0H                                                               
         CLI   BFRMOS,C'S'    IGNORE PERCTL RESET IF SEPARATE BFR MOS           
         BER   RE                                                               
         CLI   PRIOR,C'M'                                                       
         BNER  RE                                                               
         MVI   PERCTL,C'T'         RESET PERCTL                                 
         L     RF,APERG                                                         
         CLI   0(RF),C'5'          A SEPARATE CURRENT MONTH?                    
         BNER  RE                  NO                                           
         MVI   PERCTL,C'S'         YES - TREAT AS SEPARATE                      
         BR    RE                                                               
         EJECT                                                                  
FSTA     NTR1                                                                   
*                                                                               
         CLI   STACTL,C'N'                                                      
         BE    FSTAX                                                            
         L     RF,ADESC                                                         
         CLI   0(RF),X'FB'         SKIP FOR MANUALS                             
         BNL   FSTAX                                                            
*                                                                               
         L     R4,ASTA                                                          
         SHI   R4,2                                                             
         GOTO1 MSUNPK,DMCB,(R4),DUB,WORK                                        
         MVC   BIGSTA(4),WORK                                                   
*                                                                               
         MVC   STANAME,SPACES                                                   
         L     RF,ADESC                                                         
         CLI   0(RF),X'FA'         SKIP CITY AND PRINTING FOR                   
         BNE   FSTA4D              PREVIOUS BILLED LUMPS                        
         CLI   ZUOPT,C'L'          UNLESS LUMPING                               
         BE    FSTA4D                                                           
         CLI   ZUOPT,C'N'          OR IGNORING                                  
         BNE   FSTAX                                                            
*                                                                               
FSTA4D   DS    0H                                                               
         CLI   PROFB4A+9,C'Y'      NEED NETWORK NAME?                           
         BNE   FSTA4M                                                           
*                                  GET STATION RECORD                           
         LA    R5,KEY                                                           
         USING STAREC,R5                                                        
         MVI   STAKTYPE,STAKTYPQ                                                
         MVC   STAKMED,QMED                                                     
         MVC   STAKCALL(4),BIGSTA                                               
         MVI   STAKCALL+4,C'N'                                                  
         MVC   STAKAGY,QAGY                                                     
         MVC   STAKCLT,CLT                                                      
         MVC   STAKFILL,=C'000'                                                 
         GOTO1 READSTA                                                          
         CLI   DMCB,0                                                           
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R5,ADSTAT                                                        
         CLI   STYPE,C'N'          FOR BIG NETWORKS, SKIP NAME                  
         BE    FSTA4M                                                           
         DROP  R5                                                               
*                                                                               
         LA    R5,KEY                                                           
         USING ADDRREC,R5                                                       
         MVI   ADDKTYPE,ADDKTYPQ                                                
         MVC   ADDKMED,QMED                                                     
         MVC   ADDKCALL(4),BIGSTA                                               
         MVI   ADDKCALL+4,C'N'                                                  
         MVC   ADDKAGY,QAGY                                                     
         MVC   ADDKFILL,=C'000000'                                              
         GOTO1 HIGHSTAD                                                         
*                                                                               
         L     R5,ADSTATAD                                                      
         CLC   ADDRKEY,KEYSAVE                                                  
         BNE   FSTA4M                                                           
         MVC   STANAME,ANAME       STATION NAME                                 
         OC    STANAME,SPACES                                                   
         DROP  R5                                                               
*                                                                               
FSTA4M   DS    0H                                                               
         C     R3,ALOWTOG                                                       
*        BNL   FSTAX               SKIP IF LOWEST TOG OR NOT TO APPEAR          
         BH    FSTAX               SKIP IF NOT TO APPEAR                        
         BE    FSTA8               SKIP PRINTING, GOTO EDI                      
*                                                                               
         C     R3,APAGBRK          STATION 'HIGHER' THAN PAGE BREAK?            
         BNH   FSTA8               YES                                          
*                                  STATION TOGETHER (WITH SPOT DETAILS)         
         CLC   P,SPACES                                                         
         BE    *+12                                                             
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
*                                                                               
         LA    RF,P+5              PLACE FOR STATION                            
         CLI   FORMAT,1            FOR FORMAT 1                                 
         BNE   *+8                                                              
         LA    RF,P+1              PUT AT P+1                                   
         MVC   0(9,RF),BIGSTA                                                   
         MVC   10(20,RF),STANAME                                                
*                                                                               
FSTA8    DS    0H                                                               
         GOTO1 ABILLEDI,DMCB,('EDMSTA',0)   EDI CALL                            
*                                                                               
FSTAX    DS    0H                                                               
         J     XIT                                                              
         EJECT                                                                  
FPER     DS    0H                                                               
         BR    RE                                                               
         SPACE 2                                                                
FPGM     DS    0H                                                               
         BR    RE                                                               
         SPACE 2                                                                
FDESC    DS    0H                                                               
         BR    RE                                                               
         SPACE 2                                                                
FPKG     NTR1                                                                   
*                                                                               
         CLI   SPOTCTL,C'Y'                                                     
         BNE   FPKGX                                                            
         CLI   PKGCTL,C'S'                                                      
         BE    FPKGX                                                            
         L     RF,ADESC                                                         
         CLI   0(RF),X'FB'         SKIP FOR MANUALS                             
         BNL   FPKGX                                                            
*                                                                               
         BRAS  RE,FNDPKG                                                        
*                                                                               
         CLI   0(RF),X'FA'         SKIP PRINTING FOR                            
         BNE   FPKG4               PREVIOUS BILLED LUMPS                        
         CLI   ZUOPT,C'L'          UNLESS LUMPING                               
         BE    FPKG4                                                            
         CLI   ZUOPT,C'N'          OR IGNORING                                  
         BNE   FPKGX                                                            
FPKG4    DS    0H                                                               
         CLI   PKGNME,C' '                                                      
         BNH   FPKGX                                                            
*                                                                               
         CLC   P+17(5),SPACES      NEED TO PRINT LINE FIRST?                    
         BE    *+8                                                              
         BRAS  RE,PRNT                                                          
*                                                                               
         MVC   P+17(4),=C'PKG='                                                 
         MVC   P+22(16),PKGNME                                                  
*                                  UNDERLINE                                    
         LA    RF,P+22+16                                                       
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         LA    R0,P+22                                                          
         SR    RF,R0                                                            
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   P2+22(0),DASHES                                                  
*                                                                               
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
*                                                                               
FPKGX    DS    0H                                                               
         J     XIT                                                              
         SPACE 2                                                                
FCTYP    DS    0H                  FIRST FOR COST TYPE                          
         BR    RE                                                               
         SPACE 2                                                                
FDPT     NTR1                      FIRST FOR DAYPART                            
*                                                                               
         CLI   SPOTCTL,C'Y'                                                     
         BNE   FDPTX                                                            
***      CLI   DPTFILT,C' '                                                     
***      BH    FDPTX                                                            
         CLI   DPTSEP,C'T'                                                      
         BNE   FDPTX                                                            
         L     RF,ADESC                                                         
         CLI   0(RF),X'FB'         SKIP FOR MANUALS                             
         BNL   FDPTX                                                            
         CLI   0(RF),X'FA'         SKIP PRINTING FOR                            
         BNE   FDPT4               PREVIOUS BILLED LUMPS                        
         CLI   ZUOPT,C'L'          UNLESS LUMPING                               
         BE    FDPT4                                                            
         CLI   ZUOPT,C'N'          OR IGNORING                                  
         BNE   FDPTX                                                            
*                                                                               
FDPT4    DS    0H                                                               
         CLC   P+17(5),SPACES      NEED TO PRINT LINE FIRST?                    
         BE    *+8                                                              
         BRAS  RE,PRNT                                                          
*                                                                               
         MVC   P+17(4),=C'DPT='                                                 
         BRAS  RE,GETDPT                                                        
         LA    R6,WORK                                                          
         USING NDPTHDRD,R6                                                      
         MVC   P+21(L'NDPTDPTA),NDPTDPTA   USE 2-CHARACTER DAYPART              
         MVC   P+25(L'NDPTDES),NDPTDES     14 CHARACTER DESCRIPTION             
         DROP  R6                                                               
*                                                                               
*                                  UNDERLINE                                    
         LA    RF,P+25+L'NDPTDES                                                
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         LA    R0,P+21                                                          
         SR    RF,R0                                                            
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   P2+21(0),DASHES                                                  
*                                                                               
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
FDPTX    J     XIT                                                              
         EJECT                                                                  
*        LAST FOR PRODUCT GROUP                                                 
         SPACE 2                                                                
LPGR1    DS    0H                                                               
         LA    R5,PGR1             PGR1 DATA                                    
         B     LPGRA                                                            
         SPACE 2                                                                
LPGR2    DS    0H                                                               
         LA    R5,PGR2             PGR2 DATA                                    
         B     LPGRA                                                            
         SPACE 2                                                                
LPGR3    DS    0H                                                               
         LA    R5,PGR3             PGR3 DATA                                    
         B     LPGRA                                                            
         SPACE 2                                                                
LPGRA    NTR1                                                                   
*                                                                               
         C     R3,ALOWTOG          IS THIS LOWEST TOGETHER                      
         BE    LPGRA8              YES                                          
         BH    LPGRX               BYPASS IF 'LOWER' (ON RECAPS)                
*                                  PGR NOT LOWEST                               
         MVC   P(2),=C'**'                                                      
         MVC   P+2(12),6(R5)       DESC                                         
         LA    RF,P+14                                                          
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         MVC   2(8,RF),=C'TOTALS**'                                             
*                                                                               
LPGRA8   DS    0H                                                               
         MVC   TOTNAME,6(R5)       SAVE DESCRIPTION                             
         BRAS  RE,TOTOUT                                                        
         BRAS  RE,PRTADJ                                                        
*                                                                               
LPGRX    DS    0H                                                               
         J     XIT                                                              
         EJECT                                                                  
*        LAST FOR PRODUCT                                                       
         SPACE 2                                                                
LPRD     NTR1                                                                   
*                                                                               
         BRAS  RE,BILCALC                                                       
         CLI   PRDCTL,C'N'                                                      
         BE    LPRD12                                                           
         C     R3,ALOWTOG          IS THIS LOWEST TOGETHER                      
         BE    LPRD8               YES                                          
         BH    LPRDX               BYPASS IF 'LOWER' (ON RECAPS)                
*                                  PRODUCT NOT LOWEST                           
         MVC   P+2(14),=C'PRODUCT TOTALS'                                       
         CLI   PRDMKT,C'M'                                                      
         BE    *+16                                                             
         MVC   P(2),=C'**'                                                      
         MVC   P+16(2),=C'**'                                                   
*                                                                               
LPRD8    DS    0H                                                               
         MVC   TOTNAME,=CL12'PRODUCT'                                           
         BRAS  RE,TOTOUT                                                        
*                                  NEED TO SAVE CORP DATA NOW?                  
         CLI   SUMLEV,C'P'                                                      
         BE    *+16                                                             
         CLI   SUMLEV,0                                                         
         BH    *+8                                                              
         MVI   SUMLEV,C'P'         CORP DATE SAVED AT PRODUCT LEVEL             
         BRAS  RE,PRTADJ                                                        
         B     LPRDX                                                            
*                                  HERE IF PRODUCTS LUMPED                      
LPRD12   DS    0H                  NEED TO WRITE NET UNITS NOW                  
         CLI   PASSNO,1            IF PASS 1                                    
         BNE   LPRDX                                                            
*                                                                               
         L     RF,ADESC                                                         
         CLI   0(RF),X'FA'         SKIP MANUALS                                 
         BH    LPRDX                                                            
*                                                                               
****     CLI   CTYPCTL,C'S'        IF SEP INVOICE PER CTYPE                     
****     BNE   *+8                 ADD ENTRY TO CTYPTAB HERE                    
****     BAS   RE,PSTCTYP          OTHERWISE SHOULD ALREADY BE THERE            
         L     R1,=A(CTYPTAB)                                                   
         CLI   0(R1),X'FF'         ANYTHING IN TABLE ?                          
         BNE   LPRD14                                                           
         BAS   RE,PSTCTYP          OTHERWISE SHOULD ALREADY BE THERE            
         L     RF,ADESC                                                         
         CLI   0(RF),X'FA'         IF PREV BILLED UNITS                         
         BE    *+8                 DIDN'T  ADD ANYTHING TO CTYPTAB              
         MVI   ONENTRY,C'Y'        CTYPTAB'LL HAVE JUST 1 ENTRY                 
LPRD14   MVI   NETNUMOD,C'W'       MARK UNIT RECORDS NOW                        
         L     R7,BRKCODE                                                       
         L     R7,ATOTS(R7)        POINT TO ACCUMULATOR FOR THIS LEVEL          
         GOTOR NETNU,DMCB,(R7)                                                  
*                                                                               
LPRDX    DS    0H                                                               
         J     XIT                                                              
         EJECT                                                                  
*        LAST FOR ESTIMATE                                                      
         SPACE 2                                                                
LEST     NTR1                                                                   
*                                                                               
         BRAS  RE,BILCALC                                                       
         CLI   ESTCTL,C'N'                                                      
         BE    LESTX                                                            
         C     R3,ALOWTOG          IS THIS LOWEST TOGETHER                      
         BE    LEST8               YES                                          
         BH    LESTX               BYPASS IF 'LOWER' (ON RECAPS)                
*                                  ESTIMATE IS NOT LOWEST                       
         MVC   P+2(15),=C'ESTIMATE TOTALS'                                      
         CLI   PRDMKT,C'M'                                                      
         BE    *+16                                                             
         MVC   P(2),=C'**'                                                      
         MVC   P+17(2),=C'**'                                                   
*                                                                               
LEST8    DS    0H                                                               
         MVC   TOTNAME,=CL12'ESTIMATE'                                          
         BRAS  RE,TOTOUT                                                        
*                                                                               
         MVI   SUMLEV,C'E'         CORP DATA SAVED AT ESTIMATE LEVEL            
         BRAS  RE,PRTADJ           PRINT ADJUSTMENTS                            
*                                                                               
         CLI   NCOMOPT,C'E'        PRINT ESTIMATE COMMENTS?                     
         BNE   LESTX                                                            
         MVI   ECOMSW,C'Y'                                                      
         BRAS  RE,NCPROC                                                        
*                                                                               
LESTX    DS    0H                                                               
         J     XIT                                                              
         EJECT                                                                  
*        LAST FOR MARKET GROUP                                                  
         SPACE 2                                                                
LMGR1    DS    0H                                                               
LMGR2    DS    0H                                                               
LMGR3    DS    0H                                                               
         BR    RE                                                               
         SPACE 2                                                                
*        LAST FOR MARKET                                                        
         SPACE 2                                                                
LMKT     DS    0H                                                               
         BR    RE                                                               
         EJECT                                                                  
*        LAST FOR STATION                                                       
         SPACE 2                                                                
LSTA     NTR1                                                                   
*                                                                               
         CLI   STACTL,C'N'         NO STATION ON BILL                           
         BE    LSTAX                                                            
         CLI   SPOTCTL,C'Y'        IF SHOWING SPOT DETAILS                      
         BNE   *+12                THEN                                         
         CLI   STAACTSW,C'Y'       STATION ACTIVE?                              
         BNE   LSTAX                                                            
         L     R4,ADESC                                                         
         CLI   0(R4),X'FC'         SKIP FOR PREVIOUS MANUAL                     
         BE    LSTAX                                                            
         C     R3,ALOWTOG                                                       
         BH    LSTAX               BYPASS IF 'LOWER' (ON RECAPS)                
         BL    LSTA8                                                            
         CLI   PERCTL,C'T'                                                      
         BE    LSTA4                                                            
*                                  NOTE - CHANGES DUE TO SPOT FORMATS           
*                                  SINGLE MONTH                                 
         LA    R5,P+22                                                          
         CLI   FORMAT,5                                                         
         BH    *+8                                                              
         LA    R5,P+3                                                           
         CLI   SPOTCTL,C'Y'                                                     
         BNE   *+8                                                              
         LA    R5,P+6                                                           
         B     LSTA6                                                            
*                                                                               
LSTA4    DS    0H                  MULTI-MONTH                                  
         LA    R5,P+6                                                           
         CLI   SPOTCTL,C'Y'                                                     
         BE    LSTA6                                                            
         CLI   FORMAT,5                                                         
         BNL   *+8                                                              
         LA    R5,P+2                                                           
*                                                                               
LSTA6    DS    0H                                                               
         LR    RF,R5                                                            
         SHI   RF,2                                                             
         CLC   0(8,RF),SPACES      SEE IF CAN PRINT ON SAME LINE                
         BNE   *+14                NO                                           
         CLC   P2,SPACES                                                        
         BE    *+8                                                              
         BRAS  RE,PRNT                                                          
*                                                                               
         L     R4,ASTA                                                          
         CLC   XXSTA,0(R4)         FOR MANUAL BILLING                           
         BNE   LSTA7A                                                           
         CLI   FORMAT,10           FOR 'ORDERED ONLY' FORMATS                   
         BH    LSTAX               SKIP PREVIOUS BILL MARKET                    
         CLI   PRDMKT,C'M'         IF MARKET HIGHER THAN PRODUCT                
         BNE   LSTA7B                                                           
         MVI   0(R5),C'.'          FORCE PRINTING                               
         B     LSTA7B                                                           
*                                                                               
LSTA7A   DS    0H                                                               
         MVC   0(9,R5),BIGSTA                                                   
         CLI   STANAME,C' '        STATION NAME                                 
         BNH   *+10                                                             
         MVC   10(20,R5),STANAME                                                
*                                                                               
LSTA7B   DS    0H                                                               
         MVC   TOTNAME,=CL12'STATION'                                           
         CLI   QMED,C'N'                                                        
         BNE   *+10                                                             
         MVC   TOTNAME,=CL12'NETWORK'                                           
         BRAS  RE,TOTOUT                                                        
         B     LSTAX                                                            
*                                  STATION NOT LOWEST TOG (SPOT DETS)           
LSTA8    DS    0H                                                               
         BRAS  RE,PRNT             SKIP A LINE IF MULTI-MONTH                   
         XC    WORK,WORK                                                        
         MVC   WORK+1(9),BIGSTA                                                 
         LA    RF,WORK+10                                                       
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         MVC   2(6,RF),=C'TOTALS'                                               
         MVI   7(RF),C'*'                                                       
         MVI   WORK,C'*'                                                        
*                                                                               
         LA    R0,WORK-7                                                        
         SR    RF,R0               RF HAS LENGTH - 1                            
         LA    RE,P+17                                                          
         SR    RE,RF               RE HAS 'TO ADDRESS' FOR MOVE                 
         CLI   FORMAT,1            FOR FORMAT 1                                 
         BNE   *+8                                                              
         LA    RE,P+1              JUST MOVE TO P+1                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RE),WORK                                                     
         B     LSTA7B                                                           
*                                                                               
LSTAX    DS    0H                                                               
         MVI   STAACTSW,C'N'       SET OFF ACTIVITY SWITCH                      
         J     XIT                                                              
         EJECT                                                                  
*        LAST FOR PERIOD                                                        
         SPACE 2                                                                
LPER     DS    0H                  LAST FOR PERIOD                              
LPERG    DS    0H                  LAST FOR PERIOD GROUP                        
         CLI   PASSNO,2            IF PASS 2 (DETAIL BACK-UP)                   
         BNER  RE                                                               
         C     R3,AINVBRK          AND INVOICE BREAK                            
         BNER  RE                                                               
         B     LPER04                                                           
         SPACE 2                                                                
LCTYP    DS    0H                  LAST FOR COST TYPE                           
         CLI   PASSNO,2            IF PASS 2 (DETAIL BACK-UP)                   
         BNE   LCTYP10                                                          
         C     R3,AINVBRK          AND INVOICE BREAK                            
         BE    LPER04                                                           
         CLI   SPOTCTL,C'Y'        SHOWING UNIT DETAILS?                        
         BNER  RE                  NO, DON'T USE CTYPTAB                        
LCTYP10  CLI   ONENTRY,C'Y'        WAS TABLE ALREADY FILLED WHEN THE            
*                                  UNIT WAS WRITTEN OUT                         
         BNE   *+10                YES, DON'T FILL IN CTYPTAB                   
         MVI   ONENTRY,C'N'                                                     
         BR    RE                                                               
         LR    R1,RE                                                            
         BAS   RE,PSTCTYP          PUT THIS CTYP INFO IN CTYPTAB                
         LR    RE,R1                                                            
         BR    RE                                                               
*                                                                               
LDPT     NTR1                      LAST FOR DAYPART                             
******   C     R3,AINVBRK          IF INVOICE BREAK                             
******   BNER  RE                  (PASS 1 OR 2)                                
         CLI   SPOTCTL,C'Y'                                                     
         BNE   LDPTX                                                            
         CLI   DPTACTSW,C'Y'                                                    
         BNE   LDPTX                                                            
*                                                                               
         L     RF,ADESC                                                         
         CLI   0(RF),X'FA'         SKIP FOR MANUALS                             
         BH    LDPTX                                                            
         BL    LDPT2                                                            
         CLI   ZUOPT,C'L'          SKIP FOR PREVIOUS BILLED UNITS               
         BE    LDPT2               UNLESS LUMPING                               
         CLI   ZUOPT,C'N'          OR IGNORING                                  
         BNE   LDPTX                                                            
*                                                                               
LDPT2    DS    0H                                                               
         LA    RF,P+22                                                          
         CLI   FORMAT,5                                                         
         BH    *+16                                                             
         LA    RF,P+5                                                           
         BE    *+8                                                              
         LA    RF,P+1              FOR FORMAT 1                                 
*                                                                               
         MVC   0(16,RF),=C'*DAYPART TOTALS*'                                    
         BRAS  RE,TOTOUT                                                        
*                                                                               
LDPTX    DS    0H                                                               
         MVI   DPTACTSW,C'N'       SET OFF ACTIVITY SWITCH                      
         J     XIT                                                              
*                                                                               
LPER04   DS    0H                  PRINT TOTALS                                 
         MVC   P(12),=C'** TOTALS **'                                           
         LR    R0,RE                                                            
         BRAS  RE,TOTOUT                                                        
         LR    RE,R0                                                            
         BR    RE                                                               
         SPACE 2                                                                
PSTCTYP  NTR1                      PUT CTYP, LCKL MKT/STA IF AVAILABLE          
*                                  AND $$ INTO CTYPTAB                          
*        CLI   CTYPCTL,C'S'        COST TYPES SEPARATE ?                        
*        BE    PSTCTX              YES, CANNOT DO FOLLOWING CODE                
         L     RF,ADESC                                                         
         CLI   0(RF),X'FA'         PREVIOUS BILLED UNIT?                        
         BE    PSTCTX              DON'T PUT IT IN MY TAB, NOT NEEDED           
         L     R2,=A(CTYPTAB)                                                   
         USING CTYPTABD,R2                                                      
         L     R6,ASORTDTA                                                      
         L     RF,ACTYP                                                         
PSTCT10  CLI   CTYPTYP,X'FF'       EMPTY ROW?                                   
         BE    PSTCT20             YES, PUT IN INFO                             
         CLC   CTYPTYP(CTYPBRK),0(RF)  NO, IS IT SAME CTYP AND MKT/STA?         
         BNE   PSTCT50             NO, NEXT ROW                                 
PSTCT20  MVC   CTYPTYP(CTYPBRK),0(RF)      PUT CTYP AND MKT/STA                 
         AP    CTYPOG,0(ACCUMLQ,R6)        ORDERED  GROSS                       
         AP    CTYPON,ACCUMLQ(ACCUMLQ,R6)           NET                         
         AP    CTYPOG2,ACCUMLQ*2(ACCUMLQ,R6)        GROSS2                      
         AP    CTYPOS,ROW$L(ACCUMLQ,R6)             SPOTS                       
         AP    CTYPBG,ROWHL(ACCUMLQ,R6)    BILLED   GROSS                       
         AP    CTYPBN,ROWHL+ACCUMLQ(ACCUMLQ,R6)     NET                         
         AP    CTYPBG2,ROWHL+ACCUMLQ*2(ACCUMLQ,R6)  GROSS2                      
         AP    CTYPBS,ROWHL+ROW$L(ACCUMLQ,R6)       SPOTS                       
         LA    R2,CTYPTBL(R2)      NEXT ROW                                     
         OC    CTYPORD(ROWTL),CTYPORD     ANYTHING IN AMOUNTS ?                 
         BNZ   PSTCTX              YES, DON'T CLEAR IT                          
         MVI   CTYPTYP,X'FF'       MARK EOT                                     
         LA    R1,CTYPOG                                                        
         LA    RF,ROWTL(R1)                                                     
         BRAS  RE,ZAPSTR           INITIALIZE PACKED FIELDS                     
         B     PSTCTX                                                           
PSTCT50  LA    R2,CTYPTBL(R2)      NEXT ROW                                     
         B     PSTCT10                                                          
PSTCTX   XIT1                                                                   
         SPACE 2                                                                
LPGM     NTR1                                                                   
*                                                                               
         CLI   SPOTCTL,C'Y'                                                     
         BNE   LPGMX                                                            
         CLI   PROGSW,C'P'                                                      
         BNE   LPGMX                                                            
         CLI   PGMACTSW,C'Y'                                                    
         BNE   LPGMX                                                            
*                                                                               
         MVC   TOTNAME,=CL12'PROGRAM'                                           
         LA    RF,P+22                                                          
         CLI   FORMAT,5                                                         
         BH    *+16                                                             
         LA    RF,P+5                                                           
         BE    *+8                                                              
         LA    RF,P+1                                                           
*                                                                               
         MVC   0(16,RF),=C'*PROGRAM TOTALS*'                                    
         BRAS  RE,TOTOUT                                                        
*                                                                               
LPGMX    DS    0H                                                               
         MVI   PGMACTSW,C'N'       SET OFF ACTIVTY SWITCH                       
*                                                                               
         J     XIT                                                              
         EJECT                                                                  
***********************************************************************         
*        LDESC - LAST FOR UNIT DESCRIPTION                                      
***********************************************************************         
         SPACE 1                                                                
LDESC    NTR1                                                                   
*                                                                               
         CLI   PASSNO,1            IF PASS 1                                    
         BNE   LDESC4                                                           
*                                                                               
         L     RF,ADESC                                                         
         CLI   0(RF),X'FA'         MANUAL RECORD?                               
         BNH   LDESC2                                                           
         GOTOR WNBILL,DMCB,2                                                    
         L     R1,=A(CTYPTAB)                                                   
         CLI   0(R1),X'FF'         ANYTHING IN TABLE ?                          
         BNE   *+12                YES, CHECK IF NEED TO CLEAR CTYPTAB          
         MVI   ONENTRY,C'Y'        FLAG TO LCTYP NOT TO PUT IN CTYPTAB          
         B     LDESC4                                                           
*                                                                               
         CLI   SPOTCTL,C'Y'        DO WE WANT SPOT DETAILS?                     
         BE    LDESC4                                                           
*                                  TIME TO CLEAR CTYPTAB                        
         L     RE,=A(CTYPTAB)      CLEAR CHARGE TYPE TABLE                      
         LHI   RF,CTYPTMAX*CTYPTBL                                              
         XCEF                                                                   
         L     R1,=A(CTYPTAB)      INIT 1ST ROW TO PACKED                       
         MVI   0(R1),X'FF'                                                      
         LA    R1,CTYPBRK(R1)      POINT TO $$                                  
         LA    RF,ROWTL(R1)        POINT PAST $$                                
         BRAS  RE,ZAPSTR                                                        
         B     LDESC4                                                           
*                                                                               
LDESC2   DS    0H                                                               
         CLI   PRDCTL,C'N'         IF PRODUCTS LUMPED                           
         BE    LDESC4              UNITS WERE WRITTEN AT LPRD                   
*****    CLI   CTYPCTL,C'S'        IF SEP INVOICE PER CTYPE                     
*****    BNE   *+8                 ADD ENTRY TO CTYPTAB HERE                    
*****    BAS   RE,PSTCTYP          OTHERWISE SHOULD ALREADY BE THERE            
         L     R1,=A(CTYPTAB)                                                   
         CLI   0(R1),X'FF'         ANYTHING IN TABLE ?                          
         BNE   LDESC3                                                           
         BAS   RE,PSTCTYP          OTHERWISE SHOULD ALREADY BE THERE            
         L     RF,ADESC                                                         
         CLI   0(RF),X'FA'         IF PREV BILLED UNITS                         
         BE    *+8                 DIDN'T  ADD ANYTHING TO CTYPTAB              
         MVI   ONENTRY,C'Y'        CTYPTAB'LL HAVE JUST 1 ENTRY                 
LDESC3   MVI   NETNUMOD,C'W'       ELSE MARK UNIT RECORDS NOW                   
         L     R7,BRKCODE                                                       
         L     R7,ATOTS(R7)        POINT TO ACCUMULATOR FOR THIS LEVEL          
         GOTOR NETNU,DMCB,(R7)                                                  
*                                                                               
LDESC4   DS    0H                                                               
         CLI   SPOTCTL,C'Y'                                                     
         BNE   LDESCX                                                           
*                                                                               
         L     RF,ADESC                                                         
         CLI   0(RF),X'FA'         SKIP PREVIOUS UNITS                          
         BNE   LDESC4B                                                          
         CLI   ZUOPT,C'L'          UNLESS LUMPING                               
         BE    LDESC4B                                                          
*                                                                               
         LA    RF,P+5              FOR FORMAT 5+                                
         CLI   FORMAT,5                                                         
         BNL   *+8                                                              
         LA    RF,P+1              FOR FORMAT 1                                 
*                                                                               
         CLC   0(L'BIGSTA,RF),BIGSTA      HOKEY ATTEMPT TO PREVENT              
         BNE   *+10                       PRINTING OF NETWORK CODE WHEN         
         MVC   0(40,RF),SPACES            THERE IS NO DETAIL FOR IT             
*                                                                               
         CLC   P(20),SPACES        BUT PRINT ANY RESIDUE                        
         BE    *+8                 WHAT COULD IT BE???                          
         BRAS  RE,PRNT                                                          
         B     LDESCX                                                           
*                                                                               
LDESC4B  DS    0H                                                               
         CLI   0(RF),X'FB'         SKIP CURRENT MANUAL                          
         BE    LDESCX                                                           
*                                                                               
         CLI   0(RF),X'FC'         DON'T SET ON ACTIVITY SWS                    
         BE    LDESC4D             FOR PREVIOUS MANUAL                          
*                                                                               
         MVI   STAACTSW,C'Y'       SET ON ACTIVITY SWITCHES                     
         MVI   PKGACTSW,C'Y'                                                    
         MVI   DPTACTSW,C'Y'                                                    
         CLI   0(RF),X'FA'         FOR PREVIOUS BILLED LUMP                     
         BE    *+8                 DON'T SET PGM ACTIVE                         
         MVI   PGMACTSW,C'Y'                                                    
*                                                                               
LDESC4D  DS    0H                                                               
         CLI   FORMAT,5            FOR LONG FORMATS                             
         BH    LDESC5                                                           
         LA    R7,P+4              PROG+ DATE/TIME GO IN STUB                   
         BE    *+8                                                              
         LA    R7,P+1              TO LEFT FOR FORMAT 1                         
         CLC   P(20),SPACES        NEED NEW LINE?                               
         BE    LDESC6                                                           
         BRAS  RE,PRNT                                                          
         B     LDESC6                                                           
*                                                                               
LDESC5   DS    0H                                                               
         LA    R7,P+21             PLACE FOR PROG                               
         LA    R4,16(R7)           PLACE FOR DATE/TIME                          
         CLI   FORMAT,8                                                         
         BE    LDESC7                                                           
         CLI   FORMAT,11                                                        
         BE    LDESC7                                                           
         CLI   FORMAT,12                                                        
         BE    LDESC7                                                           
         CLI   FORMAT,14                                                        
         BE    LDESC6                                                           
*                                                                               
         CLI   CTYPCTL,C'T'        IF T/I TOGETHER                              
         BNE   LDESC7                                                           
*                                                                               
LDESC6   DS    0H                                                               
         LA    R4,132-2(R7)        DATE/TIME ON NEXT LINE                       
         CLI   FORMAT,1            FOR FORMAT 1                                 
         BNE   *+8                                                              
         LA    R4,1(R4)            INDENT 1                                     
*                                                                               
LDESC7   DS    0H                                                               
         CLI   STANAME,C' '        IF DOING NETWORK NAME (BUT                   
         BNH   LDESC70             MAY BE OK TO DO ALL THE TIME)                
         LR    RF,R7               SEE IF PREVIOUS LINE NEEDS CLEARING          
         SHI   RF,2                                                             
         CLC   0(5,RF),SPACES      5 SPACES SHOULD BE ABOUT RIGHT               
         BE    LDESC70                                                          
         BRAS  RE,PRNT             PRINT PREVOUS LINE                           
*                                                                               
LDESC70  DS    0H                                                               
         MVC   1(16,R7),SPACES                                                  
         L     R5,ADESC                                                         
         CLI   0(R5),X'F9'                                                      
         BH    LDESC7B                                                          
         L     R5,APGM                                                          
         MVC   1(16,R7),0(R5)                                                   
         L     R5,ADESC                                                         
         GOTO1 DATCON,DMCB,(2,0(R5)),(7,3(R4))                                  
         EDIT  (B1,2(R5)),(3,11(R4))                                            
         CLI   PROFBN+14,C'Y'      SHOW UNIT STATUS?                            
         BNE   LDESC7A                                                          
*                                                                               
         TM    3(R5),X'40'         PREEMPT                                      
         BZ    *+14                                                             
         MVC   8(3,R4),=C'-PR'                                                  
         B     LDESC7A                                                          
         TM    3(R5),X'02'         MISSED                                       
         BZ    *+14                                                             
         MVC   8(3,R4),=C'-MS'                                                  
         B     LDESC7A                                                          
         TM    3(R5),X'01'         MAKEGOOD                                     
         BZ    *+14                                                             
         MVC   8(3,R4),=C'-MG'                                                  
         B     LDESC7A                                                          
         TM    3(R5),X'04'         BONUS (PFB)                                  
         BZ    *+14                                                             
         MVC   8(3,R4),=C'-BN'                                                  
         B     LDESC7A                                                          
*                                                                               
LDESC7A  DS    0H                                                               
         B     LDESC8                                                           
*                                                                               
LDESC7B  DS    0H                                                               
         LA    R6,264+1(R7)        SET PLACE FOR MONTH                          
         CLI   0(R5),X'FA'                                                      
         BNE   LDESC7C                                                          
         MVC   1(10,R7),=C'PREVIOUSLY'                                          
         MVC   132+1(12,R7),=C'BILLED UNITS'                                    
         CLI   PGMACTSW,C'Y'       ENOUGH IF HAVE HAD                           
         BE    LDESC8              TRUE UNIT LINES FOR THIS PROGRAM             
         CLI   PROGSW,C'P'         OR IF NOT IN PROG ORDER                      
         BNE   LDESC8                                                           
*                                                                               
         L     RF,APGM             ELSE SHOW PROG NAME                          
         MVC   1(16,R7),0(RF)                                                   
         MVC   132+1(12,R7),=C'-PREVIOUSLY '                                    
         MVC   264+2(12,R7),=C'BILLED UNITS'                                    
         LA    R6,396+1(R7)        SET PLACE FOR MONTH                          
         B     LDESC8                                                           
*                                                                               
LDESC7C  DS    0H                                                               
         CLI   0(R5),X'FB'         CURRENT MANUAL                               
         BE    LDESCX                                                           
*                                                                               
         CLI   0(R5),X'FC'                                                      
         BNE   LDESC8                                                           
         MVC   1(14,R7),=C'PREV. ONE-LINE'                                      
         MVC   132+1(7,R7),=C'BILLING'                                          
         MVI   264+1(R7),0                                                      
         LA    R6,264+1(R7)        SET PLACE FOR MONTH                          
*                                                                               
LDESC8   DS    0H                                                               
         BRAS  RE,TOTOUT                                                        
*                                                                               
LDESCX   DS    0H                                                               
         J     XIT                                                              
         EJECT                                                                  
LPKG     NTR1                                                                   
*                                                                               
         CLI   SPOTCTL,C'Y'                                                     
         BNE   LPKGX                                                            
         CLI   PKGACTSW,C'Y'                                                    
         BNE   LPKGX                                                            
*                                                                               
         L     RF,ADESC                                                         
         CLI   0(RF),X'FA'         SKIP FOR MANUALS                             
         BH    LPKGX                                                            
         BL    LPKG2                                                            
         CLI   ZUOPT,C'L'          SKIP FOR PREVIOUS BILLED UNITS               
         BE    LPKG2               UNLESS LUMPING                               
         CLI   ZUOPT,C'N'          OR IGNORING                                  
         BNE   LPKGX                                                            
*                                                                               
LPKG2    DS    0H                                                               
         LA    RF,P+22                                                          
         CLI   FORMAT,5                                                         
         BH    *+16                                                             
         LA    RF,P+5                                                           
         BE    *+8                                                              
         LA    RF,P+1              FOR FORMAT 1                                 
*                                                                               
         MVC   0(16,RF),=C'*PACKAGE TOTALS*'                                    
         BRAS  RE,TOTOUT                                                        
*                                                                               
LPKGX    DS    0H                                                               
         MVI   PKGACTSW,C'N'       SET OFF ACTIVITY SWITCH                      
         J     XIT                                                              
         EJECT                                                                  
*        ULINE IN FIRST BLANK LINE                                              
ULINE    NTR1                                                                   
*                                  FIND FIRST BLANK LINE                        
         LA    R3,P                                                             
         SR    RE,RE                                                            
UL2      DS    0H                                                               
         OC    0(40,R3),SPACES                                                  
         CLC   0(40,R3),SPACES                                                  
         BE    *+16                                                             
         LA    R3,132(R3)                                                       
         AHI   RE,1                                                             
         B     UL2                                                              
*                                                                               
         LTR   RE,RE                                                            
         BNP   ULX                                                              
*                                                                               
         LA    RF,P+40                                                          
UL5      DS    0H                                                               
         LR    R1,RF                                                            
         LR    R0,RE                                                            
UL6      DS    0H                                                               
         CLI   0(R1),C' '                                                       
         BH    UL8                 FIRST NON-BLANK CHAR                         
         LA    R1,132(R1)                                                       
         BCT   R0,UL6                                                           
*                                                                               
         BCT   RF,UL5                                                           
*                                                                               
UL8      DS    0H                                                               
         LA    R0,P                                                             
         SR    RF,R0                                                            
         BM    ULX                                                              
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R3),DASHES                                                   
*                                                                               
ULX      DS    0H                                                               
         J     XIT                                                              
         SPACE 2                                                                
         DROP  RB,R9                                                            
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
FNDPKG   NMOD1 0,FNDPKG                                                         
         LA    RC,SPACEND                                                       
*                                                                               
         SR    R1,R1                                                            
         ICM   R1,1,PKGNMOPT       PACKAGE NAME  OPTION                         
         BZ    FP3                                                              
         MVC   PKGNME,SPACES                                                    
         L     RF,APKG             A(PKG NAME) - UP TO 5 CHARS                  
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   PKGNME(0),0(RF)                                                  
         B     FP4                                                              
*                                                                               
FP3      DS    0H                                                               
         MVC   PKGNME(16),SPACES                                                
         OC    PKGTABN,PKGTABN     WAS PACKAGE TABLE EVER BUILT?                
         BZ    FP4                 NO                                           
PKG      USING PKGTABD,WORK                                                     
         L     RF,AEST             ESTIMATE                                     
         XC    WORK,WORK                                                        
         MVC   PKG.PKGEST,0(RF)                                                 
         L     RF,APKG             PKG NO.                                      
         MVC   PKG.PKGPKG,0(RF)                                                 
         L     RF,ASTA             NETWORK                                      
         MVC   PKG.PKGNET,0(RF)                                                 
         DROP  PKG                                                              
*                                                                               
         LA    RE,*+10             SWITCH TO 31-BIT MODE                        
         O     RE,=X'80000000'                                                  
         BSM   0,RE                                                             
*                                                                               
         GOTO1 BINSR31,PKGPARS,WORK                                             
         TM    0(R1),X'80'         RECORD FOUND?                                
         BZ    *+6                                                              
         DC    H'0'                NO                                           
         L     RF,0(R1)                                                         
         MVC   PKGNME(16),(PKGPKGNM-PKGTABD)(RF)                                
*                                                                               
         LA    RE,*+6              SWITCH BACK TO 24-BIT MODE                   
         BSM   0,RE                                                             
*                                                                               
FP4      DS    0H                                                               
         J     XIT                                                              
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
*                                  ROLLUP - ADD TO NEXT ACCUMULATOR             
         SPACE 2                                                                
ROLLUP   NMOD1 0,ROLLUP                                                         
         LA    RC,SPACEND                                                       
*                                                                               
         L     RF,BRKCODE                                                       
         L     R4,ATOTS(RF)                                                     
         LHI   R5,MAXMOS+1                                                      
*                                                                               
RU2      DS    0H                                                               
         LR    RF,R4                                                            
         LA    RE,ROWL(R4)         POINT PAST ACCUMULATOR                       
RU2A     CP    0(ACCUMLQ,RF),=P'0' CHECK FOR ANY $ IN ACCUMULATORS              
         BNE   RU2B                                                             
         LA    RF,ACCUMLQ(RF)      NEXT ACCUMULATOR                             
         CR    RF,RE                                                            
         BL    RU2A                                                             
         B     RU6                                                              
*                                                                               
RU2B     LR    R6,R4               R6 POINTS TO NEXT ACCUMULATOR                
         AHI   R6,TOTSIZE                                                       
*                                                                               
         LHI   R0,ROWL/ACCUMLQ     NUMBER OF ACCUMULATORS                       
         LR    RE,R4                                                            
RU4      DS    0H                                                               
         AP    0(ACCUMLQ,R6),0(ACCUMLQ,R4)                                      
         LA    R4,ACCUMLQ(R4)                                                   
         LA    R6,ACCUMLQ(R6)                                                   
         BCT   R0,RU4                                                           
*                                                                               
         LR    R1,RE                                                            
         LA    RF,ROWL(R1)         POINT PAST ACCUMS FOR THIS LEVEL             
*                                                                               
         BRAS  RE,ZAPSTR           ZAP ACCUMULATORS                             
         B     RU8                                                              
*                                                                               
RU6      LA    R4,ROWL(R4)                                                      
*                                                                               
RU8      BCT   R5,RU2                                                           
*                                                                               
         L     RF,BRKCODE                                                       
         L     R4,ATOTS(RF)        POINT TO ACCUMULATOR                         
         AHI   R4,TOTSIZE-BFORML   POINT TO FORMULA INFO                        
         USING BFORMD,R4                                                        
*                                                                               
         LR    R6,R4                                                            
         AHI   R6,TOTSIZE          R6 POINTS TO NEXT ACCUMULATOR                
NEXTACC  USING BFORMD,R6                                                        
*                                  ROLL UP BILL FORMULA                         
         OC    NEXTACC.BFORMD(BFORML),NEXTACC.BFORMD                            
         BNZ   *+14                                                             
         MVC   NEXTACC.BFBAS(BFORML),BFBAS                                      
         B     RU16                                                             
         CLC   BFBAS,NEXTACC.BFBAS                                              
         BE    *+8                                                              
         MVI   NEXTACC.BFBAS,X'FF' UNEQUAL BASES                                
         CLC   BFCOMP,NEXTACC.BFCOMP                                            
         BE    *+10                                                             
         MVC   NEXTACC.BFCOMP,FFS  UNEQUAL COMMISSIONS                          
* DEIS POSTULATES THAT WITHOUT RETAIL, THESE FIELDS MUST ALWAYS BE ZERO         
         CLC   BFRETSHR,NEXTACC.BFRETSHR                                        
         BE    *+6                                                              
         DC    H'0'                                                             
         OC    BFRETSHR,BFRETSHR                                                
         BZ    *+6                                                              
         DC    H'0'                                                             
         CLC   BFAORPCT,NEXTACC.BFAORPCT                                        
         BE    *+10                                                             
         MVC   NEXTACC.BFAORPCT,FFS        UNEQUAL AOR PCTS                     
         DROP  NEXTACC                                                          
*                                                                               
RU16     DS    0H                                                               
         XC    BFBAS(BFORML),BFBAS                                              
         DROP  R4                                                               
*                                                                               
         J     XIT                                                              
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
*                                  GETAOR - GET AOR INFO                        
         SPACE 2                                                                
GETAOR   NMOD1 0,GETAOR                                                         
         LA    RC,SPACEND                                                       
*                                                                               
         XC    SVAORS(SVAORSLQ),SVAORS                                          
         MVC   AORADRS(132),SPACES                                              
         MVC   AORADRS+132(L'AORADRS-132),SPACES                                
*                                                                               
         CLI   AORSW,C'Y'          DO WE NEED AOR?                              
         BNE   GETAORX                                                          
*                                                                               
         LA    R6,KEY                                                           
         USING AORKEY,R6                                                        
         XC    KEY,KEY                                                          
         MVC   AORKTYP,=X'0D45'    AOR RECORD CODE                              
         L     RF,ADCLT                                                         
         MVC   AORKAGMD,1(RF)      AGY/MEDIA                                    
         MVC   AORKCLT,2(RF)       CLIENT                                       
*                                                                               
         L     R4,APRD                                                          
*        ZIC   R4,0(RF)            GET PRODUCT CODE FROM PRODUCT SEQ            
*        MHI   R4,4                                                             
*        L     RF,VCLIST                                                        
*        LA    R4,0(RF,R4)                                                      
         MVC   AORKPRD,0(R4)       3-CHAR PRODUCT CODE                          
         L     RF,AEST                                                          
         MVC   AORKEST+1(1),0(RF)  ESTIMATE NUMBER                              
*                                                                               
         MVI   AORKDPT,X'FF'       DEFAULT DAYPART                              
*                                                                               
         LA    RE,DPTFILT          USE DAYPART FILTER IF PRESENT                
         CLI   DPTFILT,C' '                                                     
         BH    GAKS05                                                           
         CLI   DPTSEP,C'T'                                                      
         BE    *+18                                                             
         ICM   RE,15,ADPT          OR USE DPT FOR BILL IF DPT SEPARATE          
         BZ    *+10                                                             
GAKS05   MVC   AORKDPT,0(RE)                                                    
*                                                                               
         MVI   AORKSTYP,X'FF'      DEFAULT STATION TYPE                         
         MVC   AORKSTYP,MEDFILT    SET SUB-MEDIA FILTER                         
         MVI   AORKEXT+2,X'FF'     3RD EXTRA NOT USED                           
         DROP  R6                                                               
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
KEY@     USING AORKEY,KEY                                                       
KS       USING AORKEY,KEYSAVE                                                   
*                                                                               
         CLC   KEY(8),KEYSAVE      KEY MATCHES THRU PRODUCT                     
         BNE   GAKS21              NOTHING FOR PRODUCT                          
         CLC   KEY(10),KEYSAVE     KEY MATCHES THRU ESTIMATE                    
         BE    GAKS08                                                           
         CLC   KEY@.AORKEST,=X'FFFF'  DID WE FIND DEFAULT?                      
         BE    GAKS08              YES, USE IT                                  
*                                                                               
GAKS07   DS    0H                                                               
         MVC   KS.AORKEST,=X'FFFF' TRY DEFAULT ESTIMATE                         
         MVC   KEY,KEYSAVE                                                      
         GOTO1 HIGH                                                             
         CLC   KEY(10),KEYSAVE                                                  
         BNE   GAKS21              NOTHING THERE EITHER                         
*                                                                               
GAKS08   DS    0H                                                               
         CLC   KEY@.AORKDPT,KS.AORKDPT  DAYPART                                 
         BE    GAKS10                                                           
         CLI   KEY@.AORKDPT,X'FF'  DID WE FIND DEFAULT?                         
         BE    GAKS10                                                           
         CLI   KS.AORKDPT,X'FF'    DID WE TRY FOR IT?                           
         BE    GAKS19              YES, TRY UNDER DEFAULT ESTIMATE              
*                                                                               
GAKS09   DS    0H                                                               
         MVI   KS.AORKDPT,X'FF'    TRY DEFAULT DAYPART                          
         MVC   KEY,KEYSAVE                                                      
         GOTO1 HIGH                                                             
         CLC   KEY(11),KEYSAVE                                                  
         BNE   GAKS19              NOTHING, DONE                                
*                                                                               
GAKS10   DS    0H                                                               
         CLC   KEY@.AORKSTYP,KS.AORKSTYP   STATION TYPE                         
         BE    GAKS20                                                           
         CLI   KEY@.AORKSTYP,X'FF' DID WE FIND DEFAULT?                         
         BE    GAKS20                                                           
         CLI   KS.AORKSTYP,X'FF'   DID WE TRY FOR IT?                           
         BE    GAKS18                                                           
         MVI   KS.AORKSTYP,X'FF'   TRY DEFAULT                                  
         MVC   KEY,KEYSAVE                                                      
         GOTO1 HIGH                                                             
         CLC   KEY(12),KEYSAVE                                                  
         BE    GAKS20                                                           
*                                                                               
GAKS18   DS    0H                  NOTHING FOUND                                
         CLI   KS.AORKDPT,X'FF'    WERE WE LOOKING UNDER ALL DAYPARTS           
         BE    GAKS19              YES                                          
*                                  NO, DO IT NOW                                
         MVI   KS.AORKSTYP,X'FF'   RESET STATION TYPE                           
         MVC   KS.AORKSTYP,MEDFILT SET SUB-MEDIA FILTER                         
         B     GAKS09                                                           
*                                                                               
GAKS19   DS    0H                                                               
         CLC   KS.AORKEST,=X'FFFF' WERE WE LOOKING UNDER ALL ESTIMATES?         
         BE    GAKS21              YES, NOTHING MORE TO DO                      
*                                  NO, DO IT NOW                                
         MVI   KS.AORKDPT,X'FF'    RESET DAYPART                                
*                                                                               
         LA    RE,DPTFILT          USE DAYPART FILTER IF PRESENT                
         CLI   DPTFILT,C' '                                                     
         BH    GAKS19C                                                          
         CLI   DPTSEP,C'T'                                                      
         BE    *+18                                                             
         ICM   RE,15,ADPT          OR USE DPT FOR BILL IF DPT SEPARATE          
         BZ    *+10                                                             
GAKS19C  MVC   KS.AORKDPT,0(RE)                                                 
*                                                                               
         MVI   KS.AORKSTYP,X'FF'   RESET STATION TYPE                           
         MVC   KS.AORKSTYP,MEDFILT SET SUB-MEDIA FILTER                         
         B     GAKS07                                                           
         DROP  KS                                                               
         DROP  KEY@                                                             
*                                                                               
GAKS20   DS    0H                  HAVE USEABLE AOR KEY                         
         B     GAO4                                                             
*                                                                               
GAKS21   DS    0H                  NO USEABLE AOR KEY                           
         B     GETAORX                                                          
*                                                                               
GAO4     DS    0H                                                               
         MVC   SVAORDA,KEY+14      SAVE DISK ADDRESS                            
         L     R7,=A(STABUCKC)     USE STATION BUCKET AREA                      
         ST    R7,AREC                                                          
*                                                                               
         USING AORREC,R7                                                        
         GOTO1 GET                                                              
*                                                                               
         LA    R2,AORELS                                                        
*                                                                               
GAO6     DS    0H                                                               
         CLI   0(R2),X'02'         ADDRESS ELEMENT                              
         BE    GAO7                                                             
         CLI   0(R2),X'03'         AOR INFO ELEMENT                             
         BE    GAO8                                                             
         CLI   0(R2),0             EOR                                          
         BE    GETAORX                                                          
*                                                                               
GAO6D    DS    0H                                                               
         ZIC   R0,1(R2)                                                         
         AR    R2,R0                                                            
         B     GAO6                                                             
*                                                                               
GAO7     DS    0H                  AOR ADDRESS ELEMENT                          
         USING AORADREL,R2                                                      
         MVC   AORADR1(L'AORLIN1),AORLIN1                                       
         MVC   AORADR2(L'AORLIN2),AORLIN2                                       
         MVC   AORADR3(L'AORLIN3),AORLIN3                                       
         MVC   AORADR4(L'AORLIN4),AORLIN4                                       
         DROP  R2                                                               
         B     GAO6D                                                            
*                                                                               
GAO8     DS    0H                  AOR INFO ELEMENT                             
         USING AORELEM,R2                                                       
         CLI   PROFB2A+4,C'Y'      IS 0% AOR OK?                                
         BE    *+14                                                             
         OC    AORPCT,AORPCT       YES, IS THERE ANY AOR %                      
         BZ    GETAORX             NO, REJECT                                   
*                                                                               
         MVC   SVAORPCT,AORPCT     PCT                                          
         MVC   SVAORBAS,AORBAS     BASIS                                        
*                                                                               
         MVC   SVAORACT,AORRCVBL   RCVBL/PAYABLE ACCT                           
         CLI   AORRCVBL,C' '       IF NO ACCOUNT PRESENT                        
         BH    *+10                USE AGENCY NAME                              
         MVC   SVAORACT,AORADR1    (1ST LINE OF ADDRESS - 14 CHARS)             
*                                                                               
         MVC   SVAOREFF,AOREFF     EFFECTIVE DATE                               
         MVC   SVAORKIL,AORKILL    KILL DATE                                    
         OC    SVAORKIL,SVAORKIL   IF NOT PRESENT                               
         BNZ   *+10                                                             
         MVC   SVAORKIL,=X'FFFF'   SET TO HIGH VALUES                           
         B     GAO6D                                                            
         DROP  R2                                                               
*                                                                               
GETAORX  DS    0H                                                               
         J     XIT                                                              
         DROP  R7                                                               
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
*                                  ENDINV - END OF INVOICE                      
         SPACE 2                                                                
ENDINV   NMOD1 0,ENDINV                                                         
         LA    RC,SPACEND                                                       
*                                                                               
         L     R7,BRKCODE                                                       
         L     R7,ATOTS(R7)        POINT TO ACCUMULATOR                         
         AHI   R7,MAXMOS*ROWL      POINT TO TOTAL ROW                           
         LA    RE,ADJDSP(R7)                                                    
         LA    RF,ACMEXTL(RE)      ADJ,DUE,GR2,AOR                              
EI2      CP    0(ACCUMLQ,RE),=P'0' FORMULA CALCS DONE?                          
         BNE   EI2A                                                             
         LA    RE,ACCUMLQ(RE)                                                   
         CR    RE,RF                                                            
         BL    EI2                                                              
         BRAS  RE,BILCALC          NO - DO THEM NOW                             
*                                                                               
EI2A     CLI   PASSNO,1            IF DOING RECAP NOW                           
         BNE   EI8                 SKIP TO ADJINV AND AORINV CALLS              
*                                                                               
         CLI   DUESW,C'Y'          AMOUNT DUE PRINTED?                          
         BE    EI6                                                              
         CLI   TOTSW,C'Y'          HAVE PRINTED INVOICE TOTALS?                 
         BE    EI5                                                              
         CLI   NDUES,1             BYPASS REPEAT OF TOTALS IF                   
         BE    EI5                 EXACTLY 1 DUE LEVEL PRINTED                  
         MVI   PRSW,C'H'           SET TO HOLD LINES                            
         MVC   P(12),=C'** TOTALS **'                                           
         BRAS  RE,TOTOUT                                                        
*                                                                               
EI5      DS    0H                                                               
*                                  NEED TO SAVE CORP DATA NOW?                  
         CLI   SUMLEV,C'I'                                                      
         BE    *+16                                                             
         CLI   SUMLEV,0                                                         
         BH    *+8                 ALREADY SAVED AT LOWER LEVEL                 
         MVI   SUMLEV,C'I'         CORP DATA SAVED AT INVOICE LEVEL             
         BRAS  RE,PRTADJ           INVOICE TOTALS NOT PRINTED- DO NOW           
*                                                                               
EI6      DS    0H                                                               
         CLI   NCOMOPT,C'N'        NETWORK COMMENTS ACTIVE?                     
         BE    *+12                NO- DO OLD SPOT COMMENTS                     
         CLI   QOPT3,C'O'          ALSO IF SPECIAL REQUEST OPTION               
         BNE   EI7                                                              
*                                                                               
*                                  **OLD SPOT COMMENTS**                        
         MVI   FORCECMT,C'I'       SET IMMEDIATE COMMENT PRINT                  
         XC    BCMTYPE(14),BCMTYPE                                              
         MVI   BCMTYPE,C'B'                                                     
         MVC   BCMCLT,BCLT                                                      
         CLI   PGR3CTL,C'S'        PGR'S SEPARATE?                              
         BNE   *+10                                                             
         MVC   BCMPGR,BPGR                                                      
         CLI   PRDCTL,C'S'         PRODUCTS SEPARATE?                           
         BNE   EI6D                                                             
         XC    BCMPRD,BCMPRD       SEE IF CAN GET 1 BYTE PRODUCT                
         L     R4,APRD                                                          
*        ZIC   R4,0(RF)            GET PRODUCT CODE FROM PRODUCT SEQ            
*        MHI   R4,4                                                             
         L     RF,VCLIST                                                        
         CLC   0(3,R4),0(RF)                                                    
         BE    *+20                                                             
         LA    RF,4(RF)                                                         
         CLI   0(RF),0                                                          
         BE    *+14                                                             
         B     *-22                                                             
*        LA    R4,0(RF,R4)                                                      
         MVC   BCMPRD,3(RF)                                                     
*                                                                               
EI6D     DS    0H                                                               
         CLI   ESTCTL,C'S'         ESTIMATES SEPARATE?                          
         BNE   *+14                                                             
         L     RF,AEST                                                          
         MVC   BCMEST,0(RF)                                                     
*                                                                               
         GOTO1 GETCOM                                                           
*                                                                               
         ST    RE,SAVBRK                                                        
         GOTO1 ABILLEDI,DMCB,('EDMCOM',0)                                       
*                                                                               
         CLC   P,SPACES            IF ANYTHNG NEEDS PRINTING                    
         BNE   *+18                                                             
         L     RF,ADCOMREC         OR IF HAVE COMMENT                           
         OC    0(2,RF),0(RF)                                                    
         BZ    EI7                                                              
*                                                                               
         MVI   PRSW,C'N'           PRINT NOW                                    
         BRAS  RE,PRNT                                                          
*                                                                               
EI7      DS    0H                                                               
         MVI   PUMODE,C'E'         USER FIELDS - END OF BILL                    
         BRAS  RE,PRTUSER                                                       
*                                                                               
         BRAS  RE,BILLBOX                                                       
         BRAS  RE,WOBILL           ADD OLD-STYLE BILL RECS                      
         GOTO1 ABILLEDI,DMCB,('EDMEND',0)    EDI CALL                           
         CLI   OUTMODE,C'W'        FOR WORKER FILE MODE                         
         BNE   EI6H5                                                            
         GOTO1 ABILLEDI,DMCB,('EDMCLS',0)  CLOSE EDI FOR EACH INVOICE           
*                                                                               
EI6H5    DS    0H                                                               
*                                  DO NETPAK COMMENTS NOW                       
         CLI   NCOMOPT,C'N'        NETWORK COMMENTS ACTIVE?                     
         BE    *+16                                                             
         CLI   QOPT3,C'O'          DO ONLY IF DIDNT DO OLD SPOT COMS            
         BE    *+8                                                              
         BRAS  RE,NCPROC                                                        
*                                                                               
         MVC   SINVNO,INVNO                                                     
         MVC   SPINVNO,PINVNO                                                   
         OC    ARECAP,ARECAP       FOR RECAP PASS                               
         BNZ   EI11                DON'T BUMP INVOICE NO                        
*                                                                               
EI8      DS    0H                                                               
         CLI   AORSW,C'Y'          AOR INVOICE                                  
         BNE   *+12                                                             
         MVI   AORLCTL,0                                                        
         BRAS  RE,AORINV                                                        
*                                                                               
         CLI   ADJSEP,C'Y'         SEPARATE ADJUSTMENT                          
         BNE   *+16                                                             
         BRAS  RE,ADJINV                                                        
         BNE   *+8                 IF NO AJD, NO COMMENT                        
         BRAS  RE,NCPROC           NETPAK COMMENTS                              
*                                                                               
         GOTOR GETNUM,DMCB,INVNO,PINVNO    BUMP INVOICE #                       
*                                                                               
         CLI   AORLOPT,C'C'        UNLESS CLIENT LEVEL AOR                      
         BE    *+10                                                             
         XC    PEPTABN,PEPTABN     CLEAR PEPTAB                                 
*                                                                               
EI11     DS    0H                                                               
         XC    TRDTABN,TRDTABN     CLEAR TRADETAB                               
         XC    WTRDPCT,WTRDPCT     CLEAR TRADE % FOR SORT COMMENT               
         MVI   DUESW,C'N'                                                       
         MVI   TOTSW,C'N'                                                       
         MVI   SUMLEV,0                                                         
         MVI   ACTSW,C'Y'          SET ACTIVITY FOR REQUEST                     
         MVC   PAGE,=H'1'                                                       
         MVI   NDUES,0                                                          
         MVI   FORCEHED,C'Y'                                                    
         MVC   MKTCTL,SVMKTCTL                                                  
*                                                                               
         J     XIT                                                              
         SPACE 3                                                                
         LTORG                                                                  
         EJECT                                                                  
*                                  GET AND PRINT NETPAK COMMENTS                
NCPROC   NMOD1 0,NCPROC                                                         
         LA    RC,SPACEND                                                       
*                                                                               
         CLI   NCOMOPT,C'N'        NETWORK COMMENTS ACTIVE?                     
         BE    NCPRX                                                            
         CLI   QOPT3,C'Y'          SUPPRESS COMMENTS?                           
         BE    NCPRX                                                            
*                                                                               
         CLI   NCOMOPT,C'E'        IF PRINTING ESTIMATE LEVEL COMMENTS          
         BNE   *+12                                                             
         CLI   ECOMSW,C'Y'         PRINT ONLY AT LEST (AND DON'T                
         BNE   NCPRX               PRINT AGAIN AT LINV)                         
*                                                                               
         LA    R6,WK                                                            
         USING NCOMBLKD,R6                                                      
         XC    WK,WK                                                            
         MVC   NCBAIO,ADCOMREC     IOA AREA                                     
         MVC   NCBNETB,=A(NETBLK)  NETBLOCK                                     
         MVC   NCBAHOOK,=A(NCHOOK2)  HOOK                                       
         MVI   NCBKDFL,C'Y'        SET TO DEFAULT TO HIGHER KEY                 
         MVI   NCBMULT,C'Y'        OK TO PASS MULTIPLE COMMENTS                 
         MVC   NCBID,=C'B*4'       B=T+I, 4=???                                 
         CLI   CTYPCTL,C'S'                                                     
         BNE   NCPR1                                                            
         L     RF,ACTYP                                                         
         MVI   NCBID,C'T'          TIME ONLY                                    
         CLI   0(RF),X'00'                                                      
         BE    NCPR1                                                            
         MVI   NCBID,C'I'          INTEGRATION ONLY                             
         CLI   0(RF),X'01'                                                      
         BE    NCPR1                                                            
         B     NCPRX               NO COMMENTS ON SPECIAL CHARGE BILLS          
*                                  AT PRESENT. SHOULD WE USE S-TYPES?           
NCPR1    DS    0H                                                               
         MVC   NCBAM,BAGYMD        AGY/MEDIA                                    
         MVC   NCBCLT,BCLT                                                      
*                                                                               
         CLC   APRDBRK,APAGBRK     IS PRODUCT IN HEADLINES                      
         BH    *+20                NO                                           
         L     RF,ADPRD                                                         
         MVC   NCBPRD,PCODE+1-PRDHDR(RF)                                        
         MVC   NCBPRD3,PKEYPRD-PRDHDR(RF)                                       
*                                                                               
         CLC   AESTBRK,APAGBRK     IS ESTIMATE IN HEADLINES                     
         BNH   *+12                                                             
         CLI   ECOMSW,C'Y'         ARE WE AT LEST                               
         BNE   *+14                NO                                           
         L     RF,ADEST                                                         
         MVC   NCBEST,EKEYEST-ESTHDR(RF)                                        
*                                                                               
         OC    ASTABRK,ASTABRK     IF NETWORK PRESENT                           
         BZ    *+20                                                             
         CLC   ASTABRK,APAGBRK     IS IT IN HEADLINES                           
         BH    *+10                NO                                           
         MVC   NCBNTWK,BIGSTA                                                   
*                                                                               
         OC    APKGBRK,APKGBRK     IF PACKAGE PRESENT                           
         BZ    NCPR2B                                                           
         CLC   APKGBRK,APAGBRK     IS IT IN HEADLINES                           
         BH    *+14                NO                                           
         L     RF,APKG                                                          
         MVC   NCBPKG,0(RF)                                                     
*                                                                               
NCPR2B   DS    0H                                                               
         GOTO1 =V(NETCOM),DMCB,NCOMBLKD                                         
         CLI   NCBERROR,0                                                       
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
NCPRX    DS    0H                                                               
         MVI   ECOMSW,C'N'         RESET SPECIAL EST/CMMT SWITCH                
         J     XIT                                                              
         EJECT                                                                  
*                                  PROCESSING ROUTINE FOR NETCOM                
NCHOOK2  NTR1                                                                   
*                                                                               
         L     R2,NCBAIO           IO AREA                                      
         LA    R2,27(R2)           FIRST ELEMENT                                
         SR    R1,R1               FIRST COUNT PRINT LINES                      
*                                                                               
NCHK2    DS    0H                                                               
         CLI   0(R2),0             EOR                                          
         BE    NCHK3                                                            
         CLI   0(R2),X'02'         COMMENT ELEMENT                              
         BNE   *+8                                                              
         AHI   R1,1                BUMP LINE COUNT                              
*                                                                               
         ZIC   R0,1(R2)                                                         
         AR    R2,R0                                                            
         B     NCHK2                                                            
*                                                                               
NCHK3    DS    0H                                                               
         LTR   R1,R1               ANY COMMENT LINES?                           
         BZ    NCPRX                                                            
         CLI   ECOMSW,C'Y'         UNLESS LEST COMMENT PRINT                    
         BE    *+8                                                              
         BRAS  RE,PRNT             SKIP A LINE                                  
*                                                                               
         STC   R1,ALLOWLIN         ONE PAGE                                     
*                                  NOW ACTUALLY PRINT                           
         L     R2,NCBAIO           IO AREA                                      
         LA    R2,27(R2)           FIRST ELEMENT                                
*                                                                               
NCHK4    DS    0H                                                               
         CLI   0(R2),0             EOR                                          
         BE    NCHK12                                                           
         CLI   0(R2),X'02'         COMMENT ELEMENT                              
         BE    NCHK6                                                            
*                                                                               
NCHK5    DS    0H                                                               
         ZIC   R0,1(R2)                                                         
         AR    R2,R0                                                            
         B     NCHK4                                                            
*                                                                               
NCHK6    DS    0H                                                               
         USING NCOMELEM,R2                                                      
         ZIC   RF,NCOMELEN         ELEMENT LENGTH...                            
         SHI   RF,NCOMETXT-NCOMELEM  ... MINUS OVERHEAD = L'COMMENT             
         BCTR  RF,0                FOR EX                                       
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   P(0),NCOMETXT                                                    
         DROP  R2                                                               
*                                                                               
         ST    R3,SAVBRK                                                        
         GOTO1 ABILLEDI,DMCB,('EDMNCM',P)   EDI CALL                            
*                                                                               
         BRAS  RE,PRNT                                                          
         B     NCHK5                                                            
*                                                                               
NCHK12   DS    0H                  DONE                                         
         CLI   ECOMSW,C'Y'         FOR LEST COMMENT PRINT                       
         BNE   *+16                                                             
         C     R3,AINVBRK          EXCEPT AT INVOICE END                        
         BE    *+8                                                              
         BRAS  RE,PRNT             SKIP A LINE AFTER COMMENT                    
*                                                                               
         B     NCPRX                                                            
         DROP  R6                                                               
         SPACE 3                                                                
         LTORG                                                                  
         EJECT                                                                  
*                   PRTUSER - PRINT USER FIELDS                                 
         SPACE 2                                                                
PRTUSER  NMOD1 PRTUSRQ,PUSER                                                    
         LR    R7,RC               R7 --> PRTUSRD                               
         USING PRTUSRD,R7                                                       
         LA    RC,SPACEND                                                       
*                                                                               
         MVI   HAVUSER,C'N'                                                     
*                                                                               
         MVI   MASPRDCD,0          RESET NUMERIC MASTER PRODUCT CODE            
*                                                                               
         MVI   BYTE,0                                                           
         CLI   PRDCTL,C'S'         SEE IF PRODUCTS SEPARATE                     
         BE    PU4                 YES, USE PRODUCT USER FIELD                  
*                                  ELSE                                         
         CLI   PGR1CTL,C'S'        IF DOING PRODUCT GROUPS                      
         BNE   *+16                                                             
         BAS   RE,PUGTMPRD         GET MASTER PRODUCT                           
         BNE   PU10                NON, SKIP                                    
         B     PU4                                                              
*                                                                               
*                                  NO PRODUCT GROUP                             
         BAS   RE,PUGTPOLP         GET POL PRODUCT HEADER                       
         BNE   PU10                NOT FOUND, SKIP                              
*                                                                               
PU4      DS    0H                                                               
         MVC   X(132),SPACES                                                    
         GOTO1 =V(GETUSER),DMCB,(C'S',ADCLT),(C'P',ADPRD),(C':',X+8),0          
         MVI   BYTE2,1             DO FIRST FILTERS                             
         BAS   RE,PUFILTER         SEE IF TO PRINT ON BILL                      
         BNE   PU6                                                              
         MVI   HAVUSER,C'Y'                                                     
         MVC   P1,SPACES                                                        
         BRAS  RE,PRNT             SKIP BEFORE                                  
         MVC   P1,X                                                             
         BRAS  RE,PRNT                                                          
         GOTO1 ABILLEDI,DMCB,('EDMUSR',=C'P1')    EDI CALL                      
         MVI   BYTE,1              SO I WON'T SKIP AGAIN                        
*                                                                               
PU6      DS    0H                                                               
         MVC   X(132),SPACES                                                    
         GOTO1 =V(GETUSER),DMCB,(C'S',ADCLT),(C'P',ADPRD),0,(C':',X+8)          
         MVI   BYTE2,2             DO SECOND FILTERS                            
         BAS   RE,PUFILTER         SEE IF TO PRINT ON BILL                      
         BNE   PU10                                                             
         MVI   HAVUSER,C'Y'                                                     
         CLI   BYTE,1                                                           
         BE    *+14                                                             
         MVC   P1,SPACES                                                        
         BRAS  RE,PRNT             SKIP BEFORE                                  
*                                                                               
         MVC   P1,X                                                             
         BRAS  RE,PRNT                                                          
*                                                                               
PU10     DS    0H                                                               
         GOTO1 ABILLEDI,DMCB,('EDMUSR',=C'P2')   EDI CALL                       
         MVI   BYTE,0                                                           
         MVC   P1,SPACES                                                        
         CLI   ESTCTL,C'S'         SEE IF ESTIMATES SEPARATE                    
         BNE   PU18                NO, DONE                                     
         CLI   PRDCTL,C'S'         YES, IF PRODUCT ALSO SEPARATE                
         BE    PU14                USE THIS PRODUCT/ESTIMATE                    
*                                  ELSE                                         
         CLI   PGR1CTL,C'S'        IF DOING PRODUCT GROUPS                      
         BNE   *+16                                                             
         BAS   RE,PUGTMEST         GET MASTER PRODUCT/ESTIMATE                  
         BNE   PU18                NON, SKIP                                    
         B     PU14                                                             
*                                                                               
*                                  NO PRODUCT GROUP                             
         BAS   RE,PUGTPOLE         GET POL/ESTIMATE HEADER                      
         BNE   PU18                NOT FOUND, SKIP                              
*                                                                               
PU14     DS    0H                                                               
         MVC   X(132),SPACES                                                    
         GOTO1 =V(GETUSER),DMCB,(C'S',ADCLT),(C'E',ADEST),(C':',X+8),0          
         MVI   BYTE2,1             DO FIRST FILTERS                             
         BAS   RE,PUFILTER         SEE IF TO PRINT ON BILL                      
         BNE   PU14B                                                            
         MVI   HAVUSER,C'Y'                                                     
         MVC   P1,SPACES                                                        
         BRAS  RE,PRNT             SKIP BEFORE                                  
         MVC   P1,X                                                             
         BRAS  RE,PRNT                                                          
         GOTO1 ABILLEDI,DMCB,('EDMUSR',=C'E1')    EDI CALL                      
         MVI   BYTE,1              SO I WON'T SKIP AGAIN                        
*                                                                               
PU14B    DS    0H                                                               
         MVC   X(132),SPACES                                                    
         GOTO1 =V(GETUSER),DMCB,(C'S',ADCLT),(C'E',ADEST),0,(C':',X+8)          
         MVI   BYTE2,2             DO SECOND FILTERS                            
         BAS   RE,PUFILTER         SEE IF TO PRINT ON BILL                      
         BNE   PU18                                                             
         MVI   HAVUSER,C'Y'                                                     
         CLI   BYTE,1                                                           
         BE    *+14                                                             
         MVC   P1,SPACES                                                        
         BRAS  RE,PRNT             SKIP BEFORE                                  
*                                                                               
         MVC   P1,X                                                             
         BRAS  RE,PRNT                                                          
         GOTO1 ABILLEDI,DMCB,('EDMUSR',=C'E2')    EDI CALL                      
*                                                                               
PU18     DS    0H                                                               
         CLI   HAVUSER,C'Y'        IF PRINTED ANY USER FIELDS                   
         BNE   *+14                                                             
         MVC   P1,SPACES           SKIP A LINE                                  
         BRAS  RE,PRNT                                                          
*                                                                               
*                                  NOW CHECK FOR UCOMM RECORDS                  
         CLI   PUMODE,C'E'         MUST BE END OF INVOICE                       
         BNE   PRTUXX              (FOR NOW)                                    
         MVC   USAVKEY,KEY         SAVE MY KEY                                  
         LA    R6,UCOMBLK          SET-UP DDUCOM CONTROL BLOCK                  
         XC    UCOMBLK(L'UCOMBLK),UCOMBLK                                       
         USING DDUCOMD,R6                                                       
*                                                                               
         MVC   UCACOMF,ACOMFACS    COMFACS                                      
         MVI   UCSYS,C'N'          SYSTEM TO PRINT (NET)                        
         MVC   UCSAM,BAGYMD        AGENCY/MEDIA                                 
         MVC   UCSCLT,BCLT         PACKED CLIENT                                
         L     RF,ADPRD                                                         
         MVC   UCPRD,PKEYPRD-PRDHDR(RF)   3-CHAR PRODUCT CODE                   
*                                                                               
         CLI   PRDCTL,C'S'         IF PRODUCTS SEPARATE, WE'RE OK               
         BE    PRTUX4                                                           
         CLI   PGR1CTL,C'S'        IF DOING PRODUCT GROUPS                      
         BNE   *+14                                                             
         MVC   UCPRD,MASPRDCT      . . .USE MASTER PRODUCT CODE                 
         B     *+10                                                             
         MVC   UCPRD,=C'AAA'       . . . OTHERWISE USE PRODUCT AAA              
*                                  DO UCOMM FOR PRODUCT AAA                     
PRTUX4   DS    0H                                                               
         OI    UCOPTSP,UCOCTCL     EITHER CLEAR CTYPE UCOMS OR                  
         CLI   CTYPCTL,C'S'        IF CTYP SEP, GET UCOMS BY CTYPE              
         BNE   PRTUX4F                                                          
         NI    UCOPTSP,X'FF'-UCOCTCL                                            
         OI    UCOPTSP,UCOCTYP                                                  
         L     RE,ACTYP                                                         
         L     RF,=A(CTYPLST)                                                   
         USING CTYLD,RF                                                         
PRTUX4B  CLC   0(1,RE),CTYLDISP    INTERNAL CODE                                
         BE    PRTUX4D                                                          
         CLI   0(RF),X'FF'                                                      
         BNE   *+6                                                              
         DC    H'0'                                                             
         LA    RF,CTYLSTL(RF)                                                   
         B     PRTUX4B                                                          
*                                                                               
PRTUX4D  MVC   UCCTYP,CTYLCOD                                                   
         DROP  RF                                                               
*                                                                               
PRTUX4F  CLI   NS2SW,C'Y'          FOR NS2 RETURN UP TO 8 UCOMS                 
         BE    PRTUX15                                                          
         OI    UCOPT,UCOPRD        RETURN PRODUCT UCOMMS                        
         CLI   ESTCTL,C'S'         ESTIMATE ON SEPARATE INVOICES                
         BNE   PRTUX6                                                           
         OI    UCOPT,UCOEST        RETURN ESTIMATE UCOMMS                       
         L     RF,AEST                                                          
         MVC   UCSEST,0(RF)        BINARY ESTIMATE NUMBER                       
         OI    UCOPT,UCOEFF        ONLY IF UCOM IS WITHIN EFFECT DATE           
         L     RF,APER                                                          
         ZIC   RE,0(RF)                                                         
         LA    RE,PERLIST(RE)                                                   
         USING PERLISTD,RE                                                      
         MVC   UCMOS,PERLMOS       PASS CURRENT PERIOD                          
         DROP  RE                                                               
*                                                                               
PRTUX6   DS    0H                                                               
         GOTO1 =V(DDUCOM),UCOMBLK                                               
         CLI   UCERROR,0                                                        
         BNE   PRTUXX              ERROR RETURN - JUST EXIT DON'T DIE           
         TM    UCDATA,UCDNOPRD+UCDNOEST                                         
         BO    PRTUXX              NEITHER PRODUCT NOR ESTIMATE DATA            
         MVC   P1,SPACES                                                        
         MVI   P1,0                TO INSURE PRINTING                           
         LA    R2,P2+8             START AT SECOND PRINT LINE                   
         TM    UCDATA,UCDNOPRD                                                  
         BO    PRTUX10                                                          
         XC    UCTTLS(UCTTLQ),UCTTLS                                            
         XC    UCOMDATA(UCOMDATQ),UCOMDATA                                      
         L     RE,UCPTTLS          PRODUCT TITLES                               
         MVC   UCTTLS,0(RE)                                                     
         LA    RE,UCTTLS                                                        
         L     RF,UCPDATA          PRODUCT DATA                                 
         MVC   UCOMDATA,0(RF)                                                   
         LA    RF,UCOMDATA                                                      
         LA    R1,UCPLENS          DATA FIELD LENGTHS                           
*                                                                               
         LHI   R5,4                FOR BCT                                      
         LHI   R9,1                EDI LINE COUNTER                             
PRTUX6B  DS    0H                                                               
         CLI   0(R1),0             CHECK DATA LENGTH                            
         BE    PRTUX6X                                                          
         MVC   0(20,R2),0(RE)      MOVE TITLE                                   
         LA    R4,20(R2)                                                        
PRTUX6C  CLI   0(R4),C' '          SCAN BACKWARDS FOR NON-SPACE                 
         BH    PRTUX6D                                                          
         BCT   R4,PRTUX6C                                                       
*                                                                               
PRTUX6D  MVI   1(R4),C':'                                                       
         MVC   3(32,R4),0(RF)                                                   
         MVC   X(132),SPACES                                                    
         MVC   X+8(132-8),0(R2)    MOVE VALUE IN X FOR EDI CALL                 
         MVI   HALF,C'P'                                                        
         STC   R9,HALF+1           DECIDE WHICH SEQUENCE NUMBER                 
         OI    HALF+1,X'F0'                                                     
         ST    R1,WK               SAVE R1                                      
         STM   RE,RF,WK+4          SAVE RF,RE                                   
         GOTO1 ABILLEDI,DMCB,('EDMUCM',HALF)    EDI CALL FOR PRO                
         L     R1,WK               RESTORE R1                                   
         LM    RE,RF,WK+4          RESTORE RE,RF                                
         LA    R2,132(R2)          NEXT PRINT LINE                              
*                                                                               
PRTUX6X  LA    R1,1(R1)            NEXT DATA LENGTH                             
         LA    RE,20(RE)           NEXT TITLE                                   
         LA    RF,32(RF)           NEXT DATA                                    
         AHI   R9,1                                                             
         BCT   R5,PRTUX6B                                                       
*                                                                               
*                                                                               
PRTUX10  DS    0H                  NOW DO ESTIMATE FIELDS                       
         GOTO1 =V(DDUCOM),UCOMBLK    NEW UCOM CALL SINCE GOTO MACRO             
         CLI   UCERROR,0         TRASHED WRKING STORAGE USED BY DDUCOM          
         BNE   PRTUXX       ERROR RETURN - JUST EXIT DON'T DIE                  
         TM    UCDATA,UCDNOEST                                                  
         BO    PRTUX20                                                          
         XC    UCTTLS(UCTTLQ),UCTTLS                                            
         XC    UCOMDATA(UCOMDATQ),UCOMDATA                                      
         L     RE,UCETTLS          ESTIMATE TITLES                              
         MVC   UCTTLS,0(RE)                                                     
         LA    RE,UCTTLS                                                        
         L     RF,UCEDATA          ESTIMATE DATA                                
         MVC   UCOMDATA,0(RF)                                                   
         LA    RF,UCOMDATA                                                      
         LA    R1,UCELENS          DATA FIELD LENGTHS                           
*                                                                               
*        NOTE R2 SHOULD BE SET TO P1+8 OR                                       
*        NEXT AT +8 INTO NEXT AVAILABLE PRINT LINE                              
*                                                                               
         LA    R5,4                FOR BCT                                      
         LHI   R9,1                                                             
PRTUX10B DS    0H                                                               
         CLI   0(R1),0             CHECK DATA LENGTH                            
         BE    PRTUX10X                                                         
         MVC   0(20,R2),0(RE)      MOVE TITLE                                   
         LA    R4,20(R2)                                                        
PRTUX10C CLI   0(R4),C' '          SCAN BACKWARDS FOR NON-SPACE                 
         BH    PRTUX10D                                                         
         BCT   R4,PRTUX10C                                                      
*                                                                               
PRTUX10D MVI   1(R4),C':'                                                       
         MVC   3(32,R4),0(RF)                                                   
         MVC   X(132),SPACES                                                    
         MVC   X+8(132-8),0(R2)    MOVE VALUE IN X FOR EDI CALL                 
         MVI   HALF,C'E'                                                        
         STC   R9,HALF+1           DECIDE WHICH SEQUENCE NUMBER                 
         OI    HALF+1,X'F0'                                                     
         ST    R1,WK               SAVE R1                                      
         STM   RE,RF,WK+4          SAVE RF,RE                                   
         GOTO1 ABILLEDI,DMCB,('EDMUCM',HALF)    EDI CALL FOR EST                
         L     R1,WK               RESTORE R1                                   
         LM    RE,RF,WK+4          RESTORE RE,RF                                
         LA    R2,132(R2)          NEXT PRINT LINE                              
*                                                                               
PRTUX10X LA    R1,1(R1)            NEXT DATA LENGTH                             
         LA    RE,20(RE)           NEXT TITLE                                   
         LA    RF,32(RF)           NEXT DATA                                    
         AHI   R9,1                                                             
         BCT   R5,PRTUX10B                                                      
         B     PRTUX20                                                          
*                                                                               
PRTUX15  DS    0H                                                               
         CLI   ESTCTL,C'S'         ESTIMATE ON SEPARATE INVOICES                
         BNE   PRTUXX              NO, DONE                                     
         OI    UCOPT,UCO8EST       RETURN ESTIMATE UCOMMS (UP TO 8)             
         L     RF,AEST                                                          
         MVC   UCSEST,0(RF)        BINARY ESTIMATE NUMBER                       
         OI    UCOPT,UCOEFF        ONLY IF UCOM IS WITHIN EFFECT DATE           
         L     RF,APER                                                          
         ZIC   RE,0(RF)                                                         
         LA    RE,PERLIST(RE)                                                   
         USING PERLISTD,RE                                                      
         MVC   UCMOS,PERLMOS       PASS CURRENT PERIOD                          
         DROP  RE                                                               
         GOTO1 =V(DDUCOM),UCOMBLK                                               
         CLI   UCERROR,0         TRASHED WRKING STORAGE USED BY DDUCOM          
         BNE   PRTUXX            ERROR RETURN - JUST EXIT DON'T DIE             
         TM    UCDATA,UCDNOEST                                                  
         BO    PRTUXX                                                           
         MVC   P1,SPACES                                                        
         MVI   P1,0                TO INSURE PRINTING                           
         LA    R2,P2+8             START AT SECOND PRINT LINE                   
         XC    UCTTLS(UCTTLQ),UCTTLS                                            
         XC    UCOMDATA(UCOMDATQ),UCOMDATA                                      
         L     RE,UCETTLS          ESTIMATE TITLES                              
         MVC   UCTTLS,0(RE)                                                     
         L     RE,UCPTTLS          PRODUCT TITLES CONTAINING UP TO              
         MVC   UCTTLS2,0(RE)       4 MORE EST UCOMS                             
         LA    RE,UCTTLS                                                        
         L     RF,UCEDATA          ESTIMATE DATA                                
         MVC   UCOMDATA,0(RF)                                                   
         L     RF,UCPDATA          PRODUCT DATA (HAS 4 MORE EST DATA)           
         MVC   UCOMDAT2,0(RF)                                                   
         LA    RF,UCOMDATA                                                      
         MVC   DOUBLE(L'UCELENS),UCELENS    GET LENGTHS OF EST & PRD            
         MVC   DOUBLE+4(L'UCPLENS),UCPLENS                                      
         LA    R1,DOUBLE           DATA FIELD LENS                              
         LA    R5,8                FOR BCT                                      
         LHI   R9,1                                                             
PRTUX15B DS    0H                                                               
         CLI   0(R1),0             CHECK DATA LENGTH                            
         BE    PRTUX15X                                                         
         MVC   0(20,R2),0(RE)      MOVE TITLE                                   
         LA    R4,20(R2)                                                        
PRTUX15C CLI   0(R4),C' '          SCAN BACKWARDS FOR NON-SPACE                 
         BH    PRTUX15D                                                         
         BCT   R4,PRTUX15C                                                      
*                                                                               
PRTUX15D MVI   1(R4),C':'                                                       
         MVC   3(32,R4),0(RF)                                                   
         MVC   X(132),SPACES                                                    
         MVC   X+8(132-8),0(R2)    MOVE VALUE IN X FOR EDI CALL                 
         MVI   HALF,C'E'                                                        
         STC   R9,HALF+1           DECIDE WHICH SEQUENCE NUMBER                 
         OI    HALF+1,X'F0'                                                     
         ST    R1,WK               SAVE R1                                      
         STM   RE,RF,WK+4          SAVE RF,RE                                   
         GOTO1 ABILLEDI,DMCB,('EDMUCM',HALF)    EDI CALL FOR EST                
         L     R1,WK               RESTORE R1                                   
         LM    RE,RF,WK+4          RESTORE RE,RF                                
         LA    R2,132(R2)          NEXT PRINT LINE                              
*                                                                               
PRTUX15X LA    R1,1(R1)            NEXT DATA LENGTH                             
         LA    RE,20(RE)           NEXT TITLE                                   
         LA    RF,32(RF)           NEXT DATA                                    
         AHI   R9,1                                                             
         BCT   R5,PRTUX15B                                                      
*                                                                               
PRTUX20  DS    0H                                                               
         BRAS  RE,PRNT             FINALLY PRINT P LINES                        
         MVC   KEY,USAVKEY         SINCE SEQ READING MAY BE AFFECTED            
         GOTO1 HIGH                                                             
*                                                                               
PRTUXX   J     XIT                                                              
*                                                                               
         DROP  R6,R7                                                            
         SPACE 3                                                                
         EJECT                                                                  
*        PUGTMPRD - PRTUSER, GET MASTER PRODUCT FROM PGR RECORD                 
*                                                                               
PUGTMPRD NTR1                                                                   
*                                                                               
         XC    FULL,FULL           CLEAR SAVED MASTER CODE                      
         L     R2,ADPRDGRP         PGR RECORD                                   
         LA    R2,PRGEL-PRGKEY(R2)                                              
*                                                                               
PUGMPR2  DS    0H                                                               
         CLI   0(R2),0             EOR                                          
         BE    NEQXIT                                                           
         CLI   0(R2),X'30'                                                      
         BE    PUGMPR4                                                          
*                                                                               
         ZIC   R0,1(R2)            NEXT ELEMENT                                 
         AR    R2,R0                                                            
         B     PUGMPR2                                                          
*                                                                               
PUGMPR4  DS    0H                                                               
         USING PRGEL30,R2                                                       
         CLI   PRGUSER,C' '        ANY MASTER PRODUCT PRESENT?                  
         BNH   NEQXIT              NO, DONE                                     
         MVC   FULL(L'PRGUSER),PRGUSER     SAVE PRODUCT CODE                    
*                                                                               
         L     RF,VCLIST           EXTRACT NUMERIC PRODUCT CODE                 
PUGMPR6  CLC   PRGUSER,0(RF)                                                    
         BE    PUGMPR8                                                          
         LA    RF,4(RF)                                                         
         CLI   0(RF),C'A'                                                       
         BNL   PUGMPR6                                                          
         B     *+10                MISSING PRD CODE OR OVERFLOW PRD             
PUGMPR8  MVC   MASPRDCD,3(RF)      SAVE NUMERIC MASTER PRODUCT CODE             
         MVC   MASPRDCT,PRGUSER    . . . AND ALPHA AS WELL                      
*                                                                               
*                                  READ FOR MASTER PRODUCT                      
         L     RF,ADPRD                                                         
         MVC   KEY,0(RF)                                                        
         MVC   (PKEYPRD-PRDHDR)+KEY,PRGUSER                                     
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BNE   NEQXIT                                                           
         GOTO1 GETPRD                                                           
         CLI   DMCB+8,0            *** DEIS -- WAS TM INSTRUCTION ***           
         BNE   NEQXIT                                                           
         B     EQXIT                                                            
         DROP  R2                                                               
         SPACE 2                                                                
*        PUGTMEST - PRTUSER, GET ESTIMATE FOR MASTER PRODUCT                    
*                                                                               
PUGTMEST NTR1                                                                   
*                                                                               
         CLI   FULL,C' '           ANY MASTER PRODUCT PRESENT?                  
         BNH   NEQXIT              NO, DONE                                     
*                                  READ FOR ESTIMATE FOR PRODUCT                
         L     RF,ADEST                                                         
         MVC   KEY,0(RF)                                                        
         MVC   (EKEYPRD-ESTHDR)+KEY,FULL    PRODUCT CODE                        
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BNE   NEQXIT                                                           
         GOTO1 GETEST                                                           
         CLI   DMCB+8,0            *** DEIS -- WAS TM INSTRUCTION ***           
         BNE   NEQXIT                                                           
         B     EQXIT                                                            
*                                                                               
         SPACE 2                                                                
*        PUGTPOLP - PRTUSER, GET POL PRODUCT HEADER                             
*                                                                               
PUGTPOLP NTR1                                                                   
*                                                                               
         L     RF,ADPRD                                                         
         MVC   KEY,0(RF)                                                        
         MVC   (PKEYPRD-PRDHDR)+KEY,=C'POL'                                     
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BNE   NEQXIT                                                           
         GOTO1 GETPRD                                                           
         CLI   DMCB+8,0            *** DEIS -- WAS TM INSTRUCTION ***           
         BNE   NEQXIT                                                           
         B     EQXIT                                                            
         SPACE 2                                                                
*        PUGTPOLE - PRTUSER, GET POL ESTIMATE HEADER                            
*                                                                               
PUGTPOLE NTR1                                                                   
*                                                                               
         L     RF,ADEST                                                         
         MVC   KEY,0(RF)                                                        
         MVC   (EKEYPRD-ESTHDR)+KEY,=C'POL'                                     
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BNE   NEQXIT                                                           
         GOTO1 GETEST                                                           
         CLI   DMCB+8,0            *** DEIS -- WAS TM INSTRUCTION ***           
         BNE   NEQXIT                                                           
         B     EQXIT                                                            
*                                                                               
NEQXIT   J     NO                  EXIT WITH CC NOT =                           
*                                                                               
EQXIT    J     YES                 EXIT WITH CC =                               
         SPACE 3                                                                
*        PUFILTER - FILTER ON USE MASKS                                         
*                                                                               
PUFILTER NTR1                                                                   
*                                                                               
         CLI   BYTE2,2                                                          
         BE    PUFLT2                                                           
*                                                                               
         LA    RF,DMCB+4           1ST FILTERS                                  
         B     PUFLT4                                                           
*                                                                               
PUFLT2   DS    0H                                                               
         LA    RF,DMCB+6           2ND FILTERS                                  
*                                                                               
PUFLT4   DS    0H                                                               
*                                                                               
         TM    0(RF),CFLGBHLQ      ALREADY IN HEADLINES?                        
         BO    PUFLTNO             YES                                          
*                                                                               
         CLI   PUMODE,C'F'         'FRONT' PRINTING UDEF?                       
         BNE   *+16                                                             
         TM    0(RF),CFLGBFRQ                                                   
         BO    PUFLT6                                                           
         B     PUFLTNO                                                          
*                                                                               
*                                  NOT 'FRONT'                                  
         TM    0(RF),CFLGBFRQ                                                   
         BZ    PUFLT6                                                           
         B     PUFLTNO                                                          
*                                                                               
PUFLT6   DS    0H                                                               
         CLI   CTYPCTL,C'S'        IF SEPARATE BILLS BY COST TYPE               
         BNE   PUFLT8                                                           
         L     R3,ACTYP                                                         
*                                                                               
         CLI   0(R3),0             TIME                                         
         BNE   *+16                                                             
         TM    0(RF),CFLGNTBQ                                                   
         BZ    PUFLTNO                                                          
         B     PUFLTYES                                                         
*                                                                               
         CLI   0(R3),1             INTEGRATION                                  
         BNE   *+16                                                             
         TM    0(RF),CFLGNIBQ                                                   
         BZ    PUFLTNO                                                          
         B     PUFLTYES                                                         
*                                                                               
         TM    0(RF),CFLGNSBQ      ELSE SPECIAL                                 
         BZ    PUFLTNO                                                          
         B     PUFLTYES                                                         
*                                                                               
PUFLT8   DS    0H                  COST TYPES TOGETHER OR NO                    
         CLI   CTYPQ,C'1'          REQUESTED TIME + INT                         
         BNE   *+16                                                             
         TM    0(RF),CFLGNTBQ+CFLGNIBQ                                          
         BNO   PUFLTNO                                                          
         B     PUFLTYES                                                         
*                                                                               
         CLI   CTYPQ,C'2'          REQUESTED SPECIALS                           
         BNE   *+16                                                             
         TM    0(RF),CFLGNSBQ                                                   
         BNO   PUFLTNO                                                          
         B     PUFLTYES                                                         
*                                                                               
         CLI   CTYPQ,C'3'          REQUESTED ALL TYPES                          
         BNE   *+16                ALL MUST BE ON                               
         TM    0(RF),CFLGNTBQ+CFLGNIBQ+CFLGNSBQ                                 
         BNO   PUFLTNO                                                          
         B     PUFLTYES                                                         
*                                                                               
         CLI   CTYPQ,C'4'          REQUESTED TIME + SPECIALS                    
         BNE   *+16                                                             
         TM    0(RF),CFLGNTBQ+CFLGNSBQ                                          
         BNO   PUFLTNO                                                          
         B     PUFLTYES                                                         
*                                                                               
         CLI   CTYPQ,C' '          REQUESTED ALL TYPES                          
         BNE   *+16                ALL MUST BE ON                               
         TM    0(RF),CFLGNTBQ+CFLGNIBQ+CFLGNSBQ                                 
         BNO   PUFLTNO                                                          
         B     PUFLTYES                                                         
*                                                                               
PUFLTNO  J     NO                  IF DOESN'T PASS, SET CC NOT =                
*                                                                               
PUFLTYES J     YES                 IF DOES, SET CC =                            
         SPACE 2                                                                
         LTORG                                                                  
         SPACE 2                                                                
PRTUSRD  DSECT                                                                  
UCOMBLK  DS    CL(UCOMDLNQ)        DDUCOM CONTROL BLOCK                         
UCTTLS   DS    CL80                LEN=20*4                                     
UCTTLS2  DS    CL80                LEN=20*4 (FOR 8 EST UCOMS)                   
UCTTLQ   EQU   *-UCTTLS                                                         
UCOMDATA DS    CL128               LEN=32*4                                     
UCOMDAT2 DS    CL128               LEN=32*4 (FOR 8 EST UCOMS)                   
UCOMDATQ EQU   *-UCOMDATA                                                       
USAVKEY  DS    XL13                TO SAVE CURRENT READ SEQUENCE                
PRTUSRQ  EQU   *-UCOMBLK                                                        
         EJECT                                                                  
SPBU02   CSECT                                                                  
ZAPSTR   NTR1  BASE=*,LABEL=*                                                   
ZAPS1    ZAP   0(ACCUMLQ,R1),=P'0'                                              
         LA    R1,ACCUMLQ(R1)                                                   
         CR    R1,RF                                                            
         BL    ZAPS1                                                            
         XIT1                                                                   
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
         TITLE 'TOTOUT - PRINT TOTALS FOR LEVEL'                                
*                                                                               
TOTOUT   NMOD1 0,TOTOUT                                                         
         LA    RC,SPACEND                                                       
*                                                                               
         MVI   TOTSW,C'N'                                                       
         C     R3,AINVBRK                                                       
         BNE   *+8                                                              
         MVI   TOTSW,C'Y'          SET HAVE PRINTED INVOICE TOTALS              
         MVI   PRSW,C'M'           SET TO 'MERGE UP' LINES                      
         L     R7,BRKCODE                                                       
         L     R7,ATOTS(R7)        POINT TO ACCUMULATOR                         
         CLI   PERCTL,C'T'                                                      
         BE    TOUT10                                                           
         SPACE 1                                                                
***********************************************************************         
*                             SINGLE MONTH                                      
***********************************************************************         
         SPACE 1                                                                
TOUT4    DS    0H                                                               
         AHI   R7,MAXMOS*ROWL      POINT TO TOTAL ROW                           
         L     RF,APER                                                          
         ZIC   R6,0(RF)                                                         
         ST    R6,PERLIND          SAVE A(PERLIST ENTRY)                        
         A     R6,=A(INVLIST)      POINT TO INVOICE NO FOR THIS MONTH           
         L     RF,ACTYP            COST TYPE IS ALSO INDEX                      
         ZIC   R0,0(RF)                                                         
         MHI   R0,INVLISTL                                                      
         AR    R6,R0                                                            
*                                                                               
         CLI   CTYPCTL,C'T'        COST TYPES TOGETHER?                         
         BE    TOUT7                                                            
*                                  NO, SEPARATE OR NOT SHOWN (S OR N)           
         MVI   SVCTYPE,TIMEQ       SET TYPE FOR EDI MODULE                      
         CLI   CTYPCTL,C'N'        NULL IF NOT SHOWN                            
         BE    *+14                                                             
         L     RF,ACTYP                                                         
         MVC   SVCTYPE,0(RF)       TYPE IN ACTYP IF SEPARATE                    
*                                                                               
         BAS   RE,TSET                                                          
         LA    R7,WK                                                            
         GOTOR FMTAMT,DMCB,(R7),(R6)                                            
         OC    P,X                                                              
         LA    R2,P+14             PLACE FOR UNITS (FORMAT 1 ONLY)              
         ST    R2,ADUNITS                                                       
         BAS   RE,TOUNITS                                                       
         B     TOUT8                                                            
*                                  ALL COST TYPES 'TOGETHER'                    
TOUT7    DS    0H                                                               
         CLI   FORMAT,5                                                         
         BL    *+12                                                             
         CLI   SPOTCTL,C'Y'                                                     
         BE    TOUT7A1                                                          
*                                                                               
         LA    R4,P+11             COLUMN FOR TYPE                              
         LA    RF,P+9                                                           
         CLI   FORMAT,1            FOR FORMAT 1                                 
         BNE   *+12                                                             
         LA    R4,P+4              SHIFT TO LEFT                                
         LA    RF,P+2                                                           
         CLC   0(10,RF),SPACES     SEE IF CAN FIT ON SAME LINE                  
         BE    TOUT7B                                                           
         BRAS  RE,PRNT             NO - NEXT LINE                               
         B     TOUT7B                                                           
*                                                                               
TOUT7A1  DS    0H                                                               
         LA    R4,P+54             USE COL3 FOR T/I IF FREE                     
         CLI   FORMAT,12                                                        
         BE    *+8                                                              
         LA    R4,P+24             ELSE USE COLUMN 1                            
*                                                                               
         LR    RF,R4                                                            
         BCTR  RF,0                                                             
         CLC   0(10,RF),SPACES     SEE IF CAN FIT                               
         BE    TOUT7B                                                           
         BRAS  RE,PRNT             NO - NEXT LINE                               
*                                                                               
TOUT7B   DS    0H                                                               
         LR    R0,R4                                                            
         LA    RF,P                                                             
         SR    R0,RF               DISP. FROM START OF LINE FOR COST            
         L     RF,APER                                                          
         ZIC   RE,0(RF)                                                         
         ST    RE,DMCB+12          PERIOD DISPLACEMENT                          
         GOTO1 COSTPRT,DMCB,P,(R0),(R7)                                         
         MVI   SPACING,2                                                        
*                                                                               
TOUT8    DS    0H                                                               
         C     R3,AINVBRK                                                       
         BNE   *+16                                                             
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
         B     TOUTX                                                            
*                                                                               
         CLI   SPOTCTL,C'Y'                                                     
         BNE   TOUT9B                                                           
*                                                                               
         C     R3,ADESCBRK                                                      
         BE    *+8                                                              
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
         B     TOUTX                                                            
*                                                                               
TOUT9B   DS    0H                                                               
         CLI   BRKCODE+3,STAEQ*4                                                
         BNL   *+8                                                              
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
         CLI   BRKCODE+3,STAEQ*4                                                
         BNL   TOUTXX              DON'T FLUSH PRINT LINES                      
         B     TOUTX                                                            
         SPACE 1                                                                
***********************************************************************         
*                             MULTI MONTH                                       
***********************************************************************         
         SPACE 1                                                                
TOUT10   DS    0H                                                               
         C     R3,ADESCBRK         TREAT SPOT DETAIL LINE AS                    
         BNE   *+16                SINGLE MONTH FORMAT                          
         L     RF,ADESC            UNLESS IS SPECIAL                            
         CLI   0(R5),X'F9'         (PREVIOUS BILLED UNITS, ETC.)                
         BNH   TOUT4                                                            
*                                                                               
         SR    R5,R5               R5 = INDEX INTO PERLIST                      
TOUT10A4 DS    0H                                                               
         ST    R5,PERLIND          SAVE A(PERLIST ENTRY)                        
         LA    R6,P                                                             
         LA    R4,22(R6)           COLUMN FOR MONTH                             
         CLI   FORMAT,5                                                         
         BNL   *+8                                                              
         LA    R4,3(R6)                                                         
         LR    RF,R4                                                            
         SHI   RF,2                                                             
         CLC   0(10,RF),SPACES     SEE IF CAN PRINT ON SAME LINE                
         BE    *+8                                                              
         BRAS  RE,PRNT                                                          
*                                                                               
         LA    R2,PERLIST(R5)      POINT TO MONTH                               
         USING PERLISTD,R2                                                      
         CLI   0(R2),X'FF'                                                      
         BNE   TOUT12                                                           
         MVC   0(6,R4),=C'TOTAL*'                                               
         L     R7,BRKCODE                                                       
         L     R7,ATOTS(R7)                                                     
         AHI   R7,MAXMOS*ROWL      POINT TO TOTAL ROW                           
         B     TOUT14                                                           
TOUT12   DS    0H                  ANY DATA?                                    
         LR    RE,R7                                                            
         LA    RF,ROWTL*NCTYPS(RE) POINT PAST COST TYPE ACCUMULATORS            
TOUT12A  CP    0(ACCUMLQ,RE),=P'0'                                              
         BNE   TOUT12B                                                          
         LA    RE,ACCUMLQ(RE)                                                   
         CR    RE,RF                                                            
         BL    TOUT12A                                                          
         B     TOUT15                                                           
*                                                                               
TOUT12B  CLI   SPOTPROF+2,0        BROADCAST MONTH?                             
         BE    *+12                                                             
         CLI   SPOTPROF+2,2        OR CALENDAR?                                 
         BNE   TOUT13                                                           
*                                                                               
         GOTO1 DATCON,DMCB,(3,PERLMOS),(6,0(R4))   NORMAL = MMMYY               
         B     TOUT14                                                           
TOUT13   DS    0H                                                               
         GOTO1 DATCON,DMCB,(2,PERLSTRT),(5,0(R4))  OTHER = MMMDD/YY             
         DROP  R2                                                               
*                                                                               
TOUT14   DS    0H                                                               
         CLI   CTYPCTL,C'T'        COST TYPES TOGETHER?                         
         BE    TOUT14B                                                          
*                                  NO, SEPARATE OR NOT SHOWN (S OR N)           
         MVI   SVCTYPE,TIMEQ       SET TYPE FOR EDI MODULE                      
         CLI   CTYPCTL,C'N'        NULL IF NOT SHOWN                            
         BE    *+14                                                             
         L     RF,ACTYP                                                         
         MVC   SVCTYPE,0(RF)       TYPE IN ACTYP IF SEPARATE                    
*                                                                               
         BAS   RE,TSET                                                          
         L     RF,=A(INVLIST)                                                   
         AR    RF,R5               PERIOD IS INDEX INTO INVLIST                 
         L     RE,ACTYP            SO IS COST TYPE                              
         ZIC   R0,0(RE)                                                         
         MHI   R0,INVLISTL                                                      
         AR    R0,RF                                                            
*                                                                               
         GOTOR FMTAMT,DMCB,WK,(R0)                                              
         OC    P,X                                                              
         LA    RF,P+15             PLACE FOR UNITS (FORMAT 1)                   
         ST    RF,ADUNITS                                                       
         BAS   RE,TOUNITS                                                       
         B     TOUT14P                                                          
*                                  COST TYPES  'TOGETHER'                       
TOUT14B  DS    0H                                                               
         CLI   SPOTCTL,C'Y'        IF SPOT DETAILS                              
         BE    *+16                                                             
         CLI   FORMAT,5                                                         
         BH    TOUT14D                                                          
         B     *+12                                                             
         CLI   FORMAT,12           AND COLUMN 3 FREE                            
         BE    *+16                USE IT FOR T/I                               
         LA    R6,132(R6)                                                       
         LA    R4,132(R4)                                                       
         B     TOUT14F                                                          
         LA    R4,52(R6)           COLUMN 3 FOR T/I                             
         B     TOUT14F                                                          
*                                                                               
TOUT14D  DS    0H                                                               
         LA    R4,38(R6)                                                        
*                                                                               
TOUT14F  DS    0H                                                               
         LA    R0,2(R4)                                                         
         SR    R0,R6               DISP. FROM START OF LINE FOR COST            
         GOTO1 COSTPRT,DMCB,(R6),(R0),(R7),(R5)                                 
*                                                                               
TOUT14P  DS    0H                                                               
         MVI   SPACING,2                                                        
         CLI   0(R2),X'FF'                                                      
         BE    *+16                                                             
         CLI   CTYPCTL,C'T'                                                     
         BE    *+8                                                              
         MVI   SPACING,1                                                        
         BRAS  RE,PRNT                                                          
         CLI   0(R2),X'FF'                                                      
         BE    TOUTX                                                            
*                                                                               
TOUT15   DS    0H                                                               
         LA    R5,PERLISTL(R5)     NEXT DATE                                    
         LA    R7,ROWL(R7)         NEXT DATA                                    
         B     TOUT10A4                                                         
*                                                                               
TOUTX    DS    0H                                                               
         MVI   PRSW,C'F'           SET TO FLUSH LINES                           
         BRAS  RE,PRNT                                                          
*                                                                               
TOUTXX   DS    0H                                                               
         L     RE,=A(CTYPTAB)      CLEAR CHARGE TYPE TABLE                      
         LHI   RF,CTYPTMAX*CTYPTBL                                              
         XCEF                                                                   
         L     R1,=A(CTYPTAB)      INIT 1ST ROW TO PACKED                       
         MVI   0(R1),X'FF'                                                      
         LA    R1,CTYPBRK(R1)      POINT TO $$                                  
         LA    RF,ROWTL(R1)        POINT PAST $$                                
         BRAS  RE,ZAPSTR                                                        
         J     XIT                                                              
         EJECT                                                                  
*                                  SET SUM OF COST TYPES IN WK                  
TSET     NTR1                                                                   
*                                  NOTE - SPOTS = TIME ONLY, NOT TOTAL          
         LA    R1,WK                                                            
         LA    RF,ROWTL(R1)                                                     
         BRAS  RE,ZAPSTR           ZAP WK FOR AMTS                              
         LHI   R1,NCTYPS           FOR BCT                                      
         SR    RF,RF               INDEX                                        
*                                                                               
TSET4    DS    0H                                                               
         LR    RE,R7                                                            
         AR    RE,RF               USED INSTEAD OF R7+RF                        
         AP    WK(ACCUMLQ),0(ACCUMLQ,RE) GROSS ORDERED                          
         AP    WK+ACCUMLQ(ACCUMLQ),ACCUMLQ(ACCUMLQ,RE)    NET ORDERED           
         AP    WK+ACCUMLQ*2(ACCUMLQ),ACCUMLQ*2(ACCUMLQ,RE)  GROSS2 ORD          
         AP    WK+ROWHL(ACCUMLQ),ROWHL(ACCUMLQ,RE)        GROSS BILLED          
         AP    WK+ROWHL+ACCUMLQ(ACCUMLQ),ROWHL+ACCUMLQ(ACCUMLQ,RE)  NET         
*                                                         GROSS2 BILLED         
         AP    WK+ROWHL+ACCUMLQ*2(ACCUMLQ),ROWHL+ACCUMLQ*2(ACCUMLQ,RE)          
*                                                                               
         CLI   CTYPCTL,C'N'        IF TYPES LUMPED                              
         BNE   *+10                                                             
         LTR   RF,RF               ONLY COUNT TIME SPOTS                        
         BNZ   TSET6                                                            
*                                                                               
         AP    WK+ROW$L(ACCUMLQ),ROW$L(ACCUMLQ,RE)        SPOTS ORDERED         
         AP    WK+ROWHL+ROW$L(ACCUMLQ),ROWHL+ROW$L(ACCUMLQ,RE) SPTS BLD         
*                                                                               
TSET6    DS    0H                                                               
         LA    RF,ROWTL(RF)                                                     
         BCT   R1,TSET4                                                         
*                                                                               
         J     XIT                                                              
         EJECT                                                                  
*                                  PRINT COST TYPES                             
COSTPRT  NTR1                                                                   
*                                                                               
         L     R2,0(R1)            A(FIRST PRINT LINE)                          
         L     R7,4(R1)            DISPLACEMENT INTO LINE OF TYPE               
         L     R4,8(R1)            A(ROW)                                       
         MVC   BYTE,15(R1)         PERIOD DISPLACEMENT                          
*                                                                               
         L     R6,=A(CTYPLST)      COST TYPE POINTER                            
         SR    R5,R5               COST TYPE INDEX                              
*                                                                               
         USING CTYLD,R6                                                         
CSP4     DS    0H                                                               
         CLI   CTYPQ,C'2'          UNLESS DOING ONLY ALL SPECIAL                
         BE    CSP40               COST TYPES                                   
         CLI   CTYPQ,C'4'          TIME AND SPECIALS?                           
         BNE   *+12                                                             
         CLI   CTYLDISP,INTEGQ     NO INTEGRATION                               
         BE    CSP7B               GET NXT COST TYPE                            
*                                                                               
         TM    CTYLCTL,X'80'       REQUIRED COST TYPE?                          
         BNZ   CSP4C               (T/I)                                        
CSP40    LR    RE,R4                                                            
         LA    RF,ROWTL(RE)        POINT PAST COST TYPE ACCUMULATORS            
CSP4A    CP    0(ACCUMLQ,RE),=P'0' SKIP IF ZERO                                 
         BNE   CSP4C                                                            
         LA    RE,ACCUMLQ(RE)                                                   
         CR    RE,RF                                                            
         BL    CSP4A                                                            
         B     CSP7B                                                            
*                                                                               
CSP4C    LA    R1,0(R2,R7)         R7 = PLACE FOR TYPE                          
*                                                                               
         CLI   FORMAT,1            FOR FORMAT 1                                 
         BNE   CSP6J                                                            
         C     R3,ADESCBRK         SKIP IF SINGLE UNIT DISPLAY                  
         BNE   *+16                                                             
         L     RF,ADESC                                                         
         CLI   0(RF),X'F9'         AND NOT SPECIAL TYPE                         
         BNH   CSP6J                                                            
*                                                                               
         BCTR  R1,0                BACK UP 1                                    
         CLI   0(R1),C' '          MUST HAVE SPACE BEFORE                       
         BNH   *+8                                                              
         LA    R1,132(R1)          ELSE NEXT LINE                               
**       CLI   CTYLDISP,TIMEQ      IF TIME                                      
**       BNE   CSP5                                                             
**       CLC   FEEDNAME,SPACES     USE FEED NAME IN STEAD OF WORD               
**       BE    CSP5                'TIME'                                       
**       MVC   1(9,R1),FEEDNAME                                                 
**       MVC   FEEDNAME,SPACES                                                  
**       B     *+10                                                             
CSP5     MVC   1(9,R1),CTYLSNAM                                                 
         MVC   MYPACKED,ACMORDS-ACMD(R4)    AND SHOW NO. OF UNITS               
         LR    RF,R1                                                            
         EDIT  MYPACKED,(4,11(RF)),ZERO=NOBLANK,FLOAT=-                         
         B     CSP6K                                                            
*                                                                               
CSP6J    DS    0H                                                               
**       CLI   CTYLDISP,TIMEQ      IF TIME                                      
**       BNE   CSP6J2                                                           
**       CLC   FEEDNAME,SPACES     USE FEED NAME IN STEAD OF WORD               
**       BE    CSP6J2              'TIME'                                       
**       MVC   0(9,R1),FEEDNAME                                                 
**       MVC   FEEDNAME,SPACES                                                  
**       B     *+10                                                             
CSP6J2   MVC   0(9,R1),CTYLSNAM                                                 
*                                                                               
CSP6K    DS    0H                                                               
         MVC   SVCTYPE,CTYLDISP    SET TYPE FOR EDI MODULE                      
         L     RF,=A(INVLIST)      LINE INVOICE NUMBER LIST                     
         ZIC   R0,BYTE             PERIOD IS INDEX                              
         AR    R0,RF                                                            
         AR    R0,R5               LIST FOR THIS COST TYPE                      
*                                                                               
         L     RF,=A(CTYPTAB)      ANYTHING IN TYPE TABLE ?                     
         CLI   0(RF),X'FF'                                                      
         BE    CSP6P               NO, REGULAR WAY                              
         USING CTYPTABD,RF         YES, USE CTYPTAB FOR CTYP $$                 
CSP6L    CLC   CTYPTYP,CTYLDISP    FIND CURRENT CTYPE                           
         BE    CSP6M                                                            
         LA    RF,CTYPTBL(RF)                                                   
         CLI   CTYPTYP,X'FF'                                                    
         BNE   CSP6L                                                            
         CLI   CTYLDISP,TIMEQ      NO ENTRY IN CTYP TAB...                      
         BE    CSP6P               IS IT TIME ? YES, PRINT 0                    
         CLI   CTYLDISP,INTEGQ     IS IT INTEGRATION                            
         BE    CSP6P               YES, PRINT 0                                 
         DC    H'0'                OTHERWISE HAS TO BE IN CTYPTAB               
CSP6M    STCM  RF,15,WK2           SAVE RF                                      
         STCM  R4,15,WK2+4         SAVE R4                                      
         STCM  R1,15,WK2+8         SAVE R1                                      
         OC    CTYPSTA,CTYPSTA     IS THERE FEED OR STATION ?                   
         BZ    CSP6M2                                                           
         CLI   CTYLDISP,TIMEQ      IF TIME -> FEED                              
         BNE   *+12                                                             
         BAS   RE,GETFEEDN                                                      
         B     *+8                                                              
         BAS   RE,GETMKSTN         GET MKT/STA NAME AND STATE CODE              
CSP6M2   LA    R4,CTYPBRK(RF)                                                   
         GOTOR FMTAMT,DMCB,(R4),(R0)                                            
         OC    0(132,R2),X                                                      
         LA    R2,132(R2)          NEXT LINE                                    
         ICM   RF,15,WK2           RESTORE RF                                   
         ICM   R4,15,WK2+4         RESTORE R4                                   
         ICM   R1,15,WK2+8         RESTORE R1                                   
CSP6N    LA    RF,CTYPTBL(RF)      NXT ROW                                      
         CLI   CTYPTYP,X'FF'                                                    
         BE    CSP7B                                                            
         CLC   CTYPTYP,CTYLDISP                                                 
         BNE   CSP6N                                                            
         LA    R1,132(R1)          NEXT PRINT LINE                              
         B     CSP6M                                                            
         DROP  RF                                                               
*                                                                               
CSP6P    GOTOR FMTAMT,DMCB,(R4),(R0)                                            
         OC    0(132,R2),X                                                      
*                                                                               
         LA    R2,132(R2)          NEXT LINE                                    
CSP7B    DS    0H                                                               
         LA    R4,ROWTL(R4)        NEXT AMOUNT                                  
         LA    R6,CTYLSTL(R6)      NEXT TYPE                                    
         LA    R5,INVLISTL(R5)     NEXT COST TYPE INVLIST                       
         CLI   0(R6),X'FF'         EOL                                          
         BNE   CSP4                                                             
         DROP  R6                                                               
*                                                                               
         J     XIT                                                              
         EJECT                                                                  
GETMKSTN NTR1                                                                   
         LR    R2,R1               SAVE R1, CONTAINS A(PRTLINE)                 
         MVC   0(PMKTSTAL,R2),SPACES                                            
         USING PMKTSTAD,R2                                                      
         USING CTYPTABD,RF                                                      
         GOTO1 MSUNPK,DMCB,CTYPSTA,WK2+12,PMKTSTA                               
         DROP  RF                                                               
*                                                                               
         L     R6,VMASTC                                                        
         USING MASTD,R6                                                         
         L     R4,MCUTL            A(UTL)                                       
         USING UTLD,R4                                                          
         MVC   TSYS,MCS2SENO       SWITCH TO SPOT SYSTEM                        
         OC    TSYS,TSYS                                                        
         BNZ   *+6                                                              
         DC    H'0'          DIE HERE, HAD TO OPEN SPOT FILE FOR THIS           
*                                                                               
         LA    R5,KEY                                                           
         MVI   KEY,C'0'                                                         
         MVC   KEY+1(L'KEY-1),KEY  CLEAR KEY TO C'0'                            
         USING ADDRECD,R5                                                       
         MVI   ADDKTYPE,ADDKTYPQ                                                
         MVI   ADDKMED,C'T'     ALWAYS TV                                       
         MVC   ADDKCALL,PMKTSTA                                                 
         MVI   ADDKCALL+4,C'T'     BAND IS T                                    
         MVC   ADDKAGY,QAGY                                                     
*                                                                               
         L     R5,=A(XSPIO)                                                     
         GOTO1 DATAMGR,DMCB,=C'DMRDHI',=C'STATION',KEY,(R5)                     
         CLI   8(R1),0                                                          
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLC   ADDRKEY,KEY         FOUND RECORD ?                               
         BE    *+14                                                             
         MVC   PMKTSTC,=C'??'                                                   
         B     *+10                                                             
         MVC   PMKTSTC,A3LINE                                                   
         DROP  R5                                                               
*                                                                               
         LA    R5,KEY                                                           
         MVI   KEY,C'0'                                                         
         MVC   KEY+1(L'KEY-1),KEY  CLEAR KEY TO C'0'                            
         USING MKTRECD,R5                                                       
         MVI   MKTKTYPE,MKTKTYPQ                                                
         MVI   MKTKMED,C'T'     ALWAYS TV                                       
         MVC   MKTKMKT,WK2+12                                                   
         MVC   MKTKAGY,QAGY                                                     
*                                                                               
         L     R5,=A(XSPIO)                                                     
         GOTO1 DATAMGR,DMCB,=C'DMRDHI',=C'STATION',KEY,(R5)                     
         CLI   8(R1),0                                                          
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLC   MKTKEY,KEY         FOUND RECORD ?                                
         BE    *+14                                                             
         MVC   PMKTMKT(10),=C'??????????'                                       
         B     *+10                                                             
         MVC   PMKTMKT,MKTNAME                                                  
*                                                                               
         MVC   TSYS,MCIDSENO       SWITCH BACK TO NET SYSTEM                    
         GOTO1 SQUASHER,DMCB,(R2),PMKTSTAL                                      
         DROP  R4,R6                                                            
         DROP  R5,R2                                                            
         XIT1                                                                   
         EJECT                                                                  
*                                                                               
*  GET FEED NAME FROM FEED REC USING FEED CODE                                  
GETFEEDN NTR1                                                                   
         LR    R2,R1               A(PRTLINE)                                   
         LR    R6,RF               A(CTYPTAB)                                   
         USING CTYPTABD,R6                                                      
         OC    CTYPSTA,CTYPSTA     IS THERE ANY FEED CODE?                      
         BZ    GETFNX              NO, DONE                                     
         L     R4,ASTA                                                          
         SHI   R4,2                                                             
         GOTO1 MSUNPK,DMCB,(R4),DUB,WORK                                        
         XC    KEY,KEY                YES, LOOK FOR THE FEED REC                
K@       USING FEEDKEY,KEY                                                      
         MVC   K@.FEEDKID,=X'0A2B'                                              
         MVC   K@.FEEDKAM,BAGYMD                                                
         MVC   K@.FEEDKNET,WORK                                                 
         MVC   K@.FEEDKCLT,BCLT                                                 
         MVC   K@.FEEDKFD,CTYPSTA                                               
         DROP  R6                                                               
         GOTO1 HIGH                                                             
         CLC   KEY(L'FEEDKEY),KEYSAVE                                           
         BE    GETFN10                                                          
         MVC   KEY(L'FEEDKEY),KEYSAVE                                           
         XC    K@.FEEDKCLT,KEYSAVE+7  CLEAR CLIENT                              
         GOTO1 HIGH                                                             
         CLC   KEY(L'FEEDKEY),KEYSAVE                                           
         BNE   GETFNX                                                           
         DROP  K@                                                               
*                                                                               
GETFN10  L     R6,=A(XSPIO)                                                     
         ST    R6,AREC                                                          
         GOTO1 GET                                                              
*                                                                               
         USING FEEDKEYD,R6                                                      
         CLI   FEEDELEM,X'20'        FEED DESCR ELEM                            
         BE    *+6                                                              
         DC    H'0'                                                             
         MVC   FEEDNAME,FEEDELDS                                                
         CLI   FEEDELLN,63                                                      
         BE    *+10                  THERE MIGHT BE OLD ELEM WITH               
         MVC   FEEDNAME,FEEDELDS-1   THE LENGTH OF 62                           
         MVC   0(9,R2),FEEDNAME                                                 
         DROP  R6                                                               
*                                                                               
GETFNX   XIT1                                                                   
*        TOUNITS - EDIT UNITS                                                   
*                                                                               
TOUNITS  NTR1                                                                   
*                                                                               
         CLI   FORMAT,1            ONLY FOR FORMAT 1                            
         BNE   TOUNITX                                                          
*                                                                               
         C     R3,ADESCBRK         SKIP IF SINGLE UNIT DISPLAY                  
         BNE   *+16                                                             
         L     RF,ADESC                                                         
         CLI   0(RF),X'F9'         AND NOT SPECIAL TYPE                         
         BNH   TOUNITX                                                          
*                                                                               
         MVC   MYPACKED,ROW$L(R7)  SPOTS                                        
         EDIT  MYPACKED,(6,X),ZERO=NOBLANK,FLOAT=-                              
         LA    RE,X+5                                                           
         CLI   0(RE),C' '                                                       
         BNH   *+8                                                              
         BCT   RE,*-8                                                           
*                                                                               
         LA    R2,X+5                                                           
         SR    R2,RE               R2 HAS LENGTH OF REQUIRED SPACE              
*                                                                               
         L     RF,ADUNITS          PLACE FOR OUTPUT                             
*                                                                               
TOUNIT3  DS    0H                                                               
         CLC   0(5,RF),SPACES      IF IT FITS EASILY                            
         BNE   *+14                                                             
         MVC   0(5,RF),X+1         JUST MOVE IN UNIT COUNT                      
         B     TOUNITX             AND DONE                                     
*                                                                               
*                                  ELSE LOOK FOR ROOM                           
         LHI   R0,10               TRY 10 SPACES                                
*                                                                               
TOUNIT6  DS    0H                                                               
         EX    R2,*+8                                                           
         B     *+10                                                             
         CLC   0(0,RF),SPACES                                                   
         BE    TOUNIT8                                                          
         LA    RF,1(RF)                                                         
         BCT   R0,TOUNIT6                                                       
*                                                                               
         L     RF,ADUNITS                                                       
         LA    RF,132(RF)          ON TO NEXT LINE                              
         B     TOUNIT3                                                          
*                                                                               
TOUNIT8  DS    0H                                                               
         EX    R2,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RF),0(RE)                                                    
*                                                                               
TOUNITX  J     XIT                                                              
         SPACE 2                                                                
         LTORG                                                                  
         TITLE 'PRTADJ - PRINT ADJUSTMENTS'                                     
PRTADJ   NMOD1 0,PRTADJ                                                         
         LA    RC,SPACEND                                                       
*                                                                               
         ST    R3,SAVBRK           SAVE A(BREAK)                                
         CLI   PASSNO,1            ONLY PASS 1                                  
         BNE   PAX                                                              
         CLC   SAVBRK,AINVBRK      IF INVOICE BREAK                             
         BE    PA2                                                              
         CLI   FORMAT,10           IF ORDERED ONLY FORMAT  PRINT                
         BH    PAX                 ADJUSTMENT ONLY IF END OF INVOICE            
*                                                                               
         ZIC   RF,NDUES            COUNT NO OF DUE LINES PRINTED                
         AHI   RF,1                                                             
         STC   RF,NDUES                                                         
         B     PA3                                                              
*                                                                               
PA2      DS    0H                                                               
         MVI   DUESW,C'Y'          SET HAVE PRINTED AMOUNT DUE                  
         CLI   FORMAT,10           IF FORMAT 11+ (ORDERED ONLY)                 
         BNH   PA3                                                              
         BRAS  RE,LSTINV           NEED PREVIOUS BILLING                        
*                                                                               
PA3      DS    0H                                                               
         MVI   PRSW,C'H'           SET TO HOLD PRINT LINES                      
         L     R7,BRKCODE                                                       
         L     R7,ATOTS(R7)        POINT TO ACCUMULATOR                         
         LR    R4,R7                                                            
         AHI   R4,TOTSIZE-BFORML   POINT TO FORMULA                             
         AHI   R7,MAXMOS*ROWL      POINT TO TOTAL ROW                           
         LA    R0,PAWKROW          A(DESTINATION)                               
         LA    R1,ROWL             LENGTH                                       
         LR    RE,R7               A(SOURCE)                                    
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
*                                                                               
         LA    R1,PAWKROW          CLEAR FIRST SET FOR TOTALS                   
         LA    RF,ROWTL(R1)                                                     
         BRAS  RE,ZAPSTR                                                        
         LHI   R2,NCTYPS                                                        
*                                                                               
PA3A00   DS    0H                                                               
         LA    R6,PAWKROW                                                       
*                                  ADD OTHER COST TYPES                         
         LHI   R0,ROWTL/ACCUMLQ                                                 
PA3A0    DS    0H                                                               
         AP    0(ACCUMLQ,R6),0(ACCUMLQ,R7)   ACCUM TOTAL AMONG CTYPES           
         LA    R7,ACCUMLQ(R7)                   IN PAWKROW                      
         LA    R6,ACCUMLQ(R6)                                                   
         BCT   R0,PA3A0                                                         
*                                                                               
         BCT   R2,PA3A00           NEXT COST TYPE                               
*                                                                               
         LA    R7,PAWKROW                                                       
*                                                                               
         USING BFORMD,R4                                                        
         LA    R2,P                                                             
         CLI   FORMAT,8                                                         
         BE    *+12                                                             
         CLI   FORMAT,11                                                        
         BNE   *+8                                                              
         SHI   R2,16          SHIFT SINGLE COLUMN FORMATS LEFT 1 COLUMN         
         USING ALINED,R2                                                        
         CLC   SAVBRK,AINVBRK      IF AT END OF INVOICE                         
         BNE   *+12                                                             
         CLI   NDUES,1             AND EXACTLY 1 DUE LEVEL PRINTED              
         BE    PA20                DO NOT REPEAT FORMULA                        
*                                  STATE BASIS IF NOT ON BILL                   
         CLI   BFBAS,X'FF'                                                      
         BE    PA20                UNEQUAL BASES                                
         CLI   GNSW,C'G'           GROSS                                        
         BNE   *+16                                                             
         TM    BFBAS,X'10'         AND GROSS                                    
         BZ    PA8                 OK                                           
         B     *+12                                                             
         TM    BFBAS,X'10'                                                      
         BNZ   PA8                 NET AND NET OK                               
*                                                                               
*                                  BASIS NOT ON BILL                            
         MVC   ALCOL4-11(10),=C'NET AMOUNT'                                     
         LA    R5,ACCUMLQ(R7)                                                   
         TM    BFBAS,X'10'                                                      
         BNZ   *+12                                                             
         MVC   ALCOL4-13(12),=C'GROSS AMOUNT'                                   
         LR    R5,R7                                                            
*                                                                               
         MVC   MYPACKED,0(R5)                                                   
         SP    MYPACKED,ROWHL(ACCUMLQ,R5)                                       
         EDIT  MYPACKED,(16,ALCOL4),2,COMMAS=YES,CR=YES                         
         MVI   148(R2),0                                                        
         LA    R2,L'P*2(R2)        POINT PAST 2 PRINT LINES                     
*                                                                               
*                             PRINT ADJUSTMENT LINE                             
*                             LESS (PLUS) XX.XXXX PERCENT OF GROSS(NET)         
*                                                                               
PA8      DS    0H                                                               
         OC    BFCOMP,BFCOMP       NO ADJUSTMENT PERCENT                        
         BZ    PA20                                                             
         CP    ADJDSP(ACCUMLQ,R7),=P'0'   NO ADJUSTMENT AMOUNT                  
         BE    PA20                                                             
         CLI   ADJSEP,C'Y'         ADJUSTMENT ON SEPARATE INVOICE               
         BE    PA20                                                             
*                                                                               
         MVC   W,SPACES                                                         
         MVC   BYTE,BFCOMP         USE SIGN OF FORMULA                          
         CLC   BFCOMP,FFS          UNLESS UNEQUAL FORMULAS                      
         BNE   *+10                                                             
         MVC   BYTE,ADJDSP(R7)     THEN USE SIGN OF ADJUSTMENT AMOUNT           
*                                                                               
         MVC   W(4),=C'LESS'                                                    
         TM    BYTE,X'80'                                                       
         BNZ   *+10                                                             
         MVC   W(4),=C'PLUS'                                                    
*                                                                               
         CLI   PROFB2B,C'Y'        SEE IF TO SAY JUST 'COMMISSION'              
         BE    PA8C                                                             
*                                                                               
         CLC   BFCOMP,FFS                                                       
         BNE   PA8D                                                             
         MVC   W+5(10),=C'ADJUSTMENT'                                           
         B     PA12                                                             
*                                                                               
PA8C     DS    0H                                                               
         MVC   W(17),=C'COMMISSION AMOUNT'                                      
         B     PA12                                                             
*                                                                               
PA8D     DS    0H                                                               
         EDIT  (B4,BFCOMP),(8,W+5),4                                            
*                                                                               
         LA    RF,W+11                                                          
PA9      DS    0H                                                               
         CLI   0(RF),C'0'                                                       
         BNE   *+12                                                             
         MVI   0(RF),C' '                                                       
         BCT   RF,PA9                                                           
*                                                                               
         CLI   0(RF),C'.'                                                       
         BNE   *+10                                                             
         MVI   0(RF),C' '                                                       
         BCTR  RF,0                                                             
*                                                                               
         MVC   2(10,RF),=C'PERCENT OF'                                          
         MVC   13(3,RF),=C'NET'                                                 
         SR    R0,R0                                                            
         TM    BFBAS,X'01'                                                      
         BNZ   *+14                                                             
         MVC   13(5,RF),=C'GROSS'                                               
         LHI   R0,2                                                             
*                                                                               
*                              SEE IF NEED TAX IN ADJUSTMENT EXPRESSION         
         CLI   TAXOPT,C'N'                                                      
         BE    PA12                                                             
         MVC   MYPACKED,ACMORD2-ACMORDG(R7) ORDERED TX - BILLED TX              
         SP    MYPACKED,ROWHL+ACMBIL2-ACMBILG(ACCUMLQ,R7)                       
         BZ    PA12                NO TAX                                       
         AR    RF,R0                                                            
         MVC   17(10,RF),=C'(LESS TAX)'                                         
*                                                                               
PA12     DS    0H                                                               
         LA    RF,W+40                                                          
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         LA    R0,W                                                             
         SR    RF,R0               RF = LENGTH - 1                              
         LA    RE,ALCOL4-2                                                      
         SR    RE,RF                                                            
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RE),W                                                        
*                                                                               
         CLI   CTYPCTL,C'T'        IF COST TYPES TOGETHER                       
         BNE   PA13                                                             
         CLI   FORMBOPT,C'T'       TEST FORMULA BASIS                           
         BNE   *+14                                                             
         MVC   132(19,RE),=C'(TIME CHARGES ONLY)'                               
         B     PA13                                                             
*                                                                               
         CLI   FORMBOPT,C'I'                                                    
         BNE   *+14                                                             
         MVC   132(35,RE),=C'(TIME AND INTEGRATION CHARGES ONLY)'               
         B     PA13                                                             
*                                                                               
PA13     DS    0H                                                               
         MVC   MYPACKED,ADJDSP(R7)                                              
         EDIT  MYPACKED,(16,ALCOL4),2,COMMAS=YES,CR=YES                         
         MVI   148(R2),0                                                        
         LA    R2,L'P*2(R2)        POINT PAST 2 PRINT LINES                     
*                                                                               
*                                  PRINT AMOUNT DUE                             
PA20     DS    0H                                                               
         CLC   SAVBRK,AINVBRK                                                   
         BE    PA22                                                             
         LA    R0,P                IF NOT END OF INVOICE                        
         CR    R2,R0               AND NO ADJUSTMENT OR SPECIAL BASE            
         BH    PA22                                                             
         CLI   SCBNCSW,C'C'        AND NOT SEPARATE COMMISSION                  
         BNE   PA27C               DON'T PRINT DUE                              
*                                                                               
PA22     DS    0H                                                               
         MVC   MYPACKED,DUEDSP(R7) DUE                                          
         CLI   ADJSEP,C'Y'         IF ADJUSTMENT ON SEPARATE INVOICE            
         BNE   *+16                                                             
         MVC   DUB,ADJDSP(R7)      THEN PRINT DUE +/- ADJ. HERE                 
         SP    MYPACKED,DUB                                                     
         EDIT  MYPACKED,(16,ALCOL4),2,COMMAS=YES,CR=YES                         
*                                                                               
         MVC   W,SPACES                                                         
         CP    MYPACKED,=P'0'      AMOUNT DUE POSITIVE OR NEGATIVE?             
         BL    PA26                                                             
*                                                                               
         MVC   W(16),=C'** AMOUNT DUE **'                                       
         CLI   SCBNCSW,C'C'        UNLESS SCB SEPARATE COMMISSION               
         BNE   *+10                                                             
         MVC   W(18),=C'** TOTAL AMOUNT **'  THEN TOTAL AMOUNT                  
*                                                                               
         CLC   SAVBRK,AINVBRK                                                   
         BE    PA27                                                             
         CLI   SCBNCSW,C'C'        UNLESS SCB SEPARATE COMMISSION               
         BE    *+20                                                             
         MVC   W(15),=C'AMOUNT DUE FOR '                                        
         MVC   W+15(L'TOTNAME),TOTNAME    LEVEL NAME                            
         B     PA27                                                             
*                                                                               
         MVC   W,SPACES                                                         
         MVC   W(9),=C'TOTAL FOR'                                               
         MVC   W+10(L'TOTNAME),TOTNAME                                          
         B     PA27                                                             
*                                                                               
PA26     DS    0H                                                               
         MVC   W(19),=C'** CREDIT AMOUNT **'                                    
         CLC   SAVBRK,AINVBRK                                                   
         BE    PA27                                                             
         MVC   W(18),=C'CREDIT AMOUNT FOR '                                     
         MVC   W+18(L'TOTNAME),TOTNAME    LEVEL NAME                            
*                                                                               
PA27     DS    0H                                                               
         LA    RF,W+32                                                          
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         LA    R0,W                                                             
         SR    RF,R0               RF = LENGTH - 1                              
         LA    RE,ALCOL4-2                                                      
         SR    RE,RF               RE = TO ADDRESS                              
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RE),W                                                        
         LR    R0,RE                                                            
         SR    R0,R2                                                            
         ST    R0,WORD             SAVE DISPLACEMENT                            
         CLI   TAXOPT,C'N'                                                      
         BE    PA27A8                                                           
         MVC   MYPACKED,ACMORD2-ACMORD(R7)             ORDERED TAX              
         SP    MYPACKED,ROWHL+ACMBIL2-ACMBIL(ACCUMLQ,R7) - BILLED TAX           
         BZ    PA27A8                                                           
*                                  TAX DISPLAY                                  
         LR    R5,RE                                                            
         SHI   R5,24                                                            
         MVC   0(9,R5),=C'SALES TAX'                                            
*                                                                               
         EDIT  MYPACKED,(12,11(R5)),2,COMMAS=YES,CR=YES,FLOAT=$,       +        
               ALIGN=LEFT                                                       
*                                                                               
PA27A8   DS    0H                                                               
         LA    R2,L'P(R2)          POINT TO NEXT PRINT LINE                     
*                                  RETAIL BILLING SHARES                        
*                                                                               
         CLI   SCBNCSW,C'C'        FOR SCB COMMISSION BILLING                   
         BNE   PA27C                                                            
*                                  SUBTRACT NET                                 
         L     R3,WORD             POSITION IN LINE                             
         AR    R3,R2                                                            
         MVC   0(8,R3),=C'LESS NET'                                             
         MVC   MYPACKED,ACCUMLQ(R7) ORDERED NET                                 
         SP    MYPACKED,ROWHL+ACCUMLQ(ACCUMLQ,R7)  - PREV BILLED NET            
         EDIT  MYPACKED,(16,ALCOL4),2,COMMAS=YES,CR=YES                         
         LA    R2,L'P(R2)                                                       
*                                                                               
         MVC   W,SPACES                                                         
         MVC   W(16),=C'** AMOUNT DUE **'                                       
*                                                                               
         L     R3,WORD                                                          
         AR    R3,R2                                                            
         MVC   0(L'W,R3),W                                                      
         MVC   MYPACKED,DUEDSP(R7) AMOUNT DUE                                   
         SP    MYPACKED,ACCUMLQ(ACCUMLQ,R7) LESS NET                            
         AP    MYPACKED,ROWHL+ACCUMLQ(ACCUMLQ,R7) (+ PREV BILLED NET)           
         EDIT  MYPACKED,(16,ALCOL4),2,COMMAS=YES,CR=YES = COMMISSION            
         LA    R2,L'P(R2)          POINT TO NEXT PRINT LINE                     
*                                                                               
PA27C    DS    0H                                                               
         CLC   SAVBRK,AINVBRK      IF AT END OF INVOICE                         
         BNE   PA27N                                                            
         SHI   R2,L'P              SAVE AMOUNT DUE PRINT LINE                   
         L     RF,=A(SVAMTDUE)                                                  
         MVC   0(L'P,RF),0(R2)                                                  
         LA    R2,L'P(R2)                                                       
*                                                                               
PA27N    DS    0H                                                               
         LA    R0,P                                                             
         CR    R2,R0               ANYTHING TO PRINT?                           
         BNH   PAX                 NO                                           
*                                                                               
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
*                                                                               
         GOTO1 ABILLEDI,DMCB,('EDMDUE',(R4)),(R7),(R6)   EDI CALL               
*                                                                               
*                                  SEE IF LIST OF PREVIOUS                      
*                                  BILLS NEEDED  (FOR INFORMATION ONLY)         
         CLC   SAVBRK,AINVBRK                                                   
         BNE   PAX                                                              
*                                                                               
         ZAP   MYPACKED,=P'0'                                                   
         ICM   R0,15,TRDTABN       ARE WE DOING TRADE ?                         
         BZ    PA27S                                                            
         L     R1,ATRDTAB          A(TABLE)                                     
         USING TRADETD,R1                                                       
PA27P    CLI   BFBAS,0             IF NOT GROSS BASIS, NO BILFORM               
         BNE   *+14                                                             
         AP    MYPACKED,TRDDUE                                                  
         B     *+16                                                             
*                                                                               
         AP    MYPACKED,TRDOTIME   ADD UP DOLLARS W/OUT BILFORM                 
         SP    MYPACKED,TRDBTIME                                                
*                                                                               
         LA    RE,TRDOTIME         POINT TO FIRST FIELD TO ZAP                  
         LA    RF,TRDAMTSL(RE)     POINT PAST LAST FIELD TO ZAP                 
PA27Q    ZAP   0(ACCUMLQ,RE),=P'0'                                              
         LA    RE,ACCUMLQ(RE)      NEXT AMOUNT                                  
         CR    RE,RF                                                            
         BL    PA27Q                                                            
*                                                                               
         BCT   R0,PA27P                                                         
         LA    R2,P                                                             
*        MVC   ALCOL4-22(21),=C'TRADE CREDIT UTILIZED'                          
         MVC   0(21,R2),=C'TRADE CREDIT UTILIZED'                               
         EDIT  MYPACKED,(16,ALCOL1),2,COMMAS=YES,CR=YES                         
         MVI   148(R2),0                                                        
         LA    R2,L'P(R2)                                                       
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
*                                                                               
PA27S    CLI   FORMAT,10                                                        
         BH    PAX                                                              
*******  CLI   LSTOPT,C'Y'                                                      
*******  BE    *+12                                                             
*******  CLI   LSTOPT,C'R'                                                      
*******  BNE   PAX                                                              
         CLI   LSTOPT,C'N'                                                      
         BE    PAX                                                              
         BRAS  RE,LSTINV                                                        
         DROP  R4                                                               
*                                                                               
PAX      DS    0H                                                               
         MVI   PRSW,C'F'           SET TO FLUSH LINES                           
         BRAS  RE,PRNT                                                          
*                                                                               
         J     XIT                                                              
         DROP  R2                                                               
         EJECT                                                                  
         LTORG                                                                  
         SPACE 3                                                                
SVAMTDUE DS    CL132                                                            
PAWKROW  DS    XL(ROWL)                                                         
         EJECT                                                                  
         TITLE 'ADJINV - PRINT ADJUSTMENT INVOICE'                              
ADJINV   NMOD1 0,ADJINV                                                         
         LA    RC,SPACEND                                                       
*                                                                               
         CLI   SCBNCSW,C'C'        IF SCB TYPE SEPARATE COMMISSION              
         BE    AIXNO               NO OLD-STYLE SEPARATE ADJ. BILL              
*                                                                               
         L     R7,BRKCODE                                                       
         L     R7,ATOTS(R7)        POINT TO ACCUMULATOR                         
         LR    RF,R7                                                            
         AHI   RF,TOTSIZE-BFORML                                                
         MVC   X(5),0(RF)          HOLD FORMULA IN X                            
         AHI   R7,MAXMOS*ROWL      POINT TO TOTAL ROW                           
         CP    ADJDSP(ACCUMLQ,R7),=P'0'   NO ADJUSTMENT                         
         BE    AIXNO                                                            
*                                                                               
         MVI   FORCEHED,C'Y'                                                    
         MVC   PAGE,=H'1'                                                       
         MVC   MYPACKED,DUEDSP(R7) 'DUE' FROM LAST INVB                         
         SP    MYPACKED,ADJDSP(ACCUMLQ,R7) LESS ADJUSTMENT= TRUE BILLED         
         MVI   DUESW,C'A'                                                       
*                                                                               
         LA    R2,P                                                             
         USING ALINED,R2                                                        
         MVC   P+34(24),=C'AMOUNT BILLED ON INVOICE'                            
         MVC   P+34+25(L'SPINVNO),SPINVNO                                       
         GOTOR GETNUM,DMCB,INVNO,PINVNO      GET NEXT BILL NO.                  
         EDIT  MYPACKED,(16,ALCOL4),2,COMMAS=YES,CR=YES                         
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
*                                  NEED COMMISSION BASIS?                       
         CLI   FORMBOPT,C'A'       YES IF NOT BASED ON ALL CHARGE TYPES         
         BNE   AI2D                                                             
         CLC   X+1(4),FFS                                                       
         BE    AI4                                                              
         PACK  BYTE,X(1)                                                        
         CLC   BYTE,X              OR IF NOT SAME AS 'DUE'                      
         BE    AI4                                                              
*                                  MUST STATE COMMISSION BASIS                  
AI2D     DS    0H                                                               
         MVC   ALCOL4-11(10),=C'NET AMOUNT'                                     
         LA    R5,ACCUMLQ(R7)                                                   
         TM    X,X'01'                                                          
         BNZ   *+12                                                             
         MVC   ALCOL4-13(12),=C'GROSS AMOUNT'                                   
         LR    R5,R7                                                            
*                                                                               
         ZAP   MYPACKED,=P'0'                                                   
         LHI   R1,NCTYPS           BCT THRU COST TYPES                          
         CLI   FORMBOPT,C'A'       ALL COST TYPES                               
         BE    AI3B                                                             
         LHI   R1,2                TIME AND INT                                 
         CLI   FORMBOPT,C'I'                                                    
         BE    AI3B                                                             
         LHI   R1,1                TIME ONLY                                    
*                                                                               
AI3B     DS    0H                                                               
         AP    MYPACKED,0(ACCUMLQ,R5)                                           
         SP    MYPACKED,ROWHL(ACCUMLQ,R5)                                       
         LA    R5,ROWTL(R5)                                                     
         BCT   R1,AI3B                                                          
*                                                                               
         EDIT  MYPACKED,(16,ALCOL4),2,COMMAS=YES,CR=YES                         
*                                                                               
         CLI   CTYPCTL,C'T'        IF COST TYPES TOGETHER                       
         BNE   AI3F                                                             
         CLI   FORMBOPT,C'T'       IS BASIS TIME ONLY                           
         BNE   *+14                                                             
         MVC   P2+34(19),=C'(TIME CHARGES ONLY)'                                
         B     AI3F                                                             
*                                                                               
         CLI   FORMBOPT,C'I'       IS BASIS TIME AND INT                        
         BNE   *+10                                                             
         MVC   P2+34(35),=C'(TIME AND INTEGRATION CHARGES ONLY)'                
*                                                                               
AI3F     DS    0H                                                               
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
*                                                                               
AI4      DS    0H                                                               
         MVC   W,SPACES                                                         
         MVC   W(21),=C'COMMISSION ADJUSTMENT'                                  
         CLC   X+1(4),FFS                                                       
         BE    AI6                                                              
*                                                                               
         LA    R6,W+23                                                          
         TM    X+1,X'80'                                                        
         BZ    *+12                                                             
         MVI   0(R6),C'-'                                                       
         LA    R6,1(R6)                                                         
         EDIT  (B4,X+1),(7,0(R6)),4                                             
         LA    RF,6(R6)                                                         
*                                                                               
AI5      DS    0H                                                               
         CLI   0(RF),C'0'                                                       
         BNE   *+12                                                             
         MVI   0(RF),C' '                                                       
         BCT   RF,AI5                                                           
*                                                                               
         CLI   0(RF),C'.'                                                       
         BNE   *+10                                                             
         MVI   0(RF),C' '                                                       
         BCTR  RF,0                                                             
*                                                                               
         LA    RE,W+22                                                          
         CLI   W+23,C' '                                                        
         BH    *+8                                                              
         LA    RE,W+23                                                          
         MVI   0(RE),C'('                                                       
         MVC   2(17,RF),=C'PERCENT OF ABOVE)'                                   
*                                                                               
AI6      DS    0H                                                               
         LA    RF,W+50                                                          
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         LA    R0,W                                                             
         SR    RF,R0               RF = LENGTH OF STRING - 1                    
         LA    RE,ALCOL4-2                                                      
         SR    RE,RF                                                            
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RE),W                                                        
*                                                                               
         MVC   MYPACKED,ADJDSP(R7)  ADJUSTMENT AMOUNT                           
         EDIT  MYPACKED,(16,ALCOL4),2,COMMAS=YES,CR=YES                         
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
*                                                                               
         MVC   ALCOL3-2(16),=C'** AMOUNT DUE **'                                
         MVC   MYPACKED,ADJDSP(R7)                                              
         CP    MYPACKED,=P'0'                                                   
         BNL   *+10                                                             
         MVC   ALCOL3-2(19),=C'** CREDIT AMOUNT **'                             
         EDIT  MYPACKED,(16,ALCOL4),2,COMMAS=YES,CR=YES                         
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
*                                                                               
         LA    R4,X                                                             
         GOTO1 ABILLEDI,DMCB,('EDMDUE',(R4)),(R7)                               
*                                                                               
         MVI   PUMODE,C'E'         USER FIELDS - END OF BILL                    
         BRAS  RE,PRTUSER          USER FIELDS                                  
         BRAS  RE,BILLBOX                                                       
         BRAS  RE,WOBILL                                                        
         GOTO1 ABILLEDI,DMCB,('EDMEND',0)   EDI CALL                            
*                                                                               
         CLI   OUTMODE,C'W'        IF WORKER FILE MODE                          
         BNE   AI8                                                              
         GOTO1 ABILLEDI,DMCB,('EDMCLS',0)  CLOSE                                
*                                                                               
AI8      DS    0H                                                               
         B     AIXYES                                                           
         DROP  R2                                                               
*                                                                               
AIXNO    J     NO                  CC NOT =, NO ADJUSTMENT                      
*                                                                               
AIXYES   J     YES                 CC =, HAVE ADJUSTMENT                        
         SPACE 2                                                                
         LTORG                                                                  
         TITLE 'AORINV - AOR INVOICE'                                           
AORINV   NMOD1 0,AORINV                                                         
         LA    RC,SPACEND                                                       
*                                                                               
         CLI   AORSW,C'Y'          DOING AOR?                                   
         BNE   AOIXNO              NO, EXIT                                     
         CLI   SCBNCSW,C'N'        SCB SEPARATE COMM. MODE NET BILL?            
         BE    AOIXNO              SKIP AOR                                     
         CLI   AORLOPT,C'N'        OPTION TO LIST PRODUCT/ESTIMATE/MOS          
         BNE   AOI20               DETAILS ON AOR INVOICE                       
*                                                                               
         L     R7,BRKCODE                                                       
         L     R7,ATOTS(R7)        POINT TO ACCUMULATOR                         
         LR    RF,R7                                                            
         AHI   RF,TOTSIZE-BFORML                                                
         MVC   X(BFORML),0(RF)     SET FORMULA AND AOR PCT                      
         AHI   R7,MAXMOS*ROWL      POINT TO TOTAL ROW                           
*                                                                               
*                                  NOTE- HAVE REPLACED SIMPLE TEST              
*                                        FOR ANY AOR TOTAL WITH                 
*                                        PASS THROUGH PEPTAB LOOKING            
         ICM   R6,15,PEPTABN             FOR ANY AOR ACCTS                      
         BZ    AOIXNO                                                           
         L     RF,APEPTAB                                                       
         USING PEPTD,RF                                                         
*                                                                               
AOI3     DS    0H                                                               
         OC    PEPTAORA,PEPTAORA   ANY ACCOUNT (NOT AMOUNT)?                    
         BNZ   AOI4                YES, DO AOR BILL                             
*                                                                               
         LA    RF,PEPTABRL(RF)                                                  
         BCT   R6,AOI3                                                          
         B     AOIXNO                                                           
         DROP  RF                                                               
*                                                                               
AOI4     DS    0H                                                               
         MVI   FORCEHED,C'Y'                                                    
         MVC   PAGE,=H'1'                                                       
         MVI   DUESW,C'R'                                                       
*                                                                               
         LA    R2,P                                                             
         USING ALINED,R2                                                        
*                                                                               
         MVC   P+24(44),=C'**     AGENCY OF RECORD FEE FOR AMOUNT    **+        
               '                                                                
         MVC   P2+24(44),=C'** BILLED TO CLIENT ON INVOICE NN-NN-NNNN *+        
               *'                                                               
         MVC   P2+24+31(L'SPINVNO),SPINVNO                                      
         GOTOR GETNUM,DMCB,INVNO,PINVNO      GET NEXT BILL NO.                  
*                                                                               
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
*                                                                               
         MVC   P+31(31),=C'MEDIA GROSS FROM CLIENT INVOICE'                     
*                                                                               
         LR    R5,R7                                                            
         ZAP   MYPACKED,=P'0'                                                   
         LHI   R1,NCTYPS           BCT THRU COST TYPES                          
         CLI   PROFB2A+6,C'Y'      APPLYING % ONLY TO TIME ?                    
         BNE   *+8                                                              
         LHI   R1,1                                                             
*                                                                               
AOI5D    DS    0H                                                               
         AP    MYPACKED,0(ACCUMLQ,R5)                                           
         SP    MYPACKED,ROWHL(ACCUMLQ,R5)                                       
         LA    R5,ROWTL(R5)                                                     
         BCT   R1,AOI5D                                                         
*                                                                               
         LA    R1,ALCOL4                                                        
         EDIT  MYPACKED,(16,0(R1)),2,COMMAS=YES,CR=YES                          
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
*                                                                               
         CLC   (BFAORPCT-BFORMD)+X,FFS        IF MIXED PCTS, SKIP               
         BE    AOI7                                                             
         MVC   W,SPACES                                                         
         LA    R4,W                                                             
*                                                                               
         SR    R0,R0                                                            
         ICM   R0,B'1110',X+BFAORPCT-BFORMD                                     
         SRA   R0,8                                                             
         EDIT  (R0),(8,0(R4)),4,ALIGN=LEFT                                      
         CLC   5(2,R4),=C'00'                                                   
         BNE   *+14                                                             
         MVC   5(2,R4),=C'  '                                                   
         SHI   R0,2                                                             
         CLC   5(2,R4),=C'00'                                                   
         BNE   *+14                                                             
         MVC   5(2,R4),=C'  '                                                   
         SHI   R0,2                                                             
*                                                                               
         AR    R4,R0                                                            
         MVC   1(12,R4),=C'PCT OF ABOVE'                                        
         MVC   ALCOL4-25(24),W                                                  
*                                                                               
AOI7     DS    0H                                                               
         MVC   MYPACKED,AORDSP(R7) AOR AMOUNT                                   
         LA    R1,ALCOL4                                                        
         EDIT  MYPACKED,(16,0(R1)),2,COMMAS=YES,CR=YES                          
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
*                                                                               
         BRAS  RE,BILLBOX                                                       
         BRAS  RE,WOBILL                                                        
*                                                                               
         B     AOIXYES                                                          
         EJECT                                                                  
***********************************************************************         
*        PRODUCT/ESTIMATE/MOS LISTING ON AOR BILLS                              
***********************************************************************         
         SPACE 1                                                                
AOI20    DS    0H                                                               
         MVI   AORFRST,C'Y'                                                     
         CLI   AORLOPT,C'C'        IF CLIENT LEVEL AOR RECAP                    
         BNE   *+12                                                             
         CLI   AORLCTL,C'P'        AND NOT PRINT MODE                           
         BNE   AOIXNO              DO NOTHING NOW                               
*                                                                               
         ICM   R6,15,PEPTABN       SORT PEPTAB ON AOR ACCT                      
         BZ    AOIXNO                                                           
         L     R7,APEPTAB                                                       
         USING PEPTD,R7                                                         
         GOTO1 XSORT,DMCB,(R7),(R6),PEPTABRL,L'PEPTAORA,               +        
               PEPTAORA-PEPTD                                                   
*                                                                               
         XC    LASTAORA,LASTAORA                                                
         MVI   HAVAOR,C'N'                                                      
*                                                                               
AOI30    DS    0H                                                               
         OC    PEPTAORA,PEPTAORA   SKIP IF NO AOR ACCOUNT                       
         BZ    AOI70                                                            
         CLC   PEPTAORA,LASTAORA   NEW AOR ACCT = NEW BILL                      
         BE    AOI60                                                            
*                                                                               
*                                  FINISH UP OLD BILL                           
AOI40    DS    0H                                                               
         OC    LASTAORA,LASTAORA   NOT IF FIRST TIME                            
         BZ    AOI44                                                            
         BRAS  RE,PRNT                                                          
         MVC   ALCOL1+8(7),=C'TOTALS*'                                          
         MVC   MYPACKED,X          HOW IT GOT SET??                             
         LA    R1,ALCOL2                                                        
         EDIT  MYPACKED,(16,0(R1)),2,COMMAS=YES,CR=YES                          
         MVC   MYPACKED,X+ACCUMLQ*2 TOTAL AOR                                   
         LA    R1,ALCOL4                                                        
         EDIT  MYPACKED,(16,0(R1)),2,COMMAS=YES,CR=YES                          
         BRAS  RE,PRNT                                                          
         BRAS  RE,NCPROC                                                        
         BRAS  RE,BILLBOX                                                       
         MVI   HAVAOR,C'Y'                                                      
         DROP  R2                                                               
*                                                                               
AOI44    DS    0H                                                               
         LTR   R6,R6               END OF TABLE                                 
         BNP   AOI80                                                            
*                                                                               
*                                  START NEW BILL                               
         MVC   LASTAORA,PEPTAORA                                                
         MVI   FORCEHED,C'Y'                                                    
         MVC   PAGE,=H'1'                                                       
         MVI   DUESW,C'R'                                                       
         XC    X,X                 CLEAR TOTALS                                 
         LA    R1,X                                                             
         LA    RF,ROWTL(R1)                                                     
         BRAS  RE,ZAPSTR           ZAP AMOUNTS                                  
*                                                                               
         LA    R2,P                                                             
         USING ALINED,R2                                                        
*                                  SET AOR ADDRESS                              
         MVC   AREC,=A(STABUCKC)   USE STATION BUCKET AREA                      
         MVC   KEY+14(L'PEPTAORD),PEPTAORD  DISK ADDRESS                        
         GOTO1 GET                                                              
         L     RF,AREC                                                          
         USING AORREC,RF                                                        
*                                                                               
         LA    R1,AORELS                                                        
*                                                                               
AOI52    DS    0H                                                               
         CLI   0(R1),X'02'         ADDRESS ELEMENT                              
         BE    AOI53                                                            
         CLI   0(R1),0             EOR                                          
         BE    AOI55                                                            
*                                                                               
         ZIC   R0,1(R1)                                                         
         AR    R1,R0                                                            
         B     AOI52                                                            
*                                                                               
AOI53    DS    0H                  AOR ADDRESS ELEMENT                          
         USING AORADREL,R1                                                      
         MVC   AORADR1(L'AORLIN1),AORLIN1                                       
         MVC   AORADR2(L'AORLIN2),AORLIN2                                       
         MVC   AORADR3(L'AORLIN3),AORLIN3                                       
         MVC   AORADR4(L'AORLIN4),AORLIN4                                       
         CLC   PEPTAORA,AORLIN1    IF CODE = NAME DON'T PRINT IT                
         BE    *+10                                                             
         MVC   AORADR5+L'AORADR5-L'PEPTAORA(L'PEPTAORA),PEPTAORA                
         DROP  RF                                                               
         DROP  R1                                                               
*                                                                               
AOI55    DS    0H                                                               
         MVC   P+2(31),=C'** AGENCY OF RECORD PAYMENTS **'                      
         CLI   AORLOPT,C'C'        CLIENT LEVEL RECAP                           
         BE    *+16                                                             
         MVC   P+2+29(37),=C'- CLIENT INVOICE NUMBER NN-NN-NNNN **'             
         MVC   P+2+53(L'SPINVNO),SPINVNO                                        
         CLI   AORLOPT,C'C'        FOR CLIENT RECAP MODE                        
         BNE   *+12                                                             
         CLI   AORFRST,C'Y'        AND FIRST TIME                               
         BE    AOI56               ALREADY HAVE NEW INVOICE NUMBER              
         GOTOR GETNUM,DMCB,INVNO,PINVNO      GET NEXT BILL NO.                  
*                                                                               
AOI56    DS    0H                                                               
         MVI   AORFRST,C'N'                                                     
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
*                                                                               
AOI60    DS    0H                  CONTINUE BILL                                
         MVC   PEPTAORI,INVNO      SET INVOICE NUMBER IN PEPTAB                 
***      ZIC   RF,PEPTPRD          PRODUCT                                      
***      MHI   RF,4                                                             
***      L     RE,VCLIST                                                        
***      LA    R4,0(RE,RF)                                                      
*                                                                               
         L     RF,ADCLT                                                         
         MVC   KEY(13),0(RF)                                                    
         MVC   KEY+4(3),PEPTPRD    3-CHAR PRODUCT CODE                          
         L     RF,ADPRD                                                         
         CLC   KEY(13),0(RF)       ALREADY HAVE PRDHDR?                         
         BE    AOI62                                                            
         GOTO1 READ                                                             
         GOTO1 GETPRD                                                           
*                                                                               
AOI62    DS    0H                                                               
         L     RF,ADPRD                                                         
         MVC   W,SPACES                                                         
         MVC   W(L'PRD),PRD                                                     
         MVC   W+4(L'PRDNM),PRDNM                                               
         OC    W,SPACES                                                         
         GOTO1 CHOPPER,DMCB,(28,W),(20,P),(C'P',2)                              
*                                                                               
         EDIT  (B1,PEPTEST),(3,ALCOL1+1),FILL=0                                 
         GOTO1 DATCON,DMCB,(3,PEPTMOS),(6,ALCOL1+8)                             
*                                                                               
         AP    X(ACCUMLQ),PEPTAGRS TOTAL GROSS                                  
         AP    X+ACCUMLQ*2(ACCUMLQ),PEPTAOR   AND AOR AMOUNT                    
*                                                                               
         LA    R1,ALCOL2                                                        
         EDIT  PEPTAGRS,(16,0(R1)),2,COMMAS=YES,CR=YES                          
*                                                                               
         LA    R1,ALCOL4                                                        
         EDIT  PEPTAOR,(16,0(R1)),2,COMMAS=YES,CR=YES                           
*                                                                               
         ICM   R0,15,PEPTAORP      AOR PERCENT                                  
         LA    R1,ALCOL3                                                        
         EDIT  (R0),(8,0(R1)),4                                                 
         CLC   6(2,R1),=C'00'                                                   
         BNE   *+10                                                             
         MVC   6(2,R1),SPACES                                                   
         LA    R1,9(R1)                                                         
         MVC   0(5,R1),=C'GROSS'   BASIS                                        
         MVC   MYPACKED,PEPTAGRS                                                
         TM    PEPTAORB,X'F0'      NO BITS MEANS GROSS                          
         BZ    AOI64                                                            
         MVC   0(5,R1),=C'NET  '                                                
         MVC   MYPACKED,PEPTANET                                                
         TM    PEPTAORB,X'40'                                                   
         BNZ   AOI64                                                            
         MVC   0(5,R1),=C'COMM.'                                                
         MVC   MYPACKED,PEPTAGRS                                                
         SP    MYPACKED,PEPTANET                                                
*                                                                               
AOI64    DS    0H                                                               
         LA    R1,ALSTRIP          BASIS AMOUNT IN STRIP                        
         EDIT  MYPACKED,(16,0(R1)),2,COMMAS=YES,CR=YES                          
*                                                                               
         BRAS  RE,PRNT                                                          
*                                                                               
AOI70    DS    0H                  NEXT PEPTAB ENTRY                            
         LA    R7,PEPTABRL(R7)                                                  
         BCT   R6,AOI30                                                         
         B     AOI40               AT END FINISH UP                             
*                                                                               
AOI80    DS    0H                  END                                          
         BRAS  RE,WOBILL                                                        
         MVI   DUESW,C'N'                                                       
         CLI   AORLOPT,C'C'        FOR CLIENT RECAP MODE                        
         BNE   AOI82                                                            
         GOTOR GETNUM,DMCB,INVNO,PINVNO     NEED TO BUMP INVOICE NO.            
*                                                                               
AOI82    DS    0H                                                               
         CLI   HAVAOR,C'Y'         DID WE ACTAULLY DO ANY AOR BILLS             
         BE    AOIXYES                                                          
*                                                                               
AOIXNO   J     NO                                                               
*                                                                               
AOIXYES  J     YES                                                              
         DROP  R7                                                               
         DROP  R2                                                               
         SPACE 2                                                                
         LTORG                                                                  
         TITLE 'BILCALC - CALCULATE AMOUNTS DUE'                                
BILCALC  NMOD1 BILCQ,BILCALC                                                    
         LR    R9,RC               R9 --> BILCD                                 
         USING BILCD,R9                                                         
         LA    RC,SPACEND                                                       
*                                                                               
         CLI   PASSNO,1                                                         
         BE    BC1                                                              
*                                                                               
*              ONLY REDO ADJUSTMENTS ON PASS 2                                  
*              IF DOING ADJSEP WITH DETAIL BACK-UP                              
*           OR IF DOING AORINV WITH DETAIL BACK-UP                              
*                                                                               
         CLI   PASSNO,2                                                         
         BNE   BCX                                                              
         OC    ARECAP,ARECAP                                                    
         BZ    BCX                                                              
         CLI   AORSW,C'Y'                                                       
         BE    BC1                                                              
         CLI   ADJSEP,C'Y'                                                      
         BNE   BCX                                                              
*                                                                               
BC1      DS    0H                                                               
         LA    R1,WORK             HAVE TO ZAP IT                               
         LA    RF,ACMEXTL(R1)                                                   
         BRAS  RE,ZAPSTR                                                        
         L     R7,BRKCODE                                                       
         L     R7,ATOTS(R7)        POINT TO ACCUMULATOR                         
         LR    RF,R7                                                            
         LA    R6,MAXMOS                                                        
         LA    R5,PERLIST                                                       
         USING PERLISTD,R5                                                      
         XC    DUB,DUB                                                          
*                                                                               
BC2      DS    0H                                                               
         CLI   0(R5),0             ACTIVE SLOT?                                 
         BE    BC2A6D                                                           
         LHI   R0,NCTYPS           BCT THRU CHARGE TYPES                        
         LR    R2,RF                                                            
*                                                                               
BC2A2    DS    0H                                                               
         CLC   0(ROW$L,R2),ROWHL(R2)  ANY BALANCE?                              
         BNE   *+16                YES - PROCESS                                
         LA    R2,ROWTL(R2)        NO-TRY NEXT TYPE                             
         BCT   R0,BC2A2                                                         
         B     *+10                                                             
         MVC   DUB(L'PERLMOS),PERLMOS SAVE DATE FOR BILLFORM. EFF. DATE         
*                                                                               
*                                  NOTE-WHOLE BILL EITHER OK OR NOT             
         LR    R1,RF               SAVE RF VALUE                                
         LA    RE,ADJDSP(RF)       POINT TO ADJUSTMENTS                         
         LA    RF,ACMEXTL(RE)                                                   
BC2A6A   CP    0(ACCUMLQ,RE),=P'0' EXIT IF ADJUSTMENTS ALREADY THERE            
         BNE   BCX                 (TOTAL'D UP FROM LOWER LEVEL)                
         LA    RE,ACCUMLQ(RE)                                                   
         CR    RE,RF                                                            
         BL    BC2A6A                                                           
         LR    RF,R1                                                            
         LA    RF,ROWL(RF)                                                      
         LA    R5,PERLISTL(R5)     BUMP DATE                                    
         BCT   R6,BC2                                                           
*                                                                               
BC2A6D   DS    0H                                                               
         OC    DUB,DUB             IF NO BILLABLES                              
         BNZ   *+14                                                             
         SHI   R5,PERLISTL                                                      
         MVC   DUB(L'PERLMOS),PERLMOS USE LAST DATE FOR EFF. DATE CHECK         
         DROP  R5                                                               
*                                                                               
*                                  SET BILLING FORMULA IN W                     
         XC    W,W                                                              
*  DISABLE FOLLOWING CODE FOR NOW                                               
******** OC    MANRVDTP,MANRVDTP   IS THIS A REVERSAL BILL?                     
******** BZ    *+18                                                             
******** BRAS  RE,GETBFBH                                                       
******** MVC   W(5),BFORMBH        YES, GET FORMULA FROM BILL HEADER            
******** B     BC3                                                              
*                                                                               
         CLI   PROFB4A+10,C'Y'     DIFFR BILL FORMS FOR TIME & INT ?            
         BNE   BC2A6F                                                           
         CLI   CTYPCTL,C'S'        FOR NOW TIME & INT ONLY ON SEP INV           
         BE    *+6                                                              
         DC    H'0'                IF NOT DIE                                   
         L     RF,ACTYP                                                         
         CLI   0(RF),TIMEQ         IS IT TIME ?                                 
         BE    BC2AV               YES, USE SFM BILL FORM                       
         B     *+12                OTHERWISE USE NEW FORMULA                    
*                                                                               
BC2A6F   CLI   BFROPT,C'N'         USING BILL FORMULA RECORDS?                  
         BE    BC2AV                                                            
BC2A6H   L     R4,=A(GETBFRW)      SPGETBFR WORK AREA                           
         USING SPGBFRD,R4                                                       
*                                                                               
         MVC   SPGBAM,BAGYMD                                                    
         MVC   SPGBCLT,BCLT                                                     
         L     RF,APRD                                                          
*        ZIC   R1,0(RF)            GET PRODUCT CODE FROM PRODUCT SEQ            
*        MHI   R1,4                                                             
*        L     RF,VCLIST                                                        
*        LA    R1,0(RF,R1)                                                      
         MVC   SPGBPRD,0(RF)       3-CHAR PRODUCT CODE                          
         L     RF,AEST                                                          
         MVC   SPGBEST,0(RF)                                                    
         XC    SPGBMGR,SPGBMGR                                                  
         MVI   SPGBMGR,C'N'        DEFAULT MEDIA TYPE IS 'N'                    
         CLI   QOPT5,C' '          ANY MEDIA TYPE FILTER ?                      
         BNH   *+10                NO, 'N' BY DEFAULT                           
         MVC   SPGBMGR(1),QOPT5    IF YES, USE IT                               
*                                                                               
         CLI   BFRMOS,C'S'         IF DOING BILL FORM SEPARATION                
         BE    *+18                ALWAYS USE PERIOD, NOT REQUEST MOS           
         MVC   SPGBMOS,CURPER      ELSE USE REQUEST MONTH                       
         CLI   PERCTL,C'S'         IF MONTHS NOT SEPARATE                       
         BNE   BC2A7                                                            
*                                                                               
         L     RE,APER             ELSE USE PERIOD                              
         ZIC   RF,0(RE)                                                         
         LA    RF,PERLIST(RF)                                                   
         MVC   SPGBMOS,PERLMOS-PERLISTD(RF)                                     
*                                                                               
BC2A7    DS    0H                                                               
         MVC   SPGBACOM,ACOMFACS                                                
         MVC   SPGBLODR,LOADER                                                  
         GOTO1 ASPGTBFR,DMCB,SPGBFRD                                            
*                                                                               
         MVC   W(L'SPGBFORM),SPGBFORM                                           
         CLI   QOPT5,C' '          DID WE READ FOR MEDIA 'N'?                   
         BH    *+14                YES,                                         
         MVC   QOPT5,MEDFILT       RESTORE, IF DIDN'T CHANGE WON'T HURT         
         B     BC3                 DONE                                         
         OC    W(L'SPGBFORM),W     NO, DID WE GET BILL FORMULA?                 
         BNZ   BC3                                                              
         MVI   QOPT5,C' '          IF NO READ AGAIN FOR MEDIA N                 
         B     BC2A6H                                                           
         DROP  R4                                                               
*                                                                               
BC2AV    DS    0H                                                               
         OC    W(L'ESTFORM),ESTBAS                                              
         BNZ   BC3                                                              
         CLC   DUB(L'EFFDTE),EFFDTE                                             
         BL    BC2B                                                             
         OC    W(L'PRDFORM),PRDBAS                                              
         BNZ   BC3                                                              
BC2B     DS    0H                                                               
         OC    W(L'AAEFORM),AAEBAS                                              
         BNZ   BC3                                                              
         CLC   DUB(L'AAABILDT),AAABILDT                                         
         BL    BC3                                                              
         OC    W(L'AAEFORM),AAABAS                                              
BC3      DS    0H                                                               
         CLI   SCBNCSW,C'N'        FOR NET BILLING IN SCB SITUATION             
         BNE   *+10                                                             
         MVC   W(5),=X'1000000000'   FORMULA IS NET                             
*                                                                               
         LR    RF,R7                                                            
         AHI   RF,TOTSIZE-BFORML                                                
         USING BFORMD,RF                                                        
         MVC   BFORMULA,W          SET FORMULA IN ACCUMULATOR                   
         MVC   BFAORPCT,SVAORPCT+1 SET AOR PCT IN ACCUMULATOR                   
         NI    BFBAS,X'FF'-X'EE'   ONLY X'11' BITS USED HERE                    
         DROP  RF                                                               
*                                                                               
         LA    R5,PERLIST                                                       
         USING PERLISTD,R5                                                      
*                                                                               
         LHI   R6,MAXMOS                                                        
BC4      DS    0H                                                               
         ZAP   BCGRS,=P'0'         CLEAR DERIVED GROSS                          
         ZAP   BCNET,=P'0'         CLEAR DERIVED NET                            
         ZAP   BFMGRS,=P'0'        AND BILL FORMULA BASIS GROSS                 
         ZAP   BFMNET,=P'0'        AND BILL FORMULA BASIS NET                   
         ZAP   BCGRS2,=P'0'        AND GROSS 2 SLOTS                            
         ZAP   BFMGRS2,=P'0'                                                    
         LHI   R0,NCTYPS           BCT THRU CHARGE TYPES                        
         LR    R2,R7                                                            
*                                                                               
BC4A     DS    0H                                                               
         CLC   0(ROW$L,R2),ROWHL(R2)  ANY BALANCE?                              
         BNE   *+16                YES - PROCESS                                
         LA    R2,ROWTL(R2)        NO-TRY NEXT TYPE                             
         BCT   R0,BC4A                                                          
         B     BC8                 NOTHING                                      
*                                                                               
         CLI   W+5,0                                                            
         BNE   *+8                                                              
         MVI   W+5,X'FF'                                                        
* THIS CODE MIGHT NOT BE NEEDED    SET BCGRS,BCNET,BFMGRS,BFMNET                
         MVC   BCGRS,ACCUMLQ(R7)   GROSS HERE FOR SUMMARY PASS                  
         MVC   BCNET,ACCUMLQ*2(R7) NET HERE FOR SUMMARY PASS                    
         MVC   BFMGRS,ACCUMLQ(R7)                                               
         MVC   BFMNET,ACCUMLQ*2(R7)                                             
         MVC   MYPACKED,0(R7)      ACTUAL                                       
*                                                                               
         LHI   R0,NCTYPS           BCT THRU CHARGE TYPES                        
         LR    R2,R7                                                            
         ZAP   MYPACKED,=P'0'                                                   
         ZAP   DUB,=P'0'                                                        
         ZAP   DOUBLE,=P'0'                                                     
*                                                                               
BC5A     DS    0H                                                               
         AP    MYPACKED,0(ACCUMLQ,R2)         GROSS                             
         SP    MYPACKED,ROWHL(ACCUMLQ,R2)                                       
         AP    DUB,ACCUMLQ(ACCUMLQ,R2)        NET                               
         SP    DUB,ROWHL+ACCUMLQ(ACCUMLQ,R2)                                    
         CHI   R0,NCTYPS           FIRST COST TYPE (TIME)?                      
         BE    BC5A4               YES, USE GROSS2                              
*                                                                               
         CHI   R0,NCTYPS-1         2ND COST TYPE (INTEGRATION)?                 
         BNE   BC5A3               YES, CHK IF SMTH FOR GROSS2                  
         CP    ACMORD2-ACMORD(ACCUMLQ,R2),=P'0'                                 
         BNE   BC5A4               IF YES, TREAT SAME AS TIME                   
         CP    ROWHL+ACMORD2-ACMORD(ACCUMLQ,R2),=P'0'                           
         BNE   BC5A4               IF YES, TREAT SAME AS TIME                   
*                                                                               
BC5A3    AP    DOUBLE,0(ACCUMLQ,R2)  ELSE GROSS2 = GROSS                        
         SP    DOUBLE,ROWHL(ACCUMLQ,R2)                                         
         B     BC5A6                                                            
*                                                                               
BC5A4    DS    0H                                                               
         AP    DOUBLE,ACMORD2-ACMORD(ACCUMLQ,R2)  GROSS2 (TIME AND              
         SP    DOUBLE,ROWHL+ACMORD2-ACMORD(ACCUMLQ,R2) POSSIBLY INTEG)          
*                                                                               
BC5A6    DS    0H                                                               
         LA    R2,ROWTL(R2)                                                     
         BCT   R0,BC5A                                                          
*                                                                               
         MVC   BCGRS,MYPACKED                                                   
         MVC   BCNET,DUB                                                        
         MVC   BCGRS2,DOUBLE                                                    
*                                  SET BFMGRS, BFMNET                           
         MVC   BFMGRS,BCGRS        USE TOTAL OF ALL CHARGE TYPES                
         MVC   BFMNET,BCNET                                                     
         MVC   BFMGRS2,BCGRS2                                                   
         CLI   FORMBOPT,C'A'       IF FORMULA BASED ON ALL TYPES                
         BE    BC5D                                                             
         LHI   R0,2                BCT THRU CHARGE TYPES                        
         CLI   FORMBOPT,C'I'       TIME AND INTEGRATION                         
         BE    *+8                                                              
         LHI   R0,1                ELSE TIME ONLY                               
         LR    R2,R7                                                            
         ZAP   MYPACKED,=P'0'                                                   
         ZAP   DUB,=P'0'                                                        
         ZAP   DOUBLE,=P'0'                                                     
*                                                                               
BC5C     DS    0H                                                               
         AP    MYPACKED,0(ACCUMLQ,R2)         GROSS                             
         SP    MYPACKED,ROWHL(ACCUMLQ,R2)                                       
         AP    DUB,ACCUMLQ(ACCUMLQ,R2)        NET                               
         SP    DUB,ROWHL+ACCUMLQ(ACCUMLQ,R2)                                    
         AP    DOUBLE,ACMORD2-ACMORD(ACCUMLQ,R2)        GROSS2                  
         SP    DOUBLE,ROWHL+ACMORD2-ACMORD(ACCUMLQ,R2)                          
*                                                                               
         LA    R2,ROWTL(R2)                                                     
         BCT   R0,BC5C                                                          
*                                                                               
         MVC   BFMGRS,MYPACKED                                                  
         MVC   BFMNET,DUB                                                       
         MVC   BFMGRS2,DOUBLE                                                   
*                                                                               
BC5D     DS    0H                  GET BASIS                                    
         MVC   BCBAS,BCGRS         GROSS                                        
         CLI   COST2SW,C'Y'        FOR COST2                                    
         BNE   *+10                                                             
         MVC   BCBAS,BCGRS2        USE GROSS 2                                  
         TM    W,X'10'                                                          
         BZ    *+10                                                             
         MVC   BCBAS,BCNET         NET                                          
         MVC   MYPACKED,BCBAS                                                   
*                                  CALCULATE ADJUSTMENT                         
         OC    W+1(4),W+1                                                       
         BZ    BC6                 NO ADJUSTMENT                                
         MVC   MYPACKED,BFMGRS     GROSS                                        
         CLI   COST2SW,C'Y'        FOR COST2                                    
         BNE   *+10                                                             
         MVC   MYPACKED,BFMGRS2    USE GROSS2                                   
         TM    W,X'01'                                                          
         BZ    *+10                                                             
         MVC   MYPACKED,BFMNET     NET                                          
*                                                                               
         CLI   TAXOPT,C'N'         SHOWING TAX?                                 
         BE    *+16                *NOTE-NO NETPAK TAX                          
         SP    MYPACKED,ACCUMLQ*2(ACCUMLQ,R7)        LESS TAX                   
         AP    MYPACKED,ROWHL+ACCUMLQ*2(ACCUMLQ,R7)  PLUS BILLED TAX            
*                                                                               
         MVC   FULL,W+1                                                         
*                                  ROUNDING CODE                                
         L     RE,FULL                                                          
         CVD   RE,DUB                                                           
         ZAP   MPOP2,DUB           MULTIPLIER (ADJUSTMENT %)                    
*                                                                               
         ZAP   MPOP1,MYPACKED                                                   
*                                                                               
         MP    MPOP1,MPOP2         MULTIPLICAND (BASIS)                         
         SRP   MPOP1,64-6,5                                                     
         ZAP   MYPACKED,MPOP1                                                   
*                                                                               
BC5P2    DS    0H                                                               
         MVC   ADJDSP(ACCUMLQ,R7),MYPACKED  ADJUSTMENT                          
         AP    WORK+ADJDSP-EXTDSP(ACCUMLQ),MYPACKED  TOTAL ADJUSTMENT           
         AP    MYPACKED,BCBAS      ADD BASIS                                    
BC6      DS    0H                                                               
         MVC   DUEDSP(ACCUMLQ,R7),MYPACKED     AMOUNT DUE                       
         AP    WORK+DUEDSP-EXTDSP(ACCUMLQ),MYPACKED    KEEP DUE TOTAL           
*                                                                               
BC8      DS    0H                  SET AOR AMOUNT                               
         ICM   R0,15,SVAORPCT      ANY AOR PCT?                                 
         BZ    BC9                                                              
         CLI   PROFB2A+6,C'Y'      IF APPLYING % ONLY TO TIME                   
         BNE   BC8B                                                             
*                                                                               
         MVC   WK(L'BCGRS),BCGRS   SAVE ORIGINAL VALUES                         
         MVC   WK+L'BCGRS(L'BCNET),BCNET                                        
         MVC   WK+L'BCGRS+L'BCNET(L'BCGRS2),BCGRS2                              
         MVC   BCGRS,0(R7)         SAVE ONLY TIME $$                            
         SP    BCGRS,ROWHL(ACCUMLQ,R7)                                          
         MVC   BCNET,ACCUMLQ(R7)                                                
         SP    BCNET,ROWHL+ACCUMLQ(ACCUMLQ,R7)                                  
         MVC   BCGRS2,ACCUMLQ*2(R7)                                             
         SP    BCGRS2,ROWHL+ACCUMLQ*2(ACCUMLQ,R7)                               
*                                                                               
BC8B     MVC   MYPACKED,BCGRS      BASIS IS GROSS                               
         CLI   PROFB2A+5,C'Y'      IF USING COST2 BASIS. . .                    
         BNE   *+10                                                             
         MVC   MYPACKED,BCGRS2     USE IT                                       
         TM    SVAORBAS,X'F0'      IF NOT BASIS BITS ON                         
         BZ    BC8E                                                             
         SP    MYPACKED,BCNET      BASIS IS A/C (GROSS LESS NET)                
         TM    SVAORBAS,X'80'                                                   
         BNZ   BC8E                                                             
         MVC   MYPACKED,BCNET      BASIS IS NET                                 
         TM    SVAORBAS,X'40'                                                   
         BNZ   BC8E                                                             
         DC    H'0'                                                             
*                                                                               
BC8E     DS    0H                                                               
         CLI   PROFB2A+6,C'Y'      IF APPLYING % ONLY TO TIME                   
         BNE   *+22                RESTORE  FIELDS                              
         MVC   BCGRS,WK                                                         
         MVC   BCNET,WK+L'BCGRS                                                 
         MVC   BCGRS2,WK+L'BCGRS+L'BCNET                                        
         CP    MYPACKED,=P'0'                                                   
         BE    BC9                 NO DUE AMOUNT                                
         CLC   PERLMOS,SVAOREFF    TEST VS. AOR EFFECTIVE DATE                  
         BL    BC8G                                                             
         CLC   PERLMOS,SVAORKIL    AND KILL DATE                                
         BNL   BC8G                                                             
*                                                                               
         CVD   R0,DUB              PACK %                                       
         ZAP   PKBIG,MYPACKED      PUT AMT INTO BIG FIELD FOR MULTIPLE          
         MP    PKBIG,DUB           APPLY %                                      
         SRP   PKBIG,1,0           FOR ROUNDING                                 
         ZAP   MYPACKED,=P'1000000' SET DIVISOR                                 
         DP    PKBIG,MYPACKED      DIVIDE BY ??                                 
         SRP   PKQUOT,64-1,5       ROUND                                        
         CLI   PKQUOT,0            NEED 1 FREE BYTE FOR MP                      
         BE    *+6                                                              
         DC    H'0'                                                             
         MP    PKQUOT,=P'-1'       MAKE NEGATIVE                                
*                                                                               
         MVC   AORDSP(ACCUMLQ,R7),PKQUOT   AOR AMOUNT                           
         AP    WORK+AORDSP-EXTDSP(ACCUMLQ),PKQUOT   AOR AMOUNT                  
*                                                                               
         L     RF,BRKCODE          LOOK FOR AOR PCT IN ACCUMULATOR              
         L     RF,ATOTS(RF)                                                     
         AHI   RF,TOTSIZE-BFORML+BFAORPCT-BFORMD                                
         CLC   0(3,RF),SVAORPCT+1  IF NOT THERE, DID MONTHS                     
         BE    *+10                BEFORE EFFECTIVE DATE                        
         MVC   0(3,RF),FFS         SET 'MIXED' AOR PCTS                         
         B     BC9                                                              
*                                                                               
BC8G     DS    0H                  IF ACTIVE MONTH BEFORE                       
         L     RF,BRKCODE          EFFECTIVE DATE CLEAR OUT AORPCT              
         L     RF,ATOTS(RF)        FROM ACCUMULATOR                             
         AHI   RF,TOTSIZE-BFORML+BFAORPCT-BFORMD                                
         XC    0(3,RF),0(RF)                                                    
*                                                                               
BC9      DS    0H                                                               
         CLI   PASSNO,2            FOR PASS 2 SKIP BCADD                        
         BE    *+8                 (ONLY FOR RECAP WITH ADJ. OR AOR)            
         BAS   RE,BCADD                                                         
*                                                                               
         LA    R7,ROWL(R7)                                                      
         LA    R5,PERLISTL(R5)     BUMP DATE                                    
         BCT   R6,BC4                                                           
         DROP  R5                                                               
*                                                                               
         MVC   ADJDSP(ACMEXTL,R7),WORK   TOTAL OF ADJ. AND DUE AMOUNTS          
*                                                                               
         ICM   R1,15,TRDTABN       ARE WE DOING TRADE ?                         
         BZ    BCX                                                              
         CLI   W,0                 BASIS HAS TO BE GROSS                        
         BNE   BCX                 IF NOT DO NOT FILL IN DUE                    
*                                                                               
         BAS   RE,TRDADD                                                        
*                                                                               
BCX      DS    0H                                                               
         J     XIT                                                              
         EJECT                                                                  
*                                  ADD INTO PRD-EST-PER TABLE                   
BCADD    NTR1                                                                   
*                                                                               
         USING PERLISTD,R5                                                      
         XC    X,X                                                              
         USING PEPTD,R6                                                         
         LA    R6,X                                                             
         L     RE,APRD                                                          
         MVC   PEPTPRD,0(RE)    PRODUCT                                         
         L     RE,AEST                                                          
         MVC   PEPTEST,0(RE)       ESTIMATE                                     
         CLI   PEPTEST,0                                                        
         BNE   *+6                                                              
         DC    H'0'                MUST HAVE A VALID ESTIMATE                   
         MVC   PEPTMOS,PERLMOS     PERIOD                                       
*                                                                               
         GOTO1 BINSRCH,PEPPARS,X                                                
         CLI   0(R1),1                                                          
         BE    BCX                 NOT IN PEPTAB                                
*                                                                               
         L     R6,0(R1)                                                         
         AP    PEPTADJ,ADJDSP(ACCUMLQ,R7) ADJUSTMENT                            
         AP    PEPTDUE,DUEDSP(ACCUMLQ,R7) DUE                                   
         AP    PEPTADUE,DUEDSP(ACCUMLQ,R7) DUE (FOR AOR CUMES)                  
         AP    PEPTGR2,GR2DSP(ACCUMLQ,R7) COST2 GROSS                           
*                                                                               
         CLI   SVAORACT,C' '       IF AOR                                       
         BNH   BCA10                                                            
         CLC   PERLMOS,SVAOREFF    AND EFFECTIVE FOR THIS MOS                   
         BL    BCA10                                                            
         CLC   PERLMOS,SVAORKIL    AND KILL DATE                                
         BNL   BCA10                                                            
         DROP  R5                                                               
*                                                                               
         AP    PEPTAOR,AORDSP(ACCUMLQ,R7) CUME AOR                              
         MVC   PEPTAORP,SVAORPCT   SAVE PCT                                     
         MVC   PEPTAORD,SVAORDA    DISK ADDRESS                                 
         MVC   PEPTAORB,SVAORBAS   BASIS                                        
         MVC   PEPTAORA,SVAORACT   RCVBL/PYBL ACCT                              
*                                                                               
BCA10    DS    0H                                                               
         MVC   PEPTBFB,W           BILL FORMULA BASE                            
         MVC   PEPTBFP,W+1         BILL FORMULA PCT                             
         CLI   FORMBOPT,C'A'       SET UP BASIS FLAGS                           
         BNE   *+12                                                             
         OI    PEPTBFFL,PEPTBALL   BASED ON ALL TYPES                           
         B     BCA10D                                                           
*                                                                               
         CLI   FORMBOPT,C'T'                                                    
         BNE   *+12                                                             
         OI    PEPTBFFL,PEPTBTIM   BASED ON TIME                                
         B     BCA10D                                                           
*                                                                               
         CLI   FORMBOPT,C'I'                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
         OI    PEPTBFFL,PEPTBINT   BASED ON INTEGRATION                         
*                                                                               
BCA10D   CLI   PROFB2A+5,C'Y'      FOR AOR USE COS2 BASIS?                      
         BNE   *+8                                                              
         OI    PEPTBFFL,PEPTAC2                                                 
*                                                                               
         CLI   PROFB2A+6,C'Y'      FOR AOR APPLY ONLY TO TIME?                  
         BNE   *+8                                                              
         OI    PEPTBFFL,PEPTATIM                                                
*                                                                               
         L     RE,ADPRD                                                         
         MVC   PEPTPACT,PACCT-PRDHDR(RE)     SET PRODUCT ACCT CODE              
*                                                                               
         TM    W,X'40'             COMMISSION-ONLY BILL?                        
         BZ    *+8                 YES                                          
         OI    PEPTSTAT,PEPTSTCO   SET IN STATUS AREA                           
*                                                                               
         CLI   CTYPCTL,C'S'        IF COST TYPE SEPARATE                        
         BNE   BCA12                                                            
         L     RE,ACTYP            SET IN PEPTAB                                
         L     R1,=A(CTYPLST)      COST TYPE LIST                               
*                                                                               
         USING CTYLD,R1                                                         
BCA11    CLC   0(1,RE),CTYLDISP                                                 
         BE    BCA11B                                                           
         LA    R1,CTYLSTL(R1)                                                   
         CLI   0(R1),X'FF'         EOL                                          
         BNE   BCA11                                                            
         DC    H'0'                BAD COST TYPE                                
*                                                                               
BCA11B   DS    0H                                                               
         MVC   PEPTCTYP,CTYLCOD                                                 
         DROP  R1                                                               
*                                  ALSO FOR SEPARATE COST TYPES                 
         CLI   FORMBOPT,C'A'       IF FORMULA BASIS IS T OR I                   
         BE    BCA12                                                            
         CLC   PEPTCTYP,FORMBOPT   AND IS NOT EQUAL TO                          
         BE    BCA12               CURRENT COST TYPE                            
         NI    PEPTSTAT,X'FF'-PEPTSTCO  KILL COMMISSION-ONLY STATUS             
*                                        (PART OF BILL FORM WHICH WE            
*                                         ARE SUPPRESSING)                      
BCA12    DS    0H                                                               
         CLI   PKGCTL,C'S'         PKG NUMBER SEPARATE                          
         BNE   BCA13                                                            
         L     RE,APKG             SET IN PEPTAB                                
         SR    R1,R1                                                            
         ICM   R1,1,PKGNMOPT       PACKAGE NAME OPTION                          
         BNZ   *+14                                                             
         MVC   PEPTPKG,0(RE)       IF OFF, USE PKG NUMBER                       
         B     BCA13                                                            
*                                                                               
         BCTR  R1,0                ELSE MOVE REQUIRED BYTES TO PEPTPKGN         
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   PEPTPKGN(0),0(RE)                                                
*                                                                               
BCA13    DS    0H                                                               
         B     BCX                                                              
         DROP  R6                                                               
TRDADD   NTR1                                                                   
*                                                                               
         XC    X,X                                                              
         USING TRADETD,R6                                                       
         LA    R6,X                                                             
         L     RE,APRD                                                          
         MVC   TRADEPRD,0(RE)      PRODUCT                                      
         L     RE,AEST                                                          
         MVC   TRADEEST,0(RE)      ESTIMATE                                     
*                                                                               
         GOTO1 BINSRCH,TRDPARS,X                                                
         CLI   0(R1),1                                                          
         BE    BCX                 NOT IN TRADETAB                              
*                                                                               
         L     R6,0(R1)                                                         
*                                                                               
         ZAP   MYPACKED,TRDOTIME                                                
         SP    MYPACKED,TRDBTIME                                                
         ZAP   DOUBLE,MYPACKED                                                  
*                                                                               
         OC    W+1(4),W+1          ANY ADJUSTMENT ?                             
         BZ    TRDA40                                                           
*                                                                               
         MVC   FULL,W+1                                                         
*                                  ROUNDING CODE                                
         L     RE,FULL                                                          
         CVD   RE,DUB                                                           
         ZAP   MPOP2,DUB           MULTIPLIER (ADJUSTMENT %)                    
*                                                                               
         ZAP   MPOP1,MYPACKED                                                   
*                                                                               
         MP    MPOP1,MPOP2         MULTIPLICAND (BASIS)                         
         SRP   MPOP1,64-6,5                                                     
         ZAP   MYPACKED,MPOP1                                                   
*                                                                               
         ZAP   TRDADJ,MYPACKED     ADJUSTMENT                                   
         AP    DOUBLE,MYPACKED     BASIS + ADJUSTMENT                           
TRDA40   ZAP   TRDDUE,DOUBLE       DUE                                          
         MVC   TRDBF,W             STORE FORMULA                                
         B     BCX                                                              
         DROP  R6                                                               
*                                                                               
*                                                                               
         DROP  R9                                                               
         SPACE 2                                                                
         LTORG                                                                  
         SPACE 3                                                                
BILCD    DSECT                                                                  
MPOP1    DS    PL12                                                             
MPOP2    DS    PL4                                                              
BCGRS    DS    PL8                                                              
BCNET    DS    PL8                                                              
BCBAS    DS    PL8                                                              
BCGRS2   DS    PL8                                                              
BFMGRS2  DS    PL8                                                              
BFMGRS   DS    PL8                                                              
BFMNET   DS    PL8                                                              
BILCQ    EQU   *-MPOP1                                                          
         SPACE 3                                                                
         TITLE 'FMTAMT - FORMAT BILLING AMOUNTS'                                
SPBU02   CSECT                                                                  
FMTAMT   NMOD1 FMTWQ,FMTAMT                                                     
         LR    R9,RC               R9 --> FMTWD                                 
         USING FMTWD,R9                                                         
         LA    RC,SPACEND                                                       
*                                                                               
         MVC   HLDINO,SPACES                                                    
         ST    R3,SAVBRK           SAVE BREAK LEVEL                             
*                                  SET ZLSW TO CONTROL ZERO LINE TOTALS         
         MVI   ZLSW,C'N'           N = NO SPECIAL TREATMENT                     
         C     R3,ALOWTOG             IF AT LOWEST LEVEL                        
         BE    FA2D                                                             
         CLI   ZLOPT,C'A'             OR IF NOT FOR THIS TYPE                   
         BE    *+14                                                             
         CLC   TYPE,ZLOPT                                                       
         BNE   FA2D                                                             
         MVI   ZLSW,C'Y'      ELSE DON'T SHOW ON ORDERED OR PREV. TOTS.         
*                                                                               
FA2D     DS    0H                                                               
*                                                                               
         LM    R2,R3,0(R1)         R2 = A(ORDERED AND BILLED)                   
*                                  R3 = A(PREVIOUS INVOICE NO.)                 
         CLI   COST2SW,C'Y'        FOR COST2 MODE                               
         BNE   FA2F                                                             
         CLI   SVCTYPE,TIMEQ       BUT ONLY FOR TIME AND POSSIBLY               
         BE    FA2E                                                             
         CLI   SVCTYPE,INTEGQ      INTEGRATION CHARGES                          
         BNE   FA2F                                                             
         CP    ACMORD2-ACMORDG(ACCUMLQ,R2),=P'0'                                
         BE    FA2F                IF NOTHING ASSUME NO COS2 FOR INT            
*                                                                               
FA2E     MVC   FMTWORK,0(R2)       SAVE ORFERED/BILLED                          
         LA    R2,FMTWORK          AND RE-POINT R2                              
*                                                                               
         MVC   DUB,FMTWORK              AND SWAP AGENCY GROSS AND COST2         
         MVC   FMTWORK(ACCUMLQ),FMTWORK+ACMORD2-ACMORDG           YKVA          
         MVC   FMTWORK+ACMORD2-ACMORDG(ACCUMLQ),DUB                             
         MVC   DUB,FMTWORK+ROWHL        BILLED AS WELL                          
         MVC   FMTWORK+ROWHL(ACCUMLQ),FMTWORK+ROWHL+ACMORD2-ACMORDG             
         MVC   FMTWORK+ROWHL+ACMORD2-ACMORDG(ACCUMLQ),DUB                       
*                                                                               
FA2F     DS    0H                                                               
         LA    R5,X                                                             
         USING ALINED,R5                                                        
         MVC   ALINE,SPACES                                                     
*                                  USE R4 AS 'INDEX' TO GROSS OR NET            
         SR    R4,R4                GROSS                                       
         CLI   GNSW,C'G'                                                        
         BE    *+8                                                              
         LHI   R4,ACCUMLQ          NET                                          
*                                                                               
         CLI   FORMAT,1                                                         
         BNE   FA4                                                              
*                                  FORMAT 1 ORDERED, PREV. INVOICE, ETC         
         CLI   ZLSW,C'Y'                                                        
         BE    FA3B                SHOW ONLY BALANCE                            
         LR    RE,R2                                                            
         AR    RE,R4                                                            
         MVC   MYPACKED,0(RE)                                                   
         LA    R7,ALCOL1                                                        
         BAS   RE,FMTEDT                                                        
*                                                                               
         LA    RE,ROWHL(R2)                                                     
         LA    RF,ROWHL(RE)                                                     
FA2FA    CP    0(ACCUMLQ,RE),=P'0'                                              
         BNE   FA2FC                                                            
         LA    RE,ACCUMLQ(RE)                                                   
         CR    RE,RF                                                            
         BL    FA2FA                                                            
         B     FA3                 NO BILLING                                   
*                                                                               
FA2FC    LTR   R3,R3               OR NO PREVIOUS BILL NO                       
         BZ    FA3                                                              
         OC    0(4,R3),0(R3)                                                    
         BZ    FA3                                                              
*                                                                               
         MVC   W(1),1(R3)          SET YM                                       
         MVC   THREE,TODAYB        SAVE TODAYB                                  
         MVC   TODAYB(1),0(R3)     SET YEAR                                     
         MVC   SVSVIMO,SVINVMO     SAVE SAVED INVNO MONTH                       
         GOTOR GETNUM,DMCB,(1,2(R3)),WORK                                       
         MVC   TODAYB,THREE                                                     
         MVC   SVINVMO,SVSVIMO     RESTORE SAVED INVNO MONTH                    
         XC    0(4,R3),0(R3)       CLEAR ENTRY (TO PREVENT REPETITION?)         
         MVC   ALCOL2+4(10),WORK                                                
         MVC   HLDINO,WORK                                                      
*                                                                               
FA3      DS    0H                                                               
         LR    RE,R2               PREVIOUS                                     
         AR    RE,R4                                                            
         MVC   MYPACKED,ROWHL(RE)                                               
         LA    R7,ALCOL3                                                        
         BAS   RE,FMTEDT                                                        
*                                                                               
FA3B     DS    0H                                                               
         LA    R7,ALCOL4                                                        
*                                                                               
FA3D     DS    0H                                                               
         LR    RE,R2               BALANCE                                      
         AR    RE,R4                                                            
         MVC   MYPACKED,0(RE)                                                   
         SP    MYPACKED,ROWHL(ACCUMLQ,RE)  BALANCE                              
         BAS   RE,FMTEDT                                                        
         B     FA20                                                             
*                                                                               
FA4      DS    0H                                                               
         CLI   FORMAT,5                                                         
         BNE   FA5                                                              
*                                  FORMAT 5 - SPOTS, ORDERED, ETC               
         CLI   ZLSW,C'Y'                                                        
         BE    FA3B                SHOW ONLY BALANCE                            
         LA    R7,ALCOL1           SPOTS                                        
         MVC   MYPACKED,ROW$L(R2)  SPOTS                                        
         EDIT  MYPACKED,(5,10(R7)),ZERO=NOBLANK,FLOAT=-                         
         LR    RE,R2                                                            
         AR    RE,R4                                                            
         MVC   MYPACKED,0(RE)      ORDERED GROSS                                
         LA    R7,ALCOL2                                                        
         BAS   RE,FMTEDT                                                        
         B     FA3                 DO PREVIOUS AMOUNTS AND BALANCE              
*                                                                               
FA5      DS    0H                                                               
         CLI   FORMAT,7                                                         
         BNE   FA5A                                                             
*                                  FORMAT 7 - SPOTS, BALANCE                    
         LA    R7,ALCOL3                                                        
         MVC   MYPACKED,ROW$L(R2)                                               
         EDIT  MYPACKED,(5,10(R7)),ZERO=NOBLANK,FLOAT=-                         
         LA    R7,ALCOL4                                                        
         B     FA3D                                                             
*                                                                               
FA5A     DS    0H                                                               
         CLI   FORMAT,8                                                         
         BNE   FA5B                                                             
*                                  FORMAT 8 - BALANCE                           
         LA    R7,ALCOL3                                                        
         B     FA3D                                                             
*                                                                               
FA5B     DS    0H                                                               
         CLI   FORMAT,9                                                         
         BNE   FA6                                                              
*                                  FORMAT 9 NET AND GROSS BALANCE               
         LR    RF,R4                                                            
         SHI   RF,ACCUMLQ                                                       
         LPR   RF,RF               REVERSE GROSS AND NET                        
         LR    RE,R2                                                            
         AR    RE,RF                                                            
         MVC   MYPACKED,0(RE)                                                   
         SP    MYPACKED,ROWHL(ACCUMLQ,RE)  BALANCE                              
         LA    R7,ALCOL3                                                        
         BAS   RE,FMTEDT                                                        
         B     FA3B                                                             
*                                                                               
FA6      DS    0H                                                               
         CLI   FORMAT,12                                                        
         BH    FA7                                                              
*                                  FORMAT 11 - ORDERED                          
         LR    RE,R2                                                            
         AR    RE,R4                                                            
         MVC   MYPACKED,0(RE)                                                   
         LA    R7,ALCOL4                                                        
         CLI   FORMAT,11                                                        
         BNE   *+8                                                              
         LA    R7,ALCOL3                                                        
         BAS   RE,FMTEDT                                                        
*                                                                               
         CLI   FORMAT,11                                                        
         BE    FA20                                                             
         LA    R7,ALCOL3           SPOTS                                        
         MVC   MYPACKED,ROW$L(R2)                                               
         EDIT  MYPACKED,(5,10(R7)),ZERO=NOBLANK,FLOAT=-                         
         B     FA20                                                             
*                                                                               
FA7      DS    0H                                                               
*                                  FORMAT 13 - GROSS AND NET                    
         LR    RE,R2               GROSS OR NET                                 
         AR    RE,R4                                                            
         MVC   MYPACKED,0(RE)                                                   
         LA    R7,ALCOL4                                                        
         BAS   RE,FMTEDT                                                        
*                                                                               
         LR    R6,R4                                                            
         SHI   R6,ACCUMLQ                                                       
         LPR   R6,R6                                                            
         LR    RE,R2               NET OR GROSS                                 
         AR    RE,R6                                                            
         MVC   MYPACKED,0(RE)                                                   
         LA    R7,ALCOL3                                                        
         BAS   RE,FMTEDT                                                        
*                                                                               
         CLI   FORMAT,13                                                        
         BE    FA20                                                             
         LA    R7,ALCOL2           SPOTS                                        
         MVC   MYPACKED,ROW$L(R2)                                               
         EDIT  MYPACKED,(5,10(R7)),ZERO=NOBLANK,FLOAT=-                         
*                                                                               
FA20     DS    0H                                                               
         GOTO1 ABILLEDI,DMCB,('EDMMTA',HLDINO)  EDI CALL                        
*                                                                               
         CLI   STRIPOPT,C'N'                                                    
         BE    FMTAMTX                                                          
         CLI   COMMSW,C'N'         COMMISSION ON STRIP OFF?                     
         BE    FA20B               NO                                           
*                                  YES                                          
         MVC   MYPACKED,0(R2)      GROSS                                        
         SP    MYPACKED,ACCUMLQ(ACCUMLQ,R2) LESS NET                            
         CLI   FORMAT,10           IF ORDERED FORMAT, DO NOT                    
         BNL   *+16                SUBTRACT PREVIOUS BILLS                      
         SP    MYPACKED,ROWHL(ACCUMLQ,R2) LESS BILLED GROSS                     
         AP    MYPACKED,ROWHL+ACCUMLQ(ACCUMLQ,R2) PLUS BILLED NET               
         B     FA20E               = COMMISSION                                 
*                                                                               
FA20B    DS    0H                                                               
*                                                                               
         SHI   R4,ACCUMLQ          REVERSE GROSS-NET 'INDEX' FOR STRIP          
         LPR   R4,R4                                                            
         LR    RE,R2                                                            
         AR    RE,R4                                                            
         MVC   MYPACKED,0(RE)                                                   
         CLI   FORMAT,10           IF ORDERED FORMAT, DO NOT                    
         BNL   *+10                SUBTRACT PREVIOUS BILLS                      
         SP    MYPACKED,ROWHL(ACCUMLQ,RE)                                       
*                                                                               
FA20E    DS    0H                                                               
         LA    R7,ALSTRIP                                                       
         BAS   RE,FMTEDT                                                        
*                                                                               
FMTAMTX  DS    0H                                                               
         J     XIT                                                              
         SPACE 3                                                                
FMTEDT   DS    0H                                                               
         CLI   PROFB4A+5,C'Y'      SUPPRESS PRINTING OF STATION $?              
         BNE   FMTEDT10                                                         
         L     RF,SAVBRK           YES -- PICK UP CURRENT BREAK LEVEL           
         L     RF,0(RF)                                                         
         CHI   RF,STAEQ*4          ARE WE "LOWER" THAN STATION?                 
         BL    FMTEDT10            YES -- ALWAYS PRINT THE $                    
         CHI   RF,PEREQ*4          ARE THESE PERIOD-LEVEL TOTALS?               
         BE    FMTEDT10            YES -- ALWAYS PRINT THE $                    
         CHI   RF,PERGEQ*4         ARE THESE PERIOD-GROUP-LEVEL TOTALS?         
         BNER  RE                  NO -- DON'T PRINT THE $                      
*                                                                               
FMTEDT10 EDIT  MYPACKED,(16,0(R7)),2,COMMAS=YES,CR=YES                          
         CLI   14(R7),C' '                                                      
         BHR   RE                                                               
         MVC   14(2,R7),TOTSTAR                                                 
         BR    RE                                                               
         DROP  R5,R9                                                            
         SPACE 3                                                                
         LTORG                                                                  
*                                  GET BILL FORMULA FROM BILL HEADER,           
*&&DO                                                                           
GETBFBH  NTR1  BASE=*,LABEL=*      RESET FORMBOPT, PROFB2+5, PROFB2+6           
         LA    R6,KEY                                                           
         USING BKEY,R6                                                          
         XC    BKEY,BKEY           READ BILL HEADER KEYS                        
         MVC   BKEYAM,BAGYMD       AGY/MED                                      
         MVC   BKEYCLT,BCLT        CLIENT                                       
         L     R1,APRD             ELSE PRODUCT CODE (ALPHA SEQ)                
*        ZIC   RF,0(R1)                                                         
*        MHI   RF,4                PRDLTAB ENTRY SIZE IS 4                      
*        L     RE,VCLIST                                                        
*        LA    RE,0(RE,RF)                                                      
         MVC   BKEYPRD,0(R1)                                                    
         L     RF,AEST             ESTIMATE                                     
         MVC   BKEYEST,0(RF)                                                    
*                                  SAVE MOS(2)+B/M(1)+INV NUM(2)                
         L     RE,APER                                                          
         ZIC   RF,0(RE)                                                         
         LA    RF,PERLIST(RF)                                                   
         MVC   DOUBLE(2),PERLMOS-PERLISTD(RF)                                   
         GOTO1 DATCON,DMCB,(2,MANRVDTP),(3,FULL) CONVRT DATE TO YMD             
         ZIC   R0,FULL             TRICK TO PUT Y/M IN ONE BYTE:                
         CVD   R0,MYPACKED         MYPACKED+7 HAS ACTUAL YEAR AND SIGN          
         NI    MYPACKED+7,X'F0'    CLEAR THE SIGN NIBBLE                        
         OC    MYPACKED+7(1),FULL+1  NOW PUT IN MONTH IN LOW NIBBLE             
         MVC   DOUBLE+2(1),MYPACKED+7                                           
         MVC   DOUBLE+3(2),MANRVNO   INVOICE NUMBER                             
*                                                                               
         GOTO1 HIGH                                                             
         B     GETBF20                                                          
*                                                                               
GETBF10  GOTO1 SEQ                                                              
*                                                                               
GETBF20  CLC   KEY(4),KEYSAVE      SAME AGY/MED/CLT?                            
         BE    GETBF23             NO: WE'RE FINISHED....                       
         CP    DBTOTG,=P'0'        ???AND DIDN'T FIND BILL HEADER???            
         BE    *+6                 DID WE WRITE OUT ANY RECS?                   
         DC    H'0'                                                             
         CP    NBTOTG,=P'0'        MANUALS?                                     
         BE    *+6                                                              
         DC    H'0'                IF YES, DIE, SOMETHING'S WRONG!              
         MVI   ERR,REVERR                                                       
         BRAS  RE,ERRPROC          MUST BE INVALID INVOICE #                    
*                                                                               
GETBF23  OC    BKEYYSRV(5),BKEYYSRV   BILL HEADER?                              
         BZ    GETBF10             NO, READ NEXT RECORD                         
*                                                                               
         CLC   BKEYYSRV(5),DOUBLE  IS IT 'OUR' INVOICE?                         
         BNE   GETBF10                                                          
*                                                                               
         GOTO1 GETBILL                                                          
         L     R6,ADBILL                                                        
         USING BILLREC,R6                                                       
         MVC   BFORMBH,BILBFB      SAVE BILL FORMULA                            
         OC    BILSTABF,BILSTABF   DOES IT HAVE BASIS FLAGS                     
         BZ    GETBFX              NO, DONE                                     
         XC    FORMBOPT,FORMBOPT   BASIS FLAGS                                  
         TM    BILSTABF,BSTBFALL   BASED ON ALL CTYPES?                         
         BZ    *+12                                                             
         MVI   FORMBOPT,C'A'                                                    
         B     GETBF40                                                          
*                                                                               
         TM    BILSTABF,BSTBFTIM   BASED ON TIME?                               
         BZ    *+12                                                             
         MVI   FORMBOPT,C'T'                                                    
         B     GETBF40                                                          
*                                                                               
         TM    BILSTABF,BSTBFINT   BASED ON INTEGRATION?                        
         BNZ   *+6                                                              
         DC    H'0'                                                             
         MVI   FORMBOPT,C'I'                                                    
*                                                                               
GETBF40  MVI   PROFB2A+5,0                                                      
         TM    BILSTABF,BSTBFAC2   COS2 BASIS FOR AOR?                          
         BZ    *+8                                                              
         MVI   PROFB2A+5,C'Y'                                                   
*                                                                               
         MVI   PROFB2A+6,0         AOR: APPLY ONLY TO TIME                      
         TM    BILSTABF,BSTBFATM                                                
         BZ    *+8                                                              
         MVI   PROFB2A+6,C'Y'                                                   
*                                                                               
         DROP  R6                                                               
GETBFX   J     XIT                                                              
         LTORG                                                                  
*&&                                                                             
         SPACE 3                                                                
FMTWD    DSECT                                                                  
FMTWORK  DS    XL(ROWTL)                                                        
FMTWQ    EQU   *-FMTWORK                                                        
         TITLE 'LSTINV  - ROUTINE FOR PREVIOUS BILLING'                         
SPBU02   CSECT                                                                  
LSTINV   NMOD1 LSTWQ,LSTINV                                                     
         LR    R9,RC               R9 --> LSTWKD                                
         USING LSTWKD,R9                                                        
         LA    RC,SPACEND                                                       
*                                                                               
         MVC   LSTGNSW,GNSW        SAVE GROSS/NET SWTICH                        
         L     R3,SAVBRK           RESTORE A(BREAK LEVEL)                       
         L     RF,BRKCODE                                                       
         L     RF,ATOTS(RF)        POINT TO ACCUMULATOR                         
         LR    R7,RF                                                            
         AHI   R7,MAXMOS*ROWL      POINT TO TOTAL ROW                           
         XC    WK,WK                                                            
         LA    R1,WK                                                            
         LA    RF,ROWTL(R1)                                                     
         BRAS  RE,ZAPSTR           ZAP $ FIELDS                                 
         LHI   R1,NCTYPS           TEST ALL COST TYPES (FOR BCT)                
*                                                                               
LI06     DS    0H                                                               
         MVC   DUB,0(R7)           ORDERED GROSS                                
         CLI   COST2SW,C'Y'        FOR COST2 MODE                               
         BNE   *+10                                                             
         MVC   DUB,ACCUMLQ*2(R7)   OVERRIDE GROSS (NET IS UNCHANGED)            
         AP    WK(ACCUMLQ),DUB                                                  
         AP    WK+ACCUMLQ(ACCUMLQ),ACCUMLQ(ACCUMLQ,R7) ORDERED NET              
*                                                                               
         MVC   DUB,ROWHL(R7)       PREVIOUS BILLED GROSS                        
         CLI   COST2SW,C'Y'        FOR COST2 MODE                               
         BNE   *+10                                                             
         MVC   DUB,ROWHL+ACCUMLQ*2(R7) OVERRIDE GROSS (NET UNCHANGED)           
         AP    WK+ACCUMLQ*2(ACCUMLQ),DUB                                        
*                                  PREVIOUS BILLED NET                          
         AP    WK+ACCUMLQ*3(ACCUMLQ),ROWHL+ACCUMLQ(ACCUMLQ,R7)                  
*                                                                               
         LA    R7,ROWTL(R7)                                                     
         BCT   R1,LI06                                                          
*                                                                               
         CP    WK+ACCUMLQ*2(ACCUMLQ),=P'0'  ANY PREVIOUS BILLING?               
         BNE   LI08                                                             
         CP    WK+ACCUMLQ*3(ACCUMLQ),=P'0'                                      
         BNE   LI08                YES, OK                                      
*                                                                               
         CLI   FORMAT,7            NO, FOR FORMATS 7-9                          
         BL    LSTINVX             PREVIOUS BILLING AMOUNTS NOT                 
         CLI   FORMAT,9            KEPT,                                        
         BH    LSTINVX                                                          
         ICM   RF,15,INVTABN       SO JUST TEST IF ANY INVOICES                 
         BZ    LSTINVX                                                          
*                                                                               
LI08     DS    0H                                                               
         CLI   LSTOPT,C'A'         NEED PREV $$ IN ACTUAL ??                    
         BNE   *+12                                                             
         BRAS  RE,CALCACT          CALCULATE ACTUAL                             
         MVI   BYTE,C'A'           HOPEFULLY WE GOT ACT FOR ALL ENTRIES         
*                                                                               
         MVI   LISTSW,0                                                         
         CLI   LSTOPT,C'N'         IF ACTUALLY LISTING INVOICES                 
         BE    *+12                                                             
         MVI   LISTSW,C'N'                                                      
         BAS   RE,LSTLST           SEE IF ANY LIST ENTRIES                      
*                                                                               
         MVI   PRSW,C'F'           PRINT ANYTHING THERE                         
         BRAS  RE,PRNT                                                          
         MVI   PRSW,C'N'           PRINT NOW                                    
         MVI   COLMNS,2                                                         
         CLI   FORMAT,13                                                        
         BH    *+16                                                             
         CLI   FORMAT,9                                                         
         BE    *+8                                                              
         MVI   COLMNS,1                                                         
*                                                                               
         LA    R2,P                                                             
         CLI   FORMAT,8                                                         
         BE    *+12                                                             
         CLI   FORMAT,11                                                        
         BNE   *+8                                                              
*                                                                               
         SHI   R2,16          SHIFT SINGLE COLUMN FORMATS LEFT 1 COLUMN         
         USING ALINED,R2                                                        
*                                                                               
         ZAP   LSTGRS,=P'0'        CLEAR GROSS FIELD  (PACKED)                  
         ZAP   LSTNET,=P'0'        CLEAR NET FIELD  (PACKED)                    
         XC    LSTNUM,LSTNUM       CLEAR NUMBER FIELD (BINARY)                  
*                                                                               
         CLI   FORMAT,10                                                        
         BNH   LI40                FORMATS  1 - 10                              
         EJECT                                                                  
*                                  FORMATS 11+ (ORDERED ONLY)                   
*                                                                               
         CLI   LSTOPT,C'A'         IF ACTUAL $$ ON PREV BILLS                   
         BE    LI40                DO *NOT* SUBTRACT                            
*                                  ORDERED DOLLARS ARE GROSS                    
*                                  SUBTRACTING ACTUALS FROM THEM                
*                                  DOES NOT MAKE SENSE                          
*                                                                               
*                                  SUBTRACT OUT PREVIOUS BILLS                  
*                                  ON SAME INVOICE                              
*                                                                               
         CLI   LSTOPT,C'N'         ACTUALLY LISTING INVOICE NO'S?               
         BNE   LI34                YES                                          
*                                  JUST SUBTRACTING TOTAL PREVIOUS              
         MVC   LSTGRS,WK+ACCUMLQ*2   PREVIOUS BILLING                           
         MVC   LSTNET,WK+ACCUMLQ*3                                              
         LA    R5,ALCOL2-8                                                      
         CLI   COLMNS,1                                                         
         BNE   *+8                                                              
         LA    R5,16(R5)                                                        
         MVC   0(21,R5),=C'LESS PREVIOUS BILLING'                               
         MVC   X(ACCUMLQ),LSTGRS                                                
         MVC   X+ACCUMLQ(ACCUMLQ),LSTNET                                        
         BAS   RE,LSTFMT                                                        
         BRAS  RE,PRNT                                                          
         CLI   COLMNS,1                                                         
         BE    *+10                                                             
         MVC   ALCOL3+4(10),DASHES                                              
         MVC   ALCOL4+4(10),DASHES                                              
         BRAS  RE,PRNT                                                          
*                                                                               
*                                  ORDERED LESS PREVIOUS                        
         MVC   X(ACCUMLQ*2),WK     2 FIELDS MOVED                               
         SP    X(ACCUMLQ),WK+ACCUMLQ*2(ACCUMLQ)                                 
         SP    X+ACCUMLQ(ACCUMLQ),WK+ACCUMLQ*3(ACCUMLQ)                         
         BAS   RE,LSTFMT                                                        
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
         B     LI80                                                             
*                                                                               
LI34     DS    0H                                                               
         LA    R5,ALCOL2-8                                                      
         CLI   COLMNS,1                                                         
         BNE   *+8                                                              
         LA    R5,16(R5)                                                        
         MVC   0(21,R5),=C'LESS PREVIOUS BILLING'                               
         MVC   132(21,R5),DASHES                                                
         BRAS  RE,PRNT                                                          
         BAS   RE,LSTLST                                                        
         MVC   X(ACCUMLQ*2),WK     2 FIELDS MOVED                               
         SP    X(ACCUMLQ),WK+ACCUMLQ*2(ACCUMLQ)                                 
         SP    X+ACCUMLQ(ACCUMLQ),WK+ACCUMLQ*3(ACCUMLQ)                         
         BAS   RE,LSTFMT                                                        
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
         B     LI80                                                             
         EJECT                                                                  
*                                  IF FORMAT 1 - 10 BILL IS COMPLETE            
*                                  AND PREVIOUS LIST IS JUST FOR INFO           
LI40     DS    0H                                                               
*                                  SHIFT ALL COLUMNS LEFT 1                     
*                                  TO AVOID CONFUSION OVER AMOUNT DUE           
         SHI   R2,16                                                            
         LA    R5,ALCOL2                                                        
         CLI   COLMNS,1                                                         
         BNE   *+8                                                              
         LA    R5,16(R5)                                                        
         MVC   0(14,R5),=C'PREVIOUS BILLS'                                      
         MVC   132(14,R5),DASHES                                                
         BRAS  RE,PRNT                                                          
         BAS   RE,LSTLST                                                        
*                                                                               
LI80     DS    0H                                                               
         MVI   PRSW,C'F'           FLUSH PRINT LINES                            
         BRAS  RE,PRNT                                                          
*                                                                               
         CLI   LSTOPT,C'R'         REPEAT AMOUNT DUE?                           
         BNE   LSTINVX                                                          
         CLI   FORMAT,10           SKIP FOR ORDERED ONLY FORMATS                
         BH    LSTINVX                                                          
         L     RF,=A(SVAMTDUE)                                                  
         MVC   P,0(RF)                                                          
         BRAS  RE,PRNT                                                          
         SPACE 2                                                                
LSTINVX  MVC   GNSW,LSTGNSW        RESTORE GROSS/NET SWITCH                     
         J     XIT                 (COULD'VE BEEN MODIFIED BY ACTUAL)           
         SPACE 2                                                                
         DROP  R3                                                               
         EJECT                                                                  
LSTLST   NTR1                                                                   
*                                                                               
         L     R6,INVTABN          FOR BCT                                      
         LTR   R6,R6                                                            
         BNP   LSTLSTX                                                          
         LA    RE,*+10                                                          
         O     RE,=X'80000000'                                                  
         BSM   0,RE                SWITCH TO 31 BIT MODE                        
*                                                                               
         L     R4,AINVTAB          START OF TABLE                               
         MVC   FULL,AINVTAB        TEMP FOR CURRENT ENTRY ADDRESS               
         MVC   LSTWORK,0(R4)       GET 2 ENTRIES                                
         LA    RE,*+6                                                           
         BSM   0,RE                SWITCH BACK TO 24-BIT                        
*                                                                               
         LA    R4,LSTWORK                                                       
         USING INVLD,R4                                                         
         LA    R1,X                                                             
         LA    RF,L'X(R1)                                                       
         BRAS  RE,ZAPSTR                                                        
*                                  SET TO HOLD PRINT LINES                      
LST11    DS    0H                                                               
         CLC   APRDBRK,AINVBRK     PRODUCT SEPARATE?                            
         BH    LST12               NO                                           
         L     RE,APRD             YES - MUST BE RIGHT PRODUCT                  
*        ZIC   RE,0(RF)                                                         
*        MHI   RE,4                                                             
*        L     RF,VCLIST                                                        
*        LA    RF,0(RF,RE)                                                      
*        CLC   0(3,RE),0(RF)                                                    
*        BE    *+12                                                             
*        LA    RF,4(RF)                                                         
*        B     *-14                                                             
         CLC   INVLPRD,0(RE)                                                    
         BNE   LST30                                                            
         B     LST14                                                            
*                                                                               
LST12    DS    0H                                                               
         OC    APGR1BRK,APGR1BRK                                                
         BZ    LST14                                                            
         CLC   APGR1BRK,AINVBRK    PGR SEPARATE?                                
         BH    LST14               NO                                           
*                                                                               
LST12A   L     RE,PRDLIST          YES - MUST BE RIGHT PGR                      
LST12B   DS    0H                                                               
         CLC   INVLPRD,2(RE)                                                    
         BE    *+12                                                             
         LA    RE,6(RE)                                                         
         B     LST12B                                                           
         CLC   0(2,RE),SVPGRKEY+(PRGKGRP-PRGKEY)                                
         BNE   LST30                                                            
*                                                                               
LST14    DS    0H                                                               
         CLC   AESTBRK,AINVBRK     ESTIMATE SEPARATE?                           
         BH    *+18                NO                                           
         L     RF,AEST             YES - MUST BE RIGHT ESTIMATE                 
         CLC   INVLEST,0(RF)                                                    
         BNE   LST30                                                            
*                                                                               
         OC    ADPTBRK,ADPTBRK                                                  
         BZ    LST16                                                            
         CLC   ADPTBRK,AINVBRK     DPT SEPARATE?                                
         BH    LST16               NO                                           
*                                                                               
         L     RF,ADPT             YES - MUST BE RIGHT DPT                      
         CLC   INVLDPT,0(RF)                                                    
         BNE   LST30                                                            
*                                                                               
LST16    DS    0H                                                               
         OC    APKGBRK,APKGBRK                                                  
         BZ    LST18                                                            
         CLC   APKGBRK,AINVBRK     PKG SEPARATE?                                
         BH    LST18               NO                                           
         L     RF,APKG             YES - MUST BE RIGHT PKG                      
         SR    R1,R1                                                            
         ICM   R1,1,PKGNMOPT       PKG NAME OPTION?                             
         BZ    *+6                                                              
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         CLC   INVLPKG(0),0(RF)                                                 
         BNE   LST30                                                            
*                                                                               
LST18    DS    0H                                                               
         OC    ASTABRK,ASTABRK                                                  
         BZ    LST20                                                            
         CLC   ASTABRK,AINVBRK     STATION SEPARATE?                            
         BH    LST20               NO                                           
         L     RF,ASTA                                                          
         CLC   INVLSTA,0(RF)                                                    
         BNE   LST30                                                            
*                                                                               
LST20    DS    0H                                                               
         CLC   APERBRK,AINVBRK     PERIOD SEPARATE?                             
         BH    LST22               NO                                           
         L     RE,APER                                                          
         ZIC   RF,0(RE)                                                         
         LA    RF,PERLIST(RF)                                                   
         CLC   INVLPER,PERLMOS-PERLISTD(RF)                                     
         BNE   LST30                                                            
*                                                                               
LST22    DS    0H                                                               
         CLI   CTYPCTL,C'S'        TYPES SEPARATE?                              
         BNE   *+18                                                             
         L     RF,ACTYP                                                         
         CLC   INVLTYP,0(RF)                                                    
         BNE   LST30                                                            
*                                                                               
         CLI   LISTSW,C'Y'         IS THIS THE TEST PASS                        
         BE    *+12                NO, CARRY ON                                 
         MVI   LISTSW,C'Y'         SET HAVE BILLS TO LIST                       
         B     LSTLSTX                                                          
*                                  BILL HAS PASSED ALL TESTS                    
         CLI   BYTE,C'A'                   DOING ACTUAL?                        
         BNE   *+18                                                             
         AP    X(ACCUMLQ),INVLACT          ACTUAL                               
         MVI   GNSW,C'G'                   ACTUAL IS IN THE SAME FIELD          
         B     *+10                        AS GROSS                             
*                                                                               
         AP    X(ACCUMLQ),INVLGRS          GROSS                                
*                                                                               
         AP    X+ACCUMLQ(ACCUMLQ),INVLNET  NET                                  
*                                                                               
         CLC   INVLYR(INVYMIL),INVLYR+INVTABRL  SAME YEAR/MONTH/INVNUM?         
         BNE   LST28               NO, TIME TO PRINT                            
         CLC   APRDBRK,AINVBRK     PRODUCT SEPARATE?                            
         BH    *+14                NO, DON'T CHECK IT                           
         CLC   INVLPRD,INVLPRD+INVTABRL  SAME PRODUCT?                          
         BNE   LST28               NO, TIME TO PRINT                            
*                                                                               
         OC    APGR1BRK,APGR1BRK                                                
         BZ    LST24                                                            
         CLC   APGR1BRK,AINVBRK    PGR1 SEPARATE?                               
         BH    *+14                NO                                           
         CLC   INVLPGR,INVLPGR+INVTABRL  SAME PRODUCT GROUP?                    
         BNE   LST28               NO, TIME TO PRINT                            
*                                                                               
LST24    CLC   AESTBRK,AINVBRK     ESTIMATE SEPARATE?                           
         BH    *+14                NO                                           
         CLC   INVLEST,INVLEST+INVTABRL  SAME ESTIMATE                          
         BNE   LST28               NO, TIME TO PRINT                            
*                                                                               
         OC    ADPTBRK,ADPTBRK                                                  
         BZ    LST25A                                                           
         CLC   ADPTBRK,AINVBRK     DPT SEPARATE?                                
         BH    *+14                NO                                           
         CLC   INVLDPT,INVLDPT+INVTABRL  SAME DAYPART?                          
         BNE   LST28               NO, TIME TO PRINT                            
*                                                                               
LST25A   DS    0H                                                               
         OC    APKGBRK,APKGBRK                                                  
         BZ    LST25C                                                           
         CLC   APKGBRK,AINVBRK     PKG SEPARATE?                                
         BH    *+14                NO                                           
         CLC   INVLPKG,INVLPKG+INVTABRL  SAME PACKAGE?                          
         BNE   LST28               NO, TIME TO PRINT                            
*                                                                               
LST25C   DS    0H                                                               
         OC    ASTABRK,ASTABRK                                                  
         BZ    LST25E                                                           
         CLC   ASTABRK,AINVBRK     STATION SEPARATE?                            
         BH    *+14                NO                                           
         CLC   INVLSTA,INVLSTA+INVTABRL  SAME STATION?                          
         BNE   LST28               NO, TIME TO PRINT                            
*                                                                               
LST25E   DS    0H                                                               
         CLC   APERBRK,AINVBRK     PERIOD SEPARATE?                             
         BH    *+14                                                             
         CLC   INVLPER,INVLPER+INVTABRL  SAME PERIOD?                           
         BNE   LST28               NO, TIME TO PRINT                            
*                                                                               
         CLC   ACTYPBRK,AINVBRK    CTYP SEPARATE ?                              
         BH    LST30               GET NXT ENTRY                                
         CLC   INVLTYP,INVLTYP+INVTABRL   SAME CTYP?                            
         BE    LST30               YES, NEXT ENTRY                              
*                                                                               
LST28    MVC   W(1),INVLMO         SET MONTH FOR GETNUM                         
         MVC   THREE,TODAYB        SAVE TODAYB                                  
         MVC   TODAYB(1),INVLYR    SET YEAR                                     
         LA    R5,ALCOL2+3                                                      
         CLI   COLMNS,1                                                         
         BNE   *+8                                                              
         LA    R5,16(R5)                                                        
         MVC   SVSVIMO,SVINVMO     SAVE SAVED INVNO MONTH                       
         GOTOR GETNUM,DMCB,(1,INVLINV),(R5)     FORMAT INVOICE NO               
         MVC   HLDINO,0(R5)        SAVE INVNO FOR EDI CALL                      
         MVC   TODAYB,THREE                                                     
         MVC   SVINVMO,SVSVIMO     RESTORE SAVED INVNO MONTH                    
         BAS   RE,LSTFMT                                                        
         BRAS  RE,PRNT                                                          
*                                  TOTAL                                        
         AP    LSTGRS,X(ACCUMLQ)   GROSS                                        
         AP    LSTNET,X+ACCUMLQ(ACCUMLQ) NET                                    
         L     RF,LSTNUM           COUNT                                        
         AHI   RF,1                                                             
         ST    RF,LSTNUM                                                        
*                                                                               
         GOTO1 ABILLEDI,DMCB,('EDMLST',HLDINO),X+(ACMORDG-ACMORD),     +        
               X+(ACMORDN-ACMORD)                                               
*                                                                               
         LA    R1,X                                                             
         LA    RF,L'X(R1)                                                       
         BRAS  RE,ZAPSTR                                                        
*                                                                               
LST30    DS    0H                                                               
         LA    RE,*+10                                                          
         O     RE,=X'80000000'                                                  
         BSM   0,RE                SWITCH TO 31 BIT MODE                        
*                                                                               
***      A     R4,INVTABL                                                       
         LHI   R4,INVTABRL                                                      
         A     R4,FULL                                                          
         ST    R4,FULL             BUMP TO NEXT ENTRY                           
         MVC   LSTWORK,0(R4)       NXT 2 ENTRIES                                
         LA    RE,*+6              BACK TO 24                                   
         BSM   0,RE                                                             
*                                                                               
         LA    R4,LSTWORK                                                       
         BCT   R6,LST11                                                         
*                                                                               
         CLI   LISTSW,C'N'         IS THIS THE TEST PASS                        
         BE    LSTLSTX             YES, DONE                                    
*                                                                               
LST31    OC    LSTNUM,LSTNUM                                                    
         BZ    LSTLSTX                                                          
         CLI   COLMNS,1                                                         
         BE    *+10                                                             
         MVC   ALCOL3+4(10),DASHES                                              
         MVC   ALCOL4+4(10),DASHES                                              
         BRAS  RE,PRNT                                                          
         CLI   FORMAT,10           BYPASS TOTAL OF BILLS                        
         BH    LSTLSTX             IF ORDERED ONLY FORMAT                       
         MVC   X(ACCUMLQ),LSTGRS   TOTAL OF BILLS                               
         MVC   X+ACCUMLQ(ACCUMLQ),LSTNET                                        
         BAS   RE,LSTFMT                                                        
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
*                                                                               
LSTLSTX  DS    0H                                                               
         J     XIT                                                              
         EJECT                                                                  
LSTFMT   NTR1                                                                   
*                                                                               
         CLI   COLMNS,1                                                         
         BNE   LSTFMT4                                                          
*                                  ONE COLUMN                                   
         MVC   MYPACKED,X                                                       
         CLI   GNSW,C'G'                                                        
         BE    *+10                                                             
         MVC   MYPACKED,X+ACCUMLQ                                               
         LA    R6,ALCOL4                                                        
         EDIT  MYPACKED,(16,0(R6)),2,COMMAS=YES,CR=YES                          
         CLI   14(R6),C' '                                                      
         BNE   *+10                                                             
         MVC   14(2,R6),TOTSTAR                                                 
         B     LSTFMTX                                                          
*                                                                               
LSTFMT4  DS    0H                  2 COLUMNS                                    
         MVC   PKBIG,X             MOVE 2 AMNT FIELDS                           
         CLI   GNSW,C'N'                                                        
         BE    LSTFMT4A                                                         
         XC    PKBIG(ACCUMLQ),PKBIG+ACCUMLQ     SWAP THOSE AMOUNTS              
         XC    PKBIG+ACCUMLQ(ACCUMLQ),PKBIG                                     
         XC    PKBIG(ACCUMLQ),PKBIG+ACCUMLQ                                     
*                                                                               
LSTFMT4A LA    R6,ALCOL3                                                        
         MVC   MYPACKED,PKBIG                                                   
         EDIT  MYPACKED,(16,0(R6)),2,COMMAS=YES,CR=YES                          
         CLI   14(R6),C' '                                                      
         BNE   *+10                                                             
         MVC   14(2,R6),TOTSTAR                                                 
         LA    R6,16(R6)                                                        
         MVC   MYPACKED,PKBIG+ACCUMLQ                                           
         EDIT  MYPACKED,(16,0(R6)),2,COMMAS=YES,CR=YES                          
         CLI   14(R6),C' '                                                      
         BNE   *+10                                                             
         MVC   14(2,R6),TOTSTAR                                                 
*                                                                               
LSTFMTX  DS    0H                                                               
         J     XIT                                                              
         DROP  R2,R9                                                            
         SPACE 3                                                                
         LTORG                                                                  
LSTWKD   DSECT                                                                  
LSTWORK  DS    XL(INVTABRL*2)                                                   
LSTGNSW  DS    C                                                                
*                                                                               
LSTGRS   DS    PL8                                                              
LSTNET   DS    PL8                                                              
LSTNUM   DS    F                                                                
LSTTOTSL EQU   *-LSTGRS                                                         
*                                                                               
LSTWQ    EQU   *-LSTWKD                                                         
         TITLE 'SPBU2E - SPOT BILLING/SOURCE BOOK E'                            
SPBU02   CSECT                                                                  
***********************************************************************         
*                                                                               
*        CONTAINS VARIOUS MODULES FOR BILLING EDI.                              
*                                                                               
***********************************************************************         
         SPACE 2                                                                
BILLEDI  NMOD1 0,**EDI***,R5                                                    
         LA    RC,SPACEND                                                       
*                                                                               
         L     R9,=A(COMSUBS)      COMMON AREA                                  
         USING COMSUBS,R9                                                       
         LA    R7,BREC                                                          
         USING BILLEDID,R7                                                      
         LA    R6,TSARB                                                         
         USING TSARD,R6                                                         
*                                                                               
         MVC   EDPARMS(24),0(R1)   AND PARMS                                    
         MVC   EDMODE,0(R1)        MODE IS HOB OF PARM1                         
*                                                                               
         CLI   DUESW,C'R'          DON'T PROCESS AOR                            
         BE    EDIX                                                             
         CLI   DUESW,C'A'          SEPARATE ADJUSTMENT BILLS ARE OK             
         BE    *+12                                                             
         CLI   PASSNO,1            DON'T PROCESS DETAIL BACK-UP                 
         BH    EDIX                                                             
*                                                                               
         CLI   FRSTSW,0                                                         
         BNE   *+8                                                              
         BAS   RE,EDINI                                                         
*                                                                               
         LA    RF,MODLIST          FIND MODE                                    
         LHI   R0,MODLISTN                                                      
*                                                                               
MP04     DS    0H                                                               
         CLC   EDMODE,0(RF)                                                     
         BE    *+14                                                             
         LA    RF,L'MODLIST(,RF)                                                
         BCT   R0,MP04                                                          
         DC    H'0'                                                             
*                                                                               
         ICM   RF,15,1(RF)                                                      
         BASR  RE,RF                                                            
*                                                                               
         B     EDIX                                                             
         EJECT                                                                  
**********************************************************************          
*        INITIALIZATION                                                         
**********************************************************************          
*                                                                               
EDINI    NTR1                                                                   
*                                                                               
         CLI   EDMODE,EDMCLS       IF CLOSING, NO INIT                          
         BE    INITX                                                            
         MVI   FRSTSW,1                                                         
*                                                                               
*              NOTE- IF WORKER FILES USED, THEY ARE OPENED AT MFHDR             
*                                                                               
         CLI   OUTMODE,C'D'        DATASET OUTPUT                               
         BNE   INIT5                                                            
*                                                                               
         OPEN  (EDIOUT,OUTPUT)     OPEN                                         
         CLOSE EDIOUT              CLOSE                                        
         OPEN  (EDIOUT,OUTPUT)     RE-OPEN DATASET                              
*                                                                               
INIT5    DS    0H                                                               
         L     R0,=A(BESIZE)                                                    
         GETMAIN RU,LV=(0),LOC=(ANY,ANY)                                        
         LTR   R1,R1                                                            
         BNZ   *+6                                                              
         DC    H'0'                                                             
         ST    R1,TSABUF                                                        
*                                                                               
         MVC   TSACOM,ACOMFACS                                                  
         MVI   TSKEYL,BEKLN                                                     
         OI    TSRECI,TSRVAR       SET FOR VARIABLE RECS                        
         MVC   TSRECL,=Y(BERECL)                                                
         MVI   TSOFFACT,TSAINI                                                  
         MVC   TSAREC,=A(BESIZE)                                                
         GOTO1 ATSAROFF,(R6)                                                    
         CLI   TSERRS,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LA    RF,BREC             SET ADDRESSES OF RECORD AREAS                
         ST    RF,ABREC                                                         
         LA    RF,ABREC+L'ABREC                                                 
         LA    RF,FREC                                                          
         ST    RF,AFREC                                                         
         LA    RF,4(RF)                                                         
         ST    RF,AFRECP4          RECORD+4 IS START OF DATA                    
         LA    RF,FREC+L'FREC                                                   
         ST    RF,AFRECX                                                        
*                                                                               
INITX    DS    0H                                                               
         B     EDIX                                                             
         EJECT                                                                  
**********************************************************************          
*        PRODUCT GROUP                                                          
**********************************************************************          
*                                                                               
EDPGR    NTR1                                                                   
*                                                                               
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BEPGRLN)                                             
         MVI   BEKRCLS,EDRSRTMQ    MAIN SORT GROUP                              
         MVI   BEKRCD,EDPGRQ       RECORD TYPE                                  
*                                                                               
         C     R3,APGR3BRK                                                      
         BNE   EDPGR4                                                           
         MVI   BEPGRL,C'3'                                                      
         MVC   BEPGRC,PGR3                                                      
         MVC   BEPGRD,PGR3BK                                                    
         MVC   BEPGRN,PGR3NM                                                    
         BAS   RE,EDPUT                                                         
         B     EDPGRX                                                           
*                                                                               
EDPGR4   DS    0H                                                               
         C     R3,APGR2BRK                                                      
         BNE   EDPGR6                                                           
         MVI   BEPGRL,C'2'                                                      
         MVC   BEPGRC,PGR2                                                      
         MVC   BEPGRD,PGR2BK                                                    
         MVC   BEPGRN,PGR2NM                                                    
         BAS   RE,EDPUT                                                         
         B     EDPGRX                                                           
*                                                                               
EDPGR6   DS    0H                                                               
         MVI   BEPGRL,C'1'                                                      
         MVC   BEPGRC,PGR1                                                      
         MVC   BEPGRD,PGR1BK                                                    
         MVC   BEPGRN,PGR1NM                                                    
         BAS   RE,EDPUT                                                         
*                                                                               
EDPGRX   DS    0H                                                               
         B     EDIX                                                             
         SPACE 2                                                                
**********************************************************************          
*        PRODUCT                                                                
**********************************************************************          
*                                                                               
EDPRD    NTR1                                                                   
*                                                                               
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BEPRDLN)   PRODUCT RECORD                            
         MVI   BEKRCLS,EDRSRTMQ    MAIN SORT GROUP                              
         MVI   BEKRCD,EDPRDQ       RECORD CODE                                  
         MVC   BEPRD,PRD                                                        
         MVC   BEPRDN,PRDNM                                                     
         OC    BEPRDN,SPACES                                                    
*                                                                               
         L     RF,ADPRD            PRODUCT NUMBER                               
         LA    RF,PACCT-PRDHDR(RF)                                              
         MVC   BEPRICD(4),0(RF)                                                 
*                                                                               
         CLC   BEPRICD(4),=C'0000'                                              
         BNE   *+10                                                             
         MVC   BEPRICD(4),SPACES                                                
*                                                                               
         CLI   0(RF),X'FF'                                                      
         BNE   *+20                                                             
         ZAP   DUB,1(3,RF)                                                      
         OI    DUB+7,X'0F'                                                      
         UNPK  BEPRICD,DUB                                                      
*                                                                               
         OC    BEPRICD,SPACES                                                   
         BAS   RE,EDPUT                                                         
*                                                                               
         B     EDIX                                                             
         SPACE 2                                                                
**********************************************************************          
*        ESTIMATE                                                               
**********************************************************************          
*                                                                               
EDEST    NTR1                                                                   
*                                                                               
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BEESTLN)                                             
         MVI   BEKRCLS,EDRSRTMQ    MAIN SORT GROUP                              
         MVI   BEKRCD,EDESTQ                                                    
         MVC   BEEST,EST                                                        
         MVC   BEESTN,ESTNM                                                     
         OC    BEESTN,SPACES                                                    
         BAS   RE,EDPUT                                                         
*                                                                               
         B     EDIX                                                             
         SPACE 2                                                                
**********************************************************************          
*        MARKET GROUP                                                           
**********************************************************************          
*                                                                               
EDMGR    NTR1                                                                   
*                                                                               
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BEMGRLN)                                             
         MVI   BEKRCLS,EDRSRTMQ    MAIN SORT GROUP                              
         MVI   BEKRCD,EDMGRQ       RECORD TYPE                                  
*                                                                               
         C     R3,AMGR3BRK                                                      
         BNE   EDMGR4                                                           
         MVI   BEMGRL,C'3'                                                      
         MVC   BEMGRC,MGR3                                                      
         MVC   BEMGRD,MGR3BK                                                    
         MVC   BEMGRN,MGR3NM                                                    
         BAS   RE,EDPUT                                                         
         B     EDMGRX                                                           
*                                                                               
EDMGR4   DS    0H                                                               
         C     R3,AMGR2BRK                                                      
         BNE   EDMGR6                                                           
         MVI   BEMGRL,C'2'                                                      
         MVC   BEMGRC,MGR2                                                      
         MVC   BEMGRD,MGR2BK                                                    
         MVC   BEMGRN,MGR2NM                                                    
         BAS   RE,EDPUT                                                         
         B     EDMGRX                                                           
*                                                                               
EDMGR6   DS    0H                                                               
         MVI   BEMGRL,C'2'                                                      
         MVC   BEMGRC,MGR1                                                      
         MVC   BEMGRD,MGR1BK                                                    
         MVC   BEMGRN,MGR1NM                                                    
         BAS   RE,EDPUT                                                         
*                                                                               
EDMGRX   DS    0H                                                               
         B     EDIX                                                             
         SPACE 2                                                                
**********************************************************************          
*        MARKET                                                                 
**********************************************************************          
*                                                                               
EDMKT    NTR1                                                                   
*                                                                               
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BEMKTLN)                                             
         MVI   BEKRCLS,EDRSRTMQ    MAIN SORT GROUP                              
         MVI   BEKRCD,EDMKTQ       RECORD TYPE                                  
         MVC   BEMKT,MKT                                                        
         MVC   BEMKTN,MKTNM                                                     
         OC    MKTNM,SPACES                                                     
         BAS   RE,EDPUT                                                         
*                                                                               
         B     EDIX                                                             
         SPACE 2                                                                
**********************************************************************          
*        STATION                                                                
**********************************************************************          
*                                                                               
EDSTA    NTR1                                                                   
*                                                                               
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BESTALN)                                             
         MVI   BEKRCLS,EDRSRTMQ    MAIN SORT GROUP                              
         MVI   BEKRCD,EDSTAQ       RECORD TYPE                                  
         MVC   BESTA,SPACES                                                     
         MVC   BESTA,BIGSTA                                                     
         MVC   BESTCTY,SPACES                                                   
         MVC   BESTAFF,SPACES                                                   
*                                                                               
         BAS   RE,EDPUT                                                         
*                                                                               
         B     EDIX                                                             
         SPACE 2                                                                
**********************************************************************          
*        MONTHLY TOTAL AMOUNTS                                                  
**********************************************************************          
*                                                                               
EDMTA    NTR1                                                                   
*                                                                               
         L     R3,SAVBRK           BREAK TABLE ENTRY                            
         C     R3,AINVBRK          OK IF AT INVOICE BRD                         
         BE    *+12                                                             
         CLI   3(R3),X'30'         ELSE SKIP PROGRAM AND LOWER LEVELS           
         BNL   EDIX                                                             
*                                                                               
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BEDETLN)                                             
         MVI   BEKRCLS,EDRSRTMQ    MAIN SORT GROUP                              
         MVI   BEKRCD,EDMTAQ                                                    
*                                                                               
         MVC   BEDLEV,3(R3)        BREAK LEVEL CODE                             
         C     R3,AINVBRK          IF AND END OF INVOICE                        
         BNE   *+8                                                              
         MVI   BEDLEV,X'FF'        SAY SO                                       
*                                                                               
         L     R3,PERLIND          PERIOD (PERLIST INDEX)                       
         LA    R3,PERLIST(R3)                                                   
         USING PERLISTD,R3                                                      
*                                                                               
         CLI   0(R3),X'FF'                                                      
         BNE   *+14                                                             
         MVC   BEDMOS(5),=C'TOTAL'                                              
         B     EDMTA14                                                          
*                                                                               
         CLI   SPOTPROF+2,0        BRODCAST MONTH                               
         BE    *+12                                                             
         CLI   SPOTPROF+2,2        OR CALENDAR MONTH                            
         BNE   EDMTA13                                                          
*                                                                               
         GOTO1 DATCON,DMCB,(3,PERLMOS),(6,BEDMOS)   SHOW NORMAL MMMYY           
         B     EDMTA14                                                          
*                                                                               
EDMTA13  DS    0H                                                               
         GOTO1 DATCON,DMCB,(2,PERLSTRT),(5,BEDMOS)  OTHER MMMDD/YY              
         DROP  R3                                                               
*                                                                               
EDMTA14  DS    0H                                                               
         CLI   CTYPCTL,C'N'        IF TYPES NOT SHOWN                           
         BNE   *+12                                                             
         MVI   BEDTYP,C'M'         CALL IT MIXED TYPES                          
         B     EDMTA14H                                                         
*                                                                               
         L     RF,=A(CTYPLST)      ELSE FIND IN LIST                            
*                                                                               
         USING CTYLD,RF                                                         
EDMTA14D CLC   SVCTYPE,CTYLDISP    INTERNAL CODE                                
         BE    EDMTA14F                                                         
         CLI   0(RF),X'FF'         EOL                                          
         BNE   *+6                                                              
         DC    H'0'                BAD COST TYPE                                
         LA    RF,CTYLSTL(RF)                                                   
         B     EDMTA14D                                                         
*                                                                               
EDMTA14F DS    0H                                                               
         MVC   BEDTYP,CTYLREQ      SET 1-CHAR DISPLAY COST                      
         DROP  RF                                                               
*                                                                               
EDMTA14H DS    0H                                                               
         L     RF,EDPARMS          PREVIOUS INVOICE NUMBER                      
         MVC   BEDPINV,0(RF)                                                    
*                                                                               
         EDIT  (P8,0(R2)),(11,BEDOGRS),FLOAT=-,ALIGN=LEFT,             +        
               ZERO=NOBLANK                                                     
         EDIT  (P8,ROWHL+0(R2)),(11,BEDPGRS),FLOAT=-,ALIGN=LEFT,       +        
               ZERO=NOBLANK                                                     
*                                                                               
         EDIT  (P8,ACCUMLQ(R2)),(11,BEDONET),FLOAT=-,ALIGN=LEFT,       +        
               ZERO=NOBLANK                                                     
         EDIT  (P8,ROWHL+ACCUMLQ(R2)),(11,BEDPNET),FLOAT=-,ALIGN=LEFT, +        
               ZERO=NOBLANK                                                     
*                                                                               
         EDIT  (P8,ACCUMLQ*2(R2)),(11,BEDOTAX),FLOAT=-,ALIGN=LEFT,     +        
               ZERO=NOBLANK                                                     
         EDIT  (P8,ROWHL+ACCUMLQ*2(R2)),(11,BEDPTAX),FLOAT=-,          +        
               ALIGN=LEFT,ZERO=NOBLANK                                          
         EDIT  (P8,ROW$L(R2)),(11,BEDOSPTS),FLOAT=-,ALIGN=LEFT,        +        
               ZERO=NOBLANK                                                     
         EDIT  (P8,ROWHL+ROW$L(R2)),(11,BEDPSPTS),FLOAT=-,ALIGN=LEFT,  +        
               ZERO=NOBLANK                                                     
*                                                                               
         BAS   RE,EDPUT                                                         
*                                                                               
         B     EDIX                                                             
         SPACE 2                                                                
**********************************************************************          
*        TEXT LINES                                                             
**********************************************************************          
*                                                                               
EDTXT    NTR1                                                                   
*                                                                               
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BECOMLN)                                             
         MVI   BEKRCLS,EDRSRTMQ    MAIN SORT GROUP                              
         MVI   BEKRCD,EDCOMQ                                                    
*                                                                               
         L     R3,SAVBRK                                                        
         MVC   BECOMLEV,3(R3)      BREAK LEVEL CODE                             
         C     R3,AINVBRK          IF END OF INVOICE                            
         BNE   *+8                                                              
         MVI   BECOMLEV,X'FF'      SAY SO                                       
*                                                                               
         L     R4,EDPARMS          A(TEXT)                                      
         MVC   BECOMTXT,0(R4)                                                   
         BAS   RE,EDPUT                                                         
*                                                                               
         B     EDIX                                                             
         DROP  R4                                                               
         SPACE 2                                                                
**********************************************************************          
*        REGULAR COMMENTS                                                       
**********************************************************************          
*                                                                               
EDCOM    NTR1                                                                   
*                                                                               
         L     R4,ADCOMREC                                                      
         CLI   0(R4),0             COMMENT PRESENT?                             
         BE    EDCMX                                                            
*                                                                               
         LA    R4,24(R4)           FIRST ELEMENT                                
*                                                                               
EDCM2    DS    0H                                                               
         CLI   0(R4),0             EOR                                          
         BE    EDCMX                                                            
         CLI   0(R4),5             COMMENT ELEMENT                              
         BNE   EDCM4                                                            
*                                                                               
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BECOMLN)                                             
         MVI   BEKRCLS,EDRSRTMQ    MAIN SORT GROUP                              
         MVI   BEKRCD,EDCOMQ                                                    
*                                                                               
         L     R3,SAVBRK                                                        
         MVC   BECOMLEV,3(R3)      BREAK LEVEL CODE                             
         C     R3,AINVBRK          IF END OF INVOICE                            
         BNE   *+8                                                              
         MVI   BECOMLEV,X'FF'      SAY SO                                       
*                                                                               
         ZIC   RE,1(R4)            ELEMENT LENGTH                               
         SHI   RE,3                SET FOR EX                                   
         BM    EDCM4                                                            
         EX    RE,*+8                                                           
         B     *+10                                                             
         CLC   2(0,R4),SPACES                                                   
         BNH   EDCM4               SKIP BLANK COMMENTS                          
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   BECOMTXT(0),2(R4)   SET COMMENT TEXT                             
         BAS   RE,EDPUT                                                         
*                                                                               
EDCM4    DS    0H                                                               
         ZIC   R0,1(R4)                                                         
         AR    R4,R0                                                            
         B     EDCM2                                                            
*                                                                               
EDCMX    DS    0H                                                               
         B     EDIX                                                             
*                                                                               
         SPACE 2                                                                
**********************************************************************          
*        NETPAK COMMENTS                                                        
*         - VIA NETCOM HOOK ROUTINE                                             
**********************************************************************          
*                                                                               
EDNCM    NTR1                                                                   
*                                                                               
         L     R4,EDPARMS          A(COMMENT LINE)                              
*                                                                               
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BECOMLN)                                             
         MVI   BEKRCLS,EDRSRTMQ    MAIN SORT GROUP                              
         MVI   BEKRCD,EDCOMQ       SAME MF ROUTE AS REG COMMENTS                
*                                                                               
         L     R3,SAVBRK                                                        
         MVC   BECOMLEV,3(R3)      BREAK LEVEL CODE                             
         C     R3,AINVBRK          IF END OF INVOICE                            
         BNE   *+8                                                              
         MVI   BECOMLEV,X'FF'      SAY SO                                       
*                                                                               
         OC    0(132,R4),SPACES    ANY TEXT                                     
         CLC   0(132,R4),SPACES                                                 
         BE    *+14                                                             
         MVC   BECOMTXT,0(R4)                                                   
         BAS   RE,EDPUT                                                         
*                                                                               
         B     EDIX                                                             
         SPACE 2                                                                
**********************************************************************          
*        BILLING HEADER                                                         
**********************************************************************          
*                                                                               
EDHDR    NTR1                                                                   
*                                                                               
         XC    BEKEY,BEKEY                                                      
         MVI   BEKRCLS,EDRSRTHQ    HEADER CLASS                                 
         MVI   BEKRCD,EDHDRQ                                                    
         L     RE,ADBILL                                                        
         SR    RF,RF                                                            
         ICM   RF,3,13(RE)                                                      
         STH   RF,BEREC            SET RECORD LENGTH                            
*******  BCTR  RE,0                                                             
*******  EX    RE,*+8                                                           
*******  B     *+10                                                             
*******  MVC   BEHDRC(0),0(RF)                                                  
         LR    R1,RF               LENGTH                                       
         LA    R0,BEHDRC                                                        
         MVCL  R0,RE                                                            
         BAS   RE,EDPUT                                                         
*                                                                               
         B     EDIX                                                             
         SPACE 2                                                                
**********************************************************************          
*        BILLING ADDRESS                                                        
**********************************************************************          
*                                                                               
EDADD    NTR1                                                                   
*                                                                               
         TM    EDNEWSW,X'80'       HAVE ALREADY DONE ADDRESS?                   
         BNZ   EDADDX                                                           
         OI    EDNEWSW,X'80'                                                    
*                                                                               
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BEADDLN)                                             
         MVI   BEKRCLS,EDRSRTAQ    ADDRESS SORT GROUP                           
         MVI   BEKRCD,EDADDQ                                                    
         MVC   BEADDL1,HEAD7+46                                                 
         MVC   BEADDL2,HEAD8+46                                                 
         MVC   BEADDL3,HEAD9+46                                                 
         MVC   BEADDL4,HEAD10+46                                                
         MVC   BEADDL5,HEAD11+46                                                
*                                                                               
         BAS   RE,EDPUT                                                         
*                                                                               
EDADDX   DS    0H                                                               
         B     EDIX                                                             
         SPACE 2                                                                
**********************************************************************          
*        USER DEFINITION FIELDS                                                 
**********************************************************************          
*                                                                               
EDUSR    NTR1                                                                   
*                                                                               
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BEUSRLN)                                             
         MVI   BEKRCLS,EDRSRTMQ    MAIN SORT GROUP                              
         MVI   BEKRCD,EDUSRQ                                                    
*                                                                               
         L     RF,EDPARMS                                                       
         MVC   BEUSRTXT(2),0(RF)   P1,P2,E1,E2...                               
         MVC   BEUSRTXT+2(L'BEUSRTXT-2),X   USER  STUFF IN X                    
*                                      (MFUSR ROUTINE WILL SORT IT OUT)         
         BAS   RE,EDPUT                                                         
*                                                                               
         B     EDIX                                                             
         SPACE 2                                                                
**********************************************************************          
*        USER COMMENT FIELDS                                                    
**********************************************************************          
*                                                                               
EDUCM    NTR1                                                                   
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BEUCMLN)                                             
         MVI   BEKRCLS,EDRSRTMQ    MAIN SORT GROUP                              
         MVI   BEKRCD,EDUCMQ                                                    
*                                                                               
         L     RF,EDPARMS                                                       
         MVC   BEUCMTXT(2),0(RF)          P1,P2,E1,E2,M1,M2...                  
         MVC   BEUCMTXT+2(L'BEUCMTXT-2),X   USER  STUFF IN X                    
*                                  (MFUCM ROUTINE WILL SORT IT OUT)             
         BAS   RE,EDPUT                                                         
*                                                                               
         B     EDIX                                                             
         SPACE 2                                                                
**********************************************************************          
*        LIST OF PREVIOUS BILLS                                                 
*        CALLED IN PADJINV AND ADJINV                                           
**********************************************************************          
*                                                                               
EDLST    NTR1                                                                   
*                                                                               
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BDLSTLN)                                             
         MVI   BEKRCLS,EDRSRTMQ    MAIN SORT GROUP                              
         MVI   BEKRCD,EDLSTQ                                                    
*                                                                               
         L     RF,EDPARMS                                                       
         MVC   BDLSTIN,0(RF)       INVOICE NUMBER                               
*                                                                               
         L     RF,EDPARMS+4                                                     
         EDIT  (P8,0(RF)),(11,BDLSTG),FLOAT=-,ALIGN=LEFT   GROSS                
*                                                                               
         L     RF,EDPARMS+8                                                     
         EDIT  (P8,0(RF)),(11,BDLSTN),FLOAT=-,ALIGN=LEFT   NET                  
*                                                                               
         BAS   RE,EDPUT                                                         
*                                                                               
         B     EDIX                                                             
         SPACE 2                                                                
**********************************************************************          
*        AMOUNT DUE                                                             
*          P1=A(FORMULA)                                                        
*          P2=A(TOTAL)                                                          
*          P3=INDEX TO CURRENCY (0=AGENCY, 4=CLIENT)                            
*                                                                               
*        CALLED IN PRTADJ AND ADJINV                                            
**********************************************************************          
*                                                                               
EDDUE    NTR1                                                                   
*                                                                               
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BDUELN)                                              
         MVI   BEKRCLS,EDRSRTMQ    MAIN SORT GROUP                              
         MVI   BEKRCD,EDDUEQ                                                    
*                                                                               
         L     R3,SAVBRK                                                        
         MVC   BDULEV,3(R3)        BREAK LEVEL CODE                             
         C     R3,AINVBRK          IF END OF INVOICE                            
         BNE   *+8                                                              
         MVI   BDULEV,X'FF'        SAY SO                                       
*                                                                               
         L     R4,EDPARMS          A(BFORM)                                     
         USING BFORMD,R4                                                        
         MVI   BDUBB,C'G'          BILL BASIS - GROSS                           
         TM    BFBAS,X'10'                                                      
         BNO   EDD4                                                             
         MVI   BDUBB,C'N'          NET                                          
         CLI   BFBAS,X'FF'                                                      
         BNE   EDD4                                                             
         MVI   BDUBB,C'M'          MIXED                                        
*                                                                               
EDD4     DS    0H                  COMMISSION BASIS                             
         MVI   BDUCB,C'G'          GROSS                                        
         TM    BFBAS,X'01'                                                      
         BNO   EDD6                                                             
         MVI   BDUCB,C'N'          NET                                          
         CLI   BFBAS,X'FF'                                                      
         BNE   EDD6                                                             
         MVI   BDUCB,C'M'          MIXED                                        
*                                                                               
EDD6     DS    0H                                                               
         CLC   BFCOMP,FFS          MIXED %'S                                    
         BE    EDD8                                                             
         EDIT  (B4,BFCOMP),(11,BDUCP),FLOAT=-,ALIGN=LEFT                        
         DROP  R4                                                               
*                                                                               
EDD8     DS    0H                                                               
         L     R3,EDPARMS+4        A(TOTALS)                                    
*                                                                               
         CLI   ADJSEP,C'Y'         SEPARATE ADJUSTMENT?                         
         BE    EDD10                                                            
*                                  NO, NORMAL AMOUNTS                           
         MVC   MYPACKED,DUEDSP(R3)          DUE                                 
         SP    MYPACKED,ADJDSP(ACCUMLQ,R3)  LESS ADJUSTMENT = BASIS AMT         
         EDIT  MYPACKED,(11,BDUBBA),FLOAT=-,ALIGN=LEFT                          
         EDIT  (P8,ADJDSP(R3)),(11,BDUCBA),FLOAT=-,ALIGN=LEFT                   
         EDIT  (P8,DUEDSP(R3)),(11,BDUAMT),FLOAT=-,ALIGN=LEFT,         +        
               ZERO=NOBLANK                                                     
         B     EDD20                                                            
*                                                                               
EDD10    DS    0H                  SEPARATE ADJUSTMENT                          
         CLI   DUESW,C'A'          ACTUAL ADJUSTMENT BILL?                      
         BNE   EDD12                                                            
*                                  YES, SPECIAL AMOUNTS                         
         MVI   BDUBBA,C'0'         BASE IS $0??                                 
*                                                                               
         EDIT  (P8,ADJDSP(R3)),(11,BDUCBA),FLOAT=-,ALIGN=LEFT                   
*                                                                               
         MVC   BDUAMT,BDUCBA       ADJUSTMENT IS AMOUNT DUE                     
*                                                                               
         B     EDD20                                                            
*                                                                               
EDD12    DS    0H                  BASE BILL IN SEPARATE ADJ. SITUATION         
         MVC   MYPACKED,DUEDSP(R3)         AMOUNT DUE                           
         SP    MYPACKED,ADJDSP(ACCUMLQ,R3) LESS ADJUSTMENT = BASIS AMT          
         EDIT  MYPACKED,(11,BDUBBA),FLOAT=-,ALIGN=LEFT                          
*                                                                               
         MVI   BDUCBA,C'0'         ADJUSTMENT IS $0.                            
*                                                                               
         MVC   BDUAMT,BDUBBA       DUE IS BASE AMOUNT                           
*                                                                               
EDD20    DS    0H                                                               
         BAS   RE,EDPUT                                                         
         B     EDIX                                                             
         SPACE 2                                                                
**********************************************************************          
*        REMITTANCE ADDRESS                                                     
**********************************************************************          
*                                                                               
EDRMA    NTR1                                                                   
*                                                                               
         MVC   BEREC(2),=Y(BERMALN)                                             
         MVI   BEKRCLS,EDRSRTMQ    MAIN SORT GROUP                              
         MVI   BEKRCD,EDRMAQ                                                    
         L     R4,ADSTATAD                                                      
         USING ADDRREC,R4                                                       
         MVC   BERMNAM,ANAME                                                    
         MVC   BERMADR,A1LINE                                                   
         MVC   BERMCTY,A2LINE                                                   
         MVC   BERMSTA,A3LINE                                                   
         MVC   BERMZIP,ABIGZIP                                                  
*                                                                               
         OC    BERMNAM,SPACES                                                   
         OC    BERMADR,SPACES                                                   
         OC    BERMCTY,SPACES                                                   
         OC    BERMSTA,SPACES                                                   
         OC    BERMZIP,SPACES                                                   
*                                                                               
         BAS   RE,EDPUT                                                         
         DROP  R4                                                               
*                                                                               
         B     EDIX                                                             
         EJECT                                                                  
**********************************************************************          
*       END OF INVOICE                                                          
**********************************************************************          
*                                                                               
EDEND    NTR1                                                                   
*                                                                               
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BECLTLN)   CLIENT RECORD                             
         MVI   BEKRCLS,EDRSRTHQ    HEADER CLASS                                 
         MVI   BEKRCD,EDADVQ                                                    
         MVC   BECLT,CLT                                                        
         MVC   BECLTN,CLTNM                                                     
         OC    BECLTN,SPACES                                                    
         L     RF,ADCLT                                                         
         MVC   BECLTICD,CCLTIFC-CLTHDR(RF)                                      
         OC    BECLTICD,SPACES                                                  
         BAS   RE,EDPUT                                                         
*                                                                               
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BEAGMLN)    AGENCY/MEDIA RECORD                      
         MVI   BEKRCLS,EDRSRTHQ    HEADER CLASS                                 
         MVI   BEKRCD,EDAGMQ                                                    
         MVI   BEAGSYS,C'N'        SYSTEM IS N                                  
         MVI   BEAGNSUB,C'N'       SPECIFIC MEDIA                               
         CLI   MEDFILT,C' '                                                     
         BNH   *+10                                                             
         MVC   BEAGNSUB,MEDFILT    MEDIA  N,C,S,ETC.                            
*                                                                               
         LA    RF,EDMEDLST         GET MEDIA NAME                               
EDEND4   DS    0H                                                               
         CLI   0(RF),X'FF'         EOL                                          
         BE    EDEND6                                                           
         CLC   BEAGNSUB,0(RF)                                                   
         BE    EDEND6                                                           
         LA    RF,L'EDMEDLST(RF)                                                
         B     EDEND4                                                           
*                                                                               
EDEND6   DS    0H                                                               
         MVC   BEAGMMN,1(RF)       MEDIA NAME                                   
         MVC   BEAGMAN,AGYNM       AGENCY NAME                                  
         MVC   BEAGMAD,AGYADR      AGENCY ADDRESS                               
         BAS   RE,EDPUT                                                         
*                                  AT END OF INVOICE                            
         BAS   RE,EDTRC            TRACE                                        
*                                                                               
         GOTOR MAKEFILE,DMCB,SPACEND   CREATE OUTPUT FILE                       
*                                                                               
         MVC   TSACOM,ACOMFACS                                                  
         MVI   TSKEYL,BEKLN                                                     
         OI    TSRECI,TSRVAR       SET FOR VARIABLE RECS                        
         MVC   TSRECL,=Y(BERECL)                                                
         MVI   TSOFFACT,TSAINI     RE-INITIALIZE TSAROFF                        
         MVC   TSAREC,=A(BESIZE)                                                
         GOTO1 ATSAROFF,(R6)                                                    
         CLI   TSERRS,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVI   EDNEWSW,X'00'       CLEAR ED ROUTINES NEWSW                      
         B     EDIX                                                             
*                                                                               
EDMEDLST DS    0CL11                                                            
         DC    C'NNETWORK TV'                                                   
         DC    C'CCABLE TV  '                                                   
         DC    C'SSYNDICATN '                                                   
         DC    C'DNET RADIO '                                                   
         DC    C'HHISPANIC  '                                                   
         DC    C'OOTHER     '                                                   
         DC    X'FF',C'NETWORK TV' DEFAULT                                      
         EJECT                                                                  
**********************************************************************          
*        CLOSE                                                                  
**********************************************************************          
*                                                                               
EDCLS    NTR1                                                                   
*                                                                               
         CLI   FRSTSW,0            EDI OPEN?                                    
         BE    ECLX                                                             
         CLI   OUTMODE,C'D'        DATASET OUTPUT                               
         BNE   EDCLS8                                                           
*                                                                               
         CLOSE EDIOUT                                                           
*                                  TRACE OUTPUT FILE                            
         L     RF,APATCH                                                        
         TM    0(RF),X'04'         NEED FINAL TRACE?                            
         BZ    ECLX                                                             
*                                                                               
         MVI   FORCEHED,C'Y'                                                    
*                                                                               
         OPEN  (EDITRC,INPUT)                                                   
*                                                                               
EDCLS2   DS    0H                                                               
         BAS   RE,CLRFREC                                                       
         LA    R2,EDITRC                                                        
         GET   (R2),FREC                                                        
         MVC   P(132),FREC                                                      
         MVI   SKIPSPEC,C'Y'                                                    
         BRAS  RE,PRNT                                                          
         B     EDCLS2                                                           
*                                                                               
*                                  CLOSE FOR WORKER FILE                        
EDCLS8   DS    0H                                                               
         GOTO1 DATAMGR,DMCB,=C'CLOSE',WRKRFIL,0,FREC,AWRKBUFF                   
*                                  NO TRACE OF OUTPUT FILE                      
         B     EDIX                                                             
*                                                                               
*                                                                               
EDTRCEOF DS    0H                                                               
         CLOSE EDITRC                                                           
*                                                                               
ECLX     DS    0H                                                               
         B     EDIX                                                             
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
**********************************************************************          
*        MAKEFILE - CREATE OUTPUT FILE FROM TSAR BUFFER                         
**********************************************************************          
*                                                                               
MAKEFILE NMOD1 0,**MKF***                                                       
         LA    RC,SPACEND                                                       
*                                  READ THRU TSAR BUFFER                        
         ST    R7,TSAREC                                                        
         XC    BREC(BEKLN+2),BREC  CLEAR KEY PLUS LENGTH                        
         MVI   TSOFFACT,TSARDH                                                  
         B     MKF4B                                                            
*                                                                               
MKF4     DS    0H                                                               
         MVI   TSOFFACT,TSANXT                                                  
*                                                                               
MKF4B    DS    0H                                                               
         GOTO1 ATSAROFF,(R6)                                                    
         TM    TSERRS,TSEEOF                                                    
         BO    MKF20                                                            
         TM    TSERRS,X'FF'-TSERNF (RECORD NOT FOUND IS OK)                     
         BZ    *+6                                                              
         DC    H'0'                NO OTHER ERROR IS ACCEPTABLE                 
*                                                                               
*                                  FIND ROUTINE                                 
         LA    RF,MKFROUTS                                                      
         LHI   R0,MKFRTSN                                                       
*                                                                               
MKF5     DS    0H                                                               
         CLC   BREC+5(1),0(RF)                                                  
         BE    *+14                                                             
         LA    RF,L'MKFROUTS(,RF)                                               
         BCT   R0,MKF5                                                          
         DC    H'0'                                                             
*                                                                               
         ICM   RF,15,1(RF)                                                      
         BASR  RE,RF                                                            
         B     MKF4                NEXT TSAR RECORD                             
*                                                                               
MKF20    DS    0H                                                               
         MVI   MFNEWSW,0           CLEAR NEWSW BITS                             
*                                                                               
         B     EDIX                                                             
         EJECT                                                                  
***********************************************************************         
*        MFHDR - INVOICE HEADER                                                 
***********************************************************************         
*                                                                               
MFHDR    NTR1                                                                   
*                                                                               
         TM    MFNEWSW,X'80'       NEW INVOICE?                                 
         BO    MFHDR4                                                           
         OI    MFNEWSW,X'80'                                                    
*                                  YES, START NEW RECORD                        
         CLI   OUTMODE,C'W'        FOR WORKER FILES DO OPEN                     
         BNE   MFHDR08                                                          
*                                                                               
         L     R0,=A(WRKRBUFF)                                                  
         ST    R0,AWRKBUFF                                                      
         L     R1,=A(WRKRBEND-WRKRBUFF)                                         
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
         XC    WRKRIND,WRKRIND                                                  
         LA    R4,FREC                                                          
         USING WLHDRD,R4                                                        
         XC    WLHDRD(WLSOFEND-WLHDRD),WLHDRD                                   
         MVC   WLUSRID,RCORIGID    USER ID                                      
         MVC   WLSYSPRG(L'MED),MED MEDIA                                        
         MVC   WLSYSPRG+1(L'CLT),CLT CLIENT                                     
         MVC   WLSUBPRG,CLT+2       (BROKEN UP INTO TWO FIELDS)                 
         CLI   CLT+2,C' '          SPACE TO DOT                                 
         BH    *+8                                                              
         MVI   WLSUBPRG,C'.'                                                    
         MVI   WLDAY,X'97'         EDI BILLING IDENTIFIER                       
         MVI   WLCLASS,C'N'        SYSTEM = NETPAK                              
*                                                                               
         MVC   WLAGELD,TODAYP                                                   
         MVC   WLUDATA,=X'FFFF'                                                 
         MVC   WLAGELT,=X'FFFF'                                                 
         MVC   WLRETNL,=X'FFFF'                                                 
         MVC   WLRETND,=X'FFFF'                                                 
*                                                                               
         MVC   WLDESC(L'PINVNO),PINVNO   COMMENT                                
         DROP  R4                                                               
*                                                                               
         GOTO1 DATAMGR,DMCB,(0,=C'GFILE'),=C'WRKFIL',                  +        
               WRKRIND,FREC,AWRKBUFF                                            
         LA    R1,WRKRIND                                                       
         USING UKRECD,R1                                                        
         MVC   WRKRFIL,UKUSRINF                                                 
         DROP  R1                                                               
*                                                                               
         GOTO1 DATAMGR,DMCB,=C'OPEN',WRKRFIL,0,FREC,AWRKBUFF                    
         CLI   DMCB+8,0                                                         
         BE    MFHDR08                                                          
         CLI   DMCB+8,X'40'                                                     
         BE    *+6                                                              
         DC    H'0'                                                             
         USING MASTD,RF                                                         
         MVI   MCDUMP,C'O'                                                      
         DROP  RF                                                               
         ABEND 666,DUMP                                                         
*                                                                               
MFHDR08  DS    0H                                                               
         L     RF,ADCLT            FIRST PUT EDI CONTROLS                       
         MVC   FREC+4(45),SPACES                                                
****>    OC    PROFB1A+6(7),=C'0000000'                                         
         OC    PROFB1A+6(7),SPACES  CHANGED PER BPLA MAR/06                     
*                                                                               
         MVI   FREC+04,C'H'        HEADER RECORD                                
         MVC   FREC+05(03),PROFB1A+10  CLIENT FROM B1A PROFILE                  
         MVI   FREC+08,C'N'        SYSTEM=NET                                   
         MVC   FREC+09(L'AGY),AGY  AGENCY                                       
         MVI   FREC+20,C'X'        STANDARD                                     
         MVC   FREC+21(4),PROFB1A+6 VERSION (3040,3050, ETC)                    
         MVC   FREC+25(03),=C'810' DOCUMENT TYPE                                
         MVI   FREC+28,C'P'        PRODUCTION                                   
         CLI   PROOFSW,C'Y'                                                     
         BNE   *+8                                                              
         MVI   FREC+28,C'T'        OR TEST                                      
*                                                                               
         LA    RF,FREC+45+4        MFPUT WILL SET LENGTH                        
         ST    RF,ANXTPOS                                                       
         XC    FREC+2(2),FREC+2                                                 
*                                                                               
         BAS   RE,MFPUT                                                         
*                                  NOW DO INVOICE HEADER RECORD                 
         MVC   ANXTPOS,AFRECP4                                                  
         GOTO1 BLDREC,DMCB,=C'IH'                                               
         GOTO1 BLDREC,DMCB,(10,PINVNO)                                          
         LA    R4,BEDATA                                                        
         USING BILLREC,R4                                                       
         GOTO1 DATCON,DMCB,BQDATE,(17,DUB)                                      
         GOTO1 BLDREC,DMCB,(8,DUB)                                              
         GOTO1 DATCON,DMCB,(3,BDUEDATE),(17,DUB)                                
         GOTO1 BLDREC,DMCB,(8,DUB)                                              
         MVI   WORK,C'A'           SEPARATE ADJUSTMENT BILL                     
         TM    BILSTAT,BSTSADJQ                                                 
         BNZ   MFHDR3                                                           
         MVI   WORK,C'C'           SEPARATE COMMISSION BILL                     
         TM    BILSTAT,BSTSCOMQ                                                 
         BNZ   MFHDR3                                                           
         MVI   WORK,C'N'           NORMAL BILL                                  
*                                                                               
MFHDR3   DS    0H                                                               
         GOTO1 BLDREC,DMCB,(1,WORK)                                             
         GOTO1 BLDREC,DMCB,(8,PSHPDTE) SHIP DATE                                
*                                                                               
         BAS   RE,MFPUT                                                         
*                                                                               
MFHDR4   DS    0H                                                               
         B     EDIX                                                             
         DROP  R4                                                               
         SPACE 2                                                                
***********************************************************************         
*        MFAGM - AGENCY/MEDIA                                                   
***********************************************************************         
*                                                                               
MFAGM    NTR1                                                                   
*                                                                               
         MVC   ANXTPOS,AFRECP4          START NEW RECORD                        
         GOTO1 BLDREC,DMCB,=C'AG'       AGENCY                                  
         GOTO1 BLDREC,DMCB,(33,BEAGMAN) NAME                                    
         GOTO1 BLDREC,DMCB,(33,BEAGMAD) ADDRESS                                 
         BAS   RE,MFPUT                                                         
*                                                                               
         MVC   ANXTPOS,AFRECP4           NEW RECORD                             
         GOTO1 BLDREC,DMCB,=C'ME'        MEDIA                                  
         GOTO1 BLDREC,DMCB,(2,BEAGSYMD)  SYSTEM AND MEDIA CODE                  
         GOTO1 BLDREC,DMCB,(10,BEAGMMN)  MEDIA NAME                             
         BAS   RE,MFPUT                                                         
*                                                                               
         B     EDIX                                                             
         SPACE 2                                                                
***********************************************************************         
*        MFADV - ADVERTISER                                                     
***********************************************************************         
*                                                                               
MFADV    NTR1                                                                   
*                                                                               
         MVC   ANXTPOS,AFRECP4          NEW RECORD                              
         GOTO1 BLDREC,DMCB,=C'AV'                                               
         GOTO1 BLDREC,DMCB,(3,BECLT)    CODE                                    
         GOTO1 BLDREC,DMCB,(24,BECLTN)  NAME                                    
         GOTO1 BLDREC,DMCB,(8,BECLTICD) INTERFACE CODE                          
         BAS   RE,MFPUT                                                         
*                                                                               
         B     EDIX                                                             
         SPACE 2                                                                
***********************************************************************         
*        MFADD - BILLING ADDRESS                                                
***********************************************************************         
*                                                                               
MFADD    NTR1                                                                   
*                                                                               
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         GOTO1 BLDREC,DMCB,=C'BT'                                               
         GOTO1 BLDREC,DMCB,(36,BEADDL1)                                         
         GOTO1 BLDREC,DMCB,(36,BEADDL2)                                         
         GOTO1 BLDREC,DMCB,(36,BEADDL3)                                         
         GOTO1 BLDREC,DMCB,(36,BEADDL4)                                         
         GOTO1 BLDREC,DMCB,(36,BEADDL5)                                         
         BAS   RE,MFPUT                                                         
*                                                                               
         B     EDIX                                                             
         SPACE 2                                                                
***********************************************************************         
*        MFPGR - PRODUCT GROUP                                                  
***********************************************************************         
*                                                                               
MFPGR    NTR1                                                                   
*                                                                               
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         MVI   WORK,C'P'           PN IS PGR LEVEL N                            
         MVC   WORK+1(L'BEPGRL),BEPGRL                                          
         GOTO1 BLDREC,DMCB,(2,WORK)                                             
         GOTO1 BLDREC,DMCB,(5,BEPGRC)   CODE                                    
         GOTO1 BLDREC,DMCB,(12,BEPGRD)  DESC                                    
         GOTO1 BLDREC,DMCB,(24,BEPGRN)  NAME                                    
*                                                                               
         BAS   RE,MFPUT                                                         
*                                                                               
         B     EDIX                                                             
         SPACE 2                                                                
***********************************************************************         
*        MFPRD - PRODUCT                                                        
***********************************************************************         
*                                                                               
MFPRD    NTR1                                                                   
*                                                                               
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         GOTO1 BLDREC,DMCB,=C'PR'                                               
         GOTO1 BLDREC,DMCB,(3,BEPRD)    CODE                                    
         GOTO1 BLDREC,DMCB,(24,BEPRDN)  NAME                                    
         MVC   X(8),SPACES              CODE IS ONLY 5 LONG,                    
         MVC   X(L'BEPRICD),BEPRICD     BUT EDI FIELD IS 8                      
         GOTO1 BLDREC,DMCB,(8,X)        INTERFACE CODE                          
         BAS   RE,MFPUT                                                         
*                                                                               
         B     EDIX                                                             
         SPACE 2                                                                
***********************************************************************         
*        MFEST - ESTIMATE                                                       
***********************************************************************         
*                                                                               
MFEST    NTR1                                                                   
*                                                                               
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         GOTO1 BLDREC,DMCB,=C'ES'                                               
         GOTO1 BLDREC,DMCB,(3,BEEST)    CODE                                    
         GOTO1 BLDREC,DMCB,(24,BEESTN)  NAME                                    
         BAS   RE,MFPUT                                                         
*                                                                               
         B     EDIX                                                             
         SPACE 2                                                                
***********************************************************************         
*        MFMGR - MARKET GROUP                                                   
***********************************************************************         
*                                                                               
MFMGR    NTR1                                                                   
*                                                                               
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         MVI   WORK,C'M'           MN IS MGR LEVEL N                            
         MVC   WORK+1(L'BEMGRL),BEMGRL                                          
         GOTO1 BLDREC,DMCB,(2,WORK)                                             
         GOTO1 BLDREC,DMCB,(5,BEMGRC)   CODE                                    
         GOTO1 BLDREC,DMCB,(12,BEMGRD)  DESC                                    
         GOTO1 BLDREC,DMCB,(24,BEMGRN)  NAME                                    
*                                                                               
         BAS   RE,MFPUT                                                         
*                                                                               
         B     EDIX                                                             
         SPACE 2                                                                
***********************************************************************         
*        MFMKT - MARKET                                                         
***********************************************************************         
*                                                                               
MFMKT    NTR1                                                                   
*                                                                               
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         GOTO1 BLDREC,DMCB,=C'MK'                                               
         GOTO1 BLDREC,DMCB,(4,BEMKT)   CODE                                     
         GOTO1 BLDREC,DMCB,(24,BEMKTN) NAME                                     
         BAS   RE,MFPUT                                                         
*                                                                               
         B     EDIX                                                             
         SPACE 2                                                                
***********************************************************************         
*        MFSTA - STATION                                                        
***********************************************************************         
*                                                                               
MFSTA    NTR1                                                                   
*                                                                               
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         GOTO1 BLDREC,DMCB,=C'ST'                                               
         GOTO1 BLDREC,DMCB,(9,BESTA)     CODE                                   
*                                  CITY AND AFF NOT USED FOR NETPAK             
         GOTO1 BLDREC,DMCB,(24,BESTCTY)  CITY                                   
         GOTO1 BLDREC,DMCB,(9,BESTAFF)   AFFILIATION                            
         BAS   RE,MFPUT                                                         
*                                                                               
         B     EDIX                                                             
         SPACE 2                                                                
***********************************************************************         
*        MFUSR - USER DEF RECORDS                                               
***********************************************************************         
*                                                                               
MFUSR    NTR1                                                                   
*                                                                               
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         GOTO1 BLDREC,DMCB,=C'UD'                                               
         GOTO1 BLDREC,DMCB,(2,BEUSRTXT)   DATA POSITION- P1,P2...               
*                                                                               
*              USER LINE IS 8 SPACES, DESC: NAME                                
*              (DESC CAN BE UP TO 20, NAME TO 32)                               
*                                                                               
         LA    R4,BEUSRTXT+10                                                   
         LHI   R0,22+1                                                          
*                                                                               
MFUSR04  DS    0H                                                               
         CLI   0(R4),C':'                                                       
         BE    *+16                                                             
         LA    R4,1(R4)                                                         
         BCT   R0,MFUSR04                                                       
         B     MFUSRX              NO : MEANS NO DATA                           
*                                                                               
         LR    R2,R4               SAVE A(:)                                    
         LA    R0,BEUSRTXT+11                                                   
         SR    R4,R0               R4 = DESC LENGTH                             
*                                                                               
         MVC   X(20),SPACES                                                     
         EX    R4,*+8                                                           
         B     *+10                                                             
         MVC   X(0),BEUSRTXT+10                                                 
*                                                                               
         GOTO1 BLDREC,DMCB,(20,X)                                               
         GOTO1 BLDREC,DMCB,(32,2(R2))                                           
*                                                                               
         BAS   RE,MFPUT                                                         
*                                                                               
MFUSRX   DS    0H                                                               
         B     EDIX                                                             
         SPACE 2                                                                
***********************************************************************         
*        MFUCM - USER COM RECORDS                                               
***********************************************************************         
*                                                                               
MFUCM    NTR1                                                                   
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         GOTO1 BLDREC,DMCB,=C'UC'                                               
         GOTO1 BLDREC,DMCB,(2,BEUCMTXT)   DATA POSITION- P1,P2...               
*                                                                               
*              USER LINE IS 8 SPACES, DESC: NAME                                
*              (DESC CAN BE UP TO 20, NAME TO 32)                               
*                                                                               
         LA    R4,BEUCMTXT+10                                                   
         LHI   R0,22+1                                                          
*                                                                               
MFUCM04  DS    0H                                                               
         CLI   0(R4),C':'                                                       
         BE    *+16                                                             
         LA    R4,1(R4)                                                         
         BCT   R0,MFUCM04                                                       
         B     MFUCMX              SHOULD HAVE FOUND A :                        
*                                                                               
         LR    R2,R4               SAVE A(:)                                    
         LA    R0,BEUCMTXT+11                                                   
         SR    R4,R0             R4 = DESC LENGTH                               
*                                                                               
         MVC   X(20),SPACES                                                     
         EX    R4,*+8                                                           
         B     *+10                                                             
         MVC   X(0),BEUCMTXT+10                                                 
*                                                                               
         GOTO1 BLDREC,DMCB,(20,X)                                               
         GOTO1 BLDREC,DMCB,(32,2(R2))                                           
*                                                                               
         BAS   RE,MFPUT                                                         
*                                                                               
MFUCMX   DS    0H                                                               
         B     EDIX                                                             
         SPACE 2                                                                
***********************************************************************         
*        MFCOM - COMMENT LINE RECORD                                            
*                REGULAR COMMENTS AND NETPAK COMMENTS                           
***********************************************************************         
*                                                                               
MFCOM    NTR1                                                                   
*                                                                               
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         GOTO1 BLDREC,DMCB,=C'CM'                                               
*                                                                               
         LA    R2,LEVNAMS          GET LEVEL NAME                               
         LHI   R0,LEVNAMSN                                                      
*                                                                               
MFCOM4   DS    0H                                                               
         CLC   BECOMLEV,0(R2)                                                   
         BE    *+16                                                             
         LA    R2,L'LEVNAMS(,R2)                                                
         BCT   R0,MFCOM4                                                        
         LA    R2,=C' INV '       IF NOT IN TABLE, ASSUME INVOICE LEVEL         
*                                                                               
         GOTO1 BLDREC,DMCB,(4,1(R2)) LEVEL NAME                                 
*                                                                               
         GOTO1 BLDREC,DMCB,(132,BECOMTXT)                                       
         BAS   RE,MFPUT                                                         
*                                                                               
         B     EDIX                                                             
         SPACE 2                                                                
***********************************************************************         
*        MFDET - DETAIL                                                         
***********************************************************************         
*                                                                               
MFDET    NTR1                                                                   
*                                                                               
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         GOTO1 BLDREC,DMCB,=C'MT'                                               
*                                                                               
         LA    R2,LEVNAMS          GET LEVEL NAME                               
         LHI   R0,LEVNAMSN                                                      
*                                                                               
MFDET4   DS    0H                                                               
         CLC   BEDLEV,0(R2)                                                     
         BE    *+14                                                             
         LA    R2,L'LEVNAMS(,R2)                                                
         BCT   R0,MFDET4                                                        
         DC    H'0'                                                             
*                                                                               
         GOTO1 BLDREC,DMCB,(4,1(R2)) LEVEL NAME                                 
*                                                                               
         GOTO1 BLDREC,DMCB,(8,BEDMOS)                                           
         GOTO1 BLDREC,DMCB,(1,BEDTYP)                                           
         GOTO1 BLDREC,DMCB,(10,BEDPINV)                                         
*                                                                               
         GOTO1 BLDREC,DMCB,(11,BEDOGRS)                                         
         GOTO1 BLDREC,DMCB,(11,BEDONET)                                         
         GOTO1 BLDREC,DMCB,(11,BEDOTAX)                                         
         GOTO1 BLDREC,DMCB,(11,BEDOSPTS)                                        
         GOTO1 BLDREC,DMCB,(11,BEDPGRS)                                         
         GOTO1 BLDREC,DMCB,(11,BEDPNET)                                         
         GOTO1 BLDREC,DMCB,(11,BEDPTAX)                                         
         GOTO1 BLDREC,DMCB,(11,BEDPSPTS)                                        
         BAS   RE,MFPUT                                                         
*                                                                               
         B     EDIX                                                             
         SPACE 2                                                                
***********************************************************************         
*        MFRMA - REMITTANCE ADDRESS                                             
**********************************************************************          
*                                                                               
MFRMA    NTR1                                                                   
*                                                                               
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         GOTO1 BLDREC,DMCB,=C'RA'                                               
         GOTO1 BLDREC,DMCB,(20,BERMNAM) NAME                                    
         GOTO1 BLDREC,DMCB,(24,BERMADR) ADDRESS                                 
         GOTO1 BLDREC,DMCB,(24,BERMCTY) CITY                                    
         GOTO1 BLDREC,DMCB,(03,BERMSTA) STATE                                   
         GOTO1 BLDREC,DMCB,(10,BERMZIP) ZIP                                     
         BAS   RE,MFPUT                                                         
*                                                                               
         B     EDIX                                                             
         SPACE 2                                                                
***********************************************************************         
*        MFLST - PREVIOUS BILL LIST                                             
**********************************************************************          
*                                                                               
MFLST    NTR1                                                                   
*                                                                               
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         GOTO1 BLDREC,DMCB,=C'PI'                                               
         GOTO1 BLDREC,DMCB,(10,BDLSTIN) INVOICE NUMBER                          
         GOTO1 BLDREC,DMCB,(11,BDLSTG)  GROSS                                   
         GOTO1 BLDREC,DMCB,(11,BDLSTN)  NET                                     
         BAS   RE,MFPUT                                                         
*                                                                               
         B     EDIX                                                             
         SPACE 2                                                                
***********************************************************************         
*        MFDUE - FORMULA ADJUSTMENTS AND AMOUNT DUE                             
**********************************************************************          
*                                                                               
MFDUE    NTR1                                                                   
*                                                                               
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         GOTO1 BLDREC,DMCB,=C'AD'                                               
*                                                                               
         LA    R2,LEVNAMS          GET LEVEL NAME                               
         LHI   R0,LEVNAMSN                                                      
*                                                                               
MFDUE4   DS    0H                                                               
         CLC   BDULEV,0(R2)                                                     
         BE    *+14                                                             
         LA    R2,L'LEVNAMS(,R2)                                                
         BCT   R0,MFDUE4                                                        
         DC    H'0'                                                             
*                                                                               
         GOTO1 BLDREC,DMCB,(4,1(R2)) LEVEL NAME                                 
*                                                                               
         GOTO1 BLDREC,DMCB,(1,BDUBB) BILL BASIS (G,N,M)                         
         GOTO1 BLDREC,DMCB,(1,BDUCB) COMMISSION ADJUST BASIS (G,N,M)            
         GOTO1 BLDREC,DMCB,(7,BDUCP) COMMISSION ADJUST % SNNVNNNN               
         GOTO1 BLDREC,DMCB,(11,BDUBBA) BILL BASIS AMOUNT                        
         GOTO1 BLDREC,DMCB,(11,BDUCBA) COMMISSION ADJUST AMOUNT                 
         GOTO1 BLDREC,DMCB,(11,BDUAMT) AMOUNT DUE                               
         BAS   RE,MFPUT                                                         
*                                                                               
         B     EDIX                                                             
         SPACE 3                                                                
         LTORG                                                                  
         EJECT                                                                  
**********************************************************************          
*        COMMON SUBROUTINES AND DATA AREAS                                      
**********************************************************************          
*                                                                               
COMSUBS  DS    0D                                                               
*                                                                               
MODLIST  DS    0XL5                MODE LIST                                    
         DC    AL1(EDMINI),AL4(EDINI)                                           
         DC    AL1(EDMPGR),AL4(EDPGR)                                           
         DC    AL1(EDMPRD),AL4(EDPRD)                                           
         DC    AL1(EDMEST),AL4(EDEST)                                           
         DC    AL1(EDMMGR),AL4(EDMGR)                                           
         DC    AL1(EDMMKT),AL4(EDMKT)                                           
         DC    AL1(EDMSTA),AL4(EDSTA)                                           
         DC    AL1(EDMMTA),AL4(EDMTA)                                           
         DC    AL1(EDMTXT),AL4(EDTXT)                                           
         DC    AL1(EDMCOM),AL4(EDCOM)   OLD COMMENTS                            
         DC    AL1(EDMNCM),AL4(EDNCM)   NETPAK COMMENTS                         
         DC    AL1(EDMEND),AL4(EDEND)                                           
         DC    AL1(EDMLST),AL4(EDLST)                                           
         DC    AL1(EDMDUE),AL4(EDDUE)                                           
         DC    AL1(EDMADD),AL4(EDADD)                                           
         DC    AL1(EDMHDR),AL4(EDHDR)                                           
         DC    AL1(EDMUSR),AL4(EDUSR)                                           
         DC    AL1(EDMUCM),AL4(EDUCM)                                           
         DC    AL1(EDMRMA),AL4(EDRMA)                                           
         DC    AL1(EDMCLS),AL4(EDCLS)                                           
MODLISTN EQU   (*-MODLIST)/L'MODLIST                                            
*                                  TSAR RECORD TYPE EQUATES                     
*                                                                               
MKFROUTS DS    0XL5                MAKEFILE RECORD ROUTINE LIST                 
         DC    AL1(EDAGMQ),AL4(MFAGM)                                           
         DC    AL1(EDADVQ),AL4(MFADV)                                           
         DC    AL1(EDADDQ),AL4(MFADD)                                           
         DC    AL1(EDPGRQ),AL4(MFPGR)                                           
         DC    AL1(EDPRDQ),AL4(MFPRD)                                           
         DC    AL1(EDESTQ),AL4(MFEST)                                           
         DC    AL1(EDMGRQ),AL4(MFMGR)                                           
         DC    AL1(EDMKTQ),AL4(MFMKT)                                           
         DC    AL1(EDSTAQ),AL4(MFSTA)                                           
         DC    AL1(EDHDRQ),AL4(MFHDR)                                           
         DC    AL1(EDMTAQ),AL4(MFDET)                                           
         DC    AL1(EDUSRQ),AL4(MFUSR)                                           
         DC    AL1(EDUCMQ),AL4(MFUCM)                                           
         DC    AL1(EDCOMQ),AL4(MFCOM)                                           
         DC    AL1(EDLSTQ),AL4(MFLST)                                           
         DC    AL1(EDDUEQ),AL4(MFDUE)                                           
         DC    AL1(EDRMAQ),AL4(MFRMA)                                           
MKFRTSN  EQU   (*-MKFROUTS)/L'MKFROUTS                                          
*                                                                               
*              BREAK LEVEL NAMES                                                
*              (SEE BRKEQV IN 'A' BOOK)                                         
LEVNAMS  DS    0XL5                                                             
         DC    AL1(4*PGR1EQ),C'PGR1'      PGR1                                  
         DC    AL1(4*PGR2EQ),C'PGR2'      PGR2                                  
         DC    AL1(4*PGR3EQ),C'PGR3'      PGR3                                  
         DC    AL1(4*PRDEQ),C'PRD '       PRODUCT                               
         DC    AL1(4*ESTEQ),C'EST '       ESTIMATE                              
         DC    AL1(4*MGR1EQ),C'MGR1'      MGR1                                  
         DC    AL1(4*MGR2EQ),C'MGR2'      MGR2                                  
         DC    AL1(4*MGR3EQ),C'MGR3'      MGR3                                  
         DC    AL1(4*MKTEQ),C'MKT '       MARKET                                
         DC    AL1(4*STAEQ),C'STA '       STATION                               
         DC    AL1(4*PKGEQ),C'PKG '       PACKAGE                               
         DC    AL1(4*PGMEQ),C'PGM '       PROGRAM                               
         DC    AL1(4*DESCEQ),C'SPOT'      SPOT DESC                             
         DC    AL1(4*PEREQ),C'PER '       PERIOD                                
         DC    AL1(4*PERGEQ),C'PERG'      PERIOD GROUP                          
         DC    AL1(4*CTYPEQ),C'TYPE'      TYPE - TIME, INT, ETC.                
         DC    AL1(4*DPTEQ),C'DPT '       DAYPART                               
         DC    X'FF',C'INV '              INVOICE                               
LEVNAMSN EQU   (*-LEVNAMS)/L'LEVNAMS                                            
*                                                                               
*                                  TSAR RECORD TYPE EQUATES                     
EDHDRQ   EQU   10                                                               
EDAGMQ   EQU   20                                                               
EDADVQ   EQU   30                                                               
EDADDQ   EQU   32                                                               
EDPGRQ   EQU   40                                                               
EDPRDQ   EQU   50                                                               
EDESTQ   EQU   60                                                               
EDSTAQ   EQU   62                                                               
EDCOMQ   EQU   64                                                               
EDUSRQ   EQU   66                                                               
EDUCMQ   EQU   68                                                               
EDMGRQ   EQU   70                                                               
EDMKTQ   EQU   80                                                               
EDDUEQ   EQU   81                                                               
EDLSTQ   EQU   83                                                               
EDRMAQ   EQU   85                                                               
EDMTAQ   EQU   90                                                               
*                                  SORT SEQUENCE GROUPS                         
EDRSRTHQ EQU   10                  HEADER                                       
EDRSRTAQ EQU   15                  BILLING ADDRESS                              
EDRSRTMQ EQU   20                  MAIN                                         
*                                                                               
FDELIM   EQU   X'5E'               FIELD DELIMITER  (SEMI-COLON)                
*                                                                               
EDIX     XIT1                                                                   
         EJECT                                                                  
*********************************************************************           
*        EDPUT - RECORD TO TSAR                                                 
*********************************************************************           
*                                                                               
EDPUT    NTR1                                                                   
*                                                                               
         MVC   BEKSEQ,SEQNO        SET SEQUENCE NUMBER                          
         LH    RF,SEQNO            AND BUMP                                     
         AHI   RF,1                                                             
         STH   RF,SEQNO                                                         
*                                                                               
         LA    R1,BREC                                                          
         ST    R1,TSAREC                                                        
         MVI   TSOFFACT,TSAADD                                                  
         GOTO1 ATSAROFF,(R6)                                                    
         CLI   TSERRS,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         BAS   RE,CLRBREC          SET BUFFER RECORD TO SPACES                  
*                                                                               
         B     EDIX                                                             
         SPACE 2                                                                
*********************************************************************           
*        MFPUT - RECORD TO OUTPUT FILE                                          
*********************************************************************           
*                                                                               
MFPUT    NTR1                                                                   
*                                                                               
         L     R2,ANXTPOS          SET RECORD LENGTH                            
         S     R2,AFREC                                                         
         STCM  R2,3,FREC                                                        
*                                                                               
         CLI   OUTMODE,C'D'        DATASET OUTPUT                               
         BE    MFPUT4                                                           
*                                  ELSE WORKER OUTPUT                           
         GOTO1 DATAMGR,DMCB,=C'ADD',WRKRFIL,WRKRIND,FREC,AWRKBUFF               
         CLI   DMCB+8,0            *** DEIS -- WAS TM INSTRUCTION ***           
         BE    MFPUT6                                                           
         DC    H'0'                                                             
*                                                                               
MFPUT4   DS    0H                                                               
         LA    R2,EDIOUT                                                        
         PUT   (R2),FREC                                                        
*                                                                               
MFPUT6   DS    0H                                                               
         B     EDIX                                                             
         EJECT                                                                  
*********************************************************************           
*        TRACE TSAROFF BUFFER                                                   
*********************************************************************           
*                                                                               
EDTRC    NTR1                                                                   
*                                                                               
         L     RF,APATCH                                                        
         TM    0(RF),X'08'         NEED TRACE?                                  
         BZ    EDTRX                                                            
*                                                                               
         LA    R4,BREC                                                          
         ST    R4,TSAREC                                                        
         XC    BREC(BEKLN+2),BREC  CLEAR KEY PLUS LENGTH                        
         MVI   TSOFFACT,TSARDH                                                  
         B     EDTR4B                                                           
*                                                                               
EDTR4    DS    0H                                                               
         MVI   TSOFFACT,TSANXT                                                  
*                                                                               
EDTR4B   DS    0H                                                               
         GOTO1 ATSAROFF,(R6)                                                    
         TM    TSERRS,TSEEOF                                                    
         BO    EDTRX                                                            
         TM    TSERRS,X'FF'-TSERNF (RECORD NOT FOUND IS OK)                     
         BZ    *+6                                                              
         DC    H'0'                NO OTHER ERROR IS ACCEPTABLE                 
*                                                                               
         SR    R0,R0                                                            
         ICM   R0,3,0(R4)                                                       
         GOTO1 PRNTBL,DMCB,=C'**EDI**',0(R4),C'DUMP',(R0),=C'1D'                
         B     EDTR4                                                            
*                                                                               
EDTRX    DS    0H                                                               
         B     EDIX                                                             
         EJECT                                                                  
**********************************************************************          
*        CLEAR RECORD AREAS                                                     
**********************************************************************          
*                                                                               
CLRBREC  NTR1                                                                   
*                                                                               
         LA    R0,BREC             SET BUFFER RECORD TO SPACES                  
         LHI   R1,L'BREC                                                        
         SR    RE,RE                                                            
         LHI   RF,C' '                                                          
         SLL   RF,24                                                            
         MVCL  R0,RE                                                            
*                                                                               
         B     EDIX                                                             
         SPACE 2                                                                
CLRFREC  NTR1                                                                   
*                                                                               
         LA    R0,FREC+4           SET FILE RECORD TO SPACES                    
         LHI   R1,L'FREC-4                                                      
         SR    RE,RE                                                            
         LHI   RF,C' '                                                          
         SLL   RF,24                                                            
         MVCL  R0,RE                                                            
         XC    FREC(4),FREC                                                     
*                                                                               
         B     EDIX                                                             
         EJECT                                                                  
***********************************************************************         
*        BLDREC -  ADD DATA ITEM TO RECORD                                      
*                  P1 POINTS TO ITEM, BYTE 0 = LENGTH                           
***********************************************************************         
         SPACE 2                                                                
BLDREC   NTR1                                                                   
*                                                                               
         SR    R2,R2                                                            
         ICM   R2,7,1(R1)          A(DATA ITEM)                                 
         SR    RF,RF                                                            
         ICM   RF,1,0(R1)          LENGTH                                       
         BNZ   BR02                                                             
*                                  ZERO LENGTH GIVEN                            
         CLI   OUTMODE,C'W'        VARIABLE LENGTH FLDS FOR WKR FILES           
         BE    BR03                                                             
         CLI   PROFB1A+5,C'F'      OTHERWISE MAY BE FIXED                       
         BNE   BR03                                                             
*                                                                               
         LHI   RF,1                ASSUME 1                                     
         LA    R2,SPACES           SPACE                                        
         B     BR03                                                             
*                                                                               
BR02     DS    0H                  NON-ZERO LENGTH                              
         CLI   OUTMODE,C'W'        VARIABLE LENGTH FLDS FOR WKR FILES           
         BE    *+12                                                             
         CLI   PROFB1A+5,C'F'      OTHERWISE MAY BE FIXED                       
         BE    BR03                                                             
*                                                                               
         AR    RF,R2               STRIP ANY TRAILING BLANKS                    
         BCTR  RF,0                                                             
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         SR    RF,R2                                                            
         BNM   *+10                                                             
         SR    RF,RF                                                            
         B     BR03                                                             
         LA    RF,1(RF)                                                         
*                                                                               
BR03     DS    0H                                                               
         L     R3,ANXTPOS          WHERE TO PUT                                 
         LA    R4,1(RF,R3)                                                      
         C     R4,AFRECX                                                        
         BL    *+6                                                              
         DC    H'0'                RECORD OVERFLOW                              
*                                                                               
         LTR   RF,RF                                                            
         BNP   BR06                                                             
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R3),0(R2)                                                    
         LA    R3,1(R3,RF)                                                      
*                                                                               
BR06     DS    0H                                                               
         CLI   OUTMODE,C'W'        VARIABLE LENGTH FLDS FOR WKR FILES           
         BE    *+12                NO FIELD DELIMITER                           
         CLI   PROFB1A+5,C'F'      OTHERWISE MAY BE FIXED                       
         BE    *+12                                                             
         MVI   0(R3),FDELIM                                                     
         LA    R3,1(R3)                                                         
*                                                                               
         ST    R3,ANXTPOS                                                       
*                                                                               
         XIT1                                                                   
*                                                                               
         DROP  R9,R7,R6,R5                                                      
         EJECT                                                                  
EDIOUT   DCB   DDNAME=EDIOUT,DSORG=PS,RECFM=VB,MACRF=PM                         
*                                                                               
EDITRC   DCB   DDNAME=EDIOUT,DSORG=PS,RECFM=VB,MACRF=GM,EODAD=EDTRCEOF          
*                                                                               
OUT      DCB   DDNAME=OUT,DSORG=PS,RECFM=VB,MACRF=(GM,PM),LRECL=512,   +        
               EODAD=INVR29                                                     
         SPACE 2                                                                
FRSTSW   DC    X'00'                                                            
SEQNO    DC    H'1'                                                             
MFNEWSW  DC    X'00'                                                            
EDNEWSW  DC    X'00'                                                            
*                                                                               
EDMODE   DS    X                                                                
EDPARMS  DS    6F                                                               
TSARB    DS    XL(TSARDL)                                                       
*                                                                               
BREC     DS    XL300               TSAR BUFFER RECORD                           
FREC     DS    XL300               OUTUT FILE RECORD                            
*                                                                               
ABREC    DS    A                                                                
AFREC    DS    A                                                                
AFRECP4  DS    A                                                                
ABRECX   DS    A                                                                
AFRECX   DS    A                                                                
ANXTPOS  DS    A                                                                
*                                                                               
AWRKBUFF DS    A                                                                
WRKRIND  DS    XL44                                                             
WRKRFIL  DS    CL8                                                              
*                                                                               
         LTORG                                                                  
         TITLE 'SPBUNETNU - BU NETWORK UNIT RECORD HANDLER'                     
***********************************************************************         
*                                                                               
*  - CODE TO HANDLE SPECIFIC PIGGYBACK PAIR ADDED NOV13/92.                     
*    ONLY UNITS THAT CURRENTLY HAVE THE SPECIFIC PAIR ARE                       
*    PROCESSED. ALL PREVIOUS BILLING FOR EITHER PRODUCT IS                      
*    PICKED UP. MAYBE NOT PERFECT BECAUSE IT DOESN'T HANDLE SMOOTHLY            
*    CASES WHERE THE UNIT WAS FOR A-B AND IS NOW JUST A, FOR                    
*    EXAMPLE. BUT SHOULD BE OK.                                                 
*                                                                               
*    COST2 FEATURES-                                                            
*                                                                               
*      1- ASSIGNED IS CLIENT COST WHICH IMPLIES THEY CAN'T BILL                 
*         ASSIGNED IN THE NORMAL SENSE.                                         
*                                                                               
*      2- SINCE ASSIGNED EXISTS ONLY FOR TIME COSTS, THERE CAN BE NO            
*         SEPARATE CLIENT COST FOR OTHER TYPES. IT MUST BE EQUAL TO             
*         AGENCY COST.                                                          
*                                                                               
*      3- PAYMENTS ARE NOT BY ASSIGNED, SO BILLING PAID ITEMS ONLY              
*         CAN BE BASED ONLY ON AGENCY GROSS/NET.                                
*                                                                               
*      4 - MORE....                                                             
*                                                                               
***********************************************************************         
NETNU    NMOD1 SHCUMEQ,NETNU,R7                                                 
         LR    R9,RC               SAVE STORAGE POINTER                         
         LA    RC,SPACEND                                                       
         ST    R9,STBASE           STORE RD STORAGE BASE REG                    
*                                                                               
         MVC   SAVR1,0(R1)         SAVE 1ST PARAM- A(ACCUMULATOR)               
         L     R9,=A(NETBLK)                                                    
         USING NETBLOCK,R9                                                      
*                                                                               
         BC    0,NTU8              ONCE ONLY                                    
         OI    *-3,X'F0'                                                        
*                                                                               
         L     R4,ADBUY            USE AS WORK AREA FOR OPEN                    
         GOTO1 DATAMGR,DMCB,=C'OPEN',=C'SPOT',NUFLIST,(R4)                      
*                                                                               
         XC    SVNETVAL,SVNETVAL                                                
         B     NTU8                                                             
*                                                                               
NUFLIST  DC    CL8'UUNTFIL'                                                     
         DC    CL8'NUNTDIR'                                                     
         DC    CL8'UXSPFIL'                                                     
         DC    CL8'UXSPDIR'                                                     
         DC    CL10'X'                                                          
*                                                                               
NTU8     DS    0H                                                               
         CLI   NETNUMOD,C'W'       IF CALLED FOR WRITE                          
         BNE   *+12                RE-WRITE RECORDS                             
         BRAS  RE,NTU60                                                         
         B     NTUX                                                             
*                                                                               
*        MVI   BPTNR,0                                                          
*        CLI   QPTNR,C' '          PIGGY PAIR REQUEST?                          
*        BNH   NTU8B                                                            
*        L     RF,VCLIST           YES, GET 1-BYTE PRODUCT CODE                 
*                                                                               
*TU8A4   DS    0H                                                               
*        CLI   0(RF),0                                                          
*        BNE   *+6                                                              
*        DC    H'0'                                                             
*        CLC   0(3,RF),QPTNR                                                    
*        BNE   *+14                                                             
*        MVC   BPTNR,3(RF)                                                      
*        B     NTU8B                                                            
*        LA    RF,4(RF)                                                         
*        B     NTU8A4                                                           
*                                                                               
*TU8B    DS    0H                                                               
         MVC   BCQSTRT,SPACES                                                   
         XC    BCQENDP,BCQENDP                                                  
         CLI   PROFBN+13,C'Y'      IF BROADCAST/CALENDAR MIX                    
         BNE   NTU8K                                                            
         MVC   WORK(L'QSTART),QSTART  SET BCQSTRT AND BCQEND                    
         MVC   WORK+4(2),=C'01'                                                 
         GOTO1 GETBROAD,DMCB,(1,WORK),WORK+6,GETDAY,ADDAY                       
         MVC   BCQSTRT,WORK+6                                                   
*                                                                               
         MVC   WORK(L'QEND),QEND                                                
         MVC   WORK+4(2),=C'01'                                                 
         GOTO1 GETBROAD,DMCB,(1,WORK)                                           
         GOTO1 DATCON,DMCB,WORK+12,(2,BCQENDP)                                  
*                                                                               
NTU8K    DS    0H                                                               
         CP    MANGRS,=P'0'        SPECIAL ROUTINE FOR MANUAL BILLING           
         BNE   NTU50                                                            
*                                                                               
         LA    RE,NETBLOCK                                                      
         LHI   RF,NBBLKEND-NETBLOCK                                             
         XCEF                                                                   
         MVC   NBNETVAL,SVNETVAL   RESTORE A(NETVAL)                            
*                                  SET SELECT OPTIONS                           
         MVC   NBSELAGY,QAGY       AGENCY                                       
         MVC   NBSELMED,QMED       MEDIA                                        
         CLI   MEDFILT,C' '        IF HAVE MEDIA FILTER                         
         BNH   *+10                                                             
         MVC   NBSELMFL,MEDFILT    SET IT                                       
         MVC   NBSELCLI,CLT        CLIENT                                       
         MVC   NBSELPRD,=C'POL'    ALWAYS ASK FOR ALL PRODUCTS                  
*                                                                               
         MVC   NBSELEST,BEST       ESTIMATE NUMBER                              
         MVC   NBSELESE,BESTEND    ESTIMATE END NUMBER                          
         CLC   =C'NO',QEST                                                      
         BNE   *+14                                                             
         MVC   NBSELEFL,QESTEND    ESTIMATE FILTER                              
         BAS   RE,ESTMASK          SET ESTIMATE MASK                            
*                                                                               
         CLC   NBSELEFL,SPACES                                                  
         BNE   *+10                                                             
         XC    NBSELEFL,NBSELEFL                                                
*                                                                               
         OC    MANRVDTP,MANRVDTP   REVERSAL BILL?                               
         BZ    *+18                NO                                           
         CLC   =C'NO',QEST         ALL ESTIMATE REQUEST?                        
         BNE   *+8                 NO                                           
         BAS   RE,SETESMSK         SET ESTIMATE MASK                            
*                                                                               
         MVC   NBSELPAK,PKGREQ                                                  
         MVC   NBSELSTR,QSTART                                                  
         MVC   NBSELEND,QEND                                                    
         CLI   PGSW2,C'Y'          FOR P&G SPECIAL FISCAL SET END DATE          
         BNE   *+10                                                             
         MVC   NBSELEND,QENDPG                                                  
*                                                                               
         CLI   PROFBN+13,C'Y'      IF BRD/CAL MIX                               
         BNE   *+10                SET NBSELSTR TO BRDCAST MONTH START          
         MVC   NBSELSTR,BCQSTRT    NOTE, NBSELSTR IS EARLIEST OF                
*                                  BC VS. CAL STARTS, AND NBSELEND IS           
*                                  LATEST OF ENDS                               
*                                                                               
         CLI   QSTA,C'A'           SINGLE NETWORK REQUEST?                      
         BL    NTU9                                                             
         CLI   QSTA,C'Z'                                                        
         BH    NTU9                                                             
         CLC   =C'ALL',QSTA                                                     
         BE    NTU9                                                             
         MVC   NBSELNET,QSTA                                                    
*                                                                               
NTU9     DS    0H                                                               
         CLI   DPTFILT,C' '        DAYPART FILTER                               
         BNH   *+10                                                             
         MVC   NBSELDP,DPTFILT                                                  
*                                  SET DATA OPTIONS                             
         MVI   NBDATA,C'U'         UNITS                                        
         CLI   PKGCTL,C'N'                                                      
         BE    *+8                                                              
         MVI   NBDATA,C'B'         UNITS AND PACKAGES                           
         MVI   NBSEQ,C'D'          DATE SEQUENCE                                
         MVI   NBTRCOPT,C'N'       NETIO TRACE, PATCH IF YOU WANT IT            
         MVI   NBFUNCT,NBFNORM     NORMAL FUNCTION                              
         MVI   NBUSER+13,C'N'      SET TO PASS PRE-EMPTS                        
*                                                                               
         MVC   NBAIO,=A(NETIOIO)   FOR NBAIO                                    
         MVC   NBPRINT,PRINT                                                    
         MVC   NBLOADER,LOADER                                                  
         MVC   NBACOM,ACOMFACS                                                  
*                                                                               
         MVC   NBANBUFF,=A(NMTABLE) NETWORK/MEDIA TABLE FOR NETIO               
*                                                                               
         XC    PKGTABN,PKGTABN     CLEAR PKG TABLE                              
         XC    SPTSEQ,SPTSEQ                                                    
*                                                                               
         SR    R0,R0               BINSRCH PARMS FOR NET TABLE                  
         L     R1,=A(NETTBL)                                                    
         SR    R2,R2                                                            
         LHI   R3,NETTBLN                                                       
         LHI   R4,4                                                             
         LHI   R5,MAXNETS                                                       
         STM   R0,R5,NTBPARS                                                    
*                                                                               
NTU10    DS    0H                                                               
         GOTO1 NETIO,DMCB,NETBLOCK                                              
         MVC   SVNETVAL,NBNETVAL   SAVE A(NETVAL)                               
         CLI   NBERROR,NBINVPRD    IF INVALID PRODUCT ERROR                     
         BE    NTUX                SKIP REQUEST                                 
         CLI   NBERROR,0                                                        
         BE    *+6                                                              
         DC    H'0'                                                             
         CLI   NBMODE,NBPROCUN                                                  
         BE    NTU12                                                            
         CLI   NBMODE,NBPROCPK                                                  
         BE    NTU40                                                            
         CLI   NBMODE,NBREQLST                                                  
         BE    NTUX                                                             
         B     NTU10                                                            
         SPACE 3                                                                
*        PROCESS UNIT                                                           
*                                                                               
NTU12    DS    0H                                                               
         CLI   CORPOPT,C'Y'        FOR CORP OPTION CHECK IF THE EST             
         BNE   NTU120C             FOR THIS CORP PRODUCT EXIST                  
         BRAS  RE,CKCORPES                                                      
         BNE   NTU10               IF EST DOESN'T EXIST FOR CORP PRD            
*                                  SKIP THE UNIT, GOTO NXT ONE                  
*                                                                               
NTU120C  CLI   RCTRACE,C'Y'        DUMP RECORD?                                 
         BNE   NTU120G                                                          
         MVC   WK2,SPACES                                                       
         MVC   WK2+10(5),=C'NTU12'                                              
         GOTO1 HEXOUT,DMCB,NBKEY+21,WK2,4,=C'N'                                 
         GOTO1 =V(PRTREC),DMCB,NBAIO,(27,20),PRINT,HEXOUT,C'DOME',     +        
               (15,WK2)                                                         
*                                                                               
NTU120G  DS    0H                                                               
         CLI   SPLITOPT,C'N'                                                    
         BE    NTU120J                                                          
*               FOR PRODUCT SPLITS MUST DO SPECIAL TOSORT NOW TO                
*               DETERMINE IF THIS PARTICULAR UNIT IS SPLIT                      
         MVI   USPLTSW,C'N'        ASSUME NOT SPLIT                             
         L     R5,NBAIO                                                         
         USING NURECD,R5                                                        
**       CLI   NUPRD,0             HAS BRAND BEEN ALLOCATED?                    
         OC    NBPR1CL3,NBPR1CL3   HAS BRAND BEEN ALLOCATED?                    
         BZ    NTU120J             NO -- IGNORE                                 
**       L     RE,VCLIST                                                        
**       CLC   NUPRD,3(RE)                                                      
**       BE    *+12                                                             
**       LA    RE,4(RE)                                                         
**       B     *-14                                                             
*                                                                               
         L     RF,APRD                                                          
         MVC   0(3,RF),NBPR1CL3                                                 
         L     RF,AEST                                                          
         MVC   0(1,RF),NUKEST                                                   
         DROP  R5                                                               
*                                                                               
         MVI   TSMODE,C'U'         DUMMY TOSORT MODE                            
         BRAS  RE,TOSORT           DUMMY TOSORT CALL (SETS USPLTSW)             
         MVI   TSMODE,C'N'         RESET TO NORMAL MODE                         
*                                                                               
NTU120J  DS    0H                                                               
         CLI   QPKGF,C' '          ANY PACKAGE FILTER?                          
         BNH   NTU12A                                                           
         SR    RF,RF                                                            
         ICM   RF,1,PKGNMOPT       LENGTH OF NAME TO USE                        
         BZ    NTU12A              0 MEANS NO PKG NAMES                         
         BRAS  RE,FINDPKG                                                       
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         CLC   PKGNME(0),QPKGF                                                  
         BNE   NTU10                                                            
*                                                                               
NTU12A   DS    0H                                                               
         CLI   PROFBN+13,C'Y'      IF BRD/CAL MIX                               
         BNE   NTU12C                                                           
         BRAS  RE,SETBRD           SET BRDCALSW (BRD VS. CALENDAR)              
         CLI   BRDCALSW,C'B'       BROADCAST MONTH NET                          
         BNE   *+18                                                             
         CLC   NBACTDAT,BCQENDP    DATE MUST NOT BE AFTER BRDCAST               
         BH    NTU10               MONTH END                                    
         B     NTU12C                                                           
*                                                                               
*                                  IF NOT BRD, DATE MUST NOT BE BEFORE          
         CLC   NBACTDAT,BQSTARTP   CALENDAR MONTH START                         
         BL    NTU10                                                            
*                                                                               
NTU12C   DS    0H                                                               
*                                  PREVIOUS BILLING ELEMENTS                    
*                                  -------------------------                    
         MVI   BYTE2,0             CLEAR BILL ACTIVITY SWITCH                   
         LH    R1,SPTSEQ           BUMP SPOT SEQUENCER                          
         AHI   R1,1                                                             
         STH   R1,SPTSEQ                                                        
         MVC   DUB,SPACES                                                       
         MVC   DUB(L'NBACTNET),NBACTNET                                         
         MVI   DUB+4,C'N'                                                       
         GOTO1 MSPACK,DMCB,=C'0000',DUB,BMKTSTA                                 
*                                                                               
         L     R4,=A(NETPTB)       PRODUCT TABLE                                
         MVI   0(R4),X'FF'                                                      
         USING NETPTABD,R4                                                      
         LA    R1,NPTOGRS                                                       
         LA    RF,NPTOAMTS+NPTBAMTS(R1)   POINT PAST AMOUNTS                    
         BRAS  RE,ZAPSTR           ZAP AMOUNTS                                  
*                                                                               
         CLI   PCTCTL,C'N'         % BILLING CONTROL SAYS                       
         BE    NTU14               NO PREVIOUS BILLING                          
         CLI   PREVSW,C'N'         'NO PREV' IN REQUEST                         
         BE    NTU14                                                            
*                                                                               
         CLI   PROFB1S+3,C'Y'      READING UNIT BILLING RECS ?                  
         BE    *+12                                                             
         CLI   PROFB1S+3,C'R'                                                   
         BNE   NTU12K              NO, GET X'10' ELEMS FROM UNIT REC            
*                                                                               
*                                  OTHERWISE READ NEW NEUBILL RECS              
         L     RF,=A(XTRWK)     USE XTRWK TO BIULD PARAMS TO NEUBILLRDR         
         XC    0(NBLLENQ,RF),0(RF)                                              
         USING NBLBILLD,RF                                                      
         MVC   NBLUNAIO,NBAIO      A(UNIT REC)                                  
         LA    R1,WK                                                            
         ST    R1,NBL10AIO         A(TO RETURN X'10' ELEM)                      
         L     R1,=A(PROC10EL)    A(OF MY ROUTINE TO READ NEGENUBILL)           
         ST    R1,NBLAHOOK                                                      
         OI    NBLFUNC,NBLHRAW     RETURN NEW X'10' ELEMS                       
         ST    RF,NBABILRD                                                      
         DROP  RF                                                               
         GOTO1 =V(NETBLRDR),DMCB,NETBLOCK CALL READER TO GET NUBILL REC         
         B     NTU14               DONE, GO PROCESS ORDERED AMNTS               
*                                                                               
*                       READING UNIT REC FOR PREV BILLING                       
NTU12K   L     R2,NBAIO                                                         
         LA    R2,NUDATA-NURECD(R2)                                             
         MVI   ELCODE,X'10'        BILL ELEMENT                                 
*                                                                               
NTU13    DS    0H                                                               
         BRAS  RE,NXTEL                                                         
         BNE   NTU14                                                            
*                                                                               
         USING NUBILD,R2                                                        
         TM    NUBILST,NUBILUBQ    SKIP IF UNBILLED                             
         BNZ   NTU13                                                            
*                                                                               
         CLI   NUBILTYP,C'T'       FOR TIME BILLING                             
         BNE   NTU138                                                           
*                                                                               
         CLI   PROFBN+3,C'D'       DOING ACT MINUS ASS PLUS INT                 
         BE    *+12                                                             
         CLI   PROFBN+3,C'E'       DOING AMA (ACTUAL MINUS ASSIGNED)?           
         BNE   *+16                                                             
         TM    NUBILST,NUBILAMQ    SKIP IF NOT AMA ELEMENT                      
         BZ    NTU13                                                            
         B     NTU138                                                           
*                                                                               
*                                  NOT DOING AMA                                
         TM    NUBILST,NUBILAMQ    SKIP IF AMA ELEMENT                          
         BNZ   NTU13                                                            
*                                                                               
NTU138   DS    0H                                                               
         CLI   SCBNCSW,C'C'        SEPARATE COMMISSION BILLING?                 
         BNE   *+16                                                             
         TM    NUBILST,NUBILSCQ    ELEMENT MUST BE AS WELL                      
         BZ    NTU13                                                            
         B     NTU139                                                           
*                                                                               
         CLI   SCBNCSW,C'N'        NET BILLING?                                 
         BNE   *+16                                                             
         TM    NUBILST,NUBILSNQ    ELEMENT MUST BE AS WELL                      
         BZ    NTU13                                                            
         B     NTU139                                                           
*                                                                               
         TM    NUBILST,NUBILSCQ+NUBILSNQ   ELSE ELEMENT MUST BE NEITHER         
         BNZ   NTU13                       SEPARATE COMM. OR NET ONLY           
*                                                                               
NTU139   DS    0H                                                               
         OC    IGNDATE,IGNDATE     'IGNORE' DATE?                               
         BZ    *+14                                                             
         CLC   NUBILDAT,IGNDATE    YES, DROP PREVIOUS ON OR AFTER               
         BNL   NTU13                                                            
*                                                                               
         MVC   WPRD,NUBILPRD                                                    
         CLI   NUBILLEN,29         LONGER ELEMENT ?                             
         BL    *+24                                                             
         OC    NUBILPRC,NUBILPRC   IS THERE 3 CHAR PRODUCT?                     
         BZ    *+14                                                             
         MVC   WPRDC,NUBILPRC                                                   
         B     NTU13A1                                                          
*                                                                               
         L     RF,VCLIST                                                        
         CLC   WPRD,3(RF)                                                       
         BE    *+12                                                             
         LA    RF,4(RF)                                                         
         B     *-14                                                             
*                                                                               
         MVC   WPRDC,0(RF)                                                      
NTU13A1  BRAS  RE,CKPRD                                                         
         BNE   NTU13                                                            
*                                                                               
         L     R5,=A(CTYPLST)      GET INTERNAL TYPE CODE                       
         USING CTYLD,R5                                                         
NTU13A2  CLC   NUBILTYP,CTYLCOD                                                 
         BE    *+18                                                             
         LA    R5,CTYLSTL(R5)                                                   
         CLI   0(R5),X'FF'                                                      
         BNE   NTU13A2                                                          
         DC    H'0'                                                             
         DROP  R5                                                               
*                                                                               
*                                  TEST AGAINST REQUEST COST TYPES              
         BAS   RE,CKTYPE                                                        
         BNE   NTU13               TYPE NOT OK                                  
*                                                                               
         OC    MANRVDTP,MANRVDTP   REVERSAL?                                    
         BZ    NTU13D                                                           
         CLC   NUBILDAT,MANRVDTP   TEST ELEMENT FOR REVERSAL DATE               
         BNE   NTU13               NO-SKIP                                      
         XC    DMCB,DMCB                                                        
         GOTO1 =V(SPFMTINO),DMCB,,(C'P',NUBILNUM)                               
         L     RF,DMCB+4                                                        
         OC    0(2,RF),0(RF)       IF NULLS -> INVALID                          
         BNZ   *+6                                                              
         DC    H'0'                                                             
*******  OC    NUBILNUM,=C'0000'                                                
*******  PACK  DUB,NUBILNUM                                                     
*******  CVB   R0,DUB                                                           
         CLC   MANRVNO,0(RF)         RIGHT INVOICE NUMBER?                      
         BNE   NTU13               NO-SKIP                                      
*                                                                               
NTU13D   DS    0H                                                               
         TM    NUBILST,NUBILRDQ+NUBILRLQ                                        
         BNZ   *+12                IF NEITHER REVERSED NOR REVERSAL,            
         OI    BYTE2,X'01'          THEN SET: RECORD HAS BILL ELEMENT           
         B     NTU13D2                                                          
*                                                                               
         TM    NUBILST,NUBILRDQ    ELSE LEAVE BYTE2 NON-NULL                    
         BZ    *+8                 IF REVERSED AND REVERSALS                    
         OI    BYTE2,X'80'         DON'T CANCEL EACH OTHER OUT                  
         TM    NUBILST,NUBILRLQ                                                 
         BZ    *+8                                                              
         XI    BYTE2,X'80'         FLIP STATUS BIT                              
*                                                                               
NTU13D2  DS    0H                                                               
         XC    WFEED,WFEED         NO FEED CODE                                 
         XC    WMKTSTA,WMKTSTA     NO CUT-IN STATION                            
         BAS   RE,FNDPRD           GET PRODUCT/TYPE ENTRY                       
         L     R4,WORD             A(ENTRY) RETURNED IN FIELD 'WORD'            
*                                                                               
         CLI   SPLITOPT,C'N'       FOR PRODUCT SPLITS (TEST PROBABLY            
         BE    *+16                NOT NECESSARY, BUT HERE FOR                  
*                                  SAFETY TO ISOLATE CHANGE)                    
         MVC   NPTLNSHR,NBLEN      SET "SHARE" (UNIT LENGTH) IN TABLE           
         MVC   LENSHR,NBLEN        ANOTHER SAFETY FEATURE ???                   
*                                                                               
         ICM   R0,15,NUBILGRS                                                   
         CVD   R0,DUB                                                           
         AP    NPTBGRS,DUB         ADD GROSS                                    
         ICM   R0,15,NUBILNET                                                   
         CVD   R0,DUB                                                           
         AP    NPTBNET,DUB         ADD NET                                      
*                                                                               
         CLI   NUBILLEN,24         LONGER ELEMENT                               
         BNH   NTU13D4             WILL HAVE COST2 AMOUNT                       
         ICM   R0,15,NUBILGR2                                                   
         BZ    NTU13D4                                                          
         CVD   R0,DUB                                                           
         AP    NPTBGR2,DUB         SO ADD IT IN                                 
*                                                                               
NTU13D4  GOTO1 DATCON,DMCB,(2,NUBILDAT),(3,SVINVD)                              
         MVC   NPTIDAT,SVINVD      SAVE LTST INVOICE DATE (+1=MONTH)            
         XC    DMCB,DMCB           AND NUMBER                                   
         GOTO1 =V(SPFMTINO),DMCB,,(C'P',NUBILNUM)                               
         L     RF,DMCB+4                                                        
         OC    0(2,RF),0(RF)       IF NULLS -> INVALID                          
         BNZ   *+6                                                              
         DC    H'0'                                                             
         MVC   NPTINUM,0(RF)                                                    
*******  OC    NUBILNUM,=C'0000'                                                
*******  PACK  DUB,NUBILNUM                                                     
*******  CVB   R0,DUB                                                           
*******  STCM  R0,3,NPTINUM                                                     
*                                                                               
*                                  INVOICE LIST POSTING                         
*                                  --------------------                         
*                                                                               
         CLI   LSTOPT,C'N'         DOING INVOICE LIST?                          
         BE    NTU13                                                            
         CLI   SHOWREV,C'Y'        KEEP REVERSALS                               
         BE    *+12                                                             
         TM    NUBILST,NUBILRDQ+NUBILRLQ  SKIP REVERSED AND REVERSALS           
         BNZ   NTU13                                                            
*                                  SAVE INVOICE FOR LISTING                     
         XC    X,X                                                              
         LA    R6,X                                                             
         USING INVLD,R6                                                         
*                                                                               
         MVC   INVLYRMO,SVINVD     INVOICE YEAR/MONTH                           
         XC    DMCB,DMCB                                                        
         GOTO1 =V(SPFMTINO),DMCB,,(C'P',NUBILNUM)                               
         L     RF,DMCB+4                                                        
         OC    0(2,RF),0(RF)       IF NULLS -> INVALID                          
         BNZ   *+6                                                              
         DC    H'0'                                                             
         MVC   INVLINV,0(RF)                                                    
******** OC    NUBILNUM,=C'0000'                                                
******** PACK  DUB,NUBILNUM                                                     
******** CVB   R0,DUB                                                           
******** STCM  R0,3,INVLINV        INVOICE NUM                                  
*                                                                               
         OC    APGR1BRK,APGR1BRK                                                
         BZ    NTU13F                                                           
         CLC   APGR1BRK,AINVBRK                                                 
         BH    NTU13F                                                           
         MVC   INVLPGR,SAVPGR      PGR                                          
         B     NTU13G                                                           
*                                                                               
NTU13F   DS    0H                                                               
         CLC   APRDBRK,AINVBRK                                                  
         BH    NTU13G5                                                          
NTU13G   DS    0H                                                               
*        L     RF,VCLIST                                                        
*        CLC   NUBILPRD,3(RF)                                                   
*        BE    *+12                                                             
*        LA    RF,4(RF)                                                         
*        B     *-14                                                             
*        MVC   INVLPRD,0(RF)       PRODUCT                                      
         MVC   INVLPRD,WPRDC       PRODUCT                                      
*                                                                               
NTU13G5  CLC   AESTBRK,AINVBRK                                                  
         BH    *+10                                                             
         MVC   INVLEST,NBACTEST    ESTIMATE                                     
*                                                                               
         OC    ADPTBRK,ADPTBRK     DAYPART                                      
         BZ    *+20                                                             
         CLC   ADPTBRK,AINVBRK                                                  
         BH    *+10                                                             
         MVC   INVLDPT,NBACTDP                                                  
*                                                                               
         OC    ASTABRK,ASTABRK                                                  
         BZ    *+20                                                             
         CLC   ASTABRK,AINVBRK                                                  
         BH    *+10                                                             
         MVC   INVLSTA,BSTA        NETWORK                                      
*                                                                               
         OC    APKGBRK,APKGBRK                                                  
         BZ    NTU13H                                                           
         CLC   APKGBRK,AINVBRK                                                  
         BH    NTU13H                                                           
         MVC   INVLPKG,NBPACK      PACKAGE                                      
         CLI   PKGNMOPT,0          PKG NAME OPTION?                             
         BE    NTU13H                                                           
         BRAS  RE,FINDPKG          GET PKG NAME                                 
         ZIC   RF,PKGNMOPT         MOVE UP TO 5 CHARACTERS                      
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   INVLPKG(0),PKGNME                                                
*                                                                               
NTU13H   DS    0H                                                               
         CLI   CTYPCTL,C'S'                                                     
         BNE   *+10                                                             
         MVC   INVLTYP,WTYP        CHARGE TYPE                                  
*                                                                               
         BRAS  RE,SETPER           FIND PERIOD THAT CONTAINS SPOT DATE          
         L     R1,FULL             A(PERLIST ENTRY) RETURNED IN FULL            
         CLC   APERBRK,AINVBRK                                                  
         BH    *+10                                                             
         MVC   INVLPER,PERLMOS-PERLISTD(R1)                                     
*                                                                               
         L     RF,=A(MOSLIST)                                                   
NTU13I   CLI   0(RF),X'FF'         ANYTHING IN MOS TABLE?                       
         BE    NTU13I2             NO, PUT IN MOS                               
         CLC   PERLMOS-PERLISTD(,R1),0(RF)                                      
         BE    NTU13J                                                           
         LA    RF,2(RF)            EXAMINE NXT MOS                              
         B     NTU13I                                                           
NTU13I2  MVC   0(2,RF),PERLMOS-PERLISTD(R1)                                     
         MVI   2(RF),X'FF'                                                      
*                                                                               
NTU13J   L     RE,NUBILGRS                                                      
         CVD   RE,INVLGRS          GROSS                                        
         L     RE,NUBILNET                                                      
         CVD   RE,INVLNET          NET                                          
         CLI   COST2SW,C'Y'        FOR COST2 MODE                               
         BNE   NTU13K                                                           
         CLI   NUBILLEN,24         LONGER ELEMENT                               
         BNH   NTU13K              WILL HAVE COST2 AMOUNT                       
         ICM   RE,15,NUBILGR2                                                   
         BZ    *+8                 PREVENT POSSIBLE BUG                         
         CVD   RE,INVLGRS          OVERRIDE GROSS (NET IS UNCHANGED)            
*                                                                               
NTU13K   LA    RE,*+10             SWITCH TO 31 BIT MODE                        
         O     RE,=X'80000000'                                                  
         BSM   0,RE                                                             
*                                                                               
         MVI   INVTABL,1           INSERT IF NOT FOUND                          
*                                                                               
         GOTO1 BINSR31,INVPARS,X                                                
         OC    1(3,R1),1(R1)                                                    
         BNZ   *+6                                                              
         DC    H'0'                TABLE FULL: MUST INCREASE INVTBN             
*                                                                               
         TM    0(R1),X'80'         ALREADY THERE                                
         BO    NTU13N              NO - NEXT ELEMENT                            
*                                                                               
         L     R1,0(R1)            ADD INTO EXISTING ELEMENT                    
INVLTABD USING INVLD,R1                                                         
         AP    INVLTABD.INVLGRS,INVLGRS                                         
         AP    INVLTABD.INVLNET,INVLNET                                         
NTU13N   LA    RE,*+6              SWITCH BACK TO 24 BIT MODE                   
         BSM   0,RE                                                             
*                                                                               
         B     NTU13                                                            
         DROP  INVLTABD                                                         
         DROP  R6                                                               
         DROP  R2                                                               
*                                  ORDERED AMOUNT PROCESSING                    
*                                  -------------------------                    
NTU14    DS    0H                                                               
         L     R2,NBAIO                                                         
         USING NURECD,R2                                                        
         MVC   LENSHR,NBLEN        SET SECONDS LENGTH                           
         OC    MANRVDTP,MANRVDTP   IF REVERSING                                 
         BNZ   NTU17               SKIP ORDERED AMOUNTS                         
*                                                                               
         CLC   NUPRD,NUPRD2        IF PIGGY-BACK HAS BOTH PRODUCTS              
         BNE   *+8                 THE SAME, TREAT AS NON-PIGGY                 
         MVI   NUPRD2,0            (SLOPPY, BUT SIMPLE - FIXES BUG              
*                                  THAT CAUSED DOUBLING OF 1ST SHARE)           
         CLC   NBPR1CL3,NBPR2CL3   DO THE SAME CHECK FOR CHAR PRD               
         BNE   *+10                WILL EVENTUALLY GET RID OF CODE              
         XC    NBPR2CL3,NBPR2CL3   ABOVE                                        
*                                                                               
         BAS   RE,SETPRDEL         SET PRODUCT SHARE ELEMENT X'14               
         BRAS  RE,SETCPRDE         SET PRODUCT SHARE ELEMENT X'19'              
*                                                                               
         BAS   RE,HOLDCK           CHECK FOR BHOLD RECORDS                      
         BNE   NTU17               SKIP ORDERED AMOUNTS                         
*                                                                               
         CLI   QPTNR,C' '          SPECIFIC PIGGY PAIR REQUEST?                 
         BNH   NTU14A8             NO, DO NORMAL CHECKS                         
         CLI   HPRDEL1+1,17        YES, CAN'T HAVE MORE THAN 2 PRODUCTS         
         BH    NTU17                                                            
*                                  NOTE- CODE HERE USES NUPRD, ETC.             
*                                        NOT NEW NUPRDEL                        
         CLC   NBPR1CL3,KPRDC      DO PRELIMINARY PRODUCT CHECK                 
         BE    NTU14A5             (A-B OR B-A OK)                              
         CLC   NBPR2CL3,KPRDC                                                   
         BNE   NTU17                                                            
         CLC   NBPR1CL3,QPTNR                                                   
         BNE   NTU17                                                            
         B     NTU14A8                                                          
*                                                                               
NTU14A5  DS    0H                                                               
         CLC   NBPR2CL3,QPTNR                                                   
         BNE   NTU17                                                            
*                                                                               
NTU14A8  DS    0H                                                               
         L     R3,STBASE                                                        
         USING SHCUMED,R3                                                       
         LA    RE,SHCUMEPS        CLEAR SHARE CUME PERCENTAGES                  
         LHI   RF,NCTYPS*4                                                      
         XC    0(4,RE),0(RE)                                                    
         LA    RE,4(RE)                                                         
         BCT   RF,*-10                                                          
*                                                                               
         LA    R1,SHCUMEAS                                                      
         LA    RF,L'SHCUMEAS(R1)   POINT PAST AMOUNTS                           
         BRAS  RE,ZAPSTR           ZAP AMOUNT FIELDS                            
         DROP  R3                                                               
*        LA    R3,HPRDEL+NUPRDPR-NUPRDD  FIRST PROD IN PROD SPLIT ELEM.         
*                                        NOW USE 3 CHAR PRODUCT                 
         LA    R3,HPRDEL1+NUPDEPR-NUPDED  FIRST PROD IN X'19'                   
*                                                                               
         BRAS  RE,SETNEW03         CODE TO HANDLE NEW X'03' ELEMS               
         BRAS  RE,SETINT           SEE IF NEED TO SET INTEGRATION               
*                                                                               
NTU15B   DS    0H                                                               
         CLI   0(R3),0             NO MORE PRODS                                
         BE    NTU15K                                                           
**       MVC   WPRD,0(R3)          PRODUCT CODE                                 
**       MVC   WPRD1,0(R3)         PRODUCT CODE                                 
         MVC   WPRDC,0(R3)         3 CHAR PRODUCT                               
**       L     RF,VCLIST           WILL LEAVE THIS CODE FOR NOW                 
**       CLC   WPRDC,0(RF)         JUST IN CASE                                 
**       BE    *+12                                                             
**       LA    RF,4(RF)                                                         
**       B     *-14                                                             
**                                                                              
**       MVC   WPRD,3(RF)                                                       
         MVC   WSHRL,5(R3)         LENGTH SHARE                                 
         CLI   PRDELSW,C'Y'        IF HAVE PRODUCT SPLIT ELEMENT                
         BNE   *+10                                                             
         MVC   WSHRL,NULEN         USE WHOLE SPOT LENGTH                        
         XC    WFEED,WFEED                                                      
         CLI   PROFB1S+4,C'Y'      IF NEW SCREENS AVAILABLE, GET FEED           
         BNE   *+8                 OTHERWISE SKIP IT                            
         BAS   RE,GETFEED                                                       
*                                                                               
         BAS   RE,SETAMTS          GET TIME AND OTHER AMOUNTS                   
*                                  (NEED FOR OTHER PRODUCTS FOR CUMES)          
         BAS   RE,SETSHR           GET SHARE FOR THIS PRODUCT                   
*                                                                               
         BRAS  RE,CKPRD            CHECKS IF THIS IS A PRODUCT WE WANT          
*                                                                               
         BNE   *+8                                                              
         BAS   RE,PSTAMTS          SET AMOUNTS IN PRODUCT TABLE                 
*                                                                               
         LA    R3,7(R3)            NEXT SLOT IN ELEMENT                         
         B     NTU15B                                                           
*                                                                               
NTU15K   DS    0H                                                               
         L     R4,=A(NETPTB)       START OF PRODUCT TABLE                       
*                                                                               
NTU15M   CLI   0(R4),X'FF'         END?                                         
         BE    NTU17               GET NEXT UNIT                                
*                                                                               
*******  OC    WTRDPCT,WTRDPCT     IF TRADE % PRESENT IGNORE BELOW              
*******  BNZ   NTU15R                                                           
         CLC   NPTOGRS,NPTBGRS     ANY BILLABLE?                                
         BNE   NTU15R              IF THE UNIT WAS COMPLETELY BILLED..          
         CLC   NPTONET,NPTBNET     .I.E. ORDERED GROSS/NET$=BILLED$..           
         BNE   NTU15R              BUT COS2 FACTOR WAS CHANGED AFTWDS           
         CLC   NPTBGR2,NPTOGR2     MAKE ORD COS2 SAME AS BLD COS2               
         BE    NTU15R              THUS MAKING IT A ZERO UNIT                   
         CVB   R0,NPTOGR2                                                       
         STCM  R0,15,NPTOVG2       OLD GR2 VALUE WILL PUT IN SORTCOM            
         MVC   NPTOGR2,NPTBGR2     OVERRIDE COS2                                
*******  XC    WTRDPCT,WTRDPCT     THIS CAN ALSO HAPPEN IF TRADE % WAS          
*                                  ADDED AFTER UNIT GOT BILLED                  
NTU15R   LA    R4,NETPTBL(R4)      NEXT ENTRY                                   
         B     NTU15M                                                           
*                                  FIND ZERO STATUS OF WHOLE UNIT               
NTU17    DS    0H                                                               
         MVI   ZLSW,C'N'                                                        
         OC    MANRVDTP,MANRVDTP   NO ZERO LINES FOR REVERSALS                  
         BNZ   NTU18                                                            
         CLI   ZUOPT,C'U'          PRINT ZERO (BILLED) UNIT DETAILS             
         BE    NTU18                                                            
         CLI   BYTE2,0             PRINT UNBILLED FREE SPOTS                    
         BE    NTU18                                                            
*                                                                               
         MVI   ZLSW,C'Y'           SET AS ZERO                                  
         L     R4,=A(NETPTB)       START OF PRODUCT TABLE                       
*                                                                               
NTU17B   DS    0H                                                               
         CLI   0(R4),X'FF'         END?                                         
         BE    NTU18               GET NEXT UNIT                                
*                                                                               
         CLC   NPTOGRS(NPTOAMTS),NPTBGRS   ANY BILLABLE?                        
*                                  FIELDS PACKED, BUT CAN DO CLC (YKVA)         
         BE    *+12                NO-TRY NEXT                                  
         MVI   ZLSW,C'N'           SET OFF ZERO LINE SWITCH                     
         B     NTU18                                                            
*                                                                               
         LA    R4,NETPTBL(R4)      NEXT ENTRY                                   
         B     NTU17B                                                           
*                                                                               
NTU18    DS    0H                                                               
*                                  EACH PRODUCT AND PUT IN NETPTAB              
NTU19    DS    0H                                                               
         L     R4,=A(NETPTB)       START OF PRODUCT TABLE                       
*                                                                               
NTU20    DS    0H                                                               
         CLI   0(R4),X'FF'         END?                                         
         BE    NTU10               GET NEXT UNIT                                
*                                                                               
         L     RF,APATCH           TRACE NETPTAB?                               
         TM    0(RF),X'20'                                                      
         BZ    NTU20A3                                                          
         GOTO1 PRNTBL,DMCB,0,0(R4),1,NETPTBL,=C'1H'                             
*                                                                               
NTU20A3  DS    0H                                                               
         CLI   NPTTYP,TIMEQ        FOR TIME CHARGES TEST TO BILL                
         BNE   NTU21               ONCE EVEN IF ZERO BILLABLE AMOUNT            
*                                                                               
*                                  IF TIME CHARGES NOT IN REQUEST, SKIP         
         CLI   CTYPQ,C' '          'ALL TYPES'                                  
         BE    NTU20A4                                                          
         CLI   CTYPQ,C'3'          'ALL TYPES'                                  
         BE    NTU20A4                                                          
         CLI   CTYPQ,C'4'          TIME/SPECIALS                                
         BE    NTU20A4                                                          
         CLI   CTYPQ,C'1'          TIME/INTEG                                   
         BE    NTU20A4                                                          
         CLI   CTYPQ,C'T'          TIME ONLY                                    
         BNE   NTU21                                                            
*                                                                               
NTU20A4  DS    0H                                                               
         TM    NBUNITST,X'42'      SKIP PRE-EMPT OR MISSED                      
         BNZ   NTU21                                                            
         TM    NURSTAT,X'80'       SKIP DELETED                                 
         BNZ   NTU21                                                            
         DROP  R2                                                               
*                                                                               
         CLI   PAYOPT,C'Y'         BUT IF BILLING PAID ITEMS ONLY               
         BNE   NTU22                                                            
         CLI   PAYSW,C'Y'          DON'T BILL IF NOT PAID                       
         BE    NTU22                                                            
         OC    MANRVDTP,MANRVDTP   FOR REVERSAL CKONLYTI IS NOT SET             
         BNZ   NTU22                                                            
         OC    CKONLYTI,CKONLYTI   DON'T BILL IF NOT PAID                       
         BNZ   NTU22                                                            
*                                                                               
NTU21    DS    0H                                                               
         LA    RE,NPTOGRS                                                       
         LA    RF,NPTAMTS(RE)                                                   
NTU21A   CP    0(ACCUMLQ,RE),=P'0' ANY DATA?                                    
         BNE   NTU21C                                                           
         LA    RE,ACCUMLQ(RE)                                                   
         CR    RE,RF                                                            
         BL    NTU21A                                                           
         B     NTU28               NO-SKIP                                      
*                                                                               
NTU21C   DS    0H                  CHECK IF THIS IS CASH/TRADE UNIT             
         XC    WTRDPCT,WTRDPCT     CLEAR TRADE % FOR SORT COMMENT               
*                                                                               
*                                  ****CHECK IF DOING TRADE %%*****             
         L     R2,NBAIO                                                         
         LA    R2,NUDATA-NURECD(R2)                                             
         MVI   ELCODE,X'18'        FIND TRADE %                                 
         BRAS  RE,NXTEL                                                         
         BNE   NTU22                                                            
         USING NUDTAD,R2                                                        
         MVC   WTRDPCT,NUDTTRAD    SAVE TRADE% FOR SORT COMMENT                 
         DROP  R2                                                               
*                                                                               
*                                                                               
NTU22    DS    0H                                                               
*                                                                               
         MVC   WTYP,NPTTYP                                                      
         MVC   WMKTSTA,NPTSTA                                                   
         MVC   WFEED,NPTFEED                                                    
         MVC   WPRDC,NPTPRDC                                                    
**       L     RF,VCLIST                                                        
**       CLC   WPRDC,0(RF)                                                      
**       BE    *+12                                                             
**       LA    RF,4(RF)                                                         
**       B     *-14                                                             
**                                                                              
**       MVC   WPRD,3(RF)                                                       
         MVC   WPGR,NPTPGR                                                      
*                                                                               
         XC    SORTREC,SORTREC                                                  
         L     R1,ASORTDTA         AND ZAP ACCUMULATORS                         
         LA    RF,ROWTL(R1)                                                     
         BRAS  RE,ZAPSTR                                                        
         BRAS  RE,BUYBK            BUILD KEY AND PASS TO 'SORT'                 
*                                                                               
NTU28    DS    0H                                                               
         LA    R4,NETPTBL(R4)      NEXT ENTRY                                   
         B     NTU20                                                            
         EJECT                                                                  
*        PROCESS PACKAGES                                                       
*                                                                               
NTU40    DS    0H                                                               
         MVC   WORK(L'NBACTNET),NBACTNET                                        
         MVI   WORK+4,C'N'                                                      
         GOTO1 MSPACK,DMCB,=C'0000',WORK,DUB                                    
*                                                                               
PKG      USING PKGTABD,WORK                                                     
         XC    WORK,WORK                                                        
         MVC   PKG.PKGEST,NBACTEST                                              
         MVC   PKG.PKGPKG,NBACTPAK                                              
         MVC   PKG.PKGNET,DUB+2                                                 
         MVC   PKG.PKGPKGNM,NBPAKNAM                                            
         DROP  PKG                                                              
*                                                                               
         LA    RE,*+10             SWITCH TO 31-BIT MODE                        
         O     RE,=X'80000000'                                                  
         BSM   0,RE                                                             
*                                                                               
         MVI   PKGTABL,1           INSERT IF NOT FOUND                          
         GOTO1 BINSR31,PKGPARS,WORK                                             
         OC    0(4,R1),0(R1)                                                    
         BNZ   *+6                                                              
         DC    H'0'                TABLE FULL: MUST INCREASE PKGTBN             
         MVI   PKGTABL,0                                                        
*                                                                               
         LA    RE,*+6              SWITCH BACK TO 24-BIT MODE                   
         BSM   0,RE                                                             
*                                                                               
         B     NTU10               RETURN TO NETIO                              
         EJECT                                                                  
*        MANUAL BILLING                                                         
*                                                                               
NTU50    DS    0H                                                               
         MVI   ZLSW,C'N'                                                        
         MVC   WPRD,KPRD                                                        
         MVC   WPRDC,KPRDC                                                      
         BRAS  RE,CKPRD            WILL GET PGR                                 
         MVC   NBACTEST,BEST                                                    
         MVC   NBACTDAT,PERLIST    SET START DATE                               
         MVC   BSTA,XXSTA                                                       
         MVI   WTYP,TIMEQ          MANUAL BILLS ARE FOR TIME                    
         CLI   QCTYP,C'I'          UNLESS INTEGRATION REQUESTED                 
         BNE   *+8                                                              
         MVI   WTYP,INTEGQ                                                      
*                                                                               
         L     R4,=A(NETPTB)                                                    
         USING NETPTABD,R4                                                      
         XC    0(NETPTBL,R4),0(R4)                                              
         LA    R1,NPTOGRS                                                       
         LA    RF,NPTOAMTS+NPTBAMTS(R1)   POINT PAST AMOUNTS                    
         BRAS  RE,ZAPSTR           ZAP AMOUNTS                                  
         MVC   NPTOGRS,MANGRS      GROSS                                        
         MVC   NPTONET,MANNET      NET                                          
         MVI   NETPTBL(R4),X'FF'                                                
         DROP  R4                                                               
*                                                                               
         BRAS  RE,BUYBK                                                         
*                                                                               
NTUX     DS    0H                                                               
EXIT     XIT1                                                                   
         EJECT                                                                  
SETAMTS  NTR1                                                                   
*                                  SET DOLLAR AMOUNTS IN XTRWK                  
*                                  NOTE- EACH COST TYPE USES 32 BYTES           
*                                     GROSS(8),NET(8),ASS(8),SPARE(8)           
*                                     INTERNAL TYPE IS THE INDEX                
         L     R1,=A(XTRWK)        CLEAR XTRWK                                  
         LA    RF,L'XTRWK(R1)                                                   
         BRAS  RE,ZAPSTR                                                        
*                                  TIME COST                                    
         CLI   PAYOPT,C'Y'         IF DOING PAID                                
         BE    SETAM8              GET AMOUNTS FROM PAY ELEMENTS                
*                                                                               
         TM    NBUNITST,X'42'      IF PRE-EMPT OR MISSED                        
         BNZ   SETAMX                                                           
*                                                                               
         L     RF,NBAIO                                                         
         TM    NURSTAT-NURECD(RF),X'80'       OR DELETED                        
         BNZ   SETAMX              ORDERED = ZERO                               
         BAS   RE,SETTIM           ELSE SET ORDERED TIME CHARGES                
*                                                                               
*                                                                               
         CLI   CTYPQ,C' '          DOING ALL COST TYPES?                        
         BE    SETAM3                                                           
         CLI   CTYPQ,C'3'          ALSO ALL TYPES                               
         BE    SETAM3                                                           
         CLI   CTYPQ,C'1'          TIME/INTEG                                   
         BE    SETAM3                                                           
         CLI   CTYPQ,C'I'          INTEGRATION ALONE                            
         BNE   SETAM6                                                           
*                                  **INTEGRATION**                              
SETAM3   L     R5,=A(CTYPLST)      GET INTERNAL TYPE CODE                       
         USING CTYLD,R5                                                         
SETAM3B  CLI   CTYLCOD,C'I'        FIND ENTRY FOR INTEGRATION                   
         BE    *+18                                                             
         LA    R5,CTYLSTL(R5)                                                   
         CLI   0(R5),X'FF'                                                      
         BNE   SETAM3B                                                          
         DC    H'0'                COST TYPE NOT DEFINED                        
         TM    CTYLCTL,CTYLSCIQ    IS INTEG IN NETPTAB ALREADY?                 
         BNZ   SETAM6              NO, DO IT REGULAR WAY                        
         DROP  R5                  OTHERWISE, DONE                              
*                                                                               
*                                                                               
SETAM4   MVC   FULL,NBINTEG                                                     
         TM    NBUNITST,X'80'      TEST MINUS UNIT                              
         BZ    *+14                                                             
         L     RF,FULL             MAKE AMOUNT NEGATIVE                         
         LNR   RF,RF                                                            
         ST    RF,FULL                                                          
*                                                                               
*                                  GET GROSS AND NET                            
         ZIC   R0,NBRTTYPE         RATE TYPE                                    
         TM    NBPACKST,X'04'      NON-COM INTEGRATION?                         
         BZ    *+12                                                             
         LHI   R0,C'F'             IF SO, NET=GROSS                             
         B     *+14                                                             
         CLI   NBSDRTCV,C'T'       IF RATE TYPE COVERAGE                        
         BNE   *+6                 IS FOR TIME ONLY                             
         SR    R0,R0               THEN INTEGRATION NET = 85%                   
*                                                                               
         GOTO1 =V(NETNET),DMCB,((R0),FULL),DUB                                  
         L     RF,=A(XTRWK)                                                     
         L     RE,DUB              GROSS                                        
         CVD   RE,ROWHL(RF)                                                     
         L     RE,DUB+4            NET                                          
         CVD   RE,ROWHL+ACCUMLQ(RF)                                             
*                                                                               
         CLI   COST2SW,C'Y'                                                     
         BNE   SETAM6                                                           
         L     R2,NBAIO            IF COST2, CHECK IF DOING COST2 INT           
         LA    R2,NUDATA-NURECD(R2)                                             
         MVI   ELCODE,X'74'        COS2 ELEMENT                                 
*                                                                               
         BRAS  RE,NXTEL                                                         
         BNE   SETAM6              NOT THERE? OK FOR NOW - COULD BE             
*                                  OLD UNCORVETED RECORD                        
         USING NUCOS2D,R2                                                       
         TM    NUC2STAT,NUC2INT    IS INTEGRATION AFFECTED ?                    
         BZ    SETAM6              NO, DONE                                     
         L     RF,=A(XTRWK)                                                     
         ICM   RE,15,NUC2AINT      GROS2 FOR INTEGRATION                        
         CVD   RE,ROWHL+ACCUMLQ*2(RF)                                           
         DROP  R2                                                               
*                                                                               
*                                  OTHER CHARGES                                
SETAM6   DS    0H                                                               
         L     R2,NBAIO                                                         
         LA    R2,NUDATA-NURECD(R2)                                             
         MVI   ELCODE,X'03'        SPECIAL RATE ELEMENT                         
*                                                                               
SETAM6D  DS    0H                                                               
         BRAS  RE,NXTEL                                                         
         BNE   SETAMX                                                           
         USING NUSPRD,R2                                                        
         CLI   NUSPRLEN,NUSPRLN1   IS IT OLD STYLE ELEM ?                       
         BE    SETAM6F             YES, SHOULD DO SPEC CHARGES HERE             
         CLI   NUSPRLEN,NUSPRLN4   IS IT NEW FIXED LEN ELEM?                    
         BNE   SETAM6E                                                          
         OC    NUSPRBPC,NUSPRBPC   YES, IS THERE BILLING PRD ?                  
         BNZ   SETAM6D             YES, DONE                                    
         OC    NUSPRCIS,NUSPRCIS   IS THERE C-I STATION?                        
         BNZ   SETAM6D             YES, DONE                                    
         B     SETAM6F                                                          
*                                                                               
SETAM6E  OC    NUSPRBPR,NUSPRBPR   IS THERE BILLING PRD ?                       
         BNZ   SETAM6D             YES, SHOULD BE IN NETPTABD ALREADY           
         CLI   NUSPRLEN,NUSPRLN2   CANNOT HAVE STA AT THIS POINT                
         BNH   SETAM6F                                                          
         OC    NUSPRCIS,NUSPRCIS   IS THERE C-I STATION?                        
         BNZ   SETAM6D             SKIP                                         
*                                                                               
SETAM6F  L     R5,=A(CTYPLST)      GET INTERNAL TYPE CODE                       
         USING CTYLD,R5                                                         
SETAM7   CLC   NUSPRTYP,CTYLCOD                                                 
         BE    SETAM7B                                                          
         LA    R5,CTYLSTL(R5)                                                   
         CLI   0(R5),X'FF'                                                      
         BNE   SETAM7                                                           
         DC    H'0'                COST TYPE NOT DEFINED                        
         DROP  R5                                                               
*                                                                               
SETAM7B  DS    0H                  TEST AGAINST REQUEST COST TYPES              
         BAS   RE,CKTYPE                                                        
         BNE   SETAM6D             TYPE NOT OK                                  
*                                                                               
         ZIC   R4,WTYP             TYPE IS INDEX INTO XTRWK                     
         MHI   R4,ROWHL                                                         
         L     RF,=A(XTRWK)                                                     
         AR    R4,RF                R4 IS --> TO ROW OF $ IN XTRWK              
*                                                                               
         ICM   R0,15,NUSPRAMT      GROSS                                        
         TM    NBUNITST,X'80'      IF MINUS UNIT                                
         BZ    *+6                                                              
         LNR   R0,R0               MAKE AMOUNT NEGATIVE                         
         ST    R0,FULL                                                          
*                                                                               
         CLI   NUSPRCOM,C'C'       IF COMMISSIONABLE USE RATE TYPE              
         BE    SETAM7D                                                          
         CLI   NUSPRCOM,C'Y'                                                    
         BE    SETAM7D             IF NOT COMMISSIONABLE                        
         LHI   R0,C'F'             GROSS=NET                                    
         B     SETAM7F                                                          
SETAM7D  ZIC   R0,NBRTTYPE         ELSE USE RATE TYPE                           
         CLI   NBSDRTCV,C'A'       IF SPECIALS COVERED                          
         BE    SETAM7F                                                          
         CLI   NBSDRTCV,C' '                                                    
         BNH   SETAM7F                                                          
         SR    R0,R0               ELSE NET=85%                                 
         DROP  R2                                                               
*                                                                               
SETAM7F  DS    0H                                                               
         GOTO1 =V(NETNET),DMCB,((R0),FULL),DUB                                  
*                                                                               
         L     RE,DUB              GROSS                                        
         CVD   RE,MYPACKED                                                      
         AP    0(ACCUMLQ,R4),MYPACKED                                           
         L     RE,DUB+4            NET                                          
         CVD   RE,MYPACKED                                                      
         AP    ACCUMLQ(ACCUMLQ,R4),MYPACKED                                     
         B     SETAM6D             NEXT ELEMENT                                 
*                                                                               
*                                  PAID AMOUNTS                                 
SETAM8   DS    0H                                                               
         MVI   PAYSW,C'N'                                                       
         L     R2,NBAIO                                                         
         LA    R2,NUDATA-NURECD(R2)                                             
         MVI   ELCODE,X'12'        PAYING ELEMENT                               
*                                                                               
SETAM8D  DS    0H                                                               
         BRAS  RE,NXTEL                                                         
         BNE   SETAM10                                                          
         USING NUPAYD,R2                                                        
*                                                                               
         L     R5,=A(CTYPLST)      GET INTERNAL TYPE CODE                       
         USING CTYLD,R5                                                         
SETAM9   CLC   NUPAYTYP,CTYLCOD                                                 
         BE    SETAM9B                                                          
         LA    R5,CTYLSTL(R5)                                                   
         CLI   0(R5),X'FF'                                                      
         BNE   SETAM9                                                           
         DC    H'0'                COST TYPE NOT DEFINED                        
         DROP  R5                                                               
*                                                                               
SETAM9B  DS    0H                  TEST AGAINST REQUEST COST TYPES              
         BAS   RE,CKTYPE                                                        
         BNE   SETAM8D             TYPE NOT OK                                  
*                                                                               
         OC    CKONLYTI,CKONLYTI   DOING ANYTHING SPECIAL?                      
         BZ    SETAM9E                                                          
         TM    CKONLYTI,ONLYTI     DID WE FIND ANY PAID X'03' ELEMS?            
         BO    *+16                IF NO -> ONLY EXCLUDE INTEGRATION            
         CLI   NUPAYTYP,C'I'                                                    
         BE    SETAM8D                                                          
         B     SETAM9E                                                          
*                                                                               
         TM    CKONLYTI,NOINT      X'03' PAID ELEMS PRESENT,                    
         BO    *+12                CHECK IF RECORDED PAID INT ALREADY           
         CLI   NUPAYTYP,C'I'       IF NOT, ALLOW TIME AND INT                   
         BE    *+12                                                             
         CLI   NUPAYTYP,C'T'       OTHERWISE ONLY INTEGRATION                   
         BNE   SETAM8D                                                          
*                                                                               
SETAM9E  MVI   PAYSW,C'Y'                                                       
         ZIC   R4,WTYP             TYPE IS INDEX INTO XTRWK                     
         MHI   R4,ROWHL                                                         
         L     RF,=A(XTRWK)                                                     
         AR    R4,RF                                                            
*                                                                               
         ICM   R0,15,NUPAYGRS      GROSS                                        
         CVD   R0,MYPACKED                                                      
         AP    0(ACCUMLQ,R4),MYPACKED                                           
*                                                                               
         ICM   R0,15,NUPAYNET      NET                                          
         CVD   R0,MYPACKED                                                      
         AP    ACCUMLQ(ACCUMLQ,R4),MYPACKED                                     
*                                                                               
         B     SETAM8D             NEXT ELEMENT                                 
         DROP  R2                                                               
*                                                                               
SETAM10  DS    0H                                                               
         L     RF,=A(XTRWK)                                                     
         CP    0(ACCUMLQ,RF),=P'0' TIME GROSS PAID ?                            
         BNE   *+14                                                             
         CP    ACCUMLQ(ACCUMLQ,RF),=P'0' TIME NET PAID ?                        
         BE    SETAM10B            IF NOTHING PAID - OK                         
*                                                                               
         CLI   COST2SW,C'Y'        FOR COST2                                    
         BNE   SETAM10D                                                         
         BAS   RE,SETASN           NEED ASSIGNED FOR COST2                      
         L     RE,DUB                                                           
         L     RF,=A(XTRWK)                                                     
         CVD   RE,ACCUMLQ*2(RF)                                                 
*                                                                               
SETAM10B CLI   COST2SW,C'Y'        COST2 ?                                      
         BNE   SETAMX                                                           
         CP    ROWHL(ACCUMLQ,RF),=P'0' INTEGRATION GROSS PAID ?                 
         BNE   *+14                                                             
         CP    ROWHL+ACCUMLQ(ACCUMLQ,RF),=P'0' INTEG NET PAID ?                 
         BE    SETAMX              IF NOTHING PAID - OK                         
         L     R2,NBAIO            CHECK IF DOING COST2 INT                     
         LA    R2,NUDATA-NURECD(R2)                                             
         MVI   ELCODE,X'74'        COS2 ELEMENT                                 
*                                                                               
         BRAS  RE,NXTEL                                                         
         BNE   SETAMX              NOT THERE? OK FOR NOW - COULD BE             
*                                  OLD UNCORVETED RECORD                        
         USING NUCOS2D,R2                                                       
         TM    NUC2STAT,NUC2INT    IS INTEGRATION AFFECTED ?                    
         BZ    SETAMX              NO, DONE                                     
         L     RF,=A(XTRWK)                                                     
         ICM   RE,15,NUC2AINT      GROS2 FOR INTEGRATION                        
         CVD   RE,ROWHL+ACCUMLQ*2(RF)                                           
         B     SETAMX                                                           
*                                                                               
*                                  (BILLING ON PAID OVERRIDES                   
*                                   ASSIGNED/ACTUAL OPTION)                     
SETAM10D CLI   PROFBN+3,C'*'       BILL ASSIGNED EVEN IF BILLING...             
         BNE   SETAMX               ... CLEARED?                                
*                                  (THIS MEANS BILL CURRENT ASSIGNED            
*                                   IF PAID NOT = ZERO - NOT REALLY             
*                                   BILLING BASED ON PAID!)                     
         BAS   RE,SETTIM           GET TIME ORDERED AMOUNTS                     
*                                                                               
SETAMX   DS    0H                                                               
         J     EXIT                                                             
         EJECT                                                                  
*        GET ORDERED TIME CHARGES                                               
         SPACE 2                                                                
SETTIM   NTR1                                                                   
*                                  TEST TIME CHARGES IN REQUEST                 
         CLI   CTYPQ,C' '          'ALL TYPES'                                  
         BE    SETTIM3                                                          
         CLI   CTYPQ,C'3'          'ALL TYPES'                                  
         BE    SETTIM3                                                          
         CLI   CTYPQ,C'4'          TIME/SPECIALS                                
         BE    SETTIM3                                                          
         CLI   CTYPQ,C'1'          TIME/INTEG                                   
         BE    SETTIM3                                                          
         CLI   CTYPQ,C'T'          TIME ONLY                                    
         BNE   SETTIMX                                                          
*                                                                               
SETTIM3  DS    0H                                                               
         TM    NBUNITST,X'42'      PRE-EMPT OR MISSED                           
         BNZ   SETTIMX                                                          
         L     RF,NBAIO                                                         
         TM    NURSTAT-NURECD(RF),X'80'       OR DELETED                        
         BNZ   SETTIMX             ORDERED = ZERO                               
*                                                                               
         BAS   RE,SETASN           SET ASSIGNED (OR ACTUAL IF NO                
*                                  ASSIGNED) IN DUB                             
*                                                                               
*                                  SET ACTUAL IN DUB+4                          
         XC    DUB+4(4),DUB+4                                                   
         TM    NBUNITST,X'20'      ANY ACTUAL?                                  
         BZ    *+10                                                             
         MVC   DUB+4(L'NBACTUAL),NBACTUAL                                       
*                                                                               
         TM    NBUNITST,X'80'      MINUS UNIT                                   
         BZ    *+14                                                             
         L     RF,DUB+4            MAKE AMOUNT NEGATIVE                         
         LNR   RF,RF                                                            
         ST    RF,DUB+4                                                         
*                                                                               
         CLI   PROFBN+3,C'D'       BILL ACT MINUS ASS PLUS INT?                 
         BE    *+12                                                             
         CLI   PROFBN+3,C'E'       BILL AMA (ACTUAL MINUS ASSIGNED)?            
         BNE   SETTIM3H                                                         
         L     RF,DUB+4            ACTUAL                                       
         S     RF,DUB              LESS ASSIGNED                                
         CLI   PROFBN+3,C'D'       BILL ACT MINUS ASS PLUS INT?                 
         BNE   *+8                                                              
         A     RF,NBINTEG          PLUS INTEGRATION                             
         L     RE,=A(XTRWK)                                                     
         CVD   RF,0(RE)                                                         
         LR    R4,RF                                                            
         B     SETTIM8                                                          
*                                                                               
SETTIM3H DS    0H                                                               
         CLI   PROFBN+3,C'Y'       BILL ACTUAL?                                 
         BE    SETTIM4                                                          
         CLI   COST2SW,C'Y'        BUT DON'T BILL ASSIGNED IF COST2             
         BE    SETTIM4                                                          
         L     RE,=A(XTRWK)                                                     
         L     RF,DUB              NO, USE ASSIGNED                             
         CVD   RF,0(RE)                                                         
         B     SETTIM6                                                          
*                                                                               
SETTIM4  DS    0H                  ACTUAL                                       
         L     RF,DUB+4                                                         
         L     RE,=A(XTRWK)                                                     
         CVD   RF,0(RE)                                                         
*                                                                               
SETTIM6  DS    0H                                                               
         L     R4,DUB              NET BASED ON ASSIGNED                        
         CLI   PROFBN+6,C'Y'       IF PROFILE SAYS SO                           
         BE    SETTIM8                                                          
         L     R4,DUB+4            ELSE BASED ON ACTUAL                         
*                                                                               
SETTIM8  DS    0H                                                               
         ST    R4,FULL                                                          
         GOTO1 =V(NETNET),DMCB,(NBRTTYPE,FULL),DUB                              
         L     RF,=A(XTRWK)                                                     
         L     RE,DUB+4            SET ONLY NET                                 
         CVD   RE,ACCUMLQ(RF)                                                   
         CVD   R4,MYPACKED         CONVERT TO COMPARE                           
         CP    MYPACKED,0(ACCUMLQ,RF) IF GROSS BASIS NOT EQUAL                  
         BNE   *+12                (ASSIGNED/ACTUAL)                            
         L     RE,DUB                                                           
         CVD   RE,0(RF)                                                         
*                                                                               
         XC    WTRDPCT,WTRDPCT     CLEAR TRADE % FOR SORT COMMENT               
         CLI   COST2SW,C'Y'        FOR COST2                                    
         BNE   SETTIMX                                                          
         BAS   RE,SETASN           ALSO NEED ASSIGNED (AS COST2)                
         L     RE,DUB                                                           
         CVD   RE,ACCUMLQ*2(RF)                                                 
         ZAP   MYPACKED,ACCUMLQ*2(ACCUMLQ,RF)                                   
*                                                                               
*                                 *****CHECK IF DOING TRADE %%******            
*                           THEN PUT ONLY CASH PORTION OF ASSIGNED AMNT         
         L     R2,NBAIO                                                         
         LA    R2,NUDATA-NURECD(R2)                                             
         MVI   ELCODE,X'18'        FIND TRADE %                                 
         BRAS  RE,NXTEL                                                         
         BNE   SETTIMX             NO TRADE% -> 100% CASH                       
         USING NUDTAD,R2                                                        
         MVC   WTRDPCT,NUDTTRAD    SAVE TRADE% FOR SORT COMMENT                 
         OC    WTRDPCT,WTRDPCT     NO TRADE% -> 100% CASH                       
         BZ    SETTIMX                                                          
         DROP  R2                                                               
*                                                                               
         LHI   R1,100              CASH% = 100% - TRADE%                        
         SR    R0,R0                                                            
         ICM   R0,3,WTRDPCT                                                     
         SR    R1,R0                                                            
         LTR   R1,R1                                                            
         BP    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CVD   R1,DUB              CONV % TO PKD FOR CALCULATION                
         ZAP   PKBIG,MYPACKED      PUT AMT INTO BIG FIELD FOR MULTIPLY          
         BZ    SETTIMX                                                          
         MP    PKBIG,DUB           APPLY CASH%                                  
         SRP   PKBIG,1,0           FOR ROUNDING                                 
         ZAP   MYPACKED,=P'100'    SET DIVISOR                                  
         DP    PKBIG,MYPACKED      DIVIDE BY 100%                               
         SRP   PKQUOT,64-1,5       ROUND                                        
*                                                                               
         L     RF,=A(XTRWK)                                                     
         ZAP   ACCUMLQ*2(ACCUMLQ,RF),PKQUOT  STORE CASH PORTION                 
*                                                                               
SETTIMX  DS    0H                                                               
         J     EXIT                                                             
         EJECT                                                                  
SETASN   NTR1                                                                   
*                                  SET ASSIGNED IN DUB                          
         XC    DUB(4),DUB                                                       
         OC    DUB(L'NBASSIGN),NBASSIGN USE ASSIGNED                            
         BNZ   SETASN6             IF PRESENT                                   
         TM    NBUNITST,X'08'      OR IF ENTERED AS ZERO                        
         BNZ   SETASN6                                                          
         TM    NBUNITST,X'20'      ELSE TRY ACTUAL                              
         BZ    SETASN6                                                          
         MVC   DUB(L'NBACTUAL),NBACTUAL                                         
*                                                                               
SETASN6  DS    0H                                                               
         TM    NBUNITST,X'80'      MINUS UNIT                                   
         BZ    *+14                                                             
         L     RF,DUB              MAKE AMOUNT NEGATIVE                         
         LNR   RF,RF                                                            
         ST    RF,DUB                                                           
*                                                                               
         J     EXIT                                                             
         EJECT                                                                  
*                                  POST INTO PRODUCT TABLE                      
PSTAMTS  NTR1                                                                   
*                                                                               
         USING NETPTABD,R4                                                      
         L     R3,=A(XTRWK)        AMOUNTS IN EXTRA WORK AREA                   
         LHI   R6,NCTYPS           FOR BCT                                      
         L     R5,=A(CTYPLST)      A(COST TYPE LIST)                            
         XC    WMKTSTA,WMKTSTA                                                  
*                                                                               
         USING CTYLD,R5                                                         
PAM4     MVC   WTYP,CTYLDISP       SET COST TYPE                                
         CLI   WTYP,0              TIME IS ALWAYS 1ST, PASS FEED CODE           
         BE    *+10                                                             
         XC    WFEED,WFEED         CLEAR FOR OTHER CHARGE TYPES                 
         BAS   RE,FNDPRD           GET PRODUCT/TYPE ENTRY                       
         L     R4,WORD             A(ENTRY) RETURNED IN FIELD 'WORD'            
         MVC   NPTLNSHR,LENSHR     SET LENGTH SHARE                             
         AP    NPTOGRS,0(ACCUMLQ,R3)                GROSS                       
         AP    NPTONET,ACCUMLQ(ACCUMLQ,R3)          NET                         
         AP    NPTOGR2,NPTOGR2-NPTOGRS(ACCUMLQ,R3)  2ND GROSS                   
                                                                                
         LA    R3,ROWHL(R3)           NEXT COST TYPE                            
         LA    R5,CTYLSTL(R5)                                                   
         BCT   R6,PAM4                                                          
         DROP  R5                                                               
*                                                                               
         J     EXIT                                                             
         EJECT                                                                  
FNDPRD   NTR1                                                                   
*                                  GET PRODUCT/TYPE TABLE ENTRY                 
         L     R4,=A(NETPTB)       START OF TABLE                               
FNDP4    DS    0H                                                               
         CLI   0(R4),X'FF'         END OF TABLE?                                
         BE    FNDP8               YES                                          
         CLC   NPTPRDC,WPRDC       SAME PRODUCT?                                
         BNE   FNDP6                                                            
         CLC   NPTTYP,WTYP         SAME COST TYPE?                              
         BNE   FNDP6                                                            
         CLC   NPTSTA,WMKTSTA      SAME STATION?                                
         BNE   FNDP6                                                            
         CLC   NPTFEED,WFEED       SAME FEED?                                   
         BE    FNDPX               YES -- FOUND THE ENTRY                       
FNDP6    LA    R4,NETPTBL(R4)                                                   
         B     FNDP4                                                            
*                                                                               
FNDP8    DS    0H                                                               
         XC    0(NETPTBL,R4),0(R4)                                              
         LA    R1,NPTOGRS                                                       
         LA    RF,NPTOAMTS+NPTBAMTS(R1)   POINT PAST AMOUNTS                    
         BRAS  RE,ZAPSTR           ZAP AMOUNTS                                  
         MVC   NPTPRDC,WPRDC       SET PRODUCT                                  
         MVC   NPTTYP,WTYP         SET COST TYPE                                
         MVC   NPTPGR,WPGR         SET PRODUCT GROUP                            
         MVC   NPTSTA,WMKTSTA      SET PACKED MKT/STA                           
         MVC   NPTFEED,WFEED       SET FEED CODE                                
         MVI   NETPTBL(R4),X'FF'   SET NEW END                                  
*                                                                               
FNDPX    DS    0H                                                               
         ST    R4,WORD             RETURN A(ENTRY) IN FIELD 'WORD'              
*                                                                               
         J     EXIT                                                             
         DROP  R4                                                               
         EJECT                                                                  
*                                  APPLY PROD. SHARE TO AMTS AND LENGTH         
SETSHR   NTR1                                                                   
*                                                                               
         L     RF,STBASE           POINT TO STORAGE                             
         USING SHCUMED,RF                                                       
         LHI   R5,NCTYPS*4         GROSS/NET/GROSS2/SPARE                       
         L     R6,=A(XTRWK)                                                     
         LA    R2,SHCUMEPS         CUME %'S                                     
         LA    R4,SHCUMEAS         CUME AMOUNTS                                 
         DROP  RF                                                               
*                                  R3 POINTS TO SLOT IN PRODUCT ELEMENT         
SETS2    DS    0H                                                               
         SR    R1,R1                                                            
         ICM   R1,3,NUPDEPCT-NUPDEPR(R3)                                        
         A     R1,0(R2)                                                         
         ST    R1,0(R2)            SET NEW CUME %                               
*                                                                               
         CVD   R1,DUB              CONV % TO PKD FOR CALCULATION                
         ZAP   PKBIG,0(ACCUMLQ,R6) PUT AMT INTO BIG FIELD FOR MULTIPLE          
         BZ    SETS4                                                            
         MP    PKBIG,DUB           APPLY %                                      
         SRP   PKBIG,1,0           FOR ROUNDING                                 
         ZAP   MYPACKED,=P'10000'  SET DIVISOR                                  
         DP    PKBIG,MYPACKED      DIVIDE BY ??                                 
         SRP   PKQUOT,64-1,5       ROUND                                        
*                                                                               
         MVC   0(ACCUMLQ,R6),PKQUOT        PUT RESULT IN XTRWK AMOUNTS          
         SP    0(ACCUMLQ,R6),0(ACCUMLQ,R4) - CUME AMT = THIS PROD SHARE         
         MVC   0(ACCUMLQ,R4),PKQUOT          SET NEW CUME AMOUNT                
*                                                                               
SETS4    DS    0H                                                               
         LA    R6,ACCUMLQ(R6)      NEXT AMOUNT IN XTRWK                         
         LA    R4,ACCUMLQ(R4)      NEXT AMOUNT IN SHCUMEAS                      
         LA    R2,4(R2)            NEXT % IN SHCUMEPS                           
         BCT   R5,SETS2                                                         
*                                                                               
         MVC   LENSHR,WSHRL        SET LENGTH SHARE                             
*        MVC   NBSPLPRN,WPRD1      AND PRODUCT                                  
*                                                                               
         J     EXIT                                                             
         EJECT                                                                  
* HANDLE SPEC CHARGES DIFFR-LY WHEN X'03' EL HAS BILLPRD OR C-I STATION         
* FIND X'03' ELEMS, LOOK FOR BILLING PRD, IF FOUND ALLOC 100% OF THAT           
* SPEC CHARGE TO THAT PRD, IF NO BILLPRD, BUT C-I MKTSTA, DO IT OLD WAY         
* THIS SUB ADDS ENTRIES TO NETPTAB                                              
SETNEW03 NTR1                                                                   
         XC    CKONLYTI,CKONLYTI   CHECK ONLY TIME & INT IN SETAM8              
         L     R2,NBAIO                                                         
         LA    R2,NUDATA-NURECD(R2)                                             
         MVI   ELCODE,X'03'        SPECIAL RATE ELEMENT                         
*                                                                               
SETN03B  DS    0H                                                               
         BRAS  RE,NXTEL                                                         
         BNE   SETN03X                                                          
         USING NUSPRD,R2                                                        
*                                                                               
         CLI   NUSPRLEN,NUSPRLN1   NEW STYLE ELEM ?                             
         BNH   SETN03B             NO, GET NEXT ELEM                            
*                                                                               
         CLI   PAYOPT,C'Y'         DOING PAID AMOUNTS ?                         
         BNE   *+20                                                             
         TM    NUSPRSTA,NUSPRCPD   WAS CHARGE PAID ?                            
         BZ    SETN03B                                                          
         TM    NUSPRSTA,NUSPRPRE   PRE-EMPTED?                                  
         BO    SETN03B                                                          
*                                                                               
         L     R5,=A(CTYPLST)      GET INTERNAL TYPE CODE                       
         USING CTYLD,R5                                                         
SETN03D  CLC   NUSPRTYP,CTYLCOD                                                 
         BE    SETN03E                                                          
         LA    R5,CTYLSTL(R5)                                                   
         CLI   0(R5),X'FF'                                                      
         BNE   SETN03D                                                          
         DC    H'0'                COST TYPE NOT DEFINED                        
         DROP  R5                                                               
*                                                                               
SETN03E  DS    0H                  TEST AGAINST REQUEST COST TYPES              
         BAS   RE,CKTYPE                                                        
         BNE   SETN03B             TYPE NOT OK                                  
*                                                                               
         CLI   NUSPRLEN,NUSPRLN4   FIXED ELEM ?                                 
         BL    *+20                                                             
         MVC   WPRDC,NUSPRBPC                                                   
         OC    WPRDC,WPRDC         GOT PRODUCT?                                 
         BNZ   SETN03F             YES, PROCESS IT                              
*                                                                               
         MVC   WPRD,NUSPRBPR                                                    
         OC    WPRD,WPRD           GOT BILLING PRD ?                            
         BZ    SETN03G             NO, CHECK IF HAVE STATION                    
         L     RF,VCLIST           CONVERT 1 BYTE PRD                           
         CLC   WPRD,3(RF)                                                       
         BE    *+12                                                             
         LA    RF,4(RF)                                                         
         B     *-14                                                             
         MVC   WPRDC,0(RF)                                                      
SETN03F  BRAS  RE,PROC03PR         SET AMNTS FOR PRD                            
         CLI   PAYOPT,C'Y'         DOING PAID AMOUNTS ?                         
         BNE   SETN03B                                                          
         OI    CKONLYTI,ONLYTI     CHECK ONLY TIME & INT AT SETAM8              
         B     SETN03B             NXT ELEM                                     
*                                                                               
SETN03G  XC    WMKTSTA,WMKTSTA                                                  
         CLI   NUSPRLEN,NUSPRLN2                                                
         BH    *+16                                                             
         CLI   PAYOPT,C'Y'         DOING PAID AMOUNTS ?                         
         BE    SETN03K             GO THROUGH STATION LOGIC, BUT LEAVE          
         B     SETN03B             STATION FIELD BLANK                          
*                                                                               
*        CLI   NUSPRLEN,NUSPRLN4   FIXED LEN ?                                  
*        BE    *+14                                                             
*        MVC   WMKTSTA,NUSPRCIS    VAR LEN W/ C-I STATION                       
*        B     SETN03K                                                          
*                                                                               
         MVC   WMKTSTA,NUSPRCIS    BIGGER ELEM WILL HAVE STATION                
         OC    WMKTSTA,WMKTSTA     ANYTHING IN THAT FIELD?                      
         BNZ   SETN03K             YES, PROCESS FOR STATION                     
         CLI   PAYOPT,C'Y'         DOING PAID AMOUNTS ?                         
         BNE   SETN03B                                                          
*                                                                               
SETN03K  BRAS  RE,PROC03ST         SET AMNTS FOR STATION                        
         CLI   PAYOPT,C'Y'         DOING PAID AMOUNTS ?                         
         BNE   SETN03B                                                          
         OI    CKONLYTI,ONLYTI     CHECK ONLY TIME & INT AT SETAM8              
         B     SETN03B             NXT ELEM                                     
*                                                                               
SETN03X  J     EXIT                                                             
         EJECT                                                                  
PROC03PR NTR1                                                                   
         MVC   WSHRL,NBLEN         USE WHOLE SPOT LENGTH                        
         CLI   PRDELSW,C'Y'        IF CPY-SPLIT SITUATION                       
         BE    PROC03PB                                                         
*        CLC   WPRD,NBPRD                                                       
         CLC   WPRDC,NBPR1CL3      IF NOT AND ONE OF 2 MAIN PRODUCTS            
         BE    *+14                                                             
*        CLC   WPRD,NBPRD2                                                      
         CLC   WPRDC,NBPR2CL3                                                   
         BNE   PROC03PB                                                         
         MVC   WSHRL,5(R3)         USE THEIR SHARE                              
*                                                                               
PROC03PB BRAS  RE,CKPRD                                                         
         BNE   PROC03PX                                                         
         BAS   RE,SETSPAM                                                       
         XC    WMKTSTA,WMKTSTA                                                  
         XC    WFEED,WFEED                                                      
         CLI   NUSPRLEN,NUSPRLN2                                                
         BNH   *+10                                                             
         MVC   WMKTSTA,NUSPRCIS    IF FROM VAR ELEM STAT WILL BE THERE          
         BAS   RE,FNDPRD           BUT IF FROM FIXED, MIGHT BE BLANK            
         L     R4,WORD                                                          
         USING NETPTABD,R4                                                      
         MVC   NPTLNSHR,WSHRL                                                   
         AP    NPTOGRS,MYPACKED                                                 
         AP    NPTONET,DOUBLE                                                   
*                                                                               
PROC03PX J     EXIT                                                             
*                                                                               
*              THIS ROUTIN ALSO DEALS WITH PAID, NON CUT-IN ELEMS               
*              SINCE THE LOGIC IS ESSENTIALLY THE SAME                          
PROC03ST NTR1                                                                   
PROC03SA DS    0H                                                               
         CLI   0(R3),0             NO MORE PRODS                                
         BE    PROC03SX                                                         
         MVC   WPRDC,0(R3)          PRODUCT CODE                                
         MVC   WSHRL,5(R3)         LENGTH SHARE                                 
**       L     RF,VCLIST                                                        
**       CLC   WPRDC,0(RF)                                                      
**       BE    *+12                                                             
**       LA    RF,4(RF)                                                         
**       B     *-14                                                             
**                                                                              
**       MVC   WPRD,3(RF)                                                       
         CLI   PRDELSW,C'Y'        IF HAVE PRODUCT SPLIT ELEMENT                
         BNE   *+10                                                             
         MVC   WSHRL,NBLEN         USE WHOLE SPOT LENGTH                        
         BRAS  RE,CKPRD            CHECKS IF THIS IS A PRODUCT WE WANT          
         BNE   PROC03SK                                                         
*                                                                               
         BAS   RE,SETSPAM          GET GROSS AND NET AMOUNTS                    
*                                                                               
         SR    R1,R1                                                            
         ICM   R1,3,NUPDEPCT-NUPDEPR(R3)                                        
*                                                                               
         CVD   R1,DUB              CONV % TO PKD FOR CALCULATION                
         ZAP   PKBIG,MYPACKED      PUT AMT INTO BIG FIELD FOR MULTIPLE          
         BZ    PROC03SG                                                         
         MP    PKBIG,DUB           APPLY %                                      
         SRP   PKBIG,1,0           FOR ROUNDING                                 
         ZAP   MYPACKED,=P'10000'  SET DIVISOR                                  
         DP    PKBIG,MYPACKED      DIVIDE BY ??                                 
         SRP   PKQUOT,64-1,5       ROUND                                        
*                                                                               
         MVC   MYPACKED,PKQUOT     PUT RESULT BACK                              
*                                                                               
PROC03SG CVD   R1,DUB              CONV % TO PKD FOR CALCULATION                
         ZAP   PKBIG,DOUBLE        PUT AMT INTO BIG FIELD FOR MULTIPLE          
         BZ    PROC03SJ                                                         
         MP    PKBIG,DUB           APPLY %                                      
         SRP   PKBIG,1,0           FOR ROUNDING                                 
         ZAP   DOUBLE,=P'10000'    SET DIVISOR                                  
         DP    PKBIG,DOUBLE        DIVIDE BY ??                                 
         SRP   PKQUOT,64-1,5       ROUND                                        
*                                                                               
         MVC   DOUBLE,PKQUOT       PUT RESULT BACK                              
*                                                                               
*ROC03SI CLI   NUSPRLEN,NUSPRLN2   IS IT CUT-IN STATION?                        
*        BNH   *+14                                                             
*        MVC   WMKTSTA,NUSPRCIS    IF YES, VERY GOOD                            
*        B     PROC03SJ                                                         
*                                                                               
*        CLI   PAYOPT,C'Y'         OTHERWISE SHOULD ONLY BE HERE                
*        BE    *+6                 IF DOING CLEARED $$                          
*        DC    H'0'                IF NOT, VERY BAD -- DIE                      
*        XC    WMKTSTA,WMKTSTA     CLEAR STATION, AS NON CUT-IN ELEM            
*                                                                               
PROC03SJ XC    WFEED,WFEED                                                      
         BAS   RE,FNDPRD           GET PRD/TYP ENTRY IN NETPTAB                 
         L     R4,WORD             A(ENTRY IN NETPTBL)                          
         MVC   NPTLNSHR,WSHRL      SET LEN SHARE (USE WHOLE SPOT LEN)           
         AP    NPTOGRS,MYPACKED    GROSS                                        
         AP    NPTONET,DOUBLE      NET                                          
*                                                                               
PROC03SK LA    R3,7(R3)            NEXT SLOT IN ELEMENT                         
         B     PROC03SA                                                         
PROC03SX J     EXIT                                                             
*                                                                               
SETSPAM  NTR1                                                                   
         ZAP   MYPACKED,=P'0'                                                   
         ZAP   DOUBLE,=P'0'                                                     
         TM    NUSPRSTA,NUSPRPRE   IF PRE-EMPT AND CLEARED                      
         BNZ   SETSPX              ORDERED = 0                                  
         CLI   PAYOPT,C'Y'                                                      
         BE    SETSP10                                                          
         TM    NBUNITST,X'42'      IF PRE-EMPT OR MISSED                        
         BNZ   SETSPX              ORDERED = 0                                  
         L     RF,NBAIO                                                         
         TM    NURSTAT-NURECD(RF),X'80'  AND ALSO IF DELETED                    
         BNZ   SETSPX                                                           
*                                                                               
SETSP10  ICM   R0,15,NUSPRAMT      GROSS                                        
         TM    NBUNITST,X'80'      IF MINUS UNIT                                
         BZ    *+6                                                              
         LNR   R0,R0               MAKE AMOUNT NEGATIVE                         
         ST    R0,FULL                                                          
*                                                                               
         CLI   NUSPRCOM,C'C'       IF COMMISSIONABLE USE RATE TYPE              
         BE    SETSP15                                                          
         CLI   NUSPRCOM,C'Y'                                                    
         BE    SETSP15             IF NOT COMMISSIONABLE                        
         LHI   R0,C'F'             GROSS=NET                                    
         B     SETSP20                                                          
SETSP15  ZIC   R0,NBRTTYPE         ELSE USE RATE TYPE                           
         CLI   NBSDRTCV,C'A'       IF SPECIALS COVERED                          
         BE    SETSP20                                                          
         CLI   NBSDRTCV,C' '                                                    
         BNH   SETSP20                                                          
         SR    R0,R0               ELSE NET=85%                                 
*                                                                               
SETSP20  DS    0H                                                               
         GOTO1 =V(NETNET),DMCB,((R0),FULL),DUB                                  
*                                                                               
         L     RE,DUB              GROSS                                        
         CVD   RE,MYPACKED                                                      
         L     RE,DUB+4            NET                                          
         CVD   RE,DOUBLE                                                        
         DROP  R2                                                               
SETSPX   J     EXIT                                                             
*                                                                               
         EJECT                                                                  
SETINT   NTR1                            DO INTEGRATION                         
         CLI   CTYPQ,C' '          DOING ALL COST TYPES?                        
         BE    SETINT2                                                          
         CLI   CTYPQ,C'3'          ALSO ALL TYPES                               
         BE    SETINT2                                                          
         CLI   CTYPQ,C'1'          TIME/INTEG                                   
         BE    SETINT2                                                          
         CLI   CTYPQ,C'I'          INTEGRATION ALONE                            
         BNE   SETINTX             OTHERWISE INT NOT PART OF REQUEST            
*                                                                               
SETINT2  L     R5,=A(CTYPLST)      GET INTERNAL TYPE CODE                       
         USING CTYLD,R5                                                         
SETINT3  CLI   CTYLCOD,C'I'        FIND ENTRY FOR INTEGRATION                   
         BE    *+18                                                             
         LA    R5,CTYLSTL(R5)                                                   
         CLI   0(R5),X'FF'                                                      
         BNE   SETINT3                                                          
         DC    H'0'                COST TYPE NOT DEFINED                        
         NI    CTYLCTL,X'FF'-CTYLSCIQ  TURN OFF INTEGRATION BIT                 
         DROP  R5                  OTHERWISE, DONE                              
*                                                                               
         L     R2,NBAIO                                                         
         LA    R2,NUDATA-NURECD(R2)                                             
         MVI   ELCODE,X'60'        "OTHER" FIELDS HOLD ELEM                     
*                                                                               
SETINT5  DS    0H                                                               
         BRAS  RE,NXTEL                                                         
         BNE   SETINTX                                                          
         USING NUOTH,R2                                                         
*                                                                               
         CLI   NUOTTYP,C'N'        IS THERE INTEGRATION BILL PRD ?              
         BNE   SETINT5                                                          
*        MVC   WPRD,NUOTHER+3                                                   
         MVC   WPRDC,NUOTHER                                                    
         MVI   BYTE3,C'I'          SPECIAL FOR INTEGRATION                      
         BRAS  RE,CKPRD                                                         
         BE    SETINT10            PRODUCT FOUND, VERY GOOD!                    
         CLI   BYTE3,C'I'          NOT FOUND, DO SOME CHECKING                  
         BE    SETINTX       BYTE3 NOT CLEARED? CC = NO FOR GOOD REASON         
         CLC   =C'ALL',QPRD  ELSE, THIS IS PROB A 1PRD REQST                    
         BNE   *+6           IF NOT I'M SCREWED                                 
         DC    H'0'                                                             
         MVI   BYTE3,C'X'    BUT IF I'M RIGHT INTEG PROD IS NOT PART OF         
         B     SETSCI30      THIS REQUEST, SO NO INTEG IN THIS BILL             
*                                                                               
SETINT10 ZAP   MYPACKED,=P'0'                                                   
         ZAP   DOUBLE,=P'0'                                                     
         CLI   PAYOPT,C'Y'         IF DOING PAID                                
         BNE   SETINT15                                                         
         BRAS  RE,GET12EL          FIND CORRESPONDING X'12' ELEM                
         B     SETSCI25                                                         
*                                                                               
SETINT15 TM    NBUNITST,X'42'      IF PRE-EMPT OR MISSED                        
         BNZ   SETSCI25            ORDERED = 0                                  
         L     RF,NBAIO                                                         
         TM    NURSTAT-NURECD(RF),X'80'  AND ALSO IF DELETED                    
         BNZ   SETSPX                                                           
*                                                                               
         MVC   FULL,NBINTEG                                                     
         TM    NBUNITST,X'80'      TEST MINUS UNIT                              
         BZ    *+14                                                             
         L     RF,FULL             MAKE AMOUNT NEGATIVE                         
         LNR   RF,RF                                                            
         ST    RF,FULL                                                          
*                                  GET GROSS AND NET                            
SETINT20 ZIC   R0,NBRTTYPE         RATE TYPE                                    
         TM    NBPACKST,X'04'      NON-COM INTEGRATION?                         
         BZ    *+12                                                             
         LHI   R0,C'F'             IF SO, NET=GROSS                             
         B     *+14                                                             
         CLI   NBSDRTCV,C'T'       IF RATE TYPE COVERAGE                        
         BNE   *+6                 IS FOR TIME ONLY                             
         SR    R0,R0               THEN INTEGRATION NET = 85%                   
*                                                                               
         GOTO1 =V(NETNET),DMCB,((R0),FULL),DUB                                  
         L     RE,DUB              GROSS                                        
         CVD   RE,MYPACKED                                                      
         L     RE,DUB+4            NET                                          
         CVD   RE,DOUBLE                                                        
*                                                                               
SETSCI25 L     R5,=A(CTYPLST)      GET ENTRY FOR INTEGRATION                    
         USING CTYLD,R5                                                         
SETSCI30 CLI   CTYLCOD,C'I'                                                     
         BE    *+18                                                             
         LA    R5,CTYLSTL(R5)                                                   
         CLI   0(R5),X'FF'                                                      
         BNE   SETSCI30                                                         
         DC    H'0'                COST TYPE NOT DEFINED                        
         MVC   WTYP,CTYLDISP       SET COST TYPE                                
         OI    CTYLCTL,CTYLSCIQ    SET STARCOM INTEG                            
         DROP  R5                                                               
*                                                                               
         CLI   BYTE3,C'X'          IF INT FOR DIFFRNT PRD, DONE                 
         BNE   *+12                                                             
         OI    CKONLYTI,NOINT      DO NOT CHECK INTEG IN SETAM                  
         B     SETINTX                                                          
*                                                                               
         XC    WFEED,WFEED                                                      
         XC    WMKTSTA,WMKTSTA                                                  
         BAS   RE,FNDPRD           GET PRD/TYP ENTRY IN NETPTAB                 
         L     R4,WORD             A(ENTRY IN NETPTBL)                          
         USING NETPTABD,R4                                                      
         MVC   NPTLNSHR,NBLEN      SET LEN SHARE (USE WHOLE SPOT LEN)           
         AP    NPTOGRS,MYPACKED    GROSS                                        
         AP    NPTONET,DOUBLE      NET                                          
SETINTX  J     EXIT                                                             
         DROP  R2,R4                                                            
         EJECT                                                                  
GET12EL  NTR1                                                                   
         L     R2,NBAIO                                                         
         LA    R2,NUDATA-NURECD(R2)                                             
         MVI   ELCODE,X'12'        PAYING ELEMENT                               
*                                                                               
GET12ELB BRAS  RE,NXTEL                                                         
         BNE   GET12ELX                                                         
         USING NUPAYD,R2                                                        
*                                                                               
         CLI   NUPAYTYP,C'I'       ONLY INTERESTED IN INTEGRATION               
         BNE   GET12ELB                                                         
         ICM   R0,15,NUPAYGRS                                                   
         CVD   R0,DUB                                                           
         AP    MYPACKED,DUB        GET THE SUM OF ALL 12 ELEMS GROSS            
         ICM   R0,15,NUPAYNET                                                   
         CVD   R0,DUB                                                           
         AP    DOUBLE,DUB          GET THE SUM OF ALL 12 ELEMS GROSS            
         OI    CKONLYTI,NOINT      DO NOT CHECK INTEG IN SETAM                  
         B     GET12ELB                                                         
*                                                                               
GET12ELX J     EXIT                                                             
         DROP  R2                                                               
         EJECT                                                                  
*                                                                               
* THIS SUB WILL LOOK THROUGH X'23' ELEMS IN UNIT REC AND BASED  ON              
* PRODUCT CODE FROM NETPTAB ENTRY GET FEED CODE                                 
* R3 IS POINTING TO THE PRODUCT IN X'14' ELEMENT                                
*                                                                               
GETFEED  NTR1                                                                   
         L     R2,NBAIO                                                         
         LA    R2,NUDATA-NURECD(R2)                                             
         MVI   ELCODE,X'23'        NETWORK FEED WITH COMMERCIALS ELEM           
*                                                                               
GETF5    DS    0H                                                               
         BRAS  RE,NXTEL                                                         
         BNE   GETFX                                                            
         USING NUFDCEL,R2                                                       
*                                                                               
         TM    NUFDCFL2,X'80'      DELETED FEED ?                               
         BO    GETF5               YES, GET NEXT                                
*        CLC   WPRD,NUFDCPRD       IS IT RIGHT PRODUCT ?                        
         CLC   WPRDC,NUFDPROD      IS IT RIGHT PRODUCT ?                        
         BNE   GETF5               NO, LOOK FOR NEXT X'23' ELEM                 
         SR    R0,R0               CHECK PRODUCT'S POSIT IN X'14' ELEM          
         LR    R1,R3                                                            
         LA    R4,HPRDEL1+NUPDEPR-NUPDED  FIRST PROD IN X'19'                   
         SR    R1,R4                                                            
         BZ    GETF20                                                           
         LHI   R4,7                                                             
         DR    R0,R4                                                            
         LTR   R0,R0               THERE SHOULD BE NO REMAINDER                 
         BZ    *+6                                                              
         DC    H'0'                                                             
GETF20   AHI   R1,1                1ST POSITION                                 
         CLM   R1,1,NUFDPPOS       HAS TO BE RIGHT POSIT IN X'14'               
         BNE   GETF5               OTHERWISE LOOK FOR NEXT ELEM                 
*                                                                               
         MVC   WFEED,NUFDCFED      YES, PUT FEED IN NETPTAB                     
         DROP  R2                                                               
*                                                                               
GETFX    J     EXIT                                                             
*                                                                               
         EJECT                                                                  
*        CHECK COST TYPE                                                        
*                                                                               
* R5 POINTS TO CTYPLST TABLE ENTRY                                              
*                                                                               
CKTYPE   NTR1                                                                   
*                                                                               
         USING CTYLD,R5                                                         
*                                  TEST AGAINST REQUEST COST TYPES              
         MVI   WTYP,TIMEQ                                                       
         CLI   CTYPQ,C'3'          ALL TYPES OK                                 
         BE    CKTOK                                                            
         CLI   CTYPQ,C' '          ALL TYPES OK                                 
         BE    CKTOK                                                            
         CLI   CTYPQ,C'1'          T/I                                          
         BNE   *+16                                                             
         TM    CTYLCTL,X'40'       IN T/1 GROUP?                                
         BZ    CKTNO               NO, REJECT                                   
         B     CKTOK                                                            
*                                                                               
         CLI   CTYPQ,C'2'          SPECIAL CHARGES                              
         BNE   *+16                                                             
         TM    CTYLCTL,X'40'       T/1 GROUP?                                   
         BNZ   CKTNO               YES, REJECT                                  
         B     CKTOK                                                            
*                                                                               
         CLI   CTYPQ,C'4'          TIME AND SPECIAL CHARGES                     
         BNE   *+16                                                             
         CLI   CTYLDISP,INTEGQ     IS IT INTEGRATION ?                          
         BE    CKTNO               YES, REJECT                                  
         B     CKTOK                                                            
*                                                                               
         CLC   CTYPQ,CTYLREQ       ELSE TYPE MUST MATCH EXACTLY                 
         BNE   CKTNO                                                            
*                                                                               
CKTOK    DS    0H                                                               
         MVC   WTYP,CTYLDISP                                                    
*                                                                               
         J     YES2                SET CC =                                     
*                                                                               
CKTNO    J     NO2                                                              
         SPACE 2                                                                
         ANSR  C=2                                                              
         DROP  R5                                                               
         EJECT                                                                  
***********************************************************************         
*                                                                               
*     SETESMSK - SETS NBESTMSK: THE NETIO ESTIMATE MASK.                        
*                 WHEN REVERSALS ARE REQUESTED WITH ESTIMATE "ALL", WE          
*                 MUST READ THE BILL HEADER DIRECTORY POINTERS TO SEE           
*                 WHICH ESTIMATES WERE BILLED ON THE REVERSED INVOICE.          
*                 THEN WE SET NBESTMSK SO THAT NETIO ONLY READS THE             
*                 UNITS FOR THE ESTIMATES WE FOUND.                             
*                                                                               
***********************************************************************         
*                                                                               
SETESMSK NTR1                                                                   
*                                                                               
         OI    NBINDS3,NBI3ESTM    TELL NETIO TO HONOR NBESTMSK                 
         XC    NBESTMSK,NBESTMSK   IN CASE WAS MODIFIED BY ESTMASK              
*                                                                               
         LA    R2,KEY                                                           
         USING BKEY,R2                                                          
         XC    BKEY,BKEY           READ BILL HEADER KEYS                        
         MVC   BKEYAM,BAGYMD       AGY/MED                                      
         MVC   BKEYCLT,BCLT        CLIENT                                       
*                                                                               
SETESM10 GOTO1 HIGH                                                             
*                                                                               
SETESM20 DS    0H                                                               
         CLC   KEY(4),KEYSAVE      SAME AGY/MED/CLT?                            
         BNE   SETESMX             NO: WE'RE FINISHED                           
*                                                                               
         OC    BKEYYSRV(5),BKEYYSRV   BILL HEADER?                              
         BZ    SETESM40            NO                                           
*                                                                               
         ZIC   RF,BKEYEST          CURRENT ESTIMATE NUMBER                      
         SR    RE,RE                                                            
         SLDL  RE,29               GET MASK BYTE NO. INTO RE                    
         SRL   RF,29               GET MASK BIT  NO. INTO RF                    
         LA    R1,NBESTMSK(RE)     R1 = A(CORRECT BYTE IN MASK)                 
         LA    RF,BITLIST(RF)                                                   
         MVC   BYTE,0(R1)                                                       
         NC    BYTE,0(RF)          HAVE WE ALREADY DETERMINED BELOW...          
         CLI   BYTE,0              ...THAT WE NEED THIS ESTIMATE?               
         BNE   SETESM30            YES: BUMP TO NEXT ESTIMATE                   
*                                                                               
         GOTO1 DATCON,DMCB,(2,MANRVDTP),(3,THREE)                               
         ZIC   R0,THREE+1          BINARY MONTH NUMBER                          
         GOTO1 DATCON,DMCB,(2,MANRVDTP),(1,THREE)                               
         NI    THREE,X'0F'         LEAVE ONLY YEAR WITHIN DECADE                
         ZIC   R1,THREE                                                         
         SLL   R1,4                PUT YEAR IN HIGH-ORDER NIBBLE                
         OR    R1,R0               R1 = YEAR/MONTH                              
         CLM   R1,1,BKEYMBIL       RUNDATE Y/M MATCH? (FUCK THE DECADE)         
         BNE   SETESM40            NO                                           
         CLC   BKEYINV,MANRVNO     INVOICE NUMBER MATCH?                        
         BNE   SETESM40            NO                                           
*                                                                               
         ZIC   RF,BKEYEST          WE NEED TO READ UNITS FOR THIS EST.          
         SR    RE,RE                                                            
         SLDL  RE,29               GET MASK BYTE NO. INTO RE                    
         SRL   RF,29               GET MASK BIT  NO. INTO RF                    
         LA    R1,NBESTMSK(RE)     R1 = A(CORRECT BYTE IN MASK)                 
         LA    RF,BITLIST(RF)                                                   
         OC    0(1,R1),0(RF)       TURN BIT ON IN ESTIMATE MASK                 
*                                                                               
SETESM30 DS    0H                  READ THE NEXT KEY                            
         ICM   RF,15,BKEYPRD       LOADS PRODUCT AND ESTIMATE CODES             
         AHI   RF,1                                                             
         STCM  RF,15,BKEYPRD       FORCE BUMP TO NEXT ESTIMATE                  
         XC    BKEYYSRV(5),BKEYYSRV                                             
         B     SETESM10                                                         
*                                                                               
SETESM40 GOTO1 SEQ                                                              
         B     SETESM20                                                         
*                                                                               
SETESMX  DS    0H                                                               
         J     EXIT                                                             
         DROP  R2                                                               
         SPACE                                                                  
         EJECT                                                                  
***********************************************************************         
*                                                                               
*     ESTMASK  - SETS NBESTMSK: THE NETIO ESTIMATE MASK.                        
*                ALWAYS SET ESTIMATE MASK FOR 'ALL' EST REQUEST                 
*                IN ORDER TO SKIP UNITS FOR STEWARDSHIP & BARTER ESTS           
*                TURN OFF THEIR BITS IN NBESTMSK                                
*                                                                               
***********************************************************************         
*                                                                               
ESTMASK  NTR1                                                                   
*                                                                               
         OI    NBINDS3,NBI3ESTM    TELL NETIO TO HONOR NBESTMSK                 
         MVI   NBESTMSK,X'FF'      SET NBESTMSK TO FFS                          
         MVC   NBESTMSK+1(L'NBESTMSK-1),NBESTMSK                                
*                                                                               
         MVC   KEY1,KEY            SAVE THE KEY, JUST IN CASE                   
         LA    R2,KEY                                                           
         USING ESTHDR,R2                                                        
         XC    EKEY,EKEY           READ ESTIMATE KEYS                           
         MVC   EKEYAM,BAGYMD       AGY/MED                                      
         MVC   EKEYCLT,BCLT        CLIENT                                       
         MVC   EKEYPRD,=C'POL'     PRODUCT ALWAYS POL                           
         GOTO1 HIGH                                                             
*                                                                               
ESTMSK10 GOTO1 SEQ                                                              
*                                                                               
ESTMSK20 DS    0H                                                               
         CLC   KEY(7),KEYSAVE      SAME AGY/MED/CLT/PRD?                        
         BNE   ESTMSKX             NO: WE'RE FINISHED                           
*                                                                               
         OC    KEY+8(5),KEY+8      BILL HEADER?                                 
         BNZ   ESTMSK10            YES, NEXT                                    
*                                                                               
         L     R5,=A(STABUCKC)     USE STATION BUCKET AREA                      
         ST    R5,AREC                                                          
         GOTO1 GET                                                              
*                                                                               
         L     R2,AREC                                                          
         CLI   ETYPE,C'S'          DON'T BILL STEWARDSHIP ESTIMATES             
         BE    *+12                                                             
         CLI   ETYPE,C'B'          DON'T BILL BARTER ESTIMATES                  
         BNE   ESTMSK10            NEXT EST                                     
*                                                                               
         ZIC   RF,EKEYEST          CURRENT ESTIMATE NUMBER                      
         SR    RE,RE                                                            
         SLDL  RE,29               GET MASK BYTE NO. INTO RE                    
         SRL   RF,29               GET MASK BIT  NO. INTO RF                    
         LA    R1,NBESTMSK(RE)     R1 = A(CORRECT BYTE IN MASK)                 
         LA    RF,BITLIST(RF)                                                   
         ZIC   R4,0(RF)            GET THE BIT                                  
         LHI   R5,-1               TURN IT OFF                                  
         SR    R5,R4                                                            
         STC   R5,BYTE                                                          
         NC    0(1,R1),BYTE                                                     
         B     ESTMSK10            BUMP TO NEXT ESTIMATE                        
*                                                                               
ESTMSKX  MVC   KEY,KEY1                                                         
         GOTO1 HIGH                                                             
         J     EXIT                                                             
         DROP  R2                                                               
         SPACE                                                                  
         EJECT                                                                  
***********************************************************************         
*                                                                               
*     SETPRDEL - SETS PRODUCT SHARE ELEMENT IN HPRDEL (EITHER COPIES            
*                ELEM. OUT OF RECORD OR CREATES FROM NUPRD AND NUPRD2)          
*                                                                               
*     NOTE - IN NUPRDD, BYTE AFTER NUPRDPR IS USED TO HOLD                      
*            SECONDS FOR EACH BRAND. IT USED TO BE TAGGED NUPRDLN               
*                                                                               
***********************************************************************         
*                                                                               
SETPRDEL NTR1                                                                   
*                                                                               
         MVI   PRDELSW,0                                                        
         XC    HPRDEL,HPRDEL                                                    
         L     R3,NBAIO            USE ELEMENT IF THERE                         
         USING NURECD,R3                                                        
         LA    R2,NUDATA                                                        
         MVI   ELCODE,X'14'                                                     
         BRAS  RE,NXTEL                                                         
         BNE   SPRL4                                                            
*                                                                               
         ZIC   RF,1(R2)                                                         
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   HPRDEL(0),0(R2)     SAVE ELEMENT                                 
         MVI   PRDELSW,C'Y'        *** THIS CAN BE SET LATER IF NBUNST3         
         B     SPRLX               *** INDICATES COPY-SPLIT                     
*                                                                               
SPRL4    DS    0H                  IF NO ELEMENT, BUILD FROM NUPRD ETC.         
         MVI   NBPRDNO,1           SET NUMBER OF PRODS (FOR NEPACC)             
         MVC   NBPRDLST(L'NUPRD),NUPRD                                          
         LA    R2,HPRDEL                                                        
         USING NUPRDD,R2                                                        
         MVI   NUPRDEL,X'14'                                                    
         MVC   NUPRDPR,NUPRD       1ST PRODUCT                                  
         MVI   NUPRDLEN,9          LENGTH IF ONE PRODUCT                        
         MVC   NUPRDPR+1(L'NULEN),NULEN  USE WHOLE SECONDS LENGTH               
         MVC   NUPRDPCT,=H'10000'  AND 100% OF DOLLARS                          
         CLI   NUPRD2,0            IF NO SECOND PRODUCT                         
         BNE   SPRL4K              CHECK FOR                                    
         CLI   CORPOPT,C'Y'        SPECIAL CORPORATE PRODUCT OVERRIDE           
         BNE   SPRLX                                                            
         OC    NUPRD,NUPRD         IF UNALLOCATED PRODUCT                       
         BZ    SPRLX               DON'T DO THE OVERRIDE                        
         L     RF,VCLIST           GET PRODUCT CODE                             
SPRL4B   CLI   0(RF),0                                                          
         BNE   *+6                                                              
         DC    H'0'                BAD PRODUCT                                  
         CLC   0(3,RF),QCORPRD                                                  
         BE    *+12                                                             
         LA    RF,4(RF)                                                         
         B     SPRL4B                                                           
         MVC   NUPRDPR,3(RF)       OVERRIDE WITH CORP PRODUCT                   
         B     SPRLX               DONE                                         
*                                                                               
SPRL4K   TM    NBUNST3,X'40'       IS THIS A COPY-SPLIT BUY ?                   
         BNO   *+8                 IF YES, ALSO TURN ON PRDELSW                 
         MVI   PRDELSW,C'Y'        IN ORDER TO GET FULL SHARE                   
*                                                                               
         MVI   NBPRDNO,2           SET NUMBER OF PRODS (FOR NEPACC)             
         MVC   NBPRDLST+1(L'NUPRD2),NUPRD2                                      
         MVI   NUPRDLEN,15         LENGTH IF 2 PRODUCTS                         
         MVC   NUPRDPR+6(L'NUPRD2),NUPRD2 2ND PRODUCT CODE                      
         MVC   NUPRDPR+1(L'NULEN1),NULEN1 LENGTH SHARE FOR 1ST                  
         CLI   NULEN1,0            IF ZERO                                      
         BNE   SPRL5                                                            
         ZIC   RF,NULEN                                                         
         SRL   RF,1                USE HALF                                     
         STC   RF,NUPRDPR+1                                                     
*                                                                               
SPRL5    DS    0H                                                               
         MVC   NUPRDPCT,NUP1SHR    COST SHARE FOR 1ST                           
         OC    NUP1SHR,NUP1SHR     IF ZERO                                      
         BNZ   *+18                                                             
         TM    NUUNST2,X'04'       TRULY ZERO?                                  
         BNZ   *+10                                                             
         MVC   NUPRDPCT,=H'5000'   DEFAULT IS 50%                               
*                                                                               
         ZIC   RF,NULEN                                                         
         ZIC   RE,NUPRDPR+1                                                     
         SR    RF,RE                                                            
         STC   RF,NUPRDPR+1+6      2ND PRODUCT LENGTH                           
         LHI   RF,10000                                                         
         ICM   RE,3,NUPRDPCT                                                    
         SR    RF,RE                                                            
         STCM  RF,3,NUPRDPCT+6     2ND PRODUCT COST SHARE                       
*                                                                               
SPRLX    DS    0H                                                               
         J     EXIT                                                             
         DROP  R2                                                               
*                                                                               
*                                                                               
* CHECK IF THERE'S BILLING HOLD REC FOR THIS UNIT                               
HOLDCK   NTR1                                                                   
         L     R3,NBAIO                                                         
         LA    R6,HPRDEL1                                                       
         ZIC   R2,1(R6)            DO NOT USE R2                                
         AR    R2,R6               0(R2) = END OF THE ELEMENT                   
*                                                                               
         USING NUPDED,R6                                                        
         LA    R6,NUPDEPR                                                       
         DROP  R6                                                               
*                                                                               
HOLDCK10 DS    0H                  FIND 3-CHAR PRODUCT IN VCLIST                
         CR    R6,R2                                                            
         BNL   HOLDCKQX                                                         
*                                                                               
         XC    WK2,WK2                                                          
KEY@     USING BHOLDTD,WK2                                                      
         MVC   KEY@.BHLDAM,NUKAM                                                
         MVC   KEY@.BHLDCLT,NUKCLT                                              
         MVC   KEY@.BHLDPRD,0(R6)  3-CHAR PRODUCT                               
         MVC   KEY@.BHLDEST,NUKEST                                              
         MVC   KEY@.BHLDNET,NUKNET                                              
*                                                                               
         GOTO1 BINSRCH,BHLPARS,(X'00',WK2)                                      
         CLI   0(R1),X'01'                                                      
         BE    HOLDCK50            NOT IN BHOLDTAB, DO NEXT PRODUCT             
*                                                                               
         L     RF,BHLPARS                                                       
         MVC   WK2(BHOLDTRL),0(RF)                                              
*                                                                               
         MVI   BYTE,X'00'          ACCEPT                                       
*                                                                               
         LA    R1,NUDATA                                                        
         USING NUMAINEL,R1                                                      
         OC    KEY@.BHLDPKG,KEY@.BHLDPKG  ALL PACKAGES?                         
         BNZ   *+12                NO                                           
         OI    BYTE,X'01'          YES, REJECT THIS UNIT                        
         B     HOLDCK20                                                         
*                                                                               
         CLC   KEY@.BHLDPKG,NUPACK                                              
         BNE   HOLDCK20                                                         
         OI    BYTE,X'01'          YES, REJECT THIS UNIT                        
         DROP  R1                                                               
*                                                                               
HOLDCK20 DS    0H                                                               
         OC    KEY@.BHLDMOS,KEY@.BHLDMOS                                        
         BNZ   *+12                                                             
         OI    BYTE,X'02'                                                       
         B     HOLDCK30                                                         
*                                                                               
         BRAS  RE,SETPER           FIND PERIOD THAT CONTAINS SPOT DATE          
         L     R1,FULL             A(PERLIST ENTRY) RETURNED IN FULL            
         CLC   KEY@.BHLDMOS,PERLMOS-PERLISTD(R1)                                
         BNE   HOLDCK30                                                         
         OI    BYTE,X'02'          YES, REJECT THIS UNIT                        
*                                                                               
         DROP  KEY@                                                             
*                                                                               
HOLDCK30 DS    0H                                                               
         TM    BYTE,X'03'                                                       
         BO    HOLDCKNX                                                         
*                                                                               
HOLDCK50 DS    0H                                                               
         LA    R6,7(R6)                                                         
         B     HOLDCK10                                                         
*                                                                               
HOLDCKQX CR    RB,RB                                                            
         B     *+6                                                              
HOLDCKNX LTR   RB,RB                                                            
         XIT1                                                                   
*                                                                               
*                                                                               
BITLIST  DC    X'8040201008040201'                                              
HPRDEL   DS    CL100                                                            
*                                                                               
         DROP  R3                                                               
         DROP  RB,R7                                                            
         SPACE 2                                                                
         LTORG                                                                  
*                                                                               
SHCUMED  DSECT                                                                  
SHCUMEPS DS    (NCTYPS*4)F         CUME %'S FOR SHARE CALCULATION               
SHCUMEAS DS    XL(NCTYPS*ROWHL)    CUME AMOUNTS FOR SHARE CALCULATION           
SHCUMEQ  EQU   *-SHCUMED                                                        
         EJECT                                                                  
SPBU02   CSECT                                                                  
***********************************************************************         
*                                                                               
*     SETCPRDE - SETS PRODUCT SHARE ELEMENT IN HPRDEL1 AFTER X'19' ELEM         
*                                                                               
*     NOTE - IN NUPDED, 1ST BYTE OF NUPDEFD IS USED TO HOLD                     
*            SECONDS FOR EACH BRAND.                                            
*                                                                               
***********************************************************************         
SETCPRDE NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         MVI   PRDELSW,0                                                        
         XC    HPRDEL1,HPRDEL1                                                  
         XC    WK,WK               WILL TEMP STORE X'14' ELEM HERE              
         L     R3,NBAIO            USE ELEMENT IF THERE                         
         USING NURECD,R3                                                        
         LA    R2,NUDATA                                                        
         MVI   ELCODE,X'19'        IF 19 ELEM IS THERE, USE IT                  
         BRAS  RE,NXTEL                                                         
         BNE   SCPR10              ELSE LOOK FOR X'14' OR BUILD FR SCR          
         ZIC   RF,1(R2)                                                         
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   HPRDEL1(0),0(R2)    SAVE ELEMENT                                 
         LA    R2,HPRDEL1                                                       
         USING NUPDED,R2                                                        
         TM    NUPDEIND,X'40'      COPY SPLIT ?                                 
         BZ    SCPR2                                                            
         MVI   PRDELSW,C'Y'                                                     
         B     SCPRX                                                            
SCPR2    MVI   NBPRDNO,1           SET NUMBR OF PRODUCTS                        
         CLI   NUPDELEN,10         ONE PRODUCT?                                 
         BH    *+20                                                             
         MVC   NUPDEFD(L'NULEN),NULEN  USE WHOLE SECONDS LENGTH                 
         MVC   NUPDEPCT,=H'10000'  AND 100% OF DOLLARS                          
         B     SCPRX                                                            
*                                                                               
         CLI   NUPDELEN,17         SHOULD NOT BE MORE THEN 2 PRODS              
         BNH   *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLC   NUPDEPR,NUPDEPR+7   IF PIGGY-BACKS ARE THE SAME                  
         BE    SCPR7               TREAT AS 1 NON PIGGY PRODUCT                 
         MVI   NBPRDNO,2           SET NUMBR OF PRODUCTS                        
         MVC   NUPDEFD(L'NULEN1),NULEN1  LENGTH SHARE FOR 1ST                   
         CLI   NULEN1,0            IF ZERO                                      
         BNE   SCPR5                                                            
         ZIC   RF,NULEN                                                         
         SRL   RF,1                USE HALF                                     
         STC   RF,NUPDEFD                                                       
SCPR5    ZIC   RF,NULEN                                                         
         ZIC   RE,NUPDEFD                                                       
         SR    RF,RE                                                            
         STC   RF,NUPDEFD+7        2ND PRODUCT LENGTH                           
*                                                                               
         MVC   NUPDEPCT,NUP1SHR    COST SHARE FOR 1ST                           
         OC    NUP1SHR,NUP1SHR     IF ZERO                                      
         BNZ   *+18                                                             
         TM    NUUNST2,X'04'       TRULY ZERO?                                  
         BNZ   *+10                                                             
         MVC   NUPDEPCT,=H'5000'   DEFAULT IS 50%                               
*                                                                               
         LHI   RF,10000                                                         
         ICM   RE,3,NUPDEPCT                                                    
         SR    RF,RE                                                            
         STCM  RF,3,NUPDEPCT+7     2ND PRODUCT COST SHARE                       
         B     SCPRX                                                            
*                                                                               
SCPR7    XC    HPRDEL1+10(7),HPRDEL1+10    CLEAR 2ND PROD                       
         MVI   NUPDELEN,10                                                      
         MVC   NUPDEFD(L'NULEN),NULEN  USE WHOLE SECONDS LENGTH                 
         MVC   NUPDEPCT,=H'10000'  AND 100% OF DOLLARS                          
         B     SCPRX                                                            
         DROP  R2                                                               
*                                                                               
SCPR10   MVI   ELCODE,X'14'        NO X'19', LOOK FOR X'14'                     
         LA    R2,NUDATA           GO THROUGH THE OLD CODE OF                   
         BRAS  RE,NXTEL            ALWAYS BUILDING X'14' AND THEN               
         BNE   SCPR15              CONVERT X'14' TO X'19'                       
*                                  THIS IS EASIER SINCE CODE BELOW              
         ZIC   RF,1(R2)            WILL BE OBSOLETE SOON                        
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   WK(0),0(R2)         SAVE ELEMENT                                 
         MVI   PRDELSW,C'Y'        *** THIS CAN BE SET LATER IF NBUNST3         
         B     SCPR50              *** INDICATES COPY-SPLIT                     
*                                                                               
SCPR15   DS    0H                  IF NO ELEMENT, BUILD FROM NUPRD ETC.         
         MVI   NBPRDNO,1           SET NUMBER OF PRODS (FOR NEPACC)             
         MVC   NBPRDLST(L'NUPRD),NUPRD                                          
         LA    R2,WK                                                            
         USING NUPRDD,R2                                                        
         MVI   NUPRDEL,X'14'                                                    
         MVC   NUPRDPR,NUPRD       1ST PRODUCT                                  
         MVI   NUPRDLEN,9          LENGTH IF ONE PRODUCT                        
         MVC   NUPRDPR+1(L'NULEN),NULEN  USE WHOLE SECONDS LENGTH               
         MVC   NUPRDPCT,=H'10000'  AND 100% OF DOLLARS                          
         CLI   NUPRD2,0            IF NO SECOND PRODUCT,DONE                    
         BE    SCPR50                                                           
*        CLI   CORPOPT,C'Y'        SPECIAL CORPORATE PRODUCT OVERRIDE           
*        BNE   SCPR50                                                           
*        OC    NUPRD,NUPRD         IF UNALLOCATED PRODUCT                       
*        BZ    SCPR50              DON'T DO THE OVERRIDE                        
*        L     RF,VCLIST           GET PRODUCT CODE                             
*CPR17   CLI   0(RF),0                                                          
*        BNE   *+6                                                              
*        DC    H'0'                BAD PRODUCT                                  
*        CLC   0(3,RF),QCORPRD                                                  
*        BE    *+12                                                             
*        LA    RF,4(RF)                                                         
*        B     SCPR17                                                           
*        MVC   NUPRDPR,3(RF)       OVERRIDE WITH CORP PRODUCT                   
*        B     SCPR50              DONE                                         
*                                                                               
SCPR20   TM    NBUNST3,X'40'       IS THIS A COPY-SPLIT BUY ?                   
         BNO   *+8                 IF YES, ALSO TURN ON PRDELSW                 
         MVI   PRDELSW,C'Y'        IN ORDER TO GET FULL SHARE                   
*                                                                               
         MVI   NBPRDNO,2           SET NUMBER OF PRODS (FOR NEPACC)             
         MVC   NBPRDLST+1(L'NUPRD2),NUPRD2                                      
         MVI   NUPRDLEN,15         LENGTH IF 2 PRODUCTS                         
         MVC   NUPRDPR+6(L'NUPRD2),NUPRD2 2ND PRODUCT CODE                      
         MVC   NUPRDPR+1(L'NULEN1),NULEN1 LENGTH SHARE FOR 1ST                  
         CLI   NULEN1,0            IF ZERO                                      
         BNE   SCPR25                                                           
         ZIC   RF,NULEN                                                         
         SRL   RF,1                USE HALF                                     
         STC   RF,NUPRDPR+1                                                     
*                                                                               
SCPR25   DS    0H                                                               
         MVC   NUPRDPCT,NUP1SHR    COST SHARE FOR 1ST                           
         OC    NUP1SHR,NUP1SHR     IF ZERO                                      
         BNZ   *+18                                                             
         TM    NUUNST2,X'04'       TRULY ZERO?                                  
         BNZ   *+10                                                             
         MVC   NUPRDPCT,=H'5000'   DEFAULT IS 50%                               
*                                                                               
         ZIC   RF,NULEN                                                         
         ZIC   RE,NUPRDPR+1                                                     
         SR    RF,RE                                                            
         STC   RF,NUPRDPR+1+6      2ND PRODUCT LENGTH                           
         LHI   RF,10000                                                         
         ICM   RE,3,NUPRDPCT                                                    
         SR    RF,RE                                                            
         STCM  RF,3,NUPRDPCT+6     2ND PRODUCT COST SHARE                       
         DROP  R2,R3                                                            
*                                                                               
SCPR50   DS    0H                  MAKE X'19' OUT OF X'14'                      
         CLI   PRDELSW,C'Y'          IF COPY-SPLIT NBPR1CL3 CAN BE 0            
         BE    *+14                                                             
         OC    NBPR1CL3,NBPR1CL3     IF UNALLOCATED PRODUCT, SKIP               
         BZ    SCPRXX                                                           
*                                                                               
         LA    R2,HPRDEL1                                                       
         LA    R3,WK               X'14'                                        
         MVI   0(R2),X'19'         ELEM ID                                      
         LHI   R0,10               MIN ELEM LENGTH                              
         STC   R0,1(R2)                                                         
         LA    R2,NUPDEPR-NUPDED(R2) GET RID OF OVRHEAD (ID, LEN, STAT)         
         LA    R3,NUPRDPR-NUPRDD(R3)                                            
SCPR55   MVC   NUPDEPCT-NUPDEPR(,R2),NUPRDPCT-NUPRDPR(R3)   %                   
         MVC   NUPDEFD-NUPDEPR(1,R2),1(R3)      LENGTH                          
         L     RF,VCLIST                                                        
SCPR60   CLI   0(RF),0                                                          
         BNE   *+6                                                              
         DC    H'0'                                                             
         CLC   0(1,R3),3(RF)                                                    
         BE    *+12                                                             
         LA    RF,4(RF)                                                         
         B     SCPR60                                                           
         MVC   0(3,R2),0(RF)       3CHAR PRODUCT                                
         LA    R2,7(R2)            NEXT PRODUCT SLOT IN X'19'                   
         LA    R3,6(R3)            NEXT PRODUCT SLOT IN X'14'                   
         CLI   0(R3),0             IS THERE ANOTHER PRODUCT                     
         BE    SCPRX               NO, DONE                                     
         AHI   R0,7                                                             
         STC   R0,HPRDEL1+1                                                     
         B     SCPR55                                                           
*                                                                               
SCPRX    CLI   CORPOPT,C'Y'        SPECIAL CORPORATE PRODUCT OVERRIDE           
         BNE   SCPRXX                                                           
         LA    R2,HPRDEL1                                                       
         CLI   1(R2),10            THERE SHOULD ONLY BE ONE PRD                 
         BH    SCPRXX              NO, DONE                                     
         OC    NBPR1CL3,NBPR1CL3   IF UNALLOCATED PRODUCT                       
         BZ    SCPRXX              DON'T DO THE OVERRIDE                        
         MVC   NUPDEPR-NUPDED(,R2),QCORPRD  ELSE OVERRIDE THE PRD               
SCPRXX   XIT1                                                                   
         EJECT                                                                  
         LTORG                                                                  
*                                  RE-WRITE UNIT RECORDS                        
*                                                                               
SPBU02   CSECT                                                                  
NTU60    NMOD1 0,NTU60                                                          
         LA    RC,SPACEND                                                       
*                                                                               
         MVC   NBNOWRIT,RCWRITE    SET WRITE= OPTION                            
         LA    R0,DMWORKU          DEDICATED DMWORK AREA FOR NETIO              
         ST    R0,NBADMWRK         PASS ADDRESS TO NETIO                        
*                                                                               
         L     R2,ASORTCOM         DISK ADDRESS IN COMMENT                      
         USING SORTCOMD,R2                                                      
         OC    SORTDA,SORTDA       NO DA MEANS LINE IS TOTALLY BILLED           
         BNZ   NTU60K              (MAY BE MULTIPLE UNITS)                      
***         IF CTYPTAB WAS USED, MIGHT NEED TO CLEAR BEFORE GETTING OUT         
         CLI   ONENTRY,C'Y'        CTYPTAB HAS JUST 1 ENTRY ?                   
         BE    *+12                YES, NEED TO CLEAR THE TABLE                 
         CLI   SPOTCTL,C'Y'        DO WE WANT SPOT DETAILS?                     
         BE    NTU60X              YES, DON'T CLEAR                             
*                                  TIME TO CLEAR CTYPTAB                        
         L     RE,=A(CTYPTAB)      CLEAR CHARGE TYPE TABLE                      
         LHI   RF,CTYPTMAX*CTYPTBL                                              
         XCEF                                                                   
         L     R1,=A(CTYPTAB)      INIT 1ST ROW TO PACKED                       
         MVI   0(R1),X'FF'                                                      
         LA    R1,CTYPBRK(R1)      POINT TO $$                                  
         LA    RF,ROWTL(R1)        POINT PAST $$                                
         BRAS  RE,ZAPSTR                                                        
         B     NTU60X                                                           
NTU60K   MVC   NBKEY+21(L'SORTDA),SORTDA  SET DISK ADDRESS                      
         DROP  R2                                                               
*                                                                               
         MVI   NBFUNCT,NBFGET                                                   
         GOTO1 NETIO,DMCB,NETBLOCK                                              
*                                                                               
         CLI   RCTRACE,C'Y'        DUMP RECORD?                                 
         BNE   NTU60J                                                           
         MVC   WK2,SPACES                                                       
         MVC   WK2+10(11),=C'NTU60 START'                                       
         GOTO1 HEXOUT,DMCB,NBKEY+21,WK2,4,=C'N'                                 
         GOTO1 =V(PRTREC),DMCB,NBAIO,(27,20),PRINT,HEXOUT,C'DOME',     +        
               (21,WK2)                                                         
*                                                                               
NTU60J   DS    0H                                                               
         L     RE,APRD                                                          
         MVC   WPRDC,0(RE)         3-CHAR PRODUCT CODE                          
         XC    WPRD,WPRD                                                        
*        ZIC   RE,0(RF)            GET PRODUCT CODE FROM PRODUCT SEQ            
*        MHI   RE,4                                                             
*        L     RF,VCLIST                                                        
*        LA    RE,0(RF,RE)                                                      
         L     RF,VCLIST                                                        
         CLC   0(3,RE),0(RF)                                                    
         BE    *+20                                                             
         LA    RF,4(RF)                                                         
         CLI   0(RF),0             IF REACHED 0 -- OVERFLOW PRD                 
         BE    *+14                                                             
         B     *-22                                                             
*                                                                               
         MVC   WPRD,3(RF)          1-BYTE PRODUCT CODE                          
*                                                                               
         BAS   RE,WRTUBILL         WRITE UNIT BILLING RECORDS                   
*                                                                               
         CLI   ONENTRY,C'Y'        CTYPTAB HAS JUST 1 ENTRY ?                   
         BE    *+12                YES, NEED TO CLEAR THE TABLE                 
         CLI   SPOTCTL,C'Y'        DO WE WANT SPOT DETAILS?                     
         BE    NTU60H                                                           
*                                  TIME TO CLEAR CTYPTAB                        
         L     RE,=A(CTYPTAB)      CLEAR CHARGE TYPE TABLE                      
         LHI   RF,CTYPTMAX*CTYPTBL                                              
         XCEF                                                                   
         L     R1,=A(CTYPTAB)      INIT 1ST ROW TO PACKED                       
         MVI   0(R1),X'FF'                                                      
         LA    R1,CTYPBRK(R1)      POINT TO $$                                  
         LA    RF,ROWTL(R1)        POINT PAST $$                                
         BRAS  RE,ZAPSTR                                                        
*                                                                               
NTU60H   CLI   PROFB1S+3,C'Y'      USING NEW UNIT BILLING REC?                  
         BE    NTU60X              YES: DON'T WRITE OLD UNIT BILL DATA          
*                                                                               
         OC    MANRVDTP,MANRVDTP   REVERSAL?                                    
         BZ    NTU62                                                            
*                                  YES, FIND ELEMENTS TO REVERSE                
         L     R2,NBAIO                                                         
         LA    R2,NUDATA-NURECD(R2)                                             
         MVI   ELCODE,X'10'        BILL ELEMENT                                 
*                                                                               
NTU61    DS    0H                                                               
         BRAS  RE,NXTEL                                                         
         BNE   NTU62                                                            
*                                                                               
         USING NUBILD,R2                                                        
*        MVC   FULL,WPRD           SAVE WPRD                                    
         BRAS  RE,CKPRD            NEED THIS PRODUCT?                           
*        MVC   WPRD,FULL           RESTORE                                      
         BNE   NTU61                                                            
*                                                                               
         CLC   NUBILDAT,MANRVDTP   ELEMENT HAS REVERSAL DATE?                   
         BNE   NTU61               NO-SKIP                                      
         XC    DMCB,DMCB                                                        
         GOTO1 =V(SPFMTINO),DMCB,,(C'P',NUBILNUM)                               
         L     RF,DMCB+4                                                        
         OC    0(2,RF),0(RF)       IF NULLS -> INVALID                          
         BNZ   *+6                                                              
         DC    H'0'                                                             
         CLC   MANRVNO,0(RF)       RIGHT INVOICE NUMBER?                        
*******  OC    NUBILNUM,=C'0000'                                                
*******  PACK  DUB,NUBILNUM                                                     
*******  CVB   R0,DUB                                                           
*******  CH    R0,MANRVNO          RIGHT INVOICE NUMBER?                        
         BNE   NTU61               NO-SKIP                                      
*                                                                               
         OI    NUBILST,NUBILRDQ    SET REVERSED                                 
         B     NTU61               NEXT ELEMENT                                 
         DROP  R2                                                               
*                                  FIND WHERE TO PUT BILLING ELEMENTS           
NTU62    DS    0H                                                               
         L     R2,NBAIO                                                         
         LA    R2,NUDATA-NURECD(R2)                                             
         MVI   BYTE2,0             CLEAR BILL ELEMENT SWITCH                    
*                                                                               
NTU63    DS    0H                                                               
         CLI   0(R2),0             EOR                                          
         BE    NTU63D                                                           
         CLI   0(R2),X'10'                                                      
         BH    NTU63D                                                           
         BL    *+16                                                             
         TM    NUBILST-NUBILD(R2),NUBILRDQ+NUBILRLQ                             
         BNZ   *+8                 DON'T COUNT IF REVERSED/REVERSAL             
         MVI   BYTE2,1             SET HAVE BILL ELEMENT                        
         ZIC   R0,1(R2)                                                         
         AR    R2,R0                                                            
         B     NTU63                                                            
*                                                                               
NTU63D   DS    0H                                                               
         L     R3,=A(CTYPLST)      START OF COST TYPE LIST                      
         L     R5,SAVR1            START OF TOTALS (A(ACCUMULATOR))             
         AHI   R5,MAXMOS*ROWL      POINT TO TOTAL ROW                           
*                                                                               
         USING CTYLD,R3                                                         
NTU64    MVC   WTYP,CTYLCOD        SET COST TYPE                                
*                                                                               
         XC    WORK,WORK                                                        
         MVC   WORK(ACCUMLQ),0(R5)                                              
         SP    WORK(ACCUMLQ),ROWHL(ACCUMLQ,R5)                                  
         MVC   WORK+ACCUMLQ(ACCUMLQ),ACCUMLQ(R5)                                
         SP    WORK+ACCUMLQ(ACCUMLQ),ROWHL+ACCUMLQ(ACCUMLQ,R5)                  
         MVC   WORK+ACMORD2-ACMORD(ACCUMLQ),ACMORD2-ACMORD(R5)                  
         SP    WORK+ACMORD2-ACMORD(ACCUMLQ),ROWHL+ACMORD2-ACMORD(ACCUML+        
               Q,R5)                                                            
*                                                                               
         CP    WORK(ACCUMLQ),=P'0' ANY GROSS BILLABLE?                          
         BNE   NTU65                                                            
         CP    WORK+ACCUMLQ(ACCUMLQ),=P'0' ANY NET BILLABLE?                    
         BNE   NTU65               YES- PROCESS, ELSE SKIP                      
         CLI   WTYP,C'T'           ONLY FOR TIME COSTS                          
         BNE   NTU67                                                            
         OC    MANRVDTP,MANRVDTP   UNLESS REVERSAL                              
         BNZ   NTU65                                                            
         CLI   BYTE2,0             UNLESS HAVE PREVIOUS BILLING                 
         BNE   NTU67                                                            
         TM    NBUNITST,X'42'      BILL ONCE TO MARK FREE UNITS                 
         BNZ   NTU67               UNLESS PREEMPT OR MISSED                     
         L     RF,NBAIO                                                         
         TM    NURSTAT-NURECD(RF),X'80'    OR DELETED                           
         BNZ   NTU67                                                            
*                                                                               
NTU65    DS    0H                                                               
*                                                                               
         XC    X,X                                                              
         LA    R4,X                                                             
         USING NUBILD,R4                                                        
*                                                                               
         MVI   NUBILEL,X'10'       ELEMENT CODE                                 
         MVI   NUBILLEN,29         FIXED LENGTH W/ COS2 AND 3-CHAR PRD          
         CLI   SCBNCSW,C'C'        SEPARATE COMMISSION?                         
         BNE   *+8                                                              
         OI    NUBILST,NUBILSCQ                                                 
         CLI   SCBNCSW,C'N'        NET BILL?                                    
         BNE   *+8                                                              
         OI    NUBILST,NUBILSNQ                                                 
         CLI   WTYP,C'T'           FOR TIME BILLING ONLY                        
         BNE   NTU65K                                                           
         CLI   PROFBN+3,C'D'       ACT MINUS ASS PLUS INT                       
         BE    *+12                                                             
         CLI   PROFBN+3,C'E'       AMA BILL? (ACTUAL MINUS ASSIGNED)            
         BNE   *+8                                                              
         OI    NUBILST,NUBILAMQ                                                 
*                                                                               
NTU65K   MVC   NUBILTYP,WTYP       CHARGE TYPE                                  
         MVC   NUBILBTY,TYPE       BILLING TYPE                                 
         MVC   NUBILDAT,TODAYP     RUN DATE                                     
         MVC   NUBILPRD,WPRD       PRODUCT 1 BYTE                               
         MVC   NUBILPRC,WPRDC      PRODUCT 3 CHAR                               
         MVC   NUBILIDT,BINVDTEP   INVOICE DATE                                 
         MVC   NUBILNUM,SVINVMO+2  CHAR INVOICE NUMBER                          
******** MVC   NUBILNUM,=C'0000'                                                
******** LH    RE,INVNO            INVOICE NUMBER                               
******** CVD   RE,DUB                                                           
******** OI    DUB+7,X'0F'                                                      
******** UNPK  NUBILNUM,DUB                                                     
*                                                                               
         CVB   RE,WORK                                                          
         STCM  RE,15,NUBILGRS      GROSS                                        
         CVB   RE,WORK+ACCUMLQ                                                  
         STCM  RE,15,NUBILNET      NET                                          
*                                                                               
***      CLI   COST2SW,C'Y'        FOR COST2 MODE                               
***      BNE   NTU66F                                                           
         CLI   NUBILTYP,C'T'       AND TIME                                     
         BE    NTU66C                                                           
         CLI   NUBILTYP,C'I'       AND INTEGRATION COSTS ONLY                   
         BNE   NTU66F                                                           
         CP    ACMORD2-ACMORD+WORK,=P'0'                                        
         BE    NTU66F              IF 0 ASSUME NOT USING COS2 FOR INT           
NTU66C   CVB   RE,WORK+ACMORD2-ACMORD  DO COST2                                 
         STCM  RE,15,NUBILGR2                                                   
****     MVI   NUBILLEN,28         SET NEW LENGTH                               
*                                                                               
NTU66F   DS    0H                                                               
         OC    MANRVDTP,MANRVDTP   REVERSAL?                                    
         BZ    *+8                                                              
         OI    NUBILST,NUBILRLQ    SET REVERSAL ELEMENT                         
         DROP  R4                                                               
*                                                                               
         GOTO1 RECUP,DMCB,(C'U',NBAIO),X,(R2)                                   
         ZIC   R0,1(R2)                                                         
         AR    R2,R0               BUMP ELEMENT POINTER                         
*                                                                               
         AP    DBTOTG,WORK(ACCUMLQ)             GROSS                           
         AP    DBTOTN,WORK+ACCUMLQ(ACCUMLQ)     NET                             
         AP    DBTOTG2,WORK+ACMORD2-ACMORD(ACCUMLQ)     GROSS2                  
*                                                                               
NTU67    DS    0H                                                               
         LA    R3,CTYLSTL(R3)      NEXT COST TYPE                               
         CLI   0(R3),X'FF'                                                      
         BE    *+12                                                             
         LA    R5,ROWTL(R5)        NEXT CHARGE TYPE                             
         B     NTU64                                                            
         DROP  R3                                                               
*                                                                               
         CLI   RCWRITE,C'Y'        WRITE=YES?                                   
         BNE   NTU68B                                                           
         CLI   TESTFLAG,C'T'       DRAFT BILLING?                               
         BE    NTU68B                                                           
         GOTO1 DATAMGR,DMCB,PUTREC,=C'UNTFILE',NBKEY+21,NBAIO,DMWORKU           
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
NTU68B   DS    0H                                                               
         L     RF,APATCH                                                        
         TM    0(RF),X'80'         TRACE OUTPUT RECORDS?                        
         BZ    NTU60X                                                           
         MVC   WK2,SPACES                                                       
         MVC   WK2+10(9),=C'NTU60 END'                                          
         GOTO1 HEXOUT,DMCB,NBKEY+21,WK2,4,=C'N'                                 
         GOTO1 =V(PRTREC),DMCB,NBAIO,(27,20),PRINT,HEXOUT,C'DOME',     +        
               (19,WK2)                                                         
*                                                                               
NTU60X   DS    0H                                                               
         XIT1                                                                   
         EJECT                                                                  
*                                  RE-WRITE UNIT BILLING RECORDS                
         SPACE 2                                                                
WRTUBILL NTR1                                                                   
*                                                                               
* THE FIRST STEP IS TO READ THROUGH ALL OF THE UNIT BILLING RECORDS             
* FOR THE CURRENT UNIT. IF THIS IS A REVERSAL BILL, WE MUST MARK THE            
* APPROPRIATE ELEMENTS REVERSED (UNLESS THEY ARE ALREADY MARKED AS              
* SUCH). ALSO, WE KEEP TRACK TO SEE IF THERE IS CURRENTLY ANY ACTIVE            
* BILL ELEMENT AT ALL FOR THIS UNIT, FOR ANY DATE (SEE FIELD UNITBILF).         
*                                                                               
         MVI   UNITBILF,C'N'       ASSUME UNIT WASN'T BILLED BEFORE             
*                                                                               
         XC    XSPKEY,XSPKEY                                                    
         LA    R3,XSPKEY           BUILD UNIT BILL RECORD KEY                   
         USING NUBKEY,R3                                                        
         MVI   NUBKSYS,NUBKSYSQ    X'0E06' RECORDS                              
         MVI   NUBKSTYP,NUBKSTYQ                                                
         MVC   NUBKAM,NBACTAM      AGENCY/MEDIA                                 
         MVC   NUBKCLI,NBACTCLI    CLIENT                                       
         MVC   NUBKNET,NBACTNET    NETWORK                                      
         MVC   NUBKPROG,NBACTPRG   PROGRAM                                      
         MVC   NUBKDATE,NBACTDAT   AIR DATE                                     
         MVC   NUBKEST,NBACTEST    ESTIMATE                                     
         MVC   NUBKSUB,NBACTSUB    SUB-LINE                                     
         MVC   NUBKDPT,NBACTDP     DAYPART                                      
         MVC   XSPKEYSV,XSPKEY                                                  
*                                                                               
         GOTO1 DATAMGR,DMCB,(X'08',DMRDHI),=C'XSPDIR',XSPKEYSV,XSPKEY           
*                                                                               
WRTU10   TM    DMCB+8,X'FF'-X'02'  KEY MIGHT BE DELETED                         
         BZ    *+6                                                              
         DC    H'0'                ANY OTHER DMGR ERROR IS UNACCEPTABLE         
*                                                                               
         CLC   NUBKEY(NUBKBDAT-NUBKEY),XSPKEYSV   ENTIRE KEY W/OUT DATE         
         BNE   WRTU70              NOTHING ELSE FOR THIS UNIT                   
*                                                                               
         TM    NUBKSTAT,X'80'      KEY IS DELETED?                              
         BO    WRTU60              YES: TRY FOR ANOTHER                         
*                                                                               
         MVI   BYTE3,C'N'          ASSUME NOTHING TO REVERSE HERE               
         GOTO1 DATAMGR,DMCB,GETREC,=C'XSPFIL',NUBDA,A(XSPIO),DMWORKX            
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R6,=A(XSPIO)        UNIT BILL RECORD                             
         USING NBILD,R6                                                         
         MVI   ELCODE,NBILELQ      LOOK FOR BILLING ELEMENTS                    
         BRAS  RE,GETEL                                                         
         BNE   WRTU60              NONE, SO NOTHING TO EXAMINE                  
*                                                                               
WRTU20   CLC   NUBKBDAT,MANRVDTP   MIGHT ELEMENT NEED TO BE REVERSED?           
         BNE   WRTU30              NO                                           
         CLC   NBILNUM,MANRVNO     IS ELEMENT FOR THIS INVOICE NUMBER?          
         BNE   WRTU30                                                           
         TM    NBILST,NBILRDQ      THIS ELEMENT MUST BE MARKED REVERSED         
         BO    WRTU30              ... BUT WE ALREADY DID THIS ONE              
         OI    NBILST,NBILRDQ      MARK REVERSED                                
         MVI   BYTE3,C'Y'          RECORD MUST BE WRITTEN BACK                  
*                                                                               
WRTU30   DS    0H                                                               
         TM    NBILST,NBILRDQ+NBILRLQ  IGNORE REVERSED/REVERSALS                
         BNZ   *+8                                                              
         MVI   UNITBILF,C'Y'       REMEMBER: UNIT WAS BILLED BEFORE             
         BRAS  RE,NEXTEL                                                        
         BE    WRTU20                                                           
         DROP  R6                                                               
*                                                                               
         CLI   BYTE3,C'Y'          WAS RECORD MODIFIED?                         
         BNE   WRTU60              NO                                           
         L     RF,APATCH                                                        
         TM    0(RF),X'80'         TRACE OUTPUT RECORDS?                        
         BZ    WRTU50                                                           
         MVC   WK2,SPACES                                                       
         MVC   WK2+10(27),=C'REVERSE UNIT BILLING RECORD'                       
         GOTO1 HEXOUT,DMCB,NUBDA,WK2,4,=C'N'                                    
         GOTO1 =V(PRTREC),DMCB,A(XSPIO),(42,32),PRINT,HEXOUT,C'DOME',  +        
               (37,WK2)                                                         
*                                                                               
WRTU50   DS    0H                                                               
         CLI   RCWRITE,C'Y'        WRITE=YES?                                   
         BNE   WRTU60                                                           
         CLI   TESTFLAG,C'T'       DRAFT BILLING?                               
         BE    WRTU60                                                           
         GOTO1 DATAMGR,DMCB,PUTREC,=C'XSPFIL',NUBDA,A(XSPIO),DMWORKX            
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
WRTU60   DS    0H                                                               
         GOTO1 DATAMGR,DMCB,(X'08',DMRSEQ),=C'XSPDIR',,XSPKEY                   
         B     WRTU10                                                           
*                                                                               
* NOW WE SEE IF A UNIT BILLING RECORD ALREADY EXISTS FOR THIS                   
* UNIT/DATE. SINCE WE GET CALLED HERE FOR EACH PRODUCT FOR THE UNIT,            
* WE'LL ADD THE RECORD AT THE FIRST PRODUCT, THEN CHANGE IT ON EACH             
* SUBSEQUENT PRODUCT BY ADDING MORE ELEMENTS TO IT (DURING SUBSEQUENT           
* CALLS TO THIS ROUTINE).                                                       
*                                                                               
WRTU70   DS    0H                                                               
         MVI   BYTE3,C'N'          ASSUME NO ACTIVITY ON THIS RECORD            
*                                                                               
         XC    XSPKEY,XSPKEY                                                    
         MVI   NUBKSYS,NUBKSYSQ    X'0E06' RECORDS                              
         MVI   NUBKSTYP,NUBKSTYQ                                                
         MVC   NUBKAM,NBACTAM      AGENCY/MEDIA                                 
         MVC   NUBKCLI,NBACTCLI    CLIENT                                       
         MVC   NUBKNET,NBACTNET    NETWORK                                      
         MVC   NUBKPROG,NBACTPRG   PROGRAM                                      
         MVC   NUBKDATE,NBACTDAT   AIR DATE                                     
         MVC   NUBKEST,NBACTEST    ESTIMATE                                     
         MVC   NUBKSUB,NBACTSUB    SUB-LINE                                     
         MVC   NUBKDPT,NBACTDP     DAYPART                                      
         MVC   NUBKBDAT,TODAYP     BILLING DATE (TODAY/COMPRESSED)              
         MVC   XSPKEYSV,XSPKEY                                                  
         XC    XSPDA,XSPDA         NO DISK ADDRESS YET                          
*                                                                               
         GOTO1 DATAMGR,DMCB,DMREAD,=C'XSPDIR',XSPKEY,XSPKEY                     
         TM    DMCB+8,X'FF'-X'10'                                               
         BZ    *+6                                                              
         DC    H'0'                FATAL DATAMGR ERROR                          
         TM    DMCB+8,X'10'                                                     
         BO    WRTU80              KEY NOT FOUND: BUILD NEW RECORD              
*                                                                               
         MVC   XSPDA,NUBDA         SAVE D/A                                     
         GOTO1 DATAMGR,DMCB,GETREC,=C'XSPFIL',NUBDA,A(XSPIO),DMWORKX            
         CLI   DMCB+8,0                                                         
         BE    WRTU90                                                           
         DC    H'0'                                                             
         DROP  R3                                                               
*                                                                               
WRTU80   DS    0H                                                               
         L     R6,=A(XSPIO)        BUILD UNIT BILL RECORD                       
         USING NUBRECD,R6                                                       
         XC    NUBRECD(NUBELDQ),NUBRECD                                         
         CLI   PROFB1S+5,C'Y'      CREATE X'0E0A' ACTIVE POINTERS?              
         BE    *+14                                                             
         MVC   NUBKEY,XSPKEYSV     SAVED X'0E06' KEY IS ACTIVE KEY              
         B     WRTU87                                                           
*                                                                               
         MVI   NUBK0SYS,NUBK0SYQ   X'0E0A' AIRDATE ACTIVE KEY                   
         MVI   NUBK0STY,NUBK0STQ                                                
         MVC   NUBK0AM,NBACTAM     AGENCY/MEDIA                                 
         MVC   NUBK0CLI,NBACTCLI   CLIENT                                       
         MVC   NUBK0DAT,NBACTDAT   AIR DATE                                     
         MVC   NUBK0TIM,NBACTSQH   START 1/4 HOUR                               
         MVC   NUBK0NET,NBACTNET   NETWORK                                      
         MVC   NUBK0PRG,NBACTPRG   PROGRAM                                      
         MVC   NUBK0EST,NBACTEST   ESTIMATE                                     
         MVC   NUBK0SUB,NBACTSUB   SUB-LINE                                     
         MVC   NUBK0DPT,NBACTDP    DAYPART                                      
         MVC   NUBK0BDT,TODAYP     BILLING DATE (TODAY/COMPRESSED)              
*                                                                               
         LA    RF,DAYTABLE         CONVERT TO REP DAY                           
WRTU83   CLI   0(RF),X'FF'         EOT?                                         
         BE    WRTU85                                                           
         CLC   NBDAY,0(RF)                                                      
         BE    WRTU85                                                           
         LA    RF,L'DAYTABLE(RF)                                                
         B     WRTU83                                                           
WRTU85   MVC   NUBSTAT+1(1),1(RF)  DAY                                          
*                                                                               
WRTU87   DS    0H                                                               
         MVC   NUBRECLN,=Y(NUBELDQ+1)  ADD ONE MORE BYTE FOR EOR                
         MVI   NUBDATA,0           EOR                                          
         CLI   NBSTATYP,C'C'       CABLE?                                       
         BNE   *+12                                                             
         OI    NUBSTAT,X'01'                                                    
         B     WRTU90                                                           
         CLI   NBSTATYP,C'S'       SYNDICATION?                                 
         BNE   *+12                                                             
         OI    NUBSTAT,X'02'                                                    
         B     WRTU90                                                           
         CLI   NBSTATYP,C'O'       OTHER?                                       
         BNE   *+8                                                              
         OI    NUBSTAT,X'03'                                                    
*                                                                               
WRTU90   DS    0H                                                               
         CLI   RCTRACE,C'Y'                                                     
         BNE   WRTU100                                                          
         MVC   WK2,SPACES                                                       
         MVC   WK2+10(23),=C'OLD UNIT BILLING RECORD'                           
         GOTO1 HEXOUT,DMCB,XSPDA,WK2,4,=C'N'                                    
         GOTO1 =V(PRTREC),DMCB,A(XSPIO),(42,32),PRINT,HEXOUT,C'DOME',  +        
               (33,WK2)                                                         
*                                                                               
* AT THIS POINT, XSPIO CONTAINS A VALID UNIT BILLING RECORD, WITH OR            
* WITHOUT ELEMENTS IN IT. WE NOW BUMP THROUGH THE COSTTYPE/STATION              
* TABLE, WHICH CONTAIN THE ACCUMLATED VALUES FOR THIS PRODUCT/UNIT.             
* BILLING ELEMENTS ARE CREATED AND ADDED TO THE UNIT BILLING RECORD.            
*                                                                               
WRTU100  DS    0H                                                               
         L     R3,=A(CTYPTAB)      START OF COSTTYPE TABLE                      
         USING CTYPTABD,R3                                                      
*                                                                               
WRTU110  CLI   0(R3),X'FF'         END OF TABLE?                                
         BE    WRTU140             YES                                          
*                                                                               
         ZIC   RE,CTYPTYP          COST TYPE INDEX                              
         MHI   RE,CTYLSTL          RE = DISPLACEMENT INTO TABLE                 
         A     RE,=A(CTYPLST)      RE --> TABLE ENTRY                           
         MVC   WTYP,CTYLCOD-CTYLD(RE)  'T' = TIME, ETC                          
*                                                                               
         XC    WORK,WORK           TOTALS FOR THIS COSTTYPE/STATION             
         MVC   WORK(ACCUMLQ),CTYPOG              ORDERED GROSS                  
         SP    WORK(ACCUMLQ),CTYPBG              BILLED GROSS                   
         MVC   WORK+ACCUMLQ(ACCUMLQ),CTYPON      ORDERED NET                    
         SP    WORK+ACCUMLQ(ACCUMLQ),CTYPBN      BILLED NET                     
         MVC   WORK+(2*ACCUMLQ)(ACCUMLQ),CTYPOG2 ORDERED COS2 GROSS             
         SP    WORK+(2*ACCUMLQ)(ACCUMLQ),CTYPBG2 BILLED COST2 NET               
*                                                                               
         CP    WORK(ACCUMLQ),=P'0'          ANY GROSS BILLABLE?                 
         BNE   WRTU120                                                          
         CP    WORK+ACCUMLQ(ACCUMLQ),=P'0'  ANY NET BILLABLE?                   
         BNE   WRTU120             YES- PROCESS, ELSE SKIP                      
         CLI   WTYP,C'T'           ONLY FOR TIME COSTS                          
         BNE   WRTU130                                                          
         OC    MANRVDTP,MANRVDTP   UNLESS REVERSAL                              
         BNZ   WRTU120                                                          
         CLI   UNITBILF,C'Y'       UNLESS HAVE PREVIOUS BILLING                 
         BE    WRTU130                                                          
         TM    NBUNITST,X'42'      BILL ONCE TO MARK FREE UNITS                 
         BNZ   WRTU130             UNLESS PREEMPT OR MISSED                     
         L     RF,NBAIO                                                         
         TM    NURSTAT-NURECD(RF),X'80'                                         
         BO    WRTU130             OR DELETED                                   
*                                                                               
WRTU120  DS    0H                                                               
         XC    X,X                                                              
         LA    R6,X                                                             
         USING NBILD,R6                                                         
         MVI   NBILEL,NBILELQ      ELEMENT CODE                                 
         MVI   NBILLEN,NBILELNQ    ELEMENT LENGTH                               
         CLI   SCBNCSW,C'C'        SEPARATE COMMISSION?                         
         BNE   *+8                                                              
         OI    NBILST,NBILSCQ                                                   
         CLI   SCBNCSW,C'N'        NET BILL?                                    
         BNE   *+8                                                              
         OI    NBILST,NBILSNQ                                                   
         CLI   WTYP,C'T'           FOR TIME BILLING ONLY                        
         BNE   WRTU120K                                                         
         CLI   PROFBN+3,C'D'       ACT MINUS ASS PLUS INT                       
         BE    *+12                                                             
         CLI   PROFBN+3,C'E'       AMA BILL? (ACTUAL MINUS ASSIGNED)            
         BNE   *+8                                                              
         OI    NBILST,NBILAMQ                                                   
*                                                                               
WRTU120K MVC   NBILPRD,WPRD        PRODUCT                                      
         MVC   NBILPRDC,WPRDC      PRODUCT 3-CHAR                               
         MVC   NBILCHGC,CTYPTYP    CHARGE CODE                                  
         MVC   NBILCHGT,WTYP       CHARGE TYPE                                  
         MVC   NBILMKST,CTYPSTA    LOCAL MARKET/STATION OR FEED                 
         MVC   NBILIDT,BINVDTEP    DATE ON INVOICE                              
         MVC   NBILNUM,INVNO       INVOICE NUMBER                               
         MVC   NBILBTYP,TYPE       BILLING TYPE                                 
*                                                                               
         L     RE,APER             MONTH OF SERVICE                             
         ZIC   R1,0(RE)                                                         
         LA    R1,PERLIST(R1)                                                   
         MVC   NBILMOS,PERLMOS-PERLISTD(R1)                                     
*                                                                               
         CVB   RE,WORK                                                          
         STCM  RE,15,NBILGRS       BILLED GROSS                                 
         CVB   RE,WORK+ACCUMLQ                                                  
         STCM  RE,15,NBILNET       BILLED NET                                   
*                                                                               
         CLI   COST2SW,C'Y'        FOR COST2 MODE                               
         BNE   WRTU123                                                          
         CLI   NBILCHGT,C'T'       TIME COSTS AND POSSIBLY                      
         BE    *+22                                                             
         CLI   NBILCHGT,C'I'       INTEGRATION                                  
         BNE   WRTU123                                                          
         CP    WORK+(2*ACCUMLQ)(ACCUMLQ),=P'0'                                  
         BE    WRTU123                                                          
         CVB   RE,WORK+(2*ACCUMLQ) DO COST2                                     
         STCM  RE,15,NBILGR2                                                    
*                                                                               
WRTU123  OC    MANRVDTP,MANRVDTP   REVERSAL?                                    
         BZ    WRTU125                                                          
         OI    NBILST,NBILRLQ      YES: SET REVERSAL ELEMENT FLAG               
         MVC   NBILRVDT,MANRVDTP   DATE OF REVERSED INVOICE                     
         MVC   NBILRVIN,MANRVNO    REVERSED INVOICE NUMBER                      
         DROP  R6                                                               
*                                                                               
WRTU125  DS    0H                                                               
         MVI   BYTE3,C'Y'          RECORD MUST BE WRITTEN BACK                  
*                                                                               
         GOTO1 NBHELLO,DMCB,(C'P',=C'XSPFIL'),A(XSPIO),X,0                      
         CLI   12(R1),0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         AP    UBTOTG,WORK(ACCUMLQ)             GROSS                           
         AP    UBTOTN,WORK+ACCUMLQ(ACCUMLQ)     NET                             
         AP    UBTOTG2,WORK+ACCUMLQ*2(ACCUMLQ)  GROSS2                          
*                                                                               
WRTU130  DS    0H                                                               
         LA    R3,CTYPTBL(R3)      BUMP TO NEXT ENTRY IN TABLE                  
         B     WRTU110                                                          
         DROP  R3                                                               
*                                                                               
WRTU140  DS    0H                                                               
         CLI   BYTE3,C'Y'          WAS RECORD MODIFIED?                         
         BNE   WRTUBILX            NO                                           
*                                                                               
         L     RF,APATCH                                                        
         TM    0(RF),X'80'         TRACE OUTPUT RECORDS?                        
         BZ    WRTU150                                                          
         MVC   WK2,SPACES                                                       
         MVC   WK2+10(3),=C'ADD'                                                
         OC    XSPDA,XSPDA                                                      
         BZ    *+10                                                             
         MVC   WK2+10(3),=C'PUT'                                                
         MVC   WK2+14(19),=C'UNIT BILLING RECORD'                               
         GOTO1 HEXOUT,DMCB,XSPDA,WK2,4,=C'N'                                    
         GOTO1 =V(PRTREC),DMCB,A(XSPIO),(42,32),PRINT,HEXOUT,C'DOME',  +        
               (33,WK2)                                                         
*                                                                               
WRTU150  DS    0H                                                               
         CLI   RCWRITE,C'Y'        WRITE=YES?                                   
         BNE   WRTU165                                                          
         CLI   TESTFLAG,C'T'       DRAFT BILLING?                               
         BE    WRTU165                                                          
*                                                                               
         OC    XSPDA,XSPDA         RECORD EXISTS ALREADY?                       
         BZ    WRTU160             NO: ADD IT                                   
         GOTO1 DATAMGR,DMCB,PUTREC,=C'XSPFIL',XSPDA,A(XSPIO),DMWORKX            
         CLI   DMCB+8,0                                                         
         BE    WRTUBILX            RECORD CHANGED SUCCESSFULLY                  
         DC    H'0'                                                             
*                                                                               
WRTU160  DS    0H                                                               
         GOTO1 DATAMGR,DMCB,ADDREC,=C'XSPFIL',XSPDA,A(XSPIO),DMWORKX            
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
WRTU165  DS    0H                                                               
         CLI   PROFB1S+5,C'Y'      CREATE X'0E0A' ACTIVE POINTERS?              
         BNE   WRTUBILX            NO, SO DON'T CREATE X'0E06' PASSIVE          
*                                                                               
WRTU170  DS    0H                                                               
         LA    R3,XSPKEY                                                        
         USING NUBKEY,R3                                                        
         XC    XSPKEY,XSPKEY                                                    
         MVI   NUBKSYS,NUBKSYSQ    X'0E06' PASSIVE KEY                          
         MVI   NUBKSTYP,NUBKSTYQ                                                
         MVC   NUBKAM,NBACTAM      AGENCY/MEDIA                                 
         MVC   NUBKCLI,NBACTCLI    CLIENT                                       
         MVC   NUBKNET,NBACTNET    NETWORK                                      
         MVC   NUBKPROG,NBACTPRG   PROGRAM                                      
         MVC   NUBKDATE,NBACTDAT   AIR DATE                                     
         MVC   NUBKEST,NBACTEST    ESTIMATE                                     
         MVC   NUBKSUB,NBACTSUB    SUB-LINE                                     
         MVC   NUBKDPT,NBACTDP     DAYPART                                      
         MVC   NUBKBDAT,TODAYP     BILLING DATE (TODAY/COMPRESSED)              
         L     RF,=A(XSPIO)                                                     
         MVC   NUBKSTAT,NUBSTAT-NUBRECD(RF)    STATUS BYTES                     
         MVI   NUBKSTAT+1,X'80'    *** TEMPORARY *** PASSIVE INDICATOR          
         L     RF,DMCB+8           DISK ADDRESS (FROM ADDREC ABOVE)             
         MVC   NUBDA,0(RF)                                                      
*                                                                               
         CLI   RCWRITE,C'Y'        WRITE=YES?                                   
         BNE   WRTU180                                                          
         CLI   TESTFLAG,C'T'       DRAFT BILLING?                               
         BE    WRTU180                                                          
*                                                                               
         GOTO1 DATAMGR,DMCB,DMADD,=C'XSPDIR',0,XSPKEY                           
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         DROP  R3                                                               
*                                                                               
WRTU180  DS    0H                                                               
         L     RF,APATCH                                                        
         TM    0(RF),X'80'         TRACE RECORDS?                               
         BZ    WRTUBILX                                                         
         GOTO1 PRNTBL,DMCB,=C'ADDING PASSIVE',XSPKEY,C'DUMP',40,=C'1D'          
*                                                                               
WRTUBILX DS    0H                                                               
         XIT1                                                                   
         SPACE 3                                                                
DAYTABLE DC    X'4001'           MON                                            
         DC    X'2002'           TUE                                            
         DC    X'1003'           WED                                            
         DC    X'0804'           THU                                            
         DC    X'0405'           FRI                                            
         DC    X'0206'           SAT                                            
         DC    X'0107'           SUN                                            
         DC    X'7C08'           M-F                                            
         DC    X'7F09'           M-S                                            
         DC    X'FF0A'           VAR                                            
         SPACE 3                                                                
         LTORG                                                                  
         EJECT                                                                  
*                                  CHECK IF WANT THIS PRODUCT (IN WPRD)         
CKPRD    NMOD1 0,CKPRD                                                          
         LA    RC,SPACEND                                                       
*                                                                               
***      CLI   WPRD,0                                                           
***      BE    CKPNO               SKIP UNALLOCATED                             
         OC    WPRDC,WPRDC         SKIP UNALLOCATED                             
         BZ    CKPNO                                                            
*                                                                               
         LA    R2,WORK                                                          
         XC    WORK(PEFFTLN),WORK                                               
         USING PEFFTBD,R2                                                       
         MVC   PEFFPRD,WPRDC       PRODUCT CODE                                 
         GOTO1 BINSRCH,PEFFPARS,PEFFTBD                                         
         CLI   0(R1),1                                                          
         BE    *+16                PRODUCT NOT FOUND -- THAT'S OK               
         ICM   R2,15,0(R1)                                                      
         TM    PEFFFLG,PEFFNBQ     DON'T BILL THIS PRODUCT?                     
         BO    CKPNO               CORRECT                                      
         DROP  R2                                                               
*                                                                               
*        CLI   KPRD,0              ALL PRODUCTS                                 
         OC    KPRDC,KPRDC                                                      
         BZ    CKP5                                                             
*        CLI   KPRD,X'FF'                                                       
         CLC   KPRDC,=C'POL'                                                    
         BE    CKP5                                                             
*        CLC   KPRD,WPRD           ONE PRODUCT MUST BE EQUAL                    
         CLC   KPRDC,WPRDC         ONE PRODUCT MUST BE EQUAL                    
         BE    CKP5                                                             
         CLC   QPTNR,WPRDC         MAY = 2ND OF PIGGY PAIR                      
         BE    CKP5                                                             
         CLI   BYTE3,C'I'          SPECIAL FOR INTEGRATION                      
         BNE   CKPNO                                                            
         XC    BYTE3,BYTE3         CLEAR IT AND EXIT                            
         B     CKPNO                                                            
*                                                                               
CKP5     DS    0H                                                               
*        CLC   WPRD,SAVPRD         SAME PRODUCT?                                
         CLC   WPRDC,SAVPRDC       SAME PRODUCT?                                
         BE    CKP5D                                                            
*        MVC   SAVPRD,WPRD                                                      
         MVC   SAVPRDC,WPRDC                                                    
*                                                                               
         CLI   QPGR,C' '           TEST PGRS                                    
         BE    CKPYES              NO-OK                                        
*                                  YES                                          
         L     RF,PRDLIST                                                       
CKP5B    DS    0H                                                               
*        CLC   WPRD,5(RF)                                                       
         CLC   WPRDC,2(RF)                                                      
         BE    *+12                                                             
         LA    RF,6(RF)                                                         
         B     CKP5B                                                            
*                                                                               
         MVC   SAVPRDC,2(RF)                                                    
         MVC   SAVPGR,0(RF)                                                     
         UNPK  WORK(5),SAVPGR(3)                                                
         MVC   SAVPGRU,WORK                                                     
CKP5D    DS    0H                                                               
         CLI   PGRQ,C'A'                                                        
         BE    CKPYES                                                           
         CLC   SAVPGR,=X'9999'     PGR OK?                                      
         BNE   CKPYES                                                           
*                                                                               
CKPNO    DS    0H                                                               
         LTR   RE,RE               REJECT PRODUCT                               
         B     CKPXIT                                                           
*                                                                               
CKPYES   DS    0H                                                               
*                                  GET PRODUCT SEQ NO FROM PRODUCT CODE         
*        L     RF,VCLIST                                                        
*        LR    R0,RF                                                            
*                                                                               
*        CLC   WPRD,3(RF)                                                       
*        BE    *+12                                                             
*        LA    RF,4(RF)                                                         
*        B     *-14                                                             
*                                                                               
*        SR    RF,R0                                                            
*        SRL   RF,2                                                             
*        STC   RF,WPRD             POSITIONAL PRODUCT CODE                      
         MVC   WPGR,SAVPGRU        SET PRODUCT GROUP                            
*                                                                               
         CR    RE,RE               PRODUCT OK                                   
*                                                                               
CKPXIT   XIT1                                                                   
         EJECT                                                                  
* DEIS LIKES GETEL                                                              
*                                                                               
         GETEL R6,42,ELCODE                                                     
         SPACE 3                                                                
* GRANT DIDN'T LIKE GETEL, APPARENTLY                                           
*                                                                               
NXTEL    ZIC   R0,1(R2)                                                         
         AR    R2,R0                                                            
         CLI   0(R2),0                                                          
         JE    *+16                                                             
         CLC   ELCODE,0(R2)                                                     
         BER   RE                                                               
         J     NXTEL                                                            
         LTR   RE,RE                                                            
         BR    RE                                                               
         EJECT                                                                  
         DROP  RB                                                               
         LTORG                                                                  
         SPACE 3                                                                
         EJECT                                                                  
***********************************************************************         
*                                                                               
*        SETPER - GET BILLING PERIOD FOR UNIT (IN NBACTDAT)                     
*                 RETURNS WITH FULL CONTAINING A(PERLIST ENTRY)                 
*                                                                               
***********************************************************************         
*                                                                               
SETPER   NMOD1 0,SETPER                                                         
         LA    RC,SPACEND                                                       
*                                                                               
         MVC   WORK+18(L'NBACTDAT),NBACTDAT NORMALLY JUST USE NBACTDAT          
         CLI   PROFBN+13,C'Y'      BUT IF PROFILE SAYS SO                       
         BNE   SETP10                                                           
         CLI   BRDCALSW,C'B'       AND THIS IS A BROADCAST NET                  
         BNE   SETP10                                                           
         CLI   SPOTPROF+2,2        AND PERIODS ARE CALENDAR MONTHS              
         BNE   SETP10                                                           
*                                  USE BROADCAST MONTHS INSTEAD                 
         GOTO1 DATCON,DMCB,(2,NBACTDAT),WORK                                    
         GOTO1 GETBROAD,DMCB,(1,WORK),WORK+6,GETDAY,ADDAY                       
         GOTO1 DATCON,DMCB,WORK+12,(2,WORK+18)  NOTE- END DATE WILL             
*                                       BE IN RIGHT CALENDAR MONTH              
*                                                                               
SETP10   DS    0H                  FIND PERIOD THAT CONTAINS SPOT DATE          
         LA    R1,PERLIST                                                       
         USING PERLISTD,R1                                                      
*                                                                               
SETP12   DS    0H                                                               
         CLC   WORK+18(L'PERLEND),PERLEND                                       
         BNH   *+12                                                             
         LA    R1,PERLISTL(R1)                                                  
         B     SETP12                                                           
*                                                                               
         ST    R1,FULL             RETURN A(PERLIST ENTRY) IN FULL              
*                                                                               
         L     RF,APATCH                                                        
         TM    0(RF),X'40'                                                      
         BZ    SETPX                                                            
*                                                                               
         LR    R0,R1                                                            
         DROP  R1                                                               
         MVC   P(6),WORK           BUILD HEADER NARRATION IN P                  
         MVC   P+7(12),WORK+6                                                   
         GOTO1 PRNTBL,DMCB,(20,P),(R0),C'DUMP',6,=C'1D'                         
         MVC   P,SPACES            CLEAR NARRATION                              
*                                                                               
SETPX    DS    0H                                                               
         XIT1                                                                   
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
*        FINDPKG - GET PACKAGE NAME                                             
*                                                                               
FINDPKG  NMOD1 0,FINDPKG                                                        
         LA    RC,SPACEND                                                       
*                                                                               
         MVC   WORK(L'NBACTNET),NBACTNET    NETWORK                             
         MVI   WORK+4,C'N'                                                      
         GOTO1 MSPACK,DMCB,=C'0000',WORK,DUB                                    
         XC    WORK,WORK                                                        
PKG      USING PKGTABD,WORK                                                     
         MVC   PKG.PKGEST,NBACTEST   ESTIMATE                                   
         MVC   PKG.PKGPKG,NBPACK     PACKAGE                                    
         MVC   PKG.PKGNET,DUB+2      NETWORK                                    
         DROP  PKG                                                              
*                                                                               
         LA    RE,*+10             SWITCH TO 31-BIT MODE                        
         O     RE,=X'80000000'                                                  
         BSM   0,RE                                                             
*                                                                               
         GOTO1 BINSR31,PKGPARS,WORK                                             
         TM    0(R1),X'80'         RECORD FOUND?                                
         BZ    *+6                                                              
         DC    H'0'                NO                                           
         L     RF,0(R1)                                                         
         MVC   PKGNME(16),(PKGPKGNM-PKGTABD)(RF)                                
*                                                                               
         LA    RE,*+6              SWITCH BACK TO 24-BIT MODE                   
         BSM   0,RE                                                             
*                                                                               
         XIT1                                                                   
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
*        BUILD BUYREC SORT KEYS AND PASS TO SORT                                
*                                                                               
BUYBK    NMOD1 0,BUYBK                                                          
         LA    RC,SPACEND                                                       
*                                                                               
         XC    SORTREC,SORTREC                                                  
         L     R1,ASORTDTA                                                      
         LA    RF,ROWTL(R1)                                                     
         BRAS  RE,ZAPSTR           ZAP AMOUNT FIELDS                            
         USING NETPTABD,R4                                                      
*                                                                               
         BRAS  RE,SETPER           FIND PERIOD THAT CONTAINS SPOT DATE          
         L     R1,FULL             A(PERLIST ENTRY) RETURNED IN FULL            
         MVC   THISPER,PERLMOS-PERLISTD(R1)                                     
         LA    R0,PERLIST                                                       
         SR    R1,R0                                                            
         STC   R1,PERDISP          DISPLACEMENT OF PERIOD                       
*                                                                               
         CLI   PERCTL,C'T'                                                      
         BNE   BUYBK4                                                           
*                                                                               
         CLI   BFRMOS,C'S'         IF SEPARATE BFR MOS OPTION                   
         BE    BUYBK4              SKIP THIS EFFECTIVE DATE CHECK               
*                                                                               
         LA    R2,WORK                                                          
         XC    WORK,WORK                                                        
         USING PEFFTBD,R2                                                       
****     ZIC   RF,WPRD             GET PRODUCT CODE FROM PRODUCT SEQ            
****     MHI   RF,4                                                             
****     L     R1,VCLIST                                                        
****     LA    R1,0(RF,R1)                                                      
         MVC   PEFFPRD,WPRDC       1-CHAR PRODUCT CODE                          
         GOTO1 BINSRCH,PEFFPARS,PEFFTBD                                         
         CLI   0(R1),1                                                          
         BNE   *+6                                                              
         DC    H'0'                ENTRY NOT FOUND                              
*                                                                               
         ICM   R2,15,0(R1)                                                      
*                                  IF MULTI-MONTH                               
*                                  AND CURRENT MONTH NOT LOWER THAN             
*                                  EFF. DATE, BYPASS ALL MONTHS BEFORE          
         CLC   CURPER,PEFFEFD                                                   
         BL    BUYBK4                                                           
         CLC   THISPER,PEFFEFD                                                  
         BL    BUYBK9                                                           
         DROP  R2                                                               
*                                                                               
BUYBK4   DS    0H                                                               
         LA    R3,BRKTAB                                                        
         USING BRKTABD,R3                                                       
BUYBK6   DS    0H                                                               
         ICM   RF,15,BRKCODE                                                    
         BZ    BUYBK8                                                           
         BAS   RE,BUYBRKS-4(RF)                                                 
         LA    R3,BRKL(R3)                                                      
         B     BUYBK6                                                           
*                                                                               
BUYBK8   DS    0H                                                               
         L     R2,ASORTCOM         SET DISK ADDRESS IN COMMENT                  
         USING SORTCOMD,R2                                                      
         MVC   SORTOGR2,NPTOVG2                                                 
         MVC   SORTTRDP,WTRDPCT    TRADE %                                      
         MVC   SORTSMED,NBEFFMED   PUT SUB-MEDIA IN COMMENT                     
         CP    MANGRS,=P'0'        FOR CURRNET MANUAL                           
         BE    BUYBK8A             NO DISK ADDRESS                              
         CLI   LORSW,C'Y'          FOR L'OREAL PUT IN S-MEDIA                   
         BNE   BUYBK8D                                                          
         MVC   SORTSMED,MEDFILT                                                 
         CLI   SORTSMED,C' '       ANYTHING INPUT ?                             
         BH    BUYBK8D                                                          
         MVI   SORTSMED,C'N'       BY DEFAULT - NETWORK                         
         B     BUYBK8D                                                          
*                                                                               
*        NOTE- IF ZLOPT NOT ON BILLABLE STATUS IS DETERMINED                    
*              BY ZLSW, OTHERWISE BY NETPTAB AMOUNTS. THERE IS NO               
*              REAL LOGIC TO THIS, IT IT JUST FOR SAFETY IN                     
*              INTRODUCING THE ZERO LINE FEATURE.                               
*                                                                               
BUYBK8A  CLI   ZLOPT,C'A'          IF ZLOPT ON, TEST NETPTAB AMOUNTS            
         BE    BUYBK8C                                                          
         CLC   ZLOPT,TYPE                                                       
         BE    BUYBK8C                                                          
*                                                                               
         CLI   ZLSW,C'Y'           ELSE TEST ZLSW (ACROSS COST TYPES)           
         BE    BUYBK8D                                                          
*                                                                               
BUYBK8B  DS    0H                                                               
         MVC   SORTDA,NBKEY+21     DISK ADDR                                    
         B     BUYBK8D                                                          
*                                                                               
BUYBK8C  DS    0H                                                               
         CLC   NPTOGRS(NPTOAMTS),NPTBGRS  AMTS ARE PCKD, BUT OK TO CLC          
         BNE   BUYBK8B                                                          
*                                                                               
BUYBK8D  DS    0H                                                               
         MVC   SORTIDAT,NPTIDAT    INVOICE DATE                                 
         MVC   SORTINVN,NPTINUM    AND NUMBER                                   
*                                                                               
         DROP  R2                                                               
*                                                                               
BYBK8D   L     R2,ASORTDTA                                                      
         MVC   0(NPTOAMTS,R2),NPTOGRS    ORDERED GROSS NET AND ASS              
*                                        3 PACKED FIELDS MOVED (YKVA)           
         TM    NBUNITST,X'42'      FOR MISSED/PRE-EMPT                          
         BNZ   *+10                NO 'ORDERED SPOT' COUNT                      
         ZAP   ROW$L(ACCUMLQ,R2),=P'1'      1 SPOT                              
         MVC   ROWHL(NPTBAMTS,R2),NPTBGRS   BILLED GROSS AND NET, PCKD          
         LA    RE,NPTBGRS                                                       
         LA    RF,NPTBAMTS(RE)                                                  
BUYBK8DA CP    0(ACCUMLQ,RE),=P'0' BILLED?                                      
         BNE   BUYBK8DC                                                         
         LA    RE,ACCUMLQ(RE)                                                   
         CR    RE,RF                                                            
         BL    BUYBK8DA                                                         
         B     BUYBK8F             NO                                           
BUYBK8DC ZAP   ROWHL+ROW$L(ACCUMLQ,R2),=P'1'    YES, SET 1 BILLED SPOT          
*                                                                               
         CLI   USPLTSW,C'Y'        BUT IF THIS UNIT IS A SPLIT                  
         BE    BUYBK8E             DON'T DOUBLE COUNT                           
*                                                                               
         CLI   PROFBNX+1,C'Y'      CHECK PROFILE OPTION FOR SPECIAL             
         BNE   BUYBK8F             UNIT COUNTING OF BILLED SPOTS WITH           
*                                  WITH CHANGED PRODUCT CODE                    
*                                  TEST THIS PRODUCT VS. NUPRD                  
*        L     RF,VCLIST           GET PRODUCT SEQ NO                           
*        LR    R0,RF                                                            
*        L     R6,NBAIO                                                         
*                                                                               
*        CLC   NUPRD-NURECD(,R6),3(RF)                                          
*        BE    *+12                                                             
*        LA    RF,4(RF)                                                         
*        B     *-14                                                             
*                                                                               
*        SR    RF,R0                                                            
*        SRL   RF,2                                                             
*                                                                               
*        CLM   RF,1,NPTPRD         IF THIS PRODUCT NOT =                        
         CLC   NPTPRDC,NBPR1CL3    IF THIS PRODUCT NOT =                        
         BE    BUYBK8F             CURRENT BUY PRD. (1ST ONLY IF PIGGY)         
*                                                                               
*        CLI   NUPRD2-NURECD(R6),0   IF PIGGY                                   
*        BE    BUYBK8E                                                          
*                                                                               
*        L     RF,VCLIST           CHECK IT TOO                                 
*        LR    R0,RF                                                            
*        L     R6,NBAIO                                                         
*                                                                               
*        CLC   NUPRD2-NURECD(,R6),3(RF)                                         
*        BE    *+12                                                             
*        LA    RF,4(RF)                                                         
*        B     *-14                                                             
*                                                                               
*        SR    RF,R0                                                            
*        SRL   RF,2                                                             
*                                                                               
*        CLM   RF,1,NPTPRD         IF THIS PRODUCT NOT =                        
         CLC   NPTPRDC,NBPR1CL3    IF THIS PRODUCT NOT =                        
         BE    BUYBK8F             CURRENT BUY PRD (1ST ONLY IF PIGGY)          
*                                                                               
BUYBK8E  DS    0H                                                               
         ZAP   ROW$L(ACCUMLQ,R2),=P'0'  DON'T COUNT AS A UNIT - CAN             
*                                       ONLY HAPPEN WITH BILLED SPOTS           
BUYBK8F  DS    0H                                                               
         GOTO1 =A(TOSORT)                                                       
*                                                                               
BUYBK9   DS    0H                                                               
         XIT1                                                                   
         SPACE 2                                                                
BUYBRKS  DS    0F                                                               
         B     BKPGR1                                                           
         B     BKPGR2                                                           
         B     BKPGR3                                                           
         B     BKPRD                                                            
         B     BKEST                                                            
         DC    F'0'                MGR NOT USED                                 
         DC    F'0'                MGR                                          
         DC    F'0'                MGR                                          
         DC    F'0'                MARKET                                       
         B     BKSTA                                                            
         B     BKPKG                                                            
         B     BKPGM                                                            
         B     BKDESC                                                           
         B     BKPER                                                            
         B     BKPERG                                                           
         B     BKCTYP                                                           
         B     BKDPT                                                            
*                                                                               
         SPACE 2                                                                
BKPGR1   DS    0H                                                               
         LA    R2,WPGR                                                          
         B     BKALL                                                            
         SPACE 2                                                                
BKPGR2   DS    0H                                                               
         LA    R2,WPGR                                                          
         ZIC   RF,PGR1LEN                                                       
         AR    R2,RF               POINT TO PGR2                                
         B     BKALL                                                            
         SPACE 2                                                                
BKPGR3   DS    0H                                                               
         LA    R2,WPGR                                                          
         ZIC   RF,PGR2LEN                                                       
         AR    R2,RF               POINT TO PGR3                                
         B     BKALL                                                            
         SPACE 2                                                                
BKPRD    DS    0H                  PRODUCT                                      
***      LA    R2,=X'000000'                                                    
***      MVC   0(1,R2),WPRD                                                     
         LA    R2,WPRDC                                                         
         B     BKALL                                                            
         SPACE 2                                                                
BKEST    DS    0H                  ESTIMATE                                     
         LA    R2,NBACTEST                                                      
         B     BKALL                                                            
         SPACE 2                                                                
BKPER    DS    0H                  PERIOD                                       
         LA    R2,PERDISP                                                       
         B     BKALL                                                            
         SPACE 2                                                                
BKPERG   DS    0H                                                               
         CLI   BFRMOS,C'S'         IF TRUE BILL FORM SEPARATION                 
         BE    BKPERG6             DO THINGS DIFFERENTLY                        
*                                  ELSE DIVIDE CURRENT FROM PRIOR               
         LA    R2,=C'1'            OLD MONTHS                                   
         CLC   THISPER,CURPER                                                   
         BNE   BKALL                                                            
         CLI   PRIOR,C'M'                                                       
         BNE   BKALL                                                            
         LA    R2,=C'5'                                                         
         B     BKALL                                                            
*                                                                               
BKPERG6  DS    0H                  BILL FORM SEPARATION LOGIC                   
         L     R5,=A(GETBFRW)      SPGETBFR WORK AREA                           
         USING SPGBFRD,R5                                                       
*                                                                               
         LR    R0,RE               SAVE RE                                      
         MVC   SPGBAM,BAGYMD                                                    
         MVC   SPGBCLT,BCLT                                                     
***      ZIC   RE,WPRD             ALPHA PRODUCT SEQ                            
***      MHI   RE,4                                                             
***      L     RF,VCLIST                                                        
***      LA    RF,0(RF,RE)                                                      
***      MVC   SPGBPRD,0(RF)       3-CHAR PRODUCT CODE                          
         MVC   SPGBPRD,WPRDC       3-CHAR PRODUCT CODE                          
         MVC   SPGBEST,NBACTEST                                                 
         ZIC   RE,PERDISP          PERIOD                                       
         LA    RE,PERLIST(RE)                                                   
         MVC   SPGBMOS,PERLMOS-PERLISTD(RE)                                     
         MVC   SPGBACOM,ACOMFACS                                                
         MVC   SPGBLODR,LOADER                                                  
         GOTO1 ASPGTBFR,DMCB,SPGBFRD                                            
*                                                                               
         LR    RE,R0               RESTORE RE                                   
         LA    R2,SPGBRECN         USE FOUND TSAR RECORD NUMBER                 
         B     BKALL               AS PERG                                      
*                                                                               
         DROP  R5                                                               
         SPACE 2                                                                
BKSTA    DS    0H                  STATION                                      
         LA    R2,BSTA                                                          
         B     BKALL                                                            
*                                  **SEE COMMENT AT BUYBK8**                    
*                                                                               
BKPGM    DS    0H                  PROGRAM                                      
         CP    MANGRS,=P'0'        FOR MANUAL SKIP PROGRAM                      
         BNE   BKPGM3                                                           
         CLI   ZUOPT,C'U'          IF SHOWING ZERO UNITS                        
         BE    BKPGM1              ALWAYS DO PROGRAM                            
         CLI   ZLOPT,C'A'          IF ZLOPT ON TEST NETPTAB AMOUNTS             
         BE    BKPGMD                                                           
         CLC   ZLOPT,TYPE                                                       
         BE    BKPGMD                                                           
*                                                                               
         CLI   ZLSW,C'Y'           ELSE ZLSW (COVERS ALL COST TYPES)            
         BE    BKPGM2                                                           
         B     BKPGM1                                                           
*                                                                               
BKPGMD   DS    0H                                                               
         CLC   NPTOGRS(NPTOAMTS),NPTBGRS  PCKD FIELDS                           
         BE    BKPGM2                                                           
*                                                                               
BKPGM1   DS    0H                                                               
         OC    NBPROGNM,SPACES                                                  
         LA    R2,NBPROGNM                                                      
         B     BKALL                                                            
*                                                                               
BKPGM2   DS    0H                                                               
         CLI   PROGSW,C'P'         IF IN PROG ORDER DO SET PROG                 
         BE    BKPGM1                                                           
*                                                                               
BKPGM3   DS    0H                                                               
         XC    WORK(16),WORK                                                    
         LA    R2,WORK                                                          
         B     BKALL                                                            
*                                  **SEE COMMENT AT BUYBK8**                    
*                                                                               
BKDESC   DS    0H                  DESC - DATE, LENGTH, LINE                    
         XC    WORK,WORK                                                        
         CP    MANGRS,=P'0'        SKIP FOR MANUAL                              
         BNE   BKDESC3                                                          
         CLI   ZUOPT,C'U'          IF SHOWING ZERO UNITS                        
         BE    BKDESC1B            ALWAYS BUILD DESC                            
*                                                                               
         CLI   ZLOPT,C'A'          IF ZLOPT ON TEST NETPTAB AMOUNTS             
         BE    BKDESC1                                                          
         CLC   ZLOPT,TYPE                                                       
         BE    BKDESC1                                                          
*                                                                               
         CLI   ZLSW,C'Y'           ELSE ZLSW (COVERS ALL COST TYPES)            
         BE    BKDESC2                                                          
         B     BKDESC1B                                                         
*                                                                               
BKDESC1  DS    0H                                                               
         CLC   NPTOGRS(NPTOAMTS),NPTBGRS   PCKD FIELDS (YKVA)                   
         BE    BKDESC2                                                          
*                                                                               
BKDESC1B DS    0H                                                               
         MVC   WORK(L'NBACTDAT),NBACTDAT                                        
         MVC   WORK+2(L'NPTLNSHR),NPTLNSHR  SHARE OF LENGTH                     
         MVC   WORK+3(L'NBUNITST),NBUNITST  STATUS                              
         MVC   WORK+4(L'SPTSEQ),SPTSEQ      TIE BREAKER                         
         B     BKDESC9                                                          
*                                                                               
BKDESC2  DS    0H                                                               
         MVI   WORK,X'FA'          PREVIOUS BILLED UNITS                        
         B     BKDESC9                                                          
*                                                                               
BKDESC3  DS    0H                                                               
         MVI   WORK,X'FB'          CURRENT MANUAL                               
*                                                                               
BKDESC9  DS    0H                                                               
         LA    R2,WORK                                                          
         B     BKALL                                                            
         SPACE 2                                                                
BKPKG    DS    0H                  PACKAGE                                      
         LA    R2,NBPACK           USE PACKAGE CODE                             
         CLI   PKGNMOPT,0          IF NAME OPTION OFF                           
         BE    BKALL                                                            
         LR    R0,RE               SAVE RE                                      
         BRAS  RE,FINDPKG          GET PKG NAME                                 
         LR    RE,R0                                                            
         LA    R2,PKGNME           USE NAME (OR PART OF IT)                     
         B     BKALL                                                            
         SPACE 2                                                                
BKCTYP   DS    0H                  TYPE OF CHARGE                               
         XC    WORK,WORK                                                        
         MVC   WORK(1),WTYP                                                     
         CLI   WTYP,0              IS IT TIME ?                                 
         BNE   *+14                                                             
         MVC   WORK+1(4),WFEED                                                  
         B     *+10                                                             
         MVC   WORK+1(5),WMKTSTA                                                
         LA    R2,WORK                                                          
         B     BKALL                                                            
         SPACE 2                                                                
BKDPT    DS    0H                  TYPE OF CHARGE                               
         LA    R2,NBACTDP                                                       
         B     BKALL                                                            
         SPACE 2                                                                
BKALL    DS    0H                                                               
         LA    R5,SORTKEY                                                       
         A     R5,BRKDISP                                                       
         L     RF,BRKLENM1                                                      
         EX    RF,*+6                                                           
         BR    RE                                                               
         MVC   0(0,R5),0(R2)                                                    
         SPACE 2                                                                
         DROP  R3                                                               
         DROP  R9                                                               
         DROP  RB                                                               
         SPACE 3                                                                
         LTORG                                                                  
         EJECT                                                                  
GETDPT   NTR1  BASE=*,LABEL=*                                                   
         XC    WORK,WORK                                                        
         LA    RE,DPTFILT                                                       
         CLI   DPTFILT,C' '        IF HAVE DAYPART FILTER                       
         BH    *+8                                                              
         ICM   RE,15,ADPT          OR DAYPART IS SEPARATE                       
         LA    R6,WORK                                                          
         USING NDPTHDRD,R6                                                      
         MVI   NDPTKTY,NDPTKTYQ                                                 
         MVI   NDPTKST,NDPTKSTQ                                                 
         MVC   NDPTAGM,BAGYMD                                                   
         CLI   0(RE),127           CLIENT LEVEL DPT?                            
         BH    *+10                                                             
         MVC   NDPTCLT,BCLT                                                     
         MVC   NDPTDPTE,0(RE)                                                   
         MVC   DUB,NDPTHDR         SAVE OLD KEY                                 
         GOTO1 DATAMGR,DMCB,DMRDHI,=C'UNTDIR',NDPTHDR,NDPTHDR                   
         CLC   DUB(6),NDPTHDR                                                   
         BE    *+6                                                              
         DC    H'0'                MISSING DAYPART KEY!                         
         DROP  R6                                                               
         XIT1                                                                   
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
*  ADD SUBMEDIA ELEMENTS                                                        
ADDSMEL  NTR1  BASE=*,LABEL=*                                                   
         SR    R0,R0               COUNTER FOR SUBMEDIA ELEMS                   
         USING BILLREC,R7                                                       
         LA    R5,BILPVELD         POINT TO ELEMENTS                            
         USING BILSMELD,R5                                                      
         USING PEPTD,R4                                                         
         CP    PEPTGRSN,=P'0'      ANYTHING FOR N?                              
         BNE   *+14                                                             
         CP    PEPTNETN,=P'0'                                                   
         BE    ADDSMC                                                           
         MVI   BILSMCOD,C'N'                                                    
         MVC   BILSMGRS,PEPTGRSN+2                                              
         MVC   BILSMNET,PEPTNETN+2                                              
         LA    R5,BILSMLEN(R5)                                                  
         AHI   R0,1                                                             
ADDSMC   CP    PEPTGRSC,=P'0'      ANYTHING FOR C ?                             
         BNE   *+14                                                             
         CP    PEPTNETC,=P'0'                                                   
         BE    ADDSMS                                                           
         MVI   BILSMCOD,C'C'                                                    
         MVC   BILSMGRS,PEPTGRSC+2                                              
         MVC   BILSMNET,PEPTNETC+2                                              
         LA    R5,BILSMLEN(R5)                                                  
         AHI   R0,1                                                             
ADDSMS   CP    PEPTGRSS,=P'0'      ANYTHING FOR S ?                             
         BNE   *+14                                                             
         CP    PEPTNETS,=P'0'                                                   
         BE    ADDSMO                                                           
         MVI   BILSMCOD,C'S'                                                    
         MVC   BILSMGRS,PEPTGRSS+2                                              
         MVC   BILSMNET,PEPTNETS+2                                              
         LA    R5,BILSMLEN(R5)                                                  
         AHI   R0,1                                                             
ADDSMO   CP    PEPTGRSO,=P'0'      ANYTHING FOR O ?                             
         BNE   *+14                                                             
         CP    PEPTNETO,=P'0'                                                   
         BE    ADDSMD                                                           
         MVI   BILSMCOD,C'O'                                                    
         MVC   BILSMGRS,PEPTGRSO+2                                              
         MVC   BILSMNET,PEPTNETO+2                                              
         LA    R5,BILSMLEN(R5)                                                  
         AHI   R0,1                                                             
ADDSMD   CP    PEPTGRSD,=P'0'      ANYTHING FOR D ?                             
         BNE   *+14                                                             
         CP    PEPTNETD,=P'0'                                                   
         BE    ADDSMX                                                           
         MVI   BILSMCOD,C'D'                                                    
         MVC   BILSMGRS,PEPTGRSD+2                                              
         MVC   BILSMNET,PEPTNETD+2                                              
         AHI   R0,1                                                             
ADDSMX   STC   R0,BILNMEDS         NUMBER OF ELEMENTS                           
         MHI   R0,BILSMLEN         TOTAL LENGTH OF ELEM SET                     
         SR    RF,RF                                                            
         ICM   RF,3,BLEN           CURRENT REC LEN                              
         AR    RF,R0                                                            
         STCM  RF,3,BLEN                                                        
         XIT1                                                                   
         DROP  R4,R5                                                            
         SPACE 2                                                                
         LTORG                                                                  
*********************************************************************           
*                                                                               
*  SETBRD - SET BRDCALSW TO B FOR BROADCAST OR C FOR CALENDAR                   
*                                                                               
*********************************************************************           
*                                                                               
SETBRD   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     R9,=A(NETBLK)                                                    
         USING NETBLOCK,R9                                                      
         MVI   BRDCALSW,C'B'                                                    
         CLC   NBACTNET,=C'FOX '   FOX IS BRDCAST                               
         BE    SBRDX                                                            
*                                  ELSE CHECK TABLE                             
         MVC   WORK(L'NBACTNET),NBACTNET                                        
         GOTO1 BINSRCH,NTBPARS,(1,WORK)                                         
         SR    R2,R2                                                            
         ICM   R2,7,1(R1)                                                       
         BNZ   *+6                                                              
         DC    H'0'                TABLE FULL                                   
*                                                                               
         CLI   0(R1),1             WAS NET ALREADY IN TABLE                     
         BE    *+14                                                             
         MVC   BRDCALSW,4(R2)      YES, PICK UP BRD/CAL                         
         B     SBRDX                                                            
*                                                                               
         LA    R3,KEY                                                           
         USING STAREC,R3                                                        
         MVI   STAKTYPE,C'S'                                                    
         MVI   STAKMED,C'N'                                                     
         MVC   STAKCALL,NBACTNET                                                
         MVI   STAKCALL+4,C'N'                                                  
         MVC   STAKAGY,QAGY                                                     
         MVC   STAKCLT,CLT                                                      
         MVC   STAKFILL,=C'000'                                                 
         GOTO1 READSTA                                                          
         L     R3,ADSTAT                                                        
*                                                                               
         MVI   BRDCALSW,C'B'       BROADCAST                                    
         CLC   SNTISTA,=C'PAR '    IF NTI STATION IS PAR                        
         BE    SBRD8                                                            
         CLC   SNTISTA,=C'WB  '    OR WB                                        
         BE    SBRD8                                                            
         CLC   NBACTNET,=C'FOX '   OR IF NET IS FOX                             
         BE    SBRD8                                                            
         MVI   BRDCALSW,C'C'       ELSE CALENDAR                                
*                                                                               
SBRD8    DS    0H                                                               
         MVC   4(1,R2),BRDCALSW    SET IN TABLE                                 
         DROP  R3                                                               
*                                                                               
SBRDX    DS    0H                                                               
         XIT1                                                                   
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
CKCORPES NTR1  BASE=*,LABEL=*                                                   
         L     R9,=A(NETBLK)                                                    
         USING NETBLOCK,R9                                                      
         MVC   KEY1,KEY            SAVE THE KEY, JUST IN CASE                   
         XC    KEY,KEY                                                          
KEY@     USING ESTHDRD,KEY                                                      
         L     RF,ADCLT                                                         
         MVC   KEY(4),0(RF)        MOVE A/M, CLT CODE                           
         MVC   KEY@.EKEYPRD,QCORPRD PUT IN CORP PRODUCT                         
         L     RF,NBAIO                                                         
         USING NURECD,RF                                                        
         MVC   KEY@.EKEYEST,NUKEST  PUT IN ESTIMATE FROM UNIT                   
         DROP  RF,R9                                                            
         DROP  KEY@                                                             
         GOTO1 HIGH                                                             
         MVC   KEY2(13),KEY                                                     
         MVC   KEY2SAVE(13),KEYSAVE SAVE INFO, RESORE SEQUENCE                  
*                                                                               
         MVC   KEY,KEY1                                                         
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY2(13),KEY2SAVE                                                
         XIT1                                                                   
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
*********************************************************************           
*  THE SUB WILL GO THROUGH INVTAB ENTRIES AND TRY TO CALC ACTUAL                
*  AMOUNT FOR EACH ENTRY BY READING CORRESPONDING BILLHEADERS .                 
*********************************************************************           
CALCACT  NTR1  BASE=*,LABEL=*                                                   
         L     R6,INVTABN          FOR BCT                                      
         LTR   R6,R6                                                            
         BNP   CALCAX                                                           
         LA    RE,*+10                                                          
         O     RE,=X'80000000'                                                  
         BSM   0,RE                SWITCH TO 31 BIT MODE                        
*                                                                               
         L     R4,AINVTAB          START OF TABLE                               
         MVC   WORD,AINVTAB        TEMP FOR CURRENT ENTRY ADDRESS               
         MVC   WK(INVTABRL),0(R4)  GET 1 ENTRY IN TEMP STORAGE                  
         LA    RE,*+6                                                           
         BSM   0,RE                SWITCH BACK TO 24-BIT                        
*                                                                               
         LA    R4,WK                                                            
         USING INVLD,R4                                                         
*                                                                               
*                                                                               
CALCA5   ZAP   X(L'BACTP),=P'0'    CLEAR ACCUMULATOR FOR ACT                    
         MVI   X+L'BACTP,C'N'      FLAG TO INDICATE DERIVED ACTUAL              
         ZIC   R0,INVLYR           TRICK TO PUT Y/M IN ONE BYTE:                
         CVD   R0,DOUBLE           DOUBLE+7 HAS ACTUAL YEAR AND SIGN            
         NI    DOUBLE+7,X'F0'      CLEAR THE SIGN NIBBLE                        
         OC    DOUBLE+7(1),INVLMO  NOW PUT IN MONTH IN LOW NIBBLE               
         XC    KEY,KEY                                                          
BK@      USING BILLREC,KEY                                                      
         MVC   BK@.BKEYAM,BAGYMD                                                
         MVC   BK@.BKEYCLT,BCLT                                                 
         OC    INVLPRD,INVLPRD                                                  
         BZ    CALCA10             ALL PRODUCTS ? YES, START FILTERING          
*                                                                               
*        L     RF,VCLIST           FIND PRODUCT CODE                            
*        CLC   INVLPRD,3(RF)                                                    
*        BE    *+18                                                             
*        LA    RF,4(RF)                                                         
*        CLI   0(RF),0                                                          
*        BNE   *-18                                                             
*        DC    H'0'                                                             
         MVC   BK@.BKEYPRD,INVLPRD    SINGLE PRODUCT                            
*                                                                               
         OC    INVLEST,INVLEST                                                  
         BZ    CALCA10                                                          
         MVC   BK@.BKEYEST,INVLEST HAVE ESTIMATE                                
*                                                                               
         OC    INVLPER,INVLPER     DO WE HAVE MONTH OF SERV                     
         BZ    CALCA10                                                          
         MVC   BK@.BKEYYSRV(2),INVLPER                                          
*                                                                               
         MVC   BK@.BKEYMBIL,DOUBLE+7   PUT IN YEAR/MONTH                        
         MVC   BK@.BKEYINV,INVLINV     DONE BUILDING THE KEY                    
         MVI   HALF,X'FF'          FLAG THAT BUILT WHOLE REC                    
*                                                                               
CALCA10  GOTO1 HIGH                                                             
         CLI   HALF,X'FF'                                                       
         BNE   CALCA30             NEED TO FILTER                               
         MVI   HALF,0              CLEAR                                        
         CLC   KEY(13),KEYSAVE     WHOLE KEY HAS TO MATCH                       
         BE    CALCA50                                                          
         DC    H'0'                OR I'M MISSING SOMETHING                     
*                                                                               
CALCA20  GOTO1 SEQ                                                              
*                                                                               
CALCA30  DS    0H                                                               
         CLC   KEY(4),KEYSAVE      COMPARE UP TO CLIENT                         
         BNE   CALCA100            NO MATCH, DONE WITH THIS ENTRY               
         OC    INVLPRD,INVLPRD     DO WE HAVE PRODUCT?                          
         BZ    CALCA35                                                          
*        L     RF,VCLIST           FIND PRODUCT CODE                            
*        CLC   INVLPRD,3(RF)                                                    
*        BE    *+18                                                             
*        LA    RF,4(RF)                                                         
*        CLI   0(RF),0                                                          
*        BNE   *-18                                                             
*        DC    H'0'                                                             
*                                                                               
         CLC   BK@.BKEYPRD,INVLPRD   HAVE PRODUCT, DOES IT MATCH?               
         BNE   CALCA100            NO, DONE                                     
CALCA35  OC    INVLEST,INVLEST     DID WE PUT IN EST?                           
         BZ    *+14                                                             
         CLC   BK@.BKEYEST,INVLEST IF YES, DOES IT MATCH                        
         BNE   CALCA20             NO, GET NXT REC                              
         OC    INVLPER,INVLPER     DID WE PUT MOS?                              
         BZ    *+18                                                             
         CLC   INVLPER,BK@.BKEYYSRV                                             
         BNE   CALCA20                                                          
         B     CALCA40                                                          
*                                                                               
         L     RF,=A(MOSLIST)      CHECK IF RIGHT MOS                           
CALCA37  CLI   0(RF),X'FF'                                                      
         BE    CALCA20             NO MATCH, NEXT REC                           
         CLC   0(2,RF),BK@.BKEYYSRV                                             
         BE    CALCA40                                                          
         LA    RF,2(RF)            TRY NXT ENTRY                                
         B     CALCA37                                                          
*                                                                               
CALCA40  CLC   BK@.BKEYMBIL,DOUBLE+7                                            
         BNE   CALCA20                                                          
         CLC   BK@.BKEYINV,INVLINV                                              
         BNE   CALCA20                                                          
         DROP  BK@                                                              
*                                                                               
CALCA50  DS    0H                   IF GOT HERE, GOT THE RIGHT KEY !!!          
         GOTO1 GETBILL                                                          
         L     R7,ADBILL                                                        
         USING BILLREC,R7                                                       
         OC    ASTABRK,ASTABRK                                                  
         BZ    CALCA52                                                          
         CLC   ASTABRK,AINVBRK     STATION SEPARATE ?                           
         BH    CALCA52                                                          
         CLC   BLSTATN,=CL5' '     IF ORIG BILL HAD ALL STATIONS                
         BNH   CALCA52             DON'T TRY TO MATCH IT                        
         XC    WMKTSTA,WMKTSTA                                                  
         LA    R5,WMKTSTA                                                       
         MVC   WMKTSTA+2(L'INVLSTA),INVLSTA                                     
         GOTO1 MSUNPK,DMCB,(R5),DUB,MYPACKED                                    
         CLC   BLSTATN(4),MYPACKED LAST BYTE OF BLSTATN WILL BE 0, BUT          
         BNE   CALCA20             MYPACKED WILL HAVE MEDIA CODE, SO            
*                                  MATCH ONLY 4 OUT OF 5 BYTES                  
CALCA52  CLI   MEDFILT,C' '        BILL BY SUBMEDIA?                            
         BNH   *+22                                                             
         CLI   BLMED,C' '          IF ORIG BILL HAD ALL SUB-MEDIA               
         BNH   *+14                DON'T TRY TO MATCH IT                        
         CLC   BLMED,MEDFILT                                                    
         BNE   CALCA20                                                          
*                                                                               
         OC    ADPTBRK,ADPTBRK                                                  
         BZ    CALCA54                                                          
         CLC   ADPTBRK,AINVBRK     SEP BY DAYPART ?                             
         BH    CALCA54                                                          
         CLI   BLDPT,C' '          IF ORIG BILL HAD ALL DAYPARTS                
         BNH   *+14                DON'T TRY TO MATCH IT                        
         CLC   BLDPT,INVLDPT       YES, HAS TO MATCH                            
         BNE   CALCA20             OTHERWISE GET NXT REC                        
*                                                                               
CALCA54  OC    APKGBRK,APKGBRK     SEP BY PKG?                                  
         BZ    CALCA56                                                          
         CLC   APKGBRK,APKGBRK                                                  
         BH    CALCA56                                                          
         CLC   BLPKGNM,=CL5' '     IF ORIG BILL HAD ALL PACKAGES                
         BNH   *+14                DON'T TRY TO MATCH IT                        
         CLC   BLPKGNM,INVLPKG                                                  
         BNE   CALCA20                                                          
*                                                                               
CALCA56  CLI   CTYPCTL,C'S'        TYPES SEPARATE?                              
         BNE   CALCA58                                                          
         CLI   BILCTYP,C' '        IF ORIG BILL HAD ALL CTYPES                  
         BNH   CALCA58             DON'T TRY TO MATCH IT                        
         L     R5,=A(CTYPLST)      GET INTERNAL TYPE CODE                       
         USING CTYLD,R5                                                         
CALCA57  CLC   CTYLDISP,INVLTYP    FIND ENTRY FOR INTEGRATION                   
         BE    *+18                                                             
         LA    R5,CTYLSTL(R5)                                                   
         CLI   0(R5),X'FF'                                                      
         BNE   CALCA57                                                          
         DC    H'0'                COST TYPE NOT DEFINED                        
*                                                                               
         CLC   CTYLCOD,BILCTYP     BILL FOR RIGHT TYPE?                         
         BNE   CALCA20                                                          
         DROP  R5                                                               
*                                                                               
CALCA58  CLI   SCBNCSW,C'C'         DOING COMMISSION BILLING?                   
         BNE   *+16                                                             
         TM    BILSTAT,BSTSCOMQ    YES, ONLY COMM BILLS                         
         BZ    CALCA20                                                          
         B     *+12                                                             
*                                                                               
         TM    BILSTAT,BSTSCOMQ    ELSE SKIP COMMISSION BILL                    
         BNZ   CALCA20                                                          
*                                                                               
         DS    0H                  ADD IN ACTUAL                                
         CLI   COST2SW,C'Y'        IS IT COS2?                                  
         BNE   *+18                                                             
         AP    X(L'BACTP),BACT2P   ADD IN COS2 ACTUAL                           
         MVI   X+L'BACTP,C'Y'      FLAG -> DERIVED ACTUAL                       
         B     CALCA20             GET NXT BILL HEADER                          
*                                                                               
         AP    X(L'BACTP),BACTP    ADD IN ACTUAL                                
         MVI   X+L'BACTP,C'Y'      FLAG -> DERIVED ACTUAL                       
         B     CALCA20             GET NXT BILL HEADER                          
*                                                                               
CALCA100 DS    0H                                                               
         CLI   X+L'BACTP,C'Y'      DID WE GET ACTUAL?                           
         BE    *+6                                                              
         DC    H'0'                SMTH WRONG                                   
*                                                                               
         ZAP   INVLACT,X(L'BACTP)                                               
*                                                                               
CALCA110 DS    0H                                                               
         LA    RE,*+10                                                          
         O     RE,=X'80000000'                                                  
         BSM   0,RE                SWITCH TO 31 BIT MODE                        
*                                                                               
         L     R4,WORD             POINT TO ENTRY                               
         MVC   0(INVTABRL,R4),WK   MOVE MODIFIED ENTRY BACK                     
         LHI   R4,INVTABRL                                                      
         A     R4,WORD                                                          
         ST    R4,WORD             BUMP TO NEXT ENTRY                           
         MVC   WK(INVTABRL),0(R4)  NXT  ENTRY                                   
         LA    RE,*+6              BACK TO 24                                   
         BSM   0,RE                                                             
                                                                                
         LA    R4,WK                                                            
         BCT   R6,CALCA5                                                        
*                                                                               
*                                                                               
CALCAX   XIT1                                                                   
         DROP  R4,R7                                                            
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
PROC10EL NTR1  BASE=*,LABEL=*                                                   
         USING NETBLOCK,R9                                                      
         LA    R2,WK               A(RETURNED X'10' ELEM)                       
         USING NBILD,R2                                                         
         L     R3,=A(XTRWK)        RETURENED BY NEUBILLRDR                      
         USING NBLBILLD,R3                                                      
         USING NETPTABD,R4                                                      
*                                                                               
         TM    NBILST,NBILUBQ      SKIP IF UNBILLED                             
         BNZ   PROC10X                                                          
*                                                                               
         CLI   NBILCHGT,C'T'       FOR TIME BILLING                             
         BNE   PROC10C                                                          
*                                                                               
         CLI   PROFBN+3,C'D'       DOING ACT MINUS ASS PLUS INT?                
         BE    *+12                                                             
         CLI   PROFBN+3,C'E'       DOING AMA (ACTUAL MINUS ASSIGNED)?           
         BNE   *+16                                                             
         TM    NBILST,NBILAMQ      SKIP IF NOT AMA ELEMENT                      
         BZ    PROC10X                                                          
         B     PROC10C                                                          
*                                                                               
*                                  NOT DOING AMA                                
         TM    NBILST,NBILAMQ      SKIP IF AMA ELEMENT                          
         BNZ   PROC10X                                                          
*                                                                               
PROC10C  DS    0H                                                               
         CLI   SCBNCSW,C'C'        SEPARATE COMMISSION BILLING?                 
         BNE   *+16                                                             
         TM    NBILST,NBILSCQ      ELEMENT MUST BE AS WELL                      
         BZ    PROC10X                                                          
         B     PROC10E                                                          
*                                                                               
         CLI   SCBNCSW,C'N'        NET BILLING?                                 
         BNE   *+16                                                             
         TM    NBILST,NBILSNQ      ELEMENT MUST BE AS WELL                      
         BZ    PROC10X                                                          
         B     PROC10E                                                          
*                                                                               
         TM    NBILST,NBILSCQ+NBILSNQ   ELSE ELEMENT MUST BE NEITHER            
         BNZ   PROC10X                  SEPARATE COMM. OR NET ONLY              
*                                                                               
PROC10E  DS    0H                                                               
         OC    IGNDATE,IGNDATE     'IGNORE' DATE?                               
         BZ    *+14                                                             
         CLC   NBLRUNDT,IGNDATE    YES, DROP PREVIOUS ON OR AFTER               
         BNL   PROC10X                                                          
*                                                                               
         MVC   WPRD,NBILPRD                                                     
         OC    NBILPRDC,NBILPRDC   IS THERE CHARACTER PRODUCT?                  
         BZ    *+14                                                             
         MVC   WPRDC,NBILPRDC                                                   
         B     PROC10F                                                          
*                                                                               
         L     RF,VCLIST                                                        
         CLC   WPRD,3(RF)                                                       
         BE    *+12                                                             
         LA    RF,4(RF)                                                         
         B     *-14                                                             
*                                                                               
         MVC   WPRDC,0(RF)                                                      
PROC10F  BRAS  RE,CKPRD                                                         
         BNE   PROC10X                                                          
*                                                                               
         L     R5,=A(CTYPLST)      GET INTERNAL TYPE CODE                       
         USING CTYLD,R5                                                         
PROC10G  CLC   NBILCHGT,CTYLCOD                                                 
         BE    *+18                                                             
         LA    R5,CTYLSTL(R5)                                                   
         CLI   0(R5),X'FF'                                                      
         BNE   PROC10G                                                          
         DC    H'0'                                                             
         DROP  R5                                                               
*                                                                               
*                                  TEST AGAINST REQUEST COST TYPES              
         BRAS  RE,CKTYPE                                                        
         BNE   PROC10X             TYPE NOT OK                                  
*                                                                               
         OC    MANRVDTP,MANRVDTP   REVERSAL?                                    
         BZ    PROC10I                                                          
         CLC   NBLRUNDT,MANRVDTP   TEST ELEMENT FOR REVERSAL DATE               
         BNE   PROC10X             NO-SKIP                                      
         LH    R0,NBILNUM                                                       
         CH    R0,MANRVNO          RIGHT INVOICE NUMBER?                        
         BNE   PROC10X             NO-SKIP                                      
*                                                                               
PROC10I  DS    0H                                                               
         TM    NBILST,NBILRDQ+NBILRLQ                                           
         BNZ   *+12                IF NEITHER REVERSED NOR REVERSAL,            
         OI    BYTE2,X'01'          THEN SET: RECORD HAS BILL ELEMENT           
         B     PROC10K                                                          
*                                                                               
         TM    NBILST,NBILRDQ      ELSE LEAVE BYTE2 NON-NULL                    
         BZ    *+8                 IF REVERSED AND REVERSALS                    
         OI    BYTE2,X'80'         DON'T CANCEL EACH OTHER OUT                  
         TM    NBILST,NBILRLQ                                                   
         BZ    *+8                                                              
         XI    BYTE2,X'80'         FLIP STATUS BIT                              
*                                                                               
PROC10K  DS    0H                                                               
         XC    WFEED,WFEED                                                      
         XC    WMKTSTA,WMKTSTA                                                  
         CLI   NBILCHGC,0          IS IT TIME ELEM ?                            
         BNE   *+14                                                             
         MVC   WFEED,NBILFEED      YES,GET FEED CODE                            
         B     *+10                AND THERE'S NO MKT/STA                       
         MVC   WMKTSTA,NBILMKST    LOCKAL MKT/STA OR NULLS                      
         BRAS  RE,FNDPRD           GET PRODUCT/TYPE ENTRY                       
         L     R4,WORD             A(ENTRY) RETURNED IN FIELD 'WORD'            
*                                                                               
         CLI   SPLITOPT,C'N'       FOR PRODUCT SPLITS (TEST PROBABLY            
         BE    *+16                NOT NECESSARY, BUT HERE FOR                  
*                                  SAFETY TO ISOLATE CHANGE)                    
         MVC   NPTLNSHR,NBLEN      SET "SHARE" (UNIT LENGTH) IN TABLE           
         MVC   LENSHR,NBLEN        ANOTHER SAFETY FEATURE ???                   
*                                                                               
         ICM   R0,15,NBILGRS                                                    
         CVD   R0,DUB                                                           
         AP    NPTBGRS,DUB         ADD GROSS                                    
         ICM   R0,15,NBILNET                                                    
         CVD   R0,DUB                                                           
         AP    NPTBNET,DUB         ADD NET                                      
*                                                                               
         ICM   R0,15,NBILGR2                                                    
         BZ    *+14                                                             
         CVD   R0,DUB                                                           
         AP    NPTBGR2,DUB         SO ADD IT IN                                 
*                                                                               
         GOTO1 DATCON,DMCB,(2,NBLRUNDT),(3,SVINVD)                              
         MVC   NPTIDAT,SVINVD      SAVE LTST INVOICE DATE (+1=MONTH)            
         MVC   NPTINUM,NBILNUM     AND NUMBER                                   
*                                                                               
*                                  INVOICE LIST POSTING                         
*                                  --------------------                         
*                                                                               
         CLI   LSTOPT,C'N'         DOING INVOICE LIST?                          
         BE    PROC10X                                                          
         CLI   SHOWREV,C'Y'        KEEP REVERSALS ?                             
         BE    *+12                                                             
         TM    NBILST,NBILRDQ+NBILRLQ  SKIP REVERSED AND REVERSALS              
         BNZ   PROC10X                                                          
*                                  SAVE INVOICE FOR LISTING                     
         XC    X,X                                                              
         LA    R6,X                                                             
         USING INVLD,R6                                                         
*                                                                               
         MVC   INVLYRMO,SVINVD     INVOICE YEAR/MONTH                           
         MVC   INVLINV,NBILNUM     INVOICE NUM                                  
*                                                                               
         OC    APGR1BRK,APGR1BRK                                                
         BZ    PROC10M                                                          
         CLC   APGR1BRK,AINVBRK                                                 
         BH    PROC10M                                                          
         MVC   INVLPGR,SAVPGR       PGR                                         
         B     PROC10N                                                          
*                                                                               
PROC10M  DS    0H                                                               
         CLC   APRDBRK,AINVBRK                                                  
         BH    PROC10O                                                          
PROC10N  DS    0H                                                               
*        L     RF,VCLIST                                                        
*        CLC   NBILPRD,3(RF)                                                    
*        BE    *+12                                                             
*        LA    RF,4(RF)                                                         
*        B     *-14                                                             
*        MVC   INVLPRD,0(RF)       PRODUCT                                      
         MVC   INVLPRD,WPRDC       PRODUCT                                      
*                                                                               
PROC10O  CLC   AESTBRK,AINVBRK                                                  
         BH    *+10                                                             
         MVC   INVLEST,NBACTEST    ESTIMATE                                     
*                                                                               
         OC    ADPTBRK,ADPTBRK     DAYPART                                      
         BZ    *+20                                                             
         CLC   ADPTBRK,AINVBRK                                                  
         BH    *+10                                                             
         MVC   INVLDPT,NBACTDP                                                  
*                                                                               
         OC    ASTABRK,ASTABRK                                                  
         BZ    *+20                                                             
         CLC   ASTABRK,AINVBRK                                                  
         BH    *+10                                                             
         MVC   INVLSTA,BSTA        NETWORK                                      
*                                                                               
         OC    APKGBRK,APKGBRK                                                  
         BZ    PROC10P                                                          
         CLC   APKGBRK,AINVBRK                                                  
         BH    PROC10P                                                          
         MVC   INVLPKG,NBPACK      PACKAGE                                      
         CLI   PKGNMOPT,0          PKG NAME OPTION?                             
         BE    PROC10P                                                          
         BRAS  RE,FINDPKG          GET PKG NAME                                 
         ZIC   RF,PKGNMOPT         MOVE UP TO 5 CHARACTERS                      
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   INVLPKG(0),PKGNME                                                
*                                                                               
PROC10P  DS    0H                                                               
         CLI   CTYPCTL,C'S'                                                     
         BNE   *+10                                                             
         MVC   INVLTYP,WTYP        CHARGE TYPE                                  
*                                                                               
         BRAS  RE,SETPER           FIND PERIOD THAT CONTAINS SPOT DATE          
         L     R1,FULL             A(PERLIST ENTRY) RETURNED IN FULL            
         MVC   HALF,NBILMOS        IF THIS IS COVERTED UBILL REC                
         TM    NBLFUNC2,NBLCNVRT   MOS IS NOT CORRECT DUE TO BUG                
         BZ    *+10                WILL DERIVE MOS FROM PROFILES                
         MVC   HALF,PERLMOS-PERLISTD(R1)  OTHERWISE USE MOS FROM X'10'          
*                                                                               
         CLC   APERBRK,AINVBRK                                                  
         BH    *+10                                                             
         MVC   INVLPER,HALF                                                     
******** MVC   INVLPER,PERLMOS-PERLISTD(R1)                                     
******** MVC   INVLPER,NBILMOS     UBILL RECS HAVE MOS                          
*                                                                               
         L     RF,=A(MOSLIST)      BUILD TABLE OF USED MOS'ES                   
PROC10Q  CLI   0(RF),X'FF'         ANYTHING IN MOS TABLE?                       
         BE    PROC10Q2            NO, PUT IN MOS                               
         CLC   HALF,0(RF)                                                       
         BE    PROC10R                                                          
         LA    RF,2(RF)            EXAMINE NXT MOS                              
         B     PROC10Q                                                          
PROC10Q2 MVC   0(2,RF),HALF                                                     
         MVI   2(RF),X'FF'                                                      
*                                                                               
PROC10R  L     RE,NBILGRS                                                       
         CVD   RE,INVLGRS          GROSS                                        
         L     RE,NBILNET                                                       
         CVD   RE,INVLNET          NET                                          
         CLI   COST2SW,C'Y'        FOR COST2 MODE                               
         BNE   *+16                                                             
         ICM   RE,15,NBILGR2                                                    
         BZ    *+8                                                              
         CVD   RE,INVLGRS          OVERRIDE GROSS (NET IS UNCHANGED)            
*                                                                               
         LA    RE,*+10             SWITCH TO 31 BIT MODE                        
         O     RE,=X'80000000'                                                  
         BSM   0,RE                                                             
*                                                                               
         MVI   INVTABL,1           INSERT IF NOT FOUND                          
*                                                                               
         GOTO1 BINSR31,INVPARS,X                                                
         OC    1(3,R1),1(R1)                                                    
         BNZ   *+6                                                              
         DC    H'0'                TABLE FULL: MUST INCREASE INVTBN             
*                                                                               
         TM    0(R1),X'80'         ALREADY THERE                                
         BO    PROC10S             NO - NEXT ELEMENT                            
*                                                                               
         L     R1,0(R1)            ADD INTO EXISTING ELEMENT                    
INVTBD   USING INVLD,R1                                                         
         AP    INVTBD.INVLGRS,INVLGRS                                           
         AP    INVTBD.INVLNET,INVLNET                                           
PROC10S  LA    RE,*+6              SWITCH BACK                                  
         BSM   0,RE                                                             
*                                                                               
         DROP  INVTBD                                                           
         DROP  R6                                                               
         DROP  R2,R3,R4,R9                                                      
*                                                                               
*                                                                               
PROC10X  J     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
         DS    0D                                                               
XTRWK    DS    XL(NCTYPS*ROWHL)    HOLDS PL8 ACCUMULATORS                       
NMTABLE  DS    XL4000              NET/MEDIA TABLE FOR NETIO (800X5)            
NETIOIO  DS    XL4000              IO AREA FOR NETIO                            
*                                                                               
NETTBL   DS    XL(MAXNETS*NETTBLN) NETWORK TABLE                                
MAXNETS  EQU   100                                                              
NETTBLN  EQU   5                   NET(4),BRD VS. CAL(1)                        
         SPACE 2                                                                
         DS    0D                                                               
         DC    CL8'*WKRBUF*'                                                    
WRKRBUFF DS    14336X                                                           
WRKRBEND EQU   *                                                                
         TITLE 'TABLES'                                                         
         DS    0D                                                               
         DC    CL8'*STABUCK'                                                    
STABUCKC DS    4000C                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*LEVTOTS'                                                    
LEVTOTS  DS    0D                                                               
         ORG   *+TOTSIZE*MAXLEVS                                                
*                                  THIS AREA IS FOR HOLDING                     
*                                  MONTHLY ORDERED AND BILLED FOR               
*                                  AS MANY LEVELS AS NECESSARY                  
         DC    X'00'                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*SPLTAB*'                                                    
SPLTAB   DS    0D                                                               
         ORG   SPLTAB+(SPLTABRL*SPLTPMAX)                                       
         DC    X'00'                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*NETBLK*'                                                    
NETBLK   DS    0D                  AREA FOR NETIO WORK                          
         ORG   *+2000                                                           
         DC    X'00'                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*NETPTB*'                                                    
NETPTB   DS    0D                  NETWORK PRODUCT/TYPE TABLE                   
         ORG   *+200*NETPTBL       200 ENTRIES                                  
         DC    X'00'                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*CTYPTAB'                                                    
CTYPTAB  DS    0D                  CHARGE TYPE TABLE W/ LOCAL STA $$            
         ORG   *+(CTYPTMAX*CTYPTBL)                                             
         DC    X'00'                                                            
CTYPTMAX EQU   50                  50 ENTRIES (FOR NOW *YKVA)                   
         EJECT                                                                  
CTYPLST  DS    0D                  DSECT IS CTYLD                               
*                                                                               
* NOTE: THERE IS HARD CODE IN THIS PROGRAM WHICH CHECKS THE CTYLDISP            
*       FIELD. THEREFORE, THESE NUMBERS CANNOT BE REASSIGNED.                   
*                                                                               
         DC    C'TTT',AL1(TIMEQ),X'C0'                                          
         DC    CL20'TIME',CL9'TIME'                                             
         DC    C'III',AL1(INTEGQ),X'C0'                                         
         DC    CL20'INTEGRATION',CL9'INTEGRATN'                                 
         DC    C'UUU',AL1(CUTINQ),X'00'                                         
         DC    CL20'CUT-IN',CL9'CUT-IN'                                         
         DC    C'BBL',AL1(BLCKOUTQ),X'00'                                       
         DC    CL20'BLACKOUT',CL9'BLACKOUT'                                     
         DC    C'SSP',AL1(CPYSPLTQ),X'00'                                       
         DC    CL20'COPY SPLIT',CL9'CPY SPLIT'                                  
         DC    C'XXX',AL1(TAXQ),X'00'                                           
         DC    CL20'TAX',CL9'TAX'                                               
         DC    C'EES',AL1(SECTIONQ),X'00'                                       
         DC    CL20'SECTIONAL',CL9'SECTIONAL'                                   
         DC    C'AAA',AL1(ADMINQ),X'00'                                         
         DC    CL20'ADMINISTRATION',CL9'ADMIN'                                  
         DC    C'LLH',AL1(LATECHGQ),X'00'                                       
         DC    CL20'LATE CHARGES',CL9'LATE CHRG'                                
         DC    C'OOO',AL1(OTHERQ),X'00'                                         
         DC    CL20'OTHER',CL9'OTHER'                                           
         DC    C'DDD',AL1(DELADJQ),X'00'                                        
         DC    CL20'DELIVERY ADJUSTMENT',CL9'DELIV ADJ'                         
         DC    C'QQQ',AL1(EARNEDQ),X'00'                                        
         DC    CL20'EARNED COST ADJSTMNT',CL9'ECADJ'                            
NCTYPS   EQU   (*-CTYPLST)/CTYLSTL                                              
         DC    X'FF'                                                            
         SPACE 3                                                                
TIMEQ    EQU   0                                                                
INTEGQ   EQU   1                                                                
CUTINQ   EQU   2                                                                
BLCKOUTQ EQU   3                                                                
CPYSPLTQ EQU   4                                                                
TAXQ     EQU   5                                                                
SECTIONQ EQU   6                                                                
ADMINQ   EQU   7                                                                
LATECHGQ EQU   8                                                                
OTHERQ   EQU   9                                                                
DELADJQ  EQU   10                                                               
EARNEDQ  EQU   11                                                               
*                                                                               
SMEDTAB  DS    0CL2                TABLE OF SUBMED AND DISPL IN PEPTAB          
         DC    C'N',X'0'                                                        
         DC    C'C',X'1'                                                        
         DC    C'S',X'2'                                                        
         DC    C'O',X'3'                                                        
         DC    C'D',X'4'                                                        
         DC    X'FF'                                                            
         EJECT                                                                  
         DS    0D                                                               
         DC    C'*LINTAB*'                                                      
LINTAB   DS    (LINTABN)CL132                                                   
LINTABX  DC    X'00'                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*BHOLDTA'                                                    
BHOLDTAB DS    (BHOLDTRL*BHLTBN)X                                               
BHOLDTBL EQU   *-BHOLDTAB                                                       
*                                                                               
XSPIO    DS    4000X               XSPFIL RECORD I/O AREA                       
*                                                                               
         DS    0D                                                               
         DC    C'AAAELIST'                                                      
AAAELIST DS    CL(AAAELSTL*AAAESTMX)  AAA ESTIMATE LIST                         
AAAELSTX DC    X'00'                                                            
AAAESTMX EQU   100                 MAXIMUM NUMBER OF ESTIMATES                  
*                                                                               
         DS    0D                                                               
         DC    C'*INVLIST'                                                      
INVLIST  DS    CL(INVLISTL*NCTYPS)  PREV. INV. LIST FOR EACH COST TYPE          
         DC    X'00'                                                            
*                                                                               
         DS    0D                                                               
         DC    C'*PEFFTAB'                                                      
PEFFTAB  DS    CL(PEFFTLN*PEFFMAX) LIST OF PRODUCTS BY EFFECTIVE DATES          
         DC    X'00'                                                            
*                                                                               
         DS    0D                                                               
         DC    C'*TRADETB'                                                      
TRADETB  DS    CL(TRDTABRL*TRADEMAX)                                            
         DC    X'00'                                                            
TRADEMAX EQU   100                                                              
*                                                                               
CLTTAB   DS    0D                  CLIENT LIST FOR OFFICE CHECK                 
         ORG   *+(CLTBMAX*3)                                                    
         DC    X'00'                                                            
CLTBMAX  EQU   4000                MAXIMUM NUMBER OF CLIENTS                    
*                                                                               
         DS    0D                                                               
         DC    C'*MOSLIST'                                                      
MOSLIST  DS    (MAXMOS)XL2         USED IN CALCACT TO DETERMINE                 
         DC    X'00'               WHICH MOS'S TO KEEP                          
*                                                                               
GETBFRW  DS    0D                  WORK AREA FOR BILL FORMULA                   
         ORG   *+(SPGBFRDL)        RECORD MODULE - SPGETBFR                     
         DC    X'00'                                                            
*                                                                               
*                                  BUFFALO CSECT                                
         SPACE 2                                                                
         PRINT GEN                                                              
         BUFF  LINES=00010,ROWS=1,COLUMNS=8,COMMENT=1,FLAVOR=PACKED,   +        
               KEYLIST=(1,A)                                                    
         PRINT NOGEN                                                            
*                                                                               
         DC    50X'00'                                                          
         SPACE 3                                                                
SPBU02   CSECT                                                                  
         TITLE 'GENERAL STORAGE AREAS'                                          
BILWRKD  DSECT                                                                  
*                                                                               
ABUFFC   DS    A                                                                
APATCH   DS    A                                                                
ABILLEDI DS    A                                                                
ATSAROFF DS    V                                                                
ASPGTBFR DS    V                                                                
BINSR31  DS    V                                                                
         SPACE 2                                                                
* THESE ADCONS POINT TO THEIR RESPECTIVE ROWS WITHIN BRKTAB                     
*                                                                               
ABRKS    DS    0F                                                               
APGR1BRK DS    A                                                                
APGR2BRK DS    A                                                                
APGR3BRK DS    A                                                                
APRDBRK  DS    A                                                                
AESTBRK  DS    A                                                                
AMGR1BRK DS    A                                                                
AMGR2BRK DS    A                                                                
AMGR3BRK DS    A                                                                
AMKTBRK  DS    A                                                                
ASTABRK  DS    A                                                                
APKGBRK  DS    A                                                                
APGMBRK  DS    A                                                                
ADESCBRK DS    A                                                                
APERBRK  DS    A                                                                
APERGBRK DS    A                                                                
ACTYPBRK DS    A                                                                
ADPTBRK  DS    A                                                                
*                                                                               
ABRKS2   DS    0F                                                               
APAGBRK  DS    A         PAGE BREAK LEVEL                                       
ARECAP   DS    A         RECAP (DETAIL BACK-UP) BREAK LEVEL                     
AINVBRK  DS    A         INVOICE BREAK LEVEL                                    
APMSELO  DS    A         LOWEST OF PRODUCT/MARKET/STATION/ESTIMATE              
APEPLO   DS    A         LOWEST OF PRODUCT/ESTIMATE/PER                         
APEPHI   DS    A         HIGHEST OF PRODUCT/ESTIMATE/PER                        
ALOWBRK  DS    A         LOWEST BREAK LEVEL                                     
ALOWTOG  DS    A         LOWEST OF ALL 'TOGETHERS'                              
AHITOG   DS    A         HIGHEST OF ALL 'TOGETHERS'                             
ATHISBRK DS    A         CURRENT BREAK LEVEL                                    
SVPAGBRK DS    A                                                                
SVLOWTOG DS    A                                                                
ABRKSL   EQU   *-ABRKS                                                          
         SPACE 2                                                                
* THESE ADCONS POINT TO THEIR RESPECTIVE ROWS WITHIN LEVTOTS                    
*                                                                               
ATOTS    DS    18A                                                              
         ORG   ATOTS                                                            
ACLTTOT  DS    A                                                                
APGR1TOT DS    A                                                                
APGR2TOT DS    A                                                                
APGR3TOT DS    A                                                                
APRDTOT  DS    A                                                                
AESTTOT  DS    A                                                                
AMGR1TOT DS    A                                                                
AMGR2TOT DS    A                                                                
AMGR3TOT DS    A                                                                
AMKTTOT  DS    A                                                                
ASTATOT  DS    A                                                                
APKGTOT  DS    A                                                                
APGMTOT  DS    A                                                                
ADESCTOT DS    A                                                                
APERTOT  DS    A                                                                
APERGTOT DS    A                                                                
ACTYPTOT DS    A                                                                
ADPTTOT  DS    A                                                                
LATOTS   EQU   *-ATOTS                                                          
*                                                                               
ATHISTOT DS    A                                                                
ANXTLIN  DS    A                                                                
         SPACE 2                                                                
* THESE ADCONS POINT TO THEIR RESPECTIVE FIELDS WITHIN THE SORT RECORD          
*                                                                               
ALEVS    DS    18A                                                              
         ORG   ALEVS                                                            
ACLT     DS    A                                                                
APGR1    DS    A                                                                
APGR2    DS    A                                                                
APGR3    DS    A                                                                
APRD     DS    A                                                                
AEST     DS    A                                                                
AMGR1    DS    A                                                                
AMGR2    DS    A                                                                
AMGR3    DS    A                                                                
AMKT     DS    A                                                                
ASTA     DS    A                                                                
APKG     DS    A                                                                
APGM     DS    A                                                                
ADESC    DS    A                                                                
APER     DS    A                                                                
APERG    DS    A                                                                
ACTYP    DS    A                                                                
ADPT     DS    A                                                                
LALEVS   EQU   *-ALEVS                                                          
*                                                                               
LEVCTLS  DS    18F                                                              
         ORG   LEVCTLS                                                          
CLTCTL   DS    F                                                                
PGR1CTL  DS    F                                                                
PGR2CTL  DS    F                                                                
PGR3CTL  DS    F                                                                
PRDCTL   DS    F                                                                
ESTCTL   DS    F                                                                
MGR1CTL  DS    F                                                                
MGR2CTL  DS    F                                                                
MGR3CTL  DS    F                                                                
MKTCTL   DS    F                                                                
STACTL   DS    F                                                                
PKGCTL   DS    F                                                                
PGMCTL   DS    F                                                                
DESCCTL  DS    F                                                                
PERCTL   DS    F                                                                
PERGCTL  DS    F                                                                
CTYPCTL  DS    F                                                                
DPTCTL   DS    F                                                                
LLEVCTLS EQU   *-LEVCTLS                                                        
*                                                                               
PEPPARS  DS    F                   BINSRCH PARMS FOR PEPTAB                     
APEPTAB  DS    F                                                                
PEPTABN  DS    F                                                                
PEPTABL  DS    F                                                                
         DS    2F                                                               
*                                                                               
TRDPARS  DS    F                   BINSRCH PARMS FOR TRADETAB                   
ATRDTAB  DS    F                                                                
TRDTABN  DS    F                                                                
TRDTABL  DS    F                                                                
         DS    2F                                                               
*                                                                               
INVPARS  DS    F                   BINSR31 PARMS FOR INVTAB                     
AINVTAB  DS    A                                                                
INVTABN  DS    F                                                                
INVTABL  DS    F                                                                
         DS    2F                                                               
*                                                                               
BHLPARS  DS    F                                                                
ABHLTAB  DS    F                                                                
BHLTABN  DS    F                                                                
BHLTABL  DS    F                                                                
         DS    2F                                                               
*                                                                               
PKGPARS  DS    F                   BINSR31 PARMS FOR PKGTAB                     
APKGTAB  DS    A                                                                
PKGTABN  DS    F                                                                
PKGTABL  DS    F                                                                
         DS    2F                                                               
*                                                                               
PEFFPARS DS    2F                  BINSRCH PARMS FOR PEFFTAB                    
PEFFPARN DS    F                                                                
         DS    3F                                                               
*                                                                               
SPLPARS  DS    2F                  BINSRCH PARMS FOR SPLTAB                     
SPLPARSN DS    F                                                                
         DS    3F                                                               
*                                                                               
CLTPARS  DS    2F                  BINSRCH PARMS FOR CLTTAB                     
CLTPARSN DS    F                                                                
         DS    3F                                                               
*                                                                               
*                                  PROFILES                                     
         DS    0D                                                               
PROFB1   DS    CL16                B1                                           
PROFB1A  DS    CL16                B1A                                          
PROFB1S  DS    CL16                B1S                                          
PROFB1X  DS    CL16                B1X                                          
PROFB2   DS    CL16                B2                                           
PROFB2A  DS    CL16                B2A                                          
PROFB2B  DS    CL16                B2B                                          
PROFB4   DS    CL16                B4                                           
PROFB4A  DS    CL16                B4A                                          
PROFBN   DS    CL16                BN                                           
PROFBNX  DS    CL16                BNX                                          
PROFB9   DS    CL16                B9                                           
*                                                                               
         DS    0F                                                               
BRKTAB   DS    CL240               TABLE OF SORT/BREAK CONTROLS                 
*                                                                               
         DS    0D                  PACKED ARITHMETIC IS DONE                    
X        DS    XL256               INVOLVING THESE FIELDS                       
         DS    0D                  DOUBLE WORD ALGNMT REQUIRED                  
W        DS    CL132                                                            
MYPACKED DS    PL8                 WORKING STORAGE                              
PKBIG    DS    0PL16               FOR DIVIDING PACKED                          
PKQUOT   DS    PL8                 QUOTIENT                                     
PKRMDR   DS    PL8                 REMAINDER                                    
*                                                                               
FRSTCOM  DS    F                                                                
PERLIND  DS    F                                                                
*                                  TOTALS ACROSS AN ENTIRE REQUEST              
DBTOTG   DS    PL8                 DETAILED REQUEST TOTALS (GROSS)              
DBTOTN   DS    PL8                 DETAILED REQUEST TOTALS (NET)                
DBTOTG2  DS    PL8                 DETAILED REQUEST TOTALS (GROSS2)             
NBTOTG   DS    PL8                 MANUAL BILL TOTALS (GROSS)                   
NBTOTN   DS    PL8                 MANUAL BILL TOTALS (NET)                     
OBTOTG   DS    PL8                 BILL HEADER TOTALS (GROSS)                   
OBTOTN   DS    PL8                 BILL HEADER TOTALS (NET)                     
OBTOTG2  DS    PL8                 BILL HEADER TOTALS (GROSS2)                  
UBTOTG   DS    PL8                 UBILL REQUEST TOTALS (GROSS)                 
UBTOTN   DS    PL8                 UBILL REQUEST TOTALS (NET)                   
UBTOTG2  DS    PL8                 UBILL REQUEST TOTALS (GROSS2)                
*                                                                               
EFFDTE   DS    XL2                                                              
INRSQYM  DS    XL2                 INVOICE. NO. RESEQUENCE YM                   
INRSQDA  DS    CL2                 AND DATE                                     
*                                                                               
AAAFORM  DS    0CL7                                                             
AAABILDT DS    XL2                                                              
AAABAS   DS    X                                                                
AAACOM   DS    XL4                 IS NOT USED (YKVA)                           
*                                                                               
AAEFORM  DS    0CL5                                                             
AAEBAS   DS    X                                                                
AAECOM   DS    XL4                 IS NOT USED (YKVA)                           
*                                                                               
PRDFORM  DS    0CL5                                                             
PRDBAS   DS    X                                                                
PRDCOM   DS    XL4                 IS NOT USED (YKVA)                           
*                                                                               
ESTFORM  DS    0CL5                                                             
ESTBAS   DS    X                                                                
ESTCOM   DS    XL4                                                              
*                                                                               
*                                  PACKED FIELDS FOR BIG TOTALS                 
BIGOGRS  DS    PL8                 WON'T BE NEEDED                              
BIGONET  DS    PL8                                                              
BIGBGRS  DS    PL8                                                              
BIGBNET  DS    PL8                                                              
*                                                                               
         DS    0F                                                               
MANGRS   DS    PL8                                                              
MANNET   DS    PL8                                                              
MANBIN   EQU   *                                                                
MANPCT   DS    F                                                                
MANRVNO  DS    H                   INVOICE NUMBER TO BE REVERSED                
MANRVDTP DS    XL2                 DATE OF BILL TO BE REVERSED                  
MANBINLQ EQU   *-MANBIN                                                         
*                                                                               
SVAGMINV DS    CL6                                                              
SVAGMOCT DS    C                                                                
SVOFF    DS    C                                                                
SVCLUN   DS    CL3                                                              
*                                                                               
ADUNITS  DS    A                                                                
INVBKLEN DS    F                                                                
NBUFFADR DS    A                                                                
NBUFFLN  DS    A                                                                
SAVR1    DS    F                                                                
SAVBRK   DS    F                                                                
SPTSEQ   DS    H                                                                
XPEROPT  DS    C                                                                
TSMODE   DS    C                   TOSORT MODE - L=LOOKUP, NO CALC.             
USPLTSW  DS    C                   UNIT SPLIT? - Y=YES                          
SAVPRDC  DS    CL3                                                              
SAVPRD   DS    X                                                                
SAVPGR   DS    XL2                                                              
SAVPGRU  DS    CL4                                                              
KPRD     DS    X                                                                
KPRDC    DS    CL3                                                              
FFS      DS    XL6'FF'                                                          
DASHES   DS    CL40'-'                                                          
ELCODE   DS    X                                                                
SORTTRCE DS    C                                                                
TESTFLAG DS    C                                                                
SAVTRACE DS    C                                                                
BRDCALSW DS    C                                                                
DONESW   DS    C                                                                
ACTSW    DS    C                                                                
DUESW    DS    C                                                                
BILSW    DS    C                                                                
LSTOPT   DS    C                                                                
LISTSW   DS    C                                                                
SHOWREV  DS    C                                                                
ZEROSW   DS    C                                                                
ZBOPT    DS    C                                                                
PRSW     DS    C                                                                
ADJSEP   DS    C                                                                
BOXNO    DS    C                                                                
PAYOPT   DS    C                                                                
PARTIAL  DS    C                                                                
PRIOR    DS    C                                                                
BYTE2    DS    X                                                                
BYTE3    DS    C                                                                
PASSNO   DS    X                                                                
PGRQ     DS    C                                                                
PRDQ     DS    C                                                                
ESTQ     DS    C                                                                
MGRQ     DS    C                                                                
MKTQ     DS    C                                                                
ERR      DS    X                                                                
PCTCTL   DS    C                                                                
DPTSEP   DS    C                                                                
SCBOPT   DS    C                   SEPARATE COMMISSION BILLING (Y,N)            
SCBNCSW  DS    C                   (N=NET, C=COMMISSION, R=REG)                 
HAVUSER  DS    C                                                                
MASPRDCD DS    X                   MASTER PRODUCT CODE (NUMERIC)                
MASPRDCT DS    CL3                 MASTER PRODUCT CODE (3-CHAR)                 
PERDISP  DS    X                                                                
GNSW     DS    C                                                                
COLMNS   DS    C                                                                
BFORMAT  DS    X                                                                
DFORMAT  DS    X                                                                
FORMAT   DS    X                                                                
TICTL    DS    C                                                                
SPCLCTL  DS    C                   SPECIAL CHARGES (FROM PROFB2+9)              
COST2SW  DS    C                                                                
COST2CSW DS    C                                                                
CTYPQ    DS    C                   COST TYPE REQUESTED                          
SPOTSW   DS    C                                                                
PRDMKT   DS    C                                                                
TWOCOL   DS    C                                                                
SUMLEV   DS    C                                                                
WPRD     DS    X                                                                
WTYPSTA  DS    0XL6                                                             
WTYP     DS    X                                                                
WMKTSTA  DS    XL5                 LOCAL MKT/STA                                
WFEED    DS    CL4                                                              
WTRDPCT  DS    XL2                 TRADE %                                      
BFORMBH  DS    XL5                 BILL FORMULA FROM BILL HEADER                
STAACTSW DS    C                                                                
PKGACTSW DS    C                                                                
DPTACTSW DS    C                                                                
PGMACTSW DS    C                                                                
DPTFILT  DS    C                                                                
MEDFILT  DS    C                                                                
PROOFSW  DS    C                                                                
FORMBOPT DS    C                                                                
BFROPT   DS    C                                                                
BFRMOS   DS    X                                                                
ZUOPT    DS    C                   ZERO (BILLED) UNIT OPTION                    
STRIPOPT DS    C                                                                
PUMODE   DS    C                                                                
HAVEBILL DS    C                   'Y' = WE HAVE INVOICE REGISTER DATA          
DOINVREG DS    C                   'Y' = USER WANTS INVOICE REGISTER            
OUTDDFLG DS    C                   'Y' = INVOICE REG. DATASET ALLOCATED         
SVINVMO  DS    CL6                                                              
SVSVIMO  DS    CL6                                                              
IGNDATE  DS    XL2                                                              
WSHRL    DS    X                                                                
WPRD1    DS    X                                                                
WPRDC    DS    CL3                                                              
SPLITOPT DS    C                                                                
CORPOPT  DS    C                                                                
UPDTSOON DS    C                   'Y' = UPDATIVE SOON                          
PGSW     DS    C                    UDEF PRINTING                               
PGSW2    DS    C                    P&G SPECIAL FISCAL                          
WMTSW    DS    C                    WMT UDEF PRINTING                           
MSSW     DS    C                                                                
NS2SW    DS    C                                                                
MM3SW    DS    C                                                                
LORSW    DS    C                                                                
HAVAOR   DS    C                                                                
DECADE   DS    X                                                                
YEARDIG  DS    X                                                                
INRSQDAT DS    CL6                                                              
QENDPG   DS    CL6                                                              
HLDINO   DS    CL10                                                             
OUTMODE  DS    C                                                                
SVCTYPE  DS    X                                                                
PSHPDTE  DS    CL8                                                              
NEWSTART DS    XL2                                                              
SPOTCTL  DS    C                                                                
ONENTRY  DS    C                   ON WHEN CTYPTAB CONTAIN ONLY 1 ENTRY         
PROGSW   DS    C                                                                
PKGNME   DS    CL18                                                             
COMMSW   DS    C                                                                
ZLOPT    DS    C                                                                
ZLSW     DS    C                                                                
PKGREQ   DS    X                                                                
NETOPT   DS    C                                                                
NETNUMOD DS    C                                                                
AGMTITL  DS    C                                                                
AGMOCTL  DS    C                   OFFICE CONTROL                               
TOTSW    DS    C                                                                
PAYSW    DS    C                                                                
CKONLYTI DS    C                                                                
ONLYTI   EQU   X'80'                                                            
NOINT    EQU   X'40'                                                            
AORFRST  DS    C                                                                
BPTNR    DS    X                   PIGGY PARTNER                                
WPGR     DS    CL4                                                              
LENSHR   DS    X                                                                
MGRBKTS  DS    C                                                                
CNETSTRT DS    XL2                                                              
THISPER  DS    XL2                                                              
SVMKTCTL DS    X                                                                
TAXOPT   DS    C                                                                
PCTNET   DS    C                                                                
STANAME  DS    CL20                                                             
AORLOPT  DS    C                                                                
AORLCTL  DS    C                                                                
LASTAORA DS    CL14                                                             
SVQSTART DS    CL6                                                              
SVQEND   DS    CL6                                                              
PKGNMOPT DS    X                PACKAGE NAME OPTION (1-5 CHARS AS CODE)         
SVPACCT  DS    XL4                                                              
SAVMODE  DS    X                                                                
ECOMSW   DS    C                                                                
PREVSW   DS    C                                                                
AORSW    DS    C                                                                
TYPE     DS    C                                                                
ORIGTYPE DS    C                                                                
XXMKT    DS    XL2                                                              
XXSTA    DS    XL3                                                              
NMOS     DS    X                                                                
NDUES    DS    X                                                                
REQYM    DS    XL2                                                              
NCOMOPT  DS    C                                                                
INV#ERR  DS    C                   Y=INVOICE NUMBER EXCEEDS MAX                 
FEEDNAME DS    CL20                                                             
GNWORK   DS    CL3                                                              
*                                                                               
PERLIST  DS    (MAXMOS)XL(PERLISTL)                                             
PERLISTX DS    X                   END OF TABLE MARKER                          
PERLSTLQ EQU   *-PERLIST                                                        
*                                                                               
CURPER   DS    XL2                                                              
SVINVD   DS    XL3                                                              
*                                                                               
TOTSTAR  DS    CL2                                                              
TOTNAME  DS    CL12                                                             
*                                                                               
INVNO    DS    H                                                                
PINVNO   DS    CL10                                                             
SINVNO   DS    H                                                                
SPINVNO  DS    CL10                                                             
*                                                                               
PINVDTE  DS    CL8                                                              
EINVDTE  DS    CL6                                                              
BINVDTE  DS    XL3                                                              
BINVDTEP DS    XL2                                                              
*                                                                               
PDUEDTE  DS    CL8                                                              
EDUEDTE  DS    CL6                                                              
BDUEDTE  DS    XL3                                                              
BDUEDTEP DS    XL2                                                              
*                                                                               
SVAORS   DS    0C                                                               
SVAORACT DS    CL14                AOR RECEIVABLE/PAYABLE ACCOUNT               
SVAORPCT DS    XL4                 PCT                                          
SVAORBAS DS    X                   BASIS                                        
SVAOREFF DS    XL2                 EFFECTIVE DATE                               
SVAORDA  DS    XL4                 DISK ADDRESS                                 
SVAORKIL DS    XL2                 KILL DATE                                    
SVAORSLQ EQU   *-SVAORS                                                         
*                                                                               
AGMCLNO  DS    C                   PRINT CLIENT INTERFACE NO.                   
AGMEXP   DS    CL2                 MEDIA EXPANSION FOR INVOICE. NO.             
AGMFMT   DS    C                   FORMAT (1=EX-MM-NNNN, 2=MM-EX-NNNN)          
AGMSEQ   DS    C                   A=AGY, M=MEDIA, C=CLIENT                     
AGMCLOPT DS    C                                                                
AGMFORMS DS    C                                                                
AGMSTANO DS    H                   STARTING INVOICE NO.                         
*                                                                               
         DS    0H                                                               
AGMSKIP  DS    XL4                                                              
         ORG   AGMSKIP                                                          
AGMSKP1S DS    H                   SKIP FROM HERE                               
AGMSKP1E DS    H                          TO HERE                               
*                                                                               
SORTRLEN DS    A                                                                
SORTKLEN DS    A                                                                
ASORTDTA DS    A                                                                
ASORTCOM DS    A                                                                
*                                                                               
SORTREC  DS    CL150                                                            
SORTKEY  EQU   SORTREC                                                          
THISREC  DS    CL150                                                            
THISKEY  EQU   THISREC                                                          
OLDREC   DS    CL150                                                            
OLDKEY   EQU   OLDREC                                                           
PASSREC  DS    CL150                                                            
PASSKEY  EQU   PASSREC                                                          
*                                                                               
BADDRS   DS    0CL180                                                           
BADDR1   DS    CL36                                                             
BADDR2   DS    CL36                                                             
BADDR3   DS    CL36                                                             
BADDR4   DS    CL36                                                             
BADDR5   DS    CL36                                                             
*                                                                               
AADDRS   DS    0CL180                                                           
AADDR1   DS    CL36                                                             
AADDR2   DS    CL36                                                             
AADDR3   DS    CL36                                                             
AADDR4   DS    CL36                                                             
AADDR5   DS    CL36                                                             
*                                                                               
AORADRS  DS    0CL180                                                           
AORADR1  DS    CL36                                                             
AORADR2  DS    CL36                                                             
AORADR3  DS    CL36                                                             
AORADR4  DS    CL36                                                             
AORADR5  DS    CL36                                                             
*                                                                               
LKUPKEY  DS    CL(L'LOCKEY)        LOCK KEY                                     
*                                                                               
REQHDR   DS    0XL26                                                            
       ++INCLUDE DMREQHDR                                                       
REQUEST  DS    CL80                                                             
*                                                                               
         DS    0F                                                               
WK       DS    XL64                                                             
WK2      DS    CL64                                                             
*                                                                               
SVNETVAL DS    A                                                                
BCQSTRT  DS    CL6                 BROADCAST MONTH START                        
BCQENDP  DS    XL2                 AND END                                      
NTBPARS  DS    6F                                                               
HPRDEL1  DS    XL100               HOLD PRODUCT SPLIT ELEMENT                   
PRDELSW  DS    C                   Y=HAVE PRODUCT SPLIT ELEMENT                 
DMWORKU  DS    12D                 DEDICATED DMWORK FOR NETIO                   
UNITBILF DS    C                   'Y' = UNIT WAS BILLED BEFORE                 
XSPDA    DS    XL4                 D/A OF XSPFIL RECORD                         
STBASE   DS    A                                                                
DMWORKX  DS    12D                                                              
XSPKEY   DS    XL40                                                             
XSPKEYSV DS    XL40                                                             
*                                                                               
*                                                                               
BILWRKQ  EQU   *-BILWRKD                                                        
         EJECT                                                                  
*        SORT CONTROL TABLE                                                     
         SPACE 2                                                                
*                                                                               
BRKTABD  DSECT                                                                  
BRKCODE  DS    F                   CODE                                         
BRKDISP  DS    F                   DISPLACEMENT INTO KEY                        
BRKLENM1 DS    F                   CUMULATIVE LENGTH - 1                        
BRKCTL1  DS    X                                                                
BRKCTL2  DS    X                                                                
BRKCTL3  DS    X                                                                
BRKCTL4  DS    X                                                                
BRKCTL5  DS    X                                                                
BRKCTL6  DS    X                                                                
BRKCTL7  DS    X                                                                
BRKCTL8  DS    X                                                                
*                                                                               
BRKINV   EQU   BRKCTL1                                                          
BRKL     EQU   *-BRKTABD                                                        
         SPACE 3                                                                
BRKNAMD  DSECT                                                                  
BRKNCOD  DS    X                   CODE                                         
BRKNNAM  DS    CL10                NAME IN CHARACTER                            
BRKNL    EQU   *-BRKNAMD                                                        
         SPACE 3                                                                
NETPTABD DSECT                     DSECT FOR NETWORK UNIT PRODUCT TABLE         
NPTPRDC  DS    CL3                 PRODUCT                                      
NPTTYP   DS    X                   0=TIME,1=INT,ETC...                          
NPTSTA   DS    XL5                 PACKED LOCAL MKT/STA                         
NPTFEED  DS    CL4                 FEED CODE                                    
NPTPGR   DS    CL4                 PRODUCT GROUP                                
NPTLNSHR DS    X                   SHARE (LENGTH)                               
         DS    X                   SPARE                                        
NPTIDAT  DS    XL2                 INVOICE DATE                                 
NPTINUM  DS    XL2                 INVOICE NUMBER                               
NPTOVG2  DS    XL4                 OVERRIDEN VALUE OF NPTOGR2                   
NPTOGRS  DS    PL8                 ORDERED GROSS                                
NPTONET  DS    PL8                         NET                                  
NPTOGR2  DS    PL8                         GROSS2                               
NPTOAMTS EQU   *-NPTOGRS                                                        
NPTBGRS  DS    PL8                 BILLED  GROSS                                
NPTBNET  DS    PL8                         NET                                  
NPTBGR2  DS    PL8                         GROSS2                               
NPTBAMTS EQU   *-NPTBGRS                                                        
NPTAMTS  EQU   *-NPTOGRS                                                        
NETPTBL  EQU   *-NETPTABD                                                       
         SPACE 3                                                                
CTYPTABD DSECT                                                                  
CTYPTYP  DS    X                   COST TYPE (INDEX NUMBER)                     
CTYPSTA  DS    XL5                 LOCAL MKT/STA (PACKED) OR FEED CODE          
CTYPBRK  EQU   *-CTYPTABD                                                       
CTYPORD  DS    0XL32               ORDERED GROSS, NET, GROSS2, SPTS             
CTYPOG   DS    PL8                                                              
CTYPON   DS    PL8                                                              
CTYPOG2  DS    PL8                                                              
CTYPOS   DS    PL8                                                              
CTYPBIL  DS    0XL32               BILLED GROSS, NET, GROSS2, SPTS              
CTYPBG   DS    PL8                                                              
CTYPBN   DS    PL8                                                              
CTYPBG2  DS    PL8                                                              
CTYPBS   DS    PL8                                                              
CTYPTBL  EQU   *-CTYPTABD                                                       
         SPACE 3                                                                
CTYLD    DSECT                     DSECT FOR COST TYPE LIST                     
CTYLCOD  DS    C                   COST CODE                                    
CTYLREQ  DS    C                   COST CODE (ON PROFS, REQUEST,ETC)            
CTYLCOMK DS    C                   COMMENT ID KEY PREFIX                        
CTYLDISP DS    X                   INDEX NUMBER                                 
CTYLCTL  DS    X                   CONTROL,  X'80' PRINT IF ZERO                
*                                            X'40' GROUP 1, T+I                 
CTYLSCIQ EQU   1                             X'01' INTEG STARCOM WAY            
*                                                                               
CTYLFNAM DS    CL20                FULL NAME                                    
CTYLSNAM DS    CL9                 SHORT NAME                                   
CTYLSTL  EQU   *-CTYLD                                                          
         SPACE 3                                                                
PERLISTD DSECT                     DSECT FOR PERLIST ENTRIES                    
PERLMOS  DS    XL2                 MONTH OF SERVICE (YM BINARY)                 
PERLSTRT DS    XL2                 START DATE (COMPRESSED)                      
PERLEND  DS    XL2                 END DATE (COMPRESSED)                        
PERLISTL EQU   *-PERLISTD                                                       
*                                                                               
BHOLDTD  DSECT                     TO COVER BILLING HOLD RECS TABLE             
BHLDAM   DS    X                                                                
BHLDCLT  DS    XL2                                                              
BHLDPRD  DS    CL3                                                              
BHLDEST  DS    X                                                                
BHLDNET  DS    CL4                                                              
BHOLDTKL EQU   *-BHOLDTD                                                        
BHLDMOS  DS    XL2                                                              
BHLDPKG  DS    X                                                                
BHOLDTRL EQU   *-BHOLDTD                                                        
*                                                                               
AAAELSTD DSECT                     DSECT FOR AAAELIST ENTRIES                   
AAAELEST DS    X                   ESTIMATE NUMBER                              
AAAELFOR DS    0CL5                FORMULA                                      
AAAELBAS DS    X                   BASIS                                        
AAAELCOM DS    XL4                 COMMISSION                                   
AAAELSTL EQU   *-AAAELSTD                                                       
*                                                                               
ALINED   DSECT                     DSECT FOR AMOUNT LINE                        
ALINE    DS    0CL132                                                           
ALDESC   DS    CL20                                                             
         DS    C                                                                
ALCOL1   DS    CL16                                                             
ALCOL2   DS    CL16                                                             
ALCOL3   DS    CL16                                                             
ALCOL4   DS    CL16                                                             
         DS    CL2                                                              
ALSTRIP  DS    CL16                                                             
         DS    CL29                                                             
         SPACE 3                                                                
ILINED   DSECT                     DSECT FOR INVOICE REGISTER LINE              
ILINE    DS    0CL132                                                           
         DS    C                                                                
ILINV    DS    CL8                                                              
         DS    C                                                                
ILPRD    DS    CL3                                                              
         DS    C                                                                
ILEST    DS    CL3                                                              
         DS    CL4                                                              
ILPER    DS    CL6                                                              
         DS    C                                                                
ILTYPE   DS    CL2                                                              
         DS    C                                                                
ILMKT    DS    CL6                                                              
ILCOL2   DS    CL16                                                             
ILCOL3   DS    CL16                                                             
ILCOL4   DS    CL16                                                             
         DS    CL2                                                              
ILSTRIP  DS    CL16                                                             
         DS    CL29                                                             
         SPACE 3                                                                
INVLD    DSECT                     DSECT FOR INVOICE TABLE                      
INVLYRMO DS    XL2                                                              
         ORG   INVLYRMO                                                         
INVLYR   DS    X                                                                
INVLMO   DS    X                                                                
INVLINV  DS    XL2                                                              
INVYMIL  EQU   *-INVLD                                                          
INVLPGR  DS    XL2                                                              
INVLPRD  DS    CL3                                                              
INVLEST  DS    X                                                                
INVLDPT  DS    X                                                                
INVLSTA  DS    XL3                                                              
INVLPKG  DS    CL5                 PKG(1) OR PKGNAME(5)                         
INVLPER  DS    XL2                                                              
INVLTYP  DS    X                                                                
INVTABKL EQU   *-INVLD                                                          
INVLGRS  DS    PL8                 CHANGED TO PL8(YKVA)                         
INVLNET  DS    PL8                                                              
INVLACT  DS    PL8                                                              
INVTABRL EQU   *-INVLD                                                          
         SPACE 3                                                                
SORTCOMD DSECT                                                                  
SORTDA   DS    XL4                 DISK ADDRESS OF UNIT RECORD                  
SORTINV  DS    0XL4                                                             
SORTIDAT DS    XL2                 DATE OF INVOICE                              
SORTINVN DS    H                   INVOICE NUMBER                               
SORTSMED DS    C                   SUB-MEDIA ('S'=SYNDICATION, ETC)             
SORTOGR2 DS    XL4                 GROS2 VALUE, OVERRIDEN AT NTU15K             
SORTTRDP DS    XL2                 TRADE %                                      
SORTCMLQ EQU   *-SORTCOMD                                                       
         SPACE 3                                                                
PMKTSTAD DSECT                     PRINT STATION, STATE AND MKT NAME            
PMKTSTA  DS    CL5                                                              
         DS    CL1                                                              
PMKTSTC  DS    CL3                                                              
         DS    CL1                                                              
PMKTMKT  DS    CL20                                                             
PMKTSTAL EQU   *-PMKTSTAD                                                       
         SPACE 3                                                                
*                                  DSECT FOR FORMULA INFO                       
BFORMD   DSECT                                                                  
BFORMULA DS    0XL5                                                             
BFBAS    DS    X                   X'10'=NET BILL BASIS                         
*                                  X'01'=NET COMMISSION BASIS                   
*                                  X'80'=COMMISSION-ONLY BILL                   
BFCOMP   DS    XL4                                                              
BFRETSHR DS    XL3                                                              
BFAORPCT DS    XL3                                                              
BFORML   EQU   *-BFORMD                                                         
         SPACE 3                                                                
PKGTABD  DSECT                     PACKAGE TABLE                                
PKGEST   DS    X                   ESTIMATE NO.                                 
PKGPKG   DS    X                   PACKAGE NO.                                  
PKGNET   DS    XL3                 PACKED NETWORK CALL LETTERS                  
PKGKEYLQ EQU   *-PKGTABD           LENGTH OF BINSRCH KEY                        
PKGPKGNM DS    CL16                PACKAGE NAME                                 
PKGTABLQ EQU   *-PKGTABD                                                        
         EJECT                                                                  
* BREAK NUMBERS IN BRKEQV                                                       
*                                                                               
PGR1EQ   EQU   1                   PRODUCT GROUP 1                              
PGR2EQ   EQU   2                   PRODUCT GROUP 2                              
PGR3EQ   EQU   3                   PRODUCT GROUP 3                              
PRDEQ    EQU   4                   PRODUCT                                      
ESTEQ    EQU   5                   ESTIMATE                                     
MGR1EQ   EQU   6                   MARKET GROUP 1                               
MGR2EQ   EQU   7                   MARKET GROUP 2                               
MGR3EQ   EQU   8                   MARKET GROUP 3                               
MKTEQ    EQU   9                   MARKET                                       
STAEQ    EQU   10                  STATION                                      
PKGEQ    EQU   11                  PACKAGE                                      
PGMEQ    EQU   12                  PROGRAM                                      
DESCEQ   EQU   13                  SPOT DESC                                    
PEREQ    EQU   14                  PERIOD                                       
PERGEQ   EQU   15                  PERIOD GROUP                                 
CTYPEQ   EQU   16                  COST TYPE                                    
DPTEQ    EQU   17                  DAYPART                                      
         SPACE 2                                                                
* DISPLACEMENT TO BREAK LEVEL IN BRKEQV                                         
*                                                                               
PGR1DQ   EQU   L'BRKEQV*(PGR1EQ-1) PRODUCT GROUP 1                              
PGR2DQ   EQU   L'BRKEQV*(PGR2EQ-1) PRODUCT GROUP 2                              
PGR3DQ   EQU   L'BRKEQV*(PGR3EQ-1) PRODUCT GROUP 3                              
PRDDQ    EQU   L'BRKEQV*(PRDEQ-1)  PRODUCT                                      
ESTDQ    EQU   L'BRKEQV*(ESTEQ-1)  ESTIMATE                                     
MGR1DQ   EQU   L'BRKEQV*(MGR1EQ-1) MARKET GROUP 1                               
MGR2DQ   EQU   L'BRKEQV*(MGR2EQ-1) MARKET GROUP 2                               
MGR3DQ   EQU   L'BRKEQV*(MGR3EQ-1) MARKET GROUP 3                               
MKTDQ    EQU   L'BRKEQV*(MKTEQ-1)  MARKET                                       
STADQ    EQU   L'BRKEQV*(STAEQ-1)  STATION                                      
PKGDQ    EQU   L'BRKEQV*(PKGEQ-1)  PACKAGE                                      
PGMDQ    EQU   L'BRKEQV*(PGMEQ-1)  PROGRAM                                      
DESCDQ   EQU   L'BRKEQV*(DESCEQ-1) SPOT DESCRIPTION                             
PERDQ    EQU   L'BRKEQV*(PEREQ-1)  PERIOD                                       
PERGDQ   EQU   L'BRKEQV*(PERGEQ-1) PERIOD GROUP                                 
CTYPDQ   EQU   L'BRKEQV*(CTYPEQ-1) COST TYPE                                    
DPTDQ    EQU   L'BRKEQV*(DPTEQ-1)  DAYPART                                      
         EJECT                                                                  
MAXMOS   EQU   25                  MAXIMUM NUMBER OF MONTHS                     
*                                                                               
INVLISTL EQU   ((MAXMOS+1)*6)      LENGTH OF INVLIST FOR ONE COST TYPE          
*                                    6 PER INVOICE NO                           
         EJECT                                                                  
*                                  DSECT FOR ACCUMULATORS                       
ACMD     DSECT                                                                  
ACMORD   DS    0XL32               ORDERED GROSS, NET, GROSS2, SPTS             
ACMORDG  DS    PL8                                                              
ACMORDN  DS    PL8                                                              
ACMORD2  DS    PL8                                                              
ACMORDS  DS    PL8                                                              
ACMBIL   DS    0XL32               BILLED GROSS, NET, GROSS2, SPTS              
ACMBILG  DS    PL8                                                              
ACMBILN  DS    PL8                                                              
ACMBIL2  DS    PL8                                                              
ACMBILS  DS    PL8                                                              
*                                                                               
         DS    XL((NCTYPS-1)*ROWTL)  FOR OTHER COST TYPES                       
*                                                                               
ACMEXT   DS    0X                                                               
ACMADJ   DS    PL8                 ADJUSTMENT AMOUNT                            
ACMDUE   DS    PL8                 DUE AMOUNT                                   
ACMGR2   DS    PL8                 GROSS2                                       
ACMAOR   DS    PL8                 AOR AMOUNT                                   
ACMEXTL  EQU   *-ACMEXT            LENGTH OF EXTRAS                             
ACMDL    EQU   *-ACMD              LENGTH OF DATA                               
*                                                                               
ACCUMLQ  EQU   8                   ALL ACCUMULATORS ARE 8 BYTES                 
ACMNUMS  EQU   ACMDL/ACCUMLQ       NUMBER OF ACCUMULATORS IS DSECT LEN          
*                                  DIVIDED BY THEIR LENGTH (8)                  
*                                  *                                            
*                                  NOTE - MONTHLY TOTALS ARE FOLLOWED           
*                                  BY AN AREA FOR FORMULA INFO                  
*                                  SEE BFORMD FOR DSECT                         
*                                                                               
ROWL     EQU   ACMDL               FULL MONTHLY ACCUMULATOR LENGTH              
ROWTL    EQU   L'ACMORD+L'ACMBIL                                                
ROWNL    EQU   ROWTL*NCTYPS        ONE ROW FOR EACH COST TYPE                   
ROWHL    EQU   ROWTL/2                                                          
ROW$L    EQU   ACMORDS-ACMORD      $ FIELDS ONLY, NOT SPOTS                     
MAXLEVS  EQU   14                                                               
*                                                                               
EXTDSP   EQU   ACMEXT-ACMD         START OF EXTRAS                              
ADJDSP   EQU   ACMADJ-ACMD                                                      
DUEDSP   EQU   ACMDUE-ACMD                                                      
GR2DSP   EQU   ACMGR2-ACMD         GROSS2 AMOUNT                                
AORDSP   EQU   ACMAOR-ACMD         AOR AMOUNT                                   
*                                                                               
TOTSIZE  EQU   (MAXMOS+1)*ROWL+BFORML                                           
         SPACE 3                                                                
PEFFTBD  DSECT                     DSECT FOR PRODUCT EFFDATE TABLE              
PEFFPRD  DS    XL3                 PRODUCT                                      
PEFFKLN  EQU   *-PEFFTBD                                                        
PEFFEFD  DS    XL2                 EFFDATE                                      
PEFFFLG  DS    X                   FLAGS                                        
PEFFNBQ  EQU   X'80'                DON'T BILL THIS PRODUCT                     
PEFFTLN  EQU   *-PEFFTBD                                                        
PEFFMAX  EQU   500                 MAX PRODS                                    
         SPACE 3                                                                
TRADETD  DSECT                                                                  
TRADEPRD DS    CL3                 PRODUCT                                      
TRADEEST DS    X                   ESTIMATE                                     
TRDTABKL EQU   *-TRADETD                                                        
TRDOTIME DS    PL8                 TRADE AMOUNT FOR TIME                        
TRDBTIME DS    PL8                 TRADE AMOUNT FOR TIME                        
TRDADJ   DS    PL8                 ADJUSTMENT                                   
TRDDUE   DS    PL8                 DUE                                          
TRDAMTSL EQU   *-TRDOTIME                                                       
TRDBF    DS    0XL5                                                             
TRDBFB   DS    X                   BILL FORMULA BASE                            
TRDBFP   DS    XL4                 BILL FORMULA PCT                             
TRDTABRL EQU   *-TRADETD                                                        
*        PEPTAB DSECT                                                           
*                                                                               
PEPTD    DSECT                                                                  
PEPTPRD  DS    XL3                 PRODUCT                                      
PEPTEST  DS    X                   ESTIMATE                                     
PEPTMOS  DS    XL2                 MOS (YEAR/MONTH)                             
PEPTABKL EQU   *-PEPTD                                                          
*                                                                               
PEPTNAOS DS    0XL120              NON-AOR AMOUNTS (CLEARED AFTER BILL)         
*                                  AMOUNTS BROKEN BY SUB-MEDIA                  
***  PROGRAM RELIES ON ORDER OF SUBMEDIA ACCUMULATORS: N C S O D  ****          
PEPTGRSN DS    PL8                 GROSS NETWORK                                
PEPTNETN DS    PL8                 NET                                          
PEPTGRSC DS    PL8                 GROSS CABLE                                  
PEPTNETC DS    PL8                 NET                                          
PEPTGRSS DS    PL8                 GROSS SYNDICATION                            
PEPTNETS DS    PL8                 NET                                          
PEPTGRSO DS    PL8                 GROSS OTHER                                  
PEPTNETO DS    PL8                 NET                                          
PEPTGRSD DS    PL8                 GROSS NET RADIO                              
PEPTNETD DS    PL8                 NET                                          
PEPTMANG DS    PL8                 MANUAL GROSS                                 
PEPTMANN DS    PL8                 MANUAL NET                                   
PEPTADJ  DS    PL8                 ADJUSTMENT                                   
PEPTDUE  DS    PL8                 DUE                                          
PEPTGR2  DS    PL8                 2ND GROSS                                    
*                                                                               
PEPTAORS DS    0XL32               AOR AMOUNTS (CUMED ACROSS BILLS)             
PEPTAOR  DS    PL8                 AOR                                          
PEPTAGRS DS    PL8                 AOR GROSS                                    
PEPTANET DS    PL8                 AOR NET                                      
PEPTADUE DS    PL8                 AOR DUE BASIS                                
*                                                                               
PEPTPACT DS    XL4                 PRODUCT ACCOUNT                              
PEPTSTAT DS    X                   STATUS                                       
PEPTSTCO EQU   X'80'                COMMISSION-ONLY BILL                        
PEPTSTRD EQU   X'40'                REGULAR INVOICE ALREADY DONE                
PEPTSTAD EQU   X'20'                ADJUSTMENT INVOICE ALREADY DONE             
PEPTCTYP DS    X                   COST TYPE  (IF SEPARATE)                     
PEPTPKG  DS    X                   PKG NUMBER (IF SEPARATE)                     
PEPTAORA DS    CL14                AOR RCVBL/PAYABLE ACCT                       
PEPTAORP DS    XL4                 AOR PCT                                      
PEPTAORB DS    X                   AORBAS                                       
PEPTAORD DS    XL4                 AOR RECORD DISK ADDRESS                      
PEPTAORI DS    XL2                 AOR INVOICE NUMBER                           
*                                                                               
PEPTBFP  DS    XL4                 BILL FORMULA PCT                             
PEPTBFB  DS    X                   BILL FORMULA BASE                            
PEPTBFFL DS    X                   BILL FORMULA BASE FLAGS (BN,B2A)             
PEPTBALL EQU   X'80'               FORMULA BASED ON 'ALL' TYPES                 
PEPTBTIM EQU   X'40'               FORMULA BASED ON TIME                        
PEPTBINT EQU   X'20'               FORMULA BASED ON INTEGRATION                 
PEPTAC2  EQU   X'10'               FOR AOR, COS2 BASIS                          
PEPTATIM EQU   X'08'               FOR AOR, APPLY ONLY TO TIME                  
*                                                                               
PEPTPKGN DS    CL5                 PACKAGE NAME (UP TO 5 CHARS)                 
*                                                                               
PEPTABRL EQU   *-PEPTD                                                          
*                                                                               
PEPTNET  EQU   0                                                                
PEPTCAB  EQU   1                                                                
PEPTSYN  EQU   2                                                                
PEPTOTH  EQU   3                                                                
PEPTNR   EQU   4                                                                
*                                                                               
PEPTBN   EQU   2000                                                             
INVTBN   EQU   50000               ABOVE THE LINE (CAN BE MADE HUGE)            
BHLTBN   EQU   500                                                              
LINTABN  EQU   200                                                              
PKGTBN   EQU   15000               ABOVE THE LINE (CAN BE MADE HUGE)            
*                                                                               
*                                  PRODUCT SPLIT TABLE EQUATES                  
SPLTKYLQ EQU   4                   PRODUCT/ESTIMATE                             
SPLTABRL EQU   SPLTKYLQ+(SPLTSMAX*SPLTSLEN)   KEY + SHARES                      
*PLTSMAX EQU   6                   MAX SHARES (ACTUALLY 5 + 1 IN CASE)          
SPLTSMAX EQU   10                  EXPANDED TO 10 AS OF 3/4/02                  
SPLTSLEN EQU   7                   LENGTH OF SHARE ENTRY, PRD+%                 
SPLTPMAX EQU   80                  MAX. PRODUCT/ESTIMATES TO BE SPLIT           
         SPACE 2                                                                
         PRINT OFF                                                              
       ++INCLUDE SPREPWORKD                                                     
         PRINT ON                                                               
         ORG   QAREA+35                                                         
QDUEDAYS DS    CL2                                                              
         ORG   QAREA+49                                                         
QMANUAL  DS    CL12                                                             
         ORG   QOPT1                                                            
QCTYP    DS    C                                                                
         ORG   Q2USER                                                           
QINVDATE DS    CL6                                                              
QPKGF    DS    CL16                PACKAGE NAME FILTER                          
QPRIOR   DS    0CL3                                                             
QPRIORMO DS    CL2                 NUMBER OF PRIOR MONTHS                       
QPRIORMD DS    C                   ONLY 'T' (TOGETHER) SUPPORTED NOW            
QCORPRD  DS    CL3                 CORPORATE PRODUCT OVBERRIDE                  
QINVREG  DS    C                   'R' = GENERATE INVOICE REGISTER              
         DS    C                   CURRENT=FLIGHT                               
QWEEKNO  DS    CL2                 WEEK NUMBER 0 - 99                           
         ORG                                                                    
         EJECT                                                                  
BILLRECD DSECT                                                                  
       ++INCLUDE SPGENBILL                                                      
         EJECT                                                                  
       ++INCLUDE SPGENSTAB                                                      
         EJECT                                                                  
       ++INCLUDE NEGENUBILL                                                     
         EJECT                                                                  
         PRINT OFF                                                              
AGYHDRD  DSECT                                                                  
       ++INCLUDE SPGENAGY                                                       
         EJECT                                                                  
CLTHDRD  DSECT                                                                  
       ++INCLUDE SPGENCLT                                                       
         EJECT                                                                  
PRDHDRD  DSECT                                                                  
       ++INCLUDE SPGENPRD                                                       
         EJECT                                                                  
ESTHDRD  DSECT                                                                  
       ++INCLUDE SPGENEST                                                       
         EJECT                                                                  
BUYRECD  DSECT                                                                  
       ++INCLUDE SPGENBUY                                                       
         EJECT                                                                  
STARECD  DSECT                                                                  
       ++INCLUDE SPGENSTA                                                       
         EJECT                                                                  
ADDRECD  DSECT                                                                  
       ++INCLUDE SPGENADD                                                       
         EJECT                                                                  
MKTRECD  DSECT                                                                  
       ++INCLUDE SPGENMKT                                                       
         EJECT                                                                  
       ++INCLUDE SPGENAOR                                                       
         EJECT                                                                  
       ++INCLUDE SPGENPRG                                                       
         EJECT                                                                  
       ++INCLUDE SPGENSPBL                                                      
         EJECT                                                                  
       ++INCLUDE SPREPMODES                                                     
         EJECT                                                                  
       ++INCLUDE SPMEDBLOCK                                                     
         EJECT                                                                  
       ++INCLUDE NECOMBLOK                                                      
         EJECT                                                                  
       ++INCLUDE NEGENCOM                                                       
         EJECT                                                                  
       ++INCLUDE NEGENUNIT                                                      
         EJECT                                                                  
       ++INCLUDE DDUCOMD                                                        
         EJECT                                                                  
       ++INCLUDE DDTSARD                                                        
         EJECT                                                                  
       ++INCLUDE DDGETPROFD                                                     
         EJECT                                                                  
       ++INCLUDE DMWRKFK                                                        
         EJECT                                                                  
       ++INCLUDE DMWRKFL                                                        
         EJECT                                                                  
       ++INCLUDE DDMASTD                                                        
         EJECT                                                                  
       ++INCLUDE FAUTL                                                          
         EJECT                                                                  
       ++INCLUDE DDBUFFALOD                                                     
         EJECT                                                                  
       ++INCLUDE SPBILLEDID                                                     
         EJECT                                                                  
       ++INCLUDE NETBILLRD                                                      
         EJECT                                                                  
NDPTHDRD DSECT                                                                  
       ++INCLUDE NEGENDPT                                                       
         EJECT                                                                  
NETBLOCD DSECT                                                                  
       ++INCLUDE NETBLOCKN                                                      
         EJECT                                                                  
SPBVALDD DSECT                                                                  
       ++INCLUDE SPBVALD                                                        
         EJECT                                                                  
SPGBFRDD DSECT                                                                  
       ++INCLUDE SPGETBFRD                                                      
         EJECT                                                                  
CLTPHDRD DSECT                                                                  
       ++INCLUDE SPGENCLTO                                                      
         EJECT                                                                  
FEEDKEYD DSECT                                                                  
       ++INCLUDE SPTRNFEED                                                      
         EJECT                                                                  
       ++INCLUDE FALOCKETD                                                      
LKKEYD   DSECT                                                                  
         ORG   LOCKKEY                                                          
LKNBCLT  DS    XL3                                                              
LKNBEST  DS    XL3                                                              
LKNBNET  DS    XL4                                                              
*                                                                               
       ++INCLUDE DDCOREQUS                                                      
*                                                                               
       ++INCLUDE DDCOMFACSD                                                     
*                                                                               
       ++INCLUDE NEGENBHOLD                                                     
*                                                                               
         PRINT ON                                                               
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'063SPREPBU02A04/11/07'                                      
         END                                                                    
