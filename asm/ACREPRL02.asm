*          DATA SET ACREPRL02  AT LEVEL 233 AS OF 08/12/20                      
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *         
*                                                                     *         
*                 *-----------*     *-------*     *-----------*       *         
*  **** NOTE: *** º ACREPPL02 º *** º CALLS º *** º ACREPRL02 º ****  *         
*  USA     ONLY   *-----------*     *-------*     *-----------*       *         
*  PAYABLE ONLY                                                       *         
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *         
*PHASE ACRL02C                                                                  
*INCLUDE PRINT                                                                  
*INCLUDE PRNTBL                                                                 
*INCLUDE UNDERLIN                                                               
*INCLUDE CASHVAL                                                                
*INCLUDE CENTER                                                                 
*INCLUDE ACJBEXC                                                                
*INCLUDE PERVERT                                                                
*INCLUDE ACGETRTE                                                               
*INCLUDE ACJOBAGE                                                               
*INCLUDE ACASOF                                                                 
*INCLUDE PERFACT                                                                
*&&UK                                                                           
*INCLUDE TOBACCO                                                                
*&&                                                                             
*                                                                               
* PID  LVl DATE    COMMENTS                                                     
* ---------------------------------                                             
* SMAN 034 10NOV11 PR000122 Estimate Phase 1                                    
* SMAN 035 16DEC11 PR002242 UK/US MERGE                                         
* YNGX     30NOV11 PR002414 NEW JOB EXTRACT DESCRIPTION KEYWORD                 
* SMAN 036 08FEB12 PR002625 Estimate currency keywords                          
* SMAN             Fixes from DCUR                                              
* NSHE             Fill master job when processing master job                   
* JFOS     02MAR12 PR002742 New CRD filter 'Include manual payments'            
* JFOS 038 20NOV12 <BR52815L> Always init ESTMAIN                               
* JFOS 039 04DEC12 <PR003402> Estimated time keywords (B33)                     
* JFOS 183 14AUG13 <DSSUP1115> Fixes from US                                    
* JFOS 184 06SEP13 <DSPCA111>New 'Br'Ocean Invoices Status' filter              
* JFOS 185 22JAN14 <DSPCA528> Download reports to BDE server via MQ             
*      186         <DSPCA411> New TSERNO keyword                                
*      186         <DSPCA399> New ESDTE keyword                                 
* YNGX 187 23SEP14 <PCA01185> Send download reports to USS server               
* YNGX 188 27JAN15 PCA01501 NEW KEYWORDS BGA, BGM, BGACC, COLIF, CATNAM         
* ***  189/97 **15 MERGED WITH US *************************************         
* JFOS 198 11NOV15 <PCA02009> Support WC-level estimated hours for Aura         
* YNGX     22FEB16 <PCA02292> Download option to remove request pages           
* YNGX 199 15MAR16 <PCA02355> DON'T ADD ZERO EST HOURS TO TABLE                 
* NSHE 200 08APR16 <PCA02383> Approver date fix for Aura estimates              
* GHOA 215 17NOV17 <SPEC-15538> TY12 (PO) MOA reports differently               
*      216 29DEC17 <SPEC-16663> Cli/Pro/Job not honoring multiple lists         
* JSAY 217 23MAR18 <SPEC17073> REPORT TRANSACTION TYPE AND NARRATIVE            
*                              ON G/L SCRIBE                                    
* GHOA 218 20JUN18 <SPEC-16663> Revert code from 216: multiple lists            
* GHOA 219 25JUN18 <SPEC-16663> Cli/Pro/Job not honoring multiple lists         
* GHOA 220 31JUL18 SPEC-26412 EDIHUB VIA MQ MESSAGING                           
*      221 29AUG18 SPEC-27424 PID and Email for approver, line manager          
* VGUP 226 04FEB19 SPEC-31786 Cli/Pro Fix for Aura Expenses payable             
* YNGX 227 14JAN19 <PCA02946> Support for queried transactions                  
* YNGX 228 15JUL19 <SPEC37237> FIX LOC LOOKUP IF TERM IN MID OF PERIOD          
* JSAY 229 09APR19 SPEC-33734 Ability to request a person scribe report         
*                             based on timesheet approved date.                 
* JSAY 229 09APR19 SPEC-33735 Ability to request a person scribe report         
*                             based on timesheet submitted date.                
* VGUP 230 22OCT19 SPEC-40146 Fix issue with CEA keyworkd                       
* VGUP 231 02APR19 SPEC-43802 Relink due to new ACREPRLWRK                      
* GHOA 232 30APR20 SPEC-28298 New Setup: Cairnes Oniel for CSI                  
* GHOA 233 23Jul20 SPEC-46231 Relink due to new ACREPRLWRK                      
*----------------------------------------------------------------------         
                                                                                
ACRL02   CSECT                                                                  
         TITLE 'Scribe report generator'                                        
         PRINT NOGEN                                                            
         USING ACWORKD,RC                                                       
         USING ACRLD,RA                                                         
         USING FMTRECD,R5                                                       
         NMOD1 0,**ACRL**,R9,R8,R7                                              
         L     RC,0(,R1)                                                        
         LA    RA,SPACEND                                                       
         ST    RB,RLBASEB                                                       
         ST    RC,RLBASEC                                                       
*                                                                               
ARL100   L     R5,AFORMATS                                                      
         CLI   RCTRACE,C'I'                                                     
         BNE   ARL102                                                           
         GOTOR MYTRACE                                                          
                                                                                
ARL102   CLI   MODE,0                                                           
         BNE   ARL105                                                           
                                                                                
         USING MASTD,R6                                                         
         L     R6,ADMASTC                                                       
         MVI   DDLNKIND,DDLNKON    Set running with DDLINK                      
         GOTO1 =A(LOADPROG)                                                     
         B     XIT                                                              
         DROP  R6                                                               
                                                                                
ARL105   CLI   MODE,RUNFRST                                                     
         BE    RUNF                                                             
         CLI   MODE,PROCSPCL       SPECIAL REQUEST DETAILS                      
         BNE   ARL110                                                           
         OC    MAINPROG,MAINPROG   Did we come from ACPL phase ?                
         BNZ   ARL110              Yes so skip, the ACPL did this               
         MVC   SVREG,4(R1)         SAVE OFF ADDRESS                             
*                                                                               
ARL110   TM    UPSI,UPSITABS                                                    
*&&UK*&& BZ    ARL120                                                           
*&&US*&& BZ    ARL112                                                           
         GOTO1 =A(TIMELAP),0                                                    
*&&US                                                                           
ARL112   CLI   QPROG,GENERAL       General ledger                               
         BNE   ARL120                                                           
         TM    FCIND,FCNEWGL       New GL                                       
         BZ    ARL120              OLD GL                                       
         MVI   SUBTTYP,X'19'                                                    
*&&                                                                             
ARL120   CLI   MODE,PROCRQST       Request card start                           
         BE    RQST                                                             
         CLI   MODE,PROCOPTS       Request details for options                  
         BE    PRTOPTS                                                          
         CLI   MODE,PROCSPCL       Print recap data                             
         BE    PRTSPCL                                                          
         BH    XIT                                                              
         CLI   MODE,REQFRST                                                     
         BE    REQF                                                             
         CLI   MODE,REQLAST                                                     
         BE    REQL                                                             
         CLI   MODE,RUNLAST                                                     
         BE    RUNL                                                             
         CLI   ERROR#,0                                                         
         BNE   XIT                                                              
*&&UK*&& CLI   MODE,UNITFRST                                                    
*&&UK*&& BE    UNTFRST                                                          
*&&UK*&& CLI   MODE,UNITLAST                                                    
*&&UK*&& BE    UNTLAST                                                          
         CLI   MODE,LEDGFRST                                                    
         BE    LDGFRST                                                          
         MVI   MODEIND,0                                                        
         NI    SPLITSW,TURNOFF-SPLITCPY-SPLITRST-SPLITMLT-SPLITROK              
*                                                                               
MODES    CLI   QOPT3,OPT3SCMA      SCHEMA ONLY                                  
         JE    XITMODE             Skip all of this then                        
         CLI   MODE,PROCLEVA                                                    
         BE    PRCLVLS                                                          
         CLI   MODE,PROCLEVB                                                    
         BE    PRCLVLS                                                          
         CLI   MODE,PROCLEVC                                                    
         BE    PRCLVLS                                                          
         CLI   MODE,PROCLEVD                                                    
         BE    PRCLVLS                                                          
         CLI   MODE,PROCACC                                                     
         BE    PRCA                                                             
         CLI   MODE,PROCOFA                                                     
         BE    PRCOFA                                                           
         TM    FMTMODES,FMTNOACC        DON'T PROCESS ACCOUNT                   
         BO    XITNEXTX                                                         
         CLI   MODE,PROCSBAC       Account/contra bucket                        
         BE    PRCSBA                                                           
         CLI   MODE,PROCSBOF       Account/office/contra bucket                 
         BE    PRCSBA                                                           
         CLI   MODE,ANALFRST                                                    
         BE    PRCANL                                                           
         CLI   MODE,SBACFRST                                                    
         BE    SUBACC                                                           
         CLI   MODE,ACCLAST                                                     
         BE    ACCLST                                                           
         LA    RE,XITMODE                                                       
         CLI   MODE,PROCTRNS                                                    
         BNE   *+12                                                             
         LA    RE,TRNSPUT                                                       
         OI    ACTIVITY,ACTTRNS    TRANSACTION PRESENT                          
*                                                                               
         CLI   MODE,PROCTIME                                                    
         BNE   *+12                                                             
         LA    RE,PROCTMS                                                       
         OI    ACTIVITY,ACTTRNS    TRANSACTION PRESENT                          
*                                  DON'T READ TRANSACTIONS                      
         TM    FMTMODES,FMTNOANL+FMTNOSUB+FMTNOTRS                              
         BNZ   XITNEXTX      WAIT FOR NEXT GOOD WORKCODE FOR FORMAT             
         BR    RE                                                               
         EJECT                                                                  
*=====================================================================*         
*  Routine for RUN FIRST mode                                         *         
*=====================================================================*         
                                                                                
RUNF     BRAS  RE,RUNFIRST                                                      
         B     XITMODE                                                          
         EJECT                                                                  
*=====================================================================*         
*  Routine to process request card before MONACC                      *         
*=====================================================================*         
RQST     DS    0H                                                               
*                                                                               
         CLI   QOPT1,SRPDL         Special DL to suppress req page ?            
         BNE   RQST04              No - OK                                      
         MVI   RCREQREP,NO         Yes, don't print Req Page                    
         MVI   QOPT1,YES           Restore it back to regular download          
*                                                                               
RQST04   CLI   MULTLDG,YES                                                      
         BE    XITMODE             Do one per request                           
         BRAS  RE,RQSTART                                                       
         B     XITMODE                                                          
                                                                                
*=====================================================================*         
*  Routine process details before ACPRINT, Called from ACPRINT        *         
*=====================================================================*         
PRTSPCL  BRAS  RE,RLREPORT                                                      
         B     XITMODE                                                          
                                                                                
*=====================================================================*         
*  Routine process each option as wanted on request details           *         
*=====================================================================*         
PRTOPTS  BRAS  RE,RLPRTOPT                                                      
         B     XITMODE                                                          
         EJECT                                                                  
*=====================================================================*         
*  ROUTINE FOR REQUEST FIRST                                          *         
*=====================================================================*         
                                                                                
         USING ACMD,R3                                                          
REQF     CLI   NEWOFF,YES          Only do this if two byte offices             
         BNE   RQF004              Not                                          
         LA    RE,NFILSEQ          Types to process as NEWFILE                  
         LA    RF,NFILSEQ#         Number in list                               
RQF003   CLC   QPROG(1),0(RE)      Match on program type                        
         BNE   *+8                 Not this one                                 
         MVI   FCSEQ,FCSEQNEW      Process as NEWFILE sequence                  
         AHI   RE,1                Next entry                                   
         BCT   RF,RQF003           Loop through them                            
*                                                                               
RQF004   DS    0H                                                               
*Not ready for limlist code yet                                                 
*                                                                               
*        TM    DDLNKIND,DDLNKON                                                 
*        BZ    RQF005                                                           
*        USING LP_D,R1                                                          
*        L     R3,AMONACC                                                       
*        L     R1,ACMALP_D                                                      
*        XC    FULL,FULL           Get Scribe's security values                 
*        MVI   FULL,X'06'          even though Accent/Quickreports              
*        MVI   FULL+1,X'0C'                                                     
*        L     RF,LP_ASECD                                                      
*        MVI   SECINDS-SECD(RF),0  Initialize security values                   
*        GOTO1 SECRET,DMCB,('SECPINIT+SECPOLP+SECPOVAL',(RF)),0,FULL            
*                                                                               
RQF005   CLI   MULTLDG,YES         If multiledger reset and skip mode           
         BNE   RQF0010                                                          
*                                                                               
         GOTO1 ASETACT,DMCB        Sets up account table in MONACC              
*                                                                               
         L     R3,AMONACC          Set office list in MONACC DSECT              
         L     RE,ALTOFFL                                                       
         OC    0(2,RE),0(RE)       Was there an alternate office list ?         
         BZ    RQF0005             No                                           
         LA    RE,ACMOFCN                                                       
         LA    RF,256*2+L'ACMOFCN                                               
         LR    R1,RF                                                            
         L     R0,ALTOFFL                                                       
         MVCL  RE,R0               Reset office filter list                     
*                                                                               
         USING OFFALD,R1                                                        
         L     R1,ACMAOFL                                                       
         MVI   OFFAOFFC,X'FF'      Fudge, so MONACC processes                   
         DROP  R1                                                               
                                                                                
RQF0005  CLI   QPROG,RECEIVABLE                                                 
         BE    *+8                                                              
         CLI   QPROG,PAYABLES                                                   
         BNE   XITMODE                                                          
         XC    ACMASTR,ACMASTR     Clear so ACMASTER doesn't filter             
         XC    ACMMSTR,ACMMSTR     MOA start date                               
         B     XITMODE                                                          
         DROP  R3                                                               
                                                                                
RQF0010  TM    DDLNKIND,DDLNKON                                                 
         BO    RQF0020                                                          
         GOTO1 =A(LOADPROG)        Load RL07 phase if needed                    
         GOTO1 ALOADTAB,LOADRSET+LOADCLR                                        
                                                                                
RQF0020  OC    ATBUFF,ATBUFF       Do we have this area                         
         BNZ   RQF0030             Yes, so okay as is                           
         L     R0,=A(TBUFLEN)      Acquire table above 16M line                 
         ST    R0,ATBUFLEN                                                      
                                                                                
         TM    DDLNKIND,DDLNKON                                                 
         BO    RQF0021             Always get both when DDLINK                  
         CLI   QPROG,PAYABLES      Payables                                     
         BE    *+8                 Yes so get extra storage                     
         CLI   QPROG,GENERAL       General ledger                               
         BNE   RQF0022             No,  SKIP                                    
RQF0021  OI    TSARSW,TSARBOTH     Get 2nd buffer                               
         A     R0,=A(TBUFLEN)      2nd block 2 buffer above 16M                 
                                                                                
RQF0022  GETMAIN RU,LV=(0),LOC=(ANY,ANY)                                        
         LTR   RF,RF               DID WE GET STORAGE?                          
         BZ    *+6                                                              
         DC    H'00'               NO, SO DIE                                   
*                                                                               
         ST    R1,ATBUFF           SAVE BEGINNING OF A(TSAR BUFFER)             
         TM    TSARSW,TSARBOTH                                                  
         BZ    RQF0030                                                          
         A     R1,ATBUFLEN         PLUS TSAR BUFFER LENGTH                      
         ST    R1,ASTACK           SAVE TSAR BLOCK 2 ADDRESS                    
*                                                                               
RQF0030  GOTO1 =A(REQFIRST)                                                     
*&&US                                                                           
         NI    TABIND,X'FF'-TABGBMOS  RESET FOR ACCENT                          
*&&                                                                             
         B     XITMODE                                                          
                                                                                
NFILSEQ  DC    C'BGIRX12'          Report types that support Newfile            
NFILSEQ# EQU   *-NFILSEQ                                                        
         EJECT                                                                  
*&&UK                                                                           
*=====================================================================*         
*  OPEN MEDIA FILE IF REQUIRE ON UNIT FIRST                           *         
*  NOTE: DEBTOR SCRIBE ONLY AND JCLS NEED TO BE CHANGED FOR OTHER     *         
*        MODULES TO OPEN AND READ MEDIA FILES (SEE OT82430L)          *         
*=====================================================================*         
UNTFRST  DS    0H                                                               
         TM    FMTIND2,FMTMESYS    Test format requires media system            
         JZ    XIT                 NO - OK                                      
         L     R6,ADMASTC                                                       
         L     R6,MCUTL-MASTD(R6)                                               
         MVC   4(1,R6),RCMESENO                                                 
         GOTO1 DATAMGR,DMCB,DMOPEN,DMMEDIA,MEFILLST,AIO1,0                      
         MVC   4(1,R6),RCACSENO                                                 
         J     XIT                                                              
                                                                                
*=====================================================================*         
*  CLOSE MEDIA FILE IF REQUIRE AT UNIT LAST                           *         
*=====================================================================*         
UNTLAST  DS    0H                                                               
         TM    FMTIND2,FMTMESYS    Test format requires media system            
         JZ    XIT                 NO - OK                                      
         L     R6,ADMASTC                                                       
         L     R6,MCUTL-MASTD(R6)                                               
         MVC   4(1,R6),RCMESENO                                                 
         GOTO1 DATAMGR,DMCB,DMCLSE,DMMEDIA,MEFILLST,AIO1                        
         MVC   4(1,R6),RCACSENO                                                 
         NI    FMTIND2,X'FF'-FMTMESYS                                           
         J     XIT                                                              
*                                                                               
DMOPEN   DC    C'DMOPEN '                                                       
DMCLSE   DC    C'DMCLSE '                                                       
DMMEDIA  DC    C'MEDIA  '                                                       
MEFILLST DC    C'NMEDDIR NMEDFIL X'                                             
         EJECT                                                                  
*&&                                                                             
*=====================================================================*         
*  PROCESS THE LEDGER DATA                                            *         
*=====================================================================*         
                                                                                
LDGFRST  MVI   FCRDACC,NO          STOP PROCESSING FOR THIS LEDGER              
         CLI   QOPT3,OPT3SCMA      SCHEMA ONLY                                  
         JE    XITMODE                                                          
         GOTOR =A(LDGFIRST)        STOP PROCESSING FOR THIS LEDGER              
         CLI   ERROR#,0            LEDGER SECURITY PROBLEM                      
         BNE   ERRORMSG                                                         
         J     XIT                                                              
         EJECT                                                                  
***********************************************************************         
*  PROCESS THE ACCOUNT LEVELS                                         *         
***********************************************************************         
         SPACE 1                                                                
PRCLVLS  CLI   MODE,PROCLEVC       Level three ?                                
         BNE   *+8                                                              
         NI    POSTLVL2,TURNOFF-POSTCIND                                        
         TM    MODEIND,MODEONCE    Have we been through here ?                  
         BO    PRCLVL40            Yes                                          
         MVC   SVADACC,ADACC       Fix, incorrect when using filters            
*                                                                               
         USING ACMD,R2                                                          
         L     R2,AMONACC          A(ACMASTC)                                   
         MVC   FLTRS,ACMFLTS       Save filters 1-5                             
         DROP  R2                                                               
*                                                                               
*        ICM   R2,15,ADACCSTA      Current account status (X'30')               
*        BZ    PRCLVL30            There probably should be one                 
         SR    R1,R1               Level 1 bit, or lack there of                
         CLI   MODE,PROCLEVA       Level one ?                                  
         BNE   PRCLVL02            No                                           
         MVC   ADACC,ADHEIRA                                                    
         ICM   R2,15,ADLVASTA      level A account status (X'30')               
         GOTOR SETSTAT,0           Level 1 bit                                  
         B     PRCLVL08                                                         
                                                                                
PRCLVL02 CLI   MODE,PROCLEVB       Level two ?                                  
         BNE   PRCLVL03            No                                           
         MVC   ADACC,ADHEIRB                                                    
         ICM   R2,15,ADLVBSTA      level B account status (X'30')               
         GOTOR SETSTAT,1           Level 2 bit                                  
         B     PRCLVL08                                                         
                                                                                
PRCLVL03 CLI   MODE,PROCLEVC       Level three                                  
         BNE   PRCLVL04                                                         
         MVC   ADACC,ADHEIRC                                                    
         ICM   R2,15,ADLVCSTA      level C account status (X'30')               
         GOTOR SETSTAT,2           Level 3 bit                                  
         B     PRCLVL08                                                         
                                                                                
PRCLVL04 CLI   MODE,PROCLEVD       Level four                                   
         BE    *+6                                                              
         DC    H'00'                                                            
         MVC   ADACC,ADHEIRD                                                    
         ICM   R2,15,ADLVDSTA      level D account status (X'30')               
         GOTOR SETSTAT,3           Level 4 bit                                  
*                                                                               
PRCLVL08 MVI   ACCSTAT,0           Reset                                        
         TM    ACLOCK,ACLOCANY     Any levels have lock on?                     
         BZ    *+8                 No                                           
         OI    ACCSTAT,ACCLOCK     Yes account is LOCKED                        
         TM    ACCLOSE,ACCLSANY    Any levels have closed on?                   
         BZ    *+8                 No                                           
         OI    ACCSTAT,ACCCLSE     Yes account is CLOSED                        
         TM    ACPAYEE,ACPAYANY    Any levels have PAYEE=NO on?                 
         BZ    *+8                 No                                           
         OI    ACCSTAT,ACCPAYN     Yes account has PAYEE=NO                     
         MVC   CURDLBR,SPACES                                                   
         CLI   QPROG,MANPOWER                                                   
         JNE   PRCLVL30                                                         
         MVC   CURDLBR(2),=C'14'                                                
         MVC   CURDLBR+2(1),ANALFLT                                             
                                                                                
         USING ACGOD,R2                                                         
PRCLVL30 TM    FCIND,FCNEWGL       New GL                                       
         BZ    PRCLVL31                                                         
         GOTOR STOREREC,ADACC                                                   
                                                                                
PRCLVL31 CLI   QPROG,PRODUCTION                                                 
         BNE   PRCLVL32                                                         
*&&US*&& CLI   MODE,PROCLEVC       Job level okay in UK not US                  
*&&US*&& BE    PRCLVL32                                                         
         GOTO1 PARSE,DMCB,GETOFFC,CUROFF,0                                      
         L     R2,ADGOBLOC                                                      
         MVC   GOEFFOFC,CUROFF                                                  
         MVC   CURCOFF,CUROFF      Client office                                
         DROP  R2                                                               
*                                                                               
         USING LDGD,R3                                                          
         USING ACTRECD,RE                                                       
PRCLVL32 CLI   QPROG,MANPOWER                                                   
         BNE   PRCLVL70                                                         
         CLI   MODE,PROCLEVA       Level one                                    
         BNE   PRCLVL70            No                                           
         GOTO1 GETLDGR,DMCB,=C'1R'                                              
         L     R3,DMCB             GET ENTERY                                   
         MVC   PRSNOFF,SPACES      PERSON'S OFFICE                              
         L     RE,ADHEIRA                                                       
         LLC   R1,LDGLVQ1          LENGTH OF LEVEL ONE                          
         BCTR  R1,0                                                             
         EXMVC R1,PRSNOFF,ACTKACT  MOVE IN OFFICE                               
         MVC   CUROFF,PRSNOFF                                                   
         DROP  R3,RE                                                            
***********************************************************************         
*  ROUTINE TO SET UP AND SET COLUMN DATES BASED ON CALENDAR RECORDS   *         
***********************************************************************         
         SPACE 1                                                                
         USING COLD,R3                                                          
         USING COSTWKD,R4                                                       
         USING DTED,R6                                                          
PRCLVL40 CLI   QPROG,MANPOWER                                                   
         BNE   PRCLVL70                                                         
         L     R3,FMTCOL                                                        
         L     R4,ACOSTBLK                                                      
         L     R6,FMTDTED          Load date periods for format                 
         SR    R1,R1                                                            
PRCLVL42 CLI   0(R6),0             End of table                                 
         BE    PRCLVL45            Use default entry                            
         LA    R1,1(,R1)           Bump up index                                
         STC   R1,DTEIDX#                                                       
         CLC   PRSNOFF,DTEOFF                                                   
         BE    PRCLVL50            Found this column entry in table             
         AH    R6,DTECOLLN         Length of entry                              
         B     PRCLVL42                                                         
*                                                                               
PRCLVL45 L     R6,FMTDTED          Load default                                 
         MVI   DTEIDX#,1           Reset to first entry                         
*                                                                               
PRCLVL50 SR    R0,R0                                                            
         IC    R0,FMT#COLS         Number of columns                            
PRCLVL55 TM    COLFLAGS,COLAMT     Amount columns only                          
         BZ    PRCLVL58                                                         
         TM    COLIND1,COLCNDR     Calendar dates                               
         BZ    PRCLVL58                                                         
         SR    RF,RF                                                            
         IC    RF,COLDTE#                                                       
         MHI   RF,L'DTECOL                                                      
         LA    RE,DTESTRT(RF)                                                   
         MVC   COLSTART(6),0(RE)   Move in start and end dates                  
         MVC   COLTPEDS,6(RE)      Move in number or periods                    
*                                                                               
PRCLVL58 LA    R3,COLLNQ(,R3)                                                   
         BCT   R0,PRCLVL55         Set all columns with stored dates            
         DROP  R3,R4,R6                                                         
*                                                                               
PRCLVL70 TM    FMTFLAG,FMTACLVL                                                 
         BZ    PRCLVLX                                                          
         CLC   MODE,LEVMAX         LOWEST LEVEL                                 
         BE    PRCLVLX             YES SO THIS WILL POST AT PROCACC             
         MVC   SVHEIRD,ADHEIRD                                                  
         XC    ADHEIRD,ADHEIRD                                                  
         CLI   MODE,PROCLEVC       LEVEL THREE                                  
         BE    PRCLVL75                                                         
         MVC   SVHEIRC,ADHEIRC                                                  
         MVC   SVHEIRB,ADHEIRB                                                  
         XC    ADHEIRC,ADHEIRC                                                  
         GOTO1 AFILTER,DMCB,AFLTOFF,CUROFF                                      
         BNE   PRCLVL80                                                         
*                                                                               
PRCLVL72 CLI   MODE,PROCLEVB       LEVEL TWO                                    
         BE    PRCLVL75                                                         
         XC    ADHEIRB,ADHEIRB                                                  
*                                                                               
PRCLVL75 CLC   MODE,FMTLEVMX       MODE = 33 THRU 35                            
         BH    PRCLVL80            DON'T GO BEYOUND FMTLEVMX MODE               
         BRAS  RE,ACSTATUS                                                      
         BNE   PRCLVL80                                                         
*                                                                               
         L     R2,ADACC                                                         
         AH    R2,DATADISP                                                      
PRCLVL76 CLI   0(R2),0             EOR ?                                        
         BE    PRCLVL78                                                         
         CLI   0(R2),PACELQ        X'A1' DATE CHANGED (ACGENFILE)               
         BE    PRCLV77A                                                         
         CLI   0(R2),X'F1'         X'F1' DATE CHANGED (DDACTIVD)                
         BE    PRCLV77B                                                         
         IC    RF,1(,R2)                                                        
         AR    R2,RF                                                            
         B     PRCLVL76                                                         
*                                                                               
         USING PACELD,R2                                                        
PRCLV77A LA    RE,PACDATE          POINT TO CHANGED DATE                        
         B     PRCLVL77                                                         
*                                                                               
         USING ACTVD,R2                                                         
PRCLV77B GOTO1 DATCON,DMCB,(3,ACTVCHDT),(1,ACTVCHDT)                            
         LA    RE,ACTVCHDT         CONVERTED BINARY TO PACKED                   
         DROP  R2                                                               
*                                                                               
PRCLVL77 CLC   0(3,RE),RQACTSTR                                                 
         BL    PRCLVL80            BEFORE ACTIVITY START DATE                   
         CLC   0(3,RE),RQACTEND                                                 
         BH    PRCLVL80            AFTER  ACTIVITY START DATE                   
*                                                                               
PRCLVL78 GOTO1 ASEED,SEEDLVL                                                    
*                                                                               
PRCLVL80 CLI   MODE,PROCLEVD       LOWEST LEVEL                                 
         BE    PRCLVLX                                                          
         MVC   ADHEIRD,SVHEIRD     RESTORE                                      
         CLI   MODE,PROCLEVC       LEVEL THREE                                  
         BE    PRCLVLX                                                          
         MVC   ADHEIRC,SVHEIRC     RESTORE                                      
         CLI   MODE,PROCLEVB       LEVEL TWO                                    
         BE    PRCLVLX                                                          
         MVC   ADHEIRB,SVHEIRB     RESTORE                                      
*                                                                               
PRCLVLX  B     XITNEXT                                                          
         SPACE 1                                                                
SVADACC  DS    A                                                                
SVHEIRB  DS    A                                                                
SVHEIRC  DS    A                                                                
SVHEIRD  DS    A                                                                
         EJECT                                                                  
***********************************************************************         
*  ROUTINE FOR FILTERING ACCOUNTS AND PROCESS BUDGETS                 *         
***********************************************************************         
         SPACE 1                                                                
PRCA     MVI   FMTMODES,FMTPOST    Set it is ok to post, default                
         XC    #OFCAC,#OFCAC       # of office/contras                          
                                                                                
         USING COLD,R2                                                          
         TM    FMTPONCE,FMTPON     Set to post one per account                  
         BZ    PRCA120                                                          
         L     R2,FMTCOL           Clear for format per account                 
         SR    R0,R0                                                            
         IC    R0,FMT#COLS                                                      
         NI    COLIND3,TURNOFF-COLBYACT                                         
         AHI   R2,COLLNQ                                                        
         BCT   R0,*-8                                                           
         DROP  R2                                                               
                                                                                
PRCA120  TM    MODEIND,MODEONCE    Have we been though here ?                   
         BO    PRCA300             Yes                                          
         NI    FCIND,TURNOFF-FCIOKREV                                           
         CLI   QPROG,GENERAL                                                    
         JNE   PRCA122                                                          
         CLI   REVSIGN,YES                                                      
         JNE   PRCA122                                                          
         OI    FCIND,FCIOKREV      Set on to reverse                            
                                                                                
PRCA122  MVI   #OFOFF,0            Reset                                        
         BAS   RE,CLRCUR                                                        
         MVI   POIND,0             Purchase order indicator                     
         XC    #OFPO,#OFPO         Clear between jobs  (production)             
         XC    #OFEST,#OFEST                                                    
         XC    AELEM50T,AELEM50T                                                
         XC    AELEM77B(12),AELEM77B                                            
         XC    AELMTMS1(AELMTMSQ),AELMTMS1                                      
         XC    AELEM1A(AELEMQ),AELEM1A                                          
         MVC   CURSUBAC,SPACES     NO CURRENT SUBACCOUNT                        
*&&UK*&& MVC   CURMSTJB,SPACES     NO MASTER JOB                                
         MVC   DFTBLK1,SPACES      CLEAR FOR NEW TRANS. SET                     
         XC    DFTMMOS,DFTMMOS                                                  
         XC    DUEDTE,DUEDTE                                                    
         XC    TRANDTE,TRANDTE                                                  
         ZAP   TRNSTOT,PKZERO      Initialize trans. totals to zero             
         AP    #OFACNTS,PKONE                                                   
*&&US*&& XC    CURAPPR,CURAPPR                                                  
*&&US*&& XC    CURAPPRD,CURAPPRD                                                
*&&US*&& XC    CURSUBDT,CURSUBDT                                                
         L     RF,AXESGLB                                                       
         MVI   0(RF),X'FF'                                                      
*                                                                               
         USING ACMD,R2                                                          
         L     R2,AMONACC                                                       
         MVI   ACTIVITY,0          RESET TO NO ACTIVITY AT THIS POINT           
         MVC   FLTRS,ACMFLTS       SAVE FILTERS 1-5                             
         MVI   FLTNAMES,C' '                                                    
         MVC   FLTNAMES+1(L'FLTNAMES-1),FLTNAMES    CLEAR                       
         CLI   FCGTFILT,YES                                                     
         BNE   PRCA140                                                          
*                                                                               
         LA    R1,5                FIVE FILTER NAMES POSSIBLE                   
         LA    R2,FLTNAMES                                                      
         L     R3,FILTBLOC                                                      
         LA    R4,FLTRS                                                         
PRCA130  TM    DDLNKIND,DDLNKON    DDLINK on ?                                  
         BZ    PRCA136             No                                           
         CLI   0(R4),C' '          Any filter value ?                           
         BH    *+10                Yes                                          
         MVC   0(11,R2),=C'{No Filter}'                                         
*        MVCDD 0(L'FLTNAME1,R2),AC#NOFLT                                        
                                                                                
PRCA136  OC    0(16,R3),0(R3)      ANY NAME?                                    
         BZ    *+10                                                             
         MVC   0(L'FLTNAME1,R2),16(R3)                                          
         AHI   R2,L'FLTNAME1                                                    
         AHI   R3,60               BUMP TO NEXT IN BLOCK                        
         AHI   R4,1                                                             
         BCT   R1,PRCA130                                                       
*                                                                               
PRCA140  CLI   OFFTYPE,OFFTYKEY    Account                                      
         BE    PRCA148                                                          
         CLI   OFFTYPE,OFFTYFLT    Filter                                       
         BE    PRCA148                                                          
         CLI   OFFTYPE,OFFTYCLI    Client / Product / Job (UK only)             
         BNE   PRCA150                                                          
                                                                                
PRCA148  GOTOR PARSE,DMCB,GETOFFC,LMTSECOF,0                                    
                                                                                
         USING ACTRECD,R3                                                       
PRCA150  L     R3,ADACC            ACCOUNT RECORD                               
         MVC   CURACC,ACTKCPY                                                   
         MVC   CURWKCD,SPACES      MOVE IN WORK CODE                            
         BRAS  RE,FCREADSW         Set FCRDTRNS/FCRDTIME/FCRDHIST               
                                                                                
         XC    HIREDTE,HIREDTE                                                  
         MVC   TERMDTE,=X'FFFFFF'                                               
         MVC   CURTAX2C,SPACES                                                  
         MVC   CURTAX#,SPACES                                                   
         MVC   CURTAXTY,SPACES                                                  
         GOTOR ACCINFO,(R3)                                                     
         TM    RECREAD3,RECTAX2C                                                
         BZ    PRCA170                                                          
         CLC   =C'2C',ACTKUNT                                                   
         BE    PRCA170             Don't do since this is 2C                    
         LA    R3,IOKEY                                                         
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCULA,CURACC                                                  
         MVC   ACTKUNT(2),=C'2C'                                                
         L     R1,=AL4(IOREAD+IOACFIL+IOBUD)                                    
         GOTO1 AIO                                                              
         BNE   PRCA170                                                          
         L     R1,ABUDIO                                                        
         GOTOR ACCINFO                                                          
                                                                                
PRCA170  CLI   QPROG,PRODUCTION    Production                                   
         BNE   PRCA240                                                          
*&&US*&& GOTO1 =A(RDAUTH),0                                                     
                                                                                
PRCA180  TM    DATEFLT,DATECLS     FILTER JOB BY CLOSED DATE                    
         BZ    PRCA210                                                          
         GOTO1 PARSE,DMCB,GETJCLS,XCRDTE,0                                      
         B     PRCA212                                                          
*                                                                               
PRCA210  TM    DATEFLT,DATEOPN     FILTER JOB BY OPEN DATE                      
         BZ    PRCA212                                                          
         GOTO1 PARSE,DMCB,GETJOPN,XCRDTE,0                                      
*                                                                               
PRCA212  TM    RECREAD1,RECSTUD                                                 
         BZ    PRCA214                                                          
         GOTO1 =A(PSTUDIO)                                                      
*                                                                               
PRCA214  CLI   ESTIND,0            SET ESTIMATES IN TABLE FOR USE LATER         
         BE    PRCA216                                                          
         GOTO1 =A(PEST)                                                         
                                                                                
PRCA216  DS    0H                                                               
*&&UK                                                                           
         TM    RECREAD3,RECAEXRD   READ AEXRECD TO GET CLIENT POs               
         BZ    PRCA220                                                          
         GOTO1 =A(GETCPO)                                                       
*&&                                                                             
PRCA220  MVC   CURSJACC,ACTKACT    SET SJ ACCOUNT                               
         TM    ACTRSTAT,ACTSDRFT   DRAFT STATUS FOR JOB?                        
         BZ    *+8                                                              
         OI    ACCSTAT,ACCDJOB                                                  
         LR    R2,R3                                                            
         AH    R2,DATADISP                                                      
         SR    RF,RF                                                            
*                                                                               
PRCA221  CLI   0(R2),EOR           END OF RECORD                                
         BE    PRCA225                                                          
         CLI   0(R2),JOBELQ        X'26'                                        
         BE    PRCA222                                                          
*&&UK*&& CLI   0(R2),SPAELQ        X'2C' - SPECIAL POSTING A/C                  
*&&UK*&& BE    PRCA223                                                          
PRCA221A IC    RF,1(,R2)           BUMP TO NEXT ELEMENT                         
         AR    R2,RF                                                            
         B     PRCA221                                                          
*                                                                               
         USING JOBELD,R2                                                        
PRCA222  DS    0H                                                               
         TM    JOBSTA1,JOBSMCSE    TEST JOB IS ON MCS ESTIMATES                 
         BZ    *+8                                                              
         OI    ACCSTAT,ACCMCSE                                                  
         CLI   JOBLN,JOBLN3Q       CORRECT LENGTH                               
*&&UK*&& BNE   PRCA222A            NO                                           
*&&US*&& BL    PRCA222A            NO                                           
         TM    JOBSTA1,JOBSXJOB    STATUS = EXPENSE JOBS                        
         BZ    *+8                                                              
         OI    ACCSTAT,ACCXJOB                                                  
*&&UK                                                                           
         TM    JOBSTA2,JOBSMST     STATUS = MASTER JOB                          
         BZ    *+14                                                             
         MVC   CURMSTJB,CURSJACC                                                
         NI    CURMSTJB,X'FF'-X'40'                                             
*&&                                                                             
PRCA222A DS    0H                                                               
*&&UK*&& B     PRCA221A                                                         
*&&US*&& B     PRCA225                                                          
         DROP  R2                                                               
*&&UK                                                                           
         USING SPAELD,R2                                                        
PRCA223  DS    0H                                                               
         CLI   SPATYPE,SPATMJOB    Master job?                                  
         BNE   PRCA221A                                                         
         MVC   CURMSTJB,SPAAACT                                                 
         B     PRCA221A                                                         
         DROP  R2                                                               
*&&                                                                             
PRCA225  CLI   FCJOBBER,0          Sort and adjust Jobber, values will          
         BE    PRCA227               be doubled otherwise                       
         GOTO1 =A(ADJJOBR)                                                      
*                                                                               
         USING ACGOD,R2                                                         
         USING ACXGOD,R4                                                        
PRCA227  L     R2,ADGOBLOC         A(GOBLOCK)                                   
         L     R4,AGOXBLK          A(EXTENDED GOBLOCK)                          
         MVC   CUROFF,SPACES                                                    
         NI    CURIND,TURNOFF-(CURICP+CURBILPD+CURINCHG+CURRETL)                
         CLI   GOINTPST,YES                                                     
         BNE   *+8                                                              
         OI    CURIND,CURICP       INTERCOMPANY POSTINGS                        
         MVC   CURSTTY,SPACES                                                   
         GOTO1 PARSE,DMCB,GETOFFC,CUROFF,0                                      
         GOTO1 PARSE,DMCB,GETSTTY,CURSTTY                                       
         DROP  R2                                                               
*                                                                               
         USING ACMD,R3                                                          
         USING JXCEPTD,R4                                                       
         CLI   AFLTEXCR,0          ANY FILTERING?                               
         BE    PRCA240             NO                                           
         L     R3,AMONACC                                                       
         L     R4,AJXBLOCK                                                      
         MVI   JXMODE,JXMREAD+JXMWORKD                                          
         MVC   JXAREC,ADACC                                                     
         MVC   JXAJBBLK,ACMAJOBB   A(JOBBER BLOCK)                              
         MVC   JXAGOBLK,ADGOBLOC   A(GOBLOCK)                                   
         ST    RC,JXACWORK         A(ACWORKD)                                   
         L     RE,ACMACOL          R2=A(COLUMN TABLE FOR JOBBER)                
         ST    RE,JOBRBLK                                                       
         TM    ACCSTAT,ACCMCSE                                                  
         BNZ   PRCA230                                                          
         AHI   RE,JBCOLV1R-JBCOLD                                               
         ZIC   RF,JBCV#CE          Get  JBCOLV1R num    for CE                  
         BCTR  RF,0                Get  JBCOLV1R offset for CE                  
         MHI   RF,L'JBCOLV1R                                                    
         AR    RF,RE                                                            
         ZAP   JXEST,0(L'JBCOLV1R,RF)   Estimate                                
*                                                                               
         ZIC   RF,JBCV#CEG         Get  JBCOLVAL num    for CEG                 
         BCTR  RF,0                Get  JBCOLVAL offset for CEG                 
         MHI   RF,L'JBCOLV1R                                                    
         AR    RF,RE                                                            
         ZAP   JXGEST,0(L'JBCOLV1R,RF)  Gross estimate                          
         ZAP   JXBIGBAL,PKZERO                                                  
*&&US                                                                           
         ZIC   RF,JBCV#HR          Get  JBCOLVAL num    for HR                  
         BCTR  RF,0                Get  JBCOLVAL offset for HR                  
         MHI   RF,L'JBCOLV1R                                                    
         AR    RF,RE                                                            
         ZAP   JXHREST,0(L'JBCOLV1R,RF) Highest Revision estimate               
*&&                                                                             
*&&UK*&& XC    JXHREST,JXHREST     HR estimate is not supported                 
         B     PRCA235                                                          
                                                                                
PRCA230  DS    0H                                                               
         L     RE,ACMACOL          R2=A(COLUMN TABLE FOR JOBBER)                
         ST    RE,JOBRBLK                                                       
         AHI   RE,MJETVAL-MJETABD                                               
         XR    RF,RF                                                            
         IC    RF,JBCV#CE          Get  JBCOLV1R num    for CE                  
         BCTR  RF,0                Get  JBCOLV1R offset for CE                  
         MHI   RF,L'MJETVAL                                                     
         AR    RF,RE                                                            
         ZAP   JXEST,0(L'MJETVAL,RF)                                            
*                                                                               
         XR    RF,RF                                                            
         IC    RF,JBCV#CEG         Get  JBCOLVAL num    for CEG                 
         BCTR  RF,0                Get  JBCOLVAL offset for CEG                 
         MHI   RF,L'MJETVAL                                                     
         AR    RF,RE                                                            
         ZAP   JXGEST,0(L'MJETVAL,RF)                                           
         ZAP   JXBIGBAL,PKZERO                                                  
*&&US                                                                           
         XR    RF,RF                                                            
         IC    RF,JBCV#HR          Get  JBCOLVAL num    for HR                  
         BCTR  RF,0                Get  JBCOLVAL offset for HR                  
         MHI   RF,L'MJETVAL                                                     
         AR    RF,RE                                                            
         ZAP   JXHREST,0(L'MJETVAL,RF)                                          
*&&                                                                             
*&&UK*&& XC    JXHREST,JXHREST     HR estimate is not supported                 
                                                                                
PRCA235  GOTO1 JOBEXCP,DMCB,(R4)                                                
         DROP  R3,R4                                                            
*---------------------------------------------------------------------*         
* Post amounts at this level FUND, AUTH, CRLMT, ICRLMT                          
*---------------------------------------------------------------------*         
         USING COLD,R2                                                          
         USING KYWD,R6                                                          
PRCA240  TM    FMTFLAG2,FMTALVL$   Post amounts to COLUMN                       
         BZ    PRCA250                                                          
         L     R2,FMTCOL                                                        
         LLC   R0,FMT#COLS                                                      
PRCA242  TM    COLIND3,COLALVL$    Get data for this column ?                   
         BZ    PRCA246             No                                           
         TM    COLFLAGS,COLAMT                                                  
         BZ    PRCA246             Double check to make sure amount             
         L     R6,COLINDEX         Load A(Keyword)                              
         SR    RE,RE                                                            
         ICM   RE,3,KYWPRSE        Load A(Parse entry)                          
         BZ    PRCA246             No entry so next column                      
         ST    R2,ACURCOL          Used in processing parse entries             
         A     RE,PRSBASE                                                       
         ZAP   COLDUB,PKZERO                   Clear                            
         GOTO1 PARSE,DMCB,(RE),PACKAMT,0,0                                      
         BNE    *+10                           No data                          
         ZAP   COLDUB,PACKAMT      Put amount in column table                   
*                                                                               
PRCA246  AHI   R2,COLLNQ           Next column                                  
         BCT   R0,PRCA242          Loop                                         
         DROP  R2,R6                                                            
*                                                                               
PRCA250  CLI   QPROG,MANPOWER                                                   
         BNE   PRCA300                                                          
         TM    REQIND,REQCMTH      CHANGE DATES                                 
         BZ    PRCA255                                                          
         GOTO1 =A(SETCNDR)                                                      
*                                                                               
         USING LDGD,R3                                                          
PRCA255  GOTO1 GETLDGR,DMCB,=C'1R'                                              
         L     R3,DMCB             GET ENTERY                                   
***********************************************************************         
*  ROUTINE TO PROCESS A PERSON'S LOCATION                             *         
***********************************************************************         
                                                                                
         USING PERRECD,R2                                                       
         XC    AELEM83,AELEM83                                                  
         MVI   PRSNSTAT,X'FE'      SET TO UNKNOWN STATUS                        
         LA    R2,IOKEY                                                         
         MVC   PERKEY,SPACES                                                    
         MVI   PERKTYP,PERKTYPQ    X'0F'                                        
         MVC   PERKCPY,CURACC      COMPANY CODE                                 
         SR    RF,RF                                                            
         IC    RF,LDGLEV3                                                       
         LA    RE,CURACC+3(RF)     POINT TO PERSON CODE                         
         SR    R1,R1                                                            
         IC    R1,LDGLVQ4          LENGTH OF LEVEL ALONE                        
         BCTR  R1,0                                                             
         EXMVC R1,PERKCODE,0(RE)   MOVE IN PART OF ACCOUNT                      
*                                                                               
         L     R2,ABUDIO                                                        
         L     R1,=AL4(IOBUD+IOREAD+IOACFIL)                                    
         GOTO1 AIO                                                              
         LH    R1,DATADISP         DEFAULT TO JUST KEY FOR NO RECORD            
         BNE   PRCA256             NONE FOUND                                   
         SR    R1,R1                                                            
         ICM   R1,3,PERRLEN        LENGTH OF RECORD                             
*                                                                               
PRCA256  L     R0,ABUDIO                                                        
         L     RE,APRSNWRK         MOVE RECORD TO PERSON WORK AREA              
         LA    RF,2*K              IO LENGTH                                    
         MVCL  RE,R0                                                            
         L     R2,APRSNWRK                                                      
         AH    R2,DATADISP                                                      
*                                                                               
         USING EMPELD,R2                                                        
         CLI   0(R2),0             NO ELEMENTS AT ALL                           
         BNE   PRCA257                                                          
         MVI   EMPEL,EMPELQ        X'56' BUILD DUMMY ELEMENT                    
         MVI   EMPLN,EMPLNQ                                                     
         MVC   EMPTRM,TERMDTE                                                   
         MVC   EMPHIR,HIREDTE                                                   
*                                                                               
         SR    R1,R1                                                            
PRCA257  CLI   0(R2),EOR           EOR ?                                        
         BE    PRCA270             Yes so finished for now                      
         CLI   0(R2),EMPELQ        X'56' Employee history element ?             
         BNE   PRCA258             No                                           
         OC    EMPTRM,EMPTRM                                                    
         BNZ   *+10                                                             
         MVC   EMPTRM,=X'FFFFFF'                                                
         MVC   HIREDTE,EMPHIR      SAVE OFF -> HIRE        DATE                 
         MVC   TERMDTE,EMPTRM      SAVE OFF -> TERMINATION DATE                 
*                                                                               
         USING LOCELD,R2                                                        
PRCA258  CLI   0(R2),LOCELQ        X'83' Location(s) element                    
         BNE   PRCA265             No                                           
         IC    R1,LDGLVQ1          Compare office code                          
         LA    RE,CURACC+3                                                      
         BCTR  R1,0                                                             
         EXCLC R1,LOCOFF,0(RE)                                                  
         BNE   PRCA264                                                          
*                                                                               
         LA    RE,1(R1,RE)         Point to 2nd level                           
         IC    R1,LDGLVQ2          Compare department                           
         BCTR  R1,0                                                             
         EXCLC R1,LOCDEPT,0(RE)                                                 
         BNE   PRCA264                                                          
*                                                                               
         LA    RE,1(R1,RE)         Point to 3rd level                           
         IC    R1,LDGLVQ3          Compare sub-department                       
         BCTR  R1,0                                                             
         EXCLC R1,LOCSUB,0(RE)                                                  
         BNE   PRCA264                                                          
*                                                                               
         OC    LOCEND,LOCEND       Fix up end date                              
         BNZ   *+10                                                             
         MVC   LOCEND,=X'FFFFFF'                                                
*                                                                               
         CLI   REQLOCST,X'FF'      Filtering location status ?                  
         BE    PRCA262             No                                           
         TM    LOCSTAT2,LOCSDUP    If duplicate delete/ignore                   
         BO    PRCA264                                                          
*                                                                               
PRCA262  OC    AELEM83,AELEM83     Did we save one yet ?                        
         BNZ   PRCA265             Yes                                          
         ST    R2,AELEM83          No, Save off first location element          
         MVC   PRSNSTAT,LOCSTAT    Set current status                           
         B     PRCA265                                                          
*                                                                               
PRCA264  MVI   LOCEL,X'FF'         Mark deleted                                 
*                                                                               
PRCA265  LLC   RF,LOCLN            Next element                                 
         AR    R2,RF                                                            
         B     PRCA257                                                          
*                                                                               
         USING COSTWKD,R4                                                       
PRCA270  L     R4,ACOSTBLK                                                      
         MVC   CSTKEY1R,CURACC                                                  
         TM    RECREAD1,RECSTDH                                                 
         BZ    PRCA274                                                          
         MVI   CSTMODE,CSTSTD      GET STANDARD HOURS                           
         GOTO1 =V(PERFACT),DMCB,(R4)                                            
*                                                                               
PRCA274  TM    RECREAD1,RECEDTH                                                 
         BZ    PRCA280                                                          
         MVI   CSTMODE,CSTEDT      Get edit hours                               
         GOTO1 =V(PERFACT),DMCB,(R4)                                            
*                                                                               
PRCA280  TM    RECREAD2,RECTHRS                                                 
         BZ    PRCA300                                                          
         GOTO1 TOTLHRS                                                          
*                                                                               
         USING RSTELD,R2                                                        
PRCA300  GOTOR TSTDTES             Test date filtering                          
         BNE   XITNOACC                                                         
         BAS   RE,TSTFLTS          Test filter values for recap                 
         BNE   XITNOACC                                                         
*                                                                               
* Not ready for Limlist code yet                                                
*                                                                               
*        TM    DDLNKIND,DDLNKQKR   Just for QuickReports for now                
*        BZ    PRCA308                                                          
*        MVI   BYTE,01             Manpower filtering on 1R acc                 
*        CLI   QPROG,MANPOWER                                                   
*        BE    *+16                                                             
*        CLI   QPROG,PRODUCTION                                                 
*        BNE   PRCA308                                                          
*        MVI   BYTE,03             Production filtering on SJ Client            
*        TM    DDLNKIND,DDLNKON    For regular scribe reports don't             
*        BO    PRCA302             Call secret if there is no rfhdr             
*        TM    DDLNKIND,DDLNKQKR   info set b/c it will die                     
*        BO    PRCA302                                                          
*        USING MASTD,RF                                                         
*        L     RF,ADMASTC                                                       
*        OC    MCRFHDR,MCRFHDR                                                  
*        BZ    PRCA304                                                          
*                                                                               
*RCA302  BRAS  RE,RPTSEC                                                        
*        BE    PRCA308             If = then overriding the limlist             
*RCA304  GOTO1 ARDLML                                                           
*        BNE   XITNOACC                                                         
*        CLI   QPROG,MANPOWER      If Manpower then done                        
*        BE    PRCA308                                                          
*        MVI   BYTE,04                                                          
*        GOTO1 ARDLML              Production filtering on media                
*        BNE   XITNOACC                                                         
*                                                                               
*                                                                               
PRCA308  CLI   QPROG,EXPENSE                                                    
         BNE   PRCA310                                                          
         LA    RE,PRCA310                                                       
         TM    FMTROPT3,RPFOADPT+RPFOASTF      ONLY TYPE SWITCH                 
         BZ    *+8                                                              
         LA    RE,XITNOTRS                                                      
         ICM   R2,15,ADACCSTA      LOAD LOWEST LEVEL STATUS ELEMENT             
         BZR   RE                                                               
*                                                                               
         TM    RSTSTAT1,RSTSEADD   DEPARTMENT=Y                                 
         BO    *+12                                                             
         TM    FMTROPT3,RPFOADPT   ONLY                                         
         B     *+8                                                              
         TM    FMTROPT3,RPFXADPT   EXCLUDE                                      
         BO    XITNOACC            NO ACCOUNT FOR FORMAT                        
*                                                                               
         TM    RSTSTAT1,RSTSGPEI   STAFF=Y                                      
         BO    *+12                                                             
         TM    FMTROPT3,RPFOASTF   ONLY                                         
         B     *+8                                                              
         TM    FMTROPT3,RPFXASTF   EXCLUDE                                      
         BO    XITNOACC                                                         
*                                                                               
         CLI   ANALFLT,YES         COST=Y, ANALYSIS BY CLIENT?                  
         BE    *+12                YES                                          
         TM    FMTROPT3,RPFOACLI   ONLY                                         
         B     *+8                                                              
         TM    FMTROPT3,RPFXACLI   EXCLUDE                                      
         BO    XITNOACC                                                         
*                                                                               
PRCA310  DS    0H                                                               
*&&UK                                                                           
         MVI   CURJLOCK,0                                                       
         CLI   QPROG,PRODUCTION                                                 
         BNE   PRCA310C                                                         
         CLC   CURMSTJB,SPACES     Is it a sub-job                              
         BH    PRCA310A                                                         
         TM    FMTROPT8,RPFOSUBJ   ONLY                                         
         BO    XITNOACC                                                         
         B     PRCA310B                                                         
*                                                                               
PRCA310A TM    CURMSTJB,X'40'                                                   
         BNO   *+12                                                             
         TM    FMTROPT9,RPFXSUBJ   EXCLUDE                                      
         BO    XITNOACC                                                         
         OC    CURMSTJB,SPACES                                                  
*                                                                               
PRCA310B LA    RE,PRCA310C                                                      
         TM    FMTROPT8,RPFOJLES+RPFOJLOR+RPFOJLBI+RPFOJLTI+RPFOJLAD+RPX        
               FOJLEX              ONLY TYPE SWITCH                             
         BZ    *+8                                                              
         LA    RE,XITNOTRS                                                      
         ICM   R2,15,ADACCSTA      LOAD LOWEST LEVEL STATUS ELEMENT             
         BZR   RE                                                               
         CLI   RSTLN,RSTLN3Q                                                    
         BLR   RE                                                               
*                                                                               
         MVC   CURJLOCK,RSTLSTAT   SAVE JOB LOCK STATUS                         
         CLI   RSTLSTAT,0                                                       
         BE    *+8                                                              
         OI    CURJLOCK,CURJLANQ   SET LOCKED FROM ANY APPLICATIONS             
*                                  EXPANDED JOB LOCK STATUS                     
         TM    RSTLSTAT,RSTLSESQ   - LOCKED FROM ESTIMATES                      
         BO    *+12                                                             
         TM    FMTROPT8,RPFOJLES   ONLY                                         
         B     *+8                                                              
         TM    FMTROPT9,RPFXJLES   EXCLUDE                                      
         BO    XITNOACC                                                         
*                                                                               
         TM    RSTLSTAT,RSTLSORQ   - LOCKED FROM ORDERS                         
         BO    *+12                                                             
         TM    FMTROPT8,RPFOJLOR   ONLY                                         
         B     *+8                                                              
         TM    FMTROPT9,RPFXJLOR   EXCLUDE                                      
         BO    XITNOACC                                                         
*                                                                               
         TM    RSTLSTAT,RSTLSBIQ   - LOCKED FROM BILLING                        
         BO    *+12                                                             
         TM    FMTROPT8,RPFOJLBI   ONLY                                         
         B     *+8                                                              
         TM    FMTROPT9,RPFXJLBI   EXCLUDE                                      
         BO    XITNOACC                                                         
*                                                                               
         TM    RSTLSTAT,RSTLSTIQ   - LOCKED FROM TIMESHEETS                     
         BO    *+12                                                             
         TM    FMTROPT8,RPFOJLTI   ONLY                                         
         B     *+8                                                              
         TM    FMTROPT9,RPFXJLTI   EXCLUDE                                      
         BO    XITNOACC                                                         
*                                                                               
         TM    RSTLSTAT,RSTLSADQ   - LOCKED FROM ADJUSTMENTS                    
         BO    *+12                                                             
         TM    FMTROPT8,RPFOJLAD   ONLY                                         
         B     *+8                                                              
         TM    FMTROPT9,RPFXJLAD   EXCLUDE                                      
         BO    XITNOACC                                                         
*                                                                               
         TM    RSTLSTAT,RSTLSEXQ   - LOCKED FROM 3rd Party                      
         BO    *+12                                                             
         TM    FMTROPT8,RPFOJLEX   ONLY                                         
         B     *+8                                                              
         TM    FMTROPT9,RPFXJLEX   EXCLUDE                                      
         BO    XITNOACC                                                         
*&&                                                                             
PRCA310C BRAS  RE,ACSTATUS                                                      
         BNE   XITNOACC                                                         
*                                                                               
         CLI   QPROG,MANPOWER                                                   
         BNE   PRCA311                                                          
         GOTO1 AFILTER,DMCB,AFLTOFF,CUROFF                                      
         BNE   XITNOTRS                                                         
*                                                                               
PRCA311  TM    FMTROPT,RPFBALDR+RPFBALCR+RPFBALO+RPFBALZR                       
         BZ    PRCA316                                                          
         ZAP   ACCBAL,PKZERO                                                    
         CLI   QPROG,PRODUCTION                                                 
         BNE   PRCA312                                                          
         CLC   RMOAEND,=X'FFFF'    ONLY DO IF MOA REQUESTED                     
         BE    PRCA312                                                          
         GOTO1 =A(GETBBAL)         GET BUCKET BALANCE                           
*                                                                               
PRCA312  SR    R1,R1               NO BRANCHING                                 
         TM    FMTROPT,RPFBALDR                                                 
         BZ    *+8                                                              
         LA    R1,BNP              IF DEBIT BALANCE (ZERO OR MINUS)             
         TM    FMTROPT,RPFBALCR                                                 
         BZ    PRCA313                                                          
         LA    R1,BNP              IF DEBIT BALANCE (ZERO OR PLUS)              
         CLI   QPROG,PAYABLES      REVERSED IF PAYABLES                         
         BE    PRCA313                                                          
         LA    R1,BNM              IF CREDIT BALANCE (ZERO OR PLUS)             
*                                                                               
PRCA313  CLI   QPROG,PRODUCTION                                                 
         BNE   PRCA314                                                          
         TM    FMTROPT,RPFBALO     OPTION DIFFERENT FOR RCV                     
         BZ    *+8                                                              
         LA    R1,BE               IF CREDIT/DEBIT BALANCE                      
         TM    FMTROPT,RPFBALZR    OPTION DIFFERENT FOR RCV                     
         BZ    *+8                                                              
         LA    R1,BNE              IF ZERO BALANCE                              
         CLC   RMOAEND,=X'FFFF'    WAS MOA DATE REQUESTED ?                     
         BNE   PRCA315             YES, SO USE BAL FROM GETBBAL                 
*                                                                               
         USING ABLELD,R2                                                        
PRCA314  ICM   R2,15,ADACCBAL                                                   
         BZ    PRCA315             NO BALANCE, ASSUME ZERO                      
         ZAP   ACCBAL,ABLFRWD      BALANCE FORWARD                              
         AP    ACCBAL,ABLDR        DEBITS                                       
         SP    ACCBAL,ABLCR        CREDITS                                      
         DROP  R2                                                               
*                                                                               
PRCA315  CP    ACCBAL,PKZERO                                                    
         EX    R1,*+8              TEST THIS OPTION?                            
         NOP   PRCA315             (*+4 -> *+8)                                 
         NOP   XITNOACC                                                         
***********************************************************************         
*  THESE FILTERS ARE AT JOB LEVEL OR ACCOUNT LEVEL                    *         
***********************************************************************         
         SPACE 1                                                                
PRCA316  GOTO1 AFILTER,DMCB,AFLTACC,CURACC+1                                    
         BNE   XITNOACC                                                         
*                                                                               
         USING UFSELD,R2                                                        
         CLI   QPROG,PRODUCTION                                                 
         BNE   PRCA350                                                          
*&&US                                                                           
         TM    FMTROPT6,RPFAUTHE   Non-status only ?                            
         BZ    PRCA317             No                                           
         CLI   AUTHSTAT,C' '       Yes, so is there a status ?                  
         BE    PRCA119             No, so keep                                  
         B     XITNOACC                                                         
*                                                                               
PRCA317  TM    FMTROPT6,RPFAUTHA   Active only ?                                
         BZ    PRCA318             Yes                                          
         CLI   AUTHSTAT,C'A'       Active status ?                              
         BE    PRCA119                                                          
         TM    FMTROPT6,RPFAUTHI   Both inactive and active ?                   
         BZ    XITNOACC            No, only want active                         
*                                                                               
PRCA318  TM    FMTROPT6,RPFAUTHI    In-active only ?                            
         BZ    PRCA119                                                          
         CLI   AUTHSTAT,C'I'       Active status ?                              
         BNE   XITNOACC                                                         
*&&                                                                             
PRCA119  CLI   AFLTUFLD,0          Any filtering ?                              
         BE    PRCA325             No                                           
         L     R2,ADACC            Job record                                   
         AH    R2,DATADISP                                                      
PRCA320  CLI   0(R2),0                                                          
         BE    XITNOACC            No transactions please                       
         CLI   0(R2),UFSELQ        X'A2' User field element                     
         BNE   PRCA322                                                          
         GOTO1 AFILTER,DMCB,AFLTUFLD,UFSCODE                                    
         BE    PRCA325             This one ok                                  
PRCA322  SR    R1,R1                                                            
         IC    R1,UFSLN                                                         
         AR    R2,R1                                                            
         B     PRCA320                                                          
*                                                                               
         USING ACGOD,R2                                                         
         USING ACXGOD,R4                                                        
PRCA325  L     R2,ADGOBLOC         A(GOBLOCK)                                   
         L     R4,AGOXBLK          A(EXTENDED GOBLOCK)                          
         GOTO1 AFILTER,DMCB,AFLTOFF,CUROFF                                      
         BNE   XITNOACC            NO ACCOUNT FOR THIS FORMAT                   
         GOTO1 AFILTER,DMCB,AFLTOFGP,GOEFFOG                                    
         BNE   XITNOACC                                                         
         GOTO1 AFILTER,DMCB,AFLTMDGP,GOEFFMG                                    
         BNE   XITNOACC                                                         
         GOTO1 AFILTER,DMCB,AFLTMEDA,GOEFFMED                                   
         BNE   XITNOACC                                                         
         GOTO1 AFILTER,DMCB,AFLTSTTY,CURSTTY                                    
         BNE   XITNOACC                                                         
*&&US                                                                           
         TM    RECREAD2,REC99WC    Pre-read billing, 99 trans                   
         BZ    PRCA326                                                          
         GOTO1 =A(BILLDATA)                                                     
*&&                                                                             
PRCA326  CLI   FCJOBBER,0          Check estimate activity                      
         BE    PRCA330             NO                                           
         GOTO1 ESTSTAT                                                          
         BNE   XITNOTRS                                                         
*                                                                               
*                                                                               
         USING JXCEPTD,R4                                                       
         USING JXMSGD,R2                                                        
PRCA330  CLI   AFLTEXCR,0          ANY FILTERING?                               
         BE    PRCA350             NO                                           
         L     R4,AJXBLOCK                                                      
         SR    R0,R0                                                            
         ICM   R0,1,JXNCODES       NUMBER OF CODES RETURNED                     
         BZ    XITNOTRS            ONLY WANT ONES WITH EXCEPTIONS               
         LA    R3,JXCODES          LIST OF EXECPTIONS                           
         MVI   JXMODE,JXMLIT+JXMWORKD                                           
         ST    RC,JXACWORK         A(ACWORKD)                                   
         MVI   EXCPSORT,X'FF'                                                   
         XC    CUREXCP,CUREXCP                                                  
         XC    FLTEXCP,FLTEXCP                                                  
         MVC   OLDMOS,JXOLDMOS                                                  
*                                                                               
PRCA332  MVC   JXCODE,0(R3)                                                     
         GOTO1 JOBEXCP,DMCB,(R4)                                                
         ICM   R2,15,JXALIT        ENTRY ADDRESS IN TABLE                       
         BNZ   *+6                                                              
         DC    H'00'                                                            
*                                                                               
         SR    RF,RF                                                            
         IC    RF,JXMSEQ           SEQUENCE #                                   
         BCTR  RF,0                IS USED AS SHIFT FACTOR                      
         LA    R6,1                SET ON A BIT MAP                             
         SLL   R6,0(RF)            SHIFT TO CORRECT POSITION                    
         ICM   RF,15,CUREXCP       CURRENT EXCEPTION IN BIT TABLE               
         OR    RF,R6                                                            
         STCM  RF,15,CUREXCP                                                    
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,NEXPCDES       NUMBER OF EXCEPTION CODES IN FILTER          
         BZ    PRCA338                                                          
         L     RE,AFLTEXCR         LIST OF CODES TO FILTER                      
PRCA334  CLC   1(1,RE),0(R3)       MATCH FILTER WITH LIST                       
         BE    PRCA336                                                          
         LA    RE,2(,RE)           BUMP TO NEXT FILTER ENTRY                    
         BCT   RF,PRCA334                                                       
         B     PRCA338             FINISHED THIS ROUND                          
*                                                                               
PRCA336  ICM   RE,15,FLTEXCP       FILTERED EXCEPTION BIT TABLE                 
         OR    RE,R6                                                            
         STCM  RE,15,FLTEXCP                                                    
         SR    RE,RE                                                            
         IC    RE,NEXPCDES                                                      
         SR    RE,RF               REVERES THE ORDER                            
         AHI   RE,1                                                             
         CLM   RE,1,EXCPSORT                                                    
         BNL   PRCA338                                                          
         STC   RE,EXCPSORT         SAVE HIGHEST PRIORITY                        
PRCA338  LA    R3,2(,R3)           BUMP TO NEXT IN LIST                         
         BCT   R0,PRCA332                                                       
*                                                                               
         CLI   AFLTEXCR,X'FF'      IF NO FILTERS SET UP DON'T CHECK             
         BE    PRCA350             FOR EXCULSION                                
         OC    FLTEXCP,FLTEXCP                                                  
         BZ    XITNOTRS                                                         
         DROP  R2,R4                                                            
*                                                                               
PRCA350  TM    FMTROPT5,RPFISVTM+RPFOSVTM                                       
         BZ    PRCA360                                                          
         GOTO1 ASVD2TMS            SEE IT SAVED ITEMS?                          
*                                                                               
PRCA360  TM    RECREAD1,RECPRSN    LOCATION DATA NEEDED?                        
         BZ    PRCA370                                                          
         TM    POSTLVL,POSTACC                                                  
         BZ    PRCA370                                                          
         GOTO1 LOCATION                                                         
*                                                                               
PRCA370  TM    GHISIND,GHISON      Payroll history needed ?                     
         BZ    PRCA385             No                                           
         GOTO1 PAYROLL                                                          
         GOTO1 ACOLPAYR                                                         
*                                                                               
PRCA385  TM    RECREAD1,RECSTDH+RECEDTH                                         
         BZ    PRCA400                                                          
         BRAS  RE,SETHRS                                                        
*        GOTO1 ASEED,SEEDHRS                                                    
*                                                                               
PRCA400  CLI   QPROG,MANPOWER                                                   
         BNE   PRCA500                                                          
         TM    FMTSPKYW,FMTKPEFD   Personal effective date used ?               
         BZ    PRCA402             No                                           
         GOTO1 ASEED,SEEDPEDT      Yes                                          
*                                                                               
PRCA402  TM    MODEIND,MODEPASS    Did we ever pass through here ?              
         BO    PRCA420             Yes                                          
         TM    RECREAD2,RECALO$+RECALRT                                         
         BZ    PRCA420                                                          
         GOTO1 ARATE               Allocated rates setup                        
*                                                                               
PRCA420  TM    FMTPOPT3,RPFTEDIT   Time sheet edit ?                            
         BZ    PRCA500             No                                           
         GOTO1 ASEED,SEEDACC                                                    
         GOTO1 ASEED,SEED1N                                                     
*        GOTO1 ASEED,SEEDCLI                                                    
*                                                                               
PRCA500  TM    FMTFLAG2,FMTALVL$   Account level amounts to post ?              
         BZ    PRCA505             No                                           
         GOTO1 ASEED,SEEDACC                                                    
*                                                                               
PRCA505  TM    RECREAD1,RECPEEL    GET PEELED DATA AMOUNTS ?                    
         BZ    PRCA510                                                          
         CLI   NEWOFF,YES          2 CHARACTER OFFICE ?                         
         BE    PRCA510             YES, SO PROCESS IN PROCOFA                   
         GOTO1 ASEED,SEEDBFW       SEED BALANCE FORWARD (PEEL $ BY OFF)         
*                                                                               
PRCA510  TM    FMTIND2,FMTBUDOK    Process the budgets now                      
         BZ    PRCA512                                                          
         GOTO1 BUDGETS                                                          
*                                                                               
PRCA512  TM    RECREAD2,RECPRCV    CashFlow Prod Receivable Keywords?           
         BZ    PRCA515              No                                          
         L     RE,CFWBASE           yes, reset cashflow buffer                  
         L     RF,=A(RATEQ)                                                     
         SR    R0,R0                                                            
         SR    R1,R1                                                            
         MVCL  RE,R0                                                            
*                                                                               
PRCA515  MVC   PREVACT,CURACC                                                   
         OI    MODEIND,MODEPASS    PASSED THROUGH ALL TEST AT LEAST 1X          
         CLI   FCRDTRNS,YES                                                     
         BE    XITNEXT                                                          
         CLI   FCRDHIST,YES                                                     
         BE    XITNEXT                                                          
         B     ACCLST                                                           
         EJECT                                                                  
*=====================================================================*         
*  Routine to filter F1-F5 based on recap values                      *         
*=====================================================================*         
                                                                                
TSTFLTS  ST    RE,SVRE                                                          
         LA    R0,5                Work backwards F5 down to F1                 
         LA    R1,FMTF5                                                         
         LA    RE,FLTR5                                                         
*                                                                               
TSTFLT10 CLI   0(R1),C' '          No filter value to test                      
         BE    TSTFLT50            Next filter                                  
         CLI   0(R1),0             No filter value to test                      
         BE    TSTFLT50                                                         
         LA    RF,BNE              If not the same then don't want              
         MVC   BYTE,0(R1)                                                       
         OI    BYTE,X'40'                                                       
         TM    0(R1),X'40'                                                      
         BO    *+8                                                              
         LA    RF,BE               If the same then don't want account          
                                                                                
         CLC   BYTE,0(RE)          Do the filters match ?                       
*        CLC   0(1,R1),0(RE)       Do the filters match ?                       
*        EX    RF,*+6                                                           
*        NOPR  0                                                                
*        BC    0,TSTFLTNO          Exit <> to stop processing account           
         EX    RF,*+8                                                           
         NOP   TSTFLT10            (*+4 -> *+8)                                 
         NOP   TSTFLTNO            Exit <> to stop processing account           
*                                                                               
TSTFLT50 BCTR  R1,0                Next in FMTF#                                
         BCTR  RE,0                Next in FLTR#                                
         BCT   R0,TSTFLT10                                                      
*                                                                               
TSTFLTNO L     RE,SVRE                                                          
         LTR   R0,R0               If all pass then ok                          
         BR    RE                                                               
         EJECT ,                                                                
***********************************************************************         
*  ROUTINE TO PROCESS CONTRA                                          *         
***********************************************************************         
         USING OFARECD,R2                                                       
         USING ACMD,R4                                                          
PRCOFA   L     R4,AMONACC                                                       
         L     R2,ACMAOFA                                                       
         ST    R2,AOFFACC          Office account record                        
         TM    FCIND,FCNEWGL       New GL                                       
         BO    PRCOFA10            Yes, don't bother then                       
         CLI   NEWOFF,YES                                                       
         BNE   *+10                                                             
         MVC   LMTSECOF,OFAKOFF    Set limited access office                    
         GOTO1 ASEED,SEEDBFW       Seed BALANCE FORWARD (PEEL $ BY OFF)         
                                                                                
PRCOFA10 TM    MODEIND,MODEONCE    Have we been though here ?                   
         BO    PRCOFXIT            Yes                                          
*&&DO                                                                           
         L     R6,=A(LSTOFOFF)                                                  
         ZIC   R1,#OFOFF                                                        
         SLL   R1,1                Multiply by 2                                
         AR    R6,R1                                                            
         MVC   0(2,R6),OFAKOFF                                                  
         SRL   R1,1                Divide   by 2                                
         AHI   R1,1                                                             
         STC   R1,#OFOFF                                                        
*&&                                                                             
PRCOFXIT B     XITNEXT                                                          
         DROP  R2,R4                                                            
         EJECT ,                                                                
***********************************************************************         
*  ROUTINE TO PROCESS CONTRA                                          *         
***********************************************************************         
         SPACE 1                                                                
         USING CACRECD,R2                                                       
PRCSBA   L     R2,ADSUBAC                                                       
         TM    UPSI,X'40'                                                       
         BZ    *+8                                                              
         BRAS  RE,XDUMP                                                         
                                                                                
         TM    MODEIND,MODEONCE                                                 
         BO    PRCSB20                                                          
         MVC   CURSUBAC,CACKCULC   MOVE IN CONTRA                               
         XC    AELMTMS1(AELMTMSQ),AELMTMS1                                      
         CLI   QPROG,PNL           Fix because of 1C off/contra bucks           
         BNE   PRCSB04                                                          
         CLC   CACKOFF,SPACES                                                   
         BH    XITMODE                                                          
                                                                                
PRCSB04  BRAS  RE,FCREADSW         Set FCRDTRNS/FCRDTIME/FCRDHIST               
         GOTOR SETCNTR,DMCB,CURSUBAC+1                                          
                                                                                
PRCSB06  DS    0H                                                               
         CLI   QPROG,GENERAL       General ledger          (GB/GP)              
         BE    PRCSB20                                                          
         CLI   QPROG,MANPOWER      Person writer           (1R)                 
         BE    PRCSB20                                                          
         CLI   QPROG,PNL           Profit and loss writer  (1C)                 
         BE    PRCSB20                                                          
         CLI   QPROG,CASH          Cash   writer           (SC)                 
         BE    PRCSB20                                                          
         CLI   QPROG,MEDIA         Media  writer           (SZ)                 
         BE    PRCSB20                                                          
         CLI   QPROG,INCOME        Income writer           (1C)                 
         BNE   PRCSB10             No, so ok for now                            
         CLC   =C'1C',QUNIT                                                     
         BNE   XITMODE                                                          
                                                                                
PRCSB10  CLI   QPROG,PRODUCTION    Production writer       (SJ)                 
         BNE   XITMODE                                                          
         MVC   CURWKCD,CACKWRK     Move in work code                            
         GOTO1 AFILTER,DMCB,AFLTWC,CURWKCD                                      
         BNE   XITNEXT                                                          
         B     PRCSB20                                                          
*                                                                               
PRCSB20  GOTO1 AFILTER,DMCB,AFLTUNL,QUNIT                                       
         BNE   XITNEXT                                                          
         GOTO1 AFILTER,DMCB,AFLTCTRA,CURSUBAC+1                                 
         BNE   XITNEXT                                                          
         CLI   QPROG,PRODUCTION                                                 
         BNE   PRCSB50                                                          
         OI    FMTMODES,FMTNOSUB   INITIALIZE NOT TO PROCESS TRANS              
         CLC   CACKWRK,=C'**'      IS IT A PURCHASE ORDER?                      
         BE    *+16                NO, SO CLEAR ELEMENT ADDRESS                 
         TM    FMTROPT5,RPFOPORD   PURCHASE ORDERS ONLY?                        
         BO    XITNEXT                                                          
         B     *+12                                                             
         TM    FMTROPT5,RPFXPORD   EXCLUDE PURCHASE ORDERS                      
         BO    XITNEXT                                                          
*                                                                               
         NI    FMTMODES,TURNOFF-FMTNOSUB                                        
         TM    POSTLVL,POSTHST     PROCESS RECORDS AT HISTORY LEVEL             
         BZ    XITMODE                                                          
         TM    FMTPOPT1,RPFIACT    PRINT INACTIVE ACCOUNTS?                     
         BZ    XITNEXT             SEED SORTER IF ON                            
*                                                                               
         SR    R1,R1                                                            
         AH    R2,DATADISP                                                      
PRCSB30  CLI   0(R2),0             EOR                                          
         BE    PRCSB40                                                          
         CLI   0(R2),BUKELQ        X'45' BUCKET ELEMENTS                        
         BE    XITNEXT             FOUND ACTIVITY                               
         IC    R1,1(,R2)                                                        
         AR    R2,R1                                                            
         B     PRCSB30                                                          
*                                                                               
PRCSB40  GOTO1 =A(SETWKCD)         SET WORK CODE INFO THEN                      
         B     SUBACC              SEED SORTER WITH DUMMY RECS                  
***********************************************************************         
*  Routine to process bucket records for cost dollars/General ledger  *         
***********************************************************************         
         SPACE 1                                                                
PRCSB50  CLI   QPROG,PNL           Profit and Loss (1C)                         
         BE    PRCSB51             Yes                                          
         CLI   QPROG,MANPOWER      Person/Manpower (1R)                         
         BE    PRCSB51             Yes                                          
         CLI   QPROG,GENERAL       General Ledger (GB,GP)                       
         BNE   XITMODE             No                                           
         CLI   NEWOFF,YES          Two char office ?                            
         BE    PRCSB50E            Yes                                          
         TM    FCIND,FCNEWGL       New GL                                       
         BZ    PRCSB50H            No, Old                                      
         B     XITMODE             Only process via GLNEW                       
                                                                                
PRCSB50E MVI   FCRDHIST,NO         Set to no now                                
         CLC   CACKOFF,SPACES      Acct/Contra                                  
         BNH   XITNEXT             Yes so skip, want Acct/Off/Contra            
         TM    FCIND,FCNEWGL       New GL                                       
         BO    XITMODE                                                          
                                                                                
PRCSB50H GOTOR GLOLD,(R2)                                                       
         B     XITNEXT                                                          
*                                                                               
PRCSB51  LR    R4,R2                                                            
         AH    R4,DATADISP                                                      
PRCSB51A CLI   0(R4),BUKELQ        X'45'                                        
         BE    PRCSB51C                                                         
         SR    R1,R1                                                            
         ICM   R1,1,1(R4)                                                       
         BZ    XITMODE             NO BUCKETS TO POST                           
         AR    R4,R1                                                            
         B     PRCSB51A                                                         
*                                                                               
PRCSB51C ST    R4,BUKELM           SAVE ADDRESS OF FIRST ELEMENT                
         MVC   CURBUCK,CACKBTYP                                                 
         CLI   QPROG,PNL                                                        
         BE    PRCSB51F                                                         
*                                                                               
PRCSB51D CLI   CURBUCK,C' '                                                     
         BNH   XITMODE             SKIP BLANK BUCKET TYPES                      
*        CLI   CURBUCK,C'H'        HOUR BUCKETS?                                
*        BE    XITMODE                                                          
         CLI   CACKSTYP,C' '                                                    
         BNH   XITMODE             Only want new cost records for now           
*        BNH   PRCSB52                                                          
*                                                                               
PRCSB51F MVC   CURMTHD,CACKBTYP                                                 
         MVC   CURBUCK,CACKSTYP                                                 
*                                                                               
PRCSB52  TM    RECREAD2,RECALO$    ALLOCATED DOLLARS?                           
         BZ    XITMODE             NO, NO NEED TO POST ALLOCATE BUCKETS         
         XC    AELEM1A(AELEMQ),AELEM1A                                          
         MVC   CURBLK1,SPACES      CLEAR FOR EVER TRANSACTION                   
         XC    CURMMOS,CURMMOS                                                  
         XC    CURSTAT(3),CURSTAT                                               
         MVI   CURTIME,C' '                                                     
*&&UK*&& MVI   CURJLOCK,0                                                       
         MVI   CURBRTST,C' '                                                    
         CLI   QPROG,MANPOWER                                                   
         BE    *+10                                                             
         MVC   CUROFF,CACKOFF      ??????????? 2 BYTE OR 1 BYTE ?               
*                                                                               
         TM    POSTLVL,POSTDET                                                  
         BZ    PRCSB56             NEVER ON FOR P&L                             
         CLC   =C'1N',CURSUBAC+1                                                
         BNE   PRCSBX                                                           
         MVI   CURTIME,C'N'        Set to non-client time                       
         CLI   AFLTCLI1,0          IF FILTERING SJ CLIENT, THEN NO 1N           
         BNE   PRCSBX                                                           
         CLI   AFLTWC,0            IF FILTER WORKCODE,     THEN NO 1N           
         BNE   PRCSBX                                                           
*                                                                               
PRCSB56  CLI   QPROG,PNL           ALWAYS PROCESS BUCKETS FOR P&L               
         BNE   PRCSB57                                                          
         LA    RE,CURACC+3         GET CLIENT PROD INTO CURSJACC                
         AH    RE,DSP2CLI                                                       
         LH    RF,SJJOBDSP         LENGTH OF CLI+PRD                            
         BCTR  RF,0                                                             
         EXMVC RF,CURSJACC,0(RE)                                                
         BAS   RE,CLIFILT                                                       
         BNE   XITNEXT                                                          
                                                                                
PRCSB57  GOTOR POSTBUK,DMCB,(R4)                                                
*                                                                               
PRCSBX   B     XITNEXT                                                          
*---------------------------------------------------------------------          
CLIFILT  NTR1                                                                   
         GOTO1 AFILTER,DMCB,AFLTCLI1,CURSJ                                      
         BE    CLIFLTY                                                          
         OC    AFLTCLI2,AFLTCLI2                                                
         BZ    CLIFLTN                                                          
         GOTO1 AFILTER,DMCB,AFLTCLI2,CURSJ                                      
         BE    CLIFLTY                                                          
CLIFLTN  LTR   RB,RB                                                            
         B     CLIFLTX                                                          
CLIFLTY  CR    RB,RB                                                            
CLIFLTX  B     XITNTR1                                                          
                                                                                
         EJECT                                                                  
***********************************************************************         
*  Routine for processing Jobber estimate data and client POs         *         
***********************************************************************         
         SPACE 1                                                                
PRCANL   OI    FMTMODES,FMTNOANL   Initialize not to process trans.             
         NI    FCIND,TURNOFF-FCIOKREV                                           
         XC    AELEM77B(12),AELEM77B                                            
         XC    AELMTMS1(AELMTMSQ),AELMTMS1                                      
         XC    AELEM1A(AELEMQ),AELEM1A                                          
         XC    AELEM50T,AELEM50T                                                
         MVI   POIND,0                                                          
         NI    CURIND,TURNOFF-(CURBILCR+CURINCHG+CURRETL)                       
         XC    CURSTAT(3),CURSTAT                                               
         NI    POSTMODE,TURNOFF-POSTTRN                                         
*                                                                               
         USING ACMD,R2                                                          
         L     R2,AMONACC                                                       
         MVC   CURWKCD,ACMWRKC     Current workcode                             
         DROP  R2                                                               
*                                                                               
         GOTO1 =A(SETWKCD)                                                      
         BE    PRCANL20                                                         
         CLC   CURWKCD,=C'**'                                                   
         BNE   PRCANL40                                                         
         TM    FMTROPT5,RPFMRGPO  Merge PO workcodes in                         
         BZ    PRCANL40           Definitely don't process transactions         
*                                                                               
PRCANL20 NI    FMTMODES,TURNOFF-FMTNOANL     Process transactions               
         CLI   FCJOBBER,0                                                       
         BE    PRCANL40                                                         
         GOTO1 =A(JOBEST)                                                       
*                                                                               
PRCANL40 DS    0H                                                               
*&&UK                                                                           
         TM    POSTLVL2,POSTCIND                                                
         BNZ   PRCANL50                                                         
         TM    RECREAD3,RECAEXRD   READ AEXRECD TO GET CLIENT POs               
         BZ    PRCANL50                                                         
         GOTO1 =A(PROCPO)                                                       
         GOTO1 ARECORD,DMCB,('POSTCPO',ASRTWRK),('POSTCLR',1)                   
         OI    POSTMODE,POSTCPO                                                 
         GOTO1 APUTREC,DMCB,ASRTWRK,1                                           
         NI    POSTMODE,TURNOFF-POSTCPO                                         
         NI    POSTLVL2,TURNOFF-POSTACLP                                        
         OI    POSTLVL2,POSTCIND                                                
*&&                                                                             
PRCANL50 DS    0H           DEAL WITH NON-JOBBER ESTIMATE AMOUNTS               
         OC    #OFEST,#OFEST                                                    
         BZ    PRCANL60                                                         
         GOTO1 =A(NJEST)                                                        
                                                                                
PRCANL60 B     XITNEXT                                                          
         SPACE 1                                                                
         EJECT                                                                  
***********************************************************************         
*  IF POSTLVL=HIST THEN PUT SORT RECORDS OUT HERE                     *         
***********************************************************************         
         SPACE 1                                                                
         USING CACRECD,R2                                                       
SUBACC   L     R2,ADSUBAC                                                       
         SH    R2,DATADISP                                                      
                                                                                
SUBACC10 MVC   CURSUBAC,CACKCULC           Restore Sub-account                  
         GOTO1 AFILTER,DMCB,AFLTUNL,QUNIT                                       
         BNE   XITNEXT                                                          
*                                                                               
         TM    POSTLVL,POSTHST     Are we only at History level ?               
         BZ    XITMODE             No so exit                                   
         GOTO1 AFILTER,DMCB,AFLTCTRA,CURSUBAC+1                                 
         BNE   XITNEXT                                                          
         CLI   MODE,PROCSBAC       Did we come from PROCSBAC ?                  
         BE    SUBACC20            Yes                                          
         MVI   FCRDHIST,NO         No don't want to read all the hist           
         GOTO1 SETCNTR,DMCB,CURSUBAC+1                                          
*                                                                               
SUBACC20 XC    AELEM77B(12),AELEM77B                                            
         XC    AELMTMS1(AELMTMSQ),AELMTMS1                                      
         XC    AELEM1A(AELEMQ),AELEM1A                                          
         XC    AELEM50T,AELEM50T                                                
*                                                                               
SUBACC30 GOTO1 ARECORD,DMCB,('POSTNUL',ASRTWRK),('POSTCLR',1)                   
         GOTO1 APUTREC,DMCB,ASRTWRK,1                                           
*                                                                               
SUBACCX  B     XITNEXT                                                          
         EJECT                                                                  
***********************************************************************         
*  ROUTINE TO PUT TRANSACTION TO SORT                                 *         
***********************************************************************         
         SPACE 1                                                                
TRNSPUT  MVI   POSTMODE,POSTTRN                                                 
         TM    UPSI,UPSITRNS                                                    
         BZ    TRNSP00                                                          
         GOTO1 =A(DUMPTKEY),0                                                   
*                                                                               
**NSP00  BAS   RE,FIXREF                                                        
TRNSP00  TM    MODEIND,MODEONCE                                                 
         BO    TRNSP25             ALREADY INTIALIZED DATA FOR MODE             
         CLI   QPROG,MANPOWER                                                   
         BNE   TRNSP05                                                          
         XC    AELMTMS1(AELMTMSQ),AELMTMS1                                      
         L     RE,ADTRANS                                                       
         SH    RE,DATADISP                                                      
         ST    RE,ATMSKEY                                                       
         GOTO1 ATRN2TMS                                                         
         BAS   RE,CLRCUR           CLEAR SOME VALUES (R1-R3 DESTROYED)          
         MVI   CURTIME,C' '                                                     
         MVI   CURBRTST,C' '                                                    
         B     PROCTMS                                                          
***********************************************************************         
*                                                                     *         
***********************************************************************         
         USING ACMD,R2                                                          
TRNSP05  BAS   RE,CLRCUR           CLEAR SOME VALUES (R1-R3 DESTROYED)          
         L     R2,AMONACC          ADDRESSABLITY TO MONACC DATA                 
         MVC   SAVEMOS,ACMTTMOS    TRANSACTION MOS FROM MONACC                  
         MVC   MOADTE(2),ACMTTMOS  SAVE MOS DATE                                
         MVI   MOADTE+2,01                                                      
*                                                                               
         USING TRNRECD,R2                                                       
         USING TRNELD,R4                                                        
TRNSP15  L     R4,ADTRANS                                                       
         LR    R2,R4                                                            
         SHI   R2,ACCORFST         GET TO BEGINING OF KEY                       
         CLI   QPROG,PRODUCTION                                                 
         BNE   TRNSP20                                                          
         MVC   CURSJACC,TRNKACT    RESET SJ ACCOUNT                             
*                                                                               
TRNSP20  MVI   NEWTRAN,NO          DEFAULT TO SAY NOT NEW KEY                   
         CLC   PREVKEY(TRNKSBR-TRNRECD),TRNKCULA                                
         BE    TRNSP25             KEY HAS NOT CHANGED                          
         MVC   PREVKEY,TRNKCULA    SET PREVIOUS KEY TO NEW KEY                  
         MVC   TRANDTE,TRNKDATE    SET TRANSACTION DATE                         
         MVI   NEWTRAN,YES         NEW KEY (NOT INCLUDING SUB-REF)              
*                                                                               
         L     RE,ASJBUF1          CLEAR SJBUF1                                 
         LHI   RF,SJBUFMAX                                                      
         XR    R0,R0                                                            
         XR    R1,R1                                                            
         MVCL  RE,R0                                                            
*                                                                               
         XC    DUEDTE,DUEDTE                                                    
         MVC   MOAAGE,MOADTE       POST BY THIS MOA DATE                        
         MVC   ACTAGE,ACTDTE       POST BY THIS ACTIVITY DATE                   
*&&UK                                                                           
         L     RE,AXDATAN         RESET XDATA NAME LIST                         
         LHI   RF,MAXXN                                                         
         XR    R0,R0                                                            
         XR    R1,R1                                                            
         MVCL  RE,R0                                                            
         L     RE,AXDATAN                                                       
         MVI   0(RE),X'FF'                                                      
*                                                                               
         L     RE,AXDATAV         RESET XDATA VALUE LIST                        
         LHI   RF,MAXXV                                                         
         XR    R0,R0                                                            
         XR    R1,R1                                                            
         MVCL  RE,R0                                                            
         L     RE,AXDATAV                                                       
         MVI   0(RE),X'FF'                                                      
*&&                                                                             
         CP    TRNSTOT,PKZERO      Did transaction total zero ?                 
         BE    TRNSP25             Yes                                          
         OI    PAIRIND,PAIRNOTZ    No, last pair had a balance                  
*                                                                               
TRNSP25  CLI   QPROG,MANPOWER                                                   
         BE    PROCTMS                                                          
         CLI   NEWTRAN,YES         Processing a new transaction ?               
         BE    TRNSP30             Yes                                          
         CLI   QPROG,PAYABLES      PAYABLES ONLY                                
*&&UK*&& BNE   PRCTRNS                                                          
*&&US                                                                           
         BE    *+12                                                             
         CLI   QPROG,INCOME        INCOME TOO                                   
         BNE   PRCTRNS                                                          
*&&                                                                             
         TM    TRNSTAT,TRNSDR      Debit?                                       
         BO    PRCTRNS             Yes                                          
         TM    MODEIND,MODEONCE    Credit, already done once ?                  
         BO    TRNSP28             Yes                                          
         MVC   DFTBLK1,SPACES      Clear and set new defualt by CR              
         XC    DFTMMOS,DFTMMOS     Since credit carries this info               
         MVI   PAIRIND,0           Reset for each group (pair)                  
*                                                                               
TRNSP28  CLI   FMTPUT,HOLD         PUT CR/DR PAIR                               
         BE    PRCTRNS             KEEP PROCESSING TRANSACTION                  
         MVI   NEWTRAN,YES         RESET, TO CLEAR OUT CR/DR PAIR               
*                                                                               
TRNSP30  CLI   QPROG,PRODUCTION                                                 
         BE    TRNSP40                                                          
         BAS   RE,PARTIAL                                                       
         TM    FMTROPT,RPFBALO     Only show outstanding balances ?             
         BZ    TRNSP40             No, so put to sorter                         
         TM    PAIRIND,PAIRNOTZ    Did transaction total zero ?                 
         BZ    TRNSP45             Yes, so don't put to sort                    
*        CP    TRNSTOT,PKZERO      DID TRANSACTIONS TOTAL ZERO?                 
*        BNE   TRNSP40             NO, SO ALWAYS PUT TO SORT                    
*                                                                               
TRNSP40  CLI   FMTPUT,YES          SHOULD WE PUT PRIOR TRANSACTION?             
         BNE   TRNSP45             NO                                           
         LH    RF,FMT#TRNS                                                      
         GOTO1 APUTREC,DMCB,FMTSRTWK,(RF)                                       
         XC    FMT#TRNS,FMT#TRNS             RESET                              
*                                                                               
TRNSP45  MVI   FMTPUT,HOLD                                                      
         CLI   NEWTRAN,YES                                                      
         BNE   *+10                                                             
         XC    FMT#TRNS,FMT#TRNS   Reset for each format on new trans.          
*                                                                               
         TM    MODEIND,MODEONCE                                                 
         BO    PRCTRNS                                                          
         MVC   DFTBLK1,SPACES      Clear for new trnas. set                     
         XC    DFTMMOS,DFTMMOS                                                  
         ZAP   TRNSTOT,PKZERO      Clear to totaling next trnasaction           
         ZAP   TRNSCRD,PKZERO                                                   
         ZAP   TRNSDEB,PKZERO                                                   
         CLI   NEWTRAN,YES                                                      
         BNE   PRCTRNS                                                          
         NI    PAIRIND,PAIRNOTZ    Reset most indicators (pair)                 
         B     PRCTRNS                                                          
         EJECT                                                                  
***********************************************************************         
*  ROUTINE FOR PROCESS TIME                                           *         
***********************************************************************         
         SPACE 1                                                                
         USING ACMD,R2                                                          
PROCTMS  DS    0H                                                               
         CLI   MODE,PROCTRNS                                                    
         BE    PRTMS140                                                         
         TM    MODEIND,MODEONCE                                                 
         BO    PRTMS145                                                         
         BAS   RE,CLRCUR           CLEAR SOME VALUES (R1-R3 DESTROYED)          
         MVI   CURTIME,C' '                                                     
         MVI   CURBRTST,C' '                                                    
         XC    CURPDTE,CURPDTE                                                  
         XC    CURHRS,CURHRS                                                    
         XC    CURSUBDT,CURSUBDT                                                
*                                                                               
         L     R2,AMONACC          ADDRESSABLITY TO MONACC DATA                 
         L     R2,ACMALTN                                                       
         ST    R2,ATMSKEY          SAVE IT, FOR PARSE TABLES                    
         XC    AELMTMS1(AELMTMSQ),AELMTMS1                                      
         L     R4,ADTRANS          POINTS TO CURRENT TYPE 1                     
         B     PRTMS110                                                         
*                                                                               
         USING TIMELD,R4                                                        
PRTMS100 CLI   TIMEL,0             END OF RECORD?                               
         BE    PRTMS140                                                         
         CLI   TIMEL,TIMELQ        HAS TO BE TIME ELEMENT                       
         BNE   PRTMS120            BUMP TO NEXT TYPE ON RECORD                  
         CLI   TIMETYP,TIMEINP     CAN'T HAVE INPUT DETAIL AGAIN                
         BE    PRTMS140                                                         
*&&US                                                                           
         CLI   TIMETYP,TIMETIME    Value = 7 (US)                               
         BNH   PRTMS110                                                         
         B     PRTMS120            SKIP OTHER VALUES FOR NOW                    
*&&                                                                             
*&&UK                                                                           
         CLI   TIMETYP,TIMEROW#    Value = 14 (UK)                              
         BNH   PRTMS110                                                         
         CLI   TIMETYP,TIMEITMS                                                 
         BNE   PRTMS120            SKIP OTHER VALUES FOR NOW                    
         OC    AELMTM30,AELMTM30   ITEM ALREADY FOUND?                          
         BNZ   PRTMS120            YES - DON'T SAVE IT                          
         ST    R4,AELMTM30         SAVED FIRST ITEM ELEMENT ONLY                
         B     PRTMS120                                                         
*&&                                                                             
*                                                                               
PRTMS110 LA    RF,AELMTMS1                                                      
         ZIC   R1,TIMETYP          INPUT TYPE                                   
         BCTR  R1,0                                                             
         SLL   R1,2                                                             
         AR    RF,R1               GET CORRESPONDING ADDRESS                    
         ST    R4,0(,RF)           SAVE ADDRESSES OF TYPES                      
*                                                                               
PRTMS120 LLC   RE,TIMLN                                                         
         AR    R4,RE                                                            
         B     PRTMS100                                                         
         DROP  R4                                                               
*                                                                               
         USING TIMRECD,R2                                                       
PRTMS140 TM    MODEIND,MODEONCE                                                 
         BO    PRTMS145                                                         
         L     R2,ATMSKEY          A(TMS OR TRANSACTION KEY)                    
         CLI   MODE,PROCTIME                                                    
         BNE   PRTMS142                                                         
*                                                                               
*&&UK*&& TM    FMTROPT6,RPFFPDRD   Filter period date range by day?             
*&&US*&& TM    FMTROPT7,RPFFPDRD                                                
         BNO   PRTMS142                                                         
         L     RE,AELMTMS7         CHECK IF DAILY TIME                          
         LTR   RE,RE                                                            
         BNZ   PRTMS142                                                         
         CLC   SVENDTE,TIMKPEDT    NO,SO IGNORE THIS T/S?                       
         BL    XITNEXTX            YES                                          
                                                                                
PRTMS142 MVI   NEWMOA,NO                                                        
         MVI   NEWTRAN,NO          DEFAULT TO SAY NOT NEW TRAN                  
         MVI   NEWPERSN,NO         Same person code                             
         CLC   PREVKEY(TIMKSBR-TIMRECD),TIMKCULA                                
         BE    PRTMS145            Same key no need to reset values             
         CLC   PREVKEY(TIMKOFF-TIMRECD),TIMKCULA    Same person ?               
         BE    *+8                                                              
         MVI   NEWPERSN,YES        Yes new person                               
         XC    PRIORMOA,PRIORMOA                                                
         MVC   TRANDTE,TIMKPEDT                                                 
         MVC   PREVKEY,TIMKCULA                                                 
         MVI   DFTBLK1,X'FF'                                                    
         MVC   DFTBLK1+1(L'DFTBLK1-1),DFTBLK1                                   
         XC    DFTMMOS,DFTMMOS                                                  
         MVI   NEWTRAN,YES                                                      
*                                                                               
         TM    RECREAD3,RECTMLM    Keywords being used to report                
         BZ    PRTMS145            tms line manager?                            
         CLI   NEWPERSN,YES        Only read dept passives if a new             
         BNE   *+8                 person                                       
         BRAS  RE,RDLNMGR                                                       
*                                                                               
PRTMS145 L     R2,ATMSKEY          Re-load incase this is recaping              
         CLI   FMTPUT,YES          Should we put prior transaction ?            
         BNE   PRTMS150            No                                           
         LH    RF,FMT#TRNS                                                      
         GOTO1 APUTREC,DMCB,FMTSRTWK,(RF)         PREVIOUS RECS                 
         XC    FMT#TRNS,FMT#TRNS                  RESET                         
*                                                                               
PRTMS150 MVI   FMTPUT,HOLD                                                      
         TM    MODEIND,MODEONCE    Recap, multiple passes ?                     
         BO    PRTMS200            Yes                                          
*                                                                               
         CLI   QPROG,MANPOWER                                                   
         BNE   PRTMS152                                                         
         TM    TIMKSTAT,X'FF'-(TIMSDELT+X'04')                                  
         BNZ   *+12                                                             
         MVI   CURBRTST,C'I'       IN PROGRESS (ALL STATUS OFF)                 
         B     PRTMS151                                                         
         TM    TIMKSTAT,TIMSPAPP                                                
         BZ    *+12                                                             
         MVI   CURBRTST,C'P'       PART APPROVED                                
         B     PRTMS151                                                         
*                                                                               
         TM    TIMKSTAT,TIMSFAPP   FULLY APPROVED                               
         BZ    *+8                                                              
         MVI   CURBRTST,C'F'                                                    
         TM    TIMKSTAT,TIMSSUBM   SUBMITTED                                    
         BZ    *+8                                                              
         MVI   CURBRTST,C'S'                                                    
         TM    TIMKSTAT,TIMSREJE   REJECTED                                     
         BZ    *+8                                                              
         MVI   CURBRTST,C'R'                                                    
*                                                                               
PRTMS151 GOTO1 AFILTER,DMCB,AFLTTSTA,CURBRTST                                   
         BNE   XITNEXT                                                          
*                                                                               
         USING TIMELD,RE                                                        
         USING LOCELD,R4                                                        
PRTMS152 SR    R1,R1                                                            
         XC    AELEM83,AELEM83                                                  
         L     RE,AELMTMS6         Extra time info                              
         MVI   PRSNSTAT,X'FE'      Set to unknown status                        
         L     R4,APRSNWRK                                                      
         AH    R4,DATADISP                                                      
PRTMS153 CLI   0(R4),EOR           END OF RECORD                                
         JE    PRTMS170                                                         
         CLI   0(R4),LOCELQ        X'83' LOCATION ELEMENT                       
         JNE   PRTMS158                                                         
         LTR   RE,RE               Is there a extra element, AELMTMS6 ?         
         JZ    PRTMS154            No, so look at AELMTMS1                      
         CLC   LOCEND,TIMXTPDT     Actual date of time sheet                    
         JL    PRTMS158                                                         
         CLC   LOCSTART,TIMKPEDT                                                
         JNH   PRTMS160                                                         
                                                                                
PRTMS154 CLC   LOCEND,TIMKPEDT     Calender date of time sheet                  
         JL    PRTMS158                                                         
         CLC   LOCSTART,TIMKPEDT                                                
         JNH   PRTMS160                                                         
*                                  Checked if term in mid of period             
         GOTO1 =A(GETPED),DMCB,TIMKPEDT,ACNDRBLK                                
         L     RF,4(,R1)           Get end date base on calendar                
         CLC   0(L'TIMKPEDT,RF),TIMKPEDT                                        
         JNL   PRTMS160                                                         
                                                                                
PRTMS158 IC    R1,LOCLN                                                         
         AR    R4,R1                                                            
         J     PRTMS153                                                         
         DROP  RE                                                               
*                                                                               
PRTMS160 ST    R4,AELEM83          SAVE LOCATION DATE ELEMENT                   
         MVC   PRSNSTAT,LOCSTAT    SET  LOCATION STATUS                         
*                                                                               
         USING TIMELD,R4                                                        
PRTMS170 L     R4,AELMTMS1         POINTS TO CURRENT TYPE 1                     
         CLC   PRIORMOA,TIMMOA                                                  
         BE    PRTMS171                                                         
         MVC   PRIORMOA,TIMMOA     Set previous MOA                             
         MVI   NEWMOA,YES                                                       
                                                                                
PRTMS171 MVC   SAVEMOS,TIMMOA                                                   
         MVC   THRMOS,TIMMOA                                                    
         MVC   THRTDTE,TIMKPEDT                                                 
         MVC   MOADTE(2),TIMMOA    Set MOA date                                 
         MVI   MOADTE+2,01                                                      
                                                                                
         TM    GHISIND,GHISON      Payroll history needed ?                     
         BZ    PRTMS174                                                         
         CLI   NEWPERSN,YES        New person code ?                            
         BE    PRTMS172            Yes, so process                              
         CLI   NEWTRAN,YES         New transaciton ?                            
         BE    PRTMS172            Yes, so rebuild payroll elements             
         CLI   NEWMOA,YES          New moa date  ?                              
         BNE   PRTMS174            No,  so no need to rebuild                   
                                                                                
PRTMS172 GOTOR ACOLPAYR            Reset buffer for rates only                  
                                                                                
PRTMS174 TM    RECREAD2,RECALO$+RECALRT       ALLOCATED $ OR RATES              
         BNZ   *+8                 IF KEYWORD USED THEN NOW MUST FILTER         
         TM    REQIND,REQCMTH                                                   
         BZ    PRTMS180            IF NOT ON THEN DON'T POST HOURS              
         GOTO1 =A(POSTHRS)                                                      
*                                                                               
         CLC   TIMKPEDT,RTRNSTR    NOW FILTER OUT TRUE REQUEST DATES            
         BL    XITMODE                                                          
         CLC   TIMKPEDT,RTRNEND                                                 
         BH    XITMODE                                                          
         CLC   TIMMOA,RMOASTR                                                   
         BL    XITMODE                                                          
         CLC   TIMMOA,RMOAEND                                                   
         BH    XITMODE                                                          
*                                                                               
PRTMS180 MVC   CURWKCD,SPACES                                                   
         MVC   CURCOFF,TIMOFF                                                   
         ZAP   TMSHOURS,TIMHRS     Hours to post for special keywords           
                                                                                
         CLI   FMT#P$AJ,0          Any payroll keywords ?                       
         BE    PRTMS182            No                                           
         TM    THRSW,THRLST        Processing in ACCLST ?                       
         BO    PRTMS182            Yes                                          
         GOTOR ASETPAY,1                                                        
                                                                                
PRTMS182 CLI   TIMETYP,TIMEINP     IS IT A TYPE 1?                              
         BE    *+6                 FIRST ONE IN SHOULD BE INPUT TYPE            
         DC    H'00'                                                            
                                                                                
         CLI   TIMTTYP,TIMTCB      B TIME                                       
         BNE   *+8                                                              
         MVI   CURTIME,C'B'                                                     
         CLI   TIMTTYP,TIMTCR      R TIME                                       
         BNE   *+8                                                              
         MVI   CURTIME,C'R'                                                     
         CLI   TIMTTYP,TIMTCN      N TIME (CLIENT NON-BILLABLE)                 
         BE    *+8                                                              
         CLI   TIMTTYP,TIMTNC      N TIME (NON-CLIENT)                          
         BNE   *+8                                                              
         MVI   CURTIME,C'N'                                                     
                                                                                
         CLC   =C'SJ',TIMACC       HAS TO BE SJ ACCOUNT                         
         BNE   PRTMS185                                                         
         MVC   CURSJ(14),TIMACC                                                 
         MVC   CURWKCD,TIMTSK                                                   
*                                                                               
PRTMS185 TM    TIMIND,TIMIADJ      ADJUSTED TIME                                
         BZ    *+8                                                              
         OI    CURSTAT,CURADJT                                                  
         TM    TIMIND,TIMIWO       WRITE-OFF TIME                               
         BZ    *+8                                                              
         OI    CURSTAT,CURWOFF                                                  
         TM    TIMSTAT,TIMTEMPO     TEMPO UPLOAD ITEM                           
         BZ    *+8                                                              
         OI    CURSTAT,CURTMPO                                                  
*                                                                               
         USING CPRCNDRD,R3                                                      
         TM    POSTCTL,POSTPED#    Need period number                           
         BO    PRTMS186                                                         
         TM    POSTCTL,POSTMYP     MONTH or YEAR, post by period                
         BZ    PRTMS195                                                         
                                                                                
PRTMS186 CLC   PRIORPED,TIMKPEDT   Will it be the same as last time             
         BNE   PRTMS188            No                                           
         CLC   PRIOROFF,PRSNOFF    Same office                                  
         BE    PRTMS195            Yes so same value                            
         MVC   PRIOROFF,PRSNOFF                                                 
         MVC   PRIORPED,TIMKPEDT                                                
                                                                                
PRTMS188 L     R3,ACNDRBLK                                                      
         MVC   CPRYMD,TIMKPEDT      Move in packed year                         
         MVC   CPROF,PRSNOFF                                                    
                                                                                
PRTMS190 GOTO1 AGETCNDR,DMCB,ACNDRBLK,85                                        
         MVC   CURPED#,CPRPED#                                                  
         BE    PRTMS195                                                         
         TM    CPRERR,CPRNF        Record not found ?                           
         BZ    PRTMS195                                                         
         DC    H'00'                                                            
         DROP  R3                                                               
*                                                                               
PRTMS195 ZAP   THRHRS,TIMHRS       Set total hours to post                      
         TM    THRSW,THRLST        Processing in ACCLST ?                       
         BZ    PRTMS200            No, so columns already have totals           
         GOTO1 POSTTHR             Yes, post hours to cols for tot hrs          
*                                                                               
PRTMS200 TM    GHISIND,GHISON      Payroll history needed ?                     
         BZ    PRTMS220                                                         
         ICM   RE,15,FMTRTES       Payroll rate buffer                          
         BZ    PRTMS220            No rates                                     
         SR    RF,RF                                                            
                                                                                
PRTMS202 CLI   0(RE),EOR           End of record ?                              
         JE    PRTMS220            Finished                                     
         MVI   0(RE),RT$ELQ        Reset payroll rate elements                  
         IC    RF,1(,RE)                                                        
         AR    RE,RF                                                            
         J     PRTMS202                                                         
                                                                                
PRTMS220 GOTO1 AFILTER,DMCB,AFLTCOFF,CURCOFF                                    
         BNE   XITNEXT                                                          
         BAS   RE,CLIFILT                                                       
         BNE   XITNEXT                                                          
*                                                                               
PRTMS225 GOTO1 AFILTER,DMCB,AFLTWC,CURWKCD                                      
         BNE   XITNEXT                                                          
         GOTO1 AFILTER,DMCB,AFLTCTRA,CURSUBAC+1                                 
         BNE   XITNEXT                                                          
         GOTO1 AFILTER,DMCB,AFLTTSTA,CURBRTST    fix recap per prof bug         
         BNE   XITNEXT                                                          
*&&UK*&& B     FLTT168                                                          
                                                                                
*&&US                                                                           
         CLI   QPROG,MANPOWER                                                   
         BNE   FLTT168                                                          
         CLI   NEWPERSN,YES        if new person then clear the table           
         BNE   *+8                                                              
         MVI   BYTE,C'Y'                                                        
         TM    RECREAD3,RECTMAUD   Keywords being used to report                
         BZ    PRTMS230            tms audit info?                              
         BRAS  RE,RDAUDT                                                        
         BE    *+16                if not equal means no pid found              
         TM    DATEFLT2,DATEAPR    if not equal and filtering on appr           
         BO    XITMODE             date then exit else continue on              
         B     FLTT168                                                          
         BRAS  RE,CHKAUDT                                                       
*                                                                               
         BRAS  RE,GETSUBDT         Get Submit date                              
         TM    DATEFLT2,DATETSBD   Submitter date filter                        
         JZ    PRTMS230                                                         
         CLC   CURSUBDT,ALTNSTR    ALTERNATE START DATE                         
         JL    XITMODE                                                          
         CLC   CURSUBDT,ALTNEND    ALTERNATE END DATE                           
         JH    XITMODE                                                          
PRTMS230 CLI   CURBRTST,C'I'       TIMESHEET STATUS IS BLANK?                   
         JNE   *+10                                                             
         XC    CURSUBDT,CURSUBDT   WIPE OUT SUBMIT DATE                         
*                                                                               
         TM    RECREAD3,RECTMLM    Keywords being used to report                
         BZ    *+8                 tms line manager?                            
         BRAS  RE,CHKLMGR                                                       
*                                                                               
PRTMS232 TM    DATEFLT2,DATETAPR   Timesheet Approver date filter               
         BZ    *+8                                                              
         B     *+12                                                             
         TM    DATEFLT2,DATEAPR    Approver date filter                         
         BZ    FLTT168                                                          
         CLC   ALTNEND,CURAPPRD    ALTERNATE END DATE                           
         BL    XITMODE                                                          
         CLC   ALTNSTR,CURAPPRD    ALTERNATE START DATE                         
         BH    XITMODE                                                          
         B     FLTT168                                                          
*&&                                                                             
* Not ready for limlist code yet                                                
*        TM    DDLNKIND,DDLNKQKR   Just for QuickReports for now                
*        BZ    FLTT168                                                          
*        CLC   =C'1N',CURSUBAC+1                                                
*        BE    FLTT168                                                          
*        MVI   BYTE,02             Manpower filtering on client                 
*        BRAS  RE,RPTSEC                                                        
*        BE    FLTT168             If = then overriding the limlist             
*        GOTO1 ARDLML                                                           
*        BNE   XITNEXT                                                          
*        B     FLTT168             PROCESS RECORD                               
         DROP  R2,R4                                                            
                                                                                
NEWPERSN DS    CL1                                                              
NEWMOA   DS    CL1                                                              
PRIORMOA DS    XL2                                                              
PRIORPED DS    XL3                                                              
PRIOROFF DS    CL2                                                              
         EJECT                                                                  
***********************************************************************         
*  ROUTINE FOR PROCESS TRANSACTION                                    *         
***********************************************************************         
         SPACE 1                                                                
         USING TRNRECD,R2                                                       
         USING TRNELD,R4                                                        
PRCTRNS  L     R4,ADTRANS                                                       
         LR    R2,R4                                                            
         SHI   R2,ACCORFST         Get to beginning of the key                  
         CLI   OFFTYPE,OFFTYTRN    Transaction office security                  
         BNE   *+10                No                                           
         MVC   LMTSECOF,TRNOFFC    Yes so set                                   
                                                                                
         TM    MODEIND,MODEONCE                                                 
         BO    FLTTRNS                                                          
         NI    FCIND,TURNOFF-FCIOKREV                                           
         CLI   QPROG,PRODUCTION                                                 
         JNE   PRCT02                                                           
         TM    TRNSTAT,TRNSDR                                                   
         JO    PRCT04                                                           
         OI    FCIND,FCIOKREV      Okay to reverse                              
         J     PRCT04                                                           
                                                                                
PRCT02   TM    FCIND,FCNEWGL       New GL                                       
         JO    PRCT04              Yes, don't bother then                       
         CLI   QPROG,GENERAL                                                    
         JNE   PRCT04                                                           
         CLI   REVSIGN,YES                                                      
         JNE   PRCT04                                                           
         OI    FCIND,FCIOKREV      Set on to reverse                            
                                                                                
PRCT04   MVI   POIND,0             Purchase order indicator                     
         NI    ESTIND3,TURNOFF-ESTONTX  RESET 'EST. FOUND' INDICATOR            
         XC    AELEM1A(AELEMQ),AELEM1A                                          
         XC    AELMTMS1(AELMTMSQ),AELMTMS1                                      
         XC    AELEM77B(12),AELEM77B                                            
         XC    AELEM50T,AELEM50T                                                
         OC    ACCOPEEL(2,R2),ACCOPEEL(R2)   IS IT A PEELED TRANSATION?         
         BNZ   XITMODE                       YES, SO DON'T BOTHER               
         GOTOR SETELEM                                                          
         NI    FCIND,TURNOFF-FCIFOUND                                           
         NI    CURIND,TURNOFF-(CURBILCR+CURINCHG+CURRETL)                       
         MVC   SUBTTYP,TRNTYPE     SAVE CURRENT TRANSACTION TYPE                
         MVI   SUBTTYP2,0                                                       
         MVC   REALTYP,TRNTYPE     SAVE CURRENT TRANSACTION TYPE                
         XC    ACTDTE,ACTDTE                                                    
*                                                                               
         USING TRSELD,R6                                                        
         ICM   R6,15,AELEM60       STATUS ELEMENT                               
         BZ    PRCT06                                                           
         GOTO1 DATCON,DMCB,(2,TRSDATE),(1,ACTDTE)                               
*        CLI   QOPT4,C'U'                                                       
*        BNE   PRCT06                                                           
*        CLC   TRSUDAT,=X'C910'                                                 
*        BNE   XITMODE                                                          
         DROP  R6                                                               
*                                                                               
PRCT06   ZAP   CURFCAMT,PKZERO                                                  
         ZAP   CURFCAGE,PKZERO                                                  
         MVC   CURFCCDE,RCCURR     SET DEFAULT EACH TIME IN                     
         BRAS  RE,SETDFLT          Set defaults                                 
         BAS   RE,SETPTRS          SET X'C0' POINTER VALUES                     
*                                                                               
         USING AFCELD,RF                                                        
         ICM   RF,15,AELEM7A       FOREIGN CURRENCY ELEMENT                     
         BZ    PRCT08                                                           
*&&UK*&& TM    AFCXSTA2,AFCXSMEM   MEMO TYPE POSTING?                           
*&&US*&& TM    AFCXSTAT,AFCXSMEM   MEMO TYPE POSTING?                           
         BO    PRCT08              YES SO IGNORE FOREIGN TYPE CURRENCY          
         ZAP   CURFCAMT,AFCAMNT    SAVE FOREIGN CURRENCY AMOUNT                 
         ZAP   CURFCAGE,AFCAMNT                                                 
         MVC   CURFCCDE,AFCCURR                                                 
         OI    FCIND,FCIFOUND      FOREIGN CURRENCY FOUND                       
         B     PRCT10                                                           
*                                                                               
         USING FFTELD,RF                                                        
PRCT08   ICM   RF,15,AELEMDB       FOREIGN CURRENCY ADJUSTMENT                  
         BZ    PRCT10                                                           
         CLI   FFTTYPE,FFTTACUR    RIGHT TYPE?                                  
         BNE   PRCT10              NO, SO SKIP                                  
         MVC   CURFCCDE,FFTDATA    OVERRIDE FOREIGN CURRENCY CODE               
         OI    FCIND,FCIFOUND      FOREIGH CURRENCY FOUND                       
         CLI   REALTYP,30                                                       
         BNE   PRCT10                                                           
         MVI   SUBTTYP,TY30DI      DIFFERENCE POSTING TYPE                      
         B     PRCT10                                                           
         DROP  RF                                                               
*                                                                               
PRCT10   MVC   CURSTAT,TRNSTAT                                                  
         MVI   BYTE,CURREVL+CURHELD                                             
         CLI   QPROG,PRODUCTION                                                 
         BNE   *+8                                                              
         OI    BYTE,CURNONC        NON-COMMISSIONABLE                           
*                                                                               
         CLI   QPROG,CASH                                                       
         BNE   *+8                                                              
         OI    BYTE,CURRCON        RECONCILED                                   
*                                                                               
         NC    CURSTAT,BYTE                                                     
*&&UK                                                                           
         CLI   QPROG,PRODUCTION    VL?                                          
         BE    *+12                                                             
         CLI   QPROG,PAYABLES      PL?                                          
         BNE   PRCT12                                                           
         MVI   CURAUTH2,C'U'       UNAUTH                                       
         TM    TRNSTAT,TRNSAUTH    INVOICE AUTHORISED                           
         BZ    PRCT12                                                           
         MVI   CURAUTH2,C'A'       AUTH                                         
         OI    CURSTAT,CURAUTH                                                  
*&&                                                                             
PRCT12   MVC   TRNSSTAT,TRNSTAT    SAVE TRANSACTION STATUS                      
         CLI   QPROG,PRODUCTION    PRODUCTION ONLY                              
         BNE   PRCT14                                                           
         GOTOR SETPROD,(R4)                                                     
         BNE   XITMODE                                                          
*                                                                               
         TM    RECREAD2,RECPORD    PO keywords used ?                           
         BZ    PRCT12B             No                                           
         CLC   SAVEMOS,RMOAEND                                                  
         BH    XITMODE                                                          
*                                                                               
PRCT12B  CLC   TRNKWORK,=C'**'     Purchase order?                              
         BNE   PRCT16              No                                           
         TM    DATEFLT2,DATETRM    Alt type E-for prod means po due dte         
         BZ    PRCT13                                                           
         USING POD,RF                                                           
         LA    RF,CURPODET                                                      
         CLC   PODUE,SPACES        If no due date then skip                     
         BNH   XITMODE                                                          
         CLC   ALTNEND,PODUE       ALTERNATE END DATE                           
         BL    XITMODE                                                          
         CLC   ALTNSTR,PODUE       ALTERNATE START DATE                         
         BH    XITMODE                                                          
         B     PRCT16                                                           
         DROP  RF                                                               
*                                                                               
PRCT13   TM    DATEFLT2,DATEPOAD   Purchase order approval date filter?         
         BZ    PRCT16                                                           
         USING POD,RF                                                           
         LA    RF,CURPODET                                                      
         TM    POSTATUS,POBROAP    Approval found within dates?                 
         BZ    XITMODE                                                          
*                                                                               
PRCT14   TM    RECREAD2,RECPORD    PO keywords used ?                           
         BZ    PRCT16              No                                           
         MVC   WORK(6),SPACES                                                   
         GOTOR PARSE,DMCB,GETPORD,WORK,0                                        
         BNE   PRCT16                                                           
         OI    POIND,POI#ON        Have PO #                                    
         GOTO1 GETPO,DMCB,WORK,SPACES                                           
*                                                                               
PRCT16   ZAP   TRNSAMT,TRNAMNT     SAVE TRANSACTION AMOUNT                      
         ZAP   TRNSAGE,TRNAMNT     SAVE TRANSACTION AMOUNT FOR AGEING           
         LA    RE,TRNSDEB                                                       
         SR    R1,R1                                                            
         IC    R1,BRNCHSGN         SET BASED ON U/L PROCESSING                  
         TM    TRNSTAT,TRNSDR      IS IT A DEBIT?                               
         EX    R1,*+8                                                           
         B     *+8                                                              
         BC    0,PRCT18            YES, SO BRANCH ACCORDINGLY                   
         MP    TRNSAGE,PKNEG       REVERSE SIGN                                 
         MP    CURFCAGE,PKNEG      FOREIGN CURRENCY AMOUNT                      
         LA    RE,TRNSCRD                                                       
PRCT18   AP    TRNSTOT,TRNSAGE     RUNNING TOTAL FOR TRANSACTIONS               
         AP    0(L'TRNSDEB,RE),TRNAMNT                                          
*&&UK                                                                           
         ZAP   TRNSPLB,TRNSAGE                                                  
         MP    TRNSPLB,PKNEG       Profit and loss balancing for GL             
         MVI   CURBILLT,C' '                                                    
         CP    TRNSDEB,PKZERO                                                   
         BE    PRCT22                                                           
         BL    PRCT20                                                           
         MVI   CURBILLT,C'I'       BILL TYPE = INVOICE                          
         CLI   RCLANG,LANGGER                                                   
         BNE   PRCT22                                                           
         MVI   CURBILLT,C'E'                                                    
         B     PRCT22                                                           
*                                                                               
PRCT20   MVI   CURBILLT,C'C'       BILL TYPE = CREDIT NOTE                      
         CLI   RCLANG,LANGGER                                                   
         BNE   PRCT22                                                           
         MVI   CURBILLT,C'G'                                                    
*&&                                                                             
         USING MDTELD,R2                                                        
PRCT22   ICM   R2,15,AELEM1A       X'1A' element                                
         BZ    PRCT24              Not found so don't process                   
         CLI   MDTSYS,MDTSINTA     Interagency ?                                
         BNE   PRCT24              No                                           
         MVI   SUBTTYP2,TY30IA     Set as interagency sub type 2                
*                                                                               
         USING TRXELD,R2                                                        
PRCT24   ICM   R2,15,AELEM75       EXTENDED STATUS BYTES                        
         BZ    *+10                                                             
         MVC   CURXSTA1(2),TRXSTA1                                              
*                                                                               
         TM    DATEFLT,DATEITF     FILTER OUT BY INTERFACE DATE?                
         BZ    PRCT26              NO                                           
         OC    INTRSTR,INTRSTR     START DATE?                                  
         BNZ   *+14                YES                                          
         CLC   INTREND,=X'FFFF'    END DATE?                                    
         BE    PRCT26              NO, SO OK                                    
         XC    WORK,WORK                                                        
*&&US                                                                           
         USING MDPELD,R2                                                        
         ICM   R2,15,AELEM6A       SAME AS X'1A' EXCEPT HAS PACKED #            
         BZ    *+10                                                             
         MVC   WORK(L'MDPDTE),MDPDTE                                            
*&&                                                                             
         USING MDTELD,R2                                                        
         ICM   R2,15,AELEM1A       Get interface date X'1A'                     
         BZ    *+10                Not found so don't process                   
         MVC   WORK(L'MDTDTE),MDTDTE                                            
*                                                                               
         OC    WORK(L'MDTDTE),WORK      ANY INPUT?                              
         BZ    XITMODE                  NO INPUT, SO DISCARD                    
         CLC   WORK(L'MDTDTE),INTRSTR   START DATE                              
         BL    XITMODE                  NOT IN RANGE                            
         CLC   WORK(L'MDTDTE),INTREND   END DATE                                
         BH    XITMODE                  NOT IN RANGE                            
*                                                                               
         USING TRSELD,R2                                                        
PRCT26   CLI   QPROG,CASH          CASH WRITER ONLY                             
         BNE   PRCT30                                                           
         XC    WORK,WORK                                                        
         XC    STMTDTE,STMTDTE                                                  
         ICM   R2,15,AELEM60       Get statement date                           
         BZ    PRCT28                                                           
*        OC    TRSBSTDT,TRSBSTDT                                                
*        BZ    XITMODE                                                          
         GOTO1 DATCON,DMCB,(2,TRSBSTDT),(1,WORK)                                
         MVC   STMTDTE,WORK        Save off date basis                          
         TM    DATEFLT,DATESTM     Statenent date filtering ?                   
         BZ    PRCT30              No                                           
         DROP  R2                                                               
*                                                                               
PRCT28   CLC   ALTNEND,WORK        ALTERNATE END DATE                           
         BL    XITMODE                                                          
         CLC   ALTNSTR,WORK        ALTERNATE START DATE                         
         BH    XITMODE                                                          
*                                                                               
PRCT30   DS    0H                                                               
*&&UK                                                                           
         MVI   CURBOSTS,0          BRANDOCEAN INVOICE STATUS:                   
         CLI   QPROG,PRODUCTION    VL?                                          
         BE    *+8                                                              
         CLI   QPROG,PAYABLES      PL?                                          
         BE    *+8                                                              
         CLI   QPROG,EXPENSE       XL?                                          
         BNE   PRCT32                                                           
         CLI   SUBTTYP,49          T/SHEET POSTING SHARES TRSSTAT4 BITS         
         BE    PRCT32              SKIP                                         
         USING TRSELD,R2                                                        
         ICM   R2,15,AELEM60                                                    
         BZ    PRCT32                                                           
         TM    TRSSTAT5,TRSSINVQ   TEST BRANDOCEAN INVOICE POSTING              
         BZ    PRCT32                                                           
         TM    TRSSTAT4,TRSSSUBT   =SUBMITTED                                   
         BZ    *+12                                                             
         MVI   CURBOSTS,COLNBISB                                                
         B     PRCT32                                                           
         TM    TRSSTAT4,TRSSSJAT   =PART APPROVED                               
         BZ    *+12                                                             
         MVI   CURBOSTS,COLNBIPA                                                
         B     PRCT32                                                           
         TM    TRSSTAT4,TRSSREJT   =REJECTED                                    
         BZ    *+12                                                             
         MVI   CURBOSTS,COLNBIRJ                                                
         B     PRCT32                                                           
         TM    TRSSTAT4,TRSSQERD   =QUERY                                       
         BZ    *+12                                                             
         MVI   CURBOSTS,COLNBIQR                                                
         B     PRCT32                                                           
         CLI   TRSSTAT4,TRSSFAPT   =APPROVED (=0, =DEFAULT)                     
         BNE   PRCT32                                                           
         MVI   CURBOSTS,COLNBIAP                                                
*&&                                                                             
PRCT32   XC    WORK,WORK           CLEAR AGAIN                                  
         TM    TRNSTAT,TRNSDR      IS IT A DEBIT?                               
         BO    PRCT42              Yes                                          
         MVI   CURAPRV,YES         Set approved status based on CR              
*&&US*&& MVI   CURAPRB,GDAAPPMK    Set approved by marker                       
         TM    TRNSTAT,TRNSAPPR    Approved item?                               
         BO    PRCT33              YES AN APPROVED ITEM                         
         MVI   CURAPRV,NO          NOT APPROVED                                 
*&&US*&& MVI   CURAPRB,00                                                       
         B     PRCT40                                                           
                                                                                
PRCT33   DS    0H                                                               
                                                                                
*&&US                                                                           
EL       USING GDAELD,R4                                                        
PRCT34   CLI   0(R4),0             NO 'E5' GDALED                               
         BE    PRCT42                                                           
         CLI   0(R4),GDAELQ                                                     
         BNE   PRCT36                                                           
         CLI   EL.GDATYPE,GDAAPP                                                
         BE    PRCT38                                                           
PRCT36   ZIC   R1,1(,R4)                                                        
         AR    R4,R1                                                            
         B     PRCT34                                                           
*                                                                               
PRCT38   MVC   CURAPRB,EL.GDATSUB                                               
         DROP  EL                                                               
         L     R4,ADTRANS                                                       
*&&                                                                             
PRCT40   MVI   CURURGT,YES                                                      
         TM    TRNSTAT,TRNSURG     MARKED URGENT ITEM?                          
         BO    *+8                 YES AN MARKED URGENT ITEM                    
         MVI   CURURGT,NO                                                       
*                                                                               
PRCT42   TM    CURXSTA1,TRXSRHLD   HELD ITEM?                                   
         BZ    *+8                                                              
         OI    CURSTAT,CURHELD     SET MY STATUS                                
*                                                                               
         CLI   QPROG,RECEIVABLE    Deb Scribe ?                                 
         BNE   *+16                No                                           
         TM    CURXSTA1,TRXSRQRD   QUERIED ITEM?                                
         BZ    *+8                                                              
         OI    CURSTAT,CURQURD     SET MY STATUS                                
*                                                                               
*&&UK*&& TM    CURXSTA1,TRXSRCLR   CLEARED ITEM?                                
*&&UK*&& BZ    *+8                                                              
*&&UK*&& OI    CURSTAT,CURCLRD     SET MY STATUS                                
         MVI   CURTIME,C' '                                                     
*&&UK                                                                           
         CLI   QPROG,PRODUCTION                                                 
         BNE   PRCT48                                                           
         MVI   CURTIME,C'A'        All Time                                     
         CLC   =C'1R',CURSUBAC+1   Time posting?                                
         BNE   PRCT48              No - ok                                      
         MVI   CURTIME,C'B'                                                     
         CP    TRNSAMT,PKZERO      MEMO TRANSACTION ?                           
         BNE   PRCT48              NO                                           
         MVI   CURTIME,C'N'                                                     
*                                                                               
         USING SCIELD,R6                                                        
         L     R6,ADTRANS          Point R6 to first element                    
PRCT44   CLI   0(R6),0             End-of-record?                               
         BE    PRCT48                                                           
         CLI   0(R6),SCIELQ        Sciel element?                               
         BNE   PRCT46                                                           
         CLI   SCITYPE,SCITCRAT    .  Cost Rate?                                
         BNE   PRCT46                                                           
         CP    SCIAMNT,PKZERO                                                   
         BE    PRCT50                                                           
         MVI   CURTIME,C'R'                                                     
         B     PRCT50                                                           
                                                                                
PRCT46   XR    RF,RF               Bump to next element                         
         ICM   RF,1,1(R6)                                                       
         BZ    PRCT48              Funny element length                         
         AR    R6,RF                                                            
         B     PRCT44                                                           
*&&                                                                             
PRCT48   DS    0H                                                               
*&&US                                                                           
         USING PRTELD,R2                                                        
         ICM   R2,15,AELEM40                                                    
         BZ    PRCT50                                                           
         TM    PRTSTAT,PRTSBILQ                                                 
         BZ    *+8                                                              
         MVI   CURTIME,C'B'                                                     
         TM    PRTSTAT,PRTSNOTQ                                                 
         BZ    *+8                                                              
         MVI   CURTIME,C'N'                                                     
         TM    PRTSTAT,PRTSRTEQ                                                 
         BZ    *+8                                                              
         MVI   CURTIME,C'R'                                                     
*&&                                                                             
         USING TRSELD,R2                                                        
PRCT50   MVI   CUROFST,NO                                                       
         ICM   R2,15,AELEM60       TRANSACTION STATUS X'60'                     
         BZ    PRCT54              NONE FOUND                                   
                                                                                
         CLI   QPROG,PRODUCTION                                                 
         BNE   PRCT52                                                           
         CLI   TRSSTAT4,TRSSFAPT   FULLY APPROVED                               
         BNE   *+12                                                             
         MVI   CURBRTST,C'F'                                                    
         B     PRCT52                                                           
         TM    TRSSTAT4,TRSSSAVT   IN PROGRESS                                  
         BZ    *+12                                                             
         MVI   CURBRTST,C'I'                                                    
         B     PRCT52                                                           
         TM    TRSSTAT4,TRSSSUBT   SUBMITTED                                    
         BZ    *+12                                                             
         MVI   CURBRTST,C'S'                                                    
         B     PRCT52                                                           
         TM    TRSSTAT4,TRSSSJAT+TRSSMAAP   PART APPROVED                       
         BZ    PRCT52                                                           
         MVI   CURBRTST,C'P'                                                    
                                                                                
PRCT52   TM    TRSSTAT,TRSSOFFS    OFFSET ITEM?                                 
         BZ    *+8                 NO                                           
         MVI   CUROFST,YES         YES, OFFSET STATUS TO YES                    
         CLI   QPROG,CASH          BANK                                         
         BNE   PRCT54                                                           
         CLI   TRSMARK,TRSMBRQ     RECONCILED ?                                 
         BNE   *+8                                                              
         OI    CURSTAT,CURRCON     YES                                          
         CLI   TRSMARK,TRSMBVQ     VOIDED     ?                                 
         BNE   *+8                                                              
         OI    CURSTAT,CURVOID     YES                                          
         DROP  R2                                                               
*                                                                               
PRCT54   MVI   CURRECON,NO         Set to not reconciled                        
         TM    CURSTAT,CURRCON     Was it reconciled ?                          
         BZ    *+8                                                              
         MVI   CURRECON,YES        Yes, set to reconciled                       
*                                                                               
         ZAP   PACKAMT,PKZERO                                                   
         GOTO1 PARSE,DMCB,GETCSHD,PACKAMT,0                                     
         BNE   PRCT56                                                           
         CP    PACKAMT,PKZERO                                                   
         BE    PRCT56                                                           
         OI    PAIRIND,PAIRCSHD    Set to found cash discount                   
         OI    CURSTAT,CURCSHD                                                  
*                                                                               
         USING TRSELD,R2                                                        
PRCT56   ICM   R2,15,AELEM60       X'60' STATUS ELEMENT                         
         BZ    PRCT58              No status elem, assume not a X-job           
         TM    TRSSTAT3,TRSSXJOB   X-job ?                                      
         BZ    PRCT58                                                           
         OI    PAIRIND,PAIRXJOB    Set as X-job                                 
         DROP  R2                                                               
*                                                                               
PRCT58   CLI   QPROG,RECEIVABLE    IS IT RCV REPORT?                            
         BNE   PRCT60              ANY FILTERING PARTICIPANT                    
         GOTO1 PARSE,DMCB,GETRTLC,CURPART,0                                     
*                                                                               
PRCT60   TM    CURLDGR+3,PAR_1C    INCOME TYPE 1C W/11,12 CONTRA ONLY           
         BZ    PRCT62                                                           
         LA    RE,CURACC+3         GET CLIENT PROD INTO CURSJACC                
         AH    RE,DSP2CLI                                                       
         LH    RF,SJJOBDSP         LENGTH OF CLI+PRD                            
         BCTR  RF,0                                                             
         EXMVC RF,CURSJACC,0(RE)                                                
*                                                                               
PRCT62   CLI   QPROG,EXPENSE                                                    
         BNE   PRCT66                                                           
*&&US                                                                           
         USING EXOELD,R2                                                        
         CLI   TRNTYPE,12          Purchase order                               
         BNE   PRCT64                                                           
         ICM   R2,15,AELEM97       EXOELQ                                       
         BZ    PRCT64                                                           
         LA    RE,CURSJACC                                                      
         SR    RF,RF                                                            
         IC    RF,SJCLILEN         Lenght of client                             
         BCTR  RF,0                                                             
         EXMVC RF,CURSJACC,EXOCLI                                               
         LA    RE,CURSJACC+1(RF)   Point  to product                            
         IC    RF,SJPRDLEN         Length of product                            
         BCTR  RF,0                                                             
         EXMVC RF,0(RE),EXOPRO     Move in product                              
         MVC   DFTCLI,EXOCLI                                                    
         MVC   DFTPRD,EXOPRO                                                    
                                                                                
         CLC   EXODEP,SPACES                                                    
         BNH   PRCT64                                                           
         MVC   CURDEPT(2),=C'2D'                                                
         LA    RF,EXOAOF           Analysis office                              
         CLC   EXOAOF,SPACES                                                    
         BH    *+8                                                              
         LA    RF,EXODOF           Debit office                                 
         MVC   CURDEPT+2(2),0(RF)                                               
                                                                                
         LA    RE,CURDEPT+3        If one character office                      
         CLI   NEWOFF,YES                                                       
         BNE   *+8                                                              
         LA    RE,CURDEPT+4        If two character office                      
         MVC   0(L'EXODEP,RE),EXODEP                                            
                                                                                
         USING LDGD,R3                                                          
         CLC   EXOPER,SPACES                                                    
         BNH   PRCT64                                                           
         GOTOR GETLDGR,DMCB,=C'2P'                                              
         L     R3,DMCB             GET ENTERY                                   
         CLC   CURPRSN,SPACES      Was this set?                                
         BH    PRCT64              Yes so leave it as is                        
         MVC   CURPRSN,SPACES                                                   
         MVC   CURPRSN,=C'2P'                                                   
         MVC   CURPRSN+2(L'CURPRSN-2),CURDEPT+2                                 
         SR    RF,RF                                                            
         IC    RF,LDGLEV2                 Length of off/dept                    
         LA    RE,CURPRSN+2(RF)           A(Where person code goes)             
         MVC   0(L'EXOPER,RE),EXOPER      Move in person code                   
         DROP  R2,R3                                                            
*&&                                                                             
PRCT64   XC    CURANOF,CURANOF                                                  
         GOTO1 PARSE,DMCB,GETANOF,CURANOF,0                                     
         B     PRCT72                                                           
*                                                                               
PRCT66   CLI   TRNTYPE,6           SPECIAL TYPE, MANUAL BILLING                 
         BNE   PRCT68                                                           
         CLC   TRNBREF,SPACES                                                   
         BH    PRCT72                                                           
         MVI   SUBTTYP,TY06MN                                                   
*                                                                               
PRCT68   CLI   TRNTYPE,30          SPECIAL TYPE FROM RCV PROGRAM                
         BNE   PRCT72                                                           
         ICM   R2,15,AELEMD9                                                    
         BZ    PRCT72                                                           
         CLI   SUBTTYP,TY30DI      DIFFERENCE POSTING TYPE                      
         BE    PRCT72              YES SO SUBTTYP ALREADY SET                   
*                                                                               
         USING RALELD,R2                                                        
         SR    R1,R1                                                            
         L     RE,ATTYPE                                                        
PRCT70   CLI   0(RE),EOT           End of table ?                               
         BNE   *+6                 No                                           
         DC    H'0'                Unknow type                                  
         MVC   SUBTTYP,4(RE)       Sub-transaction type                         
         CLC   RALTYPE,5(RE)       Match on special type                        
         BE    PRCT72                                                           
         AHI   RE,6                Bump up in TYPETAB (ACRL05)                  
         B     PRCT70                                                           
*                                                                               
PRCT72   CLI   QPROG,RECEIVABLE                                                 
         BE    PRCT74                                                           
         CLI   QPROG,PAYABLES                                                   
         BNE   PRCT80                                                           
*                                                                               
PRCT74   CLI   NEWTRAN,YES                                                      
         BNE   PRCT76                                                           
         XC    DUEDTE,DUEDTE                 Get Due Date before it             
         GOTO1 PARSE,DMCB,GETDDTE,DUEDTE,0   is filtered out                    
*                                                                               
PRCT76   OC    RMOASTR,RMOASTR     Request MOA start date ?                     
         BZ    PRCT78              No                                           
         CLC   RMOASTR,MOADTE      Yes, so filter out now                       
         BH    XITMODE                                                          
*                                                                               
         USING TRSELD,R2                                                        
PRCT78   OC    RACTSTR,RACTSTR     Request Activity start date ?                
         BZ    PRCT80              No                                           
         ICM   R2,15,AELEM60       Get activity date                            
         BZ    PRCT80              None                                         
         CLC   TRSDATE,RACTSTR     Is activity less then start                  
         BL    XITMODE             Yes                                          
         DROP  R2                                                               
*                                                                               
PRCT80   CLC   CURCOST,SPACES                                                   
         BH    PRCT82                                                           
         MVC   CURCOST(2),=C'1C'   Default                                      
         GOTO1 PARSE,DMCB,GETCSTC,WORK,0                                        
         BNE   PRCT82                                                           
         MVC   CURCOST,WORK                                                     
         CLC   =C'1C',CURCOST                                                   
         BE    PRCT82                                                           
         MVC   CURCOST+2(L'CURCOST-2),WORK                                      
*                                                                               
         USING JOBAGEID,R1                                                      
PRCT82   CLI   QPROG,PRODUCTION                                                 
         BNE   PRCT84                                                           
         CLI   AGECOL#,0                                                        
         BE    PRCT84                                                           
         L     R1,JBAGEBLK         JOB AGEING BLOCK                             
         MVI   JAIMODE,JAITRANS                                                 
         MVC   JAIJOBR,ADACC       JOB RECORD                                   
         MVC   JAIATX,ADTRANS      TRANSACTION RECORD (START AT X'44')          
         MVC   JAIPRATA,PRORATA2   RE-BUILT PRORATA BLOCK                       
         MVC   JAIDDISP,DATADISP                                                
         MVC   JAITXMOA,MOADTE                                                  
         MVI   JAIEXJOB,0                                                       
         TM    ACCSTAT,ACCXJOB     EXPENSE JOB?                                 
         BZ    *+8                                                              
         MVI   JAIEXJOB,JAIEXXJ                                                 
         GOTO1 JOBAGE                                                           
         DROP  R1                                                               
*                                                                               
PRCT84   DS    0H                                                               
*&&UK*&& MVI   CURVATRG,C' '                                                    
         XC    CURESTET,CURESTET                                                
         CLI   QPROG,PRODUCTION                                                 
         BE    *+8                                                              
         CLI   QPROG,PAYABLES                                                   
         BE    *+12                                                             
         CLI   QPROG,RECEIVABLE                                                 
         BNE   PRCT88                                                           
*                                                                               
         ICM   RF,15,AELEMDB                                                    
         USING FFTELD,RF                                                        
         XR    R1,R1                                                            
         B     *+10                                                             
PRCT86   IC    R1,FFTLN                                                         
         AR    RF,R1                                                            
         CLI   FFTEL,0                                                          
         BE    PRCT88                                                           
         CLI   FFTEL,FFTELQ                                                     
         BNE   PRCT86                                                           
*&&UK                                                                           
         CLI   FFTTYPE,FFTTEXTY                                                 
         BNE   *+14                                                             
         MVC   CURETYPE,FFTDATA                                                 
         B     PRCT86                                                           
         CLI   FFTTYPE,FFTTAXLO    RIGHT TYPE?                                  
         BNE   *+14                NO, SO SKIP                                  
         MVC   CURVATRG,FFTAXLOC                                                
         B     PRCT86                                                           
*&&                                                                             
         CLI   FFTTYPE,FFTTESTN    Estimate number?                             
         BNE   PRCT86                                                           
         MVC   CURESTET,FFTESTN                                                 
         B     PRCT86                                                           
         DROP  R4,RF                                                            
                                                                                
PRCT88   DS    0H                                                               
*&&UK                                                                           
         TM    RECREAD3,RECXDATA   Read for XDATA on transaction                
         BZ    PRCT90                                                           
         GOTOR GETXDAT             SAVE XDATA AWAY FOR FILTERING LATER          
*&&                                                                             
PRCT90   OC    CURESTET,CURESTET   BrandOcean estimate on transaction?          
         BZ    PRCT100                                                          
         GOTOR GTBESTA                                                          
*                                                                               
PRCT100  DS    0H                                                               
*&&US                                                                           
         CLI   QPROG,PAYABLES                                                   
         BNE   PRCT120                                                          
         CLC   =C'SY',CURACC+1                                                  
         BE    PRCT105                                                          
         CLC   =C'SX',CURACC+1                                                  
         BE    PRCT105                                                          
         CLC   =C'SW',CURACC+1                                                  
         BE    PRCT105                                                          
         CLC   =C'SV',CURACC+1                                                  
         BNE   PRCT120                                                          
PRCT105  ICM   RF,15,AELEMDB                                                    
         USING FFTELD,RF                                                        
         XR    R1,R1                                                            
         B     *+10                                                             
*                                                                               
PRCT110  IC    R1,FFTLN                                                         
         AR    RF,R1                                                            
         CLI   FFTEL,0                                                          
         BE    PRCT120                                                          
         CLI   FFTEL,FFTELQ                                                     
         BNE   PRCT110                                                          
         CLI   FFTTYPE,FFTTCLPR                                                 
         BNE   PRCT110                                                          
         MVC   CURSJACC(3),FFTCLAC                                              
         MVC   DFTCLI,FFTCLAC                                                   
         B     PRCT110                                                          
         DROP  RF                                                               
*                                                                               
PRCT120  DS    0H                                                               
*&&                                                                             
         EJECT ,                                                                
**********************************************************************          
FLTTRNS  TM    UPSI,UPSITRNS                                                    
         BZ    FLTT20                                                           
         GOTO1 =A(DUMPTKEY),2                                                   
                                                                                
*---------------------------------------------------------------------*         
*  Restore data for recaps before filtering                           *         
*---------------------------------------------------------------------*         
FLTT20   TM    RECAPSW,RECAPON                                                  
         BZ    FLTT30                                                           
         TM    SPLITSW,SPLITRST    Do we need to restore copied data ?          
         BZ    FLTT30              No                                           
         XC    AELEM77B(12),AELEM77B                                            
         L     RE,PTABASE          Copy of PTAWRK for recaps                    
         L     R0,APTAWRK          PTAEL work area                              
         LHI   R1,IOSIZEQ          length of PTAWRK                             
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
         BRAS  RE,PTADATA                                                       
*                                                                               
         L     R2,LNKBASE                                                       
FLTT26   CLI   0(R2),0             End of area                                  
         BE    FLTT28                                                           
         MVI   0(R2),LNKELQ        X'BA' Link studio elements                   
         IC    RF,1(,R2)                                                        
         AR    R2,RF                                                            
         B     FLTT26                                                           
*                                                                               
         USING TRNRECD,RE                                                       
FLTT28   L     RE,ADTRANS          Restore tranaction record                    
         SH    RE,DATADISP                                                      
         L     R0,ASAVTRNS         Transaction record saved                     
         SR    RF,RF                                                            
         ICM   RF,3,TRNRLEN                                                     
         LR    R1,RF                                                            
         MVCL  RE,R0                                                            
         DROP  RE                                                               
*                                                                               
         XC    AELEM1A(AELEMQ),AELEM1A                                          
         XC    AELMTMS1(AELMTMSQ),AELMTMS1                                      
         XC    AELEM50T,AELEM50T                                                
         GOTOR SETELEM             Refind and reset element addresses           
*                                                                               
         USING TRNELD,R4                                                        
FLTT30   L     R4,ADTRANS                RELOAD TRANSACTION ADDRESS             
         GOTO1 AFILTER,DMCB,AFLTUNL,QUNIT                                       
         BNE   XITNEXT                                                          
         TM    FCIND,FCIXNFC+FCIFOUND    EXCLUDE NON FOREIGN CURRENCY           
         BO    XITNEXT             YES                                          
*                                                                               
         GOTO1 AFILTER,DMCB,AFLTCTRA,CURSUBAC+1                                 
         BNE   XITNEXT                                                          
*                                                                               
         TM    DDLNKIND,DDLNKON+DDLNKTST RUNNING UNDER DDLINK ?                 
         BZ    FLTT32                    NO - SKIP CHECKING REVERSAL            
         TM    TRNSTAT,TRNSREV           IS IT A REVERSAL                       
         BO    *+16                      YES                                    
         TM    FMTROPT,RPFORVRS          NO REVERSED ITEMS ONLY ?               
         BO    XITNEXT                   YES                                    
         B     *+12                      KEEP THIS ONE                          
         TM    FMTROPT,RPFXRVRS          EXCLUDE REVERSED ITEMS ?               
         BO    XITNEXT                                                          
*                                                                               
FLTT32   CLI   QPROG,PRODUCTION                                                 
         BNE   FLTT36                                                           
         GOTOR FLTPROD                                                          
         BNE   XITNEXT                                                          
         NI    PARCNTRL,TURNOFF-PARBYWC    Turn off                             
         TM    FMTROPT6,RPFBYWC    Report by workcode                           
         BZ    FLTT34              No                                           
         TM    CURIND,CURBILCR     Billed credit hense % of est.                
         BZ    FLTT34              No                                           
         OI    PARCNTRL,PARBYWC    Set on to report by workcode                 
*                                                                               
FLTT34   TM    FMTROPT6,RPFOEXIV   External invoices only? (CashFlow)           
         BZ    FLTT36               No, continue                                
         TM    TRNSTAT,TRNSDR      Keep all credits                             
         BZ    FLTT36               keep                                        
         CLC   TRNANAL,=C'**'      All Purchase orders                          
         BE    FLTT36               keep                                        
         OC    AELEMD4,AELEMD4     x'D4'- true vendor info                      
         BZ    XITNEXT                                                          
*                                                                               
FLTT36   DS    0H                                                               
         CLI   QPROG,PAYABLES                                                   
         BNE   FLTT68                                                           
*&&UK                                                                           
         USING MPYELD,RF                                                        
         L     RF,ADTRANS          Look for MPYEL                               
         SR    R0,R0                                                            
         MVI   BYTE,0                                                           
FLTT38   IC    R0,TRNLN                                                         
         AR    RF,R0                                                            
         CLI   MPYEL,0                                                          
         BE    FLTT40                                                           
         CLI   MPYEL,MPYELQ                                                     
         BNE   FLTT38                                                           
         CLC   MPYNO,SPACES                                                     
         BNH   FLTT40                                                           
         OC    MPYDTE,MPYDTE                                                    
         BZ    FLTT40                                                           
         MVI   BYTE,1              Payment details set                          
                                                                                
         USING TRSELD,RF                                                        
FLTT40   ICM   RF,15,AELEM60       Status el                                    
         BZ    FLTT50              No TRSEL?                                    
         OC    TRSUMOS,TRSUMOS                                                  
         BZ    FLTT46              = not paid                                   
         CLI   TRNTYPE,36          Test manual payment trx                      
         BNE   FLTT42                                                           
         CLI   TRSMARK,TRSMBVQ     Test Marker Bank Void action                 
         BNE   FLTT42                                                           
         CP    TRNAMNT,PKZERO      Test +CR                                     
         BNH   FLTT42                                                           
         CLI   BYTE,0              Test payment details not set                 
         BE    FLTT44                                                           
         B     FLTT46                                                           
                                                                                
FLTT42   CLI   TRSMARK,TRSMCCQ     Test Marker manual cheque action             
         BNE   FLTT46                                                           
FLTT44   TM    FMTROPT7,RPFXMAPY   Test excluding manual payments+invs          
         BZ    FLTT50                                                           
         CLC   TRSUMOS,RMOAEND     Test paid within request MOA range           
         BNH   XITNEXT             yes - exclude                                
         B     FLTT50                                                           
                                                                                
FLTT46   TM    FMTROPT7,RPFOMAPY   Test only want manual payments               
         BNZ   XITNEXT             Not marke(re)d, so don't want this           
         B     FLTT50                                                           
         DROP  RF                                                               
*&&                                                                             
FLTT50   DS    0H                                                               
*&&US                                                                           
         TM    PAIRIND,PAIRXJOB    Is this an x-job                             
         BO    *+16                Yes                                          
         TM    FMTROPT4,RPFOEXPS   No, Only X-Jobs ?    (Payables)              
         BO    XITNEXT             Yes                                          
         B     *+12                Keep this one                                
         TM    FMTROPT4,RPFXEXPS   Exclude X-Jobs ?                             
         BO    XITNEXT                                                          
                                                                                
         CLC   CURMMOS(2),RQMMOSST    Is the Media MOS within range?            
         BL    XITMODE                No                                        
         CLC   CURMMOS(2),RQMMOSEN    How about the end?                        
         BH    XITMODE                No                                        
*&&                                                                             
*&&UK*&& GOTO1 AFILTER,DMCB,AFLTAUTH,CURAUTH2                                   
*&&UK*&& BNE   XITNEXT                                                          
*                                                                               
FLTT68   TM    ACTIVITY,ACTEST     DID WE HAVE ESTIMATES?                       
         BO    *+16                YES SO DO WE WANT THE TRANS.                 
         TM    FMTROPT4,RPFOESTO   ONLY JOBS WITH ESTIMATES?                    
         BO    XITNEXT                                                          
         B     *+12                                                             
         TM    FMTROPT4,RPFXESTO   ONLY JOBS WITHOUT ESTIMATES?                 
         BO    XITNEXT                                                          
*                                                                               
         CLI   CURAPRV,YES         NOT APPROVED                                 
         BE    *+16                YES AN APPROVED ITEM                         
         TM    FMTROPT1,RPFOAPRV   ONLY APPROVED ITEMS?                         
         BO    XITNEXT             ONLY WANT APPROVED ITEMS                     
         B     *+12                                                             
         TM    FMTROPT1,RPFXAPRV   EXCLUDE APPROVED ITEMS?                      
         BO    XITNEXT             ELIMINATE APPROVED ITEMS                     
*                                                                               
         CLI   CURURGT,YES                                                      
         BE    *+16                YES AN MARKED URGENT ITEM                    
         TM    FMTROPT2,RPFOUGNT   ONLY MARKED URGENT ITEMS?                    
         BO    XITNEXT             ONLY WANT MARKED URGENT ITEMS                
         B     *+12                                                             
         TM    FMTROPT2,RPFXUGNT   EXCLUDE MARKED URGENTITEMS?                  
         BO    XITNEXT             ELIMINATE MARKED URGENT ITEMS                
*                                                                               
         CLI   QPROG,CASH          CHECK CASH REPORTS FOR RECONCILED            
         BNE   FLTT70                                                           
         TM    CURSTAT,CURRCON                                                  
         BO    *+16                YES, IT IS                                   
         TM    FMTROPT5,RPFOBRI    BANK RECONCILED ONLY                         
         BO    XITNEXT                                                          
         B     *+12                                                             
         TM    FMTROPT5,RPFXBRI    BANK RECONCILED EXCLUDE                      
         BO    XITNEXT                                                          
*                                                                               
FLTT70   CLI   QPROG,RECEIVABLE    NOT HELD RECEIVABLES                         
*&&UK*&& BE    FLTT84                                                           
*&&US*&& BE    FLTT72                                                           
         TM    TRNSTAT,TRNSHOLD    HELD ITEM?                                   
         BO    *+16                YES A HELD ITEM                              
         TM    FMTROPT1,RPFOHELD   ONLY HELD ITEMS?                             
         BO    XITNEXT             ONLY WANT HELD ITEMS                         
         B     *+12                                                             
         TM    FMTROPT1,RPFXHELD   EXCLUDE HELD ITEMS?                          
         BO    XITNEXT             ELIMINATE HELD ITEMS                         
         B     FLTT88                                                           
*&&US                                                                           
FLTT72   TM    DATEFLT,DATEXMT     TRANSMIT DATE FILTERING?                     
         BZ    FLTT84              NO - SKIP FILTERING                          
*                                                                               
EL       USING GDAELD,R4                                                        
         TM    TRNSTAT,TRNSDR      DATE NOT ON DEBIT - GET IT FROM              
         BZ    FLTT80              PREVIOUS CREDIT                              
*                                                                               
FLTT74   XC    STMTDTE,STMTDTE     CLEAR DATE                                   
         CLI   0(R4),0             NO 'E5' GDALED                               
         BE    FLTT80                                                           
         CLI   0(R4),GDAELQ                                                     
         BE    FLTT76                                                           
         CLI   EL.GDATYPE,GDATEDI                                               
         BE    FLTT78                                                           
FLTT76   ZIC   R1,1(,R4)                                                        
         AR    R4,R1                                                            
         B     FLTT74                                                           
*                                                                               
FLTT78   MVC   STMTDTE,EL.GDADATE                                               
         DROP  EL                                                               
*                                                                               
FLTT80   OC    ALTNSTR,ALTNSTR     Any start date specified ?                   
         BZ    FLTT82              No, Skip to end date filtering               
         OC    STMTDTE,STMTDTE     Do I have a transmit date ?                  
         BZ    XITNEXT        ??   IF NONE EXCLUDE TRANSACTION                  
         CLC   ALTNSTR,STMTDTE     COMPARE TRANSMIT DATE TO REQ                 
         BH    XITNEXT             PARAMETERS                                   
*                                                                               
FLTT82   OC    ALTNEND,ALTNEND     ANY END DATE SPECIFIED                       
         BZ    FLTT84              EXIT TRANSMIT DATE FILTERING                 
         OC    STMTDTE,STMTDTE     DO I HAVE A TRANSMIT DATE                    
         BZ    XITNEXT        ??   IF NONE EXCLUDE TRANSACTION                  
         CLC   ALTNEND,STMTDTE     COMPARE TRANSMIT DATE TO REQ                 
         BL    XITNEXT             PARAMETERS                                   
*&&                                                                             
FLTT84   SR    R1,R1               CLEAR TEST BITS                              
         SR    RF,RF               SET NOT TO BRANCH                            
         TM    FMTROPT1,RPFOHELD   ONLY WANT HELD?                              
         BZ    *+8                                                              
         LA    R1,CURHELD          TEST HELD BIT                                
         TM    FMTROPT2,RPFOQRED   ONLY WANT QUERIED?                           
         BZ    *+8                                                              
         LA    R1,CURQURD(,R1)     TEST QUERIED BIT                             
         LTR   R1,R1               IF ANY TURNED ON THEN TAKE BRANCH            
         BZ    *+8                                                              
         LA    RF,BZ                                                            
*                                                                               
         TM    FMTROPT1,RPFXHELD   IF EXCLUDE HELD                              
         BO    *+8                                                              
         TM    FMTROPT2,RPFXQRED   IF EXCLUDE QUERIED?                          
         BZ    FLTT86                                                           
         LA    R1,CURHELD+CURQURD                                               
         LA    RF,BNZ              EXCLUDE IF ANY ON                            
*                                                                               
FLTT86   EX    R1,*+16             SET CON-CODE WITH TEST UNDER MASK            
         EX    RF,*+8              TAKE BRANCH                                  
         NOP   FLTT86              (*+4 -> *+8)                                 
         NOP   XITNEXT             SET AS NON-BRANCH CONDITION                  
         TM    CURSTAT,0                                                        
*                                                                               
FLTT88   CLI   TIMESTA2,0          Filters setup                                
         BE    FLTT90              No, so don't filter                          
*&&US                                                                           
         USING PRTELD,R2                                                        
         ICM   R2,15,AELEM40                                                    
         BZ    FLTT90                                                           
         MVC   BYTE,PRTSTAT        GET TYPE OF TIME                             
         NI    BYTE,PRTSBILQ+PRTSNOTQ+PRTSRTEQ                                  
         DROP  R2                                                               
*&&                                                                             
*&&UK                                                                           
         MVI   BYTE,0                                                           
         CLI   CURTIME,C'A'        All-time                                     
         BNE   *+8                                                              
         OI    BYTE,TIMEB+TIMER+TIMEN                                           
         CLI   CURTIME,C'B'                                                     
         BNE   *+8                                                              
         OI    BYTE,TIMEB          B-time (billable)                            
         CLI   CURTIME,C'R'                                                     
         BNE   *+8                                                              
         OI    BYTE,TIMER          R-time                                       
         CLI   CURTIME,C'N'                                                     
         BNE   *+8                                                              
         OI    BYTE,TIMEN          N-Time                                       
*&&                                                                             
         NC    BYTE,TIMESTA2                                                    
         BZ    XITNEXT             Not the time we needed                       
                                                                                
FLTT90   EQU   *                                                                
*&&UK                                                                           
         CLI   VATRGSTA,0          No VAT region filter                         
         BE    FLTT91                                                           
         MVI   BYTE,0                                                           
         CLI   CURVATRG,C' '       No VAT region setting                        
         BH    *+8                                                              
         OI    BYTE,VATRGNAT       Yes - treat it as National                   
         CLI   CURVATRG,DDTAXLNQ   N - National                                 
         BNE   *+8                                                              
         OI    BYTE,VATRGNAT                                                    
         CLI   CURVATRG,DDTAXLEQ   E - European                                 
         BNE   *+8                                                              
         OI    BYTE,VATRGEU                                                     
         CLI   CURVATRG,DDTAXLXQ   X - Foreign but non european                 
         BNE   *+8                                                              
         OI    BYTE,VATRGNEU                                                    
                                                                                
         NC    BYTE,VATRGSTA                                                    
         BZ    XITNEXT             Not the time we needed                       
*&&                                                                             
FLTT91   L     RF,AXESGLB          Filter by global estimate number             
         CLI   0(RF),EOT                                                        
         BE    FLTT92                                                           
                                                                                
         XR    RE,RE                                                            
         USING FFTELD,R2                                                        
         ICM   R2,15,AELEMDB                                                    
         BZ    FLTT92                                                           
FLTT91A  CLI   FFTEL,0                                                          
         BE    FLTT92                                                           
         CLI   FFTTYPE,FFTTESTN                                                 
         BE    FLTT91D                                                          
FLTT91B  IC    RE,FFTLN                                                         
         AR    R2,RE                                                            
         B     FLTT91A                                                          
                                                                                
FLTT91D  CLC   FFTESTN,0(RF)                                                    
         BE    XITNEXT                                                          
         LA    RF,L'FFTESTN(RF)                                                 
         CLI   0(RF),EOT                                                        
         BNE   FLTT91D                                                          
*                                                                               
FLTT92   DS    0H                                                               
*&&UK                                                                           
         TM    FMTXDATA,FMTXNAME   Any extra data name/value filters            
         BZ    FLTT122                                                          
         L     RE,AXDATAN                                                       
         CLI   0(RE),X'FF'         Any extra data on trnx?                      
         BNE   FLTT93              Yes                                          
         TM    FMTXDATA,FMTXVALU   No, any filtering by xdata values?           
         BZ    FLTT122             No so keep                                   
*                                                                               
FLTT93   L     R2,ARESREC                                                       
         AH    R2,DATADISP                                                      
         MVI   BYTE,0              TO CONTAIN SEQUENCE NUMBER                   
*                                                                               
         USING RFLELD,R2                                                        
FLTT94   CLI   RFLEL,0                                                          
         BE    FLTT122                                                          
         CLI   RFLEL,RFLELQ                                                     
         BNE   FLTT98                                                           
FLTT96   CLI   RFLTYPE,RFLXDATN    DATA NAME                                    
         BE    FLTT100                                                          
         CLI   RFLTYPE,RFLXDATV    DATA VALUE                                   
         BE    FLTT100                                                          
FLTT98   XR    RE,RE                                                            
         IC    RE,RFLLN                                                         
         AR    R2,RE                                                            
         B     FLTT94                                                           
*                                                                               
FLTT100  TM    RFLIND,RFLXDEST                                                  
         BNZ   FLTT98                                                           
         XC    WORK,WORK           COPY RFLDATA                                 
         XR    RE,RE                                                            
         IC    RE,RFLLN                                                         
         SHI   RE,RFLLNQ                                                        
         SHI   RE,1                                                             
         BM    XITNEXT                                                          
         LA    RF,L'WORK                                                        
         CR    RE,RF                                                            
         BNH   *+6                                                              
         LR    RE,RF                                                            
         MVC   WORK+1(0),RFLDATA                                                
         EX    RE,*-6                                                           
*                                                                               
         XR    R3,R3                                                            
         LA    R1,1               (MUST BE AT LEAST ONE XDATA ENTRY)            
         LA    RE,WORK+1                                                        
         AHI   RE,L'WORK-2         POINT TO END OF 'WORK'                       
         LA    RF,L'WORK-1                                                      
         CLI   0(RE),0                                                          
         BNE   FLTT102             GET TO SIGNIFICANT DATA                      
         SHI   RE,1                                                             
         BCT   RF,*-12                                                          
         DC    H'0'                                                             
FLTT102  TM    0(RE),X'40'                                                      
         BNZ   FLTT104                                                          
         AHI   R1,1                                                             
         STC   R3,0(RE)            STORE LENGTH OF RFLDATA ENTRY                
         XR    R3,R3                                                            
         B     *+8                                                              
FLTT104  AHI   R3,1                                                             
         SHI   RE,1                                                             
         BCT   RF,FLTT102                                                       
         STC   R3,WORK             STORE LENGTH OF FIRST RFLDATA ENTRY          
         STC   R1,BYTE1            BYTE1=# OF ITEMS IN RFLDATA                  
*                                                                               
         CLI   RFLTYPE,RFLXDATN                                                 
         BE    FLTT106                                                          
         CLI   RFLTYPE,RFLXDATV                                                 
         BE    FLTT114                                                          
*                                 *LOOK FOR A DATA NAME MATCH*                  
                                                                                
FLTT106  L     RE,AXDATAN          EXTRA DATA NAMES FROM TRNX                   
         LA    RF,WORK             EXTRA DATA NAMES FROM COLFILT                
         MVI   BYTE2,0             TO CONTAIN DISPLACEMENT/INDEX                
         XR    R0,R0                                                            
         XR    R3,R3                                                            
         IC    R3,BYTE1                                                         
*                                                                               
FLTT108  CLC   0(1,RE),0(RF)                                                    
         BE    FLTT112                                                          
FLTT110  IC    R0,BYTE2                                                         
         AHI   R0,1                                                             
         STC   R0,BYTE2      KEEP TRACK OF HOW FAR INTO AXDATAN WE GO           
         AHI   RE,MAXXNL                                                        
         CLI   0(RE),X'FF'                                                      
         BNE   FLTT108                                                          
         XR    R1,R1                                                            
         IC    R1,0(RF)                                                         
         LA    RF,1(R1,RF)                                                      
         LA    RE,AXDATAN                                                       
         BCT   R3,FLTT108                                                       
         LR    RE,R2                                                            
         IC    R1,RFLLN           NO XDATA NAME MATCH BUT DOES A                
         AR    RE,R1              DATA VALUE ELEMENT FOLLOW FOR                 
NXT      USING RFLELD,RE          THIS COLUMN?                                  
         CLI   NXT.RFLEL,0                                                      
         BE    FLTT122            NO                                            
         CLI   NXT.RFLEL,RFLELQ                                                 
         BNE   FLTT98             NO                                            
         LR    R2,RE                                                            
         CLI   NXT.RFLTYPE,RFLXDATV                                             
         BNE   FLTT96             NO                                            
         CLC   NXT.RFLSEQ,RFLSEQ                                                
         BE    XITNEXT            YES                                           
         B     FLTT98                                                           
         DROP  NXT                                                              
*                                                                               
FLTT112  XR    R1,R1                                                            
         IC    R1,0(RE)                                                         
         SHI   R1,1                                                             
         EXCLC R1,1(RE),1(RF)                                                   
         BNE   FLTT110             MOVE TO NEXT DATA NAME ON TRNX               
         MVC   BYTE,RFLSEQ                                                      
         B     FLTT98                                                           
*                                                                               
FLTT114  OC    BYTE,BYTE          *LOOK FOR A DATA VALUE MATCH*                 
         BZ    FLTT98                                                           
         CLC   BYTE,RFLSEQ                                                      
         BNE   FLTT98                                                           
         XR    R0,R0                                                            
         LA    R1,MAXXVL                                                        
         XR    RE,RE                                                            
         IC    RE,BYTE2                                                         
         MR    R0,RE                                                            
         LTR   R0,R0                                                            
         BZ    *+6                                                              
         DC    H'0'                TOO MUCH DATA?                               
         L     RE,AXDATAV          EXTRA DATA VALUES FROM TRNX                  
         AR    RE,R1               ADD DISPLACEMENT                             
*                                                                               
         LA    RF,WORK             EXTRA DATA VALUES FROM COLFILT               
         XR    R3,R3                                                            
         IC    R3,BYTE1                                                         
*                                                                               
FLTT116  XR    R1,R1                                                            
         CLC   0(1,RE),0(RF)                                                    
         BE    FLTT120                                                          
FLTT118  IC    R1,0(RF)                                                         
         LA    RF,1(R1,RF)                                                      
         BCT   R3,FLTT116                                                       
         B     XITNEXT                                                          
*                                                                               
FLTT120  IC    R1,0(RE)                                                         
         SHI   R1,1                                                             
         EXCLC R1,1(RE),1(RF)                                                   
         BNE   FLTT118             MOVE TO NEXT DATA VALUE ON TRNX              
         XC    BYTE,BYTE                                                        
         B     FLTT98              CHECK NEXT XDATA NAME IF ANY                 
         DROP  R2                                                               
*&&                                                                             
FLTT122  TM    ACCSTAT,ACCMCSE     BrandOcean job?                              
         BZ    FLTT128                                                          
         CLI   BESTAS,0            Any RFLBESTA BrO Est status filter?          
         BE    FLTT128             No                                           
         CLI   BESTAS,X'FF'        Include all statuses?                        
         BE    FLTT128             Yes, so no filtering needed                  
         OC    CURESTET,CURESTET                                                
         BZ    FLTT128                                                          
         L     R4,ADTRANS                                                       
         CP    TRNAMNT,PKZERO                                                   
         BNE   FLTT128                                                          
         L     R2,=A(BESTAB)                                                    
         LA    RF,BESTABX                                                       
FLTT124  MVC   BYTE,BESTAS                                                      
         NC    BYTE,0(R2)                                                       
         BZ    FLTT126                                                          
         MVC   BYTE,CURESTA1                                                    
         NC    BYTE,1(R2)                                                       
         BZ    FLTT126                                                          
         MVC   BYTE,CURESTA2                                                    
         NI    BYTE,X'FF'-(ESTKFCUR+ESTKLANG+ESTKBILP+ESTKBILA)                 
         XC    BYTE,2(R2)                                                       
         BZ    FLTT128             GOOD MATCH                                   
FLTT126  AHI   R2,BESTABQ                                                       
         BCT   RF,FLTT124                                                       
         B     XITNEXT                                                          
                                                                                
FLTT128  DS    0H                                                               
*&&UK                                                                           
         TM    CURSTAT,CURCLRD     CLEARED ITEM?                                
         BO    *+16                YES A HELD ITEM                              
         TM    FMTROPT3,RPFOCLRD   ONLY CLEARED ITEMS?                          
         BO    XITNEXT             ONLY WANT HELD ITEMS                         
         B     *+12                                                             
         TM    FMTROPT3,RPFXCLRD   EXCLUDE CLEARED ITEMS?                       
         BO    XITNEXT             ELIMINATE HELD ITEMS                         
*&&                                                                             
         CLI   CUROFST,YES         Offset item?                                 
         BE    *+16                Yes an offset item                           
         TM    FMTROPT1,RPFOOFFS   Only offset items?                           
         BO    XITNEXT             Not an offset so don't keep                  
         B     FLTT138             Option not on so keep                        
*&&US*&& TM    FMTROPT1,RPFXOFFS   Exclude offset items?                        
*&&US*&& BO    XITNEXT             Yes - we don't want this item                
         SPACE 1                                                                
***********************************************************************         
* If profile is set to exclude contra items and end MOA filter is used*         
* then include this contra item if it's split across MOA              *         
***********************************************************************         
*&&UK                                                                           
         CLI   QPROG,PAYABLES      PAYABLES SCRIBE                              
         BE    FLTT130                                                          
         TM    FMTROPT1,RPFXOFFS   Exclude offset items?                        
         BO    XITNEXT             Yes - we don't want this item                
         B     FLTT138                                                          
                                                                                
FLTT130  TM    FMTROPT1,RPFXOFFS   Exclude contra'd items                       
         BZ    FLTT138             Include so keep                              
                                                                                
EURO     USING TRNELD,RF                                                        
         L     RF,ADTRANS          include þ differences                        
         CLI   EURO.TRNTYPE,221                                                 
         BE    FLTT138                                                          
         CLI   EURO.TRNTYPE,239                                                 
         BE    FLTT138                                                          
         DROP  EURO                                                             
                                                                                
         CLC   QMOSPERD,SPACES     Exclude some but not all                     
         BE    XITNEXT             No - we don't want this item                 
*                                                                               
         USING TRNRECD,RF                                                       
         L     RF,ADTRANS                                                       
         SH    RF,DATADISP                                                      
         OC    ACCOUSED(ACCOULEN,RF),ACCOUSED(RF) TEST USED DATE SET            
         BZ    FLTT138             UNDISBURSED - CARRY ON                       
         MVC   SVUDATE,ACCOUSED(RF)                                             
         DROP  RF                                                               
*                                                                               
         USING TRSELD,RF                                                        
         ICM   RF,15,AELEM60       STATUS ELEMENT                               
         BZ    XITNEXT                                                          
         OC    TRSUMOS,TRSUMOS     ANY USED DATE?                               
         BZ    FLTT132                                                          
         CLC   TRSUMOS,DISMON                                                   
         BNH   XITNEXT                                                          
         DROP  RF                                                               
*                                                                               
         USING MPYELD,RF                                                        
FLTT132  L     RF,ADTRANS          RF=A(TRANSACTION ELEMENT)                    
         SR    R1,R1                                                            
*                                                                               
FLTT134  IC    R1,MPYLN                                                         
         AR    RF,R1                                                            
         CLI   MPYEL,0             TEST END OF RECORD                           
         BE    FLTT136                                                          
         CLI   MPYEL,MPYELQ        TEST MANUAL PAYMENT ELEMENT                  
         BNE   FLTT134                                                          
         CLC   MPYNO,SPACES                                                     
         BE    FLTT134                                                          
         CLC   MPYDTE,DISDATE                                                   
         BH    FLTT138                                                          
         B     XITNEXT                                                          
         DROP  RF                                                               
*                                                                               
FLTT136  CLC   SVUDATE,DISDATE     Test used date                               
         BNH   XITNEXT                                                          
*&&                                                                             
FLTT138  TM    FMTROPT2,RPFOCD$    Cash discount present ?                      
         BZ    FLTT140             Doesn't matter                               
         CLI   QPROG,PAYABLES      Only cash discount for PAY                   
         BNE   FLTT140                                                          
         TM    PAIRIND,PAIRCSHD    Find any cash discount ?                     
         BZ    XITNEXT             No so exit                                   
*                                                                               
FLTT140  CLI   QPROG,RECEIVABLE                                                 
         BNE   FLTT142                                                          
         GOTO1 AFILTER,DMCB,AFLTPART,CURPART                                    
         BNE   XITNEXT                                                          
         B     FLTT144                                                          
*                                                                               
FLTT142  CLI   QPROG,EXPENSE       IS IT EXP REPORT?                            
         BNE   FLTT144                                                          
         GOTO1 AFILTER,DMCB,AFLTPRSN,CURPRSN                                    
         BNE   XITNEXT                                                          
         GOTO1 AFILTER,DMCB,AFLTDEPT,CURDEPT                                    
         BNE   XITNEXT                                                          
         GOTO1 AFILTER,DMCB,AFLTDEXP,CURDEXP                                    
         BNE   XITNEXT                                                          
         GOTO1 AFILTER,DMCB,AFLTVNDR,CURVNDR                                    
         BNE   XITNEXT                                                          
         GOTO1 AFILTER,DMCB,AFLTANOF,CURANOF                                    
         BNE   XITNEXT                                                          
         GOTO1 AFILTER,DMCB,AFLTCOST,CURCOST                                    
         BNE   XITNEXT             NOT FOUND                                    
*                                                                               
FLTT144  CLI   QPROG,PRODUCTION    OFFICE IN ACCOUNT LEVEL                      
         BE    FLTT146                                                          
         CLI   QPROG,MANPOWER      OFFICE IN ACCOUNT LEVEL                      
         BE    FLTT146                                                          
         MVC   CUROFF,SPACES       FILTER - OFFICE                              
         GOTO1 PARSE,DMCB,GETOFFC,CUROFF,0                                      
         GOTO1 AFILTER,DMCB,AFLTOFF,CUROFF                                      
         BNE   XITNEXT                                                          
*                                                                               
FLTT146  CLI   AFLTPRLV,0          FILTER - PRICE LEVEL                         
         BE    FLTT148                                                          
         XC    CURPRCLV,CURPRCLV                                                
         GOTO1 PARSE,DMCB,GETPRLV,CURPRCLV,0                                    
         GOTO1 AFILTER,DMCB,AFLTPRLV,CURPRCLV                                   
         BNE   XITNEXT                                                          
*                                                                               
*                                  FILTER - TRANSACTION TYPES                   
FLTT148  GOTO1 AFILTER,DMCB,AFLTTYPE,('RFLTTYPE',0)                             
         BNE   XITNEXT                                                          
*                                                                               
         CLI   QPROG,EXPENSE       EXPENSE REPORT?                              
         BE    FLTT150             IGNORE A LOT OF CODE FOR EXPENSE             
         BAS   RE,CLIFILT                                                       
         BNE   XITNEXT                                                          
FLTT149  GOTO1 AFILTER,DMCB,AFLTCOST,CURCOST                                    
         BNE   XITNEXT             NOT FOUND SO EXIT                            
*                                                                               
         USING TRNRECD,R2                                                       
FLTT150  L     R4,ADTRANS                                                       
         LR    R2,R4                                                            
         CLI   QPROG,INCOME                                                     
         BE    FLTT152                                                          
         CLI   QPROG,RECEIVABLE                                                 
         BNE   FLTT158                                                          
*                                                                               
FLTT152  TM    FMTROPT,RPFTYP56    IGNORE TYPE 56?                              
         BO    FLTT158             NO                                           
         CLI   TRNTYPE,56          IGNORE TYPE 56 (REVERSAL OF ACCURAL)         
         BE    XITNEXT                                                          
         CLI   TRNTYPE,55          FILTER TYPE 55 BY BAT55DTE                   
         BNE   FLTT158                                                          
         CLI   BAT55MOS,X'FF'      ANY MOS END DATE?                            
         BE    FLTT154             NO                                           
         CLC   SAVEMOS,BAT55MOS                                                 
         BNE   XITNEXT                                                          
         CLI   BAT55DTE,X'FF'      IF MOS OK THEN CHECK END DATE                
         BNE   FLTT156                                                          
         B     FLTT158                                                          
*                                                                               
FLTT154  CLI   BAT55DTE,X'FF'      IF = IGNORE ALL ACCURALS (TYPE 55)           
         BE    XITNEXT                                                          
*                                                                               
FLTT156  CLC   TRNDATE,BAT55DTE                                                 
         BNH   XITNEXT                                                          
*                                                                               
FLTT158  OC    ALTNSTR,ALTNSTR     START DATE?                                  
         BNZ   *+12                YES                                          
         CLI   ALTNEND,X'FF'       END DATE?                                    
         BE    FLTT168             NO, SO OK                                    
         L     R2,GETALTC                                                       
         TM    DATEFLT,DATECHK     FILTER OUT BY CHECK DATE?                    
         BO    *+16                YES                                          
         TM    DATEFLT,DATEDEP     FILTER OUT BY DEPOSIT DATE?                  
         BZ    FLTT168             NO                                           
         L     R2,GETALTD                                                       
         XC    SAVEDATE,SAVEDATE                                                
         LA    RE,FLTT168                                                       
         CLI   QPROG,PAYABLES      PAYABLES                                     
         BNE   *+8                                                              
         LA    RE,FLTT162                                                       
         TM    FMTROPT2,RPFSPEC    CASH DISBURSEMENT/RECEIPT?                   
         BZ    FLTT160             NO                                           
         CLI   FMTPUT,YES                                                       
         BE    *+8                                                              
         MVI   FMTPUT,NO           ELEMENATE THIS GROUP OF TRANSACTIONS         
         LA    RE,FLTT168                                                       
*                                                                               
FLTT160  SR    R1,R1                                                            
         IC    R1,BRNCHSGN                                                      
         TM    TRNSTAT,TRNSDR      IS IT A DEBIT                                
         EX    R1,*+8                                                           
         NOP   FLTT160             (*+4 -> *+8)                                 
         BCR   0,RE                BRANCH ACCORDINGLY                           
         B     FLTT164                                                          
*                                                                               
FLTT162  GOTO1 PARSE,DMCB,GETXDRD,SAVEDATE                                      
         BE    FLTT166                                                          
         B     FLTT168                                                          
*                                                                               
FLTT164  GOTO1 PARSE,DMCB,(R2),SAVEDATE                                         
         BNE   XITNEXT             NOT FOUND SO DON'T PROCESS                   
*                                                                               
FLTT166  OC    SAVEDATE,SAVEDATE                                                
         BZ    XITNEXT                                                          
         CLC   SAVEDATE,ALTNSTR    START DATE                                   
         BL    XITNEXT             NOT IN RANGE                                 
         CLC   SAVEDATE,ALTNEND    END DATE                                     
         BH    XITNEXT             NOT IN RANGE                                 
         MVI   FMTPUT,YES          THIS GROUP OF TRANSACTIONS OK                
*                                  SET UP CURRENT TRANS DATE                    
FLTT168  TM    MODEIND,MODEPASS    DID WE GO THIS AT LEAST ONCE ?               
         BO    FLTT170             YES                                          
         OI    MODEIND,MODEPASS    PASSED THROUGH ALL TEST AT LEAST 1X          
*        CLI   NEWTRAN,YES                                                      
*        BNE   FLTT170                                                          
*        XC    SJBUF1,SJBUF1       RESET SJBUF1                                 
*        MVC   MOAAGE,MOADTE       POST BY THIS MOA DATE                        
*        MVC   ACTAGE,ACTDTE       POST BY THIS ACTIVITY DATE                   
*                                                                               
FLTT170  CLI   QPROG,PRODUCTION                                                 
         BNE   FLTT172                                                          
         L     RE,ACFWELS                                                       
         LHI   RF,NONCLIQ                                                       
         SR    R0,R0                                                            
         SR    R1,R1                                                            
         MVCL  RE,R0               Start out with zero in the buffer            
*&&US                                                                           
         TM    RECREAD2,RECPVND    CashFlow Production Vendor Keywords?         
         BZ    *+8                  No                                          
         BRAS  RE,PRPVND                                                        
         TM    RECREAD2,RECPRCV    CashFlow Prod Receivable Keywords?           
         BZ    FLTT172              No                                          
         BRAS  RE,PRCPRCV                                                       
         BRAS  RE,SETCFELM                                                      
*&&                                                                             
FLTT172  TM    UPSI,UPSITRNS                                                    
         BZ    FLTT174                                                          
         GOTOR =A(DUMPCF)                                                       
         GOTO1 =A(DUMPTKEY),1                                                   
*                                                                               
FLTT174  DS    0H                                                               
         SR    R2,R2                                                            
         OC    FMT#TRNS,FMT#TRNS   LAST ACTION WAS PUT IF NULL                  
         BNZ   FLTT176                                                          
         LA    R2,POSTCLR                                                       
         MVC   FMT#TRNS,=H'01'     RESET TO BUILD FIRST RECORD                  
         B     FLTT178             BUILD SORT RECORD                            
*                                                                               
FLTT176  CLI   UNIFLAG,YES         Create one record per transaction ?          
         BNE   FLTT178             No, just one record                          
         LA    R2,POSTCLR          Yes                                          
*                                  If this blows up, it could be due            
*                                  to NARALL which makes internally-            
*                                  stored recs much bigger:                     
         CLC   FMT#TRNS,MAX#TRNS                                                
         BNH   *+6                                                              
         DC    H'00'               Too many trans for this ACCKEY               
*                                                                               
FLTT178  CLI   QPROG,MANPOWER      Not DR/CR based so put out each pass         
         BE    *+8                 Set to PUT transactions                      
         CLI   FMTPUT,HOLD         Put trans as soon as key changes             
         BNE   *+8                 Only mark yes if on hold                     
         MVI   FMTPUT,YES          Put trans as soon as key changes             
         LH    R6,FMT#TRNS         Number of transactions built for key         
         TM    FMTFLAG,FMTALO$                                                  
         BZ    FLTT184                                                          
         OI    POSTCTL,POSTALO$    Post allocated detail by date                
         LH    R0,RATEMTH          Get number of months to process              
         LTR   R0,R0                                                            
         BZ    FLTT182                                                          
         MVC   AL$MOA,MOADTE       Default                                      
*                                  Post one month at a time                     
FLTT180  GOTO1 ARECORD,DMCB,(0,FMTSRTWK),((R2),(R6))                            
         GOTO1 DATCON,DMCB,(X'31',AL$MOA),(1,AL$MOA),(2,0)                      
         LA    R6,1(,R6)           Add another record                           
         BCT   R0,FLTT180          Loop, post one month at a time               
*                                                                               
FLTT182  NI    POSTCTL,TURNOFF-POSTALO$                                         
         STH   R6,FMT#TRNS                                                      
         B     FLTT210                                                          
*                                  Post one month at a time                     
*LTT184  GOTO1 PRNTBL,DMCB,=C'RECD',APTAWRK,C'DUMP',150,=C'1D'                  
FLTT184  DS    0H                                                               
         CLI   QPROG,MANPOWER                                                   
         BNE   FLTT198                                                          
         TM    FMTIND2,FMTDAILY+FMTITEM  ANY DAILY TIME/ITEM KEYWORDS?          
         BZ    FLTT198                                                          
         TM    FMTIND2,FMTDAILY          ANY DAILY TIME KEYWORD?                
         BZ    FLTT194                                                          
         ICM   R4,15,AELMTMS7            ANY DAILY TIME ELEMENTS?               
         BZ    FLTT194                                                          
*                                                                               
         LLC   R3,TIMLN-TIMELD(R4)                                              
         AR    R3,R4                                                            
         LA    R4,TIMETDT1-TIMELD(R4)                                           
         B     *+14                                                             
FLTT186  AHI   R4,L'TIMETDT1+L'TIMEHRS1                                         
         CR    R4,R3                                                            
         BNL   FLTT192                                                          
*                                                                               
*&&UK*&& TM    FMTROPT6,RPFFPDRD  Filter period date range by day?              
*&&US*&& TM    FMTROPT7,RPFFPDRD                                                
         BZ    FLTT188            No - OK                                       
         CLC   0(L'TIMETDT1,R4),RSTADTE  Request start date                     
         BL    FLTT186                                                          
         CLC   0(L'TIMETDT1,R4),RENDDTE  Request end date                       
         BH    FLTT192                                                          
FLTT188  ZAP   CURHRS,=P'0'                                                     
         OC    L'TIMETDT1(L'TIMEHRS1,R4),L'TIMETDT1(R4)                         
         BZ    FLTT186                                                          
         ZAP   CURHRS,L'TIMETDT1(L'TIMEHRS1,R4)                                 
         BZ    FLTT186             Skip if zero amount                          
         MVC   CURPDTE,0(R4)                                                    
*                                                                               
         GOTO1 ARECORD,DMCB,(0,FMTSRTWK),((R2),(R6))                            
         LA    R6,1(,R6)           ADD ANOTHER RECORD                           
         TM    POSTLVL2,POSTDALY                                                
         BO    FLTT186             SKIP IF MAIN RECORD HAS BEEN ADDED           
         TM    FMTIND2,FMTITEM                                                  
         BZ    FLTT190                                                          
         OC    AELMTM30,AELMTM30   ANY ITEMS ELEMENTS                           
         BZ    FLTT190                                                          
         GOTO1 =A(PROCITM),(R6)                                                 
*                                                                               
FLTT190  OI    POSTLVL2,POSTDALY   POST DAILY TIME KEYWORD ONLY                 
         B     FLTT186                                                          
*                                                                               
FLTT192  OC    CURPDTE,CURPDTE     POST ITEM ELEMENTS IF NO DAILY TIME          
         BNZ   FLTT196                                                          
FLTT194  TM    FMTIND2,FMTITEM     ANY ITEM KEYWORDS?                           
         BZ    FLTT198                                                          
         OC    AELMTM30,AELMTM30   ANY ITEMS ELEMENTS                           
         BZ    FLTT198                                                          
*                                                                               
         NI    POSTLVL2,TURNOFF-POSTDALY                                        
         GOTO1 ARECORD,DMCB,(0,FMTSRTWK),((R2),(R6))                            
         LA    R6,1(,R6)           YES, ADD ANOTHER RECORD                      
         GOTO1 =A(PROCITM),(R6)                                                 
*                                                                               
FLTT196  XC    CURPDTE,CURPDTE                                                  
         XC    CURHRS,CURHRS                                                    
         MVI   POSTLVL2,0                                                       
         STH   R6,FMT#TRNS                                                      
         CLC   FMT#TRNS,MAX#TRNS                                                
         BNH   *+6                                                              
         DC    H'00'               Too many trans for this ACCKEY               
         B     FLTT210                                                          
FLTT198  CLI   QPROG,PRODUCTION                                                 
         BNE   FLTT202                                                          
         TM    ESTIND,ESTNOS+ESTHRS  For BrandOcean estimates only              
         BZ    FLTT202                                                          
         XC    NJEMBLK,NJEMBLK                                                  
         XC    NJEWBLK,NJEWBLK                                                  
         USING ESTMD,RF                                                         
         L     RF,ESTMAIN          Find global entry for current est.           
FLTT200  CLI   0(RF),EOT                                                        
         BE    FLTT202             Not found...                                 
         CLC   ESTWLG,CURESTET                                                  
         BE    *+12                                                             
         AHI   RF,ESTMLNQ                                                       
         B     FLTT200                                                          
         ST    RF,NJEMBLK          SAVE A(ENTRY)                                
         DROP  RF                                                               
*                                                                               
FLTT202  GOTO1 ARECORD,DMCB,(0,FMTSRTWK),((R2),(R6))                            
         CLI   QPROG,PRODUCTION                                                 
         BNE   FLTT204                                                          
         XC    NJEMBLK,NJEMBLK                                                  
         XC    NJEWBLK,NJEWBLK     clear after use by ARECORD (RL06)            
FLTT204  MVC   SAVETRNS,FMT#TRNS                                                
*        GOTO1 PRNTBL,DMCB,=C'SPT1',APTAWRK,C'DUMP',150,=C'1D'                  
         GOTO1 =A(SPLITUP)                                                      
*        GOTO1 PRNTBL,DMCB,=C'SPT2',APTAWRK,C'DUMP',150,=C'1D'                  
         CLI   UNIFLAG,YES         WAS THERE UNIQUE DATA IN KEY?                
         BNE   FLTT210                                                          
         LH    R6,FMT#TRNS         UPDATE TRANSACTION COUNT                     
         LA    R6,1(,R6)           ADD ANOTHER RECORD                           
         STH   R6,FMT#TRNS                                                      
*                                                                               
FLTT210  OI    ACTIVITY,ACTACCT    ACCOUNT HAS SORT ACTIVITY                    
*&&UK*&& ZAP   CRLMTAMT,PKZERO     CLEAR SO IT POST ONLY ONCE                   
*&&UK*&& ZAP   ICRLMT$,PKZERO      CLEAR SO IT POST ONLY ONCE                   
*                                                                               
FLTTXIT  B     XITNEXT                                                          
                                                                                
SVMOA    DS    XL3                                                              
SVUDATE  DS    PL2                                                              
         EJECT                                                                  
***********************************************************************         
*  Routine to process account for the last time                       *         
***********************************************************************         
         SPACE 1                                                                
ACCLST   NI    FCIND,TURNOFF-FCIOKREV                                           
         GOTO1 AFILTER,DMCB,AFLTUNL,QUNIT                                       
         BNE   XITNEXT                                                          
         CLI   QPROG,PRODUCTION                                                 
         BE    ACCLST05                                                         
         BAS   RE,PARTIAL                                                       
         CP    TRNSTOT,PKZERO      Did transactions total zero ?                
         BNE   ACCLST05            No, so put to sort                           
         TM    FMTROPT,RPFBALO     Only show outstanding balances ?             
         BO    ACCLST10            Yes so don't put to sort                     
*                                                                               
ACCLST05 CLI   FMTPUT,YES          SHOULD WE PUT PRIOR TRANSACTION?             
         BNE   ACCLST10            NO                                           
         LH    RF,FMT#TRNS                                                      
         GOTO1 APUTREC,DMCB,FMTSRTWK,(RF)    PREVIOUS RECS                      
         XC    FMT#TRNS,FMT#TRNS             RESET                              
*                                                                               
ACCLST10 MVI   FMTPUT,HOLD                                                      
         NI    CURIND,TURNOFF-(CURBILCR+CURINCHG+CURRETL)                       
         MVI   POIND,0                                                          
         NI    POSTMODE,TURNOFF-POSTTRN                                         
         XC    AELEM1A(AELEMQ),AELEM1A                                          
         XC    AELMTMS1(AELMTMSQ),AELMTMS1                                      
         XC    AELEM77B(12),AELEM77B                                            
         XC    AELEM50T,AELEM50T                                                
         ZAP   TMSHOURS,PKZERO                                                  
*        ZAP   TRNSTOT,PKZERO                                                   
*        MVI   PAIRIND,0                                                        
*                                                                               
ACCLST11 TM    POSTLVL,POSTDET     POSTING DETAIL?                              
         BZ    ACCLST12                                                         
         CLI   FCRDTRNS,NO         IF I SKIP TRANSACTIONS THEN                  
         BE    ACCLST98            SKIP THE ESTIMATES                           
*                                                                               
ACCLST12 TM    FMTMODES,FMTPOST    WAS IT OK TO POST?                           
         BZ    ACCLST98            NO                                           
         XC    ADSUBAC,ADSUBAC                                                  
         XC    ADTRANS,ADTRANS     CLEAR OUT AT THIS POINT                      
         MVC   CURSUBAC,SPACES     CLEAR CURRENT SUBACCOUNT                     
*                                                                               
         CLI   QPROG,PRODUCTION                                                 
         BNE   ACCLST18                                                         
         TM    FMTROPT6,RPFSPBIL   Show prior bills                             
         BZ    ACCLST14            No                                           
         MVI   TRNSSTAT,0          Clear for mulitple passes                    
         GOTO1 ASEED,SEEDPBIL      Yes                                          
*                                                                               
         USING JOBAGEID,R1                                                      
ACCLST14 MVI   TRNSSTAT,X'80'      Set as a debit                               
         CLI   AGECOL#,0                                                        
         BE    ACCLST18                                                         
         TM    MODEIND,MODEONCE                                                 
         BO    ACCLST15                                                         
         L     R1,JBAGEBLK         Job ageing block                             
         CLI   JAIMODE,JAITRANS                                                 
         BNE   ACCLST18                                                         
         MVI   JAIMODE,JAITOTAL                                                 
         MVC   JAIJOBS,ADACC       JOB RECORD                                   
         GOTO1 JOBAGE                                                           
         DROP  R1                                                               
*                                                                               
ACCLST15 GOTO1 ASEED,SEEDAGE                                                    
*                                                                               
ACCLST18 CLI   FCJOBBER,0          PRODUCTION SCRIBE ONLY                       
         BE    ACCLST20                                                         
         GOTO1 =A(JOBEST)                                                       
         BNE   XITNEXT                                                          
*                                                                               
ACCLST20 DS    0H                                                               
*&&UK                                                                           
         TM    POSTLVL2,POSTCIND                                                
         BNZ   ACCLST30                                                         
         TM    RECREAD3,RECAEXRD   READ AEXRECD TO GET CLIENT POs               
         BZ    ACCLST30                                                         
         GOTO1 =A(PROCPO)                                                       
         GOTO1 ARECORD,DMCB,('POSTCPO',ASRTWRK),('POSTCLR',1)                   
         OI    POSTMODE,POSTCPO                                                 
         GOTO1 APUTREC,DMCB,ASRTWRK,1                                           
         NI    POSTMODE,TURNOFF-POSTCPO                                         
         NI    POSTLVL2,TURNOFF-POSTACLP                                        
         OI    POSTLVL2,POSTCIND                                                
*&&                                                                             
ACCLST30 OC    #OFEST,#OFEST    DEAL WITH NON-JOBBER ESTIMATE AMOUNTS           
         BZ    ACCLST50                                                         
         GOTO1 =A(NJEST)                                                        
*                                                                               
ACCLST50 TM    POSTLVL,POSTACC     Are we only at account level ?               
         BO    ACCLST53            Yes, so print                                
         TM    RECREAD1,RECSTDH+RECEDTH                                         
         BZ    ACCLST51                                                         
         TM    ACTIVITY,ACTACCT                                                 
         BZ    ACCLST55                                                         
*                                                                               
ACCLST51 TM    PHISIND,PHISON      This format need Payroll histories ?         
         BZ    ACCLST52            NO                                           
         GOTOR ACOLPAYR            Reset buffer for rates only                  
         BRAS  RE,PAYACTV                                                       
         BE    ACCLST55            Post remaining payroll rates/amounts         
                                                                                
ACCLST52 TM    FMTPOPT1,RPFIACT    Print inactive accounts ?                    
         BZ    ACCLST98            No, otherwise seed SORTER                    
*                                                                               
ACCLST53 TM    ACTIVITY,ACTACCT    Was there already sort activity ?            
         BO    ACCLST98            Yes, so skip                                 
         TM    FMTFLAG,FMTACLVL    Account listing                              
         BZ    ACCLST55            No,  so continue as usual                    
         CLC   FMTLEVMX,LEVMAX     Is it lower then the lowest ?                
         BNE   ACCLST98            Yes, so don't process                        
*                                                                               
ACCLST55 MVC   WCLONG,SPACES       Values not set at this level                 
         MVC   WCSHORT,SPACES                                                   
         XC    SAVEMOS,SAVEMOS                                                  
         TM    FMTROPT5,RPFOPORD   Purchase orders only ?                       
         BO    XITNEXT             If yes then do post here                     
         GOTO1 ASEED,SEEDACC                                                    
*                                                                               
ACCLST98 CLI   QPROG,MANPOWER                                                   
         BNE   XITNEXT                                                          
         TM    PHISIND,PHISON      This format need Payroll histories ?         
         BO    ACCLST99            Yes                                          
         TM    THRSW,THRLST        This format need Total hour data ?           
         BZ    XITNEXT             No                                           
*                                                                               
ACCLST99 TM    TSARSW,TSARON       Are we using TSAR at all ?                   
         BO    *+6                 Yes, so we can process                       
         DC    H'00'               We have a problem                            
*                                                                               
         GOTO1 ATSAR,DMCB,=C'FLUSH',0     Flush out by person account           
         B     XITNEXT                                                          
         EJECT                                                                  
***********************************************************************         
*  ROUTINE FOR REQUEST LAST                                           *         
***********************************************************************         
         SPACE 1                                                                
         USING ACMD,R3                                                          
REQL     CLI   ERROR#,0                                                         
         BNE   ERRORMSG            ERROR HAS OCCURED PRINT MESSAGE              
         CLI   QOPT3,OPT3SCMA      SCHEMA ONLY                                  
         JE    REQL080                                                          
*                                                                               
         TM    FCIND,FCNEWGL       New GL                                       
         BZ    REQL005             Yes, don't bother then                       
         BRAS  RE,GLNEW                                                         
*                                                                               
REQL005  TM    THRSW,THRLST        MUST FLUSH IN ACCLAST                        
         BZ    REQL010                                                          
         TM    TSARSW,TSARON+TSARDATA                                           
         BNO   *+6                                                              
         DC    H'00'               SHOULD HAVE BEEN FLUSHED BY NOW              
*                                                                               
REQL010  L     R5,AFORMATS                                                      
         SR    R0,R0                                                            
         IC    R0,FORMAT#+1                                                     
REQL020  CLI   FMTTOP,0                RECAPPED REPORTS ?                       
         BE    REQL025                 NO                                       
         GOTO1 ARECORD,DMCB,('POSTTOT',ABUDWRK),('POSTCLR',1)                   
         OI    POSTMODE,POSTTOT        EASY WAY OF DOING THIS                   
         GOTO1 APUTREC,DMCB,ABUDWRK,1                                           
*                                                                               
REQL025  LA    R5,FMTLNQ(,R5)                                                   
         BCT   R0,REQL020                                                       
         NI    POSTMODE,TURNOFF-POSTTOT                                         
*                                                                               
         L     R5,AFORMATS         RELOAD                                       
         TM    TSARSW,TSARON       ARE WE USING TSAR AT ALL?                    
         BZ    REQL030             NO, USING SORTER ONLY                        
         TM    TSARSW,TSARDATA     DID WE EVER PUT DATA TO TSAR  ?              
         BZ    REQL030             NO DATA OR KEY TOO BIG FOR TSAR              
         TM    RANKSW,RANKON       ARE WE RANKING RECORDS ?                     
         BO    *+8                 YES, SO FLUSH RECORDS TO RANKWRK             
         TM    SORTSW,SORTDATA     DID WE EVER PUT DATA TO SORTER?              
         BZ    REQL030             DON'T PUT TO SORT USE TSAR ONLY              
         GOTO1 ATSAR,DMCB,=C'FLUSH',0                                           
*                                                                               
         USING ACMD,R3                                                          
REQL030  L     R3,AMONACC                                                       
         CLI   MULTLDG,YES                                                      
         BNE   REQL040                                                          
         XC    ACMAJCSP,ACMAJCSP   CLEAR FOR JOBBER SPECS                       
         TM    ACMINDS4,ACMIUACL                                                
         BZ    REQL032                                                          
         NI    ACMINDS4,TURNOFF-ACMIUACL                                        
         XC    ACMAACTN,ACMAACTN   CLEAR N'ENTRIES IN BUFFER                    
                                                                                
REQL032  L     R2,ALEDGERS                                                      
         CLI   0(R2),EOT                                                        
         BE    REQL040                                                          
         MVI   ACMMODE,REQFRST                                                  
         MVC   QUNIT(2),0(R2)      MOVE IN NEW UNIT LEDGER                      
         LA    R2,2(,R2)                                                        
         ST    R2,ALEDGERS                                                      
         GOTO1 TABINIT                                                          
         TM    FMTIND2,FMTBUDOK    RE-BUILD BUDGET INFO FOR NEW LEDGER?         
         BZ    XIT                                                              
         GOTO1 BUDBLD                                                           
         B     XIT                 NEXT TIME REQUEST FIRST                      
         DROP  R3                                                               
*                                                                               
REQL040  MVI   MULTLDG,NO                                                       
         TM    RANKSW,RANKON       ARE WE RANKING ?                             
         BZ    REQL050             NO                                           
         GOTO1 ARANK,DMCB,=C'FLUSH'                                             
*                                                                               
REQL050  TM    SORTSW,SORTDATA     SORT OR TSAR ACTIVITY                        
         BO    REQL060             NO, NO DATA OUT THERE, GET OUT               
         TM    DDLNKIND,DDLNKTST                                                
         BO    REQL060             Need to send schema even if no data          
         TM    DDLNKIND,DDLNKON                                                 
         BO    REQL060             Need to send schema even if no data          
*&&UK                                                                           
         TM    DWNOPT3,DWNTBDE     Test BDE download                            
         BO    REQL060             Need to send schema even if no data          
         TM    DWNOPT3,DWNTUSS     Test USS download                            
         BO    REQL060             Need to send schema even if no data          
*&&                                                                             
         TM    DWNOPT3,DWNTEDI     Test USS/EDI DL                              
         BO    REQL060             Need to send schema even if no data          
         TM    TSARSW,TSARDATA     SORT OR TSAR ACTIVITY                        
         BZ    REQL090             NO, NO DATA OUT THERE, GET OUT               
*                                                                               
REQL060  TM    SORTSW,SORTVPCT     POST A VERTICAL PERCENT?                     
         BZ    REQL080             NO                                           
         GOTO1 VERTPCT,DMCB,=C'FLUSH',0                                         
*                                                                               
REQL080  GOTO1 PRINTREP                                                         
*                                                                               
         USING BOXD,R6                                                          
         USING BIGPRNTD,R4                                                      
REQL090  GOTO1 ADSORTER,DMCB,=C'END'                                            
         L     R6,ADBXAREA         RESET TO PRINT REQUEST PAGE                  
         L     R4,VBIGPRNT                                                      
         MVI   BOXFONT,0           RESET FONT                                   
         MVC   BOXROWS(BOXROWSL),SPACES           Clear boxes                   
         MVC   BOXCOLS(STDPGWD),XSPACES                                         
         MVI   RCREQREP,YES                                                     
         NI    FMTIND2,TURNOFF-FMTBUDOK                                         
         DROP  R4,R6                                                            
                                                                                
         USING ACMD,R3                                                          
         USING ACGOD,R1                                                         
         L     R3,AMONACC                                                       
         L     R1,ADGOBLOC         A(GOBLOCK)                                   
         TM    DDLNKIND,DDLNKON    DDLINK run?                                  
         JZ    REQL100             No                                           
         XC    ACMNOFNB,ACMNOFNB   Reset for each new run                       
         XC    0(L'GOBLRSV,R1),0(R1) Clear reserved fields for Getopt           
         DROP  R1                                                               
*                                                                               
         USING JOBAGEID,R1                                                      
         L     R1,JBAGEBLK                                                      
         OC    JAIWORKA,JAIWORKA                                                
         BZ    REQL100                                                          
         MVI   JAIMODE,JAIFINI     FINISH MODE/FREE MAIN                        
         GOTO1 JOBAGE                                                           
         DROP  R1                                                               
REQL100  XC    ACMAJCSP,ACMAJCSP   CLEAR FOR JOBBER SPECS                       
         NI    ACMINDS4,TURNOFF-ACMIUACL                                        
         MVI   MULTLDG,NO                                                       
         NI    POSTMODE,TURNOFF-POSTTOT                                         
         B     XIT                                                              
         DROP  R3                                                               
         EJECT                                                                  
         USING JOBAGEID,R1                                                      
RUNL     L     R1,JBAGEBLK                                                      
         OC    JAIWORKA,JAIWORKA                                                
         BZ    RUNL100                                                          
         MVI   JAIMODE,JAIFINI     FINISH MODE/FREE MAIN                        
         GOTO1 JOBAGE                                                           
         DROP  R1                                                               
*                                                                               
RUNL100  TM    UPSI,UPSITABS                                                    
         BZ    RUNL200                                                          
         GOTO1 =A(TIMELAP),1                                                    
*                                                                               
RUNL200  TM    DDLNKIND,DDLNKON                                                 
         BO    XIT                                                              
         GOTO1 ALOADTAB,LOADFREE                                                
         B     XIT                                                              
         EJECT                                                                  
***********************************************************************         
* Error messages to display, based on Error#                          *         
* See ERRRTAB in ACREPRL05                                                      
***********************************************************************         
ERRORMSG CLI   ERROR#,REQDONE      Done with this request ?                     
         BNE   ERRORM05            No                                           
         MVI   BLDACT,0            Yes                                          
         J     XIT                 Exit                                         
*                                                                               
ERRORM05 CLI   ERROR#,17           Invalid +/- List                             
         JE    *+10                                                             
         MVC   TEMPAREA,SPACES     Use TEMPAREA for extra info                  
                                                                                
         SR    R3,R3                                                            
         IC    R3,ERROR#                                                        
         BCTR  R3,0                                                             
         MHI   R3,ERRORLNQ                                                      
         A     R3,ERRBASE          A(Error number)                              
                                                                                
         CLI   ERROR#,1            Format not found                             
         JNE   *+10                                                             
         MVC   TEMPAREA(L'QAPPL),QAPPL                                          
         CLI   ERROR#,6            Bad keyword                                  
         JNE   ERRORM06                                                         
         MVC   TEMPAREA(6),FINDDATA                                             
         CLC   FINDDATA,SPACES                                                  
         JH    ERRORM06                                                         
         MVI   TEMPAREA,ESC#LFJT                                                
         MVC   TEMPAREA+1(2),KEYWRD#                                            
         MVI   TEMPAREA+3,6                                                     
                                                                                
ERRORM06 CLI   ERROR#,8            Missing calendar                             
         JE    ERRORM11                                                         
         CLI   ERROR#,11           Ledger Security problem                      
         JE    ERRORM12                                                         
         CLI   ERROR#,15           Invalid user keyword for U/L                 
         JE    ERRORM10                                                         
         CLI   ERROR#,21           Off lockout, &T                              
         JE    ERRORM07                                                         
         CLI   ERROR#,16           Invalid List ==>                             
         JNE   ERRORM08                                                         
                                                                                
         SR    RF,RF                                                            
         IC    RF,FORMAT#+1                                                     
         MHI   RF,FMTLNQ                                                        
         AR    R5,RF                                                            
         MVC   TEMPAREA(L'FMTCODE),FMTCODE                                      
         J     ERRORM08                                                         
*                                                                               
         USING ACRL2D,RF                                                        
ERRORM07 L     RF,AACRL2D                                                       
         MVC   TEMPAREA(L'SVFMTCDE),SVFMTCDE                                    
         DROP  RF                                                               
*                                                                               
ERRORM08 BRAS  RE,SENDMSG                                                       
         J     REQL090             Terminate process                            
*                                                                               
ERRORM10 MVC   TEMPAREA(2),QUNIT                                                
         J     ERRORM90                                                         
*                                                                               
         USING CPRCNDRD,R2                                                      
ERRORM11 L     R2,ACNDRBLK                                                      
         LA    RF,21               MMMDD/YYYY                                   
         CLI   CPRDD,0                                                          
         JNE   *+8                                                              
         LA    RF,22               MMM/YYYY                                     
         GOTOR DATCON,DMCB,(1,CPRYMD),((RF),TEMPAREA)                           
         J     ERRORM90                                                         
         DROP  R2                                                               
*                                                                               
ERRORM12 MVC   TEMPAREA(2),QUNIT                                                
         MVI   ERROR#,0            RESET ERROR TO CONTINUE TO NEXT LDG          
                                                                                
ERRORM90 BRAS  RE,SENDMSG                                                       
         J     XIT                 TERMINATE PROCESS FOR THIS LEDGER            
         EJECT ,                                                                
*                                                                               
* R3 = A(Error number)                                                          
*                                                                               
SENDMSG  ST    RE,SVRE                                                          
*        CLI   QOPT3,OPT3SCMA      Schema Only ?                                
*        JE    SENDMSG1            Don't send error to PC                       
                                                                                
         TM    DDLNKIND,DDLNKON    Running DDLINK ?                             
         JO    SENDMSG5                                                         
                                                                                
         USING GETTXTD,R2                                                       
         USING BIGPRNTD,R4                                                      
         USING MASTD,R6                                                         
SENDMSG1 LA    R2,WORK                                                          
         L     R4,VBIGPRNT                                                      
         L     R6,ADMASTC                                                       
         XC    GETTXTD(L'GTBLOCK),GETTXTD                                       
         MVC   GTMSGNO,0(R3)                                                    
         MVI   GTMSYS,X'06'                                                     
         MVI   GTMAXL,60                                                        
         LA    RE,XP                                                            
         STCM  RE,7,GTAOUT                                                      
         MVI   GTMTYP,GTMERR                                                    
         LA    RE,DMCB                                                          
         STCM  RE,7,GTADMCB                                                     
         MVI   GTLTXT,12                                                        
         LA    RE,TEMPAREA                                                      
         STCM  RE,7,GTATXT                                                      
         MVI   GT1INDS,GT1NOREF+GT1OWRK                                         
         GOTOR MCVGETXT,GETTXTD                                                 
         GOTOR REPORT                                                           
                                                                                
*        TM    DDLNKIND,DDLNKON    Running DDLINK ?                             
*        JZ    SENDMSG9            No                                           
         J     SENDMSG9                                                         
                                                                                
         USING ACMD,R4                                                          
         USING LP_D,R6                                                          
         USING LIOBD,R2                                                         
SENDMSG5 L     R4,AMONACC                                                       
         L     R6,ACMALP_D         R6=A(LP_D)                                   
         L     R2,LP_ALIOB         RE=A(LIOBD)                                  
         GOTOR DDLINKIO,DMCB,('LIOAPUT',LP_ALIOB),('LIOTMAP',REC_ERR#)          
*        CLI   QOPT3,OPT3SCMA      Schema Only ?                                
*        JE    SENDMSG9            Don't send error to PC                       
                                                                                
         MVI   LIOBMSYS,X'06'      Accounting system                            
*        GOTOR DDLINKIO,DMCB,('LIOAPUT',LP_ALIOB),('LIOTERR',REC_ERR#),X        
               (R3),(12,TEMPAREA)                                               
         GOTOR DDLINKIO,DMCB,('LIOAPUT',LP_ALIOB),('LIOTBAD',(R3)),0,  X        
               (12,TEMPAREA)                                                    
         DROP  R2                                                               
                                                                                
SENDMSG9 L     RE,SVRE                                                          
         BR    RE                                                               
         DROP  R4,R6                                                            
         EJECT                                                                  
*&&DO                                                                           
***********************************************************************         
* Fix reference in key/44 if DB key reference elem found (255 issue)            
***********************************************************************         
*                                                                               
         USING FFTELD,R4                                                        
         USING TRNRECD,R2                                                       
FIXREF   L     R4,ADTRANS                                                       
         LR    R2,R4                                                            
         SHI   R2,ACCORFST         GET TO BEGINING OF KEY                       
         CLI   TRNKREF+3,C'*'                                                   
         BNE   FXREFX                                                           
FXREF05  CLI   0(R4),0                                                          
         BE    FXREFX                                                           
         CLI   0(R4),FFTELQ                                                     
         BNE   *+12                                                             
         CLI   FFTTYPE,FFTTKREF                                                 
         BE    FXREF10                                                          
         ZIC   R1,1(R4)                                                         
         AR    R4,R1                                                            
         B     FXREF05                                                          
*                                                                               
         USING TRNRECD,R2                                                       
FXREF10  MVC   TRNKREF,FFTDATA    Fix reference in key                          
         DROP  R2                                                               
*                                                                               
         USING TRNELD,R2                                                        
         L     R2,ADTRANS                                                       
         MVC   TRNREF,FFTDATA     Fix reference in 44 elem                      
FXREFX   BR    RE                                                               
         DROP  R2,R4                                                            
*&&                                                                             
***********************************************************************         
* Clear address in MONACC                                                       
***********************************************************************         
CLRCUR   LA    R1,3                                                             
         LA    R2,LEV2LN           FIX UP MONACC ADDRESS                        
         LA    R3,ADHEIRB          LEVEL 2                                      
CLRCUR10 CLI   0(R2),0                                                          
         JNE   *+10                                                             
         XC    0(4,R3),0(R3)       CLEAR OUT LEVEL                              
         LA    R2,1(,R2)           BUMP TO NEXT LENGTH                          
         LA    R3,4(,R3)           NEXT LEVEL (2,3 OR 4)                        
         BRCT  R1,CLRCUR10                                                      
*                                                                               
         MVC   CURBLK1,SPACES      CLEAR FOR EVER TRANSACTION                   
         XC    CURMMOS,CURMMOS                                                  
         XC    CURSTAT(3),CURSTAT                                               
         BR    RE                                                               
         EJECT                                                                  
***********************************************************************         
*  PROCESS PARTIAL PAYMENT FLAG                                       *         
***********************************************************************         
PARTIAL  TM    FMTFLAG,FMTPART     DO WE CARE?                                  
         BZR   RE                  NO, SO SKIP THIS CODE                        
         CP    TRNSCRD,TRNSDEB     IF EQUAL THEN FULLY PAID                     
         BER   RE                                                               
         CP    TRNSCRD,PKZERO      ANY PAYMENT?                                 
         BER   RE                  NO SO CAN'T BE A PARTIAL                     
*                                                                               
         USING COLD,R3                                                          
         NTR1                                                                   
         SR    R0,R0                                                            
         IC    R0,FMT#COLS                                                      
         L     R3,FMTCOL                                                        
PART10   TM    COLIND1,COLPART                                                  
         BZ    PART80                                                           
         L     R2,FMTSRTWK         LOAD SORT RECORD ADDRESS                     
         AH    R2,COLDSP           POINT TO DATA                                
         SR    R1,R1                                                            
         ICM   R1,3,FMT#TRNS                                                    
         BNZ   *+8                                                              
         LA    R1,1                                                             
         MVI   0(R2),C'*'          CHANGE SORT KEY DATA                         
         AH    R2,SRTRECLN                                                      
         BCT   R1,*-8                                                           
PART80   LA    R3,COLLNQ(,R3)      NEXT COLUMN                                  
         BCT   R0,PART10                                                        
         J     XITNTR1                                                          
         DROP  R3                                                               
         EJECT                                                                  
***********************************************************************         
*        P1   = PTAELQ ELEMENT                                        *         
*        P2   = FIELD TO PASS BACK   YYMMDD BILLED DATE               *         
*                                    YYMM01 BILLED MOA                *         
***********************************************************************         
         SPACE 1                                                                
         USING PTAELD,R2                                                        
BILLDTES NTR1                                                                   
         L     R2,0(,R1)           POINTING TO X'77'                            
         L     R4,4(,R1)           DESTINATION FOR DATA                         
         MVC   BILLMOA,MOADTE      DEFAULT MOA DATE                             
         MVC   BILLDT,TRANDTE      DEFAULT BILLED DATE                          
         TM    TRNSSTAT,X'80'      DR ONLY                                      
         BZ    BILLDTEX                                                         
         MVC   BWORK(2),PTADATE    ACTIVITY DATE FOR XFERS / WRITE-OFFS         
         OC    PTADATE,PTADATE     ANY ACTIVITY DATE                            
         BNZ   BILLDTE3            YES                                          
         CLI   PTATYPE,PTATWOF     SEE IF WRITE-OFF                             
         BE    *+8                 OR                                           
         CLI   PTATYPE,PTATWOFR    WRITE-OFF RECOVERY                           
         BNE   BILLDTE3                                                         
         MVC   BILLDT,PTAWDAT                                                   
         GOTO1 DATCON,DMCB,(1,PTAWDAT),(2,PTADATE)                              
         B     BILLDTE5                                                         
*                                                                               
BILLDTE3 CLI   PTATYPE,PTATRAL     ALLOCATED TO BILL                            
         BNE   BILLDTE4                                                         
         TM    PTASTAT1,PTASPEND   IF PENDING SET TO ACTIVITY DATE              
         BO    BILLDTE4                                                         
         MVC   BWORK(2),PTARBLDT   BILLED DATE                                  
*                                                                               
BILLDTE4 OC    BWORK(2),BWORK                                                   
         BZ    BILLDTE5            USE TRANACTION DATE                          
         GOTO1 DATCON,DMCB,(2,BWORK),(1,BILLDT)                                 
*                                                                               
BILLDTE5 MVC   BILLMOA,BILLDT      DEFAULT TO BILLED DATE AS MOA                
         OC    PTAMOA,PTAMOA                                                    
         BZ    BILLDTEX                                                         
         MVC   BILLMOA(2),PTAMOA                                                
BILLDTEX MVI   BILLMOA+2,01        FORCE YYMM01                                 
         MVC   0(6,R4),BILLDT      RETURN DATES                                 
         XIT1                                                                   
BILLDT   DS    PL3                                                              
BILLMOA  DS    PL3                                                              
BWORK    DS    XL3                                                              
         EJECT                                                                  
***********************************************************************         
*  Set up current accounts from X'C0' element or contra account       *         
***********************************************************************         
         SPACE 1                                                                
         USING APEELD,R2                                                        
         USING TRNELD,R4                                                        
SETPTRS  ST    RE,SVRE                                                          
         XC    BYTE2,BYTE2                                                      
         MVI   CURXPBLK,C' '       WIPE OUT PREVIOUS DATA                       
         MVC   CURXPBLK+1(L'CURXPBLK-1),CURXPBLK                                
         CLI   QPROG,MANPOWER                                                   
         JNE   SETPTR02                                                         
         CLI   ANALFLT,C' '                                                     
         BNH   *+10                                                             
         MVC   CURDLBR(2),=C'14'                                                
         MVC   CURDLBR+2(1),ANALFLT                                             
                                                                                
SETPTR02 ICM   R2,15,AELEMC0                                                    
         BZ    SETPTR50                                                         
         SR    R0,R0                                                            
         ICM   R0,1,APENUM         NUMBER OF POINTERS                           
         BZ    SETPTR90            NONE AVAILABLE                               
*                                                                               
         LA    R2,APENTRY          POINT TO MINI-ELEMENTS                       
         USING APENTRY,R2                                                       
SETPTR10 SR    RF,RF                                                            
         IC    RF,APENLEN                                                       
         SHI   RF,APELN2Q+1                                                     
         BM    SETPTR30            NO ACCOUNT LOOP                              
         L     RE,=A(APTABLE)                                                   
SETPTR15 CLI   0(RE),EOT           END OF TABLE                                 
         BE    SETPTR30                                                         
         CLC   APENACT(2),0(RE)    MATCH UNIT/LEDGER AND ELEMENT                
         BE    SETPTR18                                                         
         AHI   RE,APTABQ           BUMP TO NEXT                                 
         B     SETPTR15                                                         
*                                                                               
SETPTR18 SR    R3,R3                                                            
         ICM   R3,3,2(RE)          GET DISP IN ACRLD                            
         BZ    SETPTR30            SKIP THIS ONE                                
         AR    R3,RA               ADD ACRLD BASE                               
*                                                                               
         CLC   =C'SJ',0(RE)        Processing SJ                                
         BNE   SETPTR20                                                         
                                                                                
         SR    R1,R1               Check client                                 
         LA    R6,2(,R3)           Point to client in CURSJ                     
         LA    RE,APENACT+2        Point to account in X'C0'                    
         IC    R1,SJCLILEN                                                      
         BCTR  R1,0                                                             
         EXCLC R1,0(R6),SPACES     Is it set ?                                  
         BNH   SETPTR28            No, fill in account                          
         EXCLC R1,0(R6),0(RE)      Is client the same                           
         BNE   SETPTR30            No, so don't change                          
                                                                                
         LA    R6,1(R1,R6)         Point to product and check                   
         LA    RE,1(R1,RE)                                                      
         IC    R1,SJPRDLEN                                                      
         BCTR  R1,0                                                             
         EXCLC R1,0(R6),SPACES     Is it set ?                                  
         BNH   SETPTR28            No, fill in account                          
         EXCLC R1,0(R6),0(RE)      Is product the same                          
         BNE   SETPTR30            No, so don't change                          
                                                                                
         LA    R6,1(R1,R6)         Point to job and check                       
         LA    RE,1(R1,RE)                                                      
         IC    R1,SJJOBLEN                                                      
         BCTR  R1,0                                                             
         EXCLC R1,0(R6),SPACES     Is it set ?                                  
         BNH   SETPTR28            No, fill in account                          
         B     SETPTR30            Yes so skip                                  
                                                                                
SETPTR20 CLC   =C'SI',QUNIT                                                     
         BNE   SETPTR25                                                         
         CLC   =C'1C',0(RE)                                                     
         BNE   SETPTR25                                                         
*                                                                               
         LA    R6,APENACT                                                       
         AHI   R6,1                Add 2 for U/L Sub 1 for offpos               
         SR    R1,R1                                                            
         ICM   R1,1,OFFPOS1C       Disp to office (0 MEANS NO OFFICE)           
         BZ    SETPTR25                                                         
         AR    R6,R1               Point to office                              
         LA    R1,0                Office length 1                              
         CLI   NEWOFF,YES          Two byte office?                             
         BNE   *+8                                                              
         LA    R1,1                Office length 2                              
         TM    BYTE2,X'80'         Moved in account already ?                   
         BZ    SETPTR25                                                         
         EXCLC R1,0(R6),TRNOFFC    Match on office only                         
         BNE   SETPTR30            No so skip                                   
*                                                                               
SETPTR25 CLC   0(14,R3),SPACES                                                  
         BH    SETPTR30            Already set                                  
                                                                                
SETPTR28 EXMVC RF,0(R3),APENACT                                                 
         OI    BYTE2,X'80'         Moved in account                             
*                                                                               
SETPTR30 LA    R2,APELN2Q+1(RF,R2) BUMP TO NEXT                                 
         BCT   R0,SETPTR10                                                      
*                                                                               
SETPTR50 L     RE,=A(APTABLE)      SEE IF CONTRA IS ONE IN TABLE                
SETPTR52 CLI   0(RE),EOT           END OF TABLE                                 
         BE    SETPTR90                                                         
         OC    2(2,RE),2(RE)                                                    
         BZ    SETPTR55            SKIP THIS ONE                                
         CLC   CURSUBAC+1(2),0(RE) COMPARE TABLE WITH UL CONTRA                 
         BE    SETPTR60                                                         
SETPTR55 AHI   RE,APTABQ           BUMP TO NEXT                                 
         B     SETPTR52                                                         
*                                                                               
SETPTR60 SR    R3,R3                                                            
         ICM   R3,3,2(RE)          GET DISP INTO ACRLD                          
         AR    R3,RA               ADD ACRLD BASE                               
         CLC   =C'SJ',0(RE)        Processing SJ                                
         BNE   SETPTR70                                                         
         CLC   CURSJACC,SPACES     Was SJ already set ?                         
         BNH   SETPTR72            No, fill in account                          
         B     SETPTR90            Yes                                          
                                                                                
SETPTR70 CLC   0(14,R3),SPACES                                                  
         BH    SETPTR90                                                         
SETPTR72 MVC   0(14,R3),CURSUBAC+1                                              
*                                                                               
SETPTR90 L     RE,SVRE                                                          
         BR    RE                                                               
         EJECT                                                                  
         DS    0H                                                               
AGETFCUR EQU   *                                                                
         CLC   PRVFCCDE,CURFCCDE   ALREADY SET UP                               
         BER   RE                                                               
*                                                                               
         USING CURTABD,RF                                                       
         BASR  R1,R0               USE RB AS BASE REGISTER                      
         USING *,R1                                                             
         L     RF,AFCURY           A(FOREIGN CURRENCY TABLE)                    
GETFCUR2 CLI   0(RF),0             END OF TABLE?                                
         BNE   GETFCUR4            SET TO DEFUALT                               
         L     RF,AFCURY                                                        
         B     GETFCUR9                                                         
*                                                                               
GETFCUR4 CLC   CURTCUR,CURFCCDE    MATCH CODE                                   
         BE    GETFCUR9                                                         
         AHI   RF,L'CURFCBLK                                                    
         B     GETFCUR2                                                         
*                                                                               
GETFCUR9 MVC   CURFCBLK,0(RF)                                                   
         MVC   PRVFCCDE,CURFCCDE                                                
         BR    RE                                                               
         DROP  R1,RF                                                            
         EJECT                                                                  
         LTORG                                                                  
***********************************************************************         
*        exit modes                                                   *         
***********************************************************************         
XITNOACC OI    FMTMODES,FMTNOACC                                                
XITNOTRS OI    FMTMODES,FMTNOTRS                                                
         NI    FMTMODES,TURNOFF-FMTPOST      NOT OK TO POST                     
XITNEXT  OI    MODEIND,MODEONCE    PASSED THOURGH ONCE                          
XITNEXTX CLC   FMTNUM,FORMAT#+1    PROCESSED ALL FORMATS ?                      
         BE    XITMODE                                                          
         AHI   R5,FMTLNQ           NEXT FORMAT                                  
         B     MODES                                                            
*                                                                               
XITMODE  DS    0H                                                               
*&&US*&& MVI   REALTYP,0           Clear                                        
         CLI   NEWTRAN,YES                                                      
         BNE   *+8                                                              
         NI    PAIRIND,TURNOFF-PAIRNOTZ                                         
*                                                                               
         CLI   MODE,PROCLEVA                                                    
         BE    XITMO10                                                          
         CLI   MODE,PROCLEVB                                                    
         BE    XITMO10                                                          
         CLI   MODE,PROCLEVC                                                    
         BE    XITMO10                                                          
         CLI   MODE,PROCLEVD                                                    
         BNE   XITMO12                                                          
XITMO10  MVC   ADACC,SVADACC       YES SO RESTORE                               
*                                                                               
         USING JBCOLD,R2                                                        
XITMO12  CLI   MODE,ANALFRST                                                    
         BNE   XITMO25                                                          
         ICM   R2,15,JOBRBLK                                                    
         BZ    XITMO25                                                          
         L     R1,AMONACC                                                       
         L     RF,ACMACOL-ACMD(R1)                                              
         CLI   JBNEWEST-JBLOCKD(RF),JBMCSQ     for MCS estimates                
         BE    XITMO20                                                          
         CLI   JBCOLTYP,PROCESD    WAS THIS PROCESSED ?                         
         BNE   XITMO25             NO                                           
         MVI   JBCOLTYP,0          YES, SO CLEAR                                
         B     XITMO25                                                          
*                                                                               
         USING MJETABD,R2                                                       
XITMO20  CLI   MJETTYP,PROCESD     MARKED AS PROCESSED?                         
         BNE   XITMO25             NO                                           
         MVI   MJETTYP,0           YES, SO CLEAR                                
         DROP  R2                                                               
*                                                                               
XITMO25  L     R5,AFORMATS         START WITH FORMAT 1                          
         LH    R1,FORMAT#          NUMBER OF FORMATS TO CHECK ON                
XITMO30  TM    FMTMODES,FMTNOTRS                                                
         BZ    XIT                                                              
         AHI   R5,FMTLNQ                                                        
         BCT   R1,XITMO30                                                       
*                                                                               
         MVI   FCRDTRNS,NO         IF ALL FORMAT HAVE BIT SET THEN              
         MVI   FCRDTIME,NO         TURN THESE OFF                               
*                                                                               
XIT      TM    UPSI,UPSITABS                                                    
         JZ    XITNTR1                                                          
         LA    R3,ASIDFLD                                                       
         EXTRACT (R3),'S',FIELDS=(ASID)                                         
         L     R2,ASIDFLD                                                       
         LOCASCB ASID=(R2)                                                      
         L     R0,ASCBEJST-ASCB(,R1)                                            
         ST    R0,TIMEOUT          END   TIME IN                                
         S     R0,TIMEIN           START TIME IN                                
*                                                                               
         USING TIMED,R3                                                         
         ICM   R3,15,TIMENTY       GET CURRENT ENTRY                            
         JZ    XITNTR1                                                          
         A     R0,TIMETOTL         ADD TIME IN                                  
         ST    R0,TIMETOTL         SAVE TOTAL TIME IN                           
         L     R0,TIMECNT                                                       
         AHI   R0,1                                                             
         ST    R0,TIMECNT                                                       
*                                                                               
XITNTR1  XIT1                                                                   
         DROP  R3,R5                                                            
         EJECT                                                                  
*=====================================================================*         
* Test date filtering of alternate dates at account level             *         
*=====================================================================*         
                                                                                
TSTDTES  ST    RE,SVRE                                                          
         ST    R1,SVR1                                                          
         CLI   QPROG,PRODUCTION           Production ?                          
         JNE   TSTDT200                   No                                    
         TM    DATEFLT,DATECLS+DATEOPN    Either OPEN or CLOSE date             
         JZ    TSTDT120                                                         
         CLC   ALTNSTR,XCRDTE                                                   
         JH    TSTDTENO                                                         
         CLC   ALTNEND,XCRDTE                                                   
         JL    TSTDTENO                                                         
*                                                                               
TSTDT120 DS    0H                                                               
                                                                                
**&UK                                                                           
**       L     RE,AMONACC                                                       
**       L     RE,ACMAJOBB-ACMD(RE)                                             
**       CLI   JBNEWEST-JBLOCKD(RE),JBMCSQ  Test MCS Estimates                  
**       JE    TSTDTEOK            Yes - don't filt JOB on est. dates           
**&                                                                             
*&&UK*&& J     TSTDTEOK            Don't filter JOB on any Est. dates           
*                                                                               
         USING ESTD,RE                                                          
         L     RE,ACURREST                                                      
         LA    RF,ESTADTE          Current estimate date                        
         TM    DATEFLT,DATEEST     Filter job by estimate date                  
         JO    TSTDT122                   No filtering                          
         TM    DATEFLT2,DATEAPR+DATEPRE   Either Approver or Perparer           
         JZ    TSTDT200                   No filtering                          
         LA    RF,ESTAPDT          Current est apporval date                    
         TM    DATEFLT2,DATEAPR    Approver date filter                         
         JO    TSTDT122                                                         
         LA    RF,ESTPRDT          Current est preparer date                    
         TM    DATEFLT2,DATEPRE    Preparer date filter                         
         JO    TSTDT122                                                         
         DC    H'00'                                                            
         DROP  RE                                                               
                                                                                
TSTDT122 OC    0(3,RF),0(RF)       Any date ?                                   
         JZ    TSTDTENO            No, so eliminate                             
         OC    RQS_EST,RQS_EST     Any start date specified ?                   
         JZ    TSTDT125              No                                         
         CLC   0(3,RF),RQS_EST       Yes                                        
         JL    TSTDTENO            Skip account                                 
*                                                                               
TSTDT125 CLI   RQE_EST,X'FF'       Any end date specified ?                     
         JE    TSTDT200              No                                         
         CLC   0(3,RF),RQE_EST       Yes                                        
         JH    TSTDTENO            Skip account                                 
*                                                                               
TSTDT200 CLI   QPROG,MANPOWER      Person Scribe ?                              
         JNE   TSTDTEOK            Nothing to filter                            
         LA    RF,HIREDTE                                                       
         TM    DATEFLT,DATEHIR     Filter hire date ?                           
         JO    TSTDT210            Yes                                          
         LA    RF,TERMDTE                                                       
         TM    DATEFLT2,DATETRM    Filter termination date ?                    
         JZ    TSTDT220            No                                           
*                                                                               
TSTDT210 CLC   ALTNEND,0(RF)       Check range                                  
         JL    TSTDTENO                                                         
         CLC   ALTNSTR,0(RF)                                                    
         JH    TSTDTENO                                                         
*                                                                               
TSTDT220 CLI   REQLOCST,X'FF'      Location status filter ?                     
         JE    TSTDTEOK            No, so ok                                    
         SR    RE,RE                                                            
         IC    RE,REQLOCCC         Load condition code                          
         BASR  R1,0                                                             
         CLC   REQLOCST,PRSNSTAT   Match location status with request           
         EX    RE,14(R1)                                                        
         J     TSTDTENO                                                         
         JNOP  TSTDTEOK                                                         
*                                                                               
TSTDTEOK SR    RE,RE               This will set CC to equal                    
TSTDTENO LTR   RE,RE               This will set CC to not equal                
         L     RE,SVRE                                                          
         L     R1,SVR1                                                          
         BR    RE                                                               
         EJECT                                                                  
***********************************************************************         
* Turn of bits according to status indicatore or values                         
***********************************************************************         
         USING RSTELD,R2                                                        
SETSTAT  ST    RE,SVRE                                                          
         LHI   RF,-1               Starting clearing                            
         SR    RE,RE               RF=X'FFFF', RE=X'0000'                       
         SLDL  RE,0(R1)            Shift n bits into RE                         
         STC   RE,BYTE                                                          
         NC    ACLOCK,BYTE         Clear higher levels                          
         NC    ACCLOSE,BYTE        Clear higher levels                          
         NC    ACPAYEE,BYTE        Clear higher levels                          
         LA    RE,ANALCLI+1(R1)                                                 
         LHI   RF,4                Up to 4 levels                               
         SR    RF,R1                                                            
         JZ    SETSTA04                                                         
                                                                                
SETSTA02 MVI   0(RE),C' '          Relative code no EX for now                  
         LA    RE,1(,RE)                                                        
         BRCT  RF,SETSTA02                                                      
                                                                                
SETSTA04 MVI   ANALFLT,C' '        Reset                                        
         CLI   QPROG,GENERAL       GL Scribe?                                   
         JNE   *+8                 Yes                                          
         MVI   REVSIGN,NO          Default                                      
                                                                                
         LTR   R2,R2               Is this set ?                                
         JNZ   SETSTA10            Yes, so continue                             
         L     R2,ADACC            No, so find element                          
         AH    R2,DATADISP                                                      
SETSTA05 CLI   0(R2),EOR                                                        
         JE    SETSTATX            Can't do it.                                 
         CLI   0(R2),RSTELQ        X'30' element                                
         JE    SETSTA10                                                         
         LLC   RF,1(,R2)                                                        
         AR    R2,RF                                                            
         J     SETSTA05                                                         
                                                                                
SETSTA10 LA    RF,1                Starting bit                                 
         SLL   RF,0(R1)            Shift based on R1 value                      
         STC   RF,BYTE                                                          
         TM    RSTSTAT,RSTSACIL    Locked ?                                     
         JZ    *+10                No                                           
         OC    ACLOCK,BYTE         Set lock value                               
         CLI   RSTLN,RSTLN2Q                                                    
         JL    *+18                                                             
         TM    RSTSTAT2,RSTSPLOK   PAYEE=NO ?                                   
         JZ    *+10                No                                           
         OC    ACPAYEE,BYTE        Yes, PAY=NO                                  
         TM    RSTSTAT,RSTSACIC    Closed ?                                     
         JZ    *+10                No                                           
         OC    ACCLOSE,BYTE        Yes account is closed                        
*                                                                               
         LA    RE,ANALCLI+1(R1)                                                 
         CLI   QPROG,MANPOWER                                                   
         JE    SETSTA20            Manpower get RSTCOSTG                        
         CLI   QPROG,GENERAL                                                    
         JNE   SETSTA12                                                         
         MVI   0(RE),C' '          Yes                                          
         CLI   RSTLN,RSTLN3Q                                                    
         JL    SETSTA40                                                         
         TM    RSTSTAT6,RSTYREVS   Reverse sign                                 
         JZ    *+8                 No                                           
         MVI   0(RE),YES           Yes                                          
*** 'Yes' or 'No' for UK and can be set at all account levels ***               
*&&US                                                                           
         TM    RSTSTAT6,RSTNREVS   Reverse sign                                 
         JZ    *+8                 No                                           
         MVI   0(RE),NO            Yes                                          
*&&                                                                             
         J     SETSTA40                                                         
                                                                                
SETSTA12 TM    EXPSTAT,EXPNCOST    New cost?                                    
         JO    SETSTA30            Yes                                          
         J     SETSTATX            No, then done                                
*                                                                               
SETSTA20 CLI   RSTCOSTG,C' '       ANALYSIS BY CLI (OLD COST)                   
         JNH   *+10                                                             
         MVC   0(1,RE),RSTCOSTG    SAVE VALUE                                   
         J     SETSTA40                                                         
*                                                                               
SETSTA30 CLI   RSTLN,RSTLN1Q       WHICH LENGTH X'16' OR X'1D' IS IT?           
         JE    SETSTA40            ELEMENT TOO SHORT FOR RSTSTAT2               
         TM    RSTSTAT2,RSTSYCST   COST=Y, cost postings                        
         JZ    *+8                                                              
         MVI   0(RE),YES                                                        
         TM    RSTSTAT2,RSTSNCST   COST=N, no cost postings                     
         JZ    *+8                                                              
         MVI   0(RE),NO                                                         
*                                                                               
SETSTA40 DS    0H                                                               
         LA    RF,2(,R1)           Check ledger too                             
SETSTA42 CLI   0(RE),C' '                                                       
         JH    SETSTA44            If blank then found setting                  
         BCTR  RE,0                Look at next                                 
         BRCT  RF,SETSTA42                                                      
         LA    RE,SPACES                                                        
                                                                                
SETSTA44 MVC   ANALFLT,0(RE)       Set analysis code                            
*                                                                               
SETSTATX DS    0H                                                               
*&&UK                                                                           
         USING ACRL2D,RE                                                        
         L     RE,AACRL2D                                                       
         MVC   CURPRTY,AC@NO                                                    
         TM    RSTSTAT6,RSTSDTOP                                                
         JNO   *+10                                                             
         MVC   CURPRTY,AC@YES      A desktop priorty account                    
         DROP  RE                                                               
*&&                                                                             
         L     RE,SVRE                                                          
         BR    RE                                                               
         DROP  R2                                                               
         EJECT                                                                  
***********************************************************************         
* Check account status and set condition code (Relative code)                   
***********************************************************************         
         USING FMTRECD,R5                                                       
ACSTATUS LR    RF,RE                                                            
         TM    ACCSTAT,ACCPAYN     PAY=NO?                                      
         JO    *+12                YES IT IS A LOCKED ACCOUNT                   
         TM    FMTROPT2,RPFOVNDR   PAYEE=NO ACCOUNTS ONLY?                      
         J     *+8                                                              
         TM    FMTROPT2,RPFXVNDR   EXCLUDE PAY=NO ACCOUNTS?                     
         JO    ACSTATNO                                                         
*                                                                               
         TM    ACCSTAT,ACCLOCK     LOCKED?                                      
         JO    *+12                YES IT IS A LOCKED ACCOUNT                   
         TM    FMTROPT,RPFOLOCK    LOCKED ACCOUNTS ONLY?                        
         J     *+8                                                              
         TM    FMTROPT,RPFXLOCK    EXCLUDE LOCKED ACCOUNTS?                     
         JO    ACSTATNO                                                         
*                                                                               
         TM    ACCSTAT,ACCCLSE     CLOSED?                                      
         JO    *+12                YES IT IS A CLOSED ACCOUNT                   
         TM    FMTROPT4,RPFOCLSE   CLOSED ACCOUNTS ONLY?                        
         J     *+8                                                              
         TM    FMTROPT4,RPFXCLSE   EXCLUDE CLOSED ACCOUNTS?                     
         JO    ACSTATNO                                                         
         SR    RF,RF                                                            
ACSTATNO LTR   RF,RF                                                            
         BR    RE                                                               
         DROP  R5                                                               
         EJECT                                                                  
***********************************************************************         
* IO routine. Relative code                                                     
***********************************************************************         
IO       ST    RE,IOSVREG          SAVE RE FOR RETURN                           
         ST    R1,IOFLAGS          SAVE ACTION, FILE AND AREA FLAGS             
*                                                                               
         MVI   IODMIND,0                                                        
         MVC   IOFILE,DMFACFIL     DEFAULT TO ACCOUNTING FILE                   
         LA    RF,IOKEY                                                         
         TM    IOFFLAG,IACFIL      Account file?  X'04'                         
         JO    IO10                Yes                                          
         TM    IOFFLAG,ICNTRL      Control file?  X'08'                         
         JZ    IO03                                                             
         MVC   IOFILE,DMFCNTRL     Use control file                             
         CLI   IOKEY,C'0'          See if this is a security record             
         JNE   IO03                Yes                                          
         TM    IOAFLAG,IREAD                                                    
         JZ    IO03                                                             
         OI    IODMIND,IODMSPC+IODMSEC                                          
                                                                                
IO03     DS    0H                                                               
*&&UK                                                                           
         CLI   IOFFLAG,IACARC      ACCARC FILE?  X'03'                          
         JNE   *+14                                                             
         MVC   IOFILE,DMFACARC     USE ACCARC FILE                              
         J     IO06                                                             
*&&                                                                             
         TM    IOFFLAG,IACDIR      ACCDIR FILE?  X'02'                          
         JZ    *+14                                                             
         MVC   IOFILE,DMFACDIR     USE DIRECTORY FILE                           
         LA    RF,IODIRKEY                                                      
         TM    IOFFLAG,IACMST      ACCMST FILE?  X'01'                          
         JZ    IO10                                                             
         MVC   IOFILE,DMFACMST     USE ACCMST FILE                              
IO06     LA    RF,IODISK           A(DISK A(0))                                 
         ICM   RE,15,IODISK                                                     
         JNZ   IO10                                                             
         MVI   DMCB+8,1            SET CON CODE TO NO                           
         J     IO40                                                             
*                                                                               
IO10     MVC   IOACTION,DMRDHI     DEFAULT READ HI                              
         TM    IOAFLAG,IHIGH       READ HI?                                     
         JO    IO20                                                             
         TM    IOAFLAG,IREAD       READ?                                        
         JZ    *+10                                                             
         MVC   IOACTION,DMREAD                                                  
         TM    IOAFLAG,ISEQ        READ SEQUENTIAL?                             
         JZ    *+10                                                             
         MVC   IOACTION,DMRSEQ                                                  
         TM    IOAFLAG,IGETREC     GET RECORD?                                  
         JZ    *+10                                                             
         MVC   IOACTION,DMGET                                                   
*                                                                               
IO20     MVC   IOBUFF,AIO1         SET DEFAULT AREA                             
         TM    IOIFLAG,IAREA1                                                   
         JO    IO30                                                             
         TM    IOIFLAG,IAREA2                                                   
         JZ    *+10                                                             
         MVC   IOBUFF,AIO2                                                      
         TM    IOIFLAG,IAREA3                                                   
         JZ    *+10                                                             
         MVC   IOBUFF,AIO3                                                      
         TM    IOIFLAG,IBUD                                                     
         JZ    *+10                                                             
         MVC   IOBUFF,ABUDIO                                                    
*                                                                               
         USING ACCRECD,RE                                                       
IO30     GOTOR DATAMGR,DMCB,(IODMIND,IOACTION),IOFILE,(RF),IOBUFF,IOWRK         
         TM    IOFFLAG,IACDIR      ACCDIR FILE?  X'02'                          
         JZ    IO40                                                             
         L     RE,IOBUFF                                                        
         MVC   IODISK,ACCKDA                                                    
         DROP  RE                                                               
                                                                                
IO40     L     RE,IOSVREG                                                       
         CLI   DMCB+8,0            SET CON CODE                                 
         BR    RE                                                               
         DROP  R7,R8,R9            DROP BASE REGISTERS                          
         EJECT ,                                                                
*=====================================================================*         
* Check to see if payrolls are all process in ACCLAST                           
*    R5 = current format table                                                  
*=====================================================================*         
         USING FMTRECD,R5                                                       
PAYACTV  SR    RF,RF                                                            
         ICM   R1,15,FMTRTES       Any rates                                    
         JZ    PAYACT50            No                                           
PAYACT10 CLI   0(R1),EOR           Any more                                     
         JE    PAYACT50            No                                           
         CLI   0(R1),RT$ELQ                                                     
         BER   RE                  Need to process                              
         IC    RF,1(,R1)                                                        
         AR    R1,RF                                                            
         J     PAYACT10                                                         
                                                                                
PAYACT50 ICM   R1,15,FMTPAY$       A(Payroll amount elements)                   
         JZ    PAYACTVN            None                                         
                                                                                
PAYACT60 CLI   0(R1),EOR           Any more                                     
         JE    PAYACTVN            No, all processed                            
         CLI   0(R1),P$TELQ                                                     
         BER   RE                  Need to process                              
         IC    RF,1(,R1)                                                        
         AR    R1,RF                                                            
         J     PAYACT60                                                         
                                                                                
PAYACTVN LTR   RE,RE               Set CC to No                                 
         BR    RE                                                               
         DROP  R5                                                               
         EJECT ,                                                                
*=====================================================================*         
*       Set PTA data for transaction  - Relative code, no base reg.   *         
*       Registers destroyed are R2,RE,RF                              *         
*=====================================================================*         
         USING PTAELD,R2                                                        
PTADATA  ST    RE,SVRE                                                          
         L     R2,APTAWRK          Get my work area of X'77'                    
*                                                                               
PTADAT10 CLI   0(R2),0             End of X'77'                                 
         JE    PTADATX                                                          
         CLI   0(R2),PTAELQ        X'77'                                        
         JNE   PTADAT40                                                         
         LA    RE,BILLDTE          Billed ?                                     
         LA    RF,AELEM77B                                                      
         CLI   PTATYPE,PTATRAL                                                  
         JE    PTADAT30                                                         
         LA    RE,TRFRDTE          Transfered ?                                 
         LA    RF,AELEM77T                                                      
         CLI   PTATYPE,PTATTRFT                                                 
         JE    PTADAT30                                                         
         LA    RE,WROFDTE          Write-off ?                                  
         LA    RF,AELEM77W                                                      
*                                                                               
PTADAT30 OC    0(4,RF),0(RF)       Is one saved already ?                       
         JNZ   PTADAT40            Yep                                          
         ST    R2,0(,RF)           Save address                                 
         MVC   3(2,RE),PTAMOA      Save off MOA                                 
         CLI   PTATYPE,PTATRAL                                                  
         JNE   PTADAT35                                                         
         TM    PTASTAT1,PTASPEND                                                
         JZ    PTADAT35                                                         
         OI    CURIND,CURBILPD     This is pending (SAVE STATUS)                
*                                                                               
PTADAT35 ZIC   RF,PTALN                                                         
         SHI   RF,3                Point to saved off data                      
         AR    R2,RF                                                            
         MVC   0(3,RE),0(R2)       Save date                                    
         SR    R2,RF               Point back to begining                       
*                                                                               
PTADAT40 ZIC   RF,1(,R2)           Get length                                   
         AR    R2,RF                                                            
         J     PTADAT10                                                         
*                                                                               
PTADATX  L     RE,SVRE                                                          
         BR    RE                                                               
         DROP  R2                                                               
***********************************************************************         
*                                                                               
***********************************************************************         
         SPACE 1                                                                
         USING CACRECD,R2                                                       
XDUMP    NTR1  BASE=*,LABEL=*                                                   
         LH    RF,DATADISP                                                      
         MVI   WORK,C'1'                                                        
         MVI   WORK+1,C'R'                                                      
         MVI   WORK+4,C'A'         Account                                      
         CLC   CACKOFF,SPACES                                                   
         JNH   *+8                                                              
         MVI   WORK+4,C'O'         Office                                       
         GOTOR PRNTBL,DMCB,(1,WORK+4),(R2),C'DUMP',(RF),WORK                    
         XIT1                                                                   
         DROP  R2                                                               
         EJECT                                                                  
         LTORG                                                                  
         TITLE 'Get tax Id and employer info from account record'               
***********************************************************************         
* R1 = Address of record to search for data                                     
***********************************************************************         
         USING ACTRECD,R1                                                       
ACCINFO  NTR1  BASE=*,LABEL=*                                                   
         LR    R2,R1                                                            
         SR    RF,RF                                                            
         AH    R2,DATADISP                                                      
ACCINF10 CLI   0(R2),0             EOR  ?                                       
         JE    ACCINF90            YES                                          
*&&US*&& CLI   0(R2),OTHELQ        X'23', Other element (Tax info)              
*&&US*&& JE    ACCINF20                                                         
         CLI   0(R2),EMPELQ        X'56', Employee information                  
         JE    ACCINF30                                                         
         IC    RF,1(,R2)                                                        
         AR    R2,RF                                                            
         J     ACCINF10                                                         
*&&US                                                                           
         USING OTHELD,R2                                                        
ACCINF20 DS    0H                                                               
         LA    RE,CURTAX#                                                       
         CLC   ACTKUNT(2),=C'2C'   Ledger passed is 2C?                         
         JNE   *+8                                                              
         LA    RE,CURTAX2C                                                      
         CLI   OTHPROF,C' '                                                     
         JE    *+8                                                              
         CLI   OTHPROF,C'I'                                                     
         JNE   ACCINF90                                                         
         MVC   0(L'CURTAX#,RE),OTHNUM                                           
                                                                                
         TM    REQIND,REQDDS                                                    
         JZ    *+10                                                             
         MVC   0(L'CURTAX#-4,RE),=12C'*'                                        
                                                                                
         USING LDGELD,R3                                                        
         CLC   =C'2C',CURACC+1    Are we really processing 2C ledger?           
         JNE   ACCINF22           No                                            
         MVC   CURTAX#,CURTAX2C   Yes                                           
         J     ACCINF24                                                         
                                                                                
ACCINF22 CLC   =C'2C',ACTKUNT                                                   
         JE    ACCINF90            Don't re-set type if 2C                      
                                                                                
ACCINF24 L     R3,ADLDGEL                                                       
         MVC   CURTAXTY,=C'SSN'    Social Security                              
         TM    LDGSTAT,LDGSCANL                                                 
         JZ    *+10                                                             
         MVC   CURTAXTY,=C'SIN'    Canada Id                                    
         CLI   OTHPROF,C'I'                                                     
         JNE   ACCINF90                                                         
         MVC   CURTAXTY,=C'EIN'    Tax Id                                       
         TM    LDGSTAT,LDGSCANL                                                 
         JZ    *+10                                                             
         MVC   CURTAXTY,=C'BN '    Candada Tax Id                               
         J     ACCINF90                                                         
         DROP  R3                                                               
*&&                                                                             
         USING EMPELD,R2                                                        
ACCINF30 MVC   HIREDTE,EMPHIR      Hire date                                    
         OC    EMPTRM,EMPTRM                                                    
         JZ    ACCINF90                                                         
         MVC   TERMDTE,EMPTRM      Termination date                             
                                                                                
ACCINF90 XIT1                                                                   
         DROP  R1,R2                                                            
                                                                                
         LTORG                                                                  
         TITLE 'Keep track and print out time spent in each mode'               
***********************************************************************         
* Debug - time display in each mode                                             
***********************************************************************         
         USING ACWORKD,RC                                                       
         USING ACRLD,RA                                                         
TIMELAP  NTR1  BASE=*,LABEL=*                                                   
         LTR   R1,R1                                                            
         BNZ   TIMEL30                                                          
*                                                                               
         LA    R3,ASIDFLD                                                       
         EXTRACT (R3),'S',FIELDS=(ASID)                                         
         L     R2,ASIDFLD                                                       
         LOCASCB ASID=(R2)                                                      
         L     R0,ASCBEJST-ASCB(,R1)                                            
         ST    R0,TIMEIN           START TIME IN                                
         S     R0,TIMEOUT          START TIME OUT                               
*                                                                               
         USING TIMED,R3                                                         
         L     R3,=A(TMONACC)                                                   
         A     R0,TIMETOTL         TIME IN MONACC                               
         ST    R0,TIMETOTL                                                      
         L     R0,TIMECNT                                                       
         AHI   R0,1                                                             
         ST    R0,TIMECNT                                                       
         ICM   R3,15,TIMENTY                                                    
         BZ    TIMEL12                                                          
         CLC   MODE,TIMEMODE                                                    
         BE    TIMELAPX                                                         
*                                                                               
TIMEL12  LA    R0,TIMEQ            NUBMER OF ENTRIES                            
         L     R3,=A(TIMETAB)                                                   
*                                                                               
TIMEL15  CLC   MODE,TIMEMODE                                                    
         BE    TIMEL18                                                          
         LA    R3,TIMELNQ(,R3)     NEXT ENTRY                                   
         BCT   R0,TIMEL15                                                       
*                                                                               
TIMEL18  ST    R3,TIMENTY          SAVE ENTRY ADDRESS                           
         B     TIMELAPX                                                         
*                                                                               
         USING BIGPRNTD,R6                                                      
TIMEL30  L     R6,VBIGPRNT                                                      
         MVI   FORCEHED,YES                                                     
         MVC   XP+1(7),=C'ROUTINE'                                              
         MVC   XP+13(7),=C'ENTERED'                                             
         MVC   XP+25(4),=C'TIME'                                                
         GOTO1 REPORT                                                           
*                                                                               
         L     R3,=A(TIMETAB)                                                   
         LA    R4,TIMEQ+2                                                       
TIMEL35  L     R1,TIMECNT                                                       
         CVD   R1,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  XP+13(10),DUB                                                    
         L     R0,TIMETOTL                                                      
         SRDL  R0,32                                                            
         D     R0,=F'3600'         GIVES HOURS IN R1                            
         CVD   R1,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  WORK(2),DUB                                                      
         MVI   WORK+2,C'.'                                                      
         SRDL  R0,32                                                            
         D     R0,=F'60'           GIVES MINUTES IN R1/SECS IN R0               
         CVD   R1,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  WORK+3(2),DUB                                                    
         MVI   WORK+5,C'.'                                                      
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  WORK+6(2),DUB                                                    
         MVC   XP+25(8),WORK       CPU TIME                                     
         MVC   XP+1(7),TIMETAG     ROUTINE                                      
         MVI   XP+8,C'='                                                        
         GOTO1 REPORT                                                           
         LA    R3,TIMELNQ(,R3)                                                  
         BCT   R4,TIMEL35                                                       
*                                                                               
TIMELAPX XIT1                                                                   
         DROP  R3,R6                                                            
         LTORG                                                                  
         TITLE 'Run first process'                                              
*=====================================================================*         
* Initialize variables for run                                                  
*=====================================================================*         
         USING MASTD,R6                                                         
         USING REMOTED,RF                                                       
         USING ACMD,R2                                                          
RUNFIRST NTR1  BASE=*,LABEL=*                                                   
         NI    DDLNKIND,TURNOFF-DDLNKTST                                        
         CLI   RCRERUN,C'G'        Mimic Global file                            
         BE    *+8                                                              
         CLI   RCRERUN,YES                                                      
         BE    *+8                                                              
         CLI   RCRERUN,C'X'        Mimmic running under DDLINK as XML           
         BNE   *+8                                                              
         OI    DDLNKIND,DDLNKTST   Test mode                                    
                                                                                
         TM    DDLNKIND,DDLNKINT                                                
         BZ    RUNF02                                                           
         SR    R0,R0                                                            
         SR    R1,R1                                                            
         LA    RE,SVREG                                                         
         LA    RF,TSARBLK-SVREG                                                 
         MVCL  RE,R0                                                            
                                                                                
         LA    RE,METHODS                                                       
         LA    RF,WCLONG-METHODS                                                
         MVCL  RE,R0                                                            
                                                                                
         LA    RE,DFTBLK1                                                       
         LA    RF,ANSWER-DFTBLK1                                                
         MVCL  RE,R0                                                            
                                                                                
RUNF02   L     R2,AMONACC                                                       
         MVI   FCRESET,YES         Reset MONACH key                             
         MVI   NEWOFF,NO           Test for one or two byte office              
         TM    ACMINDS,ACMINEWO    Two byte office system ?                     
         BZ    *+8                 No                                           
         MVI   NEWOFF,YES          Yes                                          
         DROP  R2                                                               
                                                                                
         TM    DDLNKIND,DDLNKINT   DDLINK code initialized ?                    
         BO    RUNF50              Yes                                          
                                                                                
         MVI   SOONJOB,NO                                                       
         MVI   PIXOPT1,0           Initialize                                   
                                                                                
         L     R6,ADMASTC                                                       
         TM    MCOPT1,MCQ1PQIX     WAS PQIX=Y set in JCL ?                      
         BZ    *+8                 No                                           
         OI    PIXOPT1,PIXGO       Yes                                          
                                                                                
         ICM   RF,15,REMOTEC       Going to queue                               
         BZ    RUNF05              No                                           
         OC    REMOTKEY,REMOTKEY                                                
         BZ    RUNF05                                                           
         OI    PIXOPT1,PIXGO       Turn on print queue indexing                 
         MVI   SOONJOB,DIRECT      Yes                                          
         OC    MCREMPQK,MCREMPQK   Is it running SOON ?                         
         BZ    *+8                 No                                           
         MVI   SOONJOB,YES         Yes                                          
         TM    REMOTTYP,REMOTSQQ   SQL (RDR) ?                                  
         BZ    RUNF05              No                                           
         NI    PIXOPT1,TURNOFF-PIXGO                                            
         DROP  RF                                                               
*                                                                               
         USING BOXD,R2                                                          
RUNF05   DS    0H                                                               
         TM    DDLNKIND,DDLNKON                                                 
         BO    RUNF08                                                           
         L     R2,MCBXAREA                                                      
         LA    R1,198                                                           
         ST    R1,BOXWIDTH                                                      
         DROP  R2,R6                                                            
*                                                                               
RUNF08   OC    MAINPROG,MAINPROG   Were these phases loaded already ?           
         BNZ   RUNF10              Yes, skip loading these phases               
         TM    DDLNKIND,DDLNKON                                                 
         BO    RUNF10                                                           
         GOTO1 =A(LOADPROG)                                                     
                                                                                
RUNF10   DS    0H                                                               
         L     RE,=A(RELOTAB)      RELOCATE MY GLOBAL ROUTINES                  
         LA    RF,ACGLOBAL                                                      
RUNF12   L     R1,0(,RE)                                                        
         LA    RE,4(,RE)                                                        
         ST    R1,0(,RF)                                                        
         LA    RF,4(,RF)                                                        
         CLI   0(RE),EOT                                                        
         BNE   RUNF12                                                           
*                                                                               
         USING ACMD,R2                                                          
         L     R2,AMONACC                                                       
         MVC   ACLIST,ACMVALST     A(ACLIST)   -> PAN BOOK ACACCLIST            
         MVC   ATSAROFF,ACMVTSAR   A(TSAROFF)                                   
         DROP  R2                                                               
                                                                                
RUNF20   DS    0H                                                               
         MVI   PKZERO,X'0C'        Set packed zero                              
         MVI   PKONE,X'1C'         Set packed positive one                      
         MVI   PKNEG,X'1D'         Set packed negative one                      
         MVC   DMFCNTRL,=CL8'CTFILE'                                            
         MVC   DMFACFIL,=CL8'ACCOUNT'                                           
         MVC   DMFACDIR,=CL8'ACCDIR'                                            
         MVC   DMFACMST,=CL8'ACCMST'                                            
         MVC   DMFACARC,=CL8'ACCARC'                                            
                                                                                
         USING COMFACSD,R2                                                      
         L     R2,ADCOMFAC                                                      
         TM    DDLNKIND,DDLNKON    For DDLink get it from LP_D block            
         BO    *+10                                                             
         MVC   SECRET,CSECRET                                                   
         MVC   DDLINKIO,CLINKIO                                                 
         OC    CLINKIO,CLINKIO                                                  
         JNZ   RUNF50                                                           
         L     RE,=A(XMLOUT)       XML version                                  
         CLI   RCRERUN,C'X'                                                     
         BE    *+8                                                              
         LA    RE,RTNRE                                                         
         ST    RE,DDLINKIO         Dummy up DDLINKIO - for testing              
         J     RUNF50                                                           
         DROP  R2                                                               
                                                                                
RUNF50   XC    SJLGST(SJLGSTLN),SJLGST                                          
         MVI   RLLANG,NO           TABLES HAVE NOT BEEN TRANSLATED YET          
         MVI   MULTLDG,NO                                                       
         MVI   BUILD,0             NO SPECIAL TABLES TO BUILD                   
         MVI   BUILT,0             NONE BUILT                                   
         GOTO1 ROUTINE             MAKE ROUTINES ADDRESSABLE                    
         GOTO1 PRINTREP                                                         
         GOTO1 TABINIT                                                          
         GOTO1 FRMTBLD             MAKE ROUTINES ADDRESSABLE                    
         MVC   PREVLDG,SPACES      INITIALIZE                                   
         TM    DDLNKIND,DDLNKON    DDLINK running ?                             
         BZ    RUNFXIT                                                          
         OI    DDLNKIND,DDLNKINT   DDLINK code initialized ?                    
RUNFXIT  XIT1                                                                   
                                                                                
RTNRE    BR    RE                                                               
                                                                                
         LTORG                                                                  
         TITLE 'Process before request first'                                   
*=====================================================================*         
*  Process request before we start request first                                
*=====================================================================*         
         USING MASTD,R6                                                         
         USING ACQD,R3                                                          
RQSTART  NTR1  BASE=*,LABEL=RQST                                                
         L     R6,ADMASTC                                                       
         L     R3,ADQSTACK                                                      
         MVI   REQIND,0                                                         
                                                                                
         MVI   FCRQOPT,FCRQOPTQ    Turn this option on                          
         CLI   MCTEST2,C' '                                                     
         BNH   RQST02                                                           
         MVC   ACQOPT10,MCTEST2                                                 
*                                                                               
RQST02   CLC   =C'EDICT',QUESTOR   Debug way of getting at this                 
         BNE   *+8                                                              
         MVI   ACQOPT1,FTPDL       FTP type transmission                        
*&&UK                                                                           
         TM    DWNOPT3,DWNTBDE     Test BDE download                            
         BZ    *+8                                                              
         MVI   ACQOPT1,BDEDL                                                    
         TM    DWNOPT3,DWNTUSS     Test USS download                            
         BZ    *+8                                                              
         MVI   ACQOPT1,USSDL                                                    
*&&                                                                             
         TM    DWNOPT3,DWNTEDI     Test EDIHUB download                         
         BZ    *+8                                                              
         MVI   ACQOPT1,EDIDL                                                    
*                                                                               
         USING REMOTED,RF                                                       
         ICM   RF,15,REMOTEC       Going to queue                               
         BZ    RQST12              No                                           
         OC    REMOTKEY,REMOTKEY                                                
         BZ    RQST12              No                                           
         CLI   ACQOPT1,C' '                                                     
         BH    RQST10                                                           
         TM    REMOTTYP,REMOTSQQ+REMOTDLQ   SQL (RDR) or Download               
         BZ    RQST10              No                                           
         MVI   ACQOPT1,C'Y'        Set to download                              
         TM    DWNOPT2,DWNFTP      This was set in PROCSPCL mode                
         BZ    *+8                 Maybe not, not on record                     
         MVI   ACQOPT1,FTPDL       Make FTP type transmission                   
         TM    DWNOPT2,DWNDSN      This was set in PROCSPCL mode                
         BZ    *+8                 Maybe not, not on record                     
         MVI   ACQOPT1,DSNDL       Make DSN type transmission                   
                                                                                
RQST10   CLI   SOONJOB,NO                                                       
         JE    RQST12                                                           
         TM    REMOTTYP,REMOTSQQ   SQL (RDR) ?                                  
         BO    RQST12              Don't over-ride for RDR                      
         MVI   REMOTSYS,C'A'                                                    
         MVC   REMOTPRG,QPROG                                                   
         XC    REMOTSUB,REMOTSUB                                                
         MVC   REMOTDSC,QAPPL      Format code                                  
         DROP  R6,RF                                                            
*                                                                               
RQST12   CLI   QUNIT,C'('                                                       
*&&US*&& BNE   RQST20                                                           
*&&UK*&& BNE   RQST90                                                           
         MVC   QUNIT(2),SPACES                                                  
         MVC   ACQUNT(2),SPACES                                                 
*&&US                                                                           
RQST20   CLI   ACQTYP8,ACQAUTH     Was authorization requested ?                
         BNE   RQST90                                                           
         BRAS  RE,AUTHSET          Assume regester all set                      
*&&                                                                             
RQST90   XIT1                                                                   
         DROP  R3                                                               
         SPACE 1                                                                
         LTORG                                                                  
         TITLE 'Print out extra request card data'                              
*=====================================================================*         
* Print out extra request card info                                             
*=====================================================================*         
         USING ACWORKD,RC                                                       
         USING ACRLD,RA                                                         
         USING RESRECD,R2                                                       
         USING ACQD,R3                                                          
         USING MASTD,R6                                                         
RLREPORT NTR1  BASE=*,LABEL=*                                                   
         L     R2,AIO2                                                          
         L     R3,ADQSTACK                                                      
         L     R4,SVREG            ADDRESS OF REQUEST CARD DATA                 
         L     R6,ADMASTC                                                       
         XC    AELM1ST(AELMLEN),AELM1ST                                         
         GOTOR GETFORMT,DMCB,(2,QAPPL)                                          
         CLI   ERROR#,0                                                         
         JNE   RLREP98                                                          
                                                                                
         SR    RF,RF                                                            
         AH    R2,DATADISP                                                      
RLREP10  CLI   0(R2),EOR                                                        
         JE    RLREP20                                                          
         CLI   0(R2),STYELQ        X'25' Scribe info element                    
         JNE   *+8                                                              
         ST    R2,AELMSTY          Save off element address                     
                                                                                
         CLI   0(R2),RPFELQ        X'C4' Profile element                        
         JNE   *+8                                                              
         ST    R2,AELMRPF          Save off element address                     
                                                                                
         OC    AELMRCP,AELMRCP                                                  
         JNZ   RLREP18             Already found first one                      
         CLI   0(R2),RCPELQ        X'C8' Recap element                          
         JNE   *+8                                                              
         ST    R2,AELMRCP          Save off element address                     
                                                                                
RLREP18  IC    RF,1(,R2)                                                        
         AR    R2,RF                                                            
         J     RLREP10                                                          
                                                                                
         USING STYELD,R2                                                        
RLREP20  ICM   R2,15,AELMSTY       Scribe type                                  
         JNZ   *+6                                                              
         DC    H'00'                                                            
                                                                                
         CLI   STYNAME,ESC#LFJT                                                 
         JE    *+6                                                              
         DC    H'00'                                                            
                                                                                
         CLI   QOPT3,C'A'          Analysis report?                             
         BNE   RLREP21A                                                         
         L     RE,=A(STYLDGT)                                                   
         LA    RF,STYLDGT#                                                      
RLREP20A CLC   QUNIT(L'QUNIT+L'QLEDGER),0(RE)                                   
         BE    RLREP21                                                          
         AHI   RE,STYLDGTQ                                                      
         BCT   RF,RLREP20A                                                      
         DC    H'00'                                                            
*                                                                               
RLREP21  MVC   STYNAME+1(2),2(RE)                                               
*   need to change the stycode too                                              
*   and how about resetting this??                                              
*                                                                               
*                                                                               
RLREP21A L     RE,=A(STYCVRT)      Convert to type                              
         LA    RF,STYCVRT#                                                      
RLREP22  CLC   STYNAME+1(2),0(RE)  Match on dictionary #                        
         JE    RLREP24                                                          
         AHI   RE,STYCVLQ                                                       
         BCT   RF,RLREP22                                                       
         DC    H'00'                                                            
                                                                                
RLREP24  MVC   QOPT2,2(RE)                                                      
         MVC   QPROG(1),QOPT2      Set QPROG for DDLINK                         
         MVC   RCPROG(1),QOPT2                                                  
         MVC   MCPROG(1),QOPT2                                                  
         MVC   ACQPROG(1),QOPT2                                                 
                                                                                
         MVI   DWNOPT2,0                                                        
         MVC   P,SPACES                                                         
*                                                                               
         USING RPFELD,R2                                                        
         ICM   R2,15,AELMRPF       X'C4', Report profile element                
         JZ    RLREP28                                                          
*                                                                               
         CLI   RPFLN,RPFLN2Q       Must be extended profile element             
         JL    RLREP28             Not long enough to have data                 
         TM    RPFXMIT,RPFXFTP     FTP transmition type                         
         JZ    *+8                                                              
         OI    DWNOPT2,DWNFTP                                                   
         TM    RPFXMIT,RPFXDSN     DSN transmition type                         
         JZ    *+8                                                              
         OI    DWNOPT2,DWNDSN                                                   
*&&US                                                                           
         TM    RPFXMIT,RPFXDSDN    DSN transmition type                         
         JZ    *+8                                                              
         OI    DWNOPT3,DWNFDSDN    DSN Download File                            
*&&                                                                             
*&&UK                                                                           
         TM    RPFXMIT,RPFXBDE     BDE transmission type                        
         JZ    *+8                                                              
         OI    DWNOPT3,DWNTBDE                                                  
         TM    RPFXMIT,RPFXUSS     USS transmission type                        
         JZ    *+8                                                              
         OI    DWNOPT3,DWNTUSS                                                  
*&&                                                                             
         TM    RPFXMIT2,RPFXEDI    EDIHUB transmission type                     
         JZ    *+8                                                              
         OI    DWNOPT3,DWNTEDI                                                  
*                                                                               
RLREP28  CLI   0(R4),ACQRCAP             Recap type from request card ?         
         JNE   RLREP90                   No                                     
         LA    R4,ACQDTSTR-ACQTYP1(,R4)  Recap request info                     
         MVCDD P+24(20),AC#RCAPF         Recap formats                          
         LA    R5,P+45                   Start of formats recapping             
*                                                                               
         USING RCPELD,R2                                                        
         ICM   R2,15,AELMRCP       X'C8', recap element                         
         JZ    RLREP90             No recapping                                 
                                                                                
RLREP30  CLI   0(R2),RCPELQ        Multiple elements                            
         JNE   RLREP80             Finished                                     
         CLI   RCPSEQ,0            Ignore first one, main format                
         JE    RLREP55             Next element                                 
*                                                                               
         CLI   0(R4),C' '          Attached report is on ? Blank=Yes            
         JE    *+8                 Yes                                          
         CLI   0(R4),YES           Attached report is on ?                      
         JNE   RLREP50             No                                           
         MVC   0(8,R5),RCPCODE                                                  
         LA    R5,7(,R5)           POINT  TO LAST CHARACTER                     
         LA    RF,8                NUMBER OF CHARCTERS                          
*                                                                               
RLREP34  CLI   0(R5),C' '          NOT BLANK, START OF DATA                     
         JH    RLREP40                                                          
         BCTR  R5,0                BACK UP ONE UNTIL START OF DATA              
         BRCT  RF,RLREP34                                                       
         AHI   R5,1                NO CHARACTERS, RESET R5                      
         J     RLREP50             GET NEXT RECAP                               
*                                                                               
RLREP40  MVI   1(R5),C','                                                       
         AHI   R5,2                BUMP PAST COMMA                              
*                                                                               
RLREP50  AHI   R4,1                Next recap                                   
                                                                                
RLREP55  ZIC   RF,1(,R2)           Next recap element                           
         AR    R2,RF                                                            
         J     RLREP30                                                          
         DROP  R2                                                               
*                                                                               
RLREP80  CLI   RCREQREP,YES        Test printing request detials                
         BNE   RLREP90             No                                           
         BCTR  R5,0                                                             
         MVI   0(R5),C' '                                                       
         GOTO1 PRINT,DMCB,P,=C'BL02'                                            
**********************************************************************          
*  Fix bad date input                                                           
**********************************************************************          
RLREP90  CLI   QPROG,MANPOWER                                                   
         BE    RLREP98                                                          
         CLC   QSTART(4),SPACES    Date entered                                 
         BNH   RLREP92             No                                           
         CLC   QSTART+4(2),SPACES  Was it in the form YYMM, without DD          
         BNE   RLREP92             No, okay as is                               
         MVC   QSTART+5(2),=C'01'  Fix date                                     
         MVC   ACQSTART,QSTART                                                  
                                                                                
RLREP92  CLC   QEND(4),SPACES      Date entered                                 
         BNH   RLREP98             No                                           
         CLC   QEND+4(2),SPACES    Was it in the form YYMM, without DD          
         BNE   RLREP98             No, okay as is                               
         GOTOR DATCON,DMCB,(X'30',QEND),(0,QEND),(1,0)                          
         MVC   ACQEND,QEND                                                      
                                                                                
RLREP98  MVC   P,SPACES                                                         
         XIT1                                                                   
         DROP  R6                                                               
**********************************************************************          
*  Call Secret to check Limlist settings                                        
*  Set security record in 1st byte of HALF (QuickReports/Accent/Scribe)         
*  Set security action in 2nd byte of HALF                                      
*  Input - BYTE contains the type of action                                     
**********************************************************************          
         SPACE 1                                                                
RPTSEC   NTR1  BASE=*,LABEL=RQST                                                
*                                                                               
         MVI   HALF,29             Default to security record 29 for QR         
         TM    DDLNKIND,DDLNKQKR   Quick reports                                
         BO    RPTS10                                                           
         MVI   HALF,30             security record 30 for Accent                
         TM    DDLNKIND,DDLNKON    Accent?                                      
         BO    RPTS10                                                           
         MVI   HALF,31             security record 31 for reg Scribe            
RPTS10   MVI   HALF+1,10           Default to security action 10 for            
         CLI   BYTE,01             Manpower filtering on 1R                     
         BE    RPTS20                                                           
         MVI   HALF+1,11           security action 11 for Manpower              
         CLI   BYTE,02             filtering on client                          
         BE    RPTS20                                                           
         MVI   HALF+1,08           security action 08 for Production            
         CLI   BYTE,03             filtering on client                          
         BE    RPTS20                                                           
         MVI   HALF+1,09           must be Prod filtering on media              
RPTS20   LA    R2,HALF                                                          
         USING MASTD,R1                                                         
         L     R1,ADMASTC                                                       
         L     RE,MCASECRT                                                      
         TM    DDLNKIND,DDLNKON          Accent/QuickReports                    
         BZ    RPTS30                                                           
         DROP  R1                                                               
         USING ACMD,RF                                                          
         USING LP_D,R1                                                          
         L     RF,AMONACC                                                       
         L     R1,ACMALP_D               Need a different Secret block          
         L     RE,LP_ASECD                                                      
         USING SECD,RE                   Set to Scribe prog for QR and          
         MVI   SECOPRG,X'0C'             Accent                                 
RPTS30   GOTO1 SECRET,DMCB,('SECPRACT',(RE)),(0(R2),1(R2))                      
         BNE   RPTSNO                                                           
*                                                                               
RPTSOK   SR    RA,RA                                                            
RPTSNO   LTR   RA,RA                                                            
RPTSX    XIT1                                                                   
         DROP  R1,RF                                                            
                                                                                
AELM1ST  DS    0A                                                               
AELMSTY  DS    A                   A(STYEL)                                     
AELMRPF  DS    A                   A(RPFEL)                                     
AELMRCP  DS    A                   A(RCPEL)                                     
AELMLEN  EQU   *-AELM1ST                                                        
                                                                                
         LTORG                                                                  
                                                                                
STYLDGT  DS    0H                                                               
         DC    C'SA',AL2(AC#RSRCV)                                              
STYLDGTQ EQU   *-STYLDGT                                                        
         DC    C'SB',AL2(AC#RSRCV)                                              
         DC    C'SC',AL2(AC#RS540)                                              
         DC    C'SE',AL2(AC#RSEXP)                                              
         DC    C'SF',AL2(AC#RSPAY)                                              
*&&UK*&& DC    C'SG',AL2(AC#RSEXP)                                              
         DC    C'SI',AL2(AC#RSINC)                                              
         DC    C'SJ',AL2(AC#RS497)                                              
         DC    C'SK',AL2(AC#RSINC)                                              
*&&US*&& DC    C'SL',AL2(AC#RSEXP)                                              
*&&US*&& DC    C'SP',AL2(AC#RSPAY)                                              
         DC    C'SQ',AL2(AC#RSPAY)                                              
         DC    C'SR',AL2(AC#RSRCV)                                              
*&&US*&& DC    C'SS',AL2(AC#RSPAY)                                              
         DC    C'ST',AL2(AC#RSPAY)                                              
*&&US*&& DC    C'SU',AL2(AC#RSPAY)                                              
         DC    C'SV',AL2(AC#RSPAY)                                              
*&&US*&& DC    C'SW',AL2(AC#RSPAY)                                              
         DC    C'SX',AL2(AC#RSPAY)                                              
*&&US*&& DC    C'SY',AL2(AC#RSPAY)                                              
         DC    C'SZ',AL2(AC#MED)                                                
STYLDGT# EQU   (*-STYLDGT)/4                                                    
*                                                                               
STYCVRT  DS    0H                                                               
         DC    AL2(AC#RS497),C'V'  Production                                   
STYCVLQ  EQU   *-STYCVRT                                                        
         DC    AL2(AC#RS498),C'1'  Person                                       
         DC    AL2(AC#RS544),C'2'  P&&L                                         
         DC    AL2(AC#RSRCV),C'R'  Receivable                                   
         DC    AL2(AC#RSINC),C'I'  Income                                       
         DC    AL2(AC#RSPAY),C'P'  Payable                                      
         DC    AL2(AC#RSEXP),C'X'  Expense                                      
         DC    AL2(AC#RS540),C'B'  Cash                                         
         DC    AL2(AC#GLG),C'G'    General Ledger                               
         DC    AL2(AC#MED),C'Z'    Media                                        
STYCVRT# EQU   (*-STYCVRT)/3                                                    
*                                                                               
*                                                                               
         TITLE 'Routine to print option/recap request detail page'              
         USING ACWORKD,RC                                                       
         USING ACRLD,RA                                                         
         USING ACQD,R3                                                          
RLPRTOPT NTR1  BASE=*,LABEL=*                                                   
         MVC   P,SPACES                                                         
         CLI   QOPT1,C' '                                                       
         BNH   PRTOPT10                                                         
*&&UK                                                                           
         CLI   ACQOPT1,BDEDL       BDE type transmission                        
         BE    *+8                                                              
         CLI   ACQOPT1,USSDL       USS type transmission                        
         BE    *+8                                                              
*&&                                                                             
         CLI   ACQOPT1,EDIDL       EDIHUB type transmission                     
         BE    *+8                                                              
         CLI   ACQOPT1,FTPDL       FTP type transmission                        
         BE    *+8                                                              
         CLI   ACQOPT1,DSNDL       DSN type transmission                        
         BNE   *+8                                                              
         NI    PIXOPT1,TURNOFF-PIXGO                                            
         MVCDD P+24(20),AC#DL                                                   
         MVC   P+45(1),QOPT1                                                    
         GOTO1 PRINT,DMCB,P,=C'BL02'                                            
         MVC   P,SPACES                                                         
*                                                                               
PRTOPT10 TM    DDLNKIND,DDLNKON+DDLNKTST                                        
         BZ    PRTOPT18                                                         
         CLI   QOPT2,C' '                                                       
         BNE   *+8                                                              
         MVI   QOPT2,C'R'          Default                                      
         L     RE,=A(SCRTYTAB)     Reporting type                               
PRTOPT12 CLI   0(RE),EOT                                                        
         JNE   *+6                                                              
         DC    H'00'                                                            
         CLC   QOPT2,0(RE)                                                      
         JE    PRTOPT14                                                         
         AHI   RE,15                                                            
         J     PRTOPT12                                                         
                                                                                
PRTOPT14 MVCDD P+24(20),AC#SCRTY                                                
         MVC   P+45(14),1(RE)                                                   
         GOTOR ADDICTAT,DMCB,C'SL  ',P+24,0                                     
         GOTOR PRINT,DMCB,P,=C'BL02'                                            
         MVC   P,SPACES                                                         
                                                                                
PRTOPT16 CLI   QOPT3,OPT3SCMA                                                   
         JNE   PRTOPT18                                                         
         MVC   P+24(11),=C'Schema Only'                                         
         GOTOR PRINT,DMCB,P,=C'BL02'                                            
         MVC   P,SPACES                                                         
                                                                                
PRTOPT18 CLI   QOPT8,C' '                                                       
         BNH   PRTOPT20                                                         
         TM    BLDACT,ROWS+COLS                                                 
         BNZ   PRTOPT20                                                         
         MVCDD P+24(20),AC#FMTDR                                                
         MVC   P+45(1),QOPT8                                                    
         GOTO1 PRINT,DMCB,P,=C'BL02'                                            
         MVC   P,SPACES                                                         
*                                                                               
PRTOPT20 CLI   QOPT7,C' '                                                       
         BNH   PRTOPT25                                                         
         MVCDD P+24(20),AC#ESTAT   Estimate status                              
         MVC   P+45(1),QOPT7                                                    
         GOTO1 PRINT,DMCB,P,=C'BL02'                                            
         MVC   P,SPACES                                                         
*                                                                               
PRTOPT25 CLI   QOPT3,C'A'                                                       
         BNE   PRTOPT30                                                         
         MVC   P+24(15),=C'Analysis Report'                                     
         GOTO1 PRINT,DMCB,P,=C'BL02'                                            
         MVC   P,SPACES                                                         
*                                                                               
PRTOPT30 CLI   QOPT10,C' '                                                      
         BNH   PRTOPTX                                                          
         MVC   P+24(12),=C'TEST VERSION'                                        
         MVI   P+45,C'"'                                                        
         MVC   P+46(1),QOPT10                                                   
         MVI   P+47,C'"'                                                        
         GOTO1 PRINT,DMCB,P,=C'BL02'                                            
         MVC   P,SPACES                                                         
*                                                                               
PRTOPTX  XIT1                                                                   
                                                                                
         DROP  R3                                                               
         SPACE 1                                                                
         LTORG                                                                  
                                                                                
FCREADSW TM    POSTLVL,POSTDET     POST DETIAL LEVEL                            
         JZ    FCREAD20                                                         
         MVI   FCRDTRNS,YES        RESET TO READ TRANSACTIONS                   
         CLI   QPROG,MANPOWER                                                   
         JNE   FCREAD10                                                         
         MVI   FCRDTIME,YES        MUST TURN ON BOTH FOR MIXED FILE             
         J     FCREAD20                                                         
                                                                                
FCREAD10 CLI   QPROG,GENERAL       GL                                           
         JNE   FCREAD20                                                         
         TM    FCIND,FCNEWGL       On new General Ledger                        
         JZ    FCREAD20                                                         
         MVI   FCRDTRNS,NO         Yes, so only read buckets                    
         BR    RE                                                               
                                                                                
FCREAD20 TM    POSTLVL,POSTHST                                                  
         BZR   RE                                                               
         MVI   FCRDHIST,YES        READ SUBACCT/HISTORY DATA                    
         BR    RE                                                               
                                                                                
                                                                                
SCRTYTAB DC    CL15'1Manpower'                                                  
         DC    CL15'2Profit && Loss'                                            
         DC    CL15'BCash'                                                      
         DC    CL15'IIncome'                                                    
         DC    CL15'GGeneral Ledger'                                            
         DC    CL15'PPayable'                                                   
         DC    CL15'RReceivable'                                                
         DC    CL15'VProduction'                                                
         DC    CL15'XExpense'                                                   
         DC    CL15'ZMedia'                                                     
         DC    AL1(EOT)                                                         
         TITLE 'Process ledger first'                                           
***********************************************************************         
* Ledger first routine                                                          
***********************************************************************         
         USING ACWORKD,RC                                                       
         USING ACRLD,RA                                                         
         USING FMTRECD,R5                                                       
LDGFIRST NTR1  BASE=*,LABEL=LDG1ST                                              
         MVI   FCRDACC,YES         PROCESSING FOR THIS LEDGER                   
*&&UK                                                                           
         USING MASTD,R6                                                         
         L     R6,ADMASTC                                                       
         CLC   =C'DDS',PIDCODE                                                  
         BNE   LDGFST04                                                         
         CLI   MCFACPAK,C'F'       LCSC                                         
         BE    LDGFST15            YES - OK                                     
         CLI   MCFACPAK,C'T'       LTST                                         
         BE    LDGFST15                                                         
         CLI   MCFACPAK,C'N'       FACNEW                                       
         BE    LDGFST15                                                         
         CLI   MCFACPAK,C'S'       LTTS                                         
         BE    LDGFST15                                                         
         DROP  R6                                                               
*&&                                                                             
LDGFST04 L     R2,ADLEDGER         LEDGER RECORD                                
         AH    R2,DATADISP         POINT TO FIRST ELEMENT                       
         SR    RF,RF                                                            
LDGFST10 CLI   0(R2),EOR           END OF RECORD                                
         BE    LDGFST15            COULDN'T FIND SECUIRTY SO SKIP IT            
         CLI   0(R2),RSTELQ        X'30' STATUS                                 
         BE    LDGFST12                                                         
         IC    RF,1(,R2)           NEXT ELEMENT                                 
         AR    R2,RF                                                            
         B     LDGFST10                                                         
*                                                                               
         USING RSTELD,R2                                                        
LDGFST12 CLC   PERAUTH#+1(1),RSTSECY+1                                          
         BNL   LDGFST15            SECURITY OK                                  
         MVI   FCRDACC,NO          STOP PROCESSING FOR THIS LEDGER              
         MVI   ERROR#,11           LEDGER SECURITY PROBLEM                      
         B     LDGXIT                                                           
         DROP  R2                                                               
*                                                                               
         USING ACMD,R2                                                          
         USING JBLOCKD,R3                                                       
LDGFST15 L     R2,AMONACC                                                       
         L     R3,ACMAJOBB         A(JOBBER Block)                              
         OI    JBSELFUN,JBGET1R    Process jobs down to 1R                      
         DROP  R3                                                               
*                                                                               
         MVI   ACMLTYP,ACMATBS     MAKE ALL LEDGERS BALANCE SHEET TYPE          
         CLI   FCWCNAME,YES                                                     
         BNE   LDGFST20                                                         
         L     R3,ACMWCNMA         WORK CODE NAMES                              
         ST    R3,WCLBASE                                                       
         SHI   R3,2                                                             
         MVC   0(2,R3),ACMWCNMN    NUMBER OF ENTRIES                            
         MVC   WCSBASE,ACMACBK                                                  
*                                                                               
LDGFST20 TM    RCFLAG1,RCFBCURT                                                 
         BZ    LDGFST50                                                         
         MVC   AFCURY,ACMACURT     FOREIGN CURRENCY TABLE                       
         TM    FCIND,FCISET        DID WE PROCESS ALREADY  ?                    
         BO    LDGFST50            YES                                          
         DROP  R2                                                               
*                                                                               
         USING COLD,R3                                                          
LDGFST25 L     R3,FMTCOL           MOVE IN CURRENCY INFO BY COLUMN              
         SR    R0,R0                                                            
         IC    R0,FMT#COLS                                                      
LDGFST30 MVC   CURFCCDE,RCCURR     SET TO EDIT AS DEFAULT                       
         TM    COLOPT,COLFCFLT     PRE-DEFINED CURRENCY TYPE?                   
         BZ    LDGFST35            YES SO SET COLUMN                            
         TM    COLOPT,COLFCAMT     SET THIS TYPE?                               
         BZ    LDGFST40            EDIT AS DEFAULT WITH FC FILTER               
         MVC   CURFCCDE,COLFCCDE   YES                                          
         B     LDGFST40                                                         
*                                                                               
LDGFST35 TM    COLOPT,COLFCAMT     IS IT FOREIGN CURRENCY COLUMN?               
         BO    LDGFST45            YES SO DON'T PRE-SET                         
         MVC   COLFCCDE,RCCURR     SET TO DEFAULT                               
*                                                                               
LDGFST40 GOTO1 GETFCUR                                                          
         MVC   COLCURED,CURFCCDE+4 SET CURED INDICATORS                         
         MVC   COLCSYSM,CURFCCDE+5 SET CURRENCY SYMBOL                          
         TM    COLOPT,COLFCAMT     OVERRIDE DECIMALS?                           
         BZ    LDGFST45            NO, CONTROLED BY PROFILE                     
         MVC   COLDCMLS,CURFCCDE+3                                              
         MVI   COLROUND,0                                                       
LDGFST45 AHI   R3,COLLNQ                                                        
         BCT   R0,LDGFST30                                                      
*                                                                               
         OI    FCIND,FCISET        SET COLUMNS FOR FOREIGN CURRENCY             
         CLC   FMTNUM,FORMAT#+1                                                 
         BE    LDGFST50                                                         
         AHI   R5,FMTLNQ           NEXT FORMAT CODE                             
         B     LDGFST25                                                         
*                                                                               
LDGFST50 TM    FCIND,FCNEWGL       New GL                                       
         BZ    LDGFST60                                                         
         GOTOR STOREREC,0          Initialize account store area                
                                                                                
         USING LDGELD,R2                                                        
LDGFST60 MVI   ACREVSG,NO          Same as ANALCLI                              
         CLI   QPROG,GENERAL                                                    
         JE    LDGXIT                                                           
         MVI   ANALCLI,C'Z'        Default  (1R)                                
         CLI   QPROG,MANPOWER                                                   
         JE    LDGXIT                                                           
         MVI   COSTPST,NO          Same location as ANALCLI                     
         ICM   R2,15,ADLDGEL       X'14' ELEMENT                                
         BZ    LDGXIT                                                           
         TM    LDGSTAT,LDGSCOST    Make cost postings (13)?                     
         BZ    *+8                 No                                           
         MVI   COSTPST,YES         Yes                                          
                                                                                
LDGXIT   XIT1                                                                   
         DROP  R2,R3,R5                                                         
         TITLE 'Process request first initialization'                           
***********************************************************************         
* Request first routine                                                         
***********************************************************************         
REQFIRST NTR1  BASE=*,LABEL=REQ1ST                                              
         CLI   QPROG,PRODUCTION                                                 
         BNE   REQF01                                                           
         MVI   FCPRORAT,C'B'       Convert PTAELDS                              
                                                                                
         L     RE,BILLTAB          Billing data table                           
         LA    RF,3                                                             
         MHI   RF,MAXBRANQ         Divide up this table                         
         AR    RE,RF                                                            
         ST    RE,ACUREST          % of Estimate data table                     
*                                                                               
REQF01   EQU   *                   Create unique # per request                  
*                                                                               
         TIME  BIN                 R0 = Seconds xxxx.xx                         
*                                  R1 = 0CYYDDDF                                
         XC    DUB,DUB                                                          
         ST    R1,DUB+4                                                         
         NI    DUB+4,X'00'         Turn off Century                             
         UNPK  UNIQUE#(5),DUB                                                   
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  UNIQUE#+5(7),DUB                                                 
*                                                                               
         TIME  DEC                  R0 = HHMMSSth                               
*                                   R1 = miju0000                               
*                                                                               
         XC    DUB,DUB                                                          
         LR    R1,R0                R0 = HHMMSSth   &  R1 = HHMMSSth            
         SLL   R0,8                 Remove old HH      R0 = MMSSth00            
         SRL   R0,12                Remove h00         R0 = 000MMSSt            
         SRL   R1,20                Isolate HH portion R1 = 00000HHS            
         ST    R1,DUB+4                                                         
         OI    DUB+7,X'0F'                                                      
         AP    DUB,=P'6'            Add 6 hours to adjust startup time          
         L     R1,DUB+4             R1 = 00000HHF                               
         SRL   R1,4                 R1 = 000000HH                               
         SLL   R1,20                Set new hours      R1 = 0HH00000            
         OR    R0,R1                New adjusted time  R0 = 0HHMMSSt            
         ST    R0,DUB+4                                                         
         OI    DUB+7,X'0F'                                                      
         UNPK  WORK(6),DUB                                                      
         MVC   REQHH,WORK                                                       
         MVI   REQCLLN1,C':'                                                    
         MVC   REQMM,WORK+2                                                     
         MVI   REQCLLN2,C':'                                                    
         MVC   REQSS,WORK+4                                                     
*                                                                               
*&&UK*&& OI    RCFLAG1,RCFBCURT    Build foreign currency table MONACC          
         MVC   CURSJ,=C'SJ'                                                     
         MVI   FCRDACC,YES         Reset to read accounts                       
         MVI   FCRDTRNS,NO         Reset to not read transactions               
         MVI   FCRDTIME,NO         Reset to not read TMS records                
         MVI   FCRDOFA,NO          Reset not to read off/acc records            
         ZAP   #OFACNTS,PKZERO                                                  
         CLI   QPROG,PRODUCTION    Prod Scribe ?                                
         BNE   REQF02              No                                           
         MVI   FCGETOPT,FCGETOWC   Read workcode getop                          
         MVI   FCRDWORK,YES        Pass workcode mode                           
         MVI   FCWCNAME,YES        Build table of workcode names                
         MVI   FCRNTIME,NO         Turn off TMS record read                     
         MVI   CURTIME,C'B'        B time                                       
*                                                                               
REQF02   MVI   FCIND,0             Foreign currency off                         
         MVI   DATEFLT,0           Clear date filter settings                   
         MVI   DATEFLT2,0                                                       
         MVI   PARSEALL,NO         Parse only data nessesary                    
         MVI   RCREQREP,YES        Print Request Details                        
         MVI   ERROR#,0            Set to no errors                             
         MVI   COUNT2,0            Debug counter                                
         MVI   CUROPT,0            Client/Prod/Job/Est level flag               
         MVI   DTEIDX#,0           TMS calendar index variable                  
*                                                                               
PRV      USING RECXD,PRVXSRT                                                    
         MVI   PRV.RECTYPE,RECNORM Set to normal type record                    
         DROP  PRV                                                              
*                                                                               
*        MVI   SPLITIND,0          Don't split records for mult elems           
         MVI   BUDSW,0             Set to no budgets                            
         ZAP   TRNSTOT,PKZERO      Initialize trans. totals to zero             
         ZAP   TRNSCRD,PKZERO                                                   
         ZAP   TRNSDEB,PKZERO                                                   
         ZAP   TRNSAMT,PKZERO      Initialize trans. amount to zero             
         ZAP   TRNSAGE,PKZERO      Initialize trans. age amount to zero         
*&&UK*&& ZAP   TRNSPLB,PKZERO      Initialize trans. PLBal to zero              
         MVI   TRNSSTAT,0          Set status to zero                           
         MVC   BUDACCKY,SPACES     Iintialize budget save key                   
         MVC   CURSUBAC,SPACES     No current sub-account                       
         MVC   PREVACT,SPACES      No previous account                          
         MVC   PREVKEY,SPACES      Clear previous key                           
         MVI   RCSUBPRG,0          Not set up for ACRL01 phase                  
         XC    ALTNSTR,ALTNSTR     Set alternate start date                     
         MVC   ALTNEND,=X'FFFFFF'  Set alternate end   date                     
         XC    RQMMOSST,RQMMOSST   Set Media MOS start date                     
         MVC   RQMMOSEN,=X'FFFFFF' Set Media MOS end date                       
         XC    RQS_EST,RQS_EST     Set estimate  start date                     
         MVC   RQE_EST,=X'FFFFFF'  Set estimate  end   date                     
         XC    STMTDTE,STMTDTE     Statement date, Cash Scribe                  
         XC    INTRSTR,INTRSTR     Internal start date                          
         MVC   INTREND,ALTNEND     Internal end   date                          
         MVI   DATEFLT,0           Type of date filter set to be none           
         MVI   ACCSTAT,0           Account status      set to be none           
         NI    EXPSTAT,EXPNCOST    Turnoff all other bits                       
         MVCDD WORK(2),AC#CR       For editing negative numbers as CR           
         CLI   QPROG,PAYABLES      Payables Scribe                              
         BE    *+8                                                              
         CLI   QPROG,INCOME        Income Scribe                                
         BNE   *+10                                                             
         MVCDD WORK(2),AC#DR       Make negative number as DR instead           
         GOTO1 ADDICTAT,DMCB,C'SU  ',WORK,0                                     
         MVC   NEGCHAR,WORK        Save off translated value                    
         MVI   LISTREC#,0          Number of +/- List records used              
*                                                                               
         USING ACMD,R2                                                          
         L     R2,AMONACC                                                       
         MVC   APRORATA,ACMAPRAT   A(PRORATA)                                   
         MVC   PRORATA1,ACMAPROB   A(PRORATA BLOCK 1)                           
         MVC   PRORATA2,ACMAPRO2   A(PRORATA BLOCK 2)                           
         MVC   AGOXBLK,ACMAGOX     A(EXTENDED GOBLOCK)                          
         DROP  R2                                                               
*                                                                               
REQF10   MVC   PAGE,=H'01'                                                      
         MVI   LINE,INITLN         FORCE MAX LINES TO FORCE FIRST PAGE          
*                                                                               
         XC    FORMAT#,FORMAT#                                                  
         MVI   PRINTFG,0           DEFAULT TO NOT PRINT LINE                    
         NI    THRSW,TURNOFF-(THRREC+THRDET+THRLST)                             
                                                                                
         GOTO1 FRMTBLD             GET FORMAT WILL ADD IT TO THE LIST           
         BE    REQF13              EXIT OKAY, CONTINUE                          
         CLI   ERROR#,REQDONE      REQUEST COMPLETED ?                          
         BNE   REQXIT              NO, EXIT THIS MODE                           
         GOTO1 ADSORTER,DMCB,=C'END'                                            
*                                                                               
         USING BOXD,R6                                                          
         USING BIGPRNTD,R4                                                      
         L     R6,ADBXAREA         RESET TO PRINT REQUEST PAGE                  
         L     R4,VBIGPRNT                                                      
         MVI   BOXFONT,0           RESET FONT                                   
         MVC   BOXROWS(BOXROWSL),SPACES           Clear boxes                   
         MVC   BOXCOLS(STDPGWD),XSPACES                                         
         MVI   RCREQREP,YES                                                     
         B     REQXIT              EXIT THIS REQUEST                            
         DROP  R4,R6                                                            
                                                                                
REQF13   DS    0H                                                               
*                                                                               
         CLI   QOPT1,YES           Regular download ?                           
         BNE   REQF14              No - OK                                      
         TM    DWNOPT4,DWNNRQPG    No request pages?                            
         BZ    REQF14                                                           
         MVI   RCREQREP,NO         Yes, don't print Req Page                    
*                                                                               
REQF14   BRAS  RE,FCREADSW                                                      
                                                                                
         USING RUNXTRAD,R3                                                      
         L     R3,VEXTRAS                                                       
         MVC   CKLIST,VLISTREC                                                  
         GOTO1 SETBUFF                                                          
                                                                                
*Not ready for limlist code yet                                                 
*        TM    DDLNKIND,DDLNKQKR   Quick reports                                
*        BZ    REQF15                                                           
*        USING ACRL2D,R3                                                        
*        L     R3,AACRL2D                                                       
*        GOTO1 ABLDLML,DMCB,TSARABUF                                            
*        DROP  R3                                                               
                                                                                
REQF15   CLI   QPROG,MANPOWER                                                   
         BNE   REQF42                                                           
         TM    THRSW,THRON         Process total hours by column ?              
         BZ    REQF42              No                                           
         TM    THRSW,THRDET        If on, dicision was made already             
         BO    REQF42                                                           
         OI    THRSW,THRDET        Yes, read tms/trans detail (default)         
                                                                                
         TM    THRSW,THRCFP        Column filter present ?                      
         BO    REQF24                                                           
         TM    THRSW,THRGFP+THR2BIG    Global or key 2 big for TSAR             
         BZ    REQF25                  Neither on, process in ACCLAST ?         
*&&US*&& NI    THRSW,TURNOFF-THRDET                                             
*&&US*&& OI    THRSW,THRREC            Use total records                        
         B     REQF42                  Either case process details              
                                                                                
REQF24   TM    THRSW,THRGFP+THR2BIG    Global or key 2 big for TSAR ?           
         BNZ   REQF42                  Yes, process details                     
                                                                                
REQF25   TM    THRSW,THRP$A        Adjusted payrolls                            
         BZ    REQF28              No. OK to process in ACCLAST                 
         TM    GHISIND,GHISDATE+GHISTYPE+GHISMOA+GHISCDNM                       
         BNZ   REQF42              Process via details or total rec             
                                                                                
REQF28   OI    THRSW,THRLST            Calculate at ACCLAST                     
         NI    THRSW,TURNOFF-THRDET                                             
*                                                                               
REQF42   MVC   ANALCLI,SPACES                                                   
*&&US                                                                           
         TM    BUILD,BUILDBRD      BUILD TABLE?                                 
         BZ    REQF45                                                           
         OC    NBRNREC,NBRNREC     NUMBER OF BRAND RECORDS                      
         BNZ   REQF45              ALREADY BUILT                                
         GOTO1 ABRNBLD                                                          
*&&                                                                             
REQF45   CLI   QPROG,MANPOWER                                                   
         BE    *+8                                                              
         CLI   QPROG,PRODUCTION                                                 
         BNE   REQF50                                                           
*                                                                               
         USING FMRATED,R3                                                       
         L     R3,ARATEBLK                                                      
         MVC   RDATAMGR,DATAMGR                                                 
*&&UK*&& MVC   RTOBACCO,=V(TOBACCO)                                             
*&&UK*&& MVC   RCASHVAL,CASHVAL                                                 
*&&UK*&& MVC   RCOMFACS,ADCOMFAC                                                
         MVC   RAT1CMPY,RCCOMPFL   Company code                                 
         MVC   RATCTRY,RCCTRY      Country code                                 
         GOTO1 GETLDGR,DMCB,=C'1R'                                              
         ICM   R2,15,0(R1)                                                      
         BZ    REQF46                                                           
*                                                                               
         USING LDGD,R2                                                          
         MVC   RAT1RL1,LDGLVQ1                                                  
         MVC   RAT1RL2,LDGLVQ2                                                  
         MVC   RAT1RL3,LDGLVQ3                                                  
         MVC   RAT1RL4,LDGLVQ4                                                  
         DROP  R2                                                               
*                                                                               
         MVC   RATSJL1,SJCLILEN                                                 
         MVC   RATSJL2,SJPRDLEN                                                 
         MVC   RATSJL3,SJJOBLEN                                                 
*&&UK                                                                           
         USING CPYELD,R2                                                        
         L     R2,ADCMPEL                                                       
         MVC   RATCSTAT,CPYSTAT7   Company status 7                             
         MVC   RATCUR1,CURCREQ     Input currency                               
         MVC   RATCUR2,CPYCURR     Primary                                      
         MVC   RATCUR3,CPYCURRS    Secondary                                    
         DROP  R2                                                               
*&&                                                                             
         USING CPRCNDRD,R3                                                      
         USING COSTWKD,R4                                                       
REQF46   CLI   QPROG,MANPOWER                                                   
         BNE   REQF50                                                           
         L     R3,ACNDRBLK         CALENDAR DATA                                
         L     R4,ACOSTBLK         PERFACT  DATA                                
         MVI   CSTMODE,CSTINT      INITIALIZE BLOCK                             
         MVI   CSTMTHD,C'1'        DEFAULT                                      
         CLI   QMTHD,C'A'                                                       
         BE    *+10                                                             
         MVC   CSTMTHD,QMTHD                                                    
         MVC   CSTIO,AIO3                                                       
         MVC   CSTDMGR,DATAMGR                                                  
         MVC   CSTXSRT,XSORT                                                    
         MVC   CSTPERV,PERVERT                                                  
         MVC   CSTDATC,DATCON                                                   
*&&US*&& MVC   CSTPRTBL,PRNTBL                                                  
*&&US*&& TM    UPSI,X'20'          Dump read records                            
*&&US*&& BZ    *+8                                                              
*&&US*&& OI    CSTDEBUG,CSTDUMP                                                 
*                                                                               
         TM    RECREAD1,RECSTDH+RECEDTH                                         
         BZ    REQF50                                                           
         GOTOR DATCON,DMCB,(3,STARTYR),(0,WORK)                                 
         GOTO1 ADDAY,DMCB,(C'Y',WORK),WORK+10,F'-4'                             
         GOTO1 DATCON,DMCB,(0,WORK+10),(1,CSTRQSTR)                             
         TM    REQIND,REQCMTH      Requested calendar months ?                  
         BO    REQF47              Yes                                          
         MVC   CSTRQEND,RELEND2    No                                           
         OC    RTRNSTR,RTRNSTR     If transaction start use this                
         BZ    REQF48              No                                           
         MVC   CSTRQSTR,RTRNSTR    Yes, transaction start                       
         B     REQF48                                                           
*                                                                               
REQF47   MVC   CSTRQEND(2),RQCALEND                                             
         MVI   CSTRQEND+2,0                                                     
         GOTO1 =A(GETPED),DMCB,CSTRQEND,(R3)                                    
         L     R2,4(,R1)           Get end date base on calendar                
         MVC   CSTRQEND,0(R2)                                                   
*                                                                               
         OC    RQCALSTR,RQCALSTR   Any requested start date ?                   
         BZ    REQF48              No                                           
         MVC   CSTRQSTR(2),RQCALSTR                                             
         MVI   CSTRQSTR+2,0                                                     
         GOTO1 =A(GETPED),DMCB,CSTRQSTR,(R3)                                    
         L     R2,0(,R1)           Get start period date                        
         MVC   CSTRQSTR,0(R2)      Get start date based on calendar             
*                                                                               
REQF48   MVC   CSTCPY,RCCOMPFL     COMPANY CODE                                 
         GOTO1 =V(PERFACT),DMCB,(R4)                                            
         DROP  R3,R4                                                            
*                                                                               
         USING JOBAGEID,R1                                                      
         USING ACMD,R2                                                          
REQF50   CLI   QPROG,PRODUCTION                                                 
         BNE   REQF90                                                           
         CLI   AGECOL#,0           NUMBER OF COLUMNS TO PROCESS                 
         BE    REQF90              NONE, SO SKIP                                
         L     R2,AMONACC                                                       
         L     R1,JBAGEBLK                                                      
         MVI   JAIMODE,JAIINIT     INITIALIZE JOB AGEING BLOCK                  
         MVC   JAICMFAC,ADCOMFAC                                                
         MVC   JAIVXTRA,VEXTRAS                                                 
         MVC   JAIBSRCH,BINSRCH                                                 
         MVC   JAIDTCON,DATCON                                                  
         MVC   JAIADDAY,ADDAY                                                   
         MVC   JAIMOAED,RMOAEND    MOA END DATE YYMM PACKED                     
         OC    RMOAEND,RMOAEND                                                  
         BNZ   *+10                                                             
         MVC   JAIMOAED,=X'FFFFFF'                                              
         MVC   JAIACTED,ACMAEND    ACTIVITY END DATE COMPRESSED                 
         MVC   JAISEDAT,JBAGECOL   COLUMN DATE PAIR TO AGE                      
         MVC   JAISEDT#,AGECOL#    NUMBER OF AGEING PAIRS                       
         MVC   JAIMTHD,AGEMTHD     AGEING METHOD                                
         CLI   QOPT5,C' '          AGEING METHOD OVERIDE ?                      
         BE    *+10                NO,  SKIP                                    
         MVC   JAIMTHD,QOPT5       OVERIDE FORMAT VALUE                         
         MVI   JAITIMCH,JAITIMBO   BOTH OOP AND TIME                            
         MVI   JAIAGETX,JAIAGEBT   BOTH BY MOA AND TRANSACTION DATE             
         MVC   JAIPRINT,PRINT      ADDR OF PRINT  ROUTINE                       
         MVC   JAIPRNTB,PRNTBL     ADDR OF PRNTBL ROUTINE                       
         TM    UPSI,UPSITRNS       DUMP TRANSACTIONS SWITCH ON                  
         BZ    *+8                 NO,  SKIP                                    
         MVI   JAIDEBUG,YES        YES, TURN ON DEBUG FOR JOBAGE RTN            
         GOTO1 JOBAGE                                                           
         DROP  R1,R2                                                            
*                                                                               
REQF90   CLI   QOPT6,C'M'                                                       
         BNE   REQXIT                                                           
         XC    MOAS,MOAS                                                        
         MVC   MOAE,=X'FFFFFF'                                                  
         CLC   QUESTOR(4),SPACES                                                
         BE    REQF92                                                           
         MVC   TEMPDATE+4(2),=C'01'                                             
         MVC   TEMPDATE(4),QUESTOR                                              
         GOTO1 DATCON,DMCB,(0,TEMPDATE),(1,MOAS)                                
*                                                                               
REQF92   CLC   QUESTOR+4(4),SPACES                                              
         BE    REQXIT                                                           
         MVC   TEMPDATE(4),QUESTOR+4                                            
         GOTO1 DATCON,DMCB,(0,TEMPDATE),(1,MOAE)                                
*                                                                               
REQXIT   XIT1                                                                   
*                                                                               
MOAS     DS    PL2                                                              
         DS    PL1                                                              
MOAE     DS    PL2                                                              
         DS    PL1                                                              
         SPACE 1                                                                
         LTORG                                                                  
         TITLE 'Get start and end period dates based on MOA'                    
**********************************************************************          
*  Pass YYMM and get start/end period dates into P1/P2               *          
**********************************************************************          
         USING CPRCNDRD,R3                                                      
         USING FMTRECD,R5                                                       
GETPED   NTR1  BASE=*,LABEL=GETPED                                              
         LR    R4,R1               SAVE PARAMETER ADDRESS                       
         L     R2,0(,R1)           ADDRESS OF YYMM                              
         L     R3,4(,R1)                                                        
         XC    CPRYMD,CPRYMD                                                    
         MVC   CPRYM,0(R2)         MOVE IN PACKED YEAR                          
         MVC   CPROF,SPACES                                                     
                                                                                
GETPED10 GOTO1 AGETCNDR,DMCB,ACNDRBLK,21                                        
         BE    GETPED20                                                         
         TM    CPRERR,CPRNF        Record not found                             
         BZ    GETPED20                                                         
         DC    H'00'                                                            
                                                                                
         USING CDRD,R6                                                          
GETPED20 L     R6,ACNDRWRK                                                      
                                                                                
         SR    R0,R0                                                            
         IC    R0,CPR#PRD          NUMBER OF PERIODS IN CALENDAR                
GETPED25 CLC   CDRMOA,0(R2)        MATCH ON MONTH                               
         BE    GETPED30                                                         
         BL    *+6                                                              
         DC    H'00'                                                            
         LA    R6,CDRLNQ(,R6)                                                   
         BCT   R0,GETPED25                                                      
*                                                                               
GETPED30 LA    RE,CDRSDATE         POINT TO START PERIOD DATE                   
         ST    RE,0(,R4)           SAVE ADDRESS OF START                        
*                                                                               
GETPED32 CLC   CDRMOA+CDRLNQ,0(R2)       LOOK AHEAD TO NEXT MONTH               
         BNE   GETPED40                  NEW MONTH SO STOP                      
         LA    R6,CDRLNQ(,R6)            STILL SAME MONTH                       
         B     GETPED32                                                         
*                                                                               
GETPED40 LA    RE,CDREDATE         POINT TO END PERIOD DATE                     
         ST    RE,4(,R4)           SAVE END DATE FOR MOA                        
         XIT1                                                                   
         DROP  R3,R6                                                            
         SPACE 3                                                                
         LTORG                                                                  
         EJECT                                                                  
         TITLE 'Get buckets based on requested MOA'                             
***********************************************************************         
* Get buckets based on requested MOA for account balance                        
***********************************************************************         
         USING ACWORKD,RC                                                       
         USING ACRLD,RA                                                         
         USING CACRECD,R2                                                       
GETBBAL  NTR1  BASE=*,LABEL=*                                                   
         LA    R2,IOKEY                                                         
         MVC   IOKEY,SPACES                                                     
         MVC   CACKCULA,CURACC     MOVE IN ACCOUNT                              
         MVC   CACKCCPY,CURACC     MOVE IN CONTRA COMPANY CODE                  
*                                                                               
GETBB10  L     R1,=AL4(IOHIGH+IOACFIL+IOAREA2)                                  
         GOTO1 AIO                                                              
         L     R2,AIO2                                                          
         CLC   CURACC,CACKCULA                                                  
         BNE   GETBB90             FINISHED                                     
*                                                                               
         USING BUKELD,R3                                                        
         LR    R3,R2                                                            
         AH    R3,DATADISP                                                      
GETBB20  CLI   0(R3),0             EOR                                          
         BE    GETBB40             FINISHED HERE GET NEXT RECORD                
         CLI   0(R3),BUKELQ        X'45' BUCKET ELEMENTS                        
         BE    GETBB30                                                          
GETBB24  SR    R1,R1                                                            
         IC    R1,BUKLN                                                         
         AR    R3,R1                                                            
         B     GETBB20                                                          
*                                                                               
GETBB30  CLC   RMOASTR,BUKMOS                                                   
         BH    GETBB24                                                          
         CLC   RMOAEND,BUKMOS                                                   
         BL    GETBB24                                                          
         AP    ACCBAL,BUKDR                                                     
         SP    ACCBAL,BUKCR                                                     
         B     GETBB24             GET NEXT BUCKET                              
*                                                                               
REC      USING CACRECD,R3                                                       
*                                                                               
GETBB40  LR    R3,R2                                                            
         LA    R2,IOKEY                REPLACE KEY WITH REC DATA TO             
         MVC   CACKWRK,REC.CACKWRK     GET NEXT BUCKET RECORD                   
         MVC   CACKCULC,REC.CACKCULC                                            
         MVI   CACKSPAC,X'FF'                                                   
         B     GETBB10                                                          
         DROP  R2                                                               
         DROP  REC                                                              
*                                                                               
GETBB90  XIT1                                                                   
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
         USING TRNELD,R2                                                        
***********************************************************************         
*  SET CURBILTY FOR WORKCODE 99                                       *         
***********************************************************************         
         SPACE 1                                                                
         USING TRNELD,R2                                                        
GETBLTYP NTR1  BASE=*,LABEL=*                                                   
         STM   R1,R4,SVR1                                                       
         L     R2,ADTRANS                                                       
*&&US                                                                           
         MVC   CURBILTY,TRNBTYPE                                                
         CLI   CURBILTY,0                                                       
         BNE   *+8                                                              
         MVI   CURBILTY,TRNBTALL   DEFAULT TO ALLOCATED                         
         OC    TRNBLTYP,SPACES     MAKE UPPER CASE                              
         CLC   TRNBLTYP,=CL15'AUTO BILL'                                        
         BNE   *+8                                                              
         MVI   CURBILTY,C'A'                                                    
         CLC   TRNBLTYP,=CL15'GRP BILLING'                                      
         BNE   *+8                                                              
         MVI   CURBILTY,C'G'                                                    
         CLI   TRNBTYPE,TRNBTPER   % OF ESTIMATE ?                              
         BNE   GETBLT00                                                         
         TM    RECREAD2,REC99WC    Pre-read billing, 99 trans                   
         BZ    GETBLT55            No then don't bother with this code          
         BRAS  RE,CHKB2                                                         
         B     GETBLT55                                                         
GETBLT00 CLI   TRNBTYPE,TRNBTSPE   SPECIAL                                      
         BE    GETBLT55                                                         
         CLI   TRNBTYPE,TRNBTMAN   MANUAL                                       
         BE    GETBLT55                                                         
         B     GETBLT95                                                         
*&&                                                                             
*&&UK                                                                           
         L     R3,=A(BILTYTAB)                                                  
         MVI   CURBILTY,TRNBTALL   DEFAULT TO ALLOCATED                         
         CLI   TRNLN,TRNLN1Q+L'TRNBLTYP-1                                       
         BNH   GETBLT95            I DON'T KNOW BUT IT MAY WORK                 
         OC    TRNBLTYP,SPACES     MAKE UPPER CASE                              
*                                                                               
GETBLT10 CLI   0(R3),EOT                                                        
         BE    GETBLT20                                                         
         CLC   TRNBLTYP,1(R3)      COMPARE TO TABLE ENTRY                       
         BE    GETBLT50                                                         
         LA    R3,16(,R3)                                                       
         B     GETBLT10                                                         
*                                                                               
GETBLT20 LA    R1,L'TRNBLTYP                                                    
         LA    R3,TRNBLTYP                                                      
*                                                                               
GETBLT22 CLI   0(R3),C'P'          FOR PC ESTIMATE                              
         BE    GETBLT30                                                         
         CLI   0(R3),C'%'          FOR %  ESTIMATE                              
         BE    GETBLT32                                                         
         LA    R3,1(,R3)                                                        
         BCT   R1,GETBLT22                                                      
         B     GETBLT95                                                         
*                                                                               
GETBLT30 CLM   R1,1,=AL1(11)       R1 = LENGTH OF ROOM LEFT                     
         BNL   GETBLT31            AL1(11) IS LENGTH OF STRING                  
         BCTR  R1,0                                                             
         EX    R1,GETBLT31                                                      
         B     *+10                                                             
*                                                                               
GETBLT31 CLC   =C'PC ESTIMATE',0(R3)      US                                    
         BE    GETBLT35                                                         
         B     GETBLT95                                                         
*                                                                               
GETBLT32 CLM   R1,1,=AL1(10)       R1 = LENGTH OF ROOM LEFT                     
         BNL   GETBLT33            AL1(10) IS LENGTH OF STRING                  
         BCTR  R1,0                                                             
         EX    R1,GETBLT33                                                      
         LA    R1,1(,R1)           ADD ONE BACK                                 
         B     *+10                                                             
*                                                                               
GETBLT33 CLC   =C'% ESTIMATE',0(R3)       UK                                    
         BE    GETBLT35                                                         
         CLM   R1,1,=AL1(6)        R1 = LENGTH OF ROOM LEFT                     
         BNL   GETBLT34            AL1(6) IS LENGTH OF STRING                   
         BCTR  R1,0                                                             
         EX    R1,GETBLT34                                                      
         B     *+10                                                             
*                                                                               
GETBLT34 CLC   =C'%  KVA',0(R3)           GERMANY                               
         BNE   GETBLT95                                                         
*                                                                               
GETBLT35 MVI   CURBILTY,TRNBTPER   ESTIMATE                                     
         B     GETBLT55                                                         
*                                                                               
GETBLT50 MVC   CURBILTY,0(R3)      SAVE OFF BILL TYPE CODE                      
         CLI   CURBILTY,TRNBTSPE   SPECIAL AMOUNT?                              
         BE    GETBLT55                                                         
         CLI   CURBILTY,TRNBTMAN   MANUAL BILLING?                              
         BNE   GETBLT95                                                         
*&&                                                                             
GETBLT55 SR    R1,R1                                                            
         OI    CURIND,CURBILCR     BILLED CREDIT ONLY                           
*&&US                                                                           
         USING GDAEL,R2                                                         
         L     R3,ABILLBLK                                                      
GETBLT60 CLI   0(R2),0             EOT                                          
         BE    GETBLT65            NONE FOUND                                   
         CLI   0(R2),GDAELQ        X'E5'                                        
         BNE   GETBLT62                                                         
         CLI   GDATYPE,GDATBILL    BILLING INFO DATES                           
         BNE   GETBLT62                                                         
         ST    R2,0(,R3)           SAVE OFF ADDRESS                             
         LA    R3,4(,R3)                                                        
GETBLT62 IC    R1,GDALN                                                         
         AR    R2,R1                                                            
         B     GETBLT60                                                         
*                                                                               
GETBLT65 LR    R1,R3                                                            
         LR    R4,R3               SAVE LAST ENTRY                              
         SHI   R4,4                                                             
         L     R3,ABILLBLK                                                      
         SR    R1,R3                                                            
         SRL   R1,2                DIVIDE BY FOUR = NUMBER OF ENTRIES           
         LTR   R1,R1                                                            
         BZ    GETBLT95                                                         
         TM    DATEFLT,DATEBIL     ALTERNATE BILLING DATE                       
         BO    GETBLT70            NO, SO IS IT UNBILLED OR BILLED              
         L     R2,0(,R4)           POINT TO LAST ELEMENT X'E5'                  
         CLI   GDALN,GDALNQ                                                     
         BE    GETBLT90            ALREADY BILLED SO DON'T INCLUDE              
         OC    GDADATE2,GDADATE2   IS IT UNBILLED?                              
         BZ    GETBLT90            NO                                           
         B     GETBLT95            YES                                          
*                                                                               
GETBLT70 L     R2,0(,R4)           POINT TO ELEMENT X'E5'                       
         CLC   GDADATE,ALTNEND     BILLED   DATE                                
         BNH   GETBLT75                                                         
         SHI   R4,4                BOUNCE BACKWARDS                             
         SHI   R1,1                NUMBER OF ENTRIES - 1                        
         BP    GETBLT70            ANY MORE?                                    
         B     GETBLT95            CONSIDER AS NO X'E5',SO BILLED               
*                                                                               
GETBLT75 CLI   GDALN,GDALNQ                                                     
         BE    GETBLT90            ALREADY BILLED SO DON'T INCLUDE              
         OC    GDADATE2,GDADATE2   ANY INPUT?                                   
         BZ    GETBLT90                                                         
         CLC   GDADATE2,ALTNEND    UNBILLED DATE                                
         BNH   GETBLT95            YES                                          
         DROP  R2                                                               
*&&                                                                             
*&&UK                                                                           
         USING TRSELD,R2                                                        
         ICM   R2,15,AELEM60       X'60' STATUS ELEMENT                         
         BZ    GETBLT95            NOT BILLED VIA ANOTHER TYPE                  
         ST    RE,SVRE                                                          
         GOTO1 DATCON,DMCB,(2,TRSUDAT),(1,WORK)                                 
         L     RE,SVRE                                                          
         CLC   WORK,ALTNEND                                                     
         BH    GETBLT95                                                         
         DROP  R2                                                               
*&&                                                                             
GETBLT90 DS    0H                                                               
*&&US*&& TM    FMTROPT6,RPFSPBIL   Treat all always as Billed CRs               
*&&US*&& BO    GETBLT95                                                         
         NI    CURIND,TURNOFF-CURBILCR    NO LONGER A BILLED CREDIT             
GETBLT95 LM    R1,R4,SVR1                                                       
         XIT1                                                                   
         LTORG                                                                  
         EJECT                                                                  
*&&US                                                                           
***********************************************************************         
* Match up 99 transactions with the correct bill in BILLTAB.  Then    *         
* add any missing workcodes indicated in the BILLEST table for that             
* particular bill                                                               
***********************************************************************         
         SPACE 1                                                                
         USING BILLD,RE                                                         
         USING TRNELD,RF                                                        
CHKB2    NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     RE,BILLTAB                                                       
CHKB200  L     RF,ADTRANS                                                       
         J     CHKB230                                                          
CHKB210  CLI   0(RF),0                                                          
         JE    CHKB270                                                          
         CLI   0(RF),BSCELQ        X'E3' - Billing source                       
         JE    CHKB240                                                          
         CLI   0(RF),CPJELQ                                                     
         JE    CHKB250                                                          
CHKB220  ZIC   R0,1(RF)                                                         
         AR    RF,R0                                                            
         J     CHKB210                                                          
*                                                                               
CHKB230  CLC   BILLRUN,TRN2DAY    Billing run date                              
         JNE   CHKB2NX                                                          
         CLC   BILLTY,TRNBTYPE    Billing type                                  
         JNE   CHKB2NX                                                          
         CLC   BILDTE,TRNDATE     Billing date                                  
         JNE   CHKB2NX                                                          
         CLC   BILL#,TRNREF       Billing ref #                                 
         JNE   CHKB2NX                                                          
         J     CHKB220                                                          
*                                                                               
         USING BSCELD,RF                                                        
CHKB240  CLC   BILLROF,BSCBOFF     Billing source office                        
         JNE   CHKB2NX                                                          
         CLC   BILLRBS,BSCBSRC     Billing source code                          
         JNE   CHKB2NX                                                          
         J     CHKB220                                                          
*                                                                               
         USING CPJELD,RF                                                        
CHKB250  NI    BYTE,X'FF'-X'80'                                                 
         CLI   CPJTYPE,CPJTREC     Type is RCV ?                                
         JNE   CHKB220             No, get next element                         
         CLC   BILLRCV,CPJRULA     Compare on billing RCV account               
         JNE   CHKB2NX             NOT THE SAME-GET NEXT BILL TAB NTRY          
         OI    BYTE,X'80'          No need to compare to trnkulc                
         J     CHKB220                                                          
*                                                                               
         USING TRNRECD,RF                                                       
CHKB270  L     RF,ADTRANS                                                       
         SH    RF,DATADISP                                                      
         CLC   BILLSBR,TRNKSBR    Transaction seq #                             
         JNE   CHKB2NX                                                          
         TM    BYTE,X'80'         Did we find a match on RCV acct?              
         JO    CHKB280                                                          
         CLC   BILLRCV,TRNKULC                                                  
         JNE   CHKB2NX                                                          
*                                                                               
         USING BESTD,R4                                                         
CHKB280  L     R4,BILLEST                                                       
         LHI   RF,BESTMAXQ                                                      
CHKB290  OC    BESTWC,BESTWC                                                    
         BZ    CHKB2X             done                                          
         TM    BESTFLAG,BESTWCF   Was this workcode found on this bill?         
         JZ    CHKB300                                                          
CHKB292  LA    R4,BESTLNQ(R4)                                                   
         JCT   RF,CHKB290                                                       
*                                                                               
ELM      USING BESELD,WORK                                                      
CHKB300  XC    WORK,WORK                                                        
         MVI   ELM.BESEL,BESELQ        X'B2'                                    
         LA    R1,BESLN2Q                                                       
         STC   R1,ELM.BESLN            Length                                   
         MVC   ELM.BESWORK,BESTWC                                               
         ZAP   ELM.BESPEBC,=P'0'                                                
         ZAP   ELM.BESPEBCG,=P'0'                                               
         L     RF,ADTRANS                                                       
         SHI   RF,ACCORFST                                                      
         GOTO1 ADDEL,DMCB,(C'P',=CL8'ACCVBIG'),(RF),WORK,=C'ADD=END'            
         CLI   12(R1),0                                                         
         BE    CHKB292                Now check for next w/c                    
         DC    H'00'                                                            
*                                                                               
CHKB2NX  LA    RE,BILLLNQ(RE)     GET NEXT BILL IN TABLE                        
         J     CHKB200                                                          
*                                                                               
CHKB2X   XIT1                                                                   
         DROP  R4,RE,RF                                                         
*&&                                                                             
***********************************************************************         
*  Adjust Jobber column amounts because of duplication in 1R cols     *         
*  W/C level rows include lower level W/C + 1R amounts, so if both    *         
*  are reported, values would be doubled                              *         
***********************************************************************         
         USING ACMD,R2                                                          
         USING JBCOLD,R3                                                        
NXT      USING JBCOLD,R4                                                        
         USING JBLOCKD,R8                                                       
         USING FMTRECD,R5                                                       
ADJJOBR  NTR1  BASE=*,LABEL=*                                                   
         L     R2,AMONACC          A(ACMASTC)                                   
         L     R8,ACMAJOBB         A(Jobber BLOCK)                              
         L     R3,ACMACOL          A(Jobber column table)                       
*                                                                               
         TM    ACCSTAT,ACCMCSE     Test job is BrandOcean                       
         BO    ADJJOB40            different table                              
*                                                                               
         LA    RF,JBCOLV1R         Point to totals in job total line            
         ST    RF,FULL                                                          
         ST    RF,THREE                                                         
         LH    R6,JBNROWS          Number of rows in table                      
*                                                                               
ADJJOB10 CHI   R6,1                More then one row ?                          
         BNH   ADJJOBX             No                                           
         CLI   JBCOLTYP,JBCOLTWC   Workcode type                                
         BNE   ADJJOB20            Try next one                                 
         OC    JBCOL1R,JBCOL1R     Any person code ?                            
         BNZ   ADJJOB20            Yes, so try next                             
*        BNZ   ADJJOBX             Must have processed all                      
         LR    R4,R3               Current entry processing                     
         LR    R0,R6               R0 = Number of entries to check              
*                                                                               
ADJJOB14 SHI   R0,1                                                             
         BZ    ADJJOB20            No more to process                           
         AH    R4,JBLCOL           Bump to next entry to compare                
         CLI   JBCOLTYP,JBCOLTWC   Workcode type                                
         BNE   ADJJOB14            Try next one                                 
         CLC   JBCOLWC,NXT.JBCOLWC Find ones with same workcode                 
         BNE   ADJJOB14            Try the next one                             
         CLC   NXT.JBCOL1R,SPACES  Make sure they have a 1R                     
         BNL   ADJJOB17                                                         
*&&US*&& DC    H'00'               Should only be WC with 1R data               
*&&UK                                                                           
         LA    R2,JBCOLV1R         Point to amounts to adjust                   
         LA    R7,NXT.JBCOLV1R     Point to amounts to reduce by                
         ZIC   RF,JBNCOLS          Number of accums to adjust                   
         MVI   NXT.JBCOLTYP,99     Mark not to process again                    
*                                                                               
ADJJOB16 AP    0(L'JBCOLV1R,R2),0(L'JBCOLV1R,R7)                                
         LA    R2,L'JBCOLV1R(,R2)                                               
         LA    R7,L'JBCOLV1R(,R7)                                               
         BCT   RF,ADJJOB16                                                      
         B     ADJJOB14            Try the next one                             
*&&                                                                             
ADJJOB17 LA    R2,JBCOLV1R         Point to amounts to adjust                   
         LA    R7,NXT.JBCOLV1R     Point to amounts to reduce by                
         ZIC   RF,JBNCOLS          Number of accums to adjust                   
*                                                                               
ADJJOB18 SP    0(L'JBCOLV1R,R2),0(L'JBCOLV1R,R7)                                
         L     R1,FULL             Subtract from job totals line too            
         SP    0(L'JBCOLV1R,R1),0(L'JBCOLV1R,R7)                                
         LA    R2,L'JBCOLV1R(,R2)                                               
         LA    R7,L'JBCOLV1R(,R7)                                               
         LA    R1,L'JBCOLV1R(,R1)  Bump up to next row in job totals            
         ST    R1,FULL             line too                                     
         BCT   RF,ADJJOB18                                                      
         MVC   FULL,THREE          Restore address of job total line            
         B     ADJJOB14            Try the next one                             
*                                                                               
ADJJOB20 AH    R3,JBLCOL           Bump to next entry                           
         BCT   R6,ADJJOB10                                                      
         B     ADJJOBX                                                          
         DROP  R3,NXT                                                           
*                                  Version for BrandOcean jobs                  
         USING MJETABD,R3                                                       
NXT      USING MJETABD,R4                                                       
*                                                                               
ADJJOB40 LA    RF,MJETVAL          Point to totals in job total line            
         ST    RF,FULL                                                          
         ST    RF,THREE                                                         
         LH    R6,JBNROWS          Number of rows in table                      
*                                                                               
ADJJOB42 CHI   R6,1                More then one row ?                          
         BNH   ADJJOBX             No                                           
         CLI   MJETTYP,MJETTWQ     Workcode type                                
         BNE   ADJJOB52            Try next one                                 
         OC    MJET1RA,MJET1RA     Any person code ?                            
         BNZ   ADJJOB52            Yes, so try next                             
*        BNZ   ADJJOBX             Must have processed all                      
         LR    R4,R3               Current entry processing                     
         LR    R0,R6               R0 = Number of entries to check              
*                                                                               
ADJJOB44 SHI   R0,1                                                             
         BZ    ADJJOB52            No more to process                           
         AH    R4,JBLCOL           Bump to next entry to compare                
         CLI   MJETTYP,MJETTWQ     Workcode type                                
         BNE   ADJJOB44            Try next one                                 
         CLC   MJETWCD,NXT.MJETWCD Find ones with same workcode                 
         BNE   ADJJOB44            Try the next one                             
         CLC   NXT.MJET1RA,SPACES  Make sure they have a 1R                     
         BNL   ADJJOB48                                                         
*&&US*&& DC    H'00'               Should only be WC with 1R data               
*&&UK                                                                           
         LA    R2,MJETVAL          Point to amounts to adjust                   
         LA    R7,NXT.MJETVAL      Point to amounts to reduce by                
         ZIC   RF,JBNCOLS          Number of accums to adjust                   
         MVI   NXT.MJETTYP,99      Mark not to process again                    
*                                                                               
ADJJOB46 AP    0(L'MJETVAL,R2),0(L'MJETVAL,R7) ?Merging lines w/out 1R          
         LA    R2,L'MJETVAL(,R2)                                                
         LA    R7,L'MJETVAL(,R7)                                                
         BCT   RF,ADJJOB46                                                      
         B     ADJJOB44            Try the next one                             
*&&                                                                             
ADJJOB48 LA    R2,MJETVAL          Point to amounts to adjust                   
         LA    R7,NXT.MJETVAL      Point to amounts to reduce by                
         ZIC   RF,JBNCOLS          Number of accums to adjust                   
*                                                                               
ADJJOB50 SP    0(L'MJETVAL,R2),0(L'MJETVAL,R7)                                  
         L     R1,FULL             Subtract from job totals line too            
         SP    0(L'MJETVAL,R1),0(L'MJETVAL,R7)                                  
         LA    R2,L'MJETVAL(,R2)                                                
         LA    R7,L'MJETVAL(,R7)                                                
         LA    R1,L'MJETVAL(,R1)   Bump up to next row in job totals            
         ST    R1,FULL             line too                                     
         BCT   RF,ADJJOB50                                                      
         MVC   FULL,THREE          Restore address of job total line            
         B     ADJJOB44            Try the next one                             
*                                                                               
ADJJOB52 AH    R3,JBLCOL           Bump to next entry                           
         BCT   R6,ADJJOB42                                                      
*                                                                               
ADJJOBX  XIT1                                                                   
         DROP  NXT                                                              
         DROP  R2,R3,R5,R8                                                      
         SPACE 2                                                                
         LTORG                                                                  
         TITLE 'Read bills, WC=99 transactions'                                 
*&&US                                                                           
*=====================================================================*         
*  Read Production billing transaction and save data                  *         
*=====================================================================*         
         USING TRNRECD,R2                                                       
         USING BILLD,R6                                                         
BILLDATA NTR1  BASE=*,LABEL=*                                                   
         SR    R3,R3                                                            
         SR    R8,R8                                                            
         MVI   #PCT_WC,0           Number of % est workcodes                    
         ZAP   PREVBAMT,PKZERO                                                  
         ZAP   PREVBCOM,PKZERO                                                  
         ZAP   PREVBCD,PKZERO                                                   
         ZAP   DOUBLE,PKZERO       Running total of all bills                   
         MVI   BYTE1,0                                                          
         MVC   ATEMPWC,ACUREST                                                  
         L     RE,ACUREST                                                       
         AHI   RE,K                Add one K                                    
         ST    RE,AESTLOC          Save off start of table                      
         LA    R2,IOKEY                                                         
         L     R6,BILLTAB                                                       
         MVC   TRNKEY,SPACES                                                    
         MVC   TRNKCULA,CURACC                                                  
         MVC   TRNKWORK,=C'99'                                                  
         MVC   TRNKCCPY,CURACC                                                  
         L     R1,=AL4(IOBUD+IOHIGH+IOACFIL)                                    
         GOTO1 AIO                                                              
*                                                                               
BILLD100 L     R2,ABUDIO                                                        
         CLC   TRNKCULA,CURACC                                                  
         BNE   BILLD500                                                         
         CLC   TRNKWORK,=C'99'                                                  
         BNE   BILLD500                                                         
         XC    BILLD(BILLLNQ),BILLD       Clear entry                           
         MVC   BILLRCV,TRNKULC            Contra                                
         MVC   BILLSBR,TRNKSBR            Sub reference                         
*                                                                               
         USING TRNELD,R2                                                        
         AH    R2,DATADISP                                                      
         CLI   0(R2),TRNELQ               X'44', Must be transaction            
         BNE   BILLD200                                                         
         CLI   TRNTYPE,1           Bad data if type 1                           
         BE    BILLD200            Get next                                     
*                                                                               
         MVC   BILLRUN,TRN2DAY     Billing run date                             
         MVC   BILL#,TRNREF        Bill number                                  
         MVC   BILDTE,TRNDATE      Billed date                                  
         MVC   BILUDTE,TRNUNBIL    Unbillled date                               
         MVC   BILTYD,TRNBLTYP     Bill type description                        
         MVC   BILLTY,TRNBTYPE     Transaction bill type                        
         CLC   =C'TOTAL BILL',TRNBLTYP                                          
         BNE   *+12                                                             
         MVI   BILLTY,TRNBTTOT                                                  
         OI    BYTE1,TOTBILL                                                    
*&&US                                                                           
         CLC   =C'ONE-LINE ',TRNBLTYP                                           
         BNE   *+12                                                             
         MVI   BILLTY,TRNBTONE                                                  
         OI    BYTE1,TOTBILL                                                    
*&&                                                                             
         CLC   =C'PROGRESSIVE',TRNBLTYP                                         
         BNE   *+8                                                              
         MVI   BILLTY,TRNBTPRO                                                  
         LA    R1,5                                                             
         LA    RE,TRNBLTYP                                                      
BXX      CLC   =C'PC ESTIMA',0(RE)                                              
         BNE   *+8                                                              
         MVI   BILLTY,TRNBTPER                                                  
         LA    RE,1(,RE)                                                        
         BCT   R1,BXX                                                           
         LA    RE,TRNBLTYP                                                      
         CLC   =C'100PC EST',0(RE)                                              
         BNE   *+12                                                             
         OI    BILLIND,BILL100     100% estimate bill                           
         OI    BYTE1,BILL1PC                                                    
*                                                                               
         ZAP   BILLAMT,TRNAMNT     Billed amount                                
         AP    DOUBLE,BILLAMT      Keep runnint total                           
         ZAP   BILLRTOT,DOUBLE                                                  
         ZAP   BILLCOM,TRNBLCOM    Billed commission                            
*&&US*&& ZAP   BILLCD,TRNBLCD      Cash discount                                
         ZAP   BILLPAMT,PKZERO                                                  
         ZAP   BILLPCOM,PKZERO                                                  
         ZAP   BILLPCD,PKZERO                                                   
         CLI   BILLTY,TRNBTPER     % of estimate                                
         BNE   BILLD118                                                         
         MVC   BILLEST,AESTLOC     No, so set start of table                    
         LA    RF,BESTMAXQ*BESTLNQ Size of table                                
         A     RF,AESTLOC          Current start of table + length              
         ST    RF,AESTLOC          New start location                           
         L     RE,BILLEST          Clear area                                   
         LA    RF,BESTMAXQ*BESTLNQ                                              
         SR    R0,R0                                                            
         SR    R1,R1                                                            
         MVCL  RE,R0                                                            
*                                                                               
BILLD118 CLI   BILLTY,TRNBTTOT     Total billing                                
*&&US                                                                           
         BE    *+12                                                             
         CLI   BILLTY,TRNBTONE     one-line billing                             
*&&                                                                             
         BNE   BILLD120                                                         
         AHI   R8,1                Count number of total bills                  
*                                                                               
         USING CPJELD,R2                                                        
BILLD120 CLI   0(R2),EOR           End of record                                
         BE    BILLD180                                                         
         CLI   0(R2),CPJELQ        X'4F' - RCV account Retail billing           
         BNE   BILLD130                                                         
         CLI   CPJTYPE,CPJTREC     Type is RCV ?                                
         BNE   BILLD160            No, get next element                         
         MVC   BILLRCV,CPJRULA     Move in receivables account                  
         B     BILLD160            Next element                                 
*                                                                               
         USING PTAELD,R2                                                        
BILLD130 CLI   0(R2),PTAELQ        X'77' - Billing element                      
         BNE   BILLD140                                                         
         TM    PTASTAT1,PTASREVS   Reversed TOTAL BILL                          
         BZ    BILLD160            No, next element                             
         OI    BILLIND,BILLREV                                                  
         B     BILLD160            Next element                                 
*                                                                               
         USING BESELD,R2                                                        
         USING BESTD,RF                                                         
BILLD140 CLI   0(R2),BESELQ        X'B2' - Billing estimate data                
         BNE   BILLD150                                                         
         OC    BILLEST,BILLEST     Bad % of estimate type                       
         BNZ   BILLD142                                                         
         MVC   BILLEST,AESTLOC     No, so set start of table                    
         LA    RF,BESTMAXQ*BESTLNQ Size of table                                
         A     RF,AESTLOC          Current start of table + length              
         ST    RF,AESTLOC          New start location                           
         MVI   BILLTY,TRNBTPER     % of estimate                                
*                                                                               
BILLD142 SR    RF,RF                                                            
         IC    RF,BILL#WC          Number of workcode for % Est                 
         AHI   RF,1                Increment count                              
         STC   RF,BILL#WC                                                       
         CHI   RF,BESTMAXQ         Max allowed                                  
         BNH   *+6                                                              
         DC    H'00'               Need to increase size                        
*                                                                               
         USING TEMPWCD,RE                                                       
         L     RE,ATEMPWC          Use as temporary area                        
         SR    R4,R4                                                            
         ICM   R4,1,#PCT_WC                                                     
         BZ    BLD10               Just add workcode                            
BLD02    MVC   BYTE2,TEMPROW       Save row to bump up for next                 
         CLC   BESWORK,TEMPWC                                                   
         BNE   *+12                                                             
         OI    TEMPBYTE,TEMPWCF    this w/c found on this bill                  
         B     BLD20                                                            
         LA    RE,TEMPLNQ(,RE)     Next entry in table of wc                    
         BCT   R4,BLD02                                                         
*                                                                               
BLD10    MVI   TEMPROW,0           default to row 0                             
         L     R1,ATEMPWC                                                       
         CR    R1,RE               Is this the beginning of the table?          
         BE    BLD12               then keep row at 0                           
         ZIC   R1,BYTE2            else get last row and bump up 1              
         AHI   R1,1                                                             
         STC   R1,TEMPROW                                                       
BLD12    MVC   TEMPWC,BESWORK                                                   
         OI    TEMPBYTE,TEMPWCF    this w/c found on this bill                  
         IC    R4,#PCT_WC                                                       
         AHI   R4,1                                                             
         STC   R4,#PCT_WC                                                       
*                                                                               
BLD20    ZIC   R1,TEMPROW                                                       
         MHI   R1,BESTLNQ                                                       
         L     RF,BILLEST                                                       
         AR    RF,R1                                                            
*                                                                               
****************************                                                    
         MVC   BESTWC,BESWORK                                                   
         ZAP   BESTNET,BESPEBC                                                  
         ZAP   BESTGRS,BESPEBCG                                                 
         OI    BESTFLAG,BESTWCF    w/c found on this bill                       
         GOTOR FILLWCT,DMCB,BESTWC,BESTWCT                                      
         B     BILLD160            Next element                                 
         DROP  RF                                                               
*                                                                               
         USING BSCELD,R2                                                        
BILLD150 CLI   0(R2),BSCELQ        X'E3' - Billing source                       
         BNE   BILLD160            Next element                                 
         MVC   BILLROF,BSCBOFF     Billing source office                        
         MVC   BILLRBS,BSCBSRC     Billing source code                          
*                                                                               
BILLD160 SR    RF,RF                                                            
         IC    RF,1(,R2)                                                        
         AR    R2,RF                                                            
         B     BILLD120            Process next element                         
         DROP  R2                                                               
*                                                                               
BILLD180 DS    0H                                                               
BILLD184 LA    R6,BILLLNQ(,R6)                                                  
         AHI   R3,1                Count the number of bills                    
*                                                                               
BILLD200 L     R1,=AL4(IOBUD+IOSEQ+IOACFIL)                                     
         GOTO1 AIO                                                              
         B     BILLD100                                                         
*                                                                               
BILLD500 DS    0H                                                               
         STH   R3,#BILLS           Save number of bills                         
         BRAS  RE,CHKWC                                                         
BILLD502 STH   R8,#TOTBILS         Save number of total bills                   
         CHI   R3,1                Any bills ?                                  
         BL    BILLD900            Nothing to sort                              
         BE    BILLD520            No need to sort one transaction              
*&&UK*&& GOTO1 XSORT,DMCB,BILLTAB,(R3),BILLLNQ,2,BILLRUN-BILLD                  
*&&US*&& GOTO1 XSORT,DMCB,BILLTAB,(R3),BILLLNQ,3,BILLRUN-BILLD                  
*                                                                               
BILLD520 DS    0H                                                               
         L     R6,BILLTAB                                                       
*                                                                               
BILLD530 CLI   BILLTY,TRNBTTOT     Total billing                                
*&&US                                                                           
         BE    *+12                                                             
         CLI   BILLTY,TRNBTONE     One-line billing                             
*&&                                                                             
         BNE   BILLD540                                                         
         TM    BILLIND,BILLREV     Reversal                                     
         BZ    BILLD540                                                         
         LH    R8,#BILLS                                                        
         SR    R8,R3               R8 = number of bills processed               
         CHI   R8,1                                                             
         BNL   *+6                                                              
         DC    H'00'               Must have at least one bill before           
*                                                                               
PRV      USING BILLD,R9                                                         
         LR    R9,R6                                                            
         SHI   R9,BILLLNQ                                                       
BILLD532 CLI   PRV.BILLTY,TRNBTTOT        Total billing                         
*&&US                                                                           
         BE    *+12                                                             
         CLI   PRV.BILLTY,TRNBTONE        One-line billing                      
*&&                                                                             
         BNE   BILLD535                                                         
         ZAP   DUB,PRV.BILLAMT                                                  
         XI    DUB+L'DUB-1,X'01'          Reverse sign                          
         CP    BILLAMT,DUB                                                      
         BNE   BILLD535                                                         
         OI    PRV.BILLIND,BILLREV        Marked as reversed                    
         B     BILLD540                                                         
*                                                                               
BILLD535 SHI   R9,BILLLNQ                                                       
         BCT   R8,BILLD532                                                      
*                                                                               
         NI    BILLIND,TURNOFF-BILLREV    Something wrong with rev              
*                                                                               
BILLD540 AHI   R6,BILLLNQ          Next entry                                   
         BCT   R3,BILLD530         Next                                         
         DROP  PRV                                                              
*                                                                               
BILLD542 L     R6,BILLTAB                                                       
         LH    R3,#BILLS           Load number of bills                         
BILLD550 CLI   BILLTY,TRNBTTOT     Total billing                                
*&&US                                                                           
         BE    *+12                                                             
         CLI   BILLTY,TRNBTONE     One-line billing                             
*&&                                                                             
         BNE   BILLD555                                                         
         TM    BILLIND,BILLREV     Reversal                                     
         BO    BILLD560            Skip reversals                               
         ZAP   BILLPAMT,PREVBAMT   Save off prev billing                        
         ZAP   BILLPCOM,PREVBCOM                                                
         ZAP   BILLPCD,PREVBCD                                                  
         ZAP   PREVBAMT,PKZERO     Clear for next pass                          
         ZAP   PREVBCOM,PKZERO                                                  
         ZAP   PREVBCD,PKZERO                                                   
         B     BILLD560                                                         
*                                                                               
BILLD555 CLI   BILLTY,TRNBTMAN     Manual                                       
         BE    *+8                                                              
         CLI   BILLTY,TRNBTSPE     Special amount                               
         BE    *+8                                                              
         CLI   BILLTY,TRNBTPER     % of estimate                                
         BNE   BILLD560                                                         
         AP    PREVBAMT,BILLAMT                                                 
         AP    PREVBCOM,BILLCOM                                                 
         AP    PREVBCD,BILLCD                                                   
*                                                                               
BILLD560 AHI   R6,BILLLNQ          Next entry                                   
         BCT   R3,BILLD550         Next                                         
*                                                                               
         LH    R3,#BILLS                                                        
         LR    R6,R3                                                            
         BCTR  R6,0                                                             
         MHI   R6,BILLLNQ          Point to last bill entry                     
         A     R6,BILLTAB                                                       
         SR    R9,R9                                                            
*                                                                               
BILLD600 CLI   BILLTY,TRNBTPER     % of estimate type ?                         
         BNE   BILLD690                                                         
         TM    BILLIND,BILLREV     If bill is unbilled (or the reversal         
         BO    BILLD690            bill then skip it                            
         OC    BILUDTE,BILUDTE                                                  
         BNZ   BILLD690                                                         
*                                                                               
         CLC   BILL#WC,#PCT_WC                                                  
         BE    BILLD620            Has all the workcodes                        
         SR    RF,RF                                                            
         IC    RF,#PCT_WC          Number of entries                            
         USING TEMPWCD,RE                                                       
         L     RE,ATEMPWC          Workcode table                               
*                                                                               
         USING BESTD,R2                                                         
BILLD610 SR    R1,R1                                                            
         L     R2,BILLEST                                                       
         ICM   R1,1,BILL#WC        Number of workcodes                          
         BZ    BILLD615                                                         
*                                                                               
BILLD612 CLC   BESTWC,TEMPWC       Match on workcode                            
         BE    BILLD618            This one is ok                               
         AHI   R2,BESTLNQ          Next entry                                   
         BCT   R1,BILLD612         Check next till we run out                   
*                                  Ran out so add                               
BILLD615 MVC   BESTWC,TEMPWC         Add workcode to list                       
         ZAP   BESTGRS,PKZERO                                                   
         ZAP   BESTNET,PKZERO                                                   
         GOTOR FILLWCT,DMCB,BESTWC,BESTWCT                                      
         ZIC   R1,BILL#WC          Up the number of workcodes                   
         AHI   R1,1                                                             
         STC   R1,BILL#WC                                                       
         CHI   R1,BESTMAXQ                                                      
         BNH   *+6                                                              
         DC    H'00'               Need to increase table                       
*                                                                               
BILLD618 LA    RE,TEMPLNQ(RE)                                                   
         BCT   RF,BILLD610         Check next                                   
*                                                                               
BILLD620 LTR   R9,R9               Do we have on from before ?                  
         BZ    BILLD670            Get next                                     
         CP    BILLRTOT,PKZERO     If running total is zero                     
         BE    BILLD670            then nothing to adjust                       
*                                                                               
PRIOR    USING BILLD,R9            Prior bill                                   
PRV      USING BESTD,R4            Previous estimate                            
         SR    RF,RF                                                            
         IC    RF,PRIOR.BILL#WC                                                 
         LTR   RF,RF                                                            
         L     R4,PRIOR.BILLEST                                                 
*                                                                               
BILLD625 SR    RE,RE                                                            
         IC    RE,BILL#WC          Number of workcodes                          
         L     R2,BILLEST          Point to workcode values                     
*                                  Find workcode in current % est               
BILLD630 OC    PRV.BESTWC,PRV.BESTWC                                            
         BNZ   BILLD632                                                         
         AHI   R4,BESTLNQ          Next workcode to process                     
         BCT   RF,BILLD630         Process all workcodes                        
*                                                                               
BILLD632 OC    BESTWC,BESTWC       Match workcode                               
         BNZ   BILLD634                                                         
         AHI   R2,BESTLNQ                                                       
         BCT   RE,BILLD632                                                      
*                                                                               
BILLD634 CLC   PRV.BESTWC,BESTWC   Match workcode                               
         BE    BILLD640            Got it                                       
         AHI   R2,BESTLNQ                                                       
         BCT   RE,BILLD632                                                      
         DC    H'00'                                                            
*                                                                               
BILLD640 SP    PRV.BESTGRS,BESTGRS Adjust prior % est                           
         SP    PRV.BESTNET,BESTNET                                              
         AHI   R4,BESTLNQ          Next workcode to process                     
         BCT   RF,BILLD625         Process all workcodes                        
*                                                                               
BILLD670 LR    R9,R6               Save off prior % est. bill                   
*                                                                               
BILLD690 SHI   R6,BILLLNQ                                                       
         BCT   R3,BILLD600                                                      
         DROP  PRV                                                              
*                                                                               
         L     R6,BILLTAB                                                       
         LH    R3,#BILLS           Load number of bills                         
BILLD700 CLI   BILLTY,TRNBTPER     % of estimate type ?                         
         BNE   BILLD760                                                         
         TM    BILLIND,BILLREV     Reversal bill                                
         BZ    BILLD760                                                         
*                                                                               
UNB      USING BILLD,R9                                                         
         L     R9,BILLTAB                                                       
         LH    R1,#BILLS                                                        
BILLD710 CR    R6,R9               Don't compare the same one                   
         BE    BILLDNXT                                                         
         CLC   BILLRUN,UNB.BILUDTE   Billing run date to unbill dte             
         BNE   BILLDNXT                                                         
         CLC   BILTYD,UNB.BILTYD     Same % of est                              
         BNE   BILLDNXT                                                         
         CLI   UNB.BILLTY,TRNBTPER   % of estimate type ?                       
         BE    BILLD715                                                         
BILLDNXT AHI   R9,BILLLNQ          Next entry                                   
         BCT   R1,BILLD710         Next                                         
         B     BILLD760            No match for this bill                       
*                                                                               
PRV      USING BESTD,R4            Previous estimate                            
BILLD715 SR    RF,RF                                                            
         IC    RF,UNB.BILL#WC                                                   
         LTR   RF,RF                                                            
         BZ    BILLD760                                                         
         L     R4,UNB.BILLEST                                                   
*                                                                               
BILLD720 SR    RE,RE                                                            
         IC    RE,BILL#WC          Number of workcodes                          
         L     R2,BILLEST          Point to workcode values                     
         USING BESTD,R2                                                         
*                                  Find workcode in current % est               
BILLD730 OC    PRV.BESTWC,PRV.BESTWC                                            
         BZ    BILLD750                                                         
         CLC   PRV.BESTWC,BESTWC   Match workcode                               
         BE    BILLD740                                                         
         AHI   R2,BESTLNQ          Next entry                                   
         BCT   RE,BILLD730         Check next till we run out                   
         B     BILLD750                                                         
*                                                                               
BILLD740 ZAP   BESTGRS,PRV.BESTGRS                                              
         ZAP   BESTNET,PRV.BESTNET                                              
BILLD750 AHI   R4,BESTLNQ          Next workcode to process                     
         BCT   RF,BILLD720         Process all workcodes                        
*                                                                               
BILLD760 AHI   R6,BILLLNQ          Next entry                                   
         BCT   R3,BILLD700         Next                                         
         DROP  PRV,UNB                                                          
*                                                                               
BILLD900 XIT1                                                                   
         DROP  R6,RE                                                            
         DROP  PRIOR                                                            
***********************************************************************         
* Go through ATEMPWC and make sure all workcodes are in the billtab             
* R2 Billest (w/c table with amts)                                              
* R3 Billtab                                                                    
* R4 # of w/c's in Atempwc                                                      
* R5 Atempwc (table of all w/c involved in all bills)                           
* R6 # of bills in Billtab                                                      
***********************************************************************         
         USING BILLD,R3                                                         
         USING BESTD,R2                                                         
         USING TEMPWCD,R5                                                       
CHKWC    NTR1  BASE=*,LABEL=*                                                   
         L     R3,BILLTAB                                                       
         SR    R6,R6                                                            
         ICM   R6,3,#BILLS         Number of bills                              
CHKWC10  CLI   BILLTY,TRNBTTOT     Skip total bill                              
         BE    CHKWCNX2                                                         
*&&US                                                                           
         CLI   BILLTY,TRNBTONE     Skip One-line bill                           
         BE    CHKWCNX2                                                         
*&&                                                                             
         L     R5,ATEMPWC                                                       
         SR    R4,R4                                                            
         ICM   R4,1,#PCT_WC                                                     
         BZ    CHKWCX                                                           
CHKWC20  L     R2,BILLEST                                                       
         LTR   R2,R2               If no estimate data skip bill                
         BZ    CHKWCNX2                                                         
         ZIC   RF,TEMPROW                                                       
         MHI   RF,BESTLNQ                                                       
         AR    R2,RF                                                            
         CLC   BESTWC,TEMPWC       Found w/c for this bill?                     
         BNE   CHKWC30             No so go fill it in                          
CHKWCNX  LA    R5,TEMPLNQ(R5)      Bump to next atempwc entry                   
         BCT   R4,CHKWC20                                                       
CHKWCNX2 LA    R3,BILLLNQ(R3)      Bump to next billtab entry                   
         BCT   R6,CHKWC10                                                       
         B     CHKWCX                                                           
*                                                                               
CHKWC30  MVC   BESTWC,TEMPWC                                                    
         ZAP   BESTNET,=P'0'                                                    
         ZAP   BESTGRS,=P'0'                                                    
         ZAP   BESTOGR,=P'0'                                                    
         ZAP   BESTONT,=P'0'                                                    
         GOTOR FILLWCT,DMCB,BESTWC,BESTWCT                                      
         SR    RF,RF                                                            
         IC    RF,BILL#WC          Number of workcode for % Est                 
         AHI   RF,1                Increment count                              
         STC   RF,BILL#WC                                                       
         B     CHKWCNX                                                          
*                                                                               
CHKWCX   XIT1                                                                   
         DROP  R2,R3,R5                                                         
***********************************************************************         
* When adding an entry to BILLEST get the workcode type and store               
***********************************************************************         
         USING WCOELD,RF                                                        
FILLWCT  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     R2,0(R1)                                                         
         L     R3,4(R1)                                                         
         L     RF,WCSBASE                                                       
FWCT10   CLI   0(RF),0             END OF RECORD?                               
         JE    FILLWCTX                                                         
*                                                                               
         LA    RF,2(,RF)           BUMP PASE UNIT/LEDGER THAT IS STORED         
         CLI   0(RF),WCOELQ        X'12' WORKCODE ELEMENT                       
         JNE   *+10                                                             
         CLC   WCOCODE,0(R2)       CURRENT WC JUST PARSED FROM B2               
         JE    FWCT20                                                           
         ZIC   R1,WCOLN                                                         
         AR    RF,R1                                                            
         J     FWCT10                                                           
*                                                                               
FWCT20   MVC   0(1,R3),WCOTYPE                                                  
         CLI   0(R3),C' '                                                       
         JNE   FILLWCTX                                                         
         MVI   0(R3),C'O'         O is the default                              
*                                                                               
FILLWCTX XIT1                                                                   
         DROP  RF                                                               
*                                                                               
***********************************************************************         
* Clear the 'this w/c found for this bill' flag in the ATEMPWC                  
***********************************************************************         
         USING TEMPWCD,R3                                                       
CLRWC    NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     R3,ATEMPWC             Now turn off x'80' flag on all            
         SR    R4,R4                  w/c's to get ready for the next           
         ICM   R4,1,#PCT_WC           bill                                      
         BZ    CLRWCX                                                           
CLRWC10  NI    TEMPBYTE,TURNOFF-TEMPWCF                                         
         LA    R3,TEMPLNQ(R3)      Next entry in table of wc                    
         BCT   R4,CLRWC10                                                       
*                                                                               
CLRWCX   XIT1                                                                   
         DROP  R3                                                               
                                                                                
AESTLOC  DS    A                                                                
ATEMPWC  DS    A                   List of all workcodes used                   
PREVBAMT DS    PL6                                                              
PREVBCOM DS    PL6                                                              
PREVBCD  DS    PL6                                                              
#PCT_WC  DS    AL1                 Number of %EST workcodes                     
         SPACE 2                                                                
         LTORG                                                                  
         TITLE 'Read authorization record for request'                          
*                                                                               
         USING ACQD,R3                                                          
         USING AUTRECD,R4                                                       
AUTHSET  LA    R4,AUTHKREQ                                                      
         XC    AUTKEY,AUTKEY                                                    
         MVI   AUTKTYP,AUTKTYPQ    X'3F' Authorization type                     
         MVI   AUTKSUB,AUTKSUBQ    X'04' Authorization sub type                 
         MVC   AUTKCPY,RCCOMPFL                                                 
         MVI   AUTKUNT,C'S'                                                     
         MVI   AUTKLDG,C'J'                                                     
         CLI   ACQOFGRP,C' '                                                    
         JNH   *+10                                                             
         MVC   AUTKOGR,ACQOFGRP    Office Group                                 
         MVI   ACQOFGRP,C' '                                                    
*                                                                               
         CLC   ACQOFFFL,SPACES     Office                                       
         JNH   *+10                                                             
         MVC   AUTKOFC,ACQOFFFL                                                 
         MVC   ACQOFFFL,SPACES     Clear                                        
         MVC   QOFFICE,SPACES      Clear                                        
*                                                                               
         CLC   ACQACT,SPACES       Client ?                                     
         JNH   AUTHST10                                                         
         MVC   AUTKCLI,SPACES                                                   
         MVC   AUTKCLI(3),ACQACT                                                
*                                                                               
         CLC   ACQACT+3(9),SPACES  Product ?                                    
         JNH   AUTHST10                                                         
         MVC   AUTKPRO,SPACES                                                   
         MVC   AUTKPRO,ACQACT+3                                                 
*                                                                               
AUTHST10 MVC   ACQACT(12),SPACES   Clear out account                            
         MVC   QACCOUNT,SPACES                                                  
         CLI   ACQMEDGP,C' '       Media group ?                                
         JNH   *+10                                                             
         MVC   AUTKMGR,ACQMEDGP                                                 
         MVI   ACQMEDGP,C' '       Clear                                        
         MVI   QMGROUP,C' '        Clear                                        
*                                                                               
         CLI   ACQMEDFL,C' '       Media ?                                      
         JNH   *+10                                                             
         MVC   AUTKMED,ACQMEDFL                                                 
         MVI   ACQMEDFL,C' '       Clear                                        
         MVI   QMEDIA,C' '         Clear                                        
*                                                                               
         MVC   AUTKNUM,ACQAUTH#                                                 
         OI    REQIND,REQAUTH      Requested by authorization                   
         BR    RE                                                               
         DROP  R3,R4                                                            
***********************************************************************         
* IF FOUND BOTH A 100% OF EST BILL AND A TOTAL BILL THEN TURN OFF THE *         
* BIT THAT SAYS TO TREAT THE 100% OF EST AS THE TOTAL BILL            *         
***********************************************************************         
         USING BILLD,R3                                                         
BILLPC   NTR1  BASE=*,LABEL=*                                                   
                                                                                
         L     R3,BILLTAB                                                       
         SR    R1,R1                                                            
         ICM   R1,3,#BILLS         Number of bills                              
BILLPC10 TM    BILLIND,BILL100     100 % of est bill?                           
         BZ    *+8                                                              
         NI    BILLIND,X'FF'-BILL100                                            
         AHI   R3,BILLLNQ          Next entry                                   
         BCT   R1,BILLPC10         Next                                         
         XIT1                                                                   
         DROP  R3                                                               
         SPACE 2                                                                
***********************************************************************         
*  Read Production Authorization Record                               *         
***********************************************************************         
         USING FMTRECD,R5                                                       
RDAUTH   NTR1  BASE=*,LABEL=*                                                   
         MVC   ATHCLPRD,SPACES     Clear auth cli/prod field                    
         MVI   AUTHSTAT,C' '       Auth active/inactive status                  
         L     RE,AAUTHREC         Clear record storage area incase an          
         LA    RF,2*K              IO length                                    
         LA    R0,*                Since length is zero load dummy addr         
         SR    R1,R1                                                            
         MVCL  RE,R0                                                            
*                                                                               
*        TM    RECREAD2,RECAUTH    Am i using authorization keywords?           
*        BZ    RDAU50                                                           
*                                                                               
         L     R6,ADACC            On account record search for                 
         AH    R6,DATADISP         Authorization element                        
         SR    RF,RF                                                            
RDAU10   CLI   0(R6),0             End of record                                
         BE    RDAU50              No X'0D' element exit read                   
         CLI   0(R6),JFNELQ        X'0D'                                        
         BE    RDAU15              If found get auth record key and             
         IC    RF,1(,R6)           Read the record                              
         AR    R6,RF                                                            
         B     RDAU10                                                           
*                                                                               
         USING JFNELD,R6                                                        
         USING AUTRECD,R2                                                       
RDAU15   MVC   ATHCLPRD(3),JFNCLI     Need this field to get                    
         MVC   ATHCLPRD+3(3),JFNPRO   Authorization product name                
*                                                                               
         LA    R2,IOKEY               Build authorization record key            
         XC    AUTKEY,AUTKEY                                                    
         MVI   AUTKTYP,AUTKTYPQ            X'3F'                                
         MVI   AUTKSUB,AUTKSUBQ            X'04'                                
         MVC   AUTKCPY,RCCOMPFL            Company code                         
         MVC   AUTKUNT(2),=C'SJ'           Unit/ledger                          
         MVC   AUTKOGR(L'JFNKEY),JFNKEY    Get rest of key from X'0D'           
*                                                                               
         L     R2,ABUDIO                                                        
         L     R1,=AL4(IOBUD+IOREAD+IOACFIL)                                    
         GOTO1 AIO                                                              
         BNE   RDAU50              Authorization record not found               
         SR    R1,R1                                                            
         ICM   R1,3,AUTRLEN        Record length                                
         L     R0,ABUDIO                                                        
         L     RE,AAUTHREC         Move rec to person work area for             
         LA    RF,2*K              Temporary access                             
         MVCL  RE,R0                                                            
*                                                                               
         USING AUTRECD,R2                                                       
         L     R2,AAUTHREC         Check authorization status byte in           
         MVI   AUTHSTAT,C'A'       Default to active                            
         TM    AUTRSTA,AUTRDACT    Key of record - De-activated ?               
         BZ    *+8                 No                                           
         MVI   AUTHSTAT,C'I'       Yes so to inactive authorizations            
*                                                                               
RDAU30   AH    R2,DATADISP         Latest x'0A' element                         
         SR    RF,RF                                                            
         XC    FULL,FULL                                                        
RDAU35   CLI   0(R2),0             EOR ?                                        
         BE    RDAU45              Yes                                          
         CLI   0(R2),AUTHELQ                                                    
         BNE   RDAU40                                                           
         MVI   0(R2),X'FF'         Mark all previous X'0A' els ff's             
         ST    R2,FULL             Save address to un-mark last element         
RDAU40   IC    RF,1(,R2)                                                        
         AR    R2,RF                                                            
         B     RDAU35                                                           
*                                                                               
RDAU45   OC    FULL,FULL           Address of latest x'0a' element              
         BZ    RDAU50              Were no X'0A' elements found                 
         L     R2,FULL                                                          
         MVI   0(R2),AUTHELQ       This is the most recent element              
*                                                                               
RDAU50   DS    0H                                                               
         XIT1                                                                   
         LTORG                                                                  
*&&                                                                             
         EJECT ,                                                                
***********************************************************************         
*  ROUTINE TO GET STANDARD AND OR EDIT HOURS FOR EACH COLUMN         *          
***********************************************************************         
         SPACE 1                                                                
         USING CALD,R2                                                          
         USING COLD,R3                                                          
         USING COSTWKD,R4                                                       
         USING FMTRECD,R5                                                       
SETHRS   NTR1  BASE=*,LABEL=*                                                   
         L     R3,FMTCOL                                                        
         L     R4,ACOSTBLK                                                      
         L     R5,AFORMATS                                                      
         SR    R0,R0                                                            
         IC    R0,FMT#COLS         NUMBER OF COLUMNS                            
SETHRS15 TM    COLFLAGS,COLAMT     $ COLUMN ONLY                                
         BZ    SETHRS50                                                         
         TM    COLFLAGS,COLCALC                                                 
         BO    SETHRS50            NOT AN CALCULATED COLUMN                     
         LA    RF,CALSHRS-CALD     DISPLACEMENT TO PACKED STD HOURS             
         TM    COLIND1,COLSHRS                                                  
         BO    *+12                                                             
         LA    RF,CALEHRS-CALD     DISPLACEMENT TO PACKED EDIT HOURS            
         TM    COLIND1,COLEHRS                                                  
         BZ    SETHRS50                                                         
         ZAP   COLHOURS,PKZERO                                                  
*                                                                               
         L     R2,CSTCALDR                                                      
SETHRS20 CLI   0(R2),0             END OF CALENDAR ENTRIES?                     
         BE    SETHRS50            YEP                                          
*                                                                               
SETHRS30 CLC   COLEND,CALSDTE                                                   
         BL    SETHRS40                                                         
         CLC   COLSTART,CALEDTE                                                 
         BH    SETHRS40                                                         
         LA    RE,CALD(RF)         POINT TO CORRECT ACCUM                       
         AP    COLHOURS,0(L'CALSHRS,RE)                                         
SETHRS40 AHI   R2,CALLNQ                                                        
         B     SETHRS20                                                         
*                                                                               
SETHRS50 AHI   R3,COLLNQ                                                        
         BCT   R0,SETHRS15                                                      
         XIT1  ,                                                                
         DROP  R2,R3,R4,R5                                                      
         EJECT                                                                  
                                                                                
***********************************************************************         
* This code tries to set current values of                                      
* client/prod/job/est/media/media/mos                                           
* The default is used if no data is found. This is based on the prior           
* transaction values                                                            
***********************************************************************         
         USING CURD,R3                                                          
SETDFLT  NTR1  BASE=*,LABEL=*                                                   
         L     R3,CURBASE                                                       
         SR    R4,R4                                                            
SETDFT10 CLI   0(R3),EOT           End of table                                 
         BE    SETDFTX                                                          
         CLI   CURFLAG,YES         Process this one ?                           
         BNE   SETDFT30                                                         
         LR    R6,RA                                                            
         AH    R6,CURVAR           Current location in variable                 
         LR    R2,RA                                                            
         AH    R2,CURDFT           CURRENT LOCATION OF DEFAULT                  
         SR    R4,R4                                                            
         IC    R4,CURVARLN         LENGTH OF VARIABLE                           
         BCTR  R4,0                ANY DEFAULT SET?                             
         EXOC  R4,0(R6),0(R6)                                                   
         BZ    SETDFT12                                                         
         EXCLC R4,0(R6),SPACES                                                  
         BNE   SETDFT20            Already set, save off default                
                                                                                
SETDFT12 GOTO1 PARSE,DMCB,CURPAR,(R6),0                                         
         BE    SETDFT20            SAVE OFF DEFAULT IF NONE ALREADY             
         EXMVC R4,0(R6),0(R2)      MOVE IN DEFAULT                              
         B     SETDFT30                                                         
*                                                                               
SETDFT20 EXCLC R4,0(R2),SPACES     Any data                                     
         BH    SETDFT30            Yes so don't bother                          
         EXMVC R4,0(R2),0(R6)      Save off default data                        
*                                                                               
SETDFT30 AHI   R3,CURLNQ           Next                                         
         B     SETDFT10                                                         
                                                                                
SETDFTX  XIT1  ,                                                                
         DROP  R3                                                               
         EJECT                                                                  
*&&US                                                                           
***********************************************************************         
*  Read TMS Audit Record and save in ATMSAUDR                         *         
***********************************************************************         
         USING AUDRECD,R4                                                       
RDAUDT   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         XC    HALF,HALF                                                        
         GOTOR PARSE,DMCB,GETPID,HALF,0                                         
         OC    HALF,HALF           Can't do this if don't have a pid            
         BZ    RDAUDL                                                           
         USING TMSAUD,RE                                                        
         L     RE,ATMSAUDR                                                      
         CLC   TMSPID,HALF         Is pid the same?                             
         BE    RDAUD01             yes-no need to clear table                   
*        CLI   BYTE,C'N'           Only clear table if new person               
*        BE    RDAUD01                                                          
         MVC   WORK(L'TMSLMGR),TMSLMGR  Save line mgr pid before clear          
         L     RE,ATMSAUDR                                                      
*&&US*&& LHI   RF,10*K                                                          
*&&UK*&& LHI   RF,8*K                                                           
         LA    R0,*                                                             
         SR    R1,R1                                                            
         MVCL  RE,R0                                                            
         STCM  RE,15,RDTEND           Store end of table                        
         USING TMSAUD,RE                                                        
         L     RE,ATMSAUDR                                                      
         MVC   TMSLMGR,WORK        Restore line mgr pid                         
         MVC   TMSPID,HALF         Store pid                                    
         LA    RF,TMSDT                                                         
         MVC   0(2,RF),=X'FFFF'                                                 
         DROP  RE                                                               
*                                                                               
RDAUD01  XC    HALF,HALF                                                        
         GOTOR PARSE,DMCB,GETPID,HALF,0                                         
         BRAS  RE,AUDRD            Check is audit entry already exists          
         BE    RDAUDE              Yes it exists                                
*                                  No it doesn't exist.  R2 point to            
         USING TMSDT,R2            next avaiable entry from AUDRD rtn           
         USING TMDAP,R3                                                         
         LA    R3,TMDAP-TMSDT(R2)                                               
         LA    R4,IOKEY                                                         
         MVI   FIRST,C'Y'                                                       
         XC    AUDKEY,AUDKEY                                                    
         MVI   AUDKTYP,AUDKTYPQ                                                 
         MVI   AUDKSUB,AUDKSUBQ                                                 
         MVC   AUDKCPY,RCCOMPFL                                                 
         MVI   AUDKAUDT,AUDKTIME                                                
         SR    RF,RF                                                            
         ICM   RF,7,TRANDTE        transaction date                             
         OC    AELMTMS7,AELMTMS7                                                
         BZ    RDAUT50                                                          
         L     RE,AELMTMS7         but use this date instead if it's            
         USING TIMELD,RE           there                                        
         OC    TIMETPDT,TIMETPDT                                                
         BZ    RDAUT50                                                          
         ICM   RF,7,TIMETPDT       CONVERT TO 2'S COMPLEMENT                    
RDAUT50  STCM  RF,7,THREE                                                       
         LNR   RF,RF                                                            
         STCM  RF,7,AUDKPEDT       Period ending date from timesheet            
         MVC   AUDKPIDB,HALF       Pid from person record                       
         L     R4,ABUDIO                                                        
         L     R1,=AL4(IOBUD+IOHIGH+IOACFIL)                                    
         GOTO1 AIO                                                              
         B     RDAUT60                                                          
         DROP  RE                                                               
*                                                                               
RDAUTNX  L     R4,ABUDIO                                                        
         L     R1,=AL4(IOBUD+IOSEQ+IOACFIL)                                     
         GOTO1 AIO                                                              
RDAUT60  CLC   IOKEY(AUDKSEQ-AUDRECD),0(R4)                                     
         BNE   RDAUDE                                                           
         TM    UPSI,UPSITRNS                                                    
         BZ    RDAUT70                                                          
         GOTO1 PRNTBL,DMCB,=C'TMS TRANS',ATMSKEY,C'DUMP',42,=C'1D'              
         GOTO1 PRNTBL,DMCB,=C'AUDIT REC',IOKEY+36,C'DUMP',5,=C'1D'              
*                                                                               
RDAUT70  AH    R4,DATADISP                                                      
         USING TIMELD,R4                                                        
RDAUT80  CLI   0(R4),EOR           END OF RECORD                                
         JE    RDAUTNX             Read next                                    
         CLI   0(R4),TIMELQ        X'8B' Time Detail Element                    
         JNE   RDAUT90                                                          
         CLI   TIMETYP,TIMEARIN    Approval row information                     
         JE    RDAUT100                                                         
RDAUT90  ZIC   R1,TIMLN                                                         
         AR    R4,R1                                                            
         J     RDAUT80                                                          
*                                                                               
RDAUT100 CLC   TIMADATE,SPACES     Approval info exists for this row?           
         BNH   RDAUT90             No                                           
         TM    UPSI,UPSITRNS                                                    
         BZ    RDAUT101                                                         
         GOTO1 PRNTBL,DMCB,=C'AUDIT EL',(R4),C'DUMP',38,=C'1D'                  
RDAUT101 CLI   FIRST,C'Y'          1st time through for this timesheet          
         BNE   *+14                                                             
         MVC   TMSAPDT,THREE       Store timesheet date in table                
         MVI   APPROW#,01                                                       
*                                                                               
         MVI   FIRST,C'N'                                                       
         MVC   TMS#ROW,APPROW#                                                  
         MVC   TMSADTE,TIMADATE    Approval date                                
         MVC   TMSAPID,TIMAPDAC    Approver pid                                 
         MVC   TMSAROW,TIMAIDNO    Row number                                   
         ZIC   RF,APPROW#                                                       
         AHI   RF,1                                                             
         STC   RF,APPROW#                                                       
         LA    R3,TMSALNQ(R3)                                                   
         CLM   R3,15,RDTEND        Compare to end                               
         BL    *+6                                                              
         DC    H'0'                Increase table                               
         MVI   0(R3),EOT                                                        
         B     RDAUT90                                                          
*                                                                               
RDAUDL   CLI   *,X'FF'             SET CC = LOW                                 
         J     RDAUDX                                                           
RDAUDE   CR    RB,RB               SET CC = EQUAL                               
RDAUDX   XIT1                                                                   
         DROP  R2,R4                                                            
*----------------------------------------                                       
*      STORAGE FOR RDAUDT                                                       
*----------------------------------------                                       
FIRST    DS    CL1                                                              
APPROW#  DS    XL1                                                              
RDTEND   DS    XL4                                                              
*                                                                               
         SPACE 2                                                                
***********************************************************************         
*  Check ATMSAUDR Audit record to see if entry already exists         *         
*  Half contains the pid of the person's timesheet                              
***********************************************************************         
AUDRD    NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING TIMELD,R4                                                        
         MVC   WORD,TRANDTE        transaction date                             
         OC    AELMTMS7,AELMTMS7                                                
         BZ    AUDR02                                                           
         L     R4,AELMTMS7                                                      
         OC    TIMETPDT,TIMETPDT                                                
         BZ    AUDR02                                                           
         MVC   WORD(L'TIMETPDT),TIMETPDT     Save timesheet date                
*                                                                               
         USING TMSAUD,R1                                                        
AUDR02   L     R1,ATMSAUDR         TMS Audit record                             
         LA    R2,TMSDT                                                         
         LA    R3,TMDAP-TMSDT(R2)                                               
         USING TMSDT,R2                                                         
         USING TMDAP,R3                                                         
AUDRD10  CLI   0(R2),EOT                                                        
         BE    AUDRDL                                                           
         CLC   TMSAPDT,WORD        Same transaction date?                       
         BE    AUDRDE              Then no need to read again                   
*                                                                               
         ZIC   RF,TMS#ROW          # of rows for this timesheet date            
         MHI   RF,TMSALNQ          x length of ea data row                      
         AHI   RF,TMSCLNQ          + overhead                                   
         AR    R2,RF               get's you to the next timesheet              
         B     AUDRD10             entry                                        
*                                                                               
AUDRDL   CLI   *,X'FF'             SET CC = LOW                                 
         J     AUDRDX                                                           
AUDRDE   CR    RB,RB               SET CC = EQUAL                               
AUDRDX   XIT1  REGS=(R2)                                                        
         DROP  R2                                                               
         SPACE 2                                                                
         LTORG                                                                  
***********************************************************************         
*  Find approver/approval date in TMS Audit record                    *         
***********************************************************************         
CHKAUDT  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         XC    HALF,HALF                                                        
         MVI   BYTE,C'N'                                                        
         XC    CURAPPR,CURAPPR                                                  
         XC    CURAPPRD,CURAPPRD                                                
         XC    CURSBMTR,CURSBMTR                                                
         L     R4,AELMTMS7                                                      
         USING TIMELD,R4                                                        
         MVC   HALF,TIMEIDNO       Save timeline row #                          
         MVC   WORD,TRANDTE        transaction date                             
         OC    AELMTMS7,AELMTMS7                                                
         BZ    CAUDT01                                                          
         L     R4,AELMTMS7                                                      
         OC    TIMETPDT,TIMETPDT                                                
         BZ    CAUDT01                                                          
         MVC   WORD(L'TIMETPDT),TIMETPDT     Save timesheet date                
         DROP  R4                                                               
*                                                                               
         USING TMSAUD,R1                                                        
CAUDT01  L     R1,ATMSAUDR         TMS Audit record                             
         MVC   CURSBMTR,TMSPID                                                  
         LA    R2,TMSDT                                                         
         USING TMSDT,R2                                                         
CAUDT10  CLI   0(R2),EOT                                                        
         BE    CAUDTX                                                           
         LA    R3,TMDAP-TMSDT(R2)                                               
         USING TMDAP,R3                                                         
         CLC   TMSAPDT,WORD        Does timesheet date match?                   
         BNE   CAUDT50                                                          
         ZIC   RE,TMS#ROW          # of table entries for this date             
CAUDT20  CLC   HALF,TMSAROW        Same row?                                    
         BE    CAUDT100            Yes - store and exit                         
         CLC   TMSAROW,=X'0000'    Overall timesheet element?                   
         BNE   CAUDT40             No - read again                              
         MVC   CURAPPR,TMSAPID                                                  
         MVC   CURAPPRD,TMSADTE                                                 
         MVC   CURSBMTR,TMSPID                                                  
*                                                                               
CAUDT40  LA    R3,TMSALNQ(R3)                                                   
         BCT   RE,CAUDT20                                                       
*                                                                               
CAUDT50  ZIC   RF,TMS#ROW          # of rows for this timesheet                 
         MHI   RF,TMSALNQ          x length of ea data row                      
         AHI   RF,TMSCLNQ          + overhead                                   
         AR    R2,RF               get's you to the next timesh                 
         B     CAUDT10                                                          
*                                                                               
CAUDT100 MVC   CURAPPR,TMSAPID                                                  
         MVC   CURAPPRD,TMSADTE                                                 
         MVC   CURSBMTR,TMSPID                                                  
*                                                                               
CAUDTX   XIT1                                                                   
         DROP  R1                                                               
         SPACE 2                                                                
         LTORG                                                                  
         SPACE 2                                                                
*&&                                                                             
***********************************************************************         
*  Get Timesheet submit date from Time record                         *         
***********************************************************************         
         USING GDAELD,R4                                                        
         USING ACMD,R2                                                          
GETSUBDT NTR1  BASE=*,LABEL=*                                                   
         XC    CURSUBDT,CURSUBDT                                                
         CLI   MODE,PROCTRNS       PROCTMS MODE?                                
         JE    GETSUBDX            NO, EXIT                                     
         CLI   QPROG,MANPOWER      MANPOWER?                                    
         JNE   GETSUBDX            NO, EXIT                                     
         L     R2,AMONACC          ADDRESSABLITY TO MONACC DATA                 
         L     R4,ACMATRN          GET TRANSACTION BLOCK FROM MONACC            
         AH    R4,DATADISP         POINT TO FIRST ELEMENT OF REC                
*                                                                               
GETSUBD2 CLI   GDAEL,0             END OF RECORD?                               
         JE    GETSUBDX            YES, EXIT                                    
         CLI   GDAEL,GDAELQ        GENERAL DATE ELEMENT FOUND?                  
         JNE   GETSUBD6            NO, EXIT                                     
         CLI   GDATYPE,GDACLSUB    BRANDOCEAN TIME- CLIENT APP SUBMIT?          
         JE    GETSUBD4            YES, CONTINUE                                
         CLI   GDATYPE,GDACLSUB    BRANDOCEAN TIME- LINE MANAGER SUB?           
         JNE   GETSUBD6            NO, EXIT                                     
*                                                                               
GETSUBD4 MVC   CURSUBDT,GDADATE    GET SUBMIT DATE                              
*                                                                               
GETSUBD6 LLC   R1,GDALN            BUMP TO NEXT ELEMENT                         
         AR    R4,R1                                                            
         J     GETSUBD2                                                         
*                                                                               
GETSUBDX XIT1                                                                   
         DROP  R2,R4                                                            
         SPACE 2                                                                
         LTORG                                                                  
         SPACE 2                                                                
***********************************************************************         
*  Read Person Approver record to get current line manager            *         
***********************************************************************         
         USING DPAPASD,R4                                                       
         USING LDGD,R3                                                          
RDLNMGR  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING TMSAUD,RF                                                        
         L     RF,ATMSAUDR         TMS Audit record                             
         MVC   TMSLMGR,SPACES      clear out the line manager                   
         GOTO1 GETLDGR,DMCB,=C'1R'                                              
         L     R3,0(,R1)           Get ledger entry                             
         MVI   BYTE,1              Set 1st time around                          
RLMG05   LA    R4,IOKEY                                                         
         XC    DPAPAS,DPAPAS                                                    
         MVI   DPAPTYP,DPAPTYPQ                                                 
         MVI   DPAPSUB,DPAPSUBQ                                                 
         MVC   DPAPCPY,RCCOMPFL                                                 
         MVI   DPAPAPPL,DPAPATIM                                                
         ZAP   DPAPXVAL,=P'0'                                                   
         ZIC   RE,LDGLEV1          Length of level 1                            
         CLI   BYTE,1                                                           
         BE    RLMG10                                                           
         ZIC   RE,LDGLEV2          Length of level 1+2                          
         CLI   BYTE,2                                                           
         BE    RLMG10                                                           
         ZIC   RE,LDGLEV3          Length of level 1+2+3                        
         CLI   BYTE,3                                                           
         BE    RLMG10                                                           
         ZIC   RE,LDGLEV4          Must be level 4 then                         
RLMG10   BCTR  RE,0                                                             
         EXMVC RE,DPAP1RAC,CURACC+3                                             
         OC    DPAP1RAC,SPACES                                                  
         L     R4,ABUDIO                                                        
         L     R1,=AL4(IOBUD+IOHIGH+IOACDIR)                                    
         GOTO1 AIO                                                              
         CLC   IOKEY(DPAPPIDB-DPAPASD),0(R4)                                    
         BNE   RLMG20                                                           
*        TM    UPSI,UPSITRNS                                                    
*        BZ    RLMG20                                                           
*        GOTO1 PRNTBL,DMCB,=C'TMS TRANS',ATMSKEY,C'DUMP',42,=C'1D'              
*        GOTO1 PRNTBL,DMCB,=C'DEPT REC',IOKEY,C'DUMP',42,=C'1D'                 
         USING TMSAUD,RF                                                        
         L     RF,ATMSAUDR         TMS Audit record                             
         MVC   TMSLMGR,DPAPPIDB                                                 
RLMG20   ZIC   R1,BYTE                                                          
         AHI   R1,1                                                             
         STC   R1,BYTE                                                          
         CHI   R1,4                Did we read all 4 levels?                    
         BNH   RLMG05                                                           
                                                                                
RDLMGRX  XIT1                                                                   
         DROP  R4,RF                                                            
                                                                                
***********************************************************************         
*  Move line manager into CURLNMGR if timeline from BrandO            *         
***********************************************************************         
CHKLMGR  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         MVC   CURLNMGR,SPACES                                                  
         USING TMSAUD,R1                                                        
         L     R1,ATMSAUDR         TMS Audit record                             
         CLC   =X'FFFF',0(R1)      If empty than not BrandO                     
         BE    CLMGRX                                                           
         MVC   CURLNMGR,TMSLMGR                                                 
CLMGRX   XIT1                                                                   
         DROP  R1                                                               
***********************************************************************         
* Set AELEM99 element for appropriate AELEM77B element                *         
***********************************************************************         
         USING CFWELD,R3                                                        
         USING TRNELD,R2                                                        
SETCFELM STM   RE,R4,SVRE                                                       
         XC    AELEM99,AELEM99                                                  
         L     R2,ADTRANS          A(X'44' TRNELD)                              
         L     R3,ACFWELS          Pool of cashflow elements                    
         TM    TRNSTAT,TRNSDR      Debit or Credit ?                            
         JZ    SETCFE10            Credit                                       
         ICM   R4,15,AELEM77B      Any billing element                          
         JZ    SETCFE90            No                                           
                                                                                
SETCFE10 CLI   0(R3),EOR           Any more ?                                   
         JE    SETCFE90            No so finished                               
         CLI   CFWEL,CFWELQ        X'99'                                        
         JNE   SETCFE20                                                         
         CLI   CFWTYP,CFWTYRQ      Client recievables                           
         JNE   SETCFE20                                                         
         TM    TRNSTAT,TRNSDR      Debit or Credit ?                            
         JO    SETCFE15            Debit                                        
                                                                                
         CLC   CFWBLNO,TRNREF      Cashflow info for this bill ?                
         JNE   SETCFE20              No                                         
         GOTOR DATCON,DMCB,(1,TRNDATE),(2,WORK)                                 
         CLC   CFWBLDT,WORK        Cashflow info for this bill date ?           
         JNE   SETCFE20              No                                         
         ST    R3,AELEM99                                                       
         J     SETCFE90                                                         
                                                                                
         USING PTAELD,R4                                                        
SETCFE15 CLC   CFWBLNO,PTARBLNO    CashFlow info for this Bill?                 
         JNE   SETCFE20              No                                         
         CLC   CFWBLDT,PTARBLDT    CashFLow info for this Date?                 
         JNE   SETCFE20              No                                         
         ST    R3,AELEM99                                                       
         J     SETCFE90                                                         
                                                                                
SETCFE20 ZIC   R0,1(,R3)                                                        
         AR    R3,R0                                                            
         J     SETCFE10                                                         
                                                                                
SETCFE90 LM    RE,R4,SVRE                                                       
         BR    RE                                                               
         DROP  R2,R3,R4                                                         
***********************************************************************         
*  PROCESS PRODUCTION ELEMENTS AT TRANSACTION LEVEL                   *         
***********************************************************************         
         SPACE 1                                                                
         USING TRNELD,R4                                                        
         USING FMTRECD,R5                                                       
SETPROD  NTR1  BASE=*,LABEL=*                                                   
         LR    R4,R1                                                            
         XC    BILLDTE(5),BILLDTE                                               
         XC    TRFRDTE(5),TRFRDTE                                               
         XC    WROFDTE(5),WROFDTE                                               
*                                                                               
         USING PG$GEN,R2                                                        
         TM    CURSTAT,CURNONC     IS IT NON-COMMISSIONALBE?                    
         BO    *+8                 YEP                                          
         OI    CURSTAT,CURCOMM     NO, SO SET AS COMMISSIONALBLE                
         L     R2,PRORATA1         GET PRORATA BLOCK 1                          
         ZAP   DUB,PA$NET          DR AMOUNT                                    
         SP    DUB,PA$WOFAM        MINUS WRITE-OFFS                             
         SP    DUB,PA$XFRAM        MINUS TRANSFER AMOUNT                        
         CP    DUB,PKZERO                                                       
         BE    SETPRD15            NOTHING BILLED                               
         CP    PA$NETBL,PKZERO     ANY BILLING?                                 
         BE    SETPRD15            NOTHING BILLED                               
         OI    CURSTAT,CURBILL     SET TO BILLED                                
         SP    DUB,PA$NETBL        MINUS BILLING                                
         BZ    SETPRD15            FULLY BILLED                                 
         OI    CURSTAT,CURPBIL     SET TO PART BILLED                           
         NI    CURSTAT,TURNOFF-CURBILL                                          
***********************************************************************         
*  ELIMINATE X'77' BASED ON MOA REQUEST RANGE                         *         
***********************************************************************         
         SPACE 1                                                                
SETPRD15 XC    BILLDTE(5),BILLDTE                                               
         XC    TRFRDTE(5),TRFRDTE                                               
         XC    WROFDTE(5),WROFDTE                                               
         NI    CURIND,TURNOFF-CURBILPD                                          
         CLC   TRNANAL,=C'99'      GET BILL TYPE FOR WORKCODE=99                
         BNE   SETPRD20                                                         
         CLI   TRNTYPE,1                                                        
         BE    SETPRDN             Not allowed, bad data                        
*                                                                               
         CLI   TRNLN,TRNLN2Q+15    TRNNARR OVER 15 BYTES TO MAKE                
         BNE   SETPRD17            LIKE NEW FORMAT                              
         CLC   =C'BILL NO',TRNBLTYP                                             
         BNE   SETPRDN             DON'T KNOW WHAT THIS IS, SO REMOVE           
         MVC   TRNBLTYP(TRNLN2Q-TRNLN1Q),TRNBLTYP+15                            
         XC    TRNBLTYP+TRNLN2Q-TRNLN1Q(15),TRNBLTYP+TRNLN2Q-TRNLN1Q            
         B     SETPRD18                                                         
*                                                                               
SETPRD17 DS    0H                                                               
*&&US*&& CLI   TRNLN,TRNLN2Q       MUST BE BAD X'44' ELEMENT                    
*&&US*&& BNE   SETPRDN             DON'T KNOW WHAT THIS IS, SO REMOVE           
*                                                                               
SETPRD18 GOTO1 =A(GETBLTYP)                                                     
         TM    CURIND,CURBILCR     BILLED CREDIT ONLY                           
         BZ    SETPRD20                                                         
         MVC   BILLDTE,TRANDTE     BILLED DATE FOR A CR                         
         MVC   BMOADTE,MOADTE                                                   
         MVI   BMOADTE+2,1                                                      
*                                                                               
         USING PTAELD,R2                                                        
SETPRD20 MVI   BYTE,NO             SET TO NO ALLOCATED AMOUNT                   
         XC    PTACOUNT,PTACOUNT   HOW MANY PTA'S ON TRANSACTION ?              
         ICM   R2,15,PRORATA2                                                   
         BZ    SETPRD70            FIX UP WRITE-OFFS FROM X'4B'                 
         L     R6,APTAWRK          MY WORK AREA FOR X'77'                       
         MVI   0(R6),0             RESET TO NONE                                
*                                                                               
SETPRD40 CLI   0(R2),0                                                          
         BE    SETPRD70            FINISHED                                     
         CLI   0(R2),PTAELQ        X'77'                                        
         BNE   SETPRD68            NEXT ELEMENT                                 
         CLI   PTATYPE,0           ANY TYPE ?                                   
         BE    SETPRD68            NO, DON'T SAVE NOR COUNT AS DELETED          
         CLI   PTATYPE,PTATRAL     .  Allocated to bill?                        
         BNE   SETPRD44                                                         
*                                                                               
         TM    FMTROPT,RPFXRVRS    Exclude Reversals?                           
         BZ    SETPRD42                                                         
         TM    PTASTAT1,PTASREVU+PTASREVS                                       
         BNZ   SETPRD68              skip them                                  
*                                                                               
SETPRD42 TM    PTASTAT1,PTASPEND   .  Pending?                                  
         BO    SETPRD44                                                         
         TM    PTASTAT1,PTASREVU   .  Reversed?                                 
         BO    SETPRD44                                                         
         TM    PTASTAT1,PTASREVS   .  Reversal allocation                       
         BO    SETPRD44                                                         
         MVC   CURFCCDE,PTACUR     Override foreign currency code               
         OI    FCIND,FCIFOUND      Foreign currency found                       
*                                                                               
SETPRD44 CLC   TRNANAL,=C'99'      IGNORE ALL IF WORKCODE=99                    
         BE    SETPRD68                                                         
         LH    RF,PTACOUNT                                                      
         AHI   RF,1                                                             
         STH   RF,PTACOUNT                                                      
         GOTOR BILLDTES,DMCB,(R2),WORK                                          
         OC    PTAMOA,PTAMOA       ANY MOA STORED?                              
         BNZ   SETPRD45            YES                                          
         MVC   PTAMOA,WORK+3       SAVE OFF BILLED MOA                          
*                                                                               
SETPRD45 CLC   RMOADTE,=X'0000FFFF'   MOA RANGE REQUESTED?                      
         BE    SETPRD52                                                         
         CLC   RMOAEND,SAVEMOS     IS THIS TRANS MOA > QMOAEND?                 
         BNL   SETPRD46            NO                                           
         CLC   RMOAEND,PTAMOA      IF SO IS BILLED MOA < ORIGINAL MOA           
         BL    SETPRD65            MARK DELETED (OUT OF RANGE)                  
*                                                                               
SETPRD46 CLC   RMOAALTE,PTAMOA     COMPARE BILLED MOA TO ALTERNATE MOA          
         BL    SETPRD65            MARK DELETED (OUT OF RANGE)                  
         CLC   RMOAALTS,PTAMOA     COMPARE BILLED MOA                           
         BH    SETPRD65            MARK DELETED (OUT OF RANGE)                  
*                                                                               
SETPRD52 CLC   RTRNDTE,=X'000000FFFFFF'  TRANS DATE RANGE REQUESTED?            
         BE    SETPRD54                                                         
         CLC   RTRNEND,TRNDATE     IS THIS TRANS DATE > QEND?                   
         BNL   SETPRD54            NO                                           
         CLC   RTRNEND,WORK        IF SO IS BILLED DATE < QEND?                 
         BL    SETPRD65            MARK DELETED (OUT OF RANGE)                  
*                                                                               
SETPRD54 TM    DATEFLT,DATEBIL     CHECK BILLED DATE                            
         BZ    SETPRD55                                                         
         CLC   ALTNEND,WORK        COMPARE BILLED DATED                         
         BL    SETPRD65            MARK DELETED (OUT OF RANGE)                  
         CLC   ALTNSTR,WORK        COMPARE BILLED DATED                         
         BH    SETPRD65            MARK DELETED (OUT OF RANGE)                  
*                                                                               
SETPRD55 LLC   R1,PTALN            GET LENGTH                                   
         LR    RF,R1               SAVE LENGTH                                  
         BCTR  R1,0                                                             
         EXMVC R1,0(R6),0(R2)      MOVE ELEMENT TO NEW AREA                     
*&&UK                                                                           
         LA    RE,PTARLN3Q                                                      
         CR    RF,RE                                                            
         BNL   SETPRD56                                                         
         SR    RE,RF                                                            
         LA    RF,PTARLN3Q         MAKE RF AT LEAST PTARLN3Q LONG               
         AR    R1,RE                                                            
*&&                                                                             
SETPRD56 AR    RF,R6               POINT TO END OF ELEMENT                      
         MVC   0(3,RF),WORK        SAVE BILLED/TRANS/W-OFF DATE                 
         AHI   R1,4                MAKE R1 = TOTAL ELEMENT LENGTH               
         STC   R1,1(,R6)           SAVE OFF NEW LENGTH                          
         LR    RF,R6               SAVE BEGINING OF ELEMENT                     
         AR    R6,R1               POINT TO END OF ELEMENT                      
         MVI   0(R6),0             MARK END                                     
         LA    R3,WROFDTE                                                       
         LA    RE,AELEM77W         SET TO WRITE-OFF OR RECOVERY                 
         CLI   PTATYPE,PTATRAL     BILLED                                       
         BNE   SETPRD58                                                         
         LA    R3,BILLDTE                                                       
         LA    RE,AELEM77B                                                      
*                                                                               
SETPRD58 CLI   PTATYPE,PTATTRFT                                                 
         BNE   SETPRD60                                                         
         LA    R3,TRFRDTE                                                       
         LA    RE,AELEM77T         TRANSFERED                                   
*                                                                               
SETPRD60 OC    0(4,RE),0(RE)       ALREADY SAVED ONE?                           
         BNZ   SETPRD68            YES                                          
         ST    RF,0(,RE)           SAVE OFF SAVED R6 = X'77' ADDRESS            
         MVC   0(6,R3),WORK        SAVE CURRENT DATE                            
         CLI   PTATYPE,PTATRAL     BILLED                                       
         BNE   SETPRD68                                                         
         TM    PTASTAT1,PTASPEND   IS IT PENDING?                               
         BZ    SETPRD68                                                         
         OI    CURIND,CURBILPD     YES                                          
         B     SETPRD68                                                         
*                                                                               
SETPRD65 MVI   BYTE,YES            THIS SAYS WE ARE IGNORE SOME X'77'           
SETPRD68 SR    R1,R1                                                            
         IC    R1,PTALN                                                         
         AR    R2,R1                                                            
         B     SETPRD40                                                         
*                                                                               
SETPRD70 CLI   GPTRAN,GPTRNCR      IS IT A CREDIT?                              
         BE    SETPRD80            YES                                          
         CLI   RTRNEND,X'FF'       ANY REQUESTED END DATE?                      
         BE    SETPRD72                                                         
         CLC   TRANDTE,RTRNEND                                                  
         BH    SETPRD73                                                         
*                                                                               
SETPRD72 CLC   RMOADTE,=X'0000FFFF'   MOA RANGE REQUESTED?                      
         BE    SETPRD77               NO                                        
         CLC   SAVEMOS,RMOAEND                                                  
         BNH   SETPRD77                                                         
*                                                                               
SETPRD73 ZAP   TRNAMNT,PKZERO      ZAP TRANS AMOUNT                             
         ZAP   CURFCAMT,PKZERO     ZAP ANY FOREIGN CURRENCY AMOUNT TOO          
*                                                                               
         ICM   RE,15,AELEM40       DELETE X'40' ELEMENT HOURS                   
         BZ    SETPRD74                                                         
         MVI   0(RE),X'FF'                                                      
         XC    AELEM40,AELEM40                                                  
*                                                                               
SETPRD74 ICM   RE,15,AELEM7C       DELETE X'7C' PRICE DETAIL                    
         BZ    SETPRD75                                                         
         MVI   0(RE),X'FF'                                                      
         XC    AELEM7C,AELEM7C                                                  
*                                                                               
SETPRD75 ICM   RE,15,AELEM50       DELETE X'50' VARIOUS                         
         BZ    SETPRD76                                                         
         MVI   0(RE),X'FF'                                                      
         XC    AELEM50,AELEM50                                                  
*                                                                               
SETPRD76 ICM   RE,15,AELEM50T      Delete X'50' T Type                          
         BZ    SETPRD77                                                         
         MVI   0(RE),X'FF'                                                      
         XC    AELEM50T,AELEM50T                                                
*                                                                               
         USING TRNRECD,R2                                                       
SETPRD77 L     R2,ADTRANS                                                       
         SHI   R2,ACCORFST         GET TO BEGINNING OF THE KEY                  
         SR    RF,RF                                                            
         CLI   BYTE,YES            DID  WE NOT INCLUDE SOME X'77'               
         BNE   SETPRD85            NO,  SO NO NEED TO UPDATE BLOCK              
*                                                                               
         L     R6,APTAWRK          YES, SO UPDATE PRORATA BLOCK                 
         L     RE,PRORATA2                                                      
SETPRD78 CLI   0(R6),0                                                          
         BE    SETPRD79                                                         
         IC    R1,1(,R6)           GET LENGTH                                   
         SHI   R1,4                TO REMOVE TAGED ON DATES                     
         EXMVC R1,0(RE),0(R6)      MOVE ELEMENT TO NEW AREA                     
         LA    R6,4(R1,R6)         POINT TO NEXT ELEMENT IN APTAWRK             
         AHI   R1,1                POINT TO NEXT SPACE IN PRORATA2              
         STC   R1,1(,RE)           SAVE OFF NEW LENGTH                          
         AR    RE,R1                                                            
         MVI   0(RE),0             MARK END OF ELEMENTS                         
         B     SETPRD78                                                         
*                                                                               
SETPRD79 GOTO1 APRORATA,DMCB,(X'A0',(R2)),ADGOBLOC,ADCOMFAC,0,         X        
               PRORATA1,PRORATA2                                                
         GOTO1 APRORATA,DMCB,(X'80',(R2)),ADGOBLOC,ADCOMFAC,0,         X        
               PRORATA1,0                                                       
         XC    AELEM1A(AELEMQ),AELEM1A                                          
         XC    AELEM50T,AELEM50T                                                
         GOTOR SETELEM             RESET ELEMENT ADDRESSES                      
         B     SETPRD85                                                         
*                                                                               
SETPRD80 CLC   RMOADTE,=X'0000FFFF'   THIS IS FOR WC=99 (CREDITS ONLY)          
         BE    SETPRD82                                                         
         CLC   RMOAALTE,MOADTE     ALTERNATE END MOA                            
         BL    SETPRDN                                                          
         CLC   RMOAALTS,MOADTE     ALTERNATE START MOA                          
         BH    SETPRDN                                                          
*                                                                               
SETPRD82 CLC   RTRNDTE,=X'000000FFFFFF'  TRANS DATE RANGE REQUESTED?            
         BE    SETPRD84                                                         
         CLC   RTRNEND,TRNDATE                                                  
         BL    SETPRDN                                                          
*                                                                               
SETPRD84 TM    DATEFLT,DATEBIL     CHECK BILLED DATE                            
         BZ    SETPRD85                                                         
         CLC   ALTNEND,TRNDATE     ALTERNATE END DATE                           
         BL    SETPRDN                                                          
         CLC   ALTNSTR,TRNDATE     ALTERNATE START DATE                         
         BH    SETPRDN                                                          
*                                  Get Purchase order number                    
SETPRD85 MVC   WORK(6),SPACES                                                   
         GOTOR PARSE,DMCB,GETPORD,WORK,0                                        
         BNE   SETPRD86                                                         
         OI    POIND,POI#ON        Have PO #                                    
         TM    RECREAD2,RECPORD                                                 
         BZ    SETPRD86                                                         
         GOTO1 GETPO,DMCB,WORK,TRNKWORK                                         
*                                  Get local BrandOcean Estimate number         
***PRD86 MVC   CURESTET,SPACES                                                  
***      GOTOR PARSE,DMCB,GETEST#,CURESTET,0                                    
SETPRD86 MVC   CURLCNO,SPACES                                                   
         GOTOR PARSE,DMCB,GETEST#,CURLCNO,0                                     
         BNE   SETPRD90                                                         
         OI    ESTIND3,ESTONTX     yes it does                                  
         TM    RECREAD3,RECAESTS   Any keywords with KYWREST set?               
         BZ    SETPRD90                                                         
         GOTO1 GEST,DMCB,TRNKWORK  Store any new non-jobber info away           
*                                                                               
SETPRD90 LH    RF,PTACOUNT         NUMBER OF PTA'S ON TRANSACTION               
         CHI   RF,1                                                             
         BNH   SETPRDY                                                          
         TM    SPLITIND,SPLIT77    ARE WE INTRESETED IN X'77'S                  
         BZ    SETPRDY             NO                                           
         OI    SPLITSW,SPLITMLT    MORE THAN 1 X'77' ON TRANS                   
         B     SETPRDY                                                          
*                                                                               
SETPRDN  LTR   RB,RB                                                            
         B     *+6                                                              
SETPRDY  CR    RB,RB                                                            
         XIT1                                                                   
         DROP  R2,R4                                                            
         SPACE 1                                                                
APREVPO  DS    A                                                                
PTACOUNT DS    H                                                                
         EJECT                                                                  
***********************************************************************         
*  FILL IN TABLE OF ELEMENT ADDRESSES                                 *         
***********************************************************************         
SETELEM  NTR1  BASE=*,LABEL=*                                                   
         L     R4,ADTRANS                                                       
         XC    WORK(2),WORK                                                     
         OI    PARCNTRL,PARTVND    Default as true vendor                       
                                                                                
SETELM10 CLI   0(R4),EOR           End of record?                               
         JE    SETELM55            Yes, so finish up                            
         ZIC   RE,0(,R4)           Index using element into hash tab            
         A     RE,=A(HASHELM)                                                   
*                                  * hash index *                               
         CLI   0(RE),0             Is there an index value                      
         JE    SETNXTEL            No so, next element                          
         ZIC   RF,0(,RE)           Get index                                    
         BCTR  RF,0                Adjust index for base zero                   
         MHI   RF,ELMTBLNQ                                                      
         A     RF,=A(ELEMTAB)      Element table                                
                                                                                
         USING ELMTABD,RF                                                       
         SR    R1,R1               * entry in table *                           
         ICM   R1,3,ELMDISP        Resolve address                              
         AR    R1,RA               Add base to DSECT                            
         OC    0(4,R1),0(R1)       Do I have one stored already?                
         JNZ   *+8                 Yes so see if there is a routine #           
         ST    R4,0(,R1)           Save off address of element                  
*                                  * process element if routine # *             
         SR    R1,R1                                                            
         ICM   R1,1,ELMROUT#                                                    
         JZ    SETNXTEL            No routine                                   
         SLL   R1,2                                                             
         B     *(R1)               Branch to jump instruction                   
         J     SETR50              SCIEL  UK                                    
*&&US*&& J     SETR5F              SUTEL  US                                    
*&&UK*&& J     SETNXTEL            SUTEL  UK                                    
         J     SETR76              NOTEL                                        
         J     SETR63              GLDEL                                        
         DROP  RF                                                               
***********************************************************************         
* Process 50 element for special type                                           
***********************************************************************         
         USING SCIELD,R4                                                        
SETR50   DS    0H                                                               
*&&US                              ** US only **                                
         CLI   SCITYPE,SCITTQST    QST / HST (PST is represent both)            
         JNE   SETNXTEL                                                         
         OC    AELEM50T,AELEM50T   There are multiple of these so               
         BNZ   SETNXTEL            need to process one at a time                
         ST    R4,AELEM50T                                                      
         J     SETNXTEL                                                         
*&&                                                                             
*&&UK                                                                           
         CLI   QPROG,PRODUCTION    ** UK only **                                
         JNE   SETNXTEL                                                         
         CLI   SCITYPE,SCITSJHR    SJ HOURS                                     
         JNE   SETNXTEL                                                         
         OC    AELEM50T,AELEM50T                                                
         JZ    *+6                 I'M HOPING ONLY 1 PER RECORD                 
         DC    H'00'                                                            
         ST    R4,AELEM50T                                                      
         J     SETNXTEL                                                         
         DROP  R4                                                               
*&&                                                                             
***********************************************************************         
* Process 76 element for latest one                                             
***********************************************************************         
         USING NOTELD,R4                                                        
SETR76   CLC   WORK(2),NOTDATE                                                  
         JNL   *+10                                                             
         MVC   WORK(2),NOTDATE     SAVE DATE OF LASTEST X'76'                   
         J     SETNXTEL                                                         
         DROP  R4                                                               
***********************************************************************         
* Process 63 element for latest one                                             
***********************************************************************         
         USING GLDELD,R4                                                        
S        USING GLDELD,R1                                                        
SETR63   OC    GLDDATE,GLDDATE     Was this set?                                
         JZ    SETNXTEL            No, so skip                                  
         ICM   R1,15,AELEM63       SAVED GENERAL LEDGER ELEMENT                 
         JZ    SETR63A                                                          
         CLC   S.GLDDATE,GLDDATE                                                
         JNL   SETNXTEL                                                         
                                                                                
SETR63A  ST    R4,AELEM63          SAVE GENERAL LEDGER ELEMENT                  
         J     SETNXTEL                                                         
         DROP  S,R4                                                             
***********************************************************************         
* Process 5F element to reverse sign of basis if need be                        
***********************************************************************         
*&&US                                                                           
         USING SUTELD,RF                                                        
         USING TRNELD,RE                                                        
SETR5F   LR    RF,R4                                                            
         SR    R1,R1               Set both as +                                
         L     RE,ADTRANS                                                       
         NI    PARCNTRL,TURNOFF-PARTVND                                         
         CP    TRNAMNT,PKZERO                                                   
         BNM   *+8                                                              
         SHI   R1,1                If minus then add -1                         
         CP    SUTRTE,PKZERO       Is it a negative rate                        
         BNM   *+8                                                              
         AHI   R1,1                If minus then add 1                          
         LTR   R1,R1               Are they the same                            
         JZ    SETNXTEL            They were the same sign                      
         ZAP   SUTBAS,SUTBAS       Get basis, make sign C or D                  
         XI    SUTBAS+L'SUTBAS-1,X'01'        Reverse sign                      
         DROP  RE,RF                                                            
*&&                                                                             
SETNXTEL SR    R1,R1                                                            
         IC    R1,1(,R4)           Get next element                             
         AR    R4,R1                                                            
         J     SETELM10            Loop                                         
*                                                                               
SETELM55 ICM   RF,15,AELEM76       MEMO ELEMENT                                 
         JZ    SETELM70                                                         
         XC    AELEM76,AELEM76     RESET                                        
         SR    R1,R1                                                            
*                                                                               
         USING NOTELD,RF                                                        
SETELM60 CLI   NOTEL,0                                                          
         JE    SETELM70            FINISHED                                     
         CLI   NOTEL,NOTELQ        ANOTHER MEMO?                                
         JNE   SETELM68                                                         
         MVI   NOTEL,X'FF'         MARK DELETED                                 
         CLC   NOTDATE,WORK        MATCH ON SAVED DATE                          
         JNE   SETELM68                                                         
         MVI   NOTEL,NOTELQ        UNMARK DELETED                               
         OC    AELEM76,AELEM76                                                  
         JNZ   SETELM68                                                         
         ST    RF,AELEM76                                                       
SETELM68 IC    R1,NOTLN                                                         
         AR    RF,R1                                                            
         J     SETELM60                                                         
         DROP  RF                                                               
*                                                                               
SETELM70 DS    0H                                                               
SETELM99 XIT1                                                                   
         EJECT                                                                  
*&&UK                                                                           
**********************************************************************          
* STORE XDATA NAMES AND VALUES FROM TRANSACTION FOR FILTERING LATER  *          
* LATER IN FLTTRN                                                    *          
**********************************************************************          
         SPACE 1                                                                
GETXDAT  NTR1  BASE=*,LABEL=*                                                   
         USING XDFELD,R6                                                        
         ICM   R6,15,AELEMA2                                                    
         BZ    GETXDAY                                                          
         L     R2,AXDATAN                                                       
         L     R3,AXDATAV                                                       
         LA    R4,MAXXD            STORE UP TO 10 XDATA PER TRANSACTION         
         B     GTXD04                                                           
*                                                                               
GTXD02   XR    R1,R1                                                            
         IC    R1,XDFLN                                                         
         AR    R6,R1                                                            
GTXD04   CLI   XDFEL,0                                                          
         BE    GETXDAY                                                          
         CLI   XDFEL,XDFELQ                                                     
         BNE   GTXD02                                                           
         MVC   0(1,R2),XDFXDALN                                                 
         XR    R1,R1                                                            
         IC    R1,XDFXDALN                                                      
         LR    RE,R1                                                            
         SHI   R1,1                                                             
         MVC   1(0,R2),XDFXDATA                                                 
         EX    R1,*-6                                                           
         OC    1(0,R2),SPACES      (CAPITALIZE)                                 
         EX    R1,*-6                                                           
         AHI   R2,MAXXNL                                                        
         MVI   0(R2),X'FF'                                                      
         LR    R0,R6                                                            
         AHI   R0,XDFXDATA-XDFELD                                               
         AR    RE,R0                                                            
         CLI   XDFXEDIT,XDFEDYQ    IS IT A YES/NO FIELD                         
         BNE   GTXD08                                                           
*                                                                               
         USING ACRL2D,R1                                                        
         L     R1,AACRL2D                                                       
         CLI   1(RE),C't'       Accept 't' or Y for YES                         
         BE    *+12                                                             
         CLI   1(RE),C'Y'                                                       
         BNE   GTXD06                                                           
*                                                                               
         MVI   0(R3),3                                                          
         MVC   1(3,R3),AC@YES                                                   
         B     GTXD14                                                           
*                                                                               
GTXD06   MVI   0(R3),2                                                          
         MVC   1(2,R3),AC@NO                                                    
         B     GTXD14                                                           
         DROP  R1                                                               
*                                                                               
GTXD08   CLI   XDFXEDIT,XDFEDDQ    IS IT A DATE                                 
         BNE   GTXD10                                                           
         GOTO1 DATCON,DMCB,(X'81',1(RE)),(17,1(R3)) CONVERT DATE                
         MVC   0(1,R3),4(R1)       STORE LENGTH                                 
         B     GTXD14                                                           
*                                                                               
GTXD10   CLI   XDFXEDIT,XDFEDAQ    IS IT AN AMOUNT?                             
         BNE   GTXD12                                                           
         CURED (P6,1(RE)),(12,1(R3)),2,COMMAS=NO,ALIGN=LEFT,           +        
               MINUS=YES                                                        
         LA    RF,12               CALCULATE REAL LENGTH OF AMOUNT              
         LA    RE,12(R3)                                                        
         CLI   0(RE),C' '                                                       
         BH    *+14                                                             
         SHI   RE,1                                                             
         BCT   RF,*-12                                                          
         DC    H'0'                                                             
         STC   RF,0(R3)            STORE REAL LENGTH OF AMOUNT                  
         B     GTXD14                                                           
*                                                                               
GTXD12   MVC   0(1,R3),0(RE)                                                    
         XR    R1,R1                                                            
         IC    R1,0(,RE)                                                        
         SHI   R1,1                                                             
         MVC   1(0,R3),1(RE)                                                    
         EX    R1,*-6                                                           
         OC    1(0,R3),SPACES      (CAPITALIZE)                                 
         EX    R1,*-6                                                           
GTXD14   AHI   R3,MAXXVL                                                        
         MVI   0(R3),X'FF'                                                      
         BCT   R4,GTXD02                                                        
         DROP  R6                                                               
*                                                                               
GETXDAY  XIT1                                                                   
         SPACE 1                                                                
*&&                                                                             
**********************************************************************          
* GET BRANDOCEAN ESTIMATE STATUS                                     *          
**********************************************************************          
         SPACE 1                                                                
GTBESTA  NTR1  BASE=*,LABEL=*                                                   
         MVI   CURESTA1,0                                                       
         MVI   CURESTA2,0                                                       
         USING EGNPASD,R6                                                       
         LA    R6,IODIRKEY                                                      
         XC    EGNPAS,EGNPAS                                                    
         MVI   EGNPTYP,EGNPTYPQ                                                 
         MVI   EGNPSUB,EGNPSUBQ                                                 
         MVC   EGNPCPY,RCCOMPFL                                                 
         MVC   EGNPNUM,CURESTET                                                 
         MVC   TEMPAREA,IODIRKEY                                                
         L     R1,=AL4(IOHIGH+IOACDIR+IOAREA2)                                  
         GOTO1 AIO                                                              
         BNE   GTBESTN                                                          
*                                                                               
         L     R6,AIO2                                                          
         CLC   TEMPAREA(EGNPCLI-EGNPASD),0(R6)                                  
         BNE   GTBESTN                                                          
         MVC   CURESTA1,EGNPSTA1                                                
         MVC   CURESTA2,EGNPSTA2                                                
         B     GTBESTY                                                          
                                                                                
GTBESTN  LTR   RB,RB                                                            
         B     *+6                                                              
GTBESTY  CR    RB,RB                                                            
         DROP  R6                                                               
         XIT1                                                                   
         SPACE 1                                                                
***********************************************************************         
* Store GL account records                                                      
***********************************************************************         
         USING ACCRECD,R2                                                       
         USING STORECD,R6                                                       
STOREREC NMOD1 0,**SREC**                                                       
         L     RC,RLBASEC                                                       
         SAM31                                                                  
         LTR   R1,R1                                                            
         BNZ   STORE100                                                         
         L     R6,ASTACK           Initialize                                   
         A     R6,ATBUFLEN         Add length to find end of buffer             
         ST    R6,ASTAKEND         Save end                                     
         XC    #OFACTS,#OFACTS     Set to zero                                  
         B     STOREXIT                                                         
                                                                                
STORE100 ICM   R2,15,0(R1)         A(RECORD)                                    
         BNZ   *+6                                                              
         DC    H'00'                                                            
         L     R6,#OFACTS          Number of accounts so far                    
         LR    RF,R6                                                            
         AHI   RF,1                                                             
         ST    RF,#OFACTS                                                       
         MHI   R6,STORLNQ                                                       
         A     R6,ASTACK           A(Hi core area)                              
         MVC   STORKEY,ACCKEY      Build keys                                   
         MVC   STOFLTS,FLTRS       Save filters 1-5 to restore later            
         L     RE,ASTAKEND                                                      
         SR    RF,RF                                                            
         ICM   RF,3,ACCRLEN                                                     
         SH    RF,DATADISP         RF = Just length of record not key           
         SR    RE,RF               A(Where to store record)                     
         STCM  RE,15,STOADDR       A(Body of record)                            
         AHI   R6,STORLNQ          Check for collision                          
         CR    RE,R6               Forward pointer pass backward ptr?           
         BH    *+6                 No                                           
         DC    H'00'               Yes, so filled up area, increase             
                                                                                
         ST    RE,ASTAKEND         Set new location                             
         LR    R1,RF               Length to move                               
         LR    R0,R2                                                            
         AH    R0,DATADISP         A(Elements)                                  
         MVCL  RE,R0                                                            
                                                                                
STOREXIT SAM24                                                                  
         XIT1                                                                   
                                                                                
ASTAKEND DS    A                                                                
         LTORG                                                                  
                                                                                
         TITLE 'Trace modes'                                                    
***********************************************************************         
* Show time spent in each mode                                                  
***********************************************************************         
         USING ACWORKD,RC                                                       
         USING ACMD,R4                                                          
MYTRACE  NMOD1 0,**TRCE**                                                       
         L     RC,RLBASEC                                                       
         ZIC   RF,MODE                                                          
         LA    R0,TIMEQ            NUBMER OF ENTRIES                            
         L     R4,AMONACC                                                       
*                                                                               
         USING TIMED,R3                                                         
         L     R3,=A(TIMETAB)                                                   
MYTRC050 CLC   MODE,TIMEMODE                                                    
         BE    MYTRC060                                                         
         LA    R3,TIMELNQ(,R3)     NEXT ENTRY                                   
         BCT   R0,MYTRC050                                                      
                                                                                
MYTRC060 MVC   MODETAG,TIMETAG                                                  
         DROP  R3                                                               
*                                                                               
         LA    R2,THEMODE                                                       
         CVD   RF,DUB                                                           
         OI    DUB+L'DUB-1,X'0F'                                                
         UNPK  MODE#,DUB                                                        
                                                                                
         ICM   R2,15,ACMABUF                                                    
         BNZ   *+8                                                              
         L     R2,ADACC                                                         
                                                                                
         LA    RF,MODEQ                                                         
         GOTO1 =V(PRNTBL),DMCB,((RF),THEMODE),(R2),C'DUMP',42,=C'1D'            
         XIT1                                                                   
         DROP  R4                                                               
         EJECT ,                                                                
THEMODE  DC   C'MODE='                                                          
MODE#    DC   C'000'                                                            
         DC   C' '                                                              
MODETAG  DC   CL7' '                                                            
MODEQ    EQU  *-THEMODE                                                         
         LTORG                                                                  
         TITLE 'Load Phase 03-07'                                               
***********************************************************************         
* LOAD - ACREPRL03 -- Initialization phase                            *         
*        ACREPRL04 -- Print report   phase                            *         
*        ACREPRL05 -- Table          phase                            *         
*        ACREPRL06 -- Common routine phase                            *         
*        ACREPRL07 -- Print details  phase (optional)                 *         
***********************************************************************         
         SPACE 1                                                                
         USING ACWORKD,RC                                                       
         USING ACRLD,RA                                                         
         USING MASTD,R6                                                         
         USING PHASED,R2                                                        
LOADPROG NMOD1 0,**LOAD**                                                       
         L     RC,RLBASEC                                                       
         L     R6,ADMASTC                                                       
         L     R2,=A(PHASETAB)     Load phases 03,04,05,06                      
         USING COMFACSD,R3                                                      
         L     R3,ADCOMFAC                                                      
*                                                                               
         CLI   MODE,0              DDLINK CALL                                  
         BNE   LOADPG05                                                         
         USING ACMD,RF                                                          
         USING LP_D,R1                                                          
LOADPG02 L     RF,AMONACC                                                       
         L     R1,ACMALP_D                                                      
         L     RE,LP_ATSAR                                                      
         ST    RE,TSARDINE                                                      
         L     RE,LP_ACOM                                                       
         MVC   SECRET,CSECRET-COMFACSD(RE)                                      
         DROP  R1,RF                                                            
*                                                                               
         CLI   0(R2),EOT           End of loads                                 
         BE    LOADPXIT            Yes                                          
         GOTOR CCALLOV,DMCB,0,(C'E',PHASE_NM)                                   
         L     RE,PHASE_RT                                                      
         AR    RE,RA               Add base of ACRL DSECT                       
         OC    0(4,RE),0(R1)                                                    
         BNZ   *+6                                                              
         DC    H'00'                                                            
         LA    R2,PHASELNQ(,R2)    Bump to next phsae                           
         B     LOADPG02                                                         
         DROP  R3                                                               
*                                                                               
LOADPG05 CLI   MODE,RUNFRST        Load main phases at RUN FIRST                
         BNE   LOADPG40                                                         
*                                                                               
LOADPG10 MVC   DUB,PHASE_NM                                                     
         MVC   DUB+6(1),MCTEST2    Test phase ?                                 
         OI    DUB+6,X'40'         Make upper case                              
         GOTO1 LOADER,DMCB,DUB,0,0                                              
         ICM   RF,15,DMCB+4        Is it OK ?                                   
         BNZ   LOADPG20            Yes a test phase                             
         MVC   DUB,PHASE_NM                                                     
         GOTO1 LOADER,DMCB,DUB,0,0                                              
         ICM   RF,15,DMCB+4        Is it OK ?                                   
         BNZ   *+6                 Non-test phase                               
         DC    H'0'                                                             
*                                                                               
LOADPG20 L     RE,PHASE_RT                                                      
         AR    RE,RA               Add base of ACRL DSECT                       
         ST    RF,0(,RE)           Save off phase begining at address           
         OC    MCUSRDMP,MCUSRDMP                                                
         BNZ   *+8                                                              
         ST    RF,MCUSRDMP         Initialize start of dump                     
         C     RF,MCUSRDMP         Check begining                               
         BNL   *+8                                                              
         ST    RF,MCUSRDMP         Save new start                               
         A     RF,DMCB             Lenght of phase + RF=(Phase start)           
         C     RF,MCUSRDMP+4       Check end                                    
         BNH   *+8                                                              
         ST    RF,MCUSRDMP+4       Save new end                                 
*                                                                               
         LA    R2,PHASELNQ(,R2)    Bump to next phsae                           
         CLI   0(R2),EOT           EOT ?                                        
         BNE   LOADPG10                                                         
*                                                                               
         MVC   DUB,SPACES          This is done for Scribe only                 
         MVC   DUB(4),=C'T00A'     Not DDLink calls                             
         MVI   WORK,QTSAR                                                       
         GOTO1 HEXOUT,DMCB,WORK,DUB+4,1                                         
         GOTOR LOADER,DMCB,DUB,0,0                                              
         BE    *+6                                                              
         DC    H'0'                                                             
         MVC   TSARDINE,4(R1)      Set A(TSARDINE)                              
*                                                                               
         MVC   UPSI,MCUPSI                                                      
         MVC   MCAPHAS3,FRMTBLD    PATCH=03 phase works for RL03                
         MVC   MCAPHAS4,PRINTREP   PATCH=04 phase works for RL04                
         TM    UPSI,UPSIPT56                                                    
         BZ    LOADPG40                                                         
         MVC   MCAPHAS3,TABINIT    PATCH=03 phase works for RL05                
         MVC   MCAPHAS4,ROUTINE    PATCH=04 phsae works for RL06                
*                                                                               
LOADPG40 DS    0H                                                               
         CLI   MODE,REQFRST        Load report extra detials in needed          
         BNE   LOADPXIT                                                         
         OC    RQPRINT,RQPRINT     Was this already loaded ?                    
         BNZ   LOADPXIT            Yes                                          
         CLI   QOPT8,YES           No, so do we need it ?                       
         BE    LOADPG42                                                         
         CLI   QOPT8,ONLY          No, so do we need it ?                       
         BNE   LOADPXIT                                                         
*                                                                               
LOADPG42 MVC   DUB,=CL8'ACRL07'                                                 
         MVC   DUB+6(1),MCTEST2    Test phase ?                                 
         OI    DUB+6,X'40'         Make upper case                              
         GOTO1 LOADER,DMCB,DUB,0,0                                              
         ICM   RF,15,DMCB+4        Is it OK ?                                   
         BNZ   LOADPG50            Yes a test phase                             
         MVC   DUB,=CL8'ACRL07'    Try normal phase then                        
         GOTO1 LOADER,DMCB,DUB,0,0                                              
         ICM   RF,15,DMCB+4        Is it OK ?                                   
         BNZ   *+6                 Non-test phase                               
         DC    H'0'                                                             
                                                                                
LOADPG50 ST    RF,RQPRINT          Save address of modual                       
*                                                                               
LOADPXIT XIT1                                                                   
         DROP  R2,R6                                                            
         SPACE 3                                                                
         LTORG                                                                  
***********************************************************************         
*  ELIMINATE CERTAIN CBIL TRANSFERS AND WRITE-OFFS                    *         
***********************************************************************         
         SPACE 1                                                                
         USING ACRLD,RA                                                         
         USING ACWORKD,RC                                                       
         USING PG$GEN,R2                                                        
         USING FMTRECD,R5                                                       
FLTPROD  NMOD1 0,**FTPRD*                                                       
         L     RC,RLBASEC                                                       
         MVI   BYTE,NO                                                          
         L     R2,PRORATA1                                                      
         TM    PG$STAT,PG$OLDA     OLD X'4B'                                    
         BZ    FLTPRD10                                                         
         MVI   BYTE,YES                                                         
*                                                                               
         USING PXDELD,R2                                                        
FLTPRD10 CLI   REALTYP,57          WRITE-OFFS ARE CONSIDERED MARKED             
         BE    FLTPRD20            BRANCH AS MARKED ON                          
         CLI   REALTYP,14          WRITE-OFFS ARE CONSIDERED MARKED             
         BE    FLTPRD20                                                         
         CLI   REALTYP,34          TRANSFERS, CHECK "FROM" OR "TO"              
         BNE   FLTPRD15                                                         
         ICM   R2,15,AELEM4E       TRANSFER DETAIL ELEMENT X'4E'                
         BZ    FLTPRD15                                                         
         CLI   PXDTYPE,PXDTTO      MARKED IF "TO" TYPE                          
         BE    FLTPRD20            BRANCH AS MARKED ON                          
FLTPRD15 TM    FMTROPT4,RPFOCWOT   ONLY ALLOC. WRITE-OFF /TRANSFERS             
         BO    FLTPRDN                                                          
         B     FLTPRD30                                                         
*                                                                               
FLTPRD20 CLI   BYTE,YES            FORGET ABOUT IT                              
         BE    FLTPRD30                                                         
         TM    FMTROPT4,RPFXCWOT   EXCLUDE ALLOC WRITE-OFF / TRANSFERS          
         BO    FLTPRDN                                                          
         DROP  R2                                                               
*                                                                               
         USING PG$GEN,R2                                                        
FLTPRD30 LA    R0,UTILTABX         NUMBER OF ENTRIES                            
         L     R1,=A(UTILTAB)                                                   
         L     R2,PRORATA1                                                      
         CLI   GPTRAN,GPTRNCR      IS IT A CREDIT?                              
         BNE   FLTPRD35                                                         
         OI    PG$STAT3,PG$BILUP+PG$FULUT                                       
         TM    CURIND,CURBILCR     IS IT BILLED?                                
         BO    *+8                 DON'T WORRY ABOUT CREDITS                    
         NI    PG$STAT3,TURNOFF-(PG$BILUP+PG$FULUT)                             
*                                                                               
FLTPRD35 CLC   BLTRNOPT,0(R1)      MATCH OPTION ON TABLE ENTRY                  
         BE    FLTPRD40                                                         
         LA    R1,5(,R1)                                                        
         BCT   R0,FLTPRD35                                                      
         DC    H'00'               NO MATCH FOUND                               
*                                                                               
FLTPRD40 SR    RE,RE                                                            
         SR    RF,RF                                                            
         ICM   RE,1,1(R1)          GET TEST BITS                                
         BZ    FLTPRD50            NOTHING TO TEST                              
         IC    RF,2(,R1)           GET BRANCH CONDITION                         
         EX    RE,PRCPTEST         TM PG$STAT3                                  
         EX    RF,PRCPBRCH         BRANCH EXIT                                  
         ICM   RE,1,3(R1)          GET TEST BITS                                
         BZ    FLTPRD50            NOTHING TO TEST                              
         IC    RF,4(,R1)           GET BRANCH CONDITION                         
         EX    RE,PRCPTEST         TM PG$STAT3                                  
         EX    RF,PRCPBRCH         BRANCH EXIT                                  
         B     FLTPRD50                                                         
*                                                                               
PRCPBRCH BC    0,FLTPRDN                                                        
PRCPTEST TM    PG$STAT3,0                                                       
*                                                                               
         USING TRNRECD,R2                                                       
FLTPRD50 L     R2,ADTRANS                                                       
         SH    R2,DATADISP                                                      
         CLC   TRNKWORK,=C'**'     Is it a purchase order?                      
         BNE   FLTPRD55            No                                           
         TM    FMTROPT5,RPFMRGPO   Merge PO workcodes in                        
         BZ    FLTPRD52                                                         
         OI    POIND,POITRN        Mark as PO                                   
         GOTO1 PARSE,DMCB,GETPOWC,CURWKCD,0                                     
         TM    RECREAD2,RECPORD                                                 
         BZ    FLTPRD55                                                         
         GOTO1 GETPO,DMCB,TRNKREF,CURWKCD                                       
         B     FLTPRD55                                                         
*                                                                               
FLTPRD52 CLC   CURWKCD,=C'**'                                                   
         BE    FLTPRD90                                                         
         MVC   CURWKCD,TRNKWORK                                                 
*                                                                               
FLTPRD55 GOTO1 =A(SETWKCD)         SET, ADD FILTER WORKCODE INFO                
         BNE   FLTPRDN                                                          
         GOTO1 AFILTER,DMCB,AFLTWC,CURWKCD                                      
         BNE   FLTPRDN                                                          
*                                                                               
FLTPRD90 DS    0H                                                               
*&&UK*&& GOTO1 AFILTER,DMCB,AFLTAUTH,CURAUTH2                                   
*&&UK*&& BNE   FLTPRDN                                                          
*&&US                                                                           
         TM    DATEFLT,DATEXMT     TRANSMIT DATE FILTERING?                     
         BZ    FLTPRD99            NO - SKIP FILTERING                          
*                                                                               
         USING GDAELD,R4                                                        
         L     R4,ADTRANS                                                       
         XC    STMTDTE,STMTDTE     CLEAR DATE                                   
FLTPRD91 CLI   0(R4),0             NO 'E5' GDALED                               
         BE    FLTPRD94                                                         
         CLI   0(R4),GDAELQ                                                     
         BNE   FLTPRD92                                                         
         CLI   GDATYPE,GDATEDI                                                  
         BE    FLTPRD93                                                         
FLTPRD92 ZIC   R1,1(,R4)                                                        
         AR    R4,R1                                                            
         B     FLTPRD91                                                         
*                                                                               
FLTPRD93 MVC   STMTDTE,GDADATE                                                  
         DROP  R4                                                               
*                                                                               
FLTPRD94 OC    ALTNSTR,ALTNSTR     ANY START DATE SPECIFIED                     
         BZ    FLTPRD95            SKIP TO END DATE FILTERING                   
         OC    STMTDTE,STMTDTE     DO I HAVE A TRANSMIT DATE                    
         BZ    FLTPRDN        ??   IF NONE EXCLUDE TRANSACTION                  
         CLC   ALTNSTR,STMTDTE     COMPARE TRANSMIT DATE TO REQ                 
         BH    FLTPRDN             PARAMETERS                                   
*                                                                               
FLTPRD95 OC    ALTNEND,ALTNEND     ANY END DATE SPECIFIED                       
         BZ    FLTPRD99            EXIT TRANSMIT DATE FILTERING                 
         OC    STMTDTE,STMTDTE     DO I HAVE A TRANSMIT DATE                    
         BZ    FLTPRDN        ??   IF NONE EXCLUDE TRANSACTION                  
         CLC   ALTNEND,STMTDTE     COMPARE TRANSMIT DATE TO REQ                 
         BL    FLTPRDN             PARAMETERS                                   
*&&                                                                             
FLTPRD99 CR    RB,RB                                                            
         B     *+6                                                              
FLTPRDN  LTR   RB,RB                                                            
         XIT1                                                                   
         DROP  R2                                                               
         EJECT                                                                  
         TITLE 'Split - create multiple records for multiple elements'          
***********************************************************************         
* HANDLE MULTIPLE ELEMENTS BY SPLITING THE RECORD                     *         
* NOTE - SPLITMLT INDICATION, WE WOULD SKIP SPLITING RECORD IF THE    *         
*        1ST PTA NEVER GOT PROCESSED. THIS WOULD OCCUR IF THE DATE    *         
*        RANGE OF THE 1ST PTA WAS NOT WITHIN ANY COLUMN DATE RANGE.   *         
*        NOW ALWAYS SPLIT IF MORE THAN ONE PTA ON TRANSACTION.        *         
***********************************************************************         
         USING ACWORKD,RC                                                       
         USING ACRLD,RA                                                         
         USING FMTRECD,R5                                                       
SPLITUP  NMOD1 0,**SPIT**                                                       
         L     RC,RLBASEC                                                       
         TM    UPSI,UPSISPTR                                                    
         BZ    SPLITUP0                                                         
         LH    R2,FMT#TRNS                                                      
         BCTR  R2,0                                                             
         MH    R2,SRTRECLN                                                      
         A     R2,FMTSRTWK         A(SORTAREA CURRENT RECORD)                   
         MVC   WORK(10),=C' 1st Rec #'                                          
         MVC   WORK+9(1),FMT#TRNS+1                                             
         OI    WORK+9,X'F0'                                                     
         LH    R0,SRTRECLN                                                      
         GOTO1 PRNTBL,DMCB,(10,WORK),(R2),C'DUMP',(R0),=C'1D'                   
*        LH    R0,PAYBUK#                                                       
*        MHI   R0,PHSLNQ                                                        
*        GOTO1 PRNTBL,DMCB,=C'PAYEM',APAYRTES,C'DUMP',(R0),=C'1D'               
*                                                                               
SPLITUP0 TM    RECREAD3,RECPOAP    Reporting PO approver info?                  
         BZ    SPLITUP2                                                         
         GOTO1 ASEED,SEEDPOA                                                    
SPLITUP2 TM    SPLITSW,SPLITMLT    DEAL WITH SPLIT DATA ?                       
         BZ    *+8                 SUBTIL CASE WHERE NEED TO PROCESS            
         OI    SPLITIND,SPLITDAT   FORCE TO PROCESS SPLIT DATA                  
         TM    SPLITIND,SPLITDAT   DEAL WITH SPLIT DATA ?                       
         BZ    SPLIT94             NO                                           
         CLI   FORMAT#+1,1         ONLY ONE FORMAT TO PROCESS ?                 
         BE    SPLIT               YES, SO DON'T BOTHER TO MAKE COPY            
*                                                                               
SPLITUP5 TM    SPLITSW,SPLITCPY    Did I make a copy already ?                  
         BO    SPLIT               Yes                                          
         CLI   MODE,PROCTIME                                                    
         BE    SPLIT                                                            
         OI    SPLITSW,SPLITCPY+SPLITRST                                        
*                                                                               
         L     RE,APTAWRK          PTAEL work area                              
         L     R0,PTABASE           copy for recaps                             
         LHI   R1,IOSIZEQ           length of PTAWRK                            
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
*                                                                               
         USING TRNRECD,RE                                                       
         L     RE,ADTRANS          Save transaction                             
         SH    RE,DATADISP                                                      
         L     R0,ASAVTRNS                                                      
         SR    R1,R1                                                            
         ICM   R1,3,TRNRLEN                                                     
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
         DROP  RE                                                               
*                                                                               
SPLIT    TM    SPLITIND,SPLIT77    PROCESS ONE X'77' AT A TIME?                 
         BZ    SPLIT12             NO, NO NEED                                  
*                                                                               
         USING PTAELD,R2                                                        
         TM    RECREAD2,RECPRCV    CashFlow receivable keywords?                
         BZ    SPLIT05               No                                         
         ICM   R2,15,AELEM77B      Bill information?                            
         BZ    SPLIT05               No, don't bother                           
         ICM   R3,15,AELEM99         Did we process a cashflow elem. ?          
         BZ    SPLIT05               No                                         
         MVI   0(R3),X'FF'           Yes mark deleted                           
         XC    AELEM99,AELEM99                                                  
         BRAS  RE,SETCFELM         Set AELEM99                                  
         ICM   R3,15,AELEM99       Was one found ?                              
         BZ    SPLIT05             No                                           
         ZAP   PTANET,PKZERO       Clear. Don't post more than once             
         ZAP   PTARCOM,PKZERO        the X'77' numbers                          
         B     SPLIT07             This will reprocesses the x'77'              
*                                                                               
SPLIT05  NI    CURIND,TURNOFF-CURBILPD                                          
         OC    AELEM77B(12),AELEM77B                                            
         BZ    SPLIT12                                                          
         ICM   R2,15,AELEM77B      BILLED                                       
         BZ    *+14                                                             
         MVI   0(R2),X'FF'         ALREADY PROCESSED SO DELETE                  
         XC    BILLDTE(5),BILLDTE                                               
                                                                                
SPLIT07  ICM   R2,15,AELEM77T      TRANSFERED                                   
         BZ    *+14                                                             
         MVI   0(R2),X'FF'         ALREADY PROCESSED SO DELETE                  
         XC    TRFRDTE(5),TRFRDTE                                               
                                                                                
         ICM   R2,15,AELEM77W      WRITE-OFF                                    
         BZ    *+14                                                             
         MVI   0(R2),X'FF'         ALREADY PROCESSED SO DELETE                  
         XC    WROFDTE(5),WROFDTE                                               
                                                                                
         SR    R1,R1                                                            
         XC    AELEM77B(12),AELEM77B                                            
*                                                                               
         BRAS  RE,PTADATA          Set AELEM77's                                
         BRAS  RE,SETCFELM         Set AELEM99                                  
         OC    AELEM77B(12),AELEM77B                                            
         BZ    *+8                                                              
         OI    SPLITIND,SPLITDAT   FORCE TO SPLIT                               
*                                                                               
SPLIT12  TM    SPLITIND,SPLITDAT   IS THERE DATA TO SPLIT?                      
         BZ    SPLIT94                                                          
         OI    POSTLVL,POSTSPLT   SELECTED MODE FOR PARSE ROUTINE               
         NI    SPLITIND,TURNOFF-(SPLITDAT+SPLITREC)                             
*                                                                               
         LA    R0,MAXDELEL         Elements to mark deleted                     
         L     R2,FMTDELEL         Delete element pool                          
SPLIT15  ICM   R4,15,0(R2)         R4 = A(ELEMENT TO MARK)                      
         BZ    SPLIT20             None left to mark, so process                
         TM    RECREAD2,RECPRCV    CashFlow Receivable Keywords?                
         BZ    SPLIT18              No                                          
         CLI   0(R4),PTAELQ         Yes, decide later on x'77's                 
         BNE   SPLIT18                                                          
         CLI   PTATYPE-PTAEL(R4),PTATRAL     Allocated To Bill                  
         BE    SPLIT19                                                          
*                                                                               
SPLIT18  MVI   0(R4),X'FF'         Mark deleted                                 
SPLIT19  XC    0(4,R2),0(R2)       Clear entry                                  
         LA    R2,4(,R2)           Next element address stored                  
         BCT   R0,SPLIT15          Check next                                   
*                                                                               
SPLIT20  DS    0H                                                               
*&&US                                                                           
         USING SCIELD,RE                                                        
         ICM   RE,15,AELEM50T      Tax (QST or HST) - split & multiple          
         BZ    SPLIT23             None                                         
         XC    AELEM50T,AELEM50T                                                
         CLI   0(RE),X'FF'         Marked for deletion ?                        
         BNE   SPLIT23             No                                           
         SR    RF,RF                                                            
SPLIT21  CLI   0(RE),EOR                                                        
         BE    SPLIT23                                                          
         CLI   0(RE),SCIELQ        X'50'                                        
         BNE   SPLIT22                                                          
         CLI   SCITYPE,SCITTQST    One we want?                                 
         BNE   SPLIT22                                                          
         ST    RE,AELEM50T         Save off new element                         
         B     SPLIT23                                                          
         DROP  RE                                                               
                                                                                
SPLIT22  IC    RF,1(,RE)                                                        
         AR    RE,RF                                                            
         B     SPLIT21                                                          
*&&                                                                             
SPLIT23  TM    FMTROPT5,RPFMRGPO   MERGE PO WORKCODES IN                        
         BZ    SPLIT24                                                          
         TM    POIND,POITRN        Is it a WC=** (Purchase order)               
         BZ    SPLIT24             No                                           
         TM    RECREAD2,RECPORD                                                 
         BZ    SPLIT24                                                          
         GOTO1 PARSE,DMCB,GETPOWC,CURWKCD,0                                     
         BNE   SPLIT24                                                          
         GOTO1 GETPO,DMCB,CURPODET,CURWKCD                                      
         GOTO1 =A(SETWKCD)                                                      
         BNE   SPLIT                                                            
*                                                                               
SPLIT24  TM    PHISIND,PHISON      Process history record data ?                
         BZ    SPLIT25             No need to process                           
         TM    THRSW,THRLST        Processing in ACCLST ?                       
         BO    SPLIT25             Yes                                          
         GOTOR ASETPAY,0                                                        
         OI    ACTIVITY,ACTPAYR    Processed payroll data                       
*                                                                               
SPLIT25  LH    R6,FMT#TRNS         Number of transaction so far                 
         LR    RE,R6                                                            
         BCTR  RE,0                                                             
         MH    RE,SRTRECLN                                                      
         A     RE,FMTSRTWK         A(SORTAREA CURRENT RECORD)                   
         LR    R2,RE               R2 = A(COPIED RECORD)                        
         TM    SPLITIND,SPLITROW                                                
         BZ    SPLIT70                                                          
         AHI   R6,1                INCREASE BY ONE TO COPY RECORD               
         STH   R6,FMT#TRNS         POSSIBLE NEW NUMBER OF TRANS RECS            
         LH    RF,SRTRECLN                                                      
         LR    R1,RF                                                            
         LR    R0,RE                                                            
         AH    RE,SRTRECLN         BUMP TO NEW LOCATION FOR RECORD              
         LR    R2,RE               R2 = A(COPIED RECORD)                        
         MVCL  RE,R0               COPY RECORD                                  
*                                                                               
         USING COLD,R3                                                          
         SR    R0,R0                                                            
         IC    R0,FMT#COLS         Number of columns to ZAP or not              
         L     R3,FMTCOL                                                        
SPLIT33  TM    COLFLAGS,COLAMT     Must be an amount column                     
         BZ    SPLIT36                                                          
         TM    COLFLAGS,COLSPLT    Data can be multiple                         
         BO    SPLIT35             Wipe out data, could be new data             
         TM    COLOPT2,COLFCPRT    Copy down feature on ?                       
         BO    SPLIT36             Yes, leave data intact                       
*                                                                               
SPLIT35  LH    RE,COLDSP                                                        
         AR    RE,R2               Point to accum                               
         ZAP   0(PKLEN,RE),PKZERO  Clear out accum                              
*                                                                               
SPLIT36  AHI   R3,COLLNQ           Next column                                  
         BCT   R0,SPLIT33                                                       
         DROP  R3                                                               
*                                                                               
         USING ROWD,R3                                                          
         USING KYWD,R6                                                          
         TM    UPSI,UPSISPTR                                                    
         BZ    SPLIT44                                                          
         LH    R0,SRTRECLN                                                      
         GOTO1 PRNTBL,DMCB,=C' Before ',(R2),C'DUMP',(R0),=C'1D'                
*        LH    R0,PAYBUK#                                                       
*        MHI   R0,PHSLNQ                                                        
*        GOTO1 PRNTBL,DMCB,=C'PAYEM',APAYRTES,C'DUMP',(R0),=C'1D'               
*                                                                               
SPLIT44  L     R3,FMTROW                                                        
         IC    R0,FMT#ROWS                                                      
SPLIT45  OI    SPLITSW,SPLITROK    Set splitting row is okay                    
         TM    ROWKYIND,ROWKYSPL   Row is splitable?                            
         BZ    SPLIT46             No                                           
         TM    ROWKYIND,ROWKYSDR   Split Debits only?                           
         BZ    SPLIT47             No, split it all                             
         TM    TRNSSTAT,TRNSDR     Yes, so is this a Debit?                     
         BO    SPLIT47             Yes, okay to split                           
SPLIT46  NI    SPLITSW,TURNOFF-SPLITROK    Don't really split then              
*                                                                               
SPLIT47  L     R6,ROWINDEX         R6 = A(KEYWORD)                              
         XC    @REPLNME,@REPLNME                                                
         TM    ROWXPIND,ROWNOSRT                                                
         BO    SPLIT65                                                          
         SR    R1,R1                                                            
         ICM   R1,3,ROWKYSZ        Size of the field to clear                   
         BZ    SPLIT65                                                          
         LH    R4,ROWKYDSP                                                      
         AR    R4,R2               Add begining of record                       
         TM    SPLITSW,SPLITROK                                                 
         BZ    SPLIT48             Not really okay, so skip clear               
         TM    ROWXPIND,ROWRATE                                                 
         BO    SPLIT48             If rate don't clear                          
         LR    RE,R4                                                            
         LR    RF,R1               Clear data                                   
         XCEFL                                                                  
         ICM   R1,3,ROWKYSZ        Re-instate size of field to clear            
*                                                                               
SPLIT48  TM    RECAPSW,RECAPON     Recapping?                                   
         BZ    SPLIT49             No                                           
         TM    FMTRCAP,FMTRSEP     Recaps are separate ?                        
         BO    SPLIT49             Separate so don't bother                     
         LA    RF,0(R1,R4)         End of data                                  
         BCTR  RF,0                                                             
         MVC   0(1,RF),FMTNUM      Set as default of next row                   
         CLI   FMTMRGE#,0                                                       
         BE    *+10                                                             
         MVC   0(1,RF),FMTMRGE#    Over-ride, mergering of reports              
                                                                                
SPLIT49  SHI   R1,2                                                             
         BNM   SPLIT51             Must have been > 1                           
         LR    RF,R4                                                            
         BCTR  RF,0                                                             
         MVC   0(1,RF),ROWRECAP    Just move in recap #                         
         LTR   R1,R1                                                            
         BZ    SPLIT65                                                          
                                                                                
SPLIT51  TM    SPLITSW,SPLITROK    Okay to split ?                              
         BZ    SPLIT55             No                                           
         MVI   BYTE,0                                                           
         SR    RE,RE                                                            
         ICM   RE,3,KYWPRSE                                                     
         BZ    SPLIT55                                                          
         TM    ROWKYIND,ROWKYCDE+ROWKYLVL                                       
         BNO   SPLIT52                                                          
         MVI   BYTE,PARDLVL                                                     
         ICM   R4,8,KYWLVLQ                                                     
*                                                                               
SPLIT52  A     RE,PRSBASE                                                       
         ST    R3,ACURROW                                                       
         OC    ROWCON,ROWCON       Size may not be what it was                  
         BZ    *+8                                                              
         OI    BYTE,PARREPL                                                     
                                                                                
         GOTO1 PARSE,DMCB,(BYTE,(RE)),(R4),ROWFILT,(R6)                         
         BNE   SPLIT55                                                          
*&&US                                                                           
         TM    ROWDAIND,ROWXCOL    Hide column and keep data out of             
         BZ    SPLIT53             sort record?                                 
         LH    RF,ROWKYDSP                                                      
         AR    RF,R2                                                            
         ICM   R1,3,ROWKYSZ                                                     
         BZ    SPLIT53                                                          
         SHI   R1,1                                                             
         BM    SPLIT53                                                          
         EXXC  R1,0(RF),0(RF)      WIPE OUT DATA                                
*&&                                                                             
SPLIT53  TM    SPLITIND,SPLITDAT   Was new data found?                          
         BZ    SPLIT55             No                                           
         OI    SPLITIND,SPLITREC   Yes                                          
*                                                                               
SPLIT55  CLI   ROWNUM,1                                                         
         BE    SPLIT56             Skip first row                               
         LR    RF,R4                                                            
         BCTR  RF,0                                                             
         MVC   0(1,RF),ROWRECAP                                                 
         CLI   ROWRECAP,0          Any recap ?                                  
         BE    SPLIT56                                                          
         CLI   FMTMRGE#,0          Special recap value                          
         BE    SPLIT56                                                          
         MVC   0(1,RF),FMTMRGE#    Over-ride, mergering of reports              
                                                                                
SPLIT56  TM    SPLITSW,SPLITROK    Continue                                     
         BZ    SPLIT65             No                                           
         SR    R1,R1                                                            
         ICM   R1,3,KYWLINK        Point to name or code alternate              
         BZ    SPLIT65             None so skip                                 
         LR    R6,R1                                                            
         A     R6,KYWBASE          Alternate keyword                            
         LH    R4,ROWDADSP                                                      
         AR    R4,R2               Point to entry point                         
         SR    R1,R1                                                            
         ICM   R1,1,ROWDASZ        Length of data                               
         BZ    SPLIT65             No length                                    
         BCTR  R1,0                                                             
         EXXC  R1,0(R4),0(R4)      Clear area to get data to                    
                                                                                
         ICM   RE,15,@REPLNME      Set when called PARSE in REPLACE rtn         
         BZ    SPLIT58                                                          
         LLC   RF,0(,RE)           Get length of data                           
         BCTR  RF,0                                                             
         CR    RF,R1                                                            
         BL    *+6                                                              
         LR    RF,R1                                                            
         EXMVC RF,0(R4),1(RE)      New data from rtn replace                    
         B     SPLIT63                                                          
*                                                                               
SPLIT58  SR    RE,RE                                                            
         SR    RF,RF                                                            
         ICM   RE,3,KYWPRSE                                                     
         BZ    SPLIT65                                                          
         TM    ROWDAIND,ROWDACDE+ROWDALVL                                       
         BNO   SPLIT62                                                          
         LA    RF,PARDLVL                                                       
         ICM   R4,8,KYWLVLQ                                                     
*                                                                               
SPLIT62  A     RE,PRSBASE                                                       
         ST    R3,ACURROW                                                       
         GOTO1 PARSE,DMCB,((RF),(RE)),(R4),ROWFILT,(R6)                         
         BNE   SPLIT65                                                          
                                                                                
SPLIT63  TM    SPLITIND,SPLITDAT   Was new data found?                          
         BZ    SPLIT65             No                                           
         OI    SPLITIND,SPLITREC                                                
*                                                                               
SPLIT65  AHI   R3,ROWLNQ           BUMP TO NEXT ROW                             
         BCT   R0,SPLIT45                                                       
*                                                                               
         TM    SPLITIND,SPLITREC   DID I REALLY NEED TO SPLIT?                  
         BZ    SPLIT68                                                          
         TM    RECREAD3,RECPOAP    Reporting PO approver info?                  
         BZ    SPLIT70                                                          
         CLI   FMT#ACMS,0          ANY ACCUMS?                                  
         BNZ   SPLIT70             YES SO DONT CALL SEED RTN UNTIL AMTS         
         GOTO1 ASEED,SEEDPOA       ARE FILLED IN                                
         B     SPLIT70                                                          
SPLIT68  SH    R2,SRTRECLN         NO SO POINT BACK TO ORIGINAL REC             
         LH    R6,FMT#TRNS         BACK OUT BY ONE                              
         BCTR  R6,0                DECREASE BY ONE TO COPY RECORD               
         STH   R6,FMT#TRNS         POSSIBLE NEW NUMBER OF TRANS RECS            
*                                                                               
         USING COLD,R3                                                          
SPLIT70  TM    SPLITIND,SPLITCOL                                                
         BZ    SPLIT               TRY SPLITTING AGAIN                          
         CLI   FMT#ACMS,0          ANY ACCUMS?                                  
         BZ    SPLIT               TRY SPLITTING AGAIN                          
*                                                                               
         SR    R0,R0                                                            
         IC    R0,FMT#COLS         NUMBER OF COLUMNS                            
         L     R3,FMTCOL           A(COLUMN TABLE)                              
         XC    ACURCOL,ACURCOL                                                  
         OI    FMTFLAG2,FMTNOCB    SET, ASSUME ALL COLS ARE ZERO                
SPLIT74  TM    COLFLAGS,COLSPLT    GET THIS AMOUNT                              
         BZ    SPLIT85                                                          
*                                                                               
         USING FLTADRD,R4                                                       
         ICM   R4,15,COLFLTS                                                    
         BZ    SPLIT78                                                          
SPLIT76  CLI   FLTFLAG,EOT                                                      
         BE    SPLIT78                                                          
         GOTO1 AFILTER,DMCB,FLTADDR,FLTDATA                                     
         BNE   SPLIT85                                                          
         AHI   R4,FLTADRLQ                                                      
         B     SPLIT76                                                          
         DROP  R4                                                               
*                                                                               
SPLIT78  ST    R3,ACURCOL                                                       
         TM    COLOPT2,COLDSKIP    DON'T CHECK DATES                            
         BO    SPLIT80                                                          
         L     RE,COLDATE          ADDRESS OF DATE TO COMPARE TO                
         CLC   COLEND,0(RE)        IF >= THEN PASSED, CHECK START DATES         
         BL    SPLIT85             ELSE DATA DOES NOT GO IN THIS COL            
         CLC   COLSTART,0(RE)      IF <= THEN PASSED, PUT AMT IN COL            
         BH    SPLIT85             ELSE DATA DOES NOT GO IN THIS COL            
*                                  PUT DATA IN COLUMN                           
SPLIT80  L     R6,COLINDEX         R6 = A(KEYWORD IN TABLE)                     
         SR    RE,RE                                                            
         ICM   RE,3,KYWPRSE                                                     
         BZ    SPLIT85                                                          
         A     RE,PRSBASE                                                       
         LR    R4,R2                                                            
         AH    R4,COLDSP           POINT TO COLUMN DATA                         
         ZAP   PACKAMT,PKZERO                                                   
         GOTO1 PARSE,DMCB,(RE),PACKAMT,COLFILT,(R6)                             
         AP    0(PKLEN,R4),PACKAMT                                              
         TM    COLOPT,COLCZERO     IS CHECK FOR ZERO COL ON ?                   
         BO    SPLIT85             YES, ACTUALLY ON MEANS OFF                   
         CP    0(PKLEN,R4),PKZERO  CHECK FOR ZERO AMOUNT                        
         BE    SPLIT85                   YES                                    
         NI    FMTFLAG2,TURNOFF-FMTNOCB  FOUND COLUMN WITH AMOUNT               
*                                                                               
SPLIT85  AHI   R3,COLLNQ                                                        
         BCT   R0,SPLIT74                                                       
*                                                                               
         TM    SPLITIND,SPLITREC   DID I REALLY NEED TO SPLIT?                  
         BZ    SPLIT86             YES                                          
         TM    RECREAD3,RECPOAP    Reporting PO approver info?                  
         BZ    SPLIT86                                                          
         GOTO1 ASEED,SEEDPOA                                                    
         XC    ACURCOL,ACURCOL                                                  
*                                                                               
SPLIT86  TM    UPSI,UPSISPTR                                                    
         BZ    SPLIT88                                                          
         LH    R0,SRTRECLN                                                      
         GOTO1 PRNTBL,DMCB,=C' Split rec',(R2),C'DUMP',(R0),=C'1D'              
*        LH    R0,PAYBUK#                                                       
*        MHI   R0,PHSLNQ                                                        
*        GOTO1 PRNTBL,DMCB,=C'PAYEM',APAYRTES,C'DUMP',(R0),=C'1D'               
*                                                                               
         USING ROWD,R3                                                          
SPLIT88  TM    FMTFLAG2,FMTWIPE+FMTNOCB    WIPE ON DATA INDICATOR               
         BNO   SPLIT                                                            
         L     R3,FMTROW           ROW TABLE                                    
         IC    R0,FMT#ROWS         NUMBER OF ROWS TO PROCESS                    
SPLIT90  TM    ROWXPIND,ROWWIPE                                                 
         BZ    SPLIT92                                                          
         SR    RF,RF                                                            
         ICM   RF,3,ROWKYSZ                                                     
         BZ    SPLIT92                                                          
         LR    R4,R2                                                            
         AH    R4,ROWKYDSP                                                      
         LTR   RF,RF                                                            
         BZ    SPLIT92                                                          
         LR    RE,R4               WIPE OUT DATA                                
         XCEFL                                                                  
*                                                                               
SPLIT92  AHI   R3,ROWLNQ                                                        
         BCT   R0,SPLIT90                                                       
         B     SPLIT               TRY SPLITTING AGAIN                          
*                                                                               
SPLIT94  NI    POSTLVL,TURNOFF-POSTSPLT                                         
*        TM    UPSI,UPSISPTR                                                    
*        BZ    SPLIT99                                                          
*        LH    RE,SAVETRNS                                                      
*        LH    R6,FMT#TRNS                                                      
*        LR    R4,R6                                                            
*        SR    R6,RE                                                            
*        LA    R6,1(,R6)                                                        
*        BCTR  R4,0                                                             
*        MH    R4,SRTRECLN                                                      
*        A     R4,FMTSRTWK                                                      
         L     R4,FMTSRTWK                                                      
         LH    R0,SRTRECLN                                                      
         LH    R6,FMT#TRNS                                                      
         AHI   R6,1                                                             
*                                                                               
SPLIT95  TM    UPSI,UPSISPTR                                                    
         BZ    SPLIT99                                                          
         MVC   WORK(10),=C' Repeat  #'                                          
         STC   R6,WORK+9                                                        
         OI    WORK+9,X'F0'                                                     
         GOTO1 PRNTBL,DMCB,(10,WORK),(R4),C'DUMP',(R0),=C'1D'                   
         AH    R4,SRTRECLN                                                      
         BCT   R6,SPLIT95                                                       
*                                                                               
SPLIT99  XMOD1                                                                  
         EJECT                                                                  
         LTORG                                                                  
         TITLE 'Process special General ledger buckets'                         
***********************************************************************         
* Process GL buckets old style                                                  
***********************************************************************         
         USING CACRECD,R2                                                       
         USING BUKELD,R4                                                        
GLOLD    NMOD1 0,**GLOLD*                                                       
         L     RC,RLBASEC                                                       
         MVC   CURBUCK,CACKBTYP                                                 
         XC    BUKELM,BUKELM                                                    
         LR    R4,R1                                                            
         AH    R4,DATADISP                                                      
GLOLD140 CLI   0(R4),EOR           End of record                                
         BE    GLOLD150                                                         
         CLI   0(R4),BUKELQ        X'45' Bucket element                         
         BNE   GLOLD148                                                         
         OC    BUKELM,BUKELM                                                    
         BNZ   *+8                                                              
         ST    R4,BUKELM           Set to 1st A(BUKELQ)                         
         TM    FCIND,FCNEWGL       New GL                                       
         BZ    GLOLD150                                                         
         CLC   BUKMOS,GLMOS                                                     
         BL    GLOLD148            Leave as is                                  
         ZAP   BUKDR,PKZERO        Clear since account for in new recs          
         ZAP   BUKCR,PKZERO                                                     
                                                                                
GLOLD148 LLC   RF,1(,R4)                                                        
         AR    R4,RF                                                            
         B     GLOLD140                                                         
         DROP  R4                                                               
                                                                                
GLOLD150 ICM   R6,15,BUKELM        Buckets                                      
         BZ    GLOLDXIT            No                                           
         CLI   NEWOFF,YES                                                       
         BNE   *+10                                                             
         MVC   LMTSECOF,CACKOFF    Set limited access office                    
         MVC   CUROFF,CACKOFF                                                   
         MVC   DFTMDC,SPACES                                                    
         MVC   CURMDC,SPACES                                                    
         MVC   SOFFC,SPACES                                                     
         MVC   SCULAC,SPACES                                                    
         CLC   CACKCULC(3),SPACES                                               
         BNE   GLOLD152                                                         
         MVC   CURSUBAC+1(L'CACKULA),SPACES                                     
         MVC   CURSUBAC+1(2),=C'SJ'                                             
         BRAS  RE,MEDNME                                                        
                                                                                
GLOLD152 GOTOR POSTBUK,DMCB,(R6)                                                
GLOLDXIT J     XIT                                                              
         EJECT ,                                                                
**********************************************************************          
* Try to find media code for unit G contra when contra is media name            
**********************************************************************          
         USING PMDELD,RE                                                        
MEDNME   ST    RE,SVRE                                                          
         L     RE,ADCOMP           Company record                               
         AH    RE,DATADISP                                                      
MEDNME10 CLI   0(RE),EOR           End of record                                
         BE    MEDNMEX                                                          
         CLI   0(RE),PMDELQ        X'11'                                        
         BNE   MEDNME20                                                         
         CLC   PMDSPACE(15),CACKCULC                                            
         BE    MEDNME30                                                         
MEDNME20 LLC   RF,1(,RE)                                                        
         AR    RE,RF                                                            
         B     MEDNME10                                                         
                                                                                
MEDNME30 MVI   DFTSYC,C'J'         Set to J for production                      
         MVC   DFTMDC,PMDCODE      Set media code                               
         MVC   CURSMC,DFTSMC                                                    
                                                                                
MEDNMEX  L     RE,SVRE                                                          
         BR    RE                                                               
         DROP  RE                                                               
                                                                                
         LTORG                                                                  
         TITLE 'Post bucket records'                                            
***********************************************************************         
* Post buckets from GLBRECD records                                             
***********************************************************************         
         USING GLBRECD,R3                                                       
         USING CACRECD,R2                                                       
GLNEW    NMOD1 0,**GLNEW*                                                       
         L     RC,RLBASEC                                                       
         L     R8,#OFACTS                                                       
         MVC   GLCFILT,SPACES                                                   
         LTR   R8,R8                                                            
         BZ    GLNEWXIT                                                         
         MVC   ACURSTAK,ASTACK     Initialize                                   
         MVC   SCULAC,SPACES                                                    
         MVC   SOFFC,SPACES                                                     
         L     R1,=AL4(IOHIGH+IOACFIL+IOBUD)                                    
         LA    R3,IOKEY                                                         
         MVC   GLBKEY,SPACES                                                    
         MVI   GLBKTYP,GLBKTYPQ    X'28' General ledger bucket                  
         MVC   GLBKCPY,RCCOMPFL    Company code                                 
         MVC   GLBKGLDG,QLEDGER                                                 
         BRAS  RE,GLACT            Setup first set of accounts                  
         LTR   R8,R8               If minus then done                           
         BM    GLNEWXIT            Done, account not to lowest level            
                                                                                
GLNEW200 GOTOR AIO                                                              
         BE    *+6                                                              
         DC    H'00'                                                            
                                                                                
         L     R3,ABUDIO                                                        
         MVC   SVIOKEY,0(R3)                                                    
         MVC   IOKEY,SVIOKEY                                                    
         CLI   GLBKTYP,GLBKTYPQ    Right record type                            
         BNE   GLNEWXIT            No, so done                                  
         CLC   GLBKCPY,RCCOMPFL    Company code                                 
         BNE   GLNEWXIT            Done, different company                      
         MVC   CUROFF,GLBKGOFF                                                  
*&&US                                                                           
         TM    FMTROPT7,RPFORTEA   Only want retained earnings                  
         BZ    *+14                                                             
         CLC   GLBKSCA+1(6),=C'RTEARN'                                          
         BNE   GLNEWNXT                                                         
         TM    FMTROPT7,RPFXRTEA                                                
         BZ    GLNEW205                                                         
         CLC   GLBKSCA+1(6),=C'RTEARN' Filter out retained earnings             
         BE    GLNEWNXT                                                         
*&&                                                                             
GLNEW205 BRAS  RE,OFFFLT                                                        
         BNE   GLNEWNXT            Next record                                  
                                                                                
         USING ACTRECD,R2                                                       
GLNEW250 L     R2,ADACC            Current account                              
         CLC   GLBKGLA,ACTKLDG     Match on account                             
         BL    GLNEWNXT            Get next special record                      
         BE    GLNEW260                                                         
         LTR   R8,R8               Any thing left                               
         BNP   GLNEWXIT            No                                           
         BRAS  RE,GLACT            Setup first set of accounts                  
         LTR   R8,R8               If minus then done                           
         BNM   GLNEW250                                                         
         B     GLNEWXIT            Done, account not to lowest level            
         DROP  R2                                                               
*                                                                               
GLNEW260 DS    0H                                                               
         CLC   GLCFILT,SPACES      Already saved off the filter?                
         BH    GLNW25              Yes                                          
         L     RF,ADMASTC          Compare for contra filter since              
         USING MASTD,RF            can't rely on Monacc since not               
         L     R1,ADQSTACK         reading transactions                         
         USING ACQD,R1                                                          
         CLI   ACQCONT1,C'C'                                                    
         BNE   GLNW30                                                           
         CLI   ACQCONT2,C'C'                                                    
         BNE   GLNW30                                                           
         LA    R4,ACQTYP1                                                       
         LHI   R1,2                  Bump around 2 times                        
GLNW02   CLI   0(R4),ACQCNTR                                                    
         BNE   GLNWNX                                                           
         LA    RE,14                                                            
         LR    RF,R4                                                            
         AHI   RF,L'ACQFLT1                                                     
GLNW10   CLI   0(RF),C' '                                                       
         BNE   GLNW20                                                           
         SHI   RF,1                                                             
         BCT   RE,GLNW10                                                        
GLNW20   BCTR  RE,0                                                             
         STC   RE,GLCFLN                                                        
         EXMVC RE,GLCFILT,1(R4)                                                 
GLNW25   ZIC   RE,GLCFLN             Saved executed length                      
         EXCLC RE,GLCFILT,GLBKSULA                                              
         BNE   GLNEWNXT                                                         
         B     GLNW30                                                           
         DROP  R1,RF                                                            
*                                                                               
GLNWNX   LA    R4,L'ACQTYP1+L'ACQFLT1(R4)   BUMP TO NEXT ENTRY                  
         BCT   R1,GLNW02                                                        
*                                                                               
GLNW30   MVC   CURACC,0(R2)        Unit G account                               
         MVC   CURSJACC,SPACES                                                  
         MVC   DFTBLK1,SPACES                                                   
         MVC   CURSUBAC+1(L'GLBKSULA),GLBKSULA                                  
         MVC   SCULAC(L'GLBKSCU+L'GLBKSCL+L'GLBKSCA),GLBKSCU                    
         NI    FCIND,TURNOFF-FCIOKREV                                           
         CLI   REVSIGN,YES         Is this on?                                  
         JNE   *+8                 No                                           
         OI    FCIND,FCIOKREV      Yes, set on to reverse                       
                                                                                
         CLC   GLBKGSPC,SPACES     If spaces then production                    
         JNH   GLNEW268            Yes                                          
         CLC   =C'SR',GLBKSULA     Unit SR ?                                    
         JNE   *+10                Yes                                          
         MVC   SCULAC,SPACES                                                    
*&&US                                                                           
         CLC   =C'SS',GLBKSULA     Payables ?                                   
         JE    GLNEW264            Yes                                          
         CLC   =C'ST',GLBKSULA     Payables ?                                   
         JE    GLNEW264            Yes                                          
         CLC   =C'SU',GLBKSULA     Payables ?                                   
         JE    GLNEW264            Yes                                          
         CLC   =C'SP',GLBKSULA     Payables ?                                   
         JE    GLNEW264            Yes                                          
         CLC   =C'SQ',GLBKSULA     Payables ?                                   
         JNE   GLNEW268            Yes                                          
GLNEW264 MVC   CURSJACC(3),GLBKSCA                                              
         MVC   DFTCLI(3),GLBKSCA                                                
         MVC   SCULAC,SPACES                                                    
*&&                                                                             
GLNEW268 MVC   LMTSECOF,GLBKGOFF   Set limited access office                    
         MVC   SOFFC,GLBKSOFF                                                   
         MVC   DFTMDC,SPACES                                                    
         MVC   CURMDC,SPACES                                                    
         MVC   CURSMC,SPACES                                                    
         MVC   DFTSMC,SPACES                                                    
         CLC   =C'SR',GLBKSUNT                                                  
         JNE   GLNEW272                                                         
         MVC   DFTSMC,GLBKSCA                                                   
         MVC   CURSMC,GLBKSCA                                                   
                                                                                
GLNEW272 CLC   GLBKGSPC,SPACES     If spaces then production                    
         BH    GLNEW280            No                                           
         MVC   CURSUBAC+1(L'CACKULA),SPACES                                     
         MVC   CURSUBAC+1(2),=C'SJ'                                             
         MVC   CURSUBAC+3(L'GLBKCP),GLBKCP                                      
         MVC   CURSJACC(L'GLBKCP),GLBKCP                                        
         LLC   R1,SJCLILEN         Lenght of client                             
         BCTR  R1,0                                                             
         EXMVC R1,DFTCLI,GLBKCP                                                 
         LA    RE,GLBKCP+1(R1)                                                  
         LLC   R1,SJPRDLEN         Length of product                            
         BCTR  R1,0                                                             
         EXMVC R1,DFTPRD,0(RE)                                                  
         MVC   SOFFC,SPACES                                                     
         MVC   SCULAC,SPACES                                                    
         MVI   DFTSYC,C'J'         J for production                             
         MVC   DFTMDC,GLBKMEDC                                                  
         MVC   CURSMC,DFTSMC                                                    
                                                                                
GLNEW280 GOTOR SETCNTR,DMCB,CURSUBAC+1                                          
         LR    R6,R3                                                            
         AH    R6,DATADISP                                                      
         ST    R6,ADSUBAC                                                       
         GOTOR POSTBUK,DMCB,(R6)                                                
         CLC   SVIOKEY,IOKEY                                                    
         BE    GLNEWNXT                                                         
         MVC   IOKEY,SVIOKEY       Need to reset                                
         L     R1,=AL4(IOREAD+IOACFIL+IOBUD)                                    
         GOTOR AIO                                                              
                                                                                
GLNEWNXT L     R1,=AL4(IOSEQ+IOACFIL+IOBUD)                                     
         J     GLNEW200                                                         
                                                                                
GLNEWXIT XIT1                                                                   
         EJECT ,                                                                
*----------------------------------------                                       
*      STORAGE FOR PRPVND                                                       
*----------------------------------------                                       
GLCFILT  DS    CL14                      Contra filter from request             
GLCFLN   DS    XL1                       Contra filter executed length          
*---------------------------------------------------------------------*         
* Filter out bucket records based on office. Fitler and limited access          
*---------------------------------------------------------------------*         
OFFFLT   NTR1                                                                   
         GOTO1 AFILTER,DMCB,AFLTOFF,CUROFF                                      
         JNE   OFFFLTNO                                                         
         CLI   NEWOFF,YES          Two character office?                        
         JE    OFFFLT50            Yes                                          
                                                                                
*---------------------------------------------*                                 
* Process one character office limited access *                                 
*---------------------------------------------*                                 
         CLI   QOFFICE,C' '                                                     
         JE    OFFFLT10            No filter so continue with list              
         CLC   CUROFF(1),QOFFICE                                                
         JE    OFFFLT10            This office is okay                          
         TM    QOFFICE,X'40'       Set to include ?                             
         JO    OFFFLTNO            Yes, so eliminate it                         
         MVC   WORK(1),QOFFICE                                                  
         OI    WORK,X'40'                                                       
         CLC   CUROFF(1),WORK      Exclude this office                          
         JE    OFFFLTNO            Yes                                          
                                                                                
OFFFLT10 L     R1,ADOFFLST         Point to office list                         
         CLI   0(R1),0             Any limit set?                               
         JE    OFFFLTOK            No, so okay as is                            
                                                                                
         LHI   R0,32               R0=# of offices to look at                   
OFFFLT20 CLI   0(R1),0             Skip zero entries                            
         JE    OFFFLT30            Next                                         
*&&US*&& CLI   0(R1),C'0'          Skip office zero                             
*&&UK*&& CLI   0(R1),C'*'          Skip office asterisk                         
         JE    OFFFLT30            Next                                         
         CLC   CUROFF(1),0(R1)     Match office to list                         
         JE    OFFFLTOK            A-Okay                                       
OFFFLT30 LA    R1,1(,R1)           Bump to next entry in office list            
         BRCT  R0,OFFFLT20                                                      
         J     OFFFLTNO            Set to no                                    
                                                                                
*---------------------------------------------*                                 
* Process two character office limited access *                                 
*---------------------------------------------*                                 
         USING ACMD,R3                                                          
OFFFLT50 L     R3,AMONACC          Set office list in MONACC DSECT              
         SR    R0,R0                                                            
         ICM   R0,3,ACMOFCN        R0=N'ENTRIES IN OFFICE LIST                  
         JNZ   *+6                                                              
         DC    H'0'                Two character must have at least 1           
                                                                                
         USING OFFALD,R1                                                        
         L     R1,ACMAOFL                                                       
         OC    OFFANEWA,OFFANEWA   Test for limited access                      
         JNZ   OFFFLT52            Yes                                          
         CLC   QOFFICE,SPACES      Test FOR A REQUESTED OFFICE FILTER           
         JE    OFFFLTOK            None                                         
                                                                                
OFFFLT52 LA    R1,ACMROFL          A(List of requested offices)                 
OFFFLT60 CLC   CUROFF,0(R1)                                                     
         JE    OFFFLTOK                                                         
         LA    R1,2(,R1)           Next office                                  
         BRCT  R0,OFFFLT60                                                      
         J     OFFFLTNO            Yes                                          
                                                                                
OFFFLTOK SR    RE,RE                                                            
OFFFLTNO LTR   RE,RE                                                            
         J     GLNEWXIT                                                         
         DROP  R3                  ACMD                                         
         EJECT ,                                                                
*---------------------------------------------------------------------*         
* Setup GL accounts saved off so we can process new GL records                  
*---------------------------------------------------------------------*         
         USING STORECD,R6                                                       
         USING LDGD,R7                                                          
GLACT    NTR1                                                                   
         GOTOR GETLDGR,DMCB,QUNIT                                               
         ICM   R7,15,0(R1)                                                      
         BNZ   *+6                                                              
         DC    H'00'                                                            
                                                                                
         SAM31                                                                  
         L     R6,ACURSTAK         Current location in stack                    
GLACT110 GOTOR CHKLEVEL,LDGLEV1                                                 
         BH    GLACT120            Not this level, next level                   
         GOTOR MOVEACC,ADHEIRA                                                  
         MVC   ADACC,ADHEIRA                                                    
         SR    R2,R2                                                            
         GOTOR SETSTAT,0                                                        
         CLI   LDGLEV1,L'ACTKACT   Lowest level?                                
         BE    GLACT200            Yes, done                                    
         LTR   R8,R8               Any accounts left?                           
         JP    GLACT110            Check to see if next is same level           
         J     GLACT180            Set to minus, indicating done                
                                                                                
GLACT120 GOTOR CHKLEVEL,LDGLEV2                                                 
         BH    GLACT140            Not this level next level                    
         GOTOR MOVEACC,ADHEIRB                                                  
         MVC   ADACC,ADHEIRB                                                    
         SR    R2,R2                                                            
         GOTOR SETSTAT,1                                                        
         CLI   LDGLEV2,L'ACTKACT   Lowest level?                                
         BE    GLACT200            Yes, done                                    
         LTR   R8,R8               Any accounts left?                           
         JP    GLACT110            Check to see if next is same level           
         J     GLACT180            Set to minus, indicating done                
                                                                                
GLACT140 GOTOR CHKLEVEL,LDGLEV3                                                 
         BH    GLACT160            Not this level next level                    
         GOTOR MOVEACC,ADHEIRC                                                  
         MVC   ADACC,ADHEIRC                                                    
         SR    R2,R2                                                            
         GOTOR SETSTAT,2                                                        
         CLI   LDGLEV3,L'ACTKACT   Lowest level?                                
         BE    GLACT200            Yes, done                                    
         LTR   R8,R8               Any accounts left?                           
         JP    GLACT110                                                         
         J     GLACT180            Set to minus, indicating done                
                                                                                
GLACT160 GOTOR MOVEACC,ADHEIRD                                                  
         MVC   ADACC,ADHEIRD                                                    
         SR    R2,R2                                                            
         GOTOR SETSTAT,3                                                        
         J     GLACT200                                                         
                                                                                
GLACT180 LHI   R8,-1               Special con code                             
                                                                                
GLACT200 ST    R6,ACURSTAK         Save next entry                              
         SAM24                                                                  
         XIT1  REGS=(R8)                                                        
         EJECT ,                                                                
*---------------------------------------------------------------------*         
* Check level to see if the account is this level                               
*---------------------------------------------------------------------*         
         USING ACTRECD,R4                                                       
CHKLEVEL ST    RE,SVRE                                                          
         LA    R4,STORKEY                                                       
         CLI   0(R1),L'ACTKACT     Lowest level?                                
         BE    CHKLEVX             Yes, so move it in                           
         LLC   RE,0(,R1)           Displacement after 2nd level                 
         LR    R1,RE                                                            
         LA    RE,ACTKACT(RE)      Point to end of 2nd level                    
         LA    RF,L'ACTKACT-1                                                   
         SR    RF,R1               See if it is all spaces                      
         EXCLC RF,0(RE),SPACES                                                  
CHKLEVX  L     RE,SVRE                                                          
         BR    RE                  Pass back con code                           
                                                                                
*---------------------------------------------------------------------*         
* Rebuild record saved off into MONACC account areas                            
*---------------------------------------------------------------------*         
MOVEACC  L     R4,0(,R1)           Get location to move record to               
         ST    RE,SVRE                                                          
         MVC   ACTKEY(ACCORFST),0(R6)                                           
         LA    RE,ACCORFST(R4)     RE=A(Elements)                               
         ICM   RF,3,ACTRLEN                                                     
         SH    RF,DATADISP         Less key length                              
         ICM   R0,15,STOADDR       Element(s) of record to restore              
         LR    R1,RF                                                            
         MVCL  RE,R0                                                            
         L     RE,SVRE                                                          
         AHI   R6,STORLNQ          Next record                                  
         SHI   R8,1                                                             
         BNMR  RE                  Can't go minus                               
         DC    H'00'                                                            
         DROP  R4,R6,R7                                                         
                                                                                
SVIOKEY  DS    CL(L'IOKEY)                                                      
ACURSTAK DS    A                                                                
         LTORG                                                                  
         TITLE 'Post bucket records'                                            
***********************************************************************         
*  Create sort records based on bucket records                        *         
***********************************************************************         
POSTBUK  NMOD1 0,**PBUK**                                                       
         L     RC,RLBASEC                                                       
         L     R4,0(,R1)           A(First element)                             
*&&DO                                                                           
         XC    SVGLBMOS,SVGLBMOS                                                
         CLI   QPROG,GENERAL       Only for General Ledger                      
         BNE   POSTBK50                                                         
         BAS   RE,BLDGBMOS         Possible GB MOS entry build                  
         BAS   RE,MTCHGLGB         Match GL to GB MOS entry                     
*&&                                                                             
POSTBK50 TM    POSTCTL,POSTBYDT    Post by date ?                               
         BO    POSTBK60            Yes                                          
         ST    R4,BUKELM           A(1st BUKEL)                                 
         GOTO1 ARECORD,DMCB,('POSTBKT',ABUDWRK),('POSTCLR',1)                   
         OI    POSTMODE,POSTBKT                                                 
         GOTO1 APUTREC,DMCB,ABUDWRK,1                                           
         NI    POSTMODE,TURNOFF-POSTBKT                                         
         B     POSTBXIT                                                         
*                                                                               
POSTBK60 CLI   0(R4),EOR           Post one bucket at a time                    
         BE    POSTBXIT            Finished                                     
         LA    RE,BUKMOS-BUKELD                                                 
         CLI   0(R4),BUKELQ        X'45'                                        
         BE    POSTBK62                                                         
*        BNE   POSTBK61            Next element                                 
*&&DO                                                                           
         CLI   QPROG,GENERAL       Only for General Ledger                      
         BNE   POSTBK62                                                         
         CLC   BUKMOS-BUKELD(2,R4),SVGLBMOS                                     
         BH    POSTBK62                                                         
         ZAP   BUKDR-BUKELD(6,R4),=P'0'                                         
         ZAP   BUKCR-BUKELD(6,R4),=P'0'                                         
         B     POSTBK62            Next element                                 
*&&                                                                             
POSTBK61 LA    RE,PBKHI-PBKELD                                                  
         CLI   0(R4),PBKELQ        X'55'                                        
         BNE   POSTBK68            Next element                                 
*&&DO                                                                           
         CLI   QPROG,GENERAL       Only for General Ledger                      
         BNE   POSTBK62                                                         
*        CLC   PBKHI-PBKELD(2,R4),SVGLBMOS                                      
*        BH    POSTBK62                                                         
         TM    TABIND,TABGBMOS                                                  
         BZ    POSTBK62                                                         
         ZAP   PBKDR-PBKELD(8,R4),=P'0'                                         
         ZAP   PBKCR-PBKELD(8,R4),=P'0'                                         
*&&                                                                             
POSTBK62 ST    R4,BUKELM           SAVE ADDRESS OF ELEMENT                      
         AR    RE,R4               Add base of element                          
         CLC   RMOAEND,0(RE)                                                    
         JL    POSTBK68            Next element                                 
         CLC   RMOASTR,0(RE)                                                    
         JH    POSTBK68            Next element                                 
         MVC   WORK(2),0(RE)       Set MOS values                               
         MVI   WORK+2,1                                                         
         MVC   CURMMOS,WORK                                                     
         MVC   SAVEMOS,WORK                                                     
         MVC   MOADTE,WORK                                                      
         GOTO1 ARECORD,DMCB,('POSTBKT',ABUDWRK),('POSTCLR',1)                   
         OI    POSTMODE,POSTBKT                                                 
         GOTO1 APUTREC,DMCB,ABUDWRK,1                                           
         NI    POSTMODE,TURNOFF-POSTBKT                                         
*                                                                               
POSTBK68 LLC   R1,1(,R4)                                                        
         AR    R4,R1                                                            
         B     POSTBK60                                                         
                                                                                
POSTBXIT XIT1                                                                   
         EJECT ,                                                                
*&&DO                                                                           
BLDGBMOS NTR1                                                                   
         CLI   0(R3),X'28'         SPECIAL GL RECORD?                           
         BNE   POSTBXIT            YES, DON'T BUILD WITH THOSE RECS             
         CLI   2(R3),C'B'          MUST BE GB OR GP ACCT                        
         BE    BGBM100                                                          
         CLI   2(R3),C'P'                                                       
         BNE   POSTBXIT                                                         
                                                                                
BGBM100  CLI   0(R4),EOR           HIT END OF RECORD?                           
         BE    POSTBXIT            YES, LEAVE                                   
                                                                                
         CLI   0(R4),PBKELQ        X'55'                                        
         BE    BGBM200             YES, FOUND ONE                               
                                                                                
         LLC   R1,1(,R4)           BUMP TO NEXT ELEMENT                         
         AR    R4,R1                                                            
         B     BGBM100                                                          
                                                                                
         USING BGBMDSCT,R6                                                      
BGBM200  SAM31                                                                  
         L     R6,AGBMOST                                                       
         L     RE,=A(MXGBMOST)         END OF GBMOS TABLE                       
         AR    RE,R6                                                            
                                                                                
BGBM210  CLC   0(GBMOSLNQ,R6),=XL32'00'                                         
         BE    BGBM300                                                          
         AHI   R6,GBMOSLNQ                                                      
         CR    R6,RE                                                            
         BL    BGBM210                                                          
         DC    H'0'                PAST END OF GBMOS TABLE                      
*                                                                               
BGBM300  MVC   BGBMCPY,TRNKCPY-TRNRECD(R3)                                      
         MVC   BGBMLACT,TRNKLDG-TRNRECD(R3)                                     
         MVC   BGBMOFF,TRNKOFF-TRNRECD(R3)                                      
         MVC   BGBMCNTR,TRNKULC-TRNRECD(R3)                                     
         MVC   BGBMMOS,PBKHI-PBKELD(R4)                                         
         MVC   SVGLBMOS,BGBMMOS                                                 
                                                                                
         SAM24                                                                  
         XIT1                                                                   
                                                                                
         EJECT                                                                  
         USING GLBRECD,R3                                                       
MTCHGLGB NTR1                                                                   
         CLI   0(R3),X'28'         SPECIAL GL RECORD?                           
         BNE   POSTBXIT            NO, DON'T MATCH                              
*                                                                               
         OI    TABIND,TABGBMOS     GB MOS TABLE BUILT                           
                                                                                
         USING BGBMDSCT,R6                                                      
         SAM31                                                                  
         L     R6,AGBMOST                                                       
         L     RE,=A(MXGBMOST)         END OF GBMOS TABLE                       
         AR    RE,R6                                                            
                                                                                
MTGLB100 CLC   0(GBMOSLNQ,R6),=XL32'00'                                         
         BE    MTGLBXIT                                                         
         CLC   BGBMCPY(BGBMCNTR-BGBMDSCT),1(R3)    MATCH UP TO OFFICE           
         BE    MTGLB200                                                         
MTGLB150 AHI   R6,GBMOSLNQ                                                      
         CR    R6,RE                                                            
         BL    MTGLB100                                                         
         DC    H'0'                PAST END OF GBMOS TABLE                      
                                                                                
MTGLB200 DS    0H                                                               
         LA    R2,BGBMMOS-1        LAST CHAR IN CONTRA                          
         LA    R1,L'BGBMCNTR-1                                                  
MTGLB210 CLI   0(R2),C' '                                                       
         BH    MTGLB250                                                         
         AHI   R2,-1                                                            
         AHI   R1,-1                                                            
         BM    MTGLBXIT                                                         
         B     MTGLB210                                                         
                                                                                
MTGLB250 DS    0H                                                               
         LA    R4,GLBKSULA                                                      
         CLI   GLBKSULA,C' '                                                    
         BH    *+8                                                              
         AHI   R4,1                                                             
         EX    R1,MTGLBCNT         COMPARE TO LAST NON-SPACE CONTRA             
         BNE   MTGLB150            NO MATCH, BUMP                               
                                                                                
MTGLB300 MVC   SVGLBMOS,BGBMMOS                                                 
                                                                                
MTGLBXIT SAM24                                                                  
         XIT1                                                                   
                                                                                
MTGLBCNT CLC   BGBMCNTR(0),0(R4)                                                
*                                                                               
         DROP  R3                                                               
         EJECT                                                                  
         LTORG                                                                  
*&&                                                                             
         TITLE 'SET WORKCODE VALUES AND FILTER'                                 
***********************************************************************         
*  Must have CURWKCD set                                              *         
*  Set up extra workcode values and apply workcode level filters      *         
***********************************************************************         
         SPACE 1                                                                
         USING WCOELD,R2                                                        
         USING ACGOD,R3                                                         
         USING ACXGOD,R4                                                        
         USING ACWORKD,RC                                                       
         USING ACRLD,RA                                                         
SETWKCD  NMOD1 0,**WKCD**                                                       
         L     RC,RLBASEC                                                       
         L     R3,ADGOBLOC         A(GOBLOCK)                                   
         L     R4,AGOXBLK          A(EXTENDED GOBLOCK)                          
         CLI   MODE,ACCLAST        In ACCLAST, processing multiple wc           
         BE    SETWKCD1                                                         
         TM    MODEIND,MODEONCE    DID WE RUN THROUGH HERE 1X FOR MODE?         
         BO    SETWKCD7            YES, SO DATA SET, JUST FILTER                
*        CLI   MODE,PROCSBAC                                                    
*        BE    SETWKCD1                                                         
*        CLI   MODE,PROCTRNS                                                    
*        BE    SETWKCD1                                                         
*                                                                               
SETWKCD1 CLC   GOSELWC,CURWKCD     Is GOBLOCK already set ?                     
         BE    SETWKCD2            Yes                                          
         MVC   GOSELWC,CURWKCD     No, so set GOBLOCK                           
         XC    GOAKEY,GOAKEY                                                    
         GOTO1 GETOPT,DMCB,ADGOBLOC                                             
*                                                                               
SETWKCD2 L     R2,WCSBASE                                                       
         MVC   CURWKCD,GOEFFWC     Move in work code                            
         MVC   WCLONG,SPACES                                                    
         MVC   WCLONG(15),=CL15'BILLING'                                        
         MVC   WCSHORT,WCLONG                                                   
         MVI   CURWCTY,C' '                                                     
         MVI   GPTRAN,GPTRNCR                                                   
         MVI   GPWCTY,C' '                                                      
         CLC   GOEFFWC,=C'99'                                                   
         BNE   SETWKCD3                                                         
         TM    FMTROPT5,RPFIWC99   INCLUDE WC99 W/GRP OR TYPE FILTERS           
         BZ    SETWKCD7            FILTER BASED ON WC GRP OR WC TY              
         B     SETWKCD9            SET AS OK      (INCLUDE)                     
*                                                                               
SETWKCD3 MVI   GPTRAN,GPTRNDR      MARK AS NON-WC99                             
         MVC   WCLONG,SPACES                                                    
         MVC   WCSHORT,SPACES                                                   
         L     RE,WCLBASE          GET THE LONG WORK CODE NAME                  
         SHI   RE,2                # OF ENTRIES, I STORED IN **LABEL**          
         SR    R6,R6                                                            
         ICM   R6,3,0(RE)                                                       
         GOTO1 BINSRCH,DMCB,(1,CURWKCD),WCLBASE,(R6),38,2,(R6)                  
         SR    R1,R1                                                            
         ICM   RE,7,DMCB+1                                                      
         BZ    *+10                                                             
         MVC   WCLONG,2(RE)                                                     
*                                                                               
         MVI   BYTE,NO             SAY NOT USEING U/L RECORD                    
         L     R2,WCSBASE          START WITH THIS TABLE                        
SETWKCD4 CLI   0(R2),0             END OF RECORD?                               
         BNE   SETWKCD5            KEEP LOOKING                                 
         CLI   BYTE,YES            ARE WE REALLY FINISHED ?                     
         BE    SETWKCD7            YES, COULD NOT FIND IT ANY WHERE             
         MVI   BYTE,YES                                                         
         L     R2,ADLEDGER         LOOK FOR WORKCODES ON LEDGER REC.            
         AH    R2,DATADISP                                                      
         B     SETWKCD4            LET'S TRY THIS AGAIN                         
*                                                                               
SETWKCD5 CLI   BYTE,NO             THIS ONLY APPLIES TO A(WCSBASE)              
         BNE   *+8                                                              
         LA    R2,2(,R2)           BUMP PASE UNIT/LEDGER THAT IS STORED         
         CLI   0(R2),WCOELQ        X'12' WORKCODE ELEMENT                       
         BNE   *+10                                                             
         CLC   WCOCODE,GOEFFWC     CURRENT WORK CODE                            
         BE    SETWKCD6                                                         
         IC    R1,WCOLN                                                         
         AR    R2,R1                                                            
         B     SETWKCD4                                                         
*                                                                               
SETWKCD6 MVC   WCSHORT,WCODESC                                                  
*&&US                                                                           
         CLI   GOWRKTY,C' '                                                     
         BH    *+14                                                             
         MVC   GOWRKTY,WCOTYPE     SAVE OFF TYPE                                
         CLI   GOWRKTY,C' '                                                     
         BH    *+8                                                              
         MVI   GOWRKTY,C'O'        DEFAULT VALUE IF NONE                        
         MVC   CURWCTY,GOWRKTY                                                  
*&&                                                                             
*&&UK                                                                           
         MVI   CURWCTY,C'C'        COST WORK CODE TYPE                          
         TM    WCOSTAT,WCOSHCOE    ORIGINAL EST.                                
         BZ    *+8                                                              
         MVI   CURWCTY,C'T'        TIME WORK CODE TYPE                          
*&&                                                                             
***********************************************************************         
*  THIS FILTER IS A ANALYSIS LEVEL                                    *         
***********************************************************************         
         SPACE 1                                                                
SETWKCD7 GOTO1 AFILTER,DMCB,AFLTWCGP,GOEFFWG                                    
         BNE   SETWKCDX                                                         
*&&UK*&& B     SETWKCD9                                                         
*&&US                                                                           
         CLI   AFLTTMWC,0                                                       
         BE    SETWKCD8                                                         
         MVI   GPWCTY,GPWCTIME     GROUP AS TYPE TIME                           
         GOTO1 AFILTER,DMCB,AFLTTMWC,GOWRKTY                                    
         BE    SETWKCD9            THIS ONE OK                                  
         CLI   AFLTOPWC,0                                                       
         BE    SETWKCDX            NONE SET UP SO                               
*                                                                               
SETWKCD8 CLI   AFLTOPWC,0          SEE IF ONLY ONE GROUP SETUP                  
         BE    SETWKCD9                                                         
         MVI   GPWCTY,GPWCOOFP     GROUP AS TYPE OUT OF POCKET                  
         GOTO1 AFILTER,DMCB,AFLTOPWC,GOWRKTY                                    
         BNE   SETWKCDX                                                         
*&&                                                                             
SETWKCD9 SR    RE,RE                                                            
SETWKCDX LTR   RE,RE                                                            
         XIT1                                                                   
         DROP  R2,R3,R4                                                         
***********************************************************************         
*  Must have CURWKCD set                                              *         
*  Get ITEM CODE and ITEM DESCRIPTION                                 *         
***********************************************************************         
         SPACE 1                                                                
         USING WCID,R2                                                          
         USING ACWORKD,RC                                                       
         USING ACRLD,RA                                                         
GETITM   NMOD1 0,**GITM**                                                       
         L     RC,RLBASEC                                                       
         L     R2,ACEITEM          Get address of CE table                      
*                                                                               
         LA    R0,WCMAX                                                         
         MVC   CURITMC,SPACES                                                   
         MVC   CURITMD,SPACES                                                   
         ZAP   CURINAMT,=P'0'                                                   
         ZAP   CURIHRS,=P'0'                                                    
         ZAP   CURIAPRC,=P'0'                                                   
         ZAP   CURICRAT,=P'0'                                                   
         ZAP   CURICAMT,=P'0'                                                   
         ZAP   CURIGAMT,=P'0'                                                   
         NI    POSTLVL,TURNOFF-POSTITM+POSTAITM                                 
*                                                                               
GETIT02  CLI   WCIWRK,0            End of table?                                
         BE    GETITX              Yes                                          
         CLC   WCIWRK,CURWKCD      Is this the workcode?                        
         BE    GETIT06                                                          
*                                                                               
GETIT04  AHI   R2,WCILNQ                                                        
         BCT   R0,GETIT02                                                       
         B     GETITX                                                           
*                                                                               
GETIT06  MVC   CURITMC,WCIITMC     Get Item Code                                
         MVC   CURITMD,WCIITMD         Item Description                         
         ZAP   CURINAMT,WCINAMT        Net Amount                               
         ZAP   CURIHRS,WCIHRS          Hours                                    
         ZAP   CURIAPRC,WCIAPRC        Price                                    
         ZAP   CURICRAT,WCICRAT        Commission Rate                          
         ZAP   CURICAMT,WCICAMT        Commission Amount                        
         ZAP   CURIGAMT,WCIGAMT        Gross Amount                             
*                                                                               
         OI    POSTLVL,POSTITM     POSTING BY ITEM                              
         LR    RF,R2                                                            
         LA    RF,WCIHRS-WCID(RF)                                               
         ST    RF,AITMBLK                                                       
         GOTO1 ARECORD,DMCB,('POSTJBR',ABUDWRK),('POSTCLR',1)                   
         OI    POSTMODE,POSTJBR                                                 
         GOTO1 APUTREC,DMCB,ABUDWRK,1                                           
         NI    POSTMODE,TURNOFF-POSTJBR                                         
         NI    POSTLVL,TURNOFF-POSTITM                                          
         OI    POSTLVL,POSTAITM    Indicate ITEMS found                         
         B     GETIT04             See if anymore                               
*                                                                               
GETITX   MVC   CURITMD,SPACES                                                   
         MVC   CURITMC,SPACES                                                   
         XIT1                                                                   
         DROP  R2                                                               
         EJECT                                                                  
*&&UK                                                                           
***********************************************************************         
*  Get CLIENT PURCHASE CODE AND AMOUNTS                               *         
***********************************************************************         
         SPACE 1                                                                
         USING CPOD,R2                                                          
         USING ACWORKD,RC                                                       
         USING ACRLD,RA                                                         
PROCPO   NMOD1 0,**PCPO**                                                       
         L     RC,RLBASEC                                                       
         L     R2,ACLPORD          Get address of CE table                      
         LA    R3,12                                                            
                                                                                
         MVC   CURCPO,SPACES                                                    
         ZAP   CURCPOA,=P'0'                                                    
                                                                                
PROCP02  OC    CPOCODE,CPOCODE     End of table?                                
         BE    PROCPX              Yes                                          
*                                                                               
         MVC   CURCPO,CPOCODE      Client PO code                               
         ZAP   CURCPOA,CPOAMNT     Client PO amount                             
*                                                                               
         OI    POSTLVL2,POSTCLP    POSTING BY CLIENT PO                         
         GOTO1 ARECORD,DMCB,('POSTCPO',ASRTWRK),('POSTCLR',1)                   
         OI    POSTMODE,POSTCPO                                                 
         GOTO1 APUTREC,DMCB,ASRTWRK,1                                           
         NI    POSTMODE,TURNOFF-POSTCPO                                         
         NI    POSTLVL2,TURNOFF-POSTCLP                                         
         OI    POSTLVL2,POSTACLP   Indicate client PO found                     
                                                                                
         AHI   R2,CPOLNQ                                                        
         BCT   R3,PROCP02                                                       
*                                                                               
PROCPX   MVC   CURCPO,SPACES                                                    
         ZAP   CURCPOA,=P'0'                                                    
         XIT1                                                                   
         DROP  R2                                                               
         EJECT                                                                  
*&&                                                                             
***********************************************************************         
*  Routine to process time/material items                                       
***********************************************************************         
         SPACE 1                                                                
FST      USING TIMELD,R3                                                        
         USING TIMELD,R4                                                        
         USING ACWORKD,RC                                                       
         USING ACRLD,RA                                                         
PROCITM  NMOD1 0,**PITM**                                                       
         L     RC,RLBASEC                                                       
*                                                                               
         LR    R6,R1               TRANSACTION COUNT                            
         ICM   R4,15,AELMTM30                                                   
         BZ    PROCITMX            NO ITEM ELEMENTS                             
         LR    R3,R4               SAVE ORIGINAL ITEM ELEMENT                   
         MVI   POSTLVL2,POSTTMI    POST ITEM KEYWORDS ONLY                      
*                                                                               
PROCIT04 LLC   RF,TIMLN            BUMP TO NEXT ELEMENT                         
         AR    R4,RF                                                            
         CLI   TIMEL,TIMELQ                                                     
         BNE   PROCIT08                                                         
         CLC   FST.TIMSEQ(TIMINP-TIMSEQ),TIMSEQ                                 
         BNE   PROCIT08            DIFFERENT SEQ                                
         ST    R4,AELMTM30                                                      
         GOTO1 ARECORD,DMCB,(0,FMTSRTWK),('POSTCLR',(R6))                       
         LA    R6,1(,R6)           ADD ANOTHER RECORD                           
         B     PROCIT04                                                         
*                                                                               
PROCIT08 XC    AELMTM30,AELMTM30                                                
         MVI   POSTLVL2,0                                                       
*                                                                               
PROCITMX XIT1  REGS=(R6)                                                        
         DROP  FST,R4                                                           
         EJECT                                                                  
         LTORG                                                                  
         TITLE 'POST HOURS AND ALLOCATE DOLLARS BY TRANSACTION'                 
***********************************************************************         
*  ROUTINE TO POST HOURS AND ALLOCATED $ DOWN TO DETAIL LEVELS        *         
***********************************************************************         
         SPACE 1                                                                
         USING COSTD,R2                                                         
         USING MTHDD,R3                                                         
         USING TIMELD,R4                                                        
         USING RATED,R6                                                         
         USING ACWORKD,RC                                                       
         USING ACRLD,RA                                                         
POSTHRS  NMOD1 0,**PHRS**                                                       
         L     RC,RLBASEC                                                       
         SR    R1,R1                                                            
         ICM   R1,3,CSTMTHDS       NUMBER OF METHODS                            
         BZ    POSTHR90                                                         
         L     R3,MHDBASE                                                       
         NI    MTHDIND,TURNOFF-MTHDHRS                                          
         LA    R3,MTHDLNQ(,R3)                                                  
         BCT   R1,*-8                                                           
*                                                                               
         SR    R0,R0                                                            
         L     R2,CSTBASE          CALENDARS                                    
         LH    R3,CSTYRS           NUMBER OF CALENDARS TO PROCESS               
         L     R4,AELMTMS1                                                      
POSTHR18 TM    COSTIND,COSTHRS     CLEAR DOLLARS                                
         BZ    POSTHR25                                                         
         NI    COSTIND,TURNOFF-COSTHRS                                          
         IC    R0,COSTMTHS         NUMBER OF RATES                              
         L     R6,COSTRATE                                                      
POSTHR20 LH    R1,CSTMTHDS         NUMBER OF METHODS                            
         LA    R6,RATEMTHD                                                      
*                                                                               
         USING RATEMTHD,R6                                                      
POSTHR22 LA    RF,RATEBUK#/2       NUMBER OF DOLLAR BUCKETS                     
         LA    RE,RATEAMT$                                                      
         ZAP   0(L'RATEAMT$,RE),PKZERO                                          
         LA    RE,L'RATEAMT$(,RE)                                               
         BCT   RF,*-10                                                          
*                                                                               
         LA    R6,RATEBUKQ(,R6)    NEXT SET                                     
         BCT   R1,POSTHR22         PROCESS METHODS                              
         BCT   R0,POSTHR20         PORCESS MONTHS                               
POSTHR25 LA    R2,COSTLNQ(,R2)                                                  
         BCT   R3,POSTHR18         PROCESS CALENDAR                             
*&&UK                                                                           
         CLC   =C'1N',CURSUBAC+1                                                
         BE    POSTHR90                                                         
*&&                                                                             
         L     R2,CSTBASE          CALENDARS                                    
POSTHR30 CLI   0(R2),0             END OF ENTRIES?                              
         BE    POSTHR90            NOT IN TABLE                                 
         CLC   TIMMOA,COSTSMOA     MOA OF HOURS                                 
         BL    POSTHR90                                                         
         CLC   TIMMOA,COSTEMOA     MOA OF HOURS                                 
         BNH   POSTHR32                                                         
         LA    R2,COSTLNQ(,R2)                                                  
         B     POSTHR30                                                         
*                                                                               
         USING RATED,R6                                                         
POSTHR32 SR    R0,R0                                                            
         IC    R0,COSTMTHS         NUMBER OF MONTHS                             
         OI    COSTIND,COSTHRS                                                  
         L     R6,COSTRATE                                                      
         CLC   TIMMOA,RATEMOA      MATCH ON MOA                                 
         BE    *+14                                                             
         AH    R6,RATELEN                                                       
         BCT   R0,*-14                                                          
         DC    H'00'                                                            
*                                                                               
         STH   R0,RATEMTH          SAVE NUMBER OF MONTHS                        
         ST    R6,RATEPTR          SAVE FOUND RATE LOCATION                     
         TM    RECREAD2,RECALO$                                                 
         BZ    POSTHR90            DON'T CONTINUE IN JUST RATES                 
*                                                                               
POSTHR34 LH    R1,CSTMTHDS         NUMBER OF METHODS                            
         L     R3,MHDBASE                                                       
         LA    R6,RATEMTHD                                                      
*                                                                               
POSTHR35 TM    MTHDIND,MTHDRTE     DOES IT HAVE RATES?                          
         BZ    POSTHR40            SO NO DOLLARS                                
         TM    MTHDIND,MTHDMTH     ALLOCATION BY MONTH?                         
         BZ    *+8                                                              
         TM    MTHDIND,MTHDHRS     ALREADY POSTED DOLLARS THEN                  
         BO    POSTHR40                                                         
         OI    MTHDIND,MTHDHRS     SET AS POSTED (ONE MONTH ONLY)               
*                                                                               
         USING RATEMTHD,R6                                                      
         ZAP   OP1,TIMHRS                                                       
         MP    OP1,RATESAL         RATE * HOURS                                 
         SRP   OP1,62,5                                                         
         ZAP   RATESAL$,OP1        SALARY DOLLARS                               
*                                                                               
         ZAP   OP1,TIMHRS                                                       
         MP    OP1,RATEBEN         RATE * HOURS                                 
         SRP   OP1,62,5                                                         
         ZAP   RATEBEN$,OP1        BENEFIT DOLLARS                              
*                                                                               
         ZAP   OP1,TIMHRS                                                       
         MP    OP1,RATEPEN         RATE * HOURS                                 
         SRP   OP1,62,5                                                         
         ZAP   RATEPEN$,OP1        PENSION DOLLARS                              
*                                                                               
         ZAP   OP1,TIMHRS                                                       
         MP    OP1,RATETOT         RATE * HOURS                                 
         SRP   OP1,62,5                                                         
         ZAP   RATETOT$,OP1        TOTAL DOLLARS                                
*                                                                               
POSTHR40 LA    R3,MTHDLNQ(,R3)     NEXT METHOD                                  
         LA    R6,RATEBUKQ(,R6)                                                 
         BCT   R1,POSTHR35         PROCESS EACH METHOD DOLLARS                  
         BCT   R0,POSTHR34         PROCESS NEXT MONTH FOR YEAR                  
*                                                                               
         LH    R0,RATEMTH          RESTORE NUMBER OF MONTHS                     
         SHI   R0,1                                                             
         BNP   POSTHR90            ONLY ONE MONTH                               
         SH    R6,RATELEN          POINT TO LAST RATE PROCESSED                 
*                                                                               
         USING RATED,R6                                                         
POSTHR50 LH    R1,CSTMTHDS                                                      
         MVC   WORK(2),RATEMOA     MOA FOR THIS RATE GROUP                      
         LA    R6,RATEMTHD         POINT TO $ AND RATES FOR METHOD              
         LR    R5,R6               SAME AS R6 BUT ONE MONTH PRIOR               
         SH    R5,RATELEN          ONE MONTH PRIOR                              
         L     R3,MHDBASE                                                       
*                                                                               
PRV      USING RATEMTHD,R5                                                      
         USING RATEMTHD,R6                                                      
POSTHR52 TM    MTHDIND,MTHDYTD     ONLY YTD ALLOCATION                          
         BZ    POSTHR56                                                         
         TM    MTHDIND,MTHDHRS     IF FIRST MONTH THEN SKIP                     
         BZ    POSTHR56                                                         
         CLC   MTHDLAD,WORK                                                     
         BL    POSTHR56                                                         
         SP    RATESAL$,PRV.RATESAL$   AMOUNT POSTED FOR EACH MONTH             
         SP    RATEBEN$,PRV.RATEBEN$                                            
         SP    RATEPEN$,PRV.RATEPEN$                                            
         SP    RATETOT$,PRV.RATETOT$                                            
*                                                                               
POSTHR56 CLI   QOPT6,C'D'          DEBUG                                        
         BNE   POSTHR60                                                         
         MVC   P,SPACES                                                         
         MVC   P+1(1),MTHDNUM      METHOD #                                     
         OI    P+1,X'F0'                                                        
         CLC   QOPT5,P+1           MATCH ON METHOD TO FILTER                    
         BNE   POSTHR60                                                         
         MVC   P+5(4),=C'TOT='                                                  
         ZAP   DUB,RATETOT$                                                     
         OI    DUB+7,X'0F'                                                      
         UNPK  P+9(12),DUB                                                      
         CP    RATETOT$,PKZERO                                                  
         BNM   *+8                                                              
         MVI   P+21,C'-'                                                        
         MVC   P+25(4),=C'HRS='                                                 
         ZAP   DUB,TIMHRS                                                       
         OI    DUB+7,X'0F'                                                      
         UNPK  P+29(6),DUB                                                      
         CP    TIMHRS,PKZERO                                                    
         BNM   *+8                                                              
         MVI   P+35,C'-'                                                        
         MVC   P+40(4),=C'MOA='                                                 
         ZAP   DUB,PKZERO                                                       
         MVO   DUB+5(3),WORK(2)                                                 
         OI    DUB+7,X'0F'                                                      
         UNPK  P+44(4),DUB                                                      
         ST    R1,SVR1                                                          
         GOTO1 PRNTBL,DMCB,=C' ALLOCATED',P,1,50,=C'1C'                         
         L     R1,SVR1                                                          
         LA    RF,1                                                             
         CR    R0,RF                                                            
         BH    POSTHR60                                                         
         ZAP   DUB,PRV.RATETOT$                                                 
         OI    DUB+7,X'0F'                                                      
         UNPK  P+9(12),DUB                                                      
         UNPK  P+9(12),DUB                                                      
         CP    RATETOT$,PKZERO                                                  
         BNM   *+8                                                              
         MVI   P+21,C'-'                                                        
         GOTO1 PRNTBL,DMCB,=C' LAST     ',P,1,50,=C'1C'                         
         L     R1,SVR1                                                          
*                                                                               
POSTHR60 LA    R5,RATEBUKQ(,R5)    NEXT LINE OF RATES (1 MONTH PRIOR)           
         LA    R6,RATEBUKQ(,R6)    NEXT LINE OF RATES FOR METHOD                
         LA    R3,MTHDLNQ(,R3)     NEXT METHOD DATA                             
         BCT   R1,POSTHR52         R1 = NUMBER OF METHODS                       
*                                                                               
         LR    R6,R5                                                            
         SH    R6,RATELEN          BUMP BACK ONE MONTH                          
         BCT   R0,POSTHR50         R0 = NUMBER OF MONTHS                        
*                                                                               
POSTHR90 EQU   *                                                                
         XIT1                                                                   
         DROP  PRV                                                              
         DROP  R2,R3,R4,R6                                                      
         EJECT                                                                  
         LTORG                                                                  
         TITLE 'PROCESS STUDIO LINKS'                                           
         USING SACRECD,R2                                                       
         USING LNKELD,R3                                                        
PSTUDIO  NMOD1 0,**STDO**                                                       
         L     RC,RLBASEC                                                       
         LA    R2,IODIRKEY                                                      
         L     R3,LNKBASE                                                       
         XC    SACKEY,SACKEY                                                    
         MVI   SACKTYP,SACKTYPQ    X'35' AGENCY POINTER                         
         MVI   SACKSUB,SACKSUBQ    X'04' SUB CODE                               
         MVC   SACKCPY,RCCOMPFL    COMPANY CODE                                 
         MVC   SACKAJB,CURACC+3    MOVE IN POSSIBLE AGENCY CODE                 
         L     R2,AIO1                                                          
         L     R1,=AL4(IOHIGH+IOACDIR+IOAREA1)                                  
PSTUDIO4 GOTO1 AIO                                                              
         CLI   SACKTYP,SACKTYPQ                                                 
         BNE   PSTUDIOX                                                         
         CLI   SACKSUB,SACKSUBQ                                                 
         BNE   PSTUDIOX                                                         
         CLC   SACKCPY,RCCOMPFL    RIGHT COMPANY?                               
         BNE   PSTUDIOX                                                         
         CLC   SACKAJB,CURACC+3    SAME CLI/PROD/JOB                            
         BNE   PSTUDIOX                                                         
         MVI   LNKEL,LNKELQ        X'BA' LINK STUDIO ELEMENT                    
         MVI   LNKLN,LNKLNQ        ELEMENT LENGTH                               
         MVC   LNKSTUD,SACKSTY     STUDIO TYPE                                  
         MVC   LNKSTJB,SACKSJB     STUDIO JOB                                   
         MVC   LNKAGJB,SACKAJB     AGENCY JOB                                   
         AHI   R3,LNKLNQ                                                        
         L     R1,=AL4(IOSEQ+IOACDIR+IOAREA1)                                   
         B     PSTUDIO4                                                         
*                                                                               
PSTUDIOX MVI   0(R3),0             MARK END OF AREA (ELEMENTS)                  
         XIT1                                                                   
         SPACE 2                                                                
         LTORG                                                                  
         DROP  R2,R3                                                            
         TITLE 'SET UP CORRECT CALENDAR FOR ACCOUNT'                            
***********************************************************************         
*  SET UP REQUEST RANGE BASED ON CALENDAR                             *         
***********************************************************************         
         SPACE 1                                                                
         USING CPRCNDRD,R2                                                      
         USING CDRD,R6                                                          
SETCNDR  NMOD1 0,**SCAL**                                                       
         L     RC,RLBASEC                                                       
         L     R2,ACNDRBLK                                                      
         OC    RQCALSTR,RQCALSTR                                                
         BZ    SETCND30                                                         
         XC    CPRYMD,CPRYMD                                                    
         MVC   CPROF,PRSNOFF                                                    
         MVC   CPRYM,RELCSYR                                                    
         GOTO1 AGETCNDR,DMCB,ACNDRBLK,22                                        
         L     R6,ACNDRWRK                                                      
         TM    REQIND,REQPERD      CODE NOT IN USE YET                          
         BO    SETCND50            GET BASED ON PERIOD NUMBERS                  
*                                                                               
SETCND20 CLI   CDRPRD#,0           END OF CALENDAR?                             
         BNE   *+6                                                              
         DC    H'00'               YES, SO WHAT WENT WRONG?                     
         CLC   CDRMOA,RQCALSTR     REQUESTED CALENDAR START MONTH               
         BE    SETCND25            FIRST MATCH USE                              
         LA    R6,CDRLNQ(,R6)      TRY NEXT                                     
         B     SETCND20                                                         
*                                                                               
SETCND25 MVC   RTRNSTR,CDRSDATE    RESET TRANSACTION START DATES                
         CLC   RQCALEND,CPRSMOA    CAN WE FIND THIS ON SAME CALENDAR?           
         BNL   *+6                 YES                                          
         DC    H'00'                                                            
         CLC   RQCALEND,CPREMOA    IS IT IN RANGE ?                             
         BNH   SETCND35            YES, ON SAME CALENDAR                        
*                                                                               
SETCND30 CLC   RQCALEND,=X'FFFFFF' ANY REQUEST CALENDAR END MONTH?              
         BE    SETCND90            NO, SO RTRNEND=X'FFFFFF'                     
         XC    CPRYMD,CPRYMD                                                    
         MVC   CPROF,PRSNOFF       GET NEXT CALENDAR                            
         MVC   CPRYM,RELCEYR       SET TO CALENDAR END YEAR                     
         GOTO1 AGETCNDR,DMCB,ACNDRBLK,23                                        
*                                                                               
         L     R6,ACNDRWRK                                                      
SETCND35 CLI   CDRPRD#,0           END OF PERIODS                               
         BE    SETCND40            NO MORE TO CHECK                             
         CLC   CDRMOA,RQCALEND     MATCH ON CALENDAR MONTH OF END REQ           
         BH    SETCND40            WENT PAST IT SO SHOULD BE OK                 
         LA    R6,CDRLNQ(,R6)      NEXT ENTRY FOR CALENDAR                      
         B     SETCND35                                                         
*                                                                               
SETCND40 SHI   R6,CDRLNQ           WENT PAST, GET LAST MATCHING MONTH           
         CLC   CDRMOA,RQCALEND     MAKE SURE IT MATCHED                         
         BE    *+6                 YES                                          
         DC    H'00'               NO, WRONG CALENDAR, DON'T FIGURE             
         MVC   RTRNEND,CDREDATE    RESET TRANSACTION END                        
         B     SETCND90                                                         
*                                                                               
SETCND50 CLI   RELSPER#,0          ANY PERIOD SPECIFIED?                        
         BE    SETCND60                                                         
         CLI   CDRPRD#,0                                                        
         BNE   SETCND52                                                         
         MVC   RTRNSTR,RTRNEND                                                  
         XC    RTRNEND,RTRNEND                                                  
         B     SETCND90                                                         
*                                                                               
SETCND52 CLC   CDRPRD#,RELSPER#    START PERIOD NUMBER                          
         BE    SETCND55                                                         
         LA    R6,CDRLNQ(,R6)                                                   
         B     SETCND50                                                         
*                                                                               
SETCND55 MVC   RTRNSTR,CDRSDATE                                                 
         CLI   RELEPER#,0          ANY END PERIOD NUMBER?                       
         BE    SETCND90                                                         
SETCND58 CLI   CDRPRD#,0                                                        
         BE    SETCND60                                                         
         CLC   CDRPRD#,RELEPER#    END PERIOD NUMBER                            
         BE    SETCND62                                                         
         LA    R6,CDRLNQ(,R6)                                                   
         B     SETCND58                                                         
SETCND60 SHI   R6,CDRLNQ                                                        
SETCND62 MVC   RTRNEND,CDREDATE                                                 
*                                                                               
         USING ACMD,R2                                                          
SETCND90 L     R2,AMONACC                                                       
         TM    RECREAD2,RECALO$    IF NO ALLOCATED DOLLARS THEN SET             
         BZ    SETCND92                                                         
         TM    POSTLVL,POSTDET     IF DETAIL LEVEL REPORTING                    
         BO    SETCND95            THEN DON'T RESET                             
*                                                                               
SETCND92 MVC   ACMTSTR,RTRNSTR                                                  
         MVC   ACMTEND,RTRNEND                                                  
*                                                                               
SETCND95 XIT1                                                                   
         DROP  R2,R6                                                            
         SPACE 1                                                                
         LTORG                                                                  
         TITLE 'SETUP REVISION AND PLANNING ESTIMATE FIELDS'                    
***********************************************************************         
*  INITIALIZE REVISION AND PLANNING ESTIMATE FIELDS                   *         
***********************************************************************         
         SPACE 1                                                                
         USING EVERECD,R2                                                       
         USING ACMD,R3                                                          
         USING JBLOCKD,R4                                                       
         USING ESTD,R6                                                          
         USING ACRL2D,R7                                                        
PEST     NMOD1 0,**PEST**                                                       
         L     RC,RLBASEC                                                       
         L     R3,AMONACC                                                       
         L     R4,ACMAJOBB                                                      
         L     R7,AACRL2D                                                       
         LA    R2,IOKEY                                                         
                                                                                
         USING ESTRECD,R2                                                       
         CLI   JBNEWEST,JBMCSQ     FOR MCS ESTIMATES                            
         BNE   PRCEST60                                                         
         GOTO1 AFILTER,DMCB,AFLTACC,CURACC+1                                    
         BNE   PRCESTX                                                          
*                                                                               
         USING PRNEND,RF           For BrandO - planning and revision           
         L     RF,PRNENTBL         data does not apply so clear                 
PEST01   CLI   PRNTYPE,0           the data from the table                      
         BE    PEST05                                                           
         LA    R6,PRNDATA                                                       
         XC    ESTAPRV(ESTLNQ-1),ESTAPRV                                        
         AHI   RF,PRNENLNQ         Next entry                                   
         B     PEST01                                                           
         DROP  RF                                                               
*                                                                               
PEST05   XC    ESTKEY,ESTKEY                                                    
         MVI   ESTKTYP,ESTKTYPQ                                                 
         MVI   ESTKSUB,ESTKSUBQ                                                 
         MVC   ESTKCPY,RCCOMPFL                                                 
         MVC   ESTKCLI,SPACES                                                   
         MVC   ESTKPRO,SPACES                                                   
         MVC   ESTKJOB,SPACES                                                   
         LA    RE,CURACC+3                                                      
         ZIC   RF,SJCLILEN                                                      
         BCTR  RF,0                                                             
         EXMVC RF,ESTKCLI,0(RE)    CLIENT                                       
         LA    RE,1(RF,RE)                                                      
         ZIC   RF,SJPRDLEN                                                      
         BCTR  RF,0                                                             
         EXMVC RF,ESTKPRO,0(RE)    PRODUCT                                      
         LA    RE,1(RF,RE)                                                      
         ZIC   RF,SJJOBLEN                                                      
         BCTR  RF,0                                                             
         EXMVC RF,ESTKJOB,0(RE)    JOB                                          
         MVC   IOKEYSAV,IOKEY                                                   
*                                                                               
         TM    ESTIND,ESTRORG      Read original estimate record                
         BZ    PRCEST10                                                         
         L     R6,AORIGEST                                                      
         XC    0(ESTLNQ,R6),0(R6)                                               
         MVC   ESTKLNO,JBORGVER    Original estimate local number               
         L     R1,=AL4(IOREAD+IOACFIL+IOAREA2)                                  
         GOTO1 AIO                                                              
         BNE   PRCEST10                                                         
*&&US                                                                           
         L     RF,=AL4(IOHIGH+IOACFIL+IOAREA3)                                  
         ST    RF,SVRF                                                          
*&&                                                                             
         GOTOR SETMED,DMCB,AIO2,(R6)                                            
*                                                                               
PRCEST10 DS    0H                                                               
*&&US*&& MVC   IOKEY,IOKEYSAV      RESTORE THE KEY                              
         TM    ESTIND,ESTRCUR      Read current estimate record                 
         BZ    PRCEST20                                                         
         L     R6,ACURREST                                                      
         XC    0(ESTLNQ,R6),0(R6)                                               
         MVC   ESTKLNO,JBCURVER    Current estimate local number                
         MVC   EST#,JBCURVER                                                    
         L     R1,=AL4(IOREAD+IOACFIL+IOAREA2)                                  
         GOTO1 AIO                                                              
         BNE   PRCEST20                                                         
*&&US                                                                           
         L     RF,=AL4(IOHIGH+IOACFIL+IOAREA3)                                  
         ST    RF,SVRF                                                          
*&&                                                                             
         GOTOR SETMED,DMCB,AIO2,(R6)                                            
*                                                                               
         USING COLD,R6                                                          
         L     R6,FMTCOL                                                        
         SR    R0,R0                                                            
         IC    R0,FMT#COLS                                                      
*                                                                               
PRCEST12 CLC   COLDD#,=AL2(AC#RSCIC) Build only if CEIN or CEIC                 
         BE    PRCEST14                                                         
         CLC   COLDD#,=AL2(AC#RSCIN)                                            
         BE    PRCEST14                                                         
         LA    R6,COLLNQ(R6)                                                    
         BCT   R0,PRCEST12                                                      
         B     PRCEST20                                                         
         DROP  R6                                                               
*                                                                               
PRCEST14 L     RE,ACEITEM          Get start of table                           
         L     RF,=A(CEITQ)                                                     
         SR    R0,R0                                                            
         SR    R1,R1                                                            
         MVCL  RE,R0                                                            
         L     R6,ACEITEM                                                       
         ST    R6,AWCINXT          Save it as the next spot                     
*                                                                               
PRCEST15 L     R1,=AL4(IOSEQ+IOACFIL+IOAREA2)                                   
         GOTO1 AIO                                                              
         L     R2,AIO2                                                          
         CLC   IOKEY(ESTKSEQ-ESTKEY),0(R2)                                      
         BNE   PRCEST20                                                         
         L     R6,AWCINXT                                                       
         GOTOR SETITM,DMCB,AIO2,(R6)                                            
         B     PRCEST15                                                         
*                                                                               
         USING ESTD,R6                                                          
PRCEST20 TM    ESTIND,ESTRHR       Read highest revision estimate rec           
         BZ    PRCEST22                                                         
         L     R6,AHREVEST                                                      
         XC    0(ESTLNQ,R6),0(R6)                                               
         MVC   ESTKLNO,JBHIREV     Highest revision estimate local no           
         MVC   EST#,JBHIREV                                                     
         L     R1,=AL4(IOREAD+IOACFIL+IOAREA2)                                  
         GOTO1 AIO                                                              
         BNE   PRCEST22                                                         
*&&US                                                                           
         L     RF,=AL4(IOHIGH+IOACFIL+IOAREA3)                                  
         ST    RF,SVRF                                                          
*&&                                                                             
         GOTOR SETMED,DMCB,AIO2,(R6)                                            
         DROP  R6                                                               
*                                                                               
PRCEST22 L     RF,ESTMAIN          Always init ESTMAIN table                    
         MVI   0(RF),EOT                                                        
         TM    ESTIND,ESTNOS+ESTHRS    Read for BrandOcean Estimates            
         BZ    PRCEST58                                                         
*                                                                               
         MVC   IOKEY,IOKEYSAV                                                   
         L     RE,ESTMAIN                                                       
         LHI   RF,MAXMESTQ                                                      
         XR    R0,R0                                                            
         XR    R1,R1                                                            
         MVCL  RE,R0                                                            
         L     RE,ESTMAIN                                                       
         ST    RE,POINTER                                                       
         MVI   0(RE),EOT           Mark end of table                            
         MVC   CXESGLB,AXESGLB                                                  
*&&UK                                                                           
         MVI   BYTE1,0                                                          
         USING XDATED,RE                                                        
         L     RE,AXDATVE          Any XDATA VALUE filters?                     
         CLI   0(RE),EOT                                                        
         BE    PRCEST24            No, so no filtering needed here              
         XR    R1,R1                                                            
         XR    RF,RF                                                            
*                                                                               
         AHI   R1,1                Count number of XDATA VALUE entries          
         IC    RF,XDATDLN                                                       
         AR    RE,RF                                                            
         CLI   0(RE),EOT                                                        
         BNE   *-14                                                             
         STC   R1,NXVALUES         NXVALUES=number of required matches          
         MVC   BYTE1,NXVALUES                                                   
         DROP  RE                                                               
*&&                                                                             
PRCEST24 L     R1,=AL4(IOHIGH+IOACDIR+IOAREA2)                                  
         GOTO1 AIO                                                              
         L     R1,=AL4(IOGETREC+IOACMST+IOAREA2)                                
         GOTO1 AIO                                                              
*                                                                               
         L     R2,AIO2                                                          
         CLC   ESTKEY(ESTKLNO-ESTRECD),IOKEYSAV                                 
         BNE   PRCEST58            Look for match of C/P/J                      
*                                                                               
         CLI   ESTKSEQ,ESTKSMQ     First should be a main record                
         BE    PRCEST26                                                         
*&&US*&& MVI   ESTKSEQ,X'FF'                                                    
*&&UK                                                                           
PRCEST2A L     R2,AIO2                                                          
         MVC   IOKEY(L'ESTKEY),ESTKEY  Refresh IOKEY from data rec -            
         LA    R2,IOKEY            DIR read doesn't update it FFS               
         XR    R0,R0                                                            
         IC    R0,ESTKLNO                                                       
         AHI   R0,1                                                             
         STC   R0,ESTKLNO                                                       
         MVI   ESTKSEQ,0                                                        
*&&                                                                             
         B     PRCEST24                                                         
*                                                                               
PRCEST25 L     R1,=AL4(IOSEQ+IOACDIR+IOAREA2)                                   
         GOTO1 AIO                                                              
         L     R1,=AL4(IOGETREC+IOACMST+IOAREA2)                                
         GOTO1 AIO                                                              
*                                                                               
         L     R2,AIO2                                                          
         CLC   ESTKEY(ESTKLNO-ESTRECD),IOKEYSAV                                 
         BNE   PRCEST58            Look for match of C/P/J                      
*                                                                               
         CLI   ESTKSEQ,ESTKSMQ     Main record?                                 
         BNE   PRCEST32                                                         
*                                                                               
PRCEST26 DS    0H                                                               
*&&UK*&& MVC   BYTE1,NXVALUES      Reset number of filters to match             
         CLI   BESTAS,0            Any RFLBESTA BrO Est status filter?          
         BE    PRCEST29            No                                           
         CLI   BESTAS,X'FF'        Include all statuses?                        
         BE    PRCEST29            Yes                                          
         L     RE,=A(BESTAB)                                                    
         LA    RF,BESTABX                                                       
PRCEST27 MVC   BYTE,BESTAS                                                      
         NC    BYTE,0(RE)                                                       
         BZ    PRCEST28                                                         
         MVC   BYTE,ESTRSTA1                                                    
         NC    BYTE,1(RE)                                                       
         BZ    PRCEST28                                                         
         MVC   BYTE,ESTRSTA2                                                    
         NI    BYTE,X'FF'-(ESTKFCUR+ESTKLANG+ESTKBILP+ESTKBILA)                 
         XC    BYTE,2(RE)                                                       
         BZ    PRCEST29            Estimate status match                        
PRCEST28 AHI   RE,BESTABQ                                                       
         BCT   RF,PRCEST27                                                      
         XR    R0,R0                                                            
         IC    R0,ESTKLNO                                                       
         AHI   R0,1                                                             
         STC   R0,IOKEY+ESTKLNO-ESTRECD                                         
         B     PRCEST24                                                         
*                                                                               
PRCEST29 EDIT  (1,ESTKLNO),(3,THREE),FILL=0                                     
         L     RF,POINTER          Next free entry in ESTMAIN                   
*                                                                               
         USING ESTMD,RF                                                         
         MVC   ESTML#,THREE                                                     
         MVC   ESTSTA1,ESTRSTA1                                                 
         MVC   ESTSTA2,ESTRSTA2                                                 
*&&UK*&& MVC   ESTSTA3,ESTRSTA3                                                 
*                                                                               
         LA    R2,ESTRFST                                                       
         USING EMDELD,R2                                                        
         CLI   EMDEL,EMDELQ        EMDELD should be the first element           
         BNE   PRCEST31            but if not, don't die just ignore.           
*&&UK                                                                           
         TM    DATEFLT,DATEEST     Test estimate date filter                    
         BZ    PRCEST30                                                         
         CLC   EMDDAT,ALTNSTR                                                   
         BL    PRCEST2A            Skip to next estimate                        
         CLC   EMDDAT,ALTNEND                                                   
         BH    PRCEST2A                                                         
*&&                                                                             
PRCEST30 MVC   CURESGLB,EMDGNO     Save global number                           
         MVC   ESTWLG,EMDGNO                                                    
*&&UK                                                                           
         MVC   ESTRTD,EMDRAT                                                    
         MVC   ESTACK,EMDGSTAT                                                  
         MVC   ESTCUR,EMDCUR                                                    
         MVC   WORD(L'EMDCUR),EMDCUR  Save currency for W/C table               
         MVC   ESTDAT,EMDDAT       Estimate date                                
*&&                                                                             
PRCEST31 AHI   RF,ESTMLNQ                                                       
         ST    RF,POINTER          Point to next free entry in ESTMAIN          
         MVI   0(RF),EOT           Mark end of table                            
                                                                                
         B     PRCEST25                                                         
         DROP  RF                                                               
*                                                                               
PRCEST32 DS    0H                                                               
*&&UK                                                                           
         CLI   BYTE1,0             Any XDATA filtering to be done?              
         BE    PRCEST34            No                                           
         GOTO1 AESXFLT,DMCB,AIO2                                                
         L     R2,AIO2                                                          
         BH    PRCEST58       (No more estimates on job)                        
         BL    PRCEST26       (Don't want wc info; moved onto next est)         
*&&                           (Otherwise want wc data)                          
         USING ESTRECD,R2                                                       
PRCEST34 LA    R2,ESTRFST                                                       
         USING ERDELD,R2                                                        
PRCEST36 CLI   ERDEL,0                                                          
         BE    PRCEST25                                                         
         CLI   ERDEL,ERDELQ                                                     
         BNE   PRCEST38                                                         
         CLI   ERDTYP,ERDTIRQ      person/hours data                            
         BE    PRCEST40                                                         
         CLI   ERDTYP,ERDTWDQ      work code data                               
         BNE   PRCEST38                                                         
         CP    ERDWAMT,PKZERO      Test any estimate amount                     
         BNE   PRCEST46            Yes, add to table                            
         CLI   ERDLN,ERDWLX1Q      Test any estimate hours                      
         BL    PRCEST38            No, skip                                     
         CP    ERDWHRS,PKZERO      Test zero estimate hours                     
         BNE   PRCEST46            No, add to table                             
PRCEST38 XR    RE,RE                                                            
         IC    RE,ERDLN                                                         
         AR    R2,RE                                                            
         B     PRCEST36                                                         
*                                                                               
T        USING ESTWCD,TEMPAREA     Build Estimate time table entries            
PRCEST40 XC    TEMPAREA,TEMPAREA                                                
         MVC   T.ESTWL#,THREE                                                   
         MVC   T.ESTWC,HALF                                                     
         MVC   T.ESTW1R,ERDITAC    1R account                                   
         ZAP   T.ESTWRAT,ERDIRAT   hourly rate                                  
         MVI   T.ESTWIND,ESTW1RQ   time-type entry                              
         MVC   T.ESTWCUR,SPACES                                                 
         ZAP   T.ESTTHRS,ERDIHRS   Number of hours                              
         ZAP   T.ESTTRFC,PKZERO                                                 
         ZAP   OP1,T.ESTTHRS       Calc estimate time value                     
         MP    OP1,T.ESTWRAT       * (agency currency)                          
         ZAP   DUB1,OP1                                                         
         SRP   DUB1,64-2,5                                                      
         ZAP   T.ESTWAM,DUB1                                                    
         ZAP   T.ESTWGAM,DUB1                                                   
         ZAP   T.ESTWTAM,DUB1                                                   
         ZAP   DUB2,PKZERO                                                      
*&&UK                                                                           
         TM    ERDITND,ERDITFQ     Test currency rate set                       
         BZ    PRCEST42                                                         
         ZAP   T.ESTTRFC,ERDIRAF   Hourly rate in currency                      
         MVC   T.ESTWCUR,WORD      Currency code from EMDCUR                    
         ZAP   OP1,T.ESTTHRS       Calc estimate time value                     
         MP    OP1,T.ESTTRFC       * (foreign currency)                         
         ZAP   DUB2,OP1                                                         
         SRP   DUB2,64-2,5                                                      
PRCEST42 ZAP   T.ESTWAMC,DUB2      Set currency value/zero                      
         ZAP   T.ESTWGAMC,DUB2                                                  
         ZAP   T.ESTWTAC,DUB2                                                   
*&&                                                                             
         LH    RF,#OFEST                                                        
         SAM31                                                                  
         GOTO1 BIN31,DMCB,T.ESTWCD,ESTWCTB,(RF),(1,ESTWLNQ),           X        
               (0,ESTWKLQ),A(MAXEST)                                            
         MVC   #OFEST,DMCB+10      Update number of entries                     
         ICM   RE,15,DMCB                                                       
         BNZ   *+6                 Next element                                 
         DC    H'00'               Table full                                   
*                                                                               
         USING ESTWCD,RE                                                        
         TM    DMCB,X'80'          Record found ?                               
         BO    PRCEST43            No, entry not found, so added                
         AP    ESTTHRS,T.ESTTHRS   Else add values to existing entry            
         AP    ESTWAM,T.ESTWAM                                                  
         AP    ESTWGAM,T.ESTWGAM                                                
         AP    ESTWTAM,T.ESTWTAM                                                
*&&UK                                                                           
         AP    ESTWAMC,T.ESTWAMC                                                
         AP    ESTWGAMC,T.ESTWGAMC                                              
         AP    ESTWTAC,T.ESTWTAC                                                
*&&                                                                             
         DROP  RE,T                                                             
                                                                                
* Find matching w/c lvl table entry, maintain est. time value(s) on it:         
*                                                                               
PRCEST43 CP    DUB1,PKZERO         Test anything to save                        
         BE    PRCEST44                                                         
*                                  Find Estimate w/c Level table entry          
         LH    RF,#OFEST                                                        
W        USING ESTWCD,TEMPAREA                                                  
         XC    TEMPAREA,TEMPAREA                                                
         MVC   W.ESTWL#,THREE                                                   
         MVC   W.ESTWC,HALF                                                     
         ZAP   W.ESTWRAT,PKZERO    Rate = zero in w/c entry key                 
         GOTO1 BIN31,DMCB,W.ESTWCD,ESTWCTB,(RF),(0,ESTWLNQ),           X        
               (0,ESTWKLQ),A(MAXEST)                                            
         TM    DMCB,X'80'          Test entry was found                         
         BZ    *+6                                                              
         DC    H'0'                = Estrec has ERDTIRQ but no ERDTWDQ?         
         SR    RE,RE                                                            
         ICM   RE,7,DMCB+1         A(table entry)                               
         BNZ   *+6                                                              
         DC    H'00'                                                            
         USING ESTWCD,RE                                                        
         SP    ESTWAM,DUB1         reduce w/c lvl vals by time-lvl vals         
         SP    ESTWGAM,DUB1                                                     
         AP    ESTWTAM,DUB1        Save estimate time value(s)                  
*&&UK                                                                           
         SP    ESTWAMC,DUB2                                                     
         SP    ESTWGAMC,DUB2                                                    
         AP    ESTWTAC,DUB2                                                     
*&&                                                                             
PRCEST44 DS    0H                                                               
         SAM24                                                                  
         B     PRCEST38                                                         
         DROP  RE,W                                                             
                                                                                
W        USING ESTWCD,TEMPAREA     Build Estimate w/c lvl table entries         
PRCEST46 XC    TEMPAREA,TEMPAREA                                                
         MVC   W.ESTWL#,THREE                                                   
         MVC   W.ESTWC,ERDWCOD                                                  
         ZAP   W.ESTWRAT,PKZERO                                                 
         MVI   W.ESTWIND,ESTWWCQ                                                
         MVC   HALF,W.ESTWC        save w/c for time-lvl table entries          
         ZAP   W.ESTWAM,ERDWAMT                                                 
         ZAP   W.ESTWGAM,ERDWAMT                                                
         AP    W.ESTWGAM,ERDWCAM   GROSS=COMMISSION+WC AMOUNT                   
         ZAP   W.ESTTHRS,PKZERO                                                 
         ZAP   W.ESTTRFC,PKZERO                                                 
         ZAP   W.ESTWTAM,PKZERO                                                 
         CLI   ERDLN,ERDWLX1Q      Test w/c-level hours extension               
         BL    PRCEST50                                                         
         ZAP   W.ESTWRAT,ERDWRAT   Hourly rate                                  
         ZAP   W.ESTTHRS,ERDWHRS   Number of hours                              
PRCEST50 DS    0H                                                               
*&&UK                                                                           
         CLI   ERDLN,ERDWLX1Q                                                   
         BNE   PRCEST52                                                         
         TM    ERDWIND2,ERDWTFQ    Test currency rate set                       
         BZ    PRCEST52                                                         
         ZAP   W.ESTTRFC,ERDWRATF                                               
PRCEST52 ZAP   W.ESTWTAC,PKZERO                                                 
         ZAP   W.ESTWAMC,ERDWFCA                                                
         ZAP   W.ESTWGAMC,ERDWFCA                                               
         AP    W.ESTWGAMC,ERDWCFC  FOREIGN GROSS=COMMISSION+WC AMOUNT           
         MVC   W.ESTWCUR,WORD      Currency code from EMDCUR                    
*&&                                                                             
         LH    RF,#OFEST                                                        
         SAM31                                                                  
         GOTO1 BIN31,DMCB,W.ESTWCD,ESTWCTB,(RF),(1,ESTWLNQ),           X        
               (0,ESTWKLQ),A(MAXEST)                                            
         MVC   #OFEST,DMCB+10      Update number of entries                     
         ICM   RE,15,DMCB                                                       
         BNZ   *+6                 Next element                                 
         DC    H'00'               Table full                                   
*                                                                               
         USING ESTWCD,RE                                                        
         TM    DMCB,X'80'          Record found ?                               
         BO    PRCEST56            No, record not found, so added               
         AP    ESTWAM,W.ESTWAM                                                  
         AP    ESTWGAM,W.ESTWGAM   Found, add to amounts already there          
*&&UK                                                                           
         AP    ESTWAMC,W.ESTWAMC                                                
         AP    ESTWGAMC,W.ESTWGAMC                                              
*&&                                                                             
         DROP  RE                                                               
         SAM24                                                                  
*                                                                               
PRCEST56 B     PRCEST38                                                         
         DROP  W                                                                
*                                                                               
PRCEST58 DS    0H                                                               
         L     RF,ESTMAIN                                                       
         CLI   0(RF),EOT                                                        
         BE    PRCESTX                                                          
         OI    ACTIVITY,ACTEST                                                  
         B     PRCESTX                                                          
*                                                                               
         USING EVERECD,R2                                                       
PRCEST60 XC    EVEKEY,EVEKEY                                                    
         MVI   EVEKTYP,EVEKTYPQ    X'2C'                                        
         MVI   EVEKSUB,EVEKSUBQ    X'36'                                        
         MVC   EVEKCPY,RCCOMPFL    COMPANY CODE                                 
         MVC   EVEKUNT(2),CURSJ                                                 
         LA    RE,CURACC+3                                                      
         ZIC   RF,SJCLILEN         LENGTH OF CLIENT                             
         BCTR  RF,0                                                             
         EXMVC RF,EVEKCLI,0(RE)    CLIENT                                       
         LA    RE,1(RF,RE)         POINT TO PRODUCT                             
         ZIC   RF,SJPRDLEN         LENGTH OF PRODUCT                            
         BCTR  RF,0                                                             
         EXMVC RF,EVEKPRO,0(RE)    PRODUCT                                      
         LA    RE,1(RF,RE)         POINT TO JOB                                 
         ZIC   RF,SJJOBLEN         LENGTH OF JOB                                
         BCTR  RF,0                                                             
         EXMVC RF,EVEKJOB,0(RE)    JOB                                          
         OC    EVEKCLI(18),SPACES                                               
*                                                                               
         USING ESTD,R6                                                          
         TM    ESTIND,ESTRORG      Read original estimate record                
         BZ    PRCEST65                                                         
         L     R6,AORIGEST                                                      
         XC    0(ESTLNQ,R6),0(R6)                                               
         MVC   EVEKTYPE,JBORGTYP   ORIGINAL TYPE                                
         MVC   EVEKVER,JBORGVER    ORIGINAL VERSION #                           
         L     R1,=AL4(IOREAD+IOACFIL+IOAREA2)                                  
         GOTO1 AIO                                                              
         BNE   PRCEST65                                                         
         GOTOR SETEST,DMCB,AIO2,(R6)                                            
*                                                                               
PRCEST65 TM    ESTIND,ESTRCUR      READ CURRENT ESTIMATE REC                    
         BZ    PRCEST67                                                         
         L     R6,ACURREST                                                      
         XC    0(ESTLNQ,R6),0(R6)                                               
         MVC   EVEKTYPE,JBCURTYP   CURRENT TYPE                                 
         MVC   EVEKVER,JBCURVER    CURRENT VERSION #                            
         MVC   EST#,JBCURVER       CURRENT VERSION #                            
         L     R1,=AL4(IOREAD+IOACFIL+IOAREA2)                                  
         GOTO1 AIO                                                              
         BNE   PRCEST67                                                         
         GOTOR SETEST,DMCB,AIO2,(R6)                                            
*                                                                               
PRCEST67 TM    ESTIND,ESTRHR       READ CURRENT ESTIMATE REC                    
         BZ    PRCEST70                                                         
         L     R6,AHREVEST                                                      
         XC    0(ESTLNQ,R6),0(R6)                                               
         MVI   EVEKTYPE,C'R'       REVISION                                     
         MVC   EVEKVER,JBHIREV     HIGHEST REVISION #                           
         MVC   EST#,JBHIREV                                                     
         L     R1,=AL4(IOREAD+IOACFIL+IOAREA2)                                  
         GOTO1 AIO                                                              
         BNE   PRCEST70                                                         
         GOTOR SETEST,DMCB,AIO2,(R6)                                            
*                                                                               
PRCEST70 TM    ESTIND,ESTPRN       READ PLANNING/REVISION # RECORDS ?           
         BZ    PRCESTX             NO,  SKIP                                    
*                                                                               
         USING PRNEND,R4           PLANNING/REVISION NUM  ELEMENT               
         L     R4,PRNENTBL         ->   PRNENTBL                                
PRCEST72 CLI   PRNTYPE,0           END  OF   TABLE ?                            
         BE    PRCESTX             YES, DONE                                    
         LA    R6,PRNDATA                                                       
         XC    ESTAPRV(ESTLNQ-1),ESTAPRV    PLANNING/REVISION DATA              
         MVC   EVEKTYPE,PRNTYPE    PLANNING/REVISION NUM  TYPE                  
         MVC   EVEKVER,EST#        PLANNING/REVISION NUMBER                     
         L     R1,=AL4(IOREAD+IOACFIL+IOAREA2)                                  
         GOTO1 AIO                                                              
         BNE   PRCEST76                                                         
         GOTOR SETEST,DMCB,AIO2,PRNDATA                                         
PRCEST76 AHI   R4,PRNENLNQ         NEXT ENTRY                                   
         B     PRCEST72                                                         
         DROP  R6                                                               
*                                                                               
PRCESTX  XIT1                                                                   
         DROP  R2,R3,R4,R7                                                      
         SPACE 1                                                                
**********************************************************************          
*  Process JOBBER column table for workcode/contra estimate data     *          
**********************************************************************          
         USING ACWORKD,RC                                                       
         USING JBCOLD,R2                                                        
         USING ACMD,R3                                                          
         USING JBLOCKD,R4                                                       
JOBEST   NMOD1 0,**JOBES*                                                       
         L     RC,RLBASEC                                                       
         TM    ACTIVITY,ACTEST     Did we have estimates ?                      
         BO    *+16                Yes so do we want the transactions ?         
         TM    FMTROPT4,RPFOESTO   Only jobs with estimates ?                   
         BO    JOBESTNO            Process next format                          
         B     *+12                                                             
         TM    FMTROPT4,RPFXESTO   Only jobs without estimates ?                
         BO    JOBESTNO            Process next format                          
*                                                                               
*                                  need to clear vendor info for ests           
*        MVC   CFWVCNO,SPACES            Vendor check number                    
*        XC    CFWVCDT,CFWVCDT           Vendor check date                      
*        XC    CFWVCDI,CFWVCDI           Internal Vendor check date             
*        XC    CFWVSTA,CFWVSTA           Vendor check status                    
*                                                                               
         L     R3,AMONACC                                                       
         L     R4,ACMAJOBB                                                      
         L     R2,ACMACOL          R2=A(Column table)                           
         LH    R0,JBNROWS          Number of rows                               
         MVC   SVSUBAC,ADSUBAC                                                  
         XC    ADSUBAC,ADSUBAC                                                  
         MVI   SVCOLTYP,MJETTWQ    Keep as is                                   
         MVI   TRNSSTAT,X'80'      Set as a debit                               
         CLI   JBNEWEST,JBMCSQ     for MCS estimates                            
         BE    JOBEST50                                                         
         MVI   SVCOLTYP,JBCOLTWC   Keep as is                                   
*                                                                               
JOBEST25 CLI   MODE,PROCACC                                                     
         BE    JOBEST28                                                         
         CLI   MODE,ACCLAST                                                     
         BE    JOBEST28                                                         
         CLI   MODE,ANALFRST                                                    
         BE    *+6                                                              
         DC    H'00'                                                            
*                                                                               
         MVI   SVCOLTYP,PROCESD    Mark as C'X' for processed                   
         CLC   JBCOLWC,CURWKCD     Match on workcode                            
         BNE   JOBEST38                                                         
         CLI   JBCOLTYP,JBCOLTWC   Workcode type                                
         BE    JOBEST32            Yes so ok                                    
         CLI   JBCOLTYP,PROCESD    Processed once for recap                     
         BE    JOBEST32            Yes, so process for this recap               
         B     JOBEST38            No, Skip this entry                          
*                                                                               
JOBEST28 CLI   JBCOLTYP,JBCOLTWC   Workcode type ?                              
         BNE   JOBEST38                                                         
         GOTO1 AFILTER,DMCB,AFLTWC,JBCOLWC                                      
         BNE   JOBEST38                                                         
         MVC   CURWKCD,JBCOLWC     Set current workcode                         
         GOTO1 =A(SETWKCD)         Set other workcode data                      
         BNE   JOBEST38                                                         
*                                                                               
JOBEST32 ST    R2,JOBRBLK                                                       
         MVC   JBCOLTYP,SVCOLTYP   Mark accordingly by mode                     
         MVC   CURSUBAC,SPACES     Clear current Sub-account                    
         CLC   JBCOL1R,SPACES                                                   
*&&US*&& BNH   JOBEST36                                                         
*&&UK*&& BL    JOBEST36                                                         
*&&UK*&& BH    JOBEST34                                                         
*&&UK*&& MVI   CURSUBAC+1,X'41'    Prevents WC level being ignored              
*&&UK*&& B     *+10                                                             
                                                                                
JOBEST34 MVC   CURSUBAC+1(L'JBCOL1R),JBCOL1R        New contra                  
         GOTO1 SETCNTR,DMCB,CURSUBAC+1                                          
         GOTO1 AFILTER,DMCB,AFLTCTRA,CURSUBAC+1                                 
         BNE   JOBEST38                                                         
*                                                                               
JOBEST36 GOTO1 ARECORD,DMCB,('POSTJBR',ABUDWRK),('POSTCLR',1)                   
         OI    POSTMODE,POSTJBR                                                 
         GOTO1 APUTREC,DMCB,ABUDWRK,1                                           
         NI    POSTMODE,TURNOFF-POSTJBR                                         
*                                                                               
JOBEST38 AH    R2,JBLCOL           Process next in table                        
         BCT   R0,JOBEST25                                                      
         B     JOBEST90                                                         
*                                                                               
         USING MJETABD,R2                                                       
JOBEST50 DS    0H                                                               
*                                                                               
JOBEST55 XR    RE,RE               first entry for totals                       
         IC    RE,MJETLEN                                                       
         AR    R2,RE                                                            
         CLI   MJETTYP,MJETTEQ                                                  
         BE    JOBEST90                                                         
         CLI   MJETTYP,MJETTWQ                                                  
         BE    JOBEST56                                                         
         CLI   MJETTYP,PROCESD     Marked as processed?                         
         BNE   JOBEST55                                                         
*                                                                               
JOBEST56 CLI   MODE,PROCACC                                                     
         BE    JOBEST60                                                         
         CLI   MODE,ACCLAST                                                     
         BE    JOBEST60                                                         
         CLI   MODE,ANALFRST                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVI   SVCOLTYP,PROCESD    Mark as processed                            
*                                                                               
         CLC   MJETWCD,CURWKCD     Match on workcode                            
         BNE   JOBEST55                                                         
         CLI   MJETTYP,MJETTWQ                                                  
         BE    JOBEST70                                                         
         CLI   MJETTYP,PROCESD     Marked as processed                          
         BE    JOBEST70                                                         
         B     JOBEST55                                                         
*                                                                               
JOBEST60 CLI   MJETTYP,MJETTWQ                                                  
         BNE   JOBEST55                                                         
         GOTO1 AFILTER,DMCB,AFLTWC,MJETWCD                                      
         BNE   JOBEST55                                                         
         MVC   CURWKCD,MJETWCD     Set current workcode                         
         GOTO1 =A(SETWKCD)         Set other workcode data                      
         BNE   JOBEST55                                                         
*                                                                               
JOBEST70 ST    R2,JOBRBLK                                                       
         MVC   MJETTYP,SVCOLTYP    Mark accordingly by mode                     
         CLC   MJET1RA,SPACES                                                   
         BH    JOBEST76                                                         
         MVC   CURSUBAC,SPACES     Clear current Sub-account                    
         BL    JOBEST80                                                         
         MVI   CURSUBAC+1,X'41'                                                 
         B     *+10                                                             
JOBEST76 MVC   CURSUBAC+1(2),=C'1R'      New contra                             
         MVC   CURSUBAC+3(L'MJET1RA),MJET1RA                                    
         GOTO1 SETCNTR,DMCB,CURSUBAC+1                                          
         GOTO1 AFILTER,DMCB,AFLTCTRA,CURSUBAC+1                                 
         BNE   JOBEST55                                                         
*                                                                               
JOBEST80 GOTO1 =A(GETITM)          Get ITEM information                         
         GOTO1 ARECORD,DMCB,('POSTJBR',ABUDWRK),('POSTCLR',1)                   
         OI    POSTMODE,POSTJBR                                                 
         GOTO1 APUTREC,DMCB,ABUDWRK,1                                           
         NI    POSTMODE,TURNOFF-POSTJBR                                         
         NI    POSTLVL,TURNOFF-POSTAITM                                         
         B     JOBEST55                                                         
*                                                                               
JOBEST90 MVC   CURSUBAC,SPACES     Clear current Sub-account                    
         MVC   ADSUBAC,SVSUBAC     Restore data from ACMASTER                   
         B     JOBESTE                                                          
*                                                                               
JOBESTNO CLI   *,X'FF'             SET CC = LOW                                 
         J     JOBESTX                                                          
JOBESTE  CR    RB,RB               SET CC = EQUAL                               
JOBESTX  XIT1                                                                   
         SPACE 1                                                                
*----------------------------------------                                       
* STORAGE FOR JOBEST                                                            
*----------------------------------------                                       
SVSUBAC  DS    A                                                                
SVCOLTYP DS    CL1                                                              
         DROP  R2,R3,R4                                                         
         EJECT                                                                  
         LTORG                                                                  
         TITLE 'READ ACCOUNT EXTENSION RECORD AEXRECD'                          
*&&UK                                                                           
***********************************************************************         
*  GET CLIENT PURCHASE ORDER NUMBERS AND AMOUNTS                      *         
***********************************************************************         
         SPACE 1                                                                
         USING AEXRECD,R2                                                       
GETCPO   NMOD1 0,**GCLPO*                                                       
         L     RC,RLBASEC                                                       
*                                                                               
         L     RE,ACLPORD          Clear client PO table                        
         LA    RF,MAXCLPOS                                                      
         XR    R0,R0                                                            
         XR    R1,R1                                                            
         MVCL  RE,R0                                                            
*                                                                               
         LA    R4,12               SAVE UP TO 12 POs ONLY                       
*                                                                               
         LA    R2,IOKEY                                                         
         XC    AEXKEY,AEXKEY                                                    
         MVI   AEXKTYP,AEXKTYPQ                                                 
         MVI   AEXKSUB,AEXKSUBQ                                                 
         MVC   AEXKCPY,RCCOMPFL                                                 
         MVC   AEXKULA,CURACC+1                                                 
*                                                                               
         L     R1,=AL4(IOREAD+IOACDIR+IOAREA2)                                  
         GOTO1 AIO                                                              
         BNE   GCPOX                                                            
         L     R1,=AL4(IOGETREC+IOACMST+IOAREA2)                                
         GOTO1 AIO                                                              
*                                                                               
         L     RE,ACLPORD                                                       
         ST    RE,FULL                                                          
         L     R3,AIO2                                                          
                                                                                
         USING LIDELD,R3                                                        
         LA    R3,AEXRFST-AEXRECD(R3)                                           
GCPO00   CLI   0(R3),0                                                          
         BE    GCPOX                                                            
         CLI   0(R3),LIDELQ                                                     
         BNE   GCPO02                                                           
         CLI   LIDTYPE,LIDTCPO                                                  
         BE    *+14                                                             
GCPO02   IC    R0,LIDLN                                                         
         AR    R3,R0                                                            
         B     GCPO00                                                           
                                                                                
         LR    RF,R3                                                            
         IC    R0,LIDLN                                                         
         AR    RF,R0         RF=A(END OF LIDEL)                                 
                                                                                
         LA    R6,LIDDATA                                                       
                                                                                
GCPO04   L     RE,FULL                                                          
         MVC   0(LIDLLN7Q,RE),0(R6)                                             
         OC    L'LIDCPO(L'LIDCPOAM,RE),L'LIDCPO(RE)                             
         BNZ   *+10                                                             
         ZAP   L'LIDCPO(L'LIDCPOAM,RE),PKZERO                                   
         AHI   RE,LIDLLN7Q                                                      
         AHI   R6,LIDLLN7Q                                                      
         ST    RE,FULL                                                          
         SHI   R4,1                                                             
         LTR   R4,R4                                                            
         BZ    GCPOX                                                            
         CR    R6,RF               END OF ELEMENT?                              
         BL    GCPO04                                                           
         B     GCPO02              YES                                          
                                                                                
GCPOX    XIT1                                                                   
         DROP  R2,R3                                                            
         SPACE 1                                                                
*&&                                                                             
**********************************************************************          
*  Process NON-JOBBER estimate table for workcode estimate data      *          
**********************************************************************          
         SPACE 1                                                                
*                                                                               
         USING ACWORKD,RC                                                       
NJEST    NMOD1 0,**NJEST*                                                       
         L     RC,RLBASEC                                                       
         TM    ACTIVITY,ACTEST     Did we have estimates ?                      
         BO    *+16                Yes so do we want the transactions ?         
         TM    FMTROPT4,RPFOESTO   Only jobs with estimates ?                   
         BO    NJESTNO             Process next format                          
         B     *+12                                                             
         TM    FMTROPT4,RPFXESTO   Only jobs without estimates ?                
         BO    NJESTNO             Process next format                          
*                                                                               
         MVI   TRNSSTAT,X'80'      Set as a debit                               
*                                                                               
         USING ESTWCD,R2                                                        
         L     R2,ESTWCTB          Estimate workcode table                      
         XR    R3,R3                                                            
         ICM   R3,3,#OFEST                                                      
         BZ    NJEST90             Empty table                                  
*                                                                               
NJEST10  MVC   SVPRCIN,ESTWIND                                                  
         CLI   MODE,PROCACC                                                     
         BE    NJEST60                                                          
         CLI   MODE,ACCLAST                                                     
         BE    NJEST60                                                          
         CLI   MODE,ANALFRST                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         OI    SVPRCIN,ESTWPRCD                                                 
         CLC   ESTWL#,CURLCNO      Match on local number                        
         BNE   NJEST55                                                          
         CLC   ESTWC,CURWKCD       Match on workcode                            
         BE    NJEST60                                                          
*                                                                               
NJEST55  LA    R2,ESTWLNQ(R2)                                                   
         BCT   R3,NJEST10                                                       
         B     NJEST90                                                          
*                                                                               
NJEST60  TM    ESTWIND,ESTWPRCD    Processed?                                   
         BNZ   NJEST55                                                          
         TM    ESTWIND,ESTW1RQ     test time-level entry                        
         BNZ   NJEST62             yes, w/c already established                 
         GOTO1 AFILTER,DMCB,AFLTWC,ESTWC                                        
         BNE   NJEST55                                                          
         MVC   CURWKCD,ESTWC       Set current workcode                         
         GOTO1 =A(SETWKCD)         Set other workcode data                      
         BNE   NJEST55                                                          
         MVC   CURSUBAC,SPACES                                                  
         B     NJEST64                                                          
*                                                                               
NJEST62  MVC   CURSUBAC(1),RCCOMPFL  Set 1R account as 'contra'                 
         MVC   CURSUBAC+1(2),=C'1R'                                             
         MVC   CURSUBAC+3(L'ESTW1R),ESTW1R                                      
         GOTO1 SETCNTR,DMCB,CURSUBAC+1           Set a/c lvls                   
         GOTO1 AFILTER,DMCB,AFLTCTRA,CURSUBAC+1  and filter                     
         BNE   NJEST55                           not required                   
*                                                                               
NJEST64  MVC   ESTWIND,SVPRCIN                                                  
*                                                                               
         USING ESTMD,RF                                                         
         L     RF,ESTMAIN                                                       
NJEST66  CLI   0(RF),EOT                                                        
         BE    NJEST55             should die really                            
         CLC   ESTML#,ESTWL#                                                    
         BE    *+12                                                             
         AHI   RF,ESTMLNQ                                                       
         B     NJEST66                                                          
         ST    RF,NJEMBLK                                                       
         ST    R2,NJEWBLK                                                       
*                                                                               
         MVC   CURLCNO,ESTWL#                                                   
         TM    ESTIND,ESTNOS       Test monetary est. kywds in use              
         BNZ   NJEST68                                                          
*                                  If ONLY hours est. keywords:                 
         CP    ESTTHRS,PKZERO      test any hours to report                     
         BZ    NJEST70             No - so skip this line                       
         MVI   BYTE,NO             Init                                         
NJEST68  GOTO1 ARECORD,DMCB,('POSTJBR',ABUDWRK),('POSTCLR',1)                   
         CLI   BYTE,YES            Test any non-zero values                     
         BNE   NJEST70             No - so skip this line                       
         OI    POSTMODE,POSTJBR                                                 
*                                                                               
         GOTO1 APUTREC,DMCB,ABUDWRK,1                                           
                                                                                
NJEST70  XC    NJEWBLK,NJEWBLK                                                  
         XC    NJEMBLK,NJEMBLK                                                  
         NI    POSTMODE,TURNOFF-POSTJBR                                         
         B     NJEST55                                                          
*                                                                               
NJEST90  XC    CURLCNO,CURLCNO     Clear current estimate local number          
*                                                                               
         SR    RE,RE               Set condition code to     equal              
NJESTNO  LTR   RE,RE               set condition code to not equal              
         XIT1                                                                   
         SPACE 1                                                                
SVPRCIN  DS    XL1                                                              
         DROP  R2                                                               
         EJECT ,                                                                
***********************************************************************         
*        Estimate block for MCS estimates                             *         
*            P1 = IO of estimate record ESTRECD                       *         
*            P2 = Area to fill          ESTD                          *         
***********************************************************************         
         USING ESTD,R5                                                          
         USING ESTRECD,R3                                                       
SETMED   NTR1                                                                   
         L     R3,0(,R1)           IO area                                      
*&&US*&& ST    R3,SVREG                                                         
         L     R5,4(,R1)           Area to fill                                 
*&&US                                                                           
         MVI   ESTSTAT1,0                                                       
         MVC   ESTSTAT1,ESTRSTA1                                                
         NI    ESTSTAT1,TURNOFF-ESTKDELT-ESTKLOGD                               
         TM    ESTRSTA2,ESTKMERG                                                
         JZ    *+8                                                              
         OI    ESTSTAT1,ESTME                                                   
         TM    ESTRSTA2,ESTKSINA                                                
         JZ    *+8                                                              
         OI    ESTSTAT1,ESTSI                                                   
*&&                                                                             
*&&UK                                                                           
         MVC   ESTSTAT1,ESTRSTA1                                                
         MVC   ESTSTAT2,ESTRSTA2                                                
         MVC   ESTSTAT3,ESTRSTA3                                                
*&&                                                                             
         USING EMDELD,R3                                                        
         AH    R3,DATADISP                                                      
                                                                                
SETMED05 CLI   EMDEL,EOR           End of record                                
*&&US*&& JE    SETMED44                                                         
*&&UK*&& JE    SETMEDX                                                          
         CLI   EMDEL,EMDELQ                                                     
         JE    SETMED15                                                         
         CLI   EMDEL,ENMELQ                                                     
         JE    SETMED20                                                         
         CLI   EMDEL,STCELQ                                                     
         JE    SETMED25                                                         
                                                                                
SETMED10 ZIC   RF,1(,R3)                                                        
         AR    R3,RF                                                            
         J     SETMED05                                                         
                                                                                
SETMED15 DS    0H                                                               
         MVC   ESTADTE,EMDADT      When added                                   
         MVC   ESTLDTE,EMDLDT      When last updated                            
         J     SETMED10                                                         
                                                                                
         USING ENMELD,R3                                                        
SETMED20 XR    R1,R1                                                            
         IC    R1,ENMLN                                                         
         SHI   R1,ENMLNQ                                                        
         CHI   R1,L'ESTNME1+L'ESTNME2                                           
         JL    *+8                                                              
         LHI   R1,L'ESTNME1+L'ESTNME2                                           
         SHI   R1,1                                                             
         MVC   ESTNME1(L'ESTNME1+L'ESTNME2),SPACES                              
         BASR  RE,0                RE=A(NEXT INSTRUCTION)                       
         MVC   ESTNME1(0),ENMNAME                                               
         EX    R1,0(RE)                                                         
         J     SETMED10                                                         
                                                                                
         USING STCELD,R3                                                        
SETMED25 CLI   STCIND,STCIEST                                                   
         JNE   SETMED32                                                         
*&&UK                                                                           
         LA    RE,ESTPRPR          Preparer by                                  
         LA    R1,ESTPRDT          Preparer date                                
         CLI   STCDTO,C'S'                                                      
         JE    SETMED30                                                         
*&&                                                                             
         LA    RE,ESTAPRV          Approved by                                  
         LA    R1,ESTAPDT          Approval date                                
         CLI   STCDTO,C'A'                                                      
         JNE   SETMED10                                                         
SETMED30 MVC   0(L'STCPERS,RE),STCPERS                                          
         MVC   0(L'STCDATE,R1),STCDATE                                          
         MVI   L'ESTAPRV-1(RE),X'00' Indicate BrandO pid for diff edit          
         J     SETMED10                                                         
                                                                                
SETMED32 CLI   STCIND,STCIEST2     Aura style audit element                     
         JNE   SETMED10                                                         
         CLI   STCETY2,STCAPDTE    Look for approval date                       
         JNE   SETMED10                                                         
         MVC   ESTAPRV,STCPERS     Approved by                                  
         MVI   ESTAPRV+L'ESTAPRV-1,X'00'                                        
         MVC   ESTAPDT,STCECAPD    Approval date                                
         J     SETMED10                                                         
         DROP  R3                                                               
*&&US                                                                           
         USING ESTRECD,R3                                                       
SETMED44 DS    0H                                                               
         L     R3,SVREG                                                         
         XC    IOKEY,IOKEY         Read audit records for brandocean            
         LA    R2,IOKEY                                         only            
         USING AUDRECD,R2                                                       
         MVI   AUDKTYP,AUDKTYPQ                                                 
         MVI   AUDKSUB,AUDKSUBQ                                                 
         MVC   AUDKCPY,ESTKCPY                                                  
         MVI   AUDKAUDT,AUDKEST                                                 
         LA    R1,AUDKECPJ                                                      
         MVC   0(L'ESTKCLI,R1),ESTKCLI                                          
         AHI   R1,L'ESTKCLI                                                     
         MVC   0(L'ESTKPRO,R1),ESTKPRO                                          
         AHI   R1,L'ESTKPRO                                                     
         MVC   0(L'ESTKJOB,R1),ESTKJOB                                          
         OC    AUDKECPJ,SPACES                                                  
         MVC   AUDKELNO,ESTKLNO                                                 
         L     R4,AIO3                                                          
         L     R1,SVRF                                                          
         GOTOR AIO                                                              
         CLC   IOKEY(AUDKSEQ-AUDRECD),0(R4)                                     
         JE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         USING STCELD,R4                                                        
         AH    R4,DATADISP                                                      
                                                                                
SETMED46 CLI   STCEL,EOR           End of record                                
         JE    SETMEDX                                                          
         CLI   STCEL,STCELQ                                                     
         JE    SETMED50                                                         
                                                                                
SETMED48 ZIC   RF,1(,R4)                                                        
         AR    R4,RF                                                            
         J     SETMED46                                                         
                                                                                
SETMED50 CLI   STCIND,STCIEST                                                   
         JNE   SETMED60                                                         
         LA    RE,ESTPRPR          Preparer by                                  
         LA    R1,ESTPRDT          Preparer date                                
         CLI   STCDTO,C'S'                                                      
         JNE   SETMED48                                                         
         MVC   0(L'STCPERS,RE),STCPERS                                          
         MVC   0(L'STCDATE,R1),STCDATE                                          
         MVI   L'ESTAPRV-1(RE),X'00' Indicate BrandO pid for diff edit          
         J     SETMED48                                                         
*                                                                               
SETMED60 CLI   STCIND,STCIEST2     Aura style audit element                     
         JNE   SETMED48                                                         
         CLI   STCETY2,STCAPDTE    Look for approval date                       
         JNE   SETMED48                                                         
         MVC   ESTAPRV,STCPERS     Approved by                                  
         MVI   ESTAPRV+L'ESTAPRV-1,X'00'                                        
         MVC   ESTAPDT,STCECAPD    Approval date                                
         J     SETMED48                                                         
*                                                                               
         DROP  R2,R3,R4                                                         
*&&                                                                             
SETMEDX  DS    0H                                                               
         J     PRCESTX                                                          
         DROP  R5                                                               
         EJECT ,                                                                
***********************************************************************         
*        Workcode block for MCS estimates                             *         
*            P1 = IO of estimate record ESTRECD                       *         
*            P2 = Area to fill          WCID                          *         
***********************************************************************         
         USING WCID,R5                                                          
         USING ERDELD,R3                                                        
SETITM   NTR1                                                                   
         L     R3,0(,R1)           IO area                                      
         L     R5,4(,R1)           Area to fill                                 
         AH    R3,DATADISP                                                      
         XR    RF,RF                                                            
*                                                                               
SETITM02 CLI   ERDEL,EOR           End of record                                
         JE    SETITMX                                                          
         CLI   ERDEL,ERDELQ        Look for Estimate Row data                   
         JE    SETITM06                                                         
*                                                                               
SETITM04 IC    RF,1(,R3)           Get next element                             
         AR    R3,RF                                                            
         J     SETITM02                                                         
*                                                                               
SETITM06 CLI   ERDTYP,ERDTWDQ      Is this a WORKCODE?                          
         JNE   SETITM08            No                                           
         MVC   SVWORKC,ERDWCOD     Yes, save the WORKCODE                       
*                                                                               
         USING ACGOD,R2                                                         
         L     R2,ADGOBLOC                                                      
         MVC   GOSELWC,ERDWCOD       set it in GOBLOCK                          
         XC    GOAKEY,GOAKEY                                                    
         STCM  RF,15,SVRF                                                       
         GOTO1 GETOPT,DMCB,ADGOBLOC                                             
         L     RF,SVRF                                                          
*                                                                               
SETITM08 CLI   ERDTYP,ERDTIDQ      No, is this an ITEM?                         
         JNE   SETITM04            No, look at next element                     
         MVC   WCIWRK,SVWORKC      Save WORKCODE                                
         MVC   WCIITMC,ERDICOD     Save ITEM CODE                               
         MVC   WCIITMD,ERDIDES     Save ITEM DESCRIPTION                        
         ZAP   WCIAPRC,ERDIAPR     Save Agency Price                            
         ZAP   WCIHRS,ERDIMUL      Save Hours                                   
         ZAP   WCICRAT,GOAGYCOM    Save Rate                                    
*                                                                               
         ZAP   OP1,ERDIAPR         Get agency amount                            
         MP    OP1,ERDIMUL         Times multiplier                             
         SRP   OP1,64-2,5          Shift to get it correct                      
         ZAP   WCINAMT,OP1         Save results as Net Amount                   
*                                                                               
         ZAP   OP1,WCINAMT         Net Amount                                   
         MP    OP1,WCICRAT         Times Rate                                   
         SRP   OP1,64-6,5          Shift to get it correct                      
         ZAP   WCICAMT,OP1         Save results as Commission amount            
*                                                                               
         ZAP   WCIGAMT,WCINAMT     Calculate Gross Amount                       
         AP    WCIGAMT,WCICAMT                                                  
*                                                                               
         LA    R5,WCILNQ(R5)       Bump the table                               
         ST    R5,AWCINXT                                                       
         J     SETITM04            Move in the next WORKCODE                    
                                                                                
SETITMX  DS    0H                                                               
         J     PRCESTX                                                          
         DROP  R3,R5                                                            
         EJECT ,                                                                
*&&DO                                                                           
***********************************************************************         
*        Get pid name from Security records for MCS estimates                   
*        R3 points to STCEL element                                             
*        On Exit - WORK contains the 8 byte pid name                            
***********************************************************************         
         USING SA0REC,R2                                                        
         USING STCELD,R3                                                        
GETPIDNM NTR1                                                                   
         MVC   WORK,SPACES                                                      
         LA    R2,IOKEY            Convert 2 byte pid to 8 byte                 
         XC    SA0KEY,SA0KEY       pid name                                     
         MVI   SA0KTYP,SA0KTYPQ    C'0'                                         
         MVC   SA0KAGY,SECALPHA                                                 
         MVC   SA0KNUM,STCPERS                                                  
         GOTO1 AIO,IOREAD+IOCNTRL+IOAREA3                                       
         BNE   GETPIDX             Okay for now                                 
                                                                                
         L     R2,AIO3                                                          
         LA    R2,SA0DATA          1st element                                  
GETPID10 CLI   0(R2),0                                                          
         BE    GETPIDX                                                          
*                                                                               
         USING SAPALD,R2                                                        
         CLI   0(R2),SAPALELQ      X'C3' PERSON ID                              
         BNE   GETPID20                                                         
         MVC   WORK(L'SAPALPID),SAPALPID                                        
         B     GETPIDX                                                          
*                                                                               
GETPID20 SR    RF,RF                                                            
         IC    RF,1(,R2)                                                        
         AR    R2,RF                                                            
         B     GETPID10                                                         
*                                                                               
GETPIDX  XIT1                                                                   
         DROP  R2,R3                                                            
*                                                                               
         LTORG                                                                  
         EJECT ,                                                                
*&&                                                                             
***********************************************************************         
*        Estimate block                                                         
*            P1 = IO of estimate record EVERECD                                 
*            P2 = Area to fill          ESTD                                    
***********************************************************************         
         USING ESTD,R5                                                          
SETEST   NTR1                                                                   
         L     R3,0(,R1)           IO area                                      
         L     R5,4(,R1)           Area to fill                                 
         AH    R3,DATADISP                                                      
*                                                                               
SETEST05 CLI   0(R3),EOR           End of record                                
         JE    SETESTX                                                          
         CLI   0(R3),EUPELQ        X'A9' Dates                                  
         JE    SETEST10                                                         
         CLI   0(R3),ENAELQ        X'AA' Titles (estimate name)                 
         JE    SETEST20                                                         
         CLI   0(R3),EAPELQ        X'AB' Approver                               
         JE    SETEST30                                                         
         CLI   0(R3),EPRELQ        X'B1' Preparer                               
         JE    SETEST40                                                         
SETEST08 ZIC   RF,1(,R3)                                                        
         AR    R3,RF                                                            
         J     SETEST05                                                         
                                                                                
         USING EUPELD,R3                                                        
SETEST10 MVC   ESTADTE,EUPADD      When added                                   
         MVC   ESTLDTE,EUPLAST     When last updated                            
         J     SETEST08                                                         
                                                                                
         USING ENAELD,R3                                                        
SETEST20 ZIC   R1,ENALN                                                         
         SHI   R1,(ENAME-ENAELD)+1                                              
         LA    RE,ESTNME1          Heading 1                                    
         CLI   ENANUM,1                                                         
         JNH   SETEST25                                                         
         LA    RE,ESTNME2          Heading 2                                    
SETEST25 MVC   0(L'ESTNME1,RE),SPACES                                           
         BASR  RF,0                RF = A(Next Instuction)                      
         MVC   0(0,RE),ENAME                                                    
         EX    R1,0(RF)                                                         
         J     SETEST08                                                         
                                                                                
         USING EAPELD,R3                                                        
SETEST30 MVC   ESTAPRV,EAPPBY      Approved by                                  
         MVC   ESTAPDT,EAPDATE     Approval date                                
         J     SETEST08                                                         
                                                                                
         USING EPRELD,R3                                                        
SETEST40 MVC   ESTPRPR,EPRPREP     Preparer by                                  
         MVC   ESTPRDT,EPRDATE     Preparer date                                
         J     SETEST08                                                         
                                                                                
SETESTX  J     PRCESTX                                                          
         DROP  R3,R5                                                            
*                                                                               
         LTORG                                                                  
         EJECT ,                                                                
*&&US                                                                           
***********************************************************************         
*  PROCESS PRODUCTION VENDER INFORMATION                              *         
***********************************************************************         
         USING CFWELD,R3                                                        
JOB      USING TRNELD,R4                                                        
         USING FMTRECD,R5                                                       
         USING ACRL2D,R7                                                        
VDRKEY   USING TRNRECD,IODIRKEY                                                 
*                                                                               
PRPVND   NMOD1 0,**PVND**                                                       
         L     RC,RLBASEC                                                       
         L     R7,AACRL2D                                                       
         L     R3,ACFWELS                CashFlow elements                      
         L     R4,ADTRANS                                                       
         XC    CFWEL(CFWVLNQ+1),CFWEL    Init the element                       
         MVC   CFWVCNO,SPACES            Vendor check number                    
         XC    CFWVCDT,CFWVCDT           Vendor check date                      
         XC    CFWVCDI,CFWVCDI           Internal Vendor check date             
         XC    CFWVSTA,CFWVSTA           Vendor check status                    
*                                                                               
         TM    JOB.TRNSTAT,TRNSDR        Production Debit?                      
         BZ    PRPVNDX                   No vendor info                         
         ZAP   DBAL,PKZERO                                                      
         XC    DAYS,DAYS                                                        
         ZAP   PRPVGRS,JOB.TRNAMNT       Net amount of prod trans               
                                                                                
         USING SCIELD,RF                                                        
         ICM   RF,15,AELEM50                                                    
         BZ    PRPV10                                                           
         CLI   SCITYPE,SCITCOMM          Commission sciel?                      
         BNE   PRPV10                                                           
         SP    PRPVGRS,SCIAMNT           subtract commission                    
         DROP  RF                                                               
*                                                                               
PRPV10   ICM   R6,15,AELEMD4             X'D4'-Payable Key element              
         BNZ   PRPV20                                                           
         CLI   JOB.TRNTYPE,TRNTORD       Order?                                 
         BE    PRPVNDX                   . yes, no info                         
         OI    CURIND,CURINCHG           Internal charge                        
         GOTOR DATCON,DMCB,(1,JOB.TRNDATE),(2,CFWVCDI)                          
         GOTOR DATCON,DMCB,(1,JOB.TRNDATE),(0,WORK)                             
         GOTOR PERVERT,DMCB,TODAYC,WORK                                         
         LH    RF,8(,R1)                                                        
         LHI   RE,-1                     Less one for non-inclusive             
         CHI   RF,0                                                             
         BP    *+8                                                              
         LHI   RE,1                                                             
         AR    RF,RE                                                            
         STCM  RF,3,DAYS                 Days based on trans date               
         CVD   RF,DUB                                                           
         ZAP   OP1,JOB.TRNAMNT                                                  
         MP    OP1,DUB+4(4)                                                     
         ZAP   DBAL,OP1                  Daily balance                          
         B     PRPVNDX                                                          
*                                                                               
         USING PAKELD,R6                 Prod Payable key element x'D4'         
PRPV20   XC    VDRKEY.TRNKEY,VDRKEY.TRNKEY                                      
         CLI   NEWOFF,YES                                                       
         BE    *+10                                                             
         MVC   PAKOFF,SPACES             Single office, not in key              
         MVC   VDRKEY.TRNKEY(TRNKEND-1),PAKACC    Payable key                   
         L     R1,=AL4(IOHIGH+IOACDIR+IOAREA2)                                  
         GOTO1 AIO                                Read for Payable              
         BNE   PRPVNDX                                                          
                                                                                
         USING TRNRECD,R2                                                       
PRPV25   L     R2,AIO2                                                          
         CLC   TRNKEY(TRNKEND-1),PAKACC  Payable found?                         
         BNE   PRPVNDX                   . no                                   
*                                                                               
         L     R1,=AL4(IOGETREC+IOACMST+IOAREA2)                                
         GOTO1 AIO                                                              
         BNE   PRPVNDX                                                          
         DROP  R6                                                               
         DROP  VDRKEY                                                           
*                                                                               
         LA    R2,TRNRFST                First element on payable               
PRPV30   CLI   0(R2),EOR                 End of record                          
         BE    PRPVNDX                                                          
         CLI   0(R2),TRNELQ              X'44'-Transaction Element              
         BE    PRPV40                                                           
         CLI   0(R2),TRSELQ              X'60'-Transaction Status Elem          
         BE    PRPV60                                                           
         CLI   0(R2),OTHELQ              X'23'-Others Element                   
         BE    PRPV80                                                           
         CLI   0(R2),MPYELQ              X'64'-Manual Payment Element           
         BE    PRPV90                                                           
PRPV32   SR    RF,RF                                                            
         IC    RF,1(,R2)                 next element                           
         AR    R2,RF                                                            
         B     PRPV30                                                           
*----------------------------------------                                       
* Transaction Element  X'44'                                                    
*----------------------------------------                                       
VNDR     USING TRNELD,R2                                                        
*                                                                               
PRPV40   TM    VNDR.TRNSTAT,TRNSDR       Only need the credits                  
         BO    PRPV100                                                          
         TM    JOB.TRNSTAT,TRNSREV       Is the job trans reversed?             
         BZ    *+16                                                             
         TM    VNDR.TRNSTAT,TRNSREV      Yes so make sure vndr is rev           
         BZ    PRPV100                                                          
         B     *+12                                                             
         TM    VNDR.TRNSTAT,TRNSREV      No so make sure vnd is not rev         
         BO    PRPV100                                                          
*                                                                               
         CLI   JOB.TRNTYPE,TRNTJBTX      Job Transfer X'34'?                    
         BNE   PRPV48                    . yes, do not match on batch           
*                                                                               
         USING PXDELD,RE                                                        
         ICM   RE,15,AELEM4E             First x'4e' elem                       
         BZ    PRPV50                    None                                   
PRPV44   CLI   PXDEL,0                   end of record                          
         BE    PRPV50                                                           
         CLI   PXDEL,PXDELQ              X'4E' - XFER DETAIL ELEM               
         BNE   *+12                                                             
         CLI   PXDTYPE,PXDTORG           C'O' - ORIGINAL JOB                    
         BE    PRPV46                                                           
         SR    R0,R0                                                            
         IC    R0,1(,RE)                 next element                           
         AR    RE,R0                                                            
         B     PRPV44                                                           
                                                                                
PRPV46   CLI   PXDLN,PXDLN2Q                                                    
         BL    PRPV50                                                           
         CLC   VNDR.TRNBTCH,PXDOBAT      Match on batch reference               
         BE    PRPV50                    Found matching batch ref               
         B     PRPV100                                                          
*                                                                               
PRPV48   CLC   VNDR.TRNBTCH,JOB.TRNBTCH  Match on batch reference               
         BNE   PRPV100                                                          
                                                                                
PRPV50   ZAP   CFWVUND,PRPVGRS                                                  
         MVC   CFWVSTA,VNDR.TRNSTAT      Status of transaction                  
         MVI   CFWEL,CFWELQ              Cashflow element                       
         MVI   CFWLN,CFWVLNQ             Element length                         
         MVI   CFWTYP,CFWTYVQ            1 = Vendor information                 
         XC    CFWDAYS,CFWDAYS                                                  
         ZAP   CFWVDIS,PKZERO                                                   
         ZAP   CFWDBAL,PKZERO                                                   
         B     PRPV32                                                           
         DROP  RE                                                               
         DROP  VNDR                                                             
*----------------------------------------                                       
* Transaction Status Element X'60'                                              
*----------------------------------------                                       
VNDR60   USING TRSELD,R2                                                        
                                                                                
PRPV60   DS    0H                                                               
JOB60    USING TRSELD,RF                                                        
         L     RF,AELEM60                                                       
         TM    JOB60.TRSSTAT,TRSSOFFS    Is the job trans offset?               
         BZ    *+16                                                             
         TM    VNDR60.TRSSTAT,TRSSOFFS   Yes so make sure vndr is offs          
         BZ    PRPV100                                                          
         B     *+12                                                             
         TM    VNDR60.TRSSTAT,TRSSOFFS   No make sure vndr is not offs          
         BO    PRPV100                                                          
         DROP  JOB60                                                            
*                                                                               
         CLI   JOB.TRNTYPE,TRNTJBTX      Job Transfer X'34'?                    
         BNE   PRPV72                    . Yes, Do not check bseq               
*                                                                               
         USING PXDELD,RE                                                        
         ICM   RE,15,AELEM4E             First x'4e' elem                       
         BZ    PRPV32                    None                                   
PRPV65   CLI   PXDEL,EOR                 End Of Record                          
         BE    PRPV32                                                           
         CLI   PXDEL,PXDELQ              X'4E' - XFER DETAIL ELEM               
         BNE   *+12                                                             
         CLI   PXDTYPE,PXDTORG           C'O' - ORIGINAL JOB                    
         BE    PRPV70                                                           
         SR    R0,R0                                                            
         IC    R0,1(,RE)                 next element                           
         AR    RE,R0                                                            
         B     PRPV65                                                           
*                                                                               
PRPV70   CLI   PXDLN,PXDLN2Q                                                    
         BL    PRPV32                                                           
         CLC   VNDR60.TRSBSEQ,PXDOSEQ    Match on original batch seq.           
         BE    PRPV32                                                           
         B     PRPV100                                                          
*                                                                               
JOB60    USING TRSELD,RF                                                        
*                                                                               
PRPV72   L     RF,AELEM60                                                       
         CLC   VNDR60.TRSBSEQ,JOB60.TRSBSEQ   Match on batch line #             
         BNE   PRPV100                                                          
*                                                                               
PRPV74   TM    CFWVSTA,TRNSREV           Reversal?                              
         BZ    PRPV76                    . No                                   
         GOTOR DATCON,DMCB,(2,VNDR60.TRSREVD),(2,CFWVCDT)                       
         B     PRPV78                                                           
PRPV76   TM    VNDR60.TRSSTAT,TRSSOFFS   Offset Item?                           
         BZ    PRPV32                    . No                                   
         MVC   CFWVCDT,VNDR60.TRSUDAT    . Yes, Offset Date                     
*                                                                               
PRPV78   GOTOR DATCON,DMCB,(2,CFWVCDT),(0,WORK)                                 
         GOTOR PERVERT,DMCB,TODAYC,WORK                                         
         LH    RF,8(,R1)                                                        
         LHI   RE,-1                     Less one for non-inclusive             
         CHI   RF,0                                                             
         BP    *+8                                                              
         LHI   RE,1                                                             
         AR    RF,RE                                                            
         STCM  RF,3,CFWDAYS                                                     
         CVD   RF,DUB                                                           
         ZAP   OP1,CFWVUND                                                      
         MP    OP1,DUB+4(4)                                                     
         ZAP   CFWDBAL,OP1                                                      
         B     PRPV32                                                           
         DROP  RE                                                               
         DROP  JOB60,VNDR60                                                     
*----------------------------------------                                       
* Payable Others Element  X'23'                                                 
*----------------------------------------                                       
         USING OTHELD,R2                                                        
PRPV80   CLI   JOB.TRNTYPE,TRNTJBTX      Job Transfer X'34'?                    
         BNE   PRPV86                    . Yes, Do not check job                
*                                                                               
         USING PXDELD,RE                                                        
         ICM   RE,15,AELEM4E             first x'4e' elem                       
         BZ    PRPV86                    None                                   
PRPV82   CLI   PXDEL,EOR                 End Of Record                          
         BE    PRPV86                                                           
         CLI   PXDEL,PXDELQ              X'4E' - XFER DETAIL ELEM               
         BNE   *+12                                                             
         CLI   PXDTYPE,PXDTORG           C'O' - ORIGINAL JOB                    
         BE    PRPV84                                                           
         SR    RF,RF                                                            
         IC    RF,1(,RE)                 next element                           
         AR    RE,RF                                                            
         B     PRPV82                                                           
*                                                                               
PRPV84   CLC   OTHNUM(3),PXDFRTOA+3      Product on payable = original          
         BNE   PRPV100                                                          
         CLC   OTHNUM+6(6),PXDFRTOA+6    Job on payable = original              
         BE    PRPV32                                                           
         B     PRPV100                                                          
*                                                                               
PRPV86   CLC   OTHNUM(3),CURACC+6                                               
         BNE   PRPV100                                                          
         CLC   OTHNUM+6(6),CURACC+9                                             
         BE    PRPV32                                                           
         B     PRPV100                                                          
         DROP  RE                                                               
*----------------------------------------                                       
* Manual Payment Element  X'64'                                                 
*----------------------------------------                                       
         USING MPYELD,R2                                                        
PRPV90   OC    MPYDTE,MPYDTE             Is check still here?                   
         BZ    PRPV32                    must have been voided                  
         MVC   CFWVCNO,MPYNO             Vendor check number                    
         MVC   CFWVCDT,MPYDTE            Vendor check date                      
         ZAP   CFWVDIS,CFWVUND           Disbursed amount                       
         ZAP   CFWVUND,PKZERO                                                   
         GOTOR DATCON,DMCB,(2,CFWVCDT),(0,WORK)                                 
         GOTOR PERVERT,DMCB,TODAYC,WORK                                         
         LH    RF,8(,R1)                                                        
         LHI   RE,-1                     Less one for non-inclusive             
         CHI   RF,0                                                             
         BP    *+8                                                              
         LHI   RE,1                                                             
         AR    RF,RE                                                            
         STCM  RF,3,CFWDAYS                                                     
         CVD   RF,DUB                                                           
         ZAP   OP1,CFWVDIS                                                      
         MP    OP1,DUB+4(4)                                                     
         ZAP   CFWDBAL,OP1                                                      
         B     PRPV32                                                           
*----------------------------------------                                       
* Clear out cashflow element, try again                                         
*----------------------------------------                                       
PRPV100  XC    CFWEL(CFWVLNQ+1),CFWEL    Clear out the cshflw elem              
         L     R1,=AL4(IOSEQ+IOACDIR+IOAREA2)                                   
         GOTO1 AIO                       Try next with this key                 
         BE    PRPV25                                                           
*                                                                               
PRPVNDX  XMOD1                                                                  
         DROP  R2,R3,R7                                                         
         DROP  JOB                                                              
*----------------------------------------                                       
*      STORAGE FOR PRPVND                                                       
*----------------------------------------                                       
PRPVGRS  DS    PL8                       Vendor Gross                           
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
                                                                                
***********************************************************************         
*  PROCESS PRODUCTION RECEIVABLE INFORMATION                          *         
***********************************************************************         
RCVKEY   USING TRNRECD,IODIRKEY                                                 
JOBKEY   USING TRNRECD,R2                                                       
         USING CFWELD,R3                                                        
JOB44    USING TRNELD,R4                                                        
                                                                                
PRCPRCV  NMOD1 0,**PRCV**                                                       
         L     RC,RLBASEC                                                       
         L     R4,ADTRANS                                                       
         XC    RCVKEY.TRNKEY,RCVKEY.TRNKEY                                      
         L     R3,ACFWELS                CashFlow elements                      
         ST    R3,AFSTCFW                First element                          
         XC    ACURP77,ACURP77                                                  
         NI    PRCPRSTA,TURNOFF-PRCPRUB                                         
*                                                                               
         CLI   CFWEL,CFWELQ              Jump past Cashflow Vendor Elem         
         BNE   PRCPR10                                                          
         CLI   CFWTYP,CFWTYVQ            Cashflow Vendor Element                
         BNE   PRCPR10                                                          
         SR    RF,RF                                                            
         IC    RF,1(,R3)                 next element                           
         AR    R3,RF                                                            
         ST    R3,AFSTCFW                Set new 1st element                    
                                                                                
PRCPR10  XC    CFWEL(CFWRLNQ+1),CFWEL    Init the element                       
*                                                                               
         TM    JOB44.TRNSTAT,TRNSDR      Production Debit, Charge ?             
         BO    PRCPR50                   . yes, skip on                         
         EJECT ,                                                                
*----------------------------------------                                       
* Process credits (bills) only                                                  
*----------------------------------------                                       
         ZAP   PRCPBGRS,JOB44.TRNAMNT    Net amount of prod transaction         
         ZAP   PRCPBLNT,JOB44.TRNAMNT    Net amount of prod transaction         
         AP    PRCPBGRS,JOB44.TRNBLCOM   Add commission for gross               
         LR    R2,R4                                                            
         SH    R2,DATADISP               Point to original job key              
         MVC   RCVKEY.TRNKCULA,JOBKEY.TRNKCULC   Receivable account             
         MVC   RCVKEY.TRNKREF,JOBKEY.TRNKREF                                    
         MVC   RCVKEY.TRNKDATE,JOBKEY.TRNKDATE                                  
         DROP  JOBKEY                                                           
*                                                                               
         LR    R2,R4                     A(TRNELQ)                              
PRCPR20  CLI   0(R2),0                   end of record                          
         BE    PRCPR40                                                          
         CLI   0(R2),VBIELQ              X'48'-VAT Billed element               
         BE    PRCPR35                                                          
PRCPR25  SR    RF,RF                                                            
         IC    RF,1(,R2)                 next element                           
         AR    R2,RF                                                            
         B     PRCPR20                                                          
*----------------------------------------                                       
* VAT Billed Element  X'48'                                                     
*----------------------------------------                                       
         USING VBIELD,R2                 X'4F'                                  
PRCPR35  AP    PRCPBGRS,VBIVAT           VAT Amount billed                      
         DROP  R2                                                               
*                                                                               
PRCPR40  BAS   RE,PRCPBILL               This bill already processed?           
         BE    PRCPR210                  Yes, we have cashflow elements         
         L     R2,ADTRANS                                                       
         B     PRCPR60                                                          
         EJECT ,                                                                
*----------------------------------------                                       
* Process debits (charges) only                                                 
*----------------------------------------                                       
PRCPR50  BAS   RE,PRCPFBL                Find Bills(that relate to DR)          
         BNE   PRCPRCVX                  none left, so exit                     
         TM    PRCPRSTA,PRCPAPB          This bill already processed?           
         BO    PRCPR210                  . Yes                                  
*                                                                               
BILKEY   USING TRNRECD,R6                R4 = Original Charge trans             
         L     R6,AIO3                   AIO3 = SJ Billing tranaction           
         XC    RCVKEY.TRNKEY,RCVKEY.TRNKEY                                      
         MVC   RCVKEY.TRNKCULA,BILKEY.TRNKCULC      Receivable account          
         MVC   RCVKEY.TRNKDATE,BILKEY.TRNKDATE      Bill Date                   
         MVC   RCVKEY.TRNKREF,BILKEY.TRNKREF        Bill Number                 
         LA    R2,BILKEY.TRNRFST                                                
         DROP  BILKEY                                                           
*----------------------------------------                                       
* Processing for Debits and Credits                                             
*----------------------------------------                                       
PRCPR60  CLI   0(R2),0                   end of record                          
         BE    PRCPR78                                                          
         CLI   0(R2),CPJELQ              X'4F'-RCV account for retail           
         BE    PRCPR70                                                          
         CLI   0(R2),BSCELQ              X'E3'-Billing Source element           
         BE    PRCPR75                                                          
PRCPR62  SR    RF,RF                                                            
         IC    RF,1(,R2)                 next element                           
         AR    R2,RF                                                            
         B     PRCPR60                                                          
*----------------------------------------                                       
* Receivable Account for Retail Billing                                         
*----------------------------------------                                       
         USING CPJELD,R2                 X'4F'                                  
PRCPR70  CLI   CPJTYPE,CPJTREC           elment type = receivable?              
         BNE   PRCPR62                                                          
         MVC   RCVKEY.TRNKULA,CPJRULA                                           
         OI    CURIND,CURRETL            Retail billing                         
         OI    CFKIND,CFKBUN             Blling unavailable from DR             
*                                        ******************************         
         TM    JOB44.TRNSTAT,TRNSDR      * At this point cashflow is  *         
         BO    PRCPRCVX                  * supported when reporting   *         
         B     PRCPR62                   * Retail Billing off Debits  *         
         DROP  R2                        ******************************         
*----------------------------------------                                       
* Prod Billing Source Element  X'E3'                                            
*----------------------------------------                                       
         USING BSCELD,R2                                                        
PRCPR75  MVC   RCVKEY.TRNKOFF(L'TRNKOFF+L'TRNKCULC),SPACES                      
         MVC   RCVKEY.TRNKCACT,BSCBSRC   billing Source                         
         CLI   NEWOFF,YES                                                       
         BNE   PRCPR62                                                          
         MVC   RCVKEY.TRNKOFF,BSCBOFF    Office                                 
         B     PRCPR62                                                          
         DROP  R2                                                               
*----------------------------------------                                       
* Read for receivable                                                           
*----------------------------------------                                       
PRCPR78  XC    PRCPRTAB(MAXRCVTQ*L'PRCPRTAB),PRCPRTAB Transfer Table            
         TM    PRCPRSTA,PRCPAPB          This bill already processed?           
         BO    PRCPR210                  . Yes                                  
*                                                                               
PRCPR80  L     R1,=AL4(IOHIGH+IOACDIR+IOAREA2)                                  
         GOTO1 AIO                                                              
         BNE   PRCPRCVX                                                         
*                                                                               
         XC    CFWDAYS,CFWDAYS           Get ready to build cashflow            
         ZAP   CFWDBAL,PKZERO                                                   
         ZAP   CFWPAPP,PKZERO                                                   
         ZAP   CFWUNAA,PKZERO                                                   
         ZAP   CFWAPPA,PKZERO                                                   
*                                                                               
         USING TRNRECD,R2                                                       
PRCPR85  L     R2,AIO2                                                          
         CLC   TRNKEY(TRNKEND-1),RCVKEY.TRNKEY    Receivable found?             
         BNE   PRCPR195                           no                            
*                                                                               
         LA    RF,PRCPRTAB               Receivable transfer table              
PRCPR90  CLI   0(RF),0                   Any more transfer entries?             
         BE    PRCPR95                   . no,process this receivable           
         CLI   0(RF),X'FF'               End of transfer table?                 
         BE    PRCPR95                   . yes,process this receivable          
         CLC   TRNKULA,0(RF)             Did we Transfer From?                  
         BE    PRCPR91                   . yes                                  
         AHI   RF,L'PRCPRTAB             . no, check next entry                 
         B     PRCPR90                                                          
                                                                                
PRCPR91  CLC   TRNKSBR,L'TRNKULA(RF)     Transfer From exact record?            
         BNH   PRCPR190                  . yes, get next record                 
*                                                                               
PRCPR95  L     R1,=AL4(IOGETREC+IOACMST+IOAREA2)                                
         GOTO1 AIO                                                              
         BNE   PRCPR195                                                         
*                                                                               
         LA    R2,TRNRFST                first element                          
PRCPR100 CLI   0(R2),EOR                 end of record                          
         BE    PRCPR180                                                         
         CLI   0(R2),TRNELQ              X'44'-Transaction element              
         BE    PRCPR110                                                         
         CLI   0(R2),TRSELQ              X'60'-Trans Status Element             
         BE    PRCPR120                                                         
         CLI   0(R2),DUEELQ              X'61'-Rcvable Due Date                 
         BE    PRCPR130                                                         
         CLI   0(R2),TRXELQ              X'75'-Transaction Extra Status         
         BE    PRCPR140                                                         
         CLI   0(R2),RALELQ              X'D9'-Rcvable Allocation elem          
         BE    PRCPR150                                                         
PRCPR102 SR    RF,RF                                                            
         IC    RF,1(,R2)                 next element                           
         AR    R2,RF                                                            
         B     PRCPR100                                                         
*----------------------------------------                                       
* Receivable Transaction Element                                                
*----------------------------------------                                       
         USING TRNELD,R2                                                        
PRCPR110 NI    PRCPRSTA,TURNOFF-PRCPRSDR                                        
*                                                                               
         TM    TRNSTAT,TRNSREV                                                  
         BZ    PRCPR114                                                         
         OI    CFWRSTA,TRNSREV           Only want reversal status              
         CLI   TRNTYPE,TRNTCALC          TYPE 30 TRNS                           
         BE    PRCPR190                  Skip this one                          
*                                                                               
PRCPR114 MVI   CFWEL,CFWELQ              Cashflow element                       
         MVI   CFWTYP,CFWTYRQ            Type 2=Receivable information          
         MVI   CFWLN,CFWRLNQ             Element length                         
         GOTO1 DATCON,DMCB,(1,TRNDATE),(2,CFWBLDT)                              
         MVC   CFWBLNO,TRNREF            Bill Number                            
         TM    TRNSTAT,TRNSDR                                                   
         BZ    PRCPR116                                                         
         L     RF,AFSTCFW                           ADD TO FIRST ELEM           
         AP    CFWUNAA-CFWEL(L'CFWUNAA,RF),TRNAMNT                              
         OI    PRCPRSTA,PRCPRSDR                                                
         B     PRCPR102                                                         
                                                                                
PRCPR116 AP    CFWAPPA,TRNAMNT           Applied amount                         
         B     PRCPR102                                                         
*----------------------------------------                                       
* Transaction Status Element                                                    
*----------------------------------------                                       
         USING TRSELD,R2                                                        
PRCPR120 TM    CFWRSTA,TRNSREV                                                  
         BZ    PRCPR102                                                         
         GOTO1 DATCON,DMCB,(2,TRSREVD),(1,CFWCCDT)                              
         B     PRCPR102                                                         
*----------------------------------------                                       
* Receivable Due Date Element                                                   
*----------------------------------------                                       
         USING DUEELD,R2                 Receivable Due Date Element            
PRCPR130 MVC   CFWCDDT,DUEDATE                                                  
         B     PRCPR102                                                         
*----------------------------------------                                       
* Transaction Extra Status Element                                              
*----------------------------------------                                       
         USING TRXELD,R2                                                        
PRCPR140 TM    TRXSTA1,TRXSRQRD          Queried?                               
         BZ    *+8                       . no                                   
         OI    CFWRSTA,TRXSRQRD                                                 
         TM    TRXSTA1,TRXSRHLD          Held?                                  
         BZ    *+8                       . no                                   
         OI    CFWRSTA,TRXSRHLD                                                 
         B     PRCPR102                                                         
*----------------------------------------                                       
* Receivable Allocation Element                                                 
*----------------------------------------                                       
         USING RALELD,R2                 Receivable Allocation Element          
PRCPR150 CLI   RALTYPE,RALTALC           Type 1 = Regular Allocation            
         BNE   PRCPR155                                                         
         MVC   CFWCCNO,RALAREF           Client Check Number                    
         MVC   CFWCCDT,RALADAT           Client Check Date                      
         MVC   CFWCPDT,RALADEP           Client Deposit Date                    
         B     PRCPR102                                                         
*                                                                               
PRCPR155 CLI   RALTYPE,RALTOFS           Type 2 = Offset/Contra'd               
         BNE   PRCPR160                                                         
         MVC   CFWCCDT,RALODAT           Offset Date                            
         OI    CFWRSTA,CFWRSOF           Status Offset                          
         B     PRCPR102                                                         
*                                                                               
PRCPR160 CLI   RALTYPE,RALTWOF           Type 3 = Write-Off                     
         BNE   PRCPR165                                                         
         MVC   CFWCCNO,RALWREF           Write-Off Reference                    
         MVC   CFWCCDT,RALWDAT           Write-Off Date                         
         OI    CFWRSTA,CFWRSWO           Status W/O                             
         B     PRCPR102                                                         
*                                                                               
PRCPR165 CLI   RALTYPE,RALTTTO           Type 4 = Transfer To                   
         BNE   PRCPR175                                                         
         L     R3,AFSTCFW                cashflow elems with transfer           
         L     RE,AIO2                   A(Current receivable tran)             
         LA    RF,PRCPRTAB               Receivable transfer table              
         XC    CFWEL(CFWRLNQ+1),CFWEL    Init the element                       
PRCPR170 CLI   0(RF),0                   Next available space                   
         BE    PRCPR172                                                         
         CLI   0(RF),X'FF'               End of transfer table?                 
         BE    PRCPR195                  . yes, No more allowed                 
         CLC   0(L'TRNKULA,RF),1(RE)     Did we Transfer From before?           
         BE    PRCPR172                  . yes                                  
         AHI   RF,L'PRCPRTAB             . no, check next entry                 
         B     PRCPR170                                                         
*                                                                               
PRCPR172 MVC   0(L'TRNKULA,RF),1(RE)     put account into rcvble tab            
         MVC   L'TRNKULA(L'TRNKSBR,RF),L'TRNKEY-1(RE) and subref                
         MVC   RCVKEY.TRNKULA,RALTULA                                           
         B     PRCPR80                                                          
*                                                                               
PRCPR175 CLI   RALTYPE,RALTTFR           Type 5 = Transfer From                 
         BNE   PRCPR185                                                         
         OI    CFWRSTA,CFWRSTR           Status Transfer                        
         B     PRCPR102                                                         
*----------------------------------------                                       
* Finish with elem and try again                                                
*----------------------------------------                                       
PRCPR180 OC    CFWCCDT,CFWCCDT           Client Check Date                      
         BNZ   PRCPR182                                                         
         TM    FMTROPT6,RPFBDDC          Use Bill Due Date?                     
         BZ    PRCPR184                  . No                                   
         OC    CFWCDDT,CFWCDDT           Bill Due Date                          
         BZ    PRCPR184                                                         
         GOTOR DATCON,DMCB,(2,CFWCDDT),(1,WORK+10)                              
         CLC   TDDATE,WORK+10            Only use Due Date if later             
         BNL   PRCPR184                                                         
         LA    RE,WORK+10                                                       
         OI    CFWEIND,CFWEDDC           Use Due Date as Days Calc Date         
         B     *+8                                                              
PRCPR182 LA    RE,CFWCCDT                                                       
         GOTOR DATCON,DMCB,(1,(RE)),(0,WORK)                                    
         GOTOR PERVERT,DMCB,TODAYC,WORK                                         
         LH    RF,8(,R1)                 Number of days                         
         LHI   RE,-1                     Adjust for non-inclusive               
         CHI   RF,0                                                             
         BP    *+8                                                              
         LHI   RE,1                                                             
         AR    RF,RE                                                            
         STCM  RF,3,CFWDAYS                                                     
         CVD   RF,DUB                                                           
         ZAP   OP1,PRCPBLNT              Use Net for daily balance              
         MP    OP1,DUB+4(4)                                                     
         ZAP   CFWDBAL,OP1                                                      
*                                                                               
PRCPR184 TM    PRCPRSTA,PRCPRSDR                                                
         BO    PRCPR190                                                         
         AHI   R3,CFWRLNQ                                                       
*                                                                               
PRCPR185 XC    CFWEL(CFWRLNQ+1),CFWEL    Init the element                       
         ZAP   CFWDBAL,PKZERO            Get ready to build cashflow            
         ZAP   CFWPAPP,PKZERO                                                   
         ZAP   CFWUNAA,PKZERO                                                   
         ZAP   CFWAPPA,PKZERO                                                   
                                                                                
PRCPR190 L     R1,=AL4(IOSEQ+IOACDIR+IOAREA2)                                   
         GOTO1 AIO                       Read for receivable                    
         BE    PRCPR85                                                          
*----------------------------------------                                       
* Save cashflow elements for this bill                                          
*----------------------------------------                                       
PRCPR195 ZAP   PRCPRAPP,PKZERO           Total of Applied amount                
*                                                                               
         L     RE,CFWBASE                get max len of data in buffer          
         A     RE,=A(RATEQ-CFWRLNQ)      Len of buffer less cshflw elem         
*        A     RE,=A(RATEQ-CFWTYRQ)      Len of buffer less cshflw elem         
*        SHI   RE,CFWTYRQ                minus len of rcv cshflw elem           
*                                                                               
         L     RF,CFWBASE                                                       
PRCPR200 CLI   0(RF),0                   Jump past cashflow elements            
         BE    PRCPR202                                                         
*                                                                               
         CR    RF,RE                     Will we exceed the buffer?             
         BL    PRCPR201                  . no                                   
         L     RF,CFWBASE                . Yes,clear buffer and rebuild         
         MVI   0(RF),0                     if necessary                         
         B     PRCPR202                                                         
*                                                                               
PRCPR201 CLI   0(RF),CFWELQ              Cashflow element?                      
         BNE   PRCPR202                  . No, go over it                       
         SR    R0,R0                                                            
         IC    R0,1(,RF)                                                        
         AR    RF,R0                                                            
         B     PRCPR200                                                         
*                                                                               
PRCPR202 L     R3,AFSTCFW                R3=A(CURRENT CASHFLOW ELEMS)           
PRCPR203 CLI   0(R3),0                   RF=A(NEXT SPOT TO SAVE)                
         BE    PRCPR210                                                         
         CLI   CFWEL,CFWELQ                                                     
         BNE   PRCPR205                                                         
         CLI   CFWTYP,CFWTYRQ                                                   
         BE    PRCPR206                                                         
PRCPR205 MVI   CFWEL,0                                                          
         B     PRCPR210                                                         
                                                                                
PRCPR206 LHI   R1,CFWRLNQ                Length of Cashflow element             
         EXMVC R1,0(RF),CFWEL            Move length of cashflow +1             
         AP    PRCPRAPP,CFWAPPA          Total of Applied amount                
         AR    RF,R1                     Point to next spot available           
         MVI   0(RF),0                   clear out in case no more              
PRCPR208 SR    R0,R0                                                            
         IC    R0,1(,R3)                                                        
         AR    R3,R0                                                            
         B     PRCPR203                                                         
*----------------------------------------                                       
* Adjust cashflow elements                                                      
*----------------------------------------                                       
PRCPR210 L     R3,AFSTCFW                FIRST ELEMENT                          
         CLI   0(R3),0                   no elements                            
         BE    PRCPR250                                                         
         OI    PRCPRSTA,PRCPNOAD                                                
         CP    CFWUNAA,PKZERO            Any amount?                            
         BE    PRCPR215                  . no                                   
         CP    CFWUNAA,PRCPBGRS          Compare unapplied to gross             
         BE    PRCPR215                                                         
         NI    PRCPRSTA,TURNOFF-PRCPNOAD                                        
*                                                                               
         ZAP   OP1,PRCPBGRS                                                     
         SRP   OP1,6,0                   Multiply for percent                   
         DP    OP1,CFWUNAA               percent of gross to unapp              
         ZAP   PRCPPRCT,OP1(L'OP1-L'CFWUNAA) Save percent                       
*                                                                               
         ZAP   OP1,CFWUNAA               Move unapplied into big field          
         MP    OP1,PRCPPRCT              multiply by percent                    
         SRP   OP1,64-6,5                divide to get actual number            
         ZAP   CFWUNAA,OP1               put adjusted number in                 
*                                                                               
         ZAP   OP1,PRCPRAPP              Applied total in big field             
         MP    OP1,PRCPPRCT              multiply by percent                    
         SRP   OP1,64-6,5                divide to get actual number            
         ZAP   PRCPRAPP,OP1              put adjusted number in                 
*                                                                               
PRCPR215 CP    PRCPRAPP,PKZERO           Any check amount?                      
         BE    *+18                      . no                                   
         CP    CFWUNAA,PRCPRAPP          Fully paid?                            
         BE    *+8                       . yes                                  
         MVI   CFWPART,C'*'                                                     
         ZAP   DOUBLE,CFWUNAA            DOUBLE gets unapp for % app            
         SP    CFWUNAA,PRCPRAPP                                                 
*                                                                               
PRCPR220 TM    PRCPRSTA,PRCPNOAD                                                
         BO    PRCPR225                                                         
         ZAP   OP1,CFWAPPA               Applied into big field                 
         MP    OP1,PRCPPRCT              multiply by percent                    
         SRP   OP1,64-6,5                                                       
         ZAP   CFWAPPA,OP1                                                      
*                                                                               
PRCPR225 CP    DOUBLE,PKZERO             Any percentage?                        
         BE    PRCPR230                  . no                                   
         ZAP   OP1,CFWAPPA               Applied amount                         
         SRP   OP1,6,0                   Multiply for % (extra decs)            
         DP    OP1,DOUBLE                                                       
         ZAP   CFWPAPP,OP1(8)            Percent applied                        
         SRP   CFWPAPP,64-2,5            get actual number                      
         TM    CFWEIND,CFWEDDC           Use Due Date as Days Calc Date         
         BO    PRCPR230                                                         
         ZAP   OP1,PRCPBLNT              Use net amount for daily bal           
         MP    OP1,CFWPAPP               multiply by percent                    
         SRP   OP1,64-4,5                                                       
         MVC   HALF,CFWDAYS                                                     
         LH    RF,HALF                   days X (% of net)= daily bal           
         CVD   RF,DUB                                                           
         MP    OP1,DUB+4(4)                                                     
         ZAP   CFWDBAL,OP1                                                      
*                                                                               
PRCPR230 L     RF,AFSTCFW                                                       
         MVC   CFWCDDT,CFWCDDT-CFWEL(RF)                                        
         MVC   CFWPART,CFWPART-CFWEL(RF)                                        
         OC    CFWRSTA,CFWRSTA-CFWEL(RF)                                        
*                                                                               
         TM    CURIND,CURBILCR           Billed CR Only?                        
         BO    PRCPR232                  (not based on actuals)                 
         TM    JOB44.TRNSTAT,TRNSDR      Production Debit?                      
         BZ    PRCPR240                                                         
                                                                                
PRCPR232 ZAP   CFWBAPP,CFWAPPA                                                  
         ZAP   CFWBBAL,CFWUNAA                                                  
         OI    CFWEIND,CFWECBC                                                  
         TM    CURIND,CURBILCR           Billed CR Only?                        
         BO    PRCPR240                  (not based on actuals)                 
         ZAP   CFWAPPA,PKZERO                                                   
         ZAP   CFWUNAA,PKZERO                                                   
         B     PRCPR240                                                         
*                                                                               
PRCPR238 CLI   0(R3),EOR                 end of record                          
         BE    PRCPR250                                                         
         CLI   0(R3),CFWELQ                                                     
         BE    PRCPR220                                                         
                                                                                
PRCPR240 SR    RF,RF                                                            
         IC    RF,1(,R3)                 next element                           
         AR    R3,RF                                                            
         B     PRCPR238                                                         
*                                                                               
PRCPR250 ST    R3,AFSTCFW                                                       
         MVI   0(R3),0                                                          
         TM    JOB44.TRNSTAT,TRNSDR      Debit?                                 
         BO    PRCPR50                   (Keep reading PTAELS)                  
*                                                                               
PRCPRCVX XMOD1                                                                  
         DROP  JOB44,RCVKEY                                                     
         EJECT ,                                                                
*---------------------------------------------------------------------*         
*       READ FOR BILLING INFO BASED ON CURR PRODUCTION CHARGE                   
*---------------------------------------------------------------------*         
BILKEY   USING TRNRECD,IODIRKEY          Job billing key                        
JOBKEY   USING TRNRECD,R4                Original tranaction job key            
*                                                                               
PRCPFBL  NTR1                                                                   
         L     R4,ADTRANS                                                       
         SH    R4,DATADISP                                                      
*                                                                               
         TM    PRCPRSTA,PRCPRUB          Already read for upfront?              
         BO    *+12                      . yes                                  
         BRAS  RE,PRCUBILL               Check for upfront bills                
         BNE   PRCPFNOX                                                         
*                                                                               
         L     R4,ADTRANS                                                       
         SH    R4,DATADISP                                                      
         XC    BILKEY.TRNKEY,BILKEY.TRNKEY                                      
         MVC   BILKEY.TRNKCULA,JOBKEY.TRNKCULA    Same account but              
         MVC   BILKEY.TRNKOFF,=C'99'              read the bill wc=99           
         ICM   R3,15,ACURP77                                                    
         BNZ   PRCPF08                   Get next x'77'                         
*                                                                               
         L     R3,ADTRANS                1st element on record                  
         USING PTAELD,R3                                                        
PRCPF05  CLI   0(R3),0                   end of record                          
         BE    PRCPFNOX                                                         
         CLI   0(R3),PTAELQ              X'77' - Transaction element            
         BNE   PRCPF08                                                          
         CLI   PTATYPE,PTATRAL                                                  
         BE    PRCPF10                                                          
PRCPF08  SR    RF,RF                                                            
         IC    RF,1(,R3)                 next element                           
         AR    R3,RF                                                            
         B     PRCPF05                                                          
*                                                                               
PRCPF10  MVC   BILKEY.TRNKREF,PTARBLNO   Bill number                            
         GOTO1 DATCON,DMCB,(2,PTARBLDT),(1,BILKEY.TRNKDATE)                     
         ZAP   PRCPBGRS,PTANET           Net amount of Billing                  
         ZAP   PRCPBLNT,PTANET           Net amount of Billing                  
         AP    PRCPBGRS,PTARCOM          Add commission for gross               
         ST    R3,ACURP77                                                       
         BAS   RE,PRCPBILL               Already process this bill?             
         BE    PRCPFGOX                  . Yes                                  
*                                                                               
         L     R1,=AL4(IOHIGH+IOACDIR+IOAREA3)                                  
         GOTO1 AIO                                                              
         BNE   PRCPFNOX                                                         
*                                                                               
         USING TRNRECD,R2                                                       
PRCPF20  L     R2,AIO3                                                          
         CLC   BILKEY.TRNKEY(TRNKCULC-TRNKEY),TRNKEY                            
         BNE   PRCPFNOX                                                         
         CLC   BILKEY.TRNKDATE(L'TRNKDATE+L'TRNKREF),TRNKDATE                   
         BE    PRCPF40                                                          
         L     R1,=AL4(IOSEQ+IOACDIR+IOAREA3)                                   
         GOTO1 AIO                                                              
         BE    PRCPF20                                                          
         DROP  R2                                                               
*                                                                               
PRCPF40  L     R1,=AL4(IOGETREC+IOACMST+IOAREA3)                                
         GOTO1 AIO                                                              
         BE    PRCPFGOX                                                         
*                                                                               
PRCPFNOX LTR   RB,RB                                                            
         B     *+6                                                              
PRCPFGOX CR    RB,RB                                                            
         XIT1                                                                   
         DROP  BILKEY,JOBKEY                                                    
*---------------------------------------------------------------------*         
*       READ CASHFLOW BUFFER FOR ALREADY PROCESSED BILL                         
*---------------------------------------------------------------------*         
         USING TRNRECD,R2                                                       
         USING CFWELD,R4                                                        
PRCPBILL NTR1                                                                   
         LA    R2,IODIRKEY                                                      
         L     R3,AFSTCFW          1st RCV cashflow element                     
         L     R4,CFWBASE          Pool of cashflow elements                    
         NI    PRCPRSTA,TURNOFF-PRCPAPB                                         
         ZAP   PRCPRAPP,PKZERO                                                  
*                                                                               
         CLI   CFWEL,0             Any Cashflow elements built?                 
         BE    PRCPBNOX              no, then just exit                         
PRCPB10  CLI   CFWEL,CFWELQ          yes, get the next one                      
         BNE   PRCPBDOX            No more                                      
         CLI   CFWTYP,CFWTYRQ      Receivable Cashflow element?                 
         BNE   PRCPB99               yes, check if for this bill                
*                                                                               
         CLC   CFWBLNO,TRNKREF     CashFlow info for this Bill?                 
         BNE   PRCPB99               No                                         
         CLC   CFWBLDT,TRNKDATE    CashFLow info for this Date?                 
         BNE   PRCPB99               No                                         
         LHI   R1,CFWRLNQ          Length of Cashflow element                   
         EXMVC R1,0(R3),CFWEL      Move length of cashflow +1                   
         AP    PRCPRAPP,CFWAPPA    Calculate total applied amount               
         AR    R3,R1               Point to next spot available                 
         MVI   0(R3),0             clear out in case no more                    
*                                                                               
         OI    PRCPRSTA,PRCPAPB                                                 
PRCPB99  SR    RF,RF                                                            
         IC    RF,1(,R4)           next element in pool                         
         AR    R4,RF                                                            
         B     PRCPB10                                                          
*                                                                               
PRCPBDOX TM    PRCPRSTA,PRCPAPB    Found an already processed bill?             
         BO    PRCPBGOX            Yes, we have our cashflow info               
                                                                                
PRCPBNOX J     PRCPFNOX                                                         
PRCPBGOX J     PRCPFGOX                                                         
         DROP  R2,R4                                                            
*---------------------------------------------------------------------*         
*       READ BILLS FOR UPFRONT BILLING                                          
*---------------------------------------------------------------------*         
BILKEY   USING TRNRECD,IODIRKEY          Job billing key                        
JOBKEY   USING TRNRECD,R4                Original transaction job key           
*                                                                               
PRCUBILL NTR1                                                                   
         OI    PRCPRSTA,PRCPRUB          Read for upfront billing               
         XC    BILKEY.TRNKEY,BILKEY.TRNKEY                                      
         MVC   BILKEY.TRNKCULA,JOBKEY.TRNKCULA    Same account but              
         MVC   BILKEY.TRNKOFF,=C'99'              read the bill wc=99           
         L     R1,=AL4(IOHIGH+IOACDIR+IOAREA3)                                  
         GOTO1 AIO                                                              
         BNE   PRCUBNOX                                                         
*                                                                               
         L     R2,AIO3                                                          
         USING TRNRECD,R2                                                       
PRCUB10  CLC   BILKEY.TRNKEY(TRNKCULC-TRNKEY),TRNKEY                            
         BNE   PRCUBNOX                                                         
         L     R1,=AL4(IOGETREC+IOACMST+IOAREA3)                                
         GOTO1 AIO                                                              
         BNE   PRCUBNOX                                                         
         LA    R3,TRNRFST                                                       
         USING TRNELD,R3                                                        
         CLI   0(R3),TRNELQ                                                     
         BNE   PRCUB20                                                          
*                                                                               
         CLI   TRNBTYPE,TRNBTALL         allocated billing                      
         BE    PRCUBGOX                                                         
         CLI   TRNBTYPE,TRNBTCLI         client billing                         
         BE    PRCUBGOX                                                         
         CLI   TRNBTYPE,TRNBTONE         one line billing                       
         BE    PRCUBGOX                                                         
         CLI   TRNBTYPE,TRNBTPRO         progressive billing                    
         BE    PRCUBGOX                                                         
         CLI   TRNBTYPE,TRNBTTOT         total billing                          
         BE    PRCUBGOX                  else keep reading                      
*                                                                               
PRCUB20  L     R1,=AL4(IOSEQ+IOACDIR+IOAREA3)                                   
         GOTO1 AIO                                                              
         BNE   PRCUBNOX                                                         
         B     PRCUB10                                                          
*                                                                               
PRCUBNOX OI    CURIND,CURRETL            Treat as Retail billing                
         OI    CFKIND,CFKBUN             Billing unavailable from DR            
         J     PRCPFNOX                                                         
PRCUBGOX J     PRCPFGOX                                                         
         DROP  R2,R3,BILKEY,JOBKEY                                              
*---------------------------------------------------------------------          
*      STORAGE FOR PRCPRCV AND ITS SUBROUTINES                                  
*---------------------------------------------------------------------          
PRCPBGRS DS    PL8             Billing Gross                                    
PRCPBLNT DS    PL8             Billing Net                                      
PRCPRAPP DS    PL8             Receivable total applied                         
PRCPPRCT DS    PL8             Percent                                          
*                                                                               
AFSTCFW  DS    A               First cashflow element                           
ACURP77  DS    A               Address of current 77 elem processing            
PRCPRSTA DS    X               Process prod receivable status                   
PRCPRSDR EQU   X'80'           . Processing Receivable Debit                    
PRCPAPB  EQU   X'40'           . Already Processed Bill                         
PRCPNOAD EQU   X'20'           . No adjusting needed                            
PRCPRUB  EQU   X'10'           . Already read for upfront billing               
*                                                                               
PRCPRTAB DS    (MAXRCVTQ)XL(L'TRNKULA+L'TRNKSBR) Rcvble transfer table          
         DC    X'FF'           END OF TABLE                                     
MAXRCVTQ EQU   5                                                                
         LTORG                                                                  
*&&                                                                             
         EJECT                                                                  
***********************************************************************         
         USING CFWELD,R2                                                        
DUMPCF   NMOD1 0,**DCFW**                                                       
         L     RC,RLBASEC                                                       
         CLI   QPROG,PRODUCTION                                                 
         JNE   DUMPCFX                                                          
         L     R2,ACFWELS                                                       
DUMPCF10 CLI   0(R2),EOR                                                        
         BE    DUMPCFX                                                          
         SR    R0,R0                                                            
         ICM   R0,1,CFWLN                                                       
         BZ    DUMPCFX                                                          
         MVC   WORK,SPACES                                                      
         MVC   WORK(7),=CL7' VENDOR'                                            
         CLI   CFWTYP,CFWTYVQ      Vendor                                       
         BE    *+10                                                             
         MVC   WORK(7),=CL7' RCV'                                               
         GOTO1 PRNTBL,DMCB,(10,WORK),(R2),C'DUMP',(R0),=C'1D'                   
         AR    R2,R0                                                            
         B     DUMPCF10                                                         
                                                                                
DUMPCFX  XIT1                                                                   
         LTORG                                                                  
         TITLE 'Printable version of DDLINKIO output'                           
***********************************************************************         
*                                                                               
***********************************************************************         
         USING FMTRECD,R5                                                       
         USING BIGPRNTD,R4                                                      
XMLOUT   NMOD1 0,**XML***                                                       
         L     RC,RLBASEC                                                       
         L     R4,VBIGPRNT                                                      
         MVC   XMLPARM(16),0(R1)                                                
         MVI   FORCEHED,NO         Never head up                                
         MVI   SPACING,1                                                        
         MVI   LINE,1                                                           
                                                                                
         CLI   XMLACT,LIOACLO      Done ?                                       
         BE    XMLO800             Yes                                          
         CLI   XMLACT,LIOAPUT      Put data                                     
         BNE   XMLOXIT                                                          
         CLI   XMLSUB,LIOTMAP      Map code subaction ?                         
         BNE   XMLO080                                                          
         LH    RF,XMLMAP#                                                       
         CHI   RF,REC_DATA                                                      
         BNE   XMLOXIT             Only process data records                    
         TM    XMLIND,XMLROOT                                                   
         BO    XMLOXIT             Do only once                                 
         MVC   XP(6),=C'<ROOT>'                                                 
         GOTOR ACREPORT                                                         
         OI    XMLIND,XMLROOT                                                   
         B     XMLOXIT                                                          
                                                                                
         USING ROWD,R2                                                          
         USING KYWD,R6                                                          
XMLO080  TM    XMLIND,XMLROOT      Only start after Root                        
         BZ    XMLOXIT                                                          
         CLI   XMLTYPE,LP_OTFUL                                                 
         BE    XMLO300             Test for now                                 
         L     R2,ACURROW                                                       
         CLI   XMLROW#,0           Is it set ?                                  
         BNE   *+10                                                             
         MVC   XMLROW#,ROWNUM      Initialize                                   
                                                                                
         CLC   ROWNUM,XMLROW#      Match on last row number                     
         BL    XMLO084                                                          
         BH    XMLO100                                                          
         TM    XMLIND,XMLBODY      Did we output body of report ?               
         BZ    XMLO100                   No so not finished                     
                                                                                
XMLO084  NI    XMLIND,TURNOFF-XMLBODY    Yes, so wrap up last row               
         ZIC   R0,XMLROW#                                                       
         ZIC   RF,ROWNUM                                                        
         LR    R2,R0               Save R0 in R2                                
         SR    R0,RF               Number of rows to process                    
         AHI   R0,1                                                             
         SHI   R2,1                                                             
         MHI   R2,ROWLNQ                                                        
         A     R2,FMTROW           Point to last row processed                  
                                                                                
XMLO090  L     R6,ROWINDEX                                                      
         MVC   HALF,KYWDD#                                                      
         LA    R8,XP                                                            
         BRAS  RE,EXPE_TAG                                                      
         GOTOR ACREPORT                                                         
         SHI   R2,ROWLNQ           Next                                         
         BCT   R0,XMLO090                                                       
         AHI   R2,ROWLNQ           Bump back to current level                   
                                                                                
XMLO100  L     R6,ROWINDEX                                                      
         MVC   HALF,KYWDD#                                                      
         MVC   XMLROW#,ROWNUM                                                   
         TM    ROWFLAGS,ROWCDE                                                  
         BZ    XMLO120                                                          
         LA    R8,XP                                                            
         BRAS  RE,EXPS_TAG                                                      
         GOTOR ACREPORT                                                         
         DROP  R6                                                               
                                                                                
         MVC   XP(6),=C'<code>'                                                 
         LHI   RF,-1                                                            
         CLI   XMLTYPE,C'E'        MPD_EMT                                      
         BE    XMLO104             Empty node                                   
         L     RE,XMLDATA                                                       
         ZIC   RF,XMLDATAQ                                                      
         BCTR  RF,0                                                             
         EXMVC RF,XP+6,0(RE)                                                    
                                                                                
XMLO104  LA    RE,XP+7                                                          
         AR    RE,RF                                                            
         MVC   0(7,RE),=C'</code>'                                              
         GOTOR ACREPORT                                                         
         B     XMLOXIT                                                          
                                                                                
XMLO120  MVC   XP(6),=C'<name>'                                                 
         LHI   RF,-1                                                            
         CLI   XMLTYPE,C'E'        MPD_EMT                                      
         BE    XMLO124             Empty node                                   
         L     RE,XMLDATA                                                       
         ZIC   RF,XMLDATAQ                                                      
         BCTR  RF,0                                                             
         EXMVC RF,XP+6,0(RE)                                                    
                                                                                
XMLO124  LA    RE,XP+7                                                          
         AR    RE,RF                                                            
         MVC   0(7,RE),=C'</name>'                                              
         GOTOR ACREPORT                                                         
         B     XMLOXIT                                                          
                                                                                
***********************************************************************         
* Handle amounts as attributes                                                  
***********************************************************************         
         USING COLD,R2                                                          
         USING KYWD,R6                                                          
XMLO300  OI    XMLIND,XMLBODY      Excuting body of report                      
         L     R2,ACURCOL                                                       
         L     R6,COLINDEX         Point to keyword entry                       
         MVC   HALF,COLDD#                                                      
         LA    R8,XP                                                            
         BRAS  RE,EXPS_TAG         Put start tag                                
         L     RE,XMLDATA                                                       
         ZIC   RF,XMLDATAQ                                                      
         BCTR  RF,0                                                             
         EXMVC RF,0(R8),0(RE)                                                   
         LA    R8,1(RF,R8)                                                      
         BRAS  RE,EXPE_TAG         Put end   tag                                
         GOTOR ACREPORT                                                         
         DROP  R2,R6                                                            
         B     XMLOXIT                                                          
                                                                                
         USING ROWD,R2                                                          
         USING KYWD,R6                                                          
XMLO800  TM    XMLIND,XMLROOT                                                   
         BZ    XMLOXIT             Nothing processed                            
         ZIC   R0,XMLROW#                                                       
         SHI   R0,1                                                             
         LR    R2,R0               Save R0 in R2                                
         MHI   R2,ROWLNQ                                                        
         A     R2,FMTROW           Point to last row processed                  
                                                                                
XMLO810  L     R6,ROWINDEX                                                      
         MVC   HALF,KYWDD#                                                      
         LA    R8,XP                                                            
         BRAS  RE,EXPE_TAG                                                      
         GOTOR ACREPORT                                                         
         SHI   R2,ROWLNQ           Next                                         
         BCT   R0,XMLO810                                                       
         DROP  R2,R6                                                            
                                                                                
         MVC   XP(7),=C'</ROOT>'                                                
         GOTOR ACREPORT                                                         
                                                                                
XMLOXIT  XIT1                                                                   
         DROP  R4,R5                                                            
         EJECT ,                                                                
***********************************************************************         
* Expand element tag                                                            
*     R8 = start position                                                       
*     R8 = end   position                                                       
***********************************************************************         
EXPS_TAG MVI   0(R8),C'<'                                                       
         AHI   R8,1                                                             
         J     EXPTAG00                                                         
                                                                                
EXPE_TAG MVI   0(R8),C'<'                                                       
         MVI   1(R8),C'/'                                                       
         AHI   R8,2                                                             
                                                                                
EXPTAG00 ST    RE,SVRE                                                          
         MVI   0(R8),ESC#LFJT                                                   
         MVC   1(2,R8),HALF                                                     
         MVI   3(R8),6                                                          
         GOTO1 ADDICTAT,DMCB,C'SU  ',(R8),0                                     
         TRT   0(6,R8),XMLCHR                                                   
         BZ    *+8                                                              
         MVI   0(R1),C'S'          Replace $ with S                             
                                                                                
         LA    RF,6                End with the close bracket                   
         AHI   R8,7                                                             
EXPTAG10 CLI   0(R8),C' '                                                       
         JNE   EXPTAG12                                                         
         SHI   R8,1                                                             
         BCT   RF,EXPTAG10                                                      
                                                                                
EXPTAG12 AHI   R8,1                                                             
         MVI   0(R8),C'>'                                                       
         AHI   R8,1                                                             
         L     RE,SVRE                                                          
         BR    RE                                                               
         EJECT ,                                                                
***********************************************************************         
*                                                                               
***********************************************************************         
XMLIND   DC    X'00'                                                            
XMLROOT  EQU   X'80'               Root node done                               
XMLBODY  EQU   X'40'               Body of report                               
                                                                                
TOTBILL  EQU   X'80'                                                            
BILL1PC  EQU   X'40'                                                            
                                                                                
XMLROW#  DC    X'00'                                                            
XMLROW   DC    A(0)                                                             
                                                                                
XMLPARM  DS    4F                                                               
         ORG   XMLPARM                                                          
XMLACT   DS    XL1                 Parm 1                                       
         DS    XL3                                                              
                                                                                
XMLSUB   DS    XL1                 Parm 2                                       
         DS    XL1                                                              
XMLMAP#  DS    H                                                                
                                                                                
XMLTYPE  DS    0XL1                Data type                                    
XMLDATA  DS    A                   Data                                         
                                                                                
XMLDATAQ DS    XL1                 Length of data                               
         DS    XL3                                                              
XMLCHR   DC    XL256'00'                                                        
         ORG   XMLCHR+C'$'                                                      
         DC    X'FF'                                                            
         ORG                                                                    
         SPACE 1                                                                
         LTORG                                                                  
         TITLE 'DUMP OUT TRANSACTION KEY FOR DEBUGING'                          
***********************************************************************         
*                                                                               
***********************************************************************         
         USING TRNELD,R2                                                        
         USING FMTRECD,R5                                                       
DUMPTKEY NMOD1 0,**DTKY**                                                       
         L     RC,RLBASEC                                                       
         STC   R1,DMPTYPE                                                       
         LHI   R0,ACCORFST                                                      
         L     R2,ADTRANS                                                       
         LR    R3,R2                                                            
         SR    R3,R0                                                            
         CLI   MODE,PROCTIME                                                    
         BNE   *+8                                                              
         L     R3,ATMSKEY          Start of key is here instead                 
         MVC   P,SPACES                                                         
         MVC   P(9),=C' TRANS IN'                                               
         CLI   DMPTYPE,1                                                        
         BNE   *+10                                                             
         MVC   P(10),=C' TRANS OUT'                                             
         CLI   DMPTYPE,2                                                        
         BNE   *+10                                                             
         MVC   P(10),=C' MID WAY'                                               
         MVC   P+14(7),=C'FMTPUT='                                              
         MVC   P+21(1),FMTPUT                                                   
         MVC   P+24(9),=C'FMT#TRNS='                                            
         SR    R1,R1                                                            
         IC    R1,FMTNUM                                                        
         CVD   R1,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  P+22(1),DUB                                                      
         LH    R1,FMT#TRNS                                                      
         CVD   R1,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  P+33(3),DUB                                                      
         CLI   DMPTYPE,1                                                        
         BL    DUMPTK10                                                         
         MVC   P+40(4),=C'DUE='                                                 
         GOTO1 DATCON,DMCB,(1,DUEDTE),(X'20',P+44)                              
*                                                                               
         USING TIMELD,R2                                                        
DUMPTK10 MVC   P+51(7),=C'AMOUNT='                                              
         CLI   MODE,PROCTIME                                                    
         BNE   DUMPTK12                                                         
         MVC   P+51(7),=CL7'HOURS='                                             
         ZAP   DUB,TIMHRS                                                       
         CURED DUB,(13,P+58),2,ALIGN=LEFT,FLOAT=-                               
         B     DUMPTK14                                                         
         DROP  R2                                                               
*                                                                               
         USING TRNELD,R2                                                        
DUMPTK12 ZAP   DUB,TRNAMNT                                                      
         CURED DUB,(13,P+58),2,ALIGN=LEFT,FLOAT=-                               
         MVC   P+72(2),=C'CR'                                                   
         TM    TRNSTAT,TRNSDR      IS IT A DEBIT?                               
         BZ    *+10                                                             
         MVC   P+72(2),=C'DR'                                                   
         CLI   DMPTYPE,1                                                        
         BL    DUMPTK15                                                         
*                                                                               
DUMPTK14 MVC   P+75(3),DFTCLI                                                   
         MVC   P+78(3),DFTPRD                                                   
         MVC   P+81(6),DFTJOB                                                   
         MVC   P+90(12),CURSJACC                                                
*                                                                               
DUMPTK15 LHI   R0,ACCORFST                                                      
         GOTO1 PRNTBL,DMCB,(L'P,P),(R3),C'DUMP',(R0),=C'2D'                     
         XIT1                                                                   
DMPTYPE  DS    AL1                                                              
         DROP  R2,R5                                                            
         SPACE 1                                                                
         LTORG                                                                  
         TITLE 'TABLE ENTRIES'                                                  
PHASETAB DS    0F                                                               
         DC    CL8'ACRL03  ',A(FRMTBLD-ACRLD)                                   
         DC    CL8'ACRL04  ',A(PRINTREP-ACRLD)                                  
         DC    CL8'ACRL05  ',A(TABINIT-ACRLD)                                   
         DC    CL8'ACRL06  ',A(ROUTINE-ACRLD)                                   
         DC    AL1(EOT)                                                         
         SPACE 3                                                                
TIMETAB  DC    A(0,0,0),AL1(RUNFRST),CL7'RUN1ST'                                
         DC    A(0,0,0),AL1(REQFRST),CL7'REQ1ST'                                
         DC    A(0,0,0),AL1(COMPFRST),CL7'CPY1ST'                               
         DC    A(0,0,0),AL1(UNITFRST),CL7'UNIT1ST'                              
         DC    A(0,0,0),AL1(LEDGFRST),CL7'LDG1ST'                               
         DC    A(0,0,0),AL1(LEVAFRST),CL7'LEVA1ST'                              
         DC    A(0,0,0),AL1(LEVBFRST),CL7'LEVB1ST'                              
         DC    A(0,0,0),AL1(LEVCFRST),CL7'LEVC1ST'                              
         DC    A(0,0,0),AL1(ACCFRST),CL7'ACCT1ST'                               
         DC    A(0,0,0),AL1(SBACFRST),CL7'SBAC1ST'                              
         DC    A(0,0,0),AL1(OFFIRST),CL7'OFF1ST'                                
         DC    A(0,0,0),AL1(PROCACC),CL7'PROCACC'                               
         DC    A(0,0,0),AL1(PROCHIST),CL7'PROCHIS'                              
         DC    A(0,0,0),AL1(PROCSBAC),CL7'PROCSBA'                              
         DC    A(0,0,0),AL1(PROCWORK),CL7'PROCHIS'                              
         DC    A(0,0,0),AL1(PROCLEVA),CL7'PROCLVA'                              
         DC    A(0,0,0),AL1(PROCLEVB),CL7'PROCLVB'                              
         DC    A(0,0,0),AL1(PROCLEVC),CL7'PROCLVC'                              
         DC    A(0,0,0),AL1(PROCLEVD),CL7'PROCLVD'                              
         DC    A(0,0,0),AL1(PROCOFA),CL7'PROCOFA'                               
         DC    A(0,0,0),AL1(PROCTRNS),CL7'PROCTRN'                              
         DC    A(0,0,0),AL1(PROCTIME),CL7'PROCTIM'                              
         DC    A(0,0,0),AL1(ANALFRST),CL7'ANALLST'                              
         DC    A(0,0,0),AL1(COMPLAST),CL7'CPYLST'                               
         DC    A(0,0,0),AL1(UNITLAST),CL7'UNITLST'                              
         DC    A(0,0,0),AL1(LEDGLAST),CL7'LDGLST'                               
         DC    A(0,0,0),AL1(LEVALAST),CL7'LEVALST'                              
         DC    A(0,0,0),AL1(LEVBLAST),CL7'LEVBLST'                              
         DC    A(0,0,0),AL1(LEVCLAST),CL7'LEVCLST'                              
         DC    A(0,0,0),AL1(ACCLAST),CL7'ACCTLST'                               
         DC    A(0,0,0),AL1(OFFLAST),CL7'OFFLST'                                
         DC    A(0,0,0),AL1(SBACLAST),CL7'SBACLST'                              
         DC    A(0,0,0),AL1(REQLAST),CL7'REQLAST'                               
         DC    A(0,0,0),AL1(RUNLAST),CL7'RUNLAST'                               
TIMEQ    EQU   (*-TIMETAB)/TIMELNQ                                              
         DC    A(0,0,0),AL1(0),CL7'UNKNOWN'                                     
TMONACC  DC    A(0,0,0),AL1(0),CL7'MONACC'                                      
         SPACE 3                                                                
RELOTAB  DC    A(IO)                                                            
         DC    A(AGETFCUR)                                                      
         DC    V(PRNTBL)                                                        
         DC    V(CENTER)                                                        
         DC    V(UNDERLIN)                                                      
         DC    V(ACEXCP)                                                        
         DC    V(CASHVAL)                                                       
         DC    V(ACJOBAGE)                                                      
         DC    V(PERVERT)                                                       
         DC    V(ACGETRTE)                                                      
         DC    AL1(EOT)                                                         
         EJECT                                                                  
HASHELM  DC    256AL1(0)                                                        
         ORG   HASHELM+MDTELQ                              X'1A'                
         DC    AL1((ELM1A-ELEMTAB)/L'ELEMTAB)                                   
         ORG   HASHELM+OTHELQ                              X'23'                
         DC    AL1((ELM23-ELEMTAB)/L'ELEMTAB)                                   
         ORG   HASHELM+FFNELQ                              X'25'                
         DC    AL1((ELM25-ELEMTAB)/L'ELEMTAB)                                   
         ORG   HASHELM+PRTELQ                              X'40'                
         DC    AL1((ELM40-ELEMTAB)/L'ELEMTAB)                                   
         ORG   HASHELM+MXPELQ                              X'47'                
         DC    AL1((ELM47-ELEMTAB)/L'ELEMTAB)                                   
         ORG   HASHELM+PXDELQ                              X'4E'                
         DC    AL1((ELM4E-ELEMTAB)/L'ELEMTAB)                                   
         ORG   HASHELM+CPJELQ                              X'4F'                
         DC    AL1((ELM4F-ELEMTAB)/L'ELEMTAB)                                   
         ORG   HASHELM+SCIELQ                              X'50'                
         DC    AL1((ELM50-ELEMTAB)/L'ELEMTAB)                                   
         ORG   HASHELM+ARTELQ                              X'59'                
         DC    AL1((ELM59-ELEMTAB)/L'ELEMTAB)                                   
         ORG   HASHELM+SUTELQ                              X'5F'                
         DC    AL1((ELM5F-ELEMTAB)/L'ELEMTAB)                                   
         ORG   HASHELM+TRSELQ                              X'60'                
         DC    AL1((ELM60-ELEMTAB)/L'ELEMTAB)                                   
         ORG   HASHELM+GLDELQ                              X'63'                
         DC    AL1((ELM63-ELEMTAB)/L'ELEMTAB)                                   
         ORG   HASHELM+MDPELQ                              X'6A'                
         DC    AL1((ELM6A-ELEMTAB)/L'ELEMTAB)                                   
         ORG   HASHELM+TRXELQ                              X'75'                
         DC    AL1((ELM75-ELEMTAB)/L'ELEMTAB)                                   
         ORG   HASHELM+NOTELQ                              X'76'                
         DC    AL1((ELM76-ELEMTAB)/L'ELEMTAB)                                   
         ORG   HASHELM+AFCELQ                              X'7A'                
         DC    AL1((ELM7A-ELEMTAB)/L'ELEMTAB)                                   
         ORG   HASHELM+SORELQ                              X'7B'                
         DC    AL1((ELM7B-ELEMTAB)/L'ELEMTAB)                                   
         ORG   HASHELM+UNPELQ                              X'7C'                
         DC    AL1((ELM7C-ELEMTAB)/L'ELEMTAB)                                   
         ORG   HASHELM+EXOELQ                              X'97'                
         DC    AL1((ELM97-ELEMTAB)/L'ELEMTAB)                                   
         ORG   HASHELM+XDFELQ                              X'A2'                
         DC    AL1((ELMA2-ELEMTAB)/L'ELEMTAB)                                   
         ORG   HASHELM+APEELQ                              X'C0'                
         DC    AL1((ELMC0-ELEMTAB)/L'ELEMTAB)                                   
         ORG   HASHELM+PAKELQ                              X'D4'                
         DC    AL1((ELMD4-ELEMTAB)/L'ELEMTAB)                                   
         ORG   HASHELM+SERELQ                              X'D5'                
         DC    AL1((ELMD5-ELEMTAB)/L'ELEMTAB)                                   
         ORG   HASHELM+RALELQ                              X'D9'                
         DC    AL1((ELMD9-ELEMTAB)/L'ELEMTAB)                                   
         ORG   HASHELM+FFTELQ                              X'DB'                
         DC    AL1((ELMDB-ELEMTAB)/L'ELEMTAB)                                   
         ORG                                                                    
         EJECT                                                                  
ELEMTAB  DS    0XL4                                                             
         DC    AL1(MDTELQ),AL2(AELEM1A-ACRLD),AL1(ELMRNONE)  X'1A'              
ELM1A    DC    AL1(OTHELQ),AL2(AELEM23-ACRLD),AL1(ELMRNONE)  X'23'              
ELM23    DC    AL1(FFNELQ),AL2(AELEM25-ACRLD),AL1(ELMRNONE)  X'25'              
ELM25    DC    AL1(PRTELQ),AL2(AELEM40-ACRLD),AL1(ELMRNONE)  X'40'              
ELM40    DC    AL1(MXPELQ),AL2(AELEM47-ACRLD),AL1(ELMRNONE)  X'47'              
ELM47    DC    AL1(PXDELQ),AL2(AELEM4E-ACRLD),AL1(ELMRNONE)  X'4E'              
ELM4E    DC    AL1(CPJELQ),AL2(AELEM4F-ACRLD),AL1(ELMRNONE)  X'4F'              
ELM4F    DC    AL1(SCIELQ),AL2(AELEM50-ACRLD),AL1(ELMRT001)  X'50'              
ELM50    DC    AL1(ARTELQ),AL2(AELEM59-ACRLD),AL1(ELMRNONE)  X'59'              
ELM59    DC    AL1(SUTELQ),AL2(AELEM5F-ACRLD),AL1(ELMRT002)  X'5F'              
ELM5F    DC    AL1(TRSELQ),AL2(AELEM60-ACRLD),AL1(ELMRNONE)  X'60'              
ELM60    DC    AL1(GLDELQ),AL2(AELEM63-ACRLD),AL1(ELMRT004)  X'63'              
ELM63    DC    AL1(MDPELQ),AL2(AELEM6A-ACRLD),AL1(ELMRNONE)  X'6A'              
ELM6A    DC    AL1(TRXELQ),AL2(AELEM75-ACRLD),AL1(ELMRNONE)  X'75'              
ELM75    DC    AL1(NOTELQ),AL2(AELEM76-ACRLD),AL1(ELMRT003)  X'76'              
ELM76    DC    AL1(AFCELQ),AL2(AELEM7A-ACRLD),AL1(ELMRNONE)  X'7A'              
ELM7A    DC    AL1(SORELQ),AL2(AELEM7B-ACRLD),AL1(ELMRNONE)  X'7B'              
ELM7B    DC    AL1(UNPELQ),AL2(AELEM7C-ACRLD),AL1(ELMRNONE)  X'7C'              
ELM7C    DC    AL1(EXOELQ),AL2(AELEM97-ACRLD),AL1(ELMRNONE)  X'97'              
ELM97    DC    AL1(XDFELQ),AL2(AELEMA2-ACRLD),AL1(ELMRNONE)  X'A2'              
ELMA2    DC    AL1(APEELQ),AL2(AELEMC0-ACRLD),AL1(ELMRNONE)  X'C0'              
ELMC0    DC    AL1(PAKELQ),AL2(AELEMD4-ACRLD),AL1(ELMRNONE)  X'D4'              
ELMD4    DC    AL1(RALELQ),AL2(AELEMD5-ACRLD),AL1(ELMRNONE)  X'D5'              
ELMD5    DC    AL1(SERELQ),AL2(AELEMD9-ACRLD),AL1(ELMRNONE)  X'D9'              
ELMD9    DC    AL1(FFTELQ),AL2(AELEMDB-ACRLD),AL1(ELMRNONE)  X'DB'              
ELMDB    DC    AL1(0),AL2(0),AL1(0)                                             
         SPACE 2                                                                
***********************************************************************         
*              CL2(LEDGER)                                                      
*              S(SAVE AREA FOR DATA)                                            
*              S(ADDRESS OF LIST OR FILTER FIELD)                               
***********************************************************************         
APTABLE  DS    0F                                                               
         DC    C'1C',AL2(CURCOST-ACRLD)                                         
APTABQ   EQU   *-APTABLE                                                        
         DC    C'11',AL2(CURBLNG-ACRLD)                                         
         DC    C'12',AL2(CURREVN-ACRLD)                                         
         DC    C'2P',AL2(CURPRSN-ACRLD)                                         
         DC    C'2D',AL2(CURDEPT-ACRLD)                                         
         DC    C'13',AL2(CURDEXP-ACRLD)                                         
*&&UK*&& DC    C'SG',AL2(CURVAT-ACRLD)                                          
*&&UK*&& DC    C'SF',AL2(CURVNDR-ACRLD)                                         
         DC    C'SV',AL2(CURVNDR-ACRLD)                                         
         DC    C'SX',AL2(CURVNDR-ACRLD)                                         
*&&US*&& DC    C'SY',AL2(CURVNDR-ACRLD)                                         
*&&US*&& DC    C'SW',AL2(CURVNDR-ACRLD)                                         
*&&US*&& DC    C'3 ',AL2(CURPART-ACRLD)                                         
         DC    C'1R',AL2(CURPRSN-ACRLD)                                         
         DC    C'29',AL2(CURCEA-ACRLD)                                          
         DC    C'SJ',AL2(CURSJ-ACRLD)                                           
         DC    C'SJ',AL2(0)                                                     
         DC    AL1(EOT)                                                         
         EJECT ,                                                                
BILTYTAB DC    CL1'A',CL15'AUTO BILL'                                           
         DC    CL1'G',CL15'GRP BILLING'                                         
         DC    AL1(TRNBTALL),CL15'ALLOCATED BILL'                               
         DC    AL1(TRNBTCLI),CL15'CLIENT WP BILL'                               
         DC    AL1(TRNBTCLI),CL15'JOB-ABRECHNUNG'      GERMAN                   
         DC    AL1(TRNBTMAN),CL15'MANUAL BILLING'                               
         DC    AL1(TRNBTMAN),CL15'MANUAL ERSTELL'      GERMAN                   
         DC    AL1(TRNBTPRO),CL15'PROGRESSIVE'                                  
         DC    AL1(TRNBTPRO),CL15'FORTLAUFEND'         GERMAN                   
         DC    AL1(TRNBTSPE),CL15'SPECIAL AMOUNT'                               
         DC    AL1(TRNBTSPE),CL15'SPECIAL'             GERMAN                   
         DC    AL1(TRNBTTOT),CL15'TOTAL BILL'                                   
         DC    AL1(TRNBTTOT),CL15'TOTAL'               GERMAN                   
         DC    AL1(TRNBTONE),CL15'ONE-LINE BILL'                                
         DC    AL1(EOT)                                                         
         EJECT ,                                                                
***********************************************************************         
*              'Y'       INCLUDE ALL  TRANS.                                    
*              'A'       INCLUDE ALLOCATED TRANS                                
*              'B'       INLCUDE BILLED TRANS ONLY, FULL/PART                   
*              'N'       INCLUDE BILLABLE, FULL/PART                            
*              'U'       INLCUDE BILLABLE BUT NOT FULLY ALLOC.                  
*              'O'       INCLUDE UTIL TRANS. FULL/PART                          
*              'P'       INLCUDE PARTIAL UTIL.                                  
***********************************************************************         
UTILTAB  DC    C' ',AL1(0,0,0,0)                                                
         DC    C'Y',AL1(0,0,0,0)                                                
*&&UK*&& DC    C'J',AL1(0,0,0,0)                                                
         DC    C'A',AL1(PG$BILAL,BZ,0,0)                                        
         DC    C'B',AL1(PG$BILUP,BZ,0,0)                                        
         DC    C'N',AL1(PG$FULUT,BO,0,0)                                        
         DC    C'U',AL1(PG$FULUT+PG$FULAL,BNZ,0,0)                              
         DC    C'O',AL1(PG$BILUP+PG$WOFUP+PG$XFRUP,BZ,0,0)                      
         DC    C'P',AL1(PG$FULUT,BO,PG$BILUP+PG$WOFUP+PG$XFRUP,BZ)              
UTILTABX EQU   (*-UTILTAB)/5                                                    
         EJECT ,                                                                
***********************************************************************         
* ESTIMATE STATUSES                                                             
*                                                                               
*              'P'       CREATED/IN PROGRESS                                    
*              'B'       SUBMITTED TO INTERNAL APPROVER                         
*              'S'       SUBMITTED TO CLIENT APPROVER                           
*              'A'       CLIENT APPROVED                                        
*              'R'       REJECTED                                               
*              'D'       DELETED                                                
*              'I'       INTERNALLY APPROVED                                    
*              'M'       MERGED                                                 
***********************************************************************         
BESTAB   DS    0F                                                               
         DC    AL1(BESPRG),AL1(ESTKCREA,0)         In progress                  
BESTABQ  EQU   *-BESTAB                                                         
         DC    AL1(BESSIN),AL1(ESTKSUBM,ESTKSINA)  Sub to internal appr         
         DC    AL1(BESIAP),AL1(ESTKINTA,0)         Internally apprvd            
         DC    AL1(BESSCL),AL1(ESTKSUBM,0)         Sub to client appr           
         DC    AL1(BESCAP),AL1(ESTKCAPP,0)         Client apprvd                
         DC    AL1(BESREJ),AL1(ESTKREJE,0)         Rejected                     
         DC    AL1(BESDEL),AL1(ESTKLOGD,0)         Logically deleted            
         DC    AL1(BESMRG),AL1(ESTKLOGD,ESTKMERG)  Merged                       
BESTABX  EQU   (*-BESTAB)/BESTABQ                                               
         EJECT ,                                                                
                                                                                
*ACREPRLWRK                                                                     
         PRINT OFF                                                              
       ++INCLUDE ACREPRLWRK                                                     
         PRINT ON                                                               
*DDCOREQUS                                                                      
         PRINT OFF                                                              
       ++INCLUDE DDCOREQUS                                                      
         PRINT ON                                                               
*ACGETRATEC                                                                     
FMRATED  DSECT                                                                  
         PRINT OFF                                                              
       ++INCLUDE ACGETRATEC                                                     
         PRINT ON                                                               
*IHAASCB                                                                        
         PRINT OFF                                                              
         IHAASCB                                                                
         PRINT ON                                                               
STORECD  DSECT                                                                  
STORKEY  DS    CL(ACCORFST)                                                     
STOFLTS  DS    CL5                 Save off composite filters                   
STOKLNQ  EQU   *-STORECD                                                        
STOADDR  DS    XL4                                                              
STORLNQ  EQU   *-STORECD                                                        
                                                                                
TIMED    DSECT                                                                  
TIMETOTL DS    A                                                                
TIMECNT  DS    A                                                                
TIMEIO#  DS    A                                                                
TIMEMODE DS    AL1                                                              
TIMETAG  DS    CL7                                                              
TIMELNQ  EQU   *-TIMED                                                          
*                                                                               
*                                                                               
* Info from Audit record                                                        
TMSAUD   DSECT                                                                  
TMSLMGR  DS    XL2                 Line manager pid                             
TMSPID   DS    XL2                 Pid of 1R person                             
TMSDT    DS    0C                                                               
TMSAPDT  DS    XL3                 Timesheet date                               
TMS#ROW  DS    XL1                 # of rows for this timesheet date            
TMSCLNQ  EQU   *-TMSDT                                                          
TMDAP    DS    0C                                                               
TMSADTE  DS    PL3                 Approver date                                
TMSAPID  DS    XL2                 Approver Pid                                 
TMSAROW  DS    XL2                 Row                                          
TMSALNQ  EQU   *-TMDAP                                                          
TMSDLNQ  EQU   *-TMSDT                                                          
TMSLNQ   EQU   *-TMSAUD                                                         
*                                                                               
BGBMDSCT DSECT                                                                  
BGBMCPY  DS    XL(L'TRNKCPY)       COMPANY CODE                                 
BGBMLACT DS    CL(L'TRNKULA-1)     LEDGER / ACCT OF GB                          
BGBMOFF  DS    CL(L'TRNKOFF)       OFFICE                                       
BGBMCNTR DS    CL(L'TRNKULC)                                                    
BGBMMOS  DS    XL(L'PBKHI)                                                      
BGBMLNQ  EQU   *-BGBMDSCT                                                       
*                                                                               
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'233ACREPRL02 08/12/20'                                      
         END                                                                    
