*          DATA SET ACBRA26    AT LEVEL 116 AS OF 11/05/20                      
*PHASE T62426A                                                                  
*INCLUDE ACGETCRL                                                               
                                                                                
ACBRA26  TITLE '- BrandOcean New Style Maintenance Downloads'                   
                                                                                
* Level change comments                                                         
* ---------------------                                                         
* UK Levels                                                                     
* ---------                                                                     
* TKLU 001 01JUN07 New style server set up                                      
* NSHE 004 08NOV07 <LO01-6995> Set FACPAK code for analysis                     
* TKLU 005 11DEC07 US merger (JSHA, comments only)                              
* TKLU 006 29JAN08 <DU01-6578> Product code narrative return value              
* NSHE 007 29JUL08 <LO01-7859+LO01-7875> Add expenses initial call with         
*                  new profile values                                           
* TKLU     05AUG08 <DU01-7684> Narratives work code filter                      
* TKLU 009 17SEP08 <BR12990D> Filter name/value bug fix                         
* NSHE 010 22SEP08 Add office records to expenses initial call                  
* NSHE 011 07OCT08 New initial call for expenses                                
* TKLU 012 15OCT08 <LO01-8207> 'Internal Approvals' implementation              
* TKLU 013 04DEC08 <LO01-8306> Pass currencies in BLDCUR order (this            
*                  allow currencies to be added in Con/Gen only)                
* TKLU 014 06JAN09 <UKCR00019430> Order type in EType download                  
* TKLU 017 27JAN09 <BR22672L> 1R person code of user in Exp/Initial             
* NSHE 018 24OCT08 Remove pidrec limit list and approver references             
* TKLU     30OCT08 SE analysis flags to EType/List                              
* TKLU     19NOV08 <UKCR00019430> Order type in EType download                  
* TKLU     18DEC08 <DU01-8048> Report format code d/load additions              
* TKLU     07JAN09 Currency list bug fix                                        
* MPEN     14JAN09 <BR22413L> READ MORE THAN ONE LIDELD ON ETYPES               
* SMAN     11FEB09 UKCR00020761 Fix to Browse by clients                        
* JFOS 019 16feb09 <LO01-7636> Invoices: set 'Cli req for KSV' flag             
* JFOS     06Apr09 <LO01-7636> Invoices: QINITIAL=F if finance user             
* NSHE     19MAY09 Add XT logon request                                         
* SMAN 021 14JUL09 <UKCR00023073> Keep leading zeros for currency rates         
* JFOS 022 01JUN09 <LO01-7636> Invoices: read PM prof for dup inv chk           
* MPEN 022 04JUN09 <LO01-8946> PASS 2 LVL APPROVER SETTINGS FOR EXP             
* MPEN 022 15JUN09 <LO01-9010> ADD NEW FIELD TO ETYPE RECORD                    
* SMAN 022 18JUN09 <LO01-8837> D/L Scheme LimList contents                      
* TKLU 023 24JUL09 <LO01-8963> SCMRECD APPLICATION = EXPENSES FILTER            
* SMAN 023 28JUL09 <LO01-8837> Change format of Scheme list d/l                 
* JFOS     18AUG09 <LO01-9184> Variance p/ws, multiple ENCODE 'keys'            
* NSHE     19SEP09 Apply new limit list controls to client download             
* SMAN 024 28SEP09 <BR27681L> Fix to checking for overdue t/s                   
* NSHE 025 01OCT09 fix to order validation - pass profile for analysis          
* JFOS 026 08OCT09 <LO01-9064> Invoices: O/R sts change,add Aprv mix rl         
* SMAN 027 12OCT09 <UKCR00022317> Get default scheme by media                   
* NSHE 028 19NOV09 Add new output field in job initial call                     
* SMAN 029 02DEC09 <UKCR00023989> Fix to read seq Scheme Limlist recs           
* MPEN 030 23SEP09 <LO01-9348> Add new profile-receipt bx ticked by def         
* NSHE 031 04JAN10 <UKCR00026305> Fix job length to be max 6 chars              
* JSHA 032 04JAN10 Time lock work for Grey NY                                   
* SMAN 033 26JAN10 <BR30395L> Fix to CALPRDS                                    
* SMAN 034 04FEB10 Remove lvl 27 changes                                        
* NSHE 035 12FEB10 Fix to client list in job initial call                       
* JFOS 035 25MAR10 Return f/currency, new Vat inds on Invoices initial          
* TKLU 036 04JUN10 EType supplier: return accounts for none low levels          
* NSHE 036 08JUN10 Send URL in intial call for web app emails                   
* NSHE 037 11AUG10 Send KSV analysis settings in invoices initial call          
* NSHE 038 25OCT10 New expenditure type call                                    
* TKLU 039 08FEB11 <LO01-8459> ACGETCRL/BLDCUR for soft currency names          
* MPEN 040 21JAN11 <PR000716> Pass GAP Order settings                           
* YNGX 041 04MAY11 <BR41275L> FIX TO DUPLICATE SUPPLIER ACCOUNTS                
* MPEN 048 11FEB11 <PR001317> New profile to choose expense claim app           
* NSHE     18MAY11 New profile to control new mileage system                    
* JFOS     18OCT11 <PR002088> Hourly Rates download                             
* SMAN     11OCT11 <PR002272> Include 1R location information                   
* YNGX     15NOV11 <BR45523L> BUG FIX DOWNLOADING SCHEME CODE                   
* MPEN     31JAN12 <PR002517> Pass third party flag                             
* MPEN     19MAR12 <UKCR00034199> BUG FIX TO SCHEME INI READ SEQ PROP           
* NSHE 049 17APR12 Enhancement to person download to use person code            
* NSHE 050 08MAY12 Don't show location info for terminated person               
* JFOS 051 25JUN12 <UKCR00034320> US:Pass rates with no effective date          
* JSHA 052 10JUL12 Fix bug losing element loop register in OVRTIM               
* YNGX 052 18DEC12 Fix bug reading rate elements                                
* MPEN 053 05FEB13 Fix narratives for all applications                          
* MPEN 054 09APR13 <BRO-244> Fix standard narratives for the US                 
* MPEN 055 09APR13 <PR003562> Separate setting to control FC on orders          
* MPEN     26APR13 <BR55302L> Fix check for overdue timesheets                  
* NSHE 056 19JUL13 Change where SETFAC is set                                   
* NRAK 057 30Oct13 OrderInit to use new ETypeList for Rodick                    
* MPEN 058 24JAN14 <DSRD-681> Estimate Initial call rodick amendments           
* NSHE     28JAN14 Change job initial call for rodick amendments                
* YNGX 059 02APR14 FIX 2CO BUG ON HOURLY RATE SEARCH                            
* MPEN 060 25APR14 <DSBO-813> Don't include term person in rate lookup          
* NSHE 062 20MAY14 <DSRD-2572> Return office code name list                     
* MPEN     02JUN14 <DSBO-675> Include ACGETCRL                                  
* NSHE     06JUN14 2 initial job calls for Aura                                 
* TKLU 063 12Aug14 <RD003587> Format records: allow office lists if 2CO         
*          20Aug14 <RD001820> Client level currency exchange rates              
* MPEN     08AUG14 <DSRD-1842> Estimate scheme download                         
* NSHE     21AUG14 <DSRD-4003> Estimate initial call split for Aura             
* TKLU 064 08Sep14 <RD004212> SCHINI routine fixes for LimList etc.             
*          26Sep14 <RD004424> Skip slush only category schemes                  
*          01Oct14 <RD004583> All currencies parm for none production           
*          12Nov14 <RD003587> More changes to support office lists              
* TKLU 065 24Nov14 <RD003587> Report format bug fix debug version               
* NSHE 066 27Nov14 <DSRD-5322> Aura changes for orders initial call             
* TKLU     09DEc14 <RD005440> Client based rates - check currency seq           
* MPEN     17Dec14 <BO001282> Fix default for supplier codes                    
* MPEN     18Dec14 <DSRD-5545> Return supplier locked status                    
* YNGX     22Dec14 <DSRD-5545> Return exoebse/supplier locked status            
* NSHE     29Dec14 <DSRD-5594> Ensure date is set correctly for Aura            
* NSHE     30Dec14 <DSRD-5608> Send name with work code list                    
* NSHE     31Dec14 <DSRD-5575> Don't read billable/non billable for             
* NSHE                         etype record when US                             
* NSHE     09Jan15 <DSRD-5402> Show US business address for suppliers           
* NSHE 067 20Jan15 <DSRD-5842> Show locked clients in initial call              
* NSHE     29Jan15 <DSRD-5939> Return dept pos and length for order             
* MPEN 068 24Mar15 <DSBO-1405> Clear AGENAREA before currency list              
* MPEN 069 24Mar15 <DSBO-1417> Reinstate closed/locked filt on A#EINI           
* MPEN 070 27Mar15 <DSBO-1417> Only send locked clients for Aura Orders         
* NSHE     31Mar15 <DSRD-6737> Hardcode so W&K can't access estimates           
* NSHE 071 14Apr15 <DSRD-5731> US fix by JSHA for address format                
* JFOS     17Apr15 <PCA-01670> Return BACS .cc email on Gen initial d/l         
* NSHE 072 01May15 <DSRD-6912> Remove supplier list in orders initial           
* NSHE     11May15 <PCA-01754> Return IDI name for BACS email service           
* YNGX 073 14MAY15 <DSRD-7182> Return lower level suppliers                     
* YNGX     14MAY15             Comment out ARYAGNT as it's not in use           
* NSHE 074 20MAY15 <DSRD-7293> Don't allow requisition in Aura without          
*                              prefix being set                                 
* JFOS     22MAY15 <PCA-01670> Fix BACS .cc email lookup for 1CO                
* MPEN     17JUN15 <DSBO-1506> Ensure ETYL key is restored                      
* NSHE     08Jun15 <DSRD-7410> Don't allow internal approval for Aura           
* MPEN 075 16Jul15 <DSBO-1531> Fix for person search call                       
* NSHE 075 03Jul15 <DSRD-7832> Add decimal place and currency                   
* NSHE 076 01Sep15 <DSRD-8353> Return WC level rates                            
* MPEN 077 24Nov15 <DSBO-1633> Skip checking for EMPELD if now low lvl          
* NSHE     06Oct15 <DSRD-8965> Investigate looping in runner for rates          
* NSHE     17Nov15 <DSRD-9401> Send orders initial response for jobs            
* NSHE     19Nov15 <DSRD-9469> Don't send names in upper case for Aura          
* NSHE 078 06Jan16 <DSRD-9947> Standard comments fix for orders                 
* NSHE     07Jan16 <DSRD-10006> Ensure request off is read not gaplst           
* NSHE     08Jan16 <DSRD-8902> Work out min and max rates when EUR              
* NSHE 079 21Jan16 <DSRD-10090> Only allow cost work codes in orders            
* TKLU     27Jan15 <RD010160>   Use AGOBLOCB not AGOBLOCK                       
* NSHE     08Feb16 <DSRD-10378> Add currency to jobs download for Aura          
* NSHE 080 29Mar16 <DSRD-10842> Add currency to invoice initial                 
* NSHE 081 01Jun16 Change expenses initial call for etype                       
* MPEN 082 01Jul16 <DSRD-11140> MF changes for federated url                    
* YNGX     21JUL16 <DSRD-12041> SHOW LOCATION ARRAY FOR AURA                    
* NSHE 083 05Sep16 <ITMF-9341> Work out min max correctly                       
* NSHE 084 06Sep16 <DSRD-13159> 2nd expense initial call - office & wc          
* MPEN 085 27Oct16 <SPEC-7364> Fix for BrandOcean expense initial               
* YNGX 086 28Nov16 <DSRD-14209> New GST/PST/Province/Rate download              
*          30Nov16 <DSRD-14214> Include Province list on init call              
*          20Dec16 <DSRD-14462> Fix Etype download for default wc               
* GHOA 087 12Jan17 <DSRD-14442> Include Studio list on Jobs Initial             
* MPEN     28Feb17 <DSRD-15036> Copy US fixes                                   
* MPEN     22Mar17 <DSRD-15255> Fix for url on federated env                    
* TKLU 088 12May17 <DSRD-15067> Return CPYSAP2J payment setting                 
* NSHE             <DSRD-15421> Return company year start month                 
* NSHE 090 09Jun17 <DSRD-15997> Line manager pid in person list                 
* NSHE     15Jun17 <DSRD-16029> Incorrect staff list                            
* YNGX     11Jul17 <DSRD-16287> Always send currency decimal places             
* CPAT 091 28Aug17 <DSRD-16671> MF-TimeOff request for backup approver          
*      091 26Sep17 <DSRD-16798> MF-TimeOff req to pass edit hour                
*      091 29Sep17 <DSRD-17085> MF-TimeOff fix filter for duplicate rec         
* NSHE 092 17Oct17 <DSRD-17206> Return reports of reports                       
* NSHE     24Oct17 <DSRD-17076> Return latest cost calendar in initial          
* NSHE 093 24Oct17 <DSRD-17648> Add hire and term date to my reports            
* MPEN     15Jan18 <DSRD-17947> No cutoff date for QA files                     
* NSHE 094 20Feb18 <DSRD-18290> Change person download to provide pers          
* NSHE 095 01Mar18 <DSRD-17966> Add userid and PIN to general initial           
* NSHE 096 18Apr18 <IAPP-173737> Ensure person download errors                  
* NSHE 097 25May18 <DSRD-18871> Don't return terminated backup approver         
* MPEN 098 02Aug18 <DSRD-19859> Fix for PST rate                                
* MPEN     07Sep18 <DSRD-19612> Include moa list in invoice initial             
* MPEN 099 28Sep18 <DSRD-20033> Return new electronic invoice flag              
* MPEN 100 15Oct18 <DSRD-20033> Fix for invoice narrative                       
* MPEN     23Oct18 <DSRD-20447> Relink for DPAPASD changes                      
* MPEN     08Nov18 <DSRD-20738> Return the country and currency                 
* MPEN     29Nov18 <DSRD-20325> Return low level exp accounts                   
* MPEN 101 13Feb19 <DSRD-21694> Fix for GST rate in initial call                
* MPEN     28Feb19 <DSRD-21808> Fix for GST rate lookup                         
* MPEN 102 20Mar19 <DSRD-22047> Include overdue t/s in initial calls            
* MPEN     11Apr19 <DSRD-22122> Fix for incorrect person details                
* MPEN 103 03May19 <DSRD-22463> Return multi currency agency option             
* MPEN     10May19 <DSRD-22517> New option to return just loc info              
* MPEN     15May19 <DSRD-22017> New office request field on curr list           
* NSHE 104 28May19 <DSRD-22083> Add GAP setting to etype supplier list          
* MPEN     31May19 <DSRd-22624> Fix for office currency lookup                  
* MPEN 105 18Jul19 <DSRD-22750> Ignore daily edit hours for overdue             
* MPEN     29Jul19 <DSRD-23211> Fix for duplicate agency currency               
* MPEN     07Aug19 <DSRD-23437> Fix for missing agency currency                 
* MPEN 106 04Sep19 <DSRD-23698> Fix for overdue t/s                             
* NSHE 107 19Aug19 <DSRD-23553> Use time off back up approvers                  
* MPEN     09Sep19 <DSRD-23841> Fix for timesheet overdue                       
* NSHE     09Sep19 <DSRD-22374> Need to remove personal data                    
* NSHE     24Sep19 <DSRD-23939> Retrun timesheet and expense approver           
* NSHE                          and access equivalent                           
* MPEN 108 02Dec19 <DSRD-24592> Remove limited cli list from est ini            
* MPEN     04Dec19 <DSRD-24591> Remove limited cli list for job ini             
* MPEN 109 13Dec19 <DSRD-24630> Return rich text setting                        
* MPEN 109 10Feb20 <DSRD-25377> Relink book                                     
* MPEN 110 20Feb20 <DSRD-25557> FIX FOR EXPENDITURE TYPE GAP IN USE             
* ABID 111 21MAR20 <DSRD-25113> ORDERS - MF - EU NEW CO REC SETTING             
*                               TO DRIVE SUPPORT FOR ORDERS HTML TEXT           
* MPEN 112 03APR20 <DSRD-25315> EINV VAT line tolerance                         
* NRAK 113 09JUN20 SPEC-46950 Fix optimisation                                  
* YNGX 114 14JUL20 <DSRD-26631> RETURN CPY SETTING MOBILE TIME IN USE           
* YNGX 115 06AUG20 <DSRD-26557> RETURN CORRECT MOS RANGE FOR INV LOG            
* NSHE     05Aug20 <DSRD-27173> Clean up URL logic                              
* NSHE     30Sep20 <DSRD-27647> Ensure we clear CTFILE buffer                   
* MPEN 116 28Sep20 <DSRD-27189> Support SI ledger on etype list                 
* MPEN     02Nov20 <DSRD-27889> Check sec term date                             
* MPEN     03Nov20 <DSRD-27962> Option to include terminated users              
**********************************************************************          
* US Levels                                                                     
* ---------                                                                     
* JSHA 001 06Dec07 All UK Levels up to 4                                        
**********************************************************************          
*                                                                               
                                                                                
         PRINT NOGEN                                                            
SVRDEF   CSECT                                                                  
         LKSVR TYPE=D,                                                 +        
               SERVERTYPE=TSTACBO,WORKERKEY=ACBO,                      +        
               SEGMENT=Y,APPEND=Y,IDF=Y,                               +        
               REQUEST=*,CODE=CODE,                                    +        
               SYSPHASE=X'0624',SYSTEM=ACCSYSQ,                        +        
               BLOCKS=(B#WORKD,WORKD,B#SAVED,SAVED,                    +        
               B#LP_D,LP_D,B#TWAD,TWAD,B#SVRDEF,SVRDEF,                +        
               B#LLSREC,LLSRECD,B#ONAREC,ONARECD,B#SCMREC,SCMRECD,     +        
               B#ROLE,ROLRECD,B#TEAM,TEARECD,B#PID,PIDRECD,            +        
               B#OFFREC,OFFRECD,B#SCHEME,SCHRECD,B#FNVREC,RSFRECD,     +        
               B#ERFREC,ERFRECD,B#MEDREC,PMDRECD,                      +        
               B#NICREC,GFEED,B#PCRREC,PCRRECD,B#PCHREC,PCHRECD,       +        
               B#GXL,GXLID,                                            +        
               B#WCREC,WCORECD,                                        +        
               B#ACTREC,ACTRECD,                                       +        
               B#ETYREC,ETYRECD,                                       +        
               B#PERREC,PERRECD,                                       +        
               B#LINMGR,BKLINMGR,                                      +        
               B#EDTREC,EDTRECD,                                       +        
               B#STUREC,STURECD,                                       +        
               B#SAPREC,SAPEREC,B#CAMREC,RWKRECD,B#COBLCK,COBLOCKD)             
         EJECT                                                                  
                                                                                
CODE     NMOD1 0,**BO26**,RR=RE                                                 
         LARL  RA,GLOBALS                                                       
         USING GLOBALS,RA          RA=A(GLOBAL LITERALS)                        
         LR    R5,R1                                                            
         USING LP_D,R5             R5=A(DDLINK PARAMETER BLOCK)                 
         L     R7,LP_ARUNP                                                      
         USING RUNPARMD,R7         R7=A(RUNPARMS)                               
         XR    R6,R6                                                            
         ICM   R6,7,RUNPARUN                                                    
         USING RUNFACSD,R6         R6=A(RUNFACS)                                
                                                                                
         USING WORKD,R9            R9=A(GLOBAL W/S)                             
         USING SAVED,R8            R8=A(SAVE W/S)                               
                                                                                
         TM    LP_FLAG,LP_FOFFL    TEST OFFLINE                                 
         BNZ   INIT02                                                           
         ICM   R9,15,LP_ABLK1      ROOT SETS A(WORKD)                           
         BNZ   *+6                                                              
         DC    H'0'                                                             
         ICM   R8,15,RSVRSAVE      R8=A(7K SAVE AREA)                           
         ST    R8,LP_BLKS+((B#SAVED-1)*L'LP_BLKS)                               
         LA    R1,WORKD                                                         
         ST    R1,LP_BLKS+((B#WORKD-1)*L'LP_BLKS)                               
         B     INIT04                                                           
                                                                                
INIT02   L     R9,RSVRSAVE                                                      
         ST    R9,LP_BLKS+((B#WORKD-1)*L'LP_BLKS)                               
         XR    R8,R8                                                            
         ICM   R8,3,WORKLEN                                                     
         LA    R8,WORKD(R8)                                                     
         ST    R8,LP_BLKS+((B#SAVED-1)*L'LP_BLKS)                               
                                                                                
         USING CPXELD,SCPXEL                                                    
         USING CPYELD,SCPYEL                                                    
INIT04   MVC   ATWA,LP_ATWA                                                     
         MVC   RUNMODE,RUNPMODE    EXTRACT DDLINK/RUNNER CALLING MODE           
         MVC   ACOMFACS,RCOMFACS                                                
         MVC   AMASTC,RMASTC                                                    
         MVC   ABUFFRIN,RBUFFRIN                                                
         MVC   APRINTER,RPRINTER                                                
         ST    R6,ARUNFACS                                                      
         DROP  R6,R7                                                            
                                                                                
         USING TWAD,R7                                                          
         L     R7,ATWA             RA=A(ON/OFFLINE TWA)                         
                                                                                
         MVI   TWAMODE,0                                                        
                                                                                
         ST    R5,ALP              SAVE A(LP_D)                                 
         ST    RE,SRVRRELO         SAVE PROGRAM RELOCATION FACTOR               
                                                                                
         STM   R2,RB,LP_R2RB       SAVE REGISTERS FOR SUB-ROUTINES              
                                                                                
         EJECT                                                                  
***********************************************************************         
* Initialize for running                                              *         
***********************************************************************         
                                                                                
RUNSTR   CLI   RUNMODE,RRUNSTRQ    TEST FIRST FOR RUN                           
         BNE   PRCWRK                                                           
                                                                                
         L     R0,ATIA                                                          
                                                                                
         TM    LP_FLAG,LP_FOFFL    TEST OFFLINE                                 
         BZ    RUNSTR02            NO                                           
                                                                                
         MVC   AROUT1,LP_AUIR1     SET LOCAL INDEX ROUTINE ADDRESSES            
         MVC   AROUT2,LP_AUIR2     WHICH WERE LOADED BY MASTER SERVER           
                                                                                
         GOTOR (#WRKINI,AWRKINI)   INITIALIZE SERVER WORKING STORAGE            
         B     RUNSTR08                                                         
                                                                                
RUNSTR02 GOTOR (#WRKINI,AWRKINI)   INITIALISE WORKING STORAGE                   
                                                                                
         LHI   R1,BRO#GENR                                                      
         CLC   LP_QMAPN,=AL2(A#JINI)   jobs initial call                        
         JNE   *+8                                                              
         LHI   R1,BRO#JOBS                                                      
         CLC   LP_QMAPN,=AL2(A#EINI)   estimates initial call                   
         JNE   *+8                                                              
         LHI   R1,BRO#ESTS                                                      
         CLC   LP_QMAPN,=AL2(A#INIT)   order initial call                       
         JNE   RUNSTR04                                                         
         LHI   R1,BRO#TIME             mobile time and approve                  
         SR    RF,RF                    make orders initial call                
         ICM   RF,3,CUXPNUM              but show this as time in stats         
         CHI   RF,XPMOBILQ                                                      
         JE    RUNSTR04                                                         
         LHI   R1,BRO#GENR             If BrandOcean make general               
         CHI   RF,XPRODIKQ                                                      
         JNE   RUNSTR04                                                         
         LHI   R1,BRO#ORDS             Aura set orders                          
RUNSTR04 CLC   LP_QMAPN,=AL2(A#CLID)   expense initial call                     
         JNE   *+8                                                              
         LHI   R1,BRO#EXPS                                                      
         CLC   LP_QMAPN,=AL2(A#IAIN)   invoices initial call                    
         JNE   *+8                                                              
         LHI   R1,BRO#INVS                                                      
         GOTOR (#SETFAC,ASETFAC)                                                
         MVC   LP_AUIR1,AROUT1     SET A(INDEX ROUTINES 1)                      
         MVC   LP_AUIR2,AROUT2     SET A(INDEX ROUTINES 2)                      
                                                                                
RUNSTR08 MVC   LP_BLKS+((B#LLSREC-1)*L'LP_BLKS)(L'LP_BLKS),AIO2                 
         MVC   LP_BLKS+((B#SAPREC-1)*L'LP_BLKS)(L'LP_BLKS),AIO4                 
         MVC   LP_BLKS+((B#PERREC-1)*L'LP_BLKS)(L'LP_BLKS),AIO5                 
         MVC   LP_BLKS+((B#EDTREC-1)*L'LP_BLKS)(L'LP_BLKS),AIO3                 
         LA    R0,BKLINMGR                                                      
         ST    R0,LP_BLKS+((B#LINMGR-1)*L'LP_BLKS)                              
         MVC   LP_BLKS+((B#COBLCK-1)*L'LP_BLKS)(L'LP_BLKS),ACOBLOCK             
         MVC   LP_BLKS+((B#PID-1)*L'LP_BLKS)(L'LP_BLKS),AIO3                    
         MVC   LP_BLKS+((B#TWAD-1)*L'LP_BLKS)(L'LP_BLKS),LP_ATWA                
         MVC   LP_BLKS+((B#SVRDEF-1)*L'LP_BLKS)(L'LP_BLKS),LP_ASVR              
         MVC   LP_BLKS+((B#LP_D-1)*L'LP_BLKS)(L'LP_BLKS),ALP                    
                                                                                
         MVC   WVALUES(WVALUEL),LVALUES                                         
                                                                                
         LA    R1,ADCONS           RELOCATE ADDRESS CONSTANTS                   
         LHI   R0,ADCONSN                                                       
         BASR  RE,0                                                             
         L     R2,0(R1)                                                         
         A     R2,SRVRRELO                                                      
         ST    R2,0(R1)                                                         
         AHI   R1,L'ADCONS                                                      
         BCTR  R0,RE                                                            
                                                                                
         LAY   R2,EDTTAB           LOAD EDTTAB                                  
         ST    R2,AEDTTAB                                                       
                                                                                
RUNSTR10 GOTOR VDATCON,DMCB,(5,0),(2,D_TODAYC)                                  
         GOTOR (RF),(R1),,(1,D_TODAYP)                                          
         GOTOR (RF),(R1),,(0,D_TODAYF)                                          
         GOTOR (RF),(R1),,(3,D_TODAYB)                                          
         GOTOR VDATCON,DMCB,(1,D_TODAYP),(0,WORK)                               
         GOTOR VADDAY,DMCB,(C'Y',WORK),WORK+6,F'-5'                             
         GOTOR VDATCON,DMCB,(0,WORK+6),(1,D_TDM10)                              
                                                                                
RUNSTR12 J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* First for new work                                                  *         
***********************************************************************         
                                                                                
PRCWRK   CLI   RUNMODE,RPRCWRKQ    TEST 'PROCESS WORK' MODE                     
         BNE   RUNREQ                                                           
         LA    R0,SAVEVAR                                                       
         LHI   R1,SAVEVARL                                                      
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
         XC    RUNI,RUNI                                                        
         TM    LP_FLAG,LP_FOFFL    TEST OFFLINE                                 
         BZ    PRCWRK02                                                         
                                                                                
         LA    R0,WORKD            CLEAR I/O AREAS                              
         AHI   R0,IOAREA1-WORKD                                                 
         LHI   R1,IOAREASL                                                      
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
                                                                                
PRCWRK02 J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Run a download request                                              *         
***********************************************************************         
                                                                                
RUNREQ   CLI   RUNMODE,RRUNREQQ    TEST 'RUN REQUEST' MODE                      
         JNE   EXITY                                                            
                                                                                
*&&US*&& GOTO1 VDICTATE,DMCB,C'LL  ',DCDICTL,DSDICTL                            
         L     RE,LP_AWMP          BUILD DEFAULT RANGE ELEMENTS IN WMP          
         USING LW_D,RE                                                          
         MVI   LW_TYPE,LW_TALLQ    ALL VALUES                                   
         STCM  RE,7,AALL                                                        
         AHI   RE,LW_LN1Q                                                       
         MVI   LW_TYPE,LW_TNZRQ    NON-ZERO VALUES                              
         STCM  RE,7,ANZR                                                        
         AHI   RE,LW_LN1Q                                                       
         ST    RE,LP_AWMP                                                       
         ST    RE,SV_AWMP                                                       
         DROP  RE                                                               
                                                                                
         XC    MAPI,MAPI           INITIALIZE MAP INDICATORS                    
         LA    RF,MAPTAB                                                        
         LHI   R0,MAPTABN                                                       
         BASR  RE,0                                                             
         CLC   LP_QMAPN,0(RF)                                                   
         JNE   RUNREQ02                                                         
         MVC   MAPI,L'LP_QMAPN(RF)                                              
         J     RUNREQ04                                                         
                                                                                
RUNREQ02 AHI   RF,L'MAPTAB                                                      
         BCTR  R0,RE                                                            
                                                                                
RUNREQ04 TM    LP_FLAG,LP_FOFFL    TEST OFFLINE                                 
         BZ    RUNREQ06                                                         
                                                                                
         L     RF,AMASTC           SET TRACE OPTION                             
         MVC   IOTRACE,MCTRACE-MASTD(RF)                                        
                                                                                
         GOTOR VDATAMGR,DMCB,DMKEY,ACCDIR,(4,0),0                               
         GOTOR VDATAMGR,DMCB,DMKEY,ACCMST,(4,0),0                               
         GOTOR VDATAMGR,DMCB,DMKEY,ACCARC,(4,0),0                               
         GOTOR VDATAMGR,DMCB,DMKEY,CTFILE,(4,0),0                               
                                                                                
RUNREQ06 GOTOR (#CPYINI,ACPYINI)   INITIALISE COMPANY VALUES                    
         GOTOR INIBUF                                                           
                                                                                
         MVC   QAGENCY,CUXCPY                                                   
         MVC   AGYALF,CUAALF                                                    
         MVC   USROFF,SPACES                                                    
         CLI   CUACCS,0                                                         
         JE    RUNREQX                                                          
         TM    CPYSTATC,CPYSROFF OFFICES FOR RESOURCES                          
         JZ    RUNREQX                                                          
         MVC   USROFF,CUACCS+2                                                  
         USING OFFALD,R1                                                        
RUNREQ08 L     R1,AOFFAREA                                                      
         TM    CPYSTAT4,CPYSOFF2                                                
         JNZ   RUNREQX                                                          
         MVC   USROFF,OFFAWORK                                                  
         MVI   USROFF+1,C' '                                                    
RUNREQX  GOTOR LP_APUTO,LP_D       CALL DDLINK OUTPUT PROCESSOR                 
         J     EXITY               EXIT BACK TO DDLINK                          
         DROP  RB                                                               
         EJECT                                                                  
***********************************************************************         
* Narrative/standard comments list/display download                   *         
***********************************************************************         
                                                                                
REQNAR   LKREQ H,A#NARR,OUTNAR,NEXTREQ=REQPERS                                  
                                                                                
Code     LKREQ F,1,(D,B#SAVED,QNARCOD),CHAR,OLEN=L'QNARCOD,            +        
               MAXLEN=L'QNARCOD,TEXT=(*,NCODLIT),COL=*                          
                                                                                
Lang     LKREQ F,2,(D,B#SAVED,QNARLAN),CHAR,OLEN=L'QNARLAN,            +        
               MAXLEN=L'QNARLAN,TEXT=(*,NLANLIT),COL=*                          
                                                                                
Filt     LKREQ F,3,(D,B#SAVED,QNARFLT),CHAR,OLEN=L'QNARFLT,            +        
               MAXLEN=L'QNARFLT,TEXT=(*,NFLTLIT),COL=*                          
                                                                                
Appl     LKREQ F,4,(D,B#SAVED,QNARAPP),CHAR,OLEN=L'QNARAPP,            +        
               MAXLEN=L'QNARAPP,TEXT=(*,NAPPLIT),COL=*                          
                                                                                
OffC     LKREQ F,5,(D,B#SAVED,QNAROFF),CHAR,OLEN=L'QNAROFF,            +        
               MAXLEN=L'QNAROFF,TEXT=(*,NOFFLIT),COL=*                          
                                                                                
CliC     LKREQ F,6,(D,B#SAVED,QNARCLI),CHAR,OLEN=L'QNARCLI,            +        
               MAXLEN=L'QNARCLI,TEXT=(*,NCLILIT),COL=*                          
                                                                                
ProC     LKREQ F,7,(D,B#SAVED,QNARPRO),CHAR,OLEN=L'QNARPRO,            +        
               MAXLEN=L'QNARPRO,TEXT=(*,NPROLIT),COL=*                          
                                                                                
WrkC     LKREQ F,8,(D,B#SAVED,QNARWRK),CHAR,OLEN=L'QNARWRK,            +        
               MAXLEN=L'QNARWRK,TEXT=(*,NWRKLIT),COL=*                          
                                                                                
         LKREQ E                                                                
                                                                                
OUTNAR   LKOUT H                                                                
                                                                                
NARNAR   LKOUT R,A#NARR            Narrative record                             
Array    LKOUT C,A#NARR,(A,ARYNAR)                                              
ValRq    LKOUT P,,VALREQ                                                        
         LKOUT E                                                                
                                                                                
         LKOUT X                                                                
                                                                                
ARYNAR   LKOUT A,(R,NXTSCM),MULTIROW=Y,ROWNAME=SCMRECD                          
                                                                                
SCCode   LKOUT C,1,SCMKCODE,CHAR                                                
SCSetV   LKOUT P,,SETSCM                                                        
SCDesc   LKOUT C,2,(D,B#SAVED,DNARRDS),CHAR,ND=Y                                
SCFilt   LKOUT C,3,(D,B#SAVED,DNARRFI),CHAR,ND=Y                                
SCGrup   LKOUT C,4,(D,B#SAVED,DNARRGR),CHAR,ND=Y                                
SCOffC   LKOUT C,6,(D,B#SAVED,DNARROF),CHAR,ND=Y                                
SCCliC   LKOUT C,7,(D,B#SAVED,DNARRCL),CHAR,ND=Y                                
SCAppl   LKOUT C,8,(D,B#SAVED,DNARRAP),CHAR,ND=Y                                
SCProC   LKOUT C,9,(D,B#SAVED,DNARRPR),CHAR,ND=Y                                
SCWrkC   LKOUT C,10,(D,B#SAVED,DNARRWC),CHAR,ND=Y                               
Array    LKOUT C,A#NARR,(A,ARYTXTB),FILTROUT=TSTTXTB                            
Array    LKOUT C,A#NARR,(A,ARYTXTA),FILTROUT=TSTTXTA                            
                                                                                
         LKOUT E                                                                
                                                                                
ARYTXTB  LKOUT A,(D,B#SCMREC,SCMRFST),EOT=EOR,NEWEL=B,                 +        
               ROWID=(SCMEL,SCMELQ),ROWWIDTH=(V,SCMLN)                          
ITTXT    LKOUT C,5,SCMNARR,CHAR,LEN=V                                           
                                                                                
         LKOUT E                                                                
                                                                                
ARYTXTA  LKOUT A,(D,B#SCMREC,SCMRFST),EOT=EOR,NEWEL=N,                 +        
               ROWID=(SCMEL,SCMELQ),ROWWIDTH=(V,SCMLN)                          
ITTXT    LKOUT C,5,SCMNARR,CHAR,LEN=V                                           
                                                                                
         LKOUT E                                                                
                                                                                
***********************************************************************         
* SCM record routines                                                 *         
***********************************************************************         
                                                                                
NXTSCM   CLI   LP_RMODE,LP_RFRST   First time?                                  
         JNE   NXTSCM4                                                          
                                                                                
         MVI   REQI,0                                                           
         OC    QNARCOD(QNARLEN),SPACES                                          
                                                                                
         CLC   QNARSTA,SPACES      Specific code defined?                       
         JH    NXTSCM2                                                          
         MVC   QNARSTA,SPACES                                                   
         MVC   QNAREND,LSTNAR      Read for all                                 
         J     NXTSCM4                                                          
                                                                                
NXTSCM2  MVC   QNAREND,QNARSTA     Read for specific only                       
                                                                                
NXTSCM4  GOTOR (#NXTREC,ANXTREC),DMCB,SCMKEYT,('B#SCMREC',0),          +        
               (0,SAVED),ASCMKF,ASCMRF                                          
         J     EXITY                                                            
                                                                                
         USING SCMRECD,R2                                                       
         USING COIELD,R3                                                        
SETSCM   L     R2,AIO2                                                          
         XC    DNARR(DNARRLQ),DNARR                                             
         OI    REQI,REQIPRO                                                     
                                                                                
         XR    R0,R0                                                            
         LA    R3,SCMRFST                                                       
         XC    ELEMENT,ELEMENT                                                  
                                                                                
SETSCM02 CLI   COIEL,0                                                          
         JE    SETSCM06                                                         
         CLI   COIEL,COIELQ                                                     
         JE    SETSCM04                                                         
         IC    R0,COILN                                                         
         AR    R3,R0                                                            
         J     SETSCM02                                                         
                                                                                
SETSCM04 XR    R1,R1                                                            
         IC    R1,COILN                                                         
         SHI   R1,1                                                             
         BASR  RE,0                                                             
         EX    R1,4(RE)                                                         
         MVC   ELEMENT(0),COIEL                                                 
                                                                                
SETSCM06 LA    R3,ELEMENT                                                       
                                                                                
         MVC   DNARRDS,COIDESC                                                  
         MVC   DNARRGR,COIGRP                                                   
         MVC   DNARRFI,COIFILT                                                  
                                                                                
         TM    SCMRSTAT,SCMKSCLP                                                
         JZ    SETSCM10                                                         
         MVC   DNARROF,COIOFFC                                                  
         MVC   DNARRCL,SCMRSCLI                                                 
         CLI   COILN,COILNXQ                                                    
         JL    SETSCM12                                                         
         MVC   DNARRPR,COIPROC                                                  
         J     SETSCM12                                                         
                                                                                
SETSCM10 MVC   DNARROF,SCMRSOFF                                                 
                                                                                
SETSCM12 DS    0H                                                               
*&&UK*&& MVC   DNARRAP,NONOS                                                    
*&&US*&& MVC   DNARRAP,YEYES       US doesn't have flist/afm narrative          
*                                  so no application specific filters           
SETSCM14 TM    SCMRSAPP,SCMKSRRQ                                                
         JZ    SETSCM16                                                         
         MVI   DNARRAP+0,YESQ                                                   
                                                                                
SETSCM16 TM    SCMRSAPP,SCMKSFBQ                                                
         JZ    SETSCM18                                                         
         MVI   DNARRAP+1,YESQ                                                   
                                                                                
SETSCM18 TM    SCMRSAPP,SCMKSESQ                                                
         JZ    SETSCM20                                                         
         MVI   DNARRAP+2,YESQ                                                   
                                                                                
SETSCM20 TM    SCMRSAPP,SCMKSORQ                                                
         JZ    SETSCM22                                                         
         MVI   DNARRAP+3,YESQ                                                   
                                                                                
SETSCM22 TM    SCMRSAPP,SCMKSTIQ                                                
         JZ    SETSCM24             bypass SETSCM24 for now                     
         MVI   DNARRAP+4,YESQ                                                   
                                                                                
SETSCM24 TM    SCMRSAPP,SCMKSEXQ                                                
         JZ    SETSCM26                                                         
         MVI   DNARRAP+5,YESQ                                                   
                                                                                
SETSCM26 CLI   COILN,COILNXQ                                                    
         JL    SETSCM28                                                         
         MVC   DNARRWC,COIWORK                                                  
                                                                                
SETSCM28 DS    0H                                                               
         J     EXITY                                                            
         DROP  R2,R3                                                            
                                                                                
TSTTXTB  SR    RF,RF                                                            
         ICM   RF,3,CUXPNUM                                                     
         CHI   RF,XPRODIKQ                                                      
         JE    SETCCC                                                           
         CLC   QNARSTA,SPACES                                                   
         JH    EXITY                                                            
         J     EXITN                                                            
                                                                                
TSTTXTA  SR    RF,RF                                                            
         ICM   RF,3,CUXPNUM                                                     
         CHI   RF,XPRODIKQ                                                      
         BR    RE                                                               
                                                                                
VALREQ   CLC   QNARSTA,SPACES                                                   
         JNH   EXITY                                                            
         TM    REQI,REQIPRO                                                     
         JNZ   EXITY                                                            
         LHI   R0,AE$IVPER                                                      
         J     XERROR                                                           
                                                                                
         EJECT                                                                  
***********************************************************************         
* Person download - Make sure arrays are at the end of Person search  *         
***********************************************************************         
                                                                                
REQPERS  LKREQ H,A#CSPS,OUTPER,NEXTREQ=REQCAMP                                  
                                                                                
Strng    LKREQ F,01,(D,B#SAVED,QPERSTR),CHAR,OLEN=L'QPERSTR,           +        
               MAXLEN=L'QPERSTR,TEXT=AC#NAME,COL=*                              
PID      LKREQ F,02,(D,B#SAVED,QPID),CHAR,OLEN=L'QPID,                 +        
               MAXLEN=L'QPID,TEXT=AC#RSPID,COL=*                                
PIN      LKREQ F,03,(D,B#SAVED,QPIN),HEXD,OLEN=L'QPIN,                 +        
               MAXLEN=L'QPIN,TEXT=(*,PINPLIT),COL=*                             
PerCde   LKREQ F,04,(D,B#SAVED,QPER),CHAR,OLEN=L'QPER,                 +        
               MAXLEN=L'QPER,TEXT=(*,PERCLIT),COL=*                             
NmCde    LKREQ F,05,(D,B#SAVED,QNAM),CHAR,OLEN=L'QNAM,                 +        
               MAXLEN=L'QNAM,TEXT=(*,NAMCLIT),COL=*                             
SuRep    LKREQ F,06,(D,B#SAVED,QSPREP),CHAR,OLEN=L'QSPREP,             +        
               MAXLEN=L'QSPREP,TEXT=(*,SREPLIT),COL=*                           
SuLoc    LKREQ F,07,(D,B#SAVED,QSPLOC),CHAR,OLEN=L'QSPLOC,             +        
               MAXLEN=L'QSPLOC,TEXT=(*,SLOCLIT),COL=*                           
SuTeam   LKREQ F,08,(D,B#SAVED,QSPTEA),CHAR,OLEN=L'QSPTEA,             +        
               MAXLEN=L'QSPTEA,TEXT=(*,STEALIT),COL=*                           
SuRole   LKREQ F,09,(D,B#SAVED,QSPROL),CHAR,OLEN=L'QSPROL,             +        
               MAXLEN=L'QSPROL,TEXT=(*,SROLLIT),COL=*                           
Termd    LKREQ F,10,(D,B#SAVED,QTERMD),CHAR,OLEN=L'QTERMD,             +        
               MAXLEN=L'QTERMD,TEXT=AC#TRM,COL=*                                
                                                                                
         LKREQ E                                                                
                                                                                
OUTPER   LKOUT H                                                                
                                                                                
PERSRC   LKOUT R,R#CSPS                                                         
Array    LKOUT C,2,(A,ARYPER)                                                   
         LKOUT E                                                                
                                                                                
         LKOUT X                                                                
                                                                                
ARYPER   LKOUT A,(R,NXTPER),MULTIROW=Y,ROWNAME=SAPEREC                          
                                                                                
PidChar  LKOUT C,1,SAPEPID,CHAR,LEN=L'SAPALPID,ND=Y                             
FirstNam LKOUT C,2,(D,B#WORKD,TEMP2),CHAR,LEN=15,ND=Y                           
LastNam  LKOUT C,3,(D,B#WORKD,TEMP2+30),CHAR,LEN=50,ND=Y                        
MidNam   LKOUT C,4,(D,B#WORKD,TEMP2+15),CHAR,LEN=15,ND=Y                        
PidBin   LKOUT C,5,(D,B#SAVED,DPPID),HEXD,LEN=L'SA0KNUM,ND=Y                    
                                                                                
Array    LKOUT C,10,(A,ARYSADR),FILTROUT=TSTNAMO                                
Array    LKOUT C,18,(A,ARYSPER),FILTROUT=TSTNAMO                                
Array    LKOUT C,30,(A,ARYSPEE),FILTROUT=TSTNAMO                                
Array    LKOUT C,43,(A,ARYSGRP),FILTROUT=TSTNAMO                                
Array    LKOUT C,45,(A,ARYSPAE),FILTROUT=TSTNAMO                                
Array    LKOUT C,31,(A,ARYPLOC),FILTROUT=TSTNAMO                                
Array    LKOUT C,117,(A,ARYFMYRP),FILTROUT=TSTMREP                              
Array    LKOUT C,117,(A,ARYMYREP),FILTROUT=TSTMREP                              
                                                                                
Array    LKOUT C,6,(A,ARYFTEA),FILTROUT=TSTTEAM                                 
Array    LKOUT C,6,(A,ARYFROL),FILTROUT=TSTROLE                                 
Array    LKOUT C,6,(A,ARYTEAN),FILTROUT=TSTTEAM                                 
Array    LKOUT C,8,(A,ARYROLN),FILTROUT=TSTROLE                                 
                                                                                
         LKOUT E                                                                
                                                                                
ARYSADR  LKOUT A,(D,B#SAPREC,SAPEDATA),EOT=EOR,                        +        
               ROWID=(SAADREL,SAADRELQ),ROWWIDTH=(V,SAADRLN)                    
                                                                                
PRout    LKOUT P,SAADRTYP,SETTYPE                                               
*&&US                                                                           
Teleph   LKOUT C,10,SAADRDAT,CHAR,FILTROUT=TSTSPHOQ,LEN=V                       
*&&                                                                             
Fax      LKOUT C,11,SAADRDAT,CHAR,FILTROUT=TSTSFAXQ,LEN=V                       
*&&US                                                                           
Addr1    LKOUT C,12,SAADRDAT,CHAR,FILTROUT=TSTSAD1Q,LEN=V                       
Addr2    LKOUT C,13,SAADRDAT,CHAR,FILTROUT=TSTSAD2Q,LEN=V                       
Addr3    LKOUT C,14,SAADRDAT,CHAR,FILTROUT=TSTSAD3Q,LEN=V                       
City     LKOUT C,15,SAADRDAT,CHAR,FILTROUT=TSTSCITQ,LEN=V                       
Postcode LKOUT C,16,SAADRDAT,CHAR,FILTROUT=TSTSCODQ,LEN=V                       
Country  LKOUT C,17,SAADRDAT,CHAR,FILTROUT=TSTSCTRQ,LEN=V                       
State    LKOUT C,44,SAADRDAT,CHAR,FILTROUT=TSTSTATQ,LEN=V                       
*&&                                                                             
         LKOUT E                                                                
                                                                                
ARYSPER  LKOUT A,(D,B#SAPREC,SAPEDATA),EOT=EOR,                        +        
               ROWID=(SAPEREL,SAPERELQ),ROWWIDTH=(V,SAPERLN)                    
                                                                                
Off      LKOUT C,18,SAPEROFF,CHAR,ND=Y                                          
Dept     LKOUT C,19,SAPERDID,CHAR,ND=Y                                          
Ext      LKOUT C,20,SAPEREXT,CHAR,ND=Y                                          
StfCod   LKOUT C,21,SAPERSTA,CHAR,ND=Y                                          
ProId    LKOUT C,22,SAPERPRO,CHAR,ND=Y                                          
*&&US                                                                           
Insur    LKOUT C,23,SAPERINC,CHAR,ND=Y                                          
*&&                                                                             
Marital  LKOUT C,24,SAPERMAR,CHAR,ND=Y                                          
Sex      LKOUT C,25,SAPERSEX,CHAR,ND=Y                                          
Hire     LKOUT C,26,SAPERDHI,CDAT,ND=Y                                          
Term     LKOUT C,27,SAPERDTE,CDAT,ND=Y                                          
DOB      LKOUT C,28,SAPERDOB,CDAT,ND=Y                                          
Title    LKOUT C,29,SAPERTIT,CHAR,LEN=V                                         
                                                                                
         LKOUT E                                                                
                                                                                
ARYSPEE  LKOUT A,(D,B#SAPREC,SAPEDATA),EOT=EOR,                        +        
               ROWID=(SAPEEEL,SAPEEELQ),ROWWIDTH=(V,SAPEELN)                    
                                                                                
Email    LKOUT C,30,SAPEEID,CHAR,LEN=V,ND=Y                                     
                                                                                
         LKOUT E                                                                
                                                                                
ARYSGRP  LKOUT A,(D,B#SAPREC,SAPEDATA),EOT=EOR,                        +        
               ROWID=(SAAGCEL,SAAGCELQ),ROWWIDTH=(V,SAAGCLN)                    
                                                                                
Secgrp   LKOUT C,43,SAAGCCOD,CHAR,ND=Y                                          
                                                                                
         LKOUT E                                                                
                                                                                
ARYSPAE  LKOUT A,(D,B#SAPREC,SAPEDATA),EOT=EOR,                        +        
               ROWID=(SAAEPEL,SAAEPELQ),ROWWIDTH=(V,SAAEPLN)                    
                                                                                
AcPerEq  LKOUT C,45,SAAEPAEP,CHAR,ND=Y                                          
                                                                                
         LKOUT E                                                                
                                                                                
                                                                                
TSTNAMO  CLI   QNAM,YESQ           Test if name and code only                   
         J     SETCCC                                                           
TSTLOCA  CLI   QSPLOC,YESQ         Test suppress my locations                   
         J     SETCCC                                                           
TSTTEAM  CLI   QNAM,YESQ           Test if name and code only                   
         JE    SETCCC                                                           
         CLI   QSPTEA,YESQ         Test suppress my team                        
         J     SETCCC                                                           
TSTROLE  CLI   QNAM,YESQ           Test if name and code only                   
         JE    SETCCC                                                           
         CLI   QSPROL,YESQ         Test suppress my roles                       
         J     SETCCC                                                           
TSTMREP  XR    RF,RF                                                            
         ICM   RF,3,CUXPNUM        Don't make name upper case for Aura          
         CHI   RF,XPRODIKQ                                                      
         BNER  RE                                                               
         CLI   QNAM,YESQ           Test if name and code only                   
         JE    SETCCC                                                           
         CLI   QSPREP,NOQ          Test suppress my reports                     
         BR    RE                                                               
*                                                                               
TSTSPHOQ CLI   WORK,SAADPHOQ       Test if telephone code                       
         BR    RE                                                               
TSTSFAXQ CLI   WORK,SAADFAXQ       Test if fax code                             
         BR    RE                                                               
TSTSCITQ CLI   WORK,SAADCITQ       Test if city                                 
         BR    RE                                                               
TSTSCTRQ CLI   WORK,SAADCTRQ       Test if country                              
         BR    RE                                                               
TSTSCODQ CLI   WORK,SAADCODQ       Test if post code                            
*&&US*&& BER   RE                                                               
*&&US*&& CLI   WORK,SAADZIPQ       or zip                                       
         BR    RE                                                               
TSTSAD1Q CLI   WORK,X'01'          Test if address line 1                       
         BR    RE                                                               
TSTSAD2Q CLI   WORK,X'02'          Test if address line 2                       
         BR    RE                                                               
TSTSAD3Q CLI   WORK,X'03'          Test if address line 3                       
         BR    RE                                                               
TSTSTATQ CLI   WORK,SAADSTEQ       Test if state                                
         BR    RE                                                               
TSTSTPC  OC    QPERKCD,QPERKCD     Test if person code present                  
         J     SETCCC                                                           
TSTSEXP  CLI   WORK,GDASEXPD       Test if scheme expiry date type              
         BR    RE                                                               
TSTLLO   CLI   BYTE1,YESQ          Test if location should be skipped           
         BR    RE                                                               
***********************************************************************         
* Get person records                                                  *         
***********************************************************************         
                                                                                
NXTPER   CLI   LP_RMODE,LP_RFRST   First time?                                  
         JNE   NXTPER18                                                         
                                                                                
*        XC    DUB,DUB             Clear out DUB (used for last PID)            
         XC    TEMPID,TEMPID       Clear out TEMPID (used for last PID)         
                                                                                
         LA    RE,QPERSTR+L'QPERSTR-1                                           
         LA    RF,L'QPERSTR                                                     
                                                                                
NXTPER04 CLI   0(RE),C' '                                                       
         JH    NXTPER06                                                         
         SHI   RE,1                                                             
         JCT   RF,NXTPER04                                                      
                                                                                
NXTPER06 STC   RF,DPERLEN          set length of search string                  
         OC    QALPHA,CUSALF                                                    
         JNZ   NXTPER08                                                         
         MVC   QALPHA,CUAALF                                                    
         J     NXTPER08                                                         
                                                                                
NXTPER08 OC    QPIN,QPIN                                                        
         JZ    NXTPER10                                                         
         MVC   TEMP2,QPIN                                                       
         J     NXTPER16                                                         
                                                                                
NXTPER10 OC    QPER,QPER                                                        
         JZ    NXTPER22                                                         
         MVC   DPERSON,QPER                                                     
         GOTOR PRSDTL,DMCB,(X'00',D_TODAYP)  (Uses AIO1)                        
         JNE   QERROR                                                           
         L     R2,AIO1                                                          
         LA    R2,PERRFST-PERRECD(R2)                                           
         USING PIDELD,R2                                                        
NXTPER12 CLI   PIDEL,0             End of record                                
         JNE   *+14                                                             
         MVC   LP_ERROR,=AL2(AE$IVPER)                                          
         J     QERROR              Yes - exit                                   
         CLI   PIDEL,PIDELQ                                                     
         JE    NXTPER14                                                         
         LLC   RE,PIDLN                                                         
         AR    R2,RE                                                            
         J     NXTPER12                                                         
                                                                                
NXTPER14 MVC   TEMP2,PIDNO                                                      
         DROP  R2                                                               
NXTPER16 GOTOR (#GETPID,AGETPID)                                                
         JE    *+14                                                             
         MVC   LP_ERROR,=AL2(AE$IVPER)                                          
         J     QERROR                                                           
         MVC   QPID,TEMP2                                                       
         J     NXTPER22                                                         
                                                                                
NXTPER18 MVC   IOKEY,SVPERKEY                                                   
         OC    QPID,QPID                                                        
         JZ    NXTPER24                                                         
NXTPER20 MVI   LP_RMODE,LP_RLAST                                                
         J     EXITY                                                            
                                                                                
NXTPER22 OC    QPID,QPID                                                        
         JZ    NXTPER24                                                         
         OC    QPID,SPACES                                                      
         GOTOR (#NXTREC,ANXTREC),DMCB,PERKEYT2,('B#SAPREC',0),         +        
               ('$NXTRCTF',SAVED),0,0                                           
         JNE   EXITY                                                            
         USING SAPEREC,R2                                                       
         L     R2,IOADDR                                                        
         CLC   SAPEPID-SAPEKEY(L'SAPEPID,R2),QPID                               
         JE    NXTPER26                                                         
         MVC   LP_ERROR,=AL2(AE$INVPD)                                          
         J     QERROR                                                           
                                                                                
NXTPER24 GOTOR (#NXTREC,ANXTREC),DMCB,PERKEYT,('B#SAPREC',0),          +        
               ('$NXTRCTF',SAVED),0,0                                           
         JNE   EXITY                                                            
NXTPER26 L     R2,IOADDR                                                        
         MVC   IOKEY,0(R2)                                                      
         CLC   SAPEAGY,QALPHA                                                   
         JNE   NXTPER20                                                         
         MVC   SVPERKEY,IOKEY                                                   
         CLC   SAPEPID,SPACES                                                   
         JNH   NXTPER18                                                         
                                                                                
         MVC   HALF1,FFS                                                        
         XC    HALF1,SAPEDEF                                                    
*        XR    RF,RF                                                            
*        ICM   RF,3,SAPEDEF        1's complement date                          
*        LNR   RF,RF                                                            
*        CLM   RF,3,D_TODAYC       Ignore effective date after today            
         CLC   HALF1,D_TODAYC      Ignore effective date after today            
         JH    NXTPER22                                                         
         CLC   TEMPID,SAPEPID      ignore duplicates                            
         JE    NXTPER18                                                         
                                                                                
         MVC   TEMPID,SAPEPID                                                   
                                                                                
         MVC   TEMP2,SPACES                                                     
                                                                                
         LA    R3,SAPEDATA                                                      
         USING SANAMD,R3                                                        
         XR    R0,R0                                                            
                                                                                
NXTPER28 CLI   SANAMEL,SANAMELQ                                                 
         JE    NXTPER32                                                         
         CLI   SANAMEL,SAPWDELQ                                                 
         JE    NXTPER44                                                         
         CLI   SANAMEL,0                                                        
         JE    NXTPER46                                                         
                                                                                
NXTPER30 IC    R0,SANAMLN          L'element                                    
         AR    R3,R0                                                            
         J     NXTPER28                                                         
                                                                                
NXTPER32 LA    R1,SANAMELN         L'name                                       
         USING SANAMELN,R1                                                      
         TM    SANAMIND,SANAMIFN   test for first name                          
         JZ    NXTPER36                                                         
         XR    RF,RF                                                            
         IC    RF,SANAMELN                                                      
         CHI   RF,15               > max length                                 
         JNH   NXTPER34                                                         
         LA    RF,15                                                            
NXTPER34 SHI   RF,1                                                             
         BASR  RE,0                                                             
         EX    RF,4(RE)                                                         
         MVC   TEMP2(0),SANAME                                                  
         LA    R1,2(RF,R1)                                                      
                                                                                
NXTPER36 TM    SANAMIND,SANAMIMN   test for middle name present                 
         JZ    NXTPER40                                                         
         IC    RF,SANAMELN                                                      
         CHI   RF,15                                                            
         JNH   NXTPER38                                                         
         LA    RF,15                                                            
NXTPER38 SHI   RF,1                                                             
         BASR  RE,0                                                             
         EX    RF,4(RE)                                                         
         MVC   TEMP2+15(0),SANAME                                               
         LA    R1,2(RF,R1)                                                      
                                                                                
NXTPER40 TM    SANAMIND,SANAMILN   skip if no last name                         
         JZ    NXTPER30                                                         
         IC    RF,SANAMELN                                                      
         CHI   RF,50                                                            
         JNH   NXTPER42                                                         
         LA    RF,50                                                            
NXTPER42 SHI   RF,1                                                             
         BASR  RE,0                                                             
         EX    RF,4(RE)                                                         
         MVC   TEMP2+30(0),SANAME                                               
         J     NXTPER30                                                         
                                                                                
         USING SAPWDD,R3                                                        
NXTPER44 MVC   DPPID,SAPWDNUM      pass binary PID                              
         J     NXTPER30                                                         
                                                                                
NXTPER46 OC    QPID,QPID           Searching with PID?                          
         JNZ   NXTPER50            Then no need to check below                  
         CLC   TEMP2,SPACES        skip if no name                              
         JE    NXTPER18                                                         
         XR    RF,RF                                                            
         ICM   RF,3,CUXPNUM        Don't make name upper case for Aura          
         CHI   RF,XPRODIKQ                                                      
         JE    NXTPER50                                                         
         OC    TEMP2,SPACES                                                     
                                                                                
         XR    R1,R1                                                            
         ICM   R1,1,DPERLEN          exec length of search string               
         JZ    NXTPER50                                                         
         SHI   R1,1                                                             
         LA    RE,TEMP2                                                         
         LA    RF,L'TEMP2                                                       
                                                                                
NXTPER48 BASR  R3,0                                                             
         EX    R1,8(R3)                                                         
         JE    NXTPER50                                                         
         CLC   QPERSTR(0),0(RE)                                                 
         AHI   RE,1                                                             
         JCT   RF,NXTPER48                                                      
         J     NXTPER18            else skip record                             
                                                                                
NXTPER50 DS    0H                                                               
         J     EXITY                                                            
         DROP  R2,R3                                                            
                                                                                
ARYFTEA  LKOUT A,(R,NXTPTM),MULTIROW=Y,ROWNAME=PIDRECD                          
                                                                                
         LKOUT E                                                                
                                                                                
ARYTEAN  LKOUT A,(R,NXTTEAM),MULTIROW=Y,ROWNAME=TEARECD                         
                                                                                
Teamnum  LKOUT C,6,TEAKNUM,LBIN                                                 
Array    LKOUT C,7,(A,ARYTEAN1)                                                 
                                                                                
         LKOUT E                                                                
                                                                                
ARYTEAN1 LKOUT A,(D,B#TEAM,TEARFST),EOT=EOR,                           +        
               ROWID=(NAMEL,NAMELQ),ROWWIDTH=(V,NAMLN)                          
                                                                                
Teamname LKOUT C,7,NAMEREC,CHAR,LEN=V                                           
                                                                                
         LKOUT E                                                                
                                                                                
***********************************************************************         
* GET PID PASSIVES TO WORK OUT TEAMS THIS PERSON BELONGS TO           *         
***********************************************************************         
                                                                                
NXTPTM   CLI   LP_RMODE,LP_RFRST   First time?                                  
         JNE   NXTPTM04                                                         
         USING LW_D,R2                                                          
         XR    R2,R2               POINT TO LIST IN WMP                         
         ICM   R2,7,DATEAM                                                      
         JZ    NXTPTM04                                                         
         XR    R3,R3                                                            
         XC    LW_NUMN,LW_NUMN                                                  
         LA    R0,LW_DATA2         CLEAR ENTRIES                                
         LHI   R1,DTEAMAXQ*L'PIDKNUM                                            
         SR    RF,RF                                                            
         SR    RE,RE                                                            
         MVCL  R0,RE               CLEAR AREA                                   
                                                                                
NXTPTM04 GOTOR (#NXTREC,ANXTREC),DMCB,PTMKEYT,('B#PID',0),             +        
               ('$NXTRXGR',SAVED),0,0                                           
         JNE   EXITY                                                            
         LA    R2,IOKEY                                                         
         USING PIDRECD,R2                                                       
         GOTOR LP_AAWMP,DMCB,(L'PIDKNUM,PIDKNUM),DTEAMIND,DTEAMAXQ,    +        
               LP_D                                                             
         DROP  R2                                                               
         J     NXTPTM04                                                         
                                                                                
***********************************************************************         
* GET TEAM RECORDS                                                    *         
***********************************************************************         
                                                                                
NXTTEAM  CLI   LP_RMODE,LP_RFRST   TEST FIRST TIME                              
         JNE   NXTTEA08                                                         
                                                                                
NXTTEA04 OC    DATEAM,DATEAM       TEST TEAM LIST PROVIDED                      
         JZ    NOMORE                                                           
                                                                                
NXTTEA08 GOTOR (#NXTREC,ANXTREC),DMCB,TEAKEYT,('B#TEAM',SVPTMKEY),     +        
               (0,SAVED),0,0                                                    
         J     EXITY                                                            
                                                                                
         EJECT                                                                  
                                                                                
SVRDEF   CSECT ,                                                                
                                                                                
ARYFROL  LKOUT A,(R,NXTPRL),MULTIROW=Y,ROWNAME=PIDRECD                          
                                                                                
         LKOUT E                                                                
                                                                                
ARYROLN  LKOUT A,(R,NXTROL),MULTIROW=Y,ROWNAME=ROLRECD                          
                                                                                
Rolnum   LKOUT C,8,ROLKNUM,LBIN                                                 
Array    LKOUT C,9,(A,ARYROLN1)                                                 
                                                                                
         LKOUT E                                                                
                                                                                
ARYROLN1 LKOUT A,(D,B#ROLE,ROLRFST),EOT=EOR,                           +        
               ROWID=(NAMEL,NAMELQ),ROWWIDTH=(V,NAMLN)                          
                                                                                
Rolename LKOUT C,9,NAMEREC,CHAR,LEN=V                                           
                                                                                
         LKOUT E                                                                
                                                                                
ARYPLOC  LKOUT A,(R,NXTPRC),NROWS=1,ROWNAME=PERRECD                             
                                                                                
AcPerCde LKOUT C,31,(D,B#SAVED,QPERKCD),CHAR,FILTROUT=TSTSTPC,         +        
               LEN=L'PERKCODE,SKIPCOLS=2                                        
Array    LKOUT C,42,(A,ARYEMPL),FILTROUT=TSTLOCA                                
Array    LKOUT C,50,(A,ARYLOCR),FILTROUT=TSTLOCA                                
                                                                                
         LKOUT E                                                                
                                                                                
ARYLOCR  LKOUT A,(D,B#PERREC,PERRFST),EOT=EOR,NEWEL=B,                 +        
               ROWID=(LOCEL,LOCELQ),ROWWIDTH=(V,LOCLN)                          
Prout    LKOUT P,LOCEL,SETLOADT                                                 
OffC     LKOUT C,32,LOCOFF,CHAR,ND=Y,FILTROUT=TSTLLO,                  +        
               SKIPCOLS=LOCSKIPS                                                
LOCSKIP  EQU   *                                                                
Prout    LKOUT P,LOCOFF,LOCNMS                                                  
OffN     LKOUT C,33,(D,B#SAVED,ELEMEN2),CHAR,LEN=36,ND=Y                        
DeptC    LKOUT C,34,LOCDEPT,CHAR,ND=Y                                           
DeptN    LKOUT C,35,(D,B#SAVED,ELEMEN2+36),CHAR,LEN=36,ND=Y                     
SubDepC  LKOUT C,36,LOCSUB,CHAR,ND=Y                                            
SubDepN  LKOUT C,37,(D,B#SAVED,ELEMEN2+72),CHAR,LEN=36,ND=Y                     
StrtDte  LKOUT C,38,LOCSTART,PDAT,ND=Y                                          
EndDte   LKOUT C,39,LOCEND,PDAT,ND=Y                                            
SalDate  LKOUT C,40,LOCSALKD,PDAT,ND=Y                                          
LocStat  LKOUT C,41,LOCSTAT,LBIN                                                
Prout    LKOUT P,,NXTEDTHR                                                      
Array    LKOUT C,66,(A,ARYDELD)                                                 
Prout    LKOUT P,LOCOFF,GETMAPO                                                 
Array    LKOUT C,80,(A,ARYBMGR)                                                 
Prout    LKOUT P,LOCOFF,GETMAPT                                                 
Array    LKOUT C,81,(A,ARYBMGR)                                                 
Prout    LKOUT P,LOCOFF,GETMAPX                                                 
Array    LKOUT C,82,(A,ARYBMGR)                                                 
LOCSKIPS EQU   (*-LOCSKIP)/LX_COLSL                                             
         LKOUT E                                                                
                                                                                
ARYDELD  LKOUT A,(D,B#EDTREC,EDTRFST),EOT=EOR,NEWEL=B,                 +        
               ROWID=(DEDEL,DEDELQ),ROWWIDTH=(V,DEDLN)                          
                                                                                
Dayofwk  LKOUT C,42,DEDIND,CHAR,ND=Y,FILTROUT=TSTEXDT,                 +        
               SKIPCOLS=EDHRSKPS                                                
                                                                                
EDHRSKP  EQU   *                                                                
                                                                                
HrPrDay  LKOUT C,43,DEDHRS,(R,EDTHRS)                                           
                                                                                
EDHRSKPS EQU   (*-EDHRSKP)/LX_COLSL                                             
                                                                                
         LKOUT E                                                                
                                                                                
ARYBMGR  LKOUT A,(D,B#LINMGR,BKLINMGR),NROWS=BKLINMAX,                 +        
               ROWWIDTH=L'LINEPID,NEWEL=B,ROWNAME=LINEPID                       
                                                                                
Prout    LKOUT P,,NXTAPP                                                        
Prout    LKOUT P,LINEPID,SETNAME                                                
LMPid    LKOUT C,1,LINEPID,HEXD,ND=Y,FILTROUT=TSTFLTR,                 +        
               SKIPCOLS=LMGRSKPS                                                
                                                                                
LMGRSKP  EQU   *                                                                
                                                                                
LMPin    LKOUT C,2,(D,B#SAVED,CHARPID),CHAR,ND=Y                                
LMFst    LKOUT C,3,(D,B#WORKD,TEMP2),CHAR,LEN=16,ND=Y                           
LMMid    LKOUT C,4,(D,B#WORKD,TEMP2+32),CHAR,LEN=16,ND=Y                        
LMLas    LKOUT C,5,(D,B#WORKD,WORK2),CHAR,LEN=58,ND=Y                           
LMEml    LKOUT C,6,(D,B#WORKD,APPEMAIL),CHAR,ND=Y                               
                                                                                
LMGRSKPS EQU   (*-LMGRSKP)/LX_COLSL                                             
                                                                                
         LKOUT E                                                                
                                                                                
ARYEMPL  LKOUT A,(D,B#PERREC,PERRFST),EOT=EOR,                         +        
               ROWID=(EMPEL,EMPELQ),ROWWIDTH=(V,EMPLN)                          
                                                                                
Thrdp    LKOUT C,42,EMPSTAT,(R,EDTEST)                                          
                                                                                
         LKOUT E                                                                
                                                                                
ARYFMYRP LKOUT A,(R,NXTMYR),MULTIROW=Y,ROWNAME=SAVED                            
                                                                                
         LKOUT E                                                                
                                                                                
ARYMYREP LKOUT A,(R,NXTREP),MULTIROW=Y,ROWNAME=SAPEREC                          
                                                                                
PidChar  LKOUT C,75,SAPEPID,CHAR,LEN=L'SAPALPID,ND=Y                            
PidBin   LKOUT C,76,(D,B#SAVED,DPPID),HEXD,LEN=L'SA0KNUM,ND=Y                   
FirstNam LKOUT C,77,(D,B#WORKD,TEMP2),CHAR,LEN=15,ND=Y                          
MidNam   LKOUT C,78,(D,B#WORKD,TEMP2+15),CHAR,LEN=15,ND=Y                       
LastNam  LKOUT C,79,(D,B#WORKD,TEMP2+30),CHAR,LEN=50,ND=Y                       
Array    LKOUT C,80,(A,ARYSPEM)                                                 
Array    LKOUT C,81,(A,ARYSRER)                                                 
Array    LKOUT C,118,(A,ARYMYRR)                                                
Array    LKOUT C,118,(A,ARYREPR)                                                
                                                                                
         LKOUT E                                                                
                                                                                
ARYSPEM  LKOUT A,(D,B#SAPREC,SAPEDATA),EOT=EOR,                        +        
               ROWID=(SAPEEEL,SAPEEELQ),ROWWIDTH=(V,SAPEELN)                    
                                                                                
Email    LKOUT C,80,SAPEEID,CHAR,LEN=V,ND=Y                                     
                                                                                
         LKOUT E                                                                
                                                                                
ARYSRER  LKOUT A,(D,B#SAPREC,SAPEDATA),EOT=EOR,                        +        
               ROWID=(SAPEREL,SAPERELQ),ROWWIDTH=(V,SAPERLN)                    
                                                                                
Hire     LKOUT C,81,SAPERDHI,CDAT,ND=Y                                          
Term     LKOUT C,82,SAPERDTE,CDAT,ND=Y                                          
                                                                                
         LKOUT E                                                                
                                                                                
ARYMYRR  LKOUT A,(R,NXTMRR),MULTIROW=Y,ROWNAME=SAVED                            
                                                                                
         LKOUT E                                                                
                                                                                
ARYREPR  LKOUT A,(R,NXTRRP),MULTIROW=Y,ROWNAME=SAPEREC                          
                                                                                
PidChar  LKOUT C,1,SAPEPID,CHAR,LEN=L'SAPALPID,ND=Y                             
PidBin   LKOUT C,2,(D,B#SAVED,DPPID),HEXD,LEN=L'SA0KNUM,ND=Y                    
FirstNam LKOUT C,3,(D,B#WORKD,TEMP2),CHAR,LEN=15,ND=Y                           
MidNam   LKOUT C,4,(D,B#WORKD,TEMP2+15),CHAR,LEN=15,ND=Y                        
LastNam  LKOUT C,5,(D,B#WORKD,TEMP2+30),CHAR,LEN=50,ND=Y                        
Array    LKOUT C,6,(A,ARYRREM)                                                  
Array    LKOUT C,7,(A,ARYSRRER)                                                 
                                                                                
         LKOUT E                                                                
                                                                                
ARYRREM  LKOUT A,(D,B#SAPREC,SAPEDATA),EOT=EOR,                        +        
               ROWID=(SAPEEEL,SAPEEELQ),ROWWIDTH=(V,SAPEELN)                    
                                                                                
Email    LKOUT C,6,SAPEEID,CHAR,LEN=V,ND=Y                                      
                                                                                
         LKOUT E                                                                
                                                                                
ARYSRRER LKOUT A,(D,B#SAPREC,SAPEDATA),EOT=EOR,                        +        
               ROWID=(SAPEREL,SAPERELQ),ROWWIDTH=(V,SAPERLN)                    
                                                                                
Hire     LKOUT C,7,SAPERDHI,CDAT,ND=Y                                           
Term     LKOUT C,8,SAPERDTE,CDAT,ND=Y                                           
                                                                                
         LKOUT E                                                                
                                                                                
***********************************************************************         
* GET edit hours for person                                           *         
***********************************************************************         
                                                                                
NXTEDTHR NTR1  ,                                                                
*                                                                               
         USING EDTRECD,R3                                                       
         LA    R3,IOKEY                                                         
         MVC   EDTKEY,SPACES       YES READ FOR DAY HOURS                       
         MVI   EDTKTYP,EDTKTYPQ                                                 
         MVI   EDTKSUB,EDTKSUBQ                                                 
         MVC   EDTKCPY,CUXCPY                                                   
         LLC   R1,ONERL1L                                                       
         BCTR  R1,0                Decrementing length by 1 for EX              
         BASR  RE,0                                                             
         MVC   EDTKOFC(0),DOFFC                                                 
         EX    R1,0(RE)                                                         
         LLC   R1,ONERL2L                                                       
         LLC   R2,ONERL1L                                                       
         SR    R1,R2                                                            
         BCTR  R1,0                Decrementing length by 1 for EX              
         BASR  RE,0                                                             
         MVC   EDTKDPT(0),DDEPT                                                 
         EX    R1,0(RE)                                                         
         LLC   R1,ONERL3L                                                       
         LLC   R2,ONERL2L                                                       
         SR    R1,R2                                                            
         BCTR  R1,0                Decrementing length by 1 for EX              
         BASR  RE,0                                                             
         MVC   EDTKSBD(0),DSDPT                                                 
         EX    R1,0(RE)                                                         
         MVC   EDTKPER,QPERKCD                                                  
         MVC   EDTKYR,D_TODAYP                                                  
         MVI   EDTKSEQ,0                                                        
         MVI   EDTKKSTA,EDTKSDAY                                                
NXTEDH10 MVC   CSVKEY1,EDTKEY                                                   
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         CLC   EDTKEY,CSVKEY1                                                   
         JE    NXTEDH30                                                         
         MVC   EDTKEY,CSVKEY1                                                   
         L     R2,AEDTTAB                                                       
NXTEDH20 CLI   0(R2),XL#EOF        No Day edit hours                            
         JE    NXTEDHX                                                          
         LA    R4,EDTKEY                                                        
         XR    RF,RF                                                            
         ICM   RF,3,0(R2)                                                       
         AR    R4,RF                                                            
         LLC   R1,2(R2)                                                         
         BCTR  R1,0                Decrementing length by 1 for EX              
         BASR  RE,0                                                             
         CLC   0(0,R4),SPACES                                                   
         EX    R1,0(RE)                                                         
         JH    *+12                                                             
         LA    R2,3(R2)                                                         
         J     NXTEDH20                                                         
                                                                                
         BASR  RE,0                                                             
         MVC   0(0,R4),SPACES                                                   
         EX    R1,0(RE)                                                         
         J     NXTEDH10                                                         
                                                                                
NXTEDH30 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
                                                                                
NXTEDHX  J     EXITY                                                            
                                                                                
         DROP  R3                                                               
                                                                                
         EJECT                                                                  
* ******************************                                                
TSTEXDT  NTR1  LABEL=*                                                          
*                                                                               
         L     R2,LP_AINP                                                       
         CLI   1(R2),DEDLN1Q                                                    
         JH    EXITN                                                            
         J     EXITY                                                            
                                                                                
         EJECT                                                                  
                                                                                
***********************************************************************         
* GET PID PASSIVES TO find backup approvers                           *         
***********************************************************************         
                                                                                
NXTAPP   NTR1  LABEL=*                                                          
*                                                                               
         XC    LINEPID,LINEPID                                                  
         L     R2,ANXTPID              RESTORE CURRENT PID ADDRESS              
         MVC   LINEPID,0(R2)                                                    
         LA    R2,L'LINEPID(R2)        INCREMENTING WITH THE REC LENGTH         
         ST    R2,ANXTPID              SAVE CURRENT PID ADDRESS                 
         J     EXITY                                                            
                                                                                
         EJECT                                                                  
                                                                                
TSTFLTR  OC    LINEPID,LINEPID         Test if backup PID available             
         JZ    SETCCC                                                           
         OC    TERMDATE,TERMDATE       Do we have a termination date            
         BZR   RE                                                               
         CLC   D_TODAYC,TERMDATE                                                
         JNH   SETCCC                                                           
         BR    RE                                                               
                                                                                
         EJECT                                                                  
***********************************************************************         
* GET PID PASSIVES TO WORK OUT ROLES THIS PERSON BELONGS TO           *         
***********************************************************************         
                                                                                
NXTPRL   CLI   LP_RMODE,LP_RFRST   First time?                                  
         JNE   NXTPRL04                                                         
         USING LW_D,R2                                                          
         XR    R2,R2               POINT TO LIST IN WMP                         
         ICM   R2,7,DAROLE                                                      
         JZ    NXTPRL04                                                         
         XR    R3,R3                                                            
         XC    LW_NUMN,LW_NUMN                                                  
         LA    R0,LW_DATA2         CLEAR ENTRIES                                
         LHI   R1,DROLMAXQ*L'PIDKNUM                                            
         SR    RF,RF                                                            
         SR    RE,RE                                                            
         MVCL  R0,RE               CLEAR AREA                                   
NXTPRL04 GOTOR (#NXTREC,ANXTREC),DMCB,PRLKEYT,('B#PID',0),             +        
               ('$NXTRXGR',SAVED),0,0                                           
         JNE   EXITY                                                            
         LA    R2,IOKEY                                                         
         USING PIDRECD,R2                                                       
         GOTOR LP_AAWMP,DMCB,(L'PIDKNUM,PIDKNUM),DROLEIND,DROLMAXQ,    +        
               LP_D                                                             
         DROP  R2                                                               
         J     NXTPRL04                                                         
                                                                                
***********************************************************************         
* GET ROLE RECORDS                                                    *         
***********************************************************************         
                                                                                
NXTROL   CLI   LP_RMODE,LP_RFRST   TEST FIRST TIME                              
         JNE   NXTROL08                                                         
                                                                                
NXTROL06 OC    DAROLE,DAROLE       TEST ROLE LIST PROVIDED                      
         JZ    NOMORE                                                           
                                                                                
NXTROL08 GOTOR (#NXTREC,ANXTREC),DMCB,ROLKEYT,('B#ROLE',SVPRLKEY),     +        
               (0,SAVED),0,0                                                    
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Extract Person code                                                 *         
***********************************************************************         
                                                                                
         USING PIDRECD,R2                                                       
NXTPRC   XC    QPERKCD,QPERKCD                                                  
         MVC   LP_ADATA,AIO5                                                    
         L     R0,AIO5             Clear ioarea                                 
         LHI   R1,IOLENQ                                                        
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
         LA    R2,IOKEY                                                         
         XC    PIDKEY,PIDKEY                                                    
         MVI   PIDKTYP,PIDKTYPQ                                                 
         MVI   PIDKSUB,PIDKSUBQ                                                 
         MVC   PIDKCPY,CUXCPY                                                   
         MVC   PIDKPID,DPPID                                                    
         MVI   PIDKSTYP,PIDKPERQ                                                
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO1'                               
         JNE   NXTPRCNX                                                         
         CLC   PIDKEY(PIDKPER-PIDRECD),IOKEYSAV                                 
         JNE   NXTPRCNX                                                         
         MVC   QPERKCD,PIDKPER                                                  
                                                                                
         CLI   QSPLOC,YESQ         Test suppress my locations                   
         JE    EXITY               don't read person                            
                                                                                
         GOTOR (#NXTREC,ANXTREC),DMCB,PERCEYT,('B#PERREC',0),          +        
               (0,SAVED),0,0                                                    
*                                                                               
NXTPRCX  J     EXITY                                                            
NXTPRCNX J     EXITN                                                            
         DROP  R2                                                               
         EJECT                                                                  
***********************************************************************         
* GET MY REPORTS AS A LINE MANAGER                                    *         
***********************************************************************         
                                                                                
         USING LW_D,R2                                                          
NXTMYR   XR    R2,R2               POINT TO LIST IN WMP                         
         ICM   R2,7,DAPID                                                       
         JZ    NXTMYR00                                                         
         XR    R3,R3                                                            
         XC    LW_NUMN,LW_NUMN                                                  
         LA    R0,LW_DATA2         CLEAR ENTRIES                                
         LHI   R1,DPIDMAXQ*L'PIDKNUM                                            
         SR    RF,RF                                                            
         SR    RE,RE                                                            
         MVCL  R0,RE               CLEAR AREA                                   
                                                                                
NXTMYR00 GOTOR (#GOATSR,AGOATSR),DMCB,('TSAINI',ATSRERRS),0,GAPAREA2,  +        
               TSARABUF                                                         
         GOTOR (#GAPLST,AGAPLST),DMCB,('GAPTT1Q',TSARABUF),            +        
               ('GAPLAPPR',SPACES),('GAPLTDTE',GAPLPARM),              +        
               ('QTIMOFF',DPPID)                                                
         JE    NXTMYR02                                                         
         J     NXTMYRX                                                          
         MVC   LP_ERROR,FULL2      set error msgno from GAPLST                  
         J     QERROR                                                           
                                                                                
GAP      USING GAPTABD,GAPAREA                                                  
NXTMYR02 XC    GAPAREA,GAPAREA                                                  
         GOTOR (#GOATSR,AGOATSR),DMCB,('TSARDH',ATSRERRS),0,GAPAREA,   +        
               TSARABUF                                                         
         TM    ATSRERRS,TSEEOF                                                  
         JNZ   NXTMYRX             end of buffer                                
         J     NXTMYR06                                                         
*XTMYR04 GOTOR (#GOATSR,AGOATSR),DMCB,('TSARDH',ATSRERRS),0,GAPAREA,            
*              TSARABUF                                                         
NXTMYR04 GOTOR (#GOATSR,AGOATSR),DMCB,('TSANXT',ATSRERRS),0,GAPAREA,   +        
               TSARABUF                                                         
         TM    ATSRERRS,TSEEOF                                                  
         JNZ   NXTMYRX             end of buffer                                
NXTMYR06 TM    GAP.GAPTSTA,GAPTSMQ     look for main entry                      
         JZ    NXTMYR04                                                         
                                                                                
         USING OFFALD,R1                                                        
NXTMYR08 L     R1,AOFFAREA                                                      
         LA    RE,1                                                             
         TM    SCPYEL+(CPYSTAT4-CPYELD),CPYSOFF2                                
         JNZ   *+8                                                              
         LA    RE,0                                                             
         BASR  RF,0                                                             
         MVC   OFFAOFFC(0),GAP.GAPTACT                                          
         EX    RE,0(RF)                                                         
         MVI   OFFAACT,OFFAVAL                                                  
         GOTO1 VOFFAL              Validate office                              
         JNE   NXTMYR04                                                         
         DROP  R1                                                               
                                                                                
         USING ACTRECD,R2                                                       
NXTMYR10 LA    R2,IOKEY            build 1R account record key                  
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKULA(L'ACTKUNT+L'ACTKLDG),=C'1R'                              
         MVC   ACTKACT,GAP.GAPTACT                                              
         MVC   CSVKEY1,ACTKEY      save key    (NOTE CSVKEY1 NOW FREE)          
                                                                                
NXTMYR12 GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         JE    NXTMYR16                                                         
         DC    H'0'                no errors should occur                       
                                                                                
NXTMYR14 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
         JE    NXTMYR16                                                         
         DC    H'0'                no errors should occur                       
                                                                                
NXTMYR16 CLC   CSVKEY1(ACTKACT-ACTRECD),ACTKEY                                  
         JNE   NXTMYR04                                                         
                                                                                
         MVC   GAPAREA2,GAPAREA                                                 
         LLC   RE,GAP.GAPTLEN          for main entry save office               
         SHI   RE,1                                                             
         BASR  RF,0                                                             
         CLC   GAP.GAPTACT(0),ACTKACT                                           
         EX    RE,0(RF)                                                         
         JNE   NXTMYR04                                                         
                                                                                
         MVC   CSVKEY3,ACTKEY                                                   
         CLC   ACTKEY+ACTKEND(L'ACTKEY-ACTKEND),SPACES                          
         JE    NXTMYR26                                                         
NXTMYR24 LA    R2,IOKEY                                                         
         MVC   ACTKEY,CSVKEY3                                                   
         MVI   ACTKEY+ACTKEND,FF   if no account read for next                  
         J     NXTMYR12                                                         
                                                                                
NXTMYR26 TM    ACTKSTAT,ACTSABLP   test low level account                       
         JZ    NXTMYR14                                                         
         MVC   DACT,ACTKACT                                                     
         GOTOR TT1RVGT             test against table                           
         JNE   NXTMYR24                                                         
         MVC   DPERSON,SPACES      retrieve current person                      
         XR    RE,RE                                                            
         IC    RE,ONERL3L                                                       
         LA    RE,ACTKACT(RE)                                                   
         MVC   DPERSON(7),0(RE)                                                 
                                                                                
         USING PERRECD,R2                                                       
NXTMYR30 LA    R2,IOKEY            and read for person record                   
         MVC   PERKEY,SPACES                                                    
         MVI   PERKTYP,PERKTYPQ                                                 
         MVC   PERKCPY,CUXCPY                                                   
         MVC   PERKCODE,DPERSON                                                 
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO4'                               
         JNE   NXTMYR24                                                         
                                                                                
NXTMYR32 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO4'                              
         JE    *+6                                                              
         DC    H'0'                Fatal error                                  
*                                                                               
NXTMYR34 L     R2,AIO4                                                          
         USING PIDELD,R3                                                        
         LA    R3,PERRFST                                                       
         XC    WORK,WORK                                                        
         XC    X#PIDNO,X#PIDNO                                                  
NXTMYR36 CLI   PIDEL,0                                                          
         JE    NXTMYR60                                                         
         CLI   PIDEL,PIDELQ                                                     
         JE    NXTMYR40                                                         
         CLI   PIDEL,LOCELQ                                                     
         JE    NXTMYR44                                                         
NXTMYR38 LLC   R0,PIDLN                                                         
         AR    R3,R0                                                            
         J     NXTMYR36                                                         
                                                                                
NXTMYR40 MVC   X#PIDNO,PIDNO                                                    
         J     NXTMYR38                                                         
                                                                                
         USING LOCELD,R3                                                        
NXTMYR44 CLC   D_TODAYP,LOCSTART   Is this location valid for today             
         JL    NXTMYR38                                                         
         OC    LOCEND,LOCEND                                                    
         JZ    NXTMYR46                                                         
         CLC   D_TODAYP,LOCEND                                                  
         JH    NXTMYR38                                                         
NXTMYR46 LA    R1,WORK                                                          
         LLC   RE,ONERL1L                                                       
         SHI   RE,1                                                             
         BASR  RF,0                                                             
         MVC   0(0,R1),LOCOFF      Add office                                   
         EX    RE,0(RF)                                                         
         AHI   RE,1                                                             
         AR    R1,RE               R1=A(Dept position of 1R account)            
         LLC   RF,ONERL2L                                                       
         SR    RF,RE                                                            
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   0(0,R1),LOCDEPT     Add dept                                     
         EX    RF,0(RE)                                                         
         AHI   RF,1                                                             
         AR    R1,RF               R1=A(Sub dept position of 1R acc)            
         LLC   RF,ONERL3L                                                       
         LLC   RE,ONERL2L                                                       
         SR    RF,RE                                                            
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   0(0,R1),LOCSUB      Add sub-dept                                 
         EX    RF,0(RE)                                                         
         LLC   RF,ONERL3L                                                       
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         CLC   WORK(0),DACT        Compare to the account record we             
         EX    RF,0(RE)             read and if no match read next              
         JNE   NXTMYR24                            record                       
         J     NXTMYR38                                                         
                                                                                
NXTMYR60 OC    X#PIDNO,X#PIDNO     Do we have a PID                             
         JZ    NXTMYR24                                                         
         GOTOR LP_AAWMP,DMCB,(L'PIDNO,X#PIDNO),DPIDIND,                +        
               DPIDMAXQ,LP_D                                                    
         J     NXTMYR24                                                         
                                                                                
NXTMYRX  MVI   LP_RMODE,LP_RLAST                                                
         J     EXITY                                                            
         DROP  R2,R3                                                            
***********************************************************************         
* GET MY REPORTS REPORTS AS LINE MANAGER                              *         
***********************************************************************         
                                                                                
         USING LW_D,R2                                                          
NXTMRR   XR    R2,R2               POINT TO LIST IN WMP                         
         ICM   R2,7,DAPID2                                                      
         JZ    NXTMRR00                                                         
         XR    R3,R3                                                            
         XC    LW_NUMN,LW_NUMN                                                  
         LA    R0,LW_DATA2         CLEAR ENTRIES                                
         LHI   R1,DPIDMAXQ*L'PIDKNUM                                            
         SR    RF,RF                                                            
         SR    RE,RE                                                            
         MVCL  R0,RE               CLEAR AREA                                   
                                                                                
NXTMRR00 GOTOR (#GOATSR,AGOATSR),DMCB,('TSAINI',ATSRERRS),0,GAPAREA2,  +        
               TSARABUF                                                         
         GOTOR (#GAPLST,AGAPLST),DMCB,('GAPTT1Q',TSARABUF),            +        
               ('GAPLAPPR',SPACES),('GAPLTDTE',GAPLPARM),              +        
               ('QTIME',DPPID)                                                  
         JE    NXTMRR02                                                         
         J     NXTMRRX                                                          
         MVC   LP_ERROR,FULL2      set error msgno from GAPLST                  
         J     QERROR                                                           
                                                                                
GAP      USING GAPTABD,GAPAREA                                                  
NXTMRR02 XC    GAPAREA,GAPAREA                                                  
         GOTOR (#GOATSR,AGOATSR),DMCB,('TSARDH',ATSRERRS),0,GAPAREA,   +        
               TSARABUF                                                         
         TM    ATSRERRS,TSEEOF                                                  
         JNZ   NXTMRRX             end of buffer                                
         J     NXTMRR06                                                         
*XTMYR04 GOTOR (#GOATSR,AGOATSR),DMCB,('TSARDH',ATSRERRS),0,GAPAREA,            
*              TSARABUF                                                         
NXTMRR04 GOTOR (#GOATSR,AGOATSR),DMCB,('TSANXT',ATSRERRS),0,GAPAREA,   +        
               TSARABUF                                                         
         TM    ATSRERRS,TSEEOF                                                  
         JNZ   NXTMRRX             end of buffer                                
NXTMRR06 TM    GAP.GAPTSTA,GAPTSMQ     look for main entry                      
         JZ    NXTMRR04                                                         
                                                                                
         USING OFFALD,R1                                                        
NXTMRR08 L     R1,AOFFAREA                                                      
         LA    RE,1                                                             
         TM    SCPYEL+(CPYSTAT4-CPYELD),CPYSOFF2                                
         JNZ   *+8                                                              
         LA    RE,0                                                             
         BASR  RF,0                                                             
         MVC   OFFAOFFC(0),GAP.GAPTACT                                          
         EX    RE,0(RF)                                                         
         MVI   OFFAACT,OFFAVAL                                                  
         GOTO1 VOFFAL              Validate office                              
         JNE   NXTMRR04                                                         
         DROP  R1                                                               
                                                                                
         USING ACTRECD,R2                                                       
NXTMRR10 LA    R2,IOKEY            build 1R account record key                  
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKULA(L'ACTKUNT+L'ACTKLDG),=C'1R'                              
         MVC   ACTKACT,GAP.GAPTACT                                              
         MVC   CSVKEY1,ACTKEY      save key    (NOTE CSVKEY1 NOW FREE)          
                                                                                
NXTMRR12 GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         JE    NXTMRR16                                                         
         DC    H'0'                no errors should occur                       
                                                                                
NXTMRR14 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
         JE    NXTMRR16                                                         
         DC    H'0'                no errors should occur                       
                                                                                
NXTMRR16 CLC   CSVKEY1(ACTKACT-ACTRECD),ACTKEY                                  
         JNE   NXTMRR04                                                         
                                                                                
         MVC   GAPAREA2,GAPAREA                                                 
         LLC   RE,GAP.GAPTLEN          for main entry save office               
         SHI   RE,1                                                             
         BASR  RF,0                                                             
         CLC   GAP.GAPTACT(0),ACTKACT                                           
         EX    RE,0(RF)                                                         
         JNE   NXTMRR04                                                         
                                                                                
         MVC   CSVKEY3,ACTKEY                                                   
         CLC   ACTKEY+ACTKEND(L'ACTKEY-ACTKEND),SPACES                          
         JE    NXTMRR26                                                         
NXTMRR24 LA    R2,IOKEY                                                         
         MVC   ACTKEY,CSVKEY3                                                   
         MVI   ACTKEY+ACTKEND,FF   if no account read for next                  
         J     NXTMRR12                                                         
                                                                                
NXTMRR26 TM    ACTKSTAT,ACTSABLP   test low level account                       
         JZ    NXTMRR14                                                         
         MVC   DACT,ACTKACT                                                     
         GOTOR TT1RVGT             test against table                           
         JNE   NXTMRR24                                                         
         MVC   DPERSON,SPACES      retrieve current person                      
         XR    RE,RE                                                            
         IC    RE,ONERL3L                                                       
         LA    RE,ACTKACT(RE)                                                   
         MVC   DPERSON(7),0(RE)                                                 
                                                                                
         USING PERRECD,R2                                                       
NXTMRR30 LA    R2,IOKEY            and read for person record                   
         MVC   PERKEY,SPACES                                                    
         MVI   PERKTYP,PERKTYPQ                                                 
         MVC   PERKCPY,CUXCPY                                                   
         MVC   PERKCODE,DPERSON                                                 
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO4'                               
         JNE   NXTMRR24                                                         
                                                                                
NXTMRR32 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO4'                              
         JE    *+6                                                              
         DC    H'0'                Fatal error                                  
*                                                                               
NXTMRR34 L     R2,AIO4                                                          
         USING PIDELD,R3                                                        
         LA    R3,PERRFST                                                       
NXTMRR36 CLI   PIDEL,0                                                          
         JE    NXTMRR24                                                         
         CLI   PIDEL,PIDELQ                                                     
         JE    NXTMRR40                                                         
NXTMRR38 LLC   R0,PIDLN                                                         
         AR    R3,R0                                                            
         J     NXTMRR36                                                         
                                                                                
NXTMRR40 GOTOR LP_AAWMP,DMCB,(L'PIDNO,PIDNO),DPIDIND2,                 +        
               DPIDMAXQ,LP_D                                                    
         J     NXTMRR24                                                         
                                                                                
NXTMRRX  MVI   LP_RMODE,LP_RLAST                                                
         J     EXITY                                                            
         DROP  R2,R3                                                            
***********************************************************************         
* Test current 1R account versus GAPTAB entries                       *         
***********************************************************************         
         SPACE 1                                                                
         USING GAPTABD,R4                                                       
TT1RVGT  NTR1  BASE=*,LABEL=*                                                   
         J     *+12                                                             
         DC    C'*TT1RVGT'                                                      
*                                                                               
         LA    R4,GAPAREA2         point to main/office entry                   
         GOTOR (#GOATSR,AGOATSR),DMCB,('TSARDH',ATSRERRS),0,GAPAREA2,  +        
               TSARABUF                                                         
                                                                                
         LA    R3,DACT                                                          
P        USING ACTKACT,R3                                                       
TT1RV08  LLC   RF,GAPTLEN                                                       
         AR    RF,R3                                                            
         CLI   0(RF),C' '          Is the account any longer than entry         
         JE    TT1RVGLY            No - so keep account                         
                                                                                
TT1RV10  GOTOR (#GOATSR,AGOATSR),DMCB,('TSANXT',ATSRERRS),0,GAPAREA2,  +        
               TSARABUF                                                         
         TM    ATSRERRS,TSEEOF     End of buffer                                
         JNZ   TT1RVGLY            Yes                                          
         TM    GAPTSTA,GAPTSMQ     next group/office                            
         JO    TT1RVGLY                                                         
                                                                                
TT1RV12  LLC   RF,GAPTLEN                                                       
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         CLC   GAPTACT(0),P.ACTKACT                                             
         EX    RF,0(RE)                                                         
         JNE   TT1RV10                                                          
         J     TT1RVGLN                                                         
                                                                                
*    REREAD GAPAREA ENTRY ON EXIT, IN CASE WE BROKE HI/NEXT SEQ                 
                                                                                
TT1RVGLY GOTOR (#GOATSR,AGOATSR),DMCB,('TSARDH',ATSRERRS),0,GAPAREA,   +        
               TSARABUF                                                         
         CR    RB,RB                                                            
         J     TT1RVGLX                                                         
TT1RVGLN GOTOR (#GOATSR,AGOATSR),DMCB,('TSARDH',ATSRERRS),0,GAPAREA,   +        
               TSARABUF                                                         
         LTR   RB,RB                                                            
TT1RVGLX XIT1                                                                   
         DROP  P,R4                                                             
***********************************************************************         
* GET PERSON RECORDS FOR LINE MANAGER                                 *         
***********************************************************************         
                                                                                
                                                                                
NXTREP   XC    TEMP2,TEMP2                                                      
         L     R4,SAVER4                                                        
         MVC   LP_ADATA,AIO4                                                    
         CLI   LP_RMODE,LP_RFRST  TEST FIRST TIME                               
         JNE   NXTREP02                                                         
         OC    DAPID,DAPID        TEST PID LIST PROVIDED                        
         JZ    NOMORE                                                           
                                                                                
         USING LW_D,R2                                                          
         XR    R2,R2               POINT TO LIST IN WMP                         
         ICM   R2,7,DAPID                                                       
         XR    R3,R3                                                            
         ICM   R3,3,LW_NUMN        number of entries                            
         STH   R3,WMPCNT           store count                                  
         LA    R4,LW_DATA2         start of list                                
         ST    R4,SAVER4           save address of list                         
         MVI   LP_RMODE,LP_RNEXT                                                
*                                                                               
NXTREP02 LLH   RF,WMPCNT          Any more entries?                             
         CHI   RF,0                                                             
         JNE   NXTREP04                                                         
         MVI   LP_RMODE,LP_RLAST  No, then we are done                          
         J     EXITY                                                            
*                                                                               
         USING SA0REC,R2                                                        
NXTREP04 LA    R2,IOKEY                                                         
         XC    SA0KEY,SA0KEY       BUILD KEY TO READ                            
         MVI   SA0KTYP,SA0KTYPQ                                                 
         MVC   SA0KAGY,QALPHA                                                   
         MVC   SA0KNUM,0(R4)                                                    
         MVC   DPPID,0(R4)                                                      
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IOCTL+IO4'                               
         JNE   NXTREP30                                                         
         L     R2,AIO4                                                          
         LA    R1,SA0DATA                                                       
         USING SAPALD,R1                                                        
         XR    R0,R0                                                            
NXTREP06 CLI   SAPALEL,SAPALELQ                                                 
         JE    NXTREP08                                                         
         CLI   SAPALEL,0                                                        
         JE    NXTREP30                                                         
         IC    R0,SAPALLN                                                       
         AR    R1,R0                                                            
         J     NXTREP06                                                         
                                                                                
         USING SAPEREC,R2                                                       
NXTREP08 LA    R2,IOKEY                                                         
         XC    SAPEKEY,SAPEKEY     BUILD KEY TO READ                            
         MVI   SAPETYP,SAPETYPQ                                                 
         MVI   SAPESUB,SAPESUBQ                                                 
         MVC   SAPEAGY,QALPHA                                                   
         MVC   SAPEPID,SAPALPID                                                 
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IOCTL+IO4'                               
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R2,AIO4             MATCH KEY ON ALL BUT EFFECTIVE DATE          
         USING SAPEREC,R2                                                       
         CLC   SAPEPID,SPACES                                                   
         JNH   NXTREP30                                                         
         MVC   TEMP2,SPACES                                                     
                                                                                
         LA    R3,SAPEDATA                                                      
         USING SANAMD,R3                                                        
         XR    R0,R0                                                            
                                                                                
NXTREP10 CLI   SANAMEL,SANAMELQ                                                 
         JE    NXTREP14                                                         
         CLI   SANAMEL,SAPERELQ                                                 
         JE    NXTREP26                                                         
         CLI   SANAMEL,0                                                        
         JE    NXTREP30                                                         
                                                                                
NXTREP12 IC    R0,SANAMLN          L'element                                    
         AR    R3,R0                                                            
         J     NXTREP10                                                         
*                                                                               
NXTREP14 LA    R1,SANAMELN         L'name                                       
         USING SANAMELN,R1                                                      
         TM    SANAMIND,SANAMIFN   test for first name                          
         JZ    NXTREP18                                                         
         XR    RF,RF                                                            
         IC    RF,SANAMELN                                                      
         CHI   RF,15               > max length                                 
         JNH   NXTREP16                                                         
         LA    RF,15                                                            
NXTREP16 SHI   RF,1                                                             
         BASR  RE,0                                                             
         EX    RF,4(RE)                                                         
         MVC   TEMP2(0),SANAME                                                  
         LA    R1,2(RF,R1)                                                      
                                                                                
NXTREP18 TM    SANAMIND,SANAMIMN   test for middle name present                 
         JZ    NXTREP22                                                         
         IC    RF,SANAMELN                                                      
         CHI   RF,15                                                            
         JNH   NXTREP20                                                         
         LA    RF,15                                                            
NXTREP20 SHI   RF,1                                                             
         BASR  RE,0                                                             
         EX    RF,4(RE)                                                         
         MVC   TEMP2+15(0),SANAME                                               
         LA    R1,2(RF,R1)                                                      
                                                                                
NXTREP22 TM    SANAMIND,SANAMILN   skip if no last name                         
         JZ    NXTREP12                                                         
         IC    RF,SANAMELN                                                      
         CHI   RF,50                                                            
         JNH   NXTREP24                                                         
         LA    RF,50                                                            
NXTREP24 SHI   RF,1                                                             
         BASR  RE,0                                                             
         EX    RF,4(RE)                                                         
         MVC   TEMP2+30(0),SANAME                                               
                                                                                
         J     NXTREP12                                                         
*                                                                               
         USING SAPERD,R3                                                        
NXTREP26 OC    SAPERDTE,SAPERDTE   Any termination date?                        
         JZ    NXTREP12                                                         
         CLI   QTERMD,YESQ         Include terminated?                          
         JE    NXTREP12                                                         
         CLC   SAPERDTE,D_TODAYC   Check terminatedd                            
         JNL   NXTREP12                                                         
*                                                                               
         L     R4,SAVER4           If terminated bump to next entry             
         LA    R4,L'PIDNO(R4)                                                   
         ST    R4,SAVER4                                                        
         LH    R3,WMPCNT                                                        
         SHI   R3,1                                                             
         STH   R3,WMPCNT                                                        
         J     NXTREP02                                                         
                                                                                
NXTREP30 L     R4,SAVER4                                                        
         LA    R4,L'PIDNO(R4)                                                   
         ST    R4,SAVER4                                                        
         LH    R3,WMPCNT                                                        
         SHI   R3,1                                                             
         STH   R3,WMPCNT                                                        
         J     EXITY                                                            
         DROP  R1,R2,R3                                                         
***********************************************************************         
* GET PERSON RECORDS FOR REPORTS OF MY REPORTS                        *         
***********************************************************************         
                                                                                
NXTRRP   XC    TEMP2,TEMP2                                                      
         L     R4,SAVER42                                                       
         MVC   LP_ADATA,AIO4                                                    
         CLI   LP_RMODE,LP_RFRST  TEST FIRST TIME                               
         JNE   NXTRRP02                                                         
         OC    DAPID2,DAPID2        TEST PID LIST PROVIDED                      
         JZ    NOMORE                                                           
                                                                                
         USING LW_D,R2                                                          
         XR    R2,R2               POINT TO LIST IN WMP                         
         ICM   R2,7,DAPID2                                                      
         XR    R3,R3                                                            
         ICM   R3,3,LW_NUMN        number of entries                            
         STH   R3,WMPCNT2          store count                                  
         LA    R4,LW_DATA2         start of list                                
         ST    R4,SAVER42          save address of list                         
         MVI   LP_RMODE,LP_RNEXT                                                
*                                                                               
NXTRRP02 LLH   RF,WMPCNT2         Any more entries?                             
         CHI   RF,0                                                             
         JNE   NXTRRP04                                                         
         MVI   LP_RMODE,LP_RLAST  No, then we are done                          
         J     EXITY                                                            
*                                                                               
         USING SA0REC,R2                                                        
NXTRRP04 LA    R2,IOKEY                                                         
         XC    SA0KEY,SA0KEY       BUILD KEY TO READ                            
         MVI   SA0KTYP,SA0KTYPQ                                                 
         MVC   SA0KAGY,QALPHA                                                   
         MVC   SA0KNUM,0(R4)                                                    
         MVC   DPPID,0(R4)                                                      
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IOCTL+IO4'                               
         JNE   NXTRRP30                                                         
         L     R2,AIO4                                                          
         LA    R1,SA0DATA                                                       
         USING SAPALD,R1                                                        
         XR    R0,R0                                                            
NXTRRP06 CLI   SAPALEL,SAPALELQ                                                 
         JE    NXTRRP08                                                         
         CLI   SAPALEL,0                                                        
         JE    NXTRRP30                                                         
         IC    R0,SAPALLN                                                       
         AR    R1,R0                                                            
         J     NXTRRP06                                                         
                                                                                
         USING SAPEREC,R2                                                       
NXTRRP08 LA    R2,IOKEY                                                         
         XC    SAPEKEY,SAPEKEY     BUILD KEY TO READ                            
         MVI   SAPETYP,SAPETYPQ                                                 
         MVI   SAPESUB,SAPESUBQ                                                 
         MVC   SAPEAGY,QALPHA                                                   
         MVC   SAPEPID,SAPALPID                                                 
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IOCTL+IO4'                               
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R2,AIO4             MATCH KEY ON ALL BUT EFFECTIVE DATE          
         USING SAPEREC,R2                                                       
         CLC   SAPEPID,SPACES                                                   
         JNH   NXTRRP30                                                         
         MVC   TEMP2,SPACES                                                     
                                                                                
         LA    R3,SAPEDATA                                                      
         USING SANAMD,R3                                                        
         XR    R0,R0                                                            
                                                                                
NXTRRP10 CLI   SANAMEL,SANAMELQ                                                 
         JE    NXTRRP14                                                         
         CLI   SANAMEL,0                                                        
         JE    NXTRRP30                                                         
                                                                                
NXTRRP12 IC    R0,SANAMLN          L'element                                    
         AR    R3,R0                                                            
         J     NXTRRP10                                                         
                                                                                
NXTRRP14 LA    R1,SANAMELN         L'name                                       
         USING SANAMELN,R1                                                      
         TM    SANAMIND,SANAMIFN   test for first name                          
         JZ    NXTRRP18                                                         
         XR    RF,RF                                                            
         IC    RF,SANAMELN                                                      
         CHI   RF,15               > max length                                 
         JNH   NXTRRP16                                                         
         LA    RF,15                                                            
NXTRRP16 SHI   RF,1                                                             
         BASR  RE,0                                                             
         EX    RF,4(RE)                                                         
         MVC   TEMP2(0),SANAME                                                  
         LA    R1,2(RF,R1)                                                      
                                                                                
NXTRRP18 TM    SANAMIND,SANAMIMN   test for middle name present                 
         JZ    NXTRRP22                                                         
         IC    RF,SANAMELN                                                      
         CHI   RF,15                                                            
         JNH   NXTRRP20                                                         
         LA    RF,15                                                            
NXTRRP20 SHI   RF,1                                                             
         BASR  RE,0                                                             
         EX    RF,4(RE)                                                         
         MVC   TEMP2+15(0),SANAME                                               
         LA    R1,2(RF,R1)                                                      
                                                                                
NXTRRP22 TM    SANAMIND,SANAMILN   skip if no last name                         
         JZ    NXTRRP12                                                         
         IC    RF,SANAMELN                                                      
         CHI   RF,50                                                            
         JNH   NXTRRP24                                                         
         LA    RF,50                                                            
NXTRRP24 SHI   RF,1                                                             
         BASR  RE,0                                                             
         EX    RF,4(RE)                                                         
         MVC   TEMP2+30(0),SANAME                                               
         J     NXTRRP12                                                         
                                                                                
NXTRRP30 L     R4,SAVER42                                                       
         LA    R4,L'PIDNO(R4)                                                   
         ST    R4,SAVER42                                                       
         LH    R3,WMPCNT2                                                       
         SHI   R3,1                                                             
         STH   R3,WMPCNT2                                                       
         J     EXITY                                                            
         DROP  R1,R2,R3                                                         
***********************************************************************         
* Campaign download                                                   *         
***********************************************************************         
                                                                                
REQCAMP  LKREQ H,A#CAMDL,OUTCAM,NEXTREQ=REQXPIN                                 
                                                                                
camp     LKREQ F,1,(D,B#SAVED,QCAMP),LBIN,OLEN=L'QCAMP,                +        
               MAXLEN=L'QCAMP,TEXT=(*,CAMCLIT),COL=*                            
client   LKREQ F,2,(D,B#SAVED,QCLIENT),CHAR,OLEN=L'QCLIENT,            +        
               MAXLEN=L'QCLIENT,TEXT=AC#CLI,COL=*                               
prod     LKREQ F,3,(D,B#SAVED,QPROD),CHAR,OLEN=L'QPROD,                +        
               MAXLEN=L'QPROD,TEXT=AC#PROC,COL=*                                
Strng    LKREQ F,04,(D,B#SAVED,QCAMSTR),CHAR,OLEN=L'QCAMSTR,           +        
               MAXLEN=L'QCAMSTR,TEXT=AC#NAME,COL=*                              
                                                                                
         LKREQ E                                                                
                                                                                
OUTCAM   LKOUT H                                                                
                                                                                
CAMLIS   LKOUT R,R#CAMDL                                                        
Array    LKOUT C,2,(A,ARYCAM)                                                   
                                                                                
         LKOUT E                                                                
                                                                                
         LKOUT X                                                                
                                                                                
ARYCAM   LKOUT A,(R,NXTCAM),MULTIROW=Y,ROWNAME=CPCPASD                          
Cam#     LKOUT C,1,(D,B#WORKD,TEMP2),LBIN,LEN=L'RWKKCCDE,ND=Y                   
CamNam   LKOUT C,2,(D,B#WORKD,TEMP2+4),CHAR,LEN=L'NAMEREC,ND=Y                  
                                                                                
         LKOUT E                                                                
                                                                                
***********************************************************************         
* Get campaign records                                                *         
***********************************************************************         
                                                                                
NXTCAM   CLI   LP_RMODE,LP_RFRST   First time?                                  
         JE    NXTCAM2                                                          
         CLI   USECPC,C'Y'                                                      
         JE    NXTCAM14                                                         
         OC    QCAMP,QCAMP                                                      
         JNZ   NXTCAM18                                                         
         J     NXTCAM20                                                         
                                                                                
NXTCAM2  LA    RE,QCAMSTR+L'QCAMSTR-1                                           
         LA    RF,L'QCAMSTR                                                     
                                                                                
NXTCAM4  CLI   0(RE),C' '                                                       
         JH    NXTCAM6                                                          
         SHI   RE,1                                                             
         JCT   RF,NXTCAM4                                                       
                                                                                
NXTCAM6  STC   RF,DCAMLEN          set length of search string                  
         LTR   RF,RF                                                            
         JNZ   NXTCAM8                                                          
         MVI   NONAME,C'Y'                                                      
NXTCAM8  OC    QCAMP,QCAMP                                                      
         JNZ   NXTCAM16                                                         
                                                                                
         CLC   QCLIENT,SPACES                                                   
         JNH   NXTCAM20                                                         
         MVI   USECPC,C'Y'                                                      
         MVC   DACT,SPACES                                                      
         MVC   DACT(L'QCLIENT),QCLIENT                                          
                                                                                
NXTCAM14 GOTOR (#NXTREC,ANXTREC),DMCB,CPCKEYT,('B#CAMREC',0),          +        
               ('$NXTRXGR',SAVED),0,0                                           
         JNE   EXITY                                                            
         J     NXTCAM22                                                         
                                                                                
NXTCAM16 MVC   D1CCAMP,QCAMP                                                    
         XC    D1CCAMP,FFS                                                      
                                                                                
NXTCAM18 GOTOR (#NXTREC,ANXTREC),DMCB,CPNKEYT,('B#CAMREC',0),          +        
               ('$NXTRXGR',SAVED),0,0                                           
         JNE   EXITY                                                            
         J     NXTCAM22                                                         
                                                                                
NXTCAM20 GOTOR (#NXTREC,ANXTREC),DMCB,CPNKEYT2,('B#CAMREC',0),         +        
               ('$NXTRXGR',SAVED),0,0                                           
         JNE   EXITY                                                            
                                                                                
NXTCAM22 MVC   TEMP2,SPACES                                                     
         LA    R2,IOKEY                                                         
         USING CPCPASD,R2                                                       
         MVC   IODA,CPCPDA                                                      
         MVC   SVPASKEY,IOKEY                                                   
                                                                                
NXTCAM24 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO4'                              
         JE    NXTCAM25                                                         
         DC    H'0'                                                             
                                                                                
NXTCAM25 MVC   IOKEY,SVPASKEY                                                   
         L     R2,AIO4                                                          
         MVC   TEMP2,SPACES                                                     
         USING RWKRECD,R2                                                       
         LA    R3,RWKRFST                                                       
         MVC   TEMP2(4),RWKKCCDE                                                
         USING NAMELD,R3                                                        
         XR    RE,RE                                                            
NXTCAM26 CLI   NAMEL,NAMELQ                                                     
         JE    NXTCAM28                                                         
         CLI   NAMEL,0                                                          
         JE    NXTCAM30                                                         
NXTCAM27 IC    RE,NAMLN                                                         
         AR    R3,RE                                                            
         J     NXTCAM26                                                         
                                                                                
NXTCAM28 SR    RE,RE                                                            
         IC    RE,NAMLN                                                         
         SHI   RE,NAMLN1Q+1                                                     
         JM    NXTCAM27                                                         
         BASR  RF,0                                                             
         EX    RE,4(RF)                                                         
         MVC   TEMP2+4(0),NAMEREC                                               
         DROP  R2                                                               
                                                                                
NXTCAM30 CLC   TEMP2+4(36),SPACES  skip if no name                              
         JNE   NXTCAM32                                                         
         CLI   USECPC,C'Y'                                                      
         JE    NXTCAM14                                                         
         OC    QCAMP,QCAMP                                                      
         JNZ   NXTCAM38                                                         
         J     NXTCAM20                                                         
                                                                                
NXTCAM32 OC    TEMP2+4(36),SPACES                                               
         CLI   NONAME,C'Y'                                                      
         JE    NXTCAM38                                                         
         XR    R1,R1                                                            
         IC    R1,DCAMLEN          exec length of search string                 
         SHI   R1,1                                                             
         LA    RE,TEMP2+4                                                       
         LA    RF,L'TEMP2-4                                                     
                                                                                
NXTCAM34 BASR  R3,0                                                             
         EX    R1,8(R3)                                                         
         JE    NXTCAM38                                                         
         CLC   QCAMSTR(0),0(RE)                                                 
         AHI   RE,1                                                             
         JCT   RF,NXTCAM34                                                      
         CLI   USECPC,C'Y'                                                      
         JE    NXTCAM14                                                         
         OC    QCAMP,QCAMP                                                      
         JNZ   NXTCAM38                                                         
         J     NXTCAM20                                                         
*                                                                               
NXTCAM38 J     EXITY                                                            
*                                                                               
         EJECT                                                                  
         DROP  R3                                                               
***********************************************************************         
* Expenses initial download                                           *         
***********************************************************************         
                                                                                
REQXPIN  LKREQ H,A#CLID,OUTXPIN,NEXTREQ=REQCURR                                 
                                                                                
Ind      LKREQ F,1,(D,B#SAVED,QINITIAL),CHAR,OLEN=L'QINITIAL,          +        
               MAXLEN=L'QINITIAL,TEXT=(*,INITLIT),COL=*                         
Xovtm    LKREQ F,2,(D,B#SAVED,QGENINI2),CHAR,OLEN=L'QGENINI2,          +        
               MAXLEN=L'QGENINI2,TEXT=(*,OVERLIT),COL=*                         
                                                                                
         LKREQ E                                                                
                                                                                
OUTXPIN  LKOUT H                                                                
                                                                                
XPINIT   LKOUT R,R#CLID                                                         
Array    LKOUT C,R#CLID,(A,ARYXIN),FILTROUT=TSTQINII                            
         LKOUT E                                                                
                                                                                
GENINIX  LKOUT R,A#GINI            General initial                              
ExpIni   LKOUT P,,EXPINI                                                        
Array    LKOUT C,A#GINI,(A,ARYGINI),FILTROUT=TSTRODK1                           
         LKOUT E                                                                
                                                                                
OUTOVTX  LKOUT R,A#OVTM                                                         
Array    LKOUT C,A#OVTM,(A,ARYOVTM),FILTROUT=TSTGENTM                           
         LKOUT E                                                                
                                                                                
CURLIS   LKOUT R,R#CURR                                                         
Array    LKOUT C,R#CURR,(A,ARYCUR),FILTROUT=TSTQINII                            
         LKOUT E                                                                
                                                                                
OFFLIS   LKOUT R,R#OFFL                                                         
Array    LKOUT C,R#OFFL,(A,ARYOFFL),FILTROUT=TSTRINIT                           
         LKOUT E                                                                
                                                                                
WCLISX   LKOUT R,A#WCOL            Aura get list of work code                   
Array    LKOUT C,A#WCOL,(A,ARYWCL),FILTROUT=TSTRODK2                            
         LKOUT E                                                                
*                                                                               
MOALIS   LKOUT R,A#MOAD            Aura get list of MOAs                        
Array    LKOUT C,A#MOAD,(A,ARYMOA),FILTROUT=TSTRODK2                            
         LKOUT E                                                                
*                                                                               
                                                                                
NARLIS   LKOUT R,R#NARR                                                         
Array    LKOUT C,R#NARR,(A,ARYNAR),FILTROUT=TSTQINII                            
         LKOUT E                                                                
                                                                                
* '06' response for Brando                                                      
ETYLIS   LKOUT R,R#ETYL                                                         
Array    LKOUT C,R#ETYL,(A,ARYETYL),FILTROUT=TSTBINII                           
         LKOUT E                                                                
* '71' response for Rodick                                                      
ETYLISE  LKOUT R,R#ETYP                                                         
Array    LKOUT C,R#ETYP,(A,ARYETYP),FILTROUT=TSTRODK1                           
         LKOUT E                                                                
*                                                                               
                                                                                
***LIS   LKOUT R,R#ETYL                                                         
***ut    LKOUT P,,INVOKER                                                       
***      LKOUT E                                                                
                                                                                
         LKOUT X                                                                
                                                                                
ARYXIN   LKOUT A,(R,GETXINI),ROWNAME=COBLOCKD                                   
AgyCur   LKOUT C,1,(D,B#WORKD,AGYCURR),CHAR,ND=Y                                
OfcInd   LKOUT C,2,(D,B#WORKD,OFFIND),CHAR,ND=Y                                 
ForCur   LKOUT C,3,(D,B#SAVED,XI_FCUR),CHAR,ND=Y                                
NewVat   LKOUT C,4,(D,B#SAVED,XI_NVAT),CHAR,ND=Y                                
Clilen   LKOUT C,5,(D,B#WORKD,PCLILEN),LBIN,ND=Y                                
OneROff  LKOUT C,6,(D,B#SAVED,XI_1ROFF),CHAR,ND=Y                               
NarrRqd  LKOUT C,7,COENR,CHAR,ND=Y                                              
NumLines LKOUT C,8,COLTP,SPAK,LEN=4,ND=Y                                        
CliVal   LKOUT C,9,COCVA,CHAR,ND=Y                                              
OneRPer  LKOUT C,10,(D,B#SAVED,DPERSON),CHAR,ND=Y                               
OneRPFN  LKOUT C,11,(D,B#SAVED,DPERFNA),CHAR,ND=Y                               
OneRPLN  LKOUT C,12,(D,B#SAVED,DPERLNA),CHAR,ND=Y                               
Estclam  LKOUT C,13,COECL,CHAR,ND=Y                                             
Nomix    LKOUT C,14,CONMX,CHAR,ND=Y                                             
Backdat  LKOUT C,15,(D,B#SAVED,QBACKDAT),CHAR,ND=Y                              
Comnfa   LKOUT C,16,COACM,CHAR,ND=Y                                             
Appcom   LKOUT C,17,COCCM,CHAR,ND=Y                                             
Rectic   LKOUT C,19,CORCP,CHAR,ND=Y                                             
Ccaexp   LKOUT C,20,COCAE,CHAR,ND=Y                                             
Mileage  LKOUT C,21,COMIL,CHAR,ND=Y                                             
KMorMils LKOUT C,22,(D,B#SAVED,XI_KMMI),CHAR,ND=Y                               
RefDte   LKOUT C,23,(D,B#SAVED,XI_DRDT),CHAR,ND=Y                               
NonVtb   LKOUT C,24,(D,B#SAVED,XI_NVTCD),CHAR,ND=Y                              
NonVrt   LKOUT C,25,(D,B#SAVED,XI_VATRT),LBIN                                   
NonVnam  LKOUT C,26,(D,B#SAVED,XI_VATAN),CHAR,ND=Y                              
PrAna    LKOUT C,27,(D,B#SAVED,XI_PRAN),CHAR,ND=Y                               
*&&UK                                                                           
Ctry     LKOUT C,28,(D,B#SAVED,XI_CTRY),LBIN                                    
Curr     LKOUT C,29,(D,B#SAVED,XI_CURR),CHAR,ND=Y                               
Mcag     LKOUT C,30,(D,B#WORKD,SCPXEL),(R,EDTMCAG)                              
*&&                                                                             
*&&US                                                                           
Array    LKOUT C,1,(A,ARYXPRV)                                                  
*&&                                                                             
                                                                                
         LKOUT E                                                                
                                                                                
*&&US                                                                           
ARYXPRV  LKOUT A,(D,B#SVRDEF,PRVTAB),ROWNAME=PRVCODE,ROWWIDTH=PRVTABL, +        
               NEWEL=Y,EOT=FF                                                   
                                                                                
PrvCodL  LKOUT C,1,PRVCODE,CHAR,LEN=L'PRVCODE                                   
PRout    LKOUT P,PRVNAM,SETPRVNM                                                
PrvNamL  LKOUT C,2,(D,B#SAVED,XI_PRVNM),CHAR                                    
                                                                                
         LKOUT E                                                                
*&&                                                                             
                                                                                
GETXINI  MVI   XI_FCUR,NOQ                                                      
         MVI   XI_PRAN,NOQ                                                      
         MVI   QAPPL,QEXPCLM                                                    
*&&UK*&& MVI   QCLTYP,QCLEXP       set expenses for currency                    
         MVI   QETYCD,C'*'                                                      
*&&UK*&& MVI   QNARAPP,QEXPCLM     Set this so we only get expense nar          
         TM    CPYSTAT6,CPYSFMCR+CPYSFOCR                                       
         JZ    GINI002                                                          
         MVI   XI_FCUR,YESQ                                                     
GINI002  MVI   XI_NVAT,NOQ                                                      
*&&US                                                                           
         TM    CPYSTAT5,CPYSEXPP                                                
         JZ    *+8                                                              
         MVI   XI_PRAN,YESQ                                                     
*&&                                                                             
*&&UK                                                                           
         TM    CPYSTAT5,CPYSNVAT                                                
         JZ    GINI003                                                          
         MVI   XI_NVAT,YESQ                                                     
GINI003  MVC   XI_NVTCD,CPXDNVAT                                                
                                                                                
         MVI   XI_KMMI,C'M'                                                     
         TM    CPXSTAT8,CPXDTKMQ                                                
         JZ    GINI004                                                          
         MVI   XI_KMMI,C'K'                                                     
*&&                                                                             
                                                                                
GINI004  GOTO1 VHEXOUT,DMCB,CPXDRDTE,XI_DRDT,2,0                                
                                                                                
         OC    CCTPID,CCTPID                                                    
         JNZ   GINI006                                                          
         MVC   LP_ERROR,=AL2(AE$NCPID)                                          
         J     QERROR                                                           
*                                                                               
GINI006  GOTOR CSTPID,DMCB,CCTPID                                               
         JE    GINI008                                                          
         MVC   LP_ERROR,=AL2(AE$PIDPR)                                          
         J     QERROR                                                           
*                                                                               
GINI008  GOTOR PRSDTL,DMCB,(X'FF',D_TODAYP)                                     
         JNE   QERROR                                                           
*                                                                               
         CLI   LP_ACCS,0           skip if no limit access                      
         JE    GINI022                                                          
         J     GINI017                                                          
*        JE    GINI022   Idiots in client service don't want security           
*                        upshot id user won't see claim in folders              
         L     R2,AIO1             Check connected user has access to           
         AHI   R2,PERRFST-PERRECD                        expenses               
         USING LOCELD,R2                                                        
GINI010  CLI   LOCEL,0                                                          
         JNE   GINI012                                                          
         MVC   LP_ERROR,=AL2(AE$SECLK)                                          
         J     QERROR                                                           
GINI012  CLI   LOCEL,LOCELQ                                                     
         JE    GINI016                                                          
GINI014  LLC   R0,LOCLN                                                         
         AR    R2,R0                                                            
         J     GINI010                                                          
*                                                                               
         USING OFFALD,R1                                                        
GINI016  L     R1,AOFFAREA                                                      
         LLC   RE,ONERL1L                                                       
         SHI   RE,1                                                             
         BASR  RF,0                                                             
         MVC   OFFAOFFC(0),LOCOFF    move in office and validate                
         EX    RE,0(RF)                                                         
         MVI   OFFAACT,OFFAVAL                                                  
         GOTO1 VOFFAL                                                           
         JNE   GINI014                                                          
*                                                                               
GINI017  DS    0H                  Read office rec to get ctry and curr         
*&&UK                                                                           
         USING OFFRECD,R3                                                       
         LA    R3,IOKEY            Read office rec to get ctry and curr         
         MVC   OFFKEY,SPACES         read for office record                     
         MVI   OFFKTYP,OFFKTYPQ                                                 
         MVC   OFFKCPY,CUXCPY                                                   
*                                                                               
         LA    RF,LP_ACCS                                                       
         LHI   RE,L'LP_ACCS                                                     
GINI017A CLI   0(RF),C'*'          Find start of off/offlist                    
         JNE   GINI017B                                                         
         AHI   RF,1                                                             
         JCT   RE,GINI017A                                                      
         DC    H'0'                Something wrong here with userid             
GINI017B MVC   OFFKOFF,0(RF)                                                    
         OC    OFFKOFF,SPACES                                                   
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JNE   GINI022             Ignore record not found could be             
*                                  1 char off with no office record             
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JE    *+6                                                              
         DC    H'0'                                                             
         L     RF,AIO2                                                          
         LA    RF,OFFRFST-OFFRECD(RF)                                           
*                                                                               
         USING OFIELD,RF                                                        
GINI018  CLI   OFIEL,0                                                          
         JE    GINI022                                                          
         CLI   OFIEL,OFIELQ                                                     
         JE    GINI020                                                          
         LLC   R0,OFILN                                                         
         AR    RF,R0                                                            
         J     GINI018                                                          
*                                                                               
GINI020  CLI   OFILN,OFILNQ        Check element is long enough                 
         JNH   GINI022                                                          
         MVC   XI_CURR,OFICUR      Currency                                     
         MVC   XI_CTRY,OFICTRY     Country code                                 
         DROP  R1,R2,RF                                                         
*&&                                                                             
                                                                                
GINI022  L     R1,ALOCEL           retrieve office                              
         MVC   XI_1ROFF,LOCOFF-LOCELD(R1)                                       
         MVC   XI_DEPT,LOCDEPT-LOCELD(R1)                                       
         MVC   XI_SDPT,LOCSUB-LOCELD(R1)                                        
         LA    RE,1                If 2 char office person code                 
         TM    CPYSTAT4,CPYSOFF2                                                
         JNZ   *+8                                                              
         LA    RE,0                                                             
         BASR  R1,0                                                             
         EX    RE,4(R1)                                                         
         MVC   DACT(0),XI_1ROFF                                                 
         AHI   RE,1                                                             
         LA    RF,DACT                                                          
         AR    RF,RE                                                            
         MVC   0(L'XI_DEPT,RF),XI_DEPT                                          
         MVC   L'XI_DEPT(L'XI_SDPT,RF),XI_SDPT                                  
         AHI   RE,L'XI_DEPT+L'XI_SDPT                                           
         LA    R1,L'DACT                                                        
         SR    R1,RE                                                            
         SHI   R1,1                                                             
         BASR  RE,0                                                             
         EX    R1,4(RE)                                                         
         MVC   L'XI_DEPT+L'XI_SDPT(0,RF),DPERSON                                
         GOTOR (#CSTPRF,ACSTPRF),DMCB,DACT  get profiles                        
         L     R3,ACOBLOCK                                                      
         MVC   LP_ADATA,ACOBLOCK                                                
         USING COBLOCK,R3                                                       
         CURED (P4,COBDT),(8,QBACKDAT),0,ALIGN=LEFT                             
                                                                                
*&&UK                                                                           
         CLC   XI_NVTCD,SPACES     Do we have non vatable code for              
         JNH   EXITY                                    mileage                 
         TM    CPYSTAT5,CPYSNVAT   On new VAT                                   
         JZ    GINI050             No                                           
                                                                                
K        USING LDGRECD,IOKEY                                                    
         MVC   K.LDGKEY,SPACES                                                  
         MVC   K.LDGKCPY,CUXCPY                                                 
         MVC   K.LDGKUNT(L'LDGKUNT+L'LDGKLDG),=C'SG'                            
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         L     R3,AIO3                                                          
         USING LDGELD,R3           Locate ledger element on record              
         AHI   R3,LDGRFST-LDGRECD                                               
GINI024  CLI   LDGEL,0                                                          
         JNE   *+6                                                              
         DC    H'0'                                                             
         CLI   LDGEL,LDGELQ                                                     
         JE    GINI026                                                          
         LLC   RF,LDGLN                                                         
         AR    R3,RF                                                            
         J     GINI024                                                          
                                                                                
GINI026  MVC   XI_SGOPS,LDGOPOS                                                 
         DROP  K,R3                                                             
                                                                                
V        USING VTCD,ELEMENT                                                     
         XC    V.VTCD(VTCLNQ),V.VTCD                                            
         MVI   V.VTCACTN,VTCAILUP                                               
         MVC   V.VTCCPY,CUXCPY                                                  
         MVC   V.VTCOFFC,SPACES                                                 
         MVC   V.VTCCOMF,ACOMFACS                                               
         MVC   V.VTCINVD,D_TODAYP                                               
         MVC   V.VTCTYPE,XI_NVTCD                                               
         MVC   V.VTCCPYS1,CPYSTAT1                                              
         MVC   V.VTCSGOPO,XI_SGOPS                                              
                                                                                
GINI028  GOTO1 VATICAN,V.VTCD                                                   
         JNE   GINI030                                                          
         TM    V.VTCINDS,VTCINA                                                 
         JZ    GINI040                                                          
         MVC   LP_ERROR,=AL2(AE$VRNDE)                                          
         J     QERROR                                                           
                                                                                
GINI030  MVC   LP_ERROR,V.VTCERR                                                
         J     QERROR                                                           
                                                                                
GINI040  MVC   XI_VATAC,V.VTCACT+L'ACTKCPY+L'ACTKLDG+L'ACTKUNT                  
         MVC   XI_VATAN,V.VTCACTNM                                              
         MVC   XI_VATRT,V.VTCRATE                                               
         J     EXITY                                                            
         DROP  V                                                                
                                                                                
K        USING ACTRECD,IOKEY                                                    
GINI050  MVC   K.ACTKEY,SPACES                                                  
         MVC   K.ACTKCPY,CUXCPY                                                 
         MVC   K.ACTKUNT(L'LDGKUNT+L'LDGKLDG),=C'SG'                            
         MVC   K.ACTKACT,XI_NVTCD                                               
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    *+14                                                             
         MVC   LP_ERROR,=AL2(AE$INACC)                                          
         J     QERROR                                                           
                                                                                
         TM    K.ACTKSTAT,ACTSDRFT                                              
         JZ    *+14                                                             
         MVC   LP_ERROR,=AL2(AE$ACCNA)                                          
         J     QERROR                                                           
                                                                                
         TM    K.ACTKSTAT,ACTSLOCK                                              
         JZ    *+14                                                             
         MVC   LP_ERROR,=AL2(AE$ACTLK)                                          
         J     QERROR                                                           
                                                                                
         TM    K.ACTKSTAT,ACTSABLP                                              
         JNZ   *+14                                                             
         MVC   LP_ERROR,=AL2(AE$INACP)                                          
         J     QERROR                                                           
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R3,AIO3                                                          
         AHI   R3,ACTRFST-ACTRECD                                               
         USING RATELD,R3                                                        
GINI060  CLI   RATEL,0                                                          
         JNE   GINI062                                                          
         MVC   LP_ERROR,=AL2(AE$VINAP)                                          
         J     QERROR                                                           
GINI062  CLI   RATEL,RATEVATQ                                                   
         JE    GINI066                                                          
         CLI   RATEL,NAMELQ                                                     
         JE    GINI068                                                          
GINI064  LLC   RF,RATLN                                                         
         AR    R3,RF                                                            
         J     GINI060                                                          
                                                                                
GINI066  MVC   XI_VATRT,RATRATE                                                 
         J     EXITY                                                            
                                                                                
         USING NAMELD,R3                                                        
GINI068  IC    RE,NAMLN                                                         
         SHI   RE,NAMLN1Q+1        RE=LENGTH OF NAME - 1                        
         BASR  RF,0                                                             
         EX    RE,4(RF)                                                         
         MVC   XI_VATAN(0),NAMEREC  PASS NAME OF EXP. TYPE                      
         J     GINI064                                                          
*&&                                                                             
         J     EXITY                                                            
*                                                                               
INVOKER  GOTOR VCALLOV,DMCB,(3,0),0,0                                           
         XR    RF,RF                                                            
         J     EXITY                                                            
         ICM   RF,7,1(R1)                                                       
         GOTOR (RF)                                                             
         J     EXITY                                                            
         SPACE 1                                                                
*&&UK                                                                           
***********************************************************************         
* Edit office currency agency                                         *         
***********************************************************************         
         SPACE 1                                                                
         USING CPXELD,R2                                                        
EDTMCAG  LM    R2,R4,LP_AINP                                                    
         MVI   0(R4),NOQ                                                        
         TM    CPXSTAT1,CPXMCAGY                                                
         JZ    EXITY                                                            
         MVI   0(R4),YESQ                                                       
         J     EXITY                                                            
         DROP  R2                                                               
*&&                                                                             
***********************************************************************         
* Currency List download                                              *         
***********************************************************************         
                                                                                
REQCURR  LKREQ H,A#CURR,OUTCURR,NEXTREQ=REQETYP                                 
                                                                                
*&&US                                                                           
Dummy    LKREQ F,01,(D,B#SAVED,QCLDUM),CHAR,OLEN=L'QCLDUM,             +        
               MAXLEN=L'QCLDUM,TEXT=AC#NOORD,COL=*                              
*&&                                                                             
*&&UK                                                                           
CType    LKREQ F,01,(D,B#SAVED,QCLTYP),CHAR,OLEN=L'QCLTYP,             +        
               MAXLEN=L'QCLTYP,TEXT=AC#TYPE,COL=*                               
                                                                                
*&&                                                                             
AllCur   LKREQ F,02,(D,B#SAVED,QCLALL),CHAR,OLEN=L'QCLALL,             +        
               MAXLEN=L'QCLALL,TEXT=AC#CURRY,COL=*                              
*&&UK                                                                           
Office   LKREQ F,03,(D,B#SAVED,QCLOFF),CHAR,OLEN=L'QCLOFF,             +        
               MAXLEN=L'QCLOFF,TEXT=AC#OFFC,COL=*                               
*&&                                                                             
         LKREQ E                                                                
                                                                                
OUTCURR  LKOUT H                                                                
                                                                                
CURLST   LKOUT R,R#CURR                                                         
Array    LKOUT C,R#CURR,(A,ARYCUR)                                              
         LKOUT E                                                                
                                                                                
         LKOUT X                                                                
                                                                                
ARYCUR   LKOUT A,(R,NXTCUR),MULTIROW=Y,ROWNAME=SAVED                            
ISOCod   LKOUT C,1,CL_CUR,CHAR,ND=Y                                             
Name     LKOUT C,2,CL_NAM,CHAR,ND=Y                                             
DecPlc   LKOUT C,3,CL_DEC,LBIN                                                  
Pos      LKOUT C,4,CL_POS,LBIN,ND=Y                                             
Rule     LKOUT C,5,CL_RUL,CHAR,ND=Y                                             
MinRte   LKOUT C,6,CL_MIN,HEXD,ND=Y                                             
MaxRte   LKOUT C,7,CL_MAX,HEXD,ND=Y                                             
Client   LKOUT C,8,CL_CLI,CHAR,ND=Y                                             
NoPro    LKOUT C,9,CL_NPC,CHAR,ND=Y                                             
         LKOUT E                                                                
                                                                                
NXTCUR   ST    R8,LP_ADATA                                                      
         CLI   LP_RMODE,LP_RFRST   TEST FIRST TIME                              
*&&UK*&& JNE   NXTCUR50                                                         
*&&US                                                                           
         JNE   NXTCUR90                                                         
                                                                                
* temporary for US beta                                                         
                                                                                
         MVC   CL_CUR,=C'USD'                     - PASS ISO CUR CODE           
         MVC   CL_NAM,=CL36'UNITED STATES DOLLAR' - CURRENCY NAME               
         MVI   CL_DEC,2                           - DECIMAL POSITIONS           
         MVI   CL_POS,1                           - POSITION                    
         MVC   WORK(7),=XL7'80000017448000'       - RULE                        
         GOTO1 VHEXOUT,DMCB,WORK,CL_RUL,7,0                                     
         XC    CL_MIN,CL_MIN                                                    
         XC    CL_MAX,CL_MAX                                                    
         J     EXITY                                                            
*&&                                                                             
*&&UK                                                                           
         MVI   BYTE1,0                                                          
         MVI   BYTE2,0                                                          
         MVC   X#LANG,CULANG                                                    
         CLI   X#LANG,0                                                         
         JH    *+8                                                              
         MVI   X#LANG,LANGEUK                                                   
*                                                                               
         XC    CL_VALS(CL_LNQ),CL_VALS                                          
         MVC   D_CURR,AGYCURR                                                   
*                                                                               
         TM    CPXSTAT1,CPXMCAGY   Multi curr agency                            
         JZ    NXTCUR04                                                         
         CLC   QCLOFF,SPACES       Any office supplied?                         
         JNH   NXTCUR04                                                         
         USING OFFRECD,R2                                                       
         LA    R2,IOKEY                                                         
         MVC   OFFKEY,SPACES                                                    
         MVI   OFFKTYP,OFFKTYPQ                                                 
         MVC   OFFKCPY,CUXCPY                                                   
         MVC   OFFKOFF,QCLOFF                                                   
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
         JE    *+14                                                             
         MVC   ROUERRV,=AL2(AE$IVOFF) Invalid office passed                     
         J     EXITN                                                            
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
         JNE   *+2                                                              
         L     R2,AIO1                                                          
         LA    RF,OFFRFST                                                       
*                                                                               
         USING OFIELD,RF                                                        
NXTCUR00 CLI   OFIEL,0                                                          
         JE    NXTCUR04                                                         
         CLI   OFIEL,OFIELQ                                                     
         JE    NXTCUR02                                                         
         LLC   R0,OFILN                                                         
         AR    RF,R0                                                            
         J     NXTCUR00                                                         
*                                                                               
NXTCUR02 CLI   OFILN,OFILNQ        Check el is long enough                      
         JNH   NXTCUR04                                                         
         CLC   OFICUR,SPACES       Any currency?                                
         JNH   NXTCUR04                                                         
         MVC   D_CURR,OFICUR       Extract office currency                      
         DROP  RF                                                               
*                                                                               
         USING GCURD,R2            R3=A(KEY)                                    
NXTCUR04 LA    R2,IOKEY                                                         
         XC    GCKEY,GCKEY                                                      
         MVI   GCKREC,GCKRECQ                                                   
         MVC   GCKCURU,AGYCURR                                                  
         MVC   CSVKEY1,GCKEY                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IOGND+IO1'                               
         JNE   NXTCUR10                                                         
         CLC   GCKEY(GCKCURX-GCURD),CSVKEY1                                     
         JNE   NXTCUR10                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOGNF+IO1'                              
         JNE   *+2                                                              
         L     R2,AIO1                                                          
         AHI   R2,GCFIRST                                                       
         USING GCREL,R2                                                         
                                                                                
NXTCUR06 CLI   GCREL,0                                                          
         JE    NXTCUR10                                                         
         CLI   GCREL,GCRELQ                                                     
         JE    NXTCUR08                                                         
         LLC   R0,GCRLEN                                                        
         AR    R2,R0                                                            
         J     NXTCUR06                                                         
                                                                                
NXTCUR08 MVC   CURMIN,GCRMNEXC                                                  
         MVC   CURMAX,GCRMXEXC                                                  
         TM    CPXSTAT1,CPXMCAGY   Multi curr agency                            
         JZ    NXTCUR10                                                         
         CLC   QCLOFF,SPACES      If office is passed then it is exp            
         JH    *+12                                                             
         CLI   QCLTYP,QCLEXP                                                    
         JNE   NXTCUR10                                                         
         MVC   CL_DEC,GCRDECP                                                   
         MVC   CL_NAM,SPACES                                                    
         MVC   CL_CUR,AGYCURR                                                   
         MVI   BYTE1,1                                                          
         LLC   RE,GCRLEN                                                        
         SHI   RE,GCRLENQ+1                                                     
         LTR   RE,RE                                                            
         JM    NXTCUR10                                                         
         BASR  RF,0                                                             
         EX    RE,4(RF)                                                         
         MVC   CL_NAM(0),GCRNAME                                                
         DROP  R2                                                               
                                                                                
NXTCUR10 CLI   QCLTYP,QCLINV      For invoices and expenses don't               
         JE    NXTCUR44            get client exchange rates                    
         CLI   QCLTYP,QCLEXP                                                    
         JE    NXTCUR44                                                         
                                                                                
         USING CLRTABD,R3                                                       
         L     R3,AIO3             Use AIO3-AIO8 for client levels              
         XC    CLRTCUR(CURTABL),CLRTCUR                                         
         LHI   R0,((8+1-3)*IOLENQ)-(CLRTABL+1)     (12K should do)              
         MVI   CURIND,0                                                         
                                                                                
         USING GEXCD,R2                                                         
         LA    R2,IOKEY                                                         
         XC    GEKEY,GEKEY                                                      
         MVI   GEKREC,GEKRECQ                                                   
         MVC   GEKAGY,CUAALF                                                    
         MVI   GEKSYS,ACCSYSQ                                                   
         MVC   CSVKEY1,GEKEY                                                    
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IOGND+IO1'                               
         JNE   NXTCURN2                                                         
         J     NXTCUR14                                                         
                                                                                
NXTCUR12 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IOGND+IO1'                               
                                                                                
NXTCUR14 CLC   GEKEY(GEKCURF-GEKEY),CSVKEY1                                     
         JNE   NXTCUR24                                                         
         CLI   GEKACT,X'41'                                                     
         JNH   NXTCUR12                                                         
         CLC   GEKACT,FFS                                                       
         JE    NXTCUR12                                                         
         CLC   GEKPEND,D_TODAYC                                                 
         JL    NXTCUR12                                                         
         CLC   GEKPSTA,D_TODAYC                                                 
         JH    NXTCUR12                                                         
         CLC   GEKCURF,D_CURR                                                   
         JNE   NXTCUR12                                                         
NXTCUR16 MVC   FULL1(3),GEKCURF                                                 
         CLC   GEKCURF,D_CURR                                                   
         JNE   NXTCUR18                                                         
         MVC   FULL1(3),GEKCURT                                                 
                                                                                
DUP      USING CLRTABD,RF                                                       
NXTCUR18 L     RF,AIO3             skip duplicate entries                       
                                                                                
NXTCUR20 CLI   DUP.CLRTCUR,0                                                    
         JE    NXTCUR22                                                         
         CLC   DUP.CLRTCUR,FULL1                                                
         JE    NXTCUR12                                                         
         AHI   RF,CLRTABL                                                       
         J     NXTCUR20                                                         
         DROP  DUP                                                              
                                                                                
NXTCUR22 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOGNF+IO1'                              
         JNE   *+2                                                              
                                                                                
         MVC   CLRTCUR,FULL1                                                    
         MVC   CLRTCLI,GEKACT                                                   
         AHI   R3,CLRTABL                                                       
         XC    CLRTCUR(CURTABL),CLRTCUR                                         
         SHI   R0,CLRTABL                                                       
         LTR   R0,R0               table size exceeded                          
         JNP   NXTCURN2                                                         
         J     NXTCUR12                                                         
         DROP  R2                                                               
                                                                                
NXTCUR24 L     R3,AIO3             all client data read - get details           
                                                                                
         USING GCURD,R2                                                         
NXTCUR26 LA    R2,IOKEY                                                         
         XC    GCKEY,GCKEY                                                      
         MVI   GCKREC,GCKRECQ                                                   
         MVC   GCKCURU,CLRTCUR                                                  
         MVC   CSVKEY1,GCKEY                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IOGND+IO1'                               
         JNE   NXTCUR40                                                         
         CLC   GCKEY(GCKCURX-GCURD),CSVKEY1                                     
         JNE   NXTCUR40                                                         
         TM    GCDSTAT,GCDSPROD    Production currencies only                   
         JZ    NXTCUR40                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOGNF+IO1'                              
         JNE   *+2                                                              
         L     R2,AIO1                                                          
         AHI   R2,GCFIRST                                                       
         USING GCREL,R2                                                         
         MVI   BYTE3,NOQ                                                        
                                                                                
NXTCUR28 CLI   GCREL,0                                                          
         JE    NXTCUR36                                                         
         CLI   GCREL,GCRELQ                                                     
         JE    NXTCUR32                                                         
         CLI   GCREL,GDDELQ                                                     
         JE    NXTCUR34                                                         
                                                                                
NXTCUR30 LLC   R0,GCRLEN                                                        
         AR    R2,R0                                                            
         J     NXTCUR28                                                         
                                                                                
NXTCUR32 MVI   BYTE3,YESQ                                                       
         MVC   CLRTDPL,GCRDECP                                                  
         MVC   CLRTMIN,GCRMNEXC                                                 
         MVC   CLRTMAX,GCRMXEXC                                                 
         MVC   CLRTNAM,SPACES                                                   
         LLC   RE,GCRLEN                                                        
         SHI   RE,GCRLENQ+1                                                     
         LTR   RE,RE                                                            
         JM    NXTCUR40                                                         
         BASR  RF,0                                                             
         EX    RE,4(RF)                                                         
         MVC   CLRTNAM(0),GCRNAME                                               
         J     NXTCUR30                                                         
                                                                                
NXTCUR34 OC    GDDICT,GDDICT       DDBLDCUR.BLD5 for language - get             
         JZ    NXTCUR30            language name via DICTATE                    
         XC    TEMP,TEMP                                                        
         MVI   TEMP,DD#ESCL                                                     
         MVC   TEMP+1(L'GDDICT),GDDICT                                          
         MVI   TEMP+1+L'GDDICT,L'CURTLONG                                       
         LARL  RE,DDSTRNG                                                       
         ICM   RF,B'1111',0(RE)                                                 
         ICM   RF,B'0001',X#LANG                                                
         GOTOX VDICTATE,DMCB,(RF),TEMP                                          
         MVC   CLRTNAM,TEMP                                                     
         J     NXTCUR30                                                         
         DROP  R2                                                               
                                                                                
NXTCUR36 CLI   BYTE3,YESQ                                                       
         JNE   NXTCUR40                                                         
                                                                                
         USING EURKBLKD,R2                                                      
         L     R2,AIO1             read for rate                                
         XC    0(EURKBLKL,R2),0(R2)                                             
         MVC   EURKCUFR,D_CURR                                                  
         MVC   EURKCUTO,CLRTCUR                                                 
         MVC   EURKALPH,CUAALF                                                  
         MVC   EURKDATE,D_TODAYC                                                
         MVC   EURKACT,CLRTCLI                                                  
         MVC   EURKAFAC,ACOMFACS                                                
         MVI   EURKTYPE,ACCQ                                                    
         TM    CPYSTAT6,CPYSFTXR                                                
         JZ    NXTCUR38                                                         
         OI    EURKTYPE,ALLOWFTQ+SWAPQ                                          
                                                                                
NXTCUR38 GOTO1 VEUREKA,DMCB,('GETQ',EURKBLKD)                                   
         CLI   0(R1),0                                                          
         JNE   NXTCUR40                                                         
         MVC   CLRTRUL,EURKRULE                                                 
         OI    CURIND,CURICLI                                                   
         J     NXTCUR42                                                         
                                                                                
NXTCUR40 MVI   CLRTCUR,FF          set to skip                                  
                                                                                
NXTCUR42 AHI   R3,CLRTABL          next entry                                   
         CLI   CLRTCUR,0                                                        
         JE    NXTCUR44                                                         
         J     NXTCUR26                                                         
         DROP  R3                                                               
                                                                                
         USING INFOD,R2                                                         
         USING LISTTABD,R3                                                      
NXTCUR44 L     R2,AIO1             USE IO1 TO BUILD PARAMETERS                  
         L     R3,AGENAREA         USE GENEAREA FOR OUTPUT                      
*                                                                               
         LR    R0,R3               clear data output area                       
         LHI   R1,GENAREAX-GENAREA-1                                            
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
         MVC   INFODAT,D_TODAYC    - USE TODAY'S DATE FOR LIST                  
         MVC   INFOALP,CUAALF      - ALPHA ID                                   
         MVC   INFOCUR,AGYCURR     - AND AGENCY'S CURRENCY                      
         MVI   INFOFLG,0           - FT/DE RATE FLAG                            
         TM    CPYSTAT6,CPYSFTXR                                                
         JZ    *+8                                                              
         OI    INFOFLG,ALLOWFTQ    NOW CALL MODULE FOR LIST                     
         GOTO1 VGETCRL,DMCB,INFOD,LISTTABD,(X#LANG,ACOMFACS)                    
         CLI   0(R1),0             ANY ERRORS?                                  
         JE    NXTCUR46                                                         
         CLI   0(R1),EMPTYQ        IS IT AN EMPTY LIST?                         
         JNE   NXTCURN1                                                         
         XC    ACURLIST,ACURLIST                                                
         TM    CURIND,CURICLI      any client level rates?                      
         JNZ   NXTCUR48                                                         
         MVI   LP_RMODE,LP_RLAST                                                
         J     EXITY                                                            
                                                                                
NXTCUR46 OI    CURIND,CURICRL      GETCRL returned data                         
*                                                                               
NXTCUR48 TM    CURIND,CURICLI      any client level found?                      
         JZ    NXTCUR62                                                         
         L     R3,AIO3                                                          
         ST    R3,ACURLIST                                                      
         OI    CURIND,CURIMOD                                                   
         MVI   LP_RMODE,LP_RNEXT                                                
         CLI   BYTE1,1                                                          
         JE    EXITY                                                            
                                                                                
NXTCUR50 DS    0H                                                               
*&&UK                                                                           
         TM    CURIND,CURIOFC      Have we printed out office currency          
         JNZ   NXTCUR56                                                         
         OI    CURIND,CURIOFC                                                   
         CLC   D_CURR,AGYCURR      Do we have an office currency?               
         JE    NXTCUR56                                                         
*                                                                               
         XC    CL_VALS(CL_LNQ),CL_VALS                                          
         USING GCURD,R2            R3=A(KEY)                                    
         LA    R2,IOKEY                                                         
         XC    GCKEY,GCKEY                                                      
         MVI   GCKREC,GCKRECQ                                                   
*                                                                               
         MVC   GCKCURU,D_CURR                                                   
         MVC   CSVKEY1,GCKEY                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IOGND+IO1'                               
         JNE   NXTCUR56                                                         
         CLC   GCKEY(GCKCURX-GCURD),CSVKEY1                                     
         JNE   NXTCUR56                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOGNF+IO1'                              
         JNE   *+2                                                              
         L     R2,AIO1                                                          
         AHI   R2,GCFIRST                                                       
         USING GCREL,R2                                                         
                                                                                
NXTCUR52 CLI   GCREL,0                                                          
         JE    NXTCUR44                                                         
         CLI   GCREL,GCRELQ                                                     
         JE    NXTCUR54                                                         
         LLC   R0,GCRLEN                                                        
         AR    R2,R0                                                            
         J     NXTCUR52                                                         
                                                                                
NXTCUR54 MVC   CURMIN,GCRMNEXC                                                  
         MVC   CURMAX,GCRMXEXC                                                  
         MVC   CL_DEC,GCRDECP                                                   
         MVC   CL_NAM,SPACES                                                    
         MVC   CL_CUR,D_CURR                                                    
         MVI   BYTE1,1                                                          
         LLC   RE,GCRLEN                                                        
         SHI   RE,GCRLENQ+1                                                     
         LTR   RE,RE                                                            
         JM    NXTCUR44                                                         
         BASR  RF,0                                                             
         EX    RE,4(RF)                                                         
         MVC   CL_NAM(0),GCRNAME                                                
         J     NXTCUR44                                                         
         DROP  R2                                                               
*&&                                                                             
NXTCUR56 TM    CURIND,CURIALL      all mode now?                                
         JNZ   NXTCUR74                                                         
                                                                                
         TM    CURIND,CURIMOD      client level data mode?                      
         JZ    NXTCUR64                                                         
                                                                                
         USING CLRTABD,R3                                                       
         XC    CL_VALS(CL_LNQ),CL_VALS                                          
         L     R3,ACURLIST                                                      
         MVC   CL_CUR,CLRTCUR                                                   
         MVC   CL_CLI,CLRTCLI                                                   
         MVC   CL_NAM,CLRTNAM                                                   
         GOTO1 VHEXOUT,DMCB,CLRTRUL,CL_RUL,L'CLRTRUL,0                          
                                                                                
         ZAP   PKWK16A,PZERO       Divide by agency currency                    
         MVO   PKWK16A,CLRTMIN      to get min max for agency currency          
         SRP   PKWK16A,10,0                                                     
         ZAP   PKWK16B,PZERO                                                    
         MVO   PKWK16B,CLRTMAX                                                  
         SRP   PKWK16B,10,0                                                     
*                                                                               
         ZAP   PKWK6,PZERO                                                      
         MVO   PKWK6,CURMAX                                                     
         DP    PKWK16A,PKWK6                                                    
         ZAP   PKWK6,PZERO                                                      
         MVO   PKWK6,CURMIN                                                     
         DP    PKWK16B,PKWK6                                                    
         MVC   CL_MIN,PKWK16A+(L'PKWK16A-L'PKWK6)-8                             
         MVC   CL_MAX,PKWK16B+(L'PKWK16B-L'PKWK6)-8                             
         MVC   CL_DEC,CLRTDPL                                                   
         AHI   R3,CLRTABL                                                       
                                                                                
NXTCUR58 CLI   CLRTCUR,FF                                                       
         JNE   NXTCUR60                                                         
         AHI   R3,CLRTABL                                                       
         J     NXTCUR58                                                         
                                                                                
NXTCUR60 ST    R3,ACURLIST                                                      
         MVI   LP_RMODE,LP_RNEXT                                                
         CLI   CLRTCUR,0           TEST EOT                                     
         JNE   EXITY                                                            
         DROP  R3                                                               
                                                                                
         USING LISTTABD,R3                                                      
         NI    CURIND,FF-CURIMOD   change mode                                  
         TM    CURIND,CURICRL      GETCRL to be processed?                      
         JZ    NXTCUR72                                                         
         L     R3,AGENAREA                                                      
         ST    R3,ACURLIST                                                      
         J     EXITY                                                            
                                                                                
NXTCUR62 ST    R3,ACURLIST                                                      
         MVI   LP_RMODE,LP_RNEXT                                                
         CLI   BYTE1,1                                                          
         JE    EXITY                                                            
                                                                                
NXTCUR64 XC    CL_VALS(CL_LNQ),CL_VALS                                          
         L     R3,ACURLIST                                                      
NXTCUR66 OC    LISTCUR,LISTCUR     TEST EOT                                     
         JZ    NXTCUR72                                                         
         CLC   LISTCUR,D_CURR      Skip office currency                         
         JNE   NXTCUR68                                                         
         AHI   R3,LISTLNQ                                                       
         J     NXTCUR66                                                         
                                                                                
NXTCUR68 MVC   CL_CUR,LISTCUR      - PASS ISO CURRENCY CODE                     
         MVC   CL_NAM,LISTNAM      - PASS CURRENCY'S NAME                       
         GOTO1 VHEXOUT,DMCB,LISTRUL,CL_RUL,L'LISTRUL,0                          
                                                                                
         ZAP   PKWK16A,PZERO       Divide by agency currency                    
         MVO   PKWK16A,LISTMIN      to get min max for agency currency          
         SRP   PKWK16A,10,0                                                     
         ZAP   PKWK16B,PZERO                                                    
         MVO   PKWK16B,LISTMAX                                                  
         SRP   PKWK16B,10,0                                                     
*                                                                               
         ZAP   PKWK6,PZERO                                                      
         MVO   PKWK6,CURMAX                                                     
         DP    PKWK16A,PKWK6                                                    
         ZAP   PKWK6,PZERO                                                      
         MVO   PKWK6,CURMIN                                                     
         DP    PKWK16B,PKWK6                                                    
         MVC   CL_MIN,PKWK16A+(L'PKWK16A-L'PKWK6)-8                             
         MVC   CL_MAX,PKWK16B+(L'PKWK16B-L'PKWK6)-8                             
         MVC   CL_DEC,LISTDPL                                                   
         LLC   R1,BYTE2                                                         
         AHI   R1,1                                                             
         STC   R1,BYTE2                                                         
         MVC   CL_POS,BYTE2                                                     
                                                                                
NXTCUR70 AHI   R3,LISTLNQ                                                       
         ST    R3,ACURLIST                                                      
         MVI   LP_RMODE,LP_RNEXT                                                
         J     EXITY                                                            
                                                                                
NXTCUR72 CLI   QCLALL,ALLQ         pass none production currencies?             
         JNE   NXTCUR90                                                         
                                                                                
         OI    CURIND,CURIALL      set new mode                                 
                                                                                
         USING GCURD,R2                                                         
         LA    R2,IOKEY                                                         
         XC    GCKEY,GCKEY                                                      
         MVI   GCKREC,GCKRECQ                                                   
         MVC   GCKCURU,SPACES                                                   
         MVC   CSVKEY1,GCKEY                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IOGND+IO1'                               
         JNE   *+2                                                              
         J     NXTCUR78                                                         
                                                                                
NXTCUR74 MVC   IOKEY,CSVKEY2                                                    
                                                                                
NXTCUR76 LA    R2,IOKEY                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IOGND+IO1'                               
         JNE   *+2                                                              
                                                                                
NXTCUR78 CLC   GCKEY(GCKCURR-GCURD),CSVKEY1                                     
         JNE   NXTCUR90                                                         
         TM    GCDSTAT,GCDSPROD    None production currencies only              
         JNZ   NXTCUR76                                                         
         CLC   GCKCURU,D_CURR      skip office currency                         
         JE    NXTCUR76                                                         
         XC    CL_VALS(CL_LNQ),CL_VALS                                          
         XR    RF,RF              Skip for BO causes initial to fail            
         ICM   RF,3,CUXPNUM                                                     
         CHI   RF,XPRODIKQ                                                      
         JNE   *+8                                                              
         MVI   CL_NPC,YESQ                                                      
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOGNF+IO1'                              
         JNE   *+2                                                              
         L     R2,AIO1                                                          
         AHI   R2,GCFIRST                                                       
         USING GCREL,R2                                                         
                                                                                
NXTCUR80 CLI   GCREL,0                                                          
         JE    NXTCUR88                                                         
         CLI   GCREL,GCRELQ                                                     
         JE    NXTCUR84                                                         
         CLI   GCREL,GDDELQ                                                     
         JE    NXTCUR86                                                         
                                                                                
NXTCUR82 LLC   R0,GCRLEN                                                        
         AR    R2,R0                                                            
         J     NXTCUR80                                                         
                                                                                
NXTCUR84 MVC   CL_DEC,GCRDECP                                                   
***      CL_MIN, CL_MAX, CL_POS, CL_RUL and CL_CLI n/a                          
         MVC   CL_NAM,SPACES                                                    
         LLC   RE,GCRLEN                                                        
         SHI   RE,GCRLENQ+1                                                     
         LTR   RE,RE                                                            
         JM    NXTCUR76                                                         
         BASR  RF,0                                                             
         EX    RE,4(RF)                                                         
         MVC   CL_NAM(0),GCRNAME                                                
         J     NXTCUR82                                                         
                                                                                
NXTCUR86 OC    GDDICT,GDDICT       DDBLDCUR.BLD5 for language - get             
         JZ    NXTCUR82            language name via DICTATE                    
         XC    TEMP,TEMP                                                        
         MVI   TEMP,DD#ESCL                                                     
         MVC   TEMP+1(L'GDDICT),GDDICT                                          
         MVI   TEMP+1+L'GDDICT,L'CURTLONG                                       
         LARL  RE,DDSTRNG                                                       
         ICM   RF,B'1111',0(RE)                                                 
         ICM   RF,B'0001',X#LANG                                                
         GOTOX VDICTATE,DMCB,(RF),TEMP                                          
         MVC   CL_NAM,TEMP                                                      
         J     NXTCUR82                                                         
                                                                                
NXTCUR88 MVC   CSVKEY2,IOKEY                                                    
         MVI   LP_RMODE,LP_RNEXT                                                
         J     EXITY                                                            
         DROP  R2                                                               
*&&                                                                             
                                                                                
NXTCUR90 MVI   LP_RMODE,LP_RLAST   END OF LIST                                  
         J     EXITY                                                            
                                                                                
*UPOSTAB DC    0XL4                (SEE ACPRF04)                                
*        DC    CL3'USD',XL1'01',X'00'                                           
*        DC    CL3'EUR',XL1'02',X'00'  (CAN ONLY BE EITHER GBP OR EUR)          
*        DC    CL3'GBP',XL1'02',X'00'                                           
*        DC    CL3'AUD',XL1'03',X'00'                                           
*        DC    CL3'CAD',XL1'04',X'00'                                           
*        DC    CL3'CHF',XL1'05',X'00'                                           
*        DC    CL3'CSK',XL1'06',X'00'                                           
*        DC    CL3'DKK',XL1'07',X'00'                                           
*        DC    CL3'HKD',XL1'08',X'00'                                           
*        DC    CL3'JPY',XL1'09',X'00'                                           
*        DC    CL3'NOK',XL1'09',X'00'                                           
*        DC    CL3'NZD',XL1'0A',X'00'                                           
*        DC    CL3'SGD',XL1'0B',X'00'                                           
*        DC    CL3'ZAR',XL1'0C',X'00'                                           
*        DC    X'FF'                                                            
                                                                                
NXTCURN1 MVC   LP_ERROR,=AL2(AE$INCUR)   currency error                         
         J     NXTCURN                                                          
NXTCURN2 MVC   LP_ERROR,=AL2(AE$TMIDT)   tabel full error                       
NXTCURN  J     QERROR                                                           
         DROP  R3                                                               
                                                                                
         DS    0H                                                               
DDSTRNG  DC    CL2'SL',XL2'0F00'                                                
         DS    0H                                                               
                                                                                
CLRTABD  DSECT                                                                  
CLRTCUR  DS    CL3                 (0=EoT, FF=Skip)                             
CLRTCLI  DS    CL5                                                              
CLRTNAM  DS    CL35                CURRENCY NAME                                
CLRTDPL  DS    XL1                 DECIMAL PLACES                               
CLRTRUL  DS    0PL7                SEE DDEUREKAD)                               
CLRTEST  DS    CL1                 EXCHANGE STATUS                              
CLRTEXR  DS    PL5                 EXCHANGE RATE                                
CLRTESH  DS    CL1                 EXCHANGE SHIFT VALUE                         
CLRTMIN  DS    CL5                 MIN VALID EXCH RATE (CURR RECORD)            
CLRTMAX  DS    CL5                 MAX VALID EXCH RATE (CURR RECORD)            
CLRTABL  EQU   *-CLRTABD                                                        
                                                                                
SVRDEF   CSECT ,                                                                
***********************************************************************         
* Expenditure Type list download  (new, 71)                           *         
***********************************************************************         
                                                                                
REQETYP  LKREQ H,A#ETYP,OUTETYP,NEXTREQ=REQETYL                                 
                                                                                
Applic   LKREQ F,01,(D,B#SAVED,QAPPL),CHAR,OLEN=L'QAPPL,               +        
               MAXLEN=L'QAPPL,TEXT=(*,APPLLIT),COL=*                            
                                                                                
OType    LKREQ F,02,(D,B#SAVED,QOTYP),CHAR,OLEN=L'QOTYP,               +        
               MAXLEN=L'QOTYP,TEXT=(*,OTYPLIT),COL=*                            
                                                                                
Suppl    LKREQ F,03,(D,B#SAVED,QSUPPC),CHAR,OLEN=L'QSUPPC,             +        
               MAXLEN=L'QSUPPC,TEXT=AC#SUPC,COL=*                               
                                                                                
Bill     LKREQ F,04,(D,B#SAVED,QBILL),CHAR,OLEN=L'QBILL,               +        
               MAXLEN=L'QBILL,TEXT=(*,OTYPLIT),COL=*                            
                                                                                
NBil     LKREQ F,05,(D,B#SAVED,QNBIL),CHAR,OLEN=L'QNBIL,               +        
               MAXLEN=L'QNBIL,TEXT=(*,OTYPLIT),COL=*                            
                                                                                
         LKREQ E                                                                
                                                                                
OUTETYP  LKOUT H                                                                
                                                                                
ETYPLS   LKOUT R,R#ETYP                                                         
Array    LKOUT C,R#ETYP,(A,ARYETYP)                                             
                                                                                
         LKOUT E                                                                
                                                                                
         LKOUT X                                                                
                                                                                
ARYETYP  LKOUT A,(R,NXTETYP),MULTIROW=Y,ROWNAME=ETYRECD                         
Code     LKOUT C,1,ETYKCODE,CHAR,ND=Y                                           
Name     LKOUT C,2,(A,ARYNAM)                                                   
Lock     LKOUT C,3,ETYRSTAT,(R,EDTLOCK)                                         
Cat      LKOUT C,4,(A,ARYCAT)                                                   
Bill     LKOUT C,5,ETYRSTA2,(R,EDTBIL)                                          
Nbill    LKOUT C,6,ETYRSTA2,(R,EDTNBL)                                          
Adv      LKOUT C,7,ETYRSTA2,(R,EDTADV)                                          
ForNam   LKOUT C,8,(A,ARYFNAM)                                                  
*&&UK                                                                           
VAT      LKOUT C,9,(A,ARYSPA)                                                   
*&&                                                                             
VAT      LKOUT C,9,(A,ARYFFT)                                                   
LkOrd    LKOUT C,13,ETYRSAPP,(R,EDTLOR)                                         
LkExp    LKOUT C,14,ETYRSAPP,(R,EDTLEX)                                         
LkInv    LKOUT C,15,ETYRSAPP,(R,EDTLIN)                                         
SlfAp    LKOUT C,16,ETYRSTA2,(R,EDTSLF)                                         
Array    LKOUT C,R#ETEX,(A,ARYEXP)                                              
Array    LKOUT C,R#ETSU,(A,ARYSUP)                                              
Array    LKOUT C,R#ETWC,(A,ARYWC)                                               
*&&US                                                                           
Array    LKOUT C,R#ETPR,(A,ARYPRV)                                              
*&&                                                                             
         LKOUT E                                                                
                                                                                
ARYNAM   LKOUT A,(D,B#ETYREC,ETYRFST),EOT=EOR,ROWID=(NAMELD,NAMELQ),   +        
               ROWWIDTH=(V,NAMLN)                                               
Name     LKOUT C,2,NAMEREC,CHAR,LEN=V                                           
                                                                                
         LKOUT E                                                                
                                                                                
ARYCAT   LKOUT A,(D,B#ETYREC,ETYRFST),EOT=EOR,ROWID=(XNMELD,XNMELQ),   +        
               ROWWIDTH=(V,XNMLN)                                               
Catgry   LKOUT C,4,XNMSUBN,CHAR,LEN=V                                           
                                                                                
         LKOUT E                                                                
                                                                                
ARYFNAM  LKOUT A,(D,B#ETYREC,ETYRFST),EOT=EOR,ROWID=(ENMELD,ENMELQ),   +        
               ROWWIDTH=(V,ENMLN)                                               
ForNam   LKOUT C,8,ENMNAME,CHAR,LEN=V                                           
                                                                                
         LKOUT E                                                                
                                                                                
ARYSPA   LKOUT A,(D,B#ETYREC,ETYRFST),EOT=EOR,ROWID=(SPAELD,SPAELQ),   +        
               ROWWIDTH=(V,SPALN)                                               
PRout    LKOUT P,SPATYPE,SETTYPE                                                
VatAcc   LKOUT C,10,SPAAACT,CHAR,ND=Y,FILTROUT=TSTTITAX,SKIPCOLS=2              
PRout    LKOUT P,SPAAACT,PRVATAC                                                
VatRate  LKOUT C,11,(D,B#SAVED,EL_VRAT),CHAR,ND=Y                               
VatName  LKOUT C,12,(D,B#SAVED,EL_VNAM),CHAR,ND=Y                               
                                                                                
                                                                                
         LKOUT E                                                                
                                                                                
ARYFFT   LKOUT A,(D,B#ETYREC,ETYRFST),EOT=EOR,ROWID=(FFTELD,FFTELQ),   +        
               ROWWIDTH=(V,FFTLN)                                               
PRout    LKOUT P,FFTTYPE,SETTYPE                                                
VatCode  LKOUT C,9,FFTDATA,CHAR,ND=Y,FILTROUT=TSTTVATC,SKIPCOLS=2               
PRout    LKOUT P,FFTDATA,PRVATCD                                                
VatRate  LKOUT C,11,(D,B#SAVED,EL_VRAT),CHAR,ND=Y                               
VatName  LKOUT C,12,(D,B#SAVED,EL_VNAM),CHAR,ND=Y                               
                                                                                
         LKOUT E                                                                
                                                                                
ARYEXP   LKOUT A,(D,B#ETYREC,ETYRFST),NEWEL=B,EOT=EOR,                 +        
               ROWID=(LIDEL,LIDELQ),ROWWIDTH=(V,LIDLN)                          
                                                                                
PRout    LKOUT P,LIDTYPE,SETTYPE                                                
Array    LKOUT C,R#ETEX,(A,ARYIEXP),FILTROUT=TSTTEXPS                           
                                                                                
         LKOUT E                                                                
                                                                                
ARYIEXP  LKOUT A,(*,LIDDATA),ROWNAME=LIDEL,NROWS=*,ROWWIDTH=L'ACTKULA, +        
               NEWEL=B                                                          
PRout    LKOUT P,LIDDATA,SETDEF                                                 
PRout    LKOUT P,LIDDATA,SETUPR                                                 
PRout    LKOUT P,LIDDATA,EXTACT                                                 
Array    LKOUT C,R#ETEX,(A,ARYEXAC)                                             
                                                                                
         LKOUT E                                                                
                                                                                
ARYSUP   LKOUT A,(D,B#ETYREC,ETYRFST),NEWEL=B,EOT=EOR,                 +        
               ROWID=(LIDEL,LIDELQ),ROWWIDTH=(V,LIDLN)                          
                                                                                
PRout    LKOUT P,LIDTYPE,SETTYPE                                                
Array    LKOUT C,R#ETSU,(A,ARYISUP),FILTROUT=TSTTSUPP                           
                                                                                
         LKOUT E                                                                
                                                                                
ARYISUP  LKOUT A,(*,LIDDATA),ROWNAME=LIDEL,NROWS=*,ROWWIDTH=L'ACTKULA, +        
               NEWEL=N                                                          
PRout    LKOUT P,LIDDATA,SETDEF                                                 
PRout    LKOUT P,LIDDATA,SETUPR                                                 
PRout    LKOUT P,LIDDATA,EXTACT                                                 
Array    LKOUT C,R#ETSU,(A,ARYSUAC)                                             
                                                                                
         LKOUT E                                                                
                                                                                
ARYWC    LKOUT A,(D,B#ETYREC,ETYRFST),NEWEL=B,EOT=EOR,                 +        
               ROWID=(LIDEL,LIDELQ),ROWWIDTH=(V,LIDLN)                          
                                                                                
PRout    LKOUT P,LIDTYPE,SETTYPE                                                
Array    LKOUT C,R#ETWC,(A,ARYIWC),FILTROUT=TSTTWKCD                            
                                                                                
         LKOUT E                                                                
                                                                                
ARYIWC   LKOUT A,(*,LIDDATA),ROWNAME=LIDEL,NROWS=*,ROWWIDTH=L'WCOKWRK, +        
               NEWEL=B                                                          
Def      LKOUT C,1,LIDDATA,(R,EDTDEF),FILTROUT=TSTINWRK,SKIPCOLS=4              
PRout    LKOUT P,LIDDATA,SETUPR                                                 
WC       LKOUT C,2,LIDDATA,CHAR,LEN=L'WCOKWRK                                   
PRout    LKOUT P,LIDDATA,EXTWRKCD                                               
Array    LKOUT C,3,(A,ARYWKCD)                                                  
                                                                                
         LKOUT E                                                                
*&&US                                                                           
ARYPRV   LKOUT A,(D,B#ETYREC,ETYRFST),NEWEL=B,EOT=EOR,                 +        
               ROWID=(LIDEL,LIDELQ),ROWWIDTH=(V,LIDLN)                          
                                                                                
PRout    LKOUT P,LIDTYPE,SETTYPE                                                
Array    LKOUT C,R#ETPR,(A,ARYIPR),FILTROUT=TSTTPROV                            
                                                                                
         LKOUT E                                                                
                                                                                
ARYIPR   LKOUT A,(*,LIDDATA),ROWNAME=LIDEL,NROWS=*,ROWWIDTH=LIDGSTLQ,  +        
               NEWEL=B                                                          
PrvCod   LKOUT C,1,LIDGPROV,CHAR,LEN=L'LIDGPROV                                 
PRout    LKOUT P,LIDGPROV,GETPRVNM                                              
PrvNam   LKOUT C,2,(D,B#SAVED,EL_PRVNM),CHAR,ND=Y                               
PRout    LKOUT P,LIDGPROV,SETPST                                                
PstCod   LKOUT C,3,(D,B#SAVED,EL_PSTCD),CHAR,ND=Y                               
PstNam   LKOUT C,4,(D,B#SAVED,EL_PSTNM),CHAR,ND=Y                               
PstRat   LKOUT C,5,(D,B#SAVED,EL_PSTRT),CHAR,ND=Y                               
                                                                                
         LKOUT E                                                                
*&&                                                                             
ARYEXAC  LKOUT A,(R,NXTACT),MULTIROW=Y,ROWNAME=ACTRECD                          
                                                                                
Def      LKOUT C,1,(D,B#SAVED,EL_DEFSU),CHAR                                    
ExpAcc   LKOUT C,2,ACTKULA,CHAR,LEN=L'ACTKULA                                   
Array    LKOUT C,3,(A,ARYACNM)                                                  
Array    LKOUT C,4,(A,ARYXNM)                                                   
Array    LKOUT C,5,(A,ARYRSTE)                                                  
                                                                                
         LKOUT E                                                                
                                                                                
ARYACNM  LKOUT A,(D,B#ACTREC,ACTRFST),EOT=EOR,                         +        
               ROWID=(NAMEL,NAMELQ),ROWWIDTH=(V,NAMLN)                          
                                                                                
Actname  LKOUT C,3,NAMEREC,CHAR,LEN=V                                           
                                                                                
         LKOUT E                                                                
                                                                                
ARYXNM   LKOUT A,(D,B#ACTREC,ACTRFST),EOT=EOR,ROWID=(XNMELD,XNMELQ),   +        
               ROWWIDTH=(V,XNMLN)                                               
ForNam   LKOUT C,4,XNMSUBN,CHAR,LEN=V                                           
                                                                                
         LKOUT E                                                                
                                                                                
ARYRSTE  LKOUT A,(D,B#ACTREC,ACTRFST),EOT=EOR,ROWID=(RSTELD,RSTELQ),   +        
               ROWWIDTH=(V,RSTLN)                                               
ExpMile  LKOUT C,5,RSTSTAT2,(R,EDTMILE)                                         
Exp2Da   LKOUT C,6,RSTSTAT1,(R,EDT2DA)                                          
Exp2Pa   LKOUT C,7,RSTSTAT1,(R,EDT2PA)                                          
*&&UK                                                                           
ExpCli   LKOUT C,8,RSTCOSTG,CHAR,ND=Y                                           
*&&                                                                             
*&&US                                                                           
PRout    LKOUT P,RSTELD,SETCSTB                                                 
CliAna   LKOUT C,8,(D,B#WORKD,BYTE3),CHAR,LEN=1,ND=Y                            
*&&                                                                             
ExpPro   LKOUT C,9,RSTSTAT5,(R,EDTPROA)                                         
ExpJob   LKOUT C,10,RSTSTAT4,(R,EDTJOBA)                                        
ExpLock  LKOUT C,11,RSTSTAT1,(R,EDTACLK)                                        
                                                                                
         LKOUT E                                                                
                                                                                
ARYSUAC  LKOUT A,(R,NXTACT),MULTIROW=Y,ROWNAME=ACTRECD                          
                                                                                
Def      LKOUT C,1,(D,B#SAVED,EL_DEFSU),CHAR                                    
SupAcc   LKOUT C,2,ACTKULA,CHAR,LEN=L'ACTKULA                                   
Array    LKOUT C,3,(A,ARYACNM)                                                  
Array    LKOUT C,4,(A,ARYXNM)                                                   
Array    LKOUT C,5,(A,ARYOAT)                                                   
Array    LKOUT C,5,(A,ARYADR),FILTROUT=TSTOATL                                  
Array    LKOUT C,6,(A,ARYAST)                                                   
Array    LKOUT C,10,(A,ARYSURST)                                                
Array    LKOUT C,12,(A,ARYSUFFT)                                                
                                                                                
         LKOUT E                                                                
                                                                                
ARYOAT   LKOUT A,(D,B#ACTREC,ACTRFST),EOT=EOR,                         +        
               ROWID=(OATEL,OATELQ),ROWWIDTH=(V,OATLN)                          
PRout    LKOUT P,,SETOATL                                                       
Line1    LKOUT C,5,OATLINE1,CHAR,ND=Y                                           
Line2    LKOUT C,5,OATLINE2,CHAR,ND=Y                                           
CitySt   LKOUT C,5,(D,B#WORKD,WORK),CHAR,LEN=50,ND=Y                            
                                                                                
         LKOUT E                                                                
                                                                                
ARYADR   LKOUT A,(D,B#ACTREC,ACTRFST),EOT=EOR,                         +        
               ROWID=(ADREL,ADRELQ),ROWWIDTH=(V,ADRLN)                          
Array    LKOUT C,5,(A,ARYADR1)                                                  
                                                                                
         LKOUT E                                                                
                                                                                
ARYADR1  LKOUT A,(*,ADRADD1),ROWNAME=ADREL,NROWS=*,ROWWIDTH=L'ADRADD1           
Addrss   LKOUT C,5,ADRADD1,CHAR,ND=Y                                            
                                                                                
         LKOUT E                                                                
                                                                                
ARYAST   LKOUT A,(D,B#ACTREC,ACTRFST),EOT=EOR,                         +        
               ROWID=(ASTEL,ASTELQ),ROWWIDTH=(V,ASTLN)                          
Curr     LKOUT C,6,ASTCUR,(R,EDTCUR)                                            
                                                                                
         LKOUT E                                                                
                                                                                
ARYSURST LKOUT A,(D,B#ACTREC,ACTRFST),EOT=EOR,ROWID=(RSTELD,RSTELQ),   +        
               ROWWIDTH=(V,RSTLN)                                               
SupLock  LKOUT C,10,RSTSTAT1,(R,EDTACLK)                                        
GAP      LKOUT C,11,RSTSTAT7,(R,EDTGAP)                                         
                                                                                
         LKOUT E                                                                
                                                                                
ARYSUFFT LKOUT A,(D,B#ACTREC,ACTRFST),EOT=EOR,ROWID=(FFTELD,FFTELQ),   +        
               ROWWIDTH=(V,FFTLN)                                               
PRout    LKOUT P,FFTTYPE,SETTTYPE                                               
Email    LKOUT C,12,FFTDATA,CHAR,LEN=V,FILTROUT=TSTFPEML,ND=Y                   
                                                                                
         LKOUT E                                                                
                                                                                
ARYWKCD  LKOUT A,(R,NXTWC),NROWS=1,ROWNAME=WCORECD                              
                                                                                
Array    LKOUT C,3,(A,ARYWCNM)                                                  
Array    LKOUT C,4,(A,ARYWCXN)                                                  
Array    LKOUT C,5,(A,ARYWCO)                                                   
                                                                                
         LKOUT E                                                                
                                                                                
                                                                                
ARYWCNM  LKOUT A,(D,B#WCREC,WCORFST),EOT=EOR,                          +        
               ROWID=(NAMEL,NAMELQ),ROWWIDTH=(V,NAMLN)                          
                                                                                
WCNam    LKOUT C,3,NAMEREC,CHAR,LEN=V,ND=Y                                      
                                                                                
         LKOUT E                                                                
                                                                                
                                                                                
ARYWCXN  LKOUT A,(D,B#WCREC,WCORFST),EOT=EOR,ROWID=(XNMELD,XNMELQ),    +        
               ROWWIDTH=(V,XNMLN)                                               
ForNam   LKOUT C,4,XNMSUBN,CHAR,LEN=V,ND=Y                                      
                                                                                
         LKOUT E                                                                
                                                                                
ARYWCO   LKOUT A,(D,B#WCREC,WCORFST),EOT=EOR,                          +        
               ROWID=(WCOEL,WCOELQ),ROWWIDTH=(V,WCOLN)                          
                                                                                
Desc     LKOUT C,5,WCODESC,CHAR,ND=Y                                            
ExpRqd   LKOUT C,6,WCOSTAT,(R,EDTWCST)                                          
Ordlckd  LKOUT C,7,WCOSTAT2,(R,EDTORLK)                                         
                                                                                
         LKOUT E                                                                
*&&DO                                                                           
ARYAGNT  LKOUT A,(R,NXTACT),NROWS=1,ROWNAME=ACTRECD                             
                                                                                
Agent    LKOUT C,7,ACTKACT,CHAR                                                 
Array    LKOUT C,8,(A,ARYAGNM)                                                  
Array    LKOUT C,9,(A,ARYAGAD)                                                  
                                                                                
         LKOUT E                                                                
                                                                                
ARYAGNM  LKOUT A,(D,B#ACTREC,ACTRFST),EOT=EOR,                         +        
               ROWID=(NAMEL,NAMELQ),ROWWIDTH=(V,NAMLN)                          
                                                                                
Agntnam  LKOUT C,8,NAMEREC,CHAR,LEN=V                                           
                                                                                
         LKOUT E                                                                
                                                                                
ARYAGAD  LKOUT A,(D,B#ACTREC,ACTRFST),EOT=EOR,                         +        
               ROWID=(ADREL,ADRELQ),ROWWIDTH=(V,ADRLN)                          
Array    LKOUT C,9,(A,ARYAGAD1)                                                 
                                                                                
         LKOUT E                                                                
                                                                                
ARYAGAD1 LKOUT A,(*,ADRADD1),ROWNAME=ADREL,NROWS=*,ROWWIDTH=L'ADRADD1           
Addrss   LKOUT C,9,ADRADD1,CHAR,ND=Y                                            
                                                                                
         LKOUT E                                                                
*&&                                                                             
NXTETYP  CLI   LP_RMODE,LP_RFRST   First time?                                  
         JNE   NXETYP20                                                         
*                                                                               
*&&UK                                                                           
         XC    LDGAREA(LDGALNQ),LDGAREA                                         
         MVC   LDGAUL,=C'SV'                                                    
         XC    DSVLVLS,DSVLVLS                                                  
         GOTOR (#SETLDG,ASETLDG)                                                
         JNE   NXETYP00                                                         
         MVC   DSVLVLS,LDGAL1      save SV levels                               
                                                                                
NXETYP00 XC    LDGAREA(LDGALNQ),LDGAREA                                         
         MVC   LDGAUL,=C'SX'                                                    
         XC    DSXLVLS,DSXLVLS                                                  
         GOTOR (#SETLDG,ASETLDG)                                                
         JNE   NXETYP0B                                                         
         MVC   DSXLVLS,LDGAL1      save SX levels                               
                                                                                
NXETYP0B XC    LDGAREA(LDGALNQ),LDGAREA                                         
         MVC   LDGAUL,=C'SA'                                                    
         XC    DSALVLS,DSALVLS                                                  
         GOTOR (#SETLDG,ASETLDG)                                                
         JNE   NXETYP0C                                                         
         MVC   DSALVLS,LDGAL1      save SA levels                               
                                                                                
NXETYP0C XC    LDGAREA(LDGALNQ),LDGAREA                                         
         MVC   LDGAUL,=C'SE'                                                    
         XC    DSELVLS,DSELVLS                                                  
         GOTOR (#SETLDG,ASETLDG)                                                
         JNE   NXETYP0D                                                         
         MVC   DSELVLS,LDGAL1      save SE levels                               
                                                                                
NXETYP0D XC    LDGAREA(LDGALNQ),LDGAREA                                         
         MVC   LDGAUL,=C'SQ'                                                    
         XC    DSQLVLS,DSQLVLS                                                  
         GOTOR (#SETLDG,ASETLDG)                                                
         JNE   NXETYP0E                                                         
         MVC   DSQLVLS,LDGAL1      save SQ levels                               
                                                                                
NXETYP0E DS    0H                                                               
*&&UK                                                                           
         XC    LDGAREA(LDGALNQ),LDGAREA                                         
         MVC   LDGAUL,=C'SI'                                                    
         XC    DSILVLS,DSILVLS                                                  
         GOTOR (#SETLDG,ASETLDG)                                                
         JNE   NXETYP0F                                                         
         MVC   DSILVLS,LDGAL1      save SI levels                               
*&&                                                                             
NXETYP0F XC    DVATCODE(DVATLNQ),DVATCODE                                       
         MVC   DCOFF,SPACES                                                     
         XC    LDGAREA(LDGALNQ),LDGAREA                                         
         MVC   LDGAUL,=C'SG'                                                    
         GOTOR (#SETLDG,ASETLDG)                                                
         JE    NXETYP0G                                                         
*                                                                               
         MVC   LP_ERROR,=AL2(AE$OPTNV)                                          
         J     QERROR                                                           
*                                                                               
NXETYP0G MVC   DSGOP,LDGAOP                                                     
         XC    DVATCODE(DVATLNQ),DVATCODE                                       
         MVC   DCOFF,SPACES                                                     
         XC    LDGAREA(LDGALNQ),LDGAREA                                         
         MVC   LDGAUL,=C'SF'                                                    
         GOTOR (#SETLDG,ASETLDG)                                                
*&&US*&& JNE   NXETYP0H                                                         
*&&UK*&& JNE   NXETY02                                                          
         MVC   DSFLVLS,LDGAL1      save SF levels                               
*&&UK*&& J     NXETY02                                                          
*                                                                               
*&&US*&&                                                                        
NXETYP0H XC    DVATCODE(DVATLNQ),DVATCODE                                       
         MVC   DCOFF,SPACES                                                     
         XC    LDGAREA(LDGALNQ),LDGAREA                                         
         MVC   LDGAUL,=C'ST'                                                    
         GOTOR (#SETLDG,ASETLDG)                                                
         JNE   NXETY02                                                          
         MVC   DSTLVLS,LDGAL1      save ST levels                               
*&&                                                                             
NXETY02  MVI   DE_SPACE,NOQ                                                     
         USING OFLPASD,IOKEY                                                    
         CLI   CUACCS,0            NO LIMIT ACCESS?                             
         JE    NXETYP06            THEN DON'T BOTHER                            
         XC    IOKEY,IOKEY         CHECK WHETHER OFFICE IS PART OF              
         MVI   OFLPTYP,OFLPTYPQ    OFFICE LIST                                  
         MVI   OFLPSUB,OFLPSUBQ                                                 
         MVC   OFLPCPY,CUXCPY                                                   
         TM    CPYSTAT4,CPYSOFF2 2 CHAR OFFICE                                  
         JZ    NXETYP02                                                         
         MVC   OFLPOFF(2),CUACCS+2                                              
         J     NXETYP04                                                         
NXETYP02 CLI   CUACCS,C'$'                                                      
         JE    NXETYP06                                                         
         MVC   OFLPOFF,SPACES                                                   
         MVC   OFLPOFF(2),CUACCS+1                                              
NXETYP04 MVC   CSVKEY1,IOKEY                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO1'                               
         CLC   CSVKEY1(OFLPOFL-OFLPASD),IOKEY                                   
         JNE   NXETYP06                                                         
         MVC   SVOFFL,OFLPOFL      SAVE OFFICE LIST CODE                        
                                                                                
NXETYP06 DS    0H                                                               
         MVC   SAVEKEY3,IOKEY      SAVE KEY                                     
         CLI   QAPPL,QMAINT        If maintenance ignore limit list             
         JE    NXETYP10                                                         
         GOTOR GETLMT,'LIDTEXPL'   Get expenditure type limit list              
         OC    ELEMEN2(L'QETYCD),ELEMEN2  Any exp. type codes ?                 
         JNZ   NXETYP10            Yes                                          
         TM    X#LLIND,X#LLINI                                                  
         JNZ   NXETYP08                                                         
         GOTOR ACCRUL                                                           
NXETYP08 CLI   LL_DEXPA,LL_ALLQ   Do we have access to all if no list           
         JNE   NOMORE                                                           
                                                                                
NXETYP10 OC    ELEMEN2(L'QETYCD),ELEMEN2  Any exp. type codes ?                 
         JNZ   NXETYP12            Yes                                          
         MVC   DAETYP,AALL                                                      
         J     NXETYP20                                                         
                                                                                
NXETYP12 LA    R3,ELEMEN2                                                       
NXETYP14 GOTOR LP_AAWMP,DMCB,(L'ETYKCODE,0(R3)),DETYPIND,DETYMAXQ,     +        
               LP_D                                                             
         LA    R3,L'ETYKCODE(R3)                                                
         OC    0(L'ETYKCODE,R3),0(R3)                                           
         JNZ   NXETYP14                                                         
                                                                                
NXETYP20 DS    0H                                                               
         MVC   IOKEY,SAVEKEY3      RESTORE KEY                                  
         CLC   QSUPPC,SPACES                                                    
         JH    NXETYP30                                                         
         GOTOR (#NXTREC,ANXTREC),DMCB,ETYKEYT,('B#ETYREC',0),          +        
               (0,SAVED),AETYKF,0                                               
         JNE   EXITY                                                            
         MVC   SAVEKEY3,IOKEY      SAVE KEY                                     
         J     EXITY                                                            
                                                                                
NXETYP30 CLI   DE_SPACE,YESQ                                                    
         JE    NXETYP50                                                         
         GOTOR (#NXTREC,ANXTREC),DMCB,CETKEYT,('B#ETYREC',0),          +        
               ('$NXTRXGR',SAVED),AETYKF,0                                      
         JE    NXETYP60                                                         
         MVI   DE_SPACE,YESQ                                                    
         MVI   LP_RMODE,LP_RFRST   Set first time again                         
NXETYP50 GOTOR (#NXTREC,ANXTREC),DMCB,CETKEYT2,('B#ETYREC',0),         +        
               ('$NXTRXGR',SAVED),AETYKF,0                                      
         JNE   EXITY                                                            
NXETYP60 DS    0H                                                               
         MVC   SAVEKEY3,IOKEY      SAVE KEY                                     
         L     R0,AIO2                                                          
         LHI   R1,IOLENQ                                                        
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
         LA    R2,IOKEY                                                         
         USING CETPASD,R2          R2=A(CREDITOR ETYPE KEY)                     
         MVC   IODA,CETPDA                                                      
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JE    *+6                                                              
         DC    H'0'                                                             
         MVC   LP_ADATA,AIO2                                                    
         J     EXITY                                                            
                                                                                
***********************************************************************         
* Read account record                                                 *         
***********************************************************************         
         USING ACTRECD,R2                                                       
NXTACT   LA    R2,IOKEY                                                         
         MVC   IOKEY,SAVEKEY4                                                   
         GOTOR (#NXTREC,ANXTREC),DMCB,ACTKEYT,('B#ACTREC',0),          +        
               (0,SAVED),AACTKF,0                                               
         JNE   EXITY                                                            
         MVC   SAVEKEY4,IOKEY                                                   
         XC    SUPBYTE,SUPBYTE                                                  
         J     EXITY                                                            
         EJECT                                                                  
         DROP  R2                                                               
***********************************************************************         
* Read work code record                                               *         
***********************************************************************         
                                                                                
NXTWC    MVC   SAVEKEY2,IOKEY                                                   
         GOTOR (#NXTREC,ANXTREC),DMCB,WCOKEYT,('B#WCREC',0),           +        
               (0,SAVED),0,0                                                    
         MVC   IOKEY,SAVEKEY2                                                   
         J     EXITY                                                            
                                                                                
***********************************************************************         
* PRout routines                                                                
***********************************************************************         
                                                                                
SETUPR   L     R1,LP_AINP          Set first character to upper case            
         OI    0(R1),C' '                                                       
         J     EXIT                                                             
                                                                                
SETTYPE  L     R1,LP_AINP          Set type of element                          
         MVC   WORK(L'STCXTYP),0(R1)                                            
         J     EXIT                                                             
*                                                                               
SETNAME  L     R1,LP_AINP                                                       
         XC    TERMDATE,TERMDATE                                                
         OC    0(L'SA0KNUM,R1),0(R1)                                            
         JZ    EXIT                                                             
         MVC   TEMP2(L'SA0KNUM),0(R1)                                           
         GOTOR (#GETPID,AGETPID)                                                
         JNE   EXIT                                                             
         MVC   CHARPID,TEMP2                                                    
         GOTOR (#GETPIN,AGETPIN)                                                
         JNE   EXIT                                                             
         USING SAPEREC,R2                                                       
         L     R2,AIO1                                                          
         LA    R3,SAPEDATA                                                      
         USING SAPERD,R3                                                        
SETNAM2  CLI   SAPEREL,0                                                        
         JE    EXIT                                                             
         CLI   SAPEREL,SAPERELQ                                                 
         JE    SETNAM4                                                          
         LLC   R0,SAPERLN                                                       
         AR    R3,R0                                                            
         J     SETNAM2                                                          
                                                                                
SETNAM4  MVC   TERMDATE,SAPERDTE                                                
         J     EXIT                                                             
*                                                                               
SETDEF   L     R1,LP_AINP          Set Default from LIDDATA                     
         MVI   EL_DEFSU,C'N'                                                    
         TM    0(R1),X'40'                                                      
         JNZ   EXIT                                                             
         MVI   EL_DEFSU,C'Y'                                                    
         J     EXIT                                                             
*                                                                               
EXTACT   L     R1,LP_AINP          Extract account code                         
         MVC   WORK(14),0(R1)      Save account code                            
*                                                                               
         CLC   LDGAUL,WORK         Check same ledger                            
         JE    EXTACT02                                                         
         MVC   LDGAUL,WORK                                                      
         GOTOR (#SETLDG,ASETLDG)                                                
EXTACT02 LA    RE,LDGAL4                                                        
         LHI   RF,4                                                             
         CLI   0(RE),L'ACTKACT                                                  
         JE    EXTACT04                                                         
         SHI   RE,1                                                             
         JCT   RF,*-12                                                          
         DC    H'0'                                                             
EXTACT04 CHI   RF,1                Check a single level ledger                  
         JNH   EXTACT06            Yes - read lowest level account only         
         SHI   RE,1                                                             
         LLC   RF,0(RE)                                                         
         AHI   RF,2                For unit ledger                              
         LA    R1,WORK(RF)         First char of lowest level                   
         CLI   0(R1),C' '          Test it's lowest level account               
         JNH   EXTACT08            No - read all lowest level accounts          
*                                                                               
EXTACT06 DS    0H                  Read lowest level account only               
         MVC   EL_ULAST,WORK                                                    
         MVC   EL_ULAEN,WORK                                                    
         J     EXIT                                                             
*                                                                               
EXTACT08 DS    0H                  Read all lowest level accounts               
         XC    EL_ULAST,EL_ULAST                                                
         MVC   EL_ULAEN,FFS                                                     
                                                                                
         SHI   RF,1                                                             
         BASR  R1,0                                                             
         MVC   EL_ULAST(0),WORK                                                 
         EX    RF,0(R1)                                                         
         BASR  R1,0                                                             
         MVC   EL_ULAEN(0),WORK                                                 
         EX    RF,0(R1)                                                         
         J     EXIT                                                             
                                                                                
EXTWRKCD L     R1,LP_AINP          Extract work code                            
         MVC   EL_WRKCD,0(R1)                                                   
         J     EXIT                                                             
                                                                                
PRVATAC  L     R1,LP_AINP                                                       
         MVC   EL_VACC,0(R1)                                                    
         CLC   EL_VACC,SPACES      any VAT account present?                     
         JNH   EXIT                                                             
*&&UK                                                                           
         MVC   SAVEKEY2,IOKEY                                                   
         GOTOR RATACC                                                           
         MVC   IOKEY,SAVEKEY2                                                   
*&&                                                                             
         J     EXIT                                                             
                                                                                
PRVATCD  L     R1,LP_AINP                                                       
         MVC   EL_VCOD,0(R1)                                                    
         CLI   EL_VCOD,C' '        any VAT code present?                        
         JNH   EXIT                                                             
*                                                                               
         MVC   SAVEKEY2,IOKEY                                                   
         GOTOR RATCOD,0                                                         
         MVC   IOKEY,SAVEKEY2                                                   
                                                                                
         J     EXIT                                                             
                                                                                
LOCNMS   L     R1,LP_AINP                                                       
         MVC   DOFFC(DPLOLN),0(R1)                                              
                                                                                
         CLC   LDGAUL,=C'1R'                                                    
         JE    LOCNM02                                                          
         MVC   LDGAUL,=C'1R'                                                    
         GOTOR (#SETLDG,ASETLDG)                                                
         MVC   ONERL1L(4),LDGAL1                                                
                                                                                
LOCNM02  XC    WORK(14),WORK                                                    
         MVC   WORK,=C'1R'                                                      
         LA    R2,WORK+2                                                        
         MVC   0(L'DOFFC,R2),DOFFC                                              
         LLC   R1,ONERL1L                                                       
         LA    R1,0(R2,R1)                                                      
         MVC   0(L'DDEPT,R1),DDEPT                                              
         LLC   R1,ONERL2L                                                       
         LA    R1,0(R2,R1)                                                      
         MVC   0(L'DSDPT,R1),DSDPT                                              
                                                                                
         LA    R2,WORK                                                          
         MVC   TEMP2,SPACES                                                     
         LLC   R1,ONERL1L                                                       
         LA    R1,1(R1)            (COMPENSATE FOR 1R PREFIX)                   
         BASR  RE,0                                                             
         EX    R1,4(RE)                                                         
         MVC   TEMP2(0),0(R2)                                                   
         GOTOR (#GETACN,AGETACN)   GET OFFICE NAME                              
         MVC   ELEMEN2(36),TEMP2                                                
                                                                                
         MVC   TEMP2,SPACES                                                     
         LLC   R1,ONERL2L                                                       
         LA    R1,1(R1)            (COMPENSATE FOR 1R PREFIX)                   
         BASR  RE,0                                                             
         EX    R1,4(RE)                                                         
         MVC   TEMP2(0),0(R2)                                                   
         GOTOR (#GETACN,AGETACN)   GET DEPARTMENT NAME                          
         MVC   ELEMEN2+36(36),TEMP2                                             
                                                                                
         MVC   TEMP2,SPACES                                                     
         LLC   R1,ONERL3L                                                       
         LA    R1,1(R1)            (COMPENSATE FOR 1R PREFIX)                   
         BASR  RE,0                                                             
         EX    R1,4(RE)                                                         
         MVC   TEMP2(0),0(R2)                                                   
         GOTOR (#GETACN,AGETACN)   GET SUB-DEPT NAME                            
         MVC   ELEMEN2+72(36),TEMP2                                             
                                                                                
         J     EXIT                                                             
                                                                                
***********************************************************************         
*getmap routine will produce a list of backup approver for line manager         
***********************************************************************         
                                                                                
GETMAPO  MVI   BYTE1,DPAPATIO                                                   
         MVI   BYTE2,LIDLTOFF                                                   
         MVI   BYTE3,LIDLAPP2-LIDDATA                                           
         J     GETMAP                                                           
                                                                                
GETMAPT  MVI   BYTE1,DPAPATIM                                                   
         MVI   BYTE2,LIDLTIME                                                   
         MVI   BYTE3,LIDLAPPL-LIDDATA                                           
         J     GETMAP                                                           
                                                                                
GETMAPX  MVI   BYTE1,DPAPAEXP                                                   
         MVI   BYTE2,LIDLEXPN                                                   
         MVI   BYTE3,LIDLAPPL-LIDDATA                                           
                                                                                
                                                                                
GETMAP   L     R1,LP_AINP                                                       
         MVC   DOFFC(DPLOLN),0(R1)                                              
                                                                                
         CLC   LDGAUL,LED1R                                                     
         JE    GETMAP00                                                         
         MVC   LDGAUL,LED1R                                                     
         GOTOR (#SETLDG,ASETLDG)                                                
         MVC   ONERL1L(4),LDGAL1                                                
                                                                                
GETMAP00 XC    WORK(14),WORK                                                    
         MVC   WORK(L'LED1R),LED1R                                              
         LA    R2,WORK+L'LED1R                                                  
         MVC   0(L'DOFFC,R2),DOFFC                                              
         LLC   R1,ONERL1L                                                       
         LA    R1,0(R2,R1)                                                      
         MVC   0(L'DDEPT,R1),DDEPT                                              
         LLC   R1,ONERL2L                                                       
         LA    R1,0(R2,R1)                                                      
         MVC   0(L'DSDPT,R1),DSDPT                                              
         LLC   R1,ONERL3L                                                       
         LA    R1,0(R2,R1)                                                      
         MVC   0(L'QPERKCD,R1),QPERKCD                                          
P        USING ACTKACT,R2                                                       
         XC    BKLINMGR(BKLINMAX*L'PIDNO),BKLINMGR                              
         LA    R0,BKLINMGR                                                      
         ST    R0,ANXTPID                                                       
                                                                                
MN       USING DPAPASD,IOKEY                                                    
         XC    MN.DPAPAS,MN.DPAPAS                                              
         MVI   MN.DPAPTYP,DPAPTYPQ                                              
         MVI   MN.DPAPSUB,DPAPSUBQ                                              
         MVC   MN.DPAPAPPL,BYTE1   Could be time off, time or expenses          
         MVC   MN.DPAPCPY,CUXCPY                                                
         ZAP   MN.DPAPXVAL,PZERO                                                
         LA    R3,ONERL4L          R3=A(Person length)                          
         LHI   R0,4                R0=Number of levels to search                
                                                                                
GETMAP02 MVC   MN.DPAP1RAC,SPACES                                               
         LLC   RF,0(R3)                                                         
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   MN.DPAP1RAC(0),P.ACTKACT                                         
         EX    RF,0(RE)                                                         
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO3'                               
         JE    GETMAP06                                                         
         J     *+2                     Die here                                 
                                                                                
GETMAP04 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO3'                               
         JNE   *+2                     Die here                                 
                                                                                
GETMAP06 CLC   MN.DPAPAS(DPAPPIDB-DPAPASD),IOKEYSAV                             
         JNE   GETMAP08                                                         
         MVC   BKLINMGR,MN.DPAPPIDB                                             
         J     GETMAP10                                                         
                                                                                
GETMAP08 MVC   MN.DPAPAS,IOKEYSAV  Reset key                                    
         SHI   R3,L'ONERL4L        Point to previous key length                 
         JCT   R0,GETMAP02         Do for number of 1R levels                   
         J     GETMAPN                                                          
                                                                                
GETMAP10 CLI   MN.DPAPSEQ,0        MAIN APPROVER RECORD?                        
         JNE   GETMAP12                                                         
         XC    CSVKEY1,CSVKEY1                                                  
         MVC   CSVKEY1(L'DPAPAS),MN.DPAPAS                                      
         J     GETMAP18                                                         
         DROP  MN,P                                                             
                                                                                
AP       USING APPRECD,IOKEY       NO, READ MAIN APPROVER RECORD                
GETMAP12 XC    AP.APPKEY,AP.APPKEY                                              
         MVI   AP.APPKTYP,APPKTYPQ                                              
         MVI   AP.APPKSUB,APPKSUBQ                                              
         MVC   AP.APPKCPY,CUXCPY                                                
         MVC   AP.APPKPIDB,BKLINMGR                                             
         XC    CSVKEY1,CSVKEY1                                                  
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    GETMAP18                                                         
         J     *+2                 MAIN APPROVER RECORD MISSING                 
*                                                                               
GETMAP14 OC    CSVKEY1,CSVKEY1                                                  
         JZ    GETMAP16                                                         
         MVC   IOKEY,CSVKEY1       (RE-)ESTABLISH SEQUENCE                      
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JNE   *+2                                                              
                                                                                
GETMAP16 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO3'                               
         JNE   *+2                 MAIN APPROVER RECORD MISSING                 
*                                                                               
         CLC   AP.APPKEY(APPKSEQ-APPKEY),IOKEYSAV                               
         JNE   GETMAPY                                                          
         DROP  AP                                                               
*                                                                               
GETMAP18 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JNE   *+2                                                              
                                                                                
         L     R1,IOADDR                                                        
         OC    CSVKEY1,CSVKEY1                                                  
         JZ    *+10                                                             
         MVC   CSVKEY1(L'APPKEY),0(R1)  SAVE APPKEY                             
         AHI   R1,ACCRFST-ACCRECD                                               
         SR    R0,R0                                                            
         USING LIDELD,R1                                                        
GETMAP20 CLI   LIDEL,0             Test end of record                           
         JE    GETMAP14            Yes, any more?                               
         CLI   LIDEL,LIDELQ                                                     
         JE    GETMAP24                                                         
GETMAP22 IC    R0,LIDLN                                                         
         AR    R1,R0                                                            
         J     GETMAP20                                                         
                                                                                
GETMAP24 CLI   LIDTYPE,LIDTBACK                                                 
         JNE   GETMAP22                                                         
         LA    R4,LIDDATA                                                       
         USING LIDDATA,R4                                                       
         LLC   R3,LIDLN                                                         
         AR    R3,R1               R3=End of element                            
         LA    RF,BKLINMGR+L'PIDNO                                              
         LHI   RE,1                Add 1 for main line manager                  
                                                                                
*ETMAP26 TM    LIDLAPPL,LIDLTIME   Is this entry for timesheets                 
*ETMAP26 TM    LIDLAPP2,LIDLTOFF   Is this entry for time off                   
GETMAP26 LLC   R2,BYTE3            What is the displacement to byte             
         AR    R2,R4                we need to test in LIDDATA                  
         MVC   BYTE4,0(R2)         Extract value at this byte                   
         NC    BYTE4,BYTE2         AND this with the value we're                
         JZ    GETMAP28             looking for and exit if not present         
         MVC   0(L'PIDNO,RF),LIDLPID  otherwise get back up approvers           
         LA    RF,L'PIDNO(RF)                                                   
         AHI   RE,1                                                             
                                                                                
GETMAP28 CHI   RE,BKLINMAX         Did we fill up the whole table?              
         JE    GETMAPY             Hope it's enough...                          
         LLC   R0,LIDITLN          Increment R4 to look at next entry           
         AR    R4,R0                                                            
         CR    R3,R4               Check we haven't reached end of el           
         JH    GETMAP26            No - check next entry                        
         J     GETMAPY             Yes - finish                                 
         DROP  R4                                                               
                                                                                
GETMAPN  MVC   ROUERRV,=AL2(AE$INAPP)                                           
         J     EXITN                                                            
                                                                                
GETMAPY  J     EXITY                                                            
         EJECT                                                                  
                                                                                
***********************************************************************         
* Some FILTROUT routines                                                        
***********************************************************************         
                                                                                
TSTTEXPS CLI   WORK,LIDTEXPS       Test if expense account list ele             
         BR    RE                                                               
                                                                                
TSTTSUPP CLI   WORK,LIDTSUPP       Test if supplier account list ele            
         BR    RE                                                               
                                                                                
TSTTWKCD CLI   WORK,LIDTWKCD       Test if work code list ele                   
         BR    RE                                                               
*&&US                                                                           
TSTTPROV CLI   WORK,LIDTGSTR       Test if province/GST/PST list ele            
         BR    RE                                                               
*&&                                                                             
TSTINWRK L     R1,LP_AINP                                                       
         CLI   CUCTRY,CTRYGER      Germany and Orders?                          
         JNE   SETCCC                                                           
         MVC   BYTE1,0(R1)                                                      
         OI    BYTE1,X'40'         MAY BE DEFAULT WORKCODE                      
         CLI   QAPPL,QORD                                                       
         JNE   TSTINW02                                                         
         CLI   QOTYP,QOTYPIQ                                                    
         JNE   TSTINW02                                                         
         CLI   BYTE1,C'0'          skip externals for internal orders           
         BHR   RE                                                               
         J     SETCCC                                                           
*                                                                               
TSTINW02 CLI   BYTE1,C'0'          skip internals for other orders              
         BLR   RE                                                               
         BER   RE                                                               
         J     SETCCC                                                           
*                                                                               
                                                                                
TSTTVATC CLI   WORK,FFTTVATC       Test if vat code                             
         BR    RE                                                               
*&&UK                                                                           
TSTFPEML CLI   WORK,FFTTPEML       Test whether type is email                   
         BR    RE                                                               
*&&                                                                             
*&&US                                                                           
TSTFPEML CLI   WORK,FFTTEML        Test whether type is email                   
         BR    RE                                                               
*&&                                                                             
                                                                                
TSTTITAX CLI   WORK,SPATITAX       Test if tax account                          
         BR    RE                                                               
*                                                                               
*&&US                                                                           
SETCSTB  L     R1,LP_AINP                                                       
         USING RSTELD,R1                                                        
         MVI   BYTE3,0                                                          
         CLC   =C'SI',EL_ULA                                                    
         JNE   *+14                                                             
         MVC   BYTE3,RSTCOSTG                                                   
         J     EXITY                                                            
         CLC   =C'SE',EL_ULA                                                    
         JNE   EXITY                                                            
         USING CATD,R1                                                          
         LA    R1,CATBLK           Get cost setting from CATCALL                
         XC    CATD(CATLNQ),CATD                                                
         MVC   CATDMGR,VDATAMGR                                                 
         MVC   CATSEAC(1),CUXCPY   Company code                                 
         MVC   CATSEAC+1(L'ACTKULA),EL_ULA SE account from above                
         GOTO1 VCATCALL                                                         
         CLI   CATPST,C'Y'         Do they require cost postings                
         JNE   EXITY                                                            
         MVI   BYTE3,C'Y'                                                       
         J     EXITY                                                            
         DROP  R1                                                               
                                                                                
SETPRVNM L     RF,LP_AINP          PROVINCE NAME DDICT                          
         LLC   RE,L'PRVNAM(RF)                                                  
         BCTR  RE,0                                                             
         LLH   RF,0(RF)                                                         
         LA    RF,DSDICTL-SAVED(RF,R8)                                          
         BASR  R1,0                                                             
         MVC   XI_PRVNM(0),0(RF)                                                
         EX    RE,0(R1)                                                         
         J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* Get the province name                                               *         
***********************************************************************         
         SPACE 1                                                                
GETPRVNM L     R1,LP_AINP                                                       
         LA    RE,PRVTAB                                                        
         USING PRVTABD,RE                                                       
                                                                                
         MVC   EL_PRVNM,SPACES                                                  
GETPRV02 CLI   PRVCODE,X'FF'       EOT                                          
         JE    EXIT                                                             
         CLC   0(L'CIDMPROV,R1),PRVCODE                                         
         JE    *+12                                                             
         LA    RE,PRVTABL(,RE)                                                  
         J     GETPRV02                                                         
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,3,PRVNAM          PROVINCE NAME DDICT                         
         LA    RF,DSDICTL-SAVED(RF,R8)                                          
         LLC   R1,PRVNAML                                                       
         DROP  RE                                                               
         BCTR  R1,0                                                             
         BASR  RE,0                                                             
         MVC   EL_PRVNM(0),0(RF)                                                
         EX    R1,0(RE)                                                         
         J     EXIT                                                             
*                                                                               
SETPST   L     R1,LP_AINP                                                       
                                                                                
         MVC   EL_PROVC,0(R1)                                                   
         MVC   EL_PSTCD,L'LIDGPROV(R1)                                          
         CLI   EL_PSTCD,C' '       any PST code present?                        
         JNH   EXIT                                                             
                                                                                
         MVC   SAVEKEY2,IOKEY                                                   
         GOTOR RATCOD,1                                                         
         MVC   IOKEY,SAVEKEY2                                                   
         J     EXIT                                                             
*&&                                                                             
***********************************************************************         
* Expenditure Type list download  (old, 06)                           *         
***********************************************************************         
                                                                                
REQETYL  LKREQ H,A#ETYL,OUTETYL,NEXTREQ=REQOFFL                                 
                                                                                
Code     LKREQ F,01,(D,B#SAVED,QETYCD),CHAR,OLEN=L'QETYCD,             +        
               MAXLEN=L'QETYCD,TEXT=AC#CODE,COL=*                               
                                                                                
Exten    LKREQ F,02,(D,B#SAVED,QEXTEN),CHAR,OLEN=L'QEXTEN,             +        
               MAXLEN=L'QEXTEN,TEXT=(*,EXTNLIT),COL=*                           
                                                                                
Applic   LKREQ F,03,(D,B#SAVED,QAPPL),CHAR,OLEN=L'QAPPL,               +        
               MAXLEN=L'QAPPL,TEXT=(*,APPLLIT),COL=*                            
                                                                                
OType    LKREQ F,04,(D,B#SAVED,QOTYP),CHAR,OLEN=L'QOTYP,               +        
               MAXLEN=L'QOTYP,TEXT=(*,OTYPLIT),COL=*                            
                                                                                
                                                                                
         LKREQ E                                                                
                                                                                
OUTETYL  LKOUT H                                                                
                                                                                
ETYLST   LKOUT R,R#ETYL                                                         
Array    LKOUT C,R#ETYL,(A,ARYETYL)                                             
                                                                                
         LKOUT E                                                                
                                                                                
         LKOUT X                                                                
                                                                                
ARYETYL  LKOUT A,(R,NXTETY),MULTIROW=Y,ROWNAME=SAVED                            
Code     LKOUT C,1,EL_CODE,CHAR,ND=Y                                            
Name     LKOUT C,2,EL_NAME,CHAR,ND=Y                                            
Lock     LKOUT C,3,EL_LCKD,CHAR,ND=Y                                            
Dflt     LKOUT C,4,EL_DEFI,CHAR,ND=Y                                            
ExpCode  LKOUT C,5,EL_EXPC,CHAR,ND=Y                                            
ExpNam   LKOUT C,6,EL_EXPN,CHAR,ND=Y                                            
SupCode  LKOUT C,7,EL_SUPC,CHAR,ND=Y                                            
SupNam   LKOUT C,8,EL_SUPN,CHAR,ND=Y                                            
SupAdd1  LKOUT C,9,EL_SAD1,CHAR,ND=Y                                            
SupAdd2  LKOUT C,10,EL_SAD2,CHAR,ND=Y                                           
SupAdd3  LKOUT C,11,EL_SAD3,CHAR,ND=Y                                           
SupAdd4  LKOUT C,12,EL_SAD4,CHAR,ND=Y                                           
WC       LKOUT C,13,EL_WCDC,CHAR,ND=Y                                           
WCDesc   LKOUT C,14,EL_WCDD,CHAR,ND=Y                                           
AgntCode LKOUT C,15,EL_AGTC,CHAR,ND=Y                                           
AgntNam  LKOUT C,16,EL_AGTN,CHAR,ND=Y                                           
AgntAd1  LKOUT C,17,EL_AGA1,CHAR,ND=Y                                           
AgntAd2  LKOUT C,18,EL_AGA2,CHAR,ND=Y                                           
AgntAd3  LKOUT C,19,EL_AGA3,CHAR,ND=Y                                           
AgntAd4  LKOUT C,20,EL_AGA4,CHAR,ND=Y                                           
Curr     LKOUT C,21,EL_SCUR,CHAR,ND=Y                                           
Catgry   LKOUT C,22,EL_ECAT,CHAR,ND=Y                                           
Types    LKOUT C,23,EL_TYPS,CHAR,ND=Y                                           
ExpStat  LKOUT C,24,EL_EXPS,CHAR,ND=Y                                           
VATcode  LKOUT C,25,EL_VCOD,CHAR,ND=Y                                           
VATAc    LKOUT C,26,EL_VACC,CHAR,ND=Y                                           
VATRate  LKOUT C,27,EL_VRAT,CHAR,ND=Y                                           
VATNam   LKOUT C,28,EL_VNAM,CHAR,ND=Y                                           
ForName  LKOUT C,29,EL_FNAM,CHAR,ND=Y                                           
LckdOrd  LKOUT C,30,EL_LFOR,CHAR,ND=Y                                           
LckdExp  LKOUT C,31,EL_LFEX,CHAR,ND=Y                                           
LckdInv  LKOUT C,32,EL_LFIN,CHAR,ND=Y                                           
ExpFNam  LKOUT C,33,EL_EXPF,CHAR,ND=Y                                           
SupFNam  LKOUT C,34,EL_SUPF,CHAR,ND=Y                                           
WCFDesc  LKOUT C,35,EL_WCDF,CHAR,ND=Y                                           
Exp2DAn  LKOUT C,36,EL_ANAD,CHAR,ND=Y                                           
Exp2PAn  LKOUT C,37,EL_ANAP,CHAR,ND=Y                                           
Sfapall  LKOUT C,38,EL_SFAP,CHAR,ND=Y                                           
ExpPrAn  LKOUT C,39,EL_PRAN,CHAR,ND=Y                                           
GAPYN    LKOUT C,40,EL_GAPYN,CHAR,ND=Y                                          
GAPAQ    LKOUT C,41,EL_GAPAQ,CHAR,ND=Y                                          
         LKOUT E                                                                
                                                                                
***********************************************************************         
* EXPENDITURE TYPE LIST                                               *         
***********************************************************************         
                                                                                
NXTETY   ST    R8,LP_ADATA                                                      
         CLI   LP_RMODE,LP_RFRST   TEST FIRST TIME                              
         JNE   NXTET10                                                          
*                                                                               
*&&UK                                                                           
         XC    LDGAREA(LDGALNQ),LDGAREA                                         
         MVC   LDGAUL,=C'SV'                                                    
         XC    DSVLVLS,DSVLVLS                                                  
         GOTOR (#SETLDG,ASETLDG)                                                
         JNE   NXTETY00                                                         
         MVC   DSVLVLS,LDGAL1      save SV levels                               
                                                                                
NXTETY00 XC    LDGAREA(LDGALNQ),LDGAREA                                         
         MVC   LDGAUL,=C'SX'                                                    
         XC    DSXLVLS,DSXLVLS                                                  
         GOTOR (#SETLDG,ASETLDG)                                                
         JNE   NXTETY0B                                                         
         MVC   DSXLVLS,LDGAL1      save SX levels                               
                                                                                
NXTETY0B XC    LDGAREA(LDGALNQ),LDGAREA                                         
         MVC   LDGAUL,=C'SA'                                                    
         XC    DSALVLS,DSALVLS                                                  
         GOTOR (#SETLDG,ASETLDG)                                                
         JNE   NXTETY0C                                                         
         MVC   DSALVLS,LDGAL1      save SA levels                               
                                                                                
NXTETY0C XC    LDGAREA(LDGALNQ),LDGAREA                                         
         MVC   LDGAUL,=C'SE'                                                    
         XC    DSELVLS,DSELVLS                                                  
         GOTOR (#SETLDG,ASETLDG)                                                
         JNE   NXTETY0D                                                         
         MVC   DSELVLS,LDGAL1      save SE levels                               
                                                                                
NXTETY0D XC    LDGAREA(LDGALNQ),LDGAREA                                         
         MVC   LDGAUL,=C'SQ'                                                    
         XC    DSQLVLS,DSQLVLS                                                  
         GOTOR (#SETLDG,ASETLDG)                                                
         JNE   NXTETY0E                                                         
         MVC   DSQLVLS,LDGAL1      save SQ levels                               
                                                                                
NXTETY0E XC    DVATCODE(DVATLNQ),DVATCODE                                       
         MVC   DCOFF,SPACES                                                     
         XC    LDGAREA(LDGALNQ),LDGAREA                                         
         MVC   LDGAUL,=C'SG'                                                    
         GOTOR (#SETLDG,ASETLDG)                                                
         JE    NXTETY0F                                                         
*                                                                               
         MVC   LP_ERROR,=AL2(AE$OPTNV)                                          
         J     QERROR                                                           
*                                                                               
NXTETY0F MVC   DSGOP,LDGAOP                                                     
         XC    DVATCODE(DVATLNQ),DVATCODE                                       
         MVC   DCOFF,SPACES                                                     
         XC    LDGAREA(LDGALNQ),LDGAREA                                         
         MVC   LDGAUL,=C'SF'                                                    
         GOTOR (#SETLDG,ASETLDG)                                                
*&&US*&& JNE   NXTETY0G                                                         
*&&UK*&& JNE   NXTET02                                                          
         MVC   DSFLVLS,LDGAL1      save SF levels                               
*&&UK*&& J     NXTET02                                                          
*                                                                               
*&&US*&&                                                                        
NXTETY0G XC    DVATCODE(DVATLNQ),DVATCODE                                       
         MVC   DCOFF,SPACES                                                     
         XC    LDGAREA(LDGALNQ),LDGAREA                                         
         MVC   LDGAUL,=C'ST'                                                    
         GOTOR (#SETLDG,ASETLDG)                                                
         JNE   NXTET02                                                          
         MVC   DSTLVLS,LDGAL1      save ST levels                               
*&&                                                                             
NXTET02  DS    0H                                                               
*                                                                               
         USING OFLPASD,IOKEY                                                    
         CLI   CUACCS,0            NO LIMIT ACCESS?                             
         JE    NXTET03             THEN DON'T BOTHER                            
         XC    IOKEY,IOKEY         CHECK WHETHER OFFICE IS PART OF              
         MVI   OFLPTYP,OFLPTYPQ    OFFICE LIST                                  
         MVI   OFLPSUB,OFLPSUBQ                                                 
         MVC   OFLPCPY,CUXCPY                                                   
         TM    CPYSTAT4,CPYSOFF2 2 CHAR OFFICE                                  
         JZ    NXTET02A                                                         
         MVC   OFLPOFF(2),CUACCS+2                                              
         J     NXTET02B                                                         
NXTET02A CLI   CUACCS,C'$'                                                      
         JE    NXTET03                                                          
         MVC   OFLPOFF,SPACES                                                   
         MVC   OFLPOFF(2),CUACCS+1                                              
NXTET02B MVC   CSVKEY1,IOKEY                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO1'                               
         CLC   CSVKEY1(OFLPOFL-OFLPASD),IOKEY                                   
         JNE   NXTET03                                                          
         MVC   SVOFFL,OFLPOFL      SAVE OFFICE LIST CODE                        
*                                                                               
NXTET03  XC    LDGAREA(LDGALNQ),LDGAREA                                         
         MVC   LDGAUL,=CL2'ST'                                                  
         GOTOR (#SETLDG,ASETLDG)   if no ST then fine, too                      
         LA    R0,ELEMEN2          Clear exp. type code list                    
         XR    R1,R1                                                            
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         LHI   R1,L'ELEMEN2                                                     
         MVCL  R0,RE                                                            
         CLI   QETYCD,C'*'                                                      
         JE    NXTET04                                                          
         MVC   ELEMEN2(L'QETYCD),QETYCD                                         
         MVI   QEXTEN,YESQ         set to extension required                    
         J     NXTET08                                                          
*                                                                               
NXTET04  MVC   QETYCD,SPACES                                                    
         OC    CCTPID,CCTPID                                                    
         JZ    NXTET08                                                          
         CLI   QAPPL,QMAINT      If maintenance ignore limit list               
         JE    NXTET08                                                          
         GOTOR GETLMT,'LIDTEXPL'   Get expenditure type limit list              
         OC    ELEMEN2(L'QETYCD),ELEMEN2  Any exp. type codes ?                 
         JNZ   NXTET08             Yes                                          
         TM    X#LLIND,X#LLINI                                                  
         JNZ   NXTET06                                                          
         GOTOR ACCRUL                                                           
NXTET06  CLI   LL_DEXPA,LL_ALLQ   Do we have access to all if no list           
         JNE   NOMORE                                                           
*        JNE   EXITN                                                            
*                                                                               
         USING ETYRECD,R2                                                       
NXTET08  LA    R4,ELEMEN2          List of exp. type codes                      
         ST    R4,AELEMEN2                                                      
         XC    ALIDEL,ALIDEL                                                    
         XC    ASTRLID,ASTRLID                                                  
         XC    AENDLID,AENDLID                                                  
         J     NXTET14                                                          
NXTET10  OC    ALIDEL,ALIDEL       Have we got a list element                   
         JNZ   NXTET72                                                          
         L     R4,AELEMEN2                                                      
         OC    ELEMEN2(L'QETYCD),ELEMEN2  Any exp. type codes ?                 
         JNZ   NXTET12             No - Read all                                
         LA    R2,IOKEY                                                         
         MVC   ETYKEY,CSVKEY2                                                   
         MVI   ETYKSEQ,FF                                                       
         J     NXTET18                                                          
*                                                                               
NXTET12  OC    0(L'QETYCD,R4),0(R4)                                             
         JZ    NOMORE                                                           
NXTET14  LA    R2,IOKEY                                                         
         XC    ETYKEY,ETYKEY                                                    
         MVI   ETYKTYP,ETYKTYPQ                                                 
         MVI   ETYKSUB,ETYKSUBQ                                                 
         MVC   ETYKCPY,CUXCPY                                                   
         MVC   CSVKEY1(3),ETYKEY          Save the key                          
         OC    ELEMEN2(L'QETYCD),ELEMEN2  Any exp. type codes ?                 
         JZ    NXTET16                                                          
         MVC   ETYKCODE,0(R4)                                                   
         J     NXTET18                                                          
*                                                                               
NXTET16  MVC   ETYKCODE,SPACES                                                  
*                                                                               
NXTET18  GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO1'                               
         JE    NXTET22                                                          
         CLC   QETYCD,SPACES       Single exp. type code request ?              
         JNE   ETYLERR1            Yes - not found                              
         J     NXTET70             We found nothing                             
*                                                                               
NXTET20  LA    R2,IOKEY                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO1'                               
         JNE   ETYLERR1                                                         
*                                                                               
NXTET22  MVC   CSVKEY2,ETYKEY                                                   
         CLI   CUACCS,0            GLOBAL LOGON?                                
         JE    NXTET36             THEN CAN VIEW EVERYTHING                     
*                                                                               
         CLC   ETYKOFFC,SPACES     GLOBAL EXPENDITURE TYPE?                     
         JNH   NXTET36             THEN ALLOW USER TO VIEW IT                   
         TM    CPYSTAT4,CPYSOFF2 2 CHAR OFFICE                                  
         JNZ   NXTET30                                                          
         CLI   CUACCS,C'$'         IS IT OFFICE LIST LOGON?                     
         JNE   NXTET24                                                          
         CLI   ETYKOFFC,C'$'       OFFICE LIST EXPENDITURE TYPE                 
         JNE   NXTET24                                                          
         CLC   CUACCS(2),ETYKOFFC  CHECK WHETHER OFFICE LIST MATCHES            
         JE    NXTET36                                                          
         OC    ELEMEN2(L'QETYCD),ELEMEN2  Any exp. type codes ?                 
         JZ    NXTET20                    No - Read all                         
         AHI   R4,L'QETYCD                                                      
         ST    R4,AELEMEN2                                                      
         J     NXTET10             EXPENDITURE TYPE NOT VALID ON THIS           
*                                                                               
NXTET24  MVC   CSVKEY3,IOKEY                                                    
         CLC   SVOFFL,SPACES                                                    
         JNH   *+14                                                             
         CLC   SVOFFL,ETYKOFFC     MATCH ON OFFICE LIST CODE                    
         JE    NXTET36                                                          
*                                                                               
         L     R1,AOFFAREA                                                      
         USING OFFALD,R1                                                        
         MVC   OFFAOFFC,SPACES                                                  
         MVC   OFFAOFFC(2),ETYKOFFC MOVE IN OFFICE AND VALIDATE                 
         MVI   OFFAACT,OFFAVAL                                                  
         GOTOR VOFFAL                                                           
         JNE   NXTET26                                                          
         MVC   IOKEY,CSVKEY3                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
         JE    *+6                                                              
         DC    H'0'                RESTORE READ SEQUENCE                        
         J     NXTET36                                                          
*                                                                               
NXTET26  MVC   IOKEY,CSVKEY3                                                    
         OC    ELEMEN2(L'QETYCD),ELEMEN2  Any exp. type codes ?                 
         JNZ   NXTET28                                                          
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
         JE    *+6                                                              
         DC    H'0'                RESTORE READ SEQUENCE                        
         J     NXTET20             No - Read all                                
*                                  EXPENDITURE TYPE NOT VALID ON THIS           
NXTET28  AHI   R4,L'QETYCD                                                      
         ST    R4,AELEMEN2                                                      
         J     NXTET10             SKIP THIS EXPENDITURE TYPE                   
*                                                                               
NXTET30  CLC   CUACCS+2(2),ETYKOFFC OFFICE LIST?                                
         JE    NXTET36                                                          
         CLC   SVOFFL,SPACES                                                    
         JNH   *+14                                                             
         CLC   SVOFFL,ETYKOFFC     MATCH ON OFFICE LIST CODE                    
         JE    NXTET36                                                          
*                                                                               
         MVC   CSVKEY3,IOKEY                                                    
         L     R1,AOFFAREA                                                      
         USING OFFALD,R1                                                        
         MVC   OFFAOFFC(2),ETYKOFFC MOVE IN OFFICE AND VALIDATE                 
         MVI   OFFAACT,OFFAVAL                                                  
         GOTOR VOFFAL                                                           
         JNE   NXTET32                                                          
         MVC   IOKEY,CSVKEY3                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
         JE    *+6                                                              
         DC    H'0'                RESTORE READ SEQUENCE                        
         J     NXTET36                                                          
*                                                                               
NXTET32  OC    ELEMEN2(L'QETYCD),ELEMEN2  Any exp. type codes ?                 
         JZ    NXTET34             No - Read all                                
         AHI   R4,L'QETYCD                                                      
         ST    R4,AELEMEN2                                                      
         J     NXTET10             EXPENDITURE TYPE NOT VALID ON THIS           
*                                                                               
NXTET34  MVC   IOKEY,CSVKEY3                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
         JE    *+6                                                              
         DC    H'0'                RESTORE READ SEQUENCE                        
         J     NXTET20             EXPENDITURE TYPE NOT VALID                   
*                                                                               
NXTET36  OC    ELEMEN2(L'QETYCD),ELEMEN2  Any exp. type codes ?                 
         JNZ   *+14                                                             
         CLC   CSVKEY1(3),ETYKEY                                                
         JNE   NOMORE              End - change record type                     
         CLI   ETYKSEQ,0                                                        
         JNE   NXTET20                                                          
*                                                                               
         CLI   QAPPL,C' '          Any application passed?                      
         JNH   NXTET40                                                          
         LA    RE,ETYKSAEQ         Expenses                                     
         CLI   QAPPL,QEXPCLM                                                    
         JE    NXTET38                                                          
         LA    RE,ETYKSAOQ         Orders                                       
         CLI   QAPPL,QORD                                                       
         JE    NXTET38                                                          
         LA    RE,ETYKSAIQ         Invoices                                     
         CLI   QAPPL,QINV                                                       
         JNE   NXTET40                                                          
*                                                                               
NXTET38  BASR  RF,0                                                             
         EX    RE,8(RF)                                                         
         JZ    NXTET40                                                          
         TM    ETYKSAPP,0                                                       
         OC    ELEMEN2(L'QETYCD),ELEMEN2  Any limit list?                       
         JZ    NXTET20                                                          
         AHI   R4,L'QETYCD                                                      
         ST    R4,AELEMEN2                                                      
         J     NXTET10                                                          
*                                                                               
NXTET40  GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
         JE    *+6                                                              
         DC    H'0'                Bad master record                            
*                                                                               
         MVC   CSVKEY2,ETYKEY                                                   
*                                                                               
         LA    RE,EL_VALS                                                       
         LHI   RF,EL_VALQ                                                       
         XR    R0,R0                                                            
         XR    R1,R1                                                            
         MVCL  RE,R0                                                            
         MVI   EL_GAPYN,NOQ                                                     
         MVI   EL_GAPAQ,NOQ                                                     
         MVC   EL_NAME,SPACES                                                   
         MVC   EL_FNAM,SPACES                                                   
         MVC   EL_ECAT,SPACES                                                   
         MVC   EL_TYPS,=C'NNN'                                                  
*&&US*&& MVI   EL_VCOD,C' '                                                     
*&&US*&& MVC   EL_VACC,SPACES                                                   
*                                                                               
         L     R2,AIO1             Pass eType flags                             
         TM    ETYRSTA2,ETYSBILY                                                
         JZ    *+8                                                              
         MVI   EL_TYPS+0,C'Y'                                                   
         TM    ETYRSTA2,ETYSBILD                                                
         JZ    *+8                                                              
         MVI   EL_TYPS+0,C'D'                                                   
         TM    ETYRSTA2,ETYSNBLY                                                
         JZ    *+8                                                              
         MVI   EL_TYPS+1,C'Y'                                                   
         TM    ETYRSTA2,ETYSNBLD                                                
         JZ    *+8                                                              
         MVI   EL_TYPS+1,C'D'                                                   
         TM    ETYRSTA2,ETYSADVY                                                
         JZ    *+8                                                              
         MVI   EL_TYPS+2,C'Y'                                                   
         TM    ETYRSTA2,ETYSADVD                                                
         JZ    *+8                                                              
         MVI   EL_TYPS+2,C'D'                                                   
*                                  SELF APPROVAL                                
NXTET42  MVI   EL_SFAP,YESQ        SELF APPROVAL ALLOWWED                       
         TM    ETYRSTA2,ETYSFAP                                                 
         JZ    *+8                                                              
         MVI   EL_SFAP,NOQ                                                      
*                                                                               
NXTET44  MVC   EL_CODE,ETYKCODE    - PASS EXP. TYPE CODE                        
         MVI   EL_LCKD,C'N'                                                     
         TM    ETYRSTAT,ETYSLOCK                                                
         JZ    *+8                                                              
         MVI   EL_LCKD,C'Y'                                                     
*                                                                               
         MVI   EL_LFOR,NOQ                                                      
         TM    ETYRSAPP,ETYKSAOQ                                                
         JZ    *+8                                                              
         MVI   EL_LFOR,YESQ                                                     
         MVI   EL_LFEX,NOQ                                                      
         TM    ETYRSAPP,ETYKSAEQ                                                
         JZ    *+8                                                              
         MVI   EL_LFEX,YESQ                                                     
         MVI   EL_LFIN,NOQ                                                      
         TM    ETYRSAPP,ETYKSAIQ                                                
         JZ    *+8                                                              
         MVI   EL_LFIN,YESQ                                                     
*                                                                               
         USING NAMELD,R1                                                        
         LA    R1,ETYRFST                                                       
*                                                                               
NXTET46  CLI   NAMEL,0                                                          
         JE    NXTET60                                                          
         CLI   NAMEL,NAMELQ                                                     
         JE    NXTET50                                                          
         CLI   NAMEL,XNMELQ                                                     
         JE    NXTET52                                                          
*&&UK                                                                           
         CLI   NAMEL,SPAELQ                                                     
         JE    NXTET54                                                          
         CLI   NAMEL,ENMELQ                                                     
         JE    NXTET56                                                          
*&&                                                                             
         CLI   NAMEL,FFTELQ                                                     
         JE    NXTET58                                                          
NXTET48  XR    RE,RE                                                            
         IC    RE,NAMLN                                                         
         AR    R1,RE                                                            
         J     NXTET46                                                          
*                                                                               
NXTET50  IC    RE,NAMLN                                                         
         SHI   RE,NAMLN1Q+1        RE=LENGTH OF NAME - 1                        
         BASR  RF,0                                                             
         EX    RE,4(RF)                                                         
         MVC   EL_NAME(0),NAMEREC  PASS NAME OF EXP. TYPE                       
         J     NXTET48                                                          
*                                                                               
         USING XNMELD,R1                                                        
NXTET52  CLI   XNMLN,XNMLN1Q       pass exp. category                           
         JNH   NXTET48                                                          
         IC    RE,XNMSUBL                                                       
         SHI   RE,1                                                             
         BASR  RF,0                                                             
         EX    RE,4(RF)                                                         
         MVC   EL_ECAT(0),XNMSUBN                                               
         J     NXTET48                                                          
         DROP  R1                                                               
*                                                                               
*&&UK                                                                           
         USING SPAELD,R1                                                        
NXTET54  CLI   SPATYPE,SPATITAX    VAT account                                  
         JNE   NXTET48                                                          
         TM    CPYSTAT5,CPYSNVAT                                                
         JNZ   NXTET48                                                          
         MVC   EL_VACC,SPAAACT                                                  
         J     NXTET48                                                          
*                                                                               
         USING ENMELD,R1                                                        
NXTET56  IC    RE,ENMLN                                                         
         SHI   RE,ENMLNQ+1         RE=LENGTH OF NAME - 1                        
         BASR  RF,0                                                             
         EX    RE,4(RF)                                                         
         MVC   EL_FNAM(0),ENMNAME  PASS FOREIGN NAME OF EXP. TYPE               
         J     NXTET48                                                          
*&&                                                                             
         USING FFTELD,R1                                                        
NXTET58  CLI   FFTTYPE,FFTTVATC    VAT account                                  
         JNE   NXTET48                                                          
*&&UK*&& TM    CPYSTAT5,CPYSNVAT                                                
*&&UK*&& JZ    NXTET48                                                          
         MVC   EL_VCOD,FFTDATA                                                  
         J     NXTET48                                                          
         DROP  R1                                                               
*                                                                               
NXTET60  CLI   EL_VCOD,C' '        any VAT code present?                        
*&&UK*&& JNH   NXTET62                                                          
*&&US*&& JNH   NXTET64                                                          
         GOTOR RATCOD,0                                                         
         J     NXTET64                                                          
*&&UK                                                                           
NXTET62  CLC   EL_VACC,SPACES      any VAT account present?                     
         JNH   NXTET64                                                          
         GOTOR RATACC                                                           
*&&                                                                             
NXTET64  CLI   QEXTEN,YESQ        extension required?                           
         JNE   NXTET70                                                          
         LA    R2,ETYRFST          now pass sub lists                           
         MVI   BYTE1,0                                                          
         USING LIDELD,R2                                                        
NXTET66  CLI   LIDEL,0                                                          
         JE    NXTET70                                                          
         CLI   LIDEL,LIDELQ                                                     
         JNE   NXTET68             Get next element                             
         LA    R3,LIDDATA                                                       
         XR    R1,R1                                                            
         IC    R1,LIDLN                                                         
         AR    R1,R2               set end of list                              
         ST    R1,AENDLID          Store address of end of list element         
         ST    R3,ASTRLID          Store address of start of list ele           
         ST    R2,ALIDEL           Store address of list element                
         MVI   LP_RMODE,LP_RNEXT                                                
         CLI   BYTE1,0                                                          
         JE    EXITY                                                            
         J     NXTET74                                                          
                                                                                
NXTET68  XR    R1,R1                                                            
         IC    R1,LIDLN                                                         
         AR    R2,R1                                                            
         J     NXTET66                                                          
                                                                                
NXTET70  XC    ALIDEL,ALIDEL                                                    
         OC    ELEMEN2(L'QETYCD),ELEMEN2  Any exp. type codes ?                 
         JZ    EXITY               No - get all records                         
         L     R4,AELEMEN2                                                      
         AHI   R4,L'QETYCD                                                      
         ST    R4,AELEMEN2                                                      
         MVI   LP_RMODE,LP_RNEXT                                                
         J     EXITY                                                            
                                                                                
NXTET72  DS    0H                                                               
*&&UK                                                                           
         CLI   DLVLMODE,YESQ                                                    
         JNE   NXTET73                                                          
         LA    RE,EL_VALS          Clear output values                          
         LHI   RF,EL_VALQ                                                       
         XR    R0,R0                                                            
         XR    R1,R1                                                            
         MVCL  RE,R0                                                            
         MVC   EL_NAME,SPACES                                                   
         MVC   EL_FNAM,SPACES                                                   
         MVC   EL_ECAT,SPACES                                                   
         MVI   EL_VCOD,C' '                                                     
         MVC   EL_VACC,SPACES                                                   
         L     RE,DLVLRE                                                        
         BR    RE                                                               
*&&                                                                             
NXTET73  MVI   BYTE1,1                                                          
                                                                                
NXTET74  L     R3,ASTRLID                                                       
         L     R2,ALIDEL           No - read for next list element              
         LA    RE,EL_VALS          Clear output values                          
         LHI   RF,EL_VALQ                                                       
         XR    R0,R0                                                            
         XR    R1,R1                                                            
         MVCL  RE,R0                                                            
         MVC   EL_NAME,SPACES                                                   
         MVC   EL_FNAM,SPACES                                                   
         MVC   EL_ECAT,SPACES                                                   
*&&US*&& MVI   EL_VCOD,C' '                                                     
*&&US*&& MVC   EL_VACC,SPACES                                                   
                                                                                
         TM    0(R3),X'40'         TEST FIRST ENTRY MARKED AS DEFAULT           
         JNZ   *+12                NO                                           
         MVI   EL_DEFI,C'D'                                                     
         OI    0(R3),X'40'         RESTORE X'40' BIT FOR LOOKUP/DISPLAY         
         CLI   LIDTYPE,LIDTWKCD    work code(s)                                 
         JNE   NXTET90                                                          
*                                                                               
         CLI   CUCTRY,CTRYGER                                                   
         JNE   NXTET78                                                          
         CLI   QOTYP,QOTYPIQ                                                    
         JE    NXTET76                                                          
         CLI   0(R3),C'0'                                                       
         JL    NXTET132            skip for internal orders                     
         J     NXTET78                                                          
NXTET76  CLI   0(R3),C'0'          skip for external orders                     
         JNL   NXTET132                                                         
NXTET78  MVC   EL_WCDC,0(R3)                                                    
         MVC   TEMP2(L'EL_WCDC),0(R3)                                           
         GOTOR (#GETWCD,AGETWCD)   get work code description                    
         MVC   EL_WCDD,TEMP2                                                    
         MVC   EL_WCDF,SPACES                                                   
         L     R1,AIO3                                                          
         AHI   R1,WCORFST-WCORECD                                               
         USING XNMELD,R1                                                        
NXTET80  CLI   XNMEL,WCOELQ                                                     
         JE    NXTET86                                                          
         CLI   XNMEL,XNMELQ                                                     
         JE    NXTET84                                                          
         CLI   XNMEL,0                                                          
         JE    NXTET132                                                         
NXTET82  LLC   R0,XNMLN                                                         
         AR    R1,R0                                                            
         J     NXTET80                                                          
NXTET84  LLC   RE,XNMSUBL                                                       
         SHI   RE,2                                                             
         LTR   RE,RE                                                            
         JM    NXTET82                                                          
         BASR  RF,0                                                             
         EX    RE,4(RF)                                                         
         MVC   EL_WCDF(0),XNMSUBN                                               
         J     NXTET82                                                          
         USING WCOELD,R1                                                        
NXTET86  CLI   CUCTRY,CTRYGER                                                   
         JE    NXTET82                                                          
         CLI   QOTYP,QOTYPIQ                                                    
         JE    NXTET88                                                          
         TM    WCOSTAT,WCOSHCOE                                                 
         JNZ   NXTET132            skip for internal orders                     
         J     NXTET82                                                          
NXTET88  TM    WCOSTAT,WCOSHCOE    skip for external orders                     
         JZ    NXTET132                                                         
         J     NXTET82                                                          
         DROP  R1                                                               
*                                                                               
NXTET90  CLI   LIDTYPE,LIDTEXPS    expense a/c(s)                               
         JNE   NXTET101                                                         
         LR    R1,R3                set as default                              
*&&UK                                                                           
         MVI   DLVLMODE,NOQ                                                     
         GOTOR TSTACL,R3           test supplier account is high level          
         JE    NXTET90A                                                         
         LR    R1,R3                                                            
         J     NXTET90D                                                         
NXTET90A MVI   DLVLMODE,YESQ                                                    
         MVC   DHIGULA,0(R3)                                                    
         MVC   DLOWULA,DHIGULA                                                  
         LARL  RE,NXTET90B                                                      
         ST    RE,DLVLRE                                                        
NXTET90B GOTOR GETNLA              get low level account                        
         JE    NXTET90C                                                         
         MVI   DLVLMODE,NOQ                                                     
         L     R2,ALIDEL           Restore loop addresses                       
         L     R3,ASTRLID                                                       
         LLC   R0,LIDITLN                                                       
         AR    R3,R0                                                            
         XC    ASTRLID,ASTRLID     Clear for getting next lideld                
         C     R3,AENDLID                                                       
         JNL   NXTET68                                                          
         ST    R3,ASTRLID          Set next entry of data                       
         J     NXTET90                                                          
NXTET90C LA    R1,DLOWULA                                                       
NXTET90D DS    0H                                                               
*&&                                                                             
         MVC   EL_EXPC,0(R1)                                                    
         MVI   EL_ANAD,NOQ                                                      
         MVI   EL_PRAN,NOQ                                                      
         MVI   EL_ANAP,NOQ                                                      
         MVC   TEMP2(14),0(R1)                                                  
         GOTOR (#GETACN,AGETACN)   GET ACCOUNT NAME                             
         MVC   EL_EXPN,TEMP2                                                    
         MVC   EL_EXPF,SPACES                                                   
         MVC   EL_EXPS,=CL5'*NN**'                                              
*&&US                                                                           
         USING CATD,R1                                                          
         LA    R1,CATBLK           GET COST SETTING FROM CATCALL                
         XC    CATD(CATLNQ),CATD                                                
         MVC   CATDMGR,VDATAMGR                                                 
         MVC   CATSEAC(1),CUXCPY   COMPANY CODE                                 
         MVC   CATSEAC+1(L'ACTKULA),0(R3) SE ACCOUNT FROM ABOVE                 
         GOTO1 VCATCALL                                                         
*        CLI   CATERR,0            IF ANY PROBLEMS - DIE                        
*        JNE   *+16                                                             
         CLI   CATPST,C'Y'         DO THEY REQUIRE COST POSTINGS?               
         JNE   NXTET91                                                          
         MVI   EL_EXPS,YESQ        EQUIVALENT TO RSTCOSTG IN UK                 
         TM    CPYSTAT5,CPYSEXPP   Product required for exp                     
         JZ    NXTET91                                                          
         MVI   EL_PRAN,YESQ                                                     
*&&                                                                             
         USING RSTELD,R1                                                        
NXTET91  L     R1,AIO3                                                          
         AHI   R1,ACTRFST-ACTRECD                                               
         XR    R0,R0                                                            
NXTET92  CLI   RSTEL,0                                                          
         JE    NXTET132                                                         
         CLI   RSTEL,RSTELQ                                                     
         JE    NXTET96                                                          
         CLI   RSTEL,XNMELQ                                                     
         JE    NXTET100                                                         
NXTET94  IC    R0,RSTLN                                                         
         AR    R1,R0                                                            
         J     NXTET92                                                          
                                                                                
*                                                                               
NXTET96  DS    0H                                                               
*&&UK                                                                           
         CLI   RSTCOSTG,C' '                                                    
         JNH   *+10                                                             
         MVC   EL_EXPS+0(1),RSTCOSTG                                            
                                                                                
         TM    RSTSTAT5,RSTSPREA                                                
         JZ    *+8                                                              
         MVI   EL_PRAN,YESQ                                                     
         CLI   0(R3),C'S'                                                       
         JNE   NXTET98                                                          
         CLI   1(R3),C'E'                                                       
         JNE   NXTET98                                                          
*&&                                                                             
                                                                                
         TM    RSTSTAT1,RSTSEADD                                                
         JZ    *+8                                                              
         MVI   EL_ANAD,YESQ                                                     
         TM    RSTSTAT1,RSTSGPEI                                                
         JZ    *+8                                                              
         MVI   EL_ANAP,YESQ                                                     
                                                                                
NXTET98  CLI   RSTLN,RSTLN2Q                                                    
         JL    NXTET94                                                          
         TM    RSTSTAT4,RSTSJREA                                                
         JZ    *+8                                                              
         MVI   EL_EXPS+1,YESQ                                                   
         TM    RSTSTAT2,RSTSMILE                                                
         JZ    *+8                                                              
         MVI   EL_EXPS+2,YESQ                                                   
         J     NXTET94                                                          
*                                                                               
         USING XNMELD,R1                                                        
NXTET100 LLC   RE,XNMSUBL                                                       
         SHI   RE,2                                                             
         BASR  RF,0                                                             
         EX    RE,4(RF)                                                         
         MVC   EL_EXPF(0),XNMSUBN                                               
         J     NXTET94                                                          
         DROP  R1                                                               
*                                                                               
NXTET101 CLI   LIDTYPE,LIDTSUPP    supplier a/c(s)                              
         JNE   NXTET68                                                          
         MVI   EL_GAPYN,C' '       clear GAP settings                           
         MVI   EL_GAPAQ,C' '                                                    
         LR    R1,R3                                                            
*&&UK                                                                           
         MVI   DLVLMODE,NOQ                                                     
         GOTOR TSTACL,R3           test account is high level                   
         JE    NXTET102                                                         
         LR    R1,R3                                                            
         J     NXTET105                                                         
NXTET102 MVI   DLVLMODE,YESQ                                                    
         LARL  RE,NXTET103                                                      
         ST    RE,DLVLRE                                                        
         MVC   DHIGULA,0(R3)                                                    
         MVC   DLOWULA,DHIGULA                                                  
NXTET103 GOTOR GETNLA              get low level account                        
         JE    NXTET104                                                         
         MVI   DLVLMODE,NOQ                                                     
         L     R2,ALIDEL           Restore loop addresses                       
         L     R3,ASTRLID                                                       
         LLC   R0,LIDITLN                                                       
         AR    R3,R0                                                            
         XC    ASTRLID,ASTRLID     Clear for getting next lideld                
         C     R3,AENDLID                                                       
         JNL   NXTET68                                                          
         ST    R3,ASTRLID          Set next entry of data                       
         J     NXTET101                                                         
NXTET104 LA    R1,DLOWULA                                                       
NXTET105 DS    0H                                                               
*&&                                                                             
         MVC   EL_SUPC,0(R1)                                                    
         MVC   TEMP2(14),0(R1)                                                  
         GOTOR (#GETACN,AGETACN)   GET ACCOUNT NAME                             
         MVC   EL_SUPF,SPACES                                                   
         MVC   EL_SUPN,TEMP2                                                    
         CLC   TEMP2(36),SPACES    TEST SUPPLIER ACCOUNT WAS FOUND              
         JNH   NXTET120            NO                                           
         CLC   AGYCURR,TEMP2+36                                                 
         JE    NXTET106                                                         
         MVC   EL_SCUR,TEMP2+36                                                 
         OC    EL_SCUR,SPACES                                                   
         CLI   TEMP2+36,ASTCANY                                                 
         JNE   NXTET106                                                         
         MVC   EL_SCUR,=CL3'***'                                                
NXTET106 L     RE,AIO3             RE=A(SUPPLIER ACCOUNT)                       
*                                                                               
         XR    RF,RF                                                            
         ICM   RF,3,CUXPNUM        Only for rodick                              
         CHI   RF,XPRODIKQ                                                      
         JNE   NXTET10A                                                         
         MVI   EL_LCKD,NOQ         Check supplier locked flag                   
         TM    ACTRSTA-ACTRECD(RE),ACTSLOCK                                     
         JZ    *+8                                                              
         MVI   EL_LCKD,YESQ                                                     
*                                                                               
NXTET10A LA    R1,ACTRFST-ACTRECD(RE)                                           
         USING ADRELD,R1           FIND ADDRESS ELEMENT                         
         XC    AADREL,AADREL                                                    
         XC    AOATEL,AOATEL                                                    
NXTET107 CLI   ADREL,0             TEST EOR                                     
         JE    NXTET114                                                         
         CLI   ADREL,ADRELQ                                                     
         JE    NXTET110                                                         
         CLI   ADREL,OATELQ                                                     
         JE    NXTET110                                                         
         CLI   ADREL,RSTELQ                                                     
         JE    NXTET111                                                         
         CLI   ADREL,XNMELQ                                                     
         JE    NXTET112                                                         
NXTET108 LLC   R0,ADRLN                                                         
         AR    R1,R0                                                            
         J     NXTET107                                                         
*                                                                               
NXTET110 CLI   0(R1),ADRELQ        Is this the Main Address?                    
         JNE   *+12                                                             
         ST    R1,AADREL           Save for later                               
         J     NXTET108                                                         
         DROP  R1                                                               
*                                                                               
         USING OATELD,R1                                                        
         CLI   0(R1),OATELQ        Is this the Business Address?                
         JNE   NXTET108                                                         
         CLI   OATSUB,OATSUB5Q     Order Delivery Address                       
         JNE   NXTET108                                                         
         ST    R1,AOATEL           Save for later                               
         J     NXTET108                                                         
         DROP  R1                                                               
*                                                                               
         USING RSTELD,R1                                                        
NXTET111 DS    0H                                                               
*&&US                                                                           
         CLI   EL_GAPYN,YESQ       Is the GAP set at the lowest level           
         JNE   *+12                No - read higher levels                      
         CLI   EL_GAPAQ,YESQ                                                    
         JE    NXTET108            Yes - nothing to do                          
*&&                                                                             
*&&UK                                                                           
         CLI   EL_GAPYN,C' '       Is the GAP set at the lowest level           
         JNH   *+12                No - read higher levels                      
         CLI   EL_GAPAQ,C' '                                                    
         JH    NXTET108            Yes - nothing to do                          
*&&                                                                             
*&&US                                                                           
         TM    RSTSTAT7,RSTGAPYN   Pass GAP order settings                      
         JZ    *+8                                                              
         MVI   EL_GAPYN,YESQ                                                    
         TM    RSTSTAT7,RSTGAPAQ                                                
         JZ    *+8                                                              
         MVI   EL_GAPAQ,YESQ                                                    
*&&                                                                             
*&&UK                                                                           
         CLI   EL_GAPAQ,C' '       If already set don't override                
         JH    NXTET11A                                                         
         TM    RSTSTAT7,RSTGAPAY                                                
         JZ    *+8                                                              
         MVI   EL_GAPAQ,YESQ                                                    
         TM    RSTSTAT7,RSTGAPAN                                                
         JZ    *+8                                                              
         MVI   EL_GAPAQ,NOQ                                                     
*                                                                               
NXTET11A CLI   EL_GAPYN,C' '       If already set don't override                
         JH    NXTET108                                                         
         TM    RSTSTAT7,RSTGAPQY                                                
         JZ    *+8                                                              
         MVI   EL_GAPYN,YESQ                                                    
         TM    RSTSTAT7,RSTGAPQN                                                
         JZ    *+8                                                              
         MVI   EL_GAPYN,NOQ                                                     
*&&                                                                             
         J     NXTET108                                                         
*                                                                               
         USING XNMELD,R1                                                        
NXTET112 LLC   RE,XNMSUBL                                                       
         SHI   RE,2                                                             
         BASR  RF,0                                                             
         EX    RE,4(RF)                                                         
         MVC   EL_SUPF(0),XNMSUBN                                               
         J     NXTET108                                                         
*                                                                               
NXTET114 L     R4,AADREL                                                        
         OC    AOATEL,AOATEL                                                    
         JZ    NXTET120                                                         
         L     R4,AOATEL                                                        
         USING OATELD,R4                                                        
*&&UK                                                                           
         XR    R1,R1                                                            
         ICM   R1,1,OATNUM         N'ADDRESS LINES                              
         JZ    NXTET124                                                         
         CHI   R1,4                                                             
         JNH   *+8                                                              
         LA    R1,4                                                             
         LA    RF,OATADD1                                                       
         LA    RE,EL_SAD1                                                       
         J     NXTET122                                                         
*&&                                                                             
*&&US                                                                           
         TM    OATSTAT,OATCSZ                                                   
         JZ    NXTET116                                                         
         MVC   EL_SAD3,SPACES                                                   
         MVC   EL_SAD3(L'OATCITY),OATCITY                                       
         CLC   EL_SAD3,SPACES                                                   
         JNH   NXTET116                                                         
         LA    R1,EL_SAD3+L'EL_SAD3                                             
         ST    R1,FULL1                                                         
         AHI   R1,-1               Back up 1 byte to get in the field           
         CLI   0(R1),C' '          Find last significant character              
         JH    *+12                                                             
         AHI   R1,-1                                                            
         J     *-12                                                             
         L     RE,FULL1                                                         
         CR    RE,R1                                                            
         JNH   NXTET116                                                         
         MVI   1(R1),C','          put in comma                                 
         AHI   R1,3                Increase length to incl comma/space          
         CR    RE,R1                                                            
         JNH   NXTET116                                                         
         SR    RE,R1               Do we have enough room for ST                
         CHI   RE,L'OATSTATE                                                    
         JL    NXTET116                                                         
         MVC   0(L'OATSTATE,R1),OATSTATE                                        
         AHI   R1,L'OATSTATE+1                                                  
         L     RE,FULL1                                                         
         SR    RE,R1               Do we have enough room for ZIP               
         CHI   RE,L'OATZIP                                                      
         JL    NXTET116                                                         
         MVC   0(L'OATZIP,R1),OATZIP                                            
         AHI   R1,L'OATZIP                                                      
         L     RE,FULL1                                                         
         SR    RE,R1               Do we have enough room for EXT               
         CHI   RE,L'OATZIPRN                                                    
         JL    NXTET116                                                         
         MVC   0(L'OATZIPRN,R1),OATZIPRN                                        
*                                                                               
NXTET116 LA    R1,2                                                             
         LA    RF,OATLINE1                                                      
         LA    RE,EL_SAD1                                                       
NXTET118 MVC   0(L'EL_SAD1,RE),0(RF)                                            
         AHI   RE,L'EL_SAD1                                                     
         AHI   RF,L'OATLINE1                                                    
         JCT   R1,NXTET118                                                      
         J     NXTET124                                                         
*&&                                                                             
         USING ADRELD,R4                                                        
NXTET120 XR    R1,R1                                                            
         ICM   R1,1,ADRNUM         N'ADDRESS LINES                              
         JZ    NXTET124                                                         
         CHI   R1,4                                                             
         JNH   *+8                                                              
         LA    R1,4                                                             
         LA    RF,ADRADD1                                                       
         LA    RE,EL_SAD1                                                       
*                                                                               
NXTET122 MVC   0(L'ADRADD1,RE),0(RF)                                            
         AHI   RE,L'OATLINE1                                                    
         AHI   RF,L'ADRADD1                                                     
         JCT   R1,NXTET122                                                      
         DROP  R4                                                               
*                                                                               
NXTET124 CLC   EL_SUPC(2),=CL2'ST'       agent data retrieval?                  
         JNE   NXTET132                                                         
         XR    RE,RE                                                            
         IC    RE,LDGAL3                                                        
         CLI   LDGAL4,L'ACTKACT                                                 
         JE    NXTET126                                                         
         IC    RE,LDGAL2                                                        
         CLI   LDGAL3,L'ACTKACT                                                 
         JE    NXTET126                                                         
         IC    RE,LDGAL1                                                        
         CLI   LDGAL2,L'ACTKACT                                                 
         JE    NXTET126                                                         
         DC    H'0'                WHERE IS THE AGENT THEN?                     
NXTET126 AHI   RE,1                                                             
         MVC   TEMP2(14),SPACES                                                 
         BASR  RF,0                                                             
         EX    RE,4(RF)                                                         
         MVC   TEMP2(0),EL_SUPC                                                 
         MVC   EL_AGTC,TEMP2                                                    
         GOTOR (#GETACN,AGETACN)   GET ACCOUNT NAME                             
         MVC   EL_AGTN,TEMP2                                                    
*                                                                               
         CLC   TEMP2,SPACES        TEST AGENT ACCOUNT WAS FOUND                 
         JE    NXTET132            NO                                           
         L     RE,AIO3             RE=A(AGENT ACCOUNT)                          
         LA    RE,ACTRFST-ACTRECD(RE)                                           
         USING ADRELD,RE           FIND ADDRESS ELEMENT                         
NXTET128 CLI   ADREL,0             TEST EOR                                     
         JE    NXTET132                                                         
         CLI   ADREL,ADRELQ                                                     
         JE    *+14                                                             
         IC    R0,ADRLN                                                         
         AR    RE,R0                                                            
         J     NXTET128                                                         
         ICM   R0,1,ADRNUM         N'ADDRESS LINES                              
         JZ    NXTET132                                                         
         LA    RF,ADRADD1                                                       
         LA    RE,EL_AGA1                                                       
NXTET130 MVC   0(L'ADRADD1,RE),0(RF)                                            
         AHI   RE,L'ADRADD1                                                     
         AHI   RF,L'ADRADD1                                                     
         JCT   R0,NXTET130                                                      
         DROP  RE                                                               
*                                                                               
NXTET132 MVI   LP_RMODE,LP_RNEXT                                                
         MVI   BYTE1,0                                                          
*&&UK                                                                           
         CLI   DLVLMODE,YESQ                                                    
         JE    EXITY                                                            
*&&                                                                             
         XR    R0,R0                                                            
         IC    R0,LIDITLN                                                       
         AR    R3,R0                                                            
         XC    ASTRLID,ASTRLID     Clear for getting next lideld                
         C     R3,AENDLID                                                       
         JNL   NXTET68                                                          
         ST    R3,ASTRLID          Set next entry of data                       
         J     EXITY                                                            
*                                                                               
ETYLERR1 MVC   LP_ERROR,=AL2(AE$ENDOF)   FILE ERROR                             
         J     QERROR                                                           
         DROP  R1,R2                                                            
                                                                                
         EJECT                                                                  
                                                                                
*** Office List Download **********************************************         
                                                                                
REQOFFL  LKREQ H,A#OFFL,OUTOFFL,NEXTREQ=REQOINI                                 
                                                                                
Dummy    LKREQ F,01,(D,B#SAVED,QINITIAL),CHAR,OLEN=L'QINITIAL,         +        
               MAXLEN=L'QINITIAL,TEXT=AC#NOORD,COL=*                            
                                                                                
         LKREQ E                                                                
                                                                                
OUTOFFL  LKOUT H                                                                
                                                                                
OFFLST   LKOUT R,R#OFFL                                                         
Array    LKOUT C,R#OFFL,(A,ARYOFFL)                                             
                                                                                
         LKOUT E                                                                
                                                                                
         LKOUT X                                                                
                                                                                
ARYOFFL  LKOUT A,(R,NXTOFF),MULTIROW=Y,ROWNAME=OFFRECD                          
Code     LKOUT C,1,(D,B#SAVED,OOFFCODE),CHAR,ND=Y                               
Array    LKOUT C,2,(A,ARYOFNM)                                                  
Array    LKOUT C,3,(A,ARYOFFN)                                                  
*&&UK                                                                           
PRout    LKOUT P,,READOFF                                                       
Array    LKOUT C,4,(A,ARYCPX)                                                   
Array    LKOUT C,5,(A,ARYOFI)                                                   
*&&                                                                             
                                                                                
         LKOUT E                                                                
                                                                                
ARYOFNM  LKOUT A,(D,B#OFFREC,OFFRFST),NROWS=1,                         +        
               ROWID=(NAMEL,NAMELQ),ROWWIDTH=(V,NAMLN)                          
                                                                                
OffName  LKOUT C,2,NAMEREC,CHAR,LEN=V                                           
                                                                                
         LKOUT E                                                                
                                                                                
ARYOFFN  LKOUT A,(D,B#OFFREC,OFFRFST),NROWS=1,                         +        
               ROWID=(XNMEL,XNMELQ),ROWWIDTH=(V,XNMLN)                          
                                                                                
ForName  LKOUT C,3,XNMSUBN,CHAR,LEN=V                                           
                                                                                
         LKOUT E                                                                
                                                                                
*&&UK                                                                           
ARYOFI   LKOUT A,(D,B#OFFREC,OFFRFST),EOT=EOR,                         +        
               ROWID=(OFIEL,OFIELQ),ROWWIDTH=(V,OFILN)                          
Cocode   LKOUT C,5,OFICTRY,LBIN,ND=Y                                            
Cocurr   LKOUT C,6,OFICUR,CHAR,ND=Y                                             
                                                                                
         LKOUT E                                                                
*&&                                                                             
*&&UK                                                                           
ARYCPX   LKOUT A,(D,B#OFFREC,OFFRFST),EOT=EOR,                         +        
               ROWID=(CPXEL,CPXELQ),ROWWIDTH=(V,CPXLN)                          
                                                                                
RcvDte   LKOUT C,4,CPXSTATB,(R,EDTRCDT)                                         
                                                                                
         LKOUT E                                                                
*&&                                                                             
                                                                                
NXTOFF   MVC   OOFFCODE,SPACES                                                  
         TM    CPYSTAT4,CPYSOFF2                                                
         JZ    NXTOFF02                                                         
         GOTOR (#NXTREC,ANXTREC),DMCB,OFFKEYT,('B#OFFREC',0),          +        
               (0,SAVED),AOFFKF,0                                               
         JNE   EXITY                                                            
         L     R3,AIO2                                                          
         USING OFFRECD,R3                                                       
         MVC   OOFFCODE,OFFKOFF                                                 
         J     EXITY                                                            
                                                                                
NXTOFF02 MVC   IOKEY,SAVEKEY                                                    
         GOTOR (#NXTREC,ANXTREC),DMCB,A2DKEYT,('B#OFFREC',0),          +        
               (0,SAVED),AA2DKF,0                                               
         JNE   EXITY                                                            
         MVC   SAVEKEY,IOKEY                                                    
         L     R3,AIO2                                                          
         USING ACTRECD,R3                                                       
         MVC   OOFFCODE(1),ACTKACT                                              
         J     EXITY                                                            
         DROP  R3                                                               
         EJECT                                                                  
                                                                                
*&&UK                                                                           
READOFF  TM    CPYSTAT4,CPYSOFF2     If 2 char already have office rec          
         JNZ   EXIT                                                             
                                                                                
         LA    R2,IOKEY                                                         
         USING OFFRECD,R2                                                       
         MVC   OFFKEY,SPACES         read for office record                     
         MVI   OFFKTYP,OFFKTYPQ                                                 
         MVC   OFFKCPY,CUXCPY                                                   
         MVC   OFFKOFF,OOFFCODE                                                 
         MVC   CSVKEY1,OFFKEY                                                   
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JNE   EXIT                NO OFFICE RECORD                             
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         J     EXIT                                                             
                                                                                
***********************************************************************         
* Edit received date setting                                          *         
***********************************************************************         
         SPACE 1                                                                
EDTRCDT  LM    R2,R4,LP_AINP                                                    
         MVI   0(R4),C' '                                                       
         TM    0(R2),CPXIRDCO      Is the received date compulsory              
         JZ    EDTRCDT2                                                         
         MVI   0(R4),C'C'          Yes - set field as C                         
EDTRCDT2 TM    0(R2),CPXIRDOP      Is the received date optional                
         JZ    EDTRCDT4                                                         
         MVI   0(R4),C'O'          Yes - set field as O                         
EDTRCDT4 LHI   RE,1                                                             
         STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
         EJECT                                                                  
*&&                                                                             
                                                                                
*** initial Order Download  *******************************************         
                                                                                
REQOINI  LKREQ H,A#INIT,OUTOINI,NEXTREQ=REQEINI                                 
                                                                                
Dummy    LKREQ F,01,(D,B#SAVED,QINITIAL),CHAR,OLEN=L'QINITIAL,         +        
               MAXLEN=L'QINITIAL,TEXT=AC#NOORD,COL=*                            
Oovtm    LKREQ F,2,(D,B#SAVED,QGENINI2),CHAR,OLEN=L'QGENINI2,          +        
               MAXLEN=L'QGENINI2,TEXT=(*,OVERLIT),COL=*                         
                                                                                
         LKREQ E                                                                
                                                                                
OUTOINI  LKOUT H                                                                
                                                                                
OUTOIN   LKOUT R,R#INIT            Orders initial                               
Array    LKOUT C,R#INIT,(A,ARYOINI),FILTROUT=TSTBRRD1                           
         LKOUT E                                                                
                                                                                
GENINIO  LKOUT R,A#GINI            General initial                              
OrdIni   LKOUT P,,ORDINI                                                        
Array    LKOUT C,A#GINI,(A,ARYGINI),FILTROUT=TSTRODK1                           
         LKOUT E                                                                
                                                                                
OUTOVTMO LKOUT R,A#OVTM                                                         
Array    LKOUT C,A#OVTM,(A,ARYOVTM),FILTROUT=TSTGENTM                           
         LKOUT E                                                                
                                                                                
WCLISO   LKOUT R,A#WCOL            Aura get list of work code                   
Array    LKOUT C,A#WCOL,(A,ARYWCL),FILTROUT=TSTRODK2                            
         LKOUT E                                                                
*                                                                               
CLILISO  LKOUT R,A#ACTS           Aura get client account list                  
Array    LKOUT C,A#ACTS,(A,ARYCLI),FILTROUT=TSTRODK2                            
         LKOUT E                                                                
*                                                                               
CURLISO  LKOUT R,R#CURR                                                         
Array    LKOUT C,R#CURR,(A,ARYCUR),FILTROUT=TSTRINIT                            
         LKOUT E                                                                
*                                                                               
NARLISO  LKOUT R,R#NARR                                                         
Array    LKOUT C,R#NARR,(A,ARYNAR),FILTROUT=TSTRINIT                            
         LKOUT E                                                                
* '06' response for Brando                                                      
ETYLISO  LKOUT R,R#ETYL                                                         
Array    LKOUT C,R#ETYL,(A,ARYETYL),FILTROUT=TSTBINIT                           
         LKOUT E                                                                
* '71' response for Rodick                                                      
ETYLISR  LKOUT R,R#ETYP                                                         
Array    LKOUT C,R#ETYP,(A,ARYETYP),FILTROUT=TSTRODK1                           
         LKOUT E                                                                
*                                                                               
OFFLSTO  LKOUT R,R#OFFL                                                         
Array    LKOUT C,R#OFFL,(A,ARYOFFL),FILTROUT=TSTRINIT                           
         LKOUT E                                                                
*                                                                               
                                                                                
         LKOUT X                                                                
                                                                                
ARYOINI  LKOUT A,(R,GTORIN),ROWNAME=ORDPRFD                                     
                                                                                
RqPfx    LKOUT C,1,(D,B#WORKD,SCPYEL+(CPYREQPF-CPYELD)),CHAR,ND=Y,     +        
               LEN=1                                                            
RqSfx    LKOUT C,2,(D,B#WORKD,SCPYEL+(CPYREQSF-CPYELD)),CHAR,ND=Y,     +        
               LEN=1                                                            
PvtZero  LKOUT C,3,PROPO301,CHAR,ND=Y                                           
AgyCurr  LKOUT C,4,(D,B#WORKD,AGYCURR),CHAR,ND=Y                                
ForCurr  LKOUT C,5,(D,B#SAVED,OFCURR),CHAR,ND=Y                                 
OffInd   LKOUT C,6,(D,B#WORKD,OFFIND),CHAR,ND=Y                                 
Amnt     LKOUT C,7,MINOAMT,SPAK,ND=Y                                            
Prof1    LKOUT C,8,PROEBY02,CHAR,ND=Y,LEN=L'ULEBYPRF-1                          
Backdt   LKOUT C,9,(D,B#SAVED,OBDTE),CHAR,ND=Y                                  
CliLen   LKOUT C,10,(D,B#WORKD,PCLILEN),LBIN,ND=Y                               
ProLen   LKOUT C,11,(D,B#SAVED,OPROLEN),LBIN,ND=Y                               
JobLen   LKOUT C,12,(D,B#SAVED,OJOBLEN),LBIN,ND=Y                               
AllOrdr  LKOUT C,13,PROPO201,CHAR,ND=Y                                          
UseWC    LKOUT C,14,PROPO202,CHAR,ND=Y                                          
ReqExp   LKOUT C,15,(D,B#SAVED,ORQEX),CHAR,ND=Y                                 
SlfExp   LKOUT C,16,(D,B#SAVED,OSFEX),CHAR,ND=Y                                 
ReqInt   LKOUT C,17,(D,B#SAVED,ORQIN),CHAR,ND=Y                                 
SlfInt   LKOUT C,18,(D,B#SAVED,OSFIN),CHAR,ND=Y                                 
ReqArt   LKOUT C,19,(D,B#SAVED,ORQAR),CHAR,ND=Y                                 
SlfArt   LKOUT C,20,(D,B#SAVED,OSFAR),CHAR,ND=Y                                 
ReqPrd   LKOUT C,21,(D,B#SAVED,ORQPR),CHAR,ND=Y                                 
SlfPrd   LKOUT C,22,(D,B#SAVED,OSFPR),CHAR,ND=Y                                 
AmntPrd  LKOUT C,23,MINPAMT,SPAK,ND=Y                                           
AmntPrd  LKOUT C,24,MINEAMT,SPAK,ND=Y                                           
AmntPrd  LKOUT C,25,MINIAMT,SPAK,ND=Y                                           
AmntPrd  LKOUT C,26,MINAAMT,SPAK,ND=Y                                           
Analys   LKOUT C,27,PROEBY10,CHAR,ND=Y                                          
ExpCde   LKOUT C,28,PROPO304,CHAR,ND=Y                                          
OrdText  LKOUT C,29,(D,B#SAVED,ORDTEXT),CHAR,ND=Y                               
                                                                                
         LKOUT E                                                                
                                                                                
                                                                                
GTORIN   MVI   OFCURR,NOQ                                                       
         MVI   QAPPL,QORD                                                       
         MVI   QETYCD,C'*'                                                      
         MVI   ORDTEXT,NOQ                                                      
         TM    CPXSTATA,CPXORDRT       HTML TEXT FOR ORDER = on ?               
         JZ    GTOR001                 NO, CONTINUE                             
         MVI   ORDTEXT,YESQ                                                     
*                                                                               
GTOR001  TM    CPYSTAT6,CPYSFMCR+CPYSFOCR                                       
         JZ    GTOR002                                                          
                                                                                
*&&UK*&& TM    CPXSTAT9,CPXFCORD       Skip if not on for foreign               
*&&UK*&& JNZ   GTOR002                      currency order                      
                                                                                
         MVI   OFCURR,YESQ                                                      
GTOR002  GOTOR (#ORDPRF,AORDPRF),DMCB,X#ORPF                                    
T        USING ORDPRFD,X#ORPF                                                   
         MVC   ORQEX(6),=C'NNNNNN'                                              
         TM    T.RNSAIND,RNSAREQ       Y/N Requisition number EXPENSE           
         JZ    GTOR004                                                          
         MVI   ORQEX,YESQ                                                       
         SR    RF,RF                                                            
         ICM   RF,3,CUXPNUM                                                     
         CHI   RF,XPRODIKQ        Allow requisition number if prefix            
         JNE   GTOR004                             is set                       
         CLI   CPYREQPF,X'40'                                                   
         JH    GTOR004                                                          
         MVC   LP_ERROR,=AL2(AE$IAUBO)                                          
         J     QERROR                                                           
GTOR004  TM    T.RNSAIND,RNSASEQ       Y/N Allow self approval EXPENSE          
         JZ    GTOR006                                                          
         MVI   OSFEX,YESQ                                                       
GTOR006  TM    T.RNSAIND,RNSARIQ     Y/N Requisition number INTERNAL            
         JZ    GTOR008                                                          
         MVI   ORQIN,YESQ                                                       
GTOR008  TM    T.RNSAIND,RNSASIQ     Y/N Allow self approval INTERNAL           
         JZ    GTOR010                                                          
         MVI   OSFIN,YESQ                                                       
GTOR010  TM    T.RNSAIND,RNSARAQ     Y/N Requisition number ARTIST              
         JZ    GTOR012                                                          
         MVI   ORQAR,YESQ                                                       
GTOR012  TM    T.RNSAIND,RNSASAQ     Y/N Allow self approval ARTIST             
         JZ    GTOR014                                                          
         MVI   OSFAR,YESQ                                                       
GTOR014  TM    T.RNSAIND,RNSARPQ     Y/N Requisition number PRODUCTION          
         JZ    GTOR016                                                          
         MVI   ORQPR,YESQ                                                       
         SR    RF,RF                                                            
         ICM   RF,3,CUXPNUM                                                     
         CHI   RF,XPRODIKQ           Allow requisition number if prefix         
         JNE   GTOR016                                is set                    
         CLI   CPYREQPF,X'40'                                                   
         JH    GTOR016                                                          
         MVC   LP_ERROR,=AL2(AE$IAUBO)                                          
         J     QERROR                                                           
GTOR016  TM    T.RNSAIND,RNSASPQ     Y/N Allow self approval PRODUCTION         
         JZ    GTOR018                                                          
         MVI   OSFPR,YESQ                                                       
GTOR018  MVI   OBDTE,YESQ                                                       
*&&US                                                                           
***      L     R2,AGOBLOCK         read for OPT/MAINT agency level              
         L     R2,AGOBLOCB         read for OPT/MAINT agency level              
         USING GOBLOCKD,R2                                                      
         MVC   GOADM,VDATAMGR                                                   
         MVC   GOSELCUL(1),CUXCPY                                               
         MVC   GOSELCUL+1(2),PRODUL                                             
         MVI   GOWHICH,0                                                        
         GOTO1 VGETOPT,DMCB,GOBLOCKD                                            
         MVC   OBDTE,GOORDER      and set IN_BDO to NOQ accordingly             
*&&                                                                             
         LLC   RF,PPROLEN                                                       
         LLC   RE,PCLILEN                                                       
         SR    RF,RE                                                            
         STC   RF,OPROLEN                                                       
         LLC   RF,PJOBLEN                                                       
         LLC   RE,PPROLEN                                                       
         SR    RF,RE                                                            
         CHI   RF,6                                                             
         JNH   *+8                                                              
         LHI   RF,6                                                             
         STC   RF,OJOBLEN                                                       
         LA    R2,X#ORPF                                                        
         ST    R2,LP_ADATA                                                      
         J     EXITY                                                            
         DROP  T                                                                
                                                                                
TSTQINIT CLI   QINITIAL,QAPPRVR                                                 
         BR    RE                                                               
                                                                                
* Brandocean, and Qinit=A                                                       
                                                                                
TSTBINIT DS    0H                                                               
         SR    RF,RF                                                            
         ICM   RF,3,CUXPNUM                                                     
         CHI   RF,XPRODIKQ                                                      
         JE    SETCCC                                                           
         CLI   QINITIAL,QAPPRVR                                                 
         BR    RE                                                               
                                                                                
* Brandocean, and Qinit=A                                                       
                                                                                
TSTRINIT DS    0H                                                               
         SR    RF,RF                                                            
         ICM   RF,3,CUXPNUM                                                     
         CHI   RF,XPRODIKQ                                                      
         JE    TSTRIN02                                                         
         CLI   QINITIAL,QAPPRVR    If Brandocean only for approver              
         BR    RE                                                               
TSTRIN02 CLI   QINITIAL,QAPLINI    If Aura only for all or 2nd request          
         BER   RE                                                               
         CLI   QINITIAL,QJB2ND                                                  
         BR    RE                                                               
*                                                                               
TSTQINII SR    RF,RF                                                            
         ICM   RF,3,CUXPNUM                                                     
         CHI   RF,XPRODIKQ                                                      
         JNE   SETCCC                                                           
         CLI   QINITIAL,0                                                       
         BR    RE                                                               
                                                                                
TSTBINII SR    RF,RF                                                            
         ICM   RF,3,CUXPNUM                                                     
         CHI   RF,XPRODIKQ                                                      
         JE    SETCCC                                                           
         CLI   QINITIAL,QINIONLY                                                
         J     SETCCC                                                           
         EJECT                                                                  
                                                                                
*** Initial Estimate Download  ****************************************         
                                                                                
REQEINI  LKREQ H,A#EINI,OUTEINI,NEXTREQ=REQESCH                                 
                                                                                
Dummy    LKREQ F,01,(D,B#SAVED,QINITIAL),CHAR,OLEN=L'QINITIAL,         +        
               MAXLEN=L'QINITIAL,TEXT=AC#NOORD,COL=*                            
Eovtm    LKREQ F,2,(D,B#SAVED,QGENINI2),CHAR,OLEN=L'QGENINI2,          +        
               MAXLEN=L'QGENINI2,TEXT=(*,OVERLIT),COL=*                         
                                                                                
         LKREQ E                                                                
                                                                                
OUTEINI  LKOUT H                                                                
                                                                                
OUTEIN   LKOUT R,R#EINI                                                         
Array    LKOUT C,R#EINI,(A,ARYEINI),FILTROUT=TSTBRRD1                           
         LKOUT E                                                                
                                                                                
GENINIE  LKOUT R,A#GINI            General initial                              
EstIni   LKOUT P,,ESTINI                                                        
Array    LKOUT C,A#GINI,(A,ARYGINI),FILTROUT=TSTRODK1                           
         LKOUT E                                                                
                                                                                
OUTOVTME LKOUT R,A#OVTM                                                         
Array    LKOUT C,A#OVTM,(A,ARYOVTM),FILTROUT=TSTGENTM                           
         LKOUT E                                                                
                                                                                
CURLISE  LKOUT R,R#CURR                                                         
Array    LKOUT C,R#CURR,(A,ARYCUR),FILTROUT=TSTBRRD2                            
         LKOUT E                                                                
                                                                                
NARLISE  LKOUT R,R#NARR                                                         
Array    LKOUT C,R#NARR,(A,ARYNAR),FILTROUT=TSTBRRD2                            
         LKOUT E                                                                
                                                                                
MEDLISE  LKOUT R,R#MEDC                                                         
Array    LKOUT C,R#MEDC,(A,ARYMED),FILTROUT=TSTBRRD2                            
         LKOUT E                                                                
                                                                                
SCHLISE  LKOUT R,R#ESCH                                                         
SchIni   LKOUT P,,SCHINI                                                        
LimLSc   LKOUT C,1,(A,ARYLID),FILTROUT=TSTLLS2                                  
SchLid   LKOUT C,1,(A,ARYSCH),FILTROUT=TSTLID2                                  
         LKOUT E                                                                
                                                                                
REFLISE  LKOUT R,R#REFO                                                         
Array    LKOUT C,R#REFO,(A,ARYERF),FILTROUT=TSTBRRD2                            
         LKOUT E                                                                
                                                                                
         LKOUT X                                                                
                                                                                
ARYEINI  LKOUT A,(R,GTESIN),ROWNAME=SAVED                                       
AgyCurr  LKOUT C,1,(D,B#WORKD,AGYCURR),CHAR,ND=Y                                
OffInd   LKOUT C,2,(D,B#WORKD,OFFIND),CHAR,ND=Y                                 
ForCurr  LKOUT C,3,OFCURR,CHAR,ND=Y                                             
NiWC     LKOUT C,4,(D,B#WORKD,SCPYEL+(CPYNICWC-CPYELD)),CHAR,          +        
               LEN=L'CPYNICWC,ND=Y                                              
TAGN     LKOUT C,05,EI_TAGN,CHAR,ND=Y                                           
TAED     LKOUT C,06,EI_TAED,PDAT,ND=Y                                           
TNV1     LKOUT C,07,EI_TNV1,SPAK,ND=Y,PZERO=S                                   
TPC1     LKOUT C,08,EI_TPC1,SPAK,ND=Y,PZERO=S                                   
TNV2     LKOUT C,09,EI_TNV2,SPAK,ND=Y,PZERO=S                                   
TPC2     LKOUT C,10,EI_TPC2,SPAK,ND=Y,PZERO=S                                   
TNV3     LKOUT C,11,EI_TNV3,SPAK,ND=Y,PZERO=S                                   
TPC3     LKOUT C,12,EI_TPC3,SPAK,ND=Y,PZERO=S                                   
TNV4     LKOUT C,13,EI_TNV4,SPAK,ND=Y,PZERO=S                                   
TPC4     LKOUT C,14,EI_TPC4,SPAK,ND=Y,PZERO=S                                   
CliLen   LKOUT C,15,(D,B#WORKD,PCLILEN),LBIN,ND=Y                               
IntApp   LKOUT C,16,EI_IAYN,CHAR,ND=Y                                           
SelApp   LKOUT C,17,EI_SAYN,CHAR,ND=Y                                           
Rtxt     LKOUT C,18,EI_RTXT,CHAR,ND=Y                                           
Array    LKOUT C,99,(A,ARYNIC),FILTROUT=TSTRODN                                 
                                                                                
         LKOUT E                                                                
                                                                                
ARYNIC   LKOUT A,(R,GETNIC),ROWNAME=GRECD,FILTROUT=TSTGER                       
Array    LKOUT C,1,(A,ARYVAT1)                                                  
Array    LKOUT C,2,(A,ARYNIC1)                                                  
                                                                                
         LKOUT E                                                                
                                                                                
ARYVAT1  DS    0H                                                               
*&&DO                                                                           
ARYVAT1  LKOUT A,(D,B#NICREC,GFFSYS+L'GFFSYS),EOT=EOR,NEWEL=B,         +        
               ROWID=(GFVATEL,GFVATELQ),ROWWIDTH=(V,GFVATELL)                   
                                                                                
VATPct   LKOUT C,01,GFVATP,LBIN,ND=Y                                            
                                                                                
         LKOUT E                                                                
*&&                                                                             
                                                                                
ARYNIC1  LKOUT A,(D,B#NICREC,GFFSYS+L'GFFSYS),EOT=EOR,NEWEL=B,         +        
               ROWID=(GFNICEL,GFNICELQ),ROWWIDTH=(V,GFNICELL)                   
                                                                                
Type     LKOUT C,01,GFNICTYP,CHAR,ND=Y                                          
Week     LKOUT C,02,GFNICWHI,LBIN,ND=Y                                          
Month    LKOUT C,03,GFNICMHI,LBIN,ND=Y                                          
A%       LKOUT C,04,GFNICAPC,LBIN,ND=Y                                          
B%       LKOUT C,05,GFNICBPC,LBIN,ND=Y                                          
C%       LKOUT C,06,GFNICCPC,LBIN,ND=Y                                          
*&&UK                                                                           
J%       LKOUT C,07,GFNICJPC,LBIN,ND=Y                                          
*&&                                                                             
                                                                                
         LKOUT E                                                                
                                                                                
GTESIN   ST    R8,LP_ADATA                                                      
         MVI   OFCURR,NOQ                                                       
*&&UK*&& MVI   QNARAPP,QEST        ensure we only get est narrative             
         TM    CPYSTATA,CPYSFCES                                                
         JZ    GTESIN02                                                         
         MVI   OFCURR,YESQ                                                      
                                                                                
GTESIN02 DS    0H                  for UK get TVR/NIC bands                     
*&&UK                                                                           
                                                                                
GTESIN03 CLI   CUCTRY,CTRYDFL                                                   
         JE    GTESIN04                                                         
         CLI   CUCTRY,CTRYGBR                                                   
         JNE   GTESIN06                                                         
                                                                                
GTESIN04 GOTOR GETBND                                                           
*&&                                                                             
                                                                                
GTESIN06 MVI   EI_IAYN,NOQ                                                      
         TM    G#OFSTA2,OFFSIAEQ       Internal approvals?                      
         JZ    GTESIN07                                                         
         MVI   EI_IAYN,YESQ            Yes                                      
*        SR    RF,RF                                                            
*        ICM   RF,3,CUXPNUM                                                     
*        CHI   RF,XPRODIKQ             Are we Aura                              
*        JNE   GTESIN07                No                                       
*        MVC   LP_ERROR,=AL2(AE$IAPES) Internal approvers please use            
*        J     QERROR                                Brandocean                 
                                                                                
GTESIN07 MVI   EI_SAYN,NOQ                                                      
         TM    CPXSTAT2,CPXSFAPE  Self approvals?                               
         JZ    GTESIN08                                                         
         MVI   EI_SAYN,YESQ                                                     
                                                                                
GTESIN08 MVI   EI_RTXT,NOQ                                                      
         TM    CPXSTATA,CPXESTRT  Rich text?                                    
         JZ    GTESIN10                                                         
         MVI   EI_RTXT,YESQ                                                     
                                                                                
GTESIN10 MVI   QSCTYP,QSCTIQ                                                    
         MVI   QMCTYP,QMCTLQ                                                    
         MVI   QAPPL,QEST                                                       
         XR    RF,RF                  For Aura return non-ISO currs             
         ICM   RF,B'0011',CUXPNUM                                               
         CHI   RF,XPRODIKQ                                                      
         JNE   EXITY                                                            
         MVI   QCLALL,C'A'                                                      
         J     EXITY                                                            
                                                                                
* Get NIC PARMS for initial call                                                
         USING GFEED,R2                                                         
GETNIC   LA    R2,IOKEY                                                         
         XC    GFKEY,GFKEY                                                      
         MVI   GFKMIN,GFKMINQ                                                   
         MVI   GFKREC,GFKNICQ                                                   
         MVC   LP_ADATA,AIO2                                                    
         MVI   LP_RMODE,LP_RNEXT                                                
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IOGND+IO2'                               
         JNE   EXITN                                                            
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOGNF+IO2'                              
         JNE   EXITN                                                            
         J     EXITY                                                            
                                                                                
         DROP  R2                                                               
                                                                                
TSTGER   DS    0H                                                               
*&&UK                                                                           
         CLI   CUCTRY,CTRYDFL                                                   
         BER   RE                                                               
*&&                                                                             
         CLI   CUCTRY,CTRYGBR                                                   
         BR    RE                                                               
                                                                                
*** Schemes ***********************************************************         
                                                                                
REQESCH  LKREQ H,A#ESCH,OUTESCH,NEXTREQ=REQREFO                                 
                                                                                
Type     LKREQ F,01,(D,B#SAVED,QSCTYP),CHAR,OLEN=L'QSCTYP,             +        
               MAXLEN=L'QSCTYP,TEXT=AC#TYPE,COL=*                               
Code     LKREQ F,02,(D,B#SAVED,QSCCOD),CHAR,OLEN=L'QSCCOD,             +        
               MAXLEN=L'QSCCOD,TEXT=AC#SCMCD,COL=*                              
CliC     LKREQ F,03,(D,B#SAVED,QSCCLI),CHAR,OLEN=L'QSCCLI,             +        
               MAXLEN=L'QSCCLI,TEXT=AC#CLIC,COL=*                               
ProC     LKREQ F,04,(D,B#SAVED,QSCPRO),CHAR,OLEN=L'QSCPRO,             +        
               MAXLEN=L'QSCPRO,TEXT=AC#PROC,COL=*                               
JobC     LKREQ F,05,(D,B#SAVED,QSCJOB),CHAR,OLEN=L'QSCJOB,             +        
               MAXLEN=L'QSCJOB,TEXT=AC#JOBC,COL=*                               
                                                                                
         LKREQ E                                                                
                                                                                
OUTESCH  LKOUT H                                                                
                                                                                
OUTSCH   LKOUT R,R#ESCH                                                         
SchIni   LKOUT P,,SCHINI                                                        
LimLSc   LKOUT C,1,(A,ARYLID),FILTROUT=TSTLLS                                   
SchLid   LKOUT C,1,(A,ARYSCH),FILTROUT=TSTLID                                   
                                                                                
         LKOUT E                                                                
                                                                                
         LKOUT X                                                                
                                                                                
ARYLID   LKOUT A,(D,B#LLSREC,LLSRFST),EOT=EOR,NEWEL=B,                 +        
               ROWID=(LIDEL,LIDELQ),ROWWIDTH=(V,LIDLN)                          
PRout    LKOUT P,LIDTYPE,SETTTYPE                                               
Array    LKOUT C,52,(A,ARYLID2),FILTROUT=TSTLESCH                               
                                                                                
         LKOUT E                                                                
                                                                                
ARYLID2  LKOUT A,(*,LIDDATA),ROWNAME=LIDEL,NROWS=*,ROWWIDTH=LIDLLN5Q,  +        
               NEWEL=B                                                          
PRout    LKOUT P,LIDLAPPL,SETTTYPE                                              
Code     LKOUT C,1,LIDLSCH,CHAR,LEN=L'LIDLSCH,FILTROUT=TSTLESTM,       +        
               SKIPCOLS=3                                                       
SchNam   LKOUT C,2,LIDLSCH,(U,#EDTSCN,$EDTSCN)                                  
DefI     LKOUT C,3,LIDLSCH,(R,EDTDFLT)           for setting ODEFLT             
                                                                                
         LKOUT E                                                                
                                                                                
ARYSCH   LKOUT A,(R,NXTSCH),MULTIROW=Y,ROWNAME=SCHRECD                          
                                                                                
Code     LKOUT C,1,SCHKCODE,CHAR,ND=Y                                           
Array    LKOUT C,2,(A,ARYSCHN)                                                  
DefI     LKOUT C,3,(D,B#SAVED,ODEFLT),CHAR,ND=Y                                 
Cutoff   LKOUT C,4,(A,ARYGDAE)                                                  
                                                                                
         LKOUT E                                                                
                                                                                
ARYSCHN  LKOUT A,(D,B#SCHEME,SCHRFST),EOT=EOR,                         +        
               ROWID=(SCHEL,SCHELQ),ROWWIDTH=(V,SCHLN)                          
                                                                                
SchName  LKOUT C,2,SCHNAME,CHAR,LEN=V                                           
                                                                                
         LKOUT E                                                                
                                                                                
ARYGDAE  LKOUT A,(D,B#SCHEME,SCHRFST),EOT=EOR,                         +        
               ROWID=(GDAEL,GDAELQ),ROWWIDTH=(V,GDALN)                          
                                                                                
PRout    LKOUT P,GDATYPE,SETTTYPE                                               
Cutoff   LKOUT C,4,GDADATE,PDAT,FILTROUT=TSTSEXP                                
                                                                                
         LKOUT E                                                                
                                                                                
SCHINI   CLI   QSCTYP,QSCTIQ       initial list requested?                      
         JE    SCHINI02                                                         
         GOTOR GETOMD              get opt/maint default                        
         JE    SCHINI00                                                         
                                                                                
         MVC   LP_ERROR,=AL2(AE$INACC)                                          
         J     QERROR                                                           
                                                                                
SCHINI00 CLI   DOMETY,C'M'         MCS estimate type?                           
         JE    SCHINI02                                                         
                                                                                
         CLC   QSCJOB+1(L'QSCJOB-1),SPACES      job level request?              
         JNH   SCHINI02            no, then allow for non MCS, too              
         MVC   LP_ERROR,=AL2(AE$NOMCS)                                          
         J     QERROR                                                           
                                                                                
SCHINI02 GOTOR ACCRUL                                                           
                                                                                
         USING LLSRECD,R4                                                       
         LA    R4,IOKEY                                                         
         XC    LLSKEY,LLSKEY                                                    
         MVI   LLSKTYP,LLSKTYPQ                                                 
         MVI   LLSKSUB,LLSKSUBQ                                                 
         MVC   LLSKCPY,CUXCPY                                                   
         MVC   LLSKPIDB,CCTPID                                                  
         MVC   CSVKEY1,LLSKEY                                                   
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         JNE   SCHINIX                                                          
         J     SCHINI04                                                         
                                                                                
SCHINI03 L     R4,AIO2                                                          
         MVC   CSVKEY1,0(R4)                                                    
         MVC   IOKEY,0(R4)                                                      
         LA    R4,IOKEY                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         JNE   *+2                                                              
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
         JNE   SCHINIX                                                          
                                                                                
SCHINI04 CLI   CSVKEY1+LLSKSUB-LLSKEY,LLSKSUBQ                                  
         JE    SCHINI05                                                         
         CLC   LLSKEY(GLSKSEQ-GLSKEY),CSVKEY1                                   
         JNE   SCHINIX                                                          
         J     SCHINI06                                                         
                                                                                
SCHINI05 CLC   LLSKEY(LLSKGRP-LLSRECD),CSVKEY1                                  
         JNE   SCHINIX                                                          
                                                                                
SCHINI06 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JNE   *+2                                                              
                                                                                
         USING LIDELD,RF                                                        
         L     RF,AIO2                                                          
         AHI   RF,LLSRFST-LLSRECD                                               
SCHINI07 CLI   LIDEL,0                                                          
         JE    SCHINI03                                                         
         CLI   LIDEL,LIDELQ                                                     
         JNE   SCHINI12                                                         
         CLI   LIDTYPE,LIDTESCH                                                 
         JNE   SCHINI14                                                         
         LA    RE,LIDDATA                                                       
LL       USING LIDDATA,RE                                                       
         LLC   R1,LIDLN                                                         
         AR    R1,RF                                                            
SCHINI08 CR    RE,R1                                                            
         JNL   SCHINI14                                                         
         TM    LL.LIDLAPPL,LIDLESTM                                             
         JNZ   SCHINI10                                                         
         AHI   RE,LIDLLN5Q                                                      
         J     SCHINI08                                                         
         DROP  LL                                                               
                                                                                
SCHINI10 MVI   LL_DESTA,LL_LISTQ                                                
         J     SCHINIX                                                          
                                                                                
SCHINI12 CLI   LIDEL,RSTELQ                                                     
         JE    SCHINI16                                                         
SCHINI14 LLC   R0,LIDLN                                                         
         AR    RF,R0                                                            
         J     SCHINI07                                                         
                                                                                
         USING RSTELD,RF                                                        
SCHINI16 TM    RSTACST1,RSTASCHM   Scheme list                                  
         JZ    SCHINI14                                                         
         MVI   LL_DESTA,LL_NONEQ                                                
         J     SCHINI14                                                         
SCHINIX  J     EXITY                                                            
         DROP  RF                                                               
                                                                                
TSTLLS   CLI   LL_DESTA,LL_LISTQ                                                
         BR    RE                                                               
                                                                                
TSTLID   CLI   LL_DESTA,LL_ALLQ                                                 
         BR    RE                                                               
                                                                                
SETTTYPE L     R1,LP_AINP          Set type of free form element                
         MVC   WORK(L'FFTTYPE),0(R1)                                            
         J     EXIT                                                             
*                                                                               
         USING LOCELD,R1                                                        
SETLOADT L     R1,LP_AINP                                                       
         MVI   BYTE1,YESQ          Set don't skip                               
         CLI   QSPLOC,C'L'         Test whether we want latest location         
         JNE   EXITY                                                            
         OC    LOCEND,LOCEND                                                    
         JZ    *+14                                                             
         CLC   LOCEND,D_TODAYP     Is end date before today?                    
         JNH   SETLOADN                                                         
         CLC   LOCSTART,D_TODAYP   Is start date after today?                   
         JH    SETLOADN                                                         
         J     EXITY                                                            
         DROP  R1                                                               
*                                                                               
SETLOADN MVI   BYTE1,NOQ           Set skip                                     
         J     EXITY                                                            
*                                                                               
JOBINI   MVI   QNAM,YESQ                                                        
         MVI   QMCTYP,QMCTLQ                                                    
         MVI   QAPPL,QJOB                                                       
         MVC   QUNLDG,PRODUL                                                    
         MVI   QGENINIT,QGENINI                                                 
         J     EXIT                                                             
                                                                                
ESTINI   MVI   QSCTYP,QSCTIQ                                                    
         MVI   QMCTYP,QMCTLQ                                                    
         MVI   QAPPL,QEST                                                       
         MVI   QNARAPP,C'E'        ESTIMATES                                    
         MVC   QUNLDG,PRODUL                                                    
         MVI   QGENINIT,QGENINI                                                 
         J     EXITY                                                            
                                                                                
ORDINI   MVI   QSCTYP,QSCTIQ                                                    
         MVI   QMCTYP,QMCTLQ                                                    
         MVI   QAPPL,QORD                                                       
         MVC   QUNLDG,PRODUL                                                    
         MVI   QNAM,YESQ                                                        
         MVI   QGENINIT,QOEIGINI                                                
         MVI   QNARAPP,C'O'        Orders                                       
         J     EXITY                                                            
                                                                                
EXPINI   MVI   QAPPL,QEXPCLM                                                    
         MVC   QUNLDG,PRODUL                                                    
         MVI   QNAM,YESQ                                                        
         MVI   QGENINIT,QOEIGINI                                                
         MVI   QNARAPP,C'X'        Expenses                                     
*&&UK*&& MVI   QBATYP,70                                                        
*&&US*&& MVI   QBATYP,10                                                        
         J     EXITY                                                            
                                                                                
INVINI   MVI   QAPPL,QINV          Invoices                                     
         MVI   QNARAPP,QINV                                                     
         MVI   QBATYP,72           Invoice batch type                           
         J     EXITY                                                            
                                                                                
TSTLESCH CLI   WORK,LIDTESCH                                                    
         BR    RE                                                               
                                                                                
TSTLESTM TM    WORK,LIDLESTM                                                    
         J     SETCCC                                                           
                                                                                
TSTRODK  SR    RF,RF                                                            
         ICM   RF,3,CUXPNUM        Check whether Brandocean rewrite             
         CHI   RF,XPRODIKQ          app is connected                            
         BR    RE                                                               
                                                                                
TSTRODK1 SR    RF,RF                                                            
         ICM   RF,3,CUXPNUM        Check whether Brandocean rewrite             
         CHI   RF,XPRODIKQ          app is connected                            
         BNER  RE                                                               
         CLI   QINITIAL,QAPLINI                                                 
         BER   RE                                                               
         CLI   QINITIAL,0                                                       
         BER   RE                                                               
         CLI   QINITIAL,QJB1ST                                                  
         BR    RE                                                               
                                                                                
TSTRODK2 SR    RF,RF                                                            
         ICM   RF,3,CUXPNUM        Check whether Brandocean rewrite             
         CHI   RF,XPRODIKQ          app is connected                            
         BNER  RE                                                               
         CLI   QINITIAL,QAPLINI                                                 
         BER   RE                                                               
         CLI   QINITIAL,QJB2ND                                                  
         BR    RE                                                               
                                                                                
TSTBRRD1 CLI   QINITIAL,QAPLINI                                                 
         BER   RE                                                               
         CLI   QINITIAL,X'00'                                                   
         BER   RE                                                               
         CLI   QINITIAL,QAPPRVR                                                 
         BER   RE                                                               
         CLI   QINITIAL,QJB1ST                                                  
         BR    RE                                                               
                                                                                
TSTBRRD2 CLI   QINITIAL,QAPLINI                                                 
         BER   RE                                                               
         CLI   QINITIAL,QJB2ND                                                  
         BR    RE                                                               
                                                                                
TSTLLS2  CLI   LL_DESTA,LL_LISTQ                                                
         BNER  RE                                                               
         CLI   QINITIAL,QAPLINI                                                 
         BER   RE                                                               
         CLI   QINITIAL,QJB2ND                                                  
         BR    RE                                                               
                                                                                
TSTLID2  CLI   LL_DESTA,LL_ALLQ                                                 
         BNER  RE                                                               
         CLI   QINITIAL,QAPLINI                                                 
         BER   RE                                                               
         CLI   QINITIAL,QJB2ND                                                  
         BR    RE                                                               
                                                                                
TSTRODN  SR    RF,RF                                                            
         ICM   RF,3,CUXPNUM        Check whether Brandocean rewrite             
         CHI   RF,XPRODIKQ          app is connected                            
         J     SETCCC              If not don't include                         
                                                                                
EDTDFLT  LM    R2,R4,LP_AINP                                                    
         MVI   0(R4),NOQ                                                        
         CLC   DOMDEF,0(R2)                                                     
         JNE   EDTDFLT2                                                         
         MVI   0(R4),YESQ                                                       
EDTDFLT2 LHI   R3,1                                                             
         STCM  R3,15,LP_OLEN                                                    
         J     EXITY                                                            
                                                                                
NXTSCH   CLI   LP_RMODE,LP_RFRST   First time?                                  
         JNE   NXTSCH04                                                         
                                                                                
         CLI   QSCTYP,QSCTIQ       initial list requested?                      
         JE    NXTSCH04                                                         
                                                                                
         GOTOR GETOMD              get opt/maint default                        
         JE    NXTSCH02                                                         
                                                                                
         MVC   LP_ERROR,=AL2(AE$INACC)                                          
         J     QERROR                                                           
                                                                                
NXTSCH02 CLI   DOMETY,C'M'         MCS estimate type?                           
         JE    NXTSCH04                                                         
                                                                                
         CLC   QSCJOB+1(L'QSCJOB-1),SPACES      job level request?              
         JNH   NXTSCH04            no, then allow for non MCS, too              
         MVC   LP_ERROR,=AL2(AE$NOMCS)                                          
         J     QERROR                                                           
                                                                                
NXTSCH04 GOTOR (#NXTREC,ANXTREC),DMCB,SCHKEYT,('B#SCHEME',0),          +        
               (0,SAVED),ASCHKF,ASCHRF                                          
         J     EXITY                                                            
                                                                                
*** Report Formats Download  ******************************************         
                                                                                
REQREFO  LKREQ H,A#REFO,OUTREFO,NEXTREQ=REQMED                                  
                                                                                
Appl     LKREQ F,01,(D,B#SAVED,QAPPL),CHAR,OLEN=L'QAPPL,               +        
               MAXLEN=L'QAPPL,TEXT=AC#APPLI,COL=*                               
EType    LKREQ F,02,(D,B#SAVED,QETYCD),CHAR,OLEN=L'QETYCD,             +        
               MAXLEN=L'QETYCD,TEXT=AC#ETYPE,COL=*                              
OType    LKREQ F,03,(D,B#SAVED,QOTYP),CHAR,OLEN=L'QOTYP,               +        
               MAXLEN=L'QOTYP,TEXT=(*,OTYPLIT),COL=*                            
Suppl    LKREQ F,04,(D,B#SAVED,QSUPPC),CHAR,OLEN=L'QSUPPC,             +        
               MAXLEN=L'QSUPPC,TEXT=AC#SUPC,COL=*                               
OffCd    LKREQ F,05,(D,B#SAVED,QOFFC),CHAR,OLEN=L'QOFFC,               +        
               MAXLEN=L'QOFFC,TEXT=AC#OFFC,COL=*                                
                                                                                
         LKREQ E                                                                
                                                                                
OUTREFO  LKOUT H                                                                
                                                                                
OUTREF   LKOUT R,R#REFO                                                         
Array    LKOUT C,R#REFO,(A,ARYERF)                                              
         LKOUT E                                                                
                                                                                
         LKOUT X                                                                
                                                                                
ARYERF   LKOUT A,(R,NXTERF),MULTIROW=Y,ROWNAME=ERFRECD                          
                                                                                
Code     LKOUT C,1,ERFKFRMT,CHAR,ND=Y                                           
Office   LKOUT C,3,ERFRSOFF,CHAR,ND=Y,FILTROUT=TSTERFO                          
OfficeE  LKOUT C,3,(D,B#SAVED,CERFOFF),CHAR,ND=Y,FILTROUT=TSTERFE               
DefI     LKOUT C,4,(D,B#SAVED,ODEFLT),CHAR,ND=Y                                 
Array    LKOUT C,2,(A,ARYERFN)                                                  
                                                                                
         LKOUT E                                                                
                                                                                
ARYERFN  LKOUT A,(D,B#ERFREC,ERFRFST),EOT=EOR,                         +        
               ROWID=(NAMEL,NAMELQ),ROWWIDTH=(V,NAMLN)                          
                                                                                
Name     LKOUT C,2,NAMEREC,CHAR,LEN=V                                           
                                                                                
         LKOUT E                                                                
                                                                                
TSTERFO  CLI   QAPPL,QEST          all but estimates                            
         J     SETCCC                                                           
TSTERFE  CLI   QAPPL,QEST          estimates                                    
         BR    RE                                                               
                                                                                
NXTERF   CLI   LP_RMODE,LP_RFRST   First time?                                  
         JE    NXTERF02                                                         
         CLI   QAPPL,QORD                                                       
         JNE   NXTERF04                                                         
         L     R1,AIO2                                                          
         ST    R1,LP_ADATA                                                      
         J     NXTERF10                                                         
                                                                                
NXTERF02 NI    REQI,FF-REQIAURA    Aura running                                 
         XR    RF,RF                                                            
         ICM   RF,B'0011',CUXPNUM                                               
         CHI   RF,XPRODIKQ                                                      
         JNE   NXTERF03                                                         
         OI    REQI,REQIAURA                                                    
                                                                                
NXTERF03 MVI   ODEFLT,0                                                         
         MVI   ERFOCNT,0                                                        
                                                                                
         CLI   QAPPL,QEST          estimates                                    
         JE    NXTERF06                                                         
                                                                                
         OC    QETYCD,SPACES                                                    
         OC    QOTYP,SPACES                                                     
         OC    QSUPPC,SPACES                                                    
         OC    QOFFC,SPACES                                                     
                                                                                
         CLI   QAPPL,QORD          orders / will need other filters             
         JE    NXTERF07                                                         
                                                                                
         MVC   LP_ERROR,=AL2(AE$IVAPP)                                          
         J     QERROR                                                           
                                                                                
NXTERF04 CLI   ERFOCNT,0           put out multiple office                      
         JE    NXTERF06                                                         
         LLC   R0,ERFOCNT          decrement count                              
         SHI   R0,1                                                             
         STC   R0,ERFOCNT                                                       
         L     R1,ACURNTR                                                       
         MVC   CERFOFF,0(R1)                                                    
         AHI   R1,L'ERFRSOFF                                                    
         ST    R1,ACURNTR                                                       
         MVC   LP_ADATA,AIO2                                                    
         MVI   LP_RMODE,LP_RNEXT                                                
         J     EXITY                                                            
                                                                                
NXTERF06 GOTOR (#NXTREC,ANXTREC),DMCB,ERFKEYT,('B#ERFREC',0),          +        
               (0,SAVED),AERFKF,AERFRF                                          
         J     EXITY                                                            
                                                                                
NXTERF07 L     R1,AIO2                                                          
         ST    R1,LP_ADATA                                                      
         GOTOR SETERF                                                           
         JE    NXTERF08                                                         
         MVI   LP_RMODE,LP_RLAST                                                
         J     EXITY                                                            
                                                                                
         USING ERFTABD,R4                                                       
NXTERF08 L     R4,AGENAREA                                                      
         ST    R4,AERFLIST                                                      
         J     NXTERF12                                                         
                                                                                
NXTERF10 L     R4,AERFLIST         process table from ERFTABD                   
         CLI   ERFTIND,FF                                                       
         JNE   NXTERF12                                                         
         MVI   LP_RMODE,LP_RLAST                                                
         J     EXITY                                                            
                                                                                
NXTERF12 MVI   LP_RMODE,LP_RNEXT                                                
         MVC   IODA,ERFTDA                                                      
         MVI   ODEFLT,0                                                         
         CLI   ERFTIND,YESQ                                                     
         JNE   NXTERF14                                                         
         MVI   ODEFLT,YESQ                                                      
                                                                                
NXTERF14 AHI   R4,ERFTLNQ                                                       
         ST    R4,AERFLIST                                                      
                                                                                
         ICM   R1,15,IOADDR        pass D/A and read record                     
         JZ    NXTERF16                                                         
         AHI   R1,IODDWQ                                                        
         MVC   0(L'IODA,R1),IODA                                                
                                                                                
NXTERF16 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'     ::: B#ERFREC             
         JE    EXITY                                                            
         DC    H'0'                                                             
         DROP  R4                                                               
                                                                                
*** Media Code Download ***********************************************         
                                                                                
REQMED   LKREQ H,A#MEDC,OUTMED,NEXTREQ=REQMOA                                   
                                                                                
Appl     LKREQ F,01,(D,B#SAVED,QMCTYP),CHAR,OLEN=L'QMCTYP,             +        
               MAXLEN=L'QMCTYP,TEXT=AC#TYPE,COL=*                               
                                                                                
         LKREQ E                                                                
                                                                                
OUTMED   LKOUT H                                                                
                                                                                
OUTMEDC  LKOUT R,R#MEDC                                                         
Array    LKOUT C,R#MEDC,(A,ARYMED)                                              
         LKOUT E                                                                
                                                                                
         LKOUT X                                                                
                                                                                
ARYMED   LKOUT A,(R,NXTMED),MULTIROW=Y,ROWNAME=PMDRECD                          
                                                                                
Code     LKOUT C,1,PMDKMED,CHAR,ND=Y                                            
Array    LKOUT C,2,(A,ARYMEDN)                                                  
Array    LKOUT C,3,(A,ARYMDFN)                                                  
                                                                                
         LKOUT E                                                                
                                                                                
ARYMEDN  LKOUT A,(D,B#MEDREC,PMDRFST),EOT=EOR,                         +        
               ROWID=(PMDEL,PMDELQ),ROWWIDTH=(V,PMDLN)                          
                                                                                
Name     LKOUT C,2,PMDDESC,CHAR                                                 
                                                                                
         LKOUT E                                                                
                                                                                
ARYMDFN  LKOUT A,(D,B#MEDREC,PMDRFST),EOT=EOR,                         +        
               ROWID=(XNMEL,XNMELQ),ROWWIDTH=(V,XNMLN)                          
                                                                                
Name     LKOUT C,3,XNMSUBN,CHAR,LEN=V                                           
                                                                                
         LKOUT E                                                                
                                                                                
NXTMED   CLI   LP_RMODE,LP_RFRST   First time?                                  
         JNE   NXTMED08                                                         
                                                                                
         CLI   QMCTYP,QMCTLQ                                                    
         JE    NXTMED02                                                         
                                                                                
*&&UK*&& MVC   LP_ERROR,=AL2(AE$SPNMC)                                          
*&&US*&& MVC   LP_ERROR,=AL2(AE$INVCD)                                          
         J     QERROR                                                           
                                                                                
NXTMED02 CLI   QAPPL,C' '          Application will be blank if                 
         JNH   NXTMED06            called directly by maintenance               
         XC    DMEDIND,DMEDIND                                                  
         XC    DAMED,DAMED                                                      
         GOTOR GETLMT,'LIDTMEDL'   Get media code limit list                    
         OC    DAMED,DAMED         Test media code list provided                
         JNZ   NXTMED08                                                         
         TM    X#LLIND,X#LLINI                                                  
         JNZ   NXTMED04                                                         
         GOTOR ACCRUL                                                           
NXTMED04 CLI   LL_DMEDA,LL_ALLQ   Do we have access to all if no list           
         JE    NXTMED06                                                         
         MVI   LP_RMODE,LP_RLAST                                                
         J     EXITY                                                            
NXTMED06 MVC   DAMED,AALL          No - set all                                 
                                                                                
NXTMED08 GOTOR (#NXTREC,ANXTREC),DMCB,PMDKEYT,('B#MEDREC',0),          +        
               (0,SAVED),0,0                                                    
         J     EXITY                                                            
                                                                                
** Client list ********************************************************         
                                                                                
ARYCLI   LKOUT A,(R,NXTCLI),MULTIROW=Y,ROWNAME=ACTRECD                          
                                                                                
Code     LKOUT C,1,ACTKACT,CHAR,ND=Y                                            
Array    LKOUT C,2,(A,ARYCLSN),FILTROUT=TESTSNM                                 
Array    LKOUT C,2,(A,ARYCLAN),FILTROUT=TESTANM                                 
Array    LKOUT C,2,(A,ARYACTN),FILTROUT=TESTNAM                                 
Array    LKOUT C,13,(A,ARYCLOF),FILTROUT=TSTRODN                                
Array    LKOUT C,13,(A,ARYRST),FILTROUT=TSTRODK                                 
Array    LKOUT C,69,(A,ARYCLOF),FILTROUT=TSTRODK                                
ACLevel  LKOUT C,107,(D,B#SAVED,AC_LVL),CHAR,LEN=1,ND=Y                         
Unit     LKOUT C,122,ACTKUNT,CHAR,ND=Y,FILTROUT=TSTRODK                         
Ledger   LKOUT C,123,ACTKLDG,CHAR,ND=Y,FILTROUT=TSTRODK                         
                                                                                
         LKOUT E                                                                
                                                                                
ARYACTN  LKOUT A,(D,B#ACTREC,ACTRFST),EOT=EOR,                         +        
               ROWID=(NAMEL,NAMELQ),ROWWIDTH=(V,NAMLN)                          
                                                                                
Name     LKOUT C,2,NAMEREC,CHAR,LEN=V                                           
                                                                                
         LKOUT E                                                                
                                                                                
ARYCLSN  LKOUT A,(D,B#ACTREC,ACTRFST),EOT=EOR,                         +        
               ROWID=(SNMEL,SNMELQ),ROWWIDTH=(V,SNMLN)                          
                                                                                
Name     LKOUT C,2,SNMNAME,CHAR                                                 
PRout    LKOUT P,,SETFOUND                                                      
                                                                                
         LKOUT E                                                                
                                                                                
ARYCLAN  LKOUT A,(D,B#ACTREC,ACTRFST),EOT=EOR,                         +        
               ROWID=(XNMEL,XNMELQ),ROWWIDTH=(V,XNMLN)                          
                                                                                
Name     LKOUT C,2,XNMSUBN,CHAR,LEN=V                                           
PRout    LKOUT P,,SETFOUND                                                      
                                                                                
         LKOUT E                                                                
                                                                                
ARYCLOF  LKOUT A,(D,B#ACTREC,ACTRFST),EOT=EOR,                         +        
               ROWID=(PPREL,PPRELQ),ROWWIDTH=(V,PPRLN)                          
                                                                                
Office   LKOUT C,13,PPRGAOFF,CHAR,FILTROUT=TSTRODN                              
Office   LKOUT C,69,PPRGAOFF,CHAR,FILTROUT=TSTRODK                              
OffNam   LKOUT C,70,PPRGAOFF,(R,EDTOFN),FILTROUT=TSTRODK,ND=Y                   
                                                                                
         LKOUT E                                                                
                                                                                
ARYRST   LKOUT A,(D,B#ACTREC,ACTRFST),EOT=EOR,                         +        
               ROWID=(RSTEL,RSTELQ),ROWWIDTH=(V,RSTLN)                          
                                                                                
Locked   LKOUT C,13,RSTSTAT1,(R,EDTRSTL),ND=Y                                   
Closed   LKOUT C,14,RSTSTAT1,(R,EDTRSTC),ND=Y                                   
                                                                                
         LKOUT E                                                                
                                                                                
NXTCLI   CLI   LP_RMODE,LP_RFRST   First time?                                  
         JNE   NXTCLI08                                                         
         XC    SAVEKEY,SAVEKEY                                                  
                                                                                
NXTCLI02 XC    DACTIND,DACTIND                                                  
         XC    DAACT,DAACT                                                      
         GOTOR GETLMT,'LIDTCPJL'   Get client code limit list                   
         MVC   DAACT2,DAACT             limit/group list                        
         OC    DAOFF,DAOFF         No - any office levels                       
         JNZ   NXTCLI06                                                         
         OC    DAACT,DAACT         Test client code list provided               
         JNZ   NXTCLI14            Yes                                          
         TM    X#LLIND,X#LLINI                                                  
         JNZ   NXTCLI04                                                         
         GOTOR ACCRUL              Get agency access rules                      
NXTCLI04 CLI   LL_DCLIA,LL_ALLQ    Do we have access to all if no list          
         JE    NXTCLI06                                                         
         MVI   LP_RMODE,LP_RLAST                                                
         J     NXTCLI20                                                         
NXTCLI06 MVC   DAACT,AALL          No - set all                                 
         OI    X#LLIND,X#ALCLI                                                  
         USING LDGRECD,R2                                                       
         LA    R2,IOKEY            Initialise key for ledger                    
         MVC   LDGKEY,SPACES                                                    
         MVC   LDGKCPY,CUXCPY                                                   
         MVC   LDGKUNT(2),PRODUL                                                
         MVC   SAVEKEY,IOKEY                                                    
                                                                                
NXTCLI08 TM    X#LLIND,X#ALCLI                                                  
         JZ    NXTCLI14                                                         
         MVC   IOKEY,SAVEKEY                                                    
         USING ACTRECD,R2                                                       
         LA    R2,IOKEY            PRODUCTION LEDGER                            
         LLC   RF,PCLILEN                                                       
         LA    RF,ACTKACT(RF)                                                   
         MVI   0(RF),X'FF'                                                      
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO4'                               
         CLC   IOKEYSAV(ACTKACT-ACTRECD),ACTKEY                                 
         JE    *+12                                                             
         MVI   LP_RMODE,LP_RLAST                                                
         J     NXTCLI16                                                         
         MVC   SAVEKEY,IOKEY                                                    
         GOTOR CLIKF                                                            
         JNE   NXTCLI08                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO4'                              
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R2,AIO4                                                          
         GOTOR CLIRF                                                            
         JNE   NXTCLI08                                                         
         XC    BYTE3,BYTE3                                                      
         MVI   AC_LVL,C'1'                                                      
         J     NXTCLI20                                                         
                                                                                
NXTCLI14 MVC   IOKEY,SAVEKEY                                                    
         GOTOR (#NXTREC,ANXTREC),DMCB,AC2KEYT,('B#ACTREC',0),          +        
               (0,SAVED),ACLIKF,ACLIRF                                          
         XC    BYTE3,BYTE3                                                      
         MVC   SAVEKEY,IOKEY                                                    
         MVI   AC_LVL,C'1'                                                      
         CLI   LP_RMODE,LP_RLAST                                                
         JNE   NXTCLI20                                                         
NXTCLI16 TM    X#LLIND,X#CLIOF                                                  
         JNZ   NXTCLI20                                                         
         OC    DAACT2,DAACT2                                                    
         JZ    NXTCLI20                                                         
         OC    DAOFF,DAOFF                                                      
         JZ    NXTCLI20                                                         
         MVC   DAACT,DAACT2                                                     
         OI    X#LLIND,X#CLIOF                                                  
         NI    X#LLIND,X'FF'-X#ALCLI                                            
         MVI   LP_RMODE,LP_RFRST                                                
         J     NXTCLI14                                                         
                                                                                
NXTCLI20 L     R2,AIO4                                                          
         ST    R2,LP_ADATA                                                      
         J     EXITY                                                            
                                                                                
SETFOUND MVI   BYTE3,1                                                          
         J     EXIT                                                             
                                                                                
TESTNAM  TM    CPYSTATC,CPYSALTN+CPYSMEDN                                       
         BZR   RE                                                               
         CLI   BYTE3,0                                                          
         BR    RE                                                               
                                                                                
TESTANM  TM    CPYSTATC,CPYSALTN                                                
         J     SETCCC                                                           
                                                                                
TESTSNM  TM    CPYSTATC,CPYSMEDN                                                
         J     SETCCC                                                           
                                                                                
         USING OATELD,R1                                                        
SETOATL  L     R1,LP_AINP                                                       
*                                                                               
         MVI   SUPBYTE,1           Set OATELD found                             
         MVC   WORK,SPACES                                                      
         MVC   WORK(L'OATCSZZR),OATCSZZR       Set up default output            
         TM    OATSTAT,OATCSZ                                                   
         JNO   EXITY                                                            
         MVC   WORK,SPACES                                                      
         LA    RE,WORK                                                          
         MVC   0(L'OATCITY,RE),OATCITY                                          
         LA    RE,L'OATCITY-1(RE)                                               
         CLI   0(RE),X'40'         Are we at a significant character?           
         JH    *+12                                                             
         AHI   RE,-1                                                            
         J     *-12                                                             
         MVI   1(RE),C','          put in comma                                 
         LA    RE,3(RE)            Bump passed comma and add space              
         MVC   0(L'OATSTATE,RE),OATSTATE                                        
         LA    RE,L'OATSTATE(RE)                                                
         MVC   1(L'OATZIP,RE),OATZIP                                            
         CLC   OATZIPRN,SPACES     Any zip extension?                           
         JNH   EXITY                                                            
         LA    RE,L'OATZIP(RE)                                                  
         MVI   1(RE),C'-'                                                       
         MVC   2(L'OATZIPRN,RE),OATZIPRN                                        
         J     EXITY                                                            
         DROP  R1                                                               
                                                                                
TSTOATL  CLI   SUPBYTE,1           Have we found OATELD                         
         J     SETCCC                                                           
                                                                                
** Work code list *****************************************************         
                                                                                
ARYWCL   LKOUT A,(R,NXTWCL),MULTIROW=Y,ROWNAME=WCORECD                          
                                                                                
Code     LKOUT C,1,WCOKWRK,CHAR,ND=Y                                            
Array    LKOUT C,2,(A,ARYWCE)                                                   
Array    LKOUT C,27,(A,ARYWCN)                                                  
                                                                                
         LKOUT E                                                                
                                                                                
ARYWCE   LKOUT A,(D,B#WCREC,WCORFST),EOT=EOR,ROWID=(WCOELD,WCOELQ),    +        
               ROWWIDTH=(V,WCOLN)                                               
WCDesc   LKOUT C,2,WCODESC,CHAR,ND=Y                                            
WCGrp    LKOUT C,3,WCOGRP,CHAR,ND=Y                                             
WCStat   LKOUT C,4,WCOSTAT,(R,EDTINEX),ND=Y                                     
WCArt    LKOUT C,5,WCOSTAT2,(R,EDTART),ND=Y                                     
*&&UK                                                                           
EstChk   LKOUT C,24,WCOSTAT3,(R,EDTESTC),ND=Y                                   
*&&                                                                             
                                                                                
         LKOUT E                                                                
                                                                                
ARYWCN   LKOUT A,(D,B#WCREC,WCORFST),EOT=EOR,                          +        
               ROWID=(NAMEL,NAMELQ),ROWWIDTH=(V,NAMLN)                          
                                                                                
WCNam    LKOUT C,27,NAMEREC,CHAR,LEN=V,ND=Y                                     
                                                                                
         LKOUT E                                                                
                                                                                
                                                                                
NXTWCL   CLI   LP_RMODE,LP_RFRST   First time?                                  
         JNE   NXTWCL02                                                         
                                                                                
         MVC   DAACT,AALL          Set all                                      
                                                                                
NXTWCL02 MVC   IOKEY,SAVEKEY                                                    
         GOTOR (#NXTREC,ANXTREC),DMCB,WC2KEYT,('B#WCREC',0),           +        
               (0,SAVED),AWCKF,AWCRF                                            
         MVC   SAVEKEY,IOKEY                                                    
         L     R2,AIO4                                                          
         ST    R2,LP_ADATA                                                      
         J     EXITY                                                            
                                                                                
** MOA list ***********************************************************         
                                                                                
REQMOA   LKREQ H,A#MOAD,OUTMOA,NEXTREQ=REQFNV                                   
                                                                                
BType    LKREQ F,01,(D,B#SAVED,QBATYP),LBIN,OLEN=L'QBATYP,             +        
               MAXLEN=3,TEXT=(*,BATTYPE),COL=*                                  
                                                                                
         LKREQ E                                                                
                                                                                
OUTMOA   LKOUT H                                                                
                                                                                
OUTMOAC  LKOUT R,R#MOAD                                                         
Array    LKOUT C,R#MOAD,(A,ARYMOA)                                              
         LKOUT E                                                                
                                                                                
         LKOUT X                                                                
                                                                                
ARYMOA   LKOUT A,(R,NXTMOA),NROWS=1,ROWNAME=SAVED                               
                                                                                
Array    LKOUT C,1,(A,ARYMOAL)                                                  
                                                                                
         LKOUT E                                                                
                                                                                
ARYMOAL  LKOUT A,(D,B#SAVED,OL_MOA),NROWS=OL_MMOA,                     +        
               ROWWIDTH=L'OL_MOA,ROWNAME=OL_MOA                                 
                                                                                
MOA      LKOUT C,1,OL_MOA,PDAT,ND=Y                                             
                                                                                
         LKOUT E                                                                
                                                                                
NXTMOA   XC    TEMP2,TEMP2                                                      
         LA    R2,OL_MOA                                                        
         LA    R3,OL_MMOA                                                       
         MVC   D_TMOAP,D_TODAYP                                                 
         MVI   D_TMOAP+2,1        Set first of month                            
*&&UK                                                                           
         XR    RF,RF                                                            
         ICM   RF,3,CUXPNUM        Check whether InvoiceLog                     
         CHI   RF,XPPCUDFQ          is connected                                
         JNE   NXTMOA01            No                                           
         GOTOR GETMOA              Get MOA from Postman control rec             
         OC    DUB2,DUB2           Any start MOA set?                           
         JZ    NXTMOA01            No                                           
         MVC   0(L'OL_MOA,R2),DUB2 Set start MOA                                
         LA    R2,L'OL_MOA(R2)     Bump to next slot                            
         SHI   R3,12               Only check next 12 months from today         
         J     NXTMOA02                                                         
*&&                                                                             
NXTMOA01 GOTOR VDATCON,DMCB,(1,D_TMOAP),(0,WORK)                                
         GOTO1 VADDAY,DMCB,(C'M',WORK),WORK+6,F'-12'                            
         GOTOR VDATCON,DMCB,(0,WORK+6),(1,D_TMOAP)                              
NXTMOA02 GOTOR VDATCON,DMCB,(X'81',D_TMOAP),(6,DUB2)                            
         MVC   BYTE1,4(R1)         Output length                                
*&&US                                                                           
         GOTO1 BMONVAL,PARM,(BYTE1,DUB2),(QBATYP,ACOMFACS),            +        
               (CULANG,TEMP2),(CUXCPY,0)                                        
*&&                                                                             
*&&UK                                                                           
         GOTO1 BMONVAL,PARM,(BYTE1,DUB2),(QBATYP,ACOMFACS),            +        
               (CULANG,TEMP2),(CUXCPY,CUUSER)                                   
*&&                                                                             
         CLI   TEMP2+(BMOERR-BMONVALD),BMOEOKQ                                  
         JNE   NXTMOA06                                                         
*                                                                               
NXTMOA04 MVC   0(L'OL_MOA,R2),D_TMOAP                                           
         LA    R2,L'OL_MOA(R2)                                                  
NXTMOA06 GOTOR VDATCON,DMCB,(1,D_TMOAP),(0,WORK)                                
         GOTO1 VADDAY,DMCB,(C'M',WORK),WORK+6,F'1'                              
         GOTOR VDATCON,DMCB,(0,WORK+6),(1,D_TMOAP)                              
         JCT   R3,NXTMOA02                                                      
         ST    R8,LP_ADATA                                                      
         J     EXITY                                                            
                                                                                
*** Filter Name/Value Download ****************************************         
                                                                                
REQFNV   LKREQ H,A#FNVD,OUTFNV,NEXTREQ=REQJINI                                  
                                                                                
Appl     LKREQ F,01,(D,B#SAVED,QUNLDG),CHAR,OLEN=L'QUNLDG,             +        
               MAXLEN=L'QUNLDG,TEXT=AC#UNTLD,COL=*                              
                                                                                
         LKREQ E                                                                
                                                                                
OUTFNV   LKOUT H                                                                
                                                                                
OUTFNVC  LKOUT R,R#FNVD                                                         
Array    LKOUT C,R#FNVD,(A,ARYFNV)                                              
         LKOUT E                                                                
                                                                                
         LKOUT X                                                                
                                                                                
ARYFNV   LKOUT A,(R,NXTFNV),MULTIROW=Y,ROWNAME=RSFRECD                          
                                                                                
Array    LKOUT C,1,(A,ARYFNVN)                                                  
                                                                                
         LKOUT E                                                                
                                                                                
ARYFNVN  LKOUT A,(D,B#FNVREC,RSFRFST),EOT=EOR,NEWEL=R,                 +        
               ROWID=(RSFEL,RSFELQ),ROWWIDTH=(V,RSFLN)                          
                                                                                
Type     LKOUT C,1,(D,B#SAVED,OTYPE),CHAR,ND=Y                                  
FltNum   LKOUT C,2,(D,B#SAVED,OFLT),LBIN,FILTROUT=TSTTYPV                       
                                                                                
FltNum   LKOUT C,2,RSFTYPE,LBIN,FILTROUT=TSTTYPN,SKIPCOLS=2                     
ShrtNm   LKOUT C,3,RSFCODE,CHAR                                                 
LngNam   LKOUT C,4,RSFLNAM,CHAR,LEN=V                                           
                                                                                
FltVal   LKOUT C,5,RSFTYPE,CHAR,FILTROUT=TSTTYPV,SKIPCOLS=2                     
ShrtNm   LKOUT C,6,RSFCODE,CHAR                                                 
LngNam   LKOUT C,7,RSFLNAM,CHAR,LEN=V                                           
                                                                                
         LKOUT E                                                                
                                                                                
NXTFNV   CLI   LP_RMODE,LP_RFRST   First time?                                  
         JNE   NXTFNV04                                                         
                                                                                
*&&UK*&& TM    CPYSTAT8,CPYSFNAM                                                
*&&UK*&& JNZ   NXTFNV02                                                         
*                                                                               
*&&UK*&& J     NOMORE                                                           
*                                                                               
NXTFNV02 CLC   QUNLDG,SPACES      unit/ledger                                   
         JH    NXTFNV04                                                         
                                                                                
         MVC   LP_ERROR,=AL2(AE$MISIF)                                          
         J     QERROR                                                           
                                                                                
                                                                                
NXTFNV04 GOTOR (#NXTREC,ANXTREC),DMCB,RSFKEYT,('B#FNVREC',0),          +        
               (0,SAVED),ARSFKF,0                                               
         J     EXITY                                                            
                                                                                
TSTTYPN  CLI   OTYPE,C'N'                                                       
         BR    RE                                                               
                                                                                
TSTTYPV  CLI   OTYPE,C'V'                                                       
         BR    RE                                                               
                                                                                
*** Job Initial Download **********************************************         
                                                                                
REQJINI  LKREQ H,A#JINI,OUTJBI,NEXTREQ=REQIINI                                  
                                                                                
Dummy    LKREQ F,01,(D,B#SAVED,QINITIAL),CHAR,OLEN=L'QINITIAL,         +        
               MAXLEN=L'QINITIAL,TEXT=AC#NOORD,COL=*                            
Oovtm    LKREQ F,2,(D,B#SAVED,QGENINI2),CHAR,OLEN=L'QGENINI2,          +        
               MAXLEN=L'QGENINI2,TEXT=(*,OVERLIT),COL=*                         
                                                                                
         LKREQ E                                                                
                                                                                
OUTJBI   LKOUT H                                                                
                                                                                
OUTJBIN  LKOUT R,R#JINI                                                         
Array    LKOUT C,R#JINI,(A,ARYJINI),FILTROUT=TSTBRRD1                           
         LKOUT E                                                                
                                                                                
GENINIJ  LKOUT R,A#GINI            General initial                              
JobIni   LKOUT P,,JOBINI                                                        
Array    LKOUT C,A#GINI,(A,ARYGINI),FILTROUT=TSTRODK1                           
         LKOUT E                                                                
                                                                                
OUTOVTMJ LKOUT R,A#OVTM                                                         
Array    LKOUT C,A#OVTM,(A,ARYOVTM),FILTROUT=TSTGENTM                           
         LKOUT E                                                                
                                                                                
FNVLISJ  LKOUT R,R#FNVD                                                         
Array    LKOUT C,R#FNVD,(A,ARYFNV),FILTROUT=TSTBRRD1                            
         LKOUT E                                                                
                                                                                
MEDLISJ  LKOUT R,R#MEDC                                                         
Array    LKOUT C,R#MEDC,(A,ARYMED),FILTROUT=TSTBRRD1                            
         LKOUT E                                                                
                                                                                
OFFLISJ  LKOUT R,R#OFFL                                                         
Array    LKOUT C,R#OFFL,(A,ARYOFFL),FILTROUT=TSTRODK1                           
         LKOUT E                                                                
                                                                                
NARLISJ  LKOUT R,R#NARR                                                         
Array    LKOUT C,R#NARR,(A,ARYNAR),FILTROUT=TSTRODK1                            
         LKOUT E                                                                
                                                                                
OUTOINJ  LKOUT R,R#INIT            Orders initial                               
Array    LKOUT C,R#INIT,(A,ARYOINI),FILTROUT=TSTRODK1                           
         LKOUT E                                                                
*                                                                               
CURLISJ  LKOUT R,R#CURR                                                         
Array    LKOUT C,R#CURR,(A,ARYCUR),FILTROUT=TSTRODK1                            
         LKOUT E                                                                
*&&US                                                                           
STULISO  LKOUT R,A#STUL                                                         
Array    LKOUT C,A#STUL,(A,ARYSTCD),FILTROUT=TSTRODK2                           
         LKOUT E                                                                
*&&                                                                             
                                                                                
         LKOUT X                                                                
                                                                                
ARYJINI  LKOUT A,(R,GTJBIN),ROWNAME=SAVED                                       
AgyCurr  LKOUT C,1,(D,B#WORKD,AGYCURR),CHAR,ND=Y                                
OffInd   LKOUT C,2,(D,B#WORKD,OFFIND),CHAR,ND=Y                                 
ForCurr  LKOUT C,3,OFCURR,CHAR,ND=Y                                             
AutApp   LKOUT C,4,OAJLA,CHAR,ND=Y                                              
AutNum   LKOUT C,5,OAJNU,CHAR,ND=Y                                              
Offset   LKOUT C,6,OJCDO,SPAK,ND=Y                                              
Draft    LKOUT C,7,ODRFT,CHAR,ND=Y                                              
WDvUsr   LKOUT C,8,OINWDUS,CHAR,ND=Y                                            
MixCse   LKOUT C,9,(D,B#SAVED,JI_MIXC),CHAR,ND=Y                                
CliLen   LKOUT C,10,(D,B#WORKD,PCLILEN),LBIN,ND=Y                               
ProLen   LKOUT C,11,(D,B#SAVED,JI_PLN),LBIN,ND=Y                                
JobLen   LKOUT C,12,(D,B#SAVED,JI_JLN),LBIN,ND=Y                                
                                                                                
         LKOUT E                                                                
                                                                                
GTJBIN   ST    R8,LP_ADATA                                                      
         MVI   QNAM,YESQ                                                        
         ZAP   OJCDO,PZERO         Job close day offset                         
         MVI   OAJLA,NOQ           Auto Job level approver                      
         MVI   OAJNU,NOQ           Auto Job numbering                           
         MVI   OFCURR,NOQ                                                       
         TM    CPYSTATA,CPYSFCES                                                
         JZ    GTJBIN02                                                         
         MVI   OFCURR,YESQ                                                      
                                                                                
GTJBIN02 CLI   CPYLN,CPYLN4Q                                                    
         JL    GTJBIN10                                                         
                                                                                
         TM    CPYSTATB,CPYSAJLA                                                
         JZ    GTJBIN06                                                         
         MVI   OAJLA,YESQ                                                       
                                                                                
GTJBIN06 TM    CPYSTATB,CPYSAJNM                                                
         JZ    GTJBIN08                                                         
         MVI   OAJNU,YESQ                                                       
                                                                                
GTJBIN08 XR    R1,R1                                                            
         ICM   R1,3,CPYDJCDO                                                    
         CVD   R1,DUB1                                                          
         ZAP   OJCDO,DUB1                                                       
                                                                                
GTJBIN10 MVI   ODRFT,NOQ                                                        
         XC    PRODPROF,PRODPROF                                                
         XC    ELEMENT,ELEMENT     IF 1ST TIME READ EBUYER PROFILE              
         MVI   ELEMENT+00,C'A'-X'40'                                            
         MVC   ELEMENT+01(3),=C'PRO'                                            
         MVC   ELEMENT+12(2),CUAALF                                             
         GOTO1 VGETPROF,DMCB,ELEMENT,PRODPROF,VDATAMGR                          
         MVC   JI_MIXC,PRODPROF+5                                               
                                                                                
         USING LDGRECD,R2                                                       
         LA    R2,IOKEY                                                         
         MVC   LDGKEY,SPACES                                                    
         MVC   LDGKCPY,CUXCPY                                                   
         MVC   LDGKUNT(2),PRODUL                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
         JNE   GTJBIN16                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         L     R2,AIO1                                                          
         LA    R2,LDGRFST                                                       
         USING LDGELD,R2                                                        
         XR    R0,R0                                                            
                                                                                
GTJBIN12 CLI   LDGEL,0                                                          
         JE    GTJBIN16                                                         
         CLI   LDGEL,LDGELQ                                                     
         JE    GTJBIN14                                                         
         IC    R0,LDGLN                                                         
         AR    R2,R0                                                            
         J     GTJBIN12                                                         
                                                                                
GTJBIN14 TM    LDGSTAT2,LDGSDRFT                                                
         JZ    GTJBIN16                                                         
         MVI   ODRFT,YESQ                                                       
                                                                                
GTJBIN16 MVI   QMCTYP,QMCTLQ                                                    
         MVI   QAPPL,QJOB                                                       
         MVC   QUNLDG,PRODUL                                                    
         GOTOR WEBDAV                                                           
         LLC   RE,PCLILEN                                                       
         LLC   RF,PPROLEN                                                       
         LR    R1,RF                                                            
         SR    RF,RE                                                            
         STC   RF,JI_PLN                                                        
         LLC   RF,PJOBLEN                                                       
         SR    RF,R1                                                            
         CHI   RF,6                                                             
         JNH   *+8                                                              
         LHI   RF,6                                                             
         STC   RF,JI_JLN                                                        
         J     EXITY                                                            
         DROP  R2                                                               
                                                                                
*** Invoice Initial Download ******************************************         
                                                                                
REQIINI  LKREQ H,A#IAIN,OUTIIN,NEXTREQ=REQOVTM                                  
                                                                                
Dummy    LKREQ F,01,(D,B#SAVED,QINITIAL),CHAR,OLEN=L'QINITIAL,         +        
               MAXLEN=L'QINITIAL,TEXT=AC#NOORD,COL=*                            
Oovtm    LKREQ F,2,(D,B#SAVED,QGENINI2),CHAR,OLEN=L'QGENINI2,          +        
               MAXLEN=L'QGENINI2,TEXT=(*,OVERLIT),COL=*                         
                                                                                
         LKREQ E                                                                
                                                                                
OUTIIN   LKOUT H                                                                
                                                                                
OUTIINI  LKOUT R,R#IAIN                                                         
Array    LKOUT C,R#IAIN,(A,ARYIINI),FILTROUT=TSTBRRD1                           
         LKOUT E                                                                
                                                                                
GENINII  LKOUT R,A#GINI            General initial                              
Ordini   LKOUT P,,ORDINI                                                        
Array    LKOUT C,A#GINI,(A,ARYGINI),FILTROUT=TSTRODK1                           
         LKOUT E                                                                
                                                                                
OUTOVTMI LKOUT R,A#OVTM                                                         
Array    LKOUT C,A#OVTM,(A,ARYOVTM),FILTROUT=TSTGENTM                           
         LKOUT E                                                                
* '06' response for Brando                                                      
ETYLISI  LKOUT R,R#ETYL           Brandocean/invoice log etype list             
Array    LKOUT C,R#ETYL,(A,ARYETYL),FILTROUT=TSTRODN                            
         LKOUT E                                                                
*                                                                               
CURLISI  LKOUT R,R#CURR           Aura get currency list in 1st call            
Array    LKOUT C,R#CURR,(A,ARYCUR),FILTROUT=TSTRODK1                            
         LKOUT E                                                                
*                                                                               
CLILISI  LKOUT R,A#ACTS           Aura get client list in 2nd call              
Array    LKOUT C,A#ACTS,(A,ARYCLI),FILTROUT=TSTRODK2                            
         LKOUT E                                                                
*                                                                               
OFFLSTI  LKOUT R,R#OFFL           Brandocean/invoice log office list            
Array    LKOUT C,R#OFFL,(A,ARYOFFL),FILTROUT=TSTRODN                            
         LKOUT E                                                                
*                                                                               
MOALISI  LKOUT R,A#MOAD            Aura get list of MOAs                        
         LKOUT P,,INVINI                                                        
Array    LKOUT C,A#MOAD,(A,ARYMOA),FILTROUT=TSTRODK2                            
         LKOUT E                                                                
*                                                                               
NARLISI  LKOUT R,R#NARR                                                         
Array    LKOUT C,R#NARR,(A,ARYNAR),FILTROUT=TSTRODK1                            
         LKOUT E                                                                
*                                                                               
         LKOUT X                                                                
                                                                                
ARYIINI  LKOUT A,(R,GTININ),ROWNAME=SAVED                                       
AgyCurr  LKOUT C,1,(D,B#WORKD,AGYCURR),CHAR,ND=Y                                
OffInd   LKOUT C,2,(D,B#WORKD,OFFIND),CHAR,ND=Y                                 
LmAccs   LKOUT C,3,OINLACC,CHAR,ND=Y                                            
InvSet   LKOUT C,4,OINSETS,CHAR,ND=Y                                            
WDvLoc   LKOUT C,5,OINWDLO,CHAR,ND=Y                                            
WDvUsr   LKOUT C,6,OINWDUS,CHAR,ND=Y                                            
WDvPwd   LKOUT C,7,OINWDPA,CHAR,ND=Y                                            
Appvr    LKOUT C,8,OINAPPR,CHAR,ND=Y                                            
Edtr     LKOUT C,9,OINEDTR,CHAR,ND=Y                                            
Months   LKOUT C,10,OINNOMB,SPAK,ND=Y                                           
Url      LKOUT C,11,OINCURL,CHAR,ND=Y                                           
Alpha    LKOUT C,12,(D,B#WORKD,CUAALF),CHAR,ND=Y                                
OffCod   LKOUT C,13,OINLAOC,CHAR,ND=Y                                           
VOffPos  LKOUT C,14,OINOKPOV,CHAR,ND=Y                                          
XOffPos  LKOUT C,15,OINOKPOX,CHAR,ND=Y                                          
ProRsr   LKOUT C,16,OINPRRSR,CHAR,ND=Y                                          
ExpRsr   LKOUT C,17,OINEXRSR,CHAR,ND=Y                                          
Dupinvf  LKOUT C,18,OINDUPF,CHAR,ND=Y                                           
VarPWSV  LKOUT C,19,OINPWSV,CHAR,ND=Y                                           
VarPWSX  LKOUT C,20,OINPWSX,CHAR,ND=Y                                           
AprvMix  LKOUT C,21,OINAMXR,CHAR,ND=Y                                           
ForCurr  LKOUT C,22,OINFCUR,CHAR,ND=Y                                           
NewVat   LKOUT C,23,OINNVAT,CHAR,ND=Y                                           
KSVcst   LKOUT C,24,OINCSTG,CHAR,ND=Y                                           
KSVStf   LKOUT C,25,OIN2PAN,CHAR,ND=Y                                           
KSVdpt   LKOUT C,26,OIN2DAN,CHAR,ND=Y                                           
KSVJob   LKOUT C,27,OINJOBR,CHAR,ND=Y                                           
KSVPro   LKOUT C,28,OINPROR,CHAR,ND=Y                                           
UOrInv   LKOUT C,29,OINUOIN,CHAR,ND=Y                                           
CliLen   LKOUT C,30,(D,B#WORKD,PCLILEN),LBIN,ND=Y                               
ProLen   LKOUT C,31,OINPLN,LBIN,ND=Y                                            
JobLen   LKOUT C,32,OINJLN,LBIN,ND=Y                                            
EtCom    LKOUT C,33,OETYCM,CHAR,ND=Y                                            
*&&UK                                                                           
ImgLog   LKOUT C,34,OIMGLOG,CHAR,ND=Y                                           
*&&                                                                             
Aura     LKOUT C,35,OINAURA,CHAR,ND=Y                                           
*&&UK                                                                           
Pay2Job  LKOUT C,36,OINCP2J,CHAR,ND=Y                                           
RcDte    LKOUT C,37,OINRCDT,CHAR,ND=Y                                           
Einv     LKOUT C,38,(D,B#WORKD,SCPXEL),(R,EDTEINV)                              
Eivlt    LKOUT C,39,(D,B#WORKD,SCPXEL+CPXELVLT-CPXELD),UBIN,LEN=1               
*&&                                                                             
                                                                                
         LKOUT E                                                                
                                                                                
GTININ   ST    R8,LP_ADATA                                                      
*&&UK*&& MVI   QCLTYP,QCLINV       set invoices                                 
         MVI   OINLACC,C'N'        no limit access                              
         CLI   CUACCS,0                                                         
         JE    GTININ01                                                         
         MVI   OINLACC,C'S'        single limit access                          
         TM    CPYSTAT4,CPYSOFF2                                                
         JNZ   GTININ00                                                         
         CLI   CUACCS,C'*'                                                      
         JE    GTININ01                                                         
         MVI   OINLACC,C'L'        list limit access                            
         J     GTININ01                                                         
                                                                                
GTININ00 MVI   OINLACC,C'2'        indicate 2CO (could read OFFRECD)            
                                                                                
GTININ01 DS    0H                                                               
*&&UK                                                                           
         MVI   OINCP2J,C'N'                                                     
         CLI   CPYLN,CPYSTATD-CPYELD                                            
         JL    GTININ02                                                         
         TM    CPYSTATD,CPYSAP2J                                                
         JZ    GTININ02                                                         
         MVI   OINCP2J,C'Y'                                                     
*&&                                                                             
                                                                                
GTININ02 MVC   OINSETS,MANYNOS                                                  
         GOTOR ACCRUL                                                           
*&&UK                              Get rules for invoice log number             
         MVI   OIMGLOG,C'N'                                                     
         TM    CPXSTAT8,CPXIMGYQ                                                
         JZ    *+8                                                              
         MVI   OIMGLOG,C'Y'        Use image file name to generate inv          
         TM    CPXSTAT8,CPXIMGDQ         log number                             
         JZ    *+8                                                              
         MVI   OIMGLOG,C'D'        As above except allow override               
*&&                                                                             
*                                  Get rules for production orders              
         MVI   OINUOIN,C'N'                                                     
         TM    CPXSTAT2,CPXSUOIN                                                
         JZ    *+8                                                              
         MVI   OINUOIN,C'Y'        order approver is invoice approver           
                                                                                
         MVI   OINPRRSR,C'O'       order raiser is optional                     
         TM    CPXSTAT7,CPXPRDFY                                                
         JZ    *+8                                                              
         MVI   OINPRRSR,C'D'       order raiser is default approver             
                                                                                
         MVI   OETYCM,C'N'         expenditure type compulsory?                 
         TM    CPXSTAT7,CPXINETY                                                
         JZ    *+8                                                              
         MVI   OETYCM,C'Y'                                                      
*                                                                               
*&&UK                                                                           
         MVI   OINRCDT,C'H'        By default hide received date                
         TM    CPXSTATB,CPXIRDCO   Is date compulsory                           
         JZ    *+8                                                              
         MVI   OINRCDT,C'C'        Yes                                          
         TM    CPXSTATB,CPXIRDOP   Is date optional                             
         JZ    *+8                                                              
         MVI   OINRCDT,C'O'        Yes                                          
*&&                                                                             
*                                                                               
         MVI   OINAURA,YESQ        Aura user                                    
*                                  Get rules for expense orders                 
         MVI   OINEXRSR,C'O'       order raiser is optional                     
         TM    CPXSTAT7,CPXEXDFY                                                
         JZ    *+8                                                              
         MVI   OINEXRSR,C'D'       order raiser is default approver             
                                                                                
         MVI   OINAMXR,C'N'        Approver mix rule                            
         TM    CPXSTAT6,CPXAPMXR                                                
         JZ    GTININ03            none                                         
         SR    RF,RF                                                            
         IC    RF,CPXSTAT6         else 1-15                                    
         SRL   RF,4                                                             
         CHI   RF,X'09'                                                         
         JH    *+16                                                             
         STC   RF,OINAMXR                                                       
         OI    OINAMXR,X'F0'                                                    
         J     GTININ03                                                         
         AHI   RF,-X'0A'                                                        
         STC   RF,OINAMXR+1                                                     
         OI    OINAMXR+1,X'F0'                                                  
         MVI   OINAMXR,C'1'                                                     
                                                                                
                                                                                
GTININ03 LA    R2,IOKEY                                                         
         USING REBRECD,R2                                                       
         XC    REBKEY,REBKEY                                                    
         MVI   REBKTYP,REBKTYPQ                                                 
         MVI   REBKSUB,REBKSUBQ                                                 
         MVC   REBKCPY,CUXCPY                                                   
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JE    GTININ04                                                         
         MVC   LP_ERROR,=AL2(AE$CNREB)                                          
         J     QERROR                                                           
                                                                                
GTININ04 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         L     R2,AIO2                                                          
         USING RCTELD,R3                                                        
         LA    R3,REBRFST                                                       
         XR    R0,R0                                                            
                                                                                
GTININ06 CLI   RCTEL,0                                                          
         JNE   *+6                                                              
         DC    H'0'                                                             
         CLI   RCTEL,RCTELQ                                                     
         JE    GTININ08                                                         
         IC    R0,RCTLN                                                         
         AR    R3,R0                                                            
         J     GTININ06                                                         
                                                                                
GTININ08 TM    RCTSTAT3,RCTSBRAQ                                                
         JNZ   GTININ10                                                         
                                                                                
         MVC   LP_ERROR,=AL2(AE$REBCU)                                          
         J     QERROR                                                           
                                                                                
GTININ10 TM    RCTSTAT1,RCTSOFFQ                                                
         JZ    *+8                                                              
         MVI   OINSETS+00,YESQ                                                  
                                                                                
         TM    RCTSTAT1,RCTSAUTQ                                                
         JZ    *+8                                                              
         MVI   OINSETS+01,YESQ                                                  
                                                                                
         TM    RCTSTAT1,RCTSOBNQ                                                
         JZ    *+8                                                              
         MVI   OINSETS+02,YESQ                                                  
                                                                                
         TM    RCTSTAT2,RCTSORDQ                                                
         JZ    *+8                                                              
         MVI   OINSETS+03,YESQ                                                  
                                                                                
         TM    RCTSTAT1,RCTSPERQ                                                
         JZ    *+8                                                              
         MVI   OINSETS+04,YESQ                                                  
                                                                                
         TM    RCTSTAT1,RCTSALAQ                                                
         JZ    *+8                                                              
         MVI   OINSETS+05,YESQ                                                  
                                                                                
         TM    RCTSTAT2,RCTSDSCQ                                                
         JZ    *+8                                                              
         MVI   OINSETS+06,YESQ                                                  
                                                                                
         TM    RCTSTAT2,RCTSSTAQ                                                
         JZ    *+8                                                              
         MVI   OINSETS+07,YESQ                                                  
                                                                                
         TM    RCTSTAT2,RCTSPINQ                                                
         JZ    GTININ12                                                         
         MVI   OINSETS+08,C'O'                                                  
                                                                                
         TM    RCTSTAT2,RCTSPOTQ                                                
         JZ    GTININ12                                                         
         MVI   OINSETS+08,YESQ                                                  
                                                                                
GTININ12 TM    RCTSTAT2,RCTSDRUQ                                                
         JZ    *+8                                                              
         MVI   OINSETS+09,YESQ                                                  
                                                                                
         TM    RCTSTAT2,RCTSAAOQ                                                
         JZ    *+8                                                              
         MVI   OINSETS+10,YESQ                                                  
                                                                                
         TM    RCTSTAT3,RCTSBRAQ                                                
         JZ    *+8                                                              
         MVI   OINSETS+11,YESQ                                                  
                                                                                
         TM    CPXSTAT5,CPXAEINV                                                
         JNZ   *+8                                                              
         MVI   OINSETS+13,YESQ                                                  
                                                                                
         TM    RCTSTAT3,RCTSHLAQ                                                
         JZ    *+8                                                              
         MVI   OINSETS+15,YESQ                                                  
                                                                                
         OC    RCTNOMOB,RCTNOMOB                                                
         JNZ   *+8                                                              
         MVI   RCTNOMOB,1                                                       
         XR    RE,RE                                                            
         IC    RE,RCTNOMOB                                                      
         CVD   RE,DUB                                                           
         ZAP   OINNOMB,DUB                                                      
         DROP  R2                                                               
                                                                                
         LLC   RE,PCLILEN                                                       
         LLC   RF,PPROLEN                                                       
         LR    R1,RF                                                            
         SR    RF,RE                                                            
         STC   RF,OINPLN                                                        
         LLC   RF,PJOBLEN                                                       
         SR    RF,R1                                                            
         CHI   RF,6                                                             
         JNH   *+8                                                              
         LHI   RF,6                                                             
         STC   RF,OINJLN                                                        
                                                                                
         GOTOR WEBDAV                                                           
         GOTOR GETURL,OINCURL                                                   
                                                                                
         MVI   OINAPPR,NOQ                                                      
         MVI   OINEDTR,NOQ                                                      
         GOTOR GETCON                                                           
                                                                                
GTININ16 MVC   OINLAOC,SPACES      LIMIT ACCCESS SINGLE OFFICE CODE             
         MVC   OINOKPOV,=C'00'     OFFPOS IN KEY SV,SX - INIT TO 'NONE'         
         MVC   OINOKPOX,=C'00'                                                  
         CLI   TWAACCS,C'*'                                                     
         JNE   GTININ18                                                         
         LA    RE,TWAACCS+1                                                     
         XR    RF,RF                                                            
         TM    CPYSTAT4,CPYSOFF2                                                
         JZ    *+12                                                             
         AHI   RE,1                                                             
         AHI   RF,1                                                             
         BASR  R1,0                                                             
         EX    RF,4(R1)                                                         
         MVC   OINLAOC(0),0(RE)                                                 
                                                                                
GTININ18 MVI   BYTE1,C'V'           START WITH SV                               
         USING LDGRECD,R2                                                       
GTININ20 LA    R2,IOKEY                                                         
         MVC   LDGKEY,SPACES                                                    
         MVC   LDGKCPY,CUXCPY                                                   
         MVI   LDGKUNT,C'S'                                                     
         MVC   LDGKLDG,BYTE1                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JE    GTININ24                                                         
GTININ22 CLI   BYTE1,C'X'                                                       
         JE    GTININ36                                                         
         MVI   BYTE1,C'X'           THEN SX                                     
         J     GTININ20                                                         
                                                                                
GTININ24 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         L     R2,AIO2                                                          
         USING LDGELD,RF                                                        
         LA    RF,LDGRFST                                                       
         SR    R1,R1                                                            
GTININ26 CLI   LDGEL,0                                                          
         JE    GTININ22                                                         
         CLI   LDGEL,FFTELQ                                                     
         JNE   *+8                                                              
         CLI   FFTTYPE-FFTELD(RF),FFTTPASS  VARIANCE PASSWORD                   
         JE    GTININ34                                                         
         CLI   LDGEL,LDGELQ                                                     
         JE    *+14                                                             
GTININ28 IC    R1,LDGLN                                                         
         AR    RF,R1                                                            
         J     GTININ26                                                         
         CLI   LDGOPOS,LDGONONE                                                 
         JE    GTININ28            NO OFFPOS DEFINED                            
         TM    CPYSTAT4,CPYSOFF2                                                
         JNZ   GTININ30            2-CHAR OFFICES                               
         CLI   LDGOPOS,LDGOKEY                                                  
         JH    GTININ28            OFFICE NOT IN KEY                            
         IC    R0,LDGOPOS                                                       
         J     GTININ32                                                         
GTININ30 CLI   LDGOPOS,LDGONKLO                                                 
         JL    GTININ28            OFFICE NOT IN KEY                            
         CLI   LDGOPOS,LDGONKHI                                                 
         JH    GTININ28            DITTO                                        
         IC    R1,LDGOPOS                                                       
         N     R1,=F'15'                                                        
GTININ32 CVD   R1,DUB                                                           
         OI    DUB+L'DUB-1,X'0F'                                                
         LA    RE,OINOKPOV                                                      
         CLI   BYTE1,C'V'                                                       
         JE    *+8                                                              
         LA    RE,OINOKPOX                                                      
         UNPK  0(L'OINOKPOV,RE),DUB                                             
         J     GTININ28                                                         
                                                                                
         USING FFTELD,RF                                                        
GTININ34 MVC   X#IDATA,SPACES      ENCODE VARIANCE PASSWORDS                    
         IC    R1,FFTDLEN                                                       
         AHI   R1,-1                                                            
         BASR  RE,0                                                             
         EX    R1,4(RE)                                                         
         MVC   X#IDATA(0),FFTDATA                                               
         GOTOR ENCODE,2                                                         
         CLI   BYTE1,C'V'                                                       
         JNE   *+14                                                             
         MVC   OINPWSV,X#ODATA     SV                                           
         J     GTININ28                                                         
         MVC   OINPWSX,X#ODATA     OR SX                                        
         J     GTININ28                                                         
                                                                                
GTININ36 MVI   QETYCD,C'*'                                                      
         MVI   QAPPL,QINV                                                       
         MVI   QNARAPP,QINV                                                     
                                                                                
         MVI   OINDUPF,NOQ         INIT                                         
         TM    CPYSTAT2,CPYSCKDP  TEST CHECK INV DUPS                           
         JZ    GTININ38            NO                                           
         MVI   OINDUPF,C'W'        SET 'WARN'                                   
         XC    WORK,WORK           READ PROFILE FOR POSTMAN                     
         MVI   WORK+00,C'A'-X'40'                                               
         MVC   WORK+1(3),=C'PM1'                                                
         MVC   WORK+12(2),CUAALF                                                
         GOTO1 VGETPROF,DMCB,WORK,TEMP,VDATAMGR                                 
         CLI   TEMP+9,YESQ                                                      
         JNE   *+8                                                              
         MVI   OINDUPF,C'I'        SET 'USER INPUT TO CONFIRM'                  
                                                                                
                                                                                
GTININ38 MVI   OINFCUR,NOQ                                                      
         TM    CPYSTAT6,CPYSFMCR+CPYSFOCR                                       
         JZ    *+8                                                              
         MVI   OINFCUR,YESQ                                                     
                                                                                
         MVI   OINNVAT,NOQ                                                      
*&&UK                                                                           
         TM    CPYSTAT5,CPYSNVAT                                                
         JZ    *+8                                                              
         MVI   OINNVAT,YESQ                                                     
*&&                                                                             
         CLI   CUCTRY,CTRYGER                                                   
         JNE   EXITY                                                            
*                                  CHECK KSV SE A/C FOR ANALYSIS                
         MVC   TEMP2(L'ACTKACT),SPACES READ LEDGER FIRST                        
         MVI   BYTE1,FFTELQ            WANT FFTEL ON SE LEDGER                  
         XC    OINCSTG,OINCSTG                                                  
         MVI   OIN2DAN,NOQ                                                      
         MVI   OIN2PAN,NOQ                                                      
         MVI   OINPROR,NOQ                                                      
         MVI   OINJOBR,NOQ                                                      
                                                                                
         USING ACTRECD,R2                                                       
GTININ40 LA    R2,IOKEY                                                         
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVI   ACTKUNT,C'S'                                                     
         MVI   ACTKLDG,C'E'                                                     
         MVC   ACTKACT,TEMP2                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         L     R2,AIO2                                                          
         USING FFTELD,RF                                                        
         LA    RF,ACTRFST                                                       
         SR    R0,R0                                                            
GTININ42 CLI   FFTEL,0                                                          
         JE    EXITY               KSV A/CS NOT SET ON LEDGER                   
         CLC   FFTEL,BYTE1         FFTEL/RSTEL                                  
         JE    *+14                                                             
GTININ44 IC    R0,FFTLN                                                         
         AR    RF,R0                                                            
         J     GTININ42                                                         
                                                                                
         CLI   FFTEL,RSTELQ                                                     
         JE    GTININ46                                                         
         CLI   FFTTYPE,FFTTKSVE    TEST SE KSV A/C (NOT SQ)                     
         JNE   GTININ44                                                         
         SR    R1,R1                                                            
         IC    R1,FFTDLEN                                                       
         AHI   R1,-1                                                            
         BASR  RE,0                                                             
         EX    R1,4(RE)                                                         
         MVC   TEMP2(0),FFTDATA    KSV SE POSTING A/C                           
         MVI   BYTE1,RSTELQ        WANT RSTEL ON SE ACCOUNT                     
         J     GTININ40                                                         
                                                                                
         USING RSTELD,RF                                                        
GTININ46 CLI   RSTCOSTG,C' '                                                    
         JNH   *+10                                                             
         MVC   OINCSTG,RSTCOSTG    EXP INVS. REQUIRE SJ CLI FOR ANAL            
*&&US                                                                           
         TM    CPYSTAT5,CPYSEXPP                                                
         JZ    *+8                                                              
         MVI   OINPROR,YESQ        YES                                          
*&&                                                                             
                                                                                
         TM    RSTSTAT1,RSTSEADD   DO WE HAVE DEPT ANALYSIS                     
         JZ    *+8                                                              
         MVI   OIN2DAN,YESQ        YES                                          
                                                                                
         TM    RSTSTAT1,RSTSGPEI   DO WE HAVE PERSONNEL ANALYSIS                
         JZ    *+8                                                              
         MVI   OIN2PAN,YESQ        YES                                          
                                                                                
         CLI   RSTLN,RSTLN2Q                                                    
         JL    EXITY                                                            
                                                                                
         TM    RSTSTAT4,RSTSJREA   JOB REQUIRED                                 
         JZ    *+8                                                              
         MVI   OINJOBR,YESQ        YES                                          
*&&UK                                                                           
         TM    RSTSTAT5,RSTSPREA   PRODUCT REQUIRED                             
         JZ    *+8                                                              
         MVI   OINPROR,YESQ        YES                                          
*&&                                                                             
         J     EXITY                                                            
         DROP  RF                                                               
                                                                                
*** Time Overdue Download *********************************************         
                                                                                
REQOVTM  LKREQ H,A#OVTM,OUTOVTM,NEXTREQ=REQGINI                                 
                                                                                
*&&UK                                                                           
PID      LKREQ F,01,(D,B#SAVED,QPID),CHAR,OLEN=L'QPID,                 +        
               MAXLEN=L'QPID,TEXT=AC#PIDCD,COL=*                                
*&&                                                                             
*&&US                                                                           
PID      LKREQ F,01,(D,B#SAVED,QPID),CHAR,OLEN=L'QPID,                 +        
               MAXLEN=L'QPID,TEXT=AC#RSPID,COL=*                                
*&&                                                                             
                                                                                
         LKREQ E                                                                
                                                                                
OUTOVTM  LKOUT H                                                                
                                                                                
OUTOVTM1 LKOUT R,A#OVTM                                                         
Array    LKOUT C,A#OVTM,(A,ARYOVTM)                                             
         LKOUT E                                                                
                                                                                
         LKOUT X                                                                
                                                                                
ARYOVTM  LKOUT A,(R,OVRTIM),ROWNAME=SAVED                                       
Ovrdue   LKOUT C,1,OOVERDUE,CHAR,ND=Y                                           
                                                                                
         LKOUT E                                                                
                                                                                
OVRTIM   ST    R8,LP_ADATA                                                      
         MVI   OOVERDUE,C'N'       Set default no overdue timesheets            
         XC    OVFLAG,OVFLAG                                                    
         OC    CCTPID,CCTPID       Any connected PID                            
         JZ    OVRTIMX             No - must be DDS                             
         MVC   HALF1,CCTPID                                                     
         OC    QPID,QPID           Were we passed a PID                         
         JZ    OVTIM05             No                                           
         MVC   TEMP2,QPID                                                       
         OC    TEMP2(L'QPID),SPACES                                             
         GOTOR (#GETPIN,AGETPIN)   (uses AIO1)                                  
         MVC   HALF1,TEMP2+50                                                   
         JE    OVTIM05                                                          
         MVC   LP_ERROR,=AL2(AE$IVPER)                                          
         J     QERROR                                                           
                                                                                
OVTIM05  GOTOR CSTPID,DMCB,HALF1                                                
         JE    OVTIM10                                                          
         MVC   LP_ERROR,=AL2(AE$PIDPR)                                          
         J     QERROR                                                           
*                                                                               
OVTIM10  GOTOR PRSDTL,DMCB,(X'00',D_TODAYP)  (Uses AIO1)                        
         JNE   QERROR                                                           
*                                                                               
         L     R2,AIO1                                                          
         LA    R2,PERRFST-PERRECD(R2)                                           
         ST    R2,ANXTLOC          Save start of elements                       
         USING LOCELD,R2                                                        
OVTIM15  CLI   LOCEL,0             End of record                                
         JE    OVRTIMX             Yes - exit                                   
         CLI   LOCEL,LOCELQ                                                     
         JE    OVTIM25                                                          
OVTIM20  L     R2,ANXTLOC          Re-establish R2 as loop address              
         LLC   RE,LOCLN                                                         
         AR    R2,RE                                                            
         ST    R2,ANXTLOC          Save off address of Current loop             
         J     OVTIM15                                                          
                                                                                
OVTIM25  LLC   RE,ONERL1L          For each location build 1R account           
         SHI   RE,1                                                             
         BASR  R1,0                                                             
         EX    RE,4(R1)                                                         
         MVC   DACT(0),LOCOFF                                                   
         MVC   D1ROFF,DACT                                                      
         OC    D1ROFF,SPACES                                                    
         AHI   RE,1                                                             
         LA    R3,DACT                                                          
         AR    R3,RE                                                            
         LLC   RF,ONERL2L                                                       
         SR    RF,RE                                                            
         SHI   RF,1                                                             
         BASR  R1,0                                                             
         EX    RF,4(R1)                                                         
         MVC   0(0,R3),LOCDEPT                                                  
         AHI   RF,1                                                             
         AR    R3,RF               R3=A(end of dept code on 1R account)         
         LLC   RF,ONERL3L                                                       
         LLC   RE,ONERL2L                                                       
         SR    RF,RE                                                            
         SHI   RF,1                                                             
         BASR  R1,0                                                             
         EX    RF,4(R1)                                                         
         MVC   0(0,R3),LOCSUB                                                   
         AHI   RF,1                                                             
         AR    R3,RF                                                            
         LLC   RF,ONERL4L                                                       
         LLC   RE,ONERL3L                                                       
         SR    RF,RE                                                            
         SHI   RF,1                                                             
         BASR  R1,0                                                             
         EX    RF,4(R1)                                                         
         MVC   0(0,R3),DPERSON                                                  
         OC    DACT,SPACES                                                      
         GOTOR CHKMCS           Get brandocean switch on and off dates          
         GOTOR CHKPLK           Check if person is locked already               
         JE    *+12                                                             
         MVI   OOVERDUE,C'Y'    Set as overdue                                  
         J     OVRTIMX                                                          
                                                                                
         GOTOR (#CSTPRF,ACSTPRF),DMCB,DACT  Get cost profile                    
         L     R3,ACOBLOCK                                                      
         USING COBLOCKD,R3                                                      
         ZAP   DUB1,CONDO                                                       
         CVB   R4,DUB1                                                          
         LNR   R4,R4                                                            
                                                                                
         MVC   WORK(L'D_TODAYF),D_TODAYF  Work out Overdue date                 
         GOTO1 VADDAY,DMCB,(C'D',WORK),WORK+6,(R4)                              
         GOTO1 VDATCON,DMCB,(0,WORK+6),(1,DOVRDTE)                              
                                                                                
         XC    NTFY#(NTFYLNQ),NTFY#                                             
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         LA    R1,24               Hours in a day                               
         CLC   CONCM,SPACES                                                     
         JE    OVTIM30                                                          
         OC    CONCM,CONCM         ANY NOTIFICATION NEEDED?                     
         JZ    OVTIM30                                                          
         ZAP   DUB1,CONCM                                                       
         JZ    OVTIM30                                                          
         CVB   RF,DUB1                                                          
         STCM  RF,3,NTFY#                                                       
         MR    RE,R1                                                            
         STCM  RF,3,NTFYHRS                                                     
         MVC   LOCK#,NTFY#         use NOTIFY parms as LOCK defaults            
         MVC   LOCKHRS,NTFYHRS                                                  
*                                                                               
OVTIM30  CLC   CONCL,SPACES                                                     
         JE    OVTIM35                                                          
*&&US*&& OC    CONCL,CONCL         ANY NOTIFICATION NEEDED?                     
*&&US*&& JE    OVTIM35                                                          
         ZAP   DUB1,CONCL                                                       
         JZ    OVTIM35                                                          
         CVB   RF,DUB1                                                          
         STCM  RF,3,LOCK#                                                       
         MR    RE,R1                                                            
         STCM  RF,3,LOCKHRS                                                     
                                                                                
OVTIM35  LAY   R4,BRATAB                                                        
OVTIM40  OC    0(L'GDADATE*2,R4),0(R4)                                          
         JZ    OVTIM20                                                          
         CLC   0(L'GDADATE,R4),L'GDADATE(R4)                                    
         JNE   OVTIM50                                                          
OVTIM45  LA    R4,L'GDADATE2+L'GDADATE(R4)                                      
         J     OVTIM40                                                          
*                                                                               
OVTIM50  MVC   QSTART,0(R4)                                                     
         CLC   0(L'GDADATE,R4),LOCSTART  Brndocn on date after loc strt         
         JH    OVTIM55             Yes                                          
         MVC   QSTART,LOCSTART     Set location start date as start             
         OC    L'GDADATE(L'GDADATE,R4),L'GDADATE(R4) Any brndocn off            
         JZ    OVTIM60             No                                           
         CLC   L'GDADATE(L'GDADATE,R4),LOCSTART Brndocn off date before         
         JNH   OVTIM45                   location start date - get next         
         J     OVTIM60                                                          
                                                                                
OVTIM55  OC    LOCEND,LOCEND       Do we have an end date                       
         JZ    OVTIM60             No                                           
         CLC   0(L'GDADATE,R4),LOCEND   Brndocn on date after loc end           
         JH    OVTIM45             Yes - get next entry from table              
OVTIM60  MVC   QEND,L'GDADATE(R4)  Set brandocean switch off date               
         OC    LOCEND,LOCEND       Any location end date                        
         JZ    OVTIM70             No                                           
         OC    L'GDADATE(L'GDADATE,R4),L'GDADATE(R4) Any bndocn off             
         JZ    OVTIM65             No - set location end date                   
         CLC   L'GDADATE(L'GDADATE,R4),LOCEND  Bndocn off date before           
         JL    OVTIM45                   location end date                      
OVTIM65  MVC   QEND,LOCEND         No - set location end date as end            
                                                                                
OVTIM70  OC    QEND,QEND           Any end date so far                          
         JZ    OVTIM75             No                                           
         CLC   DOVRDTE,QEND        Yes - check is overdue is sooner             
         JNL   *+10                No                                           
OVTIM75  MVC   QEND,DOVRDTE        Yes - set overdue date as end date           
         OC    LOCLOCK,LOCLOCK     Check for timesheet lock date                
         JZ    OVTIM80             None present                                 
         CLC   LOCLOCK,QEND        Check earlier than end date                  
         JH    *+10                No                                           
         MVC   QEND,LOCLOCK        Yes - set end date as locked date            
OVTIM80  CLC   QSTART,QEND         Ensure start date is lower than end          
         JNL   OVTIM20             No - go to next location                     
         GOTOR CALPRDS             Get period end dates into Genarea            
         JNE   QERROR                                                           
         GOTOR RDEDT               Read Daily Edit Hours                        
                                                                                
         USING CALTABD,R4                                                       
OVTIM85  L     R4,AGENAREA                                                      
OVTIM90  CLI   0(R4),0             Any dates left                               
         JE    OVTIM20             No - go to next location                     
*                                                                               
         GOTOR GETEDT,(R4)         Set up CALDAYS with DAY EDIT HOURS           
*                                                                               
         USING TSWRECD,R3                                                       
OVTIM95  LA    R3,IOKEY            Build key for reading timesheets             
         XC    TSWKEY,TSWKEY                                                    
         MVI   TSWKTYP,TSWKTYPQ                                                 
         MVI   TSWKSUB,TSWKSUBQ                                                 
         MVC   TSWKCPY,CUXCPY                                                   
         MVC   TSWKPER,DPERSON     Add person code                              
         XR    RF,RF                                                            
         ICM   RF,7,CALENDT                                                     
         LNR   RF,RF                                                            
         STCM  RF,7,TSWKEND                                                     
         LLC   RE,ONERL3L                                                       
         SHI   RE,1                                                             
         BASR  R1,0                                                             
         EX    RE,4(R1)                                                         
         MVC   TSWKODS(0),DACT    Add office dept sub dept                      
         OC    TSWKODS,SPACES                                                   
         MVC   CSVKEY1(TSWKULC-TSWRECD),TSWRECD  Save key                       
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         JE    OVTIM110                                                         
         MVC   LP_ERROR,=AL2(AE$DSKER)                                          
         J     QERROR                                                           
                                                                                
OVTIM100 LA    R3,IOKEY            Re-establish Key for IOSQ compare            
         MVC   IOKEY,CSVKEY1                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
OVTIM105 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
OVTIM110 CLC   CSVKEY1(TSWKULC-TSWRECD),TSWRECD                                 
         JNE   OVTIM115            Record not found                             
*                                                                               
         CLI   TSWKSTAT,0          Is it saved time                             
         JNE   OVTIM120            Ok - If not in progress                      
*                                                                               
OVTIM115 CLC   CALENDT,DOVRDTE     Just check NDO profile                       
         JL    OVTIM999                                                         
         J     OVTIM120                                                         
*                                                                               
OVTIM120 LA    R4,CALTABL(R4)      Bump to next period                          
         J     OVTIM90             Build key for next period                    
*                                                                               
OVTIM999 MVI   OOVERDUE,C'Y'       Set overdue timesheets                       
OVRTIMX  J     EXITY                                                            
         DROP  R4                                                               
                                                                                
*** General Initial download ******************************************         
                                                                                
REQGINI  LKREQ H,A#GINI,OUTGINI,NEXTREQ=REQXTLG                                 
                                                                                
Type     LKREQ F,01,(D,B#SAVED,QGENINIT),CHAR,OLEN=L'QGENINIT,         +        
               MAXLEN=L'QGENINIT,TEXT=AC#TYPE,COL=*                             
Govtm    LKREQ F,02,(D,B#SAVED,QGENINI2),CHAR,OLEN=L'QGENINI2,         +        
               MAXLEN=L'QGENINI2,TEXT=(*,OVERLIT),COL=*                         
                                                                                
         LKREQ E                                                                
                                                                                
OUTGINI  LKOUT H                                                                
                                                                                
OUTGINII LKOUT R,A#GINI                                                         
Array    LKOUT C,A#GINI,(A,ARYGINI)                                             
         LKOUT E                                                                
                                                                                
OUTOVTMG LKOUT R,A#OVTM                                                         
Array    LKOUT C,A#OVTM,(A,ARYOVTM),FILTROUT=TSTGENTM                           
         LKOUT E                                                                
                                                                                
         LKOUT X                                                                
                                                                                
ARYGINI  LKOUT A,(R,GENINI),ROWNAME=SAVED                                       
Code     LKOUT C,1,OGICODE,CHAR,ND=Y                                            
List     LKOUT C,2,OGILIST,CHAR,ND=Y                                            
Nexp     LKOUT C,3,OGINEXP,CHAR,ND=Y                                            
URL      LKOUT C,4,OGIURL,CHAR,ND=Y                                             
Aguid    LKOUT C,5,OGIUID,CHAR,ND=Y                                             
Agname   LKOUT C,6,OGINAME,CHAR,ND=Y                                            
TimLmAp  LKOUT C,7,OGITIMAP,CHAR,ND=Y                                           
Clilen   LKOUT C,8,(D,B#WORKD,PCLILEN),LBIN,ND=Y                                
Prolen   LKOUT C,9,OPROLEN,LBIN,ND=Y                                            
Joblen   LKOUT C,10,OJOBLEN,LBIN,ND=Y                                           
TmBkUp   LKOUT C,11,OTIMBAK,CHAR,ND=Y                                           
Onerl1   LKOUT C,12,(D,B#WORKD,ONERL1L),LBIN,ND=Y                               
Onerl2   LKOUT C,13,OONRL2L,LBIN,ND=Y                                           
Onerl3   LKOUT C,14,OONRL3L,LBIN,ND=Y                                           
Onerl4   LKOUT C,15,OONRL4L,LBIN,ND=Y                                           
DptOfP   LKOUT C,16,O2DOFPOS,LBIN,ND=Y,FILTROUT=TSTGENOR,SKIPCOLS=4             
Offlen   LKOUT C,17,OOFFLEN,LBIN                                                
StfOfP   LKOUT C,18,O2POFPOS,LBIN,ND=Y                                          
StfDpP   LKOUT C,19,O2PDPPOS,LBIN,ND=Y                                          
StfDpL   LKOUT C,20,O2PDPLEN,LBIN,ND=Y                                          
BACSEml  LKOUT C,21,OGBACSEM,CHAR,ND=Y                                          
IDInam   LKOUT C,22,OIDINAME,CHAR,ND=Y                                          
ISOCod   LKOUT C,23,OGIAGCUR,CHAR,ND=Y                                          
DecPlc   LKOUT C,24,OGIDEC,LBIN,ND=Y                                            
StMonth  LKOUT C,25,OSTMNTH,LBIN,ND=Y                                           
LtsCal   LKOUT C,26,OLTSCAL,HEXD,ND=Y                                           
Userid   LKOUT C,27,(D,B#WORKD,CUUSER),HEXD,ND=Y                                
PIN      LKOUT C,28,(D,B#WORKD,CCTPID),HEXD,ND=Y                                
MBTime   LKOUT C,29,OGIMBTIM,CHAR,ND=Y                                          
                                                                                
         LKOUT E                                                                
                                                                                
GENINI   ST    R8,LP_ADATA                                                      
         LLC   RF,PPROLEN                                                       
         LLC   RE,PCLILEN                                                       
         SR    RF,RE                                                            
         STC   RF,OPROLEN                                                       
         LLC   RF,PJOBLEN                                                       
         LLC   RE,PPROLEN                                                       
         SR    RF,RE                                                            
         CHI   RF,6                                                             
         JNH   *+8                                                              
         LHI   RF,6                                                             
         STC   RF,OJOBLEN                                                       
*                                                                               
         LLC   RF,ONERL2L                                                       
         LLC   RE,ONERL1L                                                       
         SR    RF,RE                                                            
         STC   RF,OONRL2L                                                       
         LLC   RF,ONERL3L                                                       
         LLC   RE,ONERL2L                                                       
         SR    RF,RE                                                            
         STC   RF,OONRL3L                                                       
         LLC   RF,ONERL4L                                                       
         LLC   RE,ONERL3L                                                       
         SR    RF,RE                                                            
         STC   RF,OONRL4L                                                       
*                                                                               
         MVI   OGINEXP,NOQ                                                      
         MVI   OGITIMAP,NOQ                                                     
         MVI   OGICODE,NOQ                                                      
         MVI   OTIMBAK,NOQ                                                      
         MVI   OGILIST,NOQ                                                      
         MVI   OGIMBTIM,NOQ                                                     
         XR    RE,RE                                                            
         ICM   RE,1,CPYSFST                                                     
         JNZ   *+8                 Check to see if Fiscal Start set             
         AHI   RE,X'F1'               If not, set it to Jan                     
         CHI   RE,X'F0'                                                         
         JH    *+8                                                              
         AHI   RE,X'F0'-X'C0'+X'09'                                             
         SHI   RE,X'F0'                                                         
         STC   RE,OSTMNTH                                                       
*                                                                               
         TM    CPXSTAT6,CPX2LAEI                                                
         JZ    *+8                 CHECK COMP SETTING TO SEE WHETHER            
         MVI   OGINEXP,YESQ        NEW EXPENSES WORKFLOW IN USE                 
         TM    CPYSTATB,CPYSBOMT                                                
         JZ    *+8                 CHECK COMP SETTING TO SEE WHETHER            
         MVI   OGIMBTIM,YESQ       MOBILE TIME IN USE                           
         CLI   QGENINIT,QGENINI                                                 
         JE    GINI02                                                           
         CLI   QGENINIT,QOEIGINI                                                
         JE    GINI28                                                           
         CLI   QGENINIT,QOVRTIME                                                
         JE    GINI02                                                           
         CLI   QGENINIT,QBACSEML                                                
         JE    GINI02                                                           
                                                                                
         MVC   LP_ERROR,=AL2(AE$IVTYP)                                          
         J     QERROR                                                           
                                                                                
GINI02   OC    CCTPID,CCTPID                                                    
         JZ    GINI28                                                           
         USING PIDRECD,R2                                                       
         LA    R2,IOKEY            READ APPROVER RECORD                         
         XC    PIDKEY,PIDKEY                                                    
         MVI   PIDKTYP,PIDKTYPQ                                                 
         MVI   PIDKSUB,PIDKSUBQ                                                 
         MVC   PIDKCPY,CUXCPY                                                   
         MVC   PIDKPID,CCTPID                                                   
         MVI   PIDKSTYP,PIDKBAPQ                                                
         MVC   CSVKEY1,PIDKEY                                                   
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO3'                               
         J     GINI08                                                           
                                                                                
GINI04   GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO3'                               
                                                                                
GINI08   CLC   CSVKEY1(PIDKPER-PIDRECD),PIDKEY                                  
         JNE   GINI10                                                           
         TM    PIDKAPPL,LIDLTIME                                                
         JZ    GINI04                                                           
         MVI   OTIMBAK,YESQ                                                     
                                                                                
         USING APPRECD,R2                                                       
GINI10   LA    R2,IOKEY            READ APPROVER RECORD                         
         XC    APPKEY,APPKEY                                                    
         MVI   APPKTYP,APPKTYPQ                                                 
         MVI   APPKSUB,APPKSUBQ                                                 
         MVC   APPKCPY,CUXCPY                                                   
         MVC   APPKPIDB,CCTPID                                                  
         MVC   CSVKEY1,APPKEY                                                   
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JNE   GINI28                                                           
         MVI   OGICODE,YESQ                                                     
         J     GINI14                                                           
GINI12   GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO3'                               
         LA    R2,IOKEY                                                         
         CLC   CSVKEY1(APPKSEQ-APPRECD),APPKEY                                  
         JNE   GINI28                                                           
                                                                                
GINI14   GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R2,AIO3                                                          
         XR    RF,RF                                                            
         LA    R3,APPRFST                                                       
         USING LIDELD,R3                                                        
GINI16   CLI   LIDEL,0                                                          
         JE    GINI12                                                           
         CLI   LIDEL,LIDELQ                                                     
         JNE   GINI24                                                           
                                                                                
GINI18   CLI   LIDTYPE,LIDTAP1R                                                 
         JNE   GINI24                                                           
         LA    R4,LIDDATA                                                       
         USING LIDDATA,R4                                                       
         LLC   R1,LIDLN                                                         
         AR    R1,R3               R3=End of element                            
                                                                                
GINI20   TM    LIDAPDTY,LIDAPDTI   Is this entry for timesheets                 
         JNZ   GINI26              Yes                                          
                                                                                
GINI22   LLC   R0,LIDITLN          Increment R4 to look at next entry           
         AR    R4,R0                                                            
         CR    R1,R4               Check we haven't reached end of el           
         JH    GINI20              No - check next entry                        
GINI24   IC    RF,LIDLN                                                         
         AR    R3,RF                                                            
         J     GINI16                                                           
                                                                                
GINI26   MVI   OGITIMAP,YESQ       Set time line manager approver               
                                                                                
GINI28   LA    R2,IOKEY                                                         
         USING LLSRECD,R2                                                       
         XC    LLSKEY,LLSKEY                                                    
         MVI   LLSKTYP,LLSKTYPQ                                                 
         MVI   LLSKSUB,LLSKSUBQ                                                 
         MVC   LLSKCPY,CUXCPY                                                   
         MVC   LLSKPIDB,CCTPID                                                  
         MVC   CSVKEY1,LLSKEY                                                   
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO1'                               
         JNE   GINI30                                                           
         CLC   LLSKEY(LLSKGRP-LLSRECD),CSVKEY1                                  
         JNE   GINI30                                                           
         MVI   OGILIST,C'G'                                                     
         CLC   LLSKGRP,SPACES                                                   
         JH    GINI30                                                           
         MVI   OGILIST,C'L'                                                     
                                                                                
GINI30   CLI   QGENINIT,QGENINI    READ FOR CALENDAR IF GENERAL CALL            
         JNE   GINI44                                                           
         USING CASRECD,R2                                                       
         LA    R2,IOKEY            READ APPROVER RECORD                         
         XC    CASKEY,CASKEY                                                    
         MVI   CASKTYP,CASKTYPQ                                                 
         MVI   CASKSUB,CASKSUBQ                                                 
         MVC   CASKCPY,CUXCPY                                                   
         MVC   CSVKEY1,CASKEY                                                   
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO3'                               
         J     GINI34                                                           
                                                                                
GINI32   GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO3'                               
                                                                                
GINI34   CLC   CSVKEY1(CASKEMOA-CASRECD),CASKEY                                 
         JNE   GINI36                                                           
         CLC   OLTSCAL,CASKEMOA    Save the latest calendar year                
         JH    GINI32                                                           
         MVC   OLTSCAL,CASKEMOA                                                 
         J     GINI32                                                           
                                                                                
GINI36   LLC   RF,OLTSCAL          Subtract A0 from the year                    
         SHI   RF,160                                                           
         STC   RF,OLTSCAL                                                       
                                                                                
GINI44   GOTOR GETURL,OGIURL       PULL URL                                     
         MVC   OGIUID,CPYLOGO                                                   
         GOTOR GETAGN,OGINAME      GET AGENCY NAME                              
                                                                                
*&&US                                                                           
         MVC   OGIAGCUR,=C'USD'    AgPASS ISO CUR CODE                          
         MVI   OGIDEC,2                           - DECIMAL POSITIONS           
*&&                                                                             
*&&UK                                                                           
         USING GCURD,R2            R3=A(KEY)                                    
         LA    R2,IOKEY                                                         
         XC    GCKEY,GCKEY                                                      
         MVI   GCKREC,GCKRECQ                                                   
         MVC   GCKCURU,AGYCURR                                                  
         MVC   CSVKEY1,GCKEY                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IOGND+IO1'                               
         JNE   GINI50                                                           
         CLC   GCKEY(GCKCURX-GCURD),CSVKEY1                                     
         JNE   GINI50                                                           
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOGNF+IO1'                              
         JNE   *+2                                                              
         L     R2,AIO1                                                          
         AHI   R2,GCFIRST                                                       
         USING GCREL,R2                                                         
                                                                                
GINI46   CLI   GCREL,0                                                          
         JE    GINI50                                                           
         CLI   GCREL,GCRELQ                                                     
         JE    GINI48                                                           
         LLC   R0,GCRLEN                                                        
         AR    R2,R0                                                            
         J     GINI46                                                           
                                                                                
GINI48   MVC   OGIDEC,GCRDECP                                                   
         MVC   OGIAGCUR,AGYCURR                                                 
                                                                                
GINI50   CLI   QGENINIT,QBACSEML   Are we calling this for the BACS             
         JNE   GINI60                     email service                         
         MVC   TEMP2(2),LP_USRID                                                
         GOTOR (#GETUSR,AGETUSR)   IO1 area contains id record                  
         JNE   GINI58                                                           
         GOTOR (#GETUID,AGETUID)   Get IDI record                               
         JNE   GINI58                                                           
         USING CTIREC,R2                                                        
         L     R2,AIO1                                                          
         LA    R3,CTIDATA                                                       
         USING CTDSTD,R3                                                        
         XR    R0,R0                                                            
GINI52   CLI   CTDSTEL,CTDSTELQ                                                 
         JE    GINI56                                                           
         CLI   CTDSTEL,0                                                        
         JE    GINI58                                                           
GINI54   IC    R0,CTDSTLEN                                                      
         AR    R3,R0                                                            
         J     GINI52                                                           
*                                                                               
GINI56   MVC   OIDINAME,CTDSTNAM   IDI dest name                                
         DROP  R2,R3                                                            
                                                                                
GINI58   GOTOR GETBACE             Look for BACS cc email                       
                                                                                
*&&                                                                             
GINI60   CLI   QGENINIT,QOEIGINI                                                
         JNE   EXITY                                                            
*                                                                               
* Determine length of office                                                    
*                                                                               
         MVI   OOFFLEN,2                                                        
         TM    CPYSTAT4,CPYSOFF2                                                
         JNZ   GINI62                                                           
         MVI   OOFFLEN,1                                                        
         TM    CPYSTAT5,CPYSOFPL                                                
         JNZ   GINI62                                                           
         TM    CPYSTAT1,CPYSOROE                                                
         JNZ   GINI62                                                           
         MVI   OOFFLEN,0                                                        
*                                                                               
* Determine position of office and position and length of dept                  
*                                                                               
GINI62   XC    LDGAREA(LDGALNQ),LDGAREA  Get 2D ledger offpos                   
         MVC   LDGAUL,=CL2'2D'                                                  
         GOTOR (#SETLDG,ASETLDG)                                                
         CLI   LDGAOP,LDGONKHI                                                  
         JH    GINI64                                                           
         NI    LDGAOP,X'FF'-LDGOKEY2                                            
         MVC   O2DOFPOS,LDGAOP                                                  
                                                                                
GINI64   XC    LDGAREA(LDGALNQ),LDGAREA  Get 2P ledger offpos                   
         MVC   LDGAUL,=CL2'2P'                                                  
         GOTOR (#SETLDG,ASETLDG)                                                
         CLI   LDGAOP,LDGONKHI                                                  
         JH    GINI66                                                           
         NI    LDGAOP,X'FF'-LDGOKEY2                                            
         MVC   O2POFPOS,LDGAOP                                                  
GINI66   L     R1,AIO1                                                          
         XR    R0,R0                                                            
         USING LDGRECD,R1                                                       
         LA    R1,LDGRFST                                                       
*                                                                               
         USING LDGELD,R1                                                        
GINI68   CLI   LDGEL,0             Get department position and length           
         JNE   *+6                                                              
         DC    H'0'                Die if no ledger element found               
         CLI   LDGEL,LDGELQ                                                     
         JE    GINI70                                                           
         IC    R0,LDGLN            Bump to next element if not a match          
         AR    R1,R0                                                            
         J     GINI68                                                           
*                                                                               
GINI70   MVC   O2PDPLEN,LDGDLEN    Save department length                       
         MVC   O2PDPPOS,LDGDPOS    Save department position                     
         J     EXITY                                                            
                                                                                
TSTGENTM CLI   QGENINIT,QOVRTIME                                                
         BER   RE                                                               
         CLI   QGENINI2,YESQ       Including overdue time?                      
         BR    RE                                                               
                                                                                
TSTGENOR CLI   QGENINIT,QOEIGINI                                                
         BR    RE                                                               
         EJECT                                                                  
                                                                                
* XT logon download                                                             
                                                                                
REQXTLG  LKREQ H,A#XTLG,OUTXTLG,NEXTREQ=REQHRAT                                 
Id       LKREQ F,1,(I,B#SAVED,QGXLIND),CHAR,LIST=NOD,DEFAULT=Y,        +        
               OLEN=L'GXLIKID,MAXLEN=L'GXLIKID,TEXT=AC#ID,COL=*                 
         LKREQ E                                                                
                                                                                
OUTXTLG  LKOUT H                                                                
         LKOUT R,R#XTLG                                                         
Array    LKOUT C,1,(A,ARYXTL)                                                   
         LKOUT E                                                                
         LKOUT X                                                                
                                                                                
ARYXTL   LKOUT A,(R,NXTXTL),MULTIROW=Y,ROWNAME=GXLID                            
                                                                                
Id       LKOUT C,1,GXLIKID,CHAR                                                 
Array    LKOUT C,2,(A,ARYGXL)                                                   
         LKOUT E                                                                
                                                                                
ARYGXL   LKOUT A,(D,B#GXL,GXLIEL),EOT=EOR,ROWID=(GXLIEL,GXLIELQ),      +        
               ROWWIDTH=(V,GXLIELL)                                             
                                                                                
Url      LKOUT C,2,GXLIDAT,CHAR,ROWID=(GXLIFLD,GXLIFURQ),LEN=V                  
Location LKOUT C,3,GXLIDAT,CHAR,ROWID=(GXLIFLD,GXLIFLOQ),LEN=V                  
Userid   LKOUT C,4,GXLIDAT,CHAR,ROWID=(GXLIFLD,GXLIFUIQ),LEN=V                  
Password LKOUT C,5,GXLIDAT,CHAR,ROWID=(GXLIFLD,GXLIFPWQ),LEN=V                  
         LKOUT E                                                                
                                                                                
***********************************************************************         
* Read XTLogin records                                                *         
***********************************************************************         
                                                                                
NXTXTL   GOTOR (#NXTREC,ANXTREC),DMCB,XTLKEYT,                         +        
               ('B#GXL',0),('$NXTRGEN',SAVED),0,0                               
         J     EXITY                                                            
***********************************************************************         
* Hourly Charge Rates                                                 *         
***********************************************************************         
*&&UK                                                                           
REQHRAT  LKREQ H,A#HRRAT,OUTHRAT,NEXTREQ=REQUESTX                               
*&&                                                                             
*&&US                                                                           
REQHRAT  LKREQ H,A#HRRAT,OUTHRAT,NEXTREQ=REQSTUL                                
*&&                                                                             
                                                                                
Type     LKREQ F,01,(D,B#SAVED,QRATYP),CHAR,OLEN=L'QRATYP,             +        
               MAXLEN=L'QRATYP,TEXT=(*,TYPE),COL=*                              
Effdat   LKREQ F,02,(D,B#SAVED,QRACDT),CHAR,OLEN=L'QRACDT,             +        
               MAXLEN=L'QRACDT,TEXT=(*,DATE),COL=*                              
OffCli   LKREQ F,03,(D,B#SAVED,QRACLO),CHAR,OLEN=L'QRACLO,             +        
               MAXLEN=L'QRACLO,TEXT=(*,CLIOFF),COL=*                            
CliC     LKREQ F,04,(D,B#SAVED,QRACLI),CHAR,OLEN=L'QRACLI,             +        
               MAXLEN=L'QRACLI,TEXT=(*,CLIC),COL=*                              
ProC     LKREQ F,05,(D,B#SAVED,QRAPRO),CHAR,OLEN=L'QRAPRO,             +        
               MAXLEN=L'QRAPRO,TEXT=(*,PROC),COL=*                              
*&&US                                                                           
JobC     LKREQ F,06,(D,B#SAVED,QRAJOB),CHAR,OLEN=L'QRAJOB,             +        
               MAXLEN=L'QRAJOB,TEXT=(*,JOBC),COL=*                              
*&&                                                                             
Off1R    LKREQ F,07,(I,B#SAVED,QRA1RAI),CHAR,TEXT=(*,OROFF),           +        
               LIST=NOSORT,OLEN=L'QRA1RO,ARRAY=S                                
Dept     LKREQ F,08,,CHAR,TEXT=(*,DEPT),                               +        
               OLEN=L'QRADPT                                                    
Subdept  LKREQ F,09,,CHAR,TEXT=(*,SUBD),                               +        
               OLEN=L'QRASUB                                                    
Person   LKREQ F,10,,CHAR,TEXT=(*,PERS),                               +        
               OLEN=L'QRAPER                                                    
Wcode    LKREQ F,11,,CHAR,TEXT=(*,WCD),                                +        
               OLEN=L'QRAWCD,ARRAY=E                                            
LStyle   LKREQ F,12,(D,B#SAVED,QRASTY),CHAR,OLEN=L'QRASTY,             +        
               MAXLEN=L'QRASTY,TEXT=(*,LSTYLE),COL=*                            
Currency LKREQ F,13,(D,B#SAVED,QRACUR),CHAR,OLEN=L'QRACUR,             +        
               MAXLEN=L'QRACUR,TEXT=(*,CURRY),COL=*                             
Xrate    LKREQ F,14,(D,B#SAVED,QRARAT),HEXD,OLEN=L'QRARAT,             +        
               MAXLEN=2*L'QRARAT,TEXT=(*,XRATE),COL=*                           
         LKREQ E                                                                
                                                                                
OUTHRAT  LKOUT H                                                                
         LKOUT R,R#HRRAT                                                        
Array    LKOUT C,1,(A,ARYRAT)                                                   
         LKOUT E                                                                
         LKOUT X                                                                
                                                                                
ARYRAT   LKOUT A,(R,NXTRAT),MULTIROW=Y,ROWNAME=SAVED                            
ORacc    LKOUT C,01,RA_1RAC,CHAR,ND=Y                                           
ORnam    LKOUT C,02,RA_1RNM,CHAR,ND=Y                                           
Status   LKOUT C,03,RA_RACL,CHAR                                                
Hrate    LKOUT C,04,RA_HRAT,SPAK                                                
Efdate   LKOUT C,05,RA_EFDT,PDAT,ND=Y                                           
Hrate    LKOUT C,06,RA_HRFC,SPAK                                                
RtRank   LKOUT C,07,RA_SRNK,LBIN                                                
SJacc    LKOUT C,08,RA_SJAC,CHAR,ND=Y                                           
Task     LKOUT C,09,RA_TASK,CHAR,ND=Y                                           
Array    LKOUT C,1,(A,ARYPLEV),FILTROUT=TSTRODK                                 
         LKOUT E                                                                
                                                                                
* ACCOUNT PREVIOUS LEVELS PROCESSOR ARRAY                                       
                                                                                
ARYPLEV  LKOUT A,(R,NXTPACT),MULTIROW=Y,ROWNAME=SAVED                           
                                                                                
PrevName LKOUT C,1,PREVULA,(R,EDTANM)                                           
PrevCode LKOUT C,2,PREVACT,CHAR,ND=Y                                            
                                                                                
         LKOUT E                                                                
                                                                                
                                                                                
BATTYPE  DC    C'Batch type'                                                    
TYPE     DC    C'Type'                                                          
DATE     DC    C'Date'                                                          
CLIOFF   DC    C'Client Office'                                                 
CLIC     DC    C'Client code'                                                   
PROC     DC    C'Product code'                                                  
JOBC     DC    C'Job code'                                                      
OROFF    DC    C'1R office'                                                     
DEPT     DC    C'Dept'                                                          
SUBD     DC    C'Subdept'                                                       
PERS     DC    C'Person'                                                        
WCD      DC    C'Workcode'                                                      
LSTYLE   DC    C'List style'                                                    
CURRY    DC    C'Currency'                                                      
XRATE    DC    C'Exchange rate on estimate'                                     
                                                                                
***********************************************************************         
* Read Hourly Rate records:                                           *         
* 1. Put requested 1R a/c+name recs, GAPLST filtered, to TSAR buffer. *         
* 2. Put PCR/PCH recs to same TSAR buffer, using same key + hierarchy *         
* byte set according to GETRATE's SRCHTBL (copied into this book).    *         
* 3. Read back all buffer recs, keeping 1 rate rec for each lvl of 1R *         
* to match against 1R a/c+name buffrecs in sequence. See CR_ARD       *         
***********************************************************************         
                                                                                
NXTRAT   ST    R8,LP_ADATA                                                      
         CLI   LP_RMODE,LP_RFRST   test first time                              
         JE    NRAT02                                                           
*&&UK*&& J     NRAT60                                                           
*&&US*&& J     NRAT102                                                          
                                                                                
NRAT02   GOTOR GOTSAR,DMCB,('TSAINI',0)                                         
                                                                                
         MVI   LP_RMODE,LP_RNEXT                                                
         CLI   QRASTY,QRAWCQ       test only want work code level rates         
         JE    NRAT06              yes - so ignore 1R accounts                  
         XC    DONERLNS,DONERLNS   Set 1R key component lengths                 
         SR    R1,R1                                                            
         SR    RF,RF                                                            
         IC    R1,ONERL4L                                                       
         IC    RF,ONERL3L                                                       
         SR    R1,RF                                                            
         STC   R1,DONERLN4                                                      
         IC    R1,ONERL2L                                                       
         SR    RF,R1                                                            
         STC   RF,DONERLN3                                                      
         IC    RF,ONERL1L                                                       
         SR    R1,RF                                                            
         STC   R1,DONERLN2                                                      
         MVC   DONERLN1,ONERL1L                                                 
                                                                                
         XC    LDGAREA(LDGALNQ),LDGAREA  Get 1R ledger offpos                   
         MVC   LDGAUL,=CL2'1R'                                                  
         GOTOR (#SETLDG,ASETLDG)                                                
         MVC   DONEROP,LDGAOP                                                   
                                                                                
         XC    DONERILS,DONERILS   set l'input 1R key fields                    
         LA    R1,L'QRA1RO                                                      
         STC   R1,DONERILS+0                                                    
         LA    R1,L'QRADPT                                                      
         STC   R1,DONERILS+1                                                    
         LA    R1,L'QRASUB                                                      
         STC   R1,DONERILS+2                                                    
         LA    R1,L'QRAPER                                                      
         STC   R1,DONERILS+3                                                    
                                                                                
         GOTOR (#GOATSR,AGOATSR),DMCB,('TSAINI',ATSRERRS),0,GAPAREA2,  +        
               TSARABUF                                                         
**                                 Call GAPLST for 1R rights for                
**                                 connected pid                                
         MVI   GAPLPARM,0                                                       
         GOTOR (#GAPLST,AGAPLST),DMCB,('GAPTT1Q',TSARABUF),            +        
               ('GAPLLIML',SPACES),('GAPLTACC',GAPLPARM),('QEST',0)             
         JE    NRAT04                                                           
         CLC   FULL2(2),=AL2(AE$NLIML) test list of approves is empty           
         JNE   *+8                                                              
         MVI   OLIMLST,NOQ                                                      
         MVC   LP_ERROR,FULL2      set error msgno from GAPLST                  
         J     NRATERR                                                          
                                                                                
NRAT04   GOTOR READ1R              read 1R accs, put to TSAR                    
         JNE   NRATERR                                                          
                                                                                
NRAT06   XC    DPRODLNS,DPRODLNS   Set SJ key component lengths                 
         SR    R1,R1                                                            
         SR    RF,RF                                                            
         IC    R1,PJOBLEN                                                       
         IC    RF,PPROLEN                                                       
         SR    R1,RF                                                            
         STC   R1,DJOBLN                                                        
         IC    R1,PCLILEN                                                       
         SR    RF,R1                                                            
         STC   RF,DPROLN                                                        
         MVC   DCLILN,PCLILEN                                                   
                                                                                
         XC    DPRODILS,DPRODILS   set l'input SJ key fields                    
         LA    R1,L'QRACLI                                                      
         STC   R1,DPRODILS+0                                                    
         LA    R1,L'QRAPRO                                                      
         STC   R1,DPRODILS+1                                                    
         IC    R1,DJOBLN                                                        
         STC   R1,DPRODILS+2                                                    
                                                                                
         GOTOR VDATCON,DMCB,(9,QRACDT),(31,DCURDTA) multiple o/p types          
         ORG   *-2                                                              
         OC    QRACDT,QRACDT       test date passed                             
         JNZ   *+14                                                             
         XC    0(4,R1),0(R1)       else set DATCON parms for 'today'            
         MVI   0(R1),5                                                          
*        MVI   QRACDT,C'2'         set century for DATCON                       
         BASR  RE,RF                                                            
*&&UK                                                                           
         CLI   LP_SENO,X'78'       For QA files (ACCQA)                         
         JE    NRAT06A                                                          
         CLI   LP_SENO,X'73'       ACCQB                                        
         JE    NRAT06A                                                          
*&&                                                                             
*&&US                                                                           
         CLI   LP_SENO,X'22'       ACCQA                                        
         JE    NRAT06A                                                          
         CLI   LP_SENO,X'23'       ACCQB                                        
         JE    NRAT06A                                                          
*&&                                                                             
         J     NRAT06B                                                          
NRAT06A  XC    DCUTDTP,DCUTDTP   For QA files no cutoff                         
         J     NRAT07                                                           
NRAT06B  DS    0H                                                               
*                                set cutoff date to skip very old rates         
*&&UK*&& GOTOR VDATCON,DMCB,(X'31',DCURDTP),(1,DCUTDTP),(10,0),F'-5'            
*&&US*&& GOTOR VDATCON,DMCB,(X'31',DCURDTP),(1,DCUTDTP),(10,0),F'-10'           
                                                                                
NRAT07   CLC   QRACLI,SPACES       Test client passed                           
         JNH   NRAT22                                                           
*&&UK*&& LA    R0,2                Build client (+product) acc code             
*&&US*&& LA    R0,3                Build client (+prod+job) acc code            
         LA    R1,DPRODLNS                                                      
         LA    R3,QRACLI                                                        
         LA    R4,DSJACC                                                        
         GOTOR BLDKEY                                                           
         CLC   QRACLO,SPACES       Test client office passed                    
         JH    NRAT22                                                           
         USING ACTRECD,R2                                                       
         LA    R2,IOKEY            Read SJ cli/pro for client office            
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKUNT(2),PRODUL                                                
         MVC   ACTKACT,DSJACC      Try cli+pro first                            
         J     NRAT10                                                           
NRAT08   LA    R0,1                                                             
         LA    R1,DPRODLNS                                                      
         LA    R3,QRACLI                                                        
         LA    R4,ACTKACT                                                       
         GOTOR BLDKEY                                                           
NRAT10   MVC   SAVEKEY2,ACTKEY                                                  
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JE    *+6                                                              
         DC    H'0'                Expect to find cli/pro                       
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         L     R2,AIO2                                                          
         USING PPRELD,RF                                                        
         LA    RF,ACTRFST                                                       
         SR    R0,R0                                                            
NRAT12   CLI   PPREL,0                                                          
         JE    NRAT14                                                           
         CLI   PPREL,PPRELQ        Prod profile element                         
         JE    *+14                                                             
         IC    R0,PPRLN                                                         
         AR    RF,R0                                                            
         J     NRAT12                                                           
         CLC   PPRGAOFF,SPACES                                                  
         JNH   NRAT14                                                           
         MVC   QRACLO,PPRGAOFF     Save office in request field                 
         J     NRAT22                                                           
NRAT14   SR    RF,RF               Element not found/office not set:            
         IC    RF,DCLILN                                                        
         LA    RF,ACTKACT(RF)                                                   
         CLI   0(RF),C' '                                                       
         JNE   NRAT16              Prod level, try client                       
         CLI   PPREL,0             Else client level:                           
         JNE   NRAT22              Found PPREL but office not set               
         DC    H'0'                No PPREL on client record?                   
NRAT16   LA    R2,IOKEY                                                         
         LA    R0,1                Else rebuild client-only key                 
         J     NRAT08              and try again                                
         DROP  R2,RF                                                            
*                                  Read rate records                            
*&&UK                                                                           
***********************************************************************         
* List request: One entry in request array, return all 1R a/cs + rates*         
* for that 1R lvl and below. Read rate recs once, filter on request   *         
* 1R/SJ/WC/Off.                                                       *         
* Refresh request: N entries in request array,return requested 1R a/c *         
* + current rate per entry.  Read rate recs N times, filter on request*         
* 1R/SJ/WC/Off                                                        *         
***********************************************************************         
                                                                                
NRAT22   CLI   QRASTY,QRAWCQ       test only want work code level rates         
         JE    NRAT30              yes - so ignore 1R accounts                  
*RAT22   CLI   QRATYP,QRATLST      test 'List' request                          
*        JE    NRAT30                                                           
         SR    RF,RF               Else 'Refresh' request                       
         ICM   RF,7,QRA1RAA        A(1R+WC array)                               
         JNZ   *+6                                                              
         DC    H'0'                must be at least one entry...                
         XC    ARYNTRN,ARYNTRN                                                  
         MVC   ARYNENT,LW_NUMN-LW_D(RF)  N'entries                              
         AHI   RF,LW_LN2Q                                                       
         ST    RF,ARYAENT          A(1st Array entry data)                      
         J     NRAT28                                                           
                                                                                
NRAT26   SR    R0,R0                                                            
         ICM   R0,3,ARYNENT                                                     
         AHI   R0,-1                                                            
         JZ    NRAT58              Array finished                               
         STCM  R0,3,ARYNENT                                                     
         ICM   R0,3,ARYNTRN        increment n'array entry                      
         AHI   R0,1                                                             
         STCM  R0,3,ARYNTRN                                                     
         L     RF,ARYAENT                                                       
         AHI   RF,QRA1RAL                                                       
         ST    RF,ARYAENT                                                       
NRAT28   MVC   QRA1RO(QRA1RAL),0(RF) copy array entry data vals                 
         LA    R0,4                N'1R levlens                                 
         LA    R1,DONERLNS                                                      
         LA    R3,QRA1RO                                                        
         LA    R4,D1RACC                                                        
         GOTOR BLDKEY              build 1R key                                 
                                                                                
         USING PCRRECD,R2                                                       
NRAT30   LA    R2,IOKEY                                                         
         XC    PCRKEY,PCRKEY                                                    
         MVI   PCRKTYP,PCRKTMSQ    UK rate record                               
         CLI   CUCTRY,CTRYGER                                                   
         JNE   *+8                                                              
         MVI   PCRKTYP,PCRKTYPQ    DE rate record                               
         MVC   PCRKCPY,CUXCPY                                                   
         LA    RF,PCRKJOB                                                       
         TM    CPYSTAT4,CPYSOFF2                                                
         JZ    *+8                                                              
         LA    RF,PCRKJOB2                                                      
         ST    RF,FULL1            save disp to job                             
                                                                                
         MVC   SAVEKEY2,PCRKEY                                                  
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         JE    NRAT34                                                           
         DC    H'0'                                                             
                                                                                
NRAT32   GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
NRAT34   CLC   PCRKEY(PCRKPER-PCRKEY),SAVEKEY2                                  
         JE    NRAT36                                                           
*                                  End of rates:                                
         CLI   QRATYP,QRATRFS      test 'Refresh' request                       
         JE    NRAT26              yes - get next array entry                   
         J     NRAT58              Else process TSAR buffer                     
                                                                                
NRAT36   CLC   QRAWCD,SPACES       Test workcode                                
         JNH   NRAT38              not specified - any will do                  
         L     RF,FULL1                                                         
         CLC   L'PCRKJOB(L'PCRKTSK,RF),FFS    workcode beyond job               
         JE    NRAT38              not set - carry on                           
         CLC   QRAWCD,L'PCRKJOB(RF)                                             
         JNE   NRAT32              read next                                    
                                                                                
NRAT38   LA    R0,3                Test SJ cli/pro (/job lvl is dummy)          
         LA    R1,DJOBLN                                                        
         LA    R3,DSJACC+L'DSJACC                                               
         L     R4,FULL1                                                         
         LA    R4,L'PCRKJOB(R4)                                                 
         MVI   BYTE1,C'J'          SJ                                           
         GOTOR TSTKEY                                                           
         JNE   NRAT32              doesn't match, read next                     
                                                                                
         CLI   QRACLO,C' '         Test client office                           
         JNH   NRAT40              not specified - any will do                  
         CLI   PCRKOFF,X'FF'                                                    
         JE    NRAT40              not set - carry on                           
         CLC   PCRKOFF,QRACLO                                                   
         JNE   NRAT32              read next                                    
         TM    CPYSTAT4,CPYSOFF2                                                
         JZ    NRAT40                                                           
         CLC   PCRKOFF2,QRACLO     1/2 chars                                    
         JNE   NRAT32              read next                                    
                                                                                
NRAT40   CLI   QRASTY,QRAWCQ       test only want work code level rates         
         JNE   NRAT42              yes - so ignore this account                 
         CLC   PCRKPER,SPACES      Ignore any 1R rates                          
         JH    NRAT32                                                           
         J     NRAT44                                                           
NRAT42   LA    R0,4                Test 1R account                              
         LA    R1,DONERLN4                                                      
         LA    R3,D1RACC+L'D1RACC                                               
         LA    R4,PCRKPER+L'PCRKPER                                             
         MVI   BYTE1,C'R'          1R                                           
         GOTOR TSTKEY                                                           
         JE    NRAT44                                                           
         CLI   QRATYP,QRATRFS      test 'Refresh' request                       
         JNE   NRAT32              no - read next rate                          
         CLC   PCRKPER,D1RACC      Else test rate key > array entry 1R          
         JL    NRAT32              no - get next rate rec                       
         J     NRAT26              yes - get next array entry                   
                                                                                
NRAT44   GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         USING CR_ARD,CR_BUFF                                                   
         XC    CR_BUFF(CR_XLNQ),CR_BUFF                                         
         MVC   CR_NTRN,ARYNTRN     Set array entry num in key                   
         MVC   CR_1RAC,PCRKPER                                                  
         MVI   CR_ARIND,CR_ARRAQ   set 'rate' type record                       
         LA    RF,PCRKJOB                                                       
         LA    RE,PCRKTSK                                                       
         TM    CPYSTAT4,CPYSOFF2                                                
         JZ    *+12                                                             
         LA    RF,PCRKJOB2                                                      
         LA    RE,PCRKTSK2                                                      
*        CLC   0(L'PCRKJOB,RF),FFS test SJ account set                          
*        JE    *+10                No                                           
         MVC   CR_SJAC,0(RF)       Save SJ account code                         
*        CLC   0(L'PCRKTSK,RE),FFS test work code is set                        
*        JE    *+10                No                                           
         CLI   QRASTY,QRAWCQ       Only save work code for non 1r call          
         JNE   *+10                                                             
         MVC   CR_TASK,0(RE)       Save work code                               
         LA    RE,CR_SJAC-1                                                     
         LA    RF,L'CR_SJAC                                                     
NRAT46   LA    R1,0(RE,RF)                                                      
         CLI   0(R1),X'FF'         Change FFs to spaces                         
         JNE   *+12                                                             
         MVI   0(R1),C' '                                                       
         JCT   RF,NRAT46                                                        
                                                                                
         LA    RE,CR_TASK-1                                                     
         LA    RF,L'CR_TASK                                                     
NRAT48   LA    R1,0(RE,RF)                                                      
         CLI   0(R1),X'FF'         Change FFs to spaces                         
         JNE   *+12                                                             
         MVI   0(R1),C' '                                                       
         JCT   RF,NRAT48                                                        
                                                                                
         GOTOR GETHIER,0           get rate hierarchy value                     
         JNE   NRAT32              rate key structure not in SRCHTBL            
         MVC   CR_ARRHI,BYTE2      set in buff key                              
                                                                                
         ZAP   CR_RATE,PZERO                                                    
         L     RF,AIO2                                                          
         LA    RF,PCRRFST-PCRRECD(RF)                                           
         USING TCIELD,RF                                                        
NRAT50   CLI   TCIEL,0             Find charge rate elements                    
         JE    NRAT56                                                           
         CLI   TCIEL,TCIELQ                                                     
         JE    NRAT54                                                           
NRAT52   IC    R0,TCILN                                                         
         AR    RF,R0                                                            
         J     NRAT50                                                           
                                                                                
NRAT54   CLC   TCIDTE,DCURDTP                                                   
         JH    NRAT52              not effective till after req date            
         CLC   TCIDTE,DCUTDTP                                                   
         JL    NRAT52              earlier than cutoff date                     
         CLC   TCIDTE,CR_EFDT                                                   
         JL    NRAT52              don't want                                   
         MVC   CR_EFDT,TCIDTE      save highest date found                      
         ZAP   CR_RATE,TCIAMT      and rate                                     
         J     NRAT52                                                           
         DROP  RF                                                               
                                                                                
NRAT56   OC    CR_EFDT,CR_EFDT     test any qualifying rate found               
         JZ    NRAT32              no - skip this record                        
         LHI   RE,CR_RRLQ          rate rec len                                 
         STH   RE,CR_LEN                                                        
         GOTOR GOTSAR,DMCB,('TSAADD',0)                                         
         JE    NRAT32              next rate record                             
         TM    TSARERRS,TSEEOF     Test end of buffer                           
         JNZ   *+6                                                              
         DC    H'0'                Duplicate key                                
         MVC   LP_ERROR,=AL2(AE$MAX#)                                           
         DC    H'0'                *** Testing                                  
         J     EXITN                                                            
*                                  End of rate recs: read back frm TSAR         
NRAT58   XC    SBUFRATS,SBUFRATS                                                
         XC    CR_BUFF(CR_XLNQ),CR_BUFF                                         
         GOTOR GOTSAR,DMCB,('TSARDH',0)                                         
         J     NRAT62                                                           
                                                                                
NRAT60   XC    CR_BUFF(CR_XLNQ),CR_BUFF                                         
         GOTOR GOTSAR,DMCB,('TSANXT',0)                                         
                                                                                
NRAT62   TM    TSARERRS,TSEEOF                                                  
         JNZ   NRATLST             finished                                     
                                                                                
         XR    R0,R0                                                            
         LA    RF,CR_BUFF                                                       
         CLI   QRASTY,QRAWCQ       test only want work code level rates         
         JNE   NRAT66              No                                           
         CLC   DLASTWC,CR_TASK     Was there a better match previously          
         JE    NRAT60              Yes - get next record                        
         MVC   DLASTWC,CR_TASK     Save new work code                           
         CLC   CR_TASK,SPACES      For rate without work code capture           
         JH    NRAT64              the lowest ranking                           
         MVC   DLASTHIR,CR_ARRHI                                                
         J     NRAT76              Put record out                               
                                                                                
NRAT64   OC    DLASTHIR,DLASTHIR   Have we found a non work code rate           
         JZ    NRAT76              No                                           
         CLC   CR_ARRHI,DLASTHIR   Yes - check our work isn't a higher          
         JNH   NRAT76                                     level                 
         J     NRAT60              otherwise ignore it                          
                                                                                
NRAT66   GOTOR GETLVAC,CR_1RAC     get buffrec's 1R account lvl                 
                                                                                
         CLI   CR_ARIND,CR_ARRAQ   test buffrec type - rate                     
         JNE   NRAT68                               or name                     
         LR    RE,R1               R1 = 1R lvl 0-4                              
         MHI   RE,CR_RRLQ                                                       
         LA    RF,SBUFRATS(RE)     displace to saved rate slot for lvl          
S        USING CR_ARD,RF                                                        
         CLC   S.CR_NTRN(CR_N1RLQ),CR_NTRN                                      
*                                  ignore all but first of each account         
         JE    NRAT60              as 'best match' rate is sorted first         
         MVC   S.CR_ARD(CR_RRLQ),CR_ARD  else save buffrec for compare          
         J     NRAT60                                                           
*                                  Name buffrec: clc with rate buffrecs         
NRAT68   XC    RA_VALS(RA_LNQ),RA_VALS                                          
         LTR   R0,R1               R1 = 1R lvl 0-4                              
         JZ    NRAT72              0 = ledger level                             
                                                                                
NRAT70   LR    RE,R0                                                            
         LA    R1,ONERL1L-1(RE)    displace to levlen                           
         MHI   RE,CR_RRLQ                                                       
         LA    RF,SBUFRATS(RE)     disp to saved rate buffrec                   
         IC    RE,0(R1)                                                         
         AHI   RE,L'CR_NTRN        add l'array entry num                        
         AHI   RE,-1               ex l'compare                                 
         BASR  R1,0                                                             
         CLC   S.CR_NTRN(0),CR_NTRN  test buff acc matches saved lvl            
         EX    RE,0(R1)                                                         
         JE    NRAT76              matches                                      
         CLI   QRASTY,QRA1RQ       test only want 1R a/cs with own rate         
         JE    NRAT60              yes - so ignore this account                 
         JCT   R0,NRAT70           else try next higher level rate              
                                                                                
NRAT72   LA    RF,SBUFRATS         last resort: ledger level buffrec            
         OC    S.CR_1RAC,S.CR_1RAC test rate rec exists                         
         JNZ   NRAT76              therefore it matches                         
NRAT74   MVI   RA_RACL,C'9'        else return 9 ='No rate found'               
         J     NRAT80                                                           
                                                                                
NRAT76   STC   R0,RA_RACL                                                       
         OI    RA_RACL,X'F0'       make char so 0 output not ignored            
         ZAP   RA_HRAT,S.CR_RATE                                                
         ZAP   DUB1,S.CR_RATE                                                   
         CLC   QRACUR,SPACES       test foreign currency required               
         JNH   NRAT78              no                                           
         GOTOR CONCUR              convert rate to f/c                          
NRAT78   ZAP   RA_HRFC,DUB1        return foreign currency                      
         MVC   RA_EFDT,S.CR_EFDT                                                
         MVC   RA_SJAC,S.CR_SJAC                                                
         MVC   RA_TASK,S.CR_TASK                                                
NRAT80   MVC   RA_1RAC,CR_1RAC                                                  
         MVC   PREVUNT(L'ACTKUNT+L'ACTKLDG),=C'1R'                              
         MVC   PREVACT,CR_1RAC                                                  
         CLI   QRASTY,QRAWCQ       test only want work code level rates         
         JE    *+10                Skip 1r name as there is none                
         MVC   RA_1RNM,CR_1RNM                                                  
         MVC   RA_SRNK,S.CR_ARRHI  SRCHTBL rank for debugging/testing           
         J     EXITY                                                            
         DROP  S                                                                
*&&                                                                             
*&&US                                                                           
***********************************************************************         
* List request: One entry in request array, return all 1R a/cs + rates*         
* for that 1R lvl and below. Read rate recs once, plus adjustment rate*         
* recs if job or WC flag set.  Filter rates on request 1R/SJ/WC/Off   *         
* Refresh request: N entries in request array, return requested 1R a/c*         
* + current rate per entry. Read rate recs, plus adjustment rate recs *         
* if job or WC flag set, N times. Filter rates on request 1R/SJ/WC/OFF*         
***********************************************************************         
                                                                                
         USING ACTRECD,R2                                                       
NRAT22   MVI   RATEADJ,NOQ         First, look for rate adjust flag:            
         CLC   QRAJOB,SPACES       Test job passed                              
         JNH   NRAT026             No, skip                                     
         LA    R2,IOKEY                                                         
         MVC   ACTKEY,SPACES       ...On job record                             
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKUNT(2),PRODUL                                                
         MVC   ACTKACT,DSJACC                                                   
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R2,AIO2                                                          
         USING JOBELD,RF                                                        
         LA    RF,ACTRFST                                                       
         SR    R0,R0                                                            
NRAT024  CLI   JOBEL,0                                                          
         JNE   *+6                                                              
         DC    H'0'                job with no JOBEL?                           
         CLI   JOBEL,JOBELQ                                                     
         JE    *+14                                                             
         IC    R0,JOBLN                                                         
         AR    RF,R0                                                            
         J     NRAT024                                                          
         TM    JOBSTA1,JOBSART                                                  
         JZ    *+8                                                              
         MVI   RATEADJ,YESQ        set rate can be adjusted                     
                                                                                
NRAT026  CLI   QRASTY,QRAWCQ       test only want work code level rates         
         JE    NRAT032             yes - so ignore 1R accounts                  
         SR    RF,RF               Else 'Refresh' request                       
         ICM   RF,7,QRA1RAA        A(1R+WC array)                               
         JNZ   *+6                                                              
         DC    H'0'                must be at least one entry...                
         XC    ARYNTRN,ARYNTRN                                                  
         MVC   ARYNENT,LW_NUMN-LW_D(RF)  N'entries                              
         AHI   RF,LW_LN2Q                                                       
         ST    RF,ARYAENT          A(1st Array entry data)                      
         J     NRAT030                                                          
                                                                                
NRAT028  SR    R0,R0                                                            
         ICM   R0,3,ARYNENT                                                     
         AHI   R0,-1                                                            
         JZ    NRAT066             Array finished                               
         STCM  R0,3,ARYNENT                                                     
         ICM   R0,3,ARYNTRN        increment n'array entry                      
         AHI   R0,1                                                             
         STCM  R0,3,ARYNTRN                                                     
         L     RF,ARYAENT                                                       
         AHI   RF,QRA1RAL                                                       
         ST    RF,ARYAENT                                                       
NRAT030  MVC   QRA1RO(QRA1RAL),0(RF) copy array entry data vals                 
         LA    R0,4                N'1R levlens                                 
         LA    R1,DONERLNS                                                      
         LA    R3,QRA1RO                                                        
         LA    R4,D1RACC                                                        
         GOTOR BLDKEY              build 1R key                                 
                                                                                
NRAT032  CLI   RATEADJ,YESQ        test already set from job level              
         JE    NRAT036                                                          
         CLI   QRASTY,QRAWCQ       If work code level rates we don't            
         JE    NRAT036              know work code at this point                
         USING WCORECD,R2                                                       
         LA    R2,IOKEY            Else check workcode record                   
         MVC   WCOKEY,SPACES                                                    
         MVI   WCOKTYP,WCOKTYPQ                                                 
         MVC   WCOKCPY,CUXCPY                                                   
         MVC   WCOKUNT(2),PRODUL                                                
         MVC   WCOKWRK,QRAWCD                                                   
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R2,AIO2                                                          
         USING WCOELD,RF                                                        
         LA    RF,WCORFST                                                       
         SR    R0,R0                                                            
NRAT034  CLI   WCOEL,0                                                          
         JNE   *+6                                                              
         DC    H'0'                                                             
         CLI   WCOEL,WCOELQ                                                     
         JE    *+14                                                             
         IC    R0,WCOLN                                                         
         AR    RF,R0                                                            
         J     NRAT034                                                          
         TM    WCOSTAT2,WCOSART                                                 
         JZ    *+8                                                              
         MVI   RATEADJ,YESQ        set rate can be adjusted                     
                                                                                
         USING PCHRECD,R2                                                       
NRAT036  LA    R2,IOKEY            Read regular rate records                    
         XC    PCHKEY,PCHKEY                                                    
         MVI   PCHKTYP,PCHKTYPQ                                                 
         MVC   PCHKCPY,CUXCPY                                                   
         MVC   SAVEKEY2,PCHKEY                                                  
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         JE    NRAT040                                                          
         DC    H'0'                                                             
                                                                                
NRAT038  GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
NRAT040  CLC   PCHKEY(PCHKDOF-PCHKEY),SAVEKEY2                                  
         JE    NRAT042                                                          
*                                  End of rates:                                
         CLI   QRATYP,QRATRFS      test 'Refresh' request                       
         JE    NRAT028             yes - get next array entry                   
         J     NRAT066             End of rate records                          
                                                                                
NRAT042  LA    R0,2                Test SJ cli/pro                              
         LA    R1,DPROLN                                                        
         LA    R3,DSJACC+L'PCHKCLI+L'PCHKPRO                                    
         LA    R4,PCHKPRO+L'PCHKPRO                                             
         MVI   BYTE1,C'J'          SJ                                           
         GOTOR TSTKEY                                                           
         JNE   NRAT038             read next                                    
                                                                                
         CLC   QRAWCD,SPACES       Test workcode                                
         JNH   NRAT044             not passed - any will do                     
         OC    PCHKTSK,PCHKTSK                                                  
         JZ    NRAT044             not set in key - any will do                 
         CLC   PCHKTSK,QRAWCD                                                   
         JNE   NRAT038                                                          
NRAT044  CLC   QRACLO,SPACES       test client office                           
         JNH   NRAT046             not passed - any will do                     
         OC    PCHKOFF,PCHKOFF                                                  
         JZ    NRAT046             not set in key - any will do                 
         CLC   PCHKOFF,QRACLO                                                   
         JNE   NRAT038                                                          
                                                                                
NRAT046  CLI   QRASTY,QRAWCQ       test only want work code level rates         
         JNE   NRAT050             yes - so ignore this account                 
         CLC   QRACLO,SPACES       Use client office for                        
         JNH   NRAT048             not passed - any will do                     
         CLC   PCHKDOF,QRACLO      Skip rates where office doesn't              
         JNE   NRAT038                                      match               
NRAT048  CLC   PCHKDEP,SPACES      Ignore any 1R rates with dept                
         JH    NRAT038                              sub dept or staff           
         CLC   PCHKSUB,SPACES                                                   
         JH    NRAT038                                                          
         CLC   PCHKSTF,SPACES                                                   
         JH    NRAT038                                                          
         MVC   WORK,SPACES                                                      
         MVC   WORK(L'PCHKDOF),PCHKDOF                                          
         J     NRAT052                                                          
NRAT050  LA    R0,4                Test 1R account                              
         LA    R1,DONERILS         lengths match l'PCH 1R components            
         LA    R3,PCHKDOF                                                       
         LA    R4,WORK                                                          
         GOTOR SQSH1R              squash PCH 1R key comps in WORK              
                                                                                
         LA    R0,4                Test 1R account                              
         LA    R1,DONERLN4                                                      
         LA    R3,D1RACC+L'D1RACC                                               
         LA    R4,WORK+L'ACTKACT                                                
         MVI   BYTE1,C'R'          1R                                           
         GOTOR TSTKEY                                                           
         JE    NRAT052                                                          
         CLI   QRATYP,QRATRFS      test 'Refresh' request                       
         JNE   NRAT038             no - read next rate                          
         CLC   WORK(L'ACTKACT),D1RACC  Else test rate key > array 1R            
         JL    NRAT038             no - get next rate rec                       
         J     NRAT028             yes - get next array entry                   
                                                                                
NRAT052  GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         USING CR_ARD,CR_BUFF                                                   
         XC    CR_BUFF(CR_XLNQ),CR_BUFF                                         
         MVC   CR_NTRN,ARYNTRN     Set array entry num in key                   
         CLI   QRASTY,QRAWCQ                                                    
         JE    *+10                                                             
         MVC   CR_1RAC,WORK                                                     
         MVI   CR_ARIND,CR_ARRAQ   set 'Rate' type record                       
         CLC   PCHKCLI,SPACES                                                   
         JNH   *+10                                                             
         MVC   CR_SJAC(L'PCHKCLI+L'PCHKPRO),PCHKCLI  Set SJ acc code            
         CLI   QRASTY,QRAWCQ       Only save work code for non 1R call          
         JNE   NRAT053                                                          
         MVC   CR_TASK,PCHKTSK     Set work code                                
         OC    PCHKTSK,PCHKTSK                                                  
         JNZ   *+10                                                             
         MVC   CR_TASK,SPACES                                                   
                                                                                
NRAT053  GOTOR GETHIER,0           get Rate rec hierarchy value                 
         JNE   NRAT038             rate key structure not in SRCHTBL            
         MVC   CR_ARRHI,BYTE2      set in buff key                              
                                                                                
         ZAP   CR_RATE,PZERO                                                    
         L     RF,AIO2                                                          
         LA    RF,PCHRFST-PCHRECD(RF)                                           
         USING TCIELD,RF                                                        
         MVI   BYTE1,0                                                          
NRAT054  CLI   TCIEL,0             Find charge rate elements                    
         JE    NRAT062                                                          
         CLI   TCIEL,TCIELQ                                                     
         JE    NRAT058                                                          
NRAT056  IC    R0,TCILN                                                         
         AR    RF,R0                                                            
         J     NRAT054                                                          
                                                                                
NRAT058  OC    TCIDTE,TCIDTE       test effective date blank                    
         JNZ   *+12                                                             
         MVI   TCIDTE+L'TCIDTE-1,1 set dummy lowest 'date'                      
         J     NRAT060                                                          
         CLC   TCIDTE,DCURDTP                                                   
         JNH   NRAT059                                                          
         SR    R1,R1               For Aura ignore rates set in the             
         ICM   R1,3,CUXPNUM                              future                 
         CHI   R1,XPRODIKQ                                                      
         JE    NRAT056                                                          
         MVI   BYTE1,X'FF'                                                      
         J     NRAT056             not effective till after req date            
NRAT059  CLC   TCIDTE,DCUTDTP                                                   
         JL    NRAT056             earlier than cutoff date                     
NRAT060  CLC   TCIDTE,CR_EFDT                                                   
         JL    NRAT056             don't want                                   
         MVC   CR_EFDT,TCIDTE      save highest date found                      
         ZAP   CR_RATE,TCIAMT      and rate                                     
         J     NRAT056                                                          
         DROP  RF                                                               
                                                                                
NRAT062  OC    CR_EFDT,CR_EFDT     test any qualifying rate found               
         JNZ   NRAT064                                                          
         CLI   BYTE1,X'FF'         test future rate *only* found                
         JNE   NRAT038             no - just skip this rate                     
         ZAP   CR_RATE,PZERO       add non-qualifying rate recs too             
NRAT064  LHI   RE,CR_RRLQ          rate rec len                                 
         STH   RE,CR_LEN                                                        
         GOTOR GOTSAR,DMCB,('TSAADD',0)                                         
         JE    NRAT038             next rate record                             
         TM    TSARERRS,TSEEOF     Test end of buffer                           
         JNZ   *+6                                                              
         DC    H'0'                Duplicate key                                
         MVC   LP_ERROR,=AL2(AE$MAX#)                                           
         DC    H'0'                *** Testing                                  
         J     EXITN                                                            
                                                                                
NRAT066  CLI   QRASTY,QRAWCQ       If work code level rates we don't            
         JE    *+12                 know work code at this point                
*                                   and therefore need to read adj rate         
         CLI   RATEADJ,YESQ        Test rate adjustment is possible             
         JNE   NRAT100                                                          
*                                  Add rate adjust recs to buff, too:           
         CLI   QRATYP,QRATLST      test 'List' request                          
         JE    NRAT072                                                          
         SR    RF,RF               Else 'Refresh' request                       
         ICM   RF,7,QRA1RAA        A(1R+WC array)                               
         JNZ   *+6                                                              
         DC    H'0'                must be at least one entry...                
         XC    ARYNTRN,ARYNTRN                                                  
         MVC   ARYNENT,LW_NUMN-LW_D(RF)  N'entries                              
         AHI   RF,LW_LN2Q                                                       
         ST    RF,ARYAENT          A(1st Array entry data)                      
         J     NRAT070                                                          
                                                                                
NRAT068  SR    R0,R0                                                            
         ICM   R0,3,ARYNENT                                                     
         AHI   R0,-1                                                            
         JZ    NRAT100             Array finished                               
         STCM  R0,3,ARYNENT                                                     
         ICM   R0,3,ARYNTRN        increment n'array entry                      
         AHI   R0,1                                                             
         STCM  R0,3,ARYNTRN                                                     
         L     RF,ARYAENT                                                       
         AHI   RF,QRA1RAL                                                       
         ST    RF,ARYAENT                                                       
NRAT070  MVC   QRA1RO(QRA1RAL),0(RF) copy array entry data vals                 
                                                                                
         USING PAJRECD,R2                                                       
NRAT072  LA    R2,IOKEY            Read rate adjustment records                 
         XC    PAJKEY,PAJKEY                                                    
         MVI   PAJKTYP,PAJKTYPQ                                                 
         MVC   PAJKCPY,CUXCPY                                                   
         MVC   SAVEKEY2,PAJKEY                                                  
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         JE    NRAT076                                                          
         DC    H'0'                                                             
                                                                                
NRAT074  GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
NRAT076  CLC   PAJKEY(PAJKOFF-PAJKEY),SAVEKEY2                                  
         JE    NRAT078                                                          
*                                  End of adjustment rates:                     
         CLI   QRATYP,QRATRFS      test 'Refresh' request                       
         JE    NRAT068             yes - get next array entry                   
         J     NRAT100             End of rate records                          
                                                                                
NRAT078  LA    R0,3                Test SJ cli/pro/job                          
         LA    R1,DJOBLN                                                        
         LA    R3,DSJACC+L'DSJACC                                               
         LA    R4,PAJKJOB+L'PAJKJOB                                             
         MVI   BYTE1,C'J'          SJ                                           
         GOTOR TSTKEY                                                           
         JNE   NRAT074             read next                                    
                                                                                
         CLC   QRAWCD,SPACES       Test workcode                                
         JNH   NRAT080             not passed - any will do                     
         OC    PAJKTSK,PAJKTSK                                                  
         JZ    NRAT080             not set in key - any will do                 
         CLC   PAJKTSK,QRAWCD                                                   
         JNE   NRAT074                                                          
NRAT080  CLC   QRACLO,SPACES       test client office                           
         JNH   NRAT082             not passed - any will do                     
         OC    PAJKOFF,PAJKOFF                                                  
         JZ    NRAT082             not set in key - any will do                 
         CLC   PAJKOFF,QRACLO                                                   
         JNE   NRAT074                                                          
                                                                                
NRAT082  CLI   QRASTY,QRAWCQ       test only want work code level rates         
         JNE   NRAT086             yes - so ignore this account                 
         CLC   QRACLO,SPACES       Use client office for 1R office              
         JNH   NRAT084                                                          
         CLC   PAJKDOF,SPACES      If no 1R office exist skip                   
         JNH   NRAT084                                                          
         CLC   PAJKDOF,QRACLO      Skip rates where office doesn't              
         JNE   NRAT074                                      match               
NRAT084  CLC   PAJKDEP,SPACES      Ignore any 1R rates with dept                
         JH    NRAT074                              sub dept or staff           
         CLC   PAJKSUB,SPACES                                                   
         JH    NRAT074                                                          
         CLC   PAJKSTF,SPACES                                                   
         JH    NRAT074                                                          
         MVC   WORK,SPACES                                                      
         CLC   PAJKDOF,SPACES                                                   
         JNH   NRAT088                                                          
         MVC   WORK(L'PCHKDOF),PAJKDOF                                          
         J     NRAT088                                                          
                                                                                
NRAT086  LA    R0,4                                                             
         LA    R1,DONERILS         lengths match l'PAJ 1R components            
         LA    R3,PAJKDOF                                                       
         LA    R4,WORK                                                          
         GOTOR SQSH1R              squash PAJ 1R key comps in WORK              
         LA    R0,4                Test 1R account                              
         LA    R1,DONERILS+3                                                    
         LA    R3,D1RACC+L'D1RACC                                               
         LA    R4,WORK+L'ACTKACT                                                
         MVI   BYTE1,C'R'          1R                                           
         GOTOR TSTKEY                                                           
         JE    NRAT088                                                          
         CLI   QRATYP,QRATRFS      test 'Refresh' request                       
         JNE   NRAT074             no - read next rate                          
         CLC   WORK(L'ACTKACT),D1RACC  Else test rate key > array 1R            
         JL    NRAT074             no - get next rate rec                       
         J     NRAT068             yes - get next array entry                   
                                                                                
NRAT088  GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         USING CR_ARD,CR_BUFF                                                   
         XC    CR_BUFF(CR_XLNQ),CR_BUFF                                         
         MVC   CR_NTRN,ARYNTRN     Set array entry num in key                   
         CLI   QRASTY,QRAWCQ                                                    
         JE    *+10                                                             
         MVC   CR_1RAC,WORK                                                     
         MVI   CR_ARIND,CR_ARAJQ   set 'rate adjust' type record                
         CLC   PAJKCLI,SPACES                                                   
         JNH   *+10                                                             
         MVC   CR_SJAC,PAJKCLI     Set SJ acc code (all components)             
         CLI   QRASTY,QRAWCQ       Only save work code for non 1R call          
         JNE   NRAT089                                                          
         MVC   CR_TASK,PAJKTSK     Set work code                                
         OC    PAJKTSK,PAJKTSK                                                  
         JNZ   *+10                                                             
         MVC   CR_TASK,SPACES                                                   
                                                                                
NRAT089  GOTOR GETHIER,1           get adjustment rate hierarchy value          
         JNE   NRAT074             rate key structure not in SRCHTBL            
         MVC   CR_ARRHI,BYTE2      set in buff key                              
                                                                                
         ZAP   CR_RATE,PZERO                                                    
         L     RF,AIO2                                                          
         LA    RF,PAJRFST-PAJRECD(RF)                                           
         USING TCIELD,RF                                                        
NRAT090  CLI   TCIEL,0             Find charge rate elements                    
         JE    NRAT098                                                          
         CLI   TCIEL,TCIELQ                                                     
         JE    NRAT094                                                          
NRAT092  IC    R0,TCILN                                                         
         AR    RF,R0                                                            
         J     NRAT090                                                          
                                                                                
NRAT094  OC    TCIDTE,TCIDTE       test effective date blank                    
         JNZ   *+12                                                             
         MVI   TCIDTE+L'TCIDTE-1,1 set dummy lowest 'date'                      
         J     NRAT096                                                          
         CLC   TCIDTE,DCURDTP                                                   
         JH    NRAT092             not effective till after req date            
         CLC   TCIDTE,DCUTDTP                                                   
         JL    NRAT092             earlier than cutoff date                     
NRAT096  CLC   TCIDTE,CR_EFDT                                                   
         JL    NRAT092             don't want                                   
         MVC   CR_EFDT,TCIDTE      save highest date found                      
         ZAP   CR_RATE,TCIAMT      and rate                                     
         J     NRAT092                                                          
         DROP  RF                                                               
                                                                                
NRAT098  OC    CR_EFDT,CR_EFDT     test any adjustment rate found               
         JZ    NRAT074             no - ignore                                  
         LHI   RE,CR_RRLQ          set rec len                                  
         STH   RE,CR_LEN                                                        
         GOTOR GOTSAR,DMCB,('TSAADD',0)                                         
         JE    NRAT074             next adjustment rate record                  
         TM    TSARERRS,TSEEOF     Test end of buffer                           
         JNZ   *+6                                                              
         DC    H'0'                Duplicate key                                
         MVC   LP_ERROR,=AL2(AE$MAX#)                                           
         DC    H'0'                *** Testing                                  
         J     EXITN                                                            
*                                  End of rate+adjust recs:                     
NRAT100  XC    SBUFRATS,SBUFRATS   Read back from TSAR                          
         XC    CR_BUFF(CR_XLNQ),CR_BUFF                                         
         GOTOR GOTSAR,DMCB,('TSARDH',0)                                         
         J     NRAT104                                                          
                                                                                
                                                                                
NRAT102  XC    CR_BUFF(CR_XLNQ),CR_BUFF                                         
         GOTOR GOTSAR,DMCB,('TSANXT',0)                                         
                                                                                
NRAT104  TM    TSARERRS,TSEEOF                                                  
         JNZ   NRATLST             finished                                     
                                                                                
         CLI   QRASTY,QRAWCQ       test only want work code level rates         
         JNE   NRAT130             No                                           
         MVC   DTSARKY,CR_ARKEY                                                 
         CLI   CR_ARIND,CR_ARAJQ                                                
         JE    NRAT102                                                          
         CLC   DLASTWC,CR_TASK     Was there a better match previously          
         JE    NRAT102             Yes - get next record                        
         MVC   DLASTWC,CR_TASK     Save new work code                           
         CLC   CR_TASK,SPACES      For rate without work code capture           
         JH    NRAT106             the lowest ranking                           
         MVC   DLASTHIR,CR_ARRHI                                                
         J     NRAT108             Put record out                               
                                                                                
NRAT106  OC    DLASTHIR,DLASTHIR   Have we found a non work code rate           
         JZ    NRAT108             No                                           
         CLC   CR_ARRHI,DLASTHIR   Yes - check our work isn't a higher          
         JNH   NRAT108                                    level                 
         J     NRAT102             otherwise ignore it                          
                                                                                
NRAT108  ZAP   RA_HRAT,CR_RATE     rate and effective date                      
         ZAP   RA_HRFC,PZERO                                                    
         CLC   CR_EFDT,=X'000001'  test dummy effective date                    
         JE    *+10                  yes - skip on output                       
         MVC   RA_EFDT,CR_EFDT                                                  
         MVC   RA_SJAC,CR_SJAC                                                  
         MVC   RA_TASK,CR_TASK                                                  
         MVI   RA_RACL,X'F0'       make char so 0 output not ignored            
         MVC   RA_SRNK,CR_ARRHI    SRCHTBL rank for debugging/testing           
                                                                                
NRAT110  CLI   RATEADJ,YESQ        Test already set from job level              
         JE    NRAT114                                                          
         CLC   DLASTWC,SPACES      Does the work code exist                     
         JE    NRAT128                                                          
         USING WCORECD,R2                                                       
         LA    R2,IOKEY            Else check workcode record                   
         MVC   WCOKEY,SPACES                                                    
         MVI   WCOKTYP,WCOKTYPQ                                                 
         MVC   WCOKCPY,CUXCPY                                                   
         MVC   WCOKUNT(2),PRODUL                                                
         MVC   WCOKWRK,DLASTWC                                                  
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R2,AIO2                                                          
         USING WCOELD,RF                                                        
         LA    RF,WCORFST                                                       
         SR    R0,R0                                                            
NRAT112  CLI   WCOEL,0                                                          
         JNE   *+6                                                              
         DC    H'0'                                                             
         CLI   WCOEL,WCOELQ                                                     
         JE    *+14                                                             
         IC    R0,WCOLN                                                         
         AR    RF,R0                                                            
         J     NRAT112                                                          
         TM    WCOSTAT2,WCOSART     Adjustment rates                            
         JZ    NRAT128              No - put out plain rate                     
         DROP  R2,RF                                                            
*                                                                               
NRAT114  ZAP   DADJR,PZERO                                                      
         MVC   DADJL,FFS                                                        
         XC    CR_BUFF(CR_XLNQ),CR_BUFF                                         
         MVI   CR_ARIND,CR_ARAJQ                                                
         MVC   CR_TASK,SPACES                                                   
         GOTOR GOTSAR,DMCB,('TSARDH',0)                                         
         TM    TSARERRS,TSEEOF     End of buffer                                
         JNZ   NRAT126             Yes - can't be any adj records               
         CLI   CR_ARIND,CR_ARAJQ   Is it an adjustment record                   
         JNE   NRAT126             No - can't be any records                    
         CLC   CR_TASK,SPACES      Is an adjustment without work code           
         JNE   NRAT116             No - check for one with our wc               
         ZAP   DADJR,CR_RATE       Capture first rate returned                  
         MVC   DADJL,CR_ARRHI      Capture the level                            
                                                                                
NRAT116  XC    CR_BUFF(CR_XLNQ),CR_BUFF                                         
         MVI   CR_ARIND,CR_ARAJQ                                                
         MVC   CR_TASK,DLASTWC                                                  
         GOTOR GOTSAR,DMCB,('TSARDH',0)                                         
         TM    TSARERRS,TSEEOF     End of buffer                                
         JNZ   NRAT118                                                          
         CLI   CR_ARIND,CR_ARAJQ   Is it the record type we want                
         JNE   NRAT118                                                          
         CLC   CR_TASK,DLASTWC     Does work code match                         
         JE    NRAT120                                                          
                                                                                
NRAT118  CLC   DADJL,FFS           Did we find an adjust rate at non wc         
         JNE   NRAT124                                          level           
         J     NRAT126                                                          
                                                                                
NRAT120  CLC   DADJL,FFS           Did we find an adjust rate at non wc         
         JNE   NRAT122                                          level           
         ZAP   DADJR,CR_RATE       Capture adjustment rate                      
         J     NRAT124                                                          
                                                                                
NRAT122  CLC   CR_ARRHI,DADJL      Is work code level lower                     
         JH    NRAT124             No                                           
         ZAP   DADJR,CR_RATE       Yes - use this                               
                                                                                
NRAT124  ZAP   PL13,DADJR          Use adjusted rate                            
         JZ    NRAT126             safety - use unadjusted rate                 
         MP    PL13,RA_HRAT        Apply adjustment to rate                     
         SRP   PL13,64-6,5                                                      
         AP    RA_HRAT,PL13                                                     
                                                                                
NRAT126  XC    CR_BUFF(CR_XLNQ),CR_BUFF                                         
         MVC   CR_BUFF(CR_AKLNQ),DTSARKY                                        
         GOTOR GOTSAR,DMCB,('TSARDH',0)                                         
                                                                                
NRAT128  J     EXITY                                                            
                                                                                
NRAT130  GOTOR GETLVAC,CR_1RAC     get buffrec's 1R account lvl                 
         STC   R1,BYTE1                                                         
         CLI   CR_ARIND,CR_ARACQ   test Name buffrec type                       
         JE    NRAT132                                                          
*                                  else Rate or Adjust Rate:                    
         LR    RE,R1               R1 = 1R lvl 0-4                              
         MHI   RE,CR_RRLQ                                                       
         LA    RF,SBUFRATS(RE)     displace to saved rate slot for lvl          
         CLI   CR_ARIND,CR_ARRAQ   test Rate buffrec type                       
         JE    *+8                                                              
         LA    RF,SBUFADJS(RE)     disp to saved Adjust Rate slot f lvl         
S        USING CR_ARD,RF                                                        
         CLC   S.CR_NTRN(CR_N1RLQ),CR_NTRN                                      
*                                  ignore all but first of each account         
         JE    NRAT102             as 'best match' rate is sorted first         
         MVC   S.CR_ARD(CR_RRLQ),CR_ARD   save buffrec for compare              
         J     NRAT102                                                          
*                            Name buffrec: clc with saved rate buffrecs         
NRAT132  XC    RA_VALS(RA_LNQ),RA_VALS  clear output values                     
         SR    R1,R1                                                            
         IC    R1,BYTE1                                                         
         LTR   R0,R1               R1 = 1R lvl 0-4                              
         JZ    NRAT138             0 = ledger level                             
                                                                                
NRAT134  LR    RE,R0                                                            
         LA    R1,ONERL1L-1(RE)    displace to levlen                           
         MHI   RE,CR_RRLQ                                                       
         LA    RF,SBUFRATS(RE)     disp to saved rate buffrec                   
         IC    RE,0(R1)                                                         
         AHI   RE,L'CR_NTRN        add l'array entry num                        
         AHI   RE,-1               ex l'compare                                 
         BASR  R1,0                                                             
         CLC   S.CR_NTRN(0),CR_NTRN  test buff acc matches saved lvl            
         EX    RE,0(R1)                                                         
         JNE   NRAT136             no match at this level                       
         OC    S.CR_EFDT,S.CR_EFDT  else matches, test valid rate               
         JZ    NRAT140              no, so *don't* check higher levels          
         J     NRAT142                                                          
NRAT136  CLI   QRASTY,QRA1RQ       test only want 1R a/cs with own rate         
         JE    NRAT102             yes - so ignore this account                 
         JCT   R0,NRAT134          try next higher level                        
                                                                                
NRAT138  LA    RF,SBUFRATS         last resort: ledger level buffrec            
         OC    S.CR_1RAC,S.CR_1RAC test rate rec exists                         
         JNZ   NRAT142             yes, therefore it matches                    
                                                                                
NRAT140  MVI   RA_RACL,C'9'        return 9 ='No rate found'                    
         J     NRAT150                                                          
                                                                                
NRAT142  ZAP   RA_HRAT,S.CR_RATE   rate and effective date                      
         ZAP   RA_HRFC,PZERO                                                    
         CLC   S.CR_EFDT,=X'000001'  test dummy effective date                  
         JE    *+10                  yes - skip on output                       
         MVC   RA_EFDT,S.CR_EFDT                                                
         MVC   RA_SJAC,S.CR_SJAC                                                
         MVC   RA_TASK,S.CR_TASK                                                
         STC   R0,RA_RACL                                                       
         OI    RA_RACL,X'F0'       make char so 0 output not ignored            
         MVC   RA_SRNK,S.CR_ARRHI  SRCHTBL rank for debugging/testing           
                                                                                
         SR    R1,R1               now look for any adjustment to rate          
         IC    R1,BYTE1                                                         
         LTR   R0,R1               R1 = 1R lvl 0-4                              
         JZ    NRAT146             0 = ledger level                             
                                                                                
NRAT144  LR    RE,R0                                                            
         LA    R1,ONERL1L-1(RE)    displace to levlen                           
         MHI   RE,CR_RRLQ                                                       
         LA    RF,SBUFADJS(RE)     disp to saved adjust buffrec                 
         IC    RE,0(R1)                                                         
         AHI   RE,L'CR_NTRN        add l'array entry num                        
         AHI   RE,-1               ex l'compare                                 
         BASR  R1,0                                                             
         CLC   S.CR_NTRN(0),CR_NTRN  test buff acc matches saved lvl            
         EX    RE,0(R1)                                                         
         JE    NRAT148                                                          
         JCT   R0,NRAT144                                                       
                                                                                
NRAT146  LA    RF,SBUFADJS         last resort: ledger level buffrec            
         OC    S.CR_1RAC,S.CR_1RAC test rate rec exists                         
         JZ    NRAT150             no - use unadjusted rate                     
NRAT148  ZAP   PL13,S.CR_RATE                                                   
         JZ    NRAT150             safety - use unadjusted rate                 
         MP    PL13,RA_HRAT        Apply adjustment to rate                     
         SRP   PL13,64-6,5                                                      
         AP    RA_HRAT,PL13                                                     
                                                                                
NRAT150  MVC   RA_1RAC,CR_1RAC                                                  
         MVC   PREVUNT(L'ACTKUNT+L'ACTKLDG),=C'1R'                              
         MVC   PREVACT,CR_1RAC                                                  
         CLI   QRASTY,QRAWCQ       test only want work code level rates         
         JE    *+10                Skip 1R name as there is none                
         MVC   RA_1RNM,CR_1RNM                                                  
         J     EXITY                                                            
         DROP  S                                                                
*&&                                                                             
NRATERR  LH    R0,FULL2                                                         
         J     XERRORY                                                          
                                                                                
NRATLST  MVI   LP_RMODE,LP_RLAST                                                
         J     EXITY                                                            
                                                                                
NXTRATY  J     EXITY                                                            
                                                                                
***********************************************************************         
* READ ONE LEVEL BACK FROM WHATEVER'S IN PREVACT                      *         
***********************************************************************         
*                                                                               
NXTPACT  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         ST    R8,LP_ADATA                                                      
         MVC   PREVAC2,SPACES                                                   
         LA    R2,PREVACT+L'PREVACT-1                                           
         LA    R6,ONERL4L                                                       
         LA    R3,4                                                             
*                                                                               
NPACT010 CLI   0(R6),0                                                          
         JE    NPACT015                                                         
         CLI   0(R6),L'ACTKACT                                                  
         JNE   NPACT020                                                         
*                                                                               
NPACT015 SHI   R6,1                                                             
         JCT   R3,NPACT010                                                      
         MVI   LP_RMODE,LP_RLAST   NO MORE                                      
         J     EXITN                                                            
*                                                                               
NPACT020 LLC   RF,0(R6)                                                         
         LA    RE,PREVACT(RF)                                                   
         CLI   0(RE),C' '                                                       
         JNH   NPACT015            ALREADY ABOVE THIS LEVEL                     
*                                                                               
         SHI   RF,1                                                             
         MVC   PREVAC2(0),PREVACT                                               
         EX    RF,*-6                                                           
         XC    PREVAC2,PREVACT                                                  
         XC    PREVACT,PREVAC2                                                  
         XC    PREVAC2,PREVACT                                                  
         J     EXITY                                                            
*                                                                               
         EJECT                                                                  
*&&US                                                                           
***********************************************************************         
* Read Studio records                                                 *         
***********************************************************************         
REQSTUL  LKREQ H,A#STUL,OUTSTUL,NEXTREQ=REQUESTX                                
Dummy    LKREQ F,01,(D,B#SAVED,QSTUDUM),CHAR,OLEN=L'QSTUDUM,           +        
               MAXLEN=L'QSTUDUM,TEXT=AC#NOORD,COL=*                             
         LKREQ E                                                                
                                                                                
OUTSTUL  LKOUT H                                                                
                                                                                
STULST   LKOUT R,R#STUL                                                         
Array    LKOUT C,R#STUL,(A,ARYSTCD)                                             
                                                                                
         LKOUT E                                                                
                                                                                
         LKOUT X                                                                
                                                                                
ARYSTCD  LKOUT A,(R,NXTSTU),MULTIROW=Y,ROWNAME=STURECD                          
Code     LKOUT C,1,(D,B#SAVED,SSTUCODE),CHAR,ND=Y                               
Array    LKOUT C,2,(A,ARYSTUN)                                                  
Array    LKOUT C,3,(A,ARYSTUM)                                                  
                                                                                
         LKOUT E                                                                
                                                                                
ARYSTUN  LKOUT A,(D,B#STUREC,STURFST),NROWS=1,                         +        
               ROWID=(NAMEL,NAMELQ),ROWWIDTH=(V,NAMLN)                          
                                                                                
Name     LKOUT C,2,NAMEREC,CHAR,LEN=V,ND=Y                                      
                                                                                
         LKOUT E                                                                
                                                                                
ARYSTUM  LKOUT A,(D,B#STUREC,STURFST),EOT=EOR,                         +        
               ROWID=(STUEL,STUELQ),ROWWIDTH=(V,STULN)                          
Media    LKOUT C,3,STUMED,CHAR,ND=Y                                             
Vendor   LKOUT C,4,STUVEND+1,CHAR,LEN=L'STUVEND-1,ND=Y                          
Array    LKOUT C,5,(A,ARYOFCL)                                                  
                                                                                
         LKOUT E                                                                
                                                                                
ARYOFCL  LKOUT A,(*,STUOCLN),ROWNAME=STUEL,NROWS=*,ROWWIDTH=L'STUOCLN, +        
               NEWEL=B                                                          
Office   LKOUT C,1,STUOFF,CHAR                                                  
Client   LKOUT C,2,STUCLN,CHAR                                                  
                                                                                
         LKOUT E                                                                
                                                                                
***********************************************************************         
* Read Studio record                                                  *         
***********************************************************************         
                                                                                
NXTSTU   MVC   SSTUCODE,SPACES                                                  
         GOTOR (#NXTREC,ANXTREC),DMCB,STUKEYT,('B#STUREC',0),          +        
               (0,SAVED),0,0                                                    
         JNE   EXITY                                                            
         L     R3,AIO2                                                          
         USING STURECD,R3                                                       
         MVC   SSTUCODE,STUKCODE                                                
         J     EXITY                                                            
                                                                                
                                                                                
***********************************************************************         
* Some FILTROUT routines                                                        
***********************************************************************         
TSTTSTUQ CLI   WORK,STUKSUBQ       Test if Studio sub-element                   
         BR    RE                                                               
                                                                                
*&&                                                                             
***********************************************************************         
* End of requests                                                     *         
***********************************************************************         
REQUESTX LKREQ X                                                                
         LKARY T                                                                
         EJECT                                                                  
***********************************************************************         
* Local routines                                                      *         
***********************************************************************         
                                                                                
* Get agency's WebDAV definition from Control/ESS XTLOGIN record                
WEBDAV   NTR1  BASE=*,LABEL=*                                                   
         J     *+12                                                             
         DC    C'*WEBDAV*'                                                      
                                                                                
         MVC   OINWDLO,SPACES                                                   
         MVC   OINWDUS,SPACES                                                   
         MVC   OINWDPA,SPACES                                                   
                                                                                
         USING GXLID,R3                                                         
         LA    R3,IOKEY                                                         
         XC    GXLIKEY,GXLIKEY                                                  
         MVI   GXLIKMAJ,0                                                       
         MVI   GXLIKMIN,0                                                       
         MVI   GXLIKREC,GXLIRECQ                                                
         MVC   GXLIKAGY,CUAALF     ELSE NATIVE AGENCY                           
         MVI   GXLIKSYS,0                                                       
         MVC   GXLIKID,=CL8'INVAPP'                                             
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IOGND+IO1'                               
         JNE   WEBDAVX                                                          
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOGNF+IO1'                              
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         USING GXLIEL,R3                                                        
         L     R3,AIO1             ENCODE uses R1,R2                            
         AHI   R3,GXFIRST                                                       
         XR    R0,R0                                                            
                                                                                
WEBDAV1  CLI   GXLIEL,0                                                         
         JE    WEBDAVX                                                          
         CLI   GXLIEL,GXLIELQ                                                   
         JE    WEBDAV3                                                          
                                                                                
WEBDAV2  IC    R0,GXLIELL                                                       
         AR    R3,R0                                                            
         J     WEBDAV1                                                          
                                                                                
WEBDAV3  XR    RE,RE                                                            
         IC    RE,GXLIELL                                                       
         SHI   RE,GXLIELLQ+1                                                    
         LTR   RE,RE                                                            
         JM    WEBDAV2                                                          
         CLI   GXLIFLD,GXLIFURQ    URL                                          
         JNE   WEBDAV4                                                          
         CHI   RE,L'OINWDLO-1                                                   
         JNH   *+8                                                              
         LA    RE,L'OINWDLO-1                                                   
         MVC   OINWDLO,SPACES                                                   
         MVC   OINWDLO(0),GXLIDAT                                               
         EX    RE,*-6                                                           
         J     WEBDAV2                                                          
                                                                                
WEBDAV4  CLI   GXLIFLD,GXLIFLOQ    LOCATION                                     
         JNE   WEBDAV5                                                          
         J     WEBDAV2                                                          
                                                                                
WEBDAV5  CLI   GXLIFLD,GXLIFUIQ    USER ID                                      
         JNE   WEBDAV6                                                          
         MVC   X#IDATA,SPACES                                                   
         MVC   X#IDATA(0),GXLIDAT                                               
         EX    RE,*-6                                                           
         GOTOR ENCODE,1                                                         
         MVC   OINWDUS,X#ODATA                                                  
         J     WEBDAV2                                                          
                                                                                
WEBDAV6  CLI   GXLIFLD,GXLIFPWQ    PASSWORD                                     
         JNE   WEBDAV2                                                          
         MVC   X#IDATA,SPACES                                                   
         MVC   X#IDATA(0),GXLIDAT                                               
         EX    RE,*-6                                                           
         GOTOR ENCODE,1                                                         
         MVC   OINWDPA,X#ODATA                                                  
         J     WEBDAV2                                                          
                                                                                
WEBDAVX  J     EXITY                                                            
         DROP  R3                                                               
                                                                                
ENCODE   NTR1  BASE=*,LABEL=*                                                   
         J     *+12                                                             
         DC    C'*ENCODE*'                                                      
                                                                                
         AHI   R1,-1               CALLER CHOOSES OFFSETS TO USE                
         MHI   R1,ENCLNQ                                                        
         LA    R1,TROFFS1(R1)                                                   
         MVC   X#TDATA,0(R1)                                                    
                                                                                
         MVC   X#ODATA,SPACES                                                   
         LA    RF,X#IDATA                                                       
         LA    R0,L'X#IDATA                                                     
         XR    R1,R1                                                            
                                                                                
ENCOD02  LA    R2,TRLIST                                                        
                                                                                
ENCOD04  CLI   0(R2),0                                                          
         JNE   *+6                                                              
         DC    H'0'                INPUT CHAR NOT IN TRANSLATE LIST             
         CLC   0(1,R2),0(RF)                                                    
         JE    ENCOD06             MATCHED                                      
         AHI   R2,1                ELSE TRY NEXT                                
         J     ENCOD04                                                          
                                                                                
ENCOD06  IC    R1,(L'X#IDATA*2)(RF)                                             
         AR    R2,R1               APPLY OFFSET                                 
         MVC   L'X#IDATA(1,RF),0(R2)  OUTPUT CHAR                               
         AHI   RF,1                BUMP TO NEXT INPUT CHAR                      
         CLI   0(RF),C' '                                                       
         JNH   *+8                 ASSUME SPACE = END OF INPUT DATA             
         BCT   R0,ENCOD02                                                       
                                                                                
         J     EXITY                                                            
                                                                                
ENCLNQ   EQU   10                                                               
                                                                                
TROFFS1  DC    AL1(7,1,3,0,4,8,5,9,2,6) RANDOM VALUES - 1 PER INP CHAR          
TROFFS2  DC    AL1(2,7,4,6,9,5,1,8,0,3) RANDOM VALUES - 1 PER INP CHAR          
                                                                                
TRLIST   DC    C'0ABC1DEF2GHI3JKL4MNO5PQR6STU7VWX8YZ90ABC1DEF2',X'00'           
                                                                                
* Get current's system URL (hard coded)                                         
GETURL   NTR1  BASE=*,LABEL=*                                                   
         J     *+12                                                             
         DC    C'*GETURL*'                                                      
         LR    R2,R1                                                            
*                                                                               
         LR    R0,R2                                                            
         LHI   R1,L'OINCURL        Clear out url                                
         SR    RE,RE                                                            
         LA    RF,C' '                                                          
         SLL   RF,24                                                            
         MVCL  R0,RE                                                            
*                                                                               
         LA    R3,AGYURL           PULL URL FROM TABLE                          
         USING AGYURLD,R3                                                       
GETURL02 CLI   AGUSE,0             LIVE OR TEST                                 
         JE    GETURL04            LIVE                                         
         CLC   AGUSE,LP_SENO       TEST - CHECK SE NUMBER                       
         JE    GETURL08                                                         
         J     GETURL06                                                         
                                                                                
GETURL04 CLI   AGUAA,0             END OF TABLE, USE DEFAULT                    
         JE    GETURL08                                                         
         CLC   AGUAA,CUAALF        MATCH ON AGENCY ALPHA                        
         JE    GETURL08                                                         
                                                                                
GETURL06 AHI   R3,AGYURLQ          NO MATCH, NEXT ENTRY                         
         J     GETURL02                                                         
                                                                                
GETURL08 DS    0H                                                               
                                                                                
         LA    RF,AGUHTT                                                        
         LHI   RE,L'AGUHTT-1                                                    
         CLI   AGUFED,YESQ         Is this a system with a url prefix?          
         JNE   GETURL10                                                         
         TM    CPXSTATA,CPXFEDAT   Is federated auth in use?                    
         JZ    GETURL10                                                         
         LA    RF,HTTP             Always http for federated urls               
         LHI   RE,L'HTTP-1                                                      
*                                                                               
GETURL10 BASR  R1,0                                                             
         MVC   0(0,R2),0(RF)                                                    
         EX    RE,0(R1)                                                         
         AHI   R2,L'AGUHTT                                                      
         CLI   0(R2),C' '                                                       
         JH    *+8                                                              
         JCT   R2,*-8                                                           
         AHI   R2,1                                                             
         TM    CPXSTATA,CPXFEDAT   Is federated auth in use?                    
         JNZ   GETURL12                                                         
         CLC   AGUENV,SPACES       Any environment?                             
         JNH   GETURL12                                                         
         MVC   0(L'AGUENV,R2),AGUENV                                            
         AHI   R2,L'AGUENV                                                      
         CLI   0(R2),C' '                                                       
         JH    *+8                                                              
         JCT   R2,*-8                                                           
         AHI   R2,1                                                             
*                                                                               
GETURL12 CLI   AGUFED,YESQ         Is this a system with a url prefix?          
         JNE   GETURL14                                                         
         TM    CPXSTATA,CPXFEDAT                                                
         JZ    GETURL14            Is federated auth in use?                    
         MVC   0(L'AGUFEDP,R2),AGUFEDP                                          
         AHI   R2,L'AGUFEDP                                                     
         CLI   0(R2),C' '                                                       
         JH    *+8                                                              
         JCT   R2,*-8                                                           
         AHI   R2,1                                                             
         MVC   0(L'FEDURL,R2),FEDURL                                            
         AHI   R2,L'FEDURL                                                      
         CLI   0(R2),C' '                                                       
         JH    *+8                                                              
         JCT   R2,*-8                                                           
         AHI   R2,1                                                             
         MVC   0(L'AGUFEDS,R2),AGUFEDS                                          
         AHI   R2,L'AGUFEDS                                                     
         CLI   0(R2),C' '                                                       
         JH    *+8                                                              
         JCT   R2,*-8                                                           
         AHI   R2,1                                                             
GETURL14 MVC   0(L'AGUURL2,R2),AGUURL2  Aura                                    
         J     EXITY                                                            
         DROP  R3                                                               
                                                                                
* Get agency name                                                               
         USING CPYRECD,IOKEY                                                    
GETAGN   NTR1  BASE=*,LABEL=*                                                   
         J     *+12                                                             
         DC    C'*GETAGN*'                                                      
         LR    R2,R1                                                            
         MVC   0(L'OGINAME,R2),SPACES                                           
         MVC   IOKEY,SPACES                                                     
         MVC   CPYKCPY,CUXCPY                                                   
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JE    *+6                                                              
         DC    H'0'                COMPANY NOT VALID                            
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R3,AIO2                                                          
         LA    R3,CPYRFST-CPYRECD(R3)                                           
*                                                                               
         USING NAMELD,R3                                                        
GETAGN02 CLI   NAMEL,0                                                          
         JNE   *+6                                                              
         DC    H'0'                MUST HAVE NAMELD                             
         CLI   NAMEL,NAMELQ                                                     
         JE    GETAGN04                                                         
         LLC   R0,NAMLN                                                         
         AR    R3,R0                                                            
         J     GETAGN02                                                         
*                                                                               
GETAGN04 LLC   RF,NAMLN                                                         
         SHI   RF,NAMLN1Q+1                                                     
         BASR  R1,0                                                             
         MVC   0(0,R2),NAMEREC                                                  
         EX    RF,0(R1)                                                         
         J     EXITY                                                            
         EJECT                                                                  
* Get connected user's details                                                  
GETCON   NTR1  BASE=*,LABEL=*                                                   
         J     *+12                                                             
         DC    C'*GETCON*'                                                      
                                                                                
         OC    CCTPID,CCTPID       check connected PID code                     
         BNZ   GETCON05                                                         
                                                                                
         MVC   LP_ERROR,=AL2(AE$NCPID)                                          
         J     EXITN                                                            
                                                                                
         USING APPRECD,R2                                                       
GETCON05 LA    R2,IOKEY                                                         
         XC    APPKEY,APPKEY                                                    
         MVI   APPKTYP,APPKTYPQ                                                 
         MVI   APPKSUB,APPKSUBQ                                                 
         MVC   APPKCPY,CUXCPY                                                   
         MVC   APPKPIDB,CCTPID                                                  
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO4'                               
         BE    GETCON15                                                         
                                                                                
GETCON10 MVC   LP_ERROR,=AL2(AE$INAPP)                                          
         J     EXITN                                                            
                                                                                
GETCON15 J     EXITY                                                            
         DROP  R2                                                               
                                                                                
* Get TVR band details for initial call                                         
GETBND   NTR1  BASE=*,LABEL=*                                                   
         J     *+12                                                             
         DC    C'*GETBND*'                                                      
                                                                                
AGREEM1Q EQU   1                                                                
                                                                                
         USING GFEED,R2                                                         
         LA    R2,IOKEY                                                         
         XC    GFKEY,GFKEY                                                      
         MVI   GFKMIN,GFKMINQ                                                   
         MVI   GFKREC,GFKTVRQ                                                   
         MVI   GFKCSEQ,AGREEM1Q                                                 
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IOGND+IO1'                               
         BNE   GETBNDX                                                          
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOGNF+IO1'                              
         BNE   GETBNDX                                                          
                                                                                
         MVI   EI_TAGN,AGREEM1Q                                                 
         OI    EI_TAGN,X'F0'                                                    
                                                                                
         USING GRECD,R2                                                         
         L     R2,AIO1                                                          
         LA    R3,GFIRST(R2)                                                    
         USING GFAGRD,R3                                                        
         XR    R4,R4                                                            
                                                                                
GETBND1  CLI   GFAGREL,0                                                        
         BE    GETBNDX                                                          
         CLI   GFAGREL,GFAGRELQ                                                 
         BE    GETBND3                                                          
         CLI   GFAGREL,GFBNDELQ                                                 
         BE    GETBND4                                                          
                                                                                
GETBND2  XR    R1,R1                                                            
         IC    R1,GFAGRELL                                                      
         AR    R3,R1                                                            
         B     GETBND1                                                          
                                                                                
GETBND3  GOTO1 VDATCON,DMCB,(3,GFAGRTOD),(1,EI_TAED)                            
         B     GETBND2                                                          
                                                                                
         USING GFBNDD,R3                                                        
GETBND4  CHI   R4,4                only 4 entries supported                     
         BNL   GETBND2                                                          
         LR    RE,R4                                                            
         MHI   RE,EI_TNV2-EI_TNV1                                               
         LA    RE,EI_TNV1(RE)                                                   
         USING EI_TNV1,RE                                                       
         CLC   GFBNDHIT,FFS                                                     
         BE    GETBND5                                                          
         XR    RF,RF                                                            
         ICM   RF,7,GFBNDHIT                                                    
         CVD   RF,DUB1                                                          
         ZAP   EI_TNV1,DUB1                                                     
                                                                                
GETBND5  XR    RF,RF                                                            
         ICM   RF,7,GFBNDPCT                                                    
         CVD   RF,DUB1                                                          
         ZAP   EI_TPC1,DUB1                                                     
                                                                                
         AHI   R4,1                                                             
         B     GETBND2                                                          
         DROP  RE                                                               
                                                                                
GETBNDX  XIT1                                                                   
         DROP  R2,R3                                                            
                                                                                
* Get Opt/Maint default scheme code, report format, estimate type               
GETOMD   NTR1  BASE=*,LABEL=*                                                   
         J     *+12                                                             
         DC    C'*GETOMD*'                                                      
                                                                                
         MVC   DOMDEF,SPACES       preset default scheme                        
         MVI   DOMETY,C' '         and estimate type                            
                                                                                
         MVC   TEMP2(15),SPACES    build SJ account code                        
         MVC   TEMP2(1),CUXCPY                                                  
         MVC   TEMP2+1(2),PRODUL                                                
*&&UK*&& MVC   TEMP2+3(5),QSCCLI                                                
*&&US*&& MVC   TEMP2+3(L'QSCCLI),QSCCLI                                         
         XR    R1,R1                                                            
         IC    R1,PCLILEN                                                       
         LR    RF,R1                                                            
         LA    R1,TEMP2+3(R1)                                                   
*&&UK                                                                           
         MVC   0(2,R1),QSCPRO                                                   
         CLC   QSCJOB+1(L'QSCJOB-1),SPACES      Do we have a job?               
         BNH   GETOMD1                                                          
         LA    RE,L'ACTKACT                                                     
         AHI   RF,2                Allow for product                            
         SR    RE,RF                                                            
         SHI   RE,1                                                             
         MVC   2(0,R1),QSCJOB      Move in job code                             
         EX    RE,*-6                                                           
*&&                                                                             
*&&US                                                                           
         MVC   0(L'QSCPRO,R1),QSCPRO                                            
         CLC   QSCJOB+1(L'QSCJOB-1),SPACES      Do we have a job?               
         BNH   GETOMD1                                                          
         XR    R1,R1                                                            
         IC    R1,PPROLEN                                                       
         LA    R1,TEMP2+3(R1)                                                   
         MVC   0(L'QSCJOB,R1),QSCJOB                                            
*&&                                                                             
         USING ACTRECD,R2                                                       
GETOMD1  LA    R2,IOKEY                                                         
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCULA,TEMP2                                                   
         OC    ACTKULA,SPACES                                                   
         DROP  R2                                                               
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         BNE   GETOMDN             if account doesn't exist error               
                                                                                
         USING GOBLOCKD,R2                                                      
***      L     RE,AGOBLOCK         call GETOPT for scheme code                  
         L     RE,AGOBLOCB         call GETOPT for scheme code                  
         LA    RF,GOBLOCKX-GOBLOCK                                              
         XCEF                                                                   
***      L     R2,AGOBLOCK                                                      
         L     R2,AGOBLOCB                                                      
         MVC   GOADM,VDATAMGR                                                   
         MVC   GOSELCUL,TEMP2                                                   
         MVC   GOSELCLI,SPACES                                                  
*&&UK*&& MVC   GOSELCLI(5),QSCCLI                                               
*&&US*&& MVC   GOSELCLI(L'QSCCLI),QSCCLI                                        
         MVC   GOSELPRO,SPACES                                                  
*&&UK*&& MVC   GOSELPRO(2),QSCPRO                                               
*&&US*&& MVC   GOSELPRO(L'QSCPRO),QSCPRO                                        
         MVC   GOSELMED,QSCJOB                                                  
*&&UK*&& MVC   GOSELJOB,SPACES                                                  
*&&US*&& XC    GOSELJOB,GOSELJOB                                                
         CLC   QSCJOB+1(L'QSCJOB-1),SPACES                                      
         BNH   *+10                                                             
         MVC   GOSELJOB,QSCJOB                                                  
         MVC   GOSELMED,QSCJOB                                                  
         MVI   GOWHICH,0                                                        
         MVC   GOABEXT,AJOBLOCK    UK USES 2ND EXTENSION BLOCK                  
                                                                                
         GOTO1 VGETOPT,DMCB,GOBLOCKD                                            
                                                                                
         MVC   DOMDEF,GOSCHEME                                                  
         MVC   DOMETY,GOESTTYP                                                  
                                                                                
         USING ACTRECD,R2                                                       
         LA    R2,IOKEY                                                         
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCULA,TEMP2                                                   
         OC    ACTKULA,SPACES                                                   
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         BNE   GETOMDY                                                          
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         BNE   GETOMDY                                                          
                                                                                
         L     R2,AIO2                                                          
         AHI   R2,ACTRFST-ACTRECD                                               
         USING JOBELD,R2                                                        
         XR    R0,R0                                                            
                                                                                
GETOMD2  CLI   JOBEL,0                                                          
         BE    GETOMDY                                                          
         CLI   JOBEL,JOBELQ                                                     
         BE    GETOMD4                                                          
         IC    R0,JOBLN                                                         
         AR    R2,R0                                                            
         B     GETOMD2                                                          
                                                                                
GETOMD4  MVI   DOMETY,C'N'                                                      
         CLI   JOBLN,JOBLN3Q                                                    
         BL    GETOMDY                                                          
         TM    JOBSTA1,JOBSMCSE                                                 
         BZ    GETOMDY                                                          
         MVI   DOMETY,C'M'                                                      
                                                                                
GETOMDY  CR    RB,RB                                                            
         B     *+6                                                              
GETOMDN  LTR   RB,RB                                                            
         XIT1                                                                   
         DROP  R2                                                               
                                                                                
*&&UK                                                                           
* Look for BACS email address on Office/Olist/Company records                   
                                                                                
GETBACE  NTR1  LABEL=*                                                          
         J     *+12                                                             
         DC    C'*GETBACE'                                                      
                                                                                
         CLI   CUACCS,0                                                         
         JE    GETBAC08            No limit access: straight to cpyrec          
                                                                                
O        USING OFFRECD,IOKEY                                                    
         MVC   O.OFFKEY,SPACES                                                  
         MVI   O.OFFKTYP,OFFKTYPQ                                               
         MVC   O.OFFKCPY,CUXCPY                                                 
         MVC   O.OFFKOFF,CUACCS+2  Assume 2CO list or single office             
         TM    CPYSTAT4,CPYSOFF2                                                
         JNZ   GETBAC02                                                         
                                                                                
         MVC   O.OFFKOFF,SPACES                                                 
         CLI   CUACCS,C'*'         Test 1CO single off                          
         JNE   *+14                                                             
         MVC   O.OFFKOFF(1),CUACCS+1                                            
         J     GETBAC02                                                         
         CLI   CUACCS,C'$'         Or 1CO list                                  
         JNE   GETBAC08            Unrecognised - go to cpyrec                  
         MVC   O.OFFKOFF,CUACCS                                                 
                                                                                
GETBAC02 GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JNE   GETBAC08                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JNE   *+2                                                              
         BRAS  RE,GETBAC10                                                      
         JE    EXITY               Found - finished                             
         DROP  O                                                                
                                                                                
C        USING CPYRECD,IOKEY                                                    
GETBAC08 MVC   C.CPYKEY,SPACES     Default: look up email on cpyrec             
         MVC   C.CPYKCPY,CUXCPY                                                 
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JNE   *+2                                                              
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JNE   *+2                                                              
         BRAS  RE,GETBAC10                                                      
         J     EXITY                                                            
         DROP  C                                                                
                                                                                
GETBAC10 L     R3,AIO2                                                          
         LA    R3,ACTRFST-ACTRECD(R3)                                           
         USING FFTELD,R3                                                        
GETBAC12 CLI   FFTEL,0                                                          
         JE    GETBACEN                                                         
         CLI   FFTEL,FFTELQ        Look for email FFTEL                         
         JNE   *+12                                                             
*&&UK*&& CLI   FFTTYPE,FFTTPEML                                                 
*&&US*&& CLI   FFTTYPE,FFTTEML                                                  
         JE    GETBAC14                                                         
         LLC   R0,FFTLN                                                         
         AR    R3,R0                                                            
         J     GETBAC12                                                         
*                                                                               
GETBAC14 LLC   RF,FFTDLEN                                                       
         AHI   RF,-1                                                            
         BASR  R1,0                                                             
         MVC   OGBACSEM(0),FFTDATA                                              
         EX    RF,0(R1)                                                         
         J     GETBACEY                                                         
                                                                                
GETBACEY CR    RE,RE                                                            
         BR    RE                                                               
                                                                                
GETBACEN LTR   RE,RE                                                            
         BR    RE                                                               
*&&                                                                             
         USING ERFPASD,R2                                                       
         USING ERFTABD,R4                                                       
SETERF   NTR1                                                                   
                                                                                
         L     R4,AGENAREA                                                      
         MVI   ERFTIND,FF          Set EOT                                      
         XC    CSVKEY2,CSVKEY2                                                  
                                                                                
         LA    R2,IOKEY                                                         
         XC    ERFPAS,ERFPAS                                                    
         MVI   ERFPTYP,ERFPTYPQ                                                 
         MVI   ERFPSUB,ERFPSUBQ                                                 
         MVC   ERFPCPY,CUXCPY                                                   
         MVI   ERFPAPPL,ERFKORDQ                                                
         MVC   CSVKEY1,ERFPAS                                                   
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         JE    SETERF04                                                         
         J     EXITN                                                            
                                                                                
SETERF02 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
         JNE   EXITN                                                            
                                                                                
SETERF04 CLC   CSVKEY1(ERFPETYP-ERFPASD),ERFPAS                                 
         JNE   SETERF40                                                         
                                                                                
         TM    ERFPSTAT,ERFKLOCK   skip locked records                          
         JNZ   SETERF02                                                         
                                                                                
SETERF06 CLC   ERFPETYP,FFS        apply filters                                
         JE    SETERF08                                                         
         CLC   QETYCD,ERFPETYP                                                  
         JNE   SETERF02                                                         
                                                                                
SETERF08 CLC   ERFPOTYP,FFS                                                     
         JE    SETERF10                                                         
         CLC   ERFPOTYP,QOTYP                                                   
         JNE   SETERF02                                                         
                                                                                
SETERF10 CLC   ERFPSACC,FFS                                                     
         JE    SETERF12                                                         
         CLC   ERFPSACC,QSUPPC+1                                                
         JNE   SETERF02                                                         
                                                                                
SETERF12 CLC   ERFPSOFF,SPACES                                                  
         JNH   SETERF14                                                         
         CLC   ERFPSOFF,QOFFC                                                   
         JNE   SETERF02                                                         
                                                                                
* L ERFPETYP ERFPOTYP ERFPSACC     check if 'best matching'                     
*                                  (see ACBRA1F, GETFOR)                        
* 1 E        O        S                                                         
* 2 E        .        S                                                         
* 3 .        O        S                                                         
* 4 .        .        S                                                         
* 5 E        O        .                                                         
* 6 E        .        .                                                         
* 7 .        O        .                                                         
* 8 .        .        .                                                         
                                                                                
COMP     USING ERFPASD,CSVKEY2                                                  
         OC    COMP.ERFPAS,COMP.ERFPAS                                          
         JNZ   SETERF14                                                         
         MVC   COMP.ERFPAS,ERFPAS                                               
         J     SETERF30                                                         
                                                                                
SETERF14 MVI   BYTE1,8                                                          
         CLC   COMP.ERFPETYP(L'ERFPETYP+L'ERFPOTYP+L'ERFPSACC),FFS              
         JE    SETERF20                                                         
         CLC   COMP.ERFPSACC,FFS                                                
         JNE   SETERF16                                                         
         MVI   BYTE1,7                                                          
         CLC   COMP.ERFPETYP,FFS                                                
         JE    SETERF20                                                         
         MVI   BYTE1,6                                                          
         CLC   COMP.ERFPOTYP,FFS                                                
         JE    SETERF20                                                         
         MVI   BYTE1,5                                                          
         J     SETERF20                                                         
                                                                                
SETERF16 MVI   BYTE1,4                                                          
         CLC   COMP.ERFPETYP(L'ERFPETYP+L'ERFPOTYP),FFS                         
         JE    SETERF20                                                         
         MVI   BYTE1,3                                                          
         CLC   COMP.ERFPETYP,FFS                                                
         JE    SETERF20                                                         
         MVI   BYTE1,2                                                          
         CLC   COMP.ERFPOTYP,FFS                                                
         JE    SETERF20                                                         
         MVI   BYTE1,1                                                          
                                                                                
SETERF20 MVI   BYTE2,8                                                          
         CLC   ERFPETYP(L'ERFPETYP+L'ERFPOTYP+L'ERFPSACC),FFS                   
         JE    SETERF24                                                         
         CLC   ERFPSACC,FFS                                                     
         JNE   SETERF22                                                         
         MVI   BYTE2,7                                                          
         CLC   ERFPETYP,FFS                                                     
         JE    SETERF24                                                         
         MVI   BYTE2,6                                                          
         CLC   COMP.ERFPOTYP,FFS                                                
         JE    SETERF24                                                         
         MVI   BYTE2,5                                                          
         J     SETERF24                                                         
                                                                                
SETERF22 MVI   BYTE2,4                                                          
         CLC   ERFPETYP(L'ERFPETYP+L'ERFPOTYP),FFS                              
         JE    SETERF24                                                         
         MVI   BYTE2,3                                                          
         CLC   ERFPETYP,FFS                                                     
         JE    SETERF24                                                         
         MVI   BYTE2,2                                                          
         CLC   ERFPOTYP,FFS                                                     
         JE    SETERF24                                                         
         MVI   BYTE2,1                                                          
                                                                                
SETERF24 CLC   BYTE2,BYTE1         compare current against saved record         
         JH    SETERF30                                                         
         MVC   COMP.ERFPAS,ERFPAS                                               
                                                                                
SETERF30 L     R4,AGENAREA         add to table if not existing yet             
                                                                                
SETERF32 CLI   ERFTIND,FF                                                       
         JE    SETERF34                                                         
         CLC   ERFTCOD,ERFPFRMT                                                 
         JE    SETERF02                                                         
         AHI   R4,ERFTLNQ                                                       
         J     SETERF32                                                         
                                                                                
SETERF34 MVI   ERFTIND,0           add new entry                                
         MVC   ERFTCOD,ERFPFRMT                                                 
         MVC   ERFTDA,ERFPDA                                                    
         AHI   R4,ERFTLNQ                                                       
         MVI   ERFTIND,FF                                                       
         J     SETERF02                                                         
                                                                                
SETERF40 OC    COMP.ERFPAS,COMP.ERFPAS   no entries?                            
         JZ    EXITN                                                            
                                                                                
         L     R4,AGENAREA         update table with best match                 
                                                                                
SETERF42 CLI   ERFTIND,FF                                                       
         JE    EXITY                                                            
         CLC   ERFTCOD,COMP.ERFPFRMT                                            
         JE    SETERF44                                                         
         AHI   R4,ERFTLNQ                                                       
         J     SETERF42                                                         
                                                                                
SETERF44 MVI   ERFTIND,YESQ                                                     
         MVC   TEMP(ERFTLNQ),ERFTABD                                            
         L     R1,AGENAREA                                                      
         MVC   ERFTABD(ERFTLNQ),0(R1)                                           
         MVC   0(ERFTLNQ,R1),TEMP                                               
         J     EXITY                                                            
         DROP  R2,R4                                                            
         DROP  COMP                                                             
         EJECT                                                                  
***********************************************************************         
* Access rules for connected agency                                   *         
***********************************************************************         
                                                                                
ACCRUL   NTR1  LABEL=*                                                          
         J     *+12                                                             
         DC    C'*ACCRUL*'                                                      
*                                                                               
         MVI   LL_DACS,LL_ALLQ     Set default access                           
         MVC   LL_DACS+L'LL_DACS(LL_DACLQ-L'LL_DACS),LL_DACS                    
                                                                                
         GOTOR SETLAV,SCPXEL       Set limit access values at company           
         GOTOR CHKLAV                                                           
         JE    ACCRULX             All values now set                           
                                                                                
         CLI   CUACCS,C'$'         List access single character                 
         JE    ACCRUL40            Yes - don't read for offices                 
         USING OFLPASD,R2                                                       
         LA    R2,IOKEY                                                         
         XC    OFLPAS,OFLPAS                                                    
         MVI   OFLPTYP,OFLPTYPQ                                                 
         MVI   OFLPSUB,OFLPSUBQ                                                 
         MVC   OFLPREM,CUXCPY                                                   
         MVC   OFLPOFF,CUACCS+1                                                 
         TM    CPYSTAT4,CPYSOFF2                                                
         JZ    *+10                                                             
         MVC   OFLPOFF,CUACCS+2                                                 
         MVC   CSVKEY1,OFLPAS                                                   
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO3'                               
         JE    ACCRUL20                                                         
         J     ACCRUL40                                                         
                                                                                
ACCRUL10 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO3'                               
         JNE   ACCRUL40                                                         
                                                                                
ACCRUL20 CLC   OFLPAS(OFLPOFL-OFLPASD),CSVKEY1                                  
         JNE   ACCRUL40                                                         
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JNE   *+2                                                              
                                                                                
         XR    R0,R0                                                            
         L     RF,AIO3                                                          
         LA    RF,OFFRFST-OFFRECD(RF)                                           
N        USING CPXELD,RF                                                        
ACCRUL30 CLI   N.CPXEL,0                                                        
         JE    ACCRUL10                                                         
         CLI   N.CPXEL,CPXELQ                                                   
         JE    ACCRUL32                                                         
         IC    R0,N.CPXLN                                                       
         AR    RF,R0                                                            
         J     ACCRUL30                                                         
*                                                                               
ACCRUL32 GOTOR SETLAV,N.CPXEL      SET LIMIT ACCESS VALUES AT OFL LVL           
         J     ACCRUL10                                                         
         DROP  N                                                                
                                                                                
ACCRUL40 GOTOR CHKLAV                                                           
         JE    ACCRULX             OK - ALL VALUES NOW SET                      
                                                                                
         TM    CPYSTAT4,CPYSOFF2                                                
         JZ    ACCRULX                                                          
                                                                                
         LA    R2,IOKEY            ELSE TRY OFFICE FOR SETTINGS                 
         USING OFFRECD,R2                                                       
         MVC   OFFKEY,SPACES                                                    
         MVI   OFFKTYP,OFFKTYPQ                                                 
         MVC   OFFKCPY,CUXCPY                                                   
         MVC   OFFKOFF,CUACCS+2                                                 
         MVC   CSVKEY1,OFFKEY                                                   
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JNE   ACCRULX             NO OFFICE RECORD                             
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JNE   *+2                                                              
                                                                                
         XR    R0,R0                                                            
         L     RF,AIO3                                                          
         LA    RF,OFFRFST-OFFRECD(RF)                                           
N        USING CPXELD,RF                                                        
ACCRUL50 CLI   N.CPXEL,0                                                        
         JE    ACCRULX                                                          
         CLI   N.CPXEL,CPXELQ                                                   
         JE    ACCRUL52                                                         
         IC    R0,N.CPXLN                                                       
         AR    RF,R0                                                            
         J     ACCRUL50                                                         
                                                                                
ACCRUL52 GOTOR SETLAV,N.CPXEL    SET LIMIT ACCESS VALUES AT OFF LVL             
         DROP  N                                                                
         DROP  R2                                                               
                                                                                
ACCRULX  J     EXIT                                                             
                                                                                
***********************************************************************         
* Set limit access values from Company extra element                  *         
***********************************************************************         
         SPACE 1                                                                
SETLAV   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*SETLAV*'                                                      
*                                                                               
         LR    R2,R1               Company extra element                        
N        USING CPXELD,R2                                                        
         LAY   R3,CPXTAB                                                        
         USING CPXTABD,R3                                                       
         LHI   RF,CPXTABN                                                       
SETLAV04 LLC   R1,CPXTVAL                                                       
         LA    R4,LL_DACS(R1)                                                   
         CLI   0(R4),LL_ALLQ                                                    
         JNE   SETLAV08            OK if Access has already been set            
         LLC   R1,CPXTSTA                                                       
         LA    R1,N.CPXELD(R1)                                                  
         MVC   BYTE1,0(R1)         Extra status in CPXELD                       
         NC    BYTE1,CPXTACS       Test None access                             
         JZ    SETLAV08            No - OK                                      
         MVI   0(R4),LL_NONEQ                                                   
*                                                                               
SETLAV08 LA    R3,CPXTABL(,R3)                                                  
         JCT   RF,SETLAV04                                                      
         DROP  R3,N                                                             
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Check all limit access values have already been set                 *         
* Exit: cc = equal if all limit access values set                     *         
***********************************************************************         
         SPACE 1                                                                
CHKLAV   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*CHKLAV*'                                                      
*                                                                               
         LA    RF,LL_DACS                                                       
         LHI   R1,LL_DACLQ                                                      
CHKLAV10 CLI   0(RF),LL_ALLQ                                                    
         JE    EXITN                                                            
         LA    RF,L'LL_DACS(,RF)                                                
         JCT   R1,CHKLAV10                                                      
         J     EXITY                                                            
         EJECT                                                                  
                                                                                
CPXTABD  DSECT                                                                  
CPXTVAL  DS    XL1                                                              
CPXTSTA  DS    XL1                                                              
CPXTACS  DS    XL1                                                              
CPXTABL  EQU   *-CPXTABD                                                        
                                                                                
         EJECT                                                                  
                                                                                
SVRDEF   CSECT ,                                                                
                                                                                
*** Key filter routine for ONARECD ***                                          
ONAKF    NTR1                                                                   
                                                                                
         DS    0H                  Office check                                 
         CLC   IOKEY+ONAKOFF-ONARECD(L'ONAKOFF),SPACES                          
         JNH   ONAKF2                                                           
                                                                                
         USING OFFALD,R1                                                        
         L     R1,AOFFAREA                                                      
         MVC   OFFAOFFC,IOKEY+ONAKOFF-ONARECD                                   
         MVI   OFFAACT,OFFAVAL                                                  
         GOTO1 VOFFAL                                                           
         JNE   EXITN                                                            
         DROP  R1                                                               
                                                                                
ONAKF2   OC    WAAPPL,WAAPPL       Any entries else take all                    
         JZ    EXITY                                                            
                                                                                
         USING LW_D,R2                                                          
         XR    R2,R2               point to list in WMP                         
         ICM   R2,7,WAAPPL                                                      
         XR    R3,R3                                                            
         ICM   R3,3,LW_NUMN        number of entries                            
         LA    R4,LW_DATA2         start of list                                
         DROP  R2                                                               
                                                                                
ONAKF4   BASR  RF,0                Does application match list?                 
         CLC   IOKEY+ONAKAPP-ONARECD(L'ONAKAPP),0(R4)                           
         JE    EXITY                                                            
         AHI   R4,L'ONAKAPP                                                     
         BCTR  R3,RF                                                            
                                                                                
         J     EXITN                                                            
                                                                                
*** Key filter routine for OFFRECD ***                                          
OFFKF    NTR1                                                                   
         USING OFFRECD,R2                                                       
         LA    R2,IOKEY                                                         
         TM    OFFKSTAT,OFFSLIST   ignore office lists                          
         JNZ   EXITN                                                            
                                                                                
         CLI   LP_ACCS,0           skip if no limit access                      
         JE    EXITY                                                            
         USING OFFALD,R1                                                        
         L     R1,AOFFAREA                                                      
         MVC   OFFAOFFC,OFFKOFF    move in offices                              
         MVI   OFFAACT,OFFAVAL                                                  
         GOTO1 VOFFAL                                                           
         JNE   EXITN                                                            
         J     EXITY                                                            
         DROP  R1                                                               
                                                                                
                                                                                
*** Key filter routine for 2D ACTRECD ***                                       
A2DKF    NTR1                                                                   
         USING ACTRECD,R2                                                       
         LA    R2,IOKEY                                                         
         CLC   ACTKACT,SPACES                                                   
         JE    EXITN                                                            
         LA    RE,ACTKACT+1                                                     
         CLC   0(L'ACTKACT-1,RE),SPACES      IGNORE LOWER LEVELS                
         JNE   EXITN                                                            
                                                                                
         CLI   LP_ACCS,0           skip if no limit access                      
         JE    EXITY                                                            
         USING OFFALD,R1                                                        
         L     R1,AOFFAREA                                                      
         MVC   OFFAOFFC,ACTKACT    move in offices                              
         MVI   OFFAACT,OFFAVAL                                                  
         GOTO1 VOFFAL                                                           
         JNE   EXITN                                                            
         J     EXITY                                                            
         DROP  R1                                                               
                                                                                
*** Key filter routine for Client record ***                                    
CLIKF    NTR1                                                                   
         USING ACTRECD,R2                                                       
         LA    R2,IOKEY                                                         
         CLC   ACTKACT,SPACES                                                   
         JNH   EXITN                                                            
         LLC   RF,PCLILEN                                                       
         LA    RE,ACTKACT                                                       
         AR    RE,RF                                                            
         CLI   0(RE),X'40'                                                      
         JH    EXITN                                                            
         SR    RF,RF               If Aura include closed/locked                
         ICM   RF,3,CUXPNUM                                                     
         CHI   RF,XPRODIKQ                                                      
         JNE   *+12                                                             
         CLI   QAPPL,QORD          Only skip if orders                          
         JE    EXITY                                                            
         TM    ACTKSTAT,ACTSCLOS   If BO filter out locked/closed               
         JNZ   EXITN                                                            
         TM    ACTKSTAT,ACTSLOCK                                                
         JNZ   EXITN                                                            
         J     EXITY                                                            
         DROP  R2                                                               
                                                                                
*** Record filter routine for Client record ***                                 
CLIRF    NTR1                                                                   
         L     R1,AIO4                                                          
         USING ACTRECD,R1                                                       
         LA    R2,ACTRFST                                                       
         LR    R4,R2                                                            
         USING PPRELD,R2                                                        
CLIRF02  CLI   PPREL,0                                                          
         JE    EXITY                                                            
         CLI   PPREL,PPRELQ                                                     
         JE    CLIRF04                                                          
         LLC   R0,PPRLN                                                         
         AR    R2,R0                                                            
         J     CLIRF02                                                          
CLIRF04  CLC   PPRGAOFF,SPACES                                                  
         JNH   EXITY                                                            
         USING LW_D,R3                                                          
         XR    R3,R3               Point to list in WMP                         
         ICM   R3,7,DAOFF                                                       
         JZ    CLIRF12                                                          
         XR    R0,R0                                                            
         ICM   R0,3,LW_NUMN        Number of entries                            
         JZ    EXITY                                                            
         TM    X#LLIND,X#CLIOF     Are we in filter clients by office           
         JNZ   CLIRF08                                      mode                
         LA    R3,LW_DATA2         Start of list                                
CLIRF06  CLC   PPRGAOFF,0(R3)                                                   
         JE    CLIRF12                                                          
         AHI   R3,L'PPRGAOFF                                                    
         JCT   R0,CLIRF06                                                       
         J     EXITN                                                            
                                                                                
CLIRF08  LA    R3,LW_DATA2         Start of list                                
CLIRF10  CLC   PPRGAOFF,0(R3)                                                   
         JE    EXITN                                                            
         AHI   R3,L'PPRGAOFF                                                    
         JCT   R0,CLIRF10                                                       
                                                                                
         USING OFFALD,R1                                                        
CLIRF12  L     R1,AOFFAREA                                                      
         MVC   OFFAOFFC,PPRGAOFF   validate current office                      
         MVI   OFFAACT,OFFAVAL                                                  
         GOTO1 VOFFAL                                                           
         JE    EXITY                                                            
         DROP  R1                                                               
                                                                                
         USING LIDELD,R4                                                        
CLIRF14  CLI   LIDEL,0                                                          
         JE    EXITN               No valid office code found                   
         CLI   LIDEL,LIDELQ                                                     
         JNE   CLIRF16                                                          
         CLI   LIDTYPE,LIDTPOFC      Product office codes                       
         JE    CLIRF18                                                          
CLIRF16  LLC   RF,LIDLN                                                         
         AR    R4,RF                                                            
         J     CLIRF14                                                          
CLIRF18  XR    R0,R0                                                            
         LA    RF,LIDDATA-LIDELD                                                
         LLC   R1,LIDLN                                                         
         SR    R1,RF               R1=Length of LIDDATA                         
         LLC   RF,LIDITLN                                                       
         DR    R0,RF               R1=No. of office codes in LIDDATA            
         STC   R1,BYTE3                                                         
         LR    R3,R1                                                            
         LA    R4,LIDDATA                                                       
         USING OFFALD,R1                                                        
CLIRF20  L     R1,AOFFAREA                                                      
         MVC   OFFAOFFC,0(R4)                                                   
         MVI   OFFAACT,OFFAVAL                                                  
         GOTO1 VOFFAL                                                           
         JE    EXITY                                                            
         LA    R4,L'TRNOFFC(R4)                                                 
         JCT   R3,CLIRF20                                                       
         J     EXITN                                                            
         DROP  R1,R2,R4                                                         
                                                                                
*** Key filter routine for account record ***                                   
ACTKF    NTR1                                                                   
         USING ACTRECD,R2                                                       
         LA    R2,IOKEY                                                         
         CLC   ACTKACT,SPACES                                                   
         JNH   EXITN                                                            
         TM    ACTKSTAT,ACTSABLP Only want accounts with balance elem           
         JZ    EXITN                                                            
*&&US                                                                           
         TM    ACTKSTAT,ACTSLOCK                                                
         JNZ   EXITN                                                            
*&&                                                                             
         J     EXITY                                                            
         DROP  R2                                                               
                                                                                
*** Record filter routine for account record ***                                
                                                                                
ACTRF    NTR1                                                                   
         L     R1,AIO4                                                          
         USING ACTRECD,R1                                                       
         LA    R2,ACTRFST                                                       
         USING ASTELD,R2                                                        
ACTRF02  CLI   ASTEL,0                                                          
         JE    EXITY                                                            
*&&UK                                                                           
         CLI   ASTEL,ASTELQ                                                     
         JE    ACTRF04                                                          
*&&                                                                             
*&&US                                                                           
         CLI   ASTEL,RSTELQ                                                     
         JE    ACTRF06                                                          
*&&                                                                             
         LLC   R0,ASTLN                                                         
         AR    R2,R0                                                            
         J     ACTRF02                                                          
*&&UK                                                                           
ACTRF04  CLI   ASTCUR,ASTCANY      Filter out suppliers not in agency           
         JE    EXITY                                                            
         CLC   ASTCUR,AGYCURR                                                   
         JE    EXITY                                                            
         J     EXITN                                                            
*&&                                                                             
*&&US                                                                           
         USING RSTELD,R2                                                        
ACTRF06  TM    RSTSTAT1,RSTSACIL   Is account locked                            
         JZ    EXITY                                                            
         CLC   RSTTDATE,D_TDM10    Does it have activiy in the last             
         JL    EXITN                     10 years                               
         J     EXITY                                                            
*&&                                                                             
         DROP  R1,R2                                                            
                                                                                
*** Key filter routine for work code record ***                                 
                                                                                
WCKF     NTR1                                                                   
         CLI   CUCTRY,CTRYGER      Germany and Orders?                          
         JNE   EXITY                                                            
         CLI   QAPPL,QORD                                                       
         JNE   EXITY                                                            
         LA    R1,IOKEY            Yes                                          
         USING WCORECD,R1                                                       
         CLI   WCOKWRK,C'0'        skip internals for other orders              
         JL    EXITN                                                            
         J     EXITY                                                            
         DROP  R1                                                               
                                                                                
*** Record filter routine for work code record ***                              
                                                                                
WCRF     NTR1                                                                   
         L     R1,AIO4                                                          
         USING WCORECD,R1                                                       
         LA    R2,WCORFST                                                       
         USING WCOELD,R2                                                        
WCRF002  CLI   WCOEL,0                                                          
         JE    EXITY                                                            
         CLI   WCOEL,WCOELQ                                                     
         JE    WCRF004                                                          
         LLC   R0,WCOLN                                                         
         AR    R2,R0                                                            
         J     WCRF002                                                          
                                                                                
WCRF004  LA    RE,WCOSLORD         Orders?                                      
         CLI   QAPPL,QORD                                                       
         JE    WCRF006                                                          
         LA    RE,WCOSLEST         Estimates?                                   
         CLI   QAPPL,QEST                                                       
         JE    WCRF006                                                          
         LA    RE,WCOSLPST         Time?                                        
         CLI   QAPPL,QTIME                                                      
         JE    WCRF006                                                          
         LA    RE,WCOSLPST         Invoices?                                    
         CLI   QAPPL,QINV                                                       
         JE    WCRF006                                                          
         LA    RE,WCOSLPST         Expenses?                                    
         CLI   QAPPL,QEXPCLM                                                    
         JE    WCRF006                                                          
         DC    H'0'                                                             
WCRF006  BASR  RF,0                                                             
         TM    WCOSTAT2,0          Locked from ...?                             
         EX    RE,0(RF)                                                         
         JNZ   EXITN                                                            
         J     EXITY                                                            
         DROP  R1,R2                                                            
                                                                                
*** Key filter routine for SCHRECD ***                                          
SCHKF    NTR1                                                                   
         USING SCHRECD,R2                                                       
         LA    R2,IOKEY                                                         
         TM    SCHKSTA,SCHSMCSN                                                 
         JNZ   EXITN                                                            
         MVI   ODEFLT,NOQ                                                       
         CLC   SCHKCODE,DOMDEF                                                  
         JNE   EXITY                                                            
         MVI   ODEFLT,YESQ                                                      
         J     EXITY                                                            
         DROP  R2                                                               
                                                                                
*** Record filter routine for SCHRECD ***                                       
         USING SCHRECD,R2                                                       
         USING CATRECD,R3                                                       
SCHRF    NTR1                                                                   
                                                                                
         LR    R2,R1                                                            
         MVC   SAVEKEY,SCHKEY      Save key                                     
         LA    R3,IOKEY            read for category to skip slush              
         XC    CATKEY,CATKEY       only category schemes                        
         MVI   CATKTYP,CATKTYPQ                                                 
         MVI   CATKSUB,CATKSUBQ                                                 
         MVC   CATKCPY,CUXCPY                                                   
         MVC   CATKUNT(2),PRODUL                                                
         MVC   CATKSCH,SCHKCODE                                                 
         MVC   CSVKEY1,CATKEY                                                   
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO3'                               
         JNE   *+2                                                              
                                                                                
         CLC   CATKEY(CATKCODE-CATRECD),CSVKEY1                                 
         JNE   SCHRFNO             skip if nothing found                        
                                                                                
         CLC   CATKCODE,FFS        take if anything but slush category          
         JNE   SCHRFYES                                                         
                                                                                
***      GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
***      JNE   *+2                 (no further checks so far)                   
                                                                                
         J     SCHRFNO             skip if slush only                           
         DROP  R2,R3                                                            
                                                                                
SCHRFYES MVC   IOKEY,SAVEKEY                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         J     EXITY                                                            
                                                                                
SCHRFNO  MVC   IOKEY,SAVEKEY                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         J     EXITN                                                            
                                                                                
*** Key filter routine for RSFRECD ***                                          
                                                                                
RSFKF    NTR1                                                                   
         USING RSFRECD,R2                                                       
         LA    R2,IOKEY                                                         
         MVI   OTYPE,C'N'                                                       
         MVC   OFLT,RSFKFLT#                                                    
         OC    RSFKFLT#,RSFKFLT#                                                
         JZ    EXITY                                                            
         MVI   OTYPE,C'V'                                                       
         J     EXITY                                                            
                                                                                
*** Key filter routine for ERFRECD ***                                          
ERFKF    NTR1                                                                   
         USING ERFRECD,R2                                                       
         LA    R2,IOKEY                                                         
                                                                                
         TM    CPYSTAT4,CPYSOFF2   OFFAL for 1CO only (2CO see ERFRF)           
         JNZ   EXITY                                                            
                                                                                
         TM    ERFKSTAT,ERFKLOCK                                                
         JNZ   EXITN                                                            
                                                                                
         MVC   CERFOFF,ERFKSOFF                                                 
         CLC   ERFKSOFF,SPACES                                                  
         JNH   EXITY                                                            
                                                                                
         USING OFFALD,R1                                                        
         L     R1,AOFFAREA                                                      
         MVC   OFFAOFFC,ERFKSOFF                                                
         MVI   OFFAACT,OFFAVAL                                                  
         GOTO1 VOFFAL                                                           
         JNE   EXITN                                                            
         J     EXITY                                                            
         DROP  R1,R2                                                            
                                                                                
*** Record filter routine for ERFRECD ***                                       
ERFRF    NTR1                                                                   
         USING ERFRECD,R2                                                       
         LR    R2,R1                                                            
         TM    CPYSTAT4,CPYSOFF2   skip 1CO here (see ERFKF)                    
         JZ    EXITY                                                            
         MVC   SAVEKEY,IOKEY                                                    
         L     R6,AIO8             keep track of good offices                   
         ST    R6,ACURNTR                                                       
         XC    0(L'ERFRSOFF,R6),0(R6)                                           
         XC    CERFOFF,CERFOFF                                                  
         CLC   ERFRSOFF,SPACES                                                  
         JNH   EXITY                                                            
         MVI   BYTE4,NOQ                                                        
         MVC   0(L'ERFRSOFF,R6),ERFRSOFF                                        
         XC    L'ERFRSOFF(L'ERFRSOFF,R6),L'ERFRSOFF(R6)                         
         MVC   CERFOFF,ERFRSOFF                                                 
                                                                                
         USING OFFALD,R1                                                        
         L     R1,AOFFAREA                                                      
         MVC   OFFAOFFC,ERFRSOFF   move in offices                              
         MVI   OFFAACT,OFFAVAL                                                  
         GOTO1 VOFFAL                                                           
         JNE   ERFRF1              if not OK check for 2CO lists                
         MVI   BYTE4,YESQ                                                       
                                                                                
         USING OFFRECD,R3                                                       
ERFRF1   LA    R3,IOKEY                                                         
         MVC   OFFKEY,SPACES       get office record                            
         MVI   OFFKTYP,OFFKTYPQ                                                 
         MVC   OFFKCPY,CUXCPY                                                   
         MVC   OFFKOFF,ERFRSOFF                                                 
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
         JNE   ERFRNO              must exits and must be list                  
         TM    OFFKSTAT,OFFSLIST                                                
         JZ    ERFRF8                                                           
         TM    REQI,REQIAURA                                                    
         JZ    ERFRNO                                                           
         L     R6,AIO8                                                          
         XC    0(L'ERFRSOFF,R6),0(R6)                                           
         XC    CERFOFF,CERFOFF                                                  
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
         JNE   *+2                                                              
         L     R3,AIO1                                                          
         AHI   R3,OFFRFST-OFFRECD  process list of single office                
         DROP  R3                                                               
         USING OFLELD,R3           via OFFAL                                    
ERFRF2   CLI   OFLEL,0                                                          
         JE    ERFRF8                                                           
         CLI   OFLEL,OFLELQ                                                     
         JE    ERFRF4                                                           
ERFRF3   LLC   R0,OFLLN                                                         
         AR    R3,R0                                                            
         J     ERFRF2                                                           
                                                                                
ERFRF4   LLC   R0,OFLLN                                                         
         SHI   R0,OFLLN1Q                                                       
         SRL   R0,1                                                             
         LTR   R0,R0                                                            
         JNP   ERFRF3                                                           
         LA    R4,OFLNTRY                                                       
                                                                                
         USING OFFALD,R1                                                        
ERFRF5   L     R1,AOFFAREA                                                      
         MVC   OFFAOFFC,0(R4)      move in office                               
         MVI   OFFAACT,OFFAVAL                                                  
         GOTO1 VOFFAL                                                           
         JNE   ERFRF7              on first match exit OK                       
         MVI   BYTE4,YESQ                                                       
         OC    CERFOFF,CERFOFF     set first code                               
         JNZ   ERFRF6                                                           
         MVC   CERFOFF,0(R4)                                                    
         J     ERFRF7                                                           
                                                                                
ERFRF6   LLC   RE,ERFOCNT          count office (but not first)                 
         AHI   RE,1                and add to list                              
         STC   RE,ERFOCNT                                                       
         MVC   0(L'ERFRSOFF,R6),0(R4)                                           
         AHI   R6,L'ERFRSOFF                                                    
         XC    0(L'ERFRSOFF,R6),0(R6)                                           
                                                                                
ERFRF7   AHI   R4,L'ERFRSOFF                                                    
         JCT   R0,ERFRF5                                                        
         J     ERFRF3                                                           
                                                                                
ERFRF8   CLI   BYTE4,YESQ                                                       
         JNE   ERFRNO                                                           
                                                                                
ERFRYES  CLC   SAVEKEY(L'ERFKEY),IOKEY                                          
         JE    EXITY                                                            
         MVC   IOKEY,SAVEKEY                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         J     EXITY                                                            
                                                                                
ERFRNO   CLC   SAVEKEY(L'ERFKEY),IOKEY                                          
         JE    EXITN                                                            
         MVC   IOKEY,SAVEKEY                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         J     EXITN                                                            
         DROP  R1,R3                                                            
                                                                                
*** Key filter routine for SCMRECD ***                                          
         USING SCMRECD,R2                                                       
SCMKF    NTR1                                                                   
                                                                                
         LA    R2,IOKEY                                                         
         TM    SCMKSTAT,SCMKSLCK   exlude locked                                
         JNZ   EXITN                                                            
*&&US*&& TM    SCMKSTAT,SCMKSABO   Is this available to BrandO?                 
*&&US*&& JNO   EXITN               SKIP                                         
                                                                                
         TM    SCMKSTAT,SCMKSCLP   Skip if no office set                        
         JNZ   SCMKF04                                                          
                                                                                
         CLC   SCMKSOFF,SPACES     Office check                                 
         JNH   SCMKF04                                                          
                                                                                
         USING OFFALD,R1                                                        
         L     R1,AOFFAREA                                                      
         MVC   OFFAOFFC,SCMKSOFF                                                
         MVI   OFFAACT,OFFAVAL                                                  
         GOTO1 VOFFAL                                                           
         JNE   EXITN                                                            
         DROP  R1                                                               
                                                                                
SCMKF02  CLC   QNAROFF,SPACES                                                   
         JNH   SCMKF04                                                          
                                                                                
         CLC   QNAROFF,SCMKSOFF                                                 
         JNE   EXITN                                                            
                                                                                
SCMKF04  TM    SCMKSTAT,SCMKSCLP   Skip if client not set                       
         JZ    SCMKF06                                                          
                                                                                
         CLC   SCMKSCLI,SPACES     Client check                                 
         JNH   SCMKF06                                                          
                                                                                
         CLC   QNARCLI,SPACES                                                   
         JNH   SCMKF06                                                          
                                                                                
         CLC   QNARCLI,SCMKSCLI                                                 
         JNE   EXITN                                                            
                                                                                
SCMKF06  CLI   QNARAPP,C' '        Application check                            
         JNH   SCMKF14                                                          
                                                                                
*&&UK                                                                           
SCMKF08  LA    RE,SCMKSRRQ                                                      
         CLI   QNARAPP,C'R'        REMINDER REPORT                              
         JE    SCMKF10                                                          
         LA    RE,SCMKSFBQ                                                      
         CLI   QNARAPP,C'F'        FLEXIBILL/BILLING                            
         JE    SCMKF10                                                          
         LA    RE,SCMKSESQ                                                      
         CLI   QNARAPP,C'E'        ESTIMATES                                    
         JE    SCMKF10                                                          
         LA    RE,SCMKSORQ                                                      
         CLI   QNARAPP,C'O'        ORDERS                                       
         JE    SCMKF10                                                          
         LA    RE,SCMKSTIQ                                                      
         CLI   QNARAPP,C'T'        TIMESHEETS                                   
         JE    SCMKF10                                                          
         LA    RE,SCMKSEXQ                                                      
         CLI   QNARAPP,C'X'        EXPENSE CLAIMS                               
         JE    SCMKF10                                                          
         LA    RE,SCMKSINQ                                                      
         CLI   QNARAPP,QINV        INVOICES                                     
         JE    SCMKF10                                                          
         DC    H'0'                   unknown application                       
                                                                                
SCMKF10  BASR  R1,0                                                             
         EX    RE,12(R1)                                                        
         JZ    EXITN                                                            
         J     SCMKF14                                                          
         TM    SCMKSAPP,0                                                       
*&&                                                                             
                                                                                
SCMKF14  DS    0H                                                               
         J     EXITY                                                            
         DROP  R2                                                               
                                                                                
*** Record filter routine for SCMRECD ***                                       
         USING SCMRECD,R1                                                       
         USING COIELD,R2                                                        
SCMRF    NTR1                                                                   
         LA    R2,SCMRFST                                                       
         XC    ELEMENT,ELEMENT                                                  
         XR    R0,R0                                                            
                                                                                
SCMRF02  CLI   COIEL,0                                                          
         JE    SCMRF06                                                          
         CLI   COIEL,COIELQ                                                     
         JE    SCMRF04                                                          
         IC    R0,COILN                                                         
         AR    R2,R0                                                            
         J     SCMRF02                                                          
                                                                                
SCMRF04  XR    RE,RE                                                            
         IC    RE,COILN                                                         
         SHI   RE,1                                                             
         BASR  RF,0                                                             
         EX    RE,4(RF)                                                         
         MVC   ELEMENT(0),COIEL                                                 
                                                                                
SCMRF06  LA    R2,ELEMENT                                                       
                                                                                
         TM    COISTAT,COISLOCK    (lock filter again)                          
         JNZ   EXITN                                                            
                                                                                
         CLC   QNARFLT,SPACES      check for filter                             
         JNH   SCMRF08                                                          
                                                                                
         CLC   QNARFLT,COIFILT                                                  
         JNE   EXITN                                                            
                                                                                
SCMRF08  CLI   QNARLAN,C'A'        check for language                           
         JE    SCMRF12                                                          
         CLI   QNARLAN,C' '                                                     
         JE    SCMRF12                                                          
         CLI   QNARLAN,C'F'                                                     
         JNE   SCMRF10             (else must be N=native)                      
                                                                                
         TM    COISTAT,COISFRGN                                                 
         JZ    EXITN                                                            
         J     SCMRF12                                                          
                                                                                
SCMRF10  TM    COISTAT,COISFRGN                                                 
         JNZ   EXITN                                                            
                                                                                
SCMRF12  CLC   QNARPRO,SPACES      product filter                               
         JNH   SCMRF14                                                          
                                                                                
         CLI   COILN,COILNXQ                                                    
         JL    SCMRF14                                                          
         CLC   COIPROC,SPACES                                                   
         JNH   SCMRF14                                                          
                                                                                
         CLC   COIPROC,QNARPRO                                                  
         JNE   EXITN                                                            
                                                                                
SCMRF14  CLC   QNARWRK,SPACES      work code filter                             
         JNH   SCMRF16                                                          
                                                                                
         CLI   COILN,COILNXQ                                                    
         JL    SCMRF16                                                          
         CLC   COIWORK,SPACES                                                   
         JNH   SCMRF16                                                          
                                                                                
         CLC   COIWORK,QNARWRK                                                  
         JNE   EXITN                                                            
                                                                                
SCMRF16  DS    0H                                                               
         J     EXITY                                                            
         DROP  R1,R2                                                            
                                                                                
         EJECT                                                                  
                                                                                
*** Key filter routine for ETYRECD ***                                          
         USING ETYRECD,R2                                                       
ETYKF    NTR1                                                                   
                                                                                
         LA    R2,IOKEY                                                         
         CLI   QAPPL,C' '          Any application passed?                      
*&&UK*&& JNH   ETYKF12                                                          
*&&US*&& JNH   ETYKF20                                                          
         LA    RE,ETYKSAEQ         Expenses                                     
         CLI   QAPPL,QEXPCLM                                                    
         JE    ETYKF10                                                          
         LA    RE,ETYKSAOQ         Orders                                       
         CLI   QAPPL,QORD                                                       
         JE    ETYKF10                                                          
         LA    RE,ETYKSAIQ         Invoices                                     
         CLI   QAPPL,QINV                                                       
*&&UK*&& JNE   ETYKF12                                                          
*&&US*&& JNE   ETYKF20                                                          
*                                                                               
ETYKF10  BASR  RF,0                                                             
         EX    RE,8(RF)                                                         
*&&UK*&& JZ    ETYKF12                                                          
*&&US*&& JZ    ETYKF20                                                          
         TM    ETYKSAPP,0                                                       
         J     EXITN                                                            
*                                                                               
ETYKF12  CLI   QBILL,NOQ                                                        
         JE    ETYKF14                                                          
         TM    ETYKSTA2,ETYSBILY+ETYSBILD                                       
         JNZ   ETYKF20                                                          
                                                                                
ETYKF14  CLI   QNBIL,NOQ                                                        
         JE    ETYKF18                                                          
         TM    ETYKSTA2,ETYSNBLY+ETYSNBLD                                       
         JNZ   ETYKF20                                                          
*                                                                               
ETYKF18  CLI   QAPPL,QINV                                                       
         JE    EXITN                                                            
         TM    ETYKSTA2,ETYSADVY+ETYSADVD                                       
         JZ    EXITN                                                            
                                                                                
ETYKF20  CLI   CUACCS,0            GLOBAL LOGON?                                
         JE    EXITY               THEN CAN VIEW EVERYTHING                     
*                                                                               
         CLC   ETYKOFFC,SPACES     GLOBAL EXPENDITURE TYPE?                     
         JNH   EXITY               THEN ALLOW USER TO VIEW IT                   
         TM    CPYSTAT4,CPYSOFF2 2 CHAR OFFICE                                  
         JNZ   ETYKF30                                                          
         CLI   CUACCS,C'$'         IS IT OFFICE LIST LOGON?                     
         JNE   ETYKF40                                                          
         CLI   ETYKOFFC,C'$'       OFFICE LIST EXPENDITURE TYPE                 
         JNE   ETYKF40                                                          
         CLC   CUACCS(2),ETYKOFFC  CHECK WHETHER OFFICE LIST MATCHES            
         JE    EXITY                                                            
         J     EXITN                                                            
ETYKF30  CLC   CUACCS+2(2),ETYKOFFC OFFICE LIST?                                
         JE    EXITY                                                            
ETYKF40  CLC   SVOFFL,SPACES                                                    
         JNH   *+14                                                             
         CLC   SVOFFL,ETYKOFFC     MATCH ON OFFICE LIST CODE                    
         JE    EXITY                                                            
                                                                                
         L     R1,AOFFAREA                                                      
         USING OFFALD,R1                                                        
         MVC   OFFAOFFC,SPACES                                                  
         MVC   OFFAOFFC(2),ETYKOFFC MOVE IN OFFICE AND VALIDATE                 
         MVI   OFFAACT,OFFAVAL                                                  
         GOTOR VOFFAL                                                           
         JNE   EXITN                                                            
         J     EXITY                                                            
         DROP  R1                                                               
***********************************************************************         
* Edit office name                                                    *         
***********************************************************************         
         SPACE 1                                                                
EDTOFN   LM    R2,R4,LP_AINP                                                    
         CLC   0(L'TRNOFFC,R2),SPACES                                           
         JNH   EXITY                                                            
         MVC   TEMP2,SPACES                                                     
         MVC   TEMP2(L'TRNOFFC),0(R2)                                           
         GOTOR VALOFF,TEMP2                                                     
         JNE   EXITY                                                            
         MVC   0(L'NAMEREC,R4),TEMP2                                            
         LHI   RE,L'NAMEREC                                                     
         STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Validate office code and get name                                   *         
*                                                                     *         
* Ntry:- R1=A(office code)                                            *         
***********************************************************************         
                                                                                
VALOFF   NTR1  LABEL=NO,WORK=(RC,VOWORKL)                                       
         J     *+12                                                             
         DC    C'*VALOFF*'                                                      
                                                                                
         USING VOWORKD,RC          RC=A(local working storage)                  
         LR    R2,R1               R2=A(account code)                           
         GOTOR CLRWRK,VOWORKL      Clear work area                              
         MVC   VOOFFCOD,0(R2)      Save office code                             
         USING OB_D,VORBAREA                                                    
         MVI   OB_OTYP,OB_OTYPQ    Build key of buffer record                   
         MVI   OB_OSUB,OB_OSUBQ                                                 
         MVC   OB_OFFC(L'TRNOFFC),VOOFFCOD                                      
         GOTOR GETBUF,OB_D                                                      
         JL    VALOFF02                                                         
         JH    EXITN                                                            
         MVC   TEMP2(L'OB_NAME),OB_NAME                                         
         J     VALOFFY                                                          
                                                                                
VALOFF02 TM    CPYSTAT4,CPYSOFF2                                                
         JNZ   VALOFF04                                                         
                                                                                
         MVC   TEMP2,SPACES                                                     
         MVC   TEMP2(L'TRNOFFC),VOOFFCOD                                        
         GOTOR (#GETOFN,AGETOFN)                                                
         MVC   OB_NAME,TEMP2                                                    
         J     VALOFF10                                                         
*                                                                               
K        USING OFFRECD,IOKEY                                                    
VALOFF04 MVC   K.OFFKEY,SPACES                                                  
         MVI   K.OFFKTYP,OFFKTYPQ                                               
         MVC   K.OFFKCPY,CUXCPY                                                 
         MVC   K.OFFKOFF,VOOFFCOD                                               
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         MVC   OB_NAME,SPACES                                                   
         GOTOR GETELA,NAMELQ       Locate name element on record                
         JNE   VALOFFN                                                          
         USING NAMELD,R1                                                        
         CLI   NAMLN,NAMLN1Q       Test good length                             
         JNH   VALOFFN                                                          
         LLC   RF,NAMLN                                                         
         SHI   RF,NAMLN1Q+1                                                     
         CHI   RF,L'NAMEREC-1                                                   
         JNH   *+8                                                              
         LHI   RF,L'NAMEREC-1                                                   
         BASR  RE,0                                                             
         MVC   OB_NAME(0),NAMEREC   Move name to output area                    
         EX    RF,0(RE)                                                         
                                                                                
VALOFF10 MVC   TEMP2,OB_NAME                                                    
         GOTOR ADDBUF,OB_D                                                      
                                                                                
VALOFFY  J     EXITY                                                            
VALOFFN  J     EXITN                                                            
                                                                                
         DROP  R1,RC,K                                                          
                                                                                
VOWORKD  DSECT                     ** VALOFF local w/s **                       
VOOFFCOD DS    CL(L'TRNOFFC)       Office code                                  
VORBAREA DS    XL(OB_LNQ)          Buffer area                                  
         ORG   VORBAREA                                                         
OB_OTYP  DS    X                   ** Buffer key **                             
OB_OTYPQ EQU   X'FF'               Buffer type                                  
OB_OSUB  DS    C                                                                
OB_OSUBQ EQU   C'A'                Buffer sub-type                              
OB_OFFC  DS    CL(L'TRNOFFC)       Office code                                  
         ORG   VORBAREA+(OB_DATA-OB_D)                                          
         ORG                                                                    
VOWORKL  EQU   *-VOWORKD                                                        
                                                                                
SVRDEF   CSECT ,                                                                
         EJECT                                                                  
***********************************************************************         
* Edit Account name                                                   *         
***********************************************************************         
         SPACE 1                                                                
EDTANM   LM    R2,R4,LP_AINP                                                    
         CLC   0(L'ACTKULA,R2),SPACES                                           
         JNH   EXITY                                                            
         MVC   TEMP2,SPACES                                                     
         MVC   TEMP2(L'TRNKULA),0(R2)                                           
         GOTOR VALACT,TEMP2                                                     
         MVC   0(L'NAMEREC,R4),TEMP2                                            
         LHI   RE,L'NAMEREC                                                     
         STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Validate account code                                               *         
*                                                                     *         
* Ntry:- R1=A(ULCliProJob)                                            *         
***********************************************************************         
                                                                                
VALACT   NTR1  LABEL=NO,WORK=(RC,VAWORKL)                                       
         J     *+12                                                             
         DC    C'*VALACT*'                                                      
                                                                                
         USING VAWORKD,RC          RC=A(local working storage)                  
         LR    R2,R1               R2=A(account code)                           
         GOTOR CLRWRK,VAWORKL      Clear work area                              
         USING OB_D,VARBAREA                                                    
         MVC   OB_KEY(L'ACTKULA),TEMP2                                          
         GOTOR GETBUF,OB_D                                                      
         JL    VALACT02                                                         
         JH    EXITN                                                            
         MVC   TEMP2(L'OB_NAME),OB_NAME                                         
         J     VALACTY                                                          
                                                                                
VALACT02 GOTOR (#GETACN,AGETACN)                                                
         MVC   OB_NAME,TEMP2                                                    
         GOTOR ADDBUF,OB_D                                                      
                                                                                
VALACTY  J     EXITY                                                            
                                                                                
         DROP  RC                                                               
                                                                                
VAWORKD  DSECT                     ** VALACT local w/s **                       
VARBAREA DS    XL(OB_LNQ)          Buffer area                                  
         ORG   VARBAREA+(OB_OTHER-OB_D)                                         
         ORG                                                                    
VAWORKL  EQU   *-VAWORKD                                                        
                                                                                
SVRDEF   CSECT ,                                                                
         EJECT                                                                  
***********************************************************************         
* Initialise optimisation buffer (uses WSSVR buffer)                  *         
***********************************************************************         
                                                                                
INIBUF   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*INIBUF*'                                                      
                                                                                
         XC    TSAROBUF(TSPNEWL),TSAROBUF                                       
T        USING TSARD,TSAROBUF                                                   
         MVI   T.TSACTN,TSAINI     Set action to 'Initialise'                   
         MVI   T.TSRECI,TSRXTN+TSRWSSVR                                         
         MVI   T.TSKEYL,L'OB_KEY                                                
         LHI   R0,ONEK                                                          
         OC    T.TSBUFFL,T.TSBUFFL                                              
         JNZ   *+8                                                              
         STCM  R0,3,T.TSBUFFL                                                   
         LHI   R0,OB_LNQ                                                        
         STCM  R0,3,T.TSRECL                                                    
         MVC   T.TSACOM,ACOMFACS                                                
         GOTOR VTSAR,T.TSARD                                                    
         JE    EXITY                                                            
         DC    H'0'                                                             
         DROP  T                                                                
         EJECT                                                                  
***********************************************************************         
* Add a record to optimisation buffer                                 *         
*                                                                     *         
* Ntry:- R1 points to caller's OB_D                                   *         
***********************************************************************         
                                                                                
ADDBUF   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ADDBUF*'                                                      
                                                                                
T        USING TSARD,TSAROBUF                                                   
         MVI   T.TSACTN,TSAADD     Set action to 'Add'                          
         ST    R1,T.TSAREC                                                      
         GOTOR VTSAR,T.TSARD                                                    
         JE    EXITY                                                            
         TM    T.TSERRS,TSEEOF                                                  
         JE    EXITL               buffer full. Not critical,                   
         DC    H'0'                         let caller decide                   
         DROP  T                                                                
         EJECT                                                                  
***********************************************************************         
* Get a record from optimisation buffer                               *         
*                                                                     *         
* Ntry:- R1 points to caller's OB_D                                   *         
* Exit:- CC=Low if record not found in buffer                         *         
*        CC=Equal if record found and is not posted with an error     *         
*           - record is returned in caller's OB_D                     *         
*        CC=High if record found and is posted with an error (set in  *         
*           ROUERRV)                                                  *         
***********************************************************************         
                                                                                
GETBUF   NTR1  LABEL=NO,WORK=(RC,OB_LNQ)                                        
         J     *+12                                                             
         DC    C'*GETBUF*'                                                      
                                                                                
W        USING OB_D,RC                                                          
         LR    R2,R1                                                            
P        USING OB_D,R2             R2=A(caller's OB_D)                          
         MVC   W.OB_KEY,P.OB_KEY                                                
                                                                                
T        USING TSARD,TSAROBUF                                                   
         MVI   T.TSACTN,TSARDH     Set action to 'Read High'                    
         LA    R0,W.OB_D                                                        
         ST    R0,T.TSAREC         Read into acquired storage                   
         GOTOR VTSAR,T.TSARD                                                    
         JNE   EXITL               Not found/EOF                                
         DROP  T                                                                
                                                                                
         MVC   P.OB_D(OB_LNQ),W.OB_D                                            
                                                                                
         MVC   ROUERRV,P.OB_ERROR  Set/test record in error                     
         OC    ROUERRV,ROUERRV                                                  
         JNZ   EXITH                                                            
         J     EXITY                                                            
         DROP  W,P                                                              
         EJECT                                                                  
***********************************************************************         
* Edit expenditure type locked status                                 *         
***********************************************************************         
         SPACE 1                                                                
EDTLOCK  LM    R2,R4,LP_AINP                                                    
         MVI   0(R4),C'N'                                                       
         TM    0(R2),ETYSLOCK                                                   
         JZ    EDTLCK02                                                         
         MVI   0(R4),C'Y'                                                       
EDTLCK02 LHI   RE,1                                                             
         STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Edit expenditure type rec - billable allowed                        *         
***********************************************************************         
         SPACE 1                                                                
EDTBIL   LM    R2,R4,LP_AINP                                                    
         MVI   0(R4),C'N'                                                       
         TM    0(R2),ETYSBILY                                                   
         JZ    EDTBIL02                                                         
         MVI   0(R4),C'Y'                                                       
EDTBIL02 TM    0(R2),ETYSBILD                                                   
         JZ    EDTBIL04                                                         
         MVI   0(R4),C'D'                                                       
EDTBIL04 LHI   RE,1                                                             
         STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Edit expenditure type rec - Non billable allowed                    *         
***********************************************************************         
         SPACE 1                                                                
EDTNBL   LM    R2,R4,LP_AINP                                                    
         MVI   0(R4),C'N'                                                       
         TM    0(R2),ETYSNBLY                                                   
         JZ    EDTNBL02                                                         
         MVI   0(R4),C'Y'                                                       
EDTNBL02 TM    0(R2),ETYSNBLD                                                   
         JZ    EDTNBL04                                                         
         MVI   0(R4),C'D'                                                       
EDTNBL04 LHI   RE,1                                                             
         STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Edit expenditure type rec - Advances allowed                        *         
***********************************************************************         
         SPACE 1                                                                
EDTADV   LM    R2,R4,LP_AINP                                                    
         MVI   0(R4),C'N'                                                       
         TM    0(R2),ETYSADVY                                                   
         JZ    EDTADV02                                                         
         MVI   0(R4),C'Y'                                                       
EDTADV02 TM    0(R2),ETYSADVD                                                   
         JZ    EDTADV04                                                         
         MVI   0(R4),C'D'                                                       
EDTADV04 LHI   RE,1                                                             
         STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Edit expenditure type rec - Locked from orders                      *         
***********************************************************************         
         SPACE 1                                                                
EDTLOR   LM    R2,R4,LP_AINP                                                    
         MVI   0(R4),C'N'                                                       
         TM    0(R2),ETYKSAOQ                                                   
         JZ    EDTLOR02                                                         
         MVI   0(R4),C'Y'                                                       
EDTLOR02 LHI   RE,1                                                             
         STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Edit expenditure type rec - Locked from expenses                    *         
***********************************************************************         
         SPACE 1                                                                
EDTLEX   LM    R2,R4,LP_AINP                                                    
         MVI   0(R4),C'N'                                                       
         TM    0(R2),ETYKSAEQ                                                   
         JZ    EDTLEX02                                                         
         MVI   0(R4),C'Y'                                                       
EDTLEX02 LHI   RE,1                                                             
         STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Edit expenditure type rec - Locked from invoices                    *         
***********************************************************************         
         SPACE 1                                                                
EDTLIN   LM    R2,R4,LP_AINP                                                    
         MVI   0(R4),C'N'                                                       
         TM    0(R2),ETYKSAIQ                                                   
         JZ    EDTLIN02                                                         
         MVI   0(R4),C'Y'                                                       
EDTLIN02 LHI   RE,1                                                             
         STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Edit expenditure type rec - Self approval allowed                   *         
***********************************************************************         
         SPACE 1                                                                
EDTSLF   LM    R2,R4,LP_AINP                                                    
         MVI   0(R4),C'N'                                                       
         TM    0(R2),ETYSFAP                                                    
         JNZ   EDTSLF02                                                         
         MVI   0(R4),C'Y'                                                       
EDTSLF02 LHI   RE,1                                                             
         STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Edit expenditure type rec - default                                 *         
***********************************************************************         
         SPACE 1                                                                
EDTDEF   LM    R2,R4,LP_AINP                                                    
         MVI   0(R4),C'N'                                                       
         TM    0(R2),X'40'                                                      
         JNZ   EDTDEF02                                                         
         MVI   0(R4),C'Y'                                                       
EDTDEF02 LHI   RE,1                                                             
         STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Edit expense account rec - Mileage analysis                         *         
***********************************************************************         
         SPACE 1                                                                
EDTMILE  LM    R2,R4,LP_AINP                                                    
         MVI   0(R4),C'N'                                                       
         TM    0(R2),RSTSMILE                                                   
         JZ    EDTMILE2                                                         
         MVI   0(R4),C'Y'                                                       
EDTMILE2 LHI   RE,1                                                             
         STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Edit expense account rec - Department analysis                      *         
***********************************************************************         
         SPACE 1                                                                
EDT2DA   LM    R2,R4,LP_AINP                                                    
         MVI   0(R4),C'N'                                                       
         TM    0(R2),RSTSEADD                                                   
         JZ    EDT2DA02                                                         
         MVI   0(R4),C'Y'                                                       
EDT2DA02 LHI   RE,1                                                             
         STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Edit expense account rec - Staff analysis                           *         
***********************************************************************         
         SPACE 1                                                                
EDT2PA   LM    R2,R4,LP_AINP                                                    
         MVI   0(R4),C'N'                                                       
         TM    0(R2),RSTSGPEI                                                   
         JZ    EDT2PA02                                                         
         MVI   0(R4),C'Y'                                                       
EDT2PA02 LHI   RE,1                                                             
         STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Edit expense account rec - Product analysis                         *         
***********************************************************************         
         SPACE 1                                                                
EDTPROA  LM    R2,R4,LP_AINP                                                    
         MVI   0(R4),C'N'                                                       
*&&UK*&& TM    0(R2),RSTSPREA                                                   
*&&UK*&& JZ    EDTPROA2                                                         
*&&US*&& TM    CPYSTAT5,CPYSEXPP                                                
*&&US*&& JZ    *+8                                                              
         MVI   0(R4),C'Y'                                                       
EDTPROA2 LHI   RE,1                                                             
         STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Edit expense account rec - Job analysis                             *         
***********************************************************************         
         SPACE 1                                                                
EDTJOBA  LM    R2,R4,LP_AINP                                                    
         MVI   0(R4),C'N'                                                       
         TM    0(R2),RSTSJREA                                                   
         JZ    EDTJOBA2                                                         
         MVI   0(R4),C'Y'                                                       
EDTJOBA2 LHI   RE,1                                                             
         STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Edit account rec - lock                                             *         
***********************************************************************         
         SPACE 1                                                                
EDTACLK  LM    R2,R4,LP_AINP                                                    
         MVI   0(R4),C'N'                                                       
         TM    0(R2),RSTSACIL                                                   
         JZ    EDTACLK2                                                         
         MVI   0(R4),C'Y'                                                       
EDTACLK2 LHI   RE,1                                                             
         STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Set GAP in BYTE4 based on RSTSTAT7                                  *         
***********************************************************************         
         SPACE 1                                                                
         EJECT                                                                  
***********************************************************************         
* Edit account rec - GAP                                              *         
***********************************************************************         
         SPACE 1                                                                
EDTGAP   LM    R2,R4,LP_AINP                                                    
         MVI   BYTE4,C' '                                                       
*&&UK*&& TM    0(R2),RSTGAPQY                                                   
*&&US*&& TM    0(R2),RSTGAPYN                                                   
         JZ    *+8                                                              
         MVI   BYTE4,C'Y'                                                       
*&&UK                                                                           
         TM    0(R2),RSTGAPQN                                                   
         JZ    *+8                                                              
         MVI   BYTE4,C'N'                                                       
*&&                                                                             
EDTGAP0  CLI   BYTE4,C' '                                                       
         JH    EDTGAP2                                                          
         L     RF,AIO4                                                          
         GOTOR SUPGAP,DMCB,(RF),BYTE4                                           
EDTGAP2  MVC   0(1,R4),BYTE4                                                    
         LHI   RE,1                                                             
         STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Edit supplier account rec - currency                                *         
***********************************************************************         
         SPACE 1                                                                
EDTCUR   LM    R2,R4,LP_AINP                                                    
         MVC   0(L'ASTCUR,R4),0(R2)                                             
         LHI   RE,L'ASTCUR                                                      
         CLI   0(R2),ASTCANY                                                    
         JNE   EDTCUR02                                                         
         MVI   0(R4),C'*'                                                       
         LHI   RE,1                                                             
EDTCUR02 STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Edit work code rec - status expense account required                *         
***********************************************************************         
         SPACE 1                                                                
EDTWCST  LM    R2,R4,LP_AINP                                                    
*&&UK                                                                           
         TM    0(R2),WCOSEABJ+WCOSEAUJ                                          
         JZ    EDTWCS06                                                         
         JNO   EDTWCS02                                                         
         MVI   0(R4),C'A'                                                       
         J     EDTWCS06                                                         
EDTWCS02 TM    0(R2),WCOSEABJ                                                   
         JZ    EDTWCS04                                                         
         MVI   0(R4),C'B'                                                       
         J     EDTWCS06                                                         
EDTWCS04 TM    0(R2),WCOSEAUJ                                                   
         JZ    EDTWCS06                                                         
         MVI   0(R4),C'U'                                                       
*&&                                                                             
EDTWCS06 LHI   RE,1                                                             
         STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Edit work code rec - status is work code locked from orders         *         
***********************************************************************         
         SPACE 1                                                                
EDTORLK  LM    R2,R4,LP_AINP                                                    
         MVI   0(R4),C'N'                                                       
*&&UK                                                                           
EDTORL02 TM    0(R2),WCOSLORD      Is wc locked from orders                     
         JZ    EDTORL06                                                         
         MVI   0(R4),C'Y'                                                       
*&&                                                                             
EDTORL06 LHI   RE,1                                                             
         STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Edit work code rec - internal vs external                           *         
***********************************************************************         
         SPACE 1                                                                
EDTINEX  LM    R2,R4,LP_AINP                                                    
                                                                                
         MVI   0(R4),C'C'                                                       
EDTINEX2 TM    0(R2),WCOSHCOE      Cost or time workcode                        
         JZ    EDTINEX4                                                         
         MVI   0(R4),C'T'                                                       
                                                                                
EDTINEX4 LHI   RE,1                                                             
         STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Edit work code rec - artist                                         *         
***********************************************************************         
         SPACE 1                                                                
EDTART   LM    R2,R4,LP_AINP                                                    
                                                                                
         MVI   0(R4),C'N'                                                       
EDTART02 TM    0(R2),WCOSART       Artist                                       
         JZ    EDTART04                                                         
         MVI   0(R4),C'Y'                                                       
                                                                                
EDTART04 LHI   RE,1                                                             
         STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Edit work code rec - estimate check                                 *         
***********************************************************************         
         SPACE 1                                                                
*&&UK                                                                           
EDTESTC  LM    R2,R4,LP_AINP                                                    
                                                                                
         MVI   0(R4),C'N'                                                       
EDTESTC2 TM    0(R2),WCOSESCK      Estimate check                               
         JZ    EDTESTC4                                                         
         MVI   0(R4),C'Y'                                                       
                                                                                
EDTESTC4 LHI   RE,1                                                             
         STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
*&&                                                                             
         EJECT                                                                  
***********************************************************************         
* Edit third party availability status                                *         
***********************************************************************         
         SPACE 1                                                                
EDTEST   LM    R2,R4,LP_AINP                                                    
         MVI   0(R4),NOQ                                                        
         TM    0(R2),EMPSTHRD                                                   
         JZ    *+8                                                              
         MVI   0(R4),YESQ                                                       
         J     EXITY                                                            
         EJECT                                                                  
*                                                                               
EDTRSTL  DS    0H                                                               
         LM    R2,R4,LP_AINP       A(INPUT,?,OUTPUT)                            
         TM    0(R2),RSTSACIL                                                   
         JZ    EXITY                                                            
         MVI   0(R4),C'Y'                                                       
         LHI   R3,1                                                             
         STCM  R3,15,LP_OLEN                                                    
         J     EXITY                                                            
*                                                                               
EDTRSTC  DS    0H                                                               
         LM    R2,R4,LP_AINP       A(INPUT,?,OUTPUT)                            
         TM    0(R2),RSTSACIC                                                   
         JZ    EXITY                                                            
         MVI   0(R4),C'Y'                                                       
         LHI   R3,1                                                             
         STCM  R3,15,LP_OLEN                                                    
         J     EXITY                                                            
*                                                                               
***********************************************************************         
* Edit HOURS FOR A PERSON                                             *         
***********************************************************************         
         SPACE 1                                                                
EDTHRS   LM    R2,R4,LP_AINP                                                    
         EDITR (P4,0(R2)),(L'DEDHRS+1,0(R4)),2,ALIGN=LEFT,FILL=0                
         LHI   R3,L'DEDHRS+1                                                    
         STCM  R3,15,LP_OLEN                                                    
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Edit electronic invoices in use flag                                *         
***********************************************************************         
         SPACE 1                                                                
EDTEINV  LM    R2,R4,LP_AINP                                                    
         MVI   0(R4),NOQ                                                        
         LHI   R3,1                                                             
         STCM  R3,15,LP_OLEN                                                    
*&&UK                                                                           
         TM    CPXSTATB,CPXELINV                                                
         JZ    EXITY                                                            
         MVI   0(R4),YESQ                                                       
*&&                                                                             
         J     EXITY                                                            
***********************************************************************         
* Clear work area (RC=A(Work area), R1=L'Work area)                   *         
***********************************************************************         
                                                                                
CLRWRK   STM   RE,R1,12(RD)                                                     
         LR    R0,RC                                                            
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
         LM    RE,R1,12(RD)                                                     
         BR    RE                                                               
                                                                                
***********************************************************************         
* VALIDATE COSTING PID                                                *         
* P1 - BINARY PID                                                     *         
***********************************************************************         
         SPACE 1                                                                
CSTPID   NTR1  LABEL=*                                                          
         J     *+12                                                             
         DC    C'*CSTPID*'                                                      
         L     R3,0(R1)                                                         
         USING PIDRECD,R2                                                       
         LA    R2,IOKEY            READ FOR PERSON RECORD                       
         XC    PIDKEY,PIDKEY                                                    
         MVI   PIDKTYP,PIDKTYPQ                                                 
         MVI   PIDKSUB,PIDKSUBQ                                                 
         MVC   PIDKCPY,CUXCPY                                                   
         MVC   PIDKPID,0(R3)                                                    
         MVI   PIDKSTYP,PIDKPERQ                                                
         MVC   CSVKEY1,IOKEY                                                    
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO1'                               
         JE    CSTPID02                                                         
         DC    H'0'                                                             
                                                                                
CSTPID02 CLC   CSVKEY1(PIDKPER-PIDRECD),IOKEY                                   
         JNE   EXITN                                                            
                                                                                
CSTPID04 MVC   DPERSON,PIDKPER                                                  
                                                                                
         J     EXITY                                                            
         DROP  R2                                                               
         EJECT                                                                  
***********************************************************************         
* PERSON DETAIL AS ACCORDING TO DATE PASSED                           *         
* P1 BYTE 1   'FF' DATE WAS CALCULATED                                *         
* P1 BYTE 2-4 A(DATE)                                                 *         
***********************************************************************         
         SPACE 1                                                                
PRSDTL   NTR1  LABEL=*                                                          
         J     *+12                                                             
         DC    CL8'*PRSDTL*'                                                    
         L     R3,0(R1)                                                         
         MVC   DDATE,0(R3)                                                      
         MVC   BYTE1,0(R1)                                                      
         USING PERRECD,R2                                                       
         LA    R2,IOKEY            READ FOR PERSON RECORD                       
         MVC   PERKEY,SPACES                                                    
         MVI   PERKTYP,PERKTYPQ                                                 
         MVC   PERKCPY,CUXCPY                                                   
         MVC   PERKCODE,DPERSON                                                 
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
         JE    PRSDTL02                                                         
         MVC   LP_ERROR,=AL2(AE$IVPER)                                          
         J     EXITN                                                            
                                                                                
PRSDTL02 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
         JE    PRSDTL04                                                         
         DC    H'0'                Fatal error                                  
                                                                                
PRSDTL04 CLI   BYTE1,0                                                          
         JE    EXITY                                                            
         L     R2,AIO1             R2=A(IO area 1)                              
         LA    R2,PERRFST                                                       
         USING EMPELD,R2                                                        
         XR    R0,R0                                                            
                                                                                
PRSDTL06 CLI   EMPEL,0                                                          
         JE    PRSDTL80                                                         
         CLI   EMPEL,EMPELQ                                                     
         JE    PRSDTL40                                                         
         CLI   EMPEL,LOCELQ                                                     
         JE    PRSDTL60                                                         
         CLI   EMPEL,PIDELQ                                                     
         JE    PRSDTL70                                                         
         CLI   EMPEL,GPNELQ                                                     
         JE    PRSDTL72                                                         
                                                                                
PRSDTL08 IC    R0,EMPLN                                                         
         AR    R2,R0                                                            
         J     PRSDTL06                                                         
                                                                                
PRSDTL40 CLC   EMPHIR,EMPTRM                                                    
         JNE   PRSDTL42                                                         
         MVC   LP_ERROR,=AL2(AE$TDBHD)                                          
         J     EXITN                                                            
PRSDTL42 CLC   DDATE,EMPHIR        VALIDATE EMPEL                               
         JNL   PRSDTL45                                                         
         CLI   BYTE1,0             WAS START DATE CALCULATED?                   
         JE    PRSDTL44                                                         
         MVC   DDATE,EMPHIR                                                     
         J     PRSDTL45                                                         
PRSDTL44 MVC   LP_ERROR,=AL2(AE$OHIRE)                                          
         J     EXITN                                                            
PRSDTL45 OC    EMPTRM,EMPTRM                                                    
         JZ    PRSDTL50                                                         
         CLC   DDATE,EMPTRM      VALIDATE EMPEL                                 
         JNH   PRSDTL50                                                         
         MVC   LP_ERROR,=AL2(AE$OHIRE)                                          
         J     EXITN                                                            
PRSDTL50 DS    0H                                                               
         J     PRSDTL08                                                         
                                                                                
         USING LOCELD,R2                                                        
PRSDTL60 CLC   DDATE,LOCSTART    FIND LOCATION FOR CURRENT DATE                 
         JL    PRSDTL08                                                         
         OC    LOCEND,LOCEND                                                    
         JZ    PRSDTL65                                                         
         CLC   DDATE,LOCEND                                                     
         JH    PRSDTL08                                                         
PRSDTL65 ST    R2,ALOCEL                                                        
         J     PRSDTL08                                                         
                                                                                
         USING PIDELD,R2                                                        
PRSDTL70 MVC   DPPID,PIDNO         EXTRACT PID                                  
         J     PRSDTL08                                                         
                                                                                
         USING GPNELD,R2                                                        
PRSDTL72 LA    RE,DPERLNA          extract names                                
         CLI   GPNTYP,GPNTLST                                                   
         JE    PRSDTL74                                                         
         LA    RE,DPERFNA                                                       
PRSDTL74 LLC   R1,GPNLN                                                         
         SHI   R1,GPNLNQ+1                                                      
         LTR   R1,R1                                                            
         JM    PRSDTL08                                                         
         BASR  RF,0                                                             
         EX    R1,4(RF)                                                         
         MVC   0(0,RE),GPNNME                                                   
         J     PRSDTL08                                                         
                                                                                
PRSDTL80 OC    ALOCEL,ALOCEL       ENSURE THIS IS SET                           
         JNZ   PRSDTL85                                                         
         MVC   LP_ERROR,=AL2(AE$IVLDT)                                          
         J     EXITN                                                            
                                                                                
PRSDTL85 OC    DPPID,DPPID                                                      
         JNZ   PRSDTL90                                                         
         MVC   LP_ERROR,=AL2(AE$NCPID)                                          
         J     EXITN                                                            
                                                                                
PRSDTL90 J     EXITY                                                            
                                                                                
         DROP  R2                                                               
         EJECT                                                                  
***********************************************************************         
* Check If Person is Locked                                           *         
*       1R Account is in AIO3 from CHKMCS call                        *         
***********************************************************************         
         SPACE 1                                                                
CHKPLK   NTR1  LABEL=*                                                          
         J     *+12                                                             
         DC    CL8'*CHKPLK*'                                                    
         L     R3,AIO3                                                          
         USING ACTRECD,R3                                                       
         LA    R3,ACTRFST                                                       
         USING RSTELD,R3                                                        
         SR    R0,R0                                                            
CKPLK002 CLI   RSTEL,0                                                          
         JE    CKPLKX                                                           
         CLI   RSTEL,RSTELQ                                                     
         JE    CKPLK006                                                         
CKPLK004 IC    R0,RSTLN                                                         
         AR    R3,R0                                                            
         J     CKPLK002                                                         
*                                                                               
CKPLK006 TM    RSTSTAT7,RSTLCKTS+RSTLCKAP                                       
         JNZ   EXITN                                                            
*                                                                               
CKPLKX   J     EXITY                                                            
         DROP  R3                                                               
         EJECT                                                                  
*&&UK                                                                           
***********************************************************************         
* Get rate for VAT account code                                       *         
***********************************************************************         
         SPACE 1                                                                
         USING ACTRECD,R2                                                       
RATACC   NTR1  LABEL=*                                                          
         J     *+12                                                             
         DC    C'*RATACC*'                                                      
*                                                                               
         CLC   DVATACT,EL_VACC     same as previous?                            
         JE    RATACC9                                                          
*                                                                               
         LA    R2,IOKEY                                                         
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKULA(2),=C'SG'                                                
         MVC   ACTKACT,EL_VACC                                                  
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JNE   RATACCX                                                          
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JNE   RATACCX                                                          
*                                                                               
         L     R2,AIO3                                                          
         LA    R3,ACTRFST                                                       
         USING RATELD,R3                                                        
         XR    R0,R0                                                            
*                                                                               
RATACC1  CLI   RATEL,0                                                          
         JE    RATACCX                                                          
         CLI   RATEL,RATEVATQ                                                   
         JE    RATACC5                                                          
         CLI   RATEL,NAMELQ                                                     
         JE    RATACC7                                                          
                                                                                
RATACC3  IC    R0,RATLN                                                         
         AR    R3,R0                                                            
         J     RATACC1                                                          
*                                                                               
RATACC5  EDITR (B2,RATRATE),(L'EL_VRAT,EL_VRAT),ALIGN=LEFT,            +        
               ZERO=NOBLANK                                                     
         MVC   DVATRTE,EL_VRAT                                                  
         MVC   DVATACT,EL_VACC                                                  
         J     RATACC3                                                          
*                                                                               
         USING NAMELD,R3                                                        
RATACC7  MVC   EL_VNAM,SPACES                                                   
         XR    R1,R1                                                            
         IC    R1,NAMLN                                                         
         SHI   R1,NAMLN1Q+1                                                     
         BASR  RF,0                                                             
         EX    R1,4(RF)                                                         
         MVC   EL_VNAM(0),NAMEREC                                               
         MVC   DVATNAM,EL_VNAM                                                  
         J     RATACC3                                                          
*                                                                               
RATACC9  MVC   EL_VRAT,DVATRTE                                                  
         MVC   EL_VACC,DVATACT                                                  
         MVC   EL_VNAM,DVATNAM                                                  
*                                                                               
RATACCX  J     EXITY                                                            
         DROP  R2,R3                                                            
         EJECT                                                                  
*&&                                                                             
***********************************************************************         
* Get rate for VAT code                                               *         
* NTRY: R1 = 0 VAT/GST CODE, Province code (PST code)                 *         
***********************************************************************         
         SPACE 1                                                                
         USING VTCD,R2                                                          
RATCOD   NTR1  LABEL=*                                                          
         J     *+12                                                             
         DC    C'*RATCOD*'                                                      
*                                                                               
         STC   R1,BYTE1                                                         
         MVC   BYTE2,EL_PSTCD      Set to PST code                              
         CLI   BYTE1,1             Is this a PST type request?                  
         JE    RATCOD0                                                          
         MVC   BYTE2,EL_VCOD       Default to VAT/GST code                      
         OC    DPRVCODE,DPRVCODE   Previous request had a province?             
         JNZ   RATCOD0             Yes then need to call VATICAN                
         CLC   DVATCODE,BYTE2      same as previous?                            
         JE    RATCOD2                                                          
*                                                                               
RATCOD0  MVC   DVATCODE,BYTE2                                                   
         L     R2,AIO3             build VATICAN call block                     
         XC    VTCD(VTCLNQ),VTCD                                                
         MVI   VTCACTN,VTCALOOK                                                 
*&&US                                                                           
         XC    DPRVCODE,DPRVCODE                                                
         CLI   CUCTRY,CTRYCAN      Is this a canadian request?                  
         JNE   *+8                                                              
         MVI   VTCACTN,VTCAILUP    For PST/GST input types                      
         CLI   BYTE1,1             Is it a PST request?                         
         JNE   RATCOD1                                                          
         MVC   DPRVCODE,EL_PROVC   Set province code                            
         MVC   VTCPRV,DPRVCODE                                                  
RATCOD1  DS    0H                                                               
*&&                                                                             
         MVC   VTCCPY,CUXCPY                                                    
         MVC   VTCOFFC,DCOFF                                                    
         MVC   VTCCOMF,ACOMFACS                                                 
         MVC   VTCINVD,D_TODAYP                                                 
         MVC   VTCTYPE,DVATCODE                                                 
         MVC   VTCCPYS1,CPYSTAT1                                                
         MVC   VTCSGOPO,DSGOP                                                   
         GOTO1 VATICAN,VTCD                                                     
         JE    *+12                                                             
         MVI   DVATCODE,C' '                                                    
         J     RATCODX                                                          
         MVC   DVATNAM,SPACES                                                   
         MVC   DVATNAM(10),VTCTTYPE                                             
         EDITR (B2,VTCRATE),(L'DVATRTE,DVATRTE),ALIGN=LEFT,            +        
               ZERO=NOBLANK                                                     
*                                                                               
RATCOD2  DS    0H                                                               
         CLI   BYTE1,1           PST CALL?                                      
         JE    RATCOD4                                                          
         MVC   EL_VCOD,DVATCODE                                                 
         MVC   EL_VRAT,DVATRTE                                                  
         MVC   EL_VNAM,DVATNAM                                                  
         J     RATCODX                                                          
*                                                                               
RATCOD4  MVC   EL_PSTCD,DVATCODE                                                
         MVC   EL_PSTRT,DVATRTE                                                 
         MVC   EL_PSTNM,DVATNAM                                                 
*                                                                               
RATCODX  J     EXITY                                                            
         DROP  R2                                                               
         EJECT                                                                  
*&&UK                                                                           
***********************************************************************         
* Test account level                                                  *         
***********************************************************************         
         SPACE 1                                                                
TSTACL   NTR1  LABEL=*                                                          
         J     *+12                                                             
         DC    C'*TSTACL*'                                                      
                                                                                
         LA    R1,DSVLVLS          SV and SX                                    
         CLC   0(2,R3),=C'SV'                                                   
         JE    TSTACL1                                                          
         LA    R1,DSXLVLS                                                       
         CLC   0(2,R3),=C'SX'                                                   
         JE    TSTACL1                                                          
         LA    R1,DSALVLS                                                       
         CLC   0(2,R3),=C'SA'      SA, SE and SQ                                
         JE    TSTACL1                                                          
         LA    R1,DSELVLS                                                       
         CLC   0(2,R3),=C'SE'                                                   
         JE    TSTACL1                                                          
         LA    R1,DSQLVLS                                                       
         CLC   0(2,R3),=C'SQ'                                                   
         JE    TSTACL1                                                          
*&&UK                                                                           
         LA    R1,DSILVLS                                                       
         CLC   0(2,R3),=C'SI'                                                   
         JE    TSTACL1                                                          
*&&                                                                             
         J     EXITN                                                            
                                                                                
TSTACL1  CLI   DSVLVLS,L'ACTKACT   any structure at all?                        
         JE    EXITN                                                            
                                                                                
TSTACL2  CLI   1(R1),L'ACTKACT     find length of last high level               
         JE    TSTACL3                                                          
         AHI   R1,1                                                             
         J     TSTACL2                                                          
                                                                                
TSTACL3  LHI   RE,L'ACTKACT                                                     
         LLC   RF,0(R1)                                                         
         SR    RE,RF                                                            
         SHI   RE,1                                                             
         AR    RF,R3                                                            
         AHI   RF,2                                                             
         BASR  R2,0                test account is low level                    
         EX    RE,8(R2)                                                         
         JNE   EXITN                                                            
         CLC   0(0,RF),SPACES                                                   
                                                                                
         LHI   RF,L'ACTKULA                                                     
         LA    R1,L'ACTKULA-1(R3)                                               
                                                                                
TSTACL4  CLI   0(R1),X'40'                                                      
         JH    TSTACL5                                                          
         SHI   R1,1                                                             
         JCT   RF,TSTACL4                                                       
         DC    H'0'                                                             
                                                                                
TSTACL5  STC   RF,DLVLLEN                                                       
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Get next low level account                                          *         
***********************************************************************         
         SPACE 1                                                                
         USING ACTRECD,R2                                                       
GETNLA   NTR1  LABEL=*                                                          
         J     *+12                                                             
         DC    C'*GETNLA*'                                                      
                                                                                
GETNLA1  LLC   R1,DLOWULA+L'DLOWULA-1                                           
         AHI   R1,1                                                             
         STC   R1,DLOWULA+L'DLOWULA-1                                           
                                                                                
         LA    R2,IOKEY                                                         
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKULA,DLOWULA                                                  
                                                                                
         MVC   CSVKEY3,IOKEY                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO3'                               
         JNE   EXITN                                                            
                                                                                
         LLC   RE,DLVLLEN                                                       
         BASR  R3,0                test account is low level                    
         EX    RE,8(R3)                                                         
         JNE   EXITN                                                            
         CLC   CSVKEY3(0),ACTKEY                                                
                                                                                
         TM    ACTKSTAT,ACTSABLP                                                
         JNZ   GETNLA2                                                          
         MVC   DLOWULA,ACTKULA                                                  
         J     GETNLA1                                                          
                                                                                
GETNLA2  TM    ACTKSTAT,ACTSCLOS+ACTSLOCK                                       
         JZ    GETNLA3                                                          
         MVC   DLOWULA,ACTKULA                                                  
         J     GETNLA1                                                          
                                                                                
GETNLA3  MVC   DLOWULA,ACTKULA                                                  
         J     EXITY                                                            
         DROP  R2                                                               
         EJECT                                                                  
*&&                                                                             
***********************************************************************         
* Get limit list data                                                 *         
* Etry: R1 - list type for MCS record                                 *         
* Exit: ELEMENT (LIDTMED,LIDTEXPD,LIDTWKCD)                           *         
* This routine uses BYTE3                                             *         
***********************************************************************         
         SPACE 1                                                                
GETLMT   NTR1  LABEL=*                                                          
         J     *+12                                                             
         DC    C'*GETLMT*'                                                      
*                                                                               
         STC   R1,BYTE3            Save MCS list type                           
         XR    R6,R6                                                            
         IC    R6,PCLILEN                                                       
         SHI   R6,1                                                             
         MVC   TEMP(L'ACTKACT),SPACES                                           
         OC    CCTPID,CCTPID                                                    
         JZ    GETLMTN                                                          
         LA    R4,ELEMEN2          List area                                    
*                                                                               
         USING LLSRECD,R2          Read list PID record for this person         
         LA    R2,IOKEY                                                         
         XC    LLSKEY,LLSKEY                                                    
         MVI   LLSKTYP,LLSKTYPQ                                                 
         MVI   LLSKSUB,LLSKSUBQ                                                 
         MVC   LLSKCPY,CUXCPY                                                   
         MVC   LLSKPIDB,CCTPID                                                  
         MVC   CSVKEY3,LLSKEY                                                   
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO1'                               
         CLC   IOKEY(LLSKGRP-LLSRECD),CSVKEY3                                   
         JNE   GETLMTN                                                          
         MVI   LL_DACS,LL_ALLQ     Set default access                           
         MVC   LL_DACS+L'LL_DACS(LL_DACLQ-L'LL_DACS),LL_DACS                    
         OI    X#LLIND,X#LLINI                                                  
         J     GETLMT04                                                         
GETLMT02 LA    R2,IOKEY                                                         
         CLC   IOKEY(LLSKGRP-LLSRECD),CSVKEY3                                   
         JE    GETLMT03                                                         
         MVC   CSVKEY3,LLSKEY          Update Save key as well                  
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO1'                               
GETLMT03 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO1'                               
                                                                                
         LA    R1,LLSKGRP-LLSRECD  Assume its a limlist record                  
         CLI   LLSKSUB,LLSKSUBQ                                                 
         JE    *+8                                                              
         LA    R1,GLSKSEQ-GLSRECD  No - Its a group record                      
         AHI   R1,-1                                                            
         BASR  R3,0                                                             
         EX    R1,8(R3)                                                         
         JNE   GETLMTY                                                          
         CLC   IOKEY(0),CSVKEY3                                                 
                                                                                
GETLMT04 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
         JE    *+6                                                              
         DC    H'0'                Bad master record                            
*                                                                               
         L     R2,AIO1                                                          
         MVC   IOKEY(L'LLSKEY),0(R2)   update IOKEY                             
         LA    R2,LLSRFST                                                       
         USING LIDELD,R2                                                        
*                                                                               
GETLMT10 CLI   LIDEL,0                                                          
         JE    GETLMT02                                                         
         CLI   LIDEL,RSTELQ                                                     
         JE    GETLMT56                                                         
         CLI   LIDEL,LIDELQ                                                     
         JNE   GETLMT12                                                         
         CLC   LIDTYPE,BYTE3                                                    
         JE    GETLMT14                                                         
*                                                                               
GETLMT12 XR    RE,RE                                                            
         IC    RE,LIDLN                                                         
         AR    R2,RE                                                            
         J     GETLMT10            Get next                                     
*                                                                               
GETLMT14 DS    0H                                                               
*&&UK                                                                           
         CLI   LIDTYPE,LIDTEXPL                                                 
         JNE   *+8                                                              
         MVI   LL_DEXPA,LL_LISTQ                                                
         CLI   LIDTYPE,LIDTMEDL                                                 
         JNE   *+8                                                              
         MVI   LL_DMEDA,LL_LISTQ                                                
         CLI   LIDTYPE,LIDTCPJL                                                 
         JNE   *+8                                                              
         MVI   LL_DCLIA,LL_LISTQ                                                
*&&                                                                             
         CLI   LIDTYPE,LIDTMEDL                                                 
         JE    GETLMT28                                                         
         CLI   LIDTYPE,LIDTCPJL                                                 
         JE    GETLMT28                                                         
         XR    RE,RE                                                            
         IC    RE,LIDLN                                                         
         SHI   RE,(LIDDATA-LIDELD)+1                                            
         JM    GETLMT12           No etypes                                     
         LA    R3,LIDDATA                                                       
ETY      USING LIDDATA,R3                                                       
GETLMT16 XR    R1,R1                                                            
         IC    R1,LIDLN                                                         
         AR    R1,R2               R1=END OF ELEMENT                            
         CR    R3,R1               CHECK R3 HASN'T OVERSHOT                     
         JNL   GETLMT12                                                         
                                                                                
GETLMT18 CLI   QAPPL,QEXPCLM                                                    
         JNE   GETLMT20                                                         
         TM    ETY.LIDLAPPL,LIDLEXPN                                            
         JNZ   GETLMT24                                                         
         J     GETLMT26                                                         
                                                                                
GETLMT20 CLI   QAPPL,QORD                                                       
         JNE   GETLMT22                                                         
         TM    ETY.LIDLAPPL,LIDLORDS                                            
         JNZ   GETLMT24                                                         
         J     GETLMT26                                                         
                                                                                
GETLMT22 CLI   QAPPL,QINV                                                       
         JE    *+6                                                              
         DC    H'0'                                                             
         TM    ETY.LIDLAPPL,LIDLINVC                                            
         JZ    GETLMT26                                                         
GETLMT24 DS    0H                                                               
*&&US                                                                           
         CLI   LIDTYPE,LIDTEXPL                                                 
         JNE   *+8                                                              
         MVI   LL_DEXPA,LL_LISTQ                                                
*&&                                                                             
         MVC   0(L'LIDLETY,R4),ETY.LIDLETY  Save etypes                         
         LA    R4,L'LIDLETY(R4)   Bump to next element                          
GETLMT26 LA    R3,LIDLLN4Q(R3)    Bump to next data entry                       
         J     GETLMT16                                                         
         DROP  ETY                                                              
*                                                                               
GETLMT28 LA    R3,LIDDATA                                                       
MED      USING LIDDATA,R3                                                       
GETLMT30 XR    R1,R1                                                            
         IC    R1,LIDLN                                                         
         AR    R1,R2               R1=END OF ELEMENT                            
         CR    R3,R1               CHECK R3 HASN'T OVERSHOT                     
         JNL   GETLMT12                                                         
                                                                                
         CLI   QAPPL,QTIME                                                      
         JNE   GETLMT32                                                         
         TM    MED.LIDLAPPL,LIDLTIME                                            
         JNZ   GETLMT46                                                         
         J     GETLMT42                                                         
                                                                                
GETLMT32 CLI   QAPPL,QEXPCLM                                                    
         JNE   GETLMT34                                                         
         TM    MED.LIDLAPPL,LIDLEXPN                                            
         JNZ   GETLMT46                                                         
         J     GETLMT42                                                         
                                                                                
GETLMT34 CLI   QAPPL,QEST                                                       
         JNE   GETLMT36                                                         
         TM    MED.LIDLAPPL,LIDLESTM                                            
         JNZ   GETLMT46                                                         
         J     GETLMT42                                                         
                                                                                
GETLMT36 CLI   QAPPL,QJOB                                                       
         JNE   GETLMT38                                                         
         TM    MED.LIDLAPPL,LIDLJOBS                                            
         JNZ   GETLMT46                                                         
         J     GETLMT42                                                         
                                                                                
GETLMT38 CLI   QAPPL,QORD                                                       
         JNE   GETLMT40                                                         
         TM    MED.LIDLAPPL,LIDLORDS                                            
         JNZ   GETLMT46                                                         
         J     GETLMT42                                                         
                                                                                
GETLMT40 CLI   QAPPL,QINV                                                       
         JE    *+6                                                              
         DC    H'0'                                                             
         TM    MED.LIDLAPPL,LIDLINVC                                            
         JNZ   GETLMT46                                                         
                                                                                
GETLMT42 CLI   LIDTYPE,LIDTCPJL                                                 
         JE    GETLMT54                                                         
         J     GETLMT48                                                         
                                                                                
GETLMT46 DS    0H                                                               
*&&US                                                                           
         CLI   LIDTYPE,LIDTMEDL                                                 
         JNE   *+8                                                              
         MVI   LL_DMEDA,LL_LISTQ                                                
         CLI   LIDTYPE,LIDTCPJL                                                 
         JNE   *+8                                                              
         MVI   LL_DCLIA,LL_LISTQ                                                
*&&                                                                             
         CLI   LIDTYPE,LIDTCPJL                                                 
         JE    GETLMT50                                                         
         GOTOR LP_AAWMP,DMCB,(L'PMDKMED,MED.LIDLMED),DMEDIND,DMEDMAXQ, +        
               LP_D                                                             
GETLMT48 LA    R3,LIDLLN3Q(R3)                                                  
         J     GETLMT30                                                         
         DROP  MED                                                              
*                                                                               
SJ       USING LIDDATA,R3                                                       
GETLMT50 BASR  RF,0                                                             
         EX    R6,4(RF)                                                         
         MVC   TEMP(0),SJ.LIDLACT                                               
         CLI   TEMP,C' '                                                        
         JNH   GETLMT52                                                         
         GOTOR LP_AAWMP,DMCB,(L'ACTKACT,TEMP),DACTIND,DACTMAXQ,        +        
               LP_D                                                             
         J     GETLMT54                                                         
                                                                                
GETLMT52 GOTOR LP_AAWMP,DMCB,(L'LIDLOFF,SJ.LIDLOFF),DOFFIND,DOFFMAXQ,  +        
               LP_D                                                             
GETLMT54 LA    R3,LIDLLN9Q(R3)                                                  
         J     GETLMT30                                                         
         DROP  SJ,R2                                                            
                                                                                
         USING RSTELD,R2                                                        
GETLMT56 CLI   RSTLN,RSTLN3Q                                                    
         JL    GETLMT12                                                         
         TM    RSTACST1,RSTAJOBS                                                
         JZ    *+8                                                              
         MVI   LL_DCLIA,LL_NONEQ                                                
         TM    RSTACST1,RSTAMED    Media code limit list                        
         JZ    *+8                                                              
         MVI   LL_DMEDA,LL_NONEQ                                                
         TM    RSTACST1,RSTAETYP   Expenditure type limit list                  
         JZ    *+8                                                              
         MVI   LL_DEXPA,LL_NONEQ                                                
         TM    RSTACST1,RSTA1NAC   Non-client limit list                        
         JZ    *+8                                                              
         MVI   LL_DNCLA,LL_NONEQ                                                
         TM    RSTACST1,RSTASTAF   1R costing account list                      
         JZ    *+8                                                              
         MVI   LL_DSTFA,LL_NONEQ                                                
         TM    RSTACST2,RSTASUPP   Supplier list                                
         JZ    *+8                                                              
         MVI   LL_DSUPA,LL_NONEQ                                                
         J     GETLMT12                                                         
                                                                                
GETLMTY  J     EXITY                                                            
                                                                                
GETLMTN  J     EXITN                                                            
         EJECT                                                                  
***********************************************************************         
* Locate an element in record pointed to by IOADDR                    *         
*                                                                     *         
* Ntry:- R1=Element code                                              *         
* Exit:- R1=A(Element) and CC=Equal if element found                  *         
*        R1=0 and CC=Not equal if element not found                   *         
***********************************************************************         
                                                                                
GETELA   LR    RF,R1               RF=Element code to search for                
         L     R1,IOADDR                                                        
         AHI   R1,ACCRFST-ACCRECD                                               
         SR    R0,R0                                                            
GETELA02 CLI   0(R1),0             Test end of record                           
         JNE   *+10                                                             
         SR    R1,R1               Yes - clear pointer address                  
         CR    RE,R1               Set CC to not equal                          
         BR    RE                                                               
         CLM   RF,1,0(R1)          Test correct element                         
         BER   RE                  Yes - exit with CC equal                     
         IC    R0,1(R1)            No - bump to next element on record          
         AR    R1,R0                                                            
         J     GETELA02                                                         
         EJECT                                                                  
***********************************************************************         
* CHECK MCS TIMESHEET USER                                            *         
* ON NTRY PARM1 BYTE 1-3 ADDRESS OF 1R ACCOUNT                        *         
***********************************************************************         
         SPACE 1                                                                
         DS    0H                                                               
CHKMCS   NTR1  BASE=*,LABEL=*                                                   
         J     *+12                                                             
         DC    CL8'*CHKMCS*'                                                    
         LAY   R4,BRATAB                                                        
         XC    0(BRATABX-BRATAB,R4),0(R4)                                       
         MVC   TEMP2,SPACES                                                     
         MVC   TEMP2(L'ACTKUNT+L'ACTKLDG),=C'1R'                                
         GOTOR (#GETACN,AGETACN)                                                
         GOTOR CHKE5EL                                                          
         LA    R2,ONERL1L                                                       
         LA    R3,4                                                             
CKMCS02  XR    RE,RE                                                            
         IC    RE,0(R2)                                                         
         SHI   RE,1                                                             
         MVC   TEMP2,SPACES                                                     
         MVC   TEMP2(L'ACTKUNT+L'ACTKLDG),=C'1R'                                
         MVC   TEMP2+L'ACTKUNT+L'ACTKLDG(0),DACT                                
         EX    RE,*-6                                                           
         GOTOR (#GETACN,AGETACN)                                                
         GOTOR CHKE5EL                                                          
         AHI   R2,1                                                             
         BCT   R3,CKMCS02                                                       
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* CHECK E5 ELEMENT                                                    *         
***********************************************************************         
         SPACE 1                                                                
         DS    0H                                                               
CHKE5EL  NTR1  BASE=*,LABEL=*                                                   
         J     *+12                                                             
         DC    CL8'*CHKE5L*'                                                    
         L     R3,AIO3                                                          
         USING ACTRECD,R3                                                       
         LA    R3,ACTRFST                                                       
         USING GDAELD,R3                                                        
         SR    R0,R0                                                            
CKE5L002 CLI   GDAEL,0                                                          
         BE    CKE5L030                                                         
         CLI   GDAEL,GDAELQ                                                     
         BE    CKE5L006                                                         
CKE5L004 IC    R0,GDALN                                                         
         AR    R3,R0                                                            
         B     CKE5L002                                                         
*                                                                               
CKE5L006 CLI   GDATYPE,GDATMCST                                                 
         BNE   CKE5L004                                                         
*                                                                               
CKE5L012 LAY   R5,BRATAB                                                        
         LHI   R0,MAXBRAQ                                                       
CKE5L014 OC    0(L'GDADATE2,R5),0(R5)                                           
         JZ    CKE5L016                                                         
         CLC   0(L'GDADATE,R5),GDADATE                                          
         JE    CKE5L016                                                         
         LA    R5,L'GDADATE2+L'GDADATE(R5)                                      
         J     CKE5L014                                                         
*                                                                               
CKE5L016 MVC   0(L'GDADATE,R5),GDADATE                                          
         MVC   L'GDADATE(L'GDADATE2,R5),GDADATE2                                
         J     CKE5L004                                                         
*                                                                               
CKE5L030 XIT1  ,                                                                
         DROP  R3                                                               
         EJECT                                                                  
***********************************************************************         
* GET CALENDAR                                                        *         
***********************************************************************         
         DS    0H                                                               
GTCAL    NTR1  LABEL=*                                                          
         J     *+12                                                             
         DC    CL8'*GTCAL**'                                                    
                                                                                
         USING CASRECD,R2                                                       
         LA    R2,IOKEY                                                         
         XC    CASKEY,CASKEY                                                    
         MVI   CASKTYP,CASKTYPQ                                                 
         MVI   CASKSUB,CASKSUBQ                                                 
         MVC   CASKCPY,CUXCPY                                                   
         MVC   CASKEMOA,DCEND                                                   
         MVC   CASKSMOA,DCDAT                                                   
         MVC   CASKOFC,D1ROFF                                                   
         MVC   CSVKEY1,CASKEY                                                   
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    GETCAL20                                                         
                                                                                
         MVC   CASKEY,CSVKEY1                                                   
         MVC   CASKOFC,SPACES                                                   
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    GETCAL20                                                         
         MVC   LP_ERROR,=AL2(AE$NOCAL)                                          
         J     EXITN                                                            
                                                                                
GETCAL20 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JE    EXITY                                                            
         DC    H'0'                FATAL ERROR                                  
         DROP  R2                                                               
         EJECT                                                                  
***********************************************************************         
* Calendar periods retrieval                                          *         
*   This routine is used to build a list of time periods using the    *         
*   company calendar                                                  *         
***********************************************************************         
         SPACE 1                                                                
CALPRDS  NTR1  BASE=*,LABEL=*                                                   
         J     *+12                                                             
         DC    C'*CALPRDS'                                                      
                                                                                
         USING CALTABD,R4                                                       
         L     R4,AGENAREA                                                      
         XC    CALENDT,CALENDT                                                  
                                                                                
         XC    DNUMPRD,DNUMPRD                                                  
         XR    RE,RE                                                            
         ICM   RE,1,CPYSFST                                                     
         JNZ   *+8                 Check to see if fiscal start set             
         AHI   RE,X'F1'            If not, set it to Jan                        
         CHI   RE,X'F0'                                                         
         BH    *+8                                                              
         AHI   RE,X'F0'-X'C0'+X'0F'                                             
         SHI   RE,X'F0'                                                         
         STC   RE,BYTE1                                                         
                                                                                
         MVC   DCDAT,QSTART                                                     
         MVC   DCDAT+1(1),BYTE1                                                 
                                                                                
         CLC   QSTART+1(1),BYTE1                                                
         BNL   CALP002                                                          
         GOTO1 VDATCON,DMCB,(1,DCDAT),(0,WORK)                                  
         GOTO1 VADDAY,DMCB,(C'Y',WORK),WORK+6,F'-1'                             
         GOTO1 VDATCON,DMCB,(0,WORK+6),(1,DCDAT)                                
                                                                                
CALP002  GOTO1 VDATCON,DMCB,(1,DCDAT),(0,WORK)                                  
         GOTO1 VADDAY,DMCB,(C'M',WORK),WORK+6,F'11'                             
         GOTO1 VDATCON,DMCB,(0,WORK+6),(1,DCEND)                                
                                                                                
CALP004  GOTOR GTCAL                                                            
         BNE   CALPRDSN                                                         
                                                                                
         USING CASRECD,R2                                                       
         USING TMPELD,R3                                                        
         MVI   BYTE1,0                                                          
         L     R2,AIO3                                                          
         LA    R3,CASRFST                                                       
         XR    R0,R0                                                            
                                                                                
CALP006  CLI   TMPEL,0                                                          
         BE    CALP022                                                          
         CLI   TMPEL,TMPELQ                                                     
         BE    CALP010                                                          
         CLI   TMPEL,TMRELQ                                                     
         BNE   CALP008                                                          
         ST    R3,FULL1                                                         
                                                                                
CALP008  IC    R0,TMPLN                                                         
         AR    R3,R0                                                            
         B     CALP006                                                          
                                                                                
CALP010  CLC   TMPSTART,QSTART     IS START DATE LOWER THAN PERIOD DATE         
         BNL   CALP012             NO - CHECK END DATE                          
         CLC   TMPEND,QSTART       IS START DATE LOWER THAN PERIOD END          
         BL    CALP008             NO - NOT INTERESTED                          
         B     CALP016                                                          
CALP012  CLC   TMPEND,QEND         IS PERIOD END DATE LOWER THAN END            
         BNH   CALP016             YES                                          
         CLC   TMPSTART,QEND       IS PERIOD START DATE HIGHER THAN END         
         BH    CALP008             YES - NOT INTERESTED                         
*                                                                               
CALP016  CLC   TMPEND,D_TODAYP     NOTHING HIGHER THAN TODAY                    
         BH    CALP008                                                          
         CLC   TMPEND,DOVRDTE      NOTHING HIGHER THAN OVERDUE                  
         BH    CALP008                                                          
         B     CALP020                                                          
*                                                                               
CALP018  CLC   TMPSTART,DOVRDTE    NOTHING HIGHER THAN OVERDUE                  
         BH    CALP008                                                          
*                                                                               
CALP020  MVC   CALENDT,TMPEND                                                   
         MVC   CALSTRT,TMPSTART                                                 
         LA    R4,CALTABL(R4)                                                   
         XR    RE,RE                                                            
         IC    RE,DNUMPRD                                                       
         AHI   RE,1                                                             
         STC   RE,DNUMPRD                                                       
         XC    CALENDT,CALENDT                                                  
         B     CALP008                                                          
*                                                                               
CALP022  L     R3,FULL1                                                         
         USING TMRELD,R3                                                        
         CLC   QEND(2),TMREND                                                   
         BNH   CALPRDSY                                                         
         DROP  R3                                                               
*                                                                               
         GOTO1 VDATCON,DMCB,(1,DCDAT),(0,WORK)                                  
         GOTO1 VADDAY,DMCB,(C'Y',WORK),WORK+6,F'1'                              
         GOTO1 VDATCON,DMCB,(0,WORK+6),(1,DCDAT)                                
         GOTO1 VDATCON,DMCB,(1,DCEND),(0,WORK)                                  
         GOTO1 VADDAY,DMCB,(C'Y',WORK),WORK+6,F'1'                              
         GOTO1 VDATCON,DMCB,(0,WORK+6),(1,DCEND)                                
         B     CALP004                                                          
*                                                                               
CALPRDSY J     EXITY                                                            
                                                                                
CALPRDSN J     EXITN                                                            
         DROP  R2                                                               
***********************************************************************         
* READ DAILY EDIT HOURS                                               *         
***********************************************************************         
         SPACE 1                                                                
RDEDT    NTR1  BASE=*,LABEL=*                                                   
         J     *+12                                                             
         DC    C'*RDEDT**'                                                      
                                                                                
         USING EDTRECD,R3                                                       
         LA    R3,IOKEY                                                         
         MVC   EDTKEY,SPACES       YES READ FOR DAY HOURS                       
         MVI   EDTKTYP,EDTKTYPQ                                                 
         MVI   EDTKSUB,EDTKSUBQ                                                 
         MVC   EDTKCPY,CUXCPY                                                   
         LA    RF,DACT                                                          
         LLC   R1,ONERL1L                                                       
         AHI   R1,-1                                                            
         MVC   EDTKOFC(0),0(RF)                                                 
         EX    R1,*-6                                                           
         AHI   R1,1                                                             
         AR    RF,R1               Bump to next spot in DACT                    
         LLC   R2,ONERL2L                                                       
         LLC   R1,ONERL1L                                                       
         SR    R2,R1                                                            
         LR    R1,R2                                                            
         AHI   R1,-1                                                            
         MVC   EDTKDPT(0),0(RF)                                                 
         EX    R1,*-6                                                           
         AHI   R1,1                                                             
         AR    RF,R1               Bump to next spot in DACT                    
         LLC   R2,ONERL3L                                                       
         LLC   R1,ONERL2L                                                       
         SR    R2,R1                                                            
         LR    R1,R2                                                            
         AHI   R1,-1                                                            
         MVC   EDTKSBD(0),0(RF)                                                 
         EX    R1,*-6                                                           
         MVC   EDTKPER,DPERSON                                                  
         MVC   EDTKYR,D_TODAYP                                                  
         MVI   EDTKSEQ,0                                                        
         MVI   EDTKKSTA,EDTKSDAY                                                
RDEDT010 MVC   CSVKEY1,EDTKEY                                                   
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         CLC   EDTKEY,CSVKEY1                                                   
         BE    RDEDT030                                                         
         MVC   EDTKEY,CSVKEY1                                                   
         LA    R2,EDTTAB                                                        
RDEDT020 CLI   0(R2),X'FF'         No Day edit hours                            
         BE    RDEDTX                                                           
         LA    RE,EDTKEY                                                        
         SR    RF,RF                                                            
         ICM   RF,3,0(R2)                                                       
         AR    RE,RF                                                            
         SR    R1,R1                                                            
         IC    R1,2(R2)                                                         
         AHI   R1,-1                                                            
         EX    R1,*+8                                                           
         B     *+10                                                             
         CLC   0(0,RE),SPACES                                                   
         BH    *+12                                                             
         LA    R2,3(R2)                                                         
         B     RDEDT020                                                         
                                                                                
         MVC   0(0,RE),SPACES                                                   
         EX    R1,*-6                                                           
         B     RDEDT010                                                         
                                                                                
RDEDT030 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
                                                                                
RDEDTX   XIT1                                                                   
         DROP  R3                                                               
                                                                                
EDTTAB   DC    AL2(EDTKPER-EDTKEY),AL1(L'EDTKPER)                               
         DC    AL2(EDTKSBD-EDTKEY),AL1(L'EDTKSBD)                               
         DC    AL2(EDTKDPT-EDTKEY),AL1(L'EDTKDPT)                               
         DC    AL2(EDTKOFC-EDTKEY),AL1(L'EDTKOFC)                               
         DC    X'FF'                                                            
         EJECT                                                                  
***********************************************************************         
* GET DAILY EDIT HOURS AND PROCESS CALDAY TABLE                       *         
***********************************************************************         
         SPACE 1                                                                
         USING CALTABD,R4                                                       
GETEDT   NTR1  BASE=*,LABEL=*                                                   
         J     *+12                                                             
         DC    C'*GETEDT*'                                                      
*                                                                               
         LR    R4,R1                                                            
         XC    CALDAYS,CALDAYS         Clear calendar days                      
*                                                                               
         USING EDTRECD,R2                                                       
         L     R2,AIO3                                                          
         CLI   EDTKTYP,EDTKTYPQ    Make sure we have a EDT Hour rec             
         BNE   GETEDTX                                                          
         CLI   EDTKSUB,EDTKSUBQ                                                 
         BNE   GETEDTX                                                          
         TM    EDTKKSTA,EDTKSDAY   By Day                                       
         BNO   GETEDTX                                                          
*                                                                               
         GOTO1 VDATCON,DMCB,(1,CALSTRT),(0,WORK)                                
         GOTO1 VGETDAY,DMCB,WORK,DUB1                                           
         CLC   DUB1(3),SPACES                                                   
         BNE   *+6                                                              
         DC    H'0'                                                             
         USING DAYTABD,RF                                                       
         LA    RF,DAYTAB                                                        
GTEDT040 CLI   0(RF),X'FF'                                                      
         BNE   *+6                                                              
         DC    H'0'                                                             
         CLC   DAY#,0(R1)                                                       
         BE    GTEDT050                                                         
         LA    RF,DAYTABLN(RF)                                                  
         B     GTEDT040                                                         
*                                                                               
GTEDT050 SR    R3,R3                                                            
         IC    R3,DAYEDT#          Get Matching Edit hour Day #                 
         STC   R3,BYTE1                                                         
         SR    R0,R0                                                            
         DROP  RF                                                               
*                                                                               
         USING CALDAYD,R3                                                       
         LAY   R3,CALDAYS                                                       
GTEDT060 CLI   0(R3),FF            End of Table?                                
         BE    GTEDT070                                                         
         GOTO1 VADDAY,DMCB,(C'D',WORK),WORK+6,(R0)                              
         GOTO1 VDATCON,DMCB,(0,WORK+6),(1,DUB)                                  
         CLC   DUB,CALENDT                                                      
         BH    GTEDT070                                                         
         SR    R1,R1                                                            
         IC    R1,BYTE1                                                         
         STC   R1,CALDAY#                                                       
         OI    CALDAY#,X'F0'                                                    
         MVC   CALDAY,DUB                                                       
         ZAP   CALHRS,PZERO                                                     
         AHI   R1,1                                                             
         CHI   R1,7                7 is the highest day                         
         BNH   *+8                                                              
         LA    R1,1                reset back to 1                              
         STC   R1,BYTE1                                                         
         LA    R3,CALLNQ(R3)                                                    
         AHI   R0,1                                                             
         B     GTEDT060                                                         
         DROP  R3                                                               
*                                                                               
GTEDT070 LA    R3,EDTRFST                                                       
GTEDT080 CLI   0(R3),0                                                          
         BE    GETEDTX                                                          
         CLI   0(R3),DEDELQ        X'54' - DAILY BUCKET ELEMENT                 
         BE    GTEDT100                                                         
GTEDT090 SR    R1,R1                                                            
         IC    R1,1(R3)                                                         
         AR    R3,R1                                                            
         B     GTEDT080                                                         
*                                                                               
         USING DEDELD,R3                                                        
         USING CALDAYD,R1                                                       
GTEDT100 LAY   R1,CALDAYS                                                       
GTEDT110 CLI   CALDAY#,0           End of data?                                 
         BE    GTEDT090                                                         
         CLI   CALDAY#,FF          End of table?                                
         BE    GTEDT090                                                         
         CLC   DEDIND,CALDAY#      Match on #                                   
         BNE   GTEDT120                                                         
         TM    DEDSTAT,DEDSPHOL+DEDSSHOL    Is this an exception?               
         BZ    *+14                                                             
         CLC   DEDDATE,CALDAY      Match on Date.                               
         BNE   GTEDT090                                                         
         ZAP   CALHRS,DEDHRS                                                    
*        B     GTEDT090                                                         
GTEDT120 LA    R1,CALLNQ(R1)                                                    
         B     GTEDT110                                                         
*                                                                               
GETEDTX  XIT1                                                                   
         DROP  R1,R2,R3,R4                                                      
*                                                                               
DAYTAB   DS    0X                                                               
         DC    AL1(1),AL1(2)                                                    
         DC    AL1(2),AL1(3)                                                    
         DC    AL1(3),AL1(4)                                                    
         DC    AL1(4),AL1(5)                                                    
         DC    AL1(5),AL1(6)                                                    
         DC    AL1(6),AL1(7)                                                    
         DC    AL1(7),AL1(1)                                                    
         DC    X'FF'                                                            
         EJECT                                                                  
***********************************************************************         
* Read 1R recs, filter against GAPLST and put to TSAR                 *         
***********************************************************************         
         SPACE 1                                                                
         USING CR_ARD,CR_BUFF                                                   
         USING GAPTABD,GAPAREA2                                                 
READ1R   NTR1  BASE=*,LABEL=*                                                   
         J     *+12                                                             
         DC    C'*READ1R*'                                                      
         MVC   CSVKEY2,IOKEY       save caller's key                            
         MVI   FSTIME,YESQ                                                      
         SR    RF,RF               1st time through, setup array dets           
         ICM   RF,7,QRA1RAA        A(1R+WC array)                               
         JNZ   *+6                                                              
         DC    H'0'                expect at least one entry...                 
         MVC   ARYNENT,LW_NUMN-LW_D(RF)  N'entries                              
         AHI   RF,LW_LN2Q                                                       
         ST    RF,ARYAENT          A(1st Array entry data)                      
         J     RD1R06                                                           
RD1R04   SR    R0,R0                                                            
         ICM   R0,3,ARYNENT                                                     
         AHI   R0,-1                                                            
         JZ    READ1RY             finished                                     
         STCM  R0,3,ARYNENT                                                     
         ICM   R0,3,ARYNTRN        increment count                              
         AHI   R0,1                                                             
         STCM  R0,3,ARYNTRN                                                     
         L     RF,ARYAENT                                                       
         AHI   RF,QRA1RAL                                                       
         ST    RF,ARYAENT                                                       
RD1R06   MVC   QRA1RO(QRA1RAL),0(RF) copy array entry data vals                 
         OC    QRAWCD,QRAWCD                                                    
         JNZ   RD1R08                                                           
         LHI   R0,AE$WCREQ         'Workcode required'                          
         STH   R0,FULL2                                                         
         J     READ1RN                                                          
                                                                                
RD1R08   LA    R0,4                N'1R levlens                                 
         LA    R1,DONERLNS                                                      
         LA    R3,QRA1RO                                                        
         LA    R4,D1RACC                                                        
         GOTOR BLDKEY              build 1R key                                 
         MVC   ACTWRK,D1RACC       save request 1R key                          
                                                                                
         CLI   QRATYP,QRATRFS      test 'Refresh' request                       
         JE    RD1R12              assume must have access                      
                                                                                
         CLI   OLIMLST,YESQ        test override LIMLIST                        
         JE    RD1R12              (set by first GAPRAC call)                   
RD1R10   GOTOR GAPRAC              else feed GAPLST entry into D1RACC           
         JNE   READ1RY             no more - finished                           
                                                                                
         USING ACTRECD,R2                                                       
RD1R12   LA    R2,IOKEY                                                         
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKUNT(2),=C'1R'                                                
         MVI   ACTKACT,X'41'       force a/c read in case ldg-lvl reqst         
         GOTOR GETLVAC,D1RACC      Get requested 1R account level...            
         LTR   R1,R1                                                            
         JZ    RD1R14              0=ledger level                               
         STC   R1,BYTE4                                                         
         MVC   ACTKACT,D1RACC                                                   
         AHI   R1,-1                                                            
         LA    RF,ONERL1L(R1)      ...then levlen                               
         IC    R1,0(RF)                                                         
RD1R14   AHI   R1,2                + C/U/L,-1 execute                           
         STC   R1,BYTE1                                                         
         MVC   CSVKEY4,ACTKEY                                                   
         MVC   CSVKEY3,SPACES                                                   
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         JE    RD1R18                                                           
         LHI   R0,AE$ACTNF         'Account not found'                          
         STH   R0,FULL2                                                         
         J     READ1RN                                                          
                                                                                
RD1R16   LA    R2,IOKEY                                                         
         MVC   ACTKEY+ACTKEND(L'ACTKEY-ACTKEND),SPACES  read high               
         MVI   ACTKEY+ACTKEND,X'FF'          for next account rec               
         MVC   CSVKEY3,ACTKEY                                                   
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
RD1R18   SR    RE,RE                                                            
         IC    RE,BYTE1                                                         
         BASR  RF,0                                                             
         CLC   ACTKEY(0),CSVKEY4   test matches request key                     
         EX    RE,0(RF)                                                         
         JE    RD1R20                                                           
                                                                                
* 'Refresh' request: File I/O is driven by 1 - n request array entries.         
* 'List' request with LIMLIST: File I/O is driven by GAPLST entries.            
* ditto without LIMLIST (or override): File I/O driven by 1 array entry         
                                                                                
*                                  Handle 'not found':                          
         CLI   QRATYP,QRATRFS      'Refresh' request:                           
         JE    READ1RY             Missing 1R a/c?                              
*                                  'List' request:                              
         CLI   OLIMLST,YESQ        Test override LIMLIST                        
         JE    READ1RY             yes - finished                               
         J     RD1R10              else continue with next GAPLST entry         
                                                                                
RD1R20   DS    0H                                                               
*&&DO                                                                           
         IC    RE,ONERL1L                                                       
         AHI   RE,-1                                                            
         BASR  RF,0                                                             
         CLC   ACTKACT(0),CSVKEY3  test change of office/1st time thru          
         EX    RE,0(RF)                                                         
         JE    RD1R22                                                           
         USING OFFALD,R1                                                        
         L     R1,AOFFAREA         test office security                         
         BASR  RF,0                                                             
         MVC   OFFAOFFC(0),ACTKACT                                              
         EX    RE,0(RF)                                                         
         MVI   OFFAACT,OFFAVAL                                                  
         GOTO1 VOFFAL              Validate office                              
         JE    RD1R22              OK                                           
                                                                                
         LHI   R0,AE$SECLK         pre-load 'security lockout' error            
         STH   R0,FULL2                                                         
         CLC   D1RACC,SPACES       test ledger-level request(=all offs)         
         JH    READ1RN             no, so no access to requested office         
                                                                                
         MVC   ACTKACT,SPACES      yes, ignore + force next office read         
         MVC   ACTKACT(L'OFFAOFFC),OFFAOFFC                                     
         SR    RE,RE                                                            
         IC    RE,ONERL1L                                                       
         LA    RE,ACTKACT(RE)                                                   
         MVI   0(RE),X'FF'                                                      
         J     RD1RNXT                                                          
*&&                                                                             
*                                                                               
         CLI   CUACCS,0            test limit access                            
         JE    RD1R22              no                                           
         MVC   BYTE3,DONEROP       offpos/length:                               
         LHI   RE,0                1-char offices                               
         TM    DONEROP,LDGOKEY2                                                 
         JZ    *+12                                                             
         LHI   RE,1                2-char offices                               
         NI    BYTE3,X'FF'-LDGOKEY2                                             
         STC   RE,BYTE2            save ex length                               
         CLI   BYTE3,0                                                          
         JH    RD1R21                                                           
         MVI   BYTE3,1             if not set: default to offpos 1              
         TM    CPYSTAT4,CPYSOFF2               set l'off from cpy sts           
         JZ    RD1R21                                                           
         LHI   RE,1                                                             
RD1R21   SR    RF,RF                                                            
         IC    RF,BYTE3            offpos                                       
         AHI   RF,-1                                                            
         LA    R3,ACTKACT(RF)      displace to offpos in key                    
         LA    R1,CSVKEY3+L'ACTKCPY+L'ACTKUNT+L'ACTKLDG(RF) ditto key           
         BASR  RF,0                                                             
         CLC   0(0,R3),0(R1)       test change of office/1st time thru          
         EX    RE,0(RF)                                                         
         JE    RD1R22                                                           
         BASR  RF,0                                                             
         CLC   0(0,R3),SPACES      test office = spaces                         
         EX    RE,0(RF)                                                         
         JNH   RD1R16              skip to next account                         
         USING OFFALD,R1                                                        
         L     R1,AOFFAREA         test office security                         
         BASR  RF,0                                                             
         MVC   OFFAOFFC(0),0(R3)                                                
         EX    RE,0(RF)                                                         
         MVI   OFFAACT,OFFAVAL                                                  
         GOTO1 VOFFAL              Validate office                              
         JE    RD1R22              OK                                           
                                                                                
         LHI   R0,AE$SECLK         pre-load 'security lockout' error            
         STH   R0,FULL2                                                         
         SR    RF,RF                                                            
         IC    RF,BYTE3            office disp                                  
         AHI   RF,-1                                                            
         LA    R1,ACTWRK(RF)       displace to office in request                
         SR    RE,RE                                                            
         IC    RE,BYTE2            ex l'office                                  
         BASR  RF,0                                                             
         CLC   0(0,R1),SPACES      test all-office request                      
         EX    RE,0(RF)                                                         
         JH    READ1RN             no, so no access to requested office         
                                                                                
         LA    R3,1(RE,R3)         bump beyond offpos in key                    
         MVI   0(R3),X'FF'         set to force next office read                
         LA    RE,ACTKACT+L'ACTKACT-1                                           
         SR    RE,R3                                                            
         AHI   RE,-2                                                            
         BASR  R1,0                                                             
         MVC   1(0,R3),SPACES      clear rest of key to spaces                  
         EX    RE,0(R1)                                                         
         J     RD1RNXT                                                          
*                                                                               
         DROP  R1                                                               
                                                                                
RD1R22   GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R2,AIO2             check location (assumes lvl 4 a/c,           
         LA    R3,ACTRFST          but doesn't matter if it isn't)              
         USING EMPELD,R3                                                        
         XR    RE,RE                                                            
RD1R24   CLI   EMPEL,0                                                          
         JE    RD1R28                                                           
         CLI   EMPEL,NAMELQ                                                     
         JNE   RD1R25                                                           
         ST    R3,FULL1            Save A(name el) for later                    
         J     RD1R26                                                           
*                                                                               
RD1R25   CLI   BYTE4,3             Ensure that it is 1R person account          
         JNH   RD1R26              XNMELD and EMPELD are both X'56'             
         CLI   EMPEL,EMPELQ                                                     
         JNE   RD1R26                                                           
         CLI   EMPCSTAT,0          Only want the current location               
         JNE   RD1RNXT             else skip it                                 
         OC    EMPTRM,EMPTRM       Any termination date?                        
         JZ    RD1R26                                                           
         CLC   D_TODAYP,EMPTRM     Has person been terminated?                  
         JNL   RD1RNXT             then get next person                         
RD1R26   IC    RE,EMPLN                                                         
         AR    R3,RE                                                            
         J     RD1R24                                                           
                                                                                
RD1R28   XC    CR_BUFF(CR_XLNQ),CR_BUFF                                         
         USING NAMELD,R3                                                        
         ICM   R3,15,FULL1         retrieve a(Namel)                            
         JZ    RD1R30              No name element?                             
         IC    RE,NAMLN                                                         
         AHI   RE,-3                                                            
         BASR  RF,0                                                             
         MVC   CR_1RNM(0),NAMEREC                                               
         EX    RE,0(RF)                                                         
RD1R30   MVC   CR_NTRN,ARYNTRN     Array entry n' in key: keeps Refresh         
*                                  Rate+1R rec seqnc, harmless for List         
         MVC   CR_1RAC,ACTKACT                                                  
         MVI   CR_ARIND,CR_ARACQ   set 'name' type rec                          
         LHI   RE,CR_NRLQ                                                       
         STH   RE,CR_LEN                                                        
         GOTOR GOTSAR,DMCB,('TSAADD',0)                                         
         JE    RD1RNXT             get next                                     
         TM    TSARERRS,TSEEOF     Test end of buffer                           
         JNZ   *+6                                                              
         DC    H'0'                Duplicate key                                
         LHI   R0,AE$MAX#                                                       
         STH   R0,FULL2                                                         
         J     READ1RN                                                          
                                                                                
RD1RNXT  CLI   QRATYP,QRATLST      test 'List' request                          
         JE    RD1R16              yes - get next                               
         J     RD1R04              else 'refresh' - get next array ntry         
                                                                                
                                                                                
READ1RN  MVC   IOKEY,CSVKEY2       restore caller's key                         
         J     EXITN                                                            
                                                                                
READ1RY  MVC   IOKEY,CSVKEY2       restore caller's key                         
         J     EXITY                                                            
                                                                                
***********************************************************************         
* Read first/next GAPLST 1R a/c entry, return entries that match      *         
* requested 1R a/c at the same or lower level.                        *         
* Feeds 1R and Rate rec I/O routines.                                 *         
* NB. 1st GAPLST entry = spaces means LIMLIST is overridden.          *         
***********************************************************************         
                                                                                
GAPRAC   NTR1  BASE=*,LABEL=*                                                   
         J     *+12                                                             
         DC    C'*GAPRAC*'                                                      
                                                                                
         CLI   FSTIME,NOQ                                                       
         MVI   FSTIME,NOQ                                                       
         JE    GRAC02                                                           
         GOTOR GETLVAC,ACTWRK      Get requested 1R account level...            
         STC   R1,ACTWRKLV         Save it                                      
         XC    GAPAREA2,GAPAREA2                                                
         MVI   GAPTDAT1,GAPTT1Q                                                 
         GOTOR (#GOATSR,AGOATSR),DMCB,('TSARDH',ATSRERRS),0,GAPAREA2,  +        
               TSARABUF                                                         
                                                                                
         CLC   GAPTACT,SPACES      test 1st GAPLST entry is blank               
         JH    GRAC04                                                           
         MVI   OLIMLST,YESQ        LIMLIST is overridden                        
         J     GAPRACY             so exit with D1RACC unchanged                
                                                                                
GRAC02   GOTOR (#GOATSR,AGOATSR),DMCB,('TSANXT',ATSRERRS),0,GAPAREA2,  +        
               TSARABUF                                                         
         JNE   GAPRACN             EOL                                          
                                                                                
GRAC04   CLI   ACTWRK,C' '         test ledger-lvl 1R request                   
         JE    GRAC06              yes - so all GAPLST entries pass             
                                                                                
* If user has 1ABC in LIMLIST and requests 1ABC00, return 1ABC00                
* If user has 1ABC00 in LIMLIST and requests 1ABC, return 1ABC00                
                                                                                
         GOTOR GETLVAC,GAPTACT     Else get GAPLST account level...             
         SR    RE,RE                                                            
         IC    RE,ACTWRKLV                                                      
         CR    RE,R1               l'request a/c vs l'GAPLST a/c                
         JL    *+6                                                              
         LR    RE,R1               use shorter l' for compare                   
         AHI   RE,-1                                                            
         LA    RF,ONERL1L(RE)      a/c levlen                                   
         IC    RE,0(RF)                                                         
         AHI   RE,-1               l'execute                                    
         BASR  RF,0                                                             
         CLC   ACTWRK(0),GAPTACT                                                
         EX    RE,0(RF)                                                         
         JNE   GRAC02                                                           
         IC    RE,ACTWRKLV                                                      
         CR    RE,R1               Return whichever a/c code...                 
         JL    GRAC06              ...is longer (lower level)                   
         MVC   D1RACC,ACTWRK                                                    
         J     GAPRACY                                                          
GRAC06   MVC   D1RACC,GAPTACT      return GAPLST 1R a/c into D1RACC             
         J     GAPRACY                                                          
                                                                                
GAPRACN  J     EXITN                                                            
GAPRACY  J     EXITY                                                            
                                                                                
***********************************************************************         
* Get charge rate hierarchy according to ranking in SRCHTBL           *         
* (SRCHTBLs copied from ACGETRATE)                                    *         
* Ntry: IOKEY=PCRKEY/PCHKEY                                           *         
* Exit: BYTE2=rank of matching SRCHTBL entry, x'FF' if not in SRCHTBL *         
***********************************************************************         
GETHIER  NTR1  BASE=*,LABEL=*                                                   
         J     *+12                                                             
         DC    C'*GETHIE*'                                                      
*&&UK                                                                           
         USING PCRRECD,R2                                                       
         LA    R2,IOKEY                                                         
         MVI   BYTE1,B'00000000'   build bit values from Rate rec key           
         CLI   PCRKPER,C' '                                                     
         JNH   GHIER02                                                          
         GOTOR GETLVAC,PCRKPER     Get 1R account level                         
         LA    RF,B'11110000'                                                   
         SLL   RF,24                                                            
         SR    RE,RE                                                            
         SLDL  RE,1                                                             
         JCT   R1,*-4                                                           
         STC   RE,BYTE1            low-order 4 bits are 1R                      
                                                                                
GHIER02  CLI   PCRKOFF,X'FF'                                                    
         JE    *+8                                                              
         OI    BYTE1,B'00010000'   set office present                           
                                                                                
         LA    RF,PCRKJOB                                                       
         CLI   CPYSTAT4,CPYSOFF2                                                
         JNE   *+8                                                              
         LA    RF,PCRKJOB2                                                      
         CLI   0(RF),X'FF'                                                      
         JE    *+8                                                              
         OI    BYTE1,B'00100000'   set SJ client present                        
                                                                                
         SR    R1,R1                                                            
         IC    R1,PCLILEN                                                       
         LA    R1,0(R1,RF)                                                      
         CLI   0(R1),X'FF'                                                      
         JE    *+8                                                              
         OI    BYTE1,B'01000000'   set SJ product present                       
                                                                                
         CLI   L'PCRKJOB(RF),X'FF'                                              
         JE    *+8                                                              
         OI    BYTE1,B'10000000'   set workcode present                         
                                                                                
         LA    RF,SRCHTBL          Match bit mask to SRCHTBL entry              
GHIER04  CLI   0(RF),0                                                          
         JE    GHIERN              Not defined in SRCHTBL, ignore               
         CLC   BYTE1,0(RF)                                                      
         JE    *+12                                                             
         AHI   RF,1                                                             
         J     GHIER04                                                          
         LA    R1,SRCHTBL                                                       
         SR    RF,R1                                                            
         STC   RF,BYTE2            return hierarchy value 0-n                   
         J     GHIERY                                                           
*&&                                                                             
*&&US                                                                           
         STC   R1,BYTE4                                                         
         CLI   BYTE4,1             test adjustment lookup                       
         JE    GHIER04             yes                                          
         USING PCHRECD,R2                                                       
         LA    R2,IOKEY                                                         
         MVI   BYTE1,0             build bit values from Rate rec key           
         CLI   PCHKDOF,C' '                                                     
         JNH   GHIER02                                                          
         GOTOR GETLVAC,WORK        Get 1R account level (squashed a/c)          
         LA    RF,B'11110000'                                                   
         SLL   RF,24                                                            
         SR    RE,RE                                                            
         SLDL  RE,1                                                             
         JCT   R1,*-4                                                           
         STC   RE,BYTE1            low-order 4 bits are 1R                      
                                                                                
GHIER02  CLI   PCHKTSK,C' '                                                     
         JNH   *+8                                                              
         OI    BYTE1,B'00010000'   set task/workcode present                    
         CLI   PCHKOFF,C' '                                                     
         JNH   *+8                                                              
         OI    BYTE1,B'00100000'   set SJ office present                        
         CLI   PCHKCLI,C' '                                                     
         JNH   *+8                                                              
         OI    BYTE1,B'01000000'   set SJ client present                        
         CLI   PCHKPRO,C' '                                                     
         JNH   *+8                                                              
         OI    BYTE1,B'10000000'   set SJ product present                       
         LAY   RF,SRCHTBL1         Match bit mask to SRCHTBL entry              
         J     GHIER10                                                          
*                                  Adjustment table hierarchy                   
         USING PAJRECD,R2                                                       
GHIER04  LA    R2,IOKEY                                                         
         MVI   BYTE1,0             build bit values from adjust rate            
         CLI   PAJKDOF,C' '                                                     
         JNH   GHIER06             no 1R off = no lower lvl acc comps           
         CLI   PAJKDEP,C' '                                                     
         JNH   GHIER06                                                          
         OI    BYTE1,B'00010000'                                                
         CLI   PAJKSUB,C' '                                                     
         JNH   GHIER06                                                          
         OI    BYTE1,B'00100000'                                                
         CLI   PAJKSTF,C' '                                                     
         JNH   GHIER06                                                          
         OI    BYTE1,B'01000000'                                                
GHIER06  CLI   PAJKTSK,C' '                                                     
         JNH   *+8                                                              
         OI    BYTE1,B'10000000'                                                
         CLI   PAJKCLI,C' '                                                     
         JNH   GHIER08             no SJ cli = no lower lvl acc comps           
         OI    BYTE1,B'00000010'                                                
         CLI   PAJKPRO,C' '                                                     
         JNH   GHIER08                                                          
         OI    BYTE1,B'00000100'                                                
         CLI   PAJKJOB,C' '                                                     
         JNH   GHIER08                                                          
         OI    BYTE1,B'00001000'                                                
GHIER08  CLI   PAJKOFF,C' '                                                     
         JNH   *+8                                                              
         OI    BYTE1,B'00000001'                                                
         LAY   RF,SRCHTBL2         Match bit mask to SRCHTBL2 entry             
                                                                                
GHIER10  CLI   0(RF),0                                                          
         JE    GHIERN              Not defined in SRCHTBL, ignore               
         CLC   BYTE1,0(RF)                                                      
         JE    *+12                                                             
         AHI   RF,1                                                             
         J     GHIER10                                                          
         LAY   R1,SRCHTBL1                                                      
         CLI   BYTE4,1             test adjustment lookup                       
         JNE   *+10                                                             
         LAY   R1,SRCHTBL2                                                      
         SR    RF,R1                                                            
         STC   RF,BYTE2            return hierarchy value 0-n                   
         J     GHIERY                                                           
*&&                                                                             
GHIERN   MVI   BYTE2,X'FF'                                                      
         J     EXITN                                                            
                                                                                
GHIERY   J     EXITY                                                            
                                                                                
***********************************************************************         
* Convert passed value to foreign currency set in QRACUR              *         
* Ntry: DUB1=agency currency value                                    *         
* Exit: DUB1=foreign currency value, or unchanged if error            *         
***********************************************************************         
*&&UK                                                                           
CONCUR   NTR1  BASE=*,LABEL=*                                                   
         J     *+12                                                             
         DC    C'*CONCUR*'                                                      
                                                                                
         CLC   QRACUR,SPACES                                                    
         JNH   CONCURY             No currency - nothing to do                  
         USING EURKBLKD,R2                                                      
         LA    R2,WORK             Get exchange rate                            
         XC    0(EURKBLKL,R2),0(R2)                                             
         MVC   EURKCUFR,CPYCURR    from agency                                  
         MVC   EURKCUTO,QRACUR     to foreign                                   
         MVC   EURKALPH,CUAALF                                                  
         MVC   EURKDATE,DCURDTC                                                 
         MVC   EURKAFAC,ACOMFACS                                                
         MVI   EURKTYPE,ACCQ                                                    
         TM    CPYSTAT6,CPYSFTXR   test agency uses FT rates                    
         JZ    *+8                                                              
         OI    EURKTYPE,ALLOWFTQ+SWAPQ                                          
         GOTO1 VEUREKA,DMCB,('GETQ',EURKBLKD)                                   
         CLI   0(R1),0                                                          
         JE    CCUR02              got rate                                     
         NI    EURKTYPE,X'FF'-SWAPQ  ...else try again                          
         GOTO1 VEUREKA,DMCB,('GETQ',EURKBLKD)                                   
         CLI   0(R1),0                                                          
         JNE   CONCURN             No rate returned - error                     
CCUR02   MVC   EURKRULE,QRARAT     Set rate passed now                          
         GOTO1 VEUREKA,DMCB,('APPLYQ',EURKBLKD),DUB1,DUB                        
         CLI   0(R1),0                                                          
         JNE   CONCURN                                                          
         ZAP   DUB1,DUB            return currency value in DUB1                
         J     CONCURY                                                          
                                                                                
CONCURN  J     EXITN                                                            
                                                                                
CONCURY  J     EXITY                                                            
         EJECT ,                                                                
                                                                                
***********************************************************************         
* Get MOA from Postman control record                                 *         
* Enty: QBATYP=Batch type                                             *         
* Exit: DUB2=Start MOA date from Postman control record.              *         
***********************************************************************         
GETMOA   NTR1  BASE=*,LABEL=*                                                   
         J     *+12                                                             
         DC    C'*GETMOA*'                                                      
*                                                                               
         XC    DUB2,DUB2                                                        
         TM    CPYSTAT3,CPYSOPBM   TEST ANY OPEN MONTH ALLOWED                  
         JZ    EXITY                                                            
*                                                                               
         LA    R2,IOKEY                                                         
         USING OCORECD,R2          READ POSTMAN CONTROL RECORD                  
         XC    OCOKEY,OCOKEY                                                    
         MVI   OCOKTYP,OCOKTYPQ                                                 
         MVC   OCOKCPY,CUXCPY                                                   
         MVC   OCOKUID,CUUSER                                                   
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JNE   GETMOA02            NO POSTMAN CONTROL RECORD                    
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JE    GETMOA04                                                         
         DC    H'0'                CAN'T READ MASTER RECORD                     
*                                                                               
         USING CPYRECD,R2          READ COMPANY RECORD                          
GETMOA02 MVC   IOKEY,SPACES                                                     
         MVC   CPYKCPY,CUXCPY                                                   
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JE    *+6                                                              
         DC    H'0'                COMPANY NOT VALID                            
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JE    *+6                                                              
         DC    H'0'                                                             
         DROP  R2                                                               
*                                                                               
GETMOA04 L     R3,AIO2                                                          
         LA    R3,CPYRFST-CPYRECD(R3)                                           
*                                                                               
         USING MSLELD,R3                                                        
GETMOA06 CLI   MSLEL,0                                                          
         JE    GETMOAX                                                          
         CLI   MSLEL,MSLELQ                                                     
         JNE   GETMOA20                                                         
*                                                                               
         LLC   RF,MSLNUM           N'SUB-ELEMENTS                               
         LA    RE,MSLVALS                                                       
         USING MSLVALS,RE                                                       
*                                                                               
GETMOA08 CLI   MSLVTYP,0           ALL (ALWAYS COMES BEFORE QBATYP)             
         JE    *+14                                                             
         CLC   MSLVTYP,QBATYP      MATCH BATCH TYPE                             
         JNE   GETMOA10                                                         
*                                                                               
         CLI   MSLVMON,X'40'       TEST LATEST MOS LOCK SET                     
         JNH   GETMOA10            NO - GET NEXT                                
         MVC   DUB2(1),D_TODAYP    SET DEFAUTL TO CURRENT YEAR                  
         TM    MSLVSEC,MSLVSXTN    TEST EXTENDED SUB-EL LENGTH                  
         JZ    *+10                                                             
         MVC   DUB2(L'MSLVYEAR),MSLVYEAR                                        
                                                                                
         MVC   DUB2+1(L'MSLVMON),MSLVMON                                        
         CLI   DUB2+1,X'F1'        TEST F1-F9 OR C1-C3                          
         JL    *+12                                                             
         NI    DUB2+1,X'0F'        F1-F9 ->01-09                                
         J     GETMOA10                                                         
         LLC   R1,DUB2+1                                                        
         LA    R0,X'C1'-X'10'                                                   
         SR    R1,R0               C1-C3 -> 10-12                               
         STC   R1,DUB2+1                                                        
         CLC   MSLVTYP,QBATYP      MOA FOR BATCH TYPE EXTRACTED                 
         JE    GETMOAX             YES - DONE                                   
*                                                                               
GETMOA10 TM    MSLVSEC,MSLVSXTN    TEST EXTENDED SUB-EL LENGTH                  
         JZ    *+12                                                             
         LA    RE,L'MSLVALS2(RE)   DIFFERENT SUB-EL LENGTH                      
         J     *+8                                                              
         LA    RE,L'MSLVALS(RE)                                                 
         BCT   RF,GETMOA08                                                      
*                                                                               
GETMOA20 LLC   RF,MSLLN                                                         
         AR    R3,RF                                                            
         J     GETMOA06                                                         
*                                                                               
GETMOAX  OC    DUB2,DUB2           ANY LOCKED MOA SET                           
         JZ    EXITY               NO                                           
         MVI   DUB2+2,1            SET TO FIRST DATE                            
         GOTOR VDATCON,DMCB,(1,DUB2),(0,WORK)                                   
         GOTO1 VADDAY,DMCB,(C'M',WORK),WORK+6,F'1'                              
         GOTOR VDATCON,DMCB,(0,WORK+6),(1,DUB2)                                 
         J     EXITY                                                            
         DROP  R3,RE                                                            
         EJECT                                                                  
*&&                                                                             
***********************************************************************         
*Build key from request key components                                *         
*Ntry:R0=n'levels,R1=A(individual levlens),R1+4=l'input key fields    *         
*     R3=A(request Key comps), R4=A(output area for key)              *         
***********************************************************************         
*                                                                               
BLDKEY   ST    RE,SAVERE           save A(return)                               
         MVC   0(L'ACTKACT,R4),SPACES                                           
         SR    RE,RE                                                            
BKEY02   ICM   RE,1,4(R1)          l'input key field                            
         JZ    BKEYX               not set - finished                           
         AHI   RE,-1                                                            
         BASR  RF,0                                                             
         CLC   0(0,R3),SPACES      test key component passed                    
         EX    RE,0(RF)                                                         
         JNH   BKEYX               empty - finished                             
         ICM   RE,1,0(R1)          key component levlen                         
         JZ    BKEYX               not set - finished                           
         AHI   RE,-1                                                            
         BASR  RF,0                                                             
         MVC   0(0,R4),0(R3)       move key comp to output area                 
         EX    RE,0(RF)                                                         
         LA    R4,1(RE,R4)         next output location                         
         IC    RE,4(R1)                                                         
         LA    R3,0(RE,R3)         next key component                           
         AHI   R1,1                next levlen/input key field length           
         JCT   R0,BKEY02                                                        
BKEYX    L     RE,SAVERE                                                        
         BR    RE                                                               
                                                                                
***********************************************************************         
*Squash spaces out of PCHKEY 1R components to match 1R acc key format *         
*Ntry:R0=n'levels,R1=A(individual levlens),R1+4=l'input key fields    *         
*     R3=A(request Key comps), R4=A(output area for key)              *         
***********************************************************************         
                                                                                
SQSH1R   ST    RE,SAVERE           save A(return)                               
         SR    RE,RE                                                            
         MVC   0(L'ACTKACT,R4),SPACES                                           
SQ1R02   ICM   RE,1,0(R1)          l'input key field                            
         JZ    SQ1RX               not set - finished                           
         AHI   RE,-1                                                            
         BASR  RF,0                                                             
         CLC   0(0,R3),SPACES      test key component passed                    
         EX    RE,0(RF)                                                         
         JNH   SQ1RX               empty - finished                             
         BASR  RF,0                                                             
         MVC   0(0,R4),0(R3)       move key comp to output area                 
         EX    RE,0(RF)                                                         
         LA    R4,1(RE,R4)                                                      
         CLI   0(R4),C' '          get rid of spaces in output                  
         JH    *+8                                                              
         JCT   R4,*-8                                                           
         AHI   R4,1                next output location                         
         LA    R3,1(RE,R3)         next key component                           
         AHI   R1,1                next levlen/input key field length           
         JCT   R0,SQ1R02                                                        
SQ1RX    L     RE,SAVERE                                                        
         BR    RE                                                               
                                                                                
***********************************************************************         
*Test key against request key components                              *         
*Ntry:BYTE1=ledger(S)J/(1)R,R0=n'levels,R1=A(individual levlens)      *         
*     R3=A(request key),R4=A(position in record key to test)          *         
*NB. Regs point to end of key/request fields                          *         
*    Works from lowest level upwards                                  *         
***********************************************************************         
                                                                                
TSTKEY   ST    RE,SAVERE           save A(return)                               
         SR    RE,RE                                                            
TKEY02   ICM   RE,1,0(R1)          key component levlen                         
         JZ    TKEYXY              not set - finished                           
         SR    R3,RE               R3=start of req key component                
         SR    R4,RE               R4=start of record key component             
         AHI   RE,-1                                                            
         BASR  RF,0                                                             
         CLC   0(0,R4),SPACES      test component exists in record key          
         EX    RE,0(RF)                                                         
         JNH   TKEYNXT             empty - next                                 
         BASR  RF,0                                                             
         CLC   0(0,R4),FFS         ditto (cli/pro)                              
         EX    RE,0(RF)                                                         
         JE    TKEYNXT             empty - next                                 
         BASR  RF,0                                                             
         CLC   0(0,R3),SPACES      test any req value set                       
         EX    RE,0(RF)                                                         
         JH    TKEY04              yes                                          
         CLI   BYTE1,C'J'          test SJ ledger                               
         JE    TKEYXN              skip pro-lvl rates for cli-lvl reqs          
         J     TKEYNXT             else 1R - continue                           
TKEY04   BASR  RF,0                                                             
         CLC   0(0,R4),0(R3)       compare req key comp = record key            
         EX    RE,0(RF)                                                         
         JNE   TKEYXN                                                           
TKEYNXT  AHI   R1,-1               next higher levlen                           
         JCT   R0,TKEY02                                                        
TKEYXY   CR    RB,RB                                                            
         J     *+6                                                              
TKEYXN   LTR   RB,RB                                                            
         L     RE,SAVERE                                                        
         BR    RE                                                               
***********************************************************************         
* Work out level of 1R account                                        *         
* Ntry: R1=A(1R account)                                              *         
* Exit: R1=level 0-4                                                  *         
***********************************************************************         
                                                                                
GETLVAC  ST    RE,SAVERE                                                        
         MVC   WORK2(L'ACTKACT),0(R1)                                           
         LA    R1,0                                                             
         CLC   WORK2(L'ACTKACT),SPACES                                          
         JNH   GETLA02             =Ledger lvl                                  
         LA    R1,1                                                             
         SR    RF,RF                                                            
         IC    RF,ONERL1L                                                       
         LA    RE,WORK2(RF)                                                     
         CLI   0(RE),C' '                                                       
         JNH   GETLA02                                                          
         LA    R1,2                                                             
         IC    RF,ONERL2L                                                       
         LA    RE,WORK2(RF)                                                     
         CLI   0(RE),C' '                                                       
         JNH   GETLA02                                                          
         LA    R1,3                                                             
         IC    RF,ONERL3L                                                       
         LA    RE,WORK2(RF)                                                     
         CLI   0(RE),C' '                                                       
         JNH   GETLA02                                                          
         LA    R1,4                                                             
GETLA02  L     RE,SAVERE                                                        
         BR    RE                                                               
         EJECT                                                                  
***********************************************************************         
* Interface to TSAR                                                   *         
* P1 = CL1 ACTION                                                     *         
*    AL3(0)                                                           *         
***********************************************************************         
                                                                                
GOTSAR   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*GOTSAR*'                                                      
                                                                                
         LR    R2,R1               R2=A(Caller's parameter list)                
TB       USING TSARD,TSARRECS      R3=A(TSAR block)                             
         LA    R1,CR_BUFF                                                       
         ST    R1,TB.TSAREC        Address of record buffer area                
         CLI   0(R2),TSAINI        Test initialisation call                     
         JNE   GOTSAR02                                                         
         XC    TB.TSARD(TSPNEWL),TB.TSARD                                       
         MVC   TB.TSACTN,0(R2)                                                  
         MVC   TB.TSACOM,ACOMFACS                                               
         LHI   R0,2*ONEK                                                        
         OC    TB.TSBUFFL,TB.TSBUFFL                                            
         JNZ   *+8                                                              
         STCM  R0,3,TB.TSBUFFL      Set require 1MB off-line                    
         MVI   TB.TSRECI,TSRXTN+TSRMINB1+TSRVAR                                 
         MVI   TB.TSKEYL,CR_AKLNQ   Set key length                              
         MVI   TB.TSINDS,TSINODSK   Set no disk writes (save/restore)           
         MVI   TB.TSIND2,TSI2MANY                                               
         LHI   R0,L'CR_BUFF                                                     
         STCM  R0,3,TB.TSRECL       Set maximum record length                   
         GOTOR VTSAR,TB.TSARD                                                   
         TM    TB.TSINDS,TSIINIOK                                               
         JNZ   EXITY                                                            
         DC    H'0'                 Initialisation failure                      
                                                                                
GOTSAR02 TM    TB.TSINDS,TSIINIOK   Test initialised                            
         JZ    GOTSAR06                                                         
                                                                                
         MVC   TB.TSACTN,0(R2)      Set action                                  
*&&DO                                                                           
         SAM31                                                                  
         CLI   TB.TSACTN,TSARDH     testing: copy tsarbuff to spare             
         JNE   GOTSAR03             ioarea to view in online minidump           
         L     R0,AIO4                                                          
         LA    R1,IOLENQ                                                        
         LR    RF,R1                                                            
         L     RE,TB.TSBUFFA                                                    
         MVCL  R0,RE                                                            
         SAM24                                                                  
GOTSAR03 DS    0H                                                               
*&&                                                                             
         CLI   TB.TSACTN,TSASRT     Test sorting                                
         JNE   GOTSAR04                                                         
         L     R1,4(R2)                                                         
         MVC   TB.TSRTPARM,0(R1)    Yes - set sort parameters                   
                                                                                
GOTSAR04 GOTOR VTSAR,TB.TSARD       Call TSAR                                   
         MVC   TSARERRS,TB.TSERRS   Return TSARERRS                             
         J     GOTSARX                                                          
                                                                                
GOTSAR06 MVI   TSARERRS,TSEEOF                                                  
                                                                                
GOTSARX  CLI   TSARERRS,0          Set condition code for caller                
         J     EXIT                                                             
         DROP  TB                                                               
         EJECT                                                                  
***********************************************************************         
* Read down supplier levels to get settings                           *         
* ON NTRY P1=A(supplier account)                                      *         
*         P2,P3=A(GAP/ACKNOWLEDGE SETTINGS)                           *         
* USES AIO4                                                                     
***********************************************************************         
         USING ACTRECD,R2                                                       
SUPGAP   NTR1  LABEL=NO,WORK=(RC,SUWORKL)                                       
         J     *+12                                                             
         DC    C'*SUPGAP*'                                                      
*                                                                               
         USING SUWORKD,RC          RC=A(local working storage)                  
         LM    R2,R3,0(R1)                                                      
         GOTOR CLRWRK,SUWORKL      Clear work area                              
         USING OB_D,SURBAREA                                                    
*                                                                               
         LA    RE,DSXLVLS                                                       
         CLC   =C'SX',ACTKULA      Only needed for suppliers                    
         JE    SUPGAP15                                                         
         LA    RE,DSVLVLS                                                       
         CLC   =C'SV',ACTKULA                                                   
         JE    SUPGAP15                                                         
*&&US                                                                           
         LA    RE,DSTLVLS                                                       
         CLC   =C'ST',ACTKULA                                                   
         JE    SUPGAP15                                                         
*&&                                                                             
         LA    RE,DSFLVLS                                                       
         CLC   =C'SF',ACTKULA                                                   
         JNE   EXITY                                                            
*                                                                               
SUPGAP15 CLI   0(RE),L'ACTKACT     If only single level no higher lvls          
         JE    EXITY                                                            
*                                                                               
* read and buffer higher levels, return combined settings.                      
         LA    R5,4                                                             
         LA    R6,L'DSVLVLS-1(RE)  Point R6 to level 4                          
*                                                                               
SUPGAP20 DS    0H                                                               
         CLI   0(R6),0                                                          
         JE    SUPGAP25                                                         
         CLI   0(R6),L'ACTKACT                                                  
         JE    SUPGAP25                                                         
         LLC   RF,0(R6)            higher-level length                          
         LA    RF,ACTKACT(RF)                                                   
         CLI   0(RF),C' '                                                       
         JH    SUPGAP30                                                         
         J     EXITY               Not a low-level acct, ignore.                
* up one level                                                                  
SUPGAP25 SHI   R6,1                                                             
         JCT   R5,SUPGAP20                                                      
         J     EXITY                                                            
*                                                                               
* CHECK WE ALREADY HAVE THIS REC IN BUFFER                                      
K        USING ACTRECD,IOKEY                                                    
SUPGAP30 MVC   K.ACTKEY,SPACES                                                  
         MVC   K.ACTKCPY,CUXCPY                                                 
         LLC   RF,0(R6)                                                         
         AHI   RF,1                +2 FOR U/L, -1 FOR EX                        
         BASR  RE,0                                                             
         MVC   K.ACTKULA(0),ACTKULA                                             
         EX    RF,0(RE)                                                         
*                                                                               
         MVC   OB_KEY(L'ACTKULA),K.ACTKULA                                      
         GOTOR GETBUF,OB_D                                                      
         JE    SUPGAP50                                                         
         JH    EXITN                                                            
*                                                                               
* NOT IN BUFFER, GO GET                                                         
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
         JNE   *+2                                                              
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
         JNE   *+2                                                              
*                                                                               
* SAVE SO WE DON'T READ AGAIN                                                   
         USING RSTELD,R1                                                        
         GOTOR GETELA,RSTELQ                                                    
         JE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLI   RSTLN,RSTLN3Q       CHECK RIGHT LENGTH ELEMENT                   
         JL    SUPGAP25                                                         
         MVC   OB_DATA(L'RSTSTAT7),RSTSTAT7                                     
         GOTOR ADDBUF,OB_D                                                      
         LA    R1,OB_DATA                                                       
         J     SUPGAP60                                                         
*                                                                               
SUPGAP50 LA    R1,RSTSTAT7                                                      
         DROP  R1                                                               
*                                                                               
SUPGAP60 DS    0H                                                               
*&&US                                                                           
         TM    0(R1),RSTGAPYN      GAP SUPPLIER CONTROLS                        
         JZ    *+8                                                              
         MVI   0(R3),YESQ                                                       
         CLI   0(R3),YESQ          GO BACK ANOTHER LVL IF STILL SOME            
         JE    EXITY                                        N'S                 
*&&                                                                             
*&&UK                                                                           
         TM    0(R1),RSTGAPQN                                                   
         JZ    *+8                                                              
         MVI   0(R3),NOQ                                                        
         TM    0(R1),RSTGAPQY      QUERY                                        
         JZ    *+8                                                              
         MVI   0(R3),YESQ                                                       
         CLI   0(R3),C' '          GO BACK ANOTHER LVL IF STILL SOME            
         JH    EXITY                                        N'S                 
*&&                                                                             
         J     SUPGAP25                                                         
         DROP  RC                                                               
                                                                                
SUWORKD  DSECT                     ** VALACT local w/s **                       
SURBAREA DS    XL(OB_LNQ)          Buffer area                                  
         ORG   SURBAREA+(OB_OTHER-OB_D)                                         
         ORG                                                                    
SUWORKL  EQU   *-SUWORKD                                                        
                                                                                
SVRDEF   CSECT ,                                                                
         EJECT                                                                  
         EJECT                                                                  
***********************************************************************         
* GLOBAL EXITS                                                        *         
***********************************************************************         
                                                                                
SETCCC   JE    *+8                 SET CONVERSE CONDITION CODE                  
         CR    RE,RE               NOT EQUAL TO EQUAL/NOT ZERO TO ZERO          
         BR    RE                                                               
         LTR   RE,RE               EQUAL TO NOT EQUAL/ZERO TO NOT ZERO          
         BR    RE                                                               
                                                                                
MORE     MVI   LP_RMODE,LP_RMORE   SET MORE TO COME                             
         J     EXITY                                                            
                                                                                
NOMORE   MVI   LP_RMODE,LP_RLAST   SET NO MORE RECORDS & EXIT                   
         J     EXITY                                                            
                                                                                
QERROR   MVI   LP_RMODE,LP_RERRR   SET REQUEST ERROR & EXIT                     
         MVI   LP_EMSYS,6                                                       
         J     EXITY                                                            
                                                                                
XERROR   MVI   LP_RMODE,LP_RERRR   SET REQUEST ERROR & EXIT                     
         MVI   LP_EMSYS,6                                                       
         STCM  R0,3,LP_ERROR                                                    
         J     EXITN                                                            
                                                                                
XERRORY  MVI   LP_RMODE,LP_RERRR   SET REQUEST ERROR & EXIT WITH CC =           
         MVI   LP_EMSYS,6                                                       
         STCM  R0,3,LP_ERROR                                                    
         J     EXITY                                                            
                                                                                
XCOLEN   XC    LP_OLEN,LP_OLEN     CLEAR OUTPUT FIELD LENGTH & EXIT             
         J     EXITY                                                            
                                                                                
EXITH    LHI   RE,2                                                             
         J     EXITCC                                                           
EXITL    DS    0H                                                               
EXITN    LHI   RE,0                SET CONDITION CODE TO NOT EQUAL              
         J     EXITCC                                                           
EXITY    LHI   RE,1                SET CONDITION CODE TO EQUAL                  
EXITCC   CHI   RE,1                                                             
                                                                                
EXIT     XIT1  ,                   GENERAL EXIT POINT                           
         EJECT                                                                  
***********************************************************************         
* LIST OF ACCOUNT FILES TO OPEN IN ALL SYSTEMS                        *         
***********************************************************************         
                                                                                
FILES    DS    0X                  ** FILE INFO **                              
         DC    C'ACCOUNT'          SYSTEM NAME FOR OPEN                         
                                                                                
         DC    C'nCTFILE '         FILE LIST                                    
         DC    C'UACCDIR '                                                      
         DC    C'UACCMST '                                                      
         DC    C'UACCARC '                                                      
         DC    C'X'                                                             
         EJECT                                                                  
***********************************************************************         
* GLOBAL LITERALS                                                     *         
***********************************************************************         
                                                                                
GLOBALS  DS    0D                                                               
                                                                                
WORKLEN  DC    AL2(((WORKL+7)/8)*8)                                             
                                                                                
***********************************************************************         
* MAP/INDICATORS TABLE                                                *         
***********************************************************************         
                                                                                
MAPTAB   DS    0XL4                                                             
                                                                                
                                                                                
MA#NARR  DC    AL2(A#NARR)         Narrative List/Display D/load                
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
                                                                                
MAPTABN  EQU   (*-MAPTAB)/L'MAPTAB                                              
                                                                                
***********************************************************************         
* DATA DICTIONARIS                                                    *         
***********************************************************************         
                                                                                
DCDICTL  DS    0X                                                               
*&&US                                                                           
         DCDDL AC#PRVC,L'AC@PRVBC                                               
         DCDDL AC#PRVAL,L'AC@PRVAL                                              
         DCDDL AC#PRVSA,L'AC@PRVSA                                              
         DCDDL AC#PRVMA,L'AC@PRVMA                                              
         DCDDL AC#PRVON,L'AC@PRVON                                              
         DCDDL AC#PRVPQ,L'AC@PRVPQ                                              
         DCDDL AC#PRVNB,L'AC@PRVNB                                              
         DCDDL AC#PRVNS,L'AC@PRVNS                                              
         DCDDL AC#PRVPE,L'AC@PRVPE                                              
         DCDDL AC#PRVNF,L'AC@PRVNF                                              
*&&                                                                             
DCDICTLX DC    X'FF'                                                            
*                                                                               
         EJECT                                                                  
PZERO    DC    P'0'                                                             
LED1N    DC    C'1N'                                                            
LED1R    DC    C'1R'                                                            
LSTNAR   DC    C'999999'                                                        
FFS      DC    32X'FF'                                                          
NONOS    DC    C'NNNNNN'                                                        
YEYES    DC    C'YYYYYY'                                                        
MANYNOS  DC    32C'N'                                                           
                                                                                
DMKEY    DC    C'DMKEY   '                                                      
ACCDIR   DC    C'ACCDIR '                                                       
ACCMST   DC    C'ACCMST '                                                       
ACCARC   DC    C'ACCARC '                                                       
CTFILE   DC    C'CTFILE '                                                       
LEDGERST DC    C'ST'                                                            
         EJECT                                                                  
***********************************************************************         
* KEY DRIVER TABLES                                                   *         
***********************************************************************         
                                                                                
SCMKEYT  LKKEY H,SCMKEY,SAVED      ** NARRATIVE RECORD KEY DRIVER **            
         LKKEY LIT,SCMKTYP,SCMKTYPQ                                             
         LKKEY SIN,SCMKCPY,QAGENCY                                              
         LKKEY RNG,SCMKCODE,QNARCOD                                             
         LKKEY LIT,SCMKSPR,X'00'                                                
         LKKEY E                                                                
                                                                                
ONAKEYT  LKKEY H,ONAKEY,SAVED      ** ORDER # ALLOC KEY DRIVER **               
         LKKEY LIT,ONAKTYP,ONAKTYPQ                                             
         LKKEY LIT,ONAKSUB,ONAKSUBQ                                             
         LKKEY SIN,ONAKCPY,QAGENCY                                              
         LKKEY LIT,ONAKSPR,X'00'                                                
         LKKEY ALL,ONAKAPP                                                      
         LKKEY WMP,ONAKCLS,QACLSS                                               
         LKKEY ALL,ONAKOFF                                                      
         LKKEY ALL,ONAKSEQ                                                      
         LKKEY E                                                                
                                                                                
PERKEYT  LKKEY H,SAPEKEY,SAVED      ** CONTROL PID KEY DRIVER **                
         LKKEY LIT,SAPETYP,SAPETYPQ                                             
         LKKEY LIT,SAPESUB,SAPESUBQ                                             
         LKKEY LIT,SAPEREST,0                                                   
         LKKEY SIN,SAPEAGY,QALPHA                                               
         LKKEY NZR,SAPEPID                                                      
         LKKEY ALL,SAPEDEF                                                      
         LKKEY E                                                                
                                                                                
PERKEYT2 LKKEY H,SAPEKEY,SAVED      **CONTROL PID KEY DRIVER WITH PID**         
         LKKEY LIT,SAPETYP,SAPETYPQ                                             
         LKKEY LIT,SAPESUB,SAPESUBQ                                             
         LKKEY LIT,SAPEREST,0                                                   
         LKKEY SIN,SAPEAGY,QALPHA                                               
         LKKEY SIN,SAPEPID,QPID                                                 
         LKKEY ALL,SAPEDEF                                                      
         LKKEY E                                                                
                                                                                
PTMKEYT  LKKEY H,PIDKEY            ** PID TEAM PASSIVE KEY DRIVER **            
         LKKEY LIT,PIDKTYP,PIDKTYPQ                                             
         LKKEY LIT,PIDKSUB,PIDKSUBQ                                             
         LKKEY SIN,PIDKCPY,QAGENCY                                              
         LKKEY LIT,PIDKREM,0                                                    
         LKKEY SIN,PIDKPID,DPPID                                                
         LKKEY LIT,PIDKSTYP,PIDKTEAQ                                            
         LKKEY ALL,PIDKNUM                                                      
         LKKEY SIN,PIDKOFF,USROFF                                               
         LKKEY LIT,PIDKREST,0                                                   
         LKKEY E                                                                
                                                                                
PRLKEYT  LKKEY H,PIDKEY            ** PID ROLE PASSIVE KEY DRIVER **            
         LKKEY LIT,PIDKTYP,PIDKTYPQ                                             
         LKKEY LIT,PIDKSUB,PIDKSUBQ                                             
         LKKEY SIN,PIDKCPY,QAGENCY                                              
         LKKEY LIT,PIDKREM,0                                                    
         LKKEY SIN,PIDKPID,DPPID                                                
         LKKEY LIT,PIDKSTYP,PIDKROLQ                                            
         LKKEY ALL,PIDKNUM                                                      
         LKKEY SIN,PIDKOFF,USROFF                                               
         LKKEY LIT,PIDKREST,0                                                   
         LKKEY E                                                                
                                                                                
TEAKEYT  LKKEY H,TEAKEY            ** TEAM KEY LIST DRIVER **                   
         LKKEY LIT,TEAKTYP,TEAKTYPQ                                             
         LKKEY LIT,TEAKSUB,TEAKSUBQ                                             
         LKKEY SIN,TEAKCPY,QAGENCY                                              
         LKKEY LIT,TEAKREM,0                                                    
         LKKEY SIN,TEAKOFF,USROFF                                               
         LKKEY WMP,TEAKNUM,DATEAM                                               
         LKKEY E                                                                
                                                                                
ROLKEYT  LKKEY H,ROLKEY            ** ROLE KEY LIST DRIVER **                   
         LKKEY LIT,ROLKTYP,ROLKTYPQ                                             
         LKKEY LIT,ROLKSUB,ROLKSUBQ                                             
         LKKEY SIN,ROLKCPY,QAGENCY                                              
         LKKEY LIT,ROLKREM,0                                                    
         LKKEY SIN,ROLKOFF,USROFF                                               
         LKKEY WMP,ROLKNUM,DAROLE                                               
         LKKEY E                                                                
                                                                                
PERCEYT  LKKEY H,PERKEY            ** PERSON (COST) LIST DRIVER **              
         LKKEY LIT,PERKTYP,PERKTYPQ                                             
         LKKEY SIN,PERKCPY,QAGENCY                                              
         LKKEY SIN,PERKCODE,QPERKCD                                             
         LKKEY LIT,PERREST,X'40'                                                
         LKKEY E                                                                
                                                                                
CPNKEYT  LKKEY H,CPNPAS            ** CAMPAIGN DETAIL DRIVER **                 
         LKKEY LIT,CPNPTYP,CPNPTYPQ                                             
         LKKEY LIT,CPNPSUB,CPNPSUBQ                                             
         LKKEY SIN,CPNPCPY,QAGENCY                                              
         LKKEY LIT,CPNPREM,0                                                    
         LKKEY SIN,CPNPCODE,D1CCAMP                                             
         LKKEY ALL,CPNPACT                                                      
         LKKEY LIT,CPNPSEQ,0                                                    
         LKKEY E                                                                
                                                                                
                                                                                
CPNKEYT2 LKKEY H,CPNPAS            ** CAMPAIGN DETAIL DRIVER **                 
         LKKEY LIT,CPNPTYP,CPNPTYPQ                                             
         LKKEY LIT,CPNPSUB,CPNPSUBQ                                             
         LKKEY SIN,CPNPCPY,QAGENCY                                              
         LKKEY LIT,CPNPREM,0                                                    
         LKKEY ALL,CPNPCODE                                                     
         LKKEY ALL,CPNPACT                                                      
         LKKEY LIT,CPNPSEQ,0                                                    
         LKKEY E                                                                
                                                                                
CPCKEYT  LKKEY H,CPCPAS            ** CAMPAIGN LIST DRIVER **                   
         LKKEY LIT,CPCPTYP,CPCPTYPQ                                             
         LKKEY LIT,CPCPSUB,CPCPSUBQ                                             
         LKKEY SIN,CPCPCPY,QAGENCY                                              
         LKKEY LIT,CPCPREM,0                                                    
         LKKEY SIN,CPCPACT,DACT                                                 
         LKKEY ALL,CPCPCAMP                                                     
         LKKEY LIT,CPCPSEQ,0                                                    
         LKKEY E                                                                
                                                                                
OFFKEYT  LKKEY H,OFFKEY            ** 2 CHAR OFFICE RECORD DRIVER **            
         LKKEY LIT,OFFKTYP,OFFKTYPQ                                             
         LKKEY SIN,OFFKCPY,QAGENCY                                              
*&&UK*&& LKKEY LIT,OFFREST,X'40'                                                
*&&US*&& LKKEY LIT,OFFKSP1,X'40'                                                
         LKKEY ALL,OFFKOFF                                                      
         LKKEY E                                                                
                                                                                
A2DKEYT  LKKEY H,ACTKEY            ** 1 CHAR OFFICE RECORD DRIVER **            
         LKKEY SIN,ACTKCPY,QAGENCY                                              
         LKKEY LIT,ACTKUNT,C'2'                                                 
         LKKEY LIT,ACTKLDG,C'D'                                                 
         LKKEY NZR,ACTKACT                                                      
         LKKEY LIT,ACTREST,X'40'                                                
         LKKEY E                                                                
                                                                                
SCHKEYT  LKKEY H,SCHKEY            ** SCHEME RECORD DRIVER **                   
         LKKEY LIT,SCHKTYP,SCHKTYPQ                                             
         LKKEY LIT,SCHKSUB,SCHKSUBQ                                             
         LKKEY SIN,SCHKCPY,QAGENCY                                              
         LKKEY LIT,SCHKUNT,C'S'                                                 
         LKKEY LIT,SCHKLDG,C'J'                                                 
         LKKEY NZR,SCHKCODE                                                     
         LKKEY LIT,SCHREST,X'00'                                                
         LKKEY E                                                                
                                                                                
ERFKEYT  LKKEY H,ERFKEY            ** REPORT FORMAT RECORD DRIVER **            
         LKKEY LIT,ERFKTYP,ERFKTYPQ                                             
         LKKEY LIT,ERFKSUB,ERFKSUBQ                                             
         LKKEY SIN,ERFKCPY,QAGENCY                                              
         LKKEY LIT,ERFKNULL,X'00'                                               
         LKKEY SIN,ERFKAPPL,QAPPL                                               
         LKKEY NZR,ERFKFRMT                                                     
         LKKEY E                                                                
                                                                                
XTLKEYT  LKKEY H,GXLIKEY           ** XTLOGIN RECORD DRIVER **                  
         LKKEY LIT,GXLIKMAJ,0                                                   
         LKKEY LIT,GXLIKMIN,0                                                   
         LKKEY LIT,GXLIKREC,GXLIRECQ                                            
         LKKEY SIN,GXLIKAGY,AGYALF                                              
         LKKEY LIT,GXLIKNUL,0                                                   
         LKKEY LIT,GXLIKSYS,ACCSYSQ                                             
         LKKEY WMP,GXLIKID,QAGXL                                                
         LKKEY E                                                                
                                                                                
PMDKEYT  LKKEY H,PMDKEY            ** REPORT FORMAT RECORD DRIVER **            
         LKKEY LIT,PMDKTYP,PMDKTYPQ                                             
         LKKEY SIN,PMDKCPY,QAGENCY                                              
         LKKEY WMP,PMDKMED,DAMED                                                
         LKKEY LIT,PMDREST,X'40'                                                
         LKKEY E                                                                
                                                                                
AC2KEYT  LKKEY H,ACTKEY            ** ACCOUNT RECORD DRIVER **                  
         LKKEY SIN,ACTKCPY,QAGENCY                                              
         LKKEY SIN,ACTKUNT,QUNLDG                                               
         LKKEY SIN,ACTKLDG,QUNLDG+L'RSFKUNT                                     
         LKKEY WMP,ACTKACT,DAACT                                                
         LKKEY LIT,ACTREST,X'40'                                                
         LKKEY E                                                                
                                                                                
RSFKEYT  LKKEY H,RSFKEY            ** FILTER VALUE NAME DRIVER **               
         LKKEY LIT,RSFKTYP,RSFKTYPQ                                             
         LKKEY SIN,RSFKCPY,QAGENCY                                              
         LKKEY SIN,RSFKUNT,QUNLDG                                               
         LKKEY SIN,RSFKLDG,QUNLDG+L'RSFKUNT                                     
         LKKEY LIT,RSFKREM1,X'40'                                               
         LKKEY LIT,RSFKACT,X'40'                                                
         LKKEY LIT,RSFKREM2,X'40'                                               
         LKKEY ALL,RSFKFLT#                                                     
         LKKEY E                                                                
                                                                                
ETYKEYT  LKKEY H,ETYKEY            ** ETYPE DRIVER **                           
         LKKEY LIT,ETYKTYP,ETYKTYPQ                                             
         LKKEY LIT,ETYKSUB,ETYKSUBQ                                             
         LKKEY SIN,ETYKCPY,QAGENCY                                              
         LKKEY LIT,ETYKREM,0                                                    
         LKKEY WMP,ETYKCODE,DAETYP                                              
         LKKEY ALL,ETYKOFFC                                                     
         LKKEY ALL,ETYKSEQ                                                      
         LKKEY E                                                                
                                                                                
CETKEYT  LKKEY H,CETPAS            ** CREDITOR ETYPE DRIVER **                  
         LKKEY LIT,CETPTYP,CETPTYPQ                                             
         LKKEY LIT,CETPSUB,CETPSUBQ                                             
         LKKEY SIN,CETPCPY,QAGENCY                                              
         LKKEY LIT,CETPREM,0                                                    
         LKKEY SIN,CETPCRED,QSUPPC                                              
         LKKEY WMP,CETPETYP,DAETYP                                              
         LKKEY ALL,CETPOFFC                                                     
         LKKEY ALL,CETPSEQ                                                      
         LKKEY E                                                                
                                                                                
CETKEYT2 LKKEY H,CETPAS            ** CREDITOR ETYPE DRIVER **                  
         LKKEY LIT,CETPTYP,CETPTYPQ                                             
         LKKEY LIT,CETPSUB,CETPSUBQ                                             
         LKKEY SIN,CETPCPY,QAGENCY                                              
         LKKEY LIT,CETPREM,0                                                    
         LKKEY LIT,CETPCRED,X'40'                                               
         LKKEY WMP,CETPETYP,DAETYP                                              
         LKKEY ALL,CETPOFFC                                                     
         LKKEY ALL,CETPSEQ                                                      
         LKKEY E                                                                
                                                                                
WCOKEYT  LKKEY H,WCOKEY            ** WORK CODE DRIVER **                       
         LKKEY LIT,WCOKTYP,WCOKTYPQ                                             
         LKKEY SIN,WCOKCPY,QAGENCY                                              
         LKKEY LIT,WCOKUNT,C'S'                                                 
         LKKEY LIT,WCOKLDG,C'J'                                                 
         LKKEY SIN,WCOKWRK,EL_WRKCD                                             
         LKKEY LIT,WCOREST,X'40'                                                
         LKKEY E                                                                
                                                                                
WC2KEYT  LKKEY H,WCOKEY            ** WORK CODE DRIVER **                       
         LKKEY LIT,WCOKTYP,WCOKTYPQ                                             
         LKKEY SIN,WCOKCPY,QAGENCY                                              
         LKKEY LIT,WCOKUNT,C'S'                                                 
         LKKEY LIT,WCOKLDG,C'J'                                                 
         LKKEY WMP,WCOKWRK,DAACT                                                
         LKKEY LIT,WCOREST,X'40'                                                
         LKKEY E                                                                
                                                                                
ACTKEYT  LKKEY H,ACTKEY            ** 1 CHAR OFFICE RECORD DRIVER **            
         LKKEY SIN,ACTKCPY,QAGENCY                                              
         LKKEY RNG,ACTKULA,EL_ULA                                               
         LKKEY LIT,ACTREST,X'40'                                                
         LKKEY E                                                                
                                                                                
STUKEYT  LKKEY H,STUKEY,SAVED      ** NARRATIVE RECORD KEY DRIVER **            
         LKKEY LIT,STUKTYP,STUKTYPQ                                             
         LKKEY LIT,STUKSUB,STUKSUBQ                                             
         LKKEY SIN,STUKCPY,QAGENCY                                              
         LKKEY ALL,STUKCODE                                                     
         LKKEY E                                                                
                                                                                
         EJECT                                                                  
                                                                                
         LTORG ,                                                                
***********************************************************************         
* OTHER LITERALS AND DECLARATIONS                                     *         
***********************************************************************         
                                                                                
PERBLIT  DC    C'Person code (Bin)'                                             
TESTLIT  DC    C'Test activated'                                                
APPLLIT  DC    C'Application filter'                                            
OTYPLIT  DC    C'Order type filter'                                             
NAPPLIT  DC    C'Application(s) filter'                                         
CLSSLIT  DC    C'Class filter'                                                  
NCODLIT  DC    C'Narrative code (List=No)'                                      
NLANLIT  DC    C'Language filter (F/N/A)'                                       
NFLTLIT  DC    C'Filter'                                                        
NOFFLIT  DC    C'Office code'                                                   
NCLILIT  DC    C'Client code'                                                   
NPROLIT  DC    C'Product code'                                                  
NWRKLIT  DC    C'Work code'                                                     
CAMCLIT  DC    C'Campaign number'                                               
INITLIT  DC    C'Initial'                                                       
EXTNLIT  DC    C'Extension'                                                     
PINPLIT  DC    C'PIN person code'                                               
PERCLIT  DC    C'Accounting person code'                                        
NAMCLIT  DC    C'Name and pid only'                                             
SREPLIT  DC    C'Suppress my reports'                                           
SLOCLIT  DC    C'Suppress locations'                                            
STEALIT  DC    C'Suppress teams'                                                
SROLLIT  DC    C'Suppress roles'                                                
OVERLIT  DC    C'Inc overdue t/s'                                               
HTTP     DC    C'HTTP://'                                                       
                                                                                
*&&UK                                                                           
SUPLDG   DC    C'SVSX'                                                          
*&&                                                                             
*&&US                                                                           
SUPLDG   DC    C'SVSXSYSW'                                                      
*&&                                                                             
SUPLDGX  DC    X'FF'                                                            
                                                                                
LVALUES  DS    0F                  ** LITERALS MOVED TO SAVED **                
         DC    A(ONAKF)                                                         
         DC    A(OFFKF)                                                         
         DC    A(A2DKF)                                                         
         DC    A(CLIKF)                                                         
         DC    A(CLIRF)                                                         
         DC    A(ACTKF)                                                         
         DC    A(ACTRF)                                                         
         DC    A(WCKF)                                                          
         DC    A(WCRF)                                                          
         DC    A(SCHKF)                                                         
         DC    A(SCHRF)                                                         
         DC    A(RSFKF)                                                         
         DC    A(ERFKF)                                                         
         DC    A(ERFRF)                                                         
         DC    A(SCMKF)                                                         
         DC    A(SCMRF)                                                         
         DC    A(ETYKF)                                                         
         DC    V(ACGETCRL)                                                      
         EJECT                                                                  
                                                                                
*                                                                               
CPXTAB   DC    0XL3                                                             
                                                                                
         DC    AL1(LL_DCLIA-LL_DACS)                                            
         DC    AL1(CPXSTAT3-CPXELD)                                             
         DC    AL1(CPXAJOBS)                                                    
                                                                                
         DC    AL1(LL_DMEDA-LL_DACS)                                            
         DC    AL1(CPXSTAT3-CPXELD)                                             
         DC    AL1(CPXAMED)                                                     
                                                                                
         DC    AL1(LL_DEXPA-LL_DACS)                                            
         DC    AL1(CPXSTAT3-CPXELD)                                             
         DC    AL1(CPXAETYP)                                                    
                                                                                
         DC    AL1(LL_DNCLA-LL_DACS)                                            
         DC    AL1(CPXSTAT3-CPXELD)                                             
         DC    AL1(CPXA1NAC)                                                    
                                                                                
         DC    AL1(LL_DSTFA-LL_DACS)                                            
         DC    AL1(CPXSTAT3-CPXELD)                                             
         DC    AL1(CPXASTAF)                                                    
                                                                                
         DC    AL1(LL_DWCA-LL_DACS)                                             
         DC    AL1(CPXSTAT3-CPXELD)                                             
         DC    AL1(CPXAWC)                                                      
                                                                                
         DC    AL1(LL_DREPA-LL_DACS)                                            
         DC    AL1(CPXSTAT3-CPXELD)                                             
         DC    AL1(CPXAREPF)                                                    
                                                                                
         DC    AL1(LL_DESTA-LL_DACS)                                            
         DC    AL1(CPXSTAT3-CPXELD)                                             
         DC    AL1(CPXASCHM)                                                    
                                                                                
         DC    AL1(LL_DSUPA-LL_DACS)                                            
         DC    AL1(CPXSTAT4-CPXELD)                                             
         DC    AL1(CPXASUPP)                                                    
                                                                                
CPXTABN  EQU   (*-CPXTAB)/L'CPXTAB                                              
                                                                                
BRATAB   DS    0X                                                               
         DC    (MAXBRAQ)XL3'00'                                                 
BRATABX  DC    X'FF'                                                            
MAXBRAQ  EQU   20                                                               
*                                                                               
CALDAYS  DC    XL160'00'           Days/Hours per period                        
         DC    X'FF'                                                            
                                                                                
*&&US                                                                           
***********************************************************************         
* PROVINCE CODE/NAME TABLE                                            *         
***********************************************************************         
                                                                                
PRVTAB   DS    0C                                                               
         DC    C'BC',AL2(AC@PRVBC-DSDICTL)   BRITISH COLUMBIA                   
         DC    AL1(L'AC@PRVBC)                                                  
         DC    C'AL',AL2(AC@PRVAL-DSDICTL)   ALBERTA                            
         DC    AL1(L'AC@PRVAL)                                                  
         DC    C'SA',AL2(AC@PRVSA-DSDICTL)   SASKATCHEWAN                       
         DC    AL1(L'AC@PRVSA)                                                  
         DC    C'MA',AL2(AC@PRVMA-DSDICTL)   MANITOBA                           
         DC    AL1(L'AC@PRVMA)                                                  
         DC    C'ON',AL2(AC@PRVON-DSDICTL)   ONTARIO                            
         DC    AL1(L'AC@PRVON)                                                  
         DC    C'PQ',AL2(AC@PRVPQ-DSDICTL)   QUEBEC                             
         DC    AL1(L'AC@PRVPQ)                                                  
         DC    C'NB',AL2(AC@PRVNB-DSDICTL)   NEW BRUNSWICK                      
         DC    AL1(L'AC@PRVNB)                                                  
         DC    C'NS',AL2(AC@PRVNS-DSDICTL)   NOVA SCOTIA                        
         DC    AL1(L'AC@PRVNS)                                                  
         DC    C'PE',AL2(AC@PRVPE-DSDICTL)   PRINCE EDWARD ISLAND               
         DC    AL1(L'AC@PRVPE)                                                  
         DC    C'NF',AL2(AC@PRVNF-DSDICTL)   NEWFOUNDLAND                       
         DC    AL1(L'AC@PRVNF)                                                  
PRVTABN  EQU   (*-PRVTAB)/PRVTABL                                               
         DC    X'FF'               EOT                                          
*&&                                                                             
                                                                                
***********************************************************************         
* RATE SEARCH TABLES FROM ACGETRATE                                   *         
***********************************************************************         
         SPACE 1                                                                
*&&UK                                                                           
SRCHTBL  DS    0XL1                                                             
         DC    B'11111111'     W-C/PROD/CLI/OFF/D/C/B/A                         
         DC    B'01111111'         PROD/CLI/OFF/D/C/B/A                         
         DC    B'01101111'         PROD/CLI     D/C/B/A                         
         DC    B'10111111'     W-C      CLI/OFF/D/C/B/A                         
         DC    B'10101111'     W-C      CLI     D/C/B A                         
         DC    B'00111111'              CLI/OFF/D/C/B/A                         
         DC    B'00101111'              CLI     D/C/B/A                         
         DC    B'10011111'     W-C          OFF/D/C/B/A                         
         DC    B'00011111'                  OFF/D/C/B/A                         
         DC    B'10001111'     W-C              D/C/B/A                         
         DC    B'00001111'                      D/C/B/A                         
         DC    B'11110111'     W-C/PROD/CLI/OFF   C/B/A                         
         DC    B'11100111'     W-C/PROD/CLI       C/B/A                         
         DC    B'01110111'         PROD/CLI/OFF   C/B/A                         
         DC    B'01100111'         PROD/CLI       C/B/A                         
         DC    B'10110111'     W-C      CLI/OFF   C/B/A                         
         DC    B'10100111'     W-C      CLI       C/B A                         
         DC    B'00110111'              CLI/OFF   C/B/A                         
         DC    B'00100111'              CLI       C/B/A                         
         DC    B'10010111'     W-C          OFF   C/B/A                         
         DC    B'00010111'                  OFF   C/B/A                         
         DC    B'10000111'     W-C                C/B/A                         
         DC    B'00000111'                        C/B/A                         
         DC    B'11110011'     W-C/PROD/CLI/OFF     B/A                         
         DC    B'11100011'     W-C/PROD/CLI         B/A                         
         DC    B'01110011'         PROD/CLI/OFF     B/A                         
         DC    B'01100011'         PROD/CLI         B/A                         
         DC    B'10110011'     W-C      CLI/OFF     B/A                         
         DC    B'10100011'     W-C      CLI         B/A                         
         DC    B'00110011'              CLI/OFF     B/A                         
         DC    B'00100011'              CLI         B/A                         
         DC    B'10010011'     W-C          OFF     B/A                         
         DC    B'00010011'                  OFF     B/A                         
         DC    B'10000011'     W-C                  B/A                         
         DC    B'00000011'                          B/A                         
         DC    B'11110001'     W-C/PROD/CLI/OFF       A                         
         DC    B'11100001'     W-C/PROD/CLI           A                         
         DC    B'01110001'         PROD/CLI/OFF       A                         
         DC    B'10110001'     W-C      CLI/OFF       A                         
         DC    B'10100001'     W-C      CLI           A                         
         DC    B'00110001'              CLI/OFF       A                         
         DC    B'00100001'              CLI           A                         
         DC    B'10010001'     W-C          OFF       A                         
         DC    B'00010001'                  OFF       A                         
         DC    B'10000001'     W-C                    A                         
         DC    B'00000001'                            A                         
         DC    B'11110000'     W-C/PROD/CLI/OFF                                 
         DC    B'11100000'     W-C/PROD/CLI                                     
         DC    B'01110000'         PROD/CLI/OFF                                 
         DC    B'10110000'     W-C      CLI/OFF                                 
         DC    B'10100000'     W-C      CLI                                     
         DC    B'00100000'              CLI                                     
         DC    B'00110000'              CLI/OFF                                 
         DC    B'10010000'     W-C          OFF                                 
         DC    B'00010000'                  OFF                                 
         DC    B'10000000'     W-C                                              
         DC    X'00'           E-O-T POSSIBLE SEARCHES                          
*&&                                                                             
*&&US                                                                           
SRCHTBL1 DS    0XL1                                                             
         DC    B'11111111'     PRO/CLI/OFF/TASK/STF/SUB/DEP/OFF                 
         DC    B'11101111'     PRO/CLI/OFF      STF/SUB/DEP/OFF                 
         DC    B'01111111'         CLI/OFF/TASK/STF/SUB/DEP/OFF                 
         DC    B'01101111'         CLI/OFF      STF/SUB/DEP/OFF                 
         DC    B'00111111'             OFF/TASK/STF/SUB/DEP/OFF                 
         DC    B'00101111'             OFF      STF/SUB/DEP/OFF                 
         DC    B'00011111'                 TASK/STF/SUB/DEP/OFF                 
         DC    B'00001111'                      STF/SUB/DEP/OFF                 
         DC    B'11110111'     PRO/CLI/OFF/TASK     SUB/DEP/OFF                 
         DC    B'11100111'     PRO/CLI/OFF          SUB/DEP/OFF                 
         DC    B'01110111'         CLI/OFF/TASK     SUB/DEP/OFF                 
         DC    B'01100111'         CLI/OFF          SUB/DEP/OFF                 
         DC    B'00110111'             OFF/TASK     SUB/DEP/OFF                 
         DC    B'00100111'             OFF          SUB/DEP/OFF                 
         DC    B'00010111'                 TASK     SUB/DEP/OFF                 
         DC    B'00000111'                          SUB/DEP/OFF                 
         DC    B'11110011'     PRO/CLI/OFF/TASK         DEP/OFF                 
         DC    B'11100011'     PRO/CLI/OFF              DEP/OFF                 
         DC    B'01110011'         CLI/OFF/TASK         DEP/OFF                 
         DC    B'01100011'         CLI/OFF              DEP/OFF                 
         DC    B'00110011'             OFF/TASK         DEP/OFF                 
         DC    B'00100011'             OFF              DEP/OFF                 
         DC    B'00010011'                 TASK         DEP/OFF                 
         DC    B'00000011'                              DEP/OFF                 
         DC    B'11110001'     PRO/CLI/OFF/TASK             OFF                 
         DC    B'11100001'     PRO/CLI/OFF                  OFF                 
         DC    B'01110001'         CLI/OFF/TASK             OFF                 
         DC    B'01100001'         CLI/OFF                  OFF                 
         DC    B'00110001'             OFF/TASK             OFF                 
         DC    B'00100001'             OFF                  OFF                 
         DC    B'00010001'                 TASK             OFF                 
         DC    B'00000001'                                  OFF                 
         DC    X'00'                                                            
                                                                                
SRCHTBL2 DS    0XL1                                                             
         DC    B'11111111'     TASK/STF/SUB/DEP/JOB/PRO/CLI/OFF                 
         DC    B'01111111'          STF/SUB/DEP/JOB/PRO/CLI/OFF                 
         DC    B'10111111'     TASK     SUB/DEP/JOB/PRO/CLI/OFF                 
         DC    B'00111111'              SUB/DEP/JOB/PRO/CLI/OFF                 
         DC    B'10011111'     TASK         DEP/JOB/PRO/CLI/OFF                 
         DC    B'00011111'                  DEP/JOB/PRO/CLI/OFF                 
         DC    B'10001111'     TASK             JOB/PRO/CLI/OFF                 
         DC    B'00001111'                      JOB/PRO/CLI/OFF                 
         DC    B'11110111'     TASK/STF/SUB/DEP     PRO/CLI/OFF                 
         DC    B'01110111'          STF/SUB/DEP     PRO/CLI/OFF                 
         DC    B'10110111'     TASK     SUB/DEP     PRO/CLI/OFF                 
         DC    B'00110111'              SUB/DEP     PRO/CLI/OFF                 
         DC    B'10010111'     TASK         DEP     PRO/CLI/OFF                 
         DC    B'00010111'                  DEP     PRO/CLI/OFF                 
         DC    B'10000111'     TASK                 PRO/CLI/OFF                 
         DC    B'00000111'                          PRO/CLI/OFF                 
         DC    B'11110011'     TASK/STF/SUB/DEP         CLI/OFF                 
         DC    B'01110011'          STF/SUB/DEP         CLI/OFF                 
         DC    B'10110011'     TASK     SUB/DEP         CLI/OFF                 
         DC    B'00110011'              SUB/DEP         CLI/OFF                 
         DC    B'10010011'     TASK         DEP         CLI/OFF                 
         DC    B'00010011'                  DEP         CLI/OFF                 
         DC    B'10000011'     TASK                     CLI/OFF                 
         DC    B'00000011'                              CLI/OFF                 
         DC    B'11110001'     TASK/STF/SUB/DEP             OFF                 
         DC    B'01110001'          STF/SUB/DEP             OFF                 
         DC    B'10110001'     TASK     SUB/DEP             OFF                 
         DC    B'00110001'              SUB/DEP             OFF                 
         DC    B'10010001'     TASK         DEP             OFF                 
         DC    B'00010001'                  DEP             OFF                 
         DC    B'10000001'     TASK                         OFF                 
         DC    B'00000001'                                  OFF                 
         DC    B'11110000'     TASK/STF/SUB/DEP                                 
         DC    B'01110000'          STF/SUB/DEP                                 
         DC    B'10110000'     TASK     SUB/DEP                                 
         DC    B'00110000'              SUB/DEP                                 
         DC    B'10010000'     TASK         DEP                                 
         DC    B'00010000'                  DEP                                 
         DC    B'10000000'     TASK                                             
         DC    B'00000000'                                     AGY              
SRCH2N   EQU   *-SRCHTBL2                                                       
*&&                                                                             
       ++INCLUDE ACURLTAB                                                       
*                                                                               
B#NICREC EQU   3                   IO2                                          
B#LLSREC EQU   3                   IO2                                          
B#GXL    EQU   3                   IO2                                          
B#ONAREC EQU   3                   IO2                                          
B#SCMREC EQU   3                   IO2                                          
B#ROLE   EQU   3                   IO2                                          
B#TEAM   EQU   3                   IO2                                          
B#OFFREC EQU   3                   IO2                                          
B#SCHEME EQU   3                   IO2                                          
B#ERFREC EQU   3                   IO2                                          
B#MEDREC EQU   3                   IO2                                          
B#FNVREC EQU   3                   IO2                                          
B#ETYREC EQU   3                   IO2                                          
B#PCRREC EQU   3                   IO2                                          
B#PCHREC EQU   3                   IO2                                          
B#STUREC EQU   3                   IO2                                          
B#PID    EQU   4                   IO3                                          
B#SAPREC EQU   5                   IO4                                          
B#CAMREC EQU   5                   IO4                                          
B#ACTREC EQU   5                   IO4                                          
B#WCREC  EQU   5                   IO4                                          
B#PERREC EQU   6                   IO5                                          
B#EDTREC EQU   4                   IO3                                          
B#LINMGR EQU   8                   BKLINMGR - BUFFERED LINE MANAGER             
B#COBLCK EQU   9                   COBLOCK                                      
B#SVRDEF EQU   10                  ACBRA26                                      
ASERVER  EQU   LP_BLKS+((B#SVRDEF-1)*L'LP_BLKS)                                 
B#LP_D   EQU   11                  LP_D                                         
                                                                                
EOR      EQU   0                                                                
                                                                                
         EJECT                                                                  
***********************************************************************         
* DSECT TO COVER SAVED STORAGE                                        *         
***********************************************************************         
                                                                                
SAVED    DSECT ,                                                                
                                                                                
WVALUES  DS    0X                  ** LITERAL VALUES **                         
                                                                                
ADCONS   DS    0A                  ** RELOCATED ADDRESS CONSTANTS **            
AONAKF   DS    A                   A(ONAKF)                                     
AOFFKF   DS    A                   A(OFFKF)                                     
AA2DKF   DS    A                   A(A2DKF)                                     
ACLIKF   DS    A                   A(CLIKF)                                     
ACLIRF   DS    A                   A(CLIRF)                                     
AACTKF   DS    A                   A(ACTKF)                                     
AACTRF   DS    A                   A(ACTRF)                                     
AWCKF    DS    A                   A(WCKF)                                      
AWCRF    DS    A                   A(WCRF)                                      
ASCHKF   DS    A                   A(SCHKF)                                     
ASCHRF   DS    A                   A(SCHRF)                                     
ARSFKF   DS    A                   A(RSFKF)                                     
AERFKF   DS    A                   A(ERFKF)                                     
AERFRF   DS    A                   A(ERFRF)                                     
ASCMKF   DS    A                   A(SCMKF)                                     
ASCMRF   DS    A                   A(SCMRF)                                     
AETYKF   DS    A                   A(ETYKF)                                     
VGETCRL  DS    A                   ACGETCRL                                     
ADCONSN  EQU   (*-ADCONS)/L'ADCONS                                              
                                                                                
WVALUEL  EQU   *-WVALUES                                                        
                                                                                
AMASTC   DS    A                   A(MASTC)                                     
ABUFFRIN DS    A                   A(BUFFERIN)                                  
ACURLIST DS    A                   A(CURRENCY LIST)                             
AERFLIST DS    A                   A(ERFPAS LIST)                               
ALOCEL   DS    A                   A(LOCEL)                                     
AELEMENT DS    A                   A(ELEMENT)                                   
AELEMEN2 DS    A                   A(ELEMEN2) ELEMENTS FOR EXP LIST             
ALIDEL   DS    A                   A(LIST ELEMENT)                              
ASTRLID  DS    A                   A(START/NEXT DATA OF LIST ELEMENT)           
AENDLID  DS    A                   A(END OF LIST ELEMENT)                       
ASUPLIS  DS    A                   A(LIST OF SUPPLIER LEDGERS)                  
ANXTPID  DS    A                   A(NEXT PID FROM BKLINMGR)                    
AEDTTAB  DS    A                   A(EDTTAB)                                    
APRINTER DS    A                                                                
ARUNFACS DS    A                                                                
SV_AWMP  DS    A                   A(WORK MAP POOL)                             
SAVER4   DS    A                   SAVE ADDRESS OF R4                           
SAVER42  DS    A                   SAVE ADDRESS OF R4 IN 2ND LOOP               
WMPCNT   DS    H                   WORK MAP POOL COUNT                          
WMPCNT2  DS    H                   WORK MAP POOL COUNT IN 2ND POOL              
                                                                                
MAPI     DS    0XL(L'MAPI1+L'MAPI2)                                             
                                                                                
MAPI1    DS    X                   ** MAP INDICATOR BYTE1 1 **                  
MAP#LLDL EQU   MAPI1                                                            
MAPSLLDL EQU   X'80'               LIM LIST DOWNLOAD                            
MAP#ONAL EQU   MAPI1                                                            
MAPSONAL EQU   X'40'               ONA LIST DOWNLOAD                            
MAP#NARR EQU   MAPI1                                                            
MAPSNARR EQU   X'20'               NARR LIST/DISP DOWNLOAD                      
                                                                                
MAPI2    DS    X                   ** MAP INDICATOR BYTE1 2 **                  
                                                                                
RUNI     DS    0XL(L'RUNI1)                                                     
                                                                                
RUNI1    DS    X                   ** RUN INDICATOR BYTE1 1 **                  
RUN#MEDI EQU   RUNI1                                                            
RUNSMEDI EQU   X'80'               MEDIA LIDELD INIT                            
                                                                                
D_TODAYP DS    XL3                 Today's date                                 
D_TDM10  DS    XL3                 Today's date minus 10 years                  
D_TODAYC DS    XL2                 Compressed today's date                      
D_TODAYF DS    CL6                 Character today's date                       
D_TODAYB DS    XL3                 Binary today's date                          
D_TMOAP  DS    XL3                 Current month packed                         
D_TMOAF  DS    CL6                 Current month character                      
D_CURR   DS    CL3                 Currency                                     
TSAROBUF DS    XL(TSPXTNL)         TSAR block for optimisation buffer           
TSARABUF DS    XL(TSPXTNL)         TSAR block for GAPLST                        
TSARRECS DS    XL(TSPXTNL)         TSAR block for hourly rates                  
SAVEKEY  DS    XL64                Saved key                                    
SAVEVAR  DS    0F                                                               
         DS    X                                                                
QVALUES  DS    0XL256              ** REQUEST VALUES **                         
                                                                                
QAGENCY  DS    XL1                                                              
QALPHA   DS    CL(L'SAPEAGY)                                                    
AGYALF   DS    CL(L'SAPEAGY)                                                    
                                                                                
QGXLIND  DS    XL1                                                              
QAGXL    DS    AL3                                                              
                                                                                
QCAMSTR  DS    CL16                                                             
                                                                                
QPERSTR  DS    CL16                                                             
QPER     DS    CL8                                                              
QNAM     DS    CL1                 Show code and name only                      
QSPREP   DS    CL1                 Suppress my reports for line manager         
QSPLOC   DS    CL1                 Suppress locations                           
QSPTEA   DS    CL1                 Suppress teams                               
QSPROL   DS    CL1                 Suppress roles                               
QPID     DS    CL8                                                              
QPIN     DS    XL2                                                              
QEND     DS    PL3                                                              
QSTART   DS    PL3                                                              
QSUPPC   DS    CL(L'ACTKULA)                                                    
QOFFC    DS    CL2                                                              
QBILL    DS    CL1                                                              
QNBIL    DS    CL1                                                              
QPERKCD  DS    CL8                 PERSON CODE                                  
QTERMD   DS    CL1                 TERMINATED Y/N                               
         DS    CL1                                                              
                                                                                
QTEST    DS    CL1                                                              
                                                                                
QBATYP   DS    XL1                 Batch type                                   
                                                                                
QCLIENT  DS    CL6                                                              
QPROD    DS    CL6                                                              
QCAMP    DS    XL4                                                              
QBACKDAT DS    CL8                 BACK DATE                                    
                                                                                
QNARCOD  DS    0CL6                                                             
QNARSTA  DS    CL6                                                              
QNAREND  DS    CL6                                                              
QNARLAN  DS    CL1                                                              
QNARFLT  DS    CL4                                                              
QNARAPP  DS    CL1                                                              
QNAROFF  DS    CL2                                                              
QNARCLI  DS    CL5                                                              
QNARPRO  DS    CL2                                                              
QNARWRK  DS    CL2                                                              
QNARLEN  EQU   *-QNARCOD                                                        
                                                                                
QGENINIT DS    CL1                 INITIAL FOR GENERAL                          
QGENINI  EQU   C'G'                GENERAL INITIAL CALL                         
QOVRTIME EQU   C'T'                TIME AND GENERAL INITIAL CALL                
QOEIGINI EQU   C'O'                GENERAL INITIAL CALL FOR OR, ES, EX          
QBACSEML EQU   C'1'                CALL FOR BACS EMAIL SERVICE                  
QGENINI2 DS    CL1                 INCLUDE OVERDUE TIME                         
QINITIAL DS    CL1                 INITIAL FOR MODULES                          
QAPLINI  EQU   C'*'                MODULE INITIAL CALL                          
QJB1ST   EQU   C'1'                JOB/ESTIMATE/ORDER 1ST CALL                  
QJB2ND   EQU   C'2'                JOB/ESTIMATE/ORDER 2ND CALL                  
QINIONLY EQU   C'I'                INITIAL EXPENSES ONLY CALL                   
QAPPRVR  EQU   C'A'                ORDERS INITIAL FOR APPROVERS                 
QINVFINC EQU   C'F'                INVOICES:FINANCE USER                        
                                                                                
QETYCD   DS    CL(L'ETYKCODE)      Expenditure Type Code                        
QEXTEN   DS    CL1                 Extension                                    
QAPPL    DS    CL1                 Application                                  
QMAINT   EQU   C'M'                maintenance                                  
                                                                                
QOTYP    DS    CL1                 Order type                                   
QOTYPIQ  EQU   C'I'                Internal                                     
QOTYPPQ  EQU   C'P'                Production                                   
QOTYPEQ  EQU   C'E'                Expense                                      
QOTYPAQ  EQU   C'A'                Artist                                       
                                                                                
QMCTYP   DS    CL1                 Type of enquiry - Media Code                 
QMCTLQ   EQU   C'L'                List                                         
QSCTYP   DS    CL1                 Type of enquiry - Scheme Code                
QSCTIQ   EQU   C'I'                Initial                                      
QSCTLQ   EQU   C'L'                List                                         
QSCCOD   DS    CL8                                                              
*&&UK                                                                           
QSCCLI   DS    CL5                 - client code                                
QSCPRO   DS    CL2                 - product code                               
*&&                                                                             
*&&US                                                                           
QSCCLI   DS    CL3                 - client code                                
QSCPRO   DS    CL3                 - product code                               
*&&                                                                             
QSCJOB   DS    CL7                 - job code                                   
*&&US                                                                           
QCLDUM   DS    CL1                 Dummy                                        
QSTUDUM  DS    CL1                 Dummy                                        
*&&                                                                             
*&&UK                                                                           
QCLTYP   DS    CL1                 Type                                         
QCLINV   EQU   C'I'                - Invoice approvals                          
QCLEXP   EQU   C'X'                - Expense approvals                          
*&&                                                                             
QCLALL   DS    CL1                 All currencies                               
ALLQ     EQU   C'A'                                                             
QCLOFF   DS    CL(L'TRNKOFF)       Office code                                  
QCLSIND  DS    X                                                                
QACLSS   DS    AL3                                                              
                                                                                
                                                                                
QUNLDG   DS    CL(L'ACTKUNT+L'ACTKLDG)                                          
*                                  Hourly rates                                 
QRATYP   DS    CL1                                                              
QRATLST  EQU   C'1'                'List' request                               
QRATRFS  EQU   C'2'                'Refresh' request                            
QRACDT   DS    CL8                 date                                         
QRACLO   DS    CL2                 client office                                
*&&UK                                                                           
QRACLI   DS    CL5                 client code                                  
QRAPRO   DS    CL2                 product code                                 
         DS    CL5                 dummy                                        
*&&                                                                             
*&&US                                                                           
QRACLI   DS    CL3                 client code                                  
QRAPRO   DS    CL3                 product code                                 
QRAJOB   DS    CL6                 Job                                          
*&&                                                                             
QRA1RAI  DS    XL1                 1R array indicator                           
QRA1RAA  DS    AL3                 A(1R array)                                  
QRASTY   DS    CL1                 List style                                   
QRA1RQ   EQU   C'R'                Only 1r accounts with rates                  
QRAWCQ   EQU   C'W'                Only wc level rates no 1R                    
QRAALLQ  EQU   C'A'                All rates for all 1R accounts                
QRACUR   DS    CL3                 Currency                                     
QRARAT   DS    XL7                 Exchange rate                                
         ORG   QVALUES+L'QVALUES                                                
QVALUEL  EQU   *-QVALUES                                                        
                                                                                
         DS    0F                                                               
                                                                                
OVALUES  DS    0D                  ** OUTPUT VALUES **                          
CL_VALS  DS    0X                                                               
CL_CUR   DS    CL3                 - ISO code                                   
CL_NAM   DS    CL35                - Name                                       
CL_CLI   DS    CL5                 - Client code                                
CL_DEC   DS    XL1                 - Ddecimal places                            
CL_POS   DS    XL1                 - Pos. in list (*=unknown,=inactiv)         
CL_RUL   DS    XL14                (see DDEUREKAD)                              
CL_MIN   DS    XL5                 - Minimum rate                               
CL_MAX   DS    XL5                 - Maximum rate                               
CL_NPC   DS    CL1                 - None production currency if Y              
CL_LNQ   EQU   *-CL_VALS                                                        
         ORG   OVALUES                                                          
RA_VALS  DS    0X                                                               
RA_1RAC  DS    CL(L'ACTKACT)       Hourly rates                                 
RA_1RNM  DS    CL36                                                             
RA_SRNK  DS    XL1                                                              
RA_HRAT  DS    PL4                 hourly rate, agency currency                 
RA_HRFC  DS    PL4                 hourly rate, foreign currency                
RA_EFDT  DS    PL3                                                              
RA_SJAC  DS    CL12                                                             
RA_TASK  DS    CL2                                                              
RA_RACL  DS    CL1                                                              
RA_LNQ   EQU   *-RA_VALS                                                        
         ORG   OVALUES                                                          
XI_VALS  DS    0X                  Expense initial values                       
XI_NVAT  DS    CL1                                                              
XI_KMMI  DS    CL1                                                              
XI_NVTCD DS    CL12                Non vatable VAT code                         
XI_VATAC DS    CL12                Non vatable VAT account code                 
XI_VATRT DS    XL2                 Non vatable VAT rate                         
XI_VATAN DS    CL36                Non vatable VAT account name                 
XI_SGOPS DS    XL1                 SG ledger office position                    
XI_DRDT  DS    CL4                                                              
XI_FCUR  DS    CL1                                                              
XI_PRAN  DS    CL1                                                              
XI_1ROFF DS    CL2                                                              
XI_DEPT  DS    CL2                                                              
XI_SDPT  DS    CL2                                                              
XI_PRVNM DS    CL36                Province name                                
*&&UK                                                                           
XI_CTRY  DS    XL1                 Country equate                               
XI_CURR  DS    CL3                 Currency code                                
*&&                                                                             
XI_LNQ   EQU   *-XI_VALS                                                        
                                                                                
         ORG   OVALUES                                                          
JI_VALS  DS    0X                  Job initial values                           
JI_MIXC  DS    CL1                 Mixed case allowed                           
JI_PLN   DS    XL1                 Length of product                            
JI_JLN   DS    XL1                 Length of job                                
JI_LNQ   EQU   *-JI_VALS                                                        
                                                                                
         ORG   OVALUES                                                          
EL_VALS  DS    0X                  ** EXPEND. TYPE LIST RETURN DATA             
EL_CODE  DS    CL3                 - EXPENDITURE TYPE CODE                      
EL_NAME  DS    CL36                - NAME                                       
EL_FNAM  DS    CL36                - FOREIGN NAME                               
EL_LCKD  DS    CL1                 - LOCKED - Y/N                               
EL_DEFI  DS    CL1                 - DEFAULT INDICATOR (FOR SINGLE)             
EL_EXPC  DS    CL14                - EXPENSE A/C CODE (FOR SINGLE)              
EL_EXPN  DS    CL36                - AND NAME                                   
EL_EXPF  DS    CL36                - AND NAME                                   
EL_EXPS  DS    CL5                 - AND STATUS                                 
EL_SUPC  DS    CL14                - SUPPLIER A/C CODE (FOR SINGLE)             
EL_SUPN  DS    CL36                - AND NAME                                   
EL_SUPF  DS    CL36                - AND FOREIGN NAME                           
EL_SAD1  DS    CL40                - AND ADDRESS, LINES 1-4                     
EL_SAD2  DS    CL40                                                             
EL_SAD3  DS    CL40                                                             
EL_SAD4  DS    CL40                                                             
EL_WCDC  DS    CL2                 - WORK CODE CODE (FOR SINGLE)                
EL_WCDD  DS    CL15                - AND DESCRIPTION                            
EL_WCDF  DS    CL36                - AND FOREIGN DESCRIPTION                    
EL_AGTC  DS    CL14                - AGENT CODE                                 
EL_AGTN  DS    CL36                - AGENT NAME                                 
EL_AGA1  DS    CL(L'ADRADD1)       - AND ADDRESS, LINES 1-4                     
EL_AGA2  DS    CL(L'ADRADD1)                                                    
EL_AGA3  DS    CL(L'ADRADD1)                                                    
EL_AGA4  DS    CL(L'ADRADD1)                                                    
EL_SCUR  DS    CL3                 - CURRENCY CODE                              
EL_ECAT  DS    CL35                - EXPENSE CATEGORY                           
EL_TYPS  DS    CL3                 - TYPES FOR EXPENSES                         
EL_VCOD  DS    CL1                 - VAT code                                   
EL_VACC  DS    CL12                - VAT account                                
*&&UK                                                                           
EL_VRAT  DS    CL4                 - VAT rate (UK) 2 d.p.                       
*&&                                                                             
*&&US                                                                           
EL_VRAT  DS    CL5                 - VAT rate (US) 3 d.p.                       
*&&                                                                             
EL_VNAM  DS    CL36                - VAT a/c or code name                       
EL_LFOR  DS    CL1                 - Locked from orders Y/N                     
EL_LFIN  DS    CL1                 - Locked from expenses Y/N                   
EL_LFEX  DS    CL1                 - Locked from invoices Y/N                   
EL_ANAD  DS    CL1                 - Expense account 2P analysis Y/N            
EL_ANAP  DS    CL1                 - Expense account 2D analysis Y/N            
EL_SFAP  DS    CL1                 - Self approval allowed                      
EL_PRAN  DS    CL1                 - Product analysis                           
EL_GAPYN DS    CL1                 - GAP service in use                         
EL_GAPAQ DS    CL1                 - Acknowledge query?                         
EL_ULA   DS    0CL14               Unit ledger account                          
EL_ULAST DS    CL14                Unit ledger account start range              
EL_ULAEN DS    CL14                Unit ledger account end range                
EL_WRKCD DS    CL2                 Work code                                    
EL_DEFSU DS    CL1                 Defaul indicator for supp/exp accoun         
EL_PROVC DS    CL2                 PROVINCE CODE                                
EL_PRVNM DS    CL36                PROVINCE NAME                                
EL_PSTCD DS    CL1                 PST code                                     
EL_PSTNM DS    CL36                PST name                                     
EL_PSTRT DS    CL5                 PST rate                                     
EL_VALQ  EQU   *-EL_VALS                                                        
*                                                                               
         ORG   OVALUES                                                          
OL_MOA   DS    (OL_MMOA)XL3        List of MOA dates                            
OL_MMOA  EQU   24                                                               
         ORG   OVALUES                                                          
CHARPID  DS    CL8                 Character PID                                
TERMDATE DS    XL(L'SAPERDTE)      Compressed term date                         
         ORG   OVALUES                                                          
OOFFCODE DS    CL(L'TRNOFFC)       Office                                       
SSTUCODE DS    CL(L'STUKCODE)      Studio code                                  
OBDTE    DS    CL1                                                              
ORQPR    DS    CL1                                                              
OSFPR    DS    CL1                                                              
ORQEX    DS    CL1                                                              
OSFEX    DS    CL1                                                              
ORQIN    DS    CL1                                                              
OSFIN    DS    CL1                                                              
ORQAR    DS    CL1                                                              
OSFAR    DS    CL1                                                              
OFCURR   DS    CL1                                                              
OTYPE    DS    CL1                                                              
OFLT     DS    XL1                                                              
OJCDO    DS    PL6                                                              
OAJLA    DS    CL1                                                              
OAJNU    DS    CL1                                                              
ODRFT    DS    CL1                                                              
ODEFLT   DS    CL1                                                              
OPROLEN  DS    XL1                                                              
OJOBLEN  DS    XL1                                                              
OINLACC  DS    CL1                                                              
ORDTEXT  DS    CL1                                                              
*&&UK                                                                           
OINCP2J  DS    CL1                                                              
OINRCDT  DS    CL1                 Received date H/C/O                          
*&&                                                                             
OINEXRSR DS    CL1                 Exp order approver rules                     
OINPRRSR DS    CL1                 Prod order approver rules                    
OINSETS  DS    CL20                                                             
OINWDLO  DS    CL50                                                             
OINWDUS  DS    CL10                                                             
OINWDPA  DS    CL10                                                             
OINAPPR  DS    CL1                                                              
OINEDTR  DS    CL1                                                              
OINNOMB  DS    PL6                                                              
OINCURL  DS    CL300               URL FOR AGENCY                               
OINLAOC  DS    CL2                 LIMIT ACCESS SINGLE OFFICE CODE              
OINOKPOV DS    CL2                 OFFICE POSITION ON SV                        
OINOKPOX DS    CL2                 OFFICE POSITION IN SX                        
OINDUPF  DS    CL1                 CONFIRM DUPLICATE INVOICES                   
OINPWSV  DS    CL6                 PASSWORD FOR VARIANCE ON SV                  
OINPWSX  DS    CL6                 PASSWORD FOR VARIANCE ON SX                  
OINAMXR  DS    CL2                 APPROVER MIX                                 
OINFCUR  DS    CL1                 FOREIGN CURRENCY                             
OINNVAT  DS    CL1                 NEW VAT                                      
OINCSTG  DS    CL1                 KSV COSTING GROUP ANALYSIS                   
OIN2DAN  DS    CL1                 KSV DEPARTMENT ANALYSIS                      
OIN2PAN  DS    CL1                 KSV PERSONNEL ANALYSIS                       
OINJOBR  DS    CL1                 KSV JOB REQUIRED                             
OINPROR  DS    CL1                 KSV PRODUCT REQUIRED                         
OINUOIN  DS    CL1                 USE ORDER APPROVER FOR INVOICE               
OINPLN   DS    XL1                 Length of product                            
OINJLN   DS    XL1                 Length of job                                
*&&UK                                                                           
OIMGLOG  DS    XL1                 Use image file name as log number            
*&&                                                                             
OINAURA  DS    CL1                 Aura user                                    
OETYCM   DS    CL1                 ETYPE COMPULSORY                             
*                                                                               
EI_TAGN  DS    CL1                 TVRBands - Agreement number                  
EI_TAED  DS    PL3                          - Agreement end date                
EI_TNV1  DS    PL6                          - Network value 1                   
EI_TPC1  DS    PL6                          - Percentage 1                      
EI_TNV2  DS    PL6                          - Network value 2                   
EI_TPC2  DS    PL6                          - Percentage 2                      
EI_TNV3  DS    PL6                          - Network value 3                   
EI_TPC3  DS    PL6                          - Percentage 3                      
EI_TNV4  DS    PL6                          - Network value 4                   
EI_TPC4  DS    PL6                          - Percentage 4                      
EI_IAYN  DS    CL1                          - Internal approvals Y/N            
EI_SAYN  DS    CL1                          - Self approvals Y/N                
EI_RTXT  DS    CL1                          - Rich text                         
*                                                                               
OOVERDUE DS    CL1                 Timesheets overdue                           
OGICODE  DS    CL1                 Approver record exists                       
OGILIST  DS    CL1                 Limit list record exists                     
OGINEXP  DS    CL1                 New expense workflow in use                  
OGIMBTIM DS    CL1                 Mobile time in use                           
OGIURL   DS    CL300               URL for agency                               
OGIUID   DS    CL8                 8 BYTE User ID                               
OGIAGCUR DS    CL3                 - Agency currency ISO code                   
OGIDEC   DS    XL1                 - Agency currency decimal places             
OGINAME  DS    CL36                Agency name                                  
OGITIMAP DS    CL1                 Timesheet line manager approver              
OTIMBAK  DS    XL1                 Time back up approver                        
OONRL2L  DS    XL1                 1R level 2                                   
OONRL3L  DS    XL1                 1R level 3                                   
OONRL4L  DS    XL1                 1R level 4                                   
O2DOFPOS DS    XL1                 2D office position                           
OOFFLEN  DS    XL1                 Office length                                
O2POFPOS DS    XL1                 2P office position                           
O2PDPPOS DS    XL1                 2P dept position                             
O2PDPLEN DS    XL1                 2P dept length                               
OGBACSEM DS    CL50                BACS cc email address                        
OIDINAME DS    CL(L'CTDSTNAM)      IDI Dest name                                
OSTMNTH  DS    XL1                 Fiscal start month                           
OLTSCAL  DS    XL1                 Latest calendar year PWOS                    
                                                                                
AC_LVL   DS    XL1                 Account level                                
ERFOCNT  DS    XL1                 Office count                                 
CERFOFF  DS    CL2                                                              
         ORG                                                                    
OVALUESL EQU   *-OVALUES                                                        
                                                                                
DVALUES  DS    0F                  ** DERIVED VALUES **                         
GAPLPARM DS    CL1                 GAPLST parameter                             
DDATE    DS    PL3                 DATE                                         
DE_SPACE DS    CL1                                                              
LINEPID  DS    XL(L'PIDNO)         LINE MANAGER PIN                             
BKLINMGR DS    (BKLINMAX)XL(L'PIDNO) Back-up manager approver PID               
BKLINMAX EQU   10                  10 Max Backup Approvers                      
         DS    0H                                                               
ANXTLOC  DS    AL4                 Next LOCELD location                         
                                                                                
DNARR    DS    0X                                                               
DNARRDS  DS    CL15                                                             
DNARROF  DS    CL2                                                              
DNARRCL  DS    CL5                                                              
DNARRPR  DS    CL2                                                              
DNARRWC  DS    CL2                                                              
DNARRAP  DS    CL6                                                              
DNARRFI  DS    CL4                                                              
DNARRGR  DS    CL1                                                              
DNARRLQ  EQU   *-DNARR                                                          
                                                                                
DTEAMIND DS    X                                                                
DATEAM   DS    AL3                 BUILT TEAM IN WMP                            
DTEAMAXQ EQU   500                                                              
*                                                                               
DPIDIND  DS    X                                                                
DAPID    DS    AL3                 BUILT PID IN WMP                             
DPIDMAXQ EQU   1000                                                             
*                                                                               
DPIDIND2 DS    X                                                                
DAPID2   DS    AL3                 BUILT PID IN WMP                             
*                                                                               
DROLEIND DS    X                                                                
DAROLE   DS    AL3                 BUILT ROLE IN WMP                            
DROLMAXQ EQU   500                                                              
*                                                                               
DETYPIND DS    X                                                                
DAETYP   DS    AL3                 BUILT ETYPE IN WMP                           
DETYMAXQ EQU   500                                                              
*                                                                               
DPERLEN  DS    XL1                 PERSON LENGTH                                
*                                                                               
DCAMLEN  DS    XL1                 CAMPAIGN LENGTH                              
DCAMP    DS    XL4                                                              
D1CCAMP  DS    XL4                                                              
*                                                                               
DACT     DS    CL12                ACCOUNT CODE                                 
DOVRDTE  DS    PL3                 OVERDUE DATE                                 
DCDAT    DS    PL3                 WORKING DATE - START                         
DCEND    DS    PL3                 WORKING DATE - END                           
D1ROFF   DS    CL2                 OFFICE OF TIMESHEET                          
DNUMPRD  DS    XL1                 NUMBER OF PERIODS SAVED                      
*                                                                               
NTFY#    DS    XL2                 NUMBER OF DAYS  BEFORE NOTIFYING             
NTFYHRS  DS    XL2                 NUMBER OF HOURS BEFORE NOTIFYING             
NTFYDTE  DS    PL3                 DATE NOTIFICATIONS ARE SENT                  
LOCK#    DS    XL2                 NUMBER OF DAYS  BEFORE LOCKING               
LOCKHRS  DS    XL2                 NUMBER OF HOURS BEFORE LOCKING               
LOCKDTE  DS    PL3                 DATE LOCKS ARE SET                           
NTFYLNQ  EQU   *-NTFY#                                                          
*                                                                               
DPPID    DS    XL2                 PIN                                          
DPERSON  DS    CL8                 Accounting person code                       
DPERFNA  DS    CL36                Person first name                            
DPERLNA  DS    CL36                Person last name                             
*                                                                               
DOMDEF   DS    CL8                                                              
DOMETY   DS    CL1                                                              
DCOFF    DS    CL(L'TRNOFFC)       Office                                       
DSGOP    DS    XL1                 Ledger SG office position                    
                                                                                
DMEDIND  DS    X                                                                
DAMED    DS    AL3                 Built Media Code in WMP                      
DMEDMAXQ EQU   200                                                              
                                                                                
DACTIND  DS    X                                                                
DAACT    DS    AL3                 Built account Code in WMP                    
DACTMAXQ EQU   400                                                              
                                                                                
DACTIND2 DS    X                                                                
DAACT2   DS    AL3                 Built account Code in WMP                    
                                                                                
DOFFIND  DS    X                                                                
DAOFF    DS    AL3                 Built Office Code in WMP                     
DOFFMAXQ EQU   200                                                              
                                                                                
DVATCODE DS    CL1                 VAT code                                     
DPRVCODE DS    CL2                 Province code                                
*&&UK                                                                           
DVATRTE  DS    CL4                 VAT rate (UK) 2 d.p.                         
*&&                                                                             
*&&US                                                                           
DVATRTE  DS    CL5                 VAT rate (US) 3 d.p.                         
*&&                                                                             
DVATACT  DS    CL12                VAT account code                             
DVATNAM  DS    CL36                VAT name                                     
DVATLNQ  EQU   *-DVATCODE                                                       
*&&UK                                                                           
                                                                                
DLVLRE   DS    A                                                                
DLVLMODE DS    CL1                 Low levels from high levels - values         
DHIGULA  DS    XL(L'ACTKULA)                                                    
DLOWULA  DS    XL(L'ACTKULA)                                                    
DLVLLEN  DS    XL1                                                              
*&&                                                                             
DSVLVLS  DS    XL4                 Supplier ledger levels                       
DSXLVLS  DS    XL4                                                              
DSALVLS  DS    XL4                 Expense ledger levels                        
DSELVLS  DS    XL4                 SE                                           
DSQLVLS  DS    XL4                 SQ                                           
*&&UK                                                                           
DSILVLS  DS    XL4                 SI                                           
*&&                                                                             
DSFLVLS  DS    XL4                 SF                                           
DSTLVLS  DS    XL4                 ST                                           
*                                                                               
DOFFC    DS    CL2                 Location office                              
DDEPT    DS    CL6                 Location dept                                
DSDPT    DS    CL6                 Location sub-dept                            
DPLOLN   EQU   *-DOFFC                                                          
                                                                                
PRODPROF DS    CL16                                                             
XL#EOF   EQU   X'FF'               END OF FILE                                  
TEMPID   DS    CL8                 TEMP PID                                     
                                                                                
REQI     DS    X                   ** REQUEST INDICATOR BYTE 1 **               
REQIPRO  EQU   X'80'                                                            
REQIAURA EQU   X'40'                                                            
                                                                                
CURIND   DS    X                   Process currencies                           
CURICLI  EQU   X'80'                                                            
CURICRL  EQU   X'40'                                                            
CURIMOD  EQU   X'20'                                                            
CURIALL  EQU   X'10'                                                            
CURIOFC  EQU   X'08'               Agency level done                            
CURRULE  DS    CL(L'EURKRULE)      Currency rate                                
CURMXMN  DS    XL6                                                              
CURMAX   DS    CL5                 Agency currency max rate                     
CURMIN   DS    CL5                 Agency currency min rate                     
PKWK16A  DS    PL16                                                             
PKWK16B  DS    PL16                                                             
PKWK6    DS    PL6                                                              
                                                                                
X#PIDNO  DS    XL(L'PIDNO)         PID of report                                
*                                                                               
X#ORPF   DS    XL(ORDPRFL)                                                      
X#IDATA  DS    CL(ENCLNQ)                                                       
X#ODATA  DS    CL(ENCLNQ)                                                       
X#TDATA  DS    CL(ENCLNQ)                                                       
*                                                                               
X#LANG   DS    XL1                                                              
X#LLIND  DS    XL1                                                              
X#LLINI  EQU   X'80'               Limit list record found                      
X#CLIOF  EQU   X'40'               Read for clients filter by office            
X#ALCLI  EQU   X'20'               Read for all clients                         
LL_LISTQ EQU   C'1'                                                             
LL_ALLQ  EQU   C'2'                                                             
LL_NONEQ EQU   C'3'                                                             
LL_DACS  DS    0CL1                                                             
LL_DCLIA DS    CL1                 Default Client Access                        
LL_DMEDA DS    CL1                 Default Media Access                         
LL_DEXPA DS    CL1                 Default Expenditure Access                   
LL_DNCLA DS    CL1                 Default Non-Client Access                    
LL_DSTFA DS    CL1                 Default Staff Access                         
LL_DWCA  DS    CL1                 Default Work Code Access                     
LL_DREPA DS    CL1                 Default Report Formats Access                
LL_DESTA DS    CL1                 Default Estimate Scheme Access               
LL_DSUPA DS    CL1                 Default Supplier Access                      
LL_DACLQ EQU   *-LL_DACS                                                        
*                                                                               
SVOFFL   DS    CL2                 SAVED OFFICE LIST CODE                       
                                                                                
WAPPIND  DS    X                                                                
WAAPPL   DS    AL3                                                              
                                                                                
LEDGOPOS DS    XL1                                                              
LEDGOSEC DS    XL1                                                              
LEDGCODE DS    CL2                                                              
                                                                                
OVFLAG   DS    XL1                 Overdue time flag                            
OVRECFND EQU   X'40'               Found Record                                 
                                                                                
ACURNTR  DS    A                                                                
ALSTNTR  DS    A                                                                
*                                                                               
AADREL   DS    F                   saved address element                        
AOATEL   DS    F                   saved other address element                  
*                                                                               
USROFF   DS    CL(L'TRNOFFC)                                                    
RUNMODE  DS    XL(L'RUNPMODE)      DDLINK/RUNNER CALLING MODE                   
AALL     DS    AL3                 ALL VALUE WMP ENTRY                          
ANZR     DS    AL3                 NON-ZERO VALUE WMP ENTRY                     
USECPC   DS    CL1                                                              
NONAME   DS    CL1                                                              
SVPERKEY DS    XL(L'IOKEY)         SAVED PERSONAL CONTROL KEY                   
SAVEKEY2 DS    XL(L'IOKEY)                                                      
SAVEKEY3 DS    XL(L'IOKEY)                                                      
SAVEKEY4 DS    XL(L'IOKEY)                                                      
SVPTMKEY DS    XL(L'IOKEY)                                                      
SVTEAKEY DS    XL(L'IOKEY)                                                      
SVPRLKEY DS    XL(L'IOKEY)                                                      
SVPASKEY DS    XL(L'IOKEY)                                                      
DONERLNS DS    0XL4                individual levlens                           
DONERLN1 DS    XL1                                                              
DONERLN2 DS    XL1                                                              
DONERLN3 DS    XL1                                                              
DONERLN4 DS    XL1                                                              
DONERILS DS    XL4                 l'input key components                       
DONEROP  DS    XL1                 1R offpos                                    
                                                                                
DPRODLNS DS    0XL3                individual levlens                           
DCLILN   DS    XL1                                                              
DPROLN   DS    XL1                                                              
DJOBLN   DS    XL1                                                              
         DS    XL1                                                              
DPRODILS DS    XL4                 l'input key components                       
                                                                                
DLASTWC  DS    CL2                 Last workcode processed                      
DLASTHIR DS    XL1                 lowest level for non work code               
DTSARKY  DS    XL(CR_AKLNQ)        Saved TSAR key                               
DADJR    DS    PL4                 Adjustment rate                              
DADJL    DS    XL1                 Adjustment level (lower is better)           
*                                                                               
QRA1RO   DS    CL2                 1R office                                    
QRADPT   DS    CL3                 dept                                         
QRASUB   DS    CL2                 subdept                                      
QRAPER   DS    CL7                 person                                       
QRAWCD   DS    CL2                 workcode                                     
QRA1RAL  EQU   *-QRA1RO                                                         
                                                                                
ARYNENT  DS    XL(L'LW_NUMN)       N'array entries                              
ARYAENT  DS    A                   A(Current array entry)                       
ARYNTRN  DS    XL(L'CR_NTRN)                                                    
                                                                                
PREVULA  DS    0CL14                                                            
PREVUNT  DS    CL(L'ACTKUNT)                                                    
PREVLDG  DS    CL(L'ACTKLDG)                                                    
PREVACT  DS    CL(L'ACTKACT)                                                    
PREVAC2  DS    CL(L'ACTKACT)                                                    
D1RACC   DS    CL(L'ACTKACT)                                                    
DSJACC   DS    CL(L'ACTKACT)                                                    
*                                  Current date:                                
DCURDTA  DS    CL6                 alpha                                        
DCURDTP  DS    PL3                 packed                                       
DCURDTC  DS    XL2                 compressed                                   
DCURDTB  DS    XL3                 binary                                       
DCUTDTP  DS    PL3                 Cutoff date, packed                          
*&&US                                                                           
RATEADJ  DS    CL1                 Try adjustment rates                         
RATEWADJ DS    CL1                 Try adjustment rates for this WC             
*&&                                                                             
PL13     DS    PL13                For adjustment calculation                   
FSTIME   DS    CL1                 1st time switch                              
OLIMLST  DS    CL1                 Y/N override limlist                         
ACTWRK   DS    CL(L'ACTKACT)                                                    
ACTWRKLV DS    XL1                                                              
                                                                                
SUPBYTE  DS    XL1                 Supplier routine byte                        
                                                                                
SBUFRATS DS    XL(CR_RRLQ*5)       saved charge rate buffrecs, 5 lvls           
*&&US                                                                           
SBUFADJS DS    XL(CR_RRLQ*5)       saved adjust rate buffrecs, 5 lvls           
*&&                                                                             
                                                                                
DSDICTL  DS    0C                                                               
*&&US                                                                           
AC@PRVBC DS    CL20                                                             
AC@PRVAL DS    CL20                                                             
AC@PRVSA DS    CL20                                                             
AC@PRVMA DS    CL20                                                             
AC@PRVON DS    CL20                                                             
AC@PRVPQ DS    CL20                                                             
AC@PRVNB DS    CL20                                                             
AC@PRVNS DS    CL20                                                             
AC@PRVPE DS    CL20                                                             
AC@PRVNF DS    CL20                                                             
*&&                                                                             
*                                  level 1=ledger, 2-5=1R acc levels            
GAPAREA  DS    XL(GAPTLNQ)         TSAR buffrec read areas                      
GAPAREA2 DS    XL(GAPTLNQ)                                                      
ATSRERRS DS    XL1                 error area for TSAR errors                   
CR_BUFF  DS    XL256                                                            
ELEMEN2  DS    XL1000                                                           
                                                                                
DVALUESL EQU   *-DVALUES                                                        
SAVEVARL EQU   *-SAVEVAR                                                        
SAVEMAX  DS    XL((7*ONEK)-(*-SAVED))  Won't assemble if L'SAVED > 7K           
*                                      which is L'SVSERVER in ACBRA00           
         EJECT                                                                  
***********************************************************************         
* Optimisation buffer record layout                                   *         
***********************************************************************         
         SPACE 1                                                                
OB_D     DSECT                                                                  
                                                                                
OB_KEY   DS    XL64                Record key                                   
                                                                                
OB_ERROR DS    XL2                 Error number (Zero=OK)                       
                                                                                
OB_DATA  DS    0X                  Data starts here                             
OB_NAME  DS    CL(L'NAMEREC)       Record name                                  
OB_OTHER DS    0X                  Other data                                   
         ORG   OB_D+256                                                         
                                                                                
OB_DATAL EQU   *-OB_ERROR                                                       
OB_LNQ   EQU   *-OB_D                                                           
         SPACE 1                                                                
***********************************************************************         
* Extracted 1R Acc + Rate DSECTs for Charge Rate list                 *         
***********************************************************************         
                                                                                
CR_ARD   DSECT                                                                  
CR_ARKEY DS    0X                                                               
CR_LEN   DS    XL2                                                              
CR_NTRN  DS    XL2                 Entry number in request array                
CR_1RAC  DS    CL12                                                             
CR_N1RLQ EQU   *-CR_NTRN                                                        
CR_ARIND DS    XL1                                                              
CR_ARRAQ EQU   X'00'               1R account + rate                            
*&&US                                                                           
CR_ARAJQ EQU   X'01'               1R account + rate adjustment                 
*&&                                                                             
CR_ARACQ EQU   X'FF'               1R account + name                            
CR_TASK  DS    CL2                 Task/work code                               
CR_ARRHI DS    XL1                 Rate rec ranking in SRCHTBLs                 
CR_AKLNQ EQU   *-CR_ARD                                                         
                                                                                
CR_1RNM  DS    CL36                account name                                 
CR_NRLQ  EQU   *-CR_ARD                                                         
         ORG   CR_1RNM                                                          
CR_RATE  DS    PL4                 charge rate                                  
CR_EFDT  DS    PL3                 effective date                               
CR_SJAC  DS    CL12                client/product/(job)                         
CR_RRLQ  EQU   *-CR_ARD                                                         
         ORG                                                                    
CR_XLNQ  EQU   *-CR_ARD                                                         
                                                                                
***********************************************************************         
* INCLUDED DSECTS                                                     *         
***********************************************************************         
                                                                                
         PRINT OFF                                                              
       ++INCLUDE ACBRAWRKD                                                      
         PRINT ON                                                               
PIDRECD  DSECT                                                                  
         ORG   PIDKPER+L'PIDKOFF                                                
PIDKRES2 DS    XL(L'PIDKEY-(*-PIDKEY))                                          
         ORG   PIDKOFF+L'PIDKOFF                                                
PIDKREST DS    XL(L'PIDKEY-(*-PIDKEY))                                          
                                                                                
SAPEREC  DSECT                                                                  
         ORG   SAPESUB+L'SAPESUB                                                
SAPEREST DS    XL11                                                             
                                                                                
OFFRECD  DSECT                                                                  
         ORG   OFFKCPY+L'OFFKCPY                                                
OFFREST  DS    XL38                                                             
                                                                                
SCHRECD  DSECT                                                                  
         ORG   SCHKCODE+L'SCHKCODE                                              
SCHREST  DS    XL29                                                             
                                                                                
PMDRECD  DSECT                                                                  
         ORG   PMDKMED+L'PMDKMED                                                
PMDREST  DS    XL(L'PMDKEY-PMDKEND)                                             
                                                                                
ACTRECD  DSECT                                                                  
         ORG   ACTKACT+L'ACTKACT                                                
ACTREST  DS    XL(L'ACTKEY-ACTKEND)                                             
                                                                                
WCORECD  DSECT                                                                  
         ORG   WCOKWRK+L'WCOKWRK                                                
WCOREST  DS    XL(L'WCOKEY-WCOKEND)                                             
                                                                                
PERRECD  DSECT                                                                  
         ORG   PERKCODE+L'PERKCODE                                              
PERREST  DS    XL32                                                             
                                                                                
ERFTABD  DSECT                                                                  
ERFTIND  DS    XL1                                                              
ERFTCOD  DS    CL8                                                              
ERFTDA   DS    XL4                                                              
ERFTLNQ  EQU   *-ERFTABD                                                        
                                                                                
***********************************************************************         
* DAY TABLE DSECT                                                     *         
***********************************************************************         
         SPACE 1                                                                
DAYTABD  DSECT                                                                  
DAY#     DS    XL1                 GETDAY Day #                                 
DAYEDT#  DS    XL1                 EDIT Hrs Day #                               
DAYTABLN EQU   *-DAYTABD                                                        
                                                                                
***********************************************************************         
* CALENDAR TABLE DSECT                                                *         
***********************************************************************         
         SPACE 1                                                                
CALTABD  DSECT                                                                  
CALENDT  DS    PL3                 Period end date 2's complement               
CALSTRT  DS    PL3                 Period start date 2's complement             
CALTABL  EQU   *-CALTABD                                                        
                                                                                
***********************************************************************         
* CALDAY TABLE DSECT                                                  *         
***********************************************************************         
         SPACE 1                                                                
CALDAYD  DSECT                                                                  
CALDAY#  DS    XL1                                                              
CALDAY   DS    PL3                                                              
CALHRS   DS    PL4                                                              
CALLNQ   EQU   *-CALDAYD                                                        
                                                                                
***********************************************************************         
* Province table DSECT                                                *         
***********************************************************************         
         SPACE 1                                                                
PRVTABD  DSECT                                                                  
PRVCODE  DS    CL2                 Province code                                
PRVNAM   DS    XL2                 Province name                                
PRVNAML  DS    XL1                 Province name length                         
PRVTABL  EQU   *-PRVTABD                                                        
                                                                                
***********************************************************************         
* Includes                                                            *         
***********************************************************************         
         SPACE 1                                                                
*&&UK                                                                           
         PRINT OFF                                                              
       ++INCLUDE GEGENCUR                                                       
         PRINT ON                                                               
*&&                                                                             
*&&US                                                                           
       ++INCLUDE ACCATCALLD                                                     
*&&                                                                             
                                                                                
         PRINT OFF                                                              
       ++INCLUDE GEGENGEN                                                       
         PRINT ON                                                               
         PRINT OFF                                                              
       ++INCLUDE GEGENFEE                                                       
         PRINT ON                                                               
         PRINT OFF                                                              
       ++INCLUDE GEGENEXC                                                       
         PRINT ON                                                               
         PRINT OFF                                                              
       ++INCLUDE GEGENXLI                                                       
         PRINT ON                                                               
         PRINT OFF                                                              
       ++INCLUDE DDDDEQUS                                                       
         PRINT ON                                                               
         PRINT OFF                                                              
       ++INCLUDE DDLANGEQUS                                                     
         PRINT ON                                                               
         PRINT OFF                                                              
       ++INCLUDE ACVATICAND                                                     
         PRINT ON                                                               
         PRINT OFF                                                              
       ++INCLUDE DDGETRETD                                                      
         PRINT ON                                                               
         PRINT OFF                                                              
*PREFIX=P_                                                                      
       ++INCLUDE DDDPRINTL                                                      
*PREFIX=                                                                        
         PRINT ON                                                               
                                                                                
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'116ACBRA26   11/05/20'                                      
         END                                                                    
