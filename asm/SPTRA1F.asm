*          DATA SET SPTRA1F    AT LEVEL 208 AS OF 11/06/20                      
*PHASE T2161FB                                                                  
*INCLUDE XSORT                                                                  
*INCLUDE PQPROF                                                                 
*INCLUDE BINSRCH2                                                               
*INCLUDE ENDOFMOD                                                               
*                                                                               
*&&TRC   SET   N                                                                
*                                                                               
***********************************************************************         
**********************  PRODUCTION VERSION PLUS  **********************         
********************** CONVERTED REVISION RECORDS *********************         
***********************************************************************         
***********************************************************************         
*                                                                     *         
*  TITLE: T2161F - TRAFFIC NETWORK INSTRUCTION GENERATION             *         
*  COMMENTS: THIS PROGRAM GENERATES NETWORK INSTRUCTIONS              *         
*  OUTPUTS: UPDATED REVISION AND UNIT RECS, PRINTED INSTR.            *         
*  LOCALS: REGISTER USAGE                                             *         
*          R2 - POINTER TO SCREEN FLDH, ERREX WILL POSITION CUSOR     *         
*          R3 - POINTER TO NETBLOCKD                                  *         
*          R4 - WORK REG & KEY DSECT POINTER                          *         
*          R5 - WORK REG & POINTER TO PROGRAM/UNIT TABLES             *         
*          R6 - USED FOR GETEL ELEMENT DSECT POINTER                  *         
*          R7 - SECOND BASE                                           *         
*          R8 - POINTER TO SPOOLD                                     *         
*          R9 - POINTER TO SYSD                                       *         
*          RA - POINTER TO ATWA                                       *         
*          RB - FIRST BASE                                            *         
*          RC - POINTER TO GEND                                       *         
* AIO USAGE - AIO1 - VALI RTNS IN CONTROLLER (SPTRA00-T21600)         *         
*                  - IN AIO FROM HYPER CONTROLLER (T00A30)            *         
*                  - NETIO                                            *         
*             AIO2 - FOOTNOTES                                        *         
*                  - PROD HDR EST/PRD/COPY CODE TABLE(LAST 1000)      *         
*                  - SPECIAL TEXT FOR 1ST PAGE ONLY                   *         
*                  - DAYPART REC IN PRT RTN COPIES TO LIST            *         
*             AIO3 - NETBLOCK (AIO3 + 1000)                           *         
*                  - EXCEPTION UNIT PROG NAMES 448 AFTER SVPRDLST     *         
*                  - CLT, PRD, PRG COPIES TO LIST                     *         
*                                                                     *         
* TSPFUSER   0 -   7 ID                                               *         
*            8 - 135 ERRFILE DCB                                      *         
*          136 - 139 CT TO FORCE CHANGE TO REMOTKEY                   *         
*          140       EASYLINK STUFF PRINTED SW                        *         
*                                                                     *         
* TSAR USES ELEM AS AN I/O AREA                                       *         
*      0 - 1  LENGTH OF RECORD                                        *         
*      2 - 3  KEY - BINARY NUMBER 1 TO N                              *         
*      4      FORCEHED OR, IF BINARY, SPACE BEFORE                    *         
*      5      SPACING                                                 *         
*      6 - N  PRINT LINE (OR HEADING OR MIDLINE)                      *         
*                                                                     *         
***********************************************************************         
*                                                                     *         
*   IF FAXING WITH AGENCY COPY (SVTWPR06 = 2)                         *         
*     ONLINE CREATES FAX FIRST, THEN AGENCY COPY                      *         
*     OFFLINE CREATES AGENCY COPY FIRST.                              *         
*     SOON DOES FAX, GENERATES OPTIONAL REQUEST FOR COPY              *         
*                                                                     *         
***********************************************************************         
         EJECT                                                                  
***********************************************************************         
*  LEV 14 SMUR SEP07/07 CHANGE MAXLINES FOR LANDSCAPE FAXING, FIX STEX*         
*                       FIX BUG IN HDHK FOR STEXT PRINTING            *         
*                       ADD $ABEND AND ERROR MESSAGE TO REFRESH       *         
*  LEV 15 SMUR SEP15/07 FIX PGROUP BY MNAS                            *         
*                       FIX END OF DDS MESSAGE FOR OV FAX BY SMUR     *         
*  LEV 15 SMUR DEC28/07 FIX PGROUP BCT LOOP BUG WHEN EXACTLY 150 PRODS*         
*  LEV 16 MNAS JAN18/08 ERROR MSG INSTEAD OF DUMPING WHEN MAX PRODS   *         
*                       PER PROD GROUP EXCEEDED                       *         
*  LEV 17 SMUR JAN30/08 (L)ANDSCAPE                                   *         
*  LEV 18 SMUR FEB22/08 FIX MISSING LEDGER ON AGCY COPY OF FAX=2      *         
*  LEV 18 MNAS APR30/08 FIX INCORRECT DASH INDICATING PIGGYBACKS      *         
*  LEV 19 SMUR MAY19/08 FIX OVERNIGHT FAXING                          *         
*                                                                     *         
*  LEV 163 MNAS APR15/09 : FIX FAX HEADER BUG                                   
*  LEV 164 MNAS APR22/09 : MERGE IN ARCHIVING CODE                              
*  LEV 168 SMUR MAY14/09 ISSUE ERR MSG TO ASSIGN/SEED BEFORE NINS GEN *         
*  LEV 169 MNAS MAY14/09 BUG FIX FOR LOSING REV CMNTS WHEN CAL SWITCH *         
*  LEV 170 MNAS MAY21/09 FIX MISSING PQ REFERENCE CODE - ARCHIVING BUG*         
*  LEV 171 MNAS MAY22/09 FIX BUG WHEN TRYING TO OPEN PQ WHEN PRINTING *         
*                        LOCAL                                        *         
*  LEV 173 SMUR JUL08/09 FIX BUGS:ADDTIONA CML INFO,MIDLINES, SPACING *         
*  LEV 174 SMUR JUL10/09 BUG FIX READ XSPOT NOT UNFILE FOR REV REC    *         
*  LEV 175 SMUR SEP10/09 BUG FIX WHEN READING COMMENT RECORDS         *         
*  LEV 176 SMUR SEP29/09 SET DMINBTS TO READ FOR DELETED UNIT RECORDS *         
*  LEV 185 SMUR JUN02/10 FIX PRINTING PROG NAME ON PAGE 1 IN HEADING  *         
*  LEV 186 MNAS JUN17/10 REMOVE INSTRUCTIONS REFERENCING TWAOFFC,C'*' *         
*                        THIS IS NOT ALWAYS A DDS TERMINAL            *         
*  LEV 187 MNAS JUL27/10 SOME AGENCY COPIES NOT PRINTING THE BLURB    *         
*          AGENCY COPY/FAX=C CREATING REV RECS, SHOULD NOT BE (FIXED) *         
*  LEV 188 SMUR AUG30/10 READ ONLY CLTLIST WHEN TRAF ACROSS PRODS     *         
*  LEV 190 SMUR JAN/11   SUPPORT P/B LEN=22/23                        *         
*                    FIX PRINTING END TME WHEN NO TME ON CML DAILY=Y  *         
*  LEV 191 SMUR MAY23/11 FIX PRINTING OF CUTIN STATION IN HDHK        *         
*  LEV 192 SMUR JUL25/11 BUG FIX CLOSE ERR FILE ONLY IF ITS BEEN OPEN *         
*  LEV 193 MNAS NOV15/11 CHANGES TO ACCOMODATE NEW VENDOR RECORD      *         
*          (REPLACING DAYPART) -                                      *         
*  LEV 194 MNAS JAN18/12 CORRECT UNALLOCATED ERROR MSG                *         
*  LEV 195 MNAS FEB23/12 FIX PROBLEMS WITH END OF TABLE WITH PROGRAM  *         
*          TABLE - BUGS WITH GOING PAST END OF TABLE                  *         
*  LEV 196 SMUR APR10/12 BUG FIX DISABLE SVTN2PRO+12 FOR OV FAXING    *         
*  LEV 197 SMUR AUG02/12 BUG FIX READ XSPT NOT UNTFILE FOR REV RECS   *         
*  LEV 198 SMUR FEB13/13 SET READ FOR UPDATE TO N BEFORE DMGR CALLS   *         
*  LEV 198 MNAS MAR19/13 PROFILE LOGIC FOR SUBMEDIA V                 *         
*  LEV 199 SMUR MAR19/14 NEW RECAP RECORDS FOR OPTICA                 *         
*  LEV 200 SMUR JUL24/15 ADD SPG OPTICA SERVICE PROVIDER              *         
*      201 MHER NOV01/15 GET GLOBBER VALUES FROM NET/NAV AND GENERATE *         
*                        OPTICA PDF REPORTS                           *         
*  LEV 202 SMUR AUG15/16 FIX RECAP RECS FOR 8 CHAR ISCII W/ADID ELEM  *         
*               JAN13/17 SPEC-7589 ADD OPTION TO TRAFFIC BY DAYPART   *         
*                        REMOVE CODE FOR TSUPP  (17.2)                *         
*  LEV 203 SMUR JUN28/17 SPEC-13871 ADD RECAP RECS BY PROG FOR SYND   *         
*                        ADD SUBMEDIA & PROGRAM END DATE FOR METADATA *         
*                        DO NOT CREATE PASSIVE KEYS FOR RECAP         *         
*  LEV 204 SMUR JUL31/17 SPEC-14970 ADD PROGRAM END DATE TO RECAP REC *         
*  LEV 205 SMUR MAY05/17 READ DPT FROM UNIT TN3PRO6 SPEC-12359 (17.3) *         
*                        MERGE CML AIR DATES ON RECAP RECS SPEC-15086 *         
*  LEV 206 SMUR NOV15/17 DPT, PRGM DAY/TIME TO METADATA SPEC-16932    *         
*  LEV 207 SMUR DEC10/17 PRINT STATION NAME ON REPORT SPEC-16082(18.1)*         
*  SPEC-42502 SMUR JAN30/20 SUPPORT CONVERTED DATES ON REVISION RECS  *         
*                   ******TERMINUS ************                       *         
***********************************************************************         
         TITLE 'T2161F - NETWORK  TRAFFIC INSTRUCTION GENERATION'               
T2161F   CSECT                                                                  
*                                                                               
FAXMAX   EQU   42                  MAX LINES/PAGE FOR LANDSCAPE FAX             
         PRINT NOGEN                                                            
         NMOD1 0,T2161F**,R7,RR=R3                                              
         L     RC,0(R1)                                                         
         USING GEND,RC                                                          
         L     R8,ASPOOLD          GENERAL PRINT AREAS                          
         USING SPOOLD,R8                                                        
         L     RA,ATWA                                                          
         USING CONHEADH-64,RA      BASE SCREEN FOR SYSTEM + THIS PROG           
         L     R9,ASYSD                                                         
         USING SYSD,R9                                                          
         ST    R3,SPTR1FRR                                                      
                                                                                
         L     RF,=V(PQPROF)                                                    
         AR    RF,R3                                                            
         ST    RF,PQPROF                                                        
                                                                                
         LH    R0,=AL2(ENDSYSD-SYSD)   SEE IF PAST END OF SYSD                  
         C     R0,LSYSD                                                         
         BNH   *+6                                                              
         DC    H'0'                                                             
*                                                                               
         BRAS  RE,INIT                                                          
*                                                                               
         L     R3,AIO3                                                          
         AHI   R3,5000             NETBLOCK AIO3+5000                           
         ST    R3,ANETBLK                                                       
         USING NETBLKD,R3                                                       
         EJECT                                                                  
         CLI   MODE,VALKEY         VALIDATE RECORD KEY                          
         BE    VK                                                               
*                                                                               
         CLI   OFFLINE,C'Y'                                                     
         BE    MAIN10                                                           
*                                                                               
         CLI   MODE,ERRHOOK                                                     
         JE    MAIN20                                                           
         CLI   MODE,EMPTYHK        TEST NO DATA GENERATED ERROR                 
         JE    MAIN30              YES - PRINT TWA AND SAY NO DATA              
*                                                                               
         CLI   TRLSTPGM,X'1F'      WAS NINS GEN LAST PROG USED                  
         BE    MAIN10               YES, DONE                                   
         NI    TRACLTH+4,X'FF'-X'20'                                            
         B     VK                                                               
*                                                                               
MAIN10   CLI   SVXFROV,0           TEST OPTICA                                  
         JE    MAIN12                                                           
         CLC   =C'BLD',SVXFRMOD    TEST 'BUILD' MODE                            
         JE    EXIT                PROCESS ONLY VALKEY                          
*                                                                               
MAIN12   CLI   MODE,PRINTREP       INSTRUCTIONS                                 
         BE    LRR                                                              
         CLI   MODE,RUNFRST                                                     
         BE    GENAUTO                                                          
         CLI   MODE,RUNLAST                                                     
         BE    GENFIN                                                           
         J     EXIT                                                             
*===============================================================                
* ERRHOOK - RETURN GENCON ERROR FOR XFRCTL                                      
*===============================================================                
                                                                                
MAIN20   CLI   SVXFROV,0                                                        
         JE    *+12                                                             
         CLI   TRAWRKR,C' '                                                     
         JH    MAIN24                                                           
* RETURN ERROR CODE TO NET/NAV                                                  
         L     RF,SYSPARMS                                                      
         L     RF,16(RF)                                                        
         ICM   RF,15,CGLOBBER-COMFACSD(RF)                                      
         JZ    *+2                                                              
         XC    ELEM,ELEM                                                        
         MVC   ELEM(6),=C'<9997>'                                               
         MVC   ELEM+6(60),CONHEAD                                               
         GOTO1 (RF),DMCB,=C'PUTD',ELEM,69,GLVBUY1                               
*                                                                               
MAIN22   BRAS  RE,BLDXFR           BUILD RETURN XFRCTL ELEM                     
         J     EXIT                                                             
         EJECT                                                                  
*=============================================================                  
* DEAL WITH OFFLINE OPTICA ERRORS                                               
* MESSAGE IS SITTING IN CONHEAD - JUST WRAP WITH OPTICA CARDS                   
*=============================================================                  
                                                                                
MAIN24   BRAS  RE,OPTICERR                                                      
         J     MAIN32                                                           
                                                                                
*=============================================================                  
* DEAL WITH NO DATA MESSAGE TO INCLUDE OPTICA CONTROL CARDS                     
*=============================================================                  
                                                                                
MAIN30   TM    WHEN,X'20'          TEST SOON                                    
         JZ    EXIT                                                             
         CLI   TRAWRKR,C' '        TEST OPTICA                                  
         JNH   EXIT                NO - EXIT                                    
*                                                                               
         BAS   RE,OPTICERR                                                      
*                                                                               
         MVCDD P+3(#DSK02LQ),GE#DSK02 JOB RAN TO NORMAL COMPLETION              
         GOTO1 TWAVPRNT,DUB,P,=C'BL01'                                          
*                                                                               
         MVCDD P+3(#DSK01LQ),GE#DSK01 THERE WAS NOTHING ACTIVE TO REP           
         GOTO1 (RF),(R1)                                                        
*                                                                               
MAIN32   MVC   P+1(26),=C'*** END OF DDS MESSAGE ***'                           
         GOTO1 TWAVPRNT,DUB,P,=C'BL01'                                          
         J     EXIT                                                             
*                                                                               
EQXIT    CR    RB,RB                                                            
         J     EXIT                                                             
*                                                                               
NEQXIT   LTR   RB,RB                                                            
*                                                                               
EXIT     XIT1                                                                   
         EJECT                                                                  
*===============================================================                
* OPTICERR - OPEN  PRTQUE IF NECESSARY AND PRINT TWA                            
* RETURN TO CALLER FOR TEXT OF MESSAGE                                          
*===============================================================                
                                                                                
OPTICERR NTR1                                                                   
         CLI   PQSW,2              TEST PRTQUE OPEN                             
         JE    EXIT                YES                                          
*                                                                               
         ICM   RE,15,TWAMASTC                                                   
         JZ    *+2                                                              
*                                                                               
         L     RF,MCVREMOT-MASTD(RE)                                            
         USING REMOTED,RF                                                       
         MVC   REMOTSYS,MCS2OSYS-MASTD(RE)                                      
         MVI   REMOTCPY,1                                                       
         MVI   REMOTCLS,C'G'                                                    
         MVC   REMOTJID,=C'PDF'                                                 
         MVC   REMOTDST,TWAORIG                                                 
         GOTO1 OPENPQ                                                           
         MVI   PQSW,2                                                           
         DROP  RF                                                               
*                                                                               
         BRAS  RE,SNDOPTIC         SEND EDICT CONTROL CARDS                     
*                                                                               
         GOTO1 REQTWA,DMCB,(3,(R3)),(X'FF',ACOMFACS),VPRINT                     
*                                                                               
         MVI   LINE,2                                                           
         MVI   FORCEHED,C'N'                                                    
*                                                                               
         GOTO1 TWAVPRNT,DUB,P,=C'BL01'                                          
         BASR  RE,RF                                                            
         J     EXIT                                                             
         EJECT                                                                  
*===========================================================                    
* SET RUNLAST HOOK NEEDED AND RECOVER OFFLINE COPIES                            
*===========================================================                    
                                                                                
GENAUTO  CLI   OFFLINE,C'Y'                                                     
         BNE   EXIT                                                             
         TM    WHEN,X'C0'          TEST IMMED/NOW                               
         BZ    *+6                                                              
         DC    H'0'                                                             
         MVC   SEQNUM,=H'1'                                                     
         MVI   29(RA),X'02'        SET RUNLAST HOOK REQUIRED                    
*                                                                               
         L     RE,TWAMASTC                                                      
         L     RF,MCSSB-MCBLOCK(RE)                                             
         OI    SSBSTAT2-SSBD(RF),SSBSROLC  SET RECOVER OFFLINE COPIES           
         J     EXIT                                                             
*                                                                               
* CK IF ANY EASYLINK STUFF THAT MIGHT GET LOST *                                
*                                                                               
GENFIN   CLI   OFFLINE,C'Y'                                                     
         BNE   EXIT                                                             
         TM    WHEN,X'C0'          TEST IMMED/NOW                               
         BZ    *+6                                                              
         DC    H'0'                                                             
         ICM   RF,15,TWAMASTC                                                   
         BZ    EXIT                                                             
         OC    MCREMOTE-MASTD(,RF),MCREMOTE-MASTD(RF)                           
         BNZ   EXIT                                                             
         L     RE,TWADCONS                                                      
         L     RE,TSPFUSER-TWADCOND(RE)                                         
         CLI   140(RE),C'Y'        SEE IF ANY EASYLINK STUFF PRINTED            
         BNE   EXIT                 NO                                          
*                                                                               
* OPEN DIRECT ENTRY (WHICH WILL BE LOST)  TO PRESERVE REAL QUE ENTRY *          
*                                                                               
         L     R4,MCVREMOT-MASTD(,RF)                                           
         USING REMOTED,R4                                                       
*                                                                               
         MVC   REMOTSYS,MCS2OSYS-MASTD(RE)                                      
         MVC   REMOTJID,=C'STN'                                                 
         MVC   REMOTDST,TWAORIG                                                 
         MVI   REMOTCLS,C'A'                                                    
         MVI   REMOTCPY,1                                                       
*                                                                               
         GOTO1 OPENPQ                                                           
         MVC   P(5),=C'DUMMY'                                                   
         GOTO1 SPOOL,DMCB,(R8)                                                  
         MVI   SPMODE,X'FE'        DELETE THIS ENTRY                            
*                                                                               
         GOTO1 SPOOL,DMCB,(R8)    FORCE CLOSE OF SPOOL                          
         MVI   PQSW,1                                                           
         XC    REMOTKEY,REMOTKEY                                                
         B     EXIT                                                             
         DROP  R4                                                               
         EJECT                                                                  
*=====================================================================          
*  VALKEY ROUTINE                                                               
*  IF NO CHANGES TO KEY FIELDS, THEN CHECK FOR SELECTS                          
*=====================================================================          
                                                                                
VK       BRAS  RE,GETGLOB          CHECK FOR XFRCTL GLOBALS                     
*                                                                               
         CLI   TRAWRKR,C' '        TEST WORKER FILENUM (OPTICA)                 
         JNH   *+8                                                              
         OI    GENSTAT7,GES7PDF    REQUEST ERROR RETURN FOR PDF                 
*                                                                               
         MVI   PQSW,1              SUPPRESS AUTO PRTQUE OPEN                    
         MVI   SVQLTYP1,0          CLEAR ARCHIVE BYTE                           
         MVI   SVFAXARC,0          CLEAR FAX ARCHIVE BYTE                       
         XC    ELEM,ELEM                                                        
         XC    PROFKEY,PROFKEY                                                  
         MVI   PROFKEY,C'S'                                                     
         MVC   PROFKEY+1(2),=C'TN'                                              
         MVC   PROFKEY+3(2),TWAORIG                                             
         GOTO1 PQPROF,DMCB,(X'80',PROFKEY),(0,ELEM),ACOMFACS                    
         CLI   8(R1),0                                                          
         BE    *+6                                                              
         DC    H'0'                                                             
         LA    R4,ELEM                                                          
         USING REMOTED,R4                                                       
         MVC   SVQLTYP1,REMOTTY1                                                
         MVC   SVQLARC,REMOTARC                                                 
         CLI   REMOTSUB,C'#'                                                    
         BNE   VK03                                                             
         CLI   REMOTSUB+1,C'N'                                                  
         BE    VK05                                                             
         CLI   REMOTSUB+1,C'A'                                                  
         BNE   VK03                                                             
         OI    SVFAXARC,REMOTARQ                                                
         B     VK05                                                             
VK03     OI    SVFAXARC,REMOTAEQ                                                
         DROP  R4                                                               
VK05     DS    0H                                                               
                                                                                
         TM    WHEN,X'40'          THIS NOW?                                    
         BZ    VK10                 NO                                          
         TM    TRACLTH+4,X'20'     CLIENT CHANGED                               
         BZ    VK10                  YES REVALIDATE                             
         TM    TRANETH+4,X'20'     NETWORK CHANGED                              
         BZ    VK10                  YES REVALIDATE                             
         TM    TRAPRGH+4,X'20'     PROGRAM CHANGED                              
         BZ    VK10                  YES REVALIDATE                             
         TM    TRAPERH+4,X'20'     PERIOD CHANGED                               
         BZ    VK10                  YES REVALIDATE                             
         TM    TRAFAXH+4,X'20'     FAX CHANGED                                  
         BZ    VK10                  YES REVALIDATE                             
         TM    TRAOPTH+4,X'20'     OPTIONS CHANGED                              
         BZ    VK10                  YES REVALIDATE                             
         TM    TABLESW,X'10'       WAS TABLE BUILT                              
         BZ    VK10                NO                                           
         TM    TABLESW,X'80'       DISPLAY ?                                    
         BO    CSEL                YES                                          
         TM    TABLESW,X'40'       IS IT FULL                                   
         BO    VK30                YES                                          
*                                                                               
CSEL     DS    0H                                                               
         BRAS  RE,INITTSR          INIT TSAR                                    
*                                                                               
         MVC   SVREMUSR,REMUSER                                                 
         MVI   GMSGTYPE,0                                                       
*                                                                               
* CHECK FOR UNPROTECTED SELECT FIELDS                                           
*                                                                               
CSEL10   MVI   FRSTPGSW,C'Y'                                                    
         LA    R2,TRASEL1H                                                      
         L     R5,APRGTBLE                                                      
         USING PRGTABLED,R5                                                     
         NI    UPDSW,X'FF'-X'10'   SET OFF RETRANSMIT THIS SCREEN               
CSEL20   TM    1(R2),X'20'         PROTECTED                                    
         BO    CSEL30              YES, DONE THIS BEFORE                        
         CLI   5(R2),0             ANY ENTRY                                    
         BE    MISSERR             NO                                           
         CLI   8(R2),C'S'          SELECT (PRINT INSTR)                         
         BE    CSEL25                                                           
         CLI   8(R2),C'*'                                                       
         BNE   CSEL30              NO                                           
         TM    4(R2),X'C0'         FIELD INPUT THIS TIME                        
         BNO   *+16                 NO                                          
         MVI   8(R2),C'X'          MODIFY SEL FIELD                             
         OI    6(R2),X'80'         TRANSMIT                                     
         B     CSEL30                                                           
*                                                                               
         TM    4(R2),X'40'         FIELD INPUT PREVIOUSLY                       
         BNO   CSEL30               BYPASS                                      
         OI    6(R2),X'20'         TURN ON PROTECTED BIT                        
         B     CSEL30                                                           
*                                                                               
CSEL25   OI    UPDSW,X'10'         SET TO RETRANSMIT THIS SCREEN                
         BAS   RE,GEN              GO GENERATE INSTRUCTIONS                     
*                                                                               
         MVI   ERROR,0                                                          
         OI    GENSTAT1,CATCHIOR   I WANT CONTROL BACK                          
         GOTO1 CATCHIOS            DON'T TASKNEXT OUT!                          
         CLI   ERROR,0             ANY ERROR?                                   
         BNE   CSEL29               YES                                         
*                                                                               
* ARE WE ABOUT TO EXCEED MAX IO COUNT                                           
*                                                                               
         GOTO1 GETFACT,DMCB,0      GET A(SYSTEM INFO BLOCK)                     
         L     R1,DMCB                                                          
         USING FACTSD,R1                                                        
         SR    R4,R4                                                            
         ICM   R4,3,FATMAXIO       MAXIMUM ALLOWABLE IOS                        
         AHI   R4,-1800                                                         
         CLM   R4,3,FATIOCNT       TEST RUNNING OUT OF IOS                      
         BH    CSEL27               NO-STILL HAVE AT LEAST 800 IOS              
         MVI   ERROR,1             DUMMY ERROR MSG                              
         B     CSEL29              RUNNING OUT OF IOS                           
         DROP  R1                                                               
*                                                                               
* SEE IF RUNNING OUT OF TSAR SPACE                                              
*                                                                               
CSEL27   CLC   =C'DU',AGENCY   *** TEMP FIX (FOR HUGE INSTRUCTIONS)             
         BE    CSEL29              ALWAYS  RE-INIT                              
*                                                                               
         LLC   R6,0(R2)                                                         
         AR    R6,R2                                                            
         USING LSTLINE,R6                                                       
CSEL28   CLC   PRGPRG,LPROG                                                     
         BE    CSEL28C                                                          
         LA    R5,PRGNEXT                                                       
*PRG                                                                            
         C     R5,APRGTBLX           AT END OF TABLE                            
         BL    *+6                                                              
         DC    H'0'                                                             
         CLI   PRGPRG,0            AT END OF TABLE                              
         BNE   CSEL28                                                           
         DC    H'0'                                                             
*PRG                                                                            
         DROP  R6                                                               
*                                                                               
CSEL28C  LA    R5,PRGNEXT          CK NEXT ENTRY                                
         CLC   PRGUNITS,=H'90'     IF OVER 90, FORCE PRINT                      
         BH    CSEL29                                                           
*                                                                               
         L     R5,APRGTBLE                                                      
*                                                                               
         L     RF,TSARBYTE                                                      
         A     RF,=F'65000'                                                     
         C     RF,TSARBUFL                                                      
         BL    CSEL30                                                           
*                                                                               
CSEL29   DS    0H                                                               
*                                                                               
         L     R5,APRGTBLE                                                      
         CLI   SVTWPR06,C'2'       IS AGENCY COPY REQUIRED                      
         BE    *+12                                                             
         CLI   SVTWPR07,C'Y'       IMMED AGY COPY REQUIRED                      
         BNE   CSEL29E                                                          
         OC    TSARCT,TSARCT       ANY COPIES TO PRINT                          
         BZ    CSEL29E              NO                                          
*                                                                               
         BRAS  RE,PCPY       TEMP FORCE PRINT OUT                               
         BAS   RE,DCPY             DISPLAY COPY ID                              
         BRAS  RE,INITTSR          RE-INIT TSAR                                 
*                                                                               
CSEL29E  CLI   ERROR,0             DID WE REACH MAX I/O                         
         BNE   MAXIOERR             YES                                         
*                                                                               
CSEL30   DS    0H                                                               
         LA    R2,NEXTLINE(,R2)                                                 
         CLI   0(R2),9             END OF SCREEN                                
         BNH   CSEL40               YES                                         
         CLI   5(R2),0             ANY ENTRY                                    
         BE    CSEL40                                                           
         LLC   RE,0(R2)                                                         
         LA    RF,0(RE,R2)                                                      
         OC    8(L'TRADSP1,RF),8(RF)    ANYTHING HERE                           
         BNZ   CSEL20                                                           
*                                                                               
CSEL40   CLI   SVTWPR07,C'Y'       PRINT FAX COPY NOW                           
         BNE   CSEL50                                                           
*                                                                               
* TSAR PRINT HERE                                                               
*                                                                               
         CLI   SVTWPR06,C'2'       IS AGENCY COPY REQUIRED                      
         BNE   CSEL50                                                           
         TM    SVOPTSW1,OPTHDCPY   TEST OPTION AGENCY COPY                      
         BO    CSEL50                                                           
         OC    TSARCT,TSARCT       ANY COPIES TO PRINT                          
         BZ    CSEL50               NO                                          
*                                                                               
         BRAS  RE,PCPY             GO PRINT COPY                                
         BAS   RE,DCPY             DISPLAY COPY ID                              
*                                                                               
CSEL50   DS    0H                                                               
         CLI   0(R2),9             END OF SCREEN                                
         BNH   CSEL53               YES                                         
         LLC   RE,0(R2)                                                         
         LA    RF,0(RE,R2)                                                      
         OC    8(L'TRADSP1,RF),8(RF)    ANYTHING HERE                           
         BZ    CSEL53              WE ARE AT THE END                            
         CLI   5(R2),0             ANY ENTRY                                    
         BE    MISSERR                                                          
*                                                                               
CSEL53   A     R5,ASVNEXT          GET STARTING POINT IN TABLE                  
*PRG                                                                            
         C     R5,APRGTBLX                                                      
         BNL   *+14                                                             
*PRG                                                                            
         OC    0(4,R5),0(R5)       AT END OF TABLE                              
         BNZ   CSEL55                                                           
*                                                                               
         TM    TABLESW,X'80'       DISPLAY ?                                    
         BZ    *+12                                                             
         NI    TABLESW,X'FF'-X'80' DONE DISPLAYING THIS TABLE                   
         B     CSEL60              YES, RE-BUILD IT W/THE REST OF PRGS          
*                                                                               
         MVC   GERROR,=Y(ENDMSG2)                                               
         MVI   GMSGTYPE,C'I'                                                    
         LA    R2,TRACLTH                                                       
         NI    TRACLTH+4,X'FF'-X'20' SET OFF VALIDATED                          
         B     ERREXIT                                                          
*                                                                               
CSEL55   TM    UPDSW,X'10'         SET TO RETRANSMIT THIS SCREEN                
         BZ    LRL                 GO ON TO NEXT SCREEN, IF ANY                 
*                                                                               
CSEL60   MVC   GERROR,=Y(SELMSG2)                                               
         MVI   GMSGTYPE,C'I'                                                    
         OI    TRATAGH+1,X'01'     SET MODIFIED BIT                             
         OI    TRATAGH+6,X'80'     AND TRANSMIT                                 
         B     COMXIT                                                           
*                                                                               
* CHECK FOR ANY PRINT TO DO *                                                   
*                                                                               
         CLI   SVTWPR07,C'Y'       PRINT FAX COPY NOW                           
         BNE   MISSERR                                                          
*                                                                               
* TSAR PRINT HERE                                                               
*                                                                               
         OC    TSARCT,TSARCT       ANY COPIES TO PRINT                          
         BZ    MISSERR                                                          
*                                                                               
         BRAS  RE,PCPY             GO PRINT COPY                                
*                                                                               
         BAS   RE,DCPY             DISPLAY COPY ID                              
         B     MISSERR                                                          
*                                                                               
DCPY     NTR1                                                                   
*                                                                               
DCPY05   LA    R4,TRACPY                                                        
         LR    R6,R4                                                            
         LA    R1,42(R4)           POINT TO THE END-6 OF THE FIELD              
*                                                                               
         OC    TRACPY,TRACPY       1ST REPORT                                   
         BNZ   DCPY10               NO                                          
         MVC   0(6,R4),=C'CPYID='                                               
         MVC   6(3,R4),REMUSER                                                  
         LA    R4,9(R4)                                                         
*                                                                               
         SR    R4,R6               GET LENGTH OF CPYID=                         
         STC   R4,CPYPT                                                         
*                                                                               
DCPY10   LLC   R4,CPYPT                                                         
         AR    R4,R6                                                            
         CR    R4,R1               ANY ROOM FOR DISPLAY                         
         BNL   DCPY20               NO, FULL                                    
         MVI   0(R4),C','                                                       
         LA    R4,1(R4)                                                         
         SR    R0,R0                                                            
         ICM   R0,3,SPOOLRPN                                                    
         EDIT  (R0),(4,(R4)),ALIGN=LEFT                                         
         AR    R4,R0                                                            
         SR    R4,R6                                                            
         STC   R4,CPYPT                                                         
         OI    TRACPYH+6,X'80'                                                  
         B     VKX                                                              
*                                                                               
DCPY20   DS    0H                                                               
         XC    TRACPY,TRACPY       CLEAR                                        
         MVI   CPYPT,0             INIT POINTER INTO CPYID FIELD                
         B     DCPY05                                                           
         EJECT                                                                  
* VALIDATE KEY FIELDS                                                           
*                                                                               
VK10     LA    R0,NEXTADDR         CLEAR SAVED STORAGE                          
         LA    R1,PRGTABLE-NEXTADDR                                             
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
         TM    WHEN,X'40'          THIS NOW                                     
         BZ    VK12                                                             
         CLI   CONWHENH+5,4                                                     
         BNL   VK12                                                             
         MVC   GERROR,=Y(INITREQD)                                              
         LA    R2,CONWHENH                                                      
         B     ERREXIT                                                          
*                                                                               
VK12     ICM   RE,15,TWAMASTC                                                   
         BZ    VK14                                                             
         OC    MCREMOTE-MASTD(,RE),MCREMOTE-MASTD(RE)                           
         BZ    VK14                                                             
         MVI   DIRPRTSW,C'Y'                                                    
*                                                                               
VK14     LA    R2,ELEM             FAKE VALIMED                                 
         MVC   ELEM(9),=X'0A01000184010001D5'                                   
*                                                                               
         GOTO1 VALIMED                                                          
*                                                                               
         LA    R2,TRACLTH          CLIENT                                       
         GOTO1 VALICLT                                                          
*                                                                               
         OI    4(R2),X'20'         SET ON VALIDATED                             
*                                                                               
* READ TN PROFILE *                                                             
*                                                                               
         XC    WORK,WORK                                                        
         MVC   WORK(4),=C'S0TN'                                                 
         MVC   WORK+4(2),AGENCY                                                 
         MVC   WORK+6(4),QMED & CLIENT                                          
         MVI   WORK+10,C'*'                                                     
         MVC   WORK+11(1),SVCLTOFF CLIENT OFFICE                                
*                                                                               
         TM    SECFLAG,BLSSW       BRAND LEVEL SECURITY                         
         BZ    VK15F                                                            
*                                                                               
         TM    SECFLAG,NEPRDOFF    PRDS OFFICES NOT EQUAL                       
         BO    VK15F                                                            
*                                                                               
         MVC   WORK+11(1),SVPRDOFF ELSE USE PROD OFFICE                         
*                                                                               
VK15F    GOTO1 GETPROF,DMCB,WORK,SVPROF,DATAMGR                                 
*                                                                               
         MVC   MYTN2PR6,SVPROF+1                                                
*                                                                               
         MVI   WORK+3,C'W'         TW PROFILE                                   
         GOTO1 (RF),(R1),,SVT1PROF                                              
*                                                                               
         MVC   SVTWPR06,SVT1PROF+5 SAVE NINS/CABLE GEN                          
         MVC   SVTWPR07,SVT1PROF+6 SAVE NINS NOW HARDCOPY                       
         MVC   SVTWPR08,SVT1PROF+7 FAX EACH PROGRAM SEPARATELY                  
         MVC   SVTWPR11,SVT1PROF+10 READ TRAFFIC RECORDS FOR FAX #S             
         CLI   SVTWPR06,C'Y'                                                    
         BE    VK16                                                             
         CLI   SVTWPR06,C'2'                                                    
         BE    VK16                                                             
         MVI   SVTWPR06,C'N'                                                    
*                                                                               
VK16     MVI   WORK,C'S'-X'40'    LOWERCASE S                                   
         MVC   WORK+1(3),=C'TN1'                                                
         GOTO1 (RF),(R1),,SVT1PROF                                              
*                                                                               
         MVC   WORK+1(3),=C'TN3'   READ TN3 PROFILE                             
         GOTO1 (RF),(R1),,SVT3PROF                                              
*                                                                               
VK20     BRAS  RE,VNET                                                          
*                                                                               
* MUST READ TN2 PROFILE AFTER VNET                                              
*                                                                               
         MVI   WORK,C'S'-X'40'     LOWERCASE S                                  
         MVC   WORK+1(3),=C'TN2'   READ TN2 PROFILE                             
         MVC   WORK+4(2),AGENCY                                                 
         MVC   WORK+6(1),SVMEDIA   BY SPECIFIC MEDIA!!!                         
         MVC   WORK+7(3),QCLT                                                   
         MVI   WORK+10,C'*'                                                     
         MVC   WORK+11(1),SVCLTOFF                                              
*                                                                               
         TM    SECFLAG,BLSSW       BRAND LEVEL SECURITY                         
         BZ    VK25                                                             
*                                                                               
         TM    SECFLAG,NEPRDOFF    PRDS OFFICES NOT EQUAL                       
         BO    VK25                                                             
*                                                                               
         MVC   WORK+11(1),SVPRDOFF ELSE USE PROD OFFICE                         
*                                                                               
VK25     GOTO1 GETPROF,DMCB,WORK,SVTN2PRO,DATAMGR                               
*MNV                                                                            
         CLI   SVTN2PRO+14,C'Y'                                                 
         BNE   VK26                                                             
         TM    SVOPTSW2,OPTDIGI                                                 
         BO    VK26                                                             
         CLI   SVMEDIA,C'V'                                                     
         BNE   VK26                                                             
         MVC   GERROR,=Y(BDNETMED)                                              
         LA    R2,TRANETH                                                       
         B     ERREXIT                                                          
                                                                                
VK26     DS    0H                                                               
*MNV                                                                            
*                                                                               
         MVI   SVTN2PRO+12,C'N'    DISABLE OV FAXING PROFILE                    
*                                                                               
         CLI   SVTN2PRO+5,0                                                     
         BE    VK27                                                             
         CLI   SVTN2PRO+5,C'0'                                                  
         BE    VK27                                                             
         MVC   MYTN2PR6,SVTN2PRO+5                                              
*                                                                               
* VALIDATE FAX & OPTIONS FIELDS BEFORE PERIOD *                                 
*                                                                               
VK27     BRAS  RE,VOPT              GO VALIDATE                                 
*                                                                               
* READ ANY REVISION RECORD TO SEE IF THE FILE HAS BEEN CONVERTED.               
         NI    SVFLAG,X'FF'-CONVSW INIT CONVERTED RECORDS                       
         BRAS  RE,INITXSP          SET TO XSPOT                                 
         XC    KEY,KEY                                                          
         MVC   KEY(2),=X'0A1D'                                                  
         GOTO1 HIGH                                                             
         CLC   =X'0A1D',KEY        ANY REV REC?                                 
         BE    VK28                                                             
*                                                                               
         XC    ELEM,ELEM                                                        
         LA    R1,ELEM                                                          
         MVC   0(L'NOTEMSG,R1),NOTEMSG                                          
         LA    R1,L'NOTEMSG(,R1)                                                
         MVC   0(2,R1),AGENCY                                                   
         MVC   3(3,R1),QCLT                                                     
         MVC   7(4,R1),TRANET                                                   
         MVC   12(8,R1),TRAPER                                                  
                                                                                
         OC    ELEM,SPACES                                                      
         GOTO1 DATAMGR,DMCB,=C'OPMSG',(L'NOTEMSG+72,ELEM)                       
         B     VK29                NO REC FOUND, TREATE AS CONVERTED            
*                                                                               
VK28     TM    KEY+32,X'03'        CONVERTED RECORDS?                           
         BZ    *+8                                                              
VK29     OI    SVFLAG,CONVSW                                                    
*                                                                               
         BRAS  RE,INITSPT         CHANGE TO SPOT                                
*                                                                               
*                                                                               
* VALIDATE PERIOD BEFORE PROGRAM *                                              
*                                                                               
         BRAS  RE,VPER              VALIDATE PERIOD - MONTH/YEAR                
*                                                                               
         BRAS  RE,VPROG                                                         
*                                                                               
* READ UNITS FOR THIS PERIOD AND PROGRAM, AND BUILD PROGRAM TABLE *             
*                                                                               
VK30     L     RE,AIO2                                                          
         L     RF,SIZEIO             CLEAR EST/PRD/COPY CODE AREA               
         SR    R0,R0                                                            
         SR    R1,R1                                                            
         MVCL  RE,R0                                                            
*                                                                               
         MVI   TRLSTPGM,X'1F'      USING NINS GEN                               
         BRAS  RE,BLPRG                                                         
         BE    VK35                                                             
*                                                                               
         TM    TABLESW,X'20'       IS IT 2ND TIME AROUND                        
         BO    VK33                 YES, THEN WE ARE DONE NO  RROR              
         CLI   SVTN1PR5,C'C'       OPTION TO PRINT CHANGES                      
         BE    VKX                  YES,DONE                                    
         MVC   GERROR,=Y(NOUNTSEL)                                              
         LA    R2,TRACLTH                                                       
         B     ERREXIT                                                          
*                                                                               
VK33     MVC   GERROR,=Y(DONEMSG)                                               
         MVI   GMSGTYPE,C'I'                                                    
         S     R5,APRGTBLE         SAVE                                         
         ST    R5,ASVNEXT          1ST PGM NXT SCREEN/SO CSEL WILL END          
         LA    R2,TRASEL1H                                                      
         B     COMXIT                                                           
*                                                                               
VK35     OI    TRAPERH+4,X'20'     SET ON VALIDATED                             
*                                                                               
         L     R5,APRGTBLE                                                      
         OI    TABLESW,X'10'      SET TABLE BUILT, READY FOR INSTR              
*                                                                               
VK40     BRAS  RE,RPHSE            CML PROD HOUSE RECORD FOR OPTICA             
*                                                                               
         CLI   SVTWPR06,C'N'                                                    
         BE    VK60                                                             
*                                                                               
         TM    SVOPTSW1,OPTHDCPY   TEST OPTION AGENCY COPY                      
         BO    VK60                 YES                                         
*                                                                               
         CLI   SVTWPR11,C'Y'       TRAFFIC RECS FOR FAX #                       
         BNE   VK55                                                             
*                                                                               
         OC    SVFAXTBL,SVFAXTBL   ANY FAX ?                                    
         BNZ   VK60                                                             
*                                                                               
VK55     OC    SVNETFAX,SVNETFAX  IF NO FAX NUMBER, ERROR                       
         BNZ   VK60                                                             
         TM    WHEN,X'38'          TEST SOON/OVERNIGHT/DDS                      
         BZ    FAXERR                                                           
         CLI   OFFLINE,C'Y'        AND OFFLINE                                  
         BE    FAXERR               THEN ERROR                                  
*                                                                               
VK60     CLI   SVXFROV,0           TEST OPTICA PDF BLD                          
         BE    VK65                                                             
         CLC   =C'BLD',SVXFRMOD                                                 
         BE    VK90                                                             
         B     VK100               GO CHECK LOCKS                               
*                                                                               
VK65     TM    WHEN,X'38'          TEST SOON/OVERNIGHT/DDS                      
         BZ    LRL                 GO BUILD SCREEN                              
*                                                                               
         CLI   OFFLINE,C'Y'        IF OFFLINE CONTINUE CHECK                    
         BE    *+12                                                             
*                                                                               
         TM    SVOPTSW,OPTSEED                                                  
         BO    VK98                                                             
*                                                                               
* SEE IF ANY PROGRAMS WITHOUT COMMERCIALS OR UNALLOCATED *                      
*                                                                               
         USING PRGTABLED,R5                                                     
                                                                                
VK90     DS    0H                                                               
         CLC   PRGUNITS,PRGDEL                                                  
         BNE   VK92                                                             
         OC    PRGCREVD,PRGCREVD   IF NO CURRENT REV DATE                       
         BNZ   VK92                TELL'EM TO NET ASSIGN                        
         OI    PRGFLG,PRGXCLUD                                                  
         B     VK96                                                             
                                                                                
VK92     DS    0H                                                               
         OC    PRGCREVD,PRGCREVD   IF NO CURRENT REV DATE                       
         BZ    ASGNERR             TELL'EM TO NET ASSIGN                        
                                                                                
         TM    SVOPTSW,OPTUNAS     UNASSIGNED UNITS OK                          
         BO    VK94                                                             
         CLI   SVTNPR14,C'Y'       DEFAULT TO UNASSIGNED OK?                    
         BE    VK94                                                             
         OC    PRGUNAS,PRGUNAS     THIS PROGRAM HAVE ALL COMMERCIALS            
         BZ    VK94                 YES                                         
         TM    SVOPTSW1,OPTHDCPY   FOLLOW UP TO FAX?                            
         BZ    NOCMLER              NO, JUST DO ERROR                           
         OI    PRGFLG,PRGFAXCG      YES - CONTINUE W/REP, BUT FLAG CHNG         
VK94     TM    SVOPTSW,OPTUNAL     UNALLOCATED UNITS OK                         
         BO    VK96                                                             
         CLI   SVTNPR3,C'Y'        TN PROF ALLOW UNALLOCATED UNITS              
         BE    VK96                                                             
         OC    PRGUNAL,PRGUNAL     THIS PROGRAM HAVE ALL PROD ALLOC             
         BZ    VK96                 YES                                         
         TM    SVOPTSW1,OPTHDCPY   FOLLOW UP TO FAX?                            
         BZ    NOPRDER              NO, JUST DO ERROR                           
         OI    PRGFLG,PRGFAXCG      YES - CONTINUE W/REP, BUT FLAG CHNG         
VK96     LA    R5,PRGNEXT                                                       
*PRG                                                                            
         C     R5,APRGTBLX           AT END OF TABLE                            
         BNL   VK98                NO                                           
*PRG                                                                            
         OC    0(4,R5),0(R5)       EOL                                          
         BNZ   VK90                NO                                           
*                                                                               
VK98     BAS   RE,CLRSCR                                                        
*                                                                               
         NI    TRACLTH+4,X'FF'-X'20' FORCE CLIENT CHANGED                       
*                                                                               
         CLI   OFFLINE,C'Y'        ONLY OFFLINE                                 
         BNE   VK100                                                            
         CLC   =C'BLD',SVXFRMOD    TEST 'BUILD' MODE (OPTICA)                   
         BE    VK99                                                             
         CLI   TRAWRKR,C' '        TEST OPTICA                                  
         BH    VK99                                                             
         TM    SVOPTSW1,OPTHDCPY   UNLESS AGENCY COPY                           
         BO    VK100                                                            
*                                                                               
         CLI   SVTWPR06,C'N'       ANY FAX REQUIRED                             
         BE    VK100                NO                                          
*                                                                               
VK99     BRAS  RE,INITTSR          INIT TSAROFF                                 
*                                                                               
VK100    CLI   SVXFROV,0           TEST CALLED BY NNA                           
         BNE   VK101                                                            
         TM    WHEN,X'20'          IF SOON, CHECK IF LOCKED                     
         BZ    VKX                                                              
         DROP  R5                                                               
*                                                                               
VK101    TM    SVOPTSW,OPTTEST     THIS A TEST RUN                              
         BO    VK220                NO UPDATE, NO NEED TO LOCK                  
*                                                                               
* SEE IF WE ARE LOCKED OUT BY UNIT ALLOCATION                                   
*                                                                               
         MVI   BYTE,0                                                           
         XC    DUB,DUB                                                          
         MVC   DUB(4),=C'TNET'     TEST                                         
         GOTO1 VALILOC,0                                                        
*                                                                               
* IF RUNNING FOR ALL PRODUCTS, SEE THAT NONE OF THE PRODS ARE LOCKED            
*                                                                               
         CLI   SVTN2PRO+00,C'0'                                                 
         BE    *+12                                                             
         CLI   SVTN2PRO+00,0                                                    
         BNE   VK130               NOT AN ALL PRODUCT RUN                       
*                                                                               
         BRAS  RE,INITSPT                                                       
*                                                                               
         XC    SVCPROD,SVCPROD     INIT PROD                                    
         XC    KEY,KEY                                                          
         MVC   KEY(2),=X'0DF1'      PROD REC                                    
         MVC   KEY+2(3),BAGYMD    & BCLT                                        
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
VK110    CLC   KEY(5),KEYSAVE                                                   
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLI   KEY+5,X'FF'         LAST REC FOR THIS CLT                        
         BNE   *+14                                                             
         XC    SVCPROD,SVCPROD     CLEAR PROD                                   
         B     VK120                YES, DONE                                   
*                                                                               
         MVC   SVCPROD,KEY+6       SAVE 3 CHAR PROD                             
*                                                                               
         XC    DUB,DUB                                                          
         MVI   DUB,C'T'            TEST                                         
         MVI   DUB+1,X'FF'         NET (TRAFFIC)                                
         MVC   DUB+2(4),TRANET     NETWORK                                      
*                                                                               
         GOTO1 VALILOC,SVCPROD                                                  
*                                                                               
         XC    DUB,DUB                                                          
         MVI   DUB,C'T'            TEST                                         
         MVI   DUB+1,X'FF'         NET (TRAFFIC)                                
         MVI   DUB+2,X'FF'         NETWORK=ALL                                  
         MVC   DUB+3(1),SVMEDIA    MEDIA                                        
*                                                                               
         GOTO1 VALILOC,SVCPROD                                                  
*                                                                               
         GOTO1 SEQ                 GET NEXT PROD REC                            
         B     VK110                                                            
*                                                                               
* SEE IF WE ARE LOCKED OUT BY TRAFFIC FOR A NETWORK/PROD=ALL                    
*                                                                               
* LOCK OUT FOR SOON UPDATES (FOR ALL PRODUCTS)                                  
*                                                                               
VK120    XC    DUB,DUB                                                          
         MVI   DUB,C'L'            LOCK                                         
         MVI   DUB+1,X'FF'         NET (TRAFFIC)                                
         MVC   DUB+2(4),TRANET     NETWORK                                      
         MVI   DUB+6,X'FF'         ALL PRODS                                    
*                                                                               
         CLC   =C'GZ',AGENCY       GMMNY                                        
         BNE   VK128                                                            
*                                                                               
* SEE IF WE ARE LOCKED OUT BY US                                                
*                                                                               
         MVC   DUB(4),=C'TNET'                                                  
         MVI   DUB+4,X'21'                                                      
         XC    DUB+5(3),DUB+5                                                   
*                                                                               
         CLI   SVTN2PRO+00,0       ANY PRD GRP OR PRD                           
         BE    VK124                NO                                          
         CLI   SVTN2PRO+00,C'0'    ANY PRD GRP OR PRD                           
         BE    VK124                NO                                          
*                                                                               
         CLI   SVTN2PRO+00,C'*'    BY PRD                                       
         BNE   VK122                NO                                          
*****    MVC   DUB+6(3),VOPTPROD                                                
*                                                                               
         MVC   SVCPROD,VOPTPROD                                                 
         B     VK124                                                            
*                                                                               
VK122    DS    0H                                                               
         CLI   SVTN2PRO+00,C'A'    PRD GROUP ID                                 
         BNL   *+6                                                              
         DC    H'0'                                                             
         CLI   SVTN2PRO+00,C'Z'    PRD GROUP ID                                 
         BNH   *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   DUB+6(1),SVTN2PRO+00                                             
         MVC   DUB+7(2),VOPTPRGR                                                
*                                                                               
* LOCK OUT FOR SOON UPDATES                                                     
*                                                                               
VK124    MVI   DUB,C'L'                                                         
*                                                                               
VK128    CLI   SVXFROV,0           TEST CALLED BY NNA (OPTICA)                  
         BE    *+14                NO                                           
         CLC   =C'SUB',SVXFRMOD    LOCK ONLY ON 'SUB' CALL                      
         JNE   VKX                                                              
*                                                                               
         GOTO1 VALILOC,SVCPROD                                                  
         B     VK200                                                            
*                                                                               
* IF RUNNING BY PRODUCT, SEE THAT THIS PRD IS NOT LOCKED                        
*                                                                               
VK130    CLI   SVTN2PRO+00,C'*'                                                 
         BNE   VK150                                                            
         MVC   BYTE,SVTN2PRO+00                                                 
         XC    DUB,DUB                                                          
         MVI   DUB,C'T'            TEST                                         
         MVI   DUB+1,X'FF'         NET (TRAFFIC)                                
         MVC   DUB+2(4),TRANET     NETWORK                                      
*                                                                               
         MVC   SVCPROD,VOPTPROD    THIS PRD LOCKED?                             
         GOTO1 VALILOC,SVCPROD                                                  
*                                                                               
         XC    DUB,DUB                                                          
         MVI   DUB,C'T'            TEST                                         
         MVI   DUB+1,X'FF'         NET (TRAFFIC)                                
         MVI   DUB+2,X'FF'         NETWORK=ALL                                  
         MVC   DUB+3(1),SVMEDIA    MEDIA                                        
*                                                                               
         GOTO1 VALILOC,SVCPROD                                                  
*                                                                               
         XC    DUB,DUB                                                          
         MVI   DUB,C'L'            LOCK                                         
         MVI   DUB+1,X'FF'         NET (TRAFFIC)                                
         MVC   DUB+2(4),TRANET     NETWORK                                      
*                                                                               
         CLC   =C'GZ',AGENCY       GMMNY                                        
         BE    VK200                                                            
*                                                                               
         CLI   SVXFROV,0           TEST CALLED BY NNA (OPTICA)                  
         BE    *+14                NO                                           
         CLC   =C'SUB',SVXFRMOD    LOCK ONLY ON 'SUB' CALL                      
         JNE   VKX                                                              
*                                                                               
         GOTO1 VALILOC,SVCPROD                                                  
         B     VK200                                                            
*                                                                               
* IF RUNNING BY PGROUP, SEE THAT THIS PGROUP IS NOT LOCKED                      
*                                                                               
VK150    OC    VOPTPRGR,VOPTPRGR   PROD GROUP                                   
         BNZ   *+6                                                              
         DC    H'0'                BUG CATCHER                                  
*                                                                               
         XC    DUB,DUB                                                          
         MVC   BYTE,SVTN2PRO+00                                                 
         MVI   DUB,C'T'            TEST                                         
         MVI   DUB+1,X'FF'         NET (TRAFFIC)                                
         MVC   DUB+2(4),TRANET     NETWORK                                      
         MVC   DUB+6(2),VOPTPRGR   THIS PGROUP LOCKED?                          
         GOTO1 VALILOC,0                                                        
*                                                                               
         XC    DUB,DUB                                                          
         MVI   DUB,C'T'            TEST                                         
         MVI   DUB+1,X'FF'         NET (TRAFFIC)                                
         MVI   DUB+2,X'FF'         NETWORK=ALL                                  
         MVC   DUB+3(1),SVMEDIA    MEDIA                                        
         MVC   DUB+6(2),VOPTPRGR   THIS PGROUP LOCKED?                          
         GOTO1 VALILOC,0                                                        
*                                                                               
         XC    DUB,DUB                                                          
         MVI   DUB,C'L'            LOCK                                         
         MVI   DUB+1,X'FF'         NET (TRAFFIC)                                
         MVC   DUB+2(4),TRANET     NETWORK                                      
         MVC   DUB+6(2),VOPTPRGR   PGROUP                                       
*                                                                               
         CLC   =C'GZ',AGENCY       GMMNY                                        
         BE    VK200                                                            
*                                                                               
VK190    CLI   SVXFROV,0           TEST CALLED BY NNA (OPTICA)                  
         BE    VK194               NO                                           
         CLC   =C'SUB',SVXFRMOD    LOCK ONLY ON 'SUB' CALL                      
         JNE   VKX                                                              
                                                                                
*================================================================               
* LOCK NOW!                                                                     
*================================================================               
                                                                                
VK194    GOTO1 VALILOC,0                                                        
*                                                                               
VK200    MVC   SVLOCK,DUB          SAVE LOCK INFO FOR UNLOCK                    
         MVC   SVSVPROD,SVCPROD    SAVE FOR UNLOCK                              
*                                                                               
         MVI   TWAWHEN,5          SET AS UPDATIVE SOON FOR FRED                 
*                                 ALSO SETS SINGLE THREAD                       
VK220    CLI   SVTWPR06,C'N'       REQUIRE AGENCY COPY                          
         BE    VKX                                                              
         MVC   REMUSER,=C'NWX'                                                  
         MVC   SPOOLKEY+QLTYP1-PQPLD(1),SVFAXARC                                
*AR                                                                             
         MVI   SPOOLKEY+QLEXTRA-PQPLD,X'FF'                                     
         MVC   SPOOLKEY+QLARC-PQPLD(L'SVQLARC),SVQLARC                          
*AR                                                                             
         MVI   SPOOLKEY+PLCLASS-PQPLD,C'G'                                      
*                                                                               
         ICM   RE,15,TWAMASTC                                                   
         BZ    *+8                                                              
         MVI   MCREQREP-MASTD(RE),C'N' SUPPRESS REQUEST PAGE                    
*                                                                               
VKX      DS    0H                                                               
         CLI   SVXFROV,0           TEST XFR/CTL FROM NET/NAV                    
         JE    EXIT                NO                                           
         CLC   =C'BLD',SVXFRMOD    TEST 'BUILD' MODE                            
         JE    VKX2                                                             
*                                                                               
         BRAS  RE,ADDWRKR          ADD WORKER FILE AND SOON REQUEST             
         DC    H'0'                NO RETURN HERE!                              
                                                                                
* MOVE PRGTBLE TO RSSVR BUFFER                                                  
                                                                                
VKX2     XC    ELEM,ELEM                                                        
         LA    R1,ELEM                                                          
         USING FAWSSVRD,R1                                                      
*                                                                               
         L     RF,ACOMFACS                                                      
         L     RF,CWSSVR-COMFACSD(RF)                                           
*                                                                               
         MVI   FAWSACTN,FAWSUCLR   CLEAR UTL WSSVR BUFFER                       
         GOTOR (RF),(R1)                                                        
*                                                                               
         MVC   FAWSTOKN,=C'TR1F'   TOKEN                                        
         OI    FAWSACTN,FAWSUSVE                                                
         MVC   FAWSADR,APRGTBLE                                                 
         L     RE,APRGTBLX                                                      
         S     RE,APRGTBLE                                                      
         STH   RE,FAWSLEN                                                       
*                                                                               
         GOTOR (RF),(R1)                                                        
         CLI   FAWSRTN,FAWSROK                                                  
         JNE   *+2                                                              
*                                                                               
         BRAS  RE,BLDXFR           BUILD XFRCTL ELEM                            
         J     EXIT                                                             
*                                                                               
NOTEMSG  DC    C'AUTONOTE*SMUR:NO 0A1D REC FOUND IN 1F '                        
*                                                                               
         DROP  R1                                                               
         EJECT                                                                  
*==================================================================             
* ONLINE INSTRUCTIONS - GENERATE 1 LETTER PER PROGRAM FROM TABLE                
*==================================================================             
                                                                                
         USING PRGTABLED,R5                                                     
LRL      BAS   RE,CLRSCR                                                        
*                                                                               
         XC    TRACPY,TRACPY       CLEAR ANY CPYID=                             
         OI    TRACPYH+6,X'80'                                                  
*                                                                               
* SEE IF WE ARE LOCKED OUT BY UNIT ALLOCATION                                   
*                                                                               
         XC    DUB,DUB                                                          
         MVI   BYTE,0                                                           
         MVC   DUB(4),=C'TNET'                                                  
         GOTO1 VALILOC,0                                                        
*                                                                               
* IF RUNNING FOR ALL PRODUCTS, SEE THAT NONE OF THE PRODS ARE LOCKED            
*                                                                               
         CLI   SVTN2PRO+00,C'0'                                                 
         BE    *+12                                                             
         CLI   SVTN2PRO+00,0                                                    
         BNE   TLOCK30             NOT AN ALL PRODUCT RUN                       
*                                                                               
* GET PRODUCTS FOR THIS CLIENT                                                  
*                                                                               
         BRAS  RE,INITSPT                                                       
*                                                                               
         XC    SVCPROD,SVCPROD     INIT PROD                                    
         XC    KEY,KEY                                                          
         MVC   KEY(2),=X'0DF1'      PROD REC                                    
         MVC   KEY+2(3),BAGYMD    & BCLT                                        
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
TLOCK15  CLC   KEY(5),KEYSAVE                                                   
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLI   KEY+5,X'FF'         LAST REC FOR THIS CLT                        
         BNE   *+14                                                             
         XC    SVCPROD,SVCPROD     CLEAR PROD                                   
         B     TLOCKX               YES, DONE                                   
*                                                                               
         MVC   SVCPROD,KEY+6       SAVE 3 CHAR PROD                             
*                                                                               
         XC    DUB,DUB                                                          
         MVI   DUB,C'T'            TEST                                         
         MVI   DUB+1,X'FF'         NET (TRAFFIC)                                
         MVC   DUB+2(4),TRANET     NETWORK                                      
*                                                                               
         GOTO1 VALILOC,SVCPROD                                                  
*                                                                               
         XC    DUB,DUB                                                          
         MVI   DUB,C'T'            TEST                                         
         MVI   DUB+1,X'FF'         NET (TRAFFIC)                                
         MVI   DUB+2,X'FF'         NETWORK=ALL                                  
         MVC   DUB+3(1),SVMEDIA    MEDIA                                        
*                                                                               
         GOTO1 VALILOC,SVCPROD                                                  
         GOTO1 SEQ                 GET NEXT PROD REC                            
         B     TLOCK15                                                          
*                                                                               
*        LA    R4,4(,R4)           BUMP TO NEXT PRD                             
*        BCT   R2,TLOCK10                                                       
*******  B     TLOCKX                                                           
*                                                                               
* IF RUNNING BY PRODUCT, SEE THAT THIS PRD IS NOT LOCKED                        
*                                                                               
TLOCK30  CLI   SVTN2PRO+00,C'*'                                                 
         BNE   TLOCK60                                                          
         MVC   BYTE,SVTN2PRO+00                                                 
         XC    DUB,DUB                                                          
         MVI   DUB,C'T'            TEST                                         
         MVI   DUB+1,X'FF'         NET (TRAFFIC)                                
         MVC   DUB+2(4),TRANET     NETWORK                                      
*                                                                               
         MVC   SVCPROD,VOPTPROD    THIS PRD LOCKED?                             
         GOTO1 VALILOC,SVCPROD                                                  
*                                                                               
         XC    DUB,DUB                                                          
         MVI   DUB,C'T'            TEST                                         
         MVI   DUB+1,X'FF'         NET (TRAFFIC)                                
         MVI   DUB+2,X'FF'         NETWORK=ALL                                  
         MVC   DUB+3(1),SVMEDIA    MEDIA                                        
*                                                                               
         GOTO1 VALILOC,SVCPROD                                                  
         B     TLOCKX                                                           
*                                                                               
* IF RUNNING BY PGROUP, SEE THAT THIS PGROUP IS NOT LOCKED                      
*                                                                               
TLOCK60  OC    VOPTPRGR,VOPTPRGR   PROD GROUP                                   
         BNZ   *+6                                                              
         DC    H'0'                BUG CATCHER                                  
*                                                                               
         XC    DUB,DUB                                                          
         MVC   BYTE,SVTN2PRO+00                                                 
         MVI   DUB,C'T'            TEST                                         
         MVI   DUB+1,X'FF'         NET (TRAFFIC)                                
         MVC   DUB+2(4),TRANET     NETWORK                                      
         MVC   DUB+6(2),VOPTPRGR   PGROUP                                       
         GOTO1 VALILOC,0                                                        
*                                                                               
         XC    DUB,DUB                                                          
         MVI   DUB,C'T'            TEST                                         
         MVI   DUB+1,X'FF'         NET (TRAFFIC)                                
         MVI   DUB+2,X'FF'         NETWORK=ALL                                  
         MVC   DUB+3(1),SVMEDIA    MEDIA                                        
         MVC   DUB+6(2),VOPTPRGR   PGROUP                                       
         GOTO1 VALILOC,0                                                        
*                                                                               
TLOCKX   LA    R2,TRASEL1H         1ST DISPLAY LINE                             
*                                                                               
* DISPLAY 1 LINE FOR EACH PROGRAM *                                             
*                                                                               
LRL10    NI    1(R2),X'FF'-X'20'   SET UNPROTECTED                              
         NI    4(R2),X'FF'-X'40'   SET OFF FIELD INPUT PREV                     
         NI    6(R2),X'FF'-X'20'   SET OFF PROTECTED FIELD                      
         MVI   5(R2),0             RESET INPUT DATA LENGH                       
         OI    6(R2),X'80'         SET XMT                                      
         LLC   R0,0(R2)                                                         
         AR    R2,R0                                                            
         LR    R0,R2                                                            
         SR    R0,RA                                                            
         ST    R0,SVLSTLN                                                       
         USING LSTLINE,R2                                                       
*                                                                               
LRL10B   DS    0H                                                               
         CLC   PRGUNITS,PRGDEL                                                  
         BNE   LRLTMP1                                                          
         OC    PRGCREVD,PRGCREVD   IF NO CURRENT REV DATE                       
         BNZ   LRLTMP1             TELL'EM TO NET ASSIGN                        
         OI    PRGFLG,PRGXCLUD                                                  
         B     LRLTMP2                                                          
                                                                                
LRLTMP1  DS    0H                                                               
         TM    PRGFLG,PRGXCLUD     EXCLUDE THIS PROG?                           
         BZ    LRL10C                                                           
*                                                                               
LRLTMP2  LA    R5,PRGNEXT          YES, GET NEXT PROGRAM                        
*PRG                                                                            
         C     R5,APRGTBLX           AT END OF TABLE                            
         BNL   LRL10B1                                                          
*PRG                                                                            
         OC    0(4,R5),0(R5)       END OF TABLE                                 
         BNZ   LRL10B                                                           
*                                                                               
LRL10B1  TM    TABLESW,X'40'       TABLE FULL?                                  
         BO    LRL40                                                            
         B     LRL50                                                            
*                                                                               
LRL10C   MVC   LPROG,PRGPRG                                                     
*                                                                               
         CLC   USERNAME(66),SPACES   ANY USER NAME AND ADDRESS                  
         BNH   *+14                                                             
         OC    USERNAME(66),USERNAME ANY USER NAME AND ADDRESS                  
         BNZ   *+10                 YES                                         
         MVC   USERNAME(66),SVUSER                                              
*                                                                               
         SR    R0,R0                                                            
         ICM   R0,3,PRGUNITS         CTR                                        
         BAS   RE,EDT              GO EDIT FIELD                                
         MVC   LUNITS,ELEM      O/P                                             
*                                                                               
         SR    R0,R0                                                            
         ICM   R0,3,PRGFEEDS                                                    
         BAS   RE,EDT              GO EDIT FIELD                                
         MVC   LFEEDS,ELEM+1    O/P                                             
*        EDIT  (R0),(3,LFEEDS),ZERO=NOBLANK                                     
*                                                                               
* IF PRGFLG IS 08, PROG CODE IS EQUIV AND NOT COVERED *                         
*                                                                               
         TM    PRGFLG,PRGFLGEQ                                                  
         BZ    *+14                                                             
         MVC   LCUREVNO(15),=C'EQUIVALENT CODE'                                 
         B     LRL14                                                            
*                                                                               
* IF PROGRAM REVISION NUMBER AND DATE ZERO, NET ASSIGN NEVER RUN *              
*                                                                               
         OC    PRGCREVN(4),PRGCREVN                                             
         BNZ   *+14                                                             
         MVC   LCUREVNO(16),=C'NO CMLS ASSIGNED'                                
         B     LRL14                                                            
*                                                                               
         CLI   SVTN1PR5,C'C'       OPTION TO PRINT CHANGES ONLY                 
         BNE   *+22                                                             
         TM    PRGFLG,PRGFLGNU     SET OFF NO UNITS FLAG                        
         BZ    *+14                                                             
         MVC   LCUREVNO(16),=C'NO CHANGED UNITS'                                
         B     LRL14                                                            
*                                                                               
         LLC   R0,PRGCREVN                                                      
         BAS   RE,EDT                                                           
*        EDIT  (R0),(3,LCUREVNO),ZERO=NOBLANK,ALIGN=LEFT                        
         MVC   LCUREVNO,ELEM+2                                                  
*                                                                               
         OC    PRGCREVD,PRGCREVD   IF NO CURRENT REV DATE                       
         BNZ   LRL11                                                            
         CLC   PRGUNITS,PRGDEL                                                  
         BE    LRL24B                                                           
         B     ASGNERR             TELL'EM TO NET ASSIGN                        
*                                                                               
         FIXDT02                                                                
LRL11    GOTO1 DATCON,DMCB,(2,PRGCREVD),(8,LCUREVDT)                            
         MVI   LCUREVDT+8,C'-'                                                  
*                                                                               
         OC    PRGPREVN(3),PRGPREVN ANY PREVIOUS                                
         BNZ   LRL12                                                            
         MVC   LPREVDT(8),=CL8'ORIGINAL'                                        
         B     LRL14                                                            
*                                                                               
         FIXDT02                                                                
LRL12    GOTO1 (RF),(R1),(2,PRGPREVD),(8,LPREVDT)                               
         MVI   LPREVDT+8,C'-'                                                   
*        EDIT  (B1,PRGPREVN),(3,LPREVNO),ZERO=NOBLANK,ALIGN=LEFT                
         LLC   R0,PRGPREVN                                                      
         BAS   RE,EDT                                                           
         MVC   LPREVNO,ELEM+1                                                   
*                                                                               
LRL14    OC    PRGUNAS,PRGUNAS    ANY UNITS WITHOUT COMMERCIALS                 
         BZ    LRL16                                                            
         SR    R0,R0                                                            
         ICM   R0,3,PRGUNAS        CTR                                          
         BAS   RE,EDT              GO EDIT FIELD                                
         MVC   LUNASUNT,ELEM        O/P                                         
*                                                                               
*        EDIT  (B2,PRGUNAS),(3,LUNASUNT)                                        
*                                                                               
LRL16    OC    PRGUNAL,PRGUNAL    ANY UNITS-NO PRODUCT (UNALLOCATED)            
         BZ    LRL20                                                            
         SR    R0,R0                                                            
         ICM   R0,3,PRGUNAL        CTR                                          
         BAS   RE,EDT              GO EDIT FIELD                                
         MVC   LUNALUNT,ELEM        O/P                                         
*                                                                               
*        EDIT  (B2,PRGUNAL),(3,LUNALUNT)                                        
*                                                                               
LRL20    OC    PRGDEL,PRGDEL      ANY DELETED UNITS                             
         BZ    LRL24                                                            
         TM    PRGFLG,PRGFLGPP    INSTR RUN FOR THIS REV                        
         BO    LRL22               YES, CAN'T BE ORIG                           
         CLI   PRGCREVN,0         THIS ORIGINAL INSTR                           
         BE    LRL24              NO DELETES                                    
*                                                                               
LRL22    SR    R0,R0                                                            
         ICM   R0,3,PRGDEL         CTR                                          
         BAS   RE,EDT              GO EDIT FIELD                                
         MVC   LDELUNT,ELEM+1      O/P                                          
*                                                                               
*        EDIT  (B2,PRGDEL),(3,LDELUNT)                                          
*                                                                               
LRL24    CLI   SVTWPR06,C'N'       ANY FAX REQUIRED                             
         BE    LRL24A               NO                                          
         CLI   PRGFAX,0            IS THIS FAX BY PROGRAM                       
         BE    *+8                  NO                                          
         MVI   LPRGFAX,C'P'                                                     
*                                                                               
LRL24A   OI    6(R2),X'80'                                                      
*                                                                               
LRL24B   LA    R5,PRGNEXT                                                       
*PRG                                                                            
         C     R5,APRGTBLX           AT END OF TABLE                            
         BNL   LRL30                                                            
*PRG                                                                            
         OC    0(4,R5),0(R5)       END OF TABLE                                 
         BNZ   *+16                                                             
LRL30    TM    TABLESW,X'40'       TABLE FULL?                                  
         BO    LRL40                                                            
         B     LRL50                                                            
*                                                                               
         TM    PRGFLG,PRGXCLUD     EXCLUDE THIS PROG?                           
         BO    LRL24B               YES, GET NEXT PROG                          
*                                                                               
         LLC   R0,0(R2)                                                         
         AR    R2,R0                                                            
         CLI   0(R2),9             END OF SCREEN                                
         BH    LRL10               NO                                           
*                                                                               
LRL40    MVC   GERROR,=Y(MOREMSG)                                               
         B     *+10                                                             
LRL50    MVC   GERROR,=Y(DONEMSG)                                               
*                                                                               
         MVI   GMSGTYPE,C'I'                                                    
         S     R5,APRGTBLE         SAVE                                         
         ST    R5,ASVNEXT          1ST PGM NXT SCREEN/SO CSEL WILL END          
         LA    R2,TRASEL1H                                                      
         B     COMXIT                                                           
         DROP  R2,R5                                                            
*                                                                               
* COMMON EDIT RTN *                                                             
*                                                                               
         DS   0H                                                                
EDT      NTR1                                                                   
         EDIT  (R0),(4,ELEM),ZERO=NOBLANK                                       
         B     EXIT                                                             
         EJECT                                                                  
* GENERATE OFFLINE INSTRUCTIONS HERE                                            
*                                                                               
LRR      L     R5,APRGTBLE         START OF UNIT TABLE                          
         MVI   FRSTPGSW,C'Y'                                                    
         USING PRGTABLED,R5                                                     
*                                                                               
         MVI   OPTICEOM,C'N'       RESET FLAG                                   
         CLI   TRAWRKRH+5,0        TEST OPTICA PDF RUN                          
         BE    *+8                                                              
         MVI   OPTICAGY,C'Y'       SET OPTICA AGENCY COPY                       
*                                                                               
         XC    ELEM,ELEM                                                        
         XC    PROFKEY,PROFKEY                                                  
         MVI   PROFKEY,C'S'                                                     
         MVC   PROFKEY+1(2),=C'TN'                                              
         MVC   PROFKEY+3(2),TWAORIG                                             
         GOTO1 PQPROF,DMCB,(X'80',PROFKEY),(0,ELEM),ACOMFACS                    
         CLI   8(R1),0                                                          
         BE    *+6                                                              
         DC    H'0'                                                             
         LA    R4,ELEM                                                          
         USING REMOTED,R4                                                       
         MVC   SVQLTYP1,REMOTTY1                                                
*AR                                                                             
         MVC   SVQLARC,REMOTARC                                                 
*AR                                                                             
         CLI   REMOTSUB,C'#'                                                    
         BNE   L0RR03                                                           
         CLI   REMOTSUB+1,C'N'                                                  
         BE    L0RR05                                                           
         CLI   REMOTSUB+1,C'A'                                                  
         BNE   L0RR03                                                           
         OI    SVFAXARC,REMOTARQ                                                
         B     L0RR05                                                           
L0RR03   OI    SVFAXARC,REMOTAEQ                                                
L0RR05   DS    0H                                                               
         DROP  R4                                                               
*                                                                               
LRR02    TM    PRGFLG,PRGXCLUD     EXCLUDE THIS PROG                            
         BO    LRR20                YES, GET NEXT PROGRAM                       
         MVC   SVPRGFAX,PRGFAX                                                  
*                                                                               
LRR10    DS    0H                                                               
         OC    PRGCREVN(4),PRGCREVN   WAS NET ASSIGN/SEED RUN?                  
         BZ    LRR20                   NO, CAN'T PRINT INSTRUCTIONS             
*                                                                               
LRR12    TM    SVOPTSW,OPTUNAL     PRD=UNAL - UNALLOCATED PRODUCT               
         BO    LRR14                                                            
         CLI   SVTNPR3,C'Y'        TN PROF ALLOW UNALLOCATED UNITS              
         BE    LRR14                                                            
         OC    PRGUNAL,PRGUNAL     ANY UNITS UNALLOCATED PRODUCT                
         BNZ   LRR20                BYPASS                                      
*                                                                               
LRR14    TM    SVOPTSW,OPTUNAS       UNASSIGNED UNITS OK                        
         BO    LRR16                                                            
         CLI   SVTNPR14,C'Y'       DEFAULT TO UNASSIGNED OK?                    
         BE    LRR16                                                            
         OC    PRGUNAS,PRGUNAS     ANY UNITS WITHOUT CML ASSIGNED               
         BNZ   LRR20                BYPASS                                      
*                                                                               
LRR16    DS    0H                                                               
*                                                                               
* SEE IF WE ARE FAXING MORE THAN ONE PROGRAM TO SAME DESTINATION                
*                                                                               
LRR18    DS    0H                                                               
         LA    RF,PRGNEXT                                                       
*PRG                                                                            
LRR18A   C     RF,APRGTBLX           AT END OF TABLE                            
         BNL   LRR18D                                                           
*PRG                                                                            
         CLI   PRGPRG-PRGENT(RF),0 AT END OF TABLE                              
         BE    LRR18D               YES                                         
         TM    PRGFLG-PRGENT(RF),PRGXCLUD EXCLUDE THIS PROG                     
         BZ    *+12                                                             
         LA    RF,L'PRGENT(RF)                                                  
         B     LRR18A                                                           
*                                                                               
         CLI   SVTWPR08,C'Y'       FAX EACH PROGRAM SEPARATELY                  
         BE    LRR18D               YES                                         
         CLC   PRGFAX,PRGFAX-PRGENT(RF)  NEXT ENTRY DIFFERENT DEST              
         BNE   LRR18D                                                           
         CLI   PRGFAX,0            FAX TO NETWORK                               
         BE    LRR18D               YES                                         
         OI    SVFLAG,SVMPRGFX     THIS IS A MULTI-PROGRAM FAX                  
*                                                                               
* PRINT INSTRUCTIONS FOR THIS PROGRAM *                                         
*                                                                               
LRR18D   BRAS  RE,PRT              PRINT INSTR                                  
*                                                                               
         MVC   PRGTSRKF,TSRKEYF    SAVE FIRST                                   
         MVC   PRGTSRKL,TSRKEYL    AND LAST TSAR RECORD NUMBER                  
*                                                                               
         CLI   SVTWPR06,C'N'       ANY FAX REQUIRED                             
         BE    LRR20                NO                                          
         TM    SVOPTSW1,OPTHDCPY   UNLESS AGENCY COPY                           
         BO    LRR20                                                            
         CLI   OPTICAGY,C'Y'                                                    
         BE    LRR20                                                            
*                                                                               
* SEE IF RUNNING OUT OF TSAROFF SPACE                                           
*                                                                               
         L     RF,TSARBYTE                                                      
         A     RF,=F'7000000'                                                   
         C     RF,TSARBUFL                                                      
         BL    LRR20                                                            
*                                                                               
         BRAS  RE,PRTSROF          PRINT PARTIAL FAX INFO                       
         BRAS  RE,INITTSR          RE-INIT TSAROFF                              
*                                                                               
LRR20    LA    R5,PRGNEXT          LOOK FOR NEXT PRG                            
*PRG                                                                            
         C     R5,APRGTBLX           AT END OF TABLE                            
         BNL   LRR25                                                            
*PRG                                                                            
         OC    0(4,R5),0(R5)       END                                          
         BZ    LRR25                                                            
         TM    PRGFLG,PRGXCLUD     EXCLUDE THIS PROG                            
         BO    *-18                 YES, GET NEXT PROGRAM                       
         CLC   USERNAME(66),SPACES   ANY USER NAME AND ADDRESS                  
         BNH   *+14                                                             
         OC    USERNAME(66),USERNAME ANY USER NAME AND ADDRESS                  
         BNZ   LRR10                YES                                         
         MVC   USERNAME(66),SVUSER                                              
         B     LRR10                                                            
*                                                                               
LRR25    CLI   OPTICAGY,C'Y'                                                    
         BNE   LRR26                                                            
         MVC   P1(26),=C'*** END OF DDS MESSAGE ***'                            
         MVI   LINE,2                                                           
         GOTO1 SPOOL,DMCB,(R8)                                                  
*                                                                               
LRR26    CLI   TRAWRKR,C' '       TEST OPTICA                                   
         BNH   LRR30               NO                                           
*                                                                               
         CLI   OPTICAGY,C'N'       TEST DID FAX COPY                            
         BE    LRR30               YES - DONE                                   
         CLI   TRAFAX,C'N'         TEST FAX COPY WANTED                         
         JE    LRR30               NO                                           
                                                                                
* GO BACK AND DO FAX COPIES                                                     
                                                                                
         MVI   OPTICAGY,C'N'       SET TO DO FAX PASS                           
         L     R5,APRGTBLE         START OF UNIT TABLE                          
         B     LRR02              PRINT FAX COPIES                              
*                                                                               
* PRINT ERROR REPORT FOR PROGRAMS WITH ERRORS AND POSSIBLE FAX *                
*                                                                               
LRR30    BRAS  RE,PER               PRINT ERROR REPORT                          
         B     EXIT                                                             
         EJECT                                                                  
*=================================================================              
* PRINT INSTRUCTIONS FOR THIS NETWORK/PROGRAM, USER HAS SELECTED                
* INSTRUCTIONS, NOW FIND FIRST TABLE ENTRY FOR THIS PROGRAM,                    
* THEN BUILD UNIT TABLE AND PRINT INSTRUCTIONS FOR THIS PROGRAM                 
*=================================================================              
                                                                                
         USING PRGTABLED,R5                                                     
GEN      NTR1                                                                   
         LLC   R6,0(R2)                                                         
         AR    R6,R2                                                            
         USING LSTLINE,R6                                                       
GEN10    CLC   PRGPRG,LPROG                                                     
         BE    GEN14                                                            
         LA    R5,PRGNEXT                                                       
*PRG                                                                            
         C     R5,APRGTBLX           AT END OF TABLE                            
         BL    *+6                                                              
         DC    H'0'                                                             
*PRG                                                                            
         CLI   PRGPRG,0            AT END OF TABLE                              
         BNE   GEN10                                                            
         DC    H'0'                                                             
*                                                                               
GEN14    DS   0H                                                                
         OC    PRGDEL,PRGDEL       IF DELETED UNITS, ONLY UNAL OK               
         BNZ   GEN16                                                            
         CLC   PRGUNITS,PRGUNAL    IF ALL UNALLOCATED, BYPASS                   
         BNH   ALLUNAL                                                          
*                                                                               
GEN16    TM    SVOPTSW,OPTUNAL     PRD=UNAL - UNALLOCATED PRODUCT               
         BO    GEN20                                                            
         CLI   SVTNPR3,C'Y'        TN PROF ALLOW UNALLOCATED UNITS              
         BE    GEN20                                                            
         OC    PRGUNAL,PRGUNAL     ANY UNITS UNALLOCATED PRODUCT                
         BNZ   NOPRDER              YES, CAN'T PRINT INSTRUCTIONS               
*                                                                               
GEN20    TM    SVOPTSW,OPTUNAS       UNASSIGNED UNITS OK                        
         BO    GEN22                                                            
         CLI   SVTNPR14,C'Y'       DEFAULT TO UNASSIGNED OK?                    
         BE    GEN22                                                            
         OC    PRGUNAS,PRGUNAS     ANY UNITS WITHOUT CML ASSIGNED               
         BNZ   NOCMLER              YES, CAN'T PRINT INSTRUCTIONS               
*                                                                               
GEN22    TM    PRGFLG,PRGFLGEQ      EQUIVALENT PROG CODE ERROR                  
         BZ    *+14                                                             
         MVC   GERROR,=Y(EQVUNCV)                                               
         B     ERREXIT                                                          
*                                                                               
         CLI   SVTN1PR5,C'C'       OPTION TO PRINT CHANGES ONLY                 
         BNE   GEN22C                                                           
         TM    PRGFLG,PRGFLGNU     SET OFF NO UNITS FLAG                        
         BZ    GEN22C                                                           
         MVC   GERROR,=Y(NOCHGUNT)                                              
         B     ERREXIT                                                          
*                                                                               
GEN22C   DS    0H                                                               
*                                                                               
* SEE IF WE ARE LOCKED OUT BY UNIT ALLOCATION                                   
*                                                                               
         XC    DUB,DUB                                                          
         MVI   BYTE,0                                                           
         MVC   DUB(4),=C'TNET'                                                  
         GOTO1 VALILOC,0                                                        
*                                                                               
* IF RUNNING FOR ALL PRODUCTS, SEE THAT NONE OF THE PRODS ARE LOCKED            
*                                                                               
         CLI   SVTN2PRO+00,C'0'                                                 
         BE    *+12                                                             
         CLI   SVTN2PRO+00,0                                                    
         BNE   TLOCK150            NOT AN ALL PRODUCT RUN                       
*                                                                               
* GET PRODUCTS FOR THIS CLIENT                                                  
*                                                                               
         BRAS  RE,INITSPT                                                       
*                                                                               
         XC    SVCPROD,SVCPROD     INIT PROD                                    
         XC    KEY,KEY                                                          
         MVC   KEY(2),=X'0DF1'      PROD REC                                    
         MVC   KEY+2(3),BAGYMD    & BCLT                                        
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
TLOCK135 CLC   KEY(5),KEYSAVE                                                   
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLI   KEY+5,X'FF'         LAST REC FOR THIS CLT                        
         BNE   *+14                                                             
         XC    SVCPROD,SVCPROD     CLEAR PROD                                   
         B     TLOCK1X              YES, DONE                                   
*                                                                               
         MVC   SVCPROD,KEY+6       SAVE 3 CHAR PROD                             
*                                                                               
         XC    DUB,DUB                                                          
         MVI   DUB,C'T'            TEST                                         
         MVI   DUB+1,X'FF'         NET (TRAFFIC)                                
         MVC   DUB+2(4),TRANET     NETWORK                                      
         GOTO1 VALILOC,SVCPROD                                                  
*                                                                               
         XC    DUB,DUB                                                          
         MVI   DUB,C'T'            TEST                                         
         MVI   DUB+1,X'FF'         NET (TRAFFIC)                                
         MVI   DUB+2,X'FF'         NETWORK=ALL                                  
         MVC   DUB+3(1),SVMEDIA    MEDIA                                        
         GOTO1 VALILOC,SVCPROD                                                  
*                                                                               
         GOTO1 SEQ                 GET NEXT PROD REC                            
         B     TLOCK135                                                         
*                                                                               
* IF RUNNING BY PRODUCT, SEE THAT THIS PRD IS NOT LOCKED (NOP'D)                
*                                                                               
TLOCK150 CLI   SVTN2PRO+00,C'*'                                                 
         BNE   TLOCK160                                                         
         MVC   BYTE,SVTN2PRO+00                                                 
         XC    DUB,DUB                                                          
         MVI   DUB,C'T'            TEST                                         
         MVI   DUB+1,X'FF'         NET (TRAFFIC)                                
         MVC   DUB+2(4),TRANET     NETWORK                                      
         MVC   SVCPROD,VOPTPROD                                                 
         GOTO1 VALILOC,SVCPROD                                                  
*                                                                               
         XC    DUB,DUB                                                          
         MVI   DUB,C'T'            TEST                                         
         MVI   DUB+1,X'FF'         NET (TRAFFIC)                                
         MVI   DUB+2,X'FF'         NETWORK=ALL                                  
         MVC   DUB+3(1),SVMEDIA    MEDIA                                        
         GOTO1 VALILOC,SVCPROD                                                  
         B     TLOCK1X                                                          
*                                                                               
* IF RUNNING BY PGROUP, SEE THAT THOSE PRD ARE NOT LOCKED                       
*                                                                               
TLOCK160 OC    VOPTPRGR,VOPTPRGR   PROD GROUP                                   
         BNZ   *+6                                                              
         DC    H'0'                BUG CATCHER                                  
*                                                                               
         MVC   BYTE,SVTN2PRO+00                                                 
         XC    DUB,DUB                                                          
         MVI   DUB,C'T'            TEST                                         
         MVI   DUB+1,X'FF'         NET (TRAFFIC)                                
         MVC   DUB+2(4),TRANET     NETWORK                                      
         MVC   DUB+6(2),VOPTPRGR   THIS PGROUP LOCKED?                          
         GOTO1 VALILOC,0                                                        
*                                                                               
         XC    DUB,DUB                                                          
         MVI   DUB,C'T'            TEST                                         
         MVI   DUB+1,X'FF'         NET (TRAFFIC)                                
         MVI   DUB+2,X'FF'         NETWORK=ALL                                  
         MVC   DUB+3(1),SVMEDIA    MEDIA                                        
         MVC   DUB+6(2),VOPTPRGR   THIS PGROUP LOCKED?                          
         GOTO1 VALILOC,0                                                        
*                                                                               
TLOCK1X  DS    0H                                                               
*                                                                               
* PRINT INSTRUCTIONS FOR THIS PROGRAM *                                         
*                                                                               
         BRAS  RE,PRT                                                           
         MVC   PRGTSRKF,TSRKEYF    SAVE FIRST                                   
         MVC   PRGTSRKL,TSRKEYL    AND LAST TSAR RECORD NUMBER                  
         EJECT                                                                  
* DISPLAY SPOOL ID FOR USER *                                                   
*                                                                               
         OI    6(R6),X'80'         SET XMT                                      
*                                                                               
         OC    SVSPLRPN,SVSPLRPN   DID WE HAVE MULTI-FAX NUMBERS                
         BZ    GEN25               NO                                           
*                                                                               
         LA    R1,SVSPLRPN         POINT TO THE LIST OF REPORT IDS              
         LR    RF,R1                                                            
         LA    R1,L'SVSPLRPN-1(R1) POINT TO THE END OF THE LIST                 
*                                                                               
GEN23    CLI   0(R1),C' '                                                       
         BH    *+12                                                             
         BCTR  R1,0                                                             
         CR    RF,R1               CHECK FOR BEGIN OF THE LIST                  
         BL    GEN23               NO                                           
*                                                                               
         CLI   0(R1),C','                                                       
         BNE   *+10                                                             
         MVI   0(R1),C' '          BLANK OUT THE LAST COMMA                     
         BCTR  R1,0                                                             
         SR    R1,RF               GET THE LENGTH                               
*                                                                               
         L     R4,SVLSTLN          LIST LINE                                    
         AR    R4,RA                                                            
         OI    6(R4),X'80'         TRANSMIT                                     
*                                                                               
         LA    RE,LPRTID                                                        
         SR    RE,R1               POSSIBLE PRINT LOCATION                      
*                                                                               
         XC    LPRGFAX,LPRGFAX                                                  
*                                                                               
         XC    LPRTID,LPRTID                                                    
         LA    R0,LPRTID                                                        
         CR    R0,RE                                                            
         BNH   GEN23B                                                           
*                                                                               
         XC    LDELUNT,LDELUNT                                                  
         LA    R0,LDELUNT                                                       
         CR    R0,RE                                                            
         BNH   GEN23B                                                           
*                                                                               
         XC    LUNALUNT,LUNALUNT                                                
         LA    R0,LUNALUNT                                                      
         CR    R0,RE                                                            
         BNH   GEN23B                                                           
*                                                                               
         XC    LUNASUNT,LUNASUNT                                                
         LA    R0,LUNASUNT                                                      
         CR    R0,RE                                                            
         BNH   GEN23B                                                           
*                                                                               
         XC    LUNITS,LUNITS                                                    
         XC    LFEEDS,LFEEDS                                                    
         LA    R0,LUNITS                                                        
         CR    R0,RE                                                            
         BNH   GEN23B                                                           
         DC    H'0'                LISTLINE OVERFLOW                            
*                                                                               
GEN23B   LR    RE,R0               NEW PRINT LOCATION                           
         MVC   0(3,RE),=C'ID='                                                  
         MVC   3(3,RE),REMUSER                                                  
         MVI   6(RE),C','                                                       
         LA    RE,7(RE)                                                         
*                                                                               
         EX    R1,PRNMVC                                                        
         B     GEN28                                                            
*                                                                               
PRNMVC   MVC   0(0,RE),0(RF)        EXECUTED MVC                                
*                                                                               
GEN25    MVC   LPRTID(3),=C'ID='                                                
         MVC   LPRTID+3(3),REMUSER                                              
         MVI   LPRTID+6,C','                                                    
         SR    R0,R0                                                            
         ICM   R0,3,SPOOLRPN                                                    
         EDIT  (R0),(5,LPRTID+7),ALIGN=LEFT                                     
         XC    SVSPLRPN,SVSPLRPN                                                
         MVC   SVSPLRPN(5),LPRTID+7                                             
*                                                                               
GEN28    CLI   INSPRTSW,C'N'       DID WE GENERATE INSTRUCTIONS                 
         BNE   GEN30                                                            
         MVC   LPRTID-4(17),=CL17'NO DATA GENERATED'                            
         B     GEN40                                                            
*                                                                               
GEN30    DS    0H                                                               
         CLI   SVTN2PRO+12,C'Y'    OVERNIGHT FAX                                
         BNE   GEN35                NO                                          
*                                                                               
         CLI   SVTWPR06,C'N'                                                    
         BE    GEN40                                                            
*                                                                               
         MVC   SVPRGPRG,PRGPRG                                                  
         OI    SVFLAG1,SVOVREC     LOOK FOR RECORD W/OVERNIGHT FAX              
*                                                                               
         BRAS  RE,FDPREC           FIND DAYPART RECORD FOR OV-FAX               
         BNE   GEN35                NO FAX FOUND                                
*                                                                               
         MVI   BYTE,C'@'                                                        
         BRAS  RE,REQ              GEN REQUEST FOR OVERNIGHT FAX                
*                                                                               
GEN35    CLI   SVTWPR06,C'2'       THIS FAX RUN WITH AGY COPY REQUEST           
         BNE   GEN40                                                            
*                                                                               
         CLI   SVTWPR07,C'Y'       PRINT FAX COPY NOW                           
         BE    GEN40                YES, NO OFFLINE REQ NEEDED                  
*                                                                               
         MVI   BYTE,C'#'                                                        
         BRAS  RE,REQ              GO GEN REQUEST FOR OFFLINE AGY COPY          
*                                                                               
* MODIFY SELECT FIELD *                                                         
*                                                                               
GEN40    XC    8(3,R2),8(R2)       BLANK IT                                     
         MVI   8(R2),C'*'          MARK DONE                                    
         OI    6(R2),X'80'+X'20'   TRANSMIT AND CHANGE TO PROTECTED             
         B     EXIT                                                             
         DROP  R6                                                               
         EJECT                                                                  
* DELETE ANY EQUAL NON-SPECIAL CHARACTER ENTRIES FROM COPY LIST   *             
* ENTRY IS BLANKED OUT, NOT DELETED TO LEAVE PRINT PATTERN INTACT *             
*                                                                               
DEQ      L     RF,ASVCPYLS                                                      
DEQ10    CR    RF,R2               AT END OF LIST                               
         BER   RE                                                               
         CLC   0(30,RF),0(R2)                                                   
         BNE   DEQ16                                                            
         CLC   0(29,R2),1(R2)      IF SAME CHAR IN ALL LINE                     
         BE    DEQ16               LEAVE ALONE                                  
         LA    R1,29(,RF)          START AT RIGHT                               
         LA    R0,30                                                            
*                                                                               
* IF ALL BLANKS OR SPECIAL CHARACTERS, LEAVE *                                  
*                                                                               
DEQ12    CLI   0(R1),X'C0'         IF ALPHA                                     
         BH    DEQ20               BLANK IT OUT                                 
         BCTR  R1,0                                                             
         BCT   R0,DEQ12                                                         
DEQ16    LA    RF,30(,RF)                                                       
         B     DEQ10                                                            
DEQ20    XC    0(30,R2),0(R2)      CLEAR EQUAL ENTRY                            
         BR    RE                                                               
                                                                                
* CLEAR DISPLAY AREA OF SCREEN *                                                
                                                                                
CLRSCR   LA    RF,TRASEL1H                                                      
*                                                                               
CLRSCR10 OC    8(L'TRASEL1,RF),8(RF)                                            
         BZ    CLRSCR20                                                         
         CLC   8(L'TRASEL1,RF),SPACES                                           
         BE    CLRSCR20                                                         
         XC    8(L'TRASEL1,RF),8(RF)                                            
         OI    6(RF),X'80'                                                      
         OI    1(RF),X'20'         SET PROTECT BIT                              
CLRSCR20 LLC   R0,0(RF)                                                         
         AR    RF,R0                                                            
*                                                                               
         OC    8(L'TRADSP1,RF),8(RF)                                            
         BZ    CLRSCR30                                                         
         CLC   8(L'TRADSP1,RF),SPACES                                           
         BE    CLRSCR30                                                         
         XC    8(L'TRADSP1,RF),8(RF)                                            
         OI    6(RF),X'80'                                                      
*                                                                               
CLRSCR30 IC    R0,0(RF)                                                         
         AR    RF,R0                                                            
         CLI   0(RF),9                                                          
         BH    CLRSCR10                                                         
         BR    RE                                                               
         PRINT NOGEN                                                            
         EJECT                                                                  
*        ERROR ROUTINES                                                         
*                                                                               
NOCMLER  CLI   SVTWPR07,C'Y'       PRINT FAX COPY NOW                           
         BNE   NOCMLERA                                                         
*                                                                               
* TSAR PRINT HERE                                                               
*                                                                               
         OC    TSARCT,TSARCT       ANY COPIES TO PRINT                          
         BZ    NOCMLERA             NO                                          
*                                                                               
         BRAS  RE,PCPY             GO PRINT COPY                                
*                                                                               
         BAS   RE,DCPY             DISPLAY COPY ID                              
         B     NOCMLERA                                                         
*                                                                               
* NO FAX FOUND                                                                  
*                                                                               
FAXERR   DS    0H                                                               
         CLI   ERRFILSW,0          WAS ERROR FILE OPENED                        
         BE    FAXERR10             NO                                          
         CLI   ERRFILSW,1          BUG CATCHER                                  
         BE    *+6                                                              
         DC    H'0'                                                             
         BRAS  RE,PER               PRINT ERROR REPORT                          
*                                                                               
FAXERR10 LA    R2,TRANETH                                                       
         MVC   GERROR,=Y(NOFAX)                                                 
         XC    ELEM,ELEM                                                        
         LA    R1,ELEM                                                          
         STCM  R1,7,GASUBST        A(SUBST TEXT)                                
         MVI   ELEM,8              L'SUBST TEXT+1                               
         MVC   ELEM+1(7),=C'NETWORK'                                            
         CLI   SVTWPR11,C'Y'       TRAFFIC RECS FOR FAX #                       
         BNE   *+10                                                             
         MVC   ELEM+1(7),=C'TRAFFIC'                                            
*                                                                               
         NI    TRANETH+4,X'FF'-X'20' SET OFF VALIDATED                          
         GOTO1 VTRAERR                                                          
*                                                                               
*                                                                               
* TELL THEM TO NET ASSIGN BEFORE NINS GEN                                       
*                                                                               
*                                                                               
ASGNERR  CLI   ERRFILSW,0          IS ERROR FILE CLOSE                          
         BE    ASGN05               YES                                         
*                                                                               
         L     R2,AERRFILE                                                      
         CLOSE ((R2),)                                                          
         FREEPOOL (R2)                                                          
         MVI   ERRFILSW,0                                                       
*                                                                               
ASGN05   LA    R2,TRACLTH                                                       
         MVC   GERROR,=Y(ASGNMSG)  RUN NET ASSIGN ERROR MSG                     
         MVC   ERRTEXT(6),PRGPRG                                                
         NI    TRACLTH+4,X'FF'-X'20' SET OFF VALIDATED                          
         GOTO1 VTRAERR                                                          
*                                                                               
NOCMLERA MVC   GERROR,=Y(UNTNOCML)                                              
         B     ERREXIT                                                          
*                                                                               
ALLUNAL  MVC   GERROR,=Y(UNALERR)                                               
         B     ERREXIT                                                          
*                                                                               
NOPRDER  MVC   GERROR,=Y(UNALPRD)                                               
         B     ERREXIT                                                          
*                                                                               
COMXIT   DS    0H                                                               
ERREXIT  CLI   ERRFILSW,0          WAS ERROR FILE OPENED                        
         BE    TRAPERRX             NO                                          
         CLI   ERRFILSW,1          BUG CATCHER                                  
         BE    *+6                                                              
         DC    H'0'                                                             
         BRAS  RE,PER               PRINT ERROR REPORT                          
         B     TRAPERRX                                                         
*                                                                               
COMERMVC MVC   CONHEAD(0),1(R1)                                                 
*                                                                               
BDCMLN   MVI   ERROR,INVCMMLN                                                   
         B     TRAPERR                                                          
*                                                                               
NOCOMREC MVI   ERROR,NOCOMM                                                     
         B     TRAPERR                                                          
*                                                                               
INVCMLER MVI   ERROR,INVCOMM                                                    
         B     TRAPERR                                                          
*                                                                               
PRDINV   MVI   ERROR,INVPRDCD                                                   
         B     TRAPERR                                                          
*                                                                               
MISSERR  MVI   ERROR,MISSING                                                    
         B     TRAPERR                                                          
*                                                                               
MAXIOERR DS    0H                                                               
         OI    TRATAGH+1,X'01'     SET MODIFIED BIT                             
         OI    TRATAGH+6,X'80'     TRANSMIT                                     
         MVC   GERROR,=Y(MOPROCES)                                              
         GOTO1 VTRAERR                                                          
*                                                                               
NUMERR   MVI   ERROR,NOTNUM                                                     
*                                                                               
TRAPERR  LLC   R0,ERROR                                                         
         STH   R0,GERROR                                                        
*                                                                               
TRAPERRX GOTO1 VTRAERR                                                          
         LTORG                                                                  
         EJECT                                                                  
HEADING  SSPEC H1,3,AGYNAME                                                     
         SSPEC H2,3,AGYADD                                                      
*                                                                               
         SSPEC H1,39,C'NETWORK COMMERCIAL SCHEDULE'                             
         SSPEC H2,39,C'---------------------------'                             
         SSPEC H3,40,C'PERIOD'                                                  
*                                                                               
         SSPEC H1,85,REPORT                                                     
         SSPEC H2,85,RUN                                                        
         SSPEC H3,85,PAGE                                                       
         SSPEC H3,93,REQUESTOR                                                  
         DC    X'00'               END MARKER FOR SSPECS                        
*                                                                               
* MODEL DCB FOR AUTO REQUEST FILE-MOVED TO CORE RESIDENT AREA FOR USE           
ERRFILE  DCB   BLKSIZE=3200,DDNAME=ERRFILE,DSORG=PS,LRECL=32,MACRF=PM, X        
               RECFM=FB                                                         
*                                                                               
         DROP  R7                                                               
*                                                                               
*=============================================================                  
* READ PRODUCTION HOUSE RECORD FOR OPTICA                                       
*=============================================================                  
*                                                                               
RPHSE    NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         MVI   OPTICASW,0          INIT OPTICA SWITCH                           
         BRAS  RE,INITSPT                                                       
*                                                                               
         XC    KEY,KEY                                                          
         MVC   KEY(2),=X'0A21'                                                  
         MVC   KEY+2(3),BAGYMD     A-M/CLT                                      
         MVC   KEY+5(8),=C'99999999'                                            
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BNE   RPHSEX                                                           
*                                                                               
         L     R6,AIO1                                                          
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
*                                                                               
         LA    R6,24(R6)                                                        
         CLI   0(R6),X'10'                                                      
         BE    *+6                 NO X'10' ELEM                                
         DC    H'0'                                                             
*                                                                               
         USING CMLDTAEL,R6                                                      
*                                                                               
* BUILD PRODUCTION HOUSE KEY *                                                  
*                                                                               
         XC    KEY,KEY                                                          
         MVC   KEY(2),=X'0A29'                                                  
         MVC   KEY+2(1),BAGYMD                                                  
         MVC   KEY+3(6),CMLTITLE   PROD HOUSE ID IS IN TITLE                    
         OC    KEY+3(6),SPACES                                                  
         DROP  R6                                                               
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R6,AIO1                                                          
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
*                                                                               
         L     R6,AIO1                                                          
         MVI   ELCODE,X'25'        OPTICA ELEMENT                               
         BRAS  RE,GETEL                                                         
         BNE   RPHSEX                                                           
*                                                                               
         USING PRHOPCEL,R6                                                      
*&&DO                                                                           
         CLC   =C'SPG',PRHOPC      OPTICA COMPANY                               
         BE    RPHSE20                                                          
*                                                                               
         CLC   =C'YNG',PRHOPC      OPTICA COMPANY                               
         BE    RPHSE20                                                          
*                                                                               
         CLC   =C'CAD',PRHOPC      OPTICA COMPANY                               
         BNE   RPHSEX                                                           
*&&                                                                             
         CLC   =C'ER ',PRHOPC      OPTICA COMPANY                               
         BNE   RPHSEX                                                           
*                                                                               
RPHSE20  MVI   OPTICASW,C'Y'                                                    
*                                                                               
         DROP  R6                                                               
*                                                                               
RPHSEX   BRAS  RE,INITNET          SET FOR UNTDIR/UNTFIL                        
         XIT1                                                                   
*                                                                               
*======================================================                         
* FIND DAYPART CODE FAX NUMBER                                                  
*======================================================                         
                                                                                
FDPCFAX  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         XC    SVDPCTBD,SVDPCTBD   CLEAR FAX TABLE (+1 TABLE LEN)               
*                                                                               
         BRAS  RE,FDPREC           FIND DAYPART RECORD FOR OV-FAX               
         BNE   FDPCXNX                                                          
*VEN                                                                            
         L     R6,AIO2                                                          
         LA    R6,27(R6)                                                        
         MVI   ELCODE,X'80'        PRESET TO NETWORK FAX ELEM                   
         BRAS  RE,FIRSTEL                                                       
         BNE   FDPC10                                                           
                                                                                
         USING FAXVEMEL,R6                                                      
         LA    R5,SVDPCTBL         FAX TABLE                                    
         LA    R2,12               ENTRY LENGTH                                 
*                                                                               
FDPC05   XC    BLDPCFAX,BLDPCFAX                                                
         LA    R1,BLDPCFAX                                                      
         OC    FAXVFAX,FAXVFAX                                                  
         BZ    FDPC07                                                           
         MVC   0(L'FAXVFAX,R1),FAXVFAX     AREA CODE                            
         STC   R2,0(R5)            ENTRY LENGTH                                 
*                                                                               
         LLC   R1,SVDPCLEN                                                      
         LA    R1,1(R2,R1)         LEN OF FAX ENTRY+1                           
         STC   R1,SVDPCLEN         TOTAL LENGTH                                 
*                                                                               
         MVC   1(L'BLDPCFAX,R5),BLDPCFAX                                        
*                                                                               
         LA    R5,1(R2,R5)         BUMP IN TABLE                                
FDPC07   BRAS  RE,NEXTEL                                                        
         BE    FDPC05                                                           
*        LLC   R1,SVDPCLEN                                                      
*        MVI   0(R1),X'FF'        ITS AN OV-FAX                                 
         B     FDPC30                                                           
*                                                                               
         DROP  R6                                                               
*VEN                                                                            
*                                                                               
FDPC10   DS    0H                                                               
         USING FAXNUMEL,R6                                                      
         L     R6,AIO2                                                          
         LA    R6,27(R6)                                                        
*                                                                               
         MVI   ELCODE,X'30'        PRESET TO NETWORK FAX ELEM                   
*                                                                               
*VEN     TM    SVOPTSW2,OPTOVFAX   DOING OVERNIGHT FAXING?                      
*        BZ    *+8                  NO                                          
*VEN     MVI   ELCODE,X'40'        OVERNIGHT FAX # ELEM                         
*                                                                               
         BRAS  RE,FIRSTEL                                                       
         BE    FDPC15                                                           
*                                                                               
*VEN     CLI   ELCODE,X'40'        OV FAX                                       
*        BE    FDPCXNX                                                          
*VEN     DC    H'0'                                                             
*                                                                               
         USING FAXNUMEL,R6                                                      
*                                                                               
FDPC15   LA    R5,SVDPCTBL         FAX TABLE                                    
         LA    R2,12               ENTRY LENGTH                                 
*                                                                               
FDPC20   XC    BLDPCFAX,BLDPCFAX                                                
         LA    R1,BLDPCFAX                                                      
         CLI   FAXNUM1,C' '                                                     
         BNH   *+14                                                             
         MVC   0(1,R1),FAXNUM1     PREFIX                                       
         LA    R1,1(R1)                                                         
         MVC   0(3,R1),FAXNUMA     AREA CODE                                    
         MVC   3(3,R1),FAXNUME     EXCHANGE                                     
         MVC   6(4,R1),FAXNUMN     NUMBER                                       
*                                                                               
*VEN     CLI   ELCODE,X'40'                                                     
*        BNE   *+8                                                              
*VEN     MVI   11(R1),X'FF'        ITS AN OV-FAX                                
*                                                                               
         STC   R2,0(R5)            ENTRY LENGTH                                 
*                                                                               
         LLC   R1,SVDPCLEN                                                      
         LA    R1,1(R2,R1)         LEN OF FAX ENTRY+1                           
         STC   R1,SVDPCLEN         TOTAL LENGTH                                 
*                                                                               
         MVC   1(L'BLDPCFAX,R5),BLDPCFAX                                        
*                                                                               
         LA    R5,1(R2,R5)         BUMP IN TABLE                                
         BRAS  RE,NEXTEL                                                        
         BE    FDPC20                                                           
*                                                                               
*VEN     TM    SVOPTSW2,OPTOVFAX   DOING OVERNIGHT FAXING?                      
*        BO    FDPCEX               YES,DONE                                    
*                                                                               
*        CLI   SVTN2PRO+12,C'Y'    OV-FAX PROFILE IS SET ON                     
*        BNE   FDPC30                                                           
*                                                                               
*        CLI   ELCODE,X'40'        DID WE DO OV-FAX YET                         
*        BE    FDPC30               YES                                         
*                                                                               
*        L     R6,AIO2                                                          
*        LA    R6,27(R6)                                                        
*        MVI   ELCODE,X'40'        LOOK FOR OV-FAX NUMBER                       
*        BRAS  RE,FIRSTEL                                                       
*        BNE   FDPC30                                                           
*                                                                               
*        CLC   =C'OV',CONWHEN      OVERNIGHT                                    
*        BNE   FDPC30                                                           
*                                                                               
*        B     FDPC20                                                           
*VEN                                                                            
**** NOTE *** IF INTERNATIONAL FAXING WILL EVER BE USED                         
**** NEED TO RE-VISIT ABOVE CODE (ASSUMES OV-FAX LAST FAX IN TABLE)             
*                                                                               
FDPC30   L     R6,AIO2                                                          
         LA    R6,27(R6)           DISP TO THE ELEM                             
         MVI   ELCODE,X'50'        INTERNATIONAL FAX                            
         BRAS  RE,FIRSTEL                                                       
         BE    FDPC40                                                           
*                                                                               
         OC    SVDPCTBD,SVDPCTBD   ANY FAX FOUND?                               
         BZ    FDPCXNX              NO                                          
         B     FDPCEX                                                           
*                                                                               
         USING FAXIFEL,R6                                                       
*                                                                               
FDPC40   CLI   FAXIFAX,1           INTERNATIONAL FAX                            
         BE    *+6                                                              
         DC    H'0'                BUG CATCHER                                  
*                                                                               
         XC    BLDIFAX,BLDIFAX                                                  
         LA    R1,BLDIFAX                                                       
*                                                                               
         LA    R0,L'FAXIFAX-1      LENGTH OF FIELD IN ELEMENT -1                
*                                                                               
         MVC   0(3,R1),=C'011'                                                  
*                                                                               
         LA    R2,3                COUNTER                                      
         LA    R1,3(R1)            BUMP                                         
         LA    RF,FAXIFAX+1        INTERNATIONAL FAX                            
*                                                                               
FDPC50   CLC   0(1,RF),SPACES                                                   
         BNH   FDPC55              NO SPACES OR DASHES                          
*                                                                               
         MVC   0(1,R1),0(RF)       MOVE ONE DIGIT AT A TIME                     
         LA    R2,1(R2)            INCREMENT FEILD COUNTER                      
         LA    R1,1(R1)            BUMP                                         
*                                                                               
FDPC55   LA    RF,1(RF)            BUMP IN ELEMENT                              
         BCT   R0,FDPC50                                                        
*                                                                               
         CHI   R2,16                                                            
         BNH   *+6                                                              
         DC    H'0'                FAX TOO LONG, EDIDESID IS CL16               
*                                                                               
         BCTR  R2,0                                                             
         EX    R2,MVCFAX           MOVE FAX TO TABLE                            
         LA    R2,1(R2)                                                         
         STC   R2,0(R5)            SAVE FIELD LENGTH IN TABLE                   
*                                                                               
         LLC   R1,SVDPCLEN                                                      
         LA    R1,1(R2,R1)         FAX ENTRY LENGTH                             
         STC   R1,SVDPCLEN         TOTAL LENGTH                                 
*                                                                               
FDPCEX   CR    RB,RB               SET CC                                       
         B     *+6                                                              
FDPCXNX  CR    RB,RC               SET CC                                       
*                                                                               
         XIT1                                                                   
*                                                                               
MVCFAX   MVC   1(0,R5),BLDIFAX     MOVE FAX NUMBER TO TABLE                     
*                                                                               
OVFAXERR DS   0H                                                                
         CLI   OFFLINE,C'Y'        ONLY CLOSE IF OFFLINE                        
         BNE   OVFAXERA                                                         
*                                                                               
         CLI   ERRFILSW,0          WAS ERROR FILE OPENED                        
         BE    OVFAXERA             NO                                          
*                                                                               
         L     R2,AERRFILE                                                      
         CLOSE ((R2),)                                                          
         FREEPOOL (R2)                                                          
*                                                                               
OVFAXERA LA    R2,TRACLTH                                                       
         XC    CONHEAD,CONHEAD                                                  
         MVC   CONHEAD(L'OVFXMSG),OVFXMSG                                       
         GOTO1 ERREX2                                                           
OVFXMSG  DC    C'* ERROR * MISSING OVERNIGHT FAX NUMBER *'                      
         LTORG                                                                  
         DROP  R6                                                               
         EJECT                                                                  
*=================================================================              
* FIND DAYPART RECORD FOR OVERNIGHT FAXING                                      
* AND RETURN RECORD IN AIO2                                                     
*=================================================================              
                                                                                
FDPREC   NTR1  BASE=*,LABEL=*                                                   
         BRAS  RE,INITNET          SET FOR UNTDIR/UNTFIL                        
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING FAXKEY,R4           NETWORK FAX                                  
         MVI   FAXKID,X'26'        RECORD ID                                    
         MVC   FAXKAM,BAGYMD       AGY/MED                                      
FDP1     MVC   FAXKNET,NETWORK     ADD NETWORK                                  
         MVC   FAXKDPC,SVDPC       ADD DAYPART                                  
         MVC   FAXKPRG,SVPRGPRG    ADD PROGRAM                                  
         MVC   FAXKCLT,BCLT        ADD CLIENT                                   
         BRAS  RE,FDPGET                                                        
         JE    EQXIT                                                            
*                                                                               
FDP2     XC    FAXKCLT,FAXKCLT     REMOVE CLIENT                                
         MVC   FAXKOFC,SVCLTOFF    ADD OFFICE                                   
         BRAS  RE,FDPGET                                                        
         JE    EQXIT                                                            
*                                                                               
FDP3     MVI   FAXKDPC,0           REMOVE DAYPART                               
         MVI   FAXKOFC,0           REMOVE OFFICE                                
         MVC   FAXKCLT,BCLT        ADD CLIENT                                   
         BRAS  RE,FDPGET                                                        
         JE    EQXIT                                                            
*                                                                               
FDP4     XC    FAXKCLT,FAXKCLT     REMOVE CLIENT                                
         MVC   FAXKOFC,SVCLTOFF    ADD OFFICE                                   
         BRAS  RE,FDPGET                                                        
         JE    EQXIT                                                            
*                                                                               
FDP5     MVI   FAXKOFC,0           REMOVE OFFICE                                
         MVC   FAXKDPC,SVDPC       ADD DAYPART                                  
         BRAS  RE,FDPGET                                                        
         JE    EQXIT                                                            
*                                                                               
FDP6     XC    FAXKPRG,FAXKPRG     REMOVE PROGRAM                               
         MVC   FAXKCLT,BCLT        ADD CLIENT                                   
         BRAS  RE,FDPGET                                                        
         JE    EQXIT                                                            
*                                                                               
FDP7     XC    FAXKCLT,FAXKCLT     REMOVE CLIENT                                
         MVC   FAXKOFC,SVCLTOFF    ADD OFFICE                                   
         BRAS  RE,FDPGET                                                        
         JE    EQXIT                                                            
*                                                                               
FDP8     MVI   FAXKDPC,0           REMOVE DAYPART                               
         MVI   FAXKOFC,0           REMOVE OFFICE                                
         MVC   FAXKPRG,SVPRGPRG    ADD PROGRAM                                  
         BRAS  RE,FDPGET                                                        
         JE    EQXIT                                                            
*                                                                               
FDP9     XC    FAXKPRG,FAXKPRG     REMOVE PROGRAM                               
         MVC   FAXKCLT,BCLT        ADD CLIENT                                   
         BRAS  RE,FDPGET                                                        
         JE    EQXIT                                                            
*                                                                               
FDP10    XC    FAXKCLT,FAXKCLT     REMOVE CLIENT                                
         MVC   FAXKOFC,SVCLTOFF    ADD OFFICE                                   
         BRAS  RE,FDPGET                                                        
         JE    EQXIT                                                            
*                                                                               
FDP11    MVI   FAXKOFC,0           REMOVE OFFICE                                
         MVC   FAXKDPC,SVDPC       ADD DAYPART                                  
         BRAS  RE,FDPGET                                                        
         JE    EQXIT                                                            
*                                                                               
FDP12    MVI   FAXKDPC,0           REMOVE DAYPART                               
         BRAS  RE,FDPGET                                                        
         JE    EQXIT                                                            
*                                                                               
         TM    SVFLAG1,SVOVREC     OVERNIGHT FAX ?                              
         BZ    *+8                                                              
         NI    SVFLAG1,X'FF'-SVOVREC                                            
         J     NEQXIT                                                           
*                                                                               
FDPGET   NTR1                                                                   
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(16),KEYSAVE     REQUESTED RECORD FOUND                       
         BE    FDPGET2                                                          
         MVC   KEY,KEYSAVE         RESTORE KEYARG                               
         J     NEQXIT              AND RETURN CC NEQ                            
*                                                                               
FDPGET2  L     R6,AIO2                                                          
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
*                                                                               
         CLC   KEY(7),0(R6)                                                     
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         TM    SVFLAG1,SVOVREC     OVERNIGHT FAX?                               
         JZ    EQXIT                NO, DONE (CC EQUALS)                        
*                                                                               
         MVI   ELCODE,X'40'        OVERNIGHT FAX # ELEM                         
         BRAS  RE,GETEL                                                         
         JNE   NEQXIT                                                           
*                                                                               
         NI    SVFLAG1,X'FF'-SVOVREC                                            
         J     EQXIT                                                            
         LTORG                                                                  
         DROP  R4                                                               
*                                                                               
UNTFGETK LA    R0,KEY+21                                                        
*                                                                               
UNTFGET  NTR1  BASE=*,LABEL=*                                                   
         BRAS  RE,UNTFGETX                                                      
         DC    CL8'GETREC  '                                                    
         DC    CL8'UNTFIL  '                                                    
UNTFGETX ST    RE,DMCB                                                          
         CLI   RDUPDATE,C'Y'                                                    
         JNE   *+8                                                              
         MVI   DMCB,X'80'                                                       
         GOTO1 DATAMGR,DMCB,,8(RE),(R0),(R6),DMWORK                             
         J     EXIT                                                             
*                                                                               
UNTFPUT  NTR1  BASE=*,LABEL=*                                                   
         BRAS  RE,UNTFGETX                                                      
         DC    CL8'PUTREC  '                                                    
         DC    CL8'UNTFIL  '                                                    
         LTORG                                                                  
         EJECT                                                                  
*=======================================================                        
* BUILD RETURN XFRCTL ELEM AND PUT TO GLOBBER                                   
*=======================================================                        
                                                                                
BLDXFR   NTR1  BASE=*,LABEL=*                                                   
         L     RF,SYSPARMS                                                      
         L     RF,16(RF)                                                        
         ICM   RF,15,CGLOBBER-COMFACSD(RF)                                      
*                                                                               
         XC    ELEM,ELEM                                                        
         LA    R5,ELEM                                                          
         USING GLVXFRSY,R5                                                      
         MVC   GLVXFRSY,=C'NET'                                                 
         MVC   GLVXFRPR,=C'TRA'                                                 
         MVC   GLVXTOSY,=C'NET'                                                 
         MVC   GLVXTOPR,=C'NNA'                                                 
         MVI   GLVXFLG1,GLV1RETN+GLV1SIDR+GLV1SEPS+GLV1SIDE                     
         GOTO1 (RF),DMCB,=C'PUTD',ELEM,24,GLVXCTL                               
         J     EXIT                                                             
         DROP  R5                                                               
         LTORG                                                                  
         EJECT                                                                  
*=====================================================================          
* PRINT INSTRUCTIONS FOR 1 NETWORK PROGRAM ENTRY                                
*=====================================================================          
                                                                                
         USING PRGTABLED,R5                                                     
PRT      NMOD1 0,**+PRT**,R7                                                    
         L     RC,SVADGEND                                                      
         USING GEND,RC                                                          
*                                                                               
         MVC   NEXTADDR,AIO2       ALL QUEUES BUILT IN AIO2                     
*                                                                               
         TM    SVOPTSW,OPTNEW      TEST NEW INST ONLY                           
         BZ    PRT002                                                           
         CLI   PRGCREVN,0         TEST REV=0 (NEW INSTR)                        
         BE    PRT002                                                           
         MVI   INSPRTSW,C'N'      DO NOT PRINT INSTRUCTIONS                     
         B     PRTXIT                                                           
*                                                                               
PRT002   TM    PRGFLG,PRGFLGDM    NEW DEL/MISSED FOR THIS PROG                  
         BZ    PRT004                                                           
         LLC   R1,PRGCREVN        GET CURR REV                                  
         LA    R1,1(,R1)                                                        
         STC   R1,PRGCREVN                                                      
         CLC   PRGCREVN,SVHIREVP                                                
         BNH   *+10                                                             
         MVC   SVHIREVP,PRGCREVN    SV HIGHEST PROG REV #                       
*                                                                               
PRT004   MVC   SVPRGRVN,PRGCREVN   SAVE REVISION NUMBER                         
         MVC   SVPRGRVD,PRGCREVD         AND DATE                               
         MVC   SVPRGLFX,PRGLFAX                                                 
*                                                                               
         CLI   PRGDPT,0            ANY DAYPART                                  
         BE    PRT005               NO                                          
*                                                                               
         GOTO1 VALIDPT,DMCB,(X'01',PRGDPT)  GET 2 CHAR DPT IN QDPT2             
*                                                                               
* CLEAR EXCEPTION UNIT PROGRAM NAMES AREAS *                                    
*                                                                               
PRT005   L     RE,AIO3                                                          
         LA    RF,4000                                                          
         SR    R0,R0                                                            
         SR    R1,R1                                                            
         MVCL  RE,R0                                                            
*                                                                               
         L     RE,AIO2                                                          
         LA    RE,2000(RE)           CLEAR EST/PROD/COPY CODE AREA              
         LA    RF,1500                               + DESCRIPTION              
         SR    R0,R0                                                            
         SR    R1,R1                                                            
         MVCL  RE,R0                                                            
*                                                                               
* BUILD UNIT TABLE FOR THIS PROGRAM *                                           
*                                                                               
         BRAS  RE,BLDUNT                                                        
                                                                                
* SVPRGFLG MAY HAVE HAD PRGFAXCG FLIPPED IN BLDUNT                              
* COPY CHANGE INTO PRGTABLE                                                     
                                                                                
         MVC   PRGFLG,SVPRGFLG                                                  
         MVC   PRGDAY,SVPRGDAY     PROGRAM DAY                                  
         MVC   PRGTIME,SVPRGTIM            TIME                                 
*                                                                               
         L     RE,ASVFTNT                                                       
         XC    0(200,RE),0(RE)                                                  
         EJECT                                                                  
* READ AND SAVE FOOTNOTE TEXT RECORD *                                          
*                                                                               
         MVI   ASVFTNT,1           SET MAX FEET IN SAVE AREA                    
         MVC   KEY(2),=X'0A23'                                                  
         MVC   KEY+2(3),BAGYMD AND BCLT                                         
*                                                                               
         MVI   KEY+8,C'F'                                                       
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE     TEST TEXT FOUND                              
         BNE   PRT010                                                           
*                                                                               
         L     R6,AIO1                                                          
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
*                                                                               
         MVI   ELCODE,X'40'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         CLC   =C'NONE ',2(R6)     TEST SUPPRESS COMMENT                        
         BE    PRT010                                                           
*                                                                               
         L     R4,ASVFTNT          FORMAT COMMENT                               
         SR    R0,R0                                                            
*                                                                               
PRT008   LLC   RE,1(R6)                                                         
         AHI   RE,-4                                                            
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R4),3(R6) *EXECUTED*                                         
         OC    0(60,R4),SPACES                                                  
         LA    R4,60(R4)                                                        
         BRAS  RE,NEXTEL                                                        
         BNE   *+8                                                              
         BCT   R0,PRT008                                                        
         BCTR  R0,0                ADJUST FOR CONTINUED MESSAGE                 
         LPR   R0,R0                                                            
         STC   R0,ASVFTNT          SAVE NUM FOOTLINES IN SAVE AREA              
*                                                                               
PRT010   CLI   PQSW,1              TEST PRTQUE OPEN                             
         BE    PRT011               NO                                          
*                                                                               
         CLI   TRAWRKR,C' '        TEST OPTICA                                  
         BH    PRT014              YES - ALL OUTPUT TO ONE PQ ENTRY             
*                                                                               
         TM    WHEN,X'20'          IF SOON, GENERATE REQUEST REGARDLESS         
         BO    PRT010A                                                          
*                                                                               
         CLI   OFFLINE,C'Y'                                                     
         BNE   *+12                                                             
         CLI   SVTWPR06,C'2'       REQUIRE AGENCY COPY                          
         BE    PRT016               PRINT HARD COPY 1ST OFFLINE                 
         EJECT                                                                  
*========================================================                       
* ALWAYS FAX EACH PROGRAM SEPARATELY                                            
*========================================================                       
                                                                                
PRT010A  MVC   SVLSTFAX,SVPRGFAX                                                
*                                                                               
         TM    WHEN,X'20'          THIS A SOON REQUEST?                         
         BO    *+12                 YES                                         
         CLI   OFFLINE,C'Y'        OFFLINE                                      
         BNE   PRT010B              NO, GENERATE MULTI-PRT QUE ENTRIES          
*                                                                               
         CLI   PQSW,1              PRINT QUEUE OPENED YET                       
         BNE   *+6                  BETTER BE                                   
         DC    H'0'                                                             
         CLI   SVTWPR06,C'N'       NOT FAXING                                   
         BE    PRT016                                                           
         B     PRT015C                                                          
*                                                                               
PRT010B  MVI   SPMODE,X'FF'                                                     
         MVI   PQSW,X'FF'                                                       
         GOTO1 SPOOL,DMCB,(R8)    FORCE CLOSE OF SPOOL                          
         MVI   PQSW,1                                                           
         MVI   FRSTPGSW,C'Y'                                                    
*                                                                               
PRT011   DS   0H                                                                
         LA    R1,ELEM                                                          
         ST    R1,SPOOLQLK                                                      
         XC    ELEM(128),ELEM                                                   
         USING PQPLD,R1                                                         
         BRAS  RE,INITREM          INITIALIZE PRT QUEUE ENTRY                   
*                                                                               
         CLI   SVTWPR06,C'N'       NO EASILINK FAX                              
         BE    PRT014                                                           
         TM    SVOPTSW1,OPTHDCPY   TEST OPTION AGENCY COPY                      
         BO    PRT014                                                           
*                                                                               
         CLI   OPTICAGY,C'Y'       TEST OPTICA PDF                              
         BE    PRT014                                                           
         TM    WHEN,X'20'          SOON                                         
         BO    PRT011C             YES, PRINT FAX ONLY                          
*                                                                               
         CLI   OFFLINE,C'Y'        OFFLINE, DO ALL FAXES AS 1 ENTRY             
         BNE   PRT011C                                                          
         CLI   SVTWPR06,C'2'       REQUIRE AGENCY COPY                          
         BE    PRT014              YES, OFFLINE DOES AGENCY COPY 1ST            
         B     PRT012                                                           
*                                                                               
* ONLINE CREATES SEPARATE ENTRY FOR EACH PROGRAM                                
*                                                                               
PRT011C  DS   0H                                                                
         BRAS  RE,INITREMF         INITIALIZE FAX PRT QUEUE ENTRY               
*                                                                               
         TM    WHEN,X'20'          SOON                                         
         BZ    PRT014               NO                                          
         DROP  R1                                                               
*                                                                               
*  FAXING LETTERS - MUST USE CLASS G AND SEND SPECIAL PRINT LINE FIRST          
*                                                                               
PRT012   DS    0H                                                               
         ICM   RE,15,TWAMASTC                                                   
         BNZ   *+6                                                              
         DC    H'0'                                                             
         L     RF,MCVREMOT-MASTD(RE)                                            
         USING REMOTED,RF                                                       
         MVC   REMOTSYS,MCS2OSYS-MASTD(RE)                                      
         MVI   REMOTCPY,1                                                       
         MVI   REMOTCLS,C'G'                                                    
         MVC   REMOTJID,=C'NWX'                                                 
         MVC   REMOTDST,TWAORIG                                                 
*                                                                               
         OC    TWADEST,TWADEST                                                  
         BZ    *+10                                                             
         MVC   REMOTDST,TWADEST                                                 
*                                                                               
*AR                                                                             
         MVC   REMOTTY1,SVFAXARC                                                
         MVI   REMOTFLG,X'FA'                                                   
         MVC   REMOTSYS(3),=C'NNI'                                              
         MVC   REMOTSUB,SPACES                                                  
         MVI   REMOTCPY,1                                                       
         MVC   REMOTARC,SVQLARC                                                 
*AR                                                                             
         L     RE,TWADCONS                                                      
         L     RE,TSPFUSER-TWADCOND(,RE)                                        
         MVI   140(RE),C'Y'        SET EASYLINK STUFF PRINTED SW                
*                                                                               
         ICM   R1,15,136(RE)                                                    
         LA    R1,1(,R1)                                                        
         STCM  R1,3,REMOTSUB       FORCE PRTQUE KEY CHANGE                      
         CVD   R1,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  REMOTFRM+1(3),DUB                                                
         STCM  R1,15,136(RE)                                                    
*                                                                               
         DROP  RF                                                               
*                                                                               
PRT014   CLI   OPTICAGY,C'Y'       TEST OPTICA AGENCY COPY                      
         BNE   PRT014X             NO                                           
         CLI   OPTICEOM,C'Y'       TEST ALREADY SENT EDI CARDS                  
         BE    PRT016              YES - SKIP PQ OPEN                           
*                                                                               
         ICM   RE,15,TWAMASTC                                                   
         L     RF,MCVREMOT-MASTD(RE)                                            
         USING REMOTED,RF                                                       
         MVC   REMOTSYS,MCS2OSYS-MASTD(RE)                                      
         MVI   REMOTCPY,1                                                       
         MVI   REMOTCLS,C'G'                                                    
         MVC   REMOTJID,=C'PDF'                                                 
         MVC   REMOTDST,TWAORIG                                                 
*                                                                               
         GOTO1 OPENPQ                                                           
*                                                                               
         MVI   PQSW,2                                                           
         BRAS  RE,SNDOPTIC         SEND OPTICA EDICT CARDS                      
         B     PRT016                                                           
         EJECT                                                                  
PRT014X  GOTO1 OPENPQ                                                           
*                                                                               
         CLI   SVTWPR06,C'N'       THIS AN EASYLINK TRANSMISSION                
         BE    PRT016               NO                                          
         CLI   OPTICAGY,C'Y'       TEST OPTICA AGENCY COPY                      
         BE    PRT016              YES                                          
         TM    SVOPTSW1,OPTHDCPY   TEST OPTION AGENCY COPY                      
         BO    PRT016               YES                                         
*                                                                               
         TM    WHEN,X'20'          SOON                                         
         BO    PRT015C              YES                                         
*                                                                               
PRT015   CLI   OFFLINE,C'Y'        IF ONLINE SEND EASYLINK                      
         BNE   PRT015C                                                          
         CLI   SVTWPR06,C'2'       REQUIRE AGENCY COPY                          
         BE    PRT016               YES, DO IT FIRST                            
*                                                                               
PRT015C  BRAS  RE,EASILN                                                        
         EJECT                                                                  
*================================================================               
* SET UP PRINTING ADDRESSABILITY (AFTER PRTQUE OPEN) *                          
*================================================================               
                                                                                
PRT016   LAY   R0,HEADING          HEADING INFO FOR REPORT                      
         ST    R0,SPECS                                                         
         LAY   R0,HDHK                                                          
         ST    R0,HEADHOOK                                                      
         LAY   R0,MIDHK                                                         
         ST    R0,MIDHOOK                                                       
         LAY   R0,FTHK                                                          
         ST    R0,FOOTHOOK                                                      
         MVI   MAXLINES,60         SET PAGE SIZE                                
         MVC   FOOTLNS,ASVFTNT     SET NUMBER OF FOOTLINES                      
         MVI   FOOTSW,0            RESET SWITCH                                 
         MVI   CONTINUE,C'Y'                                                    
                                                                                
* BLANK THE HEADLINES NOW *                                                     
                                                                                
         LA    R0,14                                                            
         LA    R1,H1                                                            
         MVC   0(132,R1),SPACES                                                 
         LA    R1,132(R1)                                                       
         BCT   R0,*-10                                                          
*                                                                               
         MVI   LINE,99             FORCE NEW PAGE WITHOUT FORCEHED              
         MVC   PAGE,=H'1'          WHICH CAUSES FOOTLINES TO REPRINT            
                                                                                
*================================================================               
* FIND PGRLIST OR CLIENT COPY LIST REC, SAVE NAME AND TELNUM                    
*================================================================               
                                                                                
PRT020   BRAS  RE,INITSPT                                                       
         XC    SVISNMTE,SVISNMTE                                                
*                                                                               
         OC    VOPTPRGR,VOPTPRGR    IF BY PRDGRP, NO CLTLIST                    
         BZ    PRT022                                                           
*                                                                               
         XC    KEY,KEY                                                          
         MVC   KEY(2),=X'0A45'                                                  
         MVC   KEY+2(3),BAGYMD     A-M/CLT                                      
         MVC   KEY+5(1),SVTN2PRO+00                                             
         MVC   KEY+6(2),VOPTPRGR                                                
         MVC   KEY+8(4),NETWORK                                                 
*                                                                               
         BRAS  RE,GETLIST          IF NO PRDGRP LIST, TRY CLIENT LIST           
         BNE   PRT022                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
*                                                                               
         L     R6,AIO                                                           
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         USING PGRCONEL,R6                                                      
         MVC   SVISNAME,PGRCONNM   SAVE CONTACT NAME                            
         MVC   SVISTEL,PGRCONTL                 TEL                             
         MVC   SVISFAX,PGRFAXTL                 FAX                             
         B     PRT025              GO GET EMAIL ELEM                            
         DROP  R6                                                               
*                                                                               
PRT022   XC    KEY,KEY                                                          
         MVC   KEY(2),=X'0A41'                                                  
         MVC   KEY+2(1),BAGYMD                                                  
         MVC   KEY+3(3),QCLT                                                    
         MVC   KEY+6(4),NETWORK                                                 
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE     TEST CLIENT LIST FOUND                       
         BE    PRT024                                                           
*                                                                               
         MVC   KEY,KEYSAVE                                                      
         XC    KEY+6(4),KEY+6      LOOK FOR NON-NETWORK SPECIFIC                
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE     TEST CLIENT LIST FOUND                       
         BNE   PRT026                                                           
*                                                                               
PRT024   DS    0H                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
*                                                                               
         L     R6,AIO                                                           
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         USING CLTCONEL,R6                                                      
         MVC   SVISNAME,CLTCONNM   SAVE CONTACT NAME                            
         MVC   SVISTEL,CLTCONTL                 TEL                             
         DROP  R6                                                               
*                                                                               
         MVI   ELCODE,X'14'                                                     
         BRAS  RE,NEXTEL                                                        
         BNE   *+10                                                             
         USING CLTFAXEL,R6                                                      
         MVC   SVISFAX,CLTFAXTL  SAVE CONTACT FAX                               
         DROP  R6                                                               
*                                                                               
PRT025   L     R6,AIO                                                           
         MVI   ELCODE,X'30'                                                     
         BRAS  RE,GETEL                                                         
         BNE   *+10                                                             
         USING CLTEMLEL,R6                                                      
         MVC   SVISEMAL,CLTEMLAD  SAVE CONTACT EMAIL                            
         DROP  R6                                                               
*                                                                               
PRT026   OC    VOPTPROD,VOPTPROD   RUNNING BY PRODUCT                           
         BZ    PRT030                                                           
         BRAS  RE,GPRDLIST         GET PRODUCT LIST RECORD                      
         EJECT                                                                  
* GET OPTIONAL NETWORK ADDRESS FROM PROGRAM COPY LIST REC *                     
*                                                                               
PRT030   XC    SVNETADR,SVNETADR                                                
*                                                                               
         CLI   SVTNPR10,C'Y'       BLK NET ADDRESS FROM PROGLIST                
         BE    PRT040                                                           
*                                                                               
         XC    KEY,KEY                                                          
         MVC   KEY(2),=X'0A43'    PROGRAM LIST REC (SPTDIR)                     
         MVC   KEY+2(1),BAGYMD                                                  
         MVC   KEY+3(4),NETWORK                                                 
         MVC   KEY+7(6),SVPRG                                                   
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE     TEST CLIENT LIST FOUND                       
         BE    PRT032                                                           
*                                                                               
         MVC   KEY,KEYSAVE                                                      
         XC    KEY+7(6),KEY+7                                                   
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BNE   PRT040                                                           
*                                                                               
PRT032   DS    0H                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
*                                                                               
         L     R6,AIO                                                           
         MVI   ELCODE,X'10'        ADDRESS ELEMENT                              
         BRAS  RE,GETEL                                                         
         BNE   PRT040                                                           
         USING PRGADREL,R6                                                      
         MVC   SVNETADR,PRGADRAD                                                
         DROP  R6                                                               
                                                                                
* READ PROGRAM RECORD FOR POSSIBLE DAYPART *                                    
                                                                                
PRT040   MVI   SVDPC,0             INIT DPC                                     
*                                                                               
         LA    R4,KEY                                                           
         USING NPGKEY,R4                                                        
         MVC   NPGKTYP,=X'0D20'    NTWK PROGRAM REC (SPTDIR)                    
         MVC   NPGKAM,BAGYMD                                                    
         MVC   NPGKNET,NETMKT                                                   
         MVC   NPGKPROG,PRGPRG                                                  
         MVC   NPGKEND,STDATEP                                                  
         MVC   SVPRGPRG,PRGPRG                                                  
         DROP  R4                                                               
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(11),KEYSAVE     TEST SAME THROUGH PROG                       
         BNE   PRT044                                                           
*                                                                               
         L     R6,AIO1                                                          
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
*                                                                               
         MVI   ELCODE,X'93'                                                     
         L     R6,AIO                                                           
         BRAS  RE,GETEL                                                         
         BNE   PRT044              NO DAYPART                                   
*                                                                               
         USING NPGEL93,R6                                                       
         CLI   NPG2DYP,0           IS THERE A DAYPART                           
         BZ    PRT044               NO                                          
         MVC   SVDPC,NPG2DYP       DAYPART EQUATE FOR 2 CHAR OR 1 CHAR          
         DROP  R6                                                 DPT           
*                                                                               
PRT044   DS    0H                                                               
         MVC   SVPRGPRG,PRGPRG                                                  
         BRAS  RE,FDPREC              FIND DAYPART RECORD (UNTDIR)              
         BNE   PRT048                                                           
*                                                                               
PRT046   L     R6,AIO2                                                          
         LA    R6,27(R6)           DISP TO THE ELEM                             
         MVI   ELCODE,X'10'        NETWORK ADDRESS ELEM                         
         BRAS  RE,FIRSTEL                                                       
         BE    *+6                                                              
         DC    H'0'                BETTER BE THERE                              
*                                                                               
         USING FAXADREL,R6                                                      
         MVC   SVNETADR,FAXADRAD   SAVE NETWORK ADDRESS                         
         DROP  R6                                                               
                                                                                
*                                                                               
PRT048   MVC   TSRKEYF,TSARCT      SAVE 1ST TSAR KEY NUMBER-1                   
*                                                                               
         CLI   SVTNPR13,C'Y'       FORCE PAGE ON PROG NAME                      
         BNE   PRT048X                                                          
*                                                                               
         LR    R6,R5                                                            
         L     R5,AUNTABLE                                                      
         USING UNTABLED,R5                                                      
         MVC   SVEXNAM,UNTEXNAM    CHANGE IN NAME                               
*                                                                               
         CLI   UNTEXNAM,0          DIFFERENT PROG NAME                          
         BE    PRT048H              NO                                          
*                                                                               
         TM    UNTFLG2,UNTFLCUT    THIS A CUTIN                                 
         BO    PRT048H              JUST CHANGE HEADINGS                        
*                                                                               
         CLI   UNTEXNAM,X'FF'      MORE THAN MAX TABLE SIZE                     
         BNE   PRT048C                                                          
*                                                                               
         LA    R0,UNTDSKAD                                                      
         MVI   RDUPDATE,C'N'                                                    
         BRAS  RE,UNTFGET                                                       
*                                                                               
         L     RF,AIO1                                                          
         LA    RF,NUPROGNM-NURECD(RF)                                           
         B     PRT048F                                                          
*                                                                               
PRT048C  LLC   RE,UNTEXNAM                                                      
         BCTR  RE,0                                                             
         SLL   RE,4               TIMES 16                                      
         L     RF,AIO3                                                          
         LA    RF,480(RE,RF)                                                    
*                                                                               
PRT048F  MVC   SVPRGNM,0(RF)                                                    
*                                                                               
PRT048H  LR    R5,R6                                                            
         DROP  R5                                                               
*                                                                               
PRT048X  BRAS  RE,PRTHLTXT         PRINT HEADLINE TEXT                          
*                                                                               
         BRAS  RE,INITNET                                                       
*                                                                               
         MVI   MIDFLAG,C'Y'        NOW CAN PRINT MIDLINES                       
         MVI   FORCEMID,C'Y'                                                    
         MVI   SPACING,1                                                        
*                                                                               
         TM    SVOPTSW1,OPTHDCPY   TEST OPTION AGENCY COPY                      
         BO    PRT050               YES                                         
         CLI   SVTWPR06,C'N'       THIS NORMAL (NOT FAX)                        
         BE    PRT050               YES, NORMAL PAGE SIZE                       
         MVI   MAXLINES,FAXMAX     SET PAGE SIZE                                
*                                  CAN ONLY DO 40 ON FIRST PAGE                 
PRT050   MVI   FRSTPGSW,C'N'         SET OFF VERY FIRST PAGE                    
         USING PRGTABLED,R5                                                     
*                                                                               
PRT058   OI    PRGFLG,PRGFLGIP    FLAG AS PRINTED BEFORE R5 CHANGED             
         DROP  R5                                                               
*                                                                               
         BRAS  RE,CLRBUFF          CLEAR PRINT BUFFER                           
*                                                                               
         L     R0,AADDTBL          CLEAR ADDL DATA TABLE                        
         L     R1,AADDTBLX                                                      
         SR    R1,R0                                                            
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
         XC    BINPAR3,BINPAR3     CLEAR RECORD COUNT                           
*                                                                               
* RE-INIT CML SHIP TABLE FOR OPTICA                                             
         SR    R0,R0               ADDRESS OF REC TO BE ADDED                   
         L     R1,ACMLTBL          ADDRESS OF BINTABLE                          
         SR    R2,R2               NUMBER OF RECS IN TABLE                      
         LA    R3,CMLTBLLN         LENGTH OF BIN RECORD                         
         LA    R4,L'CMLKEYL        LENGTH OF BIN KEY                            
         LA    R5,NCOMMLT          MAX RECORDS IN BINTBL (500)                  
         STM   R0,R5,BINPAR7                                                    
*                                                                               
         L     R0,ACMLTBL          CLEAR CML TABLE                              
         L     R1,ACMLTBLX                                                      
         SR    R1,R0                                                            
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
*                                                                               
* BUILD AND PRINT BODY OF REPORT                                                
*                                                                               
         L     R5,AUNTABLE                                                      
         USING UNTABLED,R5                                                      
*                                                                               
         BRAS  RE,BLDLIN           GO BUILD PRINT LINE(S)                       
*                                                                               
         BRAS  RE,PCOM             PRINT COMMENTS                               
*                                                                               
         BRAS  RE,BLDADDL          BUILD/PRINT ADDL INFO                        
*                                                                               
         MVI   P,0                                                              
         BRAS  RE,GOSPL                                                         
         EJECT                                                                  
* PRINT ORIGINAL/REVISION COMMENTS *                                            
                                                                                
         BRAS  RE,INITXSP                                                       
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING REVXKEY,R4                                                       
         MVC   REVXKID,=X'0A1D'                                                 
         MVC   REVXKAM(3),BAGYMD AND BCLT                                       
         MVC   REVXKNET,NETWORK                                                 
         MVC   REVXKPRG,SVPRG                                                   
         MVC   REVXKPER,PERIOD                                                  
*                                                                               
         CLI   MYTN2PR6,C'W'       USING WEEKLY PERIOD                          
         BNE   *+18                                                             
         TM    SVFLAG,CONVSW       CONVERTED RECORDS?                           
         BNZ   *+10                YES, ALREADY SET                             
         MVC   REVXKPER,STDATEP                                                 
*                                                                               
         OC    VOPTPROD,VOPTPROD   RUNNING BY PRODUCT                           
         BZ    *+10                                                             
         MVC   REVXKPRD,VOPTPROD                                                
*                                                                               
         OC    VOPTPRGR,VOPTPRGR   BY PRODUCT GROUP                             
         BZ    *+10                                                             
         MVC   REVXKPGR,VOPTPRGR                                                
*                                                                               
         CLI   SVTN1PR5,C'C'       OPTION TO PRINT CHANGES ONLY                 
         BE    PRT060                                                           
         CLI   SVTNPR1,C'A'        PRINT ALL REVSION CMTS                       
         BE    PRT064                                                           
*                                                                               
PRT060   LLC   R5,SVPRGRVN                                                      
*                                                                               
         CLI   SVTN1PR5,C'C'       OPTION TO PRINT CHANGES ONLY                 
         BE    PRT066                                                           
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,SVTNPR1        GET NUMBER OF PREV CMTS TO PRINT             
         BZ    PRT066              PRINT ONLY CURRENT REV COMMENT               
*                                                                               
         SR    R5,RF                                                            
         LTR   R5,R5                                                            
         BNM   *+6                                                              
PRT064   SR    R5,R5                                                            
*                                                                               
PRT066   STC   R5,REVXKNUM                                                      
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(32),KEYSAVE                                                  
         BE    PRT068                                                           
*        CHECK EVERYTHING BUT THE REV #                                         
         CLC   KEY(17),KEYSAVE                                                  
         BNE   PRT100                                                           
         CLC   KEY+18(5),KEYSAVE+18                                             
         BNE   PRT100                                                           
         LLC   R5,KEY+17                                                        
*        IF WE GOT THIS FAR IT MEANS THEY HAVE SWITCHED CALENDAR                
*                                                                               
PRT068   L     R6,AIO1                                                          
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
         NI    UPDSW,X'FF'-X'80'                                                
*                                                                               
* COUNT COMMENT LINES FOR ALLOWLIN (PRINT ALL ON 1 PAGE) *                      
*                                                                               
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL            FAKE IT FOR THE REST OF THE CODE             
*                                  TO FALL INTO PLACE                           
         SR    R1,R1                                                            
         LR    R0,R6                                                            
*                                                                               
         MVI   ELCODE,X'40'                                                     
PRT080   BRAS  RE,NEXTEL                                                        
         BNE   PRT082                                                           
         BCT   R1,PRT080                                                        
*                                                                               
PRT082   CLI   SVTN1PR2,C'Y'       SUPPRESS AUTO SEED COMMENT                   
         BE    PRT086               YES                                         
*                                                                               
         LR    R6,R0                                                            
         MVI   ELCODE,X'50'                                                     
*                                                                               
PRT084   BRAS  RE,NEXTEL                                                        
         BNE   PRT086                                                           
         BCT   R1,PRT084                                                        
*                                                                               
PRT086   LR    R6,R0               COUNT NET SEED COMMENTS                      
         MVI   ELCODE,X'60'                                                     
*                                                                               
PRT088   BRAS  RE,NEXTEL                                                        
         BNE   *+8                                                              
         BCT   R1,PRT088                                                        
         LPR   R1,R1                                                            
         BZ    PRT098                                                           
         LR    R6,R0                                                            
         STC   R1,ALLOWLIN                                                      
         MVI   ELCODE,X'40'                                                     
*                                                                               
PRT090   BRAS  RE,NEXTEL                                                        
         BNE   PRT092                                                           
         TM    UPDSW,X'80'         WAS REV PRINTED YET                          
         BO    *+8                                                              
         BAS   RE,POR              PRINT ORIG/REV                               
*                                                                               
         USING REVCMTEL,R6                                                      
         MVC   P+15(60),REVCMT                                                  
         BRAS  RE,GOSPL                                                         
         MVI   ALLOWLIN,0                                                       
         B     PRT090                                                           
*                                                                               
PRT092   CLI   SVTN1PR2,C'Y'       SUPPRESS AUTO SEED COMMENT                   
         BE    PRT094               YES                                         
         MVI   ELCODE,X'50'                                                     
         L     R6,AIO1                                                          
         BRAS  RE,GETEL                                                         
         BNE   PRT094                                                           
         TM    UPDSW,X'80'         WAS REV PRINTED YET                          
         BO    *+8                                                              
         BAS   RE,POR              PRINT ORIG/REV                               
         MVC   P+15(60),REVCMT                                                  
         BRAS  RE,GOSPL                                                         
*                                                                               
PRT094   MVI   ELCODE,X'60'                                                     
         L     R6,AIO1                                                          
         BRAS  RE,GETEL                                                         
         B     *+8                                                              
PRT096   BRAS  RE,NEXTEL                                                        
         BNE   PRT098                                                           
         TM    UPDSW,X'80'         WAS REV PRINTED YET                          
         BO    *+8                                                              
         BAS   RE,POR              PRINT ORIG/REV                               
         MVC   P+15(60),REVCMT                                                  
         BRAS  RE,GOSPL                                                         
         B     PRT096                                                           
*                                                                               
PRT098   LA    R5,1(R5)            GET NEXT REVISION                            
         B     PRT066                                                           
         DROP  R4                                                               
PRT100   TM    SVPRGFLG,PRGFLGDM   NEW REV ?                                    
         BZ    PRT110                                                           
         CLC   SVPRGRVN,KEYSAVE+REVXKNUM-REVXKEY  (MAYBE KEY NOT K.S.)          
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
PRT104   MVC   P+2(8),=C'REVISION'                                              
         LR    R0,R5                                                            
         BRAS  RE,PRTEDT                                                        
*                                                                               
         MVC   P+15(40),=C'DELETED UNITS SINCE LAST INSTRUCTIONS ON'            
         GOTO1 DATCON,DMCB,(3,SVPRGIDT),(5,P+56)                                
         MVI   SPACING,2                                                        
         BRAS  RE,GOSPL                                                         
         EJECT                                                                  
*==============================================================                 
* PRINT CLIENT, PRDGRP, PRODUCT, AND PROGRAM LISTS *                            
*==============================================================                 
                                                                                
PRT110   DS    0H                                                               
         BRAS  RE,INITSPT          GO TO SPOT FILES                             
         L     R2,AIO3             POINT TO START OF LIST                       
         CLI   SVTNPR11,C'Y'       DO NOT PRINT DISTRIBUTION LIST               
         BE    PRT121M                                                          
                                                                                
*================================================================               
* IF RUNNING BY PRDGRP, DO NOT PRINT PRDLIST                                    
* IF CONTACT NAME ELEM IN PRDLIST, DO NOT PRINT CLTLIST                         
*================================================================               
                                                                                
         L     R0,AIO3                                                          
         LA    R1,2000                                                          
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
         OC    VOPTPRGR,VOPTPRGR    IF BY PRDGRP, NO PRDLISTS                   
         BNZ   PRT113                                                           
                                                                                
         L     R1,AIO3                                                          
         LA    R1,3520(R1)                                                      
*                                                                               
PRT112   XC    KEY,KEY                                                          
         MVC   KEY(2),=X'0A42'                                                  
         MVC   KEY+2(3),BAGYMD     A-M/CLT                                      
*                                                                               
PRT112A  CLI   0(R1),0             ANY PRD ?                                    
         BE    PRT113               NO                                          
         MVC   KEY+5(3),0(R1)                                                   
         MVC   KEY+8(4),NETWORK                                                 
*                                                                               
         BRAS  RE,GETLIST                                                       
         BNE   PRT114              IF NO PRD, SKIP TO CLIENT                    
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
         L     R6,AIO                                                           
         MVI   ELCODE,X'10'        CONTACT ELEMENT                              
         BRAS  RE,GETEL                                                         
         BE    PRT121                                                           
*                                                                               
         LA    R1,SVPRDENT(R1)                                                  
         B     PRT112A                                                          
         EJECT                                                                  
*=============================================================                  
* PRDGRP DISTRIBUTION LIST                                                      
*=============================================================                  
                                                                                
PRT113   XC    KEY,KEY                                                          
         MVC   KEY(2),=X'0A45'                                                  
         MVC   KEY+2(3),BAGYMD     A-M/CLT                                      
         MVC   KEY+5(1),SVTN2PRO+00                                             
         MVC   KEY+6(2),VOPTPRGR                                                
         MVC   KEY+8(4),NETWORK                                                 
*                                                                               
         BRAS  RE,GETLIST          IF NO PRDGRP LIST, TRY CLIENT LIST           
         BNE   PRT114                                                           
*                                                                               
PRT113A  L     R6,AIO1                                                          
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
*                                                                               
         MVI   ELCODE,X'20'        DIST NAME ELEM                               
         BRAS  RE,GETEL                                                         
         BNE   PRT120                                                           
         SR    R4,R4                                                            
         B     *+8                                                              
*                                                                               
PRT113B  BRAS  RE,NEXTEL                                                        
         BNE   PRT120                                                           
         XC    0(30,R2),0(R2)                                                   
         CLI   1(R6),4             EMPTY DIST NAME ELEM                         
         BE    PRT113C                                                          
         MVC   0(30,R2),3(R6)                                                   
*                                                                               
PRT113C  LA    R2,30(R2)                                                        
         LA    R4,1(,R4)                                                        
         L     RF,AIO3                                                          
         LA    RF,1980(RF)                                                      
         CR    R2,RF                                                            
         BL    *+8                                                              
         BAS   RE,CPY              FORCE PRINTING OF COPIES TO LIST             
         B     PRT113B                                                          
                                                                                
*===================================================                            
* CLIENT DISTRIBUTION LIST                                                      
*===================================================                            
                                                                                
PRT114   XC    KEY,KEY                                                          
         MVC   KEY(2),=X'0A41'                                                  
         MVC   KEY+2(1),BAGYMD                                                  
         MVC   KEY+3(3),QCLT                                                    
         MVC   KEY+6(4),NETWORK                                                 
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE     TEST CLIENT LIST FOUND                       
         BE    PRT114A                                                          
*                                                                               
         MVC   KEY,KEYSAVE                                                      
         XC    KEY+6(4),KEY+6      LOOK FOR ALL NETWORK LIST                    
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(13),KEYSAVE     TEST CLIENT LIST FOUND                       
         BNE   PRT121                                                           
*                                                                               
PRT114A  L     R6,AIO1                                                          
         ST    R6,AIO                                                           
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
         MVI   ELCODE,X'20'        DIST NAME ELEM                               
         BRAS  RE,GETEL                                                         
         BNE   PRT120                                                           
         SR    R4,R4                                                            
         B     *+8                                                              
PRT114B  BRAS  RE,NEXTEL                                                        
         BNE   PRT120                                                           
         XC    0(30,R2),0(R2)                                                   
         CLI   1(R6),4             EMPTY DISTRIB NAME ELEM                      
         BE    PRT114C                                                          
         MVC   0(30,R2),3(R6)                                                   
*                                                                               
PRT114C  LA    R2,30(R2)                                                        
         LA    R4,1(,R4)                                                        
         L     RF,AIO3                                                          
         LA    RF,1980(RF)                                                      
         CR    R2,RF                                                            
         BL    *+8                                                              
         BAS   RE,CPY              FORCE PRINTING OF COPIES TO LIST             
         B     PRT114B                                                          
*                                                                               
* PRINT ORIGINAL OR REVISION                                                    
*                                                                               
POR      NTR1                                                                   
         CLM   R5,1,SVPRGRVN       THIS CURRENT REVISION                        
         BNE   *+8                                                              
         MVI   P+1,C'*'                                                         
         LTR   R5,R5               ORIG                                         
         BZ    POR10                                                            
         MVC   P+2(8),=C'REVISION'                                              
         LR    R0,R5                                                            
         BRAS  RE,PRTEDT                                                        
         B     *+10                                                             
POR10    MVC   P+2(8),=CL8'ORIGINAL'                                            
*                                                                               
         OI    UPDSW,X'80'                                                      
         XIT1                                                                   
*                                                                               
PRTEDT   EDIT  (R5),(3,P+11),ALIGN=LEFT,ZERO=NOBLANK                            
         BR    RE                                                               
         EJECT                                                                  
*===========================================================                    
* FORCE EVEN ALIGNMENT OF LISTS                                                 
*===========================================================                    
                                                                                
PRT120   STC   R4,WORK             FORCE EVEN LIST                              
         TM    WORK,1              IF ODD, FORCE EXTRA ENTRY                    
         BZ    *+18                                                             
         XC    0(30,R2),0(R2)      BLANK ENTRY                                  
         LA    R2,30(,R2)                                                       
         LA    R4,1(,R4)                                                        
         L     RF,AIO3                                                          
         LA    RF,1980(,RF)                                                     
         CR    R2,RF                                                            
         BL    *+8                                                              
         BAS   RE,CPY              PRINT COPIES TO LIST SO FAR                  
*                                                                               
         XC    0(60,R2),0(R2)      FORCE BLANK LINE BETWEEN LISTS               
         LA    R2,60(,R2)                                                       
         L     RF,AIO3                                                          
         LA    RF,1980(,RF)                                                     
         CR    R2,RF                                                            
         BL    *+8                                                              
         BAS   RE,CPY              PRINT COPIES TO LIST SO FAR                  
                                                                                
*==============================================================                 
* PRODUCT LISTS - FOR ALL PRODUCTS IN INSTRUCTIONS                              
*==============================================================                 
                                                                                
PRT121   ST    R2,DUB             SAVE TO SEE IF ANY LIST FOUND                 
*                                                                               
PRT121M  L     R4,AIO3                                                          
         LA    R4,3520(,R4)                                                     
         LR    R5,R4                                                            
         SR    R6,R6                                                            
         LA    R0,SVPRDLEN                                                      
*                                                                               
PRT122   CLI   0(R4),0                                                          
         BE    PRT124                                                           
         LA    R4,SVPRDENT(,R4)                                                 
         LA    R6,1(,R6)                                                        
         BCT   R0,PRT122                                                        
*                                                                               
* SINCE DELETED UNITS HAVE "NO PRODUCTS" NO PRODUCTS *                          
* ARE POSSIBLE FOR AN ALL DELETED UNITS INSTRUCTION  *                          
*                                                                               
PRT124   LTR   R6,R6                                                            
         BNZ   PRT125                                                           
         OC    SVPRGDEL,SVPRGDEL                                                
         B     PRT134 <<<<< WAS BNZ PRT134 >>>>>>                               
         DC    H'0'                                                             
PRT125   DS    0H                                                               
         GOTO1 QSORT,DMCB,(R5),(R6),SVPRDENT,3,0                                
*                                                                               
         BRAS  RE,INITSPT                                                       
         BRAS  RE,PTX              PRINT ANY PRODUCT TEXT                       
*                                                                               
         CLI   SVTNPR11,C'Y'       DO NOT PRINT DISTRIBUTION LIST               
         BE    PRT150                                                           
         OC    VOPTPRGR,VOPTPRGR   TEST BY PRDGRP                               
         BNZ   PRT134                                                           
*                                                                               
         SR    R4,R4                                                            
PRT126   XC    KEY,KEY                                                          
         MVC   KEY(2),=X'0A42'                                                  
         MVC   KEY+2(3),BAGYMD     A-M/CLT                                      
         MVC   KEY+5(3),0(R5)                                                   
         MVC   KEY+8(4),NETWORK                                                 
         BRAS  RE,GETLIST                                                       
         BNZ   PRT132                                                           
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
         MVC   0(4,R5),KEY+14      SAVE DISK ADDR                               
         L     R6,AIO                                                           
*                                                                               
* CHECK ANY OTHER EQUAL PRD LISTS *                                             
*                                                                               
         MVI   ELCODE,X'20'                                                     
         BRAS  RE,FEQ                                                           
         BE    PRT132                                                           
*                                                                               
         BRAS  RE,GETEL                                                         
         BE    PRT128A                                                          
         DC    H'0'                                                             
*                                                                               
PRT128   BRAS  RE,NEXTEL                                                        
         BNE   PRT130                                                           
*                                                                               
PRT128A  XC    0(30,R2),0(R2)                                                   
         CLI   1(R6),4             EMPTY DISTRIB NAME ELEM                      
         BE    PRT129                                                           
         MVC   0(30,R2),3(R6)                                                   
*                                                                               
PRT129   LA    R2,30(R2)                                                        
         LA    R4,1(R4)                                                         
         L     RF,AIO3                                                          
         LA    RF,1980(RF)                                                      
         CR    R2,RF                                                            
         BL    *+8                                                              
         BAS   RE,CPY              PRINT COPIES TO LIST SO FAR                  
         B     PRT128                                                           
*                                                                               
PRT130   STC   R4,WORK             FORCE EVEN LIST                              
         TM    WORK,1              IF ODD, FORCE EXTRA ENTRY                    
         BZ    PRT131                                                           
         XC    0(30,R2),0(R2)      BLANK ENTRY                                  
         LA    R4,1(,R4)                                                        
         LA    R2,30(,R2)                                                       
         L     RF,AIO3                                                          
         LA    RF,1980(,RF)                                                     
         CR    R2,RF                                                            
         BL    *+8                                                              
         BAS   RE,CPY              PRINT COPIES TO LIST SO FAR                  
PRT131   B     *+10                                                             
*                                                                               
PRT132   XC    0(SVPRDENT,R5),0(R5)        CLEAR PRD NO (OR EQ) LIST            
         LA    R5,SVPRDENT(,R5)             NEXT PRODUCT                        
         L     R1,AIO3                                                          
         LA    R1,3520+480(,R1)                                                 
         CR    R5,R1                                                            
         BNL   PRT134                                                           
         OC    0(3,R5),0(R5)                                                    
         BNZ   PRT126                                                           
*                                                                               
* SEE IF ANY PRODUCT LIST FOUND *                                               
*                                                                               
PRT134   C     R2,DUB                                                           
         BE    *+14                                                             
         XC    0(60,R2),0(R2)      FORCE BLANK LINE BETWEEN LISTS               
         LA    R2,60(,R2)                                                       
         L     RF,AIO3                                                          
         LA    RF,1980(,RF)                                                     
         CR    R2,RF                                                            
         BL    *+8                                                              
         BAS   RE,CPY              PRINT COPIES TO LIST SO FAR                  
                                                                                
*==============================================================                 
* PGMLIST AND DPT RECORDS BOTH USE THIS CODE                                    
*==============================================================                 
                                                                                
         XC    KEY,KEY                                                          
         MVC   KEY(2),=X'0A43'                                                  
         MVC   KEY+2(1),BAGYMD                                                  
         MVC   KEY+3(4),NETWORK                                                 
         MVC   KEY+7(6),SVPRG                                                   
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE     ANY PROGRAM LIST                             
         BE    PRT136                                                           
         MVC   KEY(7),KEYSAVE                                                   
         XC    KEY+7(6),KEY+7                                                   
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BNE   PRT140                                                           
PRT136   DS    0H                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
*                                                                               
         L     R6,AIO                                                           
         MVI   ELCODE,X'20'        DIST NAME LIST                               
         BRAS  RE,GETEL                                                         
         BNE   PRT140                                                           
         B     PRT139                                                           
*                                                                               
PRT138   BRAS  RE,NEXTEL                                                        
         BNE   PRT140                                                           
*                                                                               
PRT139   XC    0(30,R2),0(R2)                                                   
         CLI   1(R6),4             EMPTY DISTRIB NAME ELEM                      
         BE    *+10                                                             
         MVC   0(30,R2),3(R6)                                                   
*                                                                               
         LA    R2,30(,R2)                                                       
         LA    R4,1(R4)                                                         
         L     RF,AIO3                                                          
         LA    RF,1980(RF)                                                      
         CR    R2,RF                                                            
         BL    PRT138                                                           
         BAS   RE,CPY              PRINT COPIES TO LIST SO FAR                  
         B     PRT138                                                           
         EJECT                                                                  
*===============================================================                
* CHECK IF ANY LIST TO PRINT                                                    
*===============================================================                
                                                                                
PRT140   STC   R4,WORK             FORCE EVEN LIST                              
         TM    WORK,1              IF ODD, FORCE EXTRA ENTRY                    
         BZ    PRT142                                                           
         XC    0(30,R2),0(R2)      BLANK ENTRY                                  
         LA    R2,30(R2)                                                        
         LA    R4,1(R4)                                                         
         L     RF,AIO3                                                          
         LA    RF,1980(RF)                                                      
         CR    R2,RF                                                            
         BL    PRT142                                                           
         BAS   RE,CPY              PRINT COPIES TO LIST SO FAR                  
*                                                                               
PRT142   DS   0H                                                                
         CLI   KEY,X'26'           SEE IF DOING DAYPART REC                     
         BE    *+8                  YES, JUST PRINT SPACE                       
         B     PRT147              GO DO DAYPART                                
*                                                                               
PRT143   C     R2,AIO3             ANY LIST TO PRINT                            
         BE    PRT150               NO                                          
         L     RE,AIO3             DBL CK IF LIST EMPTY                         
*                                                                               
PRT144   OC    0(30,RE),0(RE)                                                   
         BNZ   PRT146                                                           
         LA    RE,30(RE)                                                        
         CR    RE,R2                                                            
         BL    PRT144                                                           
         B     PRT150                                                           
*                                                                               
PRT146   BAS   RE,CPY              GO PRINT COPY LIST                           
         BRAS  RE,GOSPL                                                         
         B     PRT150                                                           
*                                                                               
PRT147   DS    0H                                                               
         BRAS  RE,FDPREC           FIND DAYPART RECORD                          
         BNE   PRT143                                                           
*                                                                               
PRT147A  XC    0(60,R2),0(R2)                                                   
         LA    R2,60(R2)           FORCE BLANK LINE                             
*                                                                               
         L     R6,AIO2                                                          
         LA    R6,27(R6)           DISP TO THE ELEM                             
         MVI   ELCODE,X'20'        GET NAME LIST ELEMENT                        
         BRAS  RE,FIRSTEL                                                       
         BE    PRT139                                                           
         B     PRT143              GO MAKE SURE NOTHING TO PRINT                
*                                                                               
PRT150   DS    0H                                                               
         BRAS  RE,PSTEXT          GO PRINT SPECIAL TEXT                         
*                                                                               
         MVI   CONTINUE,C'N'                                                    
         MVI   FORCEFUT,C'Y'                                                    
         MVC   P,SPACES                                                         
         BRAS  RE,GOSPL                                                         
*                                                                               
         MVC   TSRKEYL,TSARCT      SAVE LAST TSAR KEY NUMBER                    
*                                                                               
         XC    SVSPLRPN,SVSPLRPN   SPOOL REPORT NUMBER                          
         SR    R0,R0                                                            
         ICM   R0,3,SPOOLRPN                                                    
         EDIT  (R0),(5,SVSPLRPN),ALIGN=LEFT                                     
*                                                                               
* UPDATE REVISION RECORD AND ANY DELETED UNITS FOR BUY ACTIVITY *               
*                                                                               
*VEN     TM    SVOPTSW2,OPTOVFAX   TEST OPTION OVERNIGHT FAX                    
*VEN     BO    PRT152               YES, NO UPDATE                              
         TM    SVOPTSW1,OPTHDCPY    THIS A FOLLOW-UP COPY                       
         BO    PRT152               NO UPDATE                                   
         CLI   OPTICAGY,C'N'       OPTICA FAX (WE DO AGY COPY FIRST)            
         BE    PRT152               YES, NO UPDATE                              
*                                                                               
         BRAS  RE,UPDR                                                          
                                                                                
PRT152   DS    0H                                                               
         CLI   SVTN1PRB,C'Y'       SUPPRESS DELETED UNITS                       
         BNE   PRT152F                                                          
*                                                                               
         TM    TABLESW,DELETDSW    ANY DEL UNITS THAT WERE NOT PRINTED          
         BZ    PRT152F              NO                                          
*                                                                               
         MVI   SPACING,2                                                        
         MVC   P1+1(L'DELMSG),DELMSG                                            
         BRAS  RE,GOSPL                                                         
*                                                                               
PRT152F  L     R5,SVR5                                                          
         USING UNTABLED,R5                                                      
         TM    UNTFLG2,UNTFLCUT    IS UNIT A CUTIN                              
         BZ    PRT154               NOPE, DONE                                  
         CLI   0(R5),0             ANY UNIT THERE                               
         BNE   *+6                                                              
         DC    H'0'                                                             
                                                                                
* PRINT ALL CUTIN UNITS ON INSTRUCTIONS *                                       
                                                                                
         MVI   CONTINUE,C'N'                                                    
         OI    UPDSW2,UNTCUTIN     SET ON FOR HEADINGS AND FAX                  
         MVI   LINE,99             FORCE NEW PAGE WITHOUT FORCEHED              
         MVC   PAGE,=H'1'          WHICH CAUSES FOOTLINES TO REPRINT            
*                                                                               
         MVC   SVUNTPOS,UNTPOS     SAVE CALL LETTERS FOR HEADHOOK               
         MVC   SVUNTMKT,UNTCML3+4  SAVE MARKET FOR HEADHOOK                     
*                                                                               
         BRAS  RE,BLDLIN            GO BUILD PRINT LINE(S)                      
*                                                                               
         NI    UPDSW2,X'FF'-UNTCUTIN     SET OFF PROCESSING CUTINS              
*                                                                               
         BRAS  RE,PSTEXT          GO PRINT SPECIAL TEXT                         
*                                                                               
PRT154   DS    0H                                                               
         CLI   SVTWPR06,C'N'       EASYLINK TRANSMISSION                        
         BE    PRTXIT               NO                                          
*                                                                               
         CLI   OPTICAGY,C'Y'       TEST OPTICA AGENCY COPY                      
         BE    PRTXIT                                                           
*                                                                               
         TM    SVOPTSW1,OPTHDCPY   TEST OPTION AGENCY COPY                      
         BO    PRTXIT               YES (BOB SAYS)                              
*                                                                               
         CLI   OFFLINE,C'Y'                                                     
         BNE   PRT158                                                           
*                                                                               
         CLI   SVTWPR06,C'Y'       FAXING ONLY                                  
         BE    PRT158               YES                                         
*                                                                               
         TM    WHEN,X'20'          THIS A SOON RUN                              
         BO    PRT158               YES                                         
*                                                                               
* OFFLINE RUNS WITH AGENCY COPY WILL PRINT FAXES AT END OF RUN *                
*                                                                               
         B     PRTXIT                                                           
*                                                                               
PRT158   TM    SVOPTSW1,OPTHDCPY   TEST OPTION AGENCY COPY                      
         BO    PRT159                                                           
*NOP     CLI   TRAWRKR,C' '        TEST WORKER FILENUM (OPTICA)                 
*****    JH    PRT159               YES                                         
         MVI   OPTICEOM,C'N'                                                    
         MVC   P1(26),=C'*** END OF DDS MESSAGE ***'                            
         MVI   LINE,2                                                           
         GOTO1 SPOOL,DMCB,(R8)                                                  
*                                                                               
PRT159   LH    R1,TSRKEYF                                                       
         LA    R1,1(R1)                                                         
         STH   R1,TSRKEYF                                                       
*                                                                               
* BLANK THE HEADLINES NOW *                                                     
*                                                                               
         LA    R0,14                                                            
         LA    R1,H1                                                            
         MVC   0(132,R1),SPACES                                                 
         LA    R1,132(R1)                                                       
         BCT   R0,*-10                                                          
         MVC   MID1,SPACES                                                      
*                                                                               
PRT160   CLI   OPTICAGY,C'Y'                                                    
         BE    PRTXIT                                                           
         MVI   OPTICEOM,C'Y'                                                    
         CLI   MFPRGSW,C'Y'                                                     
         BE    PRT180                                                           
         MVI   OPTICEOM,C'N'                                                    
         B     PRTXIT                                                           
*                                                                               
PRT180   BRAS  RE,GTSPL                                                         
         B     PRT160                                                           
*                                                                               
PRTXIT   CLI   OPTICAGY,C'Y'       TEST OPTICA AGENCY COPY                      
         JE    EXIT                                                             
*                                                                               
         CLI   OPTICEOM,C'Y'                                                    
         JNE   EXIT                                                             
         MVC   P1(26),=C'*** END OF DDS MESSAGE ***'                            
         MVI   LINE,2                                                           
         GOTO1 SPOOL,DMCB,(R8)                                                  
         MVI   OPTICEOM,C'N'                                                    
         J     EXIT                                                             
*                                                                               
DELMSG   DC    C'*** DELETED UNITS NOT PRINTED ON INSTRUCTIONS ***'             
         EJECT                                                                  
*===========================================================                    
* SEE IF PRODUCT LIST REC, HAS CONTACT NAME AND TEL #                           
* IF SO THEN OVERRIDE THE ONE GOTTEN FROM THE CLTLIST                           
*===========================================================                    
                                                                                
GPRDLIST NTR1                                                                   
         BRAS  RE,INITSPT                                                       
*                                                                               
         L     R5,AUNTABLE                                                      
         USING UNTABLED,R5                                                      
*                                                                               
         XC    BLOCK(250),BLOCK    SAVE AREA FOR PRODUCTS                       
         XC    WORK(L'SVISNAME),WORK SAVE AREA FOR CONTACT NAME                 
*                                                                               
         XC    KEY,KEY                                                          
         MVC   KEY(2),=X'0A42'                                                  
         MVC   KEY+2(3),BAGYMD  AND BCLT                                        
         B     GPRD15                                                           
*                                                                               
GPRD10   LA    R5,UNTNEXT                                                       
         C     R5,AUNTABLX         AT END OF TABLE                              
         BNL   GPRDX                                                            
*                                                                               
GPRD15   OC    UNTENT,UNTENT       END OF UNIT TABLE                            
         BZ    GPRDX                YES, DONE                                   
*                                                                               
         OC    UNTPROD,UNTPROD     ANY PROD ?                                   
         BZ    GPRD10               NO                                          
         MVC   QPRD,UNTPROD                                                     
*                                                                               
* SEE IF PROCESSED THIS PRODUCT BEFORE                                          
*                                                                               
GPRD20   LA    R1,BLOCK                                                         
*                                                                               
GPRD22   CLI   0(R1),0                                                          
         BE    GPRD24                                                           
         CLC   QPRD,0(R1)          SAME PRDS ?                                  
         BNE   GPRD23               NO                                          
         CLC   QPRD,UNTPROD2                                                    
         BNE   GPRD40                                                           
         B     GPRD10                                                           
*                                                                               
GPRD23   LA    R1,3(R1)                                                         
         B     GPRD22                                                           
*                                                                               
GPRD24   MVC   0(3,R1),QPRD                                                     
*                                                                               
         MVC   KEY+5(3),QPRD                                                    
         MVC   KEY+8(4),NETWORK                                                 
*                                                                               
GPRD26   DS    0H                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(13),KEYSAVE     PRODUCT LIST RECORD?                         
         BE    GPRD26F                                                          
         MVC   KEY(13),KEYSAVE                                                  
         CLC   KEY+8(4),NETWORK    ARE WE DOING NETWORK                         
         BNE   GPRD26C                                                          
*                                                                               
         XC    KEY+8(4),KEY+8                                                   
         MVC   KEY+9(1),SVMEDIA    NOW DO BY MEDIA                              
         MVI   KEY+10,X'FF'                                                     
         B     GPRD26                                                           
*                                                                               
GPRD26C  DS    0H                                                               
         CLI   KEY+10,X'FF'        ARE WE DOING MEDIA                           
         BNE   GPRD26D                                                          
         CLC   KEY+9(1),SVMEDIA                                                 
         BNE   GPRD26D                                                          
         XC    KEY+8(4),KEY+8      NOW DO ALL PRDLIST                           
         B     GPRD26                                                           
*                                                                               
GPRD26D  OC    KEY+8(4),KEY+8      ARE WE DOING ALL PRDLIST                     
         BZ    GPRD10               YES, DONE ALL                               
         DC    H'0'                WHAT ARE WE DOING ???                        
*                                                                               
GPRD26F  DS    0H                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
*                                                                               
         L     R6,AIO                                                           
*                                                                               
         MVI   ELCODE,X'10'        CONTACT ELEMENT                              
         BRAS  RE,GETEL                                                         
         BNE   GPRD40                                                           
*                                                                               
         USING PRDCONEL,R6                                                      
*                                                                               
         CLC   PRDCONNM,SPACES                                                  
         BH    *+6                                                              
         DC    H'0'                MUST HAVE CONTACT NAME                       
*                                                                               
         OC    WORK(L'SVISNAME),WORK 1ST TIME AROUND ?                          
         BZ    GPRD30               YES                                         
*                                                                               
         CLC   PRDCONNM,WORK       SAME CONTACT NAME?                           
         BNE   CONTERR              NO ERROR                                    
         B     GPRD40                                                           
*                                                                               
GPRD30   MVC   WORK(L'SVISNAME),PRDCONNM                                        
         CLC   PRDCONTL(L'PRDCONTL+L'PRDFAXTL),SPACES                           
         BH    *+6                                                              
         DC    H'0'                MUST HAVE EITHER FAX OR TEL #                
*                                                                               
         MVC   SVISTEL,PRDCONTL                                                 
         MVC   SVISFAX,PRDFAXTL                                                 
*                                                                               
         L     R6,AIO                                                           
         MVI   ELCODE,X'30'        EMAIL ELEMENT                                
         BRAS  RE,GETEL                                                         
*                                                                               
         USING PRDEMLEL,R6                                                      
         BNE   GPRD33                                                           
         LLC   R1,1(R6)                                                         
         S     R1,=F'3'                                                         
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   SVISEMAL,PRDEMLAD                                                
*                                                                               
GPRD33   MVC   QPRD2,QPRD          SAVE PROD IN CASE OF ERROR                   
*                                                                               
GPRD40   OC    UNTPROD2,UNTPROD2                                                
         BZ    GPRD10                                                           
         MVC   QPRD,UNTPROD2                                                    
         B     GPRD20                                                           
*                                                                               
GPRDX    OC    WORK(L'SVISNAME),WORK   ANY CONTACT NAME?                        
         BZ    *+10                    NO                                       
         MVC   SVISNAME,WORK           MOVE IN CONTACT NAME                     
*                                                                               
         XC    BLOCK(250),BLOCK                                                 
         XIT1                                                                   
*                                                                               
         DROP  R5,R6                                                            
*                                                                               
CONTERR  DS    0H                                                               
         CLI   ERRFILSW,0          WAS ERROR FILE OPENED                        
         BE    CONTER10            NO                                           
         CLI   ERRFILSW,1          BUG CATCHER                                  
         BE    *+6                                                              
         DC    H'0'                                                             
         BRAS  RE,PER               PRINT ERROR REPORT                          
*                                                                               
CONTER10 MVC   GERROR,=Y(BDCONTC)                                               
         XC    ELEM,ELEM                                                        
         LA    R4,ELEM                                                          
         STCM  R4,7,GASUBST        A(SUBST TEXT)                                
         MVI   0(R4),4             L'SUBST TEXT + 1                             
         MVC   1(3,R4),QPRD                                                     
         MVI   4(R4),4             L'SUBST TEXT + 1                             
         MVC   5(3,R4),QPRD2                                                    
         LA    R2,TRACLTH                                                       
         GOTO1 VTRAERR                                                          
         EJECT                                                                  
* PRINT COPY LIST (MAYBE ALL OF IT, OR PARTIAL) *                               
*                                                                               
CPY      NTR1                                                                   
*                                                                               
         MVI   SPACING,3           SPACE DOWN FROM REVISION COMMENTS            
         BRAS  RE,GOSPL                                                         
*                                                                               
         MVC   P+2(10),=CL10'COPIES TO:'                                        
         L     R4,AIO3                                                          
*                                                                               
* COUNT LINES REQUIRED FOR COPY LIST *                                          
*                                                                               
         LR    R1,R4                                                            
         SR    R0,R0                                                            
         CR    R1,R2               AT END?                                      
         BNL   *+12                                                             
         LA    R1,30(,R1)                                                       
         BCT   R0,*-10                                                          
         BCTR  R0,0                ADD ONE FOR ODD LINE                         
         LPR   R0,R0                                                            
         SRL   R0,1                DIVIDE BY 2 (PER LINE)                       
         STC   R0,ALLOWLIN                                                      
*                                                                               
         LA    R6,P+50                                                          
         LA    R5,P+14                                                          
CPY10    CLC   0(30,R4),=CL30'@ '                                               
         BE    *+10                                                             
         MVC   0(30,R5),0(R4)                                                   
         LA    R5,35(,R5)                                                       
         CR    R5,R6                                                            
         BL    CPY20                                                            
         LA    R5,P+14                                                          
         BRAS  RE,GOSPL                                                         
CPY20    LA    R4,30(,R4)                                                       
         CR    R4,R2                                                            
         BL    CPY10                                                            
         CLC   P,SPACES                                                         
         BE    CPYX                                                             
         BRAS  RE,GOSPL                                                         
CPYX     L     R2,AIO3                                                          
         SR    R4,R4                                                            
         XIT1  REGS=(R2,R4)                                                     
         DROP  R7                                                               
         EJECT                                                                  
*===========================================================                    
* SUBROUTINE TO READ FOR PRDLIST OR PGRLIST RECORD                              
*===========================================================                    
                                                                                
GETLIST  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
GETLIST2 MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE     DID WE GET IT?                               
         JE    EQXIT                                                            
*                                                                               
         MVC   KEY(13),KEYSAVE                                                  
         CLC   KEY+8(4),NETWORK    ARE WE DOING NETWORK                         
         BNE   GETLIST4                                                         
*                                                                               
         XC    KEY+8(4),KEY+8                                                   
         MVC   KEY+9(1),SVMEDIA    NOW DO BY MEDIA                              
         MVI   KEY+10,X'FF'                                                     
         B     GETLIST2                                                         
*                                                                               
GETLIST4 DS    0H                                                               
         CLI   KEY+10,X'FF'        ARE WE DOING MEDIA                           
         BNE   GETLIST6                                                         
         CLC   KEY+9(1),SVMEDIA                                                 
         BNE   GETLIST6                                                         
         XC    KEY+8(4),KEY+8      NOW DO ALL NETWORKS                          
         B     GETLIST2                                                         
*                                                                               
GETLIST6 OC    KEY+8(4),KEY+8      ARE WE DOING ALL NETWORKS                    
         JZ    NEQXIT                                                           
         DC    H'0'                WHAT ARE WE DOING ???                        
         EJECT                                                                  
*==================================================================             
* READ, FORMAT AND PRINT HEADLINE TEXT FOR PAGE 1 OF INSTS                      
*==================================================================             
                                                                                
PRTHLTXT NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         BRAS  RE,INITSPT                                                       
*                                                                               
         L     RE,AIO2                                                          
         XC    0(24,RE),0(RE)      PRECLEAR                                     
         XC    KEY,KEY                                                          
         MVC   KEY(2),=X'0A23'     TEXT RECORD (SPTDIR)                         
         MVC   KEY+2(3),BAGYMD     A-M/CLT                                      
         MVI   KEY+8,C'H'                                                       
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BNE   PRTHLTX                                                          
*                                                                               
         L     R6,AIO2                                                          
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
*                                                                               
         MVI   HALF,0                                                           
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BNE   *+10                                                             
         MVC   HALF,2(R6)          SAVE IND BYTE                                
*                                                                               
         L     R6,AIO                                                           
         MVI   ELCODE,X'40'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLC   =C'NONE ',3(R6)     TEST SUPPRESS COMMENT                        
         BE    PRTHLTX                                                          
         TM    HALF,X'80'          TEST TO BOX COMMENT                          
         BZ    PRTHLT10            NO                                           
         L     R0,AIO2                                                          
         AHI   R0,2000                                                          
         GOTO1 VBOXER,DMCB,(60,(R0))                                            
         B     PRTHLT20                                                         
         EJECT                                                                  
*======================================================                         
* FORMAT UNBOXED COMMENT                                                        
*======================================================                         
                                                                                
PRTHLT10 L     R4,AIO2                                                          
         AHI   R4,2000                                                          
         L     R6,AIO                                                           
         BRAS  RE,GETEL                                                         
*                                                                               
PRTHLT12 MVC   0(60,R4),SPACES                                                  
         LLC   RE,1(R6)                                                         
         AHI   RE,-4                                                            
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R4),3(R6) *EXECUTED*                                         
         LA    R4,60(R4)                                                        
         BRAS  RE,NEXTEL                                                        
         BE    PRTHLT12                                                         
         MVI   0(R4),0             SET EOL FLAG                                 
                                                                                
*=================================================================              
* FORMAT STANDARD TEXT TO PRINT LINES                                           
*=================================================================              
                                                                                
PRTHLT20 MVI   MIDFLAG,C'N'        SUPPRESS MIDLINES!                           
*                                                                               
         L     R4,AIO2             FORMATTED COMMENTS ARE HERE                  
         AHI   R4,2000                                                          
         MVI   SPACING,1                                                        
*                                                                               
PRTHLT22 LA    R0,4                                                             
         LA    R1,P1                                                            
*                                                                               
PRTHLT24 CLI   0(R4),0             TEST REACHED END OF COMMENTS                 
         BE    PRTHLT26                                                         
         MVC   0(60,R1),0(R4)      MOVE COMMENT TO PRINT LINE                   
*                                                                               
         LA    R1,132(R1)                                                       
         LA    R4,60(R4)                                                        
         BCT   R0,PRTHLT24                                                      
*                                                                               
PRTHLT26 BRAS  RE,GOSPL                                                         
*                                                                               
         CLI   0(R4),0                                                          
         BNE   PRTHLT22                                                         
*                                                                               
PRTHLTX  J     EXIT                                                             
         LTORG                                                                  
*                                                                               
         EJECT                                                                  
*====================================================================           
*  EASILINK GETS A PRINT LINE WITH SOME FIXED INFO AND FAX NUMBER               
*====================================================================           
                                                                                
EASILN   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         NI    SVFLAG1,X'FF'-OVFAXSW   INIT OVERNIGHT FAX                       
         MVI   FORCEHED,C'N'       PREVENT HEADLINES                            
         MVI   LINE,2                                                           
         MVI   FRSTPGSW,C'Y'                                                    
         MVC   EDIORIG,AGYORIG                                                  
         MVC   EDIHDR,=C'*HDR*'                                                 
*                                                                               
         MVI   MAXLINES,FAXMAX                                                  
         MVI   EDIWIDE,C'L'        SET UP FOR WIDE REPORT                       
         MVI   EDIPAGE,C'P'        AND FORCE NEW PAGE (REPLACES /PAGE)          
*                                                                               
         TM    UPDSW2,UNTCUTIN      IS THIS CUTIN PROCESSING?                   
         BO    EDI008                YES                                        
*                                                                               
         MVC   EDIDESID(4),=C'FAXW'                                             
         CLI   MFPRGSW,C'Y'        ARE WE DOING MULTIPLE FAX PROGRAM            
         BE    EDI006B                                                          
         NI    PRGFAXSW,X'FF'-X'80' TURN MULTI FAX PROG SWITCH OFF              
         MVC   EDIDESID+5(12),SVNETFAX    NETWORK FAX NUMBER                    
         MVC   EDIFDEST(12),SVNETFAX                                            
*                                                                               
EDI003C  CLI   SVPRGFAX,0          NON-STANDARD FAX                             
         BE    EDI008               NO                                          
*                                                                               
         LA    R1,1                                                             
         LA    RE,SVFAXTBL                                                      
EDI004   CLM   R1,1,SVPRGFAX       THIS THE ONE                                 
         BE    EDI006               YES                                         
         LLC   R4,0(RE)                                                         
         LA    RE,1(R4,RE)         BUMP TO THE NEXT GROUP OF FAXES              
         LA    R0,SVFAXEND                                                      
         CR    R0,RE               ARE WE AT THE END OF TABLE                   
         BH    *+6                                                              
         DC    H'0'                                                             
         LA    R1,1(,R1)                                                        
         B     EDI004                                                           
*                                                                               
EDI006   DS    0H                                                               
         LLC   R4,0(RE)                                                         
         STC   R4,FAXLEN           TOTAL LENGTH FAXES                           
         BCTR  R4,0                                                             
         CLM   R4,1,1(RE)          TOTAL LEN EQU ENTRY LEN?                     
         BE    EDI006A              YES, ONLY ONE FAX                           
         MVI   MFPRGSW,C'Y'                                                     
         OI    PRGFAXSW,X'80'      MULTI FAX PROGRAM                            
         B     *+8                                                              
EDI006A  MVI   MFPRGSW,C'N'                                                     
         LA    RE,1(RE)            ENTRY LENGTH                                 
         B     *+8                                                              
EDI006B  L     RE,FAXPTR                                                        
         LLC   R2,0(RE)            ENTRY LENGTH                                 
         LLC   R4,FAXLEN           TOTAL LENGTH                                 
         SR    R4,R2               REMAINING LENGTH +1                          
         BCTR  R4,0                                                             
         STC   R4,FAXLEN           STORE NEW LENGTH                             
         CLI   FAXLEN,1                                                         
         BH    EDI007                                                           
         LA    R1,0(R2,RE)         POINT TO THE END OF AN ENTRY                 
         CLI   0(R1),X'FF'                                                      
         BNE   EDI007                                                           
         BCTR  R2,0                LENGTH-1 (DO NOT MOVE IN X'FF')              
*                                                                               
         MVI   EDIDESID+5+11,C' '  CLEAR 12TH BYTE                              
         MVI   EDIFDEST+11,C' '    CLEAR 12TH BYTE                              
*                                                                               
         OI    SVFLAG1,OVFAXSW     OVERNIGHT FAX                                
*                                                                               
EDI007   BCTR  R2,0                ADJUST FOR EXECUTED MOVE                     
         EX    R2,MVCDESID                                                      
         EX    R2,MVCFDEST                                                      
*                                                                               
         LA    RE,2(R2,RE)                                                      
         TM    SVFLAG1,OVFAXSW                                                  
         BZ    *+8                                                              
         LA    RE,1(RE)            BUMP 1 FOR X'FF'                             
         ST    RE,FAXPTR           SAVE POINTER TO NEXT FAX                     
         CLI   FAXLEN,1                                                         
         BH    *+8                                                              
         MVI   MFPRGSW,C'N'                                                     
*                                                                               
EDI008   DS   0H                                                                
         TM    UPDSW2,UNTCUTIN      IS THIS CUTIN PROCESSING?                   
         BZ    EDI009                NO                                         
         MVC   EDIDESID(4),SVUNTPOS                                             
         MVI   EDIDESID+4,C'T'                                                  
         MVC   EDIDESID+5(L'EDIDESID-5),SPACES                                  
EDI009   DS   0H                                                                
         MVC   EDIBILL(4),QMED    MEDIA & CLIENT                                
         MVC   EDIBILL+4(4),NETWORK                                             
*                                                                               
         OC    VOPTPROD,VOPTPROD   TEST IF BY PRODUCT                           
         BZ    *+18                                                             
         MVC   EDIBILL+4(3),VOPTPROD                                            
         MVI   EDIBILL+7,C' '                                                   
         B     EDI010                                                           
*                                                                               
         OC    VOPTPRGR,VOPTPRGR   BY PRODUCT GROUP                             
         BZ    EDI010               NO                                          
         MVC   EDIBILL+4(1),SVTN2PRO+00                                         
         MVC   DUB(2),VOPTPRGR                                                  
         MVI   DUB+2,X'0F'                                                      
         UNPK  WORK(5),DUB(3)                                                   
         MVC   EDIBILL+5(4),WORK                                                
         MVI   EDIBILL+9,C' '                                                   
*                                                                               
EDI010   GOTO1 SPOOL,DMCB,(R8)    SEND SPECIAL PRINT LINE                       
*                                                                               
         MVC   EDIDDSID(14),=C'++DDS NENRATRN'                                  
*                                                                               
         MVC   EDINTNMD(4),QMED    MEDIA & CLIENT                               
         MVC   EDINTNPR,VOPTPROD                                                
         MVC   EDINTNET,NETWORK                                                 
*                                                                               
         TM    SVFLAG,SVMPRGFX     MULTI-PROG FAX?                              
         BZ    *+8                                                              
         NI    SVFLAG,X'FF'-SVMPRGFX YES,TURN OFF MULTI-PROG SWITCH             
         MVC   EDINTNPG,SVPRG                                                   
         MVI   EDINTNPM,C' '                                                    
*                                                                               
EDI20    MVC   EDINTNDT,PSTDATE                                                 
         LLC   R0,SVPRGRVN                                                      
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  EDINTNRV,DUB                                                     
*                                                                               
         FIXDT02                                                                
         GOTO1 DATCON,DMCB,(2,SVPGEND),(X'20',EDINTNPD)                         
         MVC   EDINTNSM,SVMEDIA                                                 
         MVC   EDINTNDP,QDPT2                                                   
*                                                                               
         GOTO1 HEXOUT,DMCB,SVPRGDAY,EDINTPDY,L'SVPRGDAY                         
*                                                                               
*PROGRAM TIME                                                                   
         LA    RF,SVPRGTIM         PROGRAM START/END TIME                       
         LR    RE,RF                                                            
         LA    R1,EDINTPTM         PROGRAM START/END TIME OUTPUT FIELD          
         MVI   5(R1),C'-'                                                       
*                                                                               
EDI25    MVI   4(R1),C'A'          PRESET TO AM                                 
         SR    R0,R0                                                            
         ICM   R0,3,0(RF)                                                       
         CHI   R0,1200                                                          
         BL    EDI25C              TIME IS AM                                   
         BE    EDI25B              TIME IS 12 NOON                              
         SHI   R0,1200                                                          
EDI25B   MVI   4(R1),C'P'          SET TO PM                                    
*                                                                               
EDI25C   CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  FULL,DUB                                                         
         MVC   0(4,R1),FULL        MOVE TIME TO OUTPUT FIELD                    
         CR    RF,RE                                                            
         BNE   EDI25X                                                           
*                                                                               
         LA    RF,2(RF)            BUMP TO END TIME                             
         LA    R1,6(R1)                                                         
         B     EDI25                                                            
*                                                                               
EDI25X   GOTO1 SPOOL,DMCB,(R8)    SEND SPECIAL PRINT LINE                       
*                                                                               
         XIT1                                                                   
*                                                                               
MVCDESID MVC   EDIDESID+5(0),1(RE) MOVE FAX NUMBER                              
MVCFDEST MVC   EDIFDEST(0),1(RE)   MOVE FAX NUMBER                              
         LTORG                                                                  
         EJECT                                                                  
*===============================================================                
* PRINT MULTI-FAX RECORD                                                        
*===============================================================                
*                                                                               
GTSPL    NTR1  BASE=*,LABEL=*                                                   
         SR    R0,R0                                                            
         ST    R0,SPECS            NO HEADING SPECS                             
         ST    R0,HEADHOOK            HDHK                                      
         ST    R0,MIDHOOK                                                       
         ST    R0,FOOTHOOK            FTHK                                      
*                                                                               
         CLI   OFFLINE,C'Y'                                                     
         BE    GTSPL02                                                          
*                                                                               
GTSPL01  MVI   SPMODE,X'FF'                                                     
         MVI   PQSW,X'FF'                                                       
         GOTO1 SPOOL,DMCB,(R8)    FORCE CLOSE OF SPOOL                          
         MVI   PQSW,1                                                           
*                                                                               
* RESTORE ORIGINAL REMOTE PRINT SETTINGS *                                      
*                                                                               
         LA    R1,ELEM                                                          
         ST    R1,SPOOLQLK                                                      
         XC    ELEM(128),ELEM                                                   
         USING PQPLD,R1                                                         
         BRAS  RE,INITREM          INITIALIZE PRT QUEUE ENTRY                   
*                                                                               
         BRAS  RE,INITREMF         INITIALIZE FAX PRT QUEUE ENTRY               
*                                                                               
         GOTO1 OPENPQ                                                           
*                                                                               
GTSPL02  BRAS  RE,EASILN                                                        
         MVI   FORCEHED,C'Y'       FORCE NEW PAGE                               
*                                                                               
GTSPL02C LA    R2,TSARBLK                                                       
         USING TSARD,R2                                                         
*                                                                               
         XC    BLOCK(256),BLOCK                                                 
         LA    R7,BLOCK                                                         
         ST    R7,TSAREC           SET ADDRESS OF THE RECORD                    
         USING TSBUFD,R7                                                        
*                                                                               
         LH    R1,TSRKEYF                                                       
         STCM  R1,3,TSBUFKEY       KEY                                          
*                                                                               
         LA    R1,TSOFFACT                                                      
         CLI   OFFLINE,C'Y'                                                     
         BE    *+8                                                              
         LA    R1,TSACTN                                                        
         MVI   0(R1),TSARDH       SET TO READ HIGH                              
*                                                                               
GTSPL10  GOTO1 VTSAR,TSARD                                                      
*                                                                               
GTSPL15  TM    TSERRS,X'C0'        END OF FILE                                  
         BNZ   GTSPL40                                                          
         CLI   TSERRS,0                                                         
         BE    GTSPL20                                                          
         DC    H'0'                                                             
*                                                                               
GTSPL20  MVI   SPACING,1                                                        
         CLI   TSBUFHED,C'Y'       IS THERE ANY FORCEHED                        
         BE    GTSPL30             YES                                          
         CLI   TSBUFSPC,0          IS THERE ANY SPACING BEFORE                  
         BE    GTSPL30              NO                                          
         MVC   SPACING,TSBUFSPC                                                 
         MVI   TSBUFSPC,0          SET OFF FOR LATER                            
         MVI   P1,0                                                             
         MVI   LINE,1                                                           
         GOTO1 SPOOL,DMCB,(R8)                                                  
*                                                                               
GTSPL30  SR    R1,R1                                                            
         ICM   R1,3,TSBUFLEN       RECORD LENGTH                                
         AHI   R1,-7               SUBTRACT HDRLEN +1                           
         EX    R1,GTSPMVC                                                       
*                                                                               
         CLI   OFFLINE,C'Y'        IF OFFLINE, NO DISPLAY                       
         BE    GTSPL32                                                          
*                                                                               
         CLC   =C'REQUESTOR',P1+92                                              
         BNE   GTSPL32                                                          
*                                                                               
         LA    R0,10                                                            
         LA    R4,P1+100                                                        
         CLI   0(R4),C','                                                       
         BE    *+14                                                             
         LA    R4,1(R4)                                                         
         BCT   R0,*-12                                                          
         DC    H'0'                                                             
*                                                                               
         SR    R0,R0               PRINT CORRECT REQUESTOR NUMBER               
         ICM   R0,3,SPOOLRPN                                                    
         EDIT  (R0),(5,1(R4)),ALIGN=LEFT                                        
*                                                                               
GTSPL32  CLI   TSBUFHED,0          IS THERE ANY FORCEHED                        
         BE    *+10                                                             
         MVC   FORCEHED,TSBUFHED                                                
*                                                                               
         CLI   TSBUFSPC,0          IS THERE ANY SPACING                         
         BE    *+10                                                             
         MVC   SPACING,TSBUFSPC                                                 
*                                                                               
* KILL IMFAMOUS AND SPURIOUS FAKE STUFF *                                       
*                                                                               
         CLC   P1+84(19),=C'*** AGENCY COPY ***'                                
         BNE   *+10                                                             
         MVC   P1+84(19),SPACES                                                 
*                                                                               
         CLI   P1+131,X'70'        SPECIAL HEADING NEEDED (OV-FAX)              
         BNE   GTSPL35                                                          
         TM    SVFLAG1,OVFAXSW                                                  
         BZ    GTSPL35                                                          
*                                                                               
         CLC   P1(130),SPACES      ANYTHING TO PRINT ?                          
         BNH   GTSPL34                                                          
         MVI   LINE,1                                                           
         GOTO1 SPOOL,DMCB,(R8)                                                  
*                                                                               
GTSPL34  MVC   P1+85(21),=C'*** OVERNIGHT FAX ***'                              
*                                                                               
GTSPL35  MVI   LINE,1                                                           
         GOTO1 SPOOL,DMCB,(R8)                                                  
*                                                                               
         SR    R1,R1                                                            
         ICM   R1,3,TSBUFKEY                                                    
         CH    R1,TSRKEYL          CHECK FOR LAST PRT LINE                      
         BE    GTSPL40                                                          
*                                                                               
         LA    R1,TSOFFACT                                                      
         CLI   OFFLINE,C'Y'                                                     
         BE    *+8                                                              
         LA    R1,TSACTN                                                        
         MVI   0(R1),TSANXT       SET GET NEXT RECORD                           
         B     GTSPL10                                                          
*                                                                               
GTSPL40  DS    0H                                                               
         CLI   SVTN1PRA,C'Y'       PRINT MG LEGEND                              
         BNE   *+18                                                             
         TM    TABLESW,MAKEGDSW    MAKEGOOD PRINTED ON REPORT?                  
         BZ    *+10                                                             
         MVC   P2+33(11),=C'MG=MAKEGOOD'                                        
*                                                                               
         MVI   P1,0                                                             
*                                                                               
         MVI   OPTICEOM,C'N'                                                    
         GOTO1 SPOOL,DMCB,(R8)                                                  
         MVC   P2(26),=C'*** END OF DDS MESSAGE ***'                            
         MVI   LINE,1                                                           
         GOTO1 SPOOL,DMCB,(R8)                                                  
*                                                                               
         CLI   OFFLINE,C'Y'        IF OFFLINE, NO DISPLAY                       
         BE    GTSPLX                                                           
*                                                                               
         LA    R5,SVSPLRPN                                                      
         OC    SVSPLRPN,SVSPLRPN                                                
         BZ    GTSPL50                                                          
         LA    R5,L'SVSPLRPN(R5)                                                
*                                                                               
GTSPL45  BCTR  R5,0                                                             
         CLI   0(R5),C' '                                                       
         BNH   GTSPL45                                                          
         MVI   1(R5),C','                                                       
*                                                                               
GTSPL50  SR    R0,R0                                                            
         ICM   R0,3,SPOOLRPN                                                    
         EDIT  (R0),(5,2(R5)),ALIGN=LEFT                                        
*                                                                               
GTSPLX   DS   0H                                                                
         XIT1                                                                   
GTSPMVC  MVC   P1(0),TSBUFLIN                                                   
         DROP  R2                                                               
         LTORG                                                                  
         EJECT                                                                  
*======================================================================         
* INITIALIZE STORAGE                                                            
*======================================================================         
                                                                                
INIT     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         LA    RE,SVSTART                                                       
         AHI   RE,6144            LENGTH OF SAVED AREA                          
         LR    RF,R9                                                            
         AHI   RF,((EDSVSYSD-SYSD)-6144)    START OF SAVED AREA                 
*                                                                               
         CR    RE,RF              USE LOWER ADDR                                
         BH    *+6                                                              
         LR    RF,RE                                                            
         ST    RF,ASVSTOR                                                       
         AHI   RF,6144            END OF SAVED AREA                             
         LR    R1,R9                                                            
         AHI   R1,EDSVSYSD-SYSD                                                 
         CR    RF,R1                                                            
         BNL   *+6                                                              
         DC    H'0'                USED MORE THAN SYSD                          
         LHI   R1,ENDSYSD-SYSD                                                  
         C     R1,LSYSD                                                         
         BNH   *+6                                                              
         DC    H'0'                USED MORE THAN LSYSD                         
*                                                                               
         LHI   R1,UNTABLE-T216FFD                                               
         AR    R1,RA                                                            
         SRL   R1,4                                                             
         SLL   R1,4                DOUBLE WORD BOUNDARY                         
*                                                                               
         MVC   0(8,R1),=C'*UNTABL*'                                             
         LA    R1,8(R1)            START OF UNIT TABLE                          
         ST    R1,AUNTABLE                                                      
         AHI   R1,ENDUNTBL-UNTABLE UNIT TABLE LENGTH                            
         ST    R1,AUNTABLX                                                      
*                                                                               
         LA    R1,PRGTABLE-8                                                    
         MVC   0(8,R1),=C'*PRGTBL*'                                             
         LA    R1,8(R1)                                                         
         ST    R1,APRGTBLE                                                      
         AHI   R1,PRGTABLX-PRGTABLE                                             
         ST    R1,APRGTBLX                                                      
*                                                                               
         MVC   0(8,R1),=C'*FTNOTE*'                                             
         LA    R1,8(R1)                                                         
         ST    R1,ASVFTNT                                                       
         LA    R1,200(R1)          200 CHAR MAX                                 
         ST    R1,ASVFTNTX                                                      
*                                                                               
         CLI   OFFLINE,C'Y'                                                     
         BNE   INIT10                                                           
                                                                                
* OFFLINE SPACE ALLOCATION                                                      
                                                                                
         L     RE,TWADCONS         MAKE SURE OUTPUT DCB ADDRESS SET             
         USING TWADCOND,RE          FOR OFFLINE JOBS                            
         L     RE,TSPFUSER                                                      
         MVC   0(8,RE),=C'*ERRFIL*'                                             
         LA    RE,8(,RE)                                                        
         ST    RE,AERRFILE                                                      
         DROP  RE                                                               
*                                                                               
         L     R1,VADUMMY                                                       
         MVC   0(8,R1),=CL8'*UNTABL*'                                           
         LA    R1,8(R1)                                                         
         ST    R1,AUNTABLE                                                      
         A     R1,=F'96000'                                                     
         ST    R1,AUNTABLX                                                      
*                                                                               
         MVC   0(8,R1),=CL8'*PRGTBL*'                                           
         LA    R1,8(R1)                                                         
         ST    R1,APRGTBLE                                                      
         A     R1,=F'10000'                                                     
         ST    R1,APRGTBLX                                                      
*                                                                               
         MVC   0(8,R1),=CL8'*PRTBUFF'                                           
         LA    R1,8(R1)                                                         
         ST    R1,APRTBUFF                                                      
         AHI   R1,4096                                                          
         ST    R1,APRTBUFX                                                      
*                                                                               
         MVC   0(8,R1),=C'*FTNOTE*'                                             
         LA    R1,8(R1)                                                         
         ST    R1,ASVFTNT                                                       
         LA    R1,200(R1)          200 CHAR MAX                                 
         ST    R1,ASVFTNTX                                                      
                                                                                
*==============================================================                 
* ALLOCATE ADDITIONAL STORAGE IN T2168C                                         
* DO A MAINT CALL TO LOAD IT AT END OF THIS PHASE                               
* SINCE REAL NODE IS USED BY SPTRA04/07.                                        
*==============================================================                 
                                                                                
INIT10   XC    DMCB(24),DMCB                                                    
         L     RE,=V(ENDOFMOD)                                                  
         A     RE,SPTR1FRR                                                      
         ST    RE,DMCB                                                          
         MVC   DMCB+4(4),=X'D902168C'                                           
         GOTO1 CALLOV,DMCB                                                      
         CLI   4(R1),X'FF'                                                      
         BNE   *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     RE,0(R1)            GET PHASE ADDRESS                            
*                                                                               
         ICM   R5,15,8(RE)         MAX STORAGE LENGTH FROM 8C                   
         AR    R5,RE               A(EOT)                                       
*                                                                               
         LA    RE,16(RE)           CAN USE FROM +16                             
         MVC   0(8,RE),=C'*PRTSAVE'                                             
         LA    RE,8(RE)                                                         
         ST    RE,APRTSAVE         FIRST 528 BYTES SAVE P1-P4                   
         LA    RE,560(RE)                                                       
*                                                                               
         MVC   0(8,RE),=C'*FTNOTE*'                                             
         LA    RE,8(RE)                                                         
         ST    RE,ASVFTNT                                                       
         LA    RE,200(RE)          200 CHAR MAX                                 
*                                                                               
         MVC   0(8,RE),=C'*PRTBUFF'                                             
         LA    RE,8(RE)                                                         
         ST    RE,APRTBUFF                                                      
         AHI   RE,4096                                                          
         ST    RE,APRTBUFX                                                      
*                                                                               
         MVC   0(8,RE),=C'*ADDTBL*'                                             
         LA    RE,8(RE)                                                         
         ST    RE,AADDTBL                                                       
         AHI   RE,100*ADDTBLLN                                                  
         ST    RE,AADDTBLX                                                      
*                                                                               
         MVC   0(8,RE),=C'*CMLTBL*'                                             
         LA    RE,8(RE)                                                         
         ST    RE,ACMLTBL                                                       
         AHI   RE,NCOMMLT*CMLTBLLN                                              
         ST    RE,ACMLTBLX                                                      
*                                                                               
         MVC   0(8,RE),=C'*WKBUFF*'                                             
         LA    RE,8(RE)                                                         
         ST    RE,AWKBUFF                                                       
         AHI   RE,14*1024                                                       
*                                                                               
         CR    R5,RE               PAST END                                     
         BH    *+6                                                              
         DC    H'0'                MAKE T2168C BIGGER                           
*                                                                               
         SR    R0,R0               ADDRESS OF REC TO BE ADDED                   
         L     R1,AADDTBL          ADDRESS OF BINTABLE                          
         SR    R2,R2               NUMBER OF RECS IN TABLE                      
         LA    R3,ADDTBLLN         LENGTH OF BIN RECORD                         
         LA    R4,L'ADDTBCOD       LENGTH OF BIN KEY                            
         LA    R5,100              MAXIMUM RECORDS IN BINTBL                    
         STM   R0,R5,BINPARS                                                    
*                                                                               
         SR    R0,R0               ADDRESS OF REC TO BE ADDED                   
         L     R1,ACMLTBL          ADDRESS OF BINTABLE                          
         SR    R2,R2               NUMBER OF RECS IN TABLE                      
         LA    R3,CMLTBLLN         LENGTH OF BIN RECORD                         
*NOP     LA    R4,L'CMLSHCML       LENGTH OF BIN KEY                            
         LA    R4,L'CMLKEYL        LENGTH OF BIN KEY                            
         LA    R5,NCOMMLT          MAX RECORDS IN BINTBL (500)                  
         STM   R0,R5,BINPAR7                                                    
*                                                                               
         L     R0,ACMLTBL          CLEAR CML TABLE                              
         L     R1,ACMLTBLX                                                      
         SR    R1,R0                                                            
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
         L     RE,=V(XSORT)                                                     
         A     RE,SPTR1FRR                                                      
         ST    RE,VXSORT                                                        
*                                                                               
         LAY   RE,BOXER                                                         
         ST    RE,VBOXER                                                        
*                                                                               
         XC    DMCB(8),DMCB                                                     
         LA    R1,DMCB                                                          
         L     RF,CALLOV                                                        
         MVC   DMCB+4(4),=X'D9000A50'  QSORT                                    
         GOTO1 (RF),(R1),0                                                      
         MVC   QSORT,DMCB                                                       
*                                                                               
         XC    DMCB(7),DMCB                                                     
         MVC   DMCB+4(4),=X'D9000A1D'  GETBROAD                                 
         GOTO1 (RF),(R1),0                                                      
         CLI   4(R1),X'FF'                                                      
         BNE   *+6                                                              
         DC    H'0'                                                             
         MVC   VGTBROAD,0(R1)                                                   
*                                                                               
         MVC   DMCB+4(4),=X'D9000AFE'    GET ADDRESS OF TRPACK                  
         GOTO1 CALLOV,DMCB                                                      
         MVC   VTRPACK,0(R1)                                                    
*                                                                               
         XIT1                                                                   
         LTORG                                                                  
         EJECT                                                                  
INITTSR  NTR1  BASE=*,LABEL=*                                                   
         XC    TSARCT,TSARCT                                                    
         XC    VTSAR,VTSAR                                                      
         XC    TSARBYTE,TSARBYTE                                                
         XC    TSARBLK,TSARBLK                                                  
*                                                                               
         LA    RE,TSARBLK                                                       
         LA    RF,TSARBLKX                                                      
         SR    RF,RE                                                            
         SR    R0,R0                                                            
         SR    R1,R1                                                            
         MVCL  RE,R0                                                            
*                                                                               
         LA    R2,TSARBLK                                                       
         USING TSARD,R2                                                         
*                                                                               
         MVC   TSACOM,ACOMFACS                                                  
         MVI   TSKEYL,2                                                         
         MVI   TSRECL+1,138                                                     
         OI    TSRECI,TSRVAR                                                    
*                                                                               
         CLI   OFFLINE,C'Y'                                                     
         BNE   INITTS2                                                          
*                                                                               
         MVI   TSOFFACT,TSAINI     SET 1ST TSAR FOR INIT                        
         OC    TSARBUFF,TSARBUFF                                                
         BNZ   INITTS4                                                          
*                                                                               
         L     R0,=F'8000000'   OFFLINE DO GETMAIN                              
         ST    R0,TSARBUFL                                                      
         GETMAIN RU,LV=(0),LOC=(ANY,ANY)                                        
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
         ST    R1,TSARBUFF                                                      
*                                                                               
         USING TSARD,R2                                                         
         MVC   TSABUF,TSARBUFF                                                  
         MVC   TSAREC,TSARBUFL                                                  
*                                                                               
         GOTO1 CALLOV,DMCB,0,(C'R',X'00000A7D')  OFFLINE CALLOFF                
         ICM   RF,15,0(R1)                                                      
         BNZ   *+6                                                              
         DC    H'0'                                                             
         ST    RF,VTSAR                                                         
         B     INITTS4                                                          
*                                                                               
INITTS2  GOTO1 CALLOV,DMCB,0,(C'R',X'00000A5D')   ONLINE CALLOV                 
         ICM   RF,15,0(R1)                                                      
         BNZ   *+6                                                              
         DC    H'0'                                                             
         ST    RF,VTSAR                                                         
*                                                                               
         MVI   TSACTN,TSAINI       SET 1ST TSAR FOR INIT                        
         MVI   TSPAGN,20           NUMBER OT TMPSTR PAGES                       
         MVC   TSARBUFL,=F'180000'                                              
         OI    TSINDS,TSINODSK                                                  
         OI    TSIND2,TSI2MANY+TSI2BIGN   USE BOTH BUFFERS                      
*                                                                               
INITTS4  GOTO1 VTSAR,TSARD                                                      
         CLI   TSERRS,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   SVREMUSR,REMUSER                                                 
         XIT1                                                                   
         LTORG                                                                  
         EJECT                                                                  
         GETEL R6,DATADISP,ELCODE                                               
*                                                                               
INITNET  DS    0H                                                               
         MVI   LKEY+1,20                                                        
         MVI   DATADISP+1,27                                                    
         MVI   LSTATUS+1,1                                                      
         MVI   SYSDIR,C'U'                                                      
         MVI   SYSDIR+1,C'N'                                                    
         MVI   SYSDIR+2,C'T'                                                    
         MVI   SYSFIL,C'U'                                                      
         MVI   SYSFIL+1,C'N'                                                    
         MVI   SYSFIL+2,C'T'                                                    
         BR    RE                                                               
INITSPT  MVI   LKEY+1,13                                                        
         MVI   DATADISP+1,24                                                    
         MVI   LSTATUS+1,1                                                      
         MVI   SYSDIR,C'S'                                                      
         MVI   SYSDIR+1,C'P'                                                    
         MVI   SYSDIR+2,C'T'                                                    
         MVI   SYSFIL,C'S'                                                      
         MVI   SYSFIL+1,C'P'                                                    
         MVI   SYSFIL+2,C'T'                                                    
         BR    RE                                                               
*                                                                               
* RESET FILES TO XFILE *                                                        
*                                                                               
INITXSP  MVI   DATADISP+1,42       SET FROM SPOT TO XSP                         
         MVI   LKEY+1,32                                                        
         MVI   LSTATUS+1,4                                                      
         MVI   SYSDIR,C'X'                                                      
         MVI   SYSDIR+1,C'S'                                                    
         MVI   SYSDIR+2,C'P'                                                    
         MVI   SYSFIL,C'X'                                                      
         MVI   SYSFIL+1,C'S'                                                    
         MVI   SYSFIL+2,C'P'                                                    
         BR    RE                                                               
                                                                                
*===============================================================                
*        INITIALIZE PRT QUEUE ENTRY                                             
*===============================================================                
                                                                                
         USING PQPLD,R1                                                         
INITREM  DS    0H                                                               
*AR                                                                             
         MVI   QLEXTRA,X'FF'                                                    
         MVC   QLARC,SVQLARC                                                    
*AR                                                                             
         MVC   QLTYP1,SVQLTYP1                                                  
         MVI   QLEXTRA,X'FF'       NEW PARM LIST                                
         OI    SPOOLIND,X'40'      USER VALUES PRESENT                          
         MVC   QLDESC(1),QMED                                                   
         MVC   QLDESC+2(3),QCLT                                                 
         MVC   QLDESC+6(4),NETWORK                                              
         BR    RE                                                               
         SPACE                                                                  
INITREMF DS    0H                                                               
*AR                                                                             
         MVI   QLEXTRA,X'FF'                                                    
         MVC   QLARC,SVQLARC                                                    
*AR                                                                             
         MVC   QLTYP1,SVFAXARC                                                  
         MVI   REMUSER,C'N'                                                     
         MVI   REMUSER+1,C'W'                                                   
         MVI   REMUSER+2,C'X'                                                   
         MVI   QLCLASS,C'G'                                                     
         MVC   QLDESC(1),QMED                                                   
         MVC   QLDESC+2(3),QCLT                                                 
         MVC   QLDESC+6(4),NETWORK                                              
         BR    RE                                                               
         DROP  R1                                                               
*                                                                               
UNTDIRHI MVC   KEYSAVE,KEY                                                      
         BRAS  RF,GOUNTDIR                                                      
         DC    CL8'DMRDHI  '                                                    
         DC    CL8'UNTDIR  '                                                    
*                                                                               
UNTDIRSQ BRAS  RF,GOUNTDIR                                                      
         DC    CL8'DMRSEQ'                                                      
         DC    CL8'UNTDIR'                                                      
*                                                                               
GOUNTDIR NTR1  BASE=*,LABEL=*                                                   
         ST    RF,DMCB                                                          
         MVC   DMCB(1),DMINBTS                                                  
         LA    RF,8(RF)                                                         
         ST    RF,DMCB+4                                                        
         GOTO1 DATAMGR,DMCB,,,KEYSAVE,KEY                                       
         CLC   KEY(32),KEYSAVE                                                  
         J     EXIT                                                             
*                                                                               
SPTDIRHI MVC   KEYSAVE,KEY                                                      
         BRAS  RF,GOSPTDIR                                                      
         DC    CL8'DMRDHI  '                                                    
         DC    CL8'SPTDIR  '                                                    
*                                                                               
GOSPTDIR NTR1  BASE=*,LABEL=*                                                   
         ST    RF,DMCB                                                          
         LA    RF,8(RF)                                                         
         ST    RF,DMCB+4                                                        
         GOTO1 DATAMGR,DMCB,,,KEYSAVE,KEY                                       
         CLC   KEY(13),KEYSAVE                                                  
         J     EXIT                                                             
*                                                                               
XSPDIRHI MVC   KEYSAVE,KEY                                                      
         BRAS  RF,GOXSPDIR                                                      
         DC    CL8'DMRDHI  '                                                    
         DC    CL8'XSPDIR  '                                                    
*                                                                               
GOXSPDIR NTR1  BASE=*,LABEL=*                                                   
         ST    RF,DMCB                                                          
         LA    RF,8(RF)                                                         
         ST    RF,DMCB+4                                                        
         GOTO1 DATAMGR,DMCB,,,KEYSAVE,KEY                                       
         CLC   KEY(32),KEYSAVE                                                  
         J     EXIT                                                             
         LTORG                                                                  
         EJECT                                                                  
*==========================================                                     
* VALIDATE NETWORK                                                              
*==========================================                                     
                                                                                
VNET     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         LA    R2,TRANETH          NETWORK                                      
         GOTO1 ANY                                                              
*                                                                               
         MVI   KEY,C'0'                                                         
         MVC   KEY+1(16),KEY       PRE-FILL THE KEY WITH ZEROES                 
         LA    R4,KEY                                                           
         USING STARECD,R4                                                       
         MVI   STAKTYPE,C'S'                                                    
         MVI   STAKMED,C'N'                                                     
         MVC   STAKCALL(4),WORK                                                 
         MVI   STAKCALL+4,C'N'                                                  
         MVC   STAKAGY,AGENCY                                                   
         MVC   STAKCLT,BCLT                                                     
*                                                                               
         GOTO1 DATAMGR,DMCB,=C'DMREAD',=C'STATION',KEY,AIO                      
         CLI   8(R1),0                                                          
         BNE   NETERR                                                           
*                                                                               
         MVC   NETWORK,WORK                                                     
         L     R4,AIO                                                           
         MVC   SVSMKT,SMKT         SAVE MARKET CODE                             
         PACK  DUB,SMKT                                                         
         CVB   R0,DUB                                                           
         STH   R0,NETMKT                                                        
         MVC   SVNETFAX,SFAX                                                    
*                                                                               
         MVC   SVMEDIA,STRTYPE     SAVE MEDIA (N,H,D,C,S,O,V)                   
         OI    4(R2),X'20'         SET ON VALIDATED                             
         DROP  R4                                                               
*                                                                               
* GET MARKET NAME                                                               
*                                                                               
         MVI   KEY,C'0'                                                         
         MVC   KEY+1(MKTKEYLN),KEY   PRE-FILL THE KEY WITH ZEROES               
         MVI   KEY,C'M'                                                         
         MVC   KEY+1(1),QMED                                                    
         MVC   KEY+2(4),SVSMKT                                                  
         MVC   KEY+6(2),AGENCY                                                  
*                                                                               
         GOTO1 DATAMGR,DMCB,=C'DMRDHI',=C'STATION',KEY,AIO                      
*                                                                               
         MVC   SVMKTNM(19),=C'**MKT NOT ON FILE**'                              
*                                                                               
         L     R6,AIO                                                           
         USING MKTRECD,R6                                                       
*                                                                               
         CLC   KEY(MKTKEYLN),0(R6)                                              
         BNE   *+10                RECORD NOT FOUND                             
         MVC   SVMKTNM,MKTNAME                                                  
         J     EXIT                                                             
*                                                                               
NETERR   MVC   GERROR,=Y(NONET)                                                 
         B     *+10                                                             
NETERR2  MVC   GERROR,=Y(BDNETMED)                                              
         GOTO1 VTRAERR                                                          
         DROP  R6                                                               
         EJECT                                                                  
*=========================================================                      
* VALIDATE PROGRAM                                                              
*=========================================================                      
                                                                                
VPROG    NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         CLI   OFFLINE,C'Y'                                                     
         BNE   VPROG00             DON'T OPEN UNLESS OFFLINE                    
         CLI   SVTWPR06,C'N'       IF NOT FAXING, PRINT ANY ERRORS              
         BE    *+12                                                             
         TM    WHEN,X'20'                                                       
         BO    VPROG00             DON'T OPEN FOR SOON                          
         L     R2,AERRFILE                                                      
         L     RF,=A(ERRFILE)                                                   
         TM    WHEN,X'20'          IF SOON                                      
         BZ    *+10                                                             
         MVC   40(8,RF),=CL8'TALWRK'                                            
*                                                                               
         MVC   0(128,R2),0(RF)                                                  
         OPEN  ((R2),OUTPUT)                                                    
         LLC   RE,ERRFILSW                                                      
         LA    RE,1(,RE)                                                        
         STC   RE,ERRFILSW                                                      
         CLI   ERRFILSW,1                                                       
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LTR   RF,RF                                                            
         BZ    VPROG00                                                          
         DC    H'0'                                                             
*                                                                               
VPROG00  LA    R2,TRAPRGH          PROGRAM                                      
*                                                                               
         GOTO1 ANY                                                              
         CLC   =CL6'ALL   ',WORK                                                
         BE    *+10                                                             
         MVC   PROGRAM,WORK                                                     
*                                                                               
         BAS   RE,GTEQV            GET EQUIV PROGS AND BUILD TABLE              
*                                                                               
         MVC   BASEPRG,PROGRAM                                                  
         MVC   BASEDTS,STDATEP                                                  
*                                                                               
VPROG10  BRAS  RE,ININETIO         INITIALIZE NETIO                             
*                                                                               
VPROG30  DS    0H                                                               
         TM    SECFLAG,BLSSW       BRAND LEVEL SECURITY CLIENT                  
         BZ    VPROG35                                                          
*                                                                               
         CLI   T216FFD+6,C'$'      USER SIGN ON OFFICE LIST                     
         BNE   *+18                                                             
         OI    NBINDS5,NBI5PLST    SET OFFICE LIST FLAG                         
         MVC   NBSECSV,ASECBLK     PASS ADDRESS OF SECURITY BLOCK               
         B     *+12                                                             
         CLI   T216FFD+6,C'*'      USER SIGN ON BY OFFICE                       
         BNE   VPROG35              NO                                          
*                                                                               
         MVC   NBTRAPSC,T216FFD+7  BRAND LEVEL OFFICE(LIST)                     
*                                                                               
VPROG35  GOTO1 ANETIO,DMCB,(R3)                                                 
         CLI   NBERROR,NBGOOD                                                   
         BE    VPROG40                                                          
         DC    H'0'                                                             
VPROG40  CLI   NBMODE,NBREQLST                                                  
         BE    VPROG50             NO UNITS                                     
         CLI   NBMODE,NBPROCUN                                                  
         BNE   VPROG30                                                          
*                                                                               
         CLI   SVTNPR9,C'B'        BOTH MEDIA AND SKED                          
         BE    VPROG44                                                          
         CLI   SVTNPR9,C'S'        IF NOT SKED, MUST BE MEDIA                   
         BNE   VPROG42                                                          
         CLI   NBACTSUB,C'A'       SKED ONLY                                    
         BL    VPROG30                                                          
         B     VPROG44                                                          
*                                                                               
VPROG42  CLI   NBACTSUB,C'A'                                                    
         BNL   VPROG30                                                          
*                                                                               
VPROG44  OC    PROGRAM,PROGRAM     SPECIFIC PROGRAM REQUEST                     
         BZ    VPROG46                                                          
         CLC   NBACTPRG,NBSELPRG                                                
         BNE   NOUNITER                                                         
*                                                                               
VPROG46  LHI   RE,EQVPTBL-SYSD     SET OFF ALL EQVUSED                          
         AR    RE,R9                                                            
         LA    RF,L'EQVPTBL/(EQVNEXT-EQVENT)                                    
         USING EQVPTBLD,RE                                                      
*                                                                               
VPROG48  OC    EQVENT,EQVENT       EMPTY ENTRY                                  
         BZ    VPROGX              NO UNITS                                     
         MVI   EQVUSED,0           SET OFF ENTRY USED ALREADY                   
         LA    RE,EQVNEXT                                                       
         BCT   RF,VPROG48                                                       
*                                                                               
VPROGX   OI    4(R2),X'20'         SET ON VALIDATED                             
         J     EXIT                                                             
         EJECT                                                                  
* HAVE NOT FOUND GOOD UNIT ON REQUESTED CODE, SEE IF EQUIVALENTS *              
*                                                                               
VPROG50  DS    0H                  NOW LOOK FOR EQUIVALENT PROGRAMS             
         LHI   RE,EQVPTBL-SYSD                                                  
         AR    RE,R9                                                            
         LA    RF,L'EQVPTBL/(EQVNEXT-EQVENT)                                    
         USING EQVPTBLD,RE                                                      
*                                                                               
VPROG54  OC    EQVENT,EQVENT       EMPTY ENTRY                                  
         BZ    NOUNITER            NO UNITS                                     
         CLI   EQVUSED,C'Y'        ENTRY USED ALREADY                           
         BNE   VPROG60                                                          
         LA    RE,EQVNEXT                                                       
         BCT   RF,VPROG54                                                       
         B     NOUNITER                                                         
*                                                                               
VPROG60  MVI   EQVUSED,C'Y'                                                     
         MVC   BASEDTS,EQVSDT                                                   
         MVC   BASEPRG,EQVEPRG                                                  
         B     VPROG10                                                          
         DROP  RE                                                               
*                                                                               
NOUNITER MVC   GERROR,=Y(NOUNTPER)                                              
         B     VPROGERX                                                         
EQVPRGER MVC   GERROR,=Y(NOEQUIV)                                               
*                                                                               
VPROGERX BRAS  RE,PER               PRINT ERROR REPORT                          
VPROGERZ GOTO1 VTRAERR                                                          
         EJECT                                                                  
* GET EQUIVALENT PROGRAM RECORDS FOR CLIENT *                                   
*                                                                               
         DS   0H                                                                
GTEQV    NTR1                                                                   
*                                                                               
         BRAS  RE,INITNET          SWITCH TO NET                                
         LHI   RE,EQVPTBL-SYSD                                                  
         AR    RE,R9                                                            
         LA    RF,L'EQVPTBL                                                     
         XCEF                                                                   
*                                                                               
         LHI   R2,EQVPTBL-SYSD                                                  
         AR    R2,R9                                                            
         LA    R3,L'EQVPTBL/(EQVNEXT-EQVENT)                                    
         LA    R5,1                INITIALIZE COUNTER                           
         USING EQVPTBLD,R2                                                      
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING PGEKEY,R4                                                        
         MVI   PGEKID,X'24'                                                     
         MVC   PGEKAM(3),BAGYMD    & BCLT                                       
         MVC   PGEKNET,NETWORK                                                  
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
*                                                                               
GTEQV10  CLC   KEY(8),KEYSAVE                                                   
         BNE   GTEQVX                                                           
*                                                                               
         L     R6,AIO1                                                          
         ST    R6,AIO                                                           
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
*                                                                               
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BE    GTEQV24                                                          
         DC    H'0'                                                             
         USING PGEDTAEL,R6                                                      
*                                                                               
GTEQV20  BRAS  RE,NEXTEL                                                        
         BNE   GTEQV30                                                          
*                                                                               
GTEQV24  OC    PROGRAM,PROGRAM     THIS ALL PROGRAMS                            
         BZ    GTEQV26                                                          
         CLC   PROGRAM,PGEPROG     SAME BASE PROG                               
         BNE   GTEQV20                                                          
*                                                                               
         FIXDT02                                                                
GTEQV26  GOTO1 DATCON,DMCB,(3,PGESTR),(2,WORK)                                  
         FIXDT02                                                                
         GOTO1 (RF),(R1),(3,PGEEND),(2,WORK+2)                                  
*                                                                               
         CLC   WORK(2),ENDATEP     SEE IF WITHIN DATES                          
         BH    GTEQV20                                                          
         CLC   WORK+2(2),STDATEP                                                
         BL    GTEQV20                                                          
*                                                                               
         CLC   WORK(2),STDATEP                                                  
         BNL   *+10                                                             
         MVC   WORK(2),STDATEP     FORCE DATES TO BE WITHIN PERIOD              
*                                                                               
         CLC   WORK+2(2),ENDATEP                                                
         BNH   *+10                                                             
         MVC   WORK+2(2),ENDATEP                                                
*                                                                               
         MVC   EQVDTS,WORK                                                      
*                                                                               
         MVC   EQVEPRG,PGEKPRG                                                  
         MVC   EQVBPRG,PGEPROG                                                  
         STC   R5,EQVCT                                                         
         LA    R5,1(,R5)           ADD 1 TO ENTRY COUNT                         
         LA    R2,EQVNEXT                                                       
         BCT   R3,GTEQV20                                                       
         DC    H'0'                                                             
*                                                                               
GTEQV30  DS    0H                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 SEQ                                                              
         B     GTEQV10                                                          
*                                                                               
GTEQVX   DS    0H                                                               
         CLI   KEYSAVE+2,0         DID WE LOOK ACROSS ALL CLIENT                
         BE    GTEQVX10             YES WE ARE DONE                             
         XC    KEY,KEY                                                          
         MVC   KEY(2),KEYSAVE       ID/A/M                                      
         MVC   KEY+4(4),NETWORK     NETWORK                                     
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
*                                                                               
         B     GTEQV10                                                          
*                                                                               
GTEQVX10 DS   0H                                                                
         BRAS  RE,INITSPT          SET TO SPOT                                  
         B     VPROGX                                                           
*                                                                               
         DROP  R2,R4,R6                                                         
         EJECT                                                                  
*==============================================================                 
* SUBROUTINE VALIDATES PERIOD AND CALCULATES START/END DATES                    
*==============================================================                 
                                                                                
VPER     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         LA    R2,TRAPERH          PERIOD                                       
         MVI   TABLESW,0           RESET TABLE BUILT                            
         CLI   5(R2),0             ANY ENTRY                                    
         BE    MISSERRA            NO, ERROR                                    
*                                                                               
         OC    NBUSER,NBUSER       CK IF NBUSER ALREADY FILLED                  
         BNZ   VPER02                                                           
*                                                                               
         XC    KEY,KEY             GET USER PROFILE INTO NBUSER                 
         MVC   KEY(4),=C'S0N0'                                                  
         MVC   KEY+4(2),AGENCY                                                  
         MVI   KEY+6,C'N'                                                       
         MVC   KEY+7(3),QCLT                                                    
         MVI   KEY+10,C'*'                                                      
         MVC   KEY+11(1),SVCLTOFF                                               
*                                                                               
         TM    SECFLAG,BLSSW       BRAND LEVEL SECURITY                         
         BZ    VPER01                                                           
*                                                                               
         TM    SECFLAG,NEPRDOFF    PRDS OFFICES NOT EQUAL                       
         BO    VPER01                                                           
*                                                                               
         MVC   KEY+11(1),SVPRDOFF  ELSE USE PROD OFFICE                         
*                                                                               
VPER01   GOTO1 GETPROF,DMCB,KEY,NBUSER,DATAMGR GET PROFILE IN NBUSER            
*                                                                               
VPER02   LA    R4,TRAPER                                                        
         CLI   0(R4),C'?'          QUESTION MARK HELP                           
         BNE   VPER04                                                           
         LA    R4,1(,R4)                                                        
*                                                                               
VPER04   GOTO1 DATVAL,DMCB,(0,0(R4)),STDATE                                     
         OC    DMCB(4),DMCB                                                     
         BZ    VPER06                                                           
         CLI   MYTN2PR6,C'W'       INSTR PERIOD = WEEKLY                        
         BNE   PERDATER                                                         
*                                                                               
         GOTO1 GETDAY,(R1),(0,STDATE),WORK                                      
         CLI   0(R1),1             MUST BE MONDAY                               
         BNE   DAYDATER                                                         
         GOTO1 ADDAY,(R1),STDATE,ENDATE,F'6'                                    
*                                                                               
         TM    SVFLAG,CONVSW       CONVERTED RECORDS?                           
         BZ    VPER05                                                           
*                                                                               
         MVC   WORK(6),STDATE                                                   
         BAS   RE,CONVPER                                                       
         MVC   PERIOD,WORK+6                                                    
         B     VPER30                                                           
*                                                                               
VPER05   GOTO1 DATCON,(R1),(0,STDATE),(3,PERIOD)                                
         B     VPER30                                                           
*                                                                               
VPER06   GOTO1 DATVAL,DMCB,(2,0(R4)),STDATE                                     
         OC    DMCB(4),DMCB                                                     
         BZ    PERDATER                                                         
         CLI   MYTN2PR6,C'W'       INSTR PERIOD = WEEKLY                        
         BE    WKDATER                                                          
*                                                                               
         GOTO1 DATCON,(R1),(0,STDATE),(3,PERIOD)                                
         CLI   MYTN2PR6,C'B'       TRAFFIC BROADCAST MONTH                      
         BE    VPER20                                                           
         CLI   MYTN2PR6,C'C'       TRAFFIC CALENDAR MONTH                       
         BE    VPER10                                                           
         CLI   NBUSER+3,C'B'       BROADCAST MONTH                              
         BE    VPER20                                                           
         MVI   MYTN2PR6,C'C'       CALENDAR MONTH                               
*                                                                               
* GET START AND END OF CALENDAR MONTH *                                         
*                                                                               
VPER10   MVC   STDATE+4(2),=C'01'                                               
         GOTO1 ADDAY,(R1),STDATE,ENDATE,F'31'                                   
*                                                                               
VPER14   GOTO1 (RF),(R1),ENDATE,ENDATE,F'-1'                                    
         CLC   STDATE(4),ENDATE                                                 
         BNE   VPER14                                                           
         B     VPER30                                                           
         EJECT                                                                  
* GET BROADCAST MONTH *                                                         
*                                                                               
VPER20   DS    0H                                                               
         MVI   MYTN2PR6,C'B'       BROADCAST MONTH                              
         MVC   STDATE+4(2),=C'15'                                               
         MVC   WORK(6),STDATE                                                   
         GOTO1 VGTBROAD,DMCB,(1,WORK),STDATE,GETDAY,ADDAY                       
*                                                                               
         FIXDT02                                                                
VPER30   GOTO1 DATCON,(R1),(0,STDATE),(2,STDATEP)                               
         FIXDT02                                                                
         GOTO1 (RF),(R1),(0,ENDATE),(2,ENDATEP)                                 
*                                                                               
         CLI   TRAPER,C'?'         QUESTION MARK HELP                           
         BNE   VPERX                                                            
*                                                                               
         MVC   GERROR,=Y(PERHLP)                                                
         MVI   GMSGTYPE,C'I'                                                    
         XC    ELEM,ELEM                                                        
         LA    R4,ELEM                                                          
         STCM  R4,7,GASUBST        A(SUBST TEXT)                                
         MVI   0(R4),15            L'SUBST TEXT + 1                             
         MVC   1(14,R4),=C'CALENDAR MONTH'                                      
*                                                                               
         CLI   MYTN2PR6,C'W'       TRAFFIC WEEKLY PERIOD                        
         BE    VPER44                                                           
         CLI   MYTN2PR6,C'B'       TRAFFIC BROADCAST MONTH                      
         BE    VPER42                                                           
         CLI   MYTN2PR6,C'C'       TRAFFIC CALENDAR MONTH                       
         BE    VPER46                                                           
         CLI   NBUSER+3,C'B'       BROADCAST MONTH                              
         BNE   VPER46                                                           
*                                                                               
VPER42   MVI   0(R4),16            L'SUBST TEXT + 1                             
         MVC   1(15,R4),=CL9'BROADCAST MONTH'                                   
         B     VPER46                                                           
VPER44   MVI   0(R4),14                                                         
         MVC   1(13,R4),=CL9'CALENDAR WEEK'                                     
*                                                                               
VPER46   LLC   R0,0(R4)                                                         
         AR    R4,R0                                                            
         MVI   0(R4),9             L'SUBST TEXT + 1                             
         FIXDT02                                                                
         GOTO1 DATCON,DMCB,(2,STDATEP),(5,1(R4))                                
         LA    R4,9(R4)                                                         
         MVI   0(R4),9             L'SUBST TEXT + 1                             
         FIXDT02                                                                
         GOTO1 (RF),(R1),(2,ENDATEP),(5,1(R4))                                  
         B     VPERERX                                                          
VPERX    OC    VOPTDATE,VOPTDATE   DOING PARTIAL PERIOD                         
         BZ    VPERX10                                                          
*                                                                               
         CLC   VOPTDATE,STDATEP                                                 
         BL    BADPARER                                                         
         CLC   VOPTDATE,ENDATEP                                                 
         BH    BADPARER                                                         
         FIXDT02                                                                
         GOTO1 DATCON,DMCB,(2,VOPTDATE),(0,STDATE)                              
         MVC   STDATEP,VOPTDATE                                                 
*                                                                               
VPERX10  GOTO1 DATCON,DMCB,(0,STDATE),(X'20',PSTDATE) PRINTABLE DATES           
         GOTO1 (RF),(R1),(0,ENDATE),(X'20',PENDATE)                             
         XIT1                                                                   
*                                                                               
MISSERRA MVI   ERROR,MISSING                                                    
         GOTO1 ERREX                                                            
PERDATER MVC   GERROR,=Y(ONLYMMYY)                                              
         CLI   MYTN2PR6,C'W'       INSTR PERIOD = WEEKLY                        
         BE    WKDATER                                                          
         B     VPERERX                                                          
DAYDATER MVC   GERROR,=Y(MONSTDT)                                               
         XC    ELEM,ELEM                                                        
         LA    R1,ELEM                                                          
         STCM  R1,7,GASUBST        A(SUBST TEXT)                                
         MVI   ELEM,4              L'SUBST TEXT + 1                             
         MVC   ELEM+1(3),WORK                                                   
         B     VPERERX                                                          
BADPARER MVC   GERROR,=Y(BDPARPER)                                              
         B     VPERERX                                                          
WKDATER  MVC   GERROR,=Y(WKDTER)                                                
VPERERX  GOTO1 VTRAERR                                                          
         LTORG                                                                  
*                                                                               
*                                                                               
****************************************************************                
* ON ENTRY WORK CONTAINS PERIOD (YYMMDD)                                        
* CONVERT PERIOD TO IN WORK+6:                                                  
* 1ST BYTE = YEAR                                                               
* 2ND BYTE = HOB MONTH AND LOB WEEK NUMBER FOR THAT MONTH                       
* EG. 1/27/20 CONVERT X'7814' YEAR= X'78' MONTH=1 WEEK=4                        
****************************************************************                
CONVPER  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         GOTO1 DATCON,(R1),(0,WORK),(3,WORK+6) YYMMDD TO YMD                    
*                                                                               
* CALC WEEK NUMBER FOR THIS MONTH                                               
         SR    R5,R5               INIT WEEK NUMBER                             
         MVC   DUB(6),WORK         YYMMDD                                       
CONV02   AHI   R5,1                INCR WEEK NUMBER                             
         GOTO1 ADDAY,(R1),DUB,DUB,F'-7'                                         
         CLC   WORK+2(2),DUB+2     SAME MONTH?                                  
         BE    CONV02                                                           
*                                                                               
         SLL   R5,28               WEEK NUMBER IN HOB                           
         LLC   R4,WORK+7                                                        
         SLDL  R4,28               HOB MONTH/LOB WEEK NUMBER                    
         STCM  R4,8,WORK+7         MONTH/WEEK NO (X'C4'= DEC/WEEK 4)            
         XIT1                                                                   
*                                                                               
         DROP  RB,RC                                                            
*                                                                               
         EJECT                                                                  
* VALIDATE OPTIONS                                                              
*                                                                               
* VALID OPTIONS = 'TEST'      OPTTEST  (X80)                                    
*                                       X40                                     
*                 'REV'       OPTREV   (X20) (REVISIONS ONLY)                   
*                 'NEW'       OPTNEW   (X10) (ONLY STA WITH NO INST)            
*                 'UNASSIGN   OPTUNAS  (X08) UNASSIGNED UNITS = TBA             
*                 'PRD=UNAL'  OPTUNAL  (X04) UNALLOCATED UNITS = TBA            
*                                            FOR PROG WITH REVISION             
*                 'NOAGY'     OPTNAGY  (X02) BLANK AGENCY NAME/ADDR             
*                 'NOAOR'     RESET SVTNPR7 -BLANK AGY OF RECORD N&A            
*                 'DATE='     ONLY DO PERIOD FROM DATE TO PERIOD END            
*                                                                               
VOPT     NTR1  BASE=*,LABEL=*                                                   
         L     RC,SVADGEND                                                      
         USING GEND,RC                                                          
*                                                                               
         LHI   RE,VOPTPGRO-SYSD                                                 
         AR    RE,R9                                                            
         LA    RF,ENDPGTBL-VOPTPGRO                                             
         XCEF                                                                   
                                                                                
         XC    QDPT,QDPT           INIT DAYPART FILTER                          
                                                                                
         LA    RE,SVOPTDTA                                                      
         LA    RF,SVOPTLEN                                                      
         SR    R0,R0                                                            
         SR    R1,R1                                                            
         MVCL  RE,R0                                                            
                                                                                
         LA    R2,TRAFAXH                                                       
         CLI   5(R2),0             ANY ENTRY                                    
         BE    VFAX30                                                           
         CLI   8(R2),C'Y'                                                       
         BE    VFAX10                                                           
         CLI   8(R2),C'2'                                                       
         BNE   VFAX20                                                           
         CLI   TRAWRKR,C' '        TEST WORKER FILENUM (OPTICA)                 
         JNH   VFAX10                                                           
         MVI   8(R2),C'Y'          FORCE FAX=Y                                  
*                                                                               
VFAX10   CLI   SVTWPR06,C'Y'       ALREADY SET TO Y                             
         BE    VFAX14                                                           
         CLI   SVTWPR06,C'2'       ALREADY SET TO 2                             
         BE    VFAX14                                                           
         CLI   SVTWPR06,C'N'                                                    
         BNE   VFAX14                                                           
         MVC   GERROR,=Y(NOTWAUTH)                                              
         B     VOPTTRAP                                                         
*                                                                               
VFAX14   MVC   SVTWPR06,8(R2)                                                   
         B     VOPT00                                                           
*                                                                               
VFAX20   CLI   8(R2),C'C'                                                       
         BE    VFAX24                                                           
*                                                                               
         CLI   8(R2),C'N'                                                       
         BE    VFAX26                                                           
         MVC   GERROR,=Y(BADFAX)                                                
         B     VOPTTRAP                                                         
*                                                                               
VFAX24   OI    SVOPTSW1,OPTHDCPY                                                
*                                                                               
VFAX26   MVI   SVTWPR06,C'N'                                                    
         B     VOPT00                                                           
*                                                                               
VFAX30   MVC   BYTE,SVTWPR06                                                    
         CLI   SVTWPR06,C'N'                                                    
         BE    VFAX34                                                           
         CLI   SVTWPR06,C'Y'                                                    
         BE    VFAX34                                                           
         CLI   SVTWPR06,C'2'                                                    
         BE    VFAX34                                                           
         MVI   BYTE,C'N'                                                        
         B     VFAX34                                                           
VFAX34   CLC   8(1,R2),BYTE                                                     
         BE    VOPT00                                                           
         MVC   8(1,R2),BYTE                                                     
VFAX40   OI    6(R2),X'80'         FORCE TRANSMIT                               
         MVI   5(R2),1                                                          
*                                                                               
VOPT00   OI    4(R2),X'20'                                                      
         LA    R2,TRAOPTH                                                       
*                                                                               
         CLI   5(R2),0             ANY ENTRY                                    
         BE    VOPTX                NO                                          
         CLI   8(R2),C'?'          HELP                                         
         BE    VOPTHLP              YES                                         
*                                                                               
         LA    R4,BLOCK+240        ADDRESS OF FIRST BLOCK                       
         GOTO1 SCANNER,DMCB,TRAOPTH,(7,(R4))                                    
         LLC   R3,DMCB+4           GET NUMBER OF BLOCKS                         
         LTR   R3,R3               SEE IF SCANNER FOUND ANYTHING                
         BNZ   VOPT10               YES - GO ON                                 
         MVC   GERROR,=Y(FLD2BIG)                                               
         B     VOPTTRAP                                                         
*                                                                               
VOPT10   LLC   R1,0(R4)            GET LENGTH                                   
         BCTR  R1,0                                                             
*                                                                               
* GET ADDRESS OF OPTION VALIDATION RTN                                          
         LA    RF,OPTTABLE                                                      
         EX    R1,VOPTCLC                                                       
         BE    VOPTGO                                                           
         LA    RF,L'OPTTABLE(RF)                                                
         CLI   0(RF),X'FF'                                                      
         BNE   *-16                                                             
         B     VOPTHLP                                                          
*                                                                               
VOPTCLC  CLC   12(0,R4),0(RF)                                                   
VOPTGO   L     RE,10(RF)                                                        
         A     RE,SPTR1FRR                                                      
         BR    RE                                                               
         EJECT                                                                  
VOPTTEST DS    0H                                                               
         L     R1,ATWA                                                          
         CLI   1(R1),C'*'          DDS TERMINAL                                 
         BE    VOPTEST2                                                         
         LA    R2,TRAFAXH                                                       
         CLI   8(R2),C'N'                                                       
         BNE   TSTFAXER                                                         
         LA    R2,TRAOPTH                                                       
VOPTEST2 OI    SVOPTSW,OPTTEST                                                  
         B     VOPTNXT                                                          
*                                                                               
VOPTSEED CLI   TWAOFFC,C'*'        DDS TERMINALS ?                              
         BE    *+12                                                             
         TM    WHEN,X'90'          TEST OVERNIGHT/DDS                           
         BZ    NOWERR               NO, ERROR                                   
         OI    SVOPTSW,OPTSEED     SEED (FORCE THRU DDS,OV REQUESTS)            
         B     VOPTNXT                                                          
*                                                                               
VOPTREV  TM    SVOPTSW,OPTNEW      NOT WITH NEW                                 
         BNZ   BDKYWDER                                                         
         OI    SVOPTSW,OPTREV                                                   
         B     VOPTNXT                                                          
*                                                                               
VOPTNEW  TM    SVOPTSW,OPTREV      NOT WITH REV                                 
         BNZ   BDKYWDER                                                         
         OI    SVOPTSW,OPTNEW                                                   
         B     VOPTNXT                                                          
*                                                                               
VOPTUNAS OI    SVOPTSW,OPTUNAS                                                  
         B     VOPTNXT                                                          
*                                                                               
VOPTPRDU CLI   1(R4),4                                                          
         BNE   VOPTPRD2                                                         
         CLC   22(4,R4),=CL4'UNAL'                                              
         BNE   VOPTHLP                                                          
         OI    SVOPTSW,OPTUNAL                                                  
         B     VOPTNXT                                                          
*                                                                               
* PAGE BREAK ON PRODUCT                                                         
*                                                                               
VOPTPBRK DS    0H                                                               
         OI    SVOPTSW2,OPTPBRK                                                 
         B     VOPTNXT                                                          
*                                                                               
VOPTNBON OI    SVOPTSW1,OPTNOBON   NOBONUS - DON'T SHOW BONUS                   
         B     VOPTNXT                                                          
*                                                                               
VOPTNADU OI    SVOPTSW1,OPTNOADU   NOADU - DON'T SHOW ADU UNITS                 
         B     VOPTNXT                                                          
*                                                                               
VOPTNAGY OI    SVOPTSW,OPTNAGY     NOAGY - DON'T PRINT AGENCY N/A               
         B     VOPTNXT                                                          
*                                                                               
VOPTDTE  GOTO1 DATVAL,DMCB,(0,22(R4)),WORK    DATE - DO PARTIAL PERIOD          
         OC    DMCB,DMCB                                                        
         BZ    INVDATER                                                         
*                                                                               
         FIXDT02                                                                
         GOTO1 DATCON,(R1),(0,WORK),(2,VOPTDATE)                                
         B     VOPTNXT                                                          
*                                                                               
VOPTNAOR MVI   SVTNPR7,C'Y'        NOAOR - DON'T PRT AGENCY OF REC N/A          
         B     VOPTNXT                                                          
*                                                                               
VOPTSKED MVI   SVTNPR9,C'S'        SKED-ONLY USE TRAFFIC SKEDED UNITS           
         B     VOPTNXT                                                          
*                                                                               
VOPTMED  MVI   SVTNPR9,C'M'        MEDIA-ONLY USE MEDIA UNITS                   
         B     VOPTNXT                                                          
*                                                                               
VOPTBOTH MVI   SVTNPR9,C'B'        BOTH-USE MEDIA & SKED UNITS                  
         B     VOPTNXT                                                          
*                                                                               
VOPTCAL  MVI   MYTN2PR6,C'C'       FORCE CALENDAR OPTION                        
         B     VOPTNXT                                                          
*                                                                               
VOPTBRD  MVI   MYTN2PR6,C'B'       FORCE BROADCAST OPTION                       
         B     VOPTNXT                                                          
*                                                                               
VOPTCHA  MVI   SVTN1PR5,C'C'       CHANGE - CHANGES ONLY                        
         B     VOPTNXT                                                          
*                                                                               
VOPTRCAP MVI   SVTN1PR5,C'R'       RECAP - SHOW ENTIRE INSTRUCTION              
         B     VOPTNXT                                                          
*                                                                               
VOPTCOPY MVI   SVTWPR07,C'Y'       PRINT FAX COPY NOW                           
         B     VOPTNXT                                                          
*                                                                               
VOPTNCPY MVI   SVTWPR07,C'N'       DON'T PRINT FAX COPY NOW                     
         B     VOPTNXT                                                          
*                                                                               
VOPTWEEK MVI   MYTN2PR6,C'W'       FORCE WEEKLY OPTION                          
         B     VOPTNXT                                                          
*                                                                               
*MNV                                                                            
VOPTDIGI OI    SVOPTSW2,OPTDIGI    OVERRIDE SUPPRESS DIGITAL                    
         B     VOPTNXT                                                          
*                                                                               
*MNV                                                                            
VOPTISCI DS    0H                                                               
         CLI   TWAOFFC,C'*'        ONLY DDS TERMINALS                           
         BNE   VOPTHLP                                                          
         B     VOPTNXT                                                          
*                                                                               
VOPTTRAC CLI   OFFLINE,C'Y'        IF OFFLINE, ALLOW IT                         
         BE    *+12                                                             
         CLI   TWAOFFC,C'*'        ONLY DDS TERMINALS                           
         BNE   VOPTHLP                                                          
         OI    SVOPTSW1,OPTRACE    SET TRACE ON                                 
         B     VOPTNXT                                                          
*                                                                               
VOPTEASY CLI   OFFLINE,C'Y'        THIS AGY COPY FOLLOW UP TO EASYLINK          
         BNE   VOPTHLP             MUST BE OFFLINE                              
         OI    SVOPTSW1,OPTHDCPY                                                
         B     VOPTNXT                                                          
*                                                                               
VOPTOVFX CLI   SVXFROV,0           TEST OPTICA VIA XFRCTL                       
         JNE   *+12                                                             
         CLI   OFFLINE,C'Y'        OV-FAX                                       
         BNE   VOPTHLP             MUST BE OFFLINE                              
*VEN     OI    SVOPTSW2,OPTOVFAX                                                
         B     VOPTNXT                                                          
*                                                                               
VOPTPRD2 CLI   SVTN2PRO+00,C'*'     TRAFFIC BY PRODUCT                          
         BNE   VOPTHLP                                                          
         CLC   =C'POL',22(R4)      IS PRD=POL                                   
         BE    INVPRER              YES, ERROR                                  
         CLC   =C'ALL',22(R4)      IS PRD=ALL                                   
         BE    INVPRER              YES, ERROR                                  
         CLI   1(R4),2             MIN 2 CHAR                                   
         BL    PRLENERR                                                         
         CLI   1(R4),3             MAX 3 CHAR                                   
         BH    PRLENERR                                                         
         BE    *+8                                                              
         MVI   24(R4),C' '                                                      
*                                                                               
         XC    FLDH,FLDH                                                        
         XC    FLD,FLD                                                          
         MVI   FLDH+5,3            DATA LEN                                     
         MVC   FLD(3),22(R4)       PROD                                         
         LA    R2,FLDH                                                          
         MVI   ERROPT,C'Y'         RETURN ON ERROR                              
         GOTO1 VALIPRD                                                          
         MVI   ERROPT,0                                                         
*                                                                               
         CLI   ERROR,0             ANY ERRORS                                   
         BNE   INVPRER                                                          
*                                                                               
         MVC   VOPTPROD(3),WORK    PROD                                         
***      MVC   VOPTPRNM,WORK       PROD NAME                                    
         MVC   VOPTPRNM,WORK+5     PROD NAME                                    
         B     VOPTNXT                                                          
*                                                                               
*                                                                               
* DAYPART FILTER                                                                
VOPTDPT  DS    0H                                                               
         XC    FLDH,FLDH                                                        
         XC    FLD,FLD                                                          
         MVC   FLDH+5(1),1(R4)     DATA LEN                                     
         LLC   R1,1(R4)                                                         
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   FLD(0),22(R4)       DAYPART (1 OR 2 CHAR)                        
                                                                                
         LA    R2,FLDH             POINT TO DAYPART                             
         GOTO1 VALIDPT             RETURNS QDPT AS 1 CHAR OR EQUATE             
*                          FOR 2 CHAR DAYPART AND PRINTABLE IN QDPT2            
         OI    SVOPTSW1,OPTDPTSW                                                
         B     VOPTNXT                                                          
*                                                                               
*                                                                               
VOPTPGRP CLI   SVTN2PRO+00,C'A'    TRAFFIC BY PRODUCT GROUP                     
         BL    VOPTHLP              NO                                          
         CLI   SVTN2PRO+00,C'Z'    TRAFFIC BY PRODUCT GROUP                     
         BH    VOPTHLP              NO                                          
*                                                                               
* VALIDATE PRODUCT GROUP *                                                      
VOPT84   BAS   RE,VPGR                                                          
*                                                                               
VOPTNXT  LA    R4,32(,R4)          POINT TO NEXT BLOCK                          
         BCT   R3,VOPT10           FOR NUMBER OF BLOCKS FOUND                   
*                                                                               
VOPTX    DS    0H                                                               
         LA    R2,TRAOPTH                                                       
         CLI   OFFLINE,C'Y'        BYPASS FOR OFFLINE                           
         BE    VOPTX06                                                          
*                                                                               
         TM    SOXSW,SOXOKFLG      IF DDS, AND FACTEST, OKAY TO GO              
         BO    VOPTX06                                                          
*                                                                               
         TM    SOXSW,SOXERFLG      IF RD ONLY/RD ONLY MODE/WRONG ADV            
         BZ    VOPTX06                                                          
*                                                                               
         TM    SVOPTSW,OPTTEST                                                  
         BO    VOPTX06                                                          
*                                                                               
         GOTO1 VSOXERR             FORCE OPTION TEST                            
*                                                                               
*                                                                               
VOPTX06  DS   0H                                                                
*        OI    4(R2),X'20'         SET ON VALIDATED                             
         CLI   SVTN2PRO+00,0       ANY PROD OR PROD GROUP EXPECTED              
         BE    VOPTX20              NO                                          
         CLI   SVTN2PRO+00,C'0'    ANY PROD OR PROD GROUP EXPECTED              
         BE    VOPTX20              NO                                          
         CLI   SVTN2PRO+00,C'*'    EXPECTING PRODUCT                            
         BNE   VOPTX10                                                          
         OC    VOPTPROD,VOPTPROD   ANY PROD ENTERED                             
         BNZ   VOPTX20                                                          
         MVC   GERROR,=Y(PRDREQD)                                               
         B     VOPTTRAP                                                         
*                                                                               
VOPTX10  OC    VOPTPRGR,VOPTPRGR   RUNNING BY PROD GROUP?                       
         BNZ   VOPTX20                                                          
         MVC   GERROR,=Y(PGRPREQD)                                              
         B     VOPTTRAP                                                         
VOPTX20  DS    0H                                                               
         B     VOPTXX                                                           
*                                                                               
VOPTXX   OI    4(R2),X'20'         SET VALIDATED                                
*                                                                               
         XIT1                                                                   
*                                                                               
TSTFAXER XC    CONHEAD,CONHEAD                                                  
         MVC   CONHEAD(32),=CL32'* USE FAX=NO WITH TEST REQUEST *'              
         GOTO1 ERREX2                                                           
         EJECT                                                                  
* VALIDATE PRODUCT GROUP *                                                      
*                                                                               
         DS   0H                                                                
VPGR     NTR1                                                                   
         GOTO1 VALIPGR                                                          
         MVC   VOPTPRGR,SVPGRP     MOVE TO LOCAL STORAGE                        
*                                                                               
* GET PRODUCT GROUP NAME *                                                      
*                                                                               
VPGR20   MVC   SVKEY,KEY           ON RETURN, HAVE 0D81 KEY                     
         NI    KEY+1,X'7F'                                                      
         XC    KEY+8(5),KEY+8                                                   
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R6,AIO1                                                          
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         MVC   SVPRGNAM,2(R6)                                                   
*                                                                               
         MVC   KEY,SVKEY           RESTORE 0D81 KEY                             
*                                                                               
VPGR21   LA   R4,VOPTPGRL                                                       
         LHI  R5,VOPTPGRO-SYSD                                                  
         AR   R5,R9                                                             
*                                                                               
VPGR22   MVC   SVKEY,KEY           SAVE 0D81 KEY                                
*                                                                               
         XC    FLDH,FLDH                                                        
         XC    FLD,FLD                                                          
         MVI   FLDH+5,3            DATA LEN                                     
         MVC   FLD(3),KEY+8        PROD                                         
*                                                                               
         LA    R2,FLDH                                                          
         MVI   ERROPT,C'Y'         RETURN ON ERROR                              
         GOTO1 VALIPRD                                                          
         MVI   ERROPT,0                                                         
*                                                                               
         CLI   ERROR,0             ANY ERRORS                                   
         BE    VPGR26                                                           
*                                                                               
         TM    SECFLAG,BLSSW       BRAND LEVEL SECURITY CLIENT                  
         BO    INVPRER                                                          
         DC    H'0'                BAD PROD IN PGROUP ??                        
*                                                                               
VPGR26   MVC   0(3,R5),WORK        SAVE 3 CHAR PROD IN TABLE                    
         LA    R5,3(R5)                                                         
*                                                                               
         MVC   KEY,SVKEY           RESTORE 0D81 KEY                             
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
VPGR50   DS    0H                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 SEQ                                                              
         CLC   KEY(8),KEYSAVE                                                   
         BNE   VOPTX                                                            
         BCT   R4,VPGR22                                                        
         B     MAXPGER             MORE THAN 150 PRODUCTS                       
*                                                                               
PRLENERR MVC   GERROR,=Y(PRDLENER)                                              
         B     VOPTTRAP                                                         
*                                                                               
MAXPGER  MVC   GERROR,=Y(MAXPGRP)                                               
         LA    R2,TRAOPTH                                                       
         B     VOPTTRAP                                                         
*                                                                               
VOPTHLP  XC    CONHEAD,CONHEAD                                                  
         MVC   CONHEAD(L'OPTHLPMS),OPTHLPMS                                     
         OI    TRAOPTH+6,X'40'     CURSOR                                       
         CLI   SVTN2PRO+00,0       ANY PROD OR PROD GROUP EXPECTED              
         BE    VOPTERX2             NO                                          
         CLI   SVTN2PRO+00,C'0'    ANY PROD OR PROD GROUP EXPECTED              
         BE    VOPTERX2             NO                                          
         MVC   CONHEAD+L'OPTHLPMS-2(7),=C'/PRD= *'                              
*                                                                               
         CLI   SVTN2PRO+00,C'*'    EXPECTING PRODUCT                            
         BE    VOPTERX2                                                         
         MVC   CONHEAD+L'OPTHLPMS-2+2(3),=C'GRP'                                
VOPTERX2 GOTO1 ERREX2                                                           
*                                                                               
NOWERR   MVI   ERROR,INVPRINT                                                   
         LA    R2,CONWHENH                                                      
         B     VOPTERX                                                          
INVPRER  MVI   ERROR,INVPROD                                                    
         TM    SECFLAG,BLSSW       BRAND LEVEL SECURITY CLIENT                  
         BZ    VOPTERX                                                          
         MVI   ERROR,SECLOCK                                                    
         B     VOPTERX                                                          
INVDATER MVI   ERROR,INVDATE                                                    
         B     VOPTERX                                                          
BDKYWDER MVI   ERROR,BADKEYWD      KEY WORDS USED IN BAD COMBINATION            
VOPTTRAP GOTO1 VTRAERR                                                          
VOPTERX  GOTO1 ERREX                                                            
*                                                                               
OPTTABLE DS    0CL14                                                            
         DC    CL10'TEST      ',AL4(VOPTTEST)                                   
         DC    CL10'SEED      ',AL4(VOPTSEED)                                   
         DC    CL10'REV       ',AL4(VOPTREV)                                    
         DC    CL10'NEW       ',AL4(VOPTNEW)                                    
         DC    CL10'UNASGGND  ',AL4(VOPTUNAS)                                   
         DC    CL10'PRD       ',AL4(VOPTPRDU)                                   
         DC    CL10'PBREAK    ',AL4(VOPTPBRK)                                   
         DC    CL10'NOBONUS   ',AL4(VOPTNBON)                                   
         DC    CL10'NOADU     ',AL4(VOPTNADU)                                   
         DC    CL10'NOAGY     ',AL4(VOPTNAGY)                                   
         DC    CL10'NOAOR     ',AL4(VOPTNAOR)                                   
         DC    CL10'HELP      ',AL4(VOPTHLP)                                    
         DC    CL10'SKED      ',AL4(VOPTSKED)                                   
         DC    CL10'MEDIA     ',AL4(VOPTMED)                                    
         DC    CL10'BOTH      ',AL4(VOPTBOTH)                                   
         DC    CL10'CALENDAR  ',AL4(VOPTCAL)                                    
         DC    CL10'DATE      ',AL4(VOPTDTE)                                    
         DC    CL10'PGRP      ',AL4(VOPTPGRP)                                   
         DC    CL10'BROADCAST ',AL4(VOPTBRD)                                    
         DC    CL10'CHANGE    ',AL4(VOPTCHA)                                    
         DC    CL10'RECAP     ',AL4(VOPTRCAP)                                   
         DC    CL10'COPY      ',AL4(VOPTCOPY)                                   
         DC    CL10'NOCOPY    ',AL4(VOPTNCPY)                                   
         DC    CL10'WEEKLY    ',AL4(VOPTWEEK)                                   
         DC    CL10'ISCII     ',AL4(VOPTISCI) PRINT ISCII - DDS ONLY            
         DC    CL10'TRACE     ',AL4(VOPTTRAC)                                   
         DC    CL10'#         ',AL4(VOPTEASY)                                   
         DC    CL10'@         ',AL4(VOPTOVFX)                                   
         DC    CL10'DIGITAL   ',AL4(VOPTDIGI)                                   
         DC    CL10'DPT       ',AL4(VOPTDPT) DAYPART FILTER                     
         DC    X'FF'                                                            
*                                                                               
OPTHLPMS DC    C'OPT=DATE/NOAGY/PRD=UNAL/REV/SEED/TEST/UNA/DPT=*'               
TSMSG    DC    C'* ERROR * INVALID TRAFFIC SUPPLIER ENTERED *'                  
         LTORG                                                                  
         EJECT                                                                  
*============================================================                   
* READ THROUGH UNITS AND BUILD PROGRAM TABLE FOR SELECTS                        
*============================================================                   
                                                                                
BLPRG    NMOD1 0,**+BLP**,R7                                                    
         L     RC,SVADGEND                                                      
         USING GEND,RC                                                          
*                                                                               
         MVI   SVHIREVP,0          INIT HIGH PROG REV NUM                       
         NI    SVFLAG,X'FF'-(SVTSX1+NOMATCH+SVMPRGFX+PQOPNSW)                   
         MVI   SVFLAG1,0                                                        
*                                                                               
         NI    UPDSW,X'FF'-X'40'   SET OFF END OF UNITS SW                      
         L     R5,APRGTBLE                                                      
         USING PRGTABLED,R5                                                     
*                                                                               
         LR    RE,R5                                                            
         L     RF,APRGTBLX                                                      
         SR    RF,RE               GET LENGTH                                   
         SR    R0,R0                                                            
         SR    R1,R1                                                            
         MVCL  RE,R0                                                            
*                                                                               
         SR    R1,R1                                                            
         ST    R1,ASVNEXT                                                       
*                                                                               
         TM    TABLESW,X'40'       BUILDING TABLE 2ND TIME AROUND?              
         BZ    *+10                                                             
         XC    BASEPRG,BASEPRG                                                  
*                                                                               
         MVC   BASEDTS,STDATEP                                                  
*                                                                               
         BRAS  RE,ININETIO         INITIALIZE NETIO                             
*                                                                               
         MVI   NBSEQ,C'Q'          ALWAYS GET UNITS IN PROGRAM SEQ              
*                                                                               
         TM    TABLESW,X'40'       ARE WE BUILDING TABLE 2X AROUND              
         BZ    *+8                                                              
         MVI   NBFUNCT,NBFRDHI      YES, RESTART NETIO                          
*                                                                               
BLPRG10  DS    0H                                                               
         TM    SECFLAG,BLSSW       BRAND LEVEL SECURITY CLIENT                  
         BZ    BLPRG11                                                          
*                                                                               
         CLI   T216FFD+6,C'$'      USER SIGN ON OFFICE LIST                     
         BNE   *+18                                                             
         OI    NBINDS5,NBI5PLST    SET OFFICE LIST FLAG                         
         MVC   NBSECSV,ASECBLK     PASS ADDRESS OF SECURITY BLOCK               
         B     *+12                                                             
         CLI   T216FFD+6,C'*'      USER SIGN ON BY OFFICE                       
         BNE   BLPRG11              NO                                          
*                                                                               
         MVC   NBTRAPSC,T216FFD+7  BRAND LEVEL OFFICE(LIST)                     
*                                                                               
BLPRG11  GOTO1 ANETIO,DMCB,(R3)                                                 
         MVI   NBUSER+13,C'N'      DO NOT SUPPRESS PRE-EMPTS                    
         CLI   NBERROR,NBGOOD                                                   
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         TM    TABLESW,X'40'       ARE WE BUILDING TABLE 2X AROUND              
         BZ    *+12                                                             
         MVI   NBFUNCT,NBFNORM                                                  
         OI    TABLESW,X'20'       MORE THAN ONE TABLE IS BUILT                 
*                                                                               
         CLI   NBMODE,NBREQLST                                                  
         BNE   BLPRG12                                                          
*                                                                               
         OC    PROGRAM,PROGRAM     REQUESTING ALL PROGRAMS                      
         BZ    BLPRG90              YES                                         
         B     BLPRG60                                                          
*                                                                               
BLPRG12  CLI   NBMODE,NBPROCUN                                                  
         BNE   BLPRG10                                                          
         TM    TABLESW,X'40'                                                    
         BZ    BLPRG14                                                          
         CLC   SVPRGNXT,NBACTPRG   IS THIS THE PROG                             
         BNE   BLPRG10                                                          
         NI    TABLESW,X'FF'-X'40' RESET TABLE IS FULL                          
         EJECT                                                                  
BLPRG14  L     R6,NBAIO                                                         
         TM    NBUNITST,X'42'     PREEMPTED OR MISSED                           
         BNZ   BLPRG16            TREAT AS DELETED                              
*                                                                               
         TM    22(R6),X'80'       DELETED UNIT                                  
         BZ    BLPRG18                                                          
*                                                                               
BLPRG16  DS    0H                                                               
         CLI   SVTN1PRB,C'Y'       DO NOT PRINT DELETED UNITS                   
         BE    BLPRG10              YES, BYPASS THIS ONE                        
*                                                                               
         LA    R6,27(R6)                                                        
         MVI   ELCODE,X'21'                                                     
         BRAS  RE,NEXTEL                                                        
         BNE   BLPRG10            IF NOT ASSIGNED BY TRAFFIC, IGNORE            
*                                                                               
         USING NUCMLEL,R6                                                       
*                                                                               
         TM    NUCMLFLG,X'10'     EVER PRINTED ON INSTR                         
         BZ    BLPRG10             NO, BYPASS                                   
         DROP  R6                                                               
*                                                                               
* GET PROGRAM INFO                                                              
*                                                                               
BLPRG18  NI    SVFLAG,X'FF'-(SVTSX1+NOMATCH+SVMPRGFX+PQOPNSW)                   
*NOP     NI    SVFLAG,X'FF'-NOMATCH RESET NO MATCH ON DPT                       
         CLI   SVT3PROF+5,C'Y'     GET DAYPART FROM UNIT?                       
         BNE   BLPRG20C                                                         
         MVC   SVDPC,NBACTDP       SAVE UNIT DAYPART                            
         CLI   QDPT,0              FILTERING ON DAYPART?                        
         BE    BLPRG20C                                                         
         CLC   QDPT,SVDPC          MATCH ON DAYPART FILTER?                     
         BNE   BLPRG54                                                          
         B     BLPRG20C                                                         
*                                                                               
BLPRG20  CLC   SVPRG,NBACTPRG      PROCESSED THIS PROGRAM?                      
         BNE   BLPRG20C            NO, GET PROGRAM RECORD                       
         TM    SVFLAG,NOMATCH      MATCH ON PROGRAM DPT?                        
         BO    BLPRG54             NO, GET NEXT UNIT                            
         CLI   SVT3PROF+5,C'Y'     GET DAYPART FROM UNIT?                       
         BNE   BLPRG21                                                          
         CLI   SVDPC,0             ANY DAYPART?                                 
         BNE   *+14                YES                                          
         MVC   SVDPC,NBACTDP                                                    
         B     BLPRG21                                                          
         CLC   SVDPC,NBACTDP       MUST BE SAME                                 
         BNE   DPTERR                                                           
         CLI   QDPT,0              FILTERING ON DAYPART?                        
         BE    BLPRG21                                                          
         CLC   QDPT,SVDPC          MATCH ON DAYPART FILTER?                     
         BNE   BLPRG54                                                          
         B     BLPRG21                                                          
*                                                                               
BLPRG20C MVC   SVPRG,NBACTPRG                                                   
         NI    SVFLAG,X'FF'-NOMATCH RESET NO MATCH ON DPT                       
         CLI   SVT3PROF+5,C'Y'     GET DAYPART FROM UNIT?                       
         BNE   BLPRG20F                                                         
         CLI   SVDPC,0             ANY DAYPART?                                 
         BNE   *+14                YES                                          
         MVC   SVDPC,NBACTDP                                                    
         B     BLPRG20F                                                         
         CLC   SVDPC,NBACTDP       MUST BE SAME                                 
         BNE   DPTERR                                                           
         CLI   QDPT,0              FILTERING ON DAYPART?                        
         BE    BLPRG20F                                                         
         CLC   QDPT,SVDPC          MATCH ON DAYPART FILTER?                     
         BNE   BLPRG54                                                          
*                                                                               
BLPRG20F BRAS  RE,INITSPT          SWITCH TO SPT                                
*                                                                               
         LA    R4,KEY                                                           
         USING NPGKEY,R4                                                        
         MVC   NPGKTYP,=X'0D20'                                                 
         MVC   NPGKAM,BAGYMD                                                    
         MVC   NPGKNET,NETMKT                                                   
         MVC   NPGKPROG,NBACTPRG                                                
         MVC   NPGKEND,NBACTDAT                                                 
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(11),KEYSAVE                                                  
         BNE   PROGDTER                                                         
*                                                                               
         MVC   SVPGEND,NPGKEND     SAVE PROGRAM END DATE                        
         DROP  R4                                                               
*                                                                               
         CLI   SVT3PROF+5,C'Y'     GET DAYPART FROM UNIT?                       
         BE    BLPRG21                                                          
*                                                                               
         CLI   QDPT,0              FILTERING ON DAYPART?                        
         BE    BLPRG21              NO                                          
*                                                                               
         L     R0,AIO              SAVE AIO ADDRESS                             
         L     R6,AIO3                                                          
         ST    R6,AIO                                                           
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
*                                                                               
         ST    R0,AIO              RESTORE AIO ADDRESS                          
         MVI   SVDPC,0                                                          
*                                                                               
* GET DAYPART IF ANY                                                            
*                                                                               
         MVI   ELCODE,X'93'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+12                                                             
         OI    SVFLAG,NOMATCH      NO DPT ELEM=NO MATCH                         
         B     BLPRG54                                                          
*                                                                               
         USING NPGEL93,R6                                                       
         CLI   NPG2DYP,0           IS THERE A DAYPART                           
         BNE   *+12                                                             
         OI    SVFLAG,NOMATCH      NO DPT=NO MATCH                              
         B     BLPRG54                                                          
*                                                                               
         CLC   QDPT,NPG2DYP        SAME DAYPART?                                
         BE    BLPRG21                                                          
         OI    SVFLAG,NOMATCH      TURN ON NO MATCH                             
         B     BLPRG54              NO, GET NEXT UNIT                           
         DROP  R6                                                               
*                                                                               
BLPRG21  MVC   KEYSAVE,NBKEY                                                    
         GOTO1 DATAMGR,DMCB,(X'08',=C'DMRDHI'),=C'UNTDIR',KEYSAVE,KEY           
         CLC   KEY(20),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R1,AIO2             USE FOR EST/PRD/COPY CODE TABLE              
         ST    R1,NEXTADDR                                                      
         XC    0(256,R1),0(R1)                                                  
         EJECT                                                                  
*                                                                               
         XC    SVCSPROD,SVCSPROD                                                
*                                                                               
         L     R6,NBAIO                                                         
         LA    R6,27(,R6)                                                       
         MVI   ELCODE,X'19'                                                     
*                                                                               
         BRAS  RE,NEXTEL                                                        
         BNE   BLPRG21A                                                         
*                                                                               
         USING NUPDED,R6                                                        
*                                                                               
         TM    NUPDEIND,X'40'      IS IT C/S                                    
         BZ    BLPRG21A                                                         
*                                                                               
         SR    R0,R0                                                            
         LLC   R1,1(R6)                                                         
         D     R0,=F'7'                                                         
         LTR   R0,R1               MUST BE AT LEAST 1 PRODUCT                   
         BP    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LA    R1,NUPDEPR          PT TO 3 CHAR PROD                            
         LA    RF,SVCSPROD         MOVE IN C/S PRODS                            
         B     BLPRG21C                                                         
         DROP  R6                                                               
*                                                                               
BLPRG21A L     R6,NBAIO                                                         
         LA    R6,27(,R6)                                                       
         MVI   ELCODE,X'14'                                                     
*                                                                               
         BRAS  RE,NEXTEL                                                        
         BNE   BLPRG21D                                                         
*                                                                               
         USING NUPRDD,R6                                                        
         SR    R0,R0                                                            
         LLC   R1,1(R6)                                                         
         D     R0,=F'6'                                                         
         LTR   R0,R1                                                            
         BP    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LA    R1,NUPRDPR                                                       
         LA    RF,SVCSPROD         MOVE IN C/S PRODS                            
*                                                                               
BLPRD00  LA    R2,NCLSTSIZ         FIND PROD                                    
         L     RE,ASVNCLST                                                      
*                                                                               
BLPRD10  CLC   0(1,R1),3(RE)                                                    
         BE    BLPRD20                                                          
         LA    RE,4(RE)                                                         
         CLI   0(RE),C' '                                                       
         BNH   *+8                                                              
         BCT   R2,BLPRD10                                                       
*                                                                               
         TM    SECFLAG,BLSSW       BRAND LEVEL SECURITY CLIENT                  
         BZ    *+12                                                             
         MVI   ERROR,SECLOCK       SECURITY LOCK-OUT                            
         B     BLPRG50                                                          
         DC    H'0'                PROD NOT IN TABLE                            
*                                                                               
BLPRD20  MVC   0(3,RF),0(RE)                                                    
         B     *+10                                                             
BLPRG21C MVC   0(3,RF),0(R1)                                                    
         LA    RF,3(,RF)           BUMP IN SVCSPROD                             
         LA    R1,6(,R1)           TO NEXT PROD IN ELEM                         
         CLI   ELCODE,X'19'        NEW 3 CHAR PROD ELEM                         
         BNE   BLPRD30                                                          
         LA    R1,1(R1)            YES, BUMP ONE MORE IN ELEM                   
         BCT   R0,BLPRG21C                                                      
         B     *+8                                                              
BLPRD30  BCT   R0,BLPRD00                                                       
*                                                                               
         CLI   SVCSPROD,0                                                       
         BNE   *+6                                                              
         DC    H'0'                                                             
*                                                                               
BLPRG21D DS    0H                                                               
         LA    RF,NBPR1CL3                                                      
         OC    NBPR1CL3,NBPR1CL3   UNALLOCATED                                  
         BNZ   BLPRG21E                                                         
*                                                                               
         LA    RF,SVCSPROD                                                      
         CLI   SVCSPROD,0                                                       
         BNE   BLPRG21E                                                         
*                                                                               
         TM    SVOPTSW,OPTUNAL     UNALLOCATED UNITS OK                         
         BO    BLPRG21I                                                         
         CLI   SVTNPR3,C'Y'        ALLOW UNALLOCATED UNITS                      
         BNE   NOPRDERR                                                         
         B     BLPRG21I                                                         
*                                                                               
* IF BRAND LEVEL SECURITY CLIENT CHECK OUT PRODS.                               
*                                                                               
BLPRG21E DS    0H                                                               
         TM    SECFLAG,BLSSW       BRAND LEVEL SECURITY CLIENT                  
         BZ    BLPRG21I                                                         
*                                                                               
         CLI   ELCODE,X'19'        NEW PRD ELEMENT                              
         BNE   BLPRG21I            NO, DONE PRD VALIDATION                      
*                                                                               
         LA    R0,6                MAX C/S PROD                                 
         LA    R4,SVCSPROD         PRODS                                        
*                                                                               
BLPRG21F XC    FLDH,FLDH                                                        
         XC    FLD,FLD                                                          
         MVI   FLDH+5,3            DATA LEN                                     
         MVC   FLD(3),0(R4)        PROD                                         
         LA    R2,FLDH                                                          
         MVI   ERROPT,C'Y'         RETURN ON ERROR                              
         GOTO1 VALIPRD                                                          
         MVI   ERROPT,0                                                         
*                                                                               
         CLI   ERROR,0             ANY ERRORS                                   
         BE    BLPRG21G                                                         
*                                                                               
         MVI   ERROR,SECLOCK                                                    
         B     BLPRG50                                                          
*                                                                               
BLPRG21G LA    R4,3(R4)            BUMP TO NET PROD IN SVCSPROD                 
         OC    0(3,R4),0(R4)                                                    
         BZ    *+8                                                              
         BCT   R0,BLPRG21F                                                      
*                                                                               
* CK PRODUCT OR PRODUCT GROUP FILTER *                                          
*                                                                               
BLPRG21I OC    VOPTPROD,VOPTPROD                                                
         BZ    BLPRG21L                                                         
         CLC   NBPR1CL3,VOPTPROD                                                
         BE    BLPRG21L                                                         
*                                                                               
         LA    RE,L'SVCSPROD                                                    
         LA    RF,SVCSPROD                                                      
BLPRG21J CLI   0(RF),0                                                          
         BE    BLPRG50                                                          
         CLC   VOPTPROD,0(RF)                                                   
         BE    BLPRG21L                                                         
         LA    RF,3(,RF)                                                        
         AHI   RE,-2                                                            
         BCT   RE,BLPRG21J                                                      
         B     BLPRG50                                                          
*                                                                               
BLPRG21L OC    VOPTPRGR,VOPTPRGR   ANY PRODUCT GROUP                            
         BZ    *+12                 NO                                          
         BAS   RE,FPG              FILTER ON PRODUCT GROUP                      
         BNE   BLPRG50                                                          
*                                                                               
         BAS   RE,FPRGC            FIND BASE IF EQUIV PROG                      
         BNE   BLPRG50                                                          
*                                                                               
         MVC   PRGENDAT,SVPGEND    PROGRAM END DATE                             
*                                                                               
         CLI   TRAWRKR,C' '        TEST OPTICA                                  
         JNH   BLOPTICX            NO                                           
*                                                                               
         BRAS  RE,OPENWRKF         REPOSITION TO FIRST RECORD                   
*                                                                               
         CLI   SVRUNALL,C'Y'       TEST DOING ALL PROGRAMS                      
         JE    BLOPTICX            YES                                          
                                                                                
*=============================================================                  
* TEST IF PROGRAM CODE IN WORKER FILE TO BE PROCESSED                           
*=============================================================                  
                                                                                
BLOPTIC2 CLC   PRGPRG(6),SVWRKREC+4  MATCH PROGRAM                              
         JE    BLOPTICX                                                         
*                                                                               
         GOTO1 DATAMGR,DMCB,=C'READ',=C'WRKFILE',SVINDEX,SVWRKREC,              
               AWKBUFF                                                          
         CLI   8(R1),0                                                          
         JE    BLOPTIC2            MORE RECORDS - GO COMPARE AGAIN              
         JNE   BLPRG50             NO - DON'T PROCESS                           
*                                                                               
* START PROCESSING UNITS *                                                      
*                                                                               
BLOPTICX L     R6,NBAIO                                                         
*                                                                               
         OC    BASEDTS,BASEDTS                                                  
         BZ    BLPRG22                                                          
         CLC   NBACTDAT,BASESTR                                                 
         BL    BLPRG50                                                          
         CLC   NBACTDAT,BASEEND                                                 
         BH    BLPRG50                                                          
*                                                                               
BLPRG22  CLI   SVTNPR9,C'B'        BOTH MEDIA AND SKED                          
         BE    BLPRG26                                                          
         CLI   SVTNPR9,C'S'        MEDIA ONLY (DEFAULT)                         
         BNE   BLPRG24                                                          
         CLI   NBACTSUB,C'A'       SKED ONLY                                    
         BL    BLPRG50                                                          
         B     BLPRG26                                                          
*                                                                               
BLPRG24  CLI   NBACTSUB,C'A'       BYPASS ANY SKED UNITS                        
         BNL   BLPRG50                                                          
*                                                                               
BLPRG26  DS   0H                                                                
*                                                                               
BLPRG28  TM    NBUNITST,X'42'     PREEMPTED OR MISSED                           
         BNZ   BLPRG30            TREAT AS DELETED                              
         TM    22(R6),X'80'       DELETED UNIT                                  
         BZ    BLPRG40                                                          
*                                                                               
BLPRG30  LA    R6,27(R6)                                                        
         MVI   ELCODE,X'21'                                                     
         BRAS  RE,NEXTEL                                                        
         BNE   BLPRG50            IF NOT ASSIGNED BY TRAFFIC, IGNORE            
*                                                                               
         USING NUCMLEL,R6                                                       
*                                                                               
BLPRG36  TM    NUCMLFLG,X'10'     EVER PRINTED ON INSTR                         
         BZ    BLPRG50             NO, BYPASS                                   
         TM    PRGFLG,PRGFLGPP    INSTR PRINTED FOR THIS REV                    
         BZ    BLPRG38             NO                                           
         TM    NUCMLFLG,X'02'     DELETE PRINTED ON INSTR                       
         BO    BLPRG38             YES                                          
*                                                                               
         NI    PRGFLG,X'FF'-PRGFLGNU     SET OFF NO UNITS FLAG                  
*                                                                               
         OI    PRGFLG,PRGFLGDM    FORCE NEW REVN MISSING/DEL/PREEMPT            
         OI    PRGFLG,PRGFAXCG    SET CHANGED SINCE LAST FAX                    
*                                                                               
BLPRG38  SR    R1,R1                                                            
         ICM   R1,3,PRGDEL                                                      
         LA    R1,1(,R1)                                                        
         STCM  R1,3,PRGDEL                                                      
         B     BLPRG48                                                          
         DROP  R6                                                               
         EJECT                                                                  
BLPRG40  OC    NBPR1CL3,NBPR1CL3   UNALLOCATED                                  
         BNZ   BLPRG42                                                          
         CLI   SVCSPROD,0                                                       
         BNE   BLPRG42                                                          
BLPRG41  DS   0H                                                                
         TM    SVOPTSW,OPTUNAL     UNALLOCATED UNITS OK                         
         BO    BLPRG41C                                                         
         CLI   SVTNPR3,C'Y'        ALLOW UNALLOCATED UNITS                      
         BNE   NOPRDERR                                                         
*                                                                               
BLPRG41C SR    R1,R1                                                            
         ICM   R1,3,PRGUNAL                                                     
         LA    R1,1(,R1)                                                        
         STCM  R1,3,PRGUNAL                                                     
         B     BLPRG48                                                          
*                                                                               
BLPRG42  LA    R6,27(R6)                                                        
         MVI   ELCODE,X'21'                                                     
         BRAS  RE,NEXTEL                                                        
         BNE   BLPRG46                                                          
*                                                                               
         USING NUCMLEL,R6                                                       
         CLI   SVTNPR5,C'Y'       TRAFFIC DELETES ALLOWED                       
         BNE   BLPRG44            NO                                            
         TM    NUCMLFLG,X'08'                                                   
         BZ    BLPRG44                                                          
         CLI   PRGCREVN,0         IF NOT ORIG                                   
         BNE   BLPRG36             GO COUNT AS DELETE                           
         OC    PRGIDTE,PRGIDTE    IF INSTR ORIGINAL                             
         BZ    BLPRG50             IGNORE                                       
         B     BLPRG36                                                          
*                                                                               
BLPRG44  TM    NBUNST3,X'40'       COPY SPLIT                                   
         BZ    BLPRG45                                                          
*                                                                               
         CLC   NUCMPROD,NBPR1CL3                                                
         BE    BLPRG45                                                          
         CLC   NUCMPROD,NBPR2CL3                                                
         BE    BLPRG45                                                          
         LA    R1,NUCMPROD                                                      
*                                                                               
         LA    RE,L'SVCSPROD                                                    
         LA    RF,SVCSPROD                                                      
BLPRG44F CLI   0(RF),0                                                          
         BE    BLPRG41                                                          
         CLC   0(3,R1),0(RF)       IS THIS THE PRODUCT                          
         BE    BLPRG45                                                          
         LA    RF,3(,RF)                                                        
         AHI   RE,-2                                                            
         BCT   RE,BLPRG44F                                                      
         B     BLPRG41             COUNT AS UNALLOCATED                         
*                                                                               
BLPRG45  TM    NUCMLFLG,X'E0'      ANY CHANGES (MADE CML INVALID)               
         BNZ   BLPRG46                                                          
         TM    NUCMLFL2,NUCMLFFD   FEED NO NATIONAL UNIT?                       
         BO    BLPRG48              YES                                         
         OC    NUCML1,NUCML1       CML ASSIGNED                                 
         BZ    BLPRG46                                                          
         TM    NBUNST3,X'40'       COPY SPLIT                                   
         BO    BLPRG48                                                          
         OC    NBPR2CL3,NBPR2CL3                                                
         BZ    BLPRG48                                                          
         OC    NUCML2,NUCML2       CML ASSIGNED                                 
         BNZ   BLPRG48                                                          
BLPRG46  SR    R1,R1                                                            
         ICM   R1,3,PRGUNAS                                                     
         LA    R1,1(,R1)                                                        
         STCM  R1,3,PRGUNAS                                                     
*                                                                               
BLPRG48  SR    R1,R1                                                            
         ICM   R1,3,PRGUNITS                                                    
         LA    R1,1(,R1)                                                        
         STCM  R1,3,PRGUNITS                                                    
*                                                                               
         CLC   PRGCREVN,NUCMLREV   THIS CHANGED THIS REVSION                    
         BNE   *+8                                                              
         NI    PRGFLG,X'FF'-PRGFLGNU     SET OFF NO UNITS FLAG                  
         EJECT                                                                  
* COUNT FEEDS *                                                                 
*                                                                               
         L     R6,NBAIO                                                         
         LA    R6,27(,R6)                                                       
         MVI   ELCODE,X'23'                                                     
BLPRG49  BRAS  RE,NEXTEL                                                        
         BNE   BLPRG50                                                          
         USING NUFDCEL,R6                                                       
         TM    NUFDCFL2,X'80'      DELETED FEED                                 
         BO    BLPRG49              YES                                         
         SR    R1,R1                                                            
         ICM   R1,3,PRGFEEDS                                                    
         LA    R1,1(,R1)                                                        
         STCM  R1,3,PRGFEEDS                                                    
*                                                                               
         CLC   PRGCREVN,NUFDCREV   THIS CHANGED THIS REVSION                    
         BNE   *+8                                                              
         NI    PRGFLG,X'FF'-PRGFLGNU     SET OFF NO UNITS FLAG                  
*                                                                               
         TM    NBUNST3,X'40'       COPY SPLIT                                   
         BZ    BLPRG49                                                          
*                                                                               
         CLC   NUFDPROD,NBPR1CL3                                                
         BE    BLPRG49                                                          
         CLC   NUFDPROD,NBPR2CL3                                                
         BE    BLPRG49                                                          
*                                                                               
         LA    R1,NUFDPROD                                                      
*                                                                               
         LA    RE,L'SVCSPROD                                                    
         LA    RF,SVCSPROD                                                      
BLPRG49E CLI   0(RF),0                                                          
         BE    BLPRG49F                                                         
         CLC   0(3,R1),0(RF)                                                    
         BE    BLPRG49                                                          
         LA    RF,3(,RF)                                                        
         AHI   RE,-2                                                            
         BCT   RE,BLPRG49E                                                      
*                                                                               
BLPRG49F DS   0H                                                                
         TM    SVOPTSW,OPTUNAL     UNALLOCATED UNITS OK                         
         BO    BLPRG49H                                                         
         CLI   SVTNPR3,C'Y'        ALLOW UNALLOCATED UNITS                      
         BNE   NOPRDERR                                                         
*                                                                               
BLPRG49H SR    R1,R1                                                            
         ICM   R1,3,PRGUNAL                                                     
         LA    R1,1(,R1)                                                        
         STCM  R1,3,PRGUNAL                                                     
         B     BLPRG49                                                          
         DROP  R6                                                               
BLPRG50  TM    TABLESW,X'20'                                                    
         BZ    *+8                                                              
         MVI   NBFUNCT,NBFRDHI      YES, RESTART NETIO                          
*                                                                               
BLPRG52  DS    0H                                                               
         TM    SECFLAG,BLSSW       BRAND LEVEL SECURITY CLIENT                  
         BZ    BLPRG54                                                          
*                                                                               
         CLI   T216FFD+6,C'$'      USER SIGN ON OFFICE LIST                     
         BNE   *+18                                                             
         OI    NBINDS5,NBI5PLST    SET OFFICE LIST FLAG                         
         MVC   NBSECSV,ASECBLK     PASS ADDRESS OF SECURITY BLOCK               
         B     *+12                                                             
         CLI   T216FFD+6,C'*'      USER SIGN ON BY OFFICE                       
         BNE   BLPRG54              NO                                          
*                                                                               
         MVC   NBTRAPSC,T216FFD+7  BRAND LEVEL OFFICE(LIST)                     
*                                                                               
BLPRG54  GOTO1 ANETIO,DMCB,(R3)                                                 
         MVI   NBUSER+13,C'N'      DO NOT SUPPRESS PRE-EMPTS                    
         CLI   NBERROR,NBGOOD                                                   
         BE    *+6                                                              
         DC    H'0'                                                             
         TM    TABLESW,X'20'                                                    
         BZ    *+8                                                              
         MVI   NBFUNCT,NBFNORM                                                  
*                                                                               
         CLI   NBMODE,NBREQLST                                                  
         BE    BLPRG60                                                          
         CLI   NBMODE,NBPROCUN                                                  
         BNE   BLPRG52                                                          
*                                                                               
         L     R6,NBAIO                                                         
*                                                                               
         TM    NBSUBMSK,NBSBMCLI+NBSBMNET                                       
         BNZ   BLPRG60                                                          
         TM    NBSUBMSK,NBSBMPRG                                                
         BNZ   BLPRG57                                                          
*                                                                               
         TM    NBUNITST,X'42'     PREEMPTED OR MISSED                           
         BNZ   BLPRG56            TREAT AS DELETED                              
*                                                                               
         TM    22(R6),X'80'       DELETED UNIT                                  
         BZ    BLPRG20                                                          
*                                                                               
BLPRG56  DS    0H                                                               
         CLI   SVTN1PRB,C'Y'       DO NOT PRINT DELETED UNITS                   
         BE    BLPRG52              YES, BYPASS THIS ONE                        
*                                                                               
         LA    R6,27(R6)                                                        
         MVI   ELCODE,X'21'                                                     
         BRAS  RE,NEXTEL                                                        
         BNE   BLPRG52            IF NOT ASSIGNED BY TRAFFIC, IGNORE            
*                                                                               
         USING NUCMLEL,R6                                                       
*                                                                               
         TM    NUCMLFLG,X'10'     EVER PRINTED ON INSTR                         
         BZ    BLPRG52             NO, BYPASS                                   
         B     BLPRG20                                                          
*                                                                               
         DROP  R6                                                               
*                                                                               
BLPRG57  OC    PROGRAM,PROGRAM     WAS PROGRAM = ALL                            
         BZ    BLPRG64                                                          
*                                                                               
BLPRG60  OC    PROGRAM,PROGRAM     WAS PROGRAM = ALL                            
         BZ    BLPRG62                                                          
*                                                                               
         BAS   RE,NXTEQV             GET NEXT EQV PROGRAM IF ANY                
         BNE   BLPRG20                                                          
*                                                                               
BLPRG62  OI    UPDSW,X'40'         END OF UNITS SWITCH                          
*                                                                               
BLPRG64  OC    PRGUNITS,PRGUNITS   ANY UNITS FOUND?                             
         BZ    BLPRG86                                                          
         EJECT                                                                  
         CLI   OFFLINE,C'Y'                                                     
         BNE   BLPRG70                                                          
*                                                                               
         TM    PRGFLG,PRGFLGNU     IS NO UNITS TO PRINT FLAG ON                 
         BO    NOUNTPRT                                                         
*                                                                               
         TM    SVOPTSW,OPTUNAS     UNASSIGNED UNITS OK                          
         BO    BLPRG66              YES                                         
         CLI   SVTNPR14,C'Y'       DEFAULT TO UNASSIGNED OK?                    
         BE    BLPRG66                                                          
*                                                                               
         CLC   PRGUNITS,PRGUNAS    ALL UNASSIGNED                               
         BNE   BLPRG66             NO                                           
*                                                                               
         OC    PRGDEL,PRGDEL       ANY DELETED UNITS                            
         BNZ   BLPRG80              PRINT IT                                    
         B     PNOASIGN                                                         
*                                                                               
BLPRG66  CLC   PRGUNITS,PRGUNAL    ALL UNALLOCATED                              
         BE    PUNALOC                                                          
         TM    SVOPTSW,OPTUNAL     UNALLOCATED UNITS OK                         
         BO    BLPRG68                                                          
         CLI   SVTNPR3,C'Y'        ALLOW UNALLOCATED UNITS                      
         BE    BLPRG68                                                          
         OC    PRGUNAL,PRGUNAL     ANY UNALLOCATED UNITS                        
         BNZ   PUNALOC                                                          
*                                                                               
BLPRG68  TM    SVOPTSW,OPTUNAS     ALLOW UNASSIGNED                             
         BO    BLPRG80              YES                                         
         CLI   SVTNPR14,C'Y'       DEFAULT TO UNASSIGNED OK?                    
         BE    BLPRG80                                                          
         OC    PRGUNAS,PRGUNAS     ANY UNASSIGNED UNITS                         
         BNZ   PUNASIGN                                                         
         B     BLPRG80                                                          
*                                                                               
* THIS IS FOR OVERNITE INSTRUCTIONS, SEE IF ANY ERRORS *                        
* IF AT LEAST 1 GOOD PROGRAM, SUBMIT REQUEST           *                        
*                                                                               
BLPRG70  TM    WHEN,X'40'          IF NOW, GO AHEAD                             
         BO    BLPRG80              YES                                         
*                                                                               
         TM    SVOPTSW,OPTUNAL     UNALLOCATED UNITS OK                         
         BO    BLPRG74                                                          
         CLI   SVTNPR3,C'Y'        ALLOW UNALLOCATED UNITS                      
         BE    BLPRG74                                                          
         CLC   PRGUNITS,PRGUNAS    ALL UNASSIGNED                               
         BE    BLPRG86              YES                                         
*                                                                               
BLPRG74  TM    SVOPTSW,OPTUNAL     UNALLOCATED UNITS OK                         
         BO    BLPRG76                                                          
         CLI   SVTNPR3,C'Y'        ALLOW UNALLOCATED UNITS                      
         BE    BLPRG76                                                          
         OC    PRGUNAL,PRGUNAL     ANY UNALLOCATED UNITS                        
         BNZ   BLPRG86                                                          
*                                                                               
BLPRG76  TM    SVOPTSW,OPTUNAS     ALLOW UNASSIGNED                             
         BO    BLPRG78             YES                                          
         CLI   SVTNPR14,C'Y'       DEFAULT TO UNASSIGNED OK?                    
         BE    BLPRG78                                                          
         OC    PRGUNAS,PRGUNAS     ANY UNASSIGNED UNITS                         
         BNZ   BLPRG86                                                          
BLPRG78  B     BLPRG95             ONLY NEED 1 PROG FOR OFFLINE                 
         EJECT                                                                  
* CHECK FOR NEW/REV ONLY OR ALL *                                               
*                                                                               
BLPRG80  TM    SVOPTSW,OPTNEW                                                   
         BZ    *+14                                                             
         OC    PRGCREVN(4),PRGCREVN THIS ORIGINAL                               
         BZ    BLPRG86               NO, BYPASS                                 
*                                                                               
         TM    SVOPTSW,OPTREV                                                   
         BZ    *+12                                                             
         CLI   PRGCREVN,0          THIS ORIGINAL                                
         BE    BLPRG86             YES, BYPASS                                  
*                                                                               
         CLI   OFFLINE,C'Y'        IF OFFLINE TABLE BUILD                       
         BE    BLPRG84                                                          
         TM    WHEN,X'40'          IF NOW, ALSO BUILD TABLE                     
         BZ    BLPRG86              IF ONLINE VALIDATE, NO TABLE                
*                                                                               
BLPRG84  CLC   PRGPRG,NBACTPRG     FOR EQV PROG, CK IF THERE                    
         BE    BLPRG88                                                          
*                                                                               
         LA    R5,PRGNEXT                                                       
         OC    PRGPRG,PRGPRG       EMPTY ENTRY                                  
         BZ    *+16                                                             
         TM    PRGFLG,PRGXCLUD     EXCLUDE THIS PROG?                           
         BZ    BLPRG84                                                          
         B     *-22                 YES, GET NEXT PROG                          
*                                                                               
         C     R5,APRGTBLX           AT END OF TABLE                            
         BL    BLPRG86                                                          
         CLI   SVXFROV,0           TEST XFRCTL FROM NET/NAV                     
         JNE   *+2                 YES - DIE!                                   
         OI    TABLESW,X'40'       TABLE IS FULL                                
         OI    TABLESW,X'80'       DO A DISPLAY                                 
         MVC   SVPRGNXT,NBACTPRG   SAVE START AT PROGRAM                        
         B     BLPRG90                                                          
*                                                                               
BLPRG86  XC    PRGENT(L'PRGENT+2),PRGENT                                        
*                                                                               
BLPRG88  TM    UPDSW,X'40'         END OF UNITS                                 
         BZ    BLPRG14                                                          
*                                                                               
BLPRG90  C     R5,APRGTBLE         ANY PROGRAMS FOUND                           
         BH    BLPRG91                                                          
         OC    PRGPRG,PRGPRG       WAS AT LEAST 1 FOUND?                        
         BZ    BLPRG96              NO                                          
*                                                                               
BLPRG91  L     R5,APRGTBLE                                                      
*                                                                               
         SR    R4,R4                                                            
BLPRG92  OC    PRGPRG,PRGPRG       AT END OF TABLE                              
         BZ    BLPRG94                                                          
         BCTR  R4,0                                                             
*                                                                               
         TM    PRGFLG,PRGXCLUD     EXCLUDE THIS PROGRAM                         
         BO    BLPRG93N             YES, GET NEXT                               
*                                                                               
         CLI   SVTWPR06,C'N'       ANY FAX                                      
         BE    BLPRG93N             NO                                          
         TM    SVOPTSW1,OPTHDCPY   TEST OPTION AGENCY COPY                      
         BO    BLPRG93N             YES                                         
*                                                                               
* READ PROGRAM RECORD FOR POSSIBLE NON-STD FAX # *                              
*                                                                               
         BRAS  RE,INITSPT          SWITCH TO SPT                                
*                                                                               
         XC    KEYSAVE,KEYSAVE                                                  
         LA    R1,KEY                                                           
         USING NPGKEY,R1                                                        
         MVC   NPGKTYP,=X'0D20'                                                 
         MVC   NPGKAM,BAGYMD                                                    
         MVC   NPGKNET,NETMKT                                                   
         MVC   NPGKPROG,PRGPRG                                                  
         MVC   NPGKEND,STDATEP                                                  
*                                                                               
         MVC   SVPRGPRG,PRGPRG                                                  
         DROP  R1                                                               
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(11),KEYSAVE                                                  
         BNE   PROGDTR                                                          
*                                                                               
         L     R0,AIO              SAVE CALLING                                 
         L     R6,AIO1                                                          
         ST    R6,AIO                                                           
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
*                                                                               
         ST    R0,AIO              RESTORE CALLING                              
*                                                                               
         CLI   SVT3PROF+5,C'Y'     DAYPART FROM UNIT?                           
         BE    BLPRG93             YES, DONE                                    
*                                                                               
         MVI   SVDPC,0                                                          
*                                                                               
* GET DAYPART IF ANY                                                            
*                                                                               
         MVI   ELCODE,X'93'                                                     
         BRAS  RE,GETEL                                                         
         BNE   BLPRG93                                                          
         USING NPGEL93,R6                                                       
         CLI   NPG2DYP,0           IS THERE A DAYPART                           
         BZ    BLPRG93              NO                                          
         MVC   SVDPC,NPG2DYP       SAVE DAYPART                                 
         MVC   PRGDPT,NPG2DYP      SAVE DAYPART IN PROGRAM TABLE                
         DROP  R6                                                               
*                                                                               
BLPRG93  BRAS  RE,FDPCFAX                                                       
         BE    BLPRG93F                                                         
*                                                                               
BLPRG93D L     R6,AIO1                                                          
         MVI   ELCODE,03                                                        
         LA    R6,24(R6)                                                        
         BRAS  RE,FIRSTEL                                                       
         BNE   BLPRG93N                                                         
         USING NPGEL03,R6                                                       
         OC    NPGTRFAX,NPGTRFAX                                                
         BZ    BLPRG93N                                                         
*                                                                               
         MVI   WORK,13             TOTAL ENTRY LENGTH                           
         MVI   WORK+1,12                                                        
         MVC   WORK+2(12),NPGTRFAX                                              
         LA    R6,WORK                                                          
         CLI   SVDPCTBL,0                                                       
         BE    BLPRG93J                                                         
         DROP  R6                                                               
*                                                                               
* (SVDPCTBD = 1 BYTE TOTAL LENGTH/1 BYTE ENTRY LENGTH/12 OR 24 FAX)             
*                                                                               
BLPRG93F LA    R6,SVDPCTBD         FAX FROM DAYPART RECORD                      
*                                                                               
BLPRG93J LA    R1,1                                                             
         LA    RE,SVFAXTBL                                                      
         LLC   R2,0(R6)            TOTAL TABLE LEN                              
         BCTR  R2,0                                                             
*                                                                               
BLPRG93K OC    0(13,RE),0(RE)      EMPTY ENTRY                                  
         BZ    BLPRG93L             YES                                         
         CLC   0(1,RE),0(R6)       COMPARE LEN OF THE ENTRIES                   
         BNE   *+12                                                             
         EX    R2,CLCFAX           R2=LENGTH OF AN ENTRY-1                      
         BE    BLPRG93M             SAVE THIS NUMBER ENTRY ONLY                 
         LA    R1,1(,R1)                                                        
*                                                                               
         LLC   RF,0(RE)            GET LENGTH OF AN ENTRY                       
         LA    RE,1(RF,RE)                                                      
         LA    R0,SVFAXEND                                                      
         CR    R0,RE                                                            
         BH    BLPRG93K                                                         
         DC    H'0'                SVFAXTBL WAS EXCEEDED                        
BLPRG93L LA    R2,1(R2)            ENTRY LENGTH +1 = TOTAL LEN                  
         EX    R2,MVCFAXT          SAVE FAX IN TABLE                            
*                                                                               
         LLC   RF,0(RE)            GET LENGTH OF AN ENTRY                       
         LA    RE,1(RF,RE)                                                      
         LA    R0,SVFAXEND                                                      
         CR    R0,RE               CHECK FOR TABLE OVERFLOW                     
         BNL   *+6                                                              
         DC    H'0'                SVFAXTBL WAS EXCEEDED                        
*                                                                               
BLPRG93M STC   R1,PRGFAX                                                        
*                                                                               
BLPRG93N LA    R5,PRGNEXT                                                       
         C     R5,APRGTBLX         AT END OF TABLE                              
         BNL   BLPRG94              YES                                         
         TM    PRGFLG,PRGXCLUD     EXCLUDE THIS PROG?                           
         BO    BLPRG93N             YES, GET NEXT                               
         B     BLPRG92                                                          
*                                                                               
BLPRG94  LPR   R4,R4                                                            
         L     R5,APRGTBLE                                                      
         GOTO1 QSORT,DMCB,(R5),(R4),L'PRGENT,L'PRGPRG+1,0                       
BLPRG95  CR    RB,RB                                                            
BLPRGX   XIT1                                                                   
*                                                                               
MVCFAXT  MVC   0(0,RE),0(R6)                                                    
CLCFAX   CLC   1(0,RE),1(R6)                                                    
*                                                                               
BLPRG96  DS   0H                                                                
         CLI   OFFLINE,C'Y'        IF OFFLINE CONTINUE CHECK                    
         BE    BLPRG98                                                          
*                                                                               
         TM    SECFLAG,BLSSW       BRAND LEVEL SECURITY CLIENT                  
         BO    BLPRG98             IS THAT RIGHT???                             
*                                                                               
         TM    SVOPTSW,OPTSEED                                                  
         BO    BLPRG95                                                          
*                                                                               
BLPRG98  CR    RB,RC                                                            
         B     BLPRGX              SET UP TEST AND EXIT HERE                    
*                                                                               
NOPRDERR MVC   GERROR,=Y(UNALPRD)                                               
*                                                                               
         CLI   ERRFILSW,0          WAS ERROR FILE OPENED                        
         BE    TRAPER2             NO                                           
         CLI   ERRFILSW,1          BUG CATCHER                                  
         BE    *+6                                                              
         DC    H'0'                                                             
         BRAS  RE,PER               PRINT ERROR REPORT                          
TRAPER2  GOTO1 VTRAERR                                                          
         EJECT                                                                  
* FILTER ON PRODUCT GROUP *                                                     
*                                                                               
FPG      NTR1                                                                   
         LA    R0,VOPTPGRL                                                      
         LHI   R1,VOPTPGRO-SYSD                                                 
         AR    R1,R9                                                            
FPG10    CLC   NBPR1CL3,0(R1)                                                   
         BE    FPGEQ                                                            
         OC    NBPR1CL3,NBPR1CL3                                                
         BNZ   FPG30                                                            
*                                                                               
         LA    RE,L'SVCSPROD                                                    
         LA    RF,SVCSPROD                                                      
FPG20    CLI   0(RF),0                                                          
         BE    FPG30                                                            
         CLC   0(3,R1),0(RF)                                                    
         BE    FPGEQ                                                            
         LA    RF,3(,RF)                                                        
         AHI   RE,-2                                                            
         BCT   RE,FPG20                                                         
*                                                                               
FPG30    LA    R1,3(,R1)                                                        
         CLI   0(R1),0                                                          
         BNH   *+8                                                              
         BCT   R0,FPG10                                                         
         CR    RD,RB                                                            
         B     FPGX                                                             
FPGEQ    CR    RB,RB                                                            
FPGX     XIT1                                                                   
*                                                                               
* GENERATE COMML INSTR ERROR REPORT *                                           
*                                                                               
PUNASIGN MVI   BYTE,1             SOME UNASSIGNED UNITS                         
         B     BLPRG100                                                         
PUNALOC  MVI   BYTE,2             SOME UNALLOCATED UNITS                        
         B     BLPRG100                                                         
PNOASIGN MVI   BYTE,3             ALL UNITS UNASSIGNED                          
         B     BLPRG100                                                         
NOUNTPRT MVI   BYTE,5             NO UNITS TO PRINT - TN1 PROFILE 5             
         B     BLPRG100                                                         
NOOVFAX  MVI   BYTE,7             NO OV FAX # FOUND                             
*                                                                               
BLPRG100 CLI   OFFLINE,C'Y'                                                     
         BE    *+16                                                             
         CLI   BYTE,7                                                           
         BNE   BLPRG86                                                          
         B     BLPRG93N                                                         
*                                                                               
         MVC   ELEM,SPACES                                                      
         LA    R2,ELEM                                                          
         USING XRECD,R2                                                         
         MVC   XBAGYMD,BAGYMD                                                   
         MVC   XCLT,QCLT                                                        
         MVC   XNET,NETWORK                                                     
         MVC   XNETMKT,NETMKT                                                   
         MVC   XPROG,PRGPRG                                                     
         MVC   XTUNT,PRGUNITS                                                   
         MVC   XUNAS,PRGUNAS                                                    
         MVC   XUNAL,PRGUNAL                                                    
         MVC   XPERST,STDATEP                                                   
         MVC   XPERND,ENDATEP                                                   
         MVC   XTYPE,BYTE                                                       
*                                                                               
         CLI   SVTWPR06,C'N'       IF NOT FAXING, PRINT ANY ERRORS              
         BE    BLPRG110                                                         
         TM    WHEN,X'20'                                                       
         BZ    BLPRG110                                                         
         CLI   BYTE,7                                                           
         BE    BLPRG93N                                                         
         B     BLPRG86             DON'T PUT FOR SOON                           
*                                                                               
BLPRG110 L     R1,AERRFILE                                                      
         LR    R0,R2                                                            
         PUT   (1),(0)                                                          
*                                                                               
         CLI   BYTE,7              NO OV FAX # FOUND                            
         BE    BLPRG93N             YES                                         
*                                                                               
         B     BLPRG86                                                          
         EJECT                                                                  
* GET BASE PROGRAM CODE FOR EQUIVALENT PROGRAM CODE *                           
*                                                                               
         DS   0H                                                                
         USING PRGTABLED,R5                                                     
FPRGC    NTR1                                                                   
*                                                                               
         MVC   BASEPRG,NBACTPRG                                                 
         XC    BASEDTS,BASEDTS                                                  
*                                                                               
         LHI   R2,EQVPTBL-SYSD                                                  
         AR    R2,R9                                                            
         LA    R4,L'EQVPTBL/(EQVNEXT-EQVENT)                                    
         USING EQVPTBLD,R2                                                      
         SR    R6,R6                                                            
FPRGC10  OC    EQVEPRG,EQVEPRG     END OF ENTRIES                               
         BZ    FPRGC26              YES                                         
*                                                                               
         CLC   NBACTPRG,EQVEPRG    THIS AN EQUIV PROG                           
         BNE   FPRGC14                                                          
*                                                                               
         BCTR  R6,0                SET PROGRAM FOUND                            
*                                                                               
         CLC   NBACTDAT,EQVSDT     WITHIN DATES                                 
         BL    FPRGC14                                                          
         CLC   NBACTDAT,EQVEDT                                                  
         BNH   FPRGC20                                                          
*                                                                               
FPRGC14  LA    R2,EQVNEXT                                                       
         BCT   R4,FPRGC10                                                       
         B     FPRGC26             ERROR, EQV PROG CODE NOT COVERED             
*                                                                               
FPRGC20  MVC   BASEPRG,EQVBPRG     SET FOR USE                                  
         MVC   BASEDTS,EQVDTS                                                   
         MVI   EQVUSED,C'Y'                                                     
         SR    R6,R6               SET PROG CODE EQV, BUT COVERED               
*                                                                               
FPRGC26  CLC   PRGPRG,BASEPRG                                                   
         BE    FPRGC50                                                          
*                                                                               
         L     R5,APRGTBLE                                                      
*PRGC30  OC    PRGENT,PRGENT       END OF ENTRIES                               
FPRGC30  OC    PRGPRG,PRGPRG       END OF ENTRIES                               
         BZ    FPRGC40              YES                                         
         TM    PRGFLG,PRGXCLUD     EXCLUDE THIS PROGRAM ?                       
         BO    *+14                 YES, GO GET NEXT                            
         CLC   PRGPRG,BASEPRG                                                   
         BE    FPRGC50                                                          
*                                                                               
         LA    R5,PRGNEXT                                                       
         C     R5,APRGTBLX                                                      
         BL    FPRGC30                                                          
         DC    H'0'                                                             
*                                                                               
FPRGC40  MVC   PRGPRG,BASEPRG                                                   
*                                                                               
         CLI   SVTN1PR5,C'C'       PRINT CHANGES ONLY                           
         BNE   *+8                  PRINT IT ALL                                
         OI    PRGFLG,PRGFLGNU     SET ON NO UNITS FLAG                         
*                                                                               
FPRGC50  LTR   R6,R6               EQV CODE NOT COVERED                         
         BNZ   FPRGC60              YES                                         
*                                                                               
         OC    PRGCREVD,PRGCREVD   GOT REVISION INFO YET                        
         BNZ   FPRGC54                                                          
*                                                                               
         BRAS  RE,FREV             GET REVISION INFO                            
*                                                                               
FPRGC54  CR    RB,RB                                                            
*                                                                               
FPRGCX   XIT1  REGS=(R5)                                                        
         EJECT                                                                  
FPRGC60  OI    PRGFLG,PRGFLGEQ     SET EQV PROG CODE ERROR                      
         CLI   OFFLINE,C'Y'                                                     
         BNE   FPRGCX                                                           
*                                                                               
         MVC   ELEM,SPACES                                                      
         LA    R2,ELEM                                                          
         USING XRECD,R2                                                         
         MVC   XBAGYMD,BAGYMD                                                   
         MVC   XCLT,QCLT                                                        
         MVC   XNET,NETWORK                                                     
         MVC   XNETMKT,NETMKT                                                   
         MVC   XPROG,PRGPRG                                                     
         MVC   XTUNT,PRGUNITS                                                   
         MVC   XUNAS,PRGUNAS                                                    
         MVC   XUNAL,PRGUNAL                                                    
         MVC   XPERST,STDATEP                                                   
         MVC   XPERND,ENDATEP                                                   
         MVI   XTYPE,4                                                          
*                                                                               
         CLI   SVTWPR06,C'N'       IF NOT FAXING, PRINT ANY ERRORS              
         BE    *+12                                                             
         TM    WHEN,X'20'                                                       
         BO    FPRGCX              DON'T PUT FOR SOON                           
*                                                                               
         L     R1,AERRFILE                                                      
         LR    R0,R2                                                            
         PUT   (1),(0)                                                          
         LTR   RB,RB               SET NE CC FOR RETURN                         
         B     FPRGCX                                                           
         DROP  R2,R5                                                            
         EJECT                                                                  
* GET BASE PROGRAM CODE FOR EQUIVALENT PROGRAM CODE *                           
*                                                                               
NXTEQV   NTR1                                                                   
*                                                                               
         MVC   BASEPRG,NBACTPRG                                                 
         XC    BASEDTS,BASEDTS                                                  
*                                                                               
         LHI   R2,EQVPTBL-SYSD                                                  
         AR    R2,R9                                                            
         LA    R4,L'EQVPTBL/(EQVNEXT-EQVENT)                                    
         SR    R5,R5                                                            
*                                                                               
         USING EQVPTBLD,R2                                                      
NXTEQV10 OC    EQVEPRG,EQVEPRG     END OF ENTRIES                               
         BZ    NXTEQVX              YES                                         
         CLI   EQVUSED,C'Y'                                                     
         BNE   NXTEQV20                                                         
*                                                                               
         LA    R2,EQVNEXT                                                       
         BCT   R4,NXTEQV10                                                      
         B     NXTEQVX                                                          
*                                                                               
NXTEQV20 MVC   BASEPRG,EQVEPRG     SET FOR USE                                  
*                                                                               
         MVC   BASEDTS,EQVDTS                                                   
*                                                                               
         CLC   BASEEND,ENDATEP     IS END DATE PAST PERIOD END                  
         BNH   *+10                                                             
         MVC   BASEEND,ENDATEP     CUTAIL END DATE                              
*                                                                               
         MVI   EQVUSED,C'Y'                                                     
*                                                                               
         BRAS  RE,ININETIO         INITIALIZE NETIO                             
*                                                                               
         MVI   NBSEQ,C'Q'          ALWAYS GET UNITS IN PROGRAM SEQ              
*                                                                               
NXTEQV30 DS    0H                                                               
         TM    SECFLAG,BLSSW       BRAND LEVEL SECURITY CLIENT                  
         BZ    NXTEQV40                                                         
*                                                                               
         CLI   T216FFD+6,C'$'      USER SIGN ON OFFICE LIST                     
         BNE   *+18                                                             
         OI    NBINDS5,NBI5PLST    SET OFFICE LIST FLAG                         
         MVC   NBSECSV,ASECBLK     PASS ADDRESS OF SECURITY BLOCK               
         B     *+12                                                             
         CLI   T216FFD+6,C'*'      USER SIGN ON BY OFFICE                       
         BNE   NXTEQV40             NO                                          
*                                                                               
         MVC   NBTRAPSC,T216FFD+7  BRAND LEVEL OFFICE(LIST)                     
*                                                                               
NXTEQV40 GOTO1 ANETIO,DMCB,(R3)                                                 
         MVI   NBUSER+13,C'N'      DO NOT SUPPRESS PRE-EMPTS                    
         CLI   NBERROR,NBGOOD                                                   
         BE    *+6                                                              
         DC    H'0'                                                             
         CLI   NBMODE,NBREQLST                                                  
         BE    NXTEQV10                                                         
         CLI   NBMODE,NBPROCUN                                                  
         BNE   NXTEQV30                                                         
*                                                                               
         BCTR  R5,0                                                             
*                                                                               
NXTEQVX  LTR   R5,R5                                                            
         B     BLPRGX                                                           
         DROP  R2                                                               
         EJECT                                                                  
         USING PRGTABLED,R5                                                     
PROGDTR  MVC   NBACTPRG,PRGPRG                                                  
         DROP  R5                                                               
PROGDTER MVC   GERROR,=Y(NOPGM4DT)                                              
         XC    ELEM,ELEM                                                        
         LA    R2,TRAPRGH                                                       
         LA    R4,ELEM                                                          
         STCM  R4,7,GASUBST        A(SUBST TEXT)                                
         MVI   0(R4),7             L'SUBST TEXT + 1                             
         MVC   1(6,R4),NBACTPRG                                                 
         MVI   7(R4),9             L'SUBST TEXT + 1                             
         FIXDT02                                                                
         GOTO1 DATCON,DMCB,(2,KEYSAVE+11),(8,8(R4))                             
         B     BLPRGERX                                                         
*                                                                               
DPTERR   MVC   GERROR,=Y(DPTMSMCH) DAYPART MISMATCH                             
*                                                                               
BLPRGERX BRAS  RE,PER              PRINT ERROR REPORT                           
*                                                                               
BLPRGERZ GOTO1 VTRAERR                                                          
*                                                                               
PRGSIZER MVC   GERROR,=Y(MANYPGM)                                               
         XC    ELEM,ELEM                                                        
         LA    R1,ELEM                                                          
         STCM  R1,7,GASUBST        A(SUBST TEXT)                                
         MVI   ELEM,3              L'SUBST TEXT + 1                             
         MVC   ELEM+1(2),=C'60'                                                 
         LA    R2,TRACLTH                                                       
         B     BLPRGERX                                                         
*                                                                               
         LTORG                                                                  
         DROP  R7,RB,RC                                                         
         EJECT                                                                  
*==============================================                                 
* GET REVISION INFO                                                             
*==============================================                                 
                                                                                
FREV     NTR1  BASE=*,LABEL=*                                                   
         L     RC,SVADGEND                                                      
         USING GEND,RC                                                          
*                                                                               
         USING PRGTABLED,R5                                                     
*                                                                               
         BRAS  RE,INITXSP                                                       
*                                                                               
         XC    FILENAME,FILENAME                                                
         MVI   OREVNN,0            INIT PROG REV NUM FOR OTHER RECS             
         MVI   OREVNUM,0                AND OTHER NET REV NUM                   
         MVI   SVHIREVP,0          INIT HIGH PROG REV NUM                       
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING REVXKEY,R4                                                       
KS       USING REVXKEY,KEYSAVE                                                  
*                                                                               
         MVC   REVXKID,=X'0A1D'                                                 
         MVC   REVXKAM,BAGYMD                                                   
         MVC   REVXKCLT,BCLT                                                    
         MVC   REVXKNET,NETWORK                                                 
         MVC   REVXKPRG,PRGPRG                                                  
         MVC   REVXKPER,PERIOD                                                  
         CLI   MYTN2PR6,C'W'       USING WEEKLY PERIOD                          
         BNE   *+18                                                             
         TM    SVFLAG,CONVSW       CONVERTED RECORDS?                           
         BNZ   *+10                YES, ALREADY SET                             
         MVC   REVXKPER,STDATEP                                                 
*                                                                               
         OC    VOPTPROD,VOPTPROD   RUNNING BY PRODUCT                           
         BZ    *+10                                                             
         MVC   REVXKPRD,VOPTPROD                                                
*                                                                               
         OC    VOPTPRGR,VOPTPRGR   BY PRODUCT GROUP                             
         BZ    *+10                                                             
         MVC   REVXKPGR,VOPTPRGR                                                
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                READ XSPDIR                                  
         CLC   KEY(L'REVXKEY),KEYSAVE                                           
         BE    FREV10                                                           
*                                                                               
FREV02   CLC   KEY(REVXKNUM-REVXKEY),KEYSAVE                                    
         BNE   FREV30                                                           
*                                                                               
         OC    VOPTPROD,VOPTPROD   RUNNING BY PRODUCT                           
         BZ    FREV02C                                                          
         CLC   REVXKPRD,VOPTPROD                                                
         BNE   FREV04                                                           
         BE    FREV10                                                           
*                                                                               
FREV02C  OC    VOPTPRGR,VOPTPRGR   BY PRODUCT GROUP                             
         BZ    FREV02F                                                          
         CLC   REVXKPGR,VOPTPRGR                                                
         BNE   FREV04                                                           
         BE    FREV10                                                           
*                                                                               
FREV02F  OC    REVXKPRD(L'REVXKPRD+L'REVXKPGR),KS.REVXKPRD PRD&PG               
         BZ    FREV10                                                           
*                                                                               
FREV04   MVC   KEYSAVE,KEY                                                      
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 SEQ                                                              
         B     FREV02                                                           
*                                                                               
* TEST REVISED/ORIGINAL HERE *                                                  
*                                                                               
FREV10   L     R6,AIO3                                                          
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
         CLC   KEY(32),0(R6)                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   PRGPREVN(3),PRGCREVN MOVE CURRENT TO PREV                        
         MVC   PRGCREVN,REVXKNUM-REVXKEY(R6)                                    
         CLC   PRGCREVN,SVHIREVP                                                
         BNH   *+10                                                             
         MVC   SVHIREVP,PRGCREVN    SV HIGHEST PROG REV #                       
*                                                                               
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         USING REVREVEL,R6                                                      
*                                                                               
         FIXDT02                                                                
         GOTO1 DATCON,DMCB,(3,REVADATE),(2,PRGCREVD)                            
         NI    PRGFLG,X'FF'-PRGFLGPP SET OFF INSTR RUN THIS REV                 
*                                                                               
         MVC   PRGIDTE,REVIDATE                                                 
*                                                                               
         TM    REVFLAG,REVINS     INSTR RUN FOR THIS REV                        
         BZ    *+8                                                              
         OI    PRGFLG,PRGFLGPP     SET ON INSTR RUN THIS REV                    
*                                                                               
         TM    REVFLAG,REVFAX      THIS INS FAXED?                              
         BZ    *+10                 NO                                          
         MVC   PRGLFAX,PRGCREVN                                                 
*                                                                               
FREV14   DS    0H                                                               
         MVC   KEYSAVE,KEY                                                      
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 SEQ                                                              
*                                                                               
         CLC   KEY(REVXKNUM-REVXKEY),KEYSAVE                                    
         BNE   FREV20                                                           
*                                                                               
         OC    VOPTPROD,VOPTPROD   RUNNING BY PRODUCT                           
         BZ    FREV14C                                                          
         CLC   REVXKPRD,VOPTPROD                                                
         BNE   FREV14                                                           
         BE    FREV10                                                           
*                                                                               
FREV14C  OC    VOPTPRGR,VOPTPRGR   BY PRODUCT GROUP                             
         BZ    FREV14F                                                          
         CLC   REVXKPGR,VOPTPRGR                                                
         BNE   FREV14                                                           
         BE    FREV10                                                           
*                                                                               
FREV14F  OC    REVXKPRD(L'REVXKPRD+L'REVXKPGR),KS.REVXKPRD PRD&PG               
         BZ    FREV10                                                           
*                                                                               
FREV20   TM    REVFLAG,REVINS      HAVE INSTR BEEN RUN FOR THIS REV?            
         BZ    *+14                 NO - SET FLAG                               
         CLC   PRGLFAX,PRGCREVN    WAS LAST REVN FAXED?                         
         BE    *+8                  YES                                         
         OI    PRGFLG,PRGFAXCG     SET FLAG TO SHOW CHANGE                      
*                                                                               
         MVC   KEY,NBKEY           RESTORE UNTDIR KEY POSN                      
         MVI   DMINBTS,X'08'       SET TO GET DELETES                           
         BRAS  RE,UNTDIRHI                                                      
         CLC   KEY(20),KEYSAVE                                                  
         BE    FREVX10                                                          
         DC    H'0'                                                             
*                                                                               
* NO REV REC FOUND, CK IF OTHER FORMAT EXISTS *                                 
* IF OPTION WEEKLY, CK FOR MONTHLY REC        *                                 
*    OPTION MONTHLY, CK FOR WEEKLY REC        *                                 
*                                                                               
FREV30   MVC   KEY,KEYSAVE                                                      
         MVI   REVXKNUM,0          SET REVISION TO ZERO                         
         CLI   VOPTPROD,0          RUNNING BY PRODUCT                           
         BE    *+10                                                             
         MVC   REVXKPRD,VOPTPROD                                                
*                                                                               
         OC    VOPTPRGR,VOPTPRGR   RUNNING BY PRODUCT GROUP                     
         BZ    *+10                                                             
         MVC   REVXKPGR(2),VOPTPRGR                                             
*                                                                               
         CLI   MYTN2PR6,C'W'                                                    
         BE    FREV40                                                           
         MVC   WORK(6),STDATE                                                   
         GOTO1 GETDAY,DMCB,(0,STDATE),WORK+6                                    
         CLC   WORK+6(3),SPACES                                                 
         BNE   *+6                                                              
         DC    H'0'                                                             
         CLI   0(R1),1             MUST BE MONDAY                               
         BE    FREV34                                                           
         LLC   R6,DMCB                                                          
         BCTR  R6,0                                                             
         LNR   R6,R6                                                            
         GOTO1 ADDAY,(R1),STDATE,WORK,(R6)                                      
*                                                                               
         FIXDT02                                                                
FREV34   GOTO1 DATCON,(R1),(0,WORK),(2,WORK+6)                                  
*                                                                               
         TM    SVFLAG,CONVSW       CONVERTED RECORDS?                           
         BZ    *+8                                                              
         BRAS  RE,CONVPER                                                       
*                                                                               
         MVC   REVXKPER,WORK+6                                                  
         XC    SVLGKEY,SVLGKEY     SAVE LAST GOOD KEY                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
*                                                                               
FREV34B  CLC   KEY(REVXKNUM-REVXKEY),KEYSAVE                                    
         BNE   FREV38              LOOK FOR NEXT WEEK'S REVISION                
*                                                                               
         OC    VOPTPROD,VOPTPROD   RUNNING BY PRODUCT                           
         BZ    FREV34C                                                          
         CLC   REVXKPRD,VOPTPROD                                                
         BNE   FREV34G                                                          
         BE    FREV35                                                           
*                                                                               
FREV34C  OC    VOPTPRGR,VOPTPRGR   BY PRODUCT GROUP                             
         BZ    FREV34F                                                          
         CLC   REVXKPGR,VOPTPRGR                                                
         BNE   FREV34G                                                          
         BE    FREV35                                                           
*                                                                               
FREV34F  OC    REVXKPRD(L'REVXKPRD+L'REVXKPGR),KS.REVXKPRD PRD&PG               
         BZ    FREV35                                                           
*                                                                               
FREV34G  MVC   KEYSAVE,KEY                                                      
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 SEQ                                                              
         B     FREV34B                                                          
*----------------------------------------------                                 
* READ ALL REVISION RECORDS FOR THIS PERIOD                                     
* AND GET HIGHEST REVISION NUMBER USED                                          
*----------------------------------------------                                 
FREV35   CLC   OREVNUM,REVXKNUM    COMPARE OTHER REV # TO THIS                  
         BNL   *+10                                                             
         MVC   OREVNUM,REVXKNUM    SAVE THIS REV#                               
*                                                                               
         MVC   SVLGKEY,KEY            SAVE LAST GOOD KEY                        
*                                                                               
FREV35F  MVC   KEYSAVE,KEY                                                      
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 SEQ                                                              
*                                                                               
         CLC   KEY(REVXKNUM-REVXKEY),KEYSAVE                                    
         BNE   FREV37               LOOK UP NEXT WEEK                           
*                                                                               
FREV36   CLI   VOPTPROD,0          RUNNING BY PRODUCT                           
         BE    FREV36B                                                          
         CLC   REVXKPRD,VOPTPROD                                                
         BE    FREV35                                                           
         BNE   FREV35F             GET NEXT RECORD                              
*                                                                               
FREV36B  OC    VOPTPRGR,VOPTPRGR   RUNNING BY PRODUCT GROUP                     
         BZ    FREV36C                                                          
         CLC   REVXKPGR(2),VOPTPRGR                                             
         BNE   FREV35F             GET NEXT RECORD                              
         BE    FREV35                                                           
*                                                                               
FREV36C  OC    REVXKPRD(L'REVXKPRD+L'REVXKPGR),KS.REVXKPRD PRD&PGR              
         BZ    FREV35                                                           
         B     FREV35F             GET NEXT RECORD                              
*                                                                               
* RE-READ LAST GOOD RECORD                                                      
*                                                                               
FREV37   OC    SVLGKEY,SVLGKEY     ANY GOOD RECORDS                             
         BZ    FREV38                                                           
         MVC   KEY,SVLGKEY                                                      
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(L'REVXKEY),KEYSAVE                                           
         BE    *+6                                                              
         DC    H'0'                 MUST BE THERE                               
*                                                                               
         CLC   OREVNUM,REVXKNUM    IS OTHER REV# HIGHER                         
         BH    FREV38               YES, DONE                                   
         BE    *+6                                                              
         DC    H'0'                OTHER REV# IS LOWER ?  BUG???                
*                                                                               
         L     R6,AIO3                                                          
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
*                                                                               
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         USING REVREVEL,R6                                                      
*                                                                               
         CLI   REVDTALN,12         OLD REV REC                                  
         BE    *+20                                                             
         CLC   OREVNN,REVNNUM                                                   
         BNL   *+10                                                             
         MVC   OREVNN,REVNNUM      SAVE NET REV NUM FOR OTHER PERIOD            
*                                                                               
         TM    REVFLAG,X'80'       HAVE INSTRUCTIONS BEEN RUN                   
         BZ    FREV38              NO,LOOK UP NEXT WEEK                         
*                                                                               
         LLC   RF,OREVNUM          YES, UP REVISION NUMBER                      
         LA    RF,1(,RF)                                                        
         STC   RF,OREVNUM                                                       
*                                                                               
FREV38   MVC   KEY,KEYSAVE                                                      
         MVI   REVXKNUM,0          SET REVISION TO ZERO                         
         CLI   VOPTPROD,0          RUNNING BY PRODUCT                           
         BE    *+10                                                             
         MVC   REVXKPRD,VOPTPROD                                                
*                                                                               
         OC    VOPTPRGR,VOPTPRGR   RUNNING BY PRODUCT GROUP                     
         BZ    *+10                                                             
         MVC   REVXKPGR(2),VOPTPRGR                                             
*                                                                               
         GOTO1 ADDAY,DMCB,WORK,WORK,F'7' GET MONDAY OF NEXT WEEK                
*                                                                               
         CLC   STDATE+2(2),WORK+2  SAME MONTH?                                  
         BE    FREV34               YES                                         
*                                                                               
         CLI   MYTN2PR6,C'B'                                                    
         BNE   FREVX                                                            
*                                                                               
         CLC   ENDATE+2(2),=C'12'   FIX END OF YEAR ISSUE                       
         BNE   *+14                                                             
         CLC   WORK+2(2),=C'01'                                                 
         BE    FREVX                                                            
*                                                                               
         CLC   ENDATE+2(2),WORK+2  SAME MONTH?                                  
         BNL   FREV34               YES                                         
         B     FREVX                                                            
*                                                                               
* CK FOR MONTHLY REV REC *                                                      
*                                                                               
FREV40   DS    0H                                                               
         GOTO1 DATCON,DMCB,(0,STDATE),(3,WORK)                                  
         MVC   REVXKPER,WORK                                                    
         XC    SVLGKEY,SVLGKEY     INIT LAST GOOD KEY                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
*NOP     BRAS  RE,UNTDIRHI                                                      
         CLC   KEY(L'REVXKEY),KEYSAVE                                           
         BE    FREV42                                                           
*                                                                               
FREV40B  CLC   KEY(REVXKNUM-REVXKEY),KEYSAVE                                    
         BNE   FREV50                                                           
*                                                                               
         OC    VOPTPROD,VOPTPROD   RUNNING BY PRODUCT                           
         BZ    FREV40C                                                          
         CLC   REVXKPRD,VOPTPROD                                                
         BNE   FREV40G                                                          
         BE    FREV42                                                           
*                                                                               
FREV40C  OC    VOPTPRGR,VOPTPRGR   BY PRODUCT GROUP                             
         BZ    FREV40F                                                          
         CLC   REVXKPGR,VOPTPRGR                                                
         BNE   FREV40G                                                          
         BE    FREV42                                                           
*                                                                               
FREV40F  OC    REVXKPRD(L'REVXKPRD+L'REVXKPGR),KS.REVXKPRD PRD&PG               
         BZ    FREV42                                                           
*                                                                               
FREV40G  MVC   KEYSAVE,KEY                                                      
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 SEQ                                                              
         B     FREV40B                                                          
*                                                                               
* READ ALL REVISION RECORDS FOR THIS PERIOD                                     
* AND GET HIGHEST REVISION NUMBER USED                                          
*                                                                               
FREV42   CLC   OREVNUM,REVXKNUM    COMPARE OTHER REV # TO THIS                  
         BNL   *+10                                                             
         MVC   OREVNUM,REVXKNUM    SAVE THIS REV#                               
*                                                                               
         MVC   SVLGKEY,KEY         SAVE LAST GOOD KEY                           
*                                                                               
FREV42F  MVC   KEYSAVE,KEY                                                      
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 SEQ                                                              
*                                                                               
         CLC   KEY(REVXKNUM-REVXKEY),KEYSAVE                                    
         BNE   FREV45               LOOK UP NEXT WEEK                           
*                                                                               
FREV43   CLI   VOPTPROD,0          RUNNING BY PRODUCT                           
         BE    FREV43B                                                          
         CLC   REVXKPRD,VOPTPROD                                                
         BE    FREV42                                                           
         BNE   FREV42F             GET NEXT RECORD                              
*                                                                               
FREV43B  OC    VOPTPRGR,VOPTPRGR   RUNNING BY PRODUCT GROUP                     
         BZ    FREV43C                                                          
         CLC   REVXKPGR(2),VOPTPRGR                                             
         BNE   FREV42F             GET NEXT RECORD                              
         BE    FREV42                                                           
*                                                                               
FREV43C  OC    REVXKPRD(L'REVXKPRD+L'REVXKPGR),KS.REVXKPRD PRD&PGR              
         BZ    FREV42                                                           
         B     FREV42F             GET NEXT RECORD                              
*                                                                               
* RE-READ LAST GOOD RECORD                                                      
*                                                                               
FREV45   OC    SVLGKEY,SVLGKEY     ANY GOOD RECORD                              
         BZ    FREV50                                                           
         MVC   KEY,SVLGKEY                                                      
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(L'REVXKEY),KEYSAVE                                           
         BE    *+6                                                              
         DC    H'0'                 MUST BE THERE                               
*                                                                               
         L     R6,AIO3                                                          
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         USING REVREVEL,R6                                                      
*                                                                               
         CLI   REVDTALN,12         OLD REV REC                                  
         BE    *+20                                                             
         CLC   OREVNN,REVNNUM                                                   
         BNL   *+10                                                             
         MVC   OREVNN,REVNNUM      SAVE NET REV NUM FOR OTHER PERIOD            
*                                                                               
         TM    REVFLAG,X'80'       HAVE INSTRUCTIONS BEEN RUN                   
         BZ    FREV50                                                           
*                                                                               
         LLC   RF,OREVNUM          YES, UP REVISION NUMBER                      
         LA    RF,1(,RF)                                                        
         STC   RF,OREVNUM                                                       
*                                                                               
FREV50   DS    0H                                                               
         MVC   KEY,KEYSAVE                                                      
         MVI   REVXKNUM,0          SET REVISION TO ZERO                         
         CLI   VOPTPROD,0          RUNNING BY PRODUCT                           
         BE    *+10                                                             
         MVC   REVXKPRD,VOPTPROD                                                
*                                                                               
         OC    VOPTPRGR,VOPTPRGR   RUNNING BY PRODUCT GROUP                     
         BZ    *+10                                                             
         MVC   REVXKPGR(2),VOPTPRGR                                             
*                                                                               
         MVC   WORK(6),STDATE                                                   
         GOTO1 VGTBROAD,DMCB,(1,WORK),WORK+6,GETDAY,ADDAY                       
         CLC   WORK+8(2),WORK+14   START AND END MONTH SAME                     
         BE    FREV55                                                           
*                                                                               
* ONLY INCREMENT MONTH IF DAY IS OVER 21 *                                      
*                                                                               
         CLC   =C'20',WORK+2                                                    
         BL    FREV55                                                           
         GOTO1 ADDAY,(R1),WORK+6,WORK+6,F'15'                                   
FREV55   GOTO1 DATCON,(R1),(0,WORK+6),(3,WORK)                                  
*                                                                               
         CLC   REVXKPER,WORK                                                    
         BE    FREVX               DONE THIS PERIOD BEFORE                      
*                                                                               
         MVC   REVXKPER,WORK                                                    
*                                                                               
FREV60   MVI   RDUPDATE,C'N'                                                    
         XC    SVLGKEY,SVLGKEY                                                  
         GOTO1 HIGH                                                             
         CLC   KEY(L'REVXKEY),KEYSAVE                                           
         BE    FREV62                                                           
*                                                                               
         CLC   KEY(REVXKNUM-REVXKEY),KEYSAVE                                    
         BNE   FREVX                                                            
*                                                                               
FREV61   CLI   VOPTPROD,0          RUNNING BY PRODUCT                           
         BE    FREV61B                                                          
         CLC   REVXKPRD,VOPTPROD                                                
         BE    FREV62                                                           
         BNE   FREV61F                                                          
*                                                                               
FREV61B  OC    VOPTPRGR,VOPTPRGR   RUNNING BY PRODUCT GROUP                     
         BZ    FREV61C                                                          
         CLC   REVXKPGR(2),VOPTPRGR                                             
         BNE   FREV61F                                                          
         BE    FREV62                                                           
FREV61C  OC    REVXKPRD(L'REVXKPRD+L'REVXKPGR),KS.REVXKPRD PRD&PGR              
         BZ    FREV62                                                           
*                                                                               
FREV61F  MVC   KEYSAVE,KEY                                                      
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 SEQ                                                              
*                                                                               
         CLC   KEY(REVXKNUM-REVXKEY),KEYSAVE                                    
         BNE   FREV65                                                           
         B     FREV61                                                           
*                                                                               
FREV62   CLC   OREVNUM,REVXKNUM    COMPARE OTHER REV # TO THIS                  
         BNL   *+10                                                             
         MVC   OREVNUM,REVXKNUM    SAVE THIS REV#                               
*                                                                               
         MVC   SVLGKEY,KEY            SAVE LAST GOOD KEY                        
         MVC   KEYSAVE,KEY                                                      
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 SEQ                                                              
*                                                                               
         CLC   KEY(REVXKNUM-REVXKEY),KEYSAVE                                    
         BE    FREV61                                                           
*-------------------------------                                                
* RE-READ LAST GOOD RECORD                                                      
*-------------------------------                                                
                                                                                
FREV65   OC    SVLGKEY,SVLGKEY     WERE THERE ANY GOOD RECORDS                  
         BZ    FREVX                NO, DONE                                    
         MVC   KEY,SVLGKEY                                                      
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(L'REVXKEY),KEYSAVE                                           
         BE    *+6                                                              
         DC    H'0'                 MUST BE THERE                               
*                                                                               
         CLC   OREVNUM,REVXKNUM    COMPARE OTHER REV # TO THIS                  
         BH    FREVX                                                            
         BE    *+6                                                              
         DC    H'0'                OTHER REV IS LOWER ? BUG??                   
*                                                                               
         L     R6,AIO3                                                          
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
*                                                                               
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         USING REVREVEL,R6                                                      
*                                                                               
         TM    REVFLAG,X'80'       HAVE INSTRUCTIONS BEEN RUN                   
         BZ    FREVX                                                            
*                                                                               
         LLC   RF,OREVNUM          YES, UP REVISION NUMBER                      
         LA    RF,1(,RF)                                                        
         STC   RF,OREVNUM                                                       
*                                                                               
FREVX    DS    0H                                                               
         CLC   OREVNUM,SVHIREVP    COMPARE OTHER  REVISION #                    
         BNH   *+10                TO THIS REVISION                             
         MVC   SVHIREVP,OREVNUM    USE THE HIGHER NUMBER OF THE TWO             
*                                                                               
         MVC   PRGCREVN,SVHIREVP                                                
*                                                                               
         MVC   KEY,NBKEY                                                        
         MVI   DMINBTS,X'08'       SET TO GET DELETES                           
         BRAS  RE,UNTDIRHI                                                      
*                                                                               
         CLC   KEY(20),NBKEY                                                    
         BE    FREVX10                                                          
         DC    H'0'                                                             
FREVX10  BRAS  RE,INITNET                                                       
         MVI   DMINBTS,0                                                        
         XIT                                                                    
         LTORG                                                                  
         DROP  KS                                                               
         DROP  R4,R5                                                            
         EJECT                                                                  
*==================================================================             
* READ THROUGH BUYS AND BUILD UNIT TABLE FOR 1 PROGRAM                          
*==================================================================             
                                                                                
BLDUNT   NMOD1 0,**+BLU,R7                                                      
         L     RC,SVADGEND                                                      
         USING GEND,RC                                                          
*                                                                               
         USING PRGTABLED,R5                                                     
         MVC   SVPRG,PRGPRG                                                     
         MVC   SVPRGDEL,PRGDEL    SAVE DELETE CT                                
         MVC   SVPRGFLG,PRGFLG    SAVE FLAGS                                    
         MVC   SVPRGIDT,PRGIDTE                                                 
         MVC   SVPRGFAX,PRGFAX                                                  
         MVC   SVPGEND,PRGENDAT   PROGRAM END DATE                              
*                                                                               
         XC    BLOCK+256(224),BLOCK+256 CLEAR AREA FOR CUTIN STATIONS           
*                                                                               
         MVI   SVMPRG,C' '                                                      
         CLI   SVTWPR08,C'Y'       FAX EACH PROGRAM SEPARATELY                  
         BE    BLDUN02                                                          
         LA    RF,PRGNEXT                                                       
*PRG                                                                            
         C     RF,APRGTBLX           AT END OF TABLE                            
         BNL   BLDUN02                                                          
*PRG                                                                            
         CLI   PRGPRG-PRGENT(RF),0   AT END OF TABLE                            
         BE    BLDUN02                                                          
         CLC   PRGFAX,PRGFAX-PRGENT(RF)  NEXT ENTRY DIFFERENT DEST              
         BNE   BLDUN02                                                          
         MVI   SVMPRG,C'+'                                                      
*                                                                               
BLDUN02  DS   0H                                                                
         SR    RF,RF               CLEAR RECORD                                 
         STH   RF,UNITCT           CLEAR UNIT COUNTER                           
         STC   RF,SVUNTCT          SAVE UNIT COUNT                              
*                                                                               
         OI    UPDSW,X'02'         SET ON ONLY SKED UNITS SW                    
*                                                                               
         MVC   BASEPRG,SVPRG                                                    
         MVC   BASEDTS,STDATEP                                                  
*                                                                               
         BRAS  RE,ININETIO         INITIALIZE NETIO                             
*                                                                               
         L     R5,AUNTABLE                                                      
         USING UNTABLED,R5                                                      
         XC    0(256,R5),0(R5)     CLEAR START OF UNTABLE                       
*                                                                               
* FIRST READ - MUST IGNORE BAD NBSUBMSK SETTINGS *                              
*                                                                               
BLDUN04 DS     0H                                                               
         TM    SECFLAG,BLSSW       BRAND LEVEL SECURITY CLIENT                  
         BZ    BLDUN05                                                          
*                                                                               
         CLI   T216FFD+6,C'$'      USER SIGN ON OFFICE LIST                     
         BNE   *+18                                                             
         OI    NBINDS5,NBI5PLST    SET OFFICE LIST FLAG                         
         MVC   NBSECSV,ASECBLK     PASS ADDRESS OF SECURITY BLOCK               
         B     *+12                                                             
         CLI   T216FFD+6,C'*'      USER SIGN ON BY OFFICE                       
         BNE   BLDUN05              NO                                          
*                                                                               
         MVC   NBTRAPSC,T216FFD+7  BRAND LEVEL OFFICE(LIST)                     
*                                                                               
BLDUN05  GOTO1 ANETIO,DMCB,(R3)                                                 
         MVI   NBUSER+13,C'N'      DO NOT SUPPRESS PRE-EMPTS                    
         CLI   NBERROR,NBGOOD                                                   
         BE    *+6                                                              
         DC    H'0'                                                             
         CLI   NBMODE,NBREQLST                                                  
         BE    BLDUN06                                                          
         CLI   NBMODE,NBPROCUN                                                  
         BNE   BLDUN04                                                          
         TM    SVPRGFLG,PRGXCLUD   EXCLUDE THIS PROGRAM                         
         BZ    BLDUN06              NO                                          
*                                                                               
         MVI   NBMODE,NBREQLST     DONE WITH THIS PROG                          
         LLC   RF,SVUNTCT          COUNTER                                      
         BCTR  RF,0                ADJ RECORD CT                                
         STC   RF,SVUNTCT                                                       
         B     BLDUN60             GET NEXT PROGRAM                             
         EJECT                                                                  
* READ PROGRAM RECORD FOR STANDARD PROGRAM INFORMATION *                        
*                                                                               
BLDUN06 XC     KEY,KEY                                                          
         LA    R1,KEY                                                           
         USING NPGKEY,R1                                                        
         MVC   NPGKTYP,=X'0D20'                                                 
         MVC   NPGKAM,BAGYMD                                                    
         MVC   NPGKNET,NETMKT                                                   
         MVC   NPGKPROG,SVPRG                                                   
         MVC   NPGKEND,NBACTDAT                                                 
         DROP  R1                                                               
         BRAS  RE,INITSPT          SWITCH TO SPT                                
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(11),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
         L     R6,AIO2                                                          
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
         MVC   AIO,AIO1                                                         
         MVI   ELCODE,X'92'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         USING NPGEL92,R6                                                       
         MVC   SVPRGDAY,NPGDAY                                                  
         MVC   SVPRGTIM,NPGTIME                                                 
         MVC   SVPRGNM,NPGNAME                                                  
*                                                                               
         CLI   NPGROT,0            IF ROT FILLED IN, USE IT                     
         BE    *+10                                                             
         MVC   SVPRGDAY,NPGROT                                                  
*                                                                               
* BLANK FILL PROGRAM NAME *                                                     
*                                                                               
         OC    SVPRGNM,SPACES                                                   
         MVC   SVSTDNM,SVPRGNM                                                  
*                                                                               
         MVI   ELCODE,X'E3'                                                     
         BRAS  RE,NEXTEL                                                        
         BNE   BLDUN08                                                          
         USING NPGELE3,R6                                                       
         MVC   SVPRGDAY,NPGTDAY                                                 
         DROP  R6                                                               
BLDUN08 L      R1,NEXTADDR                                                      
         XC    0(256,R1),0(R1)                                                  
         CLI   NBMODE,NBREQLST                                                  
         BE    BLDUN70                                                          
         EJECT                                                                  
* PROCESS UNITS *                                                               
*                                                                               
BLDUN10  L     R6,NBAIO                                                         
         LR    R4,R6                                                            
*                                                                               
         XC    SVCSPROD,SVCSPROD                                                
         NI    UPDSW,X'FF'-UNTFDDSW  INIT FEED NO NATIONAL SW                   
*                                                                               
         LA    R6,27(R6)                                                        
         MVI   ELCODE,X'19'                                                     
         BRAS  RE,NEXTEL                                                        
         BNE   BLDUN10E                                                         
*                                                                               
         USING NUPDED,R6                                                        
         TM    NUPDEIND,X'40'      IS IT COPYSPLIT                              
         BZ    BLDUN10E            NO                                           
*                                                                               
         SR    R0,R0                                                            
         LLC   R1,1(R6)                                                         
         D     R0,=F'7'                                                         
         LTR   R0,R1                                                            
         BP    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LA    R1,NUPDEPR          PT TO 3 CHAR PROD                            
         LA    RF,SVCSPROD         MOVE IN C/S PRODS                            
         DROP  R6                                                               
*                                                                               
BLUPR22  MVC   0(3,RF),0(R1)                                                    
         LA    RF,3(RF)            BUMP IN SVCSPROD                             
         LA    R1,6(R1)            TO NEXT PROD IN ELEM                         
         LA    R1,1(R1)            YES, BUMP ONE MORE IN ELEM                   
         BCT   R0,BLUPR22                                                       
*                                                                               
BLDUN10E L     R6,NBAIO                                                         
                                                                                
* SEE IF MEDIA OR TRAFFIC SKED UNIT *                                           
                                                                                
BLDUN10G CLI   SVTNPR9,C'B'        BOTH MEDIA AND SKED                          
         BE    BLDUN11                                                          
         CLI   SVTNPR9,C'S'        IF NOT SKED, MEDIA DEFAULT                   
         BNE   *+16                                                             
         CLI   NBACTSUB,C'A'       SKED ONLY                                    
         BL    BLDUN60                                                          
         B     BLDUN11                                                          
*                                                                               
         CLI   NBACTSUB,C'A'                                                    
         BNL   BLDUN60                                                          
*                                                                               
BLDUN11 CLI    NBACTSUB,C'A'       SKED ONLY                                    
         BNL   *+8                                                              
         NI    UPDSW,X'FF'-X'02'        SET OFF ONLY SKED UNITS SW              
         MVI   DATADISP+1,27       SET FROM SPOT TO NET                         
         OC    NBPR1CL3,NBPR1CL3   UNALLOCATED                                  
         BNZ   BLDUN12                                                          
*                                                                               
         CLI   SVCSPROD,0          THIS A MULTI PROD C/S OR T/B                 
         BNE   BLDUN12                                                          
*                                                                               
         CLI   SVTNPR3,C'Y'        ALLOW UNALLOCATED PRODUCTS                   
         BE    BLDUN12                                                          
         TM    SVOPTSW,OPTUNAL     PRD=UNAL                                     
         BO    BLDUN12             YES                                          
         TM    22(R6),X'80'       THIS RECORD DELETED                           
         BO    BLDUN12                                                          
         TM    NBUNITST,X'42'     PREEMPT OR MISSED                             
         BNZ   BLDUN12                                                          
         DC    H'0'                                                             
*                                                                               
BLDUN12 CLC    STDATEP,NBACTDAT                                                 
         BH    BLDUN14                                                          
         CLC   ENDATEP,NBACTDAT                                                 
         BNL   *+6                                                              
BLDUN14 DC     H'0'                                                             
*                                                                               
         OC    NBPR1CL3,NBPR1CL3   UNALLOCATED                                  
         BNZ   BLDUN14B                                                         
         CLI   SVCSPROD,0          COPY SPLITS OR TRI-BACK                      
         BNE   BLDUN14B             YES                                         
         OC    VOPTPRGR,VOPTPRGR   FILTERING ON PRODUCT GROUP                   
         BZ    BLDUN15              NO                                          
         B     BLDUN60             BYPASS UNALLOCATED                           
*                                                                               
BLDUN14B DS   0H                                                                
         EJECT                                                                  
         OC    VOPTPROD,VOPTPROD   FILTERING ON PRODUCT                         
         BZ    BLDUN14F             NO                                          
         CLC   NBPR1CL3,VOPTPROD                                                
         BE    BLDUN14F                                                         
*                                                                               
         LA    RE,L'SVCSPROD                                                    
         LA    RF,SVCSPROD                                                      
BLDUN14C CLI   0(RF),0                                                          
         BE    BLDUN60                                                          
         CLC   VOPTPROD,0(RF)                                                   
         BE    BLDUN14F                                                         
         LA    RF,3(,RF)                                                        
         BCT   RE,BLDUN14C                                                      
         B     BLDUN60                                                          
*                                                                               
BLDUN14F OC    VOPTPRGR,VOPTPRGR   FILTERING ON PRODUCT GROUP                   
         BZ    *+12                 NO                                          
         BAS   RE,FPGR             FILTER ON PRODUCT GROUP                      
         BNE   BLDUN60                                                          
*                                                                               
* CHECK BRAND LEVEL SECURITY                                                    
*                                                                               
BLDUN15 DS     0H                                                               
         TM    SECFLAG,BLSSW       BRAND LEVEL SECURITY CLIENT                  
         BZ    BLDUN15X                                                         
*                                                                               
         CLI   ELCODE,X'19'        NEW 3 CHAR PROD ELEM                         
         BNE   BLDUN15X            NO, ALREADY VALIDATED                        
*                                                                               
         L     R0,AIO2             TO                                           
         L     RE,AIO1             FROM                                         
         SR    RF,RF                                                            
         ICM   RF,3,20(RE)         REC LEN                                      
         LR    R1,RF                                                            
         MVCL  (R0),(RE)                                                        
*                                                                               
         LA    R0,6                MAX C/S PROD                                 
         LA    R4,SVCSPROD         PRODS                                        
*                                                                               
BLDUN15F XC    FLDH,FLDH                                                        
         XC    FLD,FLD                                                          
         MVI   FLDH+5,3            DATA LEN                                     
         MVC   FLD(3),0(R4)        PROD                                         
         LA    R2,FLDH                                                          
         MVI   ERROPT,C'Y'         RETURN ON ERROR                              
         GOTO1 VALIPRD                                                          
         MVI   ERROPT,0                                                         
*                                                                               
         CLI   ERROR,0             ANY ERRORS                                   
         BE    BLDUN15G                                                         
*                                                                               
         MVI   ERROR,SECLOCK                                                    
         B     BLDUN60                                                          
*                                                                               
BLDUN15G LA    R4,3(R4)            BUMP TO NET PROD IN SVCSPROD                 
         OC    0(3,R4),0(R4)                                                    
         BZ    *+8                                                              
         BCT   R0,BLDUN15F                                                      
*                                                                               
         L     R0,AIO1             TO                                           
         L     RE,AIO2             FROM                                         
         SR    RF,RF                                                            
         ICM   RF,3,20(RE)         REC LEN                                      
         LR    R1,RF                                                            
         MVCL  (R0),(RE)                                                        
*                                                                               
BLDUN15X XC    UNTENT(L'UNTENT+2),UNTENT                                        
*                                                                               
         CLI   SVTN2PRC,C'Y'       SHOW ESTIMATE ?                              
         BNE   *+10                 NO                                          
         MVC   UNTEST,NBACTEST     SAVE ESTIMATE NUMBER                         
*                                                                               
         MVC   UNTADTEP,NBACTDAT                                                
         LLC   RF,SVUNTCT          COUNTER                                      
         STC   RF,UNTSUB           WAS SUBLINE, NOW REC CT                      
         MVC   UNTDSKAD,NBKEY+21                                                
*                                                                               
* SET FLAG IF BONUS UNIT *                                                      
*                                                                               
         TM    NBUNITST,X'04'     PFB = BONUS                                   
         BZ    *+8                 NO                                           
         OI    UNTFLG1,UNTFLGBN                                                 
*                                                                               
         TM    NBUNITST,X'01'     MAKE-GOOD                                     
         BZ    *+8                                                              
         OI    UNTFLG2,UNTFLMG                                                  
*                                                                               
         CLI   SVTN2PR8,C'Y'       SHOW UNIT COST?                              
         BNE   *+18                 NO                                          
         TM    NBUNITST,X'20'      ANY ACTUAL COST?                             
         BZ    *+10                                                             
         MVC   UNTACOST,NBACTUAL   SAVE COST IN TABLE                           
*OPTICA                                                                         
*****    MVC   UNTNTI,NBNTI        NTI CODE                                     
*                                                                               
* SET FLAG IF ADU UNIT *                                                        
*                                                                               
         MVI   ELCODE,X'02'                                                     
         L     R6,NBAIO                                                         
         BRAS  RE,GETEL                                                         
         BNE   BLDUN15B                                                         
*                                                                               
         TM    NUSDST3-NUSDRD(R6),X'02' ADU?                                    
         BZ    *+8                       NO                                     
         OI    UNTFLG1,UNTFLGAD                                                 
BLDUN15B L     R6,NBAIO                                                         
         MVI   ELCODE,X'60'                                                     
         LA    R6,27(R6)                                                        
*                                                                               
BLDUN15C BRAS  RE,NEXTEL                                                        
         BNE   BLDUN15E                                                         
         CLI   2(R6),C'F'          THIS A BUY TYPE CODE                         
         BNE   BLDUN15C             NO                                          
         CLI   3(R6),C'O'          OPPORTUNISTIC                                
         BNE   *+8                                                              
         OI    UNTFLG2,UNTFLOPR                                                 
         CLI   3(R6),C'S'          SCATTER                                      
         BNE   *+8                                                              
         OI    UNTFLG2,UNTFLSCA                                                 
         CLI   3(R6),C'U'          UPFRONT                                      
         BNE   BLDUN15C                                                         
         OI    UNTFLG2,UNTFLUPF                                                 
         B     BLDUN15C                                                         
*                                                                               
* SPECIAL CHECKS FOR PREEMPTED, MISSED, & DELETED UNITS *                       
*                                                                               
BLDUN15E L     R6,NBAIO                                                         
*                                                                               
         TM    NBUNITST,X'42'     PREEMPT OR MISSED                             
         BNZ   BLDUN16            TREAT AS DELETED                              
*                                                                               
         TM    22(R6),X'80'       THIS RECORD DELETED                           
         BZ    BLDUN20                                                          
*                                                                               
BLDUN16  L     R6,NBAIO                                                         
         MVI   ELCODE,X'21'                                                     
         BRAS  RE,GETEL                                                         
         BNE   BLDUN60            IF NOT ASSIGNED BY TRAFFIC, IGNORE            
*                                                                               
         CLI   SVTN1PRB,C'Y'       DO NOT PRINT DELETED UNITS                   
         BNE   BLDUN18             YES, PRINT THEM                              
*                                                                               
         OI    TABLESW,DELETDSW    DEL UNIT NOT PRINTED ON INSTR                
         B     BLDUN60              BYPASS                                      
*                                                                               
         USING NUCMLEL,R6                                                       
*                                                                               
BLDUN18 OI     UNTFLG,X'40'                                                     
         TM    NBUNITST,X'42'     PREEMPT OR MISSED                             
         BZ    *+8                                                              
         OI    UNTFLG,X'02'       FLAG IN ADDITION TO DELETED                   
         TM    NUCMLFLG,X'10'     EVER PRINTED ON INSTR                         
         BZ    BLDUN60              NO                                          
         TM    NUCMLFLG,X'02'     PRINTED ON INSTR SINCE DELETED                
         BO    BLDUN25              YES                                         
         MVC   NUCMLREV,SVPRGRVN                                                
         EJECT                                                                  
* SAVE UNIT INFO IN TABLE *                                                     
*                                                                               
BLDUN20 DS     0H                                                               
         L     R6,NBAIO                                                         
         MVI   ELCODE,X'21'                                                     
         BRAS  RE,GETEL                                                         
         BNE   *+12                                                             
BLDUN25  TM     NUCMLFLG,X'10'      PRINTED ON INSTRUCTIONS?                    
         BNZ   *+12                 YES                                         
         OI    SVPRGFLG,PRGFAXCG    SET FLAG TO SHOW CHANGE                     
         B     *+8                                                              
         OI    UNTFLG1,UNTFLGIN   SET ON PRINTED ON INSTRUCTIONS                
*                                                                               
         L     R6,NBAIO                                                         
*                                                                               
* SEE IF THIS UNIT HAS 5 SECONDS TAG                                            
*                                                                               
         MVI   ELCODE,X'60'                                                     
         LA    R6,27(R6)                                                        
*                                                                               
BLDUNG10 BRAS RE,NEXTEL                                                         
         BNE   BLDUNGX                                                          
*                                                                               
         CLI   2(R6),C'Q'          IS THIS A TAG ELEMENT                        
         BNE   BLDUNG10                                                         
         CLI   3(R6),C'T'          T=TAG                                        
         BNE   BLDUNG10                                                         
*                                                                               
         PACK  DUB,4(1,R6)                                                      
         CVB   R0,DUB              TAGS IN BINARY                               
         MHI   R0,5                TIMES 5 (5 SECONDS PER TAG)                  
         LLC   R1,NBLEN            TOTAL UNIT LEN                               
         SR    R1,R0               MINUS TAG LEN                                
         STC   R1,NBLEN            = ACTUAL UNIT LENGTH                         
*                                                                               
         MVI   UNTFEED+1,X'FF'                                                  
         MVC   UNTFEED+2(2),3(R6)  SAVE TAG  (00FF(T1))                         
*                                                                               
BLDUNGX L      R6,NBAIO                                                         
*                                                                               
         MVC   UNTPROD,NBPR1CL3                                                 
         MVC   UNTSLN,NBLEN                                                     
         MVC   UNTTIME,NBTIME                                                   
         MVC   UNTDAY,NBSDROT                                                   
         CLI   NBSDROT,0           IF NOT THERE, USE NBDAY                      
         BNE   *+10                                                             
         MVC   UNTDAY,NBDAY                                                     
*                                                                               
         MVC   UNTPACK,NBPACK      SAVE PACKAGE NUMBER                          
*                                                                               
         TM    NBUNST3,X'40'       COPY SPLIT                                   
         BO    BLDUN30              YES                                         
*                                                                               
         OC    NBPR2CL3,NBPR2CL3   IS THERE PROD 2                              
         BZ    BLDUN30              NO                                          
*                                                                               
         MVC   UNTPROD2,NBPR2CL3                                                
*                                                                               
* CALCULATE PRD LENGTH                                                          
*                                                                               
         LLC   R1,NBLEN1           1ST PRD LEN                                  
         CLI   NBLEN1,0            IF PRD 1 LEN IS ZERO THEN                    
         BNE   BLDUN29C                                                         
*                                                                               
         SR    RE,RE                                                            
         LLC   RF,NBLEN            TOTAL LEN                                    
         D     RE,=F'2'                                                         
         STC   RF,UNTSLN2                                                       
         AR    RF,RE               ADD REMAINDER 1 IF ANY                       
         STC   RF,UNTSLN                                                        
         B     BLDUN30                                                          
*                                                                               
BLDUN29C LLC   RF,NBLEN            TOTAL PRD LEN                                
         SR    RF,R1                                                            
BLDUN29F STC   R1,UNTSLN                                                        
         STC   RF,UNTSLN2                                                       
*                                                                               
* GET TRAFFIC INFO *                                                            
*                                                                               
BLDUN30 MVI    ELCODE,X'21'                                                     
         BRAS  RE,GETEL                                                         
         BNE   BLDUN38                                                          
*                                                                               
         USING NUCMLEL,R6                                                       
*                                                                               
         CLI   SVTN1PRB,C'Y'       DO NOT PRINT DELETED UNITS                   
         BNE   BLDUN31             YES, PRINT THEM                              
         TM    NBUNITST,X'42'      PREEMPT OR MISSED                            
         BO    *+12                 YES                                         
         TM    NUCMLFLG,X'08'      TRAFFIC DELETED?                             
         BZ    BLDUN31              NO                                          
*                                                                               
         OI    TABLESW,DELETDSW    DEL UNIT NOT PRINTED ON INSTR                
         B     BLDUN60              BYPASS                                      
*                                                                               
BLDUN31 TM     NUCMLFL2,NUCMLFFD   FEED NO NATIONAL UNIT                        
         BZ    *+12                                                             
         OI    UPDSW,UNTFDDSW       YES                                         
*                                                                               
         CLI   SVTNPR5,C'Y'       TRAFFIC DELETES ALLOWED                       
         BNE   BLDUN32            NO                                            
         TM    NUCMLFLG,X'08'                                                   
         BZ    BLDUN32                                                          
*                                                                               
         TM    NUCMLFLG,X'10'      EVER PRINTED ON INSTR                        
         BZ    BLDUN60              BYPASS                                      
         OI    UNTFLG,X'10'        TRAFFIC DELETED UNIT                         
*                                                                               
BLDUN32 TM     NUCMLFLG,X'E0'      NEED REASSIGN                                
         BNZ   BLDUN34             YES, TREAT AS UNASSIGNED                     
*                                                                               
         TM    NUCMLFL2,NUCMLNEW                                                
         BZ    *+8                                                              
         OI    UNTFLG1,UNTFLGNW    SET NEWLY ASGND CML                          
*                                                                               
         TM    UPDSW,UNTFDDSW      FEED NO NATIONAL                             
         BO    BLDUN34B             YES                                         
*                                                                               
         MVC   UNTCML1(16),NUCML1                                               
         MVC   UNTBBSN(16),NUCMLBSN  IF TRI-BACK THEN ITS UNTCML3               
         MVC   UNTADIFL,NUCMADFL     SAVE ADID FLAGS                            
*                                                                               
BLDUN34 MVC    UNTBBSL,NUCMLBSL                                                 
         MVC   UNTBBPOS,NUCMLBPS                                                
         MVC   UNTPOS,NUCMLPOS                                                  
         OC    UNTPOS,UNTPOS       THIS A TBA                                   
         BNZ   *+8                  NO                                          
         MVI   UNTPOS,X'FF'                                                     
*                                                                               
BLDUN34B TM    NUCMLFLG,X'04'      MEDIA REQUIRED BILLBOARD                     
         BZ    *+8                                                              
         OI    UNTFLG,X'04'                                                     
*                                                                               
         TM    UPDSW,UNTFDDSW      FEED NO NATIONAL                             
         BO    BLDUN34G             YES                                         
*                                                                               
         TM    NBUNST3,X'40'       COPY SPLIT                                   
         BO    BLUN34BA             YES                                         
         CLI   SVCSPROD,0          TRI-BACK                                     
         BE    BLDUN34G             NO                                          
         DC    H'0'                BUG CATCHER                                  
*                                                                               
BLUN34BA XC    UNTPROD,UNTPROD                                                  
*                                                                               
         LA    R2,NUCMPROD         PT TO 3 CHAR PROD                            
         CLC   NUCMPROD,NBPR1CL3                                                
         BE    BLDUN34F                                                         
         CLC   NUCMPROD,NBPR2CL3                                                
         BE    BLDUN34F                                                         
*                                                                               
         LA    RE,L'SVCSPROD                                                    
         LA    RF,SVCSPROD                                                      
BLDUN34E CLI   0(RF),0                                                          
         BE    BLDUN34F                                                         
         CLC   0(3,R2),0(RF)       3 CHAR PROD FROM UNT TO C/S                  
         BE    BLDUN34F                                                         
         LA    RF,3(,RF)                                                        
         AHI   RE,-2                                                            
         BCT   RE,BLDUN34E                                                      
*                                                                               
         B     BLDUN34G                                                         
*                                                                               
BLDUN34F TM    UNTFLG1,UNTFL3TB    TRI-BACK?                                    
         BO    BLDUN34G             YES, DONT FILL IN UNTPROD                   
         MVC   UNTPROD,0(R2)       3 CHAR PROD                                  
*                                                                               
BLDUN34G TM    NUCMLFLG,X'E0'      NEED REASSIGN                                
         BZ    BLDUN35                                                          
         OI    UNTFLG,X'80'                                                     
         OI    SVPRGFLG,PRGFAXCG   SET FLAG TO SHOW CHANGE                      
         TM    SVOPTSW1,OPTHDCPY   ONLY NEED THIS ON FOLLOW-UP                  
         BZ    BLDUN35                                                          
         TM    NUCMLFL2,NUCMLACK   HAS ERROR BEEN SEEN BY NINS?                 
         BZ    BLDUN35              NO                                          
         OI    UNTFLG1,UNTFLGAK                                                 
*                                                                               
BLDUN35 TM     NUCMLFLG,X'10'      INSTR RUN FOR THIS UNIT                      
         BZ    BLDUN36                                                          
         OI    UNTFLG,X'20'                                                     
*                                                                               
         TM    NUCMLFL2,NUCMLFLP   NEEDS TO BE REPRINTED ON INSTR               
         BZ    BLDUN36                                                          
         OI    UNTFLG1,UNTFLGPR    SET NEEDS REPRINTING ON INSTR                
*                                                                               
BLDUN36 MVC    UNTREVN,NUCMLREV                                                 
         TM    NUCMLFLG,X'01'      INVERT PRODUCTS & COMMERCIALS                
         BZ    BLDUN38                                                          
*                                                                               
         TM    NUCMLFLG,X'40'      WAS PRODUCT CHANGED                          
         BZ    BLDUN36F             NO                                          
         OC    UNTPROD2,UNTPROD2   IF NO P/B PROD, FORGET IT                    
         BZ    BLDUN38                                                          
*                                                                               
* SWAP PRODS AND CMLS                                                           
*                                                                               
BLDUN36F XC    UNTPROD,UNTPROD2                                                 
         XC    UNTPROD2,UNTPROD                                                 
         XC    UNTPROD,UNTPROD2                                                 
         XC    UNTCML1,UNTCML2                                                  
         XC    UNTCML2,UNTCML1                                                  
         XC    UNTCML1,UNTCML2                                                  
*                                                                               
         NI    BYTE,0              SET OFF CML1/2 BITS                          
         TM    UNTADIFL,UNTADIF1                                                
         BZ    *+8                                                              
         OI    BYTE,UNTADIF2                                                    
*                                                                               
         TM    UNTADIFL,UNTADIF2                                                
         BZ    *+8                                                              
         OI    BYTE,UNTADIF1                                                    
*                                                                               
         NI    UNTADIFL,X'FF'-UNTADIF1                                          
*                                                                               
         OC    UNTADIFL,BYTE       SET ON BITS IF NEEDED                        
*                                                                               
         OC    UNTPROD,UNTPROD     IF NO P/B PROD, PROBLEMS                     
         BNZ   *+6                                                              
         DC    H'0'                                                             
         DROP  R6                                                               
         EJECT                                                                  
* IS THIS A FEED ? *                                                            
*                                                                               
BLDUN38 MVI    ELCODE,X'22'                                                     
         L     R6,NBAIO                                                         
         BRAS  RE,GETEL                                                         
         BNE   *+10                                                             
         MVC   UNTFEED,2(R6)                                                    
*                                                                               
* BLANK FILL END OF PROGRAM NAME *                                              
*                                                                               
         LA    R0,16                                                            
         LA    R1,NBPROGNM+15                                                   
         CLI   0(R1),0                                                          
         BNE   *+16                                                             
         MVI   0(R1),C' '                                                       
         BCTR  R1,0                                                             
         BCT   R0,*-14                                                          
         DC    H'0'                                                             
*                                                                               
* TEST FOR STANDARD PROGRAM NAME *                                              
*                                                                               
         CLC   SVPRGNM,NBPROGNM   SAME AS PROGRAM REC NAME                      
         BE    BLDUN48                                                          
         LA    R0,28              MAX NON-STD PROG NAMES                        
         L     R1,AIO3                                                          
         LA    R1,480(,R1)                                                      
         LA    RF,1               POINTER CT TO ENTRY                           
BLDUN40 OC     0(16,R1),0(R1)     EMPTY SLOT                                    
         BZ    BLDUN42                                                          
         CLC   NBPROGNM,0(R1)                                                   
         BE    BLDUN46                                                          
         LA    R1,16(,R1)                                                       
         LA    RF,1(,RF)                                                        
         BCT   R0,BLDUN40                                                       
         MVI   UNTEXNAM,X'FF'     MORE THAN 14 NON-STD PROG NAMES!              
         B     BLDUN48                                                          
BLDUN42 MVC    0(16,R1),NBPROGNM                                                
*                                                                               
BLDUN46 STC    RF,UNTEXNAM                                                      
*                                                                               
BLDUN48 MVC    SVUNTCOM,UNTCOM     SAVE FOR POSSIBLE FEED(S)                    
         TM    UPDSW,UNTFDDSW      FEED NO NATIONAL                             
         BO    BLDUN49              YES                                         
         LH    RE,UNITCT           ADD TO UNIT CT                               
         LA    RE,1(,RE)                                                        
         STH   RE,UNITCT                                                        
         LA    R5,UNTNEXT                                                       
         C     R5,AUNTABLX         AT END OF TABLE                              
         BNL   UNTSIZER                                                         
         XC    0(L'UNTENT+2,R5),0(R5)                                           
         EJECT                                                                  
* GET ANY POSSIBLE FEEDS *                                                      
*                                                                               
BLDUN49 DS     0H                                                               
         MVI   SVMYEAR,0           INIT MAP YEAR                                
         XC    SVMCODE,SVMCODE     AND MAP CODE                                 
*                                                                               
         MVI   ELCODE,X'18'        DATA ELEMENT                                 
         L     R6,NBAIO                                                         
         BRAS  RE,GETEL                                                         
         BNE   BLDUN49F                                                         
*                                                                               
         USING NUDTAD,R6                                                        
         CLI   NUDTAMYR,0          ANY MAP YEAR                                 
         BE    BLDUN49F                                                         
         CLI   NUDTAMYR,X'5C'      TO BYPASS NELSON'S BUG                       
         BE    BLDUN49F                                                         
         OC    NUDTAMCD,NUDTAMCD   ANY MAP CODE                                 
         BZ    BLDUN49F                                                         
*                                                                               
         MVC   SVMYEAR,NUDTAMYR    SAVE MAP YEAR                                
         MVC   SVMCODE,NUDTAMCD    SAVE MAP CODE                                
*                                                                               
         DROP  R6                                                               
*                                                                               
BLDUN49F L     R6,NBAIO                                                         
         MVI   ELCODE,X'23'                                                     
         BRAS  RE,GETEL                                                         
         BNE   BLDUN60                                                          
         USING NUFDCEL,R6                                                       
*                                                                               
         TM    UPDSW,UNTFDDSW      FEED NO NATIONAL                             
         BO    BLDUN50              YES                                         
* GO BACK TO PREV ENTRY AND SET UNTFLG1 - NAT'L UNIT W/FEEDS                    
         LR    RF,R5                                                            
         AHI   RF,-L'UNTENT        RF = A(PREV ENTRY)                           
*                                                                               
         OI    UNTFLG1-UNTENT(RF),UNTFLGNF   SET NAT'L UNIT W/FEEDS             
*                                                                               
BLDUN50 TM     NUFDCFL2,X'81'      MEDIA FEED DELETED                           
         BO    BLDUN58              YES, BYPASS                                 
*                                                                               
         TM    UPDSW,UNTFDDSW      FEED NO NATIONAL                             
         BZ    *+8                  NO                                          
         OI    UNTFLG2,UNITFDD                                                  
*                                                                               
         MVC   UNTCOM,SVUNTCOM     GET COMMON STUFF                             
         MVC   UNTREVN,NUFDCREV                                                 
*                                                                               
         CLI   SVTN2PRC,C'Y'       SHOW ESTIMATE ?                              
         BNE   *+10                 NO                                          
         MVC   UNTEST,NBACTEST     SAVE ESTIMATE NUMBER                         
*                                                                               
         TM    NBUNST3,X'40'       COPY SPLIT                                   
         BO    BLDUN50B             YES                                         
*                                                                               
         CLI   SVCSPROD,0          TRI-BACK                                     
         BE    BLDUN52              NO                                          
         DC    H'0'                BUG?                                         
*                                                                               
BLDUN50B DS    0H                                                               
*                                                                               
         LA    R2,NUFDPROD         PRESET                                       
         CLC   NUFDPROD,NBPR1CL3                                                
         BE    BLDUN51                                                          
         CLC   NUFDPROD,NBPR2CL3                                                
         BE    BLDUN51                                                          
*                                                                               
         LA    RE,L'SVCSPROD                                                    
         LA    RF,SVCSPROD                                                      
*                                                                               
BLDUN50F CLI   0(RF),0                                                          
         BE    BLDUN52                                                          
         CLC   0(3,R2),0(RF)       PROD FROM REC TO C/S                         
         BE    BLDUN51                                                          
         LA    RF,3(,RF)                                                        
         AHI   RE,-2                                                            
         BCT   RE,BLDUN50F                                                      
         B     BLDUN52                                                          
*                                                                               
BLDUN51 TM     UNTFLG1,UNTFL3TB    TRI-BACK ?                                   
         BO    BLDUN52                                                          
         MVC   UNTPROD,0(R2)       3 CHAR PROD                                  
*                                                                               
BLDUN52 TM     UNTFLG,X'80'        NEED REASSIGN                                
         BO    BLDUN54             YES, TREAT AS UNASSIGNED                     
*                                                                               
         TM    NUFDCFL3,NUFDCNEW                                                
         BZ    *+8                                                              
         OI    UNTFLG1,UNTFLGNW    SET NEWLY ASGND CML                          
*                                                                               
         MVC   UNTCML1(16),NUFDCML1                                             
         MVC   UNTBBSN(16),NUFDCBSN  IF TRI-BACK THEN ITS UNTCML3               
*                                                                               
         MVC   UNTADIFL,NUFDADFL     SAVE ADID FLAGS                            
*                                                                               
BLDUN54  MVC   UNTBBSL,NUFDCBSL                                                 
         MVC   UNTBBPOS,NUFDCBPS                                                
         MVC   UNTPOS,NUFDCPOS                                                  
         MVC   UNTDSKAD,NBKEY+21                                                
*                                                                               
         CLI   SVMYEAR,0           IS THIS SECTIONAL FEED                       
         BE    BLDUN56F                                                         
         MVC   UNTMYR,SVMYEAR      MAP YEAR                                     
*                                                                               
         LHI   R1,MCODETBL-SYSD                                                 
         AR    R1,R9                                                            
         LR    RF,R1                                                            
         LA    RE,L'MCODETBL(R1)   END OF TABLE                                 
*                                                                               
         OC    0(8,R1),0(R1)       EMPTY?                                       
         BZ    BLDUN56C             YES                                         
         CLC   0(8,R1),SVMCODE     SAME ENTRY                                   
         BE    BLDUN56D                                                         
         LA    R1,8(R1)                                                         
         CR    R1,RE                                                            
         BL    *-26                                                             
         DC    H'0'                MAKE MAP CODE TABLE BIGGER                   
*                                                                               
BLDUN56C MVC   0(8,R1),SVMCODE     SAVE MAP CODE IN TABLE                       
*                                                                               
BLDUN56D SR    R1,RF               GET DISP INTO MAP CODE TABLE                 
         LA    R1,1(R1)                                                         
         STC   R1,UNTMCDP          AND SAVE THE POINTER                         
*                                                                               
BLDUN56F DS    0H                                                               
         TM    NUFDCFL2,NUFDCFLP   NEEDS TO BE REPRINTED ON INSTR               
         BZ    *+8                                                              
         OI    UNTFLG1,UNTFLGPR    SET NEEDS REPRINTING ON INSTR                
*                                                                               
         OC    UNTPOS,UNTPOS       THIS A TBA                                   
         BNZ   *+8                  NO                                          
         MVI   UNTPOS,X'FF'                                                     
*                                                                               
         MVC   UNTFEED,NUFDCFED                                                 
         TM    UNTFLG2,UNITFDD     FEED NO NATIONAL ?                           
         BO    *+8                  YES                                         
         OI    UNTFLG,X'08'        SET ON FEED TO NATIONAL UNIT                 
*                                                                               
         TM    NUFDCFL2,X'01'      MEDIA FEED                                   
         BZ    *+8                  NO                                          
         OI    UNTFLG,X'01'        SET MEDIA ORIGINATED FEED                    
*                                                                               
         TM    NUFDCFL2,X'80'      MEDIA FEED DELETED                           
         BZ    *+8                  NO                                          
         OI    UNTFLG,X'40'        SET MEDIA DELETED FEED                       
*                                                                               
         LH    RE,UNITCT           ADD TO UNIT CT                               
         LA    RE,1(,RE)                                                        
         STH   RE,UNITCT                                                        
         LA    R5,UNTNEXT                                                       
         C     R5,AUNTABLX         AT END OF TABLE                              
         BNL   UNTSIZER                                                         
BLDUN58 XC     0(L'UNTENT+2,R5),0(R5)                                           
         BRAS  RE,NEXTEL                                                        
         BE    BLDUN50                                                          
*                                                                               
BLDUN60 XC     UNTENT(L'UNTENT+2),UNTENT                                        
         LLC   RF,SVUNTCT                                                       
         LA    RF,1(,RF)           ADD TO RECORD CT                             
         STC   RF,SVUNTCT                                                       
                                                                                
* SET FLAG FOR PIGGYBACK/COPYSPLIT COMMENT*                                     
                                                                                
         TM    NBUNST3,X'40'       COPY SPLIT?                                  
         BZ    BLDUN61A                                                         
         OI    SVFLAG1,X'10'       SET TO PRINT COMMENT                         
         B     BLDUN61B            ASSUME NOT BOTH C/S AND P/B                  
*                                                                               
BLDUN61A CLI   NBPR2CL3,C' '       PIGGYBACK PROD ?                             
         BNH   *+8                                                              
         OI    SVFLAG1,X'20'       PRINT PIGGYBACK COMMENT                      
*                                                                               
BLDUN61B OC    SVUNTCOM,SVUNTCOM   ANY UNIT INFO                                
         BZ    BLDUN62                                                          
*                                                                               
         TM    NBUNITST,X'42'      PREEMPT OR MISSED                            
         BNZ   BLDUN62                                                          
*                                                                               
         TM    UNTFLG,X'40'        DELETED                                      
         BNZ   BLDUN62                                                          
*                                                                               
         L     R1,NBAIO                                                         
         TM    22(R1),X'80'       THIS RECORD DELETED                           
         BNZ   BLDUN62                                                          
*                                                                               
         BAS   RE,GCUT             GO GET ANY CUTINS                            
*                                                                               
BLDUN62 DS     0H                                                               
         TM    SECFLAG,BLSSW       BRAND LEVEL SECURITY CLIENT                  
         BZ    BLDUN63                                                          
*                                                                               
         CLI   T216FFD+6,C'$'      USER SIGN ON OFFICE LIST                     
         BNE   *+18                                                             
         OI    NBINDS5,NBI5PLST    SET OFFICE LIST FLAG                         
         MVC   NBSECSV,ASECBLK     PASS ADDRESS OF SECURITY BLOCK               
         B     *+12                                                             
         CLI   T216FFD+6,C'*'      USER SIGN ON BY OFFICE                       
         BNE   BLDUN63              NO                                          
*                                                                               
         MVC   NBTRAPSC,T216FFD+7  BRAND LEVEL OFFICE(LIST)                     
*                                                                               
BLDUN63 GOTO1 ANETIO,DMCB,(R3)                                                  
         MVI   NBUSER+13,C'N'      DO NOT SUPPRESS PRE-EMPTS                    
         CLI   NBERROR,NBGOOD                                                   
         BE    BLDUN64                                                          
         DC    H'0'                                                             
*                                                                               
BLDUN64 DS     0H                                                               
         TM    NBSUBMSK,NBSBMCLI+NBSBMNET+NBSBMPRG                              
         BNZ   BLDUN70                                                          
         CLI   NBMODE,NBREQLST                                                  
         BE    BLDUN70                                                          
         CLI   NBMODE,NBPROCUN                                                  
         BNE   BLDUN60                                                          
         L     R1,APRGTBLE                                                      
         USING PRGTABLED,R1                                                     
*                                                                               
BLDUN66  CLC   NBACTPRG,PRGPRG                                                  
         BE    BLDUN68                                                          
         LA    R1,PRGNEXT                                                       
*PRG                                                                            
         C     R1,APRGTBLX           AT END OF TABLE                            
         BL    *+6                                                              
         DC    H'0'                BUG, PROGRAM S/B BE IN PROG TABLE            
*PRG                                                                            
         OC    PRGPRG,PRGPRG                                                    
*PRG     BNZ   *-20                                                             
         BNZ   BLDUN66                                                          
         DC    H'0'                BUG, PROGRAM S/B BE IN PROG TABLE            
*                                                                               
BLDUN68 TM     PRGFLG,PRGXCLUD     EXCLUDE THIS PROGRAM?                        
         BZ    BLDUN10              NO                                          
         MVI   NBMODE,NBREQLST     DONE WITH THIS PROG                          
         LLC   RF,SVUNTCT                                                       
         BCTR  RF,0                ADJ RECORD CT                                
         STC   RF,SVUNTCT                                                       
         B     BLDUN60             GET NEXT PROGRAM                             
*                                                                               
         DROP  R1                                                               
*                                                                               
BLDUN70 DS    0H                                                                
         LHI   RE,EQVPTBL-SYSD                                                  
         AR    RE,R9                                                            
         LA    RF,L'EQVPTBL/(EQVNEXT-EQVENT)                                    
         USING EQVPTBLD,RE                                                      
BLDUN72 OC     EQVENT,EQVENT       EMPTY ENTRY IS END                           
         BZ    BLDUN80                                                          
         CLC   EQVBPRG,SVPRG       THIS SAME AS CURRENT                         
         BNE   BLDUN74                                                          
         CLI   EQVUSED,C'Y'        ENTRY HAVE UNITS & NOT BEEN USED             
         BE    BLDUN76                                                          
BLDUN74 LA     RE,EQVNEXT                                                       
         BCT   RF,BLDUN72                                                       
*                                                                               
         B     BLDUN80                                                          
*                                                                               
BLDUN76 MVI    EQVUSED,C'U'        SET TO USED                                  
         MVC   BASEPRG,EQVEPRG                                                  
         MVC   BASEDTS,EQVDTS                                                   
*                                                                               
         CLC   BASEEND,ENDATEP     IS END DATE PAST PERIOD END                  
         BNH   *+10                                                             
         MVC   BASEEND,ENDATEP     CUTAIL END DATE                              
*                                                                               
         MVC   BASECT,EQVCT        SAVE ENTRY CT                                
         DROP  RE                                                               
         BRAS  RE,ININETIO                                                      
*                                                                               
BLDUN78 DS     0H                                                               
         TM    SECFLAG,BLSSW       BRAND LEVEL SECURITY CLIENT                  
         BZ    BLDUN79                                                          
*                                                                               
         CLI   T216FFD+6,C'$'      USER SIGN ON OFFICE LIST                     
         BNE   *+18                                                             
         OI    NBINDS5,NBI5PLST    SET OFFICE LIST FLAG                         
         MVC   NBSECSV,ASECBLK     PASS ADDRESS OF SECURITY BLOCK               
         B     *+12                                                             
         CLI   T216FFD+6,C'*'      USER SIGN ON BY OFFICE                       
         BNE   BLDUN79              NO                                          
*                                                                               
         MVC   NBTRAPSC,T216FFD+7  BRAND LEVEL OFFICE(LIST)                     
*                                                                               
BLDUN79 GOTO1 ANETIO,DMCB,(R3)                                                  
         MVI   NBUSER+13,C'N'      DO NOT SUPPRESS PRE-EMPTS                    
         CLI   NBERROR,NBGOOD                                                   
         BE    *+6                                                              
         DC    H'0'                                                             
         CLI   NBMODE,NBREQLST                                                  
         BE    BLDUN70                                                          
         CLI   NBMODE,NBPROCUN                                                  
         BNE   BLDUN78                                                          
         CLC   NBACTPRG,NBSELPRG                                                
         BNE   BLDUN70                                                          
         B     BLDUN10                                                          
*                                                                               
BLDUN80 DS     0H                                                               
         MVI   DATADISP+1,24       SET FROM NET TO SPOT                         
         LH    R2,UNITCT                                                        
*                                                                               
         CLI   SVTN1PR5,C'C'       OPTION TO PRINT CHANGES ONLY                 
         BNE   BLDUN85                                                          
         L     R5,AUNTABLE                                                      
         USING UNTABLED,R5                                                      
         LR    R0,R2                                                            
*                                                                               
         CLC   UNTREVN,SVPRGRVN    CHANGED THIS REVISION                        
         BE    BLDUN85             AT LEAST 1 FOUND, GO ON                      
         LA    R5,UNTNEXT                                                       
         BCT   R0,*-14                                                          
         OI    SVPRGFLG,PRGFLGNU     SET ON NO UNITS FLAG                       
*                                                                               
BLDUN85 LTR    R2,R2               ANY UNITS FOUND                              
         BNZ   *+6                                                              
         DC    H'0'                                                             
*                                                                               
         TM    UPDSW,X'02'         ONLY SKED UNITS                              
         BO    BLDUNTX             YES, NO SORT                                 
*                                                                               
* CAN'T HAVE CUTINS ON SKED UNITS                                               
*                                                                               
         XC    DMCB(24),DMCB                                                    
         MVI   DMCB+15,15                                                       
         MVI   DMCB+19,1                                                        
*                                                                               
         TM    UPDSW2,UNTCUTIN     NEED SORT INCLUDING EXNAM                    
         BO    *+12                                                             
*                                                                               
         CLI   SVTNPR13,C'Y'       FORCE PAGE BREAK ON PROG NAME                
         BNE   *+12                                                             
         MVI   DMCB+15,16                                                       
         MVI   DMCB+19,0                                                        
*                                                                               
         NI    UPDSW2,X'FF'-UNTCUTIN     SET OFF FOR HDHK                       
*                                                                               
         TM    SVOPTSW2,OPTPBRK    GROUP PRODUCTS TOGETHER                      
         BO    BLUNT100             YES                                         
*                                                                               
         GOTO1 QSORT,DMCB,AUNTABLE,(R2),L'UNTENT                                
         B     BLDUNTX                                                          
*                                                                               
BLUNT100 GOTO1 VXSORT,DMCB,AUNTABLE,(R2),L'UNTENT,4,UNTPROD-UNTENT              
         GOTO1 VXSORT,DMCB,AUNTABLE,(R2),L'UNTENT                               
*                                                                               
BLDUNTX  XIT1                                                                   
         EJECT                                                                  
* FILTER ON PRODUCT GROUP *                                                     
*                                                                               
FPGR     NTR1                                                                   
         LA    R0,VOPTPGRL                                                      
         LHI   R1,VOPTPGRO-SYSD                                                 
         AR    R1,R9                                                            
FPGR10   CLC   NBPR1CL3,0(R1)                                                   
         BE    FPGREQ                                                           
*                                                                               
         CLI   SVCSPROD,0                                                       
         BE    FPGR20                                                           
         LA    RE,L'SVCSPROD                                                    
         LA    RF,SVCSPROD                                                      
FPGR14   CLI   0(RF),0                                                          
         BE    FPGR20                                                           
         CLC   0(3,R1),0(RF)                                                    
         BE    FPGREQ                                                           
         LA    RF,3(,RF)                                                        
         AHI   RE,-2                                                            
         BCT   RE,FPGR14                                                        
*                                                                               
FPGR20   LA    R1,3(,R1)                                                        
         CLI   0(R1),0                                                          
         BNH   *+8                                                              
         BCT   R0,FPGR10                                                        
         CR    RD,RB                                                            
         B     FPGRX                                                            
FPGREQ   CR    RB,RB                                                            
FPGRX    XIT1                                                                   
         EJECT                                                                  
* GET ANY CUTINS *                                                              
*                                                                               
         USING UNTABLED,R5                                                      
GCUT     NTR1                                                                   
*                                                                               
* SEE IF ANY CUTIN COMML ELEM                                                   
*                                                                               
         XC    BLOCK(256),BLOCK    CLEAR AREA FOR CUTIN COMMLS                  
         BRAS  RE,INITNET          SWITCH TO NET                                
*                                                                               
         L     R6,NBAIO                                                         
         MVI   ELCODE,X'17'                                                     
         BRAS  RE,GETEL                                                         
         BNE   GCUT20                                                           
*                                                                               
         LLC   RF,1(R6)                                                         
         BCTR  RF,0                LESS 1 FOR MOVE                              
         EX    RF,GCUTMVC                                                       
         B     GCUT20                                                           
         B     *+10                                                             
GCUTMVC  MVC   BLOCK(0),0(R6)                                                   
*                                                                               
         LA    R2,BLOCK+2                                                       
         LLC   R4,BLOCK+1                                                       
         SRL   R4,8                DIVIDE BY 8, AND DROP 2 EXTRA                
         LA    R4,1(R4)                                                         
*                                                                               
         MVC   UNTCOM,SVUNTCOM                                                  
*                                                                               
GCUT10   DS    0H                                                               
         MVC   SVCMLCOD,0(R2)                                                   
*                                                                               
         BRAS  RE,FCML              FIND CML RECORD                             
         BE    GCUT14                                                           
*                                                                               
         MVC   0(8,R2),=C'REASSIGN'                                             
*                                                                               
GCUT14   DS    0H                                                               
         LA    R2,8(R2)                                                         
         BCT   R4,GCUT10                                                        
*                                                                               
GCUT20   DS    0H                                                               
         BRAS  RE,INITNET          SWITCH TO NET (FCML USES SPOT)               
*                                                                               
         L     R6,NBAIO                                                         
         MVI   ELCODE,X'03'                                                     
         BRAS  RE,GETEL                                                         
         BNE   GCUTX                                                            
*                                                                               
GCUT30   DS    0H                                                               
         USING NUSPRD,R6                                                        
         CLI   NUSPRTYP,C'U'       BYPASS ALL OTHERS                            
         BNE   GCUT80                                                           
*                                                                               
         CLI   NUSPRLEN,NUSPRLN1   BYPASS OLD ELEMS                             
         BE    GCUT80                                                           
*                                                                               
         OC    NUSPRCIS,NUSPRCIS   ANY CUTIN STATION?                           
         BZ    GCUT80               NO                                          
*                                                                               
         CLI   NUSPRLEN,NUSPRLN4   FIXED LEN 3 CHAR ELEM                        
         BNE   GCUT31               NO                                          
*                                                                               
         OC    NUSPRTPC,NUSPRTPC   ANY 3 CHAR PRODUCT?                          
         BZ    GCUT80               NO                                          
         B     GCUT33                                                           
*                                                                               
* NON 3 CHAR X'03' ELEM                                                         
*                                                                               
GCUT31   CLI   NUSPRTPR,0          ANY PRODUCT?                                 
         BE    GCUT80               NO                                          
*                                                                               
         LA    R2,NCLSTSIZ         FIND 3 CHAR PROD                             
         L     RE,ASVNCLST                                                      
*                                                                               
GCUT31F  CLC   NUSPRTPR,3(RE)                                                   
         BE    GCUT32                                                           
         LA    RE,4(RE)                                                         
         CLI   0(RE),C' '                                                       
         BNH   *+8                                                              
         BCT   R2,GCUT31F                                                       
*                                                                               
GCUT32   MVC   SVPROD,0(RE)        MOVE 3 CHAR PROD                             
         B     *+10                                                             
GCUT33   MVC   SVPROD,NUSPRTPC                                                  
*                                                                               
         MVC   UNTCOM,SVUNTCOM                                                  
         MVC   UNTDSKAD,NBKEY+21                                                
         MVC   UNTSLN,NBLEN                                                     
         MVC   UNTPROD,SVPROD      MOVE 3 CHAR PROD                             
         XC    SVPROD,SVPROD                                                    
         XC    UNTPROD2,UNTPROD2                                                
         MVI   UNTSLN2,0                                                        
*                                                                               
         CLI   SVMYEAR,0           IS THIS SECTIONAL FEED                       
         BE    GCUT39                                                           
         MVC   UNTMYR,SVMYEAR      MAP YEAR                                     
*                                                                               
*        LA    R1,MCODETBL         START OF MAP CODE TABLE                      
         LHI   R1,MCODETBL-SYSD                                                 
         AR    R1,R9                                                            
         LR    RF,R1                                                            
         LA    RE,L'MCODETBL(R1)   END OF TABLE                                 
*                                                                               
         OC    0(8,R1),0(R1)       EMPTY?                                       
         BZ    GCUT35               YES                                         
         CLC   0(8,R1),SVMCODE     SAME ENTRY                                   
         BE    GCUT37                                                           
         LA    R1,8(R1)                                                         
         CR    R1,RE                                                            
         BL    *-26                                                             
         DC    H'0'                MAKE MAP CODE TABLE BIGGER                   
*                                                                               
GCUT35   MVC   0(8,R1),SVMCODE     SAVE MAP CODE IN TABLE                       
*                                                                               
*                                                                               
GCUT37   SR    R1,RF               GET DISP INTO MAP CODE TABLE                 
         LA    R1,1(R1)                                                         
         STC   R1,UNTMCDP          AND SAVE THE POINTER                         
*                                                                               
GCUT39   DS    0H                                                               
         CLI   OFFLINE,C'Y'        ONLY NEEDED ONLINE                           
         BE    GCUT40                                                           
*                                                                               
         GOTO1 VSWITCH,DMCB,=C'SPT'                                             
*                                                                               
GCUT40   DS    0H                                                               
         XC    ELEM,ELEM                                                        
         LA    R1,ELEM                                                          
*                                                                               
         USING STAPACKD,R1                                                      
         MVI   STAPACT,C'U'                                                     
         MVC   STAPAGY,AGENCY                                                   
         MVC   STAPCTRY,SPOTCAN                                                 
         MVC   STAPMED,QMED                                                     
         MVC   STAPACOM,ACOMFACS                                                
         MVC   STAPMKST,NUSPRCIS   MARKET/STATION                               
*                                                                               
         GOTO1 STAPACK,(R1)                                                     
         CLI   STAPERR,0                                                        
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   UNTPOS,STAPQSTA       STATION CALL LETTERS                       
         MVC   UNTCML3+4(4),STAPQMKT MARKET NUMBER                              
         DROP  R1                                                               
*                                                                               
* BUILD A TABLE OF STATION CALL LETTERS TO SORT BY CALL LETTERS *               
*                                                                               
         LA    R0,40                                                            
         LA    R1,BLOCK+256                                                     
         LA    RF,X'FE'                                                         
GCUT44   DS    0H                                                               
         OC    0(4,R1),0(R1)       EMPTY ENTRY?                                 
         BZ    GCUT46                                                           
         CLC   UNTPOS,0(R1)        THIS SAME STA?                               
         BE    GCUT48                                                           
*                                                                               
         BCTR  RF,0                                                             
         LA    R1,4(,R1)                                                        
         BCT   R0,GCUT44                                                        
         DC    H'0'                                                             
*                                                                               
GCUT46   DS    0H                                                               
         MVC   0(4,R1),UNTPOS                                                   
GCUT48   DS    0H                                                               
         STC   RF,UNTEXNAM                                                      
*                                                                               
         MVC   UNTREVN,NUSPRREV                                                 
*                                                                               
         CLI   OFFLINE,C'Y'        ONLY NEEDED ONLINE                           
         BE    GCUT50                                                           
*                                                                               
         GOTO1 VSWITCH,DMCB,=C'NET'                                             
*                                                                               
GCUT50   DS    0H                                                               
         OI    UNTFLG2,UNTFLCUT    SET AS CUTIN                                 
         OI    UPDSW2,UNTCUTIN     SET ON FOR SORT AT END OF BLDUNT             
*                                                                               
         TM    NUSPRSTA,X'80'      PROD CHANGED?                                
         BZ    *+8                                                              
         OI    UNTFLG,X'80'        SET NEED REASSIGN                            
*                                                                               
         CLI   NUSPRLEN,NUSPRLN4   FIXED LEN 3 CHAR ELEM                        
         BNE   GCUT55               NO                                          
         OC    NUSPRFED,NUSPRFED       FEED                                     
         BZ    GCUT60               NO FEED INFO                                
         MVC   UNTFEED,NUSPRFED                                                 
         OC    UNTFEED,SPACES                                                   
         B     GCUT60                                                           
*                                                                               
GCUT55   CLI   1(R6),NUSPRFED-NUSPREL                                           
         BE    GCUT60               NO FEED INFO                                
*                                                                               
         LLC   R1,1(R6)            GET ELEM LEN                                 
         AHI   R1,-((NUSPRFED-NUSPREL)+1)                                       
         EX    R1,GCUTFD                                                        
         OC    UNTFEED,SPACES                                                   
         B     GCUT60                                                           
*                                                                               
GCUTFD   MVC   UNTFEED(0),NUSPRFED                                              
*                                                                               
GCUT60   DS    0H                                                               
         CLI   NUSPRCMI,0          IS THERE A COMML?                            
         BE    GCUT70               NO                                          
*                                                                               
         LLC   RF,NUSPRCMI         GET POINTER TO COMML                         
         BCTR  RF,0                                                             
         SLL   RF,3                TIMES 8                                      
         LA    RE,BLOCK+2(RF)                                                   
         MVC   UNTCML1,0(RE)                                                    
         OC    UNTCML1,UNTCML1     THERE HAD BETTER BE SOMETHING                
         BNZ   GCUT70                                                           
         DC    H'0'                                                             
GCUT70   DS    0H                                                               
         LH    RE,UNITCT           ADD TO UNIT CT                               
         LA    RE,1(,RE)                                                        
         STH   RE,UNITCT                                                        
         LA    R5,UNTNEXT                                                       
*                                                                               
         XC    0(L'UNTENT+2,R5),0(R5)                                           
*                                                                               
GCUT80   DS    0H                                                               
         BRAS  RE,NEXTEL                                                        
         BE    GCUT30                                                           
*                                                                               
         MVC   KEYSAVE,NBKEY                                                    
         GOTO1 DATAMGR,DMCB,(X'08',=C'DMRDHI'),=C'UNTDIR',KEYSAVE,KEY           
         CLC   KEY(20),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
GCUTX    XIT1  REGS=(R5)                                                        
         DROP  R5                                                               
         EJECT                                                                  
* FILTER ON PRODUCT GROUP *                                                     
                                                                                
UNTSIZER MVC   GERROR,=Y(MANYUNT)                                               
         XC    ELEM,ELEM                                                        
         LA    R1,ELEM                                                          
         STCM  R1,7,GASUBST        A(SUBST TEXT)                                
         MVI   ELEM,3              L'SUBST TEXT + 1                             
         MVC   ELEM+1(2),=C'95'                                                 
         LA    R2,TRACLTH                                                       
         GOTO1 VTRAERR                                                          
         LTORG                                                                  
         DROP  R7                                                               
         EJECT                                                                  
*=============================================================                  
* BUILD PRINT LINE(S) FOR ALL UNITS FOR 1 INSTRUCTION                           
*=============================================================                  
                                                                                
BLDLIN   NTR1  BASE=*,LABEL=*                                                   
         USING UNTABLED,R5                                                      
*                                                                               
         OI    UPDSW,X'20'         SET ON PRINT UNITS SW                        
*                                                                               
         XC    SVDESC,SVDESC                                                    
         XC    SVFEED,SVFEED                                                    
         MVI   SVMYEAR,0                                                        
         MVI   SVMCODEP,0                                                       
*                                                                               
         CLI   UNTADTEP,0          ANY UNITS?                                   
         BNE   *+6                                                              
         DC    H'0'                                                             
*&&DO                                                                           
*VEN     TM    SVOPTSW2,OPTOVFAX   DOING OV-FAX NOW?                            
*        BO    BLDL20               YES                                         
*                                                                               
*        CLI   SVTWPR06,C'2'       HARD COPY ONLY                               
*        BNE   BLDL20                                                           
*                                                                               
*        CLI   OFFLINE,C'Y'        PUT TO TSAROFF                               
*        BNE   BLDL20                                                           
*                                                                               
*        CLI   SVTWPR07,C'Y'       PRINT FAX COPY NOW                           
*        BNE   BLDL20                                                           
*                                                                               
*        MVI   SPACING,2                                                        
*VEN     BRAS  RE,GOSPL                                                         
*&&                                                                             
BLDL20   TM    UNTFLG,X'20'        EVER PRINTED ON INSTR                        
         BO    BLDL24               YES                                         
         TM    UNTFLG,X'52'        DELETED (MEDIA/TRAFFIC OR MISSED)            
         BNZ   BLDL186              BYPASS                                      
*                                                                               
BLDL24   DS    0H                                                               
         TM    UNTFLG2,UNTFLCUT    SET AS CUTIN                                 
         BZ    BLDL26                                                           
*                                                                               
         MVC   SVUNTPOS,UNTPOS     SAVE CALL LETTERS FOR HEADHOOK               
         MVC   SVUNTMKT,UNTCML3+4  SAVE MARKET FOR HEADHOOK                     
         XC    UNTCML3,UNTCML3                                                  
*                                                                               
BLDL26   DS    0H                                                               
         CLI   SVPRGRVN,0          THIS ORIGINAL                                
         BE    BLDL28               PRINT IT ALL                                
*                                                                               
         CLI   SVTN1PR5,C'C'       PRINT CHANGES ONLY                           
         BNE   BLDL28               PRINT IT ALL                                
*                                                                               
         CLC   SVPRGRVN,UNTREVN    THIS CHANGED THIS REVSION                    
         BE    BLDL28                                                           
*                                                                               
         TM    UNTFLG,X'52'        DELETED (MEDIA/TRAFFIC OR MISSED)            
         BZ    BLDL186              BYPASS                                      
*                                                                               
         TM    UNTFLG,X'20'        DELETED ALREADY PRINTED ON INSTR             
         BO    BLDL186              BYPASS                                      
*                                                                               
BLDL28   DS   0H                                                                
         TM    UNTFLG2,UNTFLCUT    THIS A CUTIN?                                
         BO    BLDL32               YES                                         
*                                                                               
BLDL30   DS   0H                                                                
         CLI   SVTNPR13,C'Y'       FORCE PAGE ON PROG NAME                      
         BNE   BLDL60                                                           
*                                                                               
BLDL32   DS   0H                                                                
         CLC   SVEXNAM,UNTEXNAM    CHANGE IN NAME                               
         BE    BLDL60               NO                                          
*                                                                               
         MVC   SVEXNAM,UNTEXNAM    SAVE CHANGE IN NAME                          
*                                                                               
         CLI   UNTEXNAM,0          FOR PBREAK                                   
         BNE   BLDL34                                                           
         MVC   SVPRGNM,SVSTDNM     RESTORE STANDARD NAME                        
         B     BLDL50                                                           
*                                                                               
BLDL34   DS   0H                                                                
         TM    UNTFLG2,UNTFLCUT    SET AS CUTIN?                                
         BO    BLDL40               YES                                         
*                                                                               
         CLI   UNTEXNAM,X'FF'      MORE THAN 14                                 
         BNE   BLDL36                                                           
*                                                                               
         LA    R0,UNTDSKAD                                                      
         MVI   RDUPDATE,C'N'                                                    
         BRAS  RE,UNTFGET                                                       
         L     RF,AIO1                                                          
         LA    RF,NUPROGNM-NURECD(RF)                                           
         B     BLDL38                                                           
*                                                                               
BLDL36   LLC   RE,UNTEXNAM                                                      
         BCTR  RE,0                                                             
         SLL   RE,4               TIMES 16                                      
         L     RF,AIO3                                                          
         LA    RF,480(RE,RF)                                                    
*                                                                               
BLDL38   MVC   SVPRGNM,0(RF)                                                    
         B     BLDL50                                                           
*                                                                               
BLDL40   DS   0H                                                                
         MVI   CONTINUE,C'Y'       SET TO PRINT 'CONTINUED'                     
         MVC   PAGE,=H'1'                                                       
         CLI   SVTWPR06,C'N'       THIS AN EASYLINK TRANSMISSION                
         BE    BLDL50               NO                                          
*VEN     TM    SVOPTSW2,OPTOVFAX   TEST OPTION OVERNIGHT FAX                    
*VEN     BO    BLDL50               YES                                         
         TM    SVOPTSW1,OPTHDCPY   TEST OPTION AGENCY COPY                      
         BO    BLDL50               YES                                         
*                                                                               
         TM    WHEN,X'20'          SOON                                         
         BO    BLDL44               YES                                         
*                                                                               
         CLI   OFFLINE,C'Y'        IF ONLINE SEND EASYLINK                      
         BNE   BLDL42                                                           
         CLI   SVTWPR06,C'2'       REQUIRE AGENCY COPY                          
         BE    BLDL60               YES, DO IT FIRST                            
         B     BLDL44                                                           
*                                                                               
BLDL42   MVI   SPMODE,X'FF'                                                     
         GOTO1 SPOOL,DMCB,(R8)    FORCE CLOSE OF SPOOL                          
         MVI   PQSW,1                                                           
*                                                                               
         LA    R1,ELEM                                                          
         ST    R1,SPOOLQLK                                                      
         XC    ELEM(128),ELEM                                                   
         USING PQPLD,R1                                                         
*                                                                               
         BRAS  RE,INITREM          INITIALIZE PRT QUEUE ENTRY                   
*                                                                               
         BRAS  RE,INITREMF         INITIALIZE FAX PRT QUEUE ENTRY               
*                                                                               
         MVI   SPOOLKEY+PLCLASS-PQPLD,C'G'                                      
*                                                                               
         GOTO1 OPENPQ                                                           
*                                                                               
         LAY   R0,HEADING          HEADING INFO FOR REPORT                      
         ST    R0,SPECS                                                         
         LAY   R0,HDHK                                                          
         ST    R0,HEADHOOK                                                      
         LAY   R0,MIDHK                                                         
         ST    R0,MIDHOOK                                                       
         LAY   R0,FTHK                                                          
         ST    R0,FOOTHOOK                                                      
         MVC   FOOTLNS,ASVFTNT     SET NUMBER OF FOOTLINES                      
         B     BLDL46                                                           
         DROP  R1                                                               
*                                                                               
BLDL44   GOTO1 SPOOL,DMCB,(R8)                                                  
         MVC   P1(26),=C'*** END OF DDS MESSAGE ***'                            
         MVI   LINE,2                                                           
         GOTO1 SPOOL,DMCB,(R8)                                                  
*                                                                               
BLDL46   DS   0H                                                                
         BRAS  RE,EASILN                                                        
*                                                                               
BLDL50   MVI   MAXLINES,60         SET PAGE SIZE                                
         MVI   FOOTSW,0            RESET SWITCH                                 
         MVI   FORCEHED,C'Y'                                                    
*                                                                               
BLDL60   DS   0H                                                                
         CLI   FORCEHED,C'Y'                                                    
         BE    *+12                                                             
         MVI   P,0                                                              
         BRAS  RE,GOSPL                                                         
*                                                                               
         L     R2,APRTBUFF                                                      
         USING PLINED,R2                                                        
*                                                                               
BLDL62   OC    UNTFEED,UNTFEED     THIS A FEED                                  
         BNZ   BLDL64                                                           
*                                                                               
         TM    UNTFLG1,UNTFLGNF    NATIONAL UNIT WITH FEEDS?                    
         BZ    BLDL70                                                           
*                                                                               
         MVC   PLAIRDT(18),=C'NATL **NATIONAL**'                                
         LA    R2,132(R2)            CONTINUE ON LINE 2                         
         B     BLDL70                                                           
*                                                                               
BLDL64   CLC   =X'00FFE3',UNTFEED  CHK IF TAG                                   
         BE    BLDL70                                                           
*                                                                               
BLDL66   MVC   PLAIRDT(4),UNTFEED                                               
*                                                                               
         CLI   UNTMYR,0            SECTIONAL FEED?                              
         BE    BLDL68               NO                                          
*                                                                               
         CLC   SVMYEAR,UNTMYR      SAME MAP YEAR AS PREV                        
         BNE   BLDL68               NO                                          
         CLC   SVFEED,UNTFEED      SAME FEED AS PREV                            
         BNE   BLDL68               NO                                          
         CLC   SVMCODEP,UNTMCDP    SAME CODE AS PREV                            
         BNE   BLDL68                                                           
*                                                                               
         MVC   PLAIRDT+6(60),SVDESC                                             
         MVC   PLAIRDT+68(19),=C'*** NO NATIONAL ***'                           
         LA    R2,132(R2)                                                       
         B     BLDL70                                                           
*                                                                               
BLDL68   BRAS  RE,BLDFEED                                                       
                                                                                
*============================================================                   
* PRINT FORMATTED FEED IF IT'S THERE                                            
*============================================================                   
                                                                                
BLDL70   L     R2,APRTBUFF         TEST FEED TO PRINT                           
         CLC   0(132,R2),SPACES                                                 
         BNH   *+12                                                             
         MVI   ALLOWLIN,5          ALWAYS ALLOW 5 LINES FOR UNIT                
         BRAS  RE,PRTBUFF                                                       
*                                                                               
         L     R2,APRTBUFF         START AT TOP OF BUFFER AGAIN                 
         ST    R2,ATOPBUFF         SET FIRST LINE TO USE AGAIN                  
*                                                                               
         CLI   UNTPROD2,C' '       TEST PIGGYBACK                               
         BNH   BLDL71                                                           
         MVC   PLAIRDT(9),=C'PIGGYBACK'                                         
         LA    R2,132(R2)                                                       
         ST    R2,ATOPBUFF         SET FIRST LINE TO USE AGAIN                  
*                                                                               
*LDL71   MVC   SVUNTDTE,UNTADTEP   PRINT AIRDATE                                
         FIXDT02                                                                
BLDL71   GOTO1 DATCON,DMCB,(2,UNTADTEP),(4,PLAIRDT)                             
*                                                                               
         CLI   UNTDAY,0            ANY ROTATION                                 
         BE    BLDL72               NO                                          
*                                                                               
         GOTO1 UNDAY,DMCB,UNTDAY,PLAIRDT+132                                    
*                                                                               
BLDL72   TM    SVOPTSW1,OPTHDCPY   TEST OPTION AGENCY COPY                      
         BZ    BLDL76               ONLY SHOW @ ON FOLLOW-UP TO FAX             
         TM    UNTFLG1,UNTFLGIN    WAS UNIT PRINTED ON INSTRUCTIONS?            
         BZ    BLDL74               NO - FLAG ERROR                             
         TM    UNTFLG,X'80'        WAS THERE AN ERROR?                          
         BZ    *+12                 NO                                          
         TM    UNTFLG1,UNTFLGAK    WAS ERROR ACKNOWLEDGED?                      
         BZ    BLDL74               NO - SHOW OFFENDING LINE                    
         CLC   UNTREVN,SVPRGLFX    WAS THIS THE LATEST REVN FAXED?              
         BNH   BLDL76               YES, NO ERROR                               
*                                                                               
BLDL74   MVI   PLAIRDT-2,C'@'      SHOW OFFENDING LINE                          
*                                                                               
BLDL76   CLI   SVTNPR12,C'Y'       SHOW ALL REVISION NUMBERS                    
         BNE   BLDL80                                                           
         LLC   R0,UNTREVN          WAS THIS ORIG                                
         LTR   R0,R0                                                            
         BZ    BLDL80                                                           
*                                                                               
         CLI   UNTREVN,9           TEST CAN PRINT NEXT TO AIRDATE               
         BH    BLDL78              NO                                           
         MVI   PLAIRDT+5,C'('                                                   
         LA    R6,PLAIRDT+6                                                     
         B     BLDL78A                                                          
*                                                                               
BLDL78   MVC   PLAIRDT+264(132),PLAIRDT+132 MOVE ROT DOWN 1 LINE                
         MVC   PLAIRDT+132(132),SPACES                                          
         MVI   PLAIRDT+132,C'('                                                 
         LA    R6,PLAIRDT+133                                                   
*                                                                               
BLDL78A  BAS   RE,EDITNUM                                                       
         AR    R6,R0                                                            
         MVI   0(R6),C')'                                                       
*                                                                               
BLDL80   TM    UNTFLG2,UNTFLCUT    TEST CUTIN                                   
         BO    BLDL82                                                           
         CLI   SVT3PROF+3,C'N'     TEST DO NOT PRINT POSN                       
         BE    BLDL84                                                           
         MVC   PLPOS,UNTPOS                                                     
         CLI   UNTPOS,X'FF'                                                     
         BNE   BLDL84                                                           
*                                                                               
BLDL82   MVC   PLPOS(4),=C'TBA '   DEFAULT                                      
*                                                                               
BLDL84   MVC   QPRD,UNTPROD                                                     
*        OC    QPRD,QPRD                                                        
*        BZ    BLDL88                                                           
*                                                                               
BLDL86   BRAS  RE,FPRD             UPDATE PRODUCT LIST AND GET NAME             
         MVC   PLPRDNM,PRDNM       MOVE PRD NAME                                
*                                                                               
         CLI   SVTN1PRF,C'Y'       SHOW PROD CODE                               
         BNE   *+10                                                             
         MVC   PLPRD,QPRD                                                       
*                                                                               
* SEE IF SCATTER/UPFRONT/DELETED UNIT                                           
*                                                                               
BLDL88   TM    UNTFLG,X'52'       DELETED OR MISSED UNIT?                       
         BZ    BLDL100                                                          
         MVC   PLCML(7),=C'DELETED'                                             
*                                                                               
         TM    UNTFLG,X'10'       TRAFFIC DELETE                                
         BZ    *+8                                                              
         MVI   PLCML+6,C' '                                                     
*                                                                               
         CLC   UNTREVN,SVPRGRVN    THIS RERUN                                   
         BE    *+12                 YES, SHOW AS NEW THIS REVISION              
         TM    UNTFLG,X'20'       INSTR RUN ON DELETED/MISSED UNIT?             
         BO    BLDL110                                                          
*                                                                               
         MVI   PLAIRDT-1,C'*'      MARK 1ST TIME DELETE SHOWN                   
         MVI   PLCML-1,C'*'                                                     
         LA    R1,PLCML+12                                                      
         CLI   0(R1),C' '                                                       
         BH    *+8                                                              
         BCT   R1,*-8                                                           
         MVI   1(R1),C'*'                                                       
         B     BLDL110                                                          
*                                                                               
*                                                                               
BLDL100  CLI   SVPRGRVN,0          IF ORIG, NO NEW                              
         BE    BLDL106                                                          
         CLC   SVPRGRVN,UNTREVN    THIS CHANGED THIS REVISION                   
         BNE   BLDL106                                                          
         MVC   264(7,R2),=C'**CHG**'                                            
*                                                                               
BLDL106  TM    UNTFLG1,UNTFLGNW    NEW ASSIGNMENT                               
         BZ    BLDL110                                                          
         OC    UNTCML1,UNTCML1                                                  
         BZ    BLDL110             IF NO CML THEN IGNORE                        
         NI    UNTFLG1,X'FF'-UNTFLGNW                                           
         MVC   264(7,R2),=C'**NEW**'                                            
         EJECT                                                                  
*========================================================                       
* PRINT COMMERCIAL LENGTHS AND OVERRIDES                                        
*========================================================                       
                                                                                
BLDL110  OC    UNTCML1(16),UNTCML1 CML1/CML2                                    
         BZ    BLDL110B                                                         
*                                                                               
         OC    UNTCML1,UNTCML1                                                  
         BNZ   BLDL110B                                                         
*                                                                               
         MVC   SVCMLCOD,UNTCML2                                                 
         MVI   BYTE,C'L'           GET CML LEN ONLY                             
         BRAS  RE,FCML                                                          
         MVI   BYTE,0                                                           
*                                                                               
         CLC   UNTSLN2,SVCMLLEN                                                 
         BE    BLDL110B                                                         
*                                                                               
         LLC   RE,UNTSLN                                                        
         LLC   RF,UNTSLN2                                                       
         AR    RE,RF               TOTAL UNIT LEN                               
         LLC   RF,SVCMLLEN         CML2 LEN                                     
         CR    RE,RF               CML2 LEN = TOTAL UNIT LEN                    
         BE    BLDL110B            YES, DONE                                    
         SR    RE,RF               TOTAL UNIT LEN MINUS CML2 LEN                
         STC   RF,UNTSLN2          FIX LEN2                                     
         STC   RE,UNTSLN           AND LEN1                                     
                                                                                
*                                                                               
BLDL110B MVC   SVCMLCOD,UNTCML1                                                 
         BRAS  RE,FCML                                                          
*                                                                               
         CLC   UNTSLN,SVCMLLEN                                                  
         BE    BLDL110C                                                         
*                                                                               
         CLI   SVCMLLEN,0                                                       
         BE    BLDL110C                                                         
*                                                                               
         LLC   RE,UNTSLN                                                        
         LLC   RF,UNTSLN2                                                       
         AR    RE,RF               TOTAL UNIT LEN                               
         LLC   RF,SVCMLLEN         CML1 LEN                                     
         CR    RE,RF               CML1 LEN = TOTAL UNIT LEN                    
         BE    BLDL110C            YES, DONE                                    
         SR    RE,RF               TOTAL UNIT LEN MINUS CML1 LEN                
         STC   RE,UNTSLN2                                                       
         STC   RF,UNTSLN                                                        
*                                                                               
BLDL110C CLC   PLCML,SPACES        TEST ALREADY SET TITLE                       
         BH    BLDL112                                                          
*                                                                               
         MVC   PLCML,SVCMLCOD     MOVE COMMERCIAL CODE                          
         MVC   PLCML+8(4),SPACES                                                
         CLI   SVCMLADI,C' '                                                    
         BNH   *+10                                                             
         MVC   PLCML,SVCMLADI                                                   
*                                                                               
BLDL112  LA    R1,PLSLN                                                         
         LLC   R0,UNTSLN                                                        
         CLC   UNTCML1,UNTCML2     TEST ONE CMML FOR BOTH PRDS                  
         BNE   BLDL114             NO                                           
         LLC   RE,UNTSLN2          PRINT UNIT SLN                               
         AR    R0,RE                                                            
         BAS   RE,EDITSLN                                                       
         B     BLDL116                                                          
*                                                                               
BLDL114  BAS   RE,EDITSLN                                                       
         AR    R1,R0               POINT TO NEXT PRINT POSN                     
         CLI   UNTPROD2,C' '       TEST PIGGYBACK                               
         BNH   BLDL116                                                          
         MVI   PLSLN-1,C'('                                                     
         MVI   0(R1),C'-'                                                       
*                                                                               
BLDL116  CLI   SVCMLOVR,0                                                       
         BE    BLDL130                                                          
         MVC   PLCMLTTL(10),=C'LEN OVRD=('                                      
         LA    R1,PLCMLTTL+10                                                   
         IC    R0,SVCMLOVR                                                      
         BAS   RE,EDITSLN                                                       
         AR    R1,R0                                                            
         MVI   0(R1),C')'                                                       
*                                                                               
         ICM   R0,1,SVCMLOVR+1                                                  
         BZ    BLDL130                                                          
         MVI   0(R1),C'/'                                                       
         LA    R1,1(R1)                                                         
         BAS   RE,EDITSLN                                                       
         AR    R1,R0                                                            
         MVI   0(R1),C')'                                                       
*                                                                               
BLDL130  LA    R2,132(R2)          NEXT PRINT LINE                              
*                                                                               
         TM    SVOPTSW1,OPTNOBON   OPTION NOBONUS                               
         BO    BLDL132                  YES                                     
         TM    UNTFLG1,UNTFLGBN    IS THIS A BONUS UNIT                         
         BZ    BLDL132              NO                                          
         MVC   7(9,R2),=C'**BONUS**'                                            
         B     BLDL142                                                          
*                                                                               
BLDL132  TM    SVOPTSW1,OPTNOADU   OPTION NOADU                                 
         BO    BLDL140                  YES                                     
         TM    UNTFLG1,UNTFLGAD    IS THIS AN ADU UNIT                          
         BZ    BLDL140              NO                                          
         MVC   7(7,R2),=C'**ADU**'                                              
         B     BLDL142                                                          
*                                                                               
BLDL140  TM    UNTFLG2,UNTFLMG     IS THIS A MAKE GOOD                          
         BZ    BLDL142              NO                                          
         OI    TABLESW,MAKEGDSW    MAKE GOOD PRINTED                            
         MVC   7(12,R2),=C'**MAKEGOOD**'                                        
         B     BLDL142                                                          
*                                                                               
BLDL142  TM    UNTFLG,X'50'       DELETED UNIT?                                 
         BNZ   BLDL170                                                          
*PER RAMUNE IGNORE CHANGES MADE TO CMLS FOR NOW                                 
*NOP     TM    SVFLAG1,SVCMLDEL   DELETED CML                                   
*        BO    BLDL162                                                          
*                                                                               
         OC    UNTCML1,UNTCML1    IS THERE A CML                                
         BZ    BLDL162                                                          
*                                                                               
         L     R2,ATOPBUFF        BACK TO TOP OF BUFFER                         
         CLI   SVCMLOVR,0          TEST FOR LEN OVERRIDE                        
         BE    *+8                 NO                                           
         LA    R2,132(R2)          ELSE USE SECOND LINE                         
         MVC   PLCMLTTL,SVCMLDS                                                 
*                                                                               
         CLC   SVCMLDS2,SPACES                                                  
         BNH   *+10                                                             
         MVC   PLCMLTTL+132,SVCMLDS2                                            
*                                                                               
         OC    SVCMLDS3,SVCMLDS3                                                
         BZ    *+10                                                             
         MVC   PLCMLTTL+264(L'SVCMLDS3),SVCMLDS3                                
*                                                                               
BLDL160  L     R2,ATOPBUFF                                                      
         BAS   RE,BLDOTHR                                                       
*                                                                               
BLDL162  OC    UNTPROD2,UNTPROD2   TEST FOR PRD2                                
         BZ    BLDL170             NO                                           
*                                                                               
         BRAS  RE,FNDBUFX                                                       
         MVI   0(R2),0             FORCE TO SKIP A LINE                         
         LA    R2,132(R2)                                                       
         ST    R2,ATOPBUFF         SET NEW STARTING POSITION                    
*                                                                               
         MVC   QPRD,UNTPROD2                                                    
         BRAS  RE,FPRD                                                          
         MVC   PLPRDNM,PRDNM                                                    
*                                                                               
         CLI   SVTN1PRF,C'Y'       SHOW PROD CODE                               
         BNE   *+10                                                             
         MVC   PLPRD(3),QPRD                                                    
*                                                                               
         CLC   UNTCML1,UNTCML2     TEST SAME CMML FOR BOTH PRDS                 
         BNE   BLDL166                                                          
*                                                                               
         MVC   PLCMLTTL(6),=C'P/B= ('                                           
         LLC   R0,UNTSLN                                                        
         LA    R1,PLCMLTTL+6                                                    
         BAS   RE,EDITSLN                                                       
         AR    R1,R0               POINT TO NEXT PRINT POSN                     
         MVI   0(R1),C'/'                                                       
         LA    R1,1(R1)                                                         
         IC    R0,UNTSLN2                                                       
         BAS   RE,EDITSLN                                                       
         AR    R1,R0                                                            
         MVI   0(R1),C')'                                                       
         B     BLDL170                                                          
*                                                                               
BLDL166  MVC   PLSLN-4(3),=C'P/B'                                               
*                                                                               
         MVC   SVCMLCOD,UNTCML2                                                 
         BRAS  RE,FCML             GET COMMERCIAL DATA                          
*                                                                               
*NOP     TM    SVFLAG1,SVCMLDEL    DELETED CML                                  
*        BO    BLDL166C                                                         
*                                                                               
         CLC   UNTSLN2,SVCMLLEN                                                 
         BE    BLDL166C                                                         
*                                                                               
         CLI   SVCMLLEN,0                                                       
         BE    BLDL166C                                                         
*                                                                               
         LLC   RE,UNTSLN                                                        
         LLC   RF,UNTSLN2                                                       
         AR    RE,RF               TOTAL UNIT LEN                               
         LLC   RF,SVCMLLEN         CML2 LEN                                     
         CR    RE,RF               CML2 LEN = TOTAL UNIT LEN                    
         BE    BLDL166C            YES, DONE                                    
         SR    RE,RF               TOTAL UNIT LEN MINUS CML2 LEN                
         STC   RF,UNTSLN2                                                       
         STC   RE,UNTSLN                                                        
*                                                                               
BLDL166C CLC   PLCML,SPACES        TEST ALREADY SET TITLE                       
         BH    BLDL166F                                                         
*                                                                               
         MVC   PLCML,SVCMLCOD     MOVE COMMERCIAL CODE                          
         MVC   PLCML+8(4),SPACES                                                
         CLI   SVCMLADI,C' '                                                    
         BNH   *+10                                                             
         MVC   PLCML,SVCMLADI                                                   
*                                                                               
BLDL166F LLC   R0,UNTSLN2                                                       
         LA    R1,PLSLN                                                         
         BAS   RE,EDITSLN                                                       
         AR    R1,R0               POINT TO NEXT PRINT POSN                     
         MVI   0(R1),C')'                                                       
*                                                                               
         CLI   SVCMLOVR,0                                                       
         BE    BLDL168                                                          
         MVC   PLCMLTTL(10),=C'LEN OVRD=('                                      
         LA    R1,PLCMLTTL+10                                                   
         LLC   R0,SVCMLOVR                                                      
         BAS   RE,EDITSLN                                                       
         AR    R1,R0                                                            
         MVI   0(R1),C')'                                                       
*                                                                               
         ICM   R0,1,SVCMLOVR+1                                                  
         BZ    BLDL168                                                          
         MVI   0(R1),C'/'                                                       
         LA    R1,1(R1)                                                         
         BAS   RE,EDITSLN                                                       
         AR    R1,R0                                                            
         MVI   0(R1),C')'                                                       
*                                                                               
BLDL168  CLI   SVCMLOVR,0          TEST FOR LEN OVERRIDE                        
         BE    *+8                                                              
         LA    R2,132(R2)          IF YES, USE SECOND LINE                      
*                                                                               
*NOP     TM    SVFLAG1,SVCMLDEL    DELETED CML                                  
******   BO    BLDL170                                                          
*                                                                               
         CLC   SVCMLDS,SPACES      NO DESCRIPTION FOR TBA ENTRIES               
         BNH   BLDL168C                                                         
*                                                                               
         MVC   PLCMLTTL,SVCMLDS                                                 
         CLC   SVCMLDS2,SPACES                                                  
         BNH   *+10                                                             
         MVC   PLCMLTTL+132,SVCMLDS2                                            
         OC    SVCMLDS3,SVCMLDS3                                                
         BZ    *+10                                                             
         MVC   PLCMLTTL+264(L'SVCMLDS3),SVCMLDS3                                
*                                                                               
BLDL168C TM    UNTFLG,X'50'        DELETED UNIT?                                
         BNZ   BLDL170                                                          
         LR    R0,R2               SAVE CURRENT R2                              
         BRAS  RE,BLDMSC           ADD HD/CTR/CLTCML TO BUFFER                  
         LR    R2,R0               RESTORE R2                                   
                                                                                
* PRINT DAY/TIME/PROGRAM NAME IF DIFFERENT FROM PROGRAM HEADING DATA *          
                                                                                
BLDL170  CLI   SVTNPR16,C'Y'       SUPPRESS DAY/TIME                            
         BE    BLDL172                                                          
*                                                                               
         MVC   WORK(1),SVPRGDAY                                                 
         NC    WORK(1),UNTDAY                                                   
         CLC   WORK(1),UNTDAY                                                   
         BNE   BLDL174                                                          
*                                                                               
         CLC   SVPRGTIM,UNTTIME                                                 
         BNE   BLDL174                                                          
*                                                                               
BLDL172  DS   0H                                                                
         TM    UNTFLG2,UNTFLCUT    SET AS CUTIN?                                
         BO    BLDL186              YES                                         
*                                                                               
         CLI   SVTNPR13,C'Y'       FORCE PAGE ON PROG NAME                      
         BE    BLDL186              YES, CAN'T HAVE 'DIFF' NAMES                
         CLI   UNTEXNAM,0          STD PROGRAM NAME                             
         BE    BLDL186              YES                                         
*                                                                               
BLDL174  LA    RE,UNTNEXT                IF NEXT REC IS THE SAME                
         LA    RF,UNTDSKAD-UNTABLED(RE)  POINT TO NEXT DISK ADDR                
         CLC   UNTDSKAD,0(RF)            ONLY PRINT ONCE FOR EACH UNIT          
         BE    BLDL186                                                          
*                                                                               
         BRAS  RE,FNDBUFX                                                       
*                                                                               
         MVC   PLPRD(9),=CL9'DIFFERENT'                                         
         LA    R4,PLPRD+10                                                      
         CLI   SVTNPR13,C'Y'       FORCE PAGE ON PROG NAME                      
         BE    BLDL180              YES, CAN'T HAVE 'DIFF' NAMES                
         CLI   UNTEXNAM,0         STD PROGRAM NAME                              
         BE    BLDL180                                                          
         MVC   0(7,R4),=C'PROGRAM'                                              
         CLI   UNTEXNAM,X'FF'      NOT IN TABLE, MORE THAN 14                   
         BNE   BLDL176                                                          
*                                                                               
         LA    R0,UNTDSKAD         READ UNIT RECORD                             
         L     R6,AIO1                                                          
         MVI   RDUPDATE,C'N'                                                    
         BRAS  RE,UNTFGET                                                       
*                                                                               
         LA    RF,NUPROGNM-NURECD(R6)                                           
         B     BLDL178                                                          
*                                                                               
BLDL176  LLC   RE,UNTEXNAM                                                      
         BCTR  RE,0                                                             
         SLL   RE,4               TIMES 16                                      
         L     RF,AIO3                                                          
         LA    RF,480(RE,RF)                                                    
*                                                                               
BLDL178  MVC   8(16,R4),0(RF)                                                   
         LA    R4,132(R4)          NEXT PRINT LINE                              
*                                                                               
BLDL180  CLI   SVTNPR16,C'Y'       SUPPRESS DAY/TIME                            
         BE    BLDL186                                                          
*                                                                               
         CLC   WORK(1),UNTDAY                                                   
         BE    BLDL184                                                          
         MVC   0(3,R4),=CL3'DAY'                                                
         GOTO1 UNDAY,DMCB,UNTDAY,4(R4)                                          
         LA    R4,10(R4)                                                        
*                                                                               
BLDL184  CLC   SVPRGTIM,UNTTIME                                                 
         BE    BLDL186                                                          
         MVC   0(4,R4),=CL4'TIME'                                               
         GOTO1 UNTIME,DMCB,UNTTIME,5(R4)                                        
*                                                                               
BLDL186  MVC   QPRD,UNTPROD        SAVE THIS PRODUCT                            
*                                                                               
         BRAS  RE,PRTBUFF                                                       
*                                                                               
         LA    R5,UNTNEXT          NEXT UNIT                                    
         TM    UNTFLG2,UNTFLCUT    TEST CUTIN                                   
         BZ    *+12                NO                                           
         TM    UPDSW2,UNTCUTIN     PROCESSING CUTINS?                           
         BZ    BLDLX               GO PRINT COPIES AND RETURN                   
*                                                                               
         CLI   UNTADTEP,0           ANY MORE                                    
         BE    BLDL200               NO                                         
*                                                                               
         TM    SVOPTSW2,OPTPBRK    PAGE BREAK BY PRD                            
         BZ    BLDL20               NO                                          
*                                                                               
         CLC   QPRD,UNTPROD        SAME PRD?                                    
         BE    BLDL190                                                          
*                                                                               
         TM    UNTFLG2,UNTFLCUT   TEST CUTIN                                    
         BZ    *+8                                                              
         BRAS  RE,PSTEXT          GO PRINT SPECIAL TEXT                         
*                                                                               
         MVI   FORCEHED,C'Y'       PAGE BREAK ON PRODUCT                        
         B     BLDL20                                                           
*                                                                               
BLDL190  DS    0H                                                               
         TM    UNTFLG2,UNTFLCUT   TEST CUTIN                                    
         BZ    BLDL20                                                           
         BRAS  RE,PSTEXT          GO PRINT SPECIAL TEXT                         
         B     BLDL20                                                           
*                                                                               
BLDL200  NI    UPDSW,X'FF'-X'20'   SET OFF PRINT UNITS SW                       
*                                                                               
BLDLX    ST    R5,SVR5                                                          
         J     EXIT                                                             
*                                                                               
EDITSLN  EDIT  (R0),(3,(R1)),ALIGN=LEFT,ZERO=NOBLANK                            
         BR    RE                                                               
*                                                                               
EDITNUM  EDIT  (R0),(3,(R6)),ALIGN=LEFT,ZERO=NOBLANK                            
         BR    RE                                                               
         EJECT                                                                  
*===============================================================                
* ON ENTRY R2 HAS FIRST PRINT LINE ADDRESS                                      
* R4 IS USED HERE TO PRINT PLOTHER OR PLPOS IF IT IS SUPPRESSED                 
*===============================================================                
                                                                                
BLDOTHR  NTR1                                                                   
         AHI   R2,-132                                                          
         BAS   RE,NEXTOTHR         POINT R4 CORRECTLY                           
*                                                                               
         OC    SVCMLSTM(4),SVCMLSTM   TEST TIMES PRESENT                        
         BZ    BLDOTH6             NO                                           
*                                                                               
         OC    SVCMLSTM,SVCMLSTM   ANY START TIME                               
         BNZ   *+14                                                             
         CLC   SVCMLETM,=X'FFFF'   ANY END TIME                                 
         BE    BLDOTH6                                                          
*                                                                               
         CLI   SVT3PROF+2,C'Y'     PRINT TIMES ON INST?                         
         BNE   BLDOTH6             NO                                           
*                                                                               
         GOTO1 CALLOV,DMCB,0,X'D9000A11'  GET UNTIME ADDRESS                    
         L     RF,0(R1)                                                         
         ST    RF,FULL             SAVE UNTIME ADDRESS                          
*                                                                               
         MVC   0(7,R4),=C'==> RUN'                                              
         TM    SVCMLSTA,X'80'       TEST TIMES ARE DAILY                        
         BZ    BLDOTH2                                                          
*                                                                               
         CLC   SVCMLSTM,=X'0000'                                                
         BNE   BLDOTH1C                                                         
         XC    DUB,DUB                                                          
         MVC   DUB(2),SVCMLETM                                                  
         L     RF,FULL                                                          
         GOTO1 (RF),DMCB,DUB,14(R4)                                             
         MVC   8(5,R4),=C'UNTIL'                                                
         B     BLDOTH1G                                                         
                                                                                
BLDOTH1C CLC   SVCMLETM,=X'FFFF'                                                
         BNE   BLDOTH1E                                                         
         XC    DUB,DUB                                                          
         MVC   DUB(2),SVCMLSTM                                                  
         L     RF,FULL                                                          
         GOTO1 (RF),DMCB,DUB,13(R4)                                             
         MVC   8(4,R4),=C'FROM'                                                 
         B     BLDOTH1G                                                         
*                                                                               
BLDOTH1E GOTO1 (RF),(R1),SVCMLSTM,8(R4)                                         
*                                                                               
BLDOTH1G CLI   SVPRGDAY,0                                                       
         BE    BLDOTH1J                                                         
         LA    R4,25(R4)                                                        
         CLI   0(R4),C' '                                                       
         BH    *+8                                                              
         BCT   R4,*-8                                                           
         MVC   2(5,R4),=C'DAILY'                                                
BLDOTH1J DS    0H                                                               
*                                                                               
         BAS   RE,NEXTOTHR                                                      
         B     BLDOTH6                                                          
*                                                                               
BLDOTH2  MVC   0(12,R4),=C'==> RUN FROM'                                        
         FIXDT02                                                                
         GOTO1 DATCON,DMCB,(2,SVCMLSDT),(4,13(R4))                              
         MVI   18(R4),C'-'                                                      
         XC    DUB,DUB                                                          
         MVC   DUB(2),SVCMLSTM     PASS START TIME ONLY                         
         L     RF,FULL                                                          
         GOTO1 (RF),DMCB,DUB,19(R4)                                             
*                                                                               
         MVC   133(23,R4),=C'   UNTIL FURTHER NOTICE'                           
         CLC   SVCMLEDT,=X'FFFF'                                                
         BE    BLDOTH4                                                          
         MVC   142(14,R4),SPACES                                                
         FIXDT02                                                                
         GOTO1 DATCON,DMCB,(2,SVCMLEDT),(4,142(R4))                             
*                                                                               
         CLC   SVCMLETM,=X'FFFF'                                                
         BE    BLDOTH4                                                          
         MVI   150(R4),C'-'                                                     
         MVC   DUB(2),SVCMLETM                                                  
         L     RF,FULL                                                          
         GOTO1 (RF),DMCB,DUB,151(R4)                                            
*                                                                               
BLDOTH4  LA    R2,132(R2)                                                       
         BAS   RE,NEXTOTHR                                                      
*                                                                               
BLDOTH6  TM    UNTFLG,X'50'        DELETED UNIT?                                
         BNZ   BLDOTH10                                                         
*                                                                               
         BRAS  RE,BLDMSC           ADD HD/CTR/CLTCML TO BUFFER                  
         AHI   R2,-132                                                          
         BAS   RE,NEXTOTHR                                                      
*                                                                               
BLDOTH10 LR    R6,R4                                                            
         CLI   SVTN2PRC,C'Y'       SHOW ESTIMATE ?                              
         BNE   BLDOTH12             NO                                          
         CLI   UNTEST,0            ANY ESTIMATE ?                               
         BE    BLDOTH12             NO                                          
         CLI   UNTPACK,0           IF NO PKG - SKIP EST                         
         BE    BLDOTH12                                                         
*                                                                               
         MVC   0(9,R6),=C'ESTIMATE='                                            
         LA    R6,9(R6)                                                         
         LLC   R0,UNTEST                                                        
         BAS   RE,EDITNUM                                                       
         AR    R6,R0                                                            
         LA    R6,1(R6)            1 SPACE AFTER EST NUM                        
*                                                                               
BLDOTH12 CLI   SVTN1PRE,C'Y'       SHOW PACKAGE ?                               
         BNE   BLDOTH14             NO                                          
         CLI   UNTPACK,0           ANY PACKAGE                                  
         BE    BLDOTH14             NO                                          
*                                                                               
         CLI   0(R4),C' '          DID WE SHOW ESTIMATE                         
         BNH   *+12                NO                                           
         MVI   0(R6),C'/'                                                       
         LA    R6,1(R6)                                                         
*                                                                               
         MVC   0(8,R6),=C'PACKAGE='                                             
         LA    R6,8(R6)                                                         
         LLC   R0,UNTPACK                                                       
         BAS   RE,EDITNUM                                                       
*                                                                               
BLDOTH14 CLC   0(L'PLOTHER,R4),SPACES                                           
         BE    *+8                                                              
         BAS   RE,NEXTOTHR                                                      
*                                                                               
         ICM   R0,15,UNTACOST                                                   
         BZ    BLDOTH16                                                         
         MVC   0(7,R4),=C'COST= $'                                              
         SRDA  R0,32                                                            
         D     R0,=F'100'                                                       
         LR    R0,R1                                                            
         EDIT  (R0),(11,7(R4)),ALIGN=LEFT,MINUS=YES,COMMAS=YES                  
         BAS   RE,NEXTOTHR                                                      
*                                                                               
BLDOTH16 TM    UNTFLG,X'04'        MEDIA REQUIRED BILLBOARD                     
         BO    *+12                                                             
         CLI   UNTBBSL,0           ANY BILLBOARD                                
         BE    BLDOTH20            NO                                           
*                                                                               
         BRAS  RE,BLDBB            PRINT BILLBOARD                              
         BRAS  RE,FNDBUFX          FIND LAST LINE                               
                                                                                
BLDOTH20 SR    R1,R1                                                            
         TM    UNTFLG2,UNTFLOPR    OPPORTUNITY                                  
         BZ    *+8                                                              
         LA    R1,=CL17'**OPPORTUNISTIC**'                                      
         TM    UNTFLG2,UNTFLSCA    SCATTER                                      
         BZ    *+8                                                              
         LA    R1,=CL17'**SCATTER**      '                                      
         TM    UNTFLG2,UNTFLUPF    UPFRONT                                      
         BZ    *+8                                                              
         LA    R1,=CL17'**UPFRONT**      '                                      
*                                                                               
         LTR   R1,R1                                                            
         BZ    BLDOTHX                                                          
         MVC   0(17,R4),0(R1)                                                   
         LA    R2,132(R2)                                                       
*                                                                               
BLDOTHX  XIT1  REGS=(R2)                                                        
*                                                                               
NEXTOTHR LA    R2,132(R2)                                                       
         LA    R4,PLOTHER                                                       
         CLI   SVT3PROF+3,C'N'     TEST DO NOT PRINT POSN                       
         JNE   *+8                                                              
         LA    R4,PLPOS                                                         
         BR    RE                                                               
         LTORG                                                                  
         EJECT                                                                  
*=================================================================              
* PRINT BILLBOARD                                                               
* ON ENTRY R2 POINTS TO FIRST PRINT LINE                                        
*=================================================================              
                                                                                
BLDBB    NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         BRAS  RE,FNDBUFX                                                       
*                                                                               
         MVI   0(R2),0             SKIP A LINE                                  
         LA    R2,132(R2)                                                       
*                                                                               
         LLC   R0,UNTBBSL                                                       
         LA    R1,PLSLN+1                                                       
         CLI   UNTBBSL,255         THIS REALLY ZERO LEN                         
         BE    BLDBB01                                                          
*                                                                               
         EDIT  (R0),(3,(R1)),ALIGN=LEFT,ZERO=NOBLANK                            
*                                                                               
BLDBB01  CLC   =C'VIGNETTE',UNTBBSN                                             
         BE    BLDBB06                                                          
*                                                                               
         MVC   PLOTHER(13),=C'**BILLBOARD**'                                    
*                                                                               
         CLI   SVT3PROF+3,C'N'     TEST DO NOT PRINT POSN                       
         BE    BLDBB02                                                          
         MVC   PLPOS,UNTBBPOS                                                   
         OC    UNTBBPOS,UNTBBPOS                                                
         BNZ   *+10                                                             
         MVC   PLPOS,=C'TBA '      DEFAULT                                      
*                                                                               
BLDBB02  CLI   UNTBBSL,0           ZERO LEN                                     
         BNE   *+12                                                             
         TM    UNTFLG,X'04'        MEDIA REQUIRED BILLBOARD                     
         BO    BLDBB04                                                          
*                                                                               
         OC    UNTBBSN,UNTBBSN     IS THERE A SLIDE                             
         BZ    BLDBB10             NO                                           
         CLC   UNTBBSN,=C'REASSIGN'                                             
         BE    BLDBB10             NO                                           
*                                                                               
         MVC   SVCMLCOD,UNTBBSN    SLIDE NUMBER                                 
         BRAS  RE,FCML                                                          
*                                                                               
         MVC   PLCML(8),SVCMLCOD   MOVE COMMERCIAL CODE                         
         MVC   PLCML+8(4),SPACES                                                
         CLI   SVCMLADI,C' '                                                    
         BNH   *+10                                                             
         MVC   PLCML,SVCMLADI                                                   
*                                                                               
         MVC   PLCMLTTL,SVCMLDS                                                 
*                                                                               
         OC    SVCMLDS2,SVCMLDS2                                                
         BZ    *+10                                                             
         MVC   PLCMLTTL+132,SVCMLDS2                                            
*                                                                               
         OC    SVCMLDS3,SVCMLDS3                                                
         BZ    *+10                                                             
         MVC   PLCMLTTL+264,SVCMLDS3                                            
*                                                                               
         LA    R2,132(R2)          POINT TO LINE 2                              
         BRAS  RE,BLDMSC                                                        
         B     BLDBB06                                                          
*                                                                               
* PRINT UNASSIGNED BILLBOARD HERE *                                             
*                                                                               
BLDBB04  MVC   PLCML(24),=C'BILLBOARD TO BE ASSIGNED'                           
         B     BLDBB20                                                          
*                                                                               
* PRINT VIGNETTE HERE *                                                         
*                                                                               
BLDBB06  CLC   UNTBBSN,=C'VIGNETTE'                                             
         BNE   *+10                                                             
         MVC   PLCML(8),=C'VIGNETTE'                                            
*                                                                               
BLDBB10  OC    UNTBBCN,UNTBBCN     ANY COPY                                     
         BZ    BLDBB20                                                          
         CLC   UNTBBCN,=C'REASSIGN'                                             
         BE    BLDBB20             NO COPY                                      
*                                                                               
         CLC   UNTBBSN,UNTBBCN     ARE SLIDE AND COPY SAME                      
         BE    BLDBB20             ONLY PRINT ONE                               
*                                                                               
         MVC   SVCMLCOD,UNTBBCN                                                 
         BRAS  RE,FCML                                                          
*                                                                               
         CLC   PLOTHER(13),=C'**BILLBOARD**' LOOK AT FIRST LINE                 
         BE    BLDBB12                                                          
*                                                                               
         BRAS  RE,FNDBUFX          ELSE FIND LAST LINE                          
         MVI   0(R2),0                                                          
         LA    R2,132(R2)          SKIP A LINE                                  
*                                                                               
BLDBB12  MVC   PLCML(8),SVCMLCOD   MOVE COMMERCIAL CODE                         
         MVC   PLCML+8(4),SPACES                                                
         CLI   SVCMLADI,C' '                                                    
         BNH   *+10                                                             
         MVC   PLCML,SVCMLADI                                                   
*                                                                               
         MVC   PLCMLTTL,SVCMLDS                                                 
*                                                                               
         OC    SVCMLDS2,SVCMLDS2                                                
         BZ    *+10                                                             
         MVC   PLCMLTTL+132,SVCMLDS2                                            
*                                                                               
         OC    SVCMLDS3,SVCMLDS3                                                
         BZ    *+10                                                             
         MVC   PLCMLTTL+264,SVCMLDS3                                            
*                                                                               
         LA    R2,132(R2)          POINT TO LINE 2                              
         BRAS  RE,BLDMSC                                                        
*                                                                               
BLDBB20  XIT1                                                                   
         EJECT                                                                  
*================================================================               
* ADD HIDEF/CENTERCUT/CLTCMML# TO PRINT BUFFER                                  
* R2 POINTS TO FIRST PRINT LINE                                                 
*================================================================               
                                                                                
BLDMSC   NTR1  BASE=*,LABEL=*                                                   
         AHI   R2,-132                  NEXTOTHR BUMPS R2 SO FIX NOW            
         BRAS  RE,NEXTOTHR                                                      
*                                                                               
         CLI   SVSWAP,C'Y'              CLIENT CHOOSES TO SWAP                  
         BNE   BLDMSC1                  HIDEF AND CENTERCUT COMMLS              
         XC    SVCMLCTR,SVCMLHD                                                 
         XC    SVCMLHD,SVCMLCTR                                                 
         XC    SVCMLCTR,SVCMLHD                                                 
*                                                                               
BLDMSC1  OC    SVCMLHD,SVCMLHD                                                  
         BZ    BLDMSC2                                                          
         MVC   0(7,R4),=C'HIDEF ='                                              
         MVC   7(12,R4),SVCMLHD                                                 
         BRAS  RE,NEXTOTHR                                                      
*                                                                               
BLDMSC2  OC    SVCMLCTR,SVCMLCTR                                                
         BZ    BLDMSC4                                                          
         MVC   0(7,R4),=C'HDCTR ='                                              
         MVC   7(12,R4),SVCMLCTR                                                
         BRAS  RE,NEXTOTHR                                                      
*                                                                               
BLDMSC4  OC    SVCMLCLT,SVCMLCLT                                                
         BZ    BLDMSC6                                                          
         MVC   0(5,R4),=C'ALT#='                                                
         MVC   5(20,R4),SVCMLCLT                                                
         BRAS  RE,NEXTOTHR                                                      
*                                                                               
BLDMSC6  CLC   =X'00FFE3',UNTFEED      TAG ?                                    
         BNE   BLDMSCX                                                          
         MVC   0(1,R4),UNTFEED+3                                                
         MVC   3(6,R4),=C'TAG(S)'                                               
         BRAS  RE,NEXTOTHR                                                      
*                                                                               
BLDMSCX  XIT1  REGS=(R2)                                                        
         LTORG                                                                  
         EJECT                                                                  
BLDADDL  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         BRAS  RE,INITXSP          CMML TEXT LIVES HERE!                        
*                                                                               
         L     R3,AADDTBL                                                       
         USING ADDTBLD,R3                                                       
*                                                                               
         CLI   0(R3),0                                                          
         BE    BLDADDX              NO COMMLS - JUST GET OUT                    
*                                                                               
BLDA05   MVI   P,0                 NEED SPACE BEFORE MIDLINE                    
         BRAS  RE,GOSPL                                                         
         MVI   MIDFLAG,C'A'        SET PRINTING ADDITIONAL DATA                 
         MVI   CONTINUE,C'N'                                                    
         MVI   FORCEMID,C'Y'                                                    
*                                                                               
BLDA10   L     R2,APRTBUFF                                                      
         ST    R2,ATOPBUFF                                                      
         CLI   CONTINUE,C'Y'       TEST FIRST TIME                              
         BE    *+12                                                             
         MVI   0(R2),0             SET TO SKIP A LINE                           
         LA    R2,132(R2)                                                       
*                                                                               
         MVC   0(12,R2),ADDTBADI                                                
         MVI   14(R2),C'-'                                                      
         LA    R4,16(R2)                                                        
*                                                                               
         CLI   SVTN1PR6,C'Y'       SUPPRESS CMML TYPE?                          
         BE    BLDA12                                                           
         CLI   SVTN1PR6,C'S'                                                    
         BE    BLDA12                                                           
         OC    ADDTBTYP,ADDTBTYP                                                
         BZ    BLDA12                                                           
         MVC   0(5,R4),=C'TYPE='                                                
         MVC   5(4,R4),ADDTBTYP                                                 
*                                                                               
BLDA12   CLI   ADDTBDDT,0          DESTROY DATE?                                
         BE    BLDA14                                                           
         MVC   0(18,R4),=C'DESTROY DATE/TIME='                                  
         LA    R4,19(R4)                                                        
         GOTO1 DATCON,DMCB,(3,ADDTBDDT),(5,(R4))                                
         LA    R4,10(R4)                                                        
*                                                                               
         XC    WORK,WORK                                                        
         MVC   WORK(2),ADDTBDTM                                                 
         GOTO1 UNTIME,DMCB,WORK,(R4)                                            
         LA    R2,132(R2)                                                       
         LA    R4,16(R2)                                                        
*                                                                               
BLDA14   TM    ADDTBSTA,X'40'   TXTREC FOR THIS CMML?                           
         BZ    BLDA26                                                           
*                                                                               
         LA    R1,KEY                                                           
         USING CMXKEY,R1                                                        
         L     R6,AIO1             RESET R6 TO CMML REC                         
         XC    KEY,KEY                                                          
         MVC   KEY(2),=X'0A35'                                                  
         MVC   CMXKAM(3),BAGYMD    AG/MD/CLT                                    
         MVC   CMXKPROD,QPRD                                                    
         MVC   CMXKNET,NETWORK                                                  
         MVC   CMXKCML,ADDTBCOD                                                 
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                READ FOR PRD/NET                             
         CLC   KEY(32),KEYSAVE                                                  
         BE    BLDA20                                                           
*                                                                               
         MVC   KEY,KEYSAVE                                                      
         XC    CMXKNET,CMXKNET                                                  
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                READ FOR PRD ONLY                            
         CLC   KEY(32),KEYSAVE                                                  
         BE    BLDA20                                                           
*                                                                               
         MVC   KEY,KEYSAVE                                                      
         XC    CMXKPROD,CMXKPROD                                                
         MVC   CMXKNET,NETWORK                                                  
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                READ FOR NET ONLY                            
         CLC   KEY(32),KEYSAVE                                                  
         BE    BLDA20                                                           
*                                                                               
         MVC   KEY,KEYSAVE                                                      
         XC    CMXKPROD,CMXKPROD                                                
         XC    CMXKNET,CMXKNET                                                  
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                READ FOR CLIENT                              
         CLC   KEY(32),KEYSAVE                                                  
         BE    BLDA20                                                           
*                                                                               
*NOP     MVC   0(37,R2),=C'A035 KEY NOT FOUND A035 KEY NOT FOUND'               
         B     BLDA26                                                           
*                                                                               
BLDA20   MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
*                                                                               
         L     R6,AIO1                                                          
         MVI   ELCODE,X'40'                                                     
         BRAS  RE,GETEL                                                         
         BNE   BLDA26                                                           
*                                                                               
BLDA24   LLC   R1,1(R6)            GET LENGTH OF TEXT                           
         AHI   R1,-4               SET FOR EX                                   
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R4),3(R6)                                                    
*                                                                               
         LA    R2,132(R2)          NEXT PRINT LINE                              
         LA    R4,16(R2)                                                        
         BRAS  RE,NEXTEL                                                        
         BE    BLDA24                                                           
*                                                                               
BLDA26   LR    R1,R2                                                            
         S     R1,APRTBUFF                                                      
         SR    R0,R0                                                            
         D     R0,=F'132'                                                       
         STC   R1,ALLOWLIN                                                      
*                                                                               
         BRAS  RE,PRTBUFF          PRINT ADDL DATA FOR THIS CMML                
         MVI   CONTINUE,C'Y'                                                    
*                                                                               
         LA    R3,ADDTBLLN(R3)                                                  
         CLI   0(R3),0             EOF                                          
         BNE   BLDA10                                                           
*                                                                               
BLDADDX  DS    0H                                                               
         MVI   MIDFLAG,C'N'        SUPPRESS MIDLINES                            
         BRAS  RE,INITNET                                                       
         XIT1                                                                   
         DROP  R3                                                               
         LTORG                                                                  
         EJECT                                                                  
*================================================================               
* FIND COMMERCIAL TITLE *                                                       
*================================================================               
*                                                                               
FCML     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         NI    SVFLAG1,X'FF'-SVCMLDEL   INIT DELETED CML                        
*                                                                               
         XC    SVCMLDTA,SVCMLDTA                                                
         TM    UNTFLG,X'52'        TEST DELETED UNIT                            
         BNZ   FCMLX                                                            
*                                                                               
         CLI   BYTE,C'L'           GET LEN FOR CML2 (CML1=TBA)                  
         BNE   *+14                                                             
         MVC   PLCML+2(15),=CL15'TO BE ANNOUNCED'                               
         B     FCML01X                                                          
*                                                                               
         CLC   SVCMLCOD(8),=C'REASSIGN'                                         
         BE    *+14                                                             
         OC    SVCMLCOD,SVCMLCOD                                                
         BNZ   FCML01X                                                          
*                                                                               
         MVC   PLCML+2(15),=CL15'TO BE ANNOUNCED'                               
         B     FCMLX                                                            
*                                                                               
FCML01X  XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING CMLKEY,R4                                                        
         MVC   CMLKID,=X'0A21'                                                  
         MVC   CMLKAM(3),BAGYMD    A-M/CLT                                      
         MVC   CMLKCML,SVCMLCOD                                                 
*                                                                               
         BRAS  RE,INITSPT          CHANGE TO SPOT                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BE    FCML02                                                           
*                                                                               
         MVC   KEY,KEYSAVE         RESTORE KEY                                  
         MVI   KEY+1,X'C1'         TRY FOR ADID KEY                             
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
         DROP  R4                                                               
*                                                                               
FCML02   L     R6,AIO1                                                          
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
*                                                                               
         CLI   BYTE,C'L'           JUST NEED CML LEN                            
         BE    FCML08                                                           
*                                                                               
         L     R6,AIO1                                                          
         MVC   SVCMLISC,5(R6)      MOVE ISCI CODE                               
*                                                                               
         MVI   ADIDFLAG,0          INIT CML IS AN ADID FLAG                     
         MVC   SVCMLOPT,SVCMLCOD   PRESET OPTICA COMML                          
*                                                                               
         USING CMLADIEL,R6                                                      
         MVI   ELCODE,X'A0'        ADID ELEMENT                                 
         BRAS  RE,GETEL                                                         
         BNE   FCML02C                                                          
         MVC   SVCMLADI,2(R6)      SAVE PRINTABLE ADID                          
         MVC   SVCMLOPT,CMLADIDP   SAVE PACKED ADID FROM ELEM                   
         OI    ADIDFLAG,ADIDSW                                                  
         DROP  R6                                                               
*                                                                               
FCML02C  L     R6,AIO                                                           
         MVI   ELCODE,X'22'        CML NETWORK ELEMENT                          
         BRAS  RE,GETEL                                                         
         BNE   FCML08                                                           
*                                                                               
         USING CMLNETEL,R6                                                      
*                                                                               
FCML04   CLI   CMLNETLN,6          OLD RECORD?                                  
         BE    FCML06               YES                                         
         TM    CMLFLG,CMLEXNET     EXCLUDED NETWORKS?                           
         BZ    FCML06              NO                                           
*                                                                               
         CLC   NETWORK,CMLNET      IS THIS IT                                   
         BE    FCML30               YES ERROR                                   
         BRAS  RE,NEXTEL                                                        
         BE    FCML04                                                           
         B     FCML08                                                           
*                                                                               
FCML06   CLC   NETWORK,CMLNET                                                   
         BE    FCML08                                                           
         BRAS  RE,NEXTEL                                                        
         BE    FCML04                                                           
         B     FCML30                                                           
         DROP  R6                                                               
*                                                                               
FCML08   L     R6,AIO1                                                          
*                                                                               
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         USING CMLDTAEL,R6                                                      
*                                                                               
         MVC   SVCMLLEN,CMLSLN                                                  
         CLI   BYTE,C'L'           JUST NEED LEN                                
         BE    FCMLX                                                            
*                                                                               
         TM    CMLSTAT,X'80'       TEST DELETED COMMERCIAL                      
         BZ    *+12                                                             
         OI    SVFLAG1,SVCMLDEL    CML IS DELETED                               
         B     FCML30                                                           
*                                                                               
         MVC   SVCMLDS(15),CMLTITLE                                             
         MVC   SVCMLCLT,CMLCLTNO                                                
         MVC   SVCMLOVR(2),CMLOVRD1  SAVE OVERRIDES                             
         MVC   SVCMLTYP,CMLTYPE                                                 
         MVC   SVCMLSTA,CMLSTAT                                                 
*                                                                               
         FIXDT02                                                                
         GOTO1 DATCON,DMCB,(3,CMLRLSE),(2,SVCMLSDT)  SAVE ST/END DTS            
         MVC   SVCMLEDT,CMLRCL                                                  
         CLC   SVCMLEDT,=X'FFFF'   TEST UFN                                     
         BE    FCML08A                                                          
         FIXDT02                                                                
         GOTO1 DATCON,DMCB,(3,CMLRCL),(2,SVCMLEDT)                              
*                                                                               
         FIXDT02                                                                
FCML08A  GOTO1 DATCON,DMCB,(2,UNTADTEP),(3,DUB)                                 
         FIXDT02                                                                
         GOTO1 DATCON,(R1),(2,UNTADTEP),(0,WORK)                                
         GOTO1 GETDAY,(R1),WORK,WORK+6                                          
*                                                                               
         LLC   RF,0(R1)            GET DAY OF WEEK                              
         LLC   R0,UNTDAY                                                        
         SLL   R0,25                                                            
         SR    R1,R1               CLEAR COUNTER                                
*                                                                               
         LTR   RF,RF                                                            
         BZ    FCML10                                                           
         SLL   R0,1                ONLY COUNT DAYS AFTER NBACTDAT               
         BCT   RF,*-4                                                           
*                                                                               
FCML10   LTR   R0,R0               COUNT UNTIL NO DAYS LEFT                     
         BZ    FCML12                                                           
         SLL   R0,1                                                             
         BCT   R1,FCML10                                                        
*                                                                               
FCML12   LPR   R0,R1               GET # OF DAYS IN ROT AFTER NBACTDAT          
*                                                                               
         GOTO1 ADDAY,DMCB,WORK,WORK+6,(R0)                                      
         GOTO1 DATCON,(R1),WORK+6,(3,DUB+3)                                     
*                                                                               
         XC    SVUNTDAT,SVUNTDAT                                                
         MVC   SVUNTDTS,DUB        SAVE DATES FOR OPTICA                        
         MVC   SVUNTDTE,DUB+3                                                   
*                                                                               
         CLC   CMLRLSE,DUB+3      SEE IF AIR DATES FALL IN CML PERIOD           
         BH    FCML30                                                           
         CLC   CMLRCL,DUB                                                       
         BL    FCML30                                                           
*                                                                               
FCML20   L     R6,AIO1                                                          
         MVI   ELCODE,X'24'                                                     
         BRAS  RE,GETEL                                                         
         BNE   FCML22                                                           
         USING CMLXDTEL,R6                                                      
         MVC   SVCMLHD,CMLXHDEF                                                 
         MVC   SVCMLCTR,CMLXCNTR                                                
         MVC   SVSWAP,CMLXSWAP                                                  
         MVC   SVCMLDDT,CMLXDSDT                                                
         MVC   SVCMLDTM,CMLXDSTM                                                
         DROP  R6                                                               
*                                                                               
FCML22   L     R6,AIO1             LOOK FOR DESC ELEMENTS                       
         MVI   ELCODE,X'30'                                                     
         BRAS  RE,GETEL                                                         
         BNE   FCML40                                                           
         MVC   SVCMLDS,3(R6)      REPLACE DESC1                                 
*                                                                               
FCML24   BRAS  RE,NEXTEL                                                        
         BNE   FCML40                                                           
         MVC   SVCMLDS2,3(R6)                                                   
*                                                                               
         BRAS  RE,NEXTEL                                                        
         BNE   FCML40                                                           
         MVC   SVCMLDS3,3(R6)                                                   
         B     FCML40                                                           
*PER RAMUNE NOP THIS FOR NOW... UNTIL FURTHER NOTICE                            
*CML30   MVC   PLCML+2(15),=CL15'TO BE ANNOUNCED'                               
*NOP     B     FCMLX                                                            
FCML30         B     FCML50                                                     
*                                                                               
FCML40   DS    0H                                                               
         CLI   SVTN2PRO+15,C'N'    PRINT CMML RUN TIMES?                        
         BE    FCML50              NO                                           
         L     R6,AIO1                                                          
         MVI   ELCODE,X'B0'        COMMERCIAL RUN TIMES                         
         BRAS  RE,GETEL                                                         
         BNE   FCML50                                                           
         USING CMLMATEL,R6                                                      
         MVC   SVCMLSTM,CMLMSTIM                                                
         MVC   SVCMLETM,CMLMETIM                                                
         TM    CMLMFLAG,CMLMFDAY   TEST DAILY TIMES FLAG                        
         BZ    *+8                                                              
         OI    SVCMLSTA,X'80'       SAVE FLAG                                   
                                                                                
* IF ANY ADDITIONAL COMMERCIAL DATA, ADD ENTRY TO SAVE TABLE *                  
* PRINTS OUT AT THE END OF EACH PROGRAM                      *                  
                                                                                
FCML50   LA    R4,WORK                                                          
         USING ADDTBLD,R4                                                       
         MVC   ADDTBCOD(8),SVCMLISC     MOVE ISCI CODE                          
         MVC   ADDTBADI(8),SVCMLISC        AND SET AS ADID ALSO                 
         MVC   ADDTBADI+8(4),SPACES                                             
         CLI   SVCMLADI,C' '            IF HAVE ACTUAL ADID                     
         BNH   *+10                                                             
         MVC   ADDTBADI,SVCMLADI     THEN USE IT                                
         MVC   ADDTBDA,KEY+14        DISK ADDRESS                               
         MVC   ADDTBSTA,SVCMLSTA     CMML TEXT FLAG                             
         NI    ADDTBSTA,X'40'        DROP ALL BUT X'40' FLAG                    
         MVC   ADDTBTYP,SVCMLTYP                                                
         MVC   ADDTBDDT,SVCMLDDT                                                
         MVC   ADDTBDTM,SVCMLDTM                                                
*                                                                               
         CLI   SVTN1PR6,C'Y'       SUPPRESS CMML TYPE?                          
         BE    FCML52                                                           
         CLI   SVTN1PR6,C'S'                                                    
         BE    FCML52                                                           
         B     FCML54                                                           
FCML52   XC    ADDTBTYP,ADDTBTYP                                                
*                                                                               
FCML54   OC    ADDTBSTA(9),ADDTBSTA  TEST ANY ADDL DATA TO SAVE                 
         BZ    FCML60                NO                                         
*                                                                               
         GOTO1 =V(BINSRCH),BINPARS,(1,WORK),RR=SPTR1FRR                         
         ICM   R3,15,0(R1)                                                      
         BNZ   *+6                                                              
         DC    H'0'            *TABLE FULL                                      
*                                                                               
* ADD CML TO TABLE FOR OPTICA.                                                  
*                                                                               
FCML60   XC    WORK,WORK                                                        
         LA    R4,WORK                                                          
         USING CMLTBLD,R4                                                       
*                                                                               
         MVC   CMLSHCML,SVCMLOPT                                                
         MVC   CMLFLAG,ADIDFLAG    ADID FLAG IF ANY                             
*                                                                               
FCML62   MVC   CMLFTD,SVUNTDTS                                                  
         MVC   CMLPRO1,UNTPROD                                                  
         MVC   CMLPRO2,UNTPROD2                                                 
         MVC   CMLLTD,SVUNTDTE                                                  
*NOP     MVC   CMLNTI,UNTNTI                                                    
*                                                                               
         GOTO1 =V(BINSRCH),BINPAR7,(1,WORK),RR=SPTR1FRR                         
         L     R3,0(R1)                                                         
         LTR   R3,R3                                                            
         BNZ   *+6                                                              
         DC    H'0'            *TABLE FULL                                      
                                                                                
         CLI   0(R1),1             WAS RECORD ADDED TO BINTABLE                 
         BE    FCMLX               YES                                          
*                                                                               
         L     R3,0(R1)            A(RECORD IN BIN TABLE)                       
B        USING CMLTBLD,R3                                                       
*                                                                               
         MVC   B.CMLLTD,CMLLTD     EXPAND LTD IF NEEDED                         
         BNL   *+10                                                             
         MVC   B.CMLLTD,CMLLTD                                                  
*                                                                               
         DROP  B                                                                
*                                                                               
FCMLX    XIT1                                                                   
         DROP  R4                                                               
*                                                                               
* CONVERSION OF CML TYPE TO PRINTABLE TYPE *                                    
*                                                                               
TYPTABLE DC    CL4'ABB ',CL11'AUDIO BB   '                                      
         DC    CL4'ACD ',CL11'ART CARD   '                                      
         DC    CL4'AT  ',CL11'AUDIO TAPES'                                      
         DC    CL4'CLR ',CL11'CLR/VTR    '                                      
         DC    CL4'CPY ',CL11'COPY       '                                      
         DC    CL4'CSL ',CL11'COLOR SLIDE'                                      
         DC    CL4'CSS ',CL11'COLR SUPRSL'                                      
         DC    CL4'D2  ',CL11'DIGITAL    '                                      
         DC    CL4'FBB ',CL11'FILM BB    '                                      
         DC    CL4'FBS ',CL11'FS BW SLIDE'                                      
         DC    CL4'FCS ',CL11'FS CL SLIDE'                                      
         DC    CL4'HV1 ',CL11'HIGH BAND 1'                                      
         DC    CL4'HDT ',CL11'HIGH DEF TV'                                      
         DC    CL4'SC  ',CL11'SLIDE COPY '                                      
         DC    CL4'SSL ',CL11'SUPER SLIDE'                                      
         DC    CL4'VTR ',CL11'VIDEO TAPE '                                      
TYPTABCT EQU   (*-TYPTABLE)/15                                                  
         DC    CL4'XXXX',CL11'UNKNOWN TYPE'                                     
         LTORG                                                                  
         EJECT                                                                  
* PRINT COMMENTS FOR THIS PROGRAM *                                             
*                                                                               
* EXPECTS:  AIO3 - SVPRDLST IN AIO3 + 3520                                      
*           SVCLIST                                                             
*                                                                               
* USES:     AIO1 - COMMENT REC (DTXRECD)                                        
*                - PRODUCT REC                                                  
*           R4   - KEY, COMMENT REC POINTER                                     
*           R5   - AIO3 + 3520 (SVPRDLST)                                       
* FOR REASONS I DO NOT UNDERSTAND, THESE COMMENTS SEEM TO ACTUALLY              
* BE ON THE XSPDIR/XSPFILE. YOU COULD HAVE FOOLED ME!  MH 2/26/09               
*                                                                               
PCOM     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         BRAS  RE,INITXSP                                                       
*                                                                               
         NI    SVOPTSW1,X'FF'-(USEDEF+PRNTDCMT)  RESET PCOM OPTS                
         L     R5,AIO3             SVPRDLST                                     
         LA    R5,3520(,R5)                                                     
*                                                                               
         MVC   AIO,AIO1                                                         
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING DT2RECD,R4                                                       
*                                                                               
PCOM10   MVC   DT2KID,=X'0A2D'                                                  
         MVC   DT2KAM(3),BAGYMD    A-M/CLT                                      
         MVC   DT2KMED,SVMEDIA                                                  
         MVC   DT2KNET,NETWORK                                                  
*                                                                               
         OC    0(3,R5),0(R5)       ANY MORE PRODUCTS?                           
         BZ    PCOM90               NO                                          
*                                                                               
         MVC   DT2KPRD,0(R5)                                                    
*                                                                               
         MVC   KEYSAVE,KEY                                                      
         BRAS  RE,XSPDIRHI                                                      
*                                                                               
         CLC   KEY(13),KEYSAVE     DID WE FIND NET/PRD REC?                     
         BE    PCOM20               YES - USE IT                                
*                                                                               
         MVC   KEY,KEYSAVE         RESTORE KEY                                  
         XC    DT2KNET,DT2KNET                                                  
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(13),KEYSAVE     DID WE FIND MEDIA/PRD REC?                   
         BE    PCOM20               YES - USE IT                                
*                                                                               
         CLI   SVTN1PR7,C'Y'       PRINT DEFAULT COMMENTS AS WELL               
         BE    PCOM80                                                           
*                                                                               
         OI    SVOPTSW1,USEDEF     SET FLAG TO PRINT A DEFAULT COMMENT          
         B     PCOM80                                                           
*                                                                               
PCOM20   DS    0H                                                               
         TM    SVOPTSW1,PRNTDCMT   ALREADY PRINTED COMMENTS?                    
         BNZ   PCOM30               YES                                         
*                                                                               
         MVI   P,0                                                              
         BRAS  RE,GOSPL            SKIP A LINE                                  
*                                                                               
         OI    SVOPTSW1,PRNTDCMT   SET COMMENT PRINTED                          
         MVI   P,C'*'                                                           
         MVC   P+1(79),P           PRE-FILL PRINT LINE WITH *'S                 
         MVC   P+4(19),=C' START OF COMMENTS '                                  
         BRAS  RE,GOSPL                                                         
*                                                                               
PCOM30   DS    0H                                                               
         LA    R1,P+3                                                           
         MVC   0(13,R1),=C'*COMMENT FOR '                                       
         LA    R1,13(R1)                                                        
         OC    DT2KNET,DT2KNET     WAS THIS MEDIA OR NET SPECIFIC?              
         BZ    PCOM40               MEDIA OR CLIENT                             
         MVC   0(4,R1),DT2KNET                                                  
         CLI   3(R1),C' '                                                       
         BNE   *+12                                                             
         LA    R1,3(R1)                                                         
         B     *+8                                                              
         LA    R1,4(R1)                                                         
         MVC   0(2,R1),=C', '                                                   
         LA    R1,2(R1)                                                         
         B     PCOM60                                                           
*                                                                               
PCOM40   DS    0H                                                               
         CLI   DT2KMED,0           WAS THIS MEDIA SPEC OR CLIENT?               
         BZ    PCOM50                                                           
                                                                                
         CLI   DT2KMED,C'C'                                                     
         BNE   *+18                                                             
         MVC   0(7,R1),=C'CABLE, '                                              
         LA    R1,7(R1)                                                         
         B     PCOM60                                                           
                                                                                
         CLI   DT2KMED,C'S'                                                     
         BNE   *+18                                                             
         MVC   0(13,R1),=C'SYNDICATION, '                                       
         LA    R1,13(R1)                                                        
         B     PCOM60                                                           
                                                                                
         CLI   DT2KMED,C'N'                                                     
         BNE   *+18                                                             
         MVC   0(9,R1),=C'NETWORK, '                                            
         LA    R1,9(R1)                                                         
         B     PCOM60                                                           
                                                                                
*MNV                                                                            
         CLI   DT2KMED,C'V'                                                     
         BNE   *+18                                                             
         MVC   0(7,R1),=C'OTHER, '                                              
         LA    R1,7(R1)                                                         
         B     PCOM60                                                           
*MNV                                                                            
                                                                                
         CLI   DT2KMED,C'O'                                                     
         BE    *+6                                                              
         DC    H'0'                                                             
         MVC   0(7,R1),=C'OTHER, '                                              
         LA    R1,7(R1)                                                         
         B     PCOM60                                                           
*                                                                               
PCOM50   DS    0H                                                               
         MVC   0(07,R1),=C'CLIENT '                                             
         MVC   7(03,R1),QCLT                                                    
         LA    R1,11(R1)                                                        
         B     PCOM70              CAN'T BE PRD FOR CLT LEVEL COMMENT           
*                                                                               
PCOM60   DS    0H                                                               
         OC    DT2KPRD,DT2KPRD     PRD SPECIFIC?                                
         BNZ   *+16                 YES                                         
         BCTR  R1,0                                                             
         BCTR  R1,0                                                             
         MVI   0(R1),C' '          BLANK OUT ','                                
         B     PCOM70                                                           
*                                                                               
         BAS   RE,PCFPRD           GET PRD NAME                                 
         MVC   0(8,R1),=C'PRODUCT '                                             
         LA    R1,8(R1)                                                         
         L     RE,AIO1                                                          
         USING PRDHDRD,RE                                                       
         MVC   0(L'PNAME,R1),PNAME                                              
         OC    0(L'PNAME,R1),SPACES                                             
         DROP  RE                                                               
         LA    R1,L'PNAME(R1)                                                   
         CLI   0(R1),C' '          FIND LAST PRINTED CHAR                       
         BH    *+8                                                              
         BCT   R1,*-8                                                           
*                                                                               
         MVC   1(2,R1),=C' ('                                                   
         MVC   3(3,R1),0(R5)       PRD CODE                                     
*                                                                               
         LA    R1,5(R1)            POINT TO LAST CHAR                           
         CLI   0(R1),C' '                                                       
         BH    *+8                                                              
         BCT   R1,*-8                                                           
         MVI   1(R1),C')'                                                       
*                                                                               
PCOM70   BRAS  RE,GOSPL                                                         
         MVI   SVCMTTYP,C'C'       COMMENT RECORD                               
         BRAS  RE,PRNCMT           NOW GO PRINT COMMENTS                        
         OC    DT2KPRD,DT2KPRD     DID WE JUST PRINT A DEFAULT COMMENT?         
         BZ    PCOMX                YES - WE'RE DONE                            
*                                                                               
PCOM80   LA    R5,SVPRDENT(R5)     NEXT ENTRY IN PRD LST                        
         B     PCOM10                                                           
*                                                                               
PCOM90   DS    0H                                                               
         CLI   SVTN1PR7,C'Y'       PRINT DEFAULT COMMENTS AS WELL               
         BE    PCOM94                                                           
*                                                                               
         TM    SVOPTSW1,USEDEF     DO WE NEED A DEFAULT COMMENT?                
         BZ    PCOMX                NO                                          
*                                                                               
PCOM94   DS    0H                                                               
         XC    KEY,KEY                                                          
         MVC   DT2KID,=X'0A2D'                                                  
         MVC   DT2KAM(3),BAGYMD    A-M/CLT                                      
         MVC   DT2KMED,SVMEDIA                                                  
         MVC   DT2KNET,NETWORK                                                  
         MVI   DT2KPRD,0                                                        
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                READ FOR NET SPEC                            
         CLC   KEY(13),KEYSAVE                                                  
         BE    PCOM20               YES                                         
*                                                                               
         MVC   KEY,KEYSAVE                                                      
         XC    DT2KNET,DT2KNET                                                  
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                READ FOR NET SPEC                            
         CLC   KEY(13),KEYSAVE                                                  
         BE    PCOM20               YES                                         
*                                                                               
         MVC   KEY,KEYSAVE                                                      
         MVI   DT2KMED,0                                                        
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                READ FOR NET SPEC                            
         CLC   KEY(13),KEYSAVE                                                  
         BE    PCOM20                                                           
*                                                                               
PCOMX    DS    0H                                                               
         TM    SVOPTSW1,PRNTDCMT   ANY CMTS PRINTED?                            
         BZ    PCOMXIT              NO                                          
         MVI   P,C'*'                                                           
         MVC   P+1(79),P           PRE-FILL PRINT LINE WITH *'S                 
         MVC   P+4(17),=C' END OF COMMENTS '                                    
         BRAS  RE,GOSPL                                                         
*                                                                               
PCOMXIT  J     EXIT                                                             
         EJECT                                                                  
* FIND PRODUCT NAME *                                                           
*                                                                               
* EXPECTS R5 - A(PRD CODE)                                                      
* RETURNS PRD REC IN AIO (S.B. AIO1 IF CALLED FROM PCOM)                        
* NOTE: KEY IS RESTORED FOR SEQ                                                 
                                                                                
PCFPRD   NTR1                                                                   
         BRAS  RE,INITSPT                                                       
*                                                                               
         MVC   SAVEKEY(32),KEY     SAVE OFF KEY                                 
         XC    KEY,KEY                                                          
         MVC   KEY+1(3),BAGYMD     & BCLT                                       
         MVC   KEY+4(3),0(R5)                                                   
         MVI   RDUPDATE,C'N'                                                    
*                                                                               
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
*                                                                               
         BRAS  RE,INITXSP                                                       
         MVC   KEY(32),SAVEKEY     RESTORE KEY                                  
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(32),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
         J     EXIT                                                             
         LTORG                                                                  
         DROP  R4                                                               
         EJECT                                                                  
*================================================================               
* PRINT COMMENT REC & ANY PAGES                                                 
*================================================================               
                                                                                
PRNCMT   NTR1  BASE=*,LABEL=*                                                   
         L     RC,SVADGEND                                                      
         USING GEND,RC                                                          
*                                                                               
         LA    R0,P                                                             
         LA    R1,4*132                                                         
         SR    RE,RE                                                            
         LA    RF,X'40'                                                         
         SLL   RF,24                                                            
         MVCL  R0,RE                                                            
*                                                                               
         MVC   SAVEKEY(32),KEY     SAVE KEY                                     
*                                                                               
PRNCMT10 DS    0H                                                               
         CLI   SVCMTTYP,C'C'       COMMENT RECORD                               
         BNE   PRNCMT15            NO, STEXT RECORD                             
*                                                                               
         BRAS  RE,INITXSP          ONLY FOR COMMENT RECORD!                     
*                                                                               
PRNCMT15 MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
*                                                                               
PRNCMT18 L     R6,AIO                                                           
         MVI   ELCODE,X'40'                                                     
         BRAS  RE,GETEL                                                         
         USING DTXTXTEL,R6                                                      
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
PRNCMT20 LA    R1,P+7                                                           
*                                                                               
         LLC   RF,DTXTXTLN                                                      
         AHI   RF,-4               GET TEXT LEN-1                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R1),DTXTXT                                                   
*                                                                               
         CLC   0(132,R1),SPACES    IF STILL BLANK LINE                          
         BNE   *+8                                                              
         MVI   0(R1),0             FORCE LINE TO PRINT                          
*                                                                               
         BRAS  RE,NEXTEL                                                        
         BNE   PRNCMT40                                                         
*                                                                               
         MVI   SPACING,1                                                        
         BRAS  RE,GOSPL                                                         
         B     PRNCMT20                                                         
*                                                                               
PRNCMT40 BRAS  RE,GOSPL                                                         
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 SEQ                 READ SPTDIR/XSPDIR                           
*                                                                               
         CLI   SVCMTTYP,C'C'       COMMENT RECORD                               
         BNE   PRNCMT50             NO, STEXT RECORD                            
*                                                                               
         CLC   KEY(31),KEYSAVE                                                  
         BE    PRNCMT15                                                         
         MVC   KEY(32),SAVEKEY     RESTORE KEY                                  
         B     PCX                                                              
*                                                                               
PRNCMT50 CLC   KEY(11),KEYSAVE                                                  
         BE    PRNCMT15                                                         
         XC    KEY,KEY                                                          
         MVC   KEY(13),SAVEKEY     RESTORE KEY                                  
*                                                                               
PCX      XIT1                                                                   
         LTORG                                                                  
         DROP  R6                                                               
         EJECT                                                                  
* PRINT SPECIAL COMMENT AT THE END OF THE REPORT                                
******************************************************                          
****** (STEXT IS ON SPTFIL NOT XSPFIL)  **************                          
******************************************************                          
*                                                                               
PSTEXT   NTR1  BASE=*,LABEL=*                                                   
         L     RC,SVADGEND                                                      
         USING GEND,RC                                                          
*                                                                               
         BRAS  RE,INITSPT          SWITCH TO SPT                                
*                                                                               
         MVC   AIO,AIO1                                                         
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING DTXRECD,R4                                                       
         MVC   DTXKID,=X'0A2D'                                                  
         MVC   DTXKAM,BAGYMD                                                    
         MVI   DTXKCLT,C'*'        CLT=OFFICE                                   
         MVC   DTXKCLT+1(1),SVCLTOFF                                            
         MVI   DTXKTYP,C'L'        LIVE TEXT (BODY)                             
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE     ANY STEXT FOR THIS OFFICE                    
         BNE   PSTEXTX              NO, DONE                                    
*                                                                               
         MVI   P,0                                                              
         BRAS  RE,GOSPL                                                         
         MVI   SVCMTTYP,C'S'       STEXT RECORD                                 
         BRAS  RE,PRNCMT           PRINT COMMENT                                
*                                                                               
PSTEXTX  BRAS  RE,INITNET          CHANGE TO NET                                
         XIT1                                                                   
         LTORG                                                                  
         EJECT                                                                  
*===================================================================            
* FIND FEED DESCRIPTION                                                         
* FEED DESCRIPTION PRINTS ON FIRST LINE IN BUFFER                               
*===================================================================            
                                                                                
         USING UNTABLED,R5                                                      
         USING PLINED,R2                                                        
BLDFEED  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         BRAS  RE,INITSPT          SWITCH TO SPT                                
*                                                                               
         XC    KEY,KEY                                                          
         MVC   KEY(2),=X'0A2B'                                                  
         MVC   KEY+2(1),BAGYMD                                                  
         MVC   KEY+3(4),NETWORK                                                 
         MVC   KEY+7(2),BCLT                                                    
         MVC   KEY+9(4),UNTFEED                                                 
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BE    BLDF10                                                           
*                                                                               
         MVC   KEY(13),KEYSAVE                                                  
         XC    KEY+7(2),KEYSAVE+7  CLEAR CLIENT                                 
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         JNE   NEQXIT                                                           
*                                                                               
BLDF10   L     R6,AIO1                                                          
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
*                                                                               
         CLI   UNTMYR,0            IS THIS SECTIONAL FEED                       
         BE    BLDF14               NO                                          
*                                                                               
         MVC   SVFEED,UNTFEED                                                   
         MVC   SVMYEAR,UNTMYR      SAVE THIS MAP YEAR                           
         MVC   SVMCODEP,UNTMCDP    AND THIS MAP CODE POINTER                    
*                                                                               
         LHI   R4,MCODETBL-SYSD                                                 
         AR    R4,R9                                                            
         LLC   R1,UNTMCDP          AND DISPLACEMENT+1                           
         AR    R4,R1                                                            
         BCTR  R4,0                R4 IS PONTING TO MAP CODE                    
*                                                                               
         MVI   ELCODE,X'40'        SECTIONAL FEED DESCRIPTION ELEM              
         BRAS  RE,GETEL                                                         
         B     *+8                                                              
*                                                                               
BLDF12   BRAS  RE,NEXTEL                                                        
         BE    *+6                                                              
         DC    H'0'                NO FEED DESCRIPTION RECORD                   
*                                                                               
         USING FEEDSMEL,R6                                                      
*                                                                               
         TM    FEEDSFLG,FEEDSDEL   DELETED FEED                                 
         BO    BLDF12               YES                                         
*                                                                               
         CLC   UNTMYR,FEEDSMYR     SAME MAP YEAR                                
         BNE   BLDF12                                                           
         CLC   FEEDSMCD,0(R4)      SAME MAP CODE                                
         BNE   BLDF12                                                           
*                                                                               
         MVC   SVDESC,FEEDSMDS     SAVE FEED DESCRIPTION                        
         MVC   6(60,R2),SVDESC                                                  
         MVC   68(19,R2),=C'*** NO NATIONAL ***'                                
         LA    R2,132(R2)                                                       
         B     BLDFX                                                            
*                                                                               
BLDF14   MVI   ELCODE,X'20'        FEED DESCR ELEM                              
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         USING FEEDELEM,R6                                                      
         MVC   6(60,R2),FEEDELDS                                                
         CLI   1(R6),63                                                         
         BE    BLDF16                                                           
         MVC   6(60,R2),2(R6)                                                   
*                                                                               
BLDF16   TM    UNTFLG2,UNITFDD     FEED W/O NATIONAL ?                          
         BZ    BLDF28               NO                                          
*                                                                               
* LOOK FOR THE END OF THE FEED DESCRIPTION                                      
*                                                                               
         LA    R0,60                                                            
         LA    R1,66(R2)                                                        
BLDF20   CLI   0(R1),C' '           FIND A CHARACTER                            
         BH    BLDF22               YES                                         
         BCTR  R1,0                                                             
         BCT   R0,BLDF20                                                        
*                                                                               
BLDF22   MVC   5(19,R1),=C'*** NO NATIONAL ***'                                 
         LA    R2,132(R2)          NEXT PRINT LINE                              
*                                                                               
BLDF28   BRAS  RE,NEXTEL                                                        
         BNE   BLDFX                                                            
*                                                                               
         MVC   6(60,R2),3(R6)                                                   
         CLI   1(R6),63                                                         
         BE    *+10                                                             
         MVC   6(60,R2),2(R6)                                                   
         LA    R2,132(R2)                                                       
         B     BLDF28                                                           
*                                                                               
BLDFX    BRAS  RE,INITNET          SWITCH TO NET                                
         XIT1  REGS=(R2)                                                        
         LTORG                                                                  
         EJECT                                                                  
*===============================================================                
* FIND PRODUCT NAME AND ADD ENTRY TO SVPRDLST!                                  
*===============================================================                
                                                                                
         USING UNTABLED,R5                                                      
FPRD     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         OC    QPRD,QPRD           UNALLOCATED                                  
         BZ    FPRD30                                                           
         XC    KEY,KEY                                                          
         MVC   KEY+1(3),BAGYMD  & BCLT                                          
         MVC   KEY+4(3),QPRD                                                    
         BRAS  RE,INITSPT          CHANGE TO SPOT                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
         L     R6,AIO1                                                          
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
         BRAS  RE,INITNET          CHANGE TO NET                                
*                                                                               
         USING PRDHDRD,R6                                                       
*                                                                               
         MVC   PRDNM(20),PNAME       AND PRODUCT NAME                           
         LA    R0,SVPRDLEN                                                      
         L     R1,AIO3            SVPRDLST                                      
         LA    R1,3520(,R1)                                                     
FPRD10   CLC   QPRD,0(R1)                                                       
         BE    FPRD20                                                           
         OC    0(4,R1),0(R1)                                                    
         BZ    FPRD14                                                           
         LA    R1,SVPRDENT(,R1)                                                 
         BCT   R0,FPRD10                                                        
         DC    H'0'                                                             
FPRD14   MVC   0(3,R1),QPRD        BUILD PRDLIST HERE!                          
FPRD20   B     FPRDX                                                            
*                                                                               
FPRD30   MVC   QPRD,=C'---'                                                     
         MVC   PRDNM,=CL20'TO BE ALLOCATED'                                     
         TM    SVOPTSW,OPTUNAL     UNALLOCATED UNITS OK                         
         BO    FPRDX                                                            
         CLI   SVTNPR3,C'Y'        TN PROF ALLOW UNALLOCATED UNITS              
         BE    FPRDX                                                            
         TM    UNTFLG,X'52'       DELETED/MISSED/TRAFFIC DELETE                 
         BNZ   FPRDX                                                            
         DC    H'0'                                                             
FPRDX    XIT1                                                                   
         LTORG                                                                  
         DROP  R6                                                               
         EJECT                                                                  
* GENERATE OFFLINE REQUEST FOR HARD COPY *                                      
* PUT OUT PROGRAM BY PROGRAM ONLY ONLINE *                                      
*                                                                               
REQ      NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING PRGTABLED,R5                                                     
         L     RC,SVADGEND                                                      
         USING GEND,RC                                                          
*                                                                               
         MVC   CONWHEN(2),=C'OV'                                                
         MVC   CONWHEN+2(L'CONWHEN-3),CONWHEN+3                                 
         MVI   CONWHEN+L'CONWHEN-1,C' '                                         
*                                                                               
         MVC   WORK(6),TRAPRG                                                   
         MVC   TRAPRG(6),PRGPRG                                                 
         ICM   R5,8,TRAPRGH+5                                                   
         MVI   TRAPRGH+5,6                                                      
         MVC   PRGPRG,WORK                                                      
*                                                                               
         LLC   R2,TRAOPTH+5                                                     
         LA    R3,TRAOPT(R2)                                                    
         LR    R6,R3                                                            
         SR    R4,R4                                                            
*                                                                               
         LTR   R2,R2                                                            
         BZ    REQ10                                                            
         MVI   0(R6),C','                                                       
         LA    R6,1(,R6)                                                        
         LA    R4,1                                                             
*                                                                               
REQ10    MVC   0(1,R6),BYTE         '#' FOLLOW UP AGY COPY                      
*                                   '@' OVERNIGTH FAX                           
         LA    R4,1(,R4)                                                        
         LA    RF,0(R2,R4)                                                      
         STC   RF,TRAOPTH+5                                                     
                                                                                
* MAKE SURE THE OVERNIGHT REQUEST IS NOT A PDF                                  
                                                                                
         MVC   FLDH(8+L'TRAWRKR),TRAWRKRH     SAVE OPTICA WKFILE NUM            
         MVI   TRAWRKRH+5,0        CLEAR FIELD LENGTH                           
         XC    TRAWRKR,TRAWRKR     AND CLEAR WORKER FILENUM                     
*                                                                               
         MVI   GCMODE,C'S'                                                      
         GOTO1 BLDREQST                                                         
         MVI   GCMODE,0                                                         
         LA    RF,GETTXTCB                                                      
         MVI   GTMSYS-GETTXTD(RF),0                                             
*                                                                               
         MVC   WORK(L'CONWHEN-3),CONWHEN+2                                      
         MVC   CONWHEN+3(L'CONWHEN-3),WORK                                      
         MVC   CONWHEN(3),=C'NOW'                                               
         XC    CONHEAD,CONHEAD                                                  
         MVC   WORK(6),PRGPRG                                                   
         MVC   PRGPRG,TRAPRG                                                    
         MVC   TRAPRG(6),WORK                                                   
         STCM  R5,8,TRAPRGH+5                                                   
*                                                                               
         EX    R4,REQCLR                                                        
         STC   R2,TRAOPTH+5                                                     
*                                                                               
         MVC   TRAWRKRH(8+L'TRAWRKR),FLDH   RESTORE WORKER FILENUM              
REQX     XIT1                                                                   
*                                                                               
REQCLR   MVC   0(0,R3),SPACES                                                   
         DROP  R5                                                               
         EJECT                                                                  
*=======================================================                        
* PRINT HARDCOPY USING TSAR                                                     
*=======================================================                        
                                                                                
PCPY     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         MVI   SPMODE,X'FF'                                                     
         GOTO1 SPOOL,DMCB,(R8)    FORCE CLOSE OF SPOOL                          
         MVI   PQSW,1                                                           
*                                                                               
         LA    R1,ELEM                                                          
         ST    R1,SPOOLQLK                                                      
         XC    ELEM(128),ELEM                                                   
         USING PQPLD,R1                                                         
*                                                                               
         BRAS  RE,INITREM          INITIALIZE PRT QUEUE ENTRY                   
*                                                                               
* RESTORE ORIGINAL REMOTE PRINT SETTINGS *                                      
*                                                                               
         MVC   REMUSER,SVREMUSR                                                 
*                                                                               
         GOTO1 OPENPQ                                                           
*                                                                               
         SR    R0,R0                                                            
         ST    R0,SPECS            NO HEADING SPECS                             
         ST    R0,HEADHOOK            HDHK                                      
         ST    R0,MIDHOOK             HDHK                                      
         ST    R0,FOOTHOOK            FTHK                                      
*                                                                               
         LA    R2,TSARBLK                                                       
         USING TSARD,R2                                                         
*                                                                               
         XC    BLOCK(256),BLOCK                                                 
         LA    R7,BLOCK                                                         
         ST    R7,TSAREC           SET ADDRESS OF THE RECORD                    
         USING TSBUFD,R7                                                        
*                                                                               
         LA    R0,1                                                             
         STCM  R0,3,TSRNUM                                                      
         MVI   SPACING,1                                                        
*                                                                               
PCPY10   MVI   TSACTN,TSAGET                                                    
         GOTO1 VTSAR,TSARD                                                      
*=====>                                                                         
*        XC    BLOCK(128),BLOCK                                                 
*        MVI   BLOCK,128                                                        
*        LA    R1,BLOCK+1                                                       
*        MVC   0(64,R1),0(R2)                                                   
*        MVC   64(64,R1),ELEM                                                   
*        GOTO1 DATAMGR,DMCB,=C'DMTRACE',=C'DATA',BLOCK                          
*=====>                                                                         
         TM    TSERRS,X'90'        END OF FILE                                  
         BNZ   PCPYX                                                            
         CLI   TSERRS,0                                                         
         BE    PCPY20                                                           
         DC    H'0'                                                             
PCPY20   MVI   SPACING,1                                                        
         CLC   BLOCK+98(9),=C'REQUESTOR'                                        
         BNE   PCPY25                                                           
         MVC   BLOCK+108(3),REMUSER                                             
         SR    R0,R0                                                            
         ICM   R0,3,SPOOLRPN                                                    
         EDIT  (R0),(5,BLOCK+112),ALIGN=LEFT                                    
*                                                                               
PCPY25   CLI   TSBUFHED,C'Y'        IS THERE ANY FORCEHED                       
         BE    PCPY30               YES                                         
         CLI   TSBUFSPC,0           IS THERE ANY SPACING BEFORE                 
         BE    PCPY30               NO                                          
         MVC   SPACING,TSBUFSPC                                                 
         MVI   TSBUFSPC,0           SET OFF FOR LATER                           
         MVI   P,0                                                              
*                                                                               
         GOTO1 SPOOL,DMCB,(R8)                                                  
*                                                                               
PCPY30   SR    R1,R1                                                            
         ICM   R1,3,TSBUFLEN                                                    
         AHI   R1,-7                                                            
         EX    R1,PCPYMVC                                                       
         CLI   TSBUFHED,0          IS THERE ANY FORCEHED                        
         BE    *+10                                                             
         MVC   FORCEHED,TSBUFHED                                                
*                                                                               
         CLI   TSBUFSPC,0           IS THERE ANY SPACING                        
         BE    *+10                                                             
         MVC   SPACING,TSBUFSPC                                                 
*                                                                               
         GOTO1 SPOOL,DMCB,(R8)                                                  
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,3,TSRNUM                                                      
         LA    RF,1(RF)                                                         
         STCM  RF,3,TSRNUM                                                      
         B     PCPY10                                                           
*                                                                               
PCPYX    DS    0H                                                               
*                                                                               
         XIT1                                                                   
*                                                                               
PCPYMVC  MVC   P(0),BLOCK+6                                                     
         DROP  R2                                                               
         EJECT                                                                  
*====================================================                           
* FIND IF THIS PRD DIST LIST IS EQUAL TO ANY PREV                               
*====================================================                           
                                                                                
FEQ      NTR1  BASE=*,LABEL=*                                                   
         L     RC,SVADGEND                                                      
         USING GEND,RC                                                          
         BRAS  RE,GETEL                                                         
         LLC   R4,1(R6)                                                         
*                                                                               
FEQ10    BRAS  RE,NEXTEL                                                        
         BNE   FEQ20                                                            
         LLC   R0,1(R6)                                                         
         AR    R4,R0                                                            
         B     FEQ10                                                            
*                                                                               
FEQ20    STC   R4,4(R5)            SAVE TOTAL DIST LIST LEN                     
         L     R6,AIO3                                                          
         LA    R6,3520(,R6)                                                     
*                                                                               
FEQ30    CR    R5,R6               END OF LIST                                  
         JE    NEQXIT                                                           
         OC    0(SVPRDENT,R6),0(R6) ANY ENTRY                                   
         BZ    FEQ36                                                            
         CLM   R4,1,4(R6)          WAS THIS THE SAME LEN                        
         BNE   FEQ36               NOT SAME LIST THEN                           
         L     R1,AIO1                                                          
         LA    R1,1000(,R1)                                                     
         ST    R1,AIO                                                           
         MVC   KEY+14(4),0(R6)                                                  
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
         MVC   AIO,AIO1                                                         
         LA    R0,24(,R1)                                                       
         LR    R1,R4                                                            
         LR    RF,R1                                                            
         L     RE,AIO1                                                          
         LA    RE,24(,RE)                                                       
         CLCL  R0,RE                                                            
         JE    EQXIT                                                            
FEQ36    LA    R6,SVPRDENT(,R6)                                                 
         B     FEQ30                                                            
         J     NEQXIT                                                           
         LTORG                                                                  
         EJECT                                                                  
*===============================================================                
* PRINT ANY TEXT BY PRODUCT                                                     
*===============================================================                
                                                                                
PTX      NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         STH   R6,HALF             COUNT OF PRODUCTS                            
         L     R5,AIO3                                                          
         LA    R5,3520(,R5)                                                     
*                                                                               
         BRAS  RE,INITSPT                                                       
*                                                                               
PTX10    XC    KEY,KEY             BUILD TEXT RECORD KEY                        
         MVC   KEY(2),=X'0A23'                                                  
         MVC   KEY+2(3),BAGYMD     A-M/CLT                                      
         MVC   KEY+5(3),0(R5)      PRODUCT                                      
         MVI   KEY+8,C'H'                                                       
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE     TEST TEXT FOUND                              
         BNE   PTX40                                                            
*                                                                               
         L     R6,AIO1                                                          
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
*                                                                               
         L     R2,APRTBUFF                                                      
         MVC   0(14,R2),=C'PRODUCT CODE ='                                      
         MVC   17(3,R2),0(R5)                                                   
         LA    R2,132(R2)                                                       
*                                                                               
         MVI   BYTE,0                                                           
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BNE   *+10                                                             
         MVC   BYTE,2(R6)          SAVE IND BYTE                                
*                                                                               
         L     R6,AIO                                                           
         MVI   ELCODE,X'40'                                                     
         BNE   PTX40                                                            
         BRAS  RE,GETEL                                                         
         CLC   =C'NONE ',3(R6)                                                  
         BE    PTX40                                                            
         TM    BYTE,X'80'          TEST TO BOX COMMENT                          
         BZ    PTX20                                                            
         GOTO1 VBOXER,DMCB,(60,AIO2)   FORMAT COMMENT                           
         B     PTX030                                                           
         EJECT                                                                  
*======================================================                         
* FORMAT UNBOXED COMMENT                                                        
*======================================================                         
                                                                                
PTX20    L     R4,AIO2                                                          
         L     R6,AIO                                                           
         BRAS  RE,GETEL                                                         
*                                                                               
PTX22    MVC   0(60,R4),SPACES                                                  
         LLC   RE,1(R6)                                                         
         AHI   RE,-4                                                            
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R4),3(R6) *EXECUTED*                                         
         LA    R4,60(R4)                                                        
         BRAS  RE,NEXTEL                                                        
         BE    PTX22                                                            
         MVI   0(R4),0             SET EOL FLAG                                 
                                                                                
*=================================================================              
* FORMAT STANDARD TEXT TO PRINT LINES                                           
*=================================================================              
                                                                                
PTX030   BRAS  RE,GOSPL            PRINT HEADLINES                              
*                                                                               
         L     R4,AIO2             FORMATTED COMMENTS ARE HERE                  
         MVI   SPACING,1                                                        
*                                                                               
PTX032   LA    R1,P1                                                            
*                                                                               
PTX034   CLI   0(R4),0             TEST REACHED END OF COMMENTS                 
         BE    PTX40                                                            
         MVC   0(60,R1),0(R4)      MOVE COMMENT TO PRINT LINE                   
*                                                                               
         BRAS  RE,GOSPL                                                         
         LA    R4,60(R4)                                                        
         B     PTX034                                                           
*                                                                               
PTX40    LA    R5,SVPRDENT(R5)           NEXT PRODUCT                           
         LH    R0,HALF                                                          
         AHI   R0,-1                                                            
         STH   R0,HALF                                                          
         BP    PTX10                                                            
         XIT1                                                                   
         EJECT                                                                  
*==============================================================                 
* INITIALIZE NETIO                                                              
*==============================================================                 
                                                                                
ININETIO NTR1  BASE=*,LABEL=*                                                   
         L     R3,ANETBLK                                                       
         USING NETBLKD,R3                                                       
*                                                                               
         LR    R0,R3                                                            
         LA    R1,1024                                                          
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
         MVC   NBSELAGY,AGENCY                                                  
         MVC   NBSELMED,QMED                                                    
         MVC   NBSELAM,BAGYMD                                                   
         MVC   NBSELCLI,QCLT                                                    
         MVC   NBSELCL2,BCLT                                                    
         MVC   NBSELPRD,=C'ALL'                                                 
         MVC   NBSELPRG,BASEPRG                                                 
         FIXDT02                                                                
         GOTO1 DATCON,DMCB,(2,BASESTR),NBSELSTR                                 
         FIXDT02                                                                
         GOTO1 (RF),(R1),(2,BASEEND),NBSELEND                                   
*                                                                               
         XC    WORK,WORK           GET USER PROFILE INTO NBUSER                 
         MVC   WORK(4),=C'S0N0'                                                 
         MVC   WORK+4(2),AGENCY                                                 
         MVI   WORK+6,C'N'                                                      
         MVC   WORK+7(3),QCLT                                                   
         MVI   WORK+10,C'*'                                                     
         MVC   WORK+11(1),SVCLTOFF                                              
*                                                                               
         TM    SECFLAG,BLSSW       BRAND LEVEL SECURITY                         
         BZ    ININET05                                                         
*                                                                               
         TM    SECFLAG,NEPRDOFF    PRDS OFFICES NOT EQUAL                       
         BO    ININET05                                                         
*                                                                               
         MVC   WORK+11(1),SVPRDOFF ELSE USE PROD OFFICE                         
*                                                                               
ININET05 GOTO1 GETPROF,DMCB,WORK,NBUSER,DATAMGR GET PROFILE IN NBUSER           
         MVI   NBUSER+13,C'N'      DON'T SUPPRESS PRE-EMPTS                     
*                                                                               
         MVC   NBSELNET,NETWORK                                                 
         MVI   NBSELUOP,C'B'      GET MISSED (EST AND ACTUAL)                   
         MVI   NBDATA,C'U'                                                      
         MVI   NBSEQ,C'D'                                                       
         MVI   NBMODE,NBPROCUN                                                  
         MVC   NBAIO,AIO1                                                       
         MVI   NBSELTRF,C'B'       READ BOTH NETWORK AND TRAFFIC UNITS          
         OI    NBDMGOPT,X'08'      AND DELETED                                  
         L     R1,SYSPARMS                                                      
         L     RF,16(R1)           COMFACS ADDRESS                              
         ST    RF,NBACOM                                                        
*                                                                               
         TM    SVOPTSW1,OPTRACE                                                 
         BZ    ININET10                                                         
         MVI   NBTRCOPT,C'Y'                                                    
         MVC   NBPRINT,VPRINT                                                   
*                                                                               
ININET10 EQU   *                                                                
         GOTO1 CALLOV,DMCB,0,(C'R',X'00000A27')                                 
         ICM   RF,15,0(R1)                                                      
         BNZ   *+6                                                              
         DC    H'0'                                                             
         ST    RF,ANETIO                                                        
         XIT1                                                                   
         LTORG                                                                  
         EJECT                                                                  
*==========================================================                     
* UPDATE REVISION RECORDS AND DELETED UNITS                                     
*==========================================================                     
                                                                                
UPDR     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         BRAS  RE,INITXSP                                                       
*                                                                               
         BAS   RE,FNREVN           FIND NETWORK REVISION NUMBER                 
*                                                                               
         CLC   SVHIREVP,HIREVNN                                                 
         BNH   *+10                                                             
         MVC   HIREVNN,SVHIREVP    SAVE HIGHER REVISION NUM                     
*                                                                               
         L     R6,AIO1                                                          
         ST    R6,AIO                                                           
*                                                                               
         XC    KEY,KEY             WAS KEYSAVE                                  
         LA    R4,KEY                                                           
         USING REVXKEY,R4                                                       
         MVC   REVXKID,=X'0A1D'                                                 
         MVC   REVXKAM(3),BAGYMD AND BCLT                                       
         MVC   REVXKNET,NETWORK                                                 
         MVC   REVXKPRG,SVPRG                                                   
         MVC   REVXKPER,PERIOD                                                  
*                                                                               
         CLI   MYTN2PR6,C'W'       USING WEEKLY PERIOD                          
         BNE   *+18                                                             
         TM    SVFLAG,CONVSW       CONVERTED RECORDS?                           
         BNZ   *+10                YES, ALREADY SET                             
         MVC   REVXKPER,STDATEP                                                 
         MVC   REVXKNUM,SVPRGRVN                                                
*                                                                               
         OC    VOPTPROD,VOPTPROD   RUNNING BY PRODUCT                           
         BZ    *+10                                                             
         MVC   REVXKPRD,VOPTPROD                                                
*                                                                               
         OC    VOPTPRGR,VOPTPRGR   RUNNING BY PRODUCT GROUP                     
         BZ    *+10                                                             
         MVC   REVXKPGR,VOPTPRGR                                                
         DROP  R4                                                               
*                                                                               
         OC    SVPRGRVN(3),SVPRGRVN  IF BOTH NUMBER AND DATE ZERO               
         BZ    UPDR06                 THEN NO COMMERCIALS ASSIGNED              
*                                                                               
         TM    SVPRGFLG,PRGFLGDM  FORCE NEW REV?                                
         BO    UPDR06              YES                                          
*                                                                               
         GOTO1 HIGH                                                             
         CLC   KEY(32),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
* IF THE REVISION REC IS NOT FOUND, CHANCES ARE THAT THE AGENCY HAS             
* CHANGED TN2 PROFILE 1 - RUN BY PRODUCT OR PRODUCT GROUP.                      
* KEY+17 IS ZERO UNLESS RUNNING BY PRODUCT OR PRODUCT GROUP                     
*                                                                               
*                                                                               
* TO FIND OUT WHAT IS HAPPENING, DO REV LIST, LOOK ON RIGHT HAND SIDE           
* UNDER COMMENT FOR MIXED PGR=NNN OR PRD=XXX.  THEY HAVE TO BE                  
* CONSISTENT WITHIN THE TIME PERIOD (CAL/BRD MONTH OR WEEK) OF INSTR            
*                                                                               
UPDR01F  GOTO1 GETREC                                                           
*                                                                               
         L     R6,AIO                                                           
         CLC   KEY(32),0(R6)                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         USING REVREVEL,R6                                                      
*                                                                               
         GOTO1 DATCON,DMCB,(5,0),(3,REVIDATE)                                   
         OI    REVFLAG,REVINS                                                   
*                                                                               
         OC    VOPTPRGR,VOPTPRGR   RUNNING BY PRODUCT GROUP                     
         BZ    *+8                                                              
         OI    REVFLAG,REVPRGRP                                                 
*                                                                               
         CLI   SVTWPR06,C'N'       FAXED?                                       
         BE    *+8                  NO                                          
         OI    REVFLAG,REVFAX                                                   
*                                                                               
*VEN     TM    SVOPTSW2,OPTOVFAX   TEST OPTION OVERNIGHT FAX                    
*VEN     BO    UPDR10               YES, NO UPDATE                              
         TM    SVOPTSW1,OPTHDCPY    THIS A FOLLOW-UP COPY                       
         BO    UPDR10               NO UPDATE                                   
         TM    SVOPTSW,OPTTEST     THIS A TEST RUN                              
         BO    UPDR10               NO UPDATE                                   
         CLI   OFFLINE,C'Y'        IF ONLINE                                    
         BNE   *+12                 ALWAYS UPDATE                               
         CLI   TWAWRITE,C'Y'                                                    
         BNE   UPDR10               NO UPDATE                                   
*                                                                               
         BRAS  RE,BTIME                                                         
*                                                                               
         GOTO1 PUTREC                                                           
         B     UPDR10                                                           
         EJECT                                                                  
*==========================================================                     
* ADD NEW REVISION REC FOR NEW DEL/MISSED RECS THIS INSTR                       
*==========================================================                     
                                                                                
UPDR06   DS   0H                                                                
         BRAS  RE,UNTDIRHI                                                      
         BE    REFRERR             NEED TO REFRESH                              
*                                                                               
* BUILD NEW REVISION RECORD *                                                   
*                                                                               
         L     R6,AIO1                                                          
         XC    0(256,R6),0(R6)                                                  
         MVC   0(32,R6),KEYSAVE                                                 
         MVI   33(R6),42                                                        
*                                                                               
* BUILD NEW REVISION ELEMENT *                                                  
*                                                                               
         XC    ELEM,ELEM                                                        
         LA    R6,ELEM                                                          
         USING REVREVEL,R6                                                      
         MVI   REVREVEL,X'10'                                                   
         MVI   REVDTALN,(REVREVEQ-REVREVEL)                                     
         GOTO1 DATCON,DMCB,(5,0),(3,REVIDATE)                                   
         MVC   REVADATE,REVIDATE                                                
         CLC   HIREVNN,SVPRGRVN    COMPARE NET # W/PROG #                       
         BNL   *+6                                                              
         DC    H'0'                BUG CATCHER, NET # LESS THEN PRG #           
*                                                                               
         MVC   REVNNUM,HIREVNN     NETWORK REVISION NUMBER                      
         OI    REVFLAG,REVINS                                                   
*                                                                               
         OC    VOPTPRGR,VOPTPRGR   RUNNING BY PRODUCT GROUP                     
         BZ    *+8                                                              
         OI    REVFLAG,REVPRGRP                                                 
*                                                                               
         CLI   MYTN2PR6,C'B'                                                    
         BNE   *+12                                                             
         OI    REVFLAG,REVBRD      TURN ON PERIOD IS BROAD MONTH                
         B     *+16                                                             
         CLI   MYTN2PR6,C'C'                                                    
         BNE   *+8                                                              
         OI    REVFLAG,REVCAL      TURN ON PERIOD IS CALENDAR MONTH             
*                                                                               
         CLI   SVTWPR06,C'N'       FAXED?                                       
         BE    *+8                  NO                                          
         OI    REVFLAG,REVFAX                                                   
*                                                                               
         GOTO1 ADDELEM                                                          
*                                                                               
* BUILD NEW REVISION COMMENT ELEMENT *                                          
*                                                                               
         XC    ELEM,ELEM                                                        
         USING REVCMTEL,R6                                                      
         MVI   REVCMTEL,X'40'                                                   
         MVI   REVCMTLN,63                                                      
         MVI   REVNUMB,1                                                        
         MVC   REVCMT,SPACES                                                    
         MVC   REVCMT(40),=C'DELETED UNITS SINCE LAST INSTRUCTIONS ON'          
*                                                                               
         OC    SVPRGRVN(3),SVPRGRVN  IF BOTH NUMBER AND DATE ZERO               
         BNZ   *+10                   THEN NO COMMERCIALS ASSIGNED              
         MVC   REVCMT(40),=C'INSTRUCTIONS HAVE BEEN RUN ON PROGRAM   '          
*                                                                               
         GOTO1 DATCON,DMCB,(3,SVPRGIDT),(5,REVCMT+41)                           
         GOTO1 ADDELEM                                                          
*                                                                               
         LA    R6,ELEM                                                          
         USING REVTSEL,R6                                                       
         MVI   REVTSEL,X'20'                                                    
         MVI   REVTSLN,(REVTSEQ-REVTSEL)  ELEM LENGTH                           
         GOTO1 DATCON,DMCB,(5,0),(3,REVIDTE)  TODAY'S DATE                      
*                                                                               
         GOTO1 ADDELEM                                                          
*                                                                               
         TM    SVOPTSW,OPTTEST     THIS A TEST RUN                              
         BO    UPDR10              NO UPDATE                                    
*                                                                               
         GOTO1 ADDREC                                                           
*                                                                               
*===========================================================                    
* UPDATE OR ADD NEW NET RECAP RECORD FOR CAD ONLY                               
*===========================================================                    
*                                                                               
UPDR10   CLI   OPTICASW,C'Y'       CAD OPTICA CLIENT                            
         BNE   *+8                                                              
         BAS   RE,BRECAP                                                        
*                                                                               
         EJECT                                                                  
* GO THRU UNIT TABLE AND UPDATE PRINTED ON INSTR FLAGS *                        
*                                                                               
         BRAS  RE,INITNET          CHANGE TO NET                                
*                                                                               
         L     R5,AUNTABLE                                                      
         USING UNTABLED,R5                                                      
         L     R6,AIO1                                                          
*                                                                               
UPDR20   TM    UNTFLG,X'08'        FEED                                         
         BO    UPDR50                                                           
         TM    UNTFLG,X'52'       DELETED/MISSED UNIT                           
         BZ    UPDR30               NO                                          
         TM    UNTFLG,X'20'       INSTR PRINTED FOR THIS UNIT PREV RUN          
         BZ    UPDR50               BYPASS ANY DELETES NEVER PRINTED            
         B     UPDR34                                                           
*                                                                               
UPDR30   TM    UNTFLG1,UNTFLGPR   UNIT NEEDS REPRINTING ON INSTR                
         BO    UPDR34                                                           
*                                                                               
UPDR34   L     R6,AIO1                                                          
         LA    R0,UNTDSKAD                                                      
         MVI   RDUPDATE,C'Y'                                                    
         BRAS  RE,UNTFGET                                                       
*                                                                               
         LA    R6,ELEM                                                          
         XC    ELEM,ELEM                                                        
         USING NUCMLEL,R6                                                       
         MVI   ELCODE,X'21'                                                     
         GOTO1 REMELEM                                                          
*                                                                               
         MVI   NUCMLEL,X'21'                                                    
         MVI   NUCMLELN,NUCMLEND-NUCMLEL                                        
         OI    NUCMLFLG,X'10'     SET PRINTED ON INSTR FLAG                     
         NI    NUCMLFL2,X'FF'-NUCMLFLP SET OFF NEEDS PRINTING                   
*                                                                               
         TM    UNTFLG,X'52'       DELETED/MISSED UNIT                           
         BZ    UPDR36                                                           
         TM    NUCMLFLG,X'02'      DEL/MISSED PRINTED ON INSTR YET              
         BO    UPDR50               YES, DONE                                   
         OI    NUCMLFLG,X'02'      SET ON DEL/MISSED PRINTED ON INSTR           
         MVC   NUCMLREV,SVPRGRVN                                                
*                                                                               
UPDR36   TM    SVOPTSW1,OPTHDCPY   SKIP CODE ON FOLLOW-UP                       
         BNZ   UPDR40                                                           
*VEN     TM    SVOPTSW2,OPTOVFAX   TEST OPTION OVERNIGHT FAX                    
*VEN     BO    UPDR40               YES, NO UPDATE                              
         TM    UNTFLG,X'80'        WAS THERE A CHANGE IN DATE/PROD/LEN?         
         BNZ   *+12                                                             
         NI    NUCMLFL2,X'FF'-NUCMLACK    RESET FLAG                            
         B     *+8                                                              
         OI    NUCMLFL2,NUCMLACK   SET ERROR ACKNOWLEDGED BY NINS               
*                                                                               
UPDR40   GOTO1 ADDELEM                                                          
*                                                                               
         L     R6,AIO1                                                          
         MVI   ELCODE,X'23'                                                     
         BRAS  RE,GETEL                                                         
         BNE   UPDR46                                                           
UPDR44   NI    NUFDCFL2-NUFDCEL(R6),X'FF'-NUFDCFLP                              
         BRAS  RE,NEXTEL                                                        
         BE    UPDR44                                                           
*                                                                               
UPDR46   TM    SVOPTSW1,OPTHDCPY    THIS A FOLLOW-UP COPY                       
         BO    UPDR50               NO UPDATE                                   
*VEN     TM    SVOPTSW2,OPTOVFAX   TEST OPTION OVERNIGHT FAX                    
*VEN     BO    UPDR50               YES, NO UPDATE                              
         TM    SVOPTSW,OPTTEST     THIS A TEST RUN                              
         BO    UPDR50               YES, NO UPDATE                              
         CLI   OFFLINE,C'Y'        IF ONLINE                                    
         BNE   *+12                 ALWAYS UPDATE                               
         CLI   TWAWRITE,C'Y'                                                    
         BNE   UPDR50               NO UPDATE                                   
*                                                                               
         BAS   RE,AACTELEM         ADD F1 ELEM                                  
         LA    R0,UNTDSKAD                                                      
         L     R6,AIO                                                           
         BRAS  RE,UNTFPUT                                                       
*                                                                               
UPDR50   LR    RE,R5                                                            
         TM    UNTFLG2,UNITFDD     FEED NO NATIONAL ?                           
         BO    UPDR60               YES                                         
*                                                                               
UPDR55   LA    RE,UNTNEXT-UNTENT(RE)  BUMP TO NEXT UNIT                         
         TM    UNTFLG2-UNTENT(RE),UNITFDD    FEED NO NATIONAL ?                 
         BZ    UPDR60                                                           
         CLC   UNTDSKAD,UNTDSKAD-UNTENT(RE)  SAME DISK ADDRESS                  
         BNE   UPDR60               NO                                          
         LR    R5,RE                                                            
         B     UPDR55                                                           
*                                                                               
UPDR60   LA    R5,UNTNEXT          NEXT UNIT                                    
*                                                                               
         CLI   UNTADTEP,0          ANY MORE                                     
         BNE   UPDR20                                                           
*                                                                               
         DROP  R6,R5                                                            
UPDRX    XIT1                                                                   
*                                                                               
* CLIENT DISPLAYS NINS GEN, FLIPS TO NET ASSIGN, RETURNS TO NINS GEN            
* MUST BE FORCED TO REFRESH SO WE CAN GO THRU VK ROUTINE                        
*                                                                               
REFRERR  DS    0H                                                               
*                                                                               
         CLI   ERRFILSW,0          WAS ERROR FILE OPENED                        
         BE    TRAERR1              NO                                          
         CLI   ERRFILSW,1          BUG CATCHER                                  
         BE    *+6                                                              
         DC    H'0'                                                             
         BRAS  RE,PER               PRINT ERROR REPORT                          
*                                                                               
TRAERR1  LA    R2,TRACLTH                                                       
         MVC   8(3,R2),SPACES      CLEAR CLT                                    
         MVI   5(R2),3                                                          
         OI    6(R2),X'C0'         TRANSMIT, CURSON (X'80'+X'40')               
         NI    4(R2),X'FF'-X'20'   TURN OFF VALIDATED                           
*                                                                               
         XC    CONHEAD,CONHEAD                                                  
         MVC   CONHEAD(L'REFRMSG),REFRMSG                                       
         OI    CONHEADH+6,X'80'                                                 
*                                                                               
         CLI   OFFLINE,C'Y' BYPASS IF OFFLINE                                   
         BE    TRAERR10                                                         
*                                                                               
         XC    DMCB(24),DMCB                                                    
         LA    R1,=C'DMWRT '                                                    
         ST    R1,DMCB                                                          
         MVI   DMCB+8,0            SET PAGE 0  (TWA0)                           
         L     RE,ATWA                                                          
         MVC   DMCB+10(2),2(RE)    MOVE TERMINAL NUMBER                         
         MVC   DMCB+20(2),=C'L='                                                
         MVC   DMCB+22(2),=Y(TWA018K)                                           
         GOTO1 DATAMGR,DMCB,,=C'TEMPSTR',,ATWA                                  
         CLI   8(R1),0                                                          
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVI   DMCB+8,3            SET PAGE 3                                   
         GOTO1 (RF),(R1),,=C'TEMPSTR',,ASVNCLST                                 
         CLI   8(R1),0                                                          
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
TRAERR10 DS    0H                                                               
         DC    H'0',C'$ABEND'      'RESTORES' RECS WRITTEN                      
*                                                                               
REFRMSG  DC    C'DATA CHANGED, RE-INPUT CLIENT TO REFRESH'                      
         EJECT                                                                  
*                                                                               
*                                                                               
* BUILD RECAP RECORD (UPDATE OR ADD NEW)                                        
*                                                                               
BRECAP   NTR1                                                                   
         L     R5,ACMLTBL                                                       
         USING CMLTBLD,R5                                                       
*                                                                               
         OC    CMLSHCML,CMLSHCML   ANY ENTRIES                                  
         BZ    BRCX                 NO DONE                                     
*                                                                               
         CLI   SVMEDIA,C'S'        SYNDICATION                                  
         BNE   BRC00                                                            
*                                                                               
* READ PROGRAM RECORD FOR PROGRAM DAY AND TIME                                  
*                                                                               
         BRAS  RE,INITSPT          SWITCH TO SPT                                
*                                                                               
         LA    R4,KEY                                                           
         USING NPGKEY,R4                                                        
         MVC   NPGKTYP,=X'0D20'    NTWK PROGRAM REC (SPTDIR)                    
         MVC   NPGKAM,BAGYMD                                                    
         MVC   NPGKNET,NETMKT                                                   
         MVC   NPGKPROG,SVPRG                                                   
         MVC   NPGKEND,STDATEP                                                  
         DROP  R4                                                               
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(11),KEYSAVE     TEST SAME THROUGH PROG                       
         BE    *+6                                                              
         DC    H'0'                NO PROG RECORD ???                           
*                                                                               
         L     R6,AIO1                                                          
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
*                                                                               
         MVI   ELCODE,X'92'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         USING NPGEL92,R6                                                       
         MVC   SVPDAY,NPGDAY                                                    
         MVC   SVPTIME,NPGTIME                                                  
*                                                                               
         BRAS  RE,INITXSP                                                       
*                                                                               
* SEE IF RECAP RECORD FOR THIS NETWORK IS ALREADY THERE                         
BRC00    XC    KEY,KEY                                                          
         XC    ELEM,ELEM                                                        
         MVI   BYTE,0              INIT PUTREC/ADDREC FLAG                      
*                                                                               
         LA    R4,KEY                                                           
         USING NRCPKEY,R4                                                       
         MVC   NRCPKID,=X'0A20'    NET RECAP RECORD                             
         MVC   NRCPKAM(3),BAGYMD AND BCLT                                       
         MVC   NRCPCML,CMLSHCML    CML                                          
         MVC   NRCPNET,NETWORK     NETWORK                                      
         MVC   NRCPSMED,SVMEDIA    SUB-MEDIA                                    
         MVC   NRCPPROD,CMLPRO1    PRODUCT                                      
         MVC   NRCPPRO2,CMLPRO2    PRODUCT 2                                    
         CLI   SVMEDIA,C'S'        SYNDICATION                                  
         BNE   *+10                                                             
         MVC   NRCPPROG,SVPRG      YES, NEED PROGRAM                            
         DROP  R4                                                               
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(32),KEYSAVE     HAVE THE RECORD?                             
         BNE   BRC50                                                            
*                                                                               
         GOTO1 GETREC                                                           
*                                                                               
BRC01    L     R6,AIO                                                           
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         USING NRCPDTEL,R6                                                      
*                                                                               
* ARE DATES IN TABLE COMPLETE OUT OF DATE RANGE IN ELEM                         
BRC02    CLC   NRCPFTD,CMLLTD      FTD IN ELEM > LTD IN TABLE?                  
         BH    BRC20                                                            
         CLC   NRCPLTD,CMLFTD      LTD IN ELEM < FTD IN TABLE?                  
         BL    BRC10                                                            
*                                                                               
* DATE OVERLAP?                                                                 
BRC05    CLC   NRCPFTD,CMLFTD      FTD IN ELEM < FTD IN TABLE?                  
         BNH   *+14                                                             
         MVC   NRCPFTD,CMLFTD                                                   
         MVI   BYTE,C'C'           ELEMENT CHANGED, DO PUTREC                   
         CLC   NRCPLTD,CMLLTD                                                   
         BNL   BRC40               NEXT DATE RANGE FROM TABLE                   
         MVC   NRCPLTD,CMLLTD                                                   
         MVI   BYTE,C'C'           ELEMENT CHANGED, DO PUTREC                   
         B     BRC40               NEXT DATE RANGE FROM TABLE                   
                                                                                
* DATE RANGE IS ONE DAY APART?                                                  
BRC10    GOTO1 DATCON,DMCB,(3,CMLFTD),(0,WORK)                                  
         GOTO1 ADDAY,(R1),WORK,WORK+6,F'-1' MINUS 1 FROM TO FTD                 
         GOTO1 DATCON,(R1),(0,WORK+6),(3,WORK+12)                               
         CLC   NRCPLTD,WORK+12     LTD IN ELEM = FTD IN TABLE -1                
         BNE   BRC20                                                            
         MVC   NRCPLTD,CMLLTD      SAVE LATER LTD                               
         MVI   BYTE,C'C'           ELEMENT CHANGED, DO PUTREC                   
         B     BRC40               DONE, DATES ARE MERGED                       
*                                                                               
BRC20    GOTO1 DATCON,DMCB,(3,CMLLTD),(0,WORK)                                  
         GOTO1 ADDAY,(R1),WORK,WORK+6,F'1' ADD 1 TO TO LTD                      
         GOTO1 DATCON,(R1),(0,WORK+6),(3,WORK+12)                               
         CLC   NRCPFTD,WORK+12     FTD IN ELEM = LTD IN TABLE +1                
         BNE   BRC30                                                            
         MVC   NRCPFTD,CMLFTD      SAVE EARLIER FTD                             
         MVI   BYTE,C'C'           ELEMENT CHANGED, DO PUTREC                   
         B     BRC40               NEXT DATE RANGE FROM TABLE                   
*                                                                               
BRC30    BRAS  RE,NEXTEL                                                        
         BE    BRC02                                                            
*                                                                               
* ADD NEW ELEMENT                                                               
         XC    ELEM,ELEM                                                        
         LA    R6,ELEM                                                          
         USING NRCPDTEL,R6                                                      
         MVI   NRCPDTEL,X'10'                                                   
         MVI   NRCPDTLN,(NRCPDTX-NRCPDTEL)                                      
         MVC   NRCPFTD,CMLFTD      FTD                                          
         MVC   NRCPLTD,CMLLTD      LTD                                          
         MVC   NRCPIDTE,BTODAY     CML INSTR DATE                               
*                                                                               
         GOTO1 ADDELEM                                                          
         DROP  R6                                                               
*                                                                               
         MVI   BYTE,C'P'           NEED PUTREC                                  
         B     BRC70                                                            
*                                                                               
BRC40    LA    R5,CMLTBLLN(R5)     BUMP TO NEXT ENTRY IN TABLE                  
         CLI   0(R5),0                                                          
         BE    BRC77               DONE                                         
*                                                                               
         USING NRCPKEY,R4                                                       
         CLC   NRCPCML,CMLSHCML    SAME COMMERCIAL?                             
         BNE   BRC45                                                            
         CLC   NRCPPROD(6),CMLPRO1 SAME PRODS?                                  
         BE    BRC01                                                            
         DROP  R4                                                               
*                                                                               
BRC45    CLI   BYTE,C'P'                                                        
         BE    BRC75                                                            
         CLI   BYTE,C'C'                                                        
         BE    BRC75                                                            
         B     BRC00                                                            
*                                                                               
* BUILD NEW RECAP RECORD                                                        
*                                                                               
BRC50    MVC   KEY,KEYSAVE                                                      
         L     R6,AIO1                                                          
         XC    0(256,R6),0(R6)                                                  
         MVC   0(32,R6),KEYSAVE                                                 
         MVI   33(R6),42                                                        
         TM    CMLFLAG,ADIDSW      IS CML PACKED ADID                           
         BZ    BRC60                                                            
         OI    KEY+32,X'01'        SET STATUS CML PACKED ADID                   
         OI    34(R6),X'01'                                                     
*                                                                               
* ADD NEW ELEMENT                                                               
BRC60    XC    ELEM,ELEM                                                        
         LA    R6,ELEM                                                          
         USING NRCPDTEL,R6                                                      
         MVI   NRCPDTEL,X'10'                                                   
         MVI   NRCPDTLN,(NRCPDTX-NRCPDTEL)                                      
         MVC   NRCPFTD,CMLFTD      FTD                                          
         MVC   NRCPLTD,CMLLTD      LTD                                          
         MVC   NRCPIDTE,BTODAY     CML INSTR DATE                               
*                                                                               
         GOTO1 ADDELEM                                                          
         DROP  R6                                                               
*                                                                               
         MVI   BYTE,C'A'           NEED ADDREC                                  
*                                                                               
BRC70    LA    R5,CMLTBLLN(R5)     BUMP TO NEXT ENTRY IN TABLE                  
         CLI   0(R5),0                                                          
         BE    BRC75               DONE                                         
*                                                                               
         USING NRCPKEY,R4                                                       
         CLC   NRCPCML,CMLSHCML    SAME COMMERCIAL?                             
         BNE   BRC75                                                            
         CLC   NRCPPROD(6),CMLPRO1 SAME PRODS?                                  
         BNE   BRC75                                                            
         DROP  R4                                                               
*                                                                               
         CLI   BYTE,C'A'                                                        
         BE    BRC60                                                            
         B     BRC01                                                            
*                                                                               
BRC75    CLI   SVMEDIA,C'S'        SYNDICATION                                  
         BNE   BRC77                                                            
*                                                                               
         CLI   BYTE,C'C'           IF PUTREC                                    
         BE    *+12                                                             
         CLI   BYTE,C'P'           IF PUTREC                                    
         BNE   BRC75C                                                           
*                                                                               
         L     R6,AIO              LOOK FOR SYNDICATION ELEM                    
         MVI   ELCODE,X'20'                                                     
         BRAS  RE,GETEL                                                         
         BE    BRC77                                                            
*                                                                               
*ADD SYNDICATION DATA ELEMENT                                                   
BRC75C   XC    ELEM,ELEM                                                        
         LA    R6,ELEM                                                          
         USING NRCPSNEL,R6                                                      
         MVI   NRCPSNEL,X'20'                                                   
         MVI   NRCPSNLN,(NRCPSNX-NRCPSNEL)                                      
         MVC   NRCPPRG,SVPRG       PROGRAM CODE                                 
         MVC   NRCPDAY,SVPDAY      PROGRAM DAY                                  
         MVC   NRCPTIME,SVPTIME    PROGRAM TIME                                 
         FIXDT02                                                                
         GOTO1 DATCON,DMCB,(2,SVPGEND),(3,DUB)                                  
         MVC   NRCPEDTE,DUB        PRGRAM END DATE                              
*                                                                               
         GOTO1 ADDELEM                                                          
         DROP  R6                                                               
*                                                                               
*GO THRU ALL ELEMS ONE MORE TIME                                                
BRC77    BAS   RE,CELEMS           COMBINE ELEMENTS IF DATES MERGE              
*                                                                               
         TM    SVOPTSW,OPTTEST     THIS A TEST RUN                              
         BO    BRC90               NO UPDATE                                    
*                                                                               
         TM    SVOPTSW1,OPTHDCPY   IF AGENCY COPY RUN                           
         BO    BRC90               NO UPDATE                                    
*                                                                               
         CLI   OFFLINE,C'Y'        IF OFFLINE                                   
         BNE   *+12                 CK UPDATE                                   
         CLI   TWAWRITE,C'Y'                                                    
         BNE   BRC90                                                            
*                                                                               
         CLI   BYTE,C'A'           ADD REC ?                                    
         BNE   BRC80                                                            
*                                                                               
         MVC   SAVEKEY,KEY                                                      
         GOTO1 ADDREC                                                           
         CLI   8(R1),0                                                          
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVI   BYTE,0                                                           
         B     BRC90                                                            
*                                                                               
BRC80    CLI   BYTE,C'C'                                                        
         BE    BRCPUT                                                           
*                                                                               
         OC    ELEM,ELEM           DID WE ADD ANY ELEMENTS                      
         BZ    BRC90                                                            
*                                                                               
         CLI   BYTE,C'P'                                                        
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
BRCPUT   GOTO1 PUTREC                                                           
         MVI   BYTE,0                                                           
*                                                                               
BRC90    CLI   0(R5),0                                                          
         BNE   BRC00               PROCESS NEXT CML                             
*                                                                               
BRCX     XIT1                                                                   
*                                                                               
*                                                                               
* GO THRU ELEMENTS ONE MORE TIME                                                
* AND COMBINE ELEMS WITH DATES THAT CAN MERGE                                   
*                                                                               
CELEMS   NTR1                                                                   
         L     R6,AIO                                                           
         MVI   ELCODE,X'10'                                                     
         USING NRCPDTEL,R6                                                      
         BRAS  RE,GETEL                                                         
         LR    R2,R6               SAVE ELEM ADDRESS                            
R        USING NRCPDTEL,R2                                                      
         BRAS  RE,NEXTEL                                                        
         BNE   CELX                                                             
*                                                                               
CEL02    MVI   OPTION2,0           INIT RECUP FLAG                              
         CLI   0(R6),X'10'         POINTING TO 10 ELEM                          
         BNE   CELX                NO, DONE                                     
*                                                                               
         CLC   R.NRCPFTD,NRCPLTD   FTD > LTD?                                   
         BH    CEL20                                                            
         CLC   R.NRCPLTD,NRCPFTD   LTD < FTD?                                   
         BL    CEL10                                                            
*                                                                               
* DATE OVERLAP?                                                                 
CEL05    CLC   R.NRCPFTD,NRCPFTD     FTD IN ELEM < FTD IN TABLE?                
         BNH   CEL08                                                            
         MVC   R.NRCPFTD,NRCPFTD                                                
         GOTO1 VRECUP,DMCB,(C'T',AIO),(R6)  DELETE THIS ELEMENT                 
         MVI   OPTION2,1                                                        
         CLI   BYTE,0                                                           
         BNE   *+8                                                              
         MVI   BYTE,C'C'             NEED PUTREC                                
*                                                                               
CEL08    CLC   R.NRCPLTD,NRCPLTD                                                
         BH    CEL30               GET NEXT ELEM                                
         MVC   R.NRCPLTD,NRCPLTD                                                
         GOTO1 VRECUP,DMCB,(C'T',AIO),(R6)  DELETE THIS ELEMENT                 
         MVI   OPTION2,1                                                        
         CLI   BYTE,0                                                           
         BNE   *+8                                                              
         MVI   BYTE,C'C'             NEED PUTREC                                
         B     CEL30                                                            
                                                                                
* DATE RANGE IS ONE DAY APART?                                                  
CEL10    GOTO1 DATCON,DMCB,(3,NRCPFTD),(0,WORK)                                 
         GOTO1 ADDAY,(R1),WORK,WORK+6,F'-1' MINUS 1 FROM TO FTD                 
         GOTO1 DATCON,(R1),(0,WORK+6),(3,WORK+12)                               
         CLC   R.NRCPLTD,WORK+12   LTD IN ELEM = FTD IN TABLE -1                
         BNE   CEL20                                                            
         MVC   R.NRCPLTD,NRCPLTD   SAVE LATER LTD                               
         GOTO1 VRECUP,DMCB,(C'T',AIO),(R6)  DELETE THIS ELEMENT                 
         MVI   OPTION2,1                                                        
         CLI   BYTE,0                                                           
         BNE   *+8                                                              
         MVI   BYTE,C'C'             NEED PUTREC                                
         B     CEL30               DONE, DATES ARE MERGED                       
*                                                                               
CEL20    GOTO1 DATCON,DMCB,(3,NRCPLTD),(0,WORK)                                 
         GOTO1 ADDAY,(R1),WORK,WORK+6,F'1' ADD 1 TO TO LTD                      
         GOTO1 DATCON,(R1),(0,WORK+6),(3,WORK+12)                               
         CLC   R.NRCPFTD,WORK+12   FTD IN ELEM = LTD IN TABLE +1                
         BNE   CEL30                                                            
         MVC   R.NRCPFTD,NRCPFTD   SAVE EARLIER FTD                             
         GOTO1 VRECUP,DMCB,(C'T',AIO),(R6)  DELETE THIS ELEMENT                 
         MVI   OPTION2,1                                                        
         CLI   BYTE,0                                                           
         BNE   *+8                                                              
         MVI   BYTE,C'C'             NEED PUTREC                                
                                                                                
CEL30    CLI   OPTION2,1           ELEM DELETED?                                
         BE    CEL02               YES, R6 POINTS TO NEXT ELEM                  
         LR    R2,R6               PT TO NEXT ELEM                              
         BRAS  RE,NEXTEL                                                        
         BE    CEL02                                                            
*                                                                               
CELX     XIT1                                                                   
         DROP  R,R6                                                             
*                                                                               
*                                                                               
* ADD F1 ACTIVITY ELEMENT                                                       
*                                                                               
AACTELEM NTR1                                                                   
         MVI   ELCODE,X'F1'                                                     
         L     R6,AIO                                                           
         BRAS  RE,GETEL                                                         
         BNE   ACTIV2                                                           
         USING ACTVD,R6                                                         
         GOTO1 REMELEM                                                          
         LA    R6,ELEM                                                          
         MVC   ACTVCHDT,BTODAY                                                  
         MVI   ACTVLEN,ACTVLENQ    NEW LENGTH                                   
         AI    ACTVCHNM,1          UP THE CHANGE NUMBER                         
*                                                                               
         LA    R3,ACTVCHID                                                      
         MVC   0(2,R3),TWAORIG     MOVE IN ID                                   
         GOTO1 GETFACT,DMCB,0                                                   
         L     R1,0(R1)                                                         
         USING FACTSD,R1                                                        
         TM    FATFLAG,X'08'       IS PASSWORD PROTECT ACTIVE                   
         BZ    ACTIV8                                                           
         MVC   0(2,R3),FAPASSWD    YES SO USE THIS ID                           
         OI    2(R3),X'80'                                                      
         DROP  R1                                                               
         B     ACTIV8                                                           
*                                                                               
ACTIV2   DS    0H                                                               
*        GOTO1 REMELEM                                                          
         XC    ELEM,ELEM                                                        
*                                                                               
         LA    R6,ELEM                                                          
         USING ACTVD,R6                                                         
         MVI   ACTVEL,X'F1'                                                     
         MVI   ACTVLEN,20                                                       
         MVC   ACTVADDT,BTODAY     SET DATE                                     
         MVC   ACTVCHDT,BTODAY                                                  
         LA    R3,ACTVADID                                                      
*                                                                               
ACTIV6   MVC   0(2,R3),TWAORIG     MOVE IN ID                                   
         GOTO1 GETFACT,DMCB,0                                                   
         L     R1,0(R1)                                                         
         USING FACTSD,R1                                                        
         TM    FATFLAG,X'08'       IS PASSWORD PROTECT ACTIVE                   
         BZ    ACTIV8                                                           
         MVC   0(2,R3),FAPASSWD    YES SO USE THIS ID                           
         OI    2(R3),X'80'                                                      
         DROP  R1                                                               
*                                                                               
ACTIV8   OC    ASECBLK,ASECBLK     IS NEW SECURITY ACTIVE                       
         BZ    ACTIV10                                                          
         L     R1,ASECBLK          NEW SECURITY BLOCK                           
         USING SECD,R1                                                          
         MVC   ACTVSCID,SECPID     USER'S PERSONAL ID                           
         MVI   ACTVLEN,ACTVLENQ    NEW LENGTH                                   
         DROP  R1                                                               
*                                                                               
ACTIV10  GOTO1 ADDELEM                                                          
         XIT1                                                                   
         EJECT                                                                  
* FIND NETWORK REVISION NUMBER *                                                
* READ ALL REVISION RECORDS FOR THAT PERIOD FOR ALL PROGRAMS *                  
*                                                                               
         DS    0H                                                               
FNREVN   NTR1                                                                   
         MVI   HIREVNN,0                                                        
         L     R6,AIO1                                                          
         ST    R6,AIO                                                           
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY              WAS KEYSAVE                                  
         USING REVXKEY,R4                                                       
         MVC   REVXKID,=X'0A1D'                                                 
         MVC   REVXKAM(3),BAGYMD AND BCLT                                       
         MVC   REVXKNET(4),NETWORK                                              
         MVC   REVXKPER,PERIOD                                                  
*                                                                               
         CLI   MYTN2PR6,C'W'       USING WEEKLY PERIOD                          
         BNE   *+18                                                             
         TM    SVFLAG,CONVSW       CONVERTED RECORDS?                           
         BNZ   *+10                YES, ALREADY SET                             
         MVC   REVXKPER,STDATEP                                                 
*                                                                               
* REVN05 BRAS  RE,UNTDIRHI                                                      
FNREVN05 MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(9),KEYSAVE      AM/CLT/NET                                   
         BNE   XFNREVN             MUST BE ORIGINAL                             
*                                                                               
FNREV05K MVC   KEYSAVE,KEY                                                      
*                                                                               
         CLI   MYTN2PR6,C'W'       USING WEEKLY PERIOD                          
         BNE   FNREV05P                                                         
         TM    SVFLAG,CONVSW       CONVERTED RECORDS?                           
         BZ    *+14                 NO                                          
         CLC   REVXKPER,PERIOD                                                  
         B     *+10                                                             
         CLC   REVXKPER,STDATEP    SAME PERIOD                                  
         BE    FNREVN10             YES, GO GET NET REV #                       
         BH    FREV05M                                                          
         MVC   REVXKPER,PERIOD     PRESET TO CONVERTED DATE                     
         TM    SVFLAG,CONVSW       CONVERTED RECORDS?                           
         BNZ   *+10                 YES                                         
         MVC   REVXKPER,STDATEP                                                 
         B     *+10                                                             
FREV05M  MVC   REVXKPER,=X'FFFF'   FORCE NEXT PROGRAM                           
*                                                                               
         XC    REVXKNUM(4),REVXKNUM CLEAR THE REST OF THE KEY                   
         B     FNREVN05                                                         
* MONTHLY                                                                       
FNREV05P CLC   REVXKPER,PERIOD                                                  
         BE    FNREVN10            GO GET NET REV #                             
         BH    *+14                                                             
         MVC   REVXKPER,PERIOD                                                  
         B     *+10                                                             
         MVC   REVXKPER,=X'FFFF'   FORCE NEXT PROGRAM                           
*                                                                               
         XC    REVXKNUM(4),REVXKNUM CLEAR THE REST OF THE KEY                   
         B     FNREVN05                                                         
*                                                                               
FNREVN10 L     R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
*NOP     BRAS  RE,UNTFGETK                                                      
         GOTO1 GETREC                                                           
*                                                                               
         CLC   KEY(17),0(R6)                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         USING REVREVEL,R6                                                      
*                                                                               
         CLI   REVDTALN,12         OLD REV REC                                  
         BE    FNREVN20                                                         
         CLC   HIREVNN,REVNNUM                                                  
         BNL   FNREVN20                                                         
         MVC   HIREVNN,REVNNUM     SAVE REV NET NUM                             
*                                                                               
FNREVN20 DS    0H                                                               
         MVC   KEYSAVE,KEY                                                      
         MVI   RDUPDATE,C'N'                                                    
*NOP     BRAS  RE,UNTDIRSQ                                                      
         GOTO1 SEQ                                                              
*                                                                               
         CLC   KEY(9),KEYSAVE      AM/CLT/NET                                   
         BE    FNREV05K                                                         
*                                                                               
XFNREVN  DS    0H                                                               
         XIT1                                                                   
         LTORG                                                                  
         DROP  R6                                                               
         EJECT                                                                  
*                                                                               
* BUILD/UPDATE TIME ELEMENT                                                     
*                                                                               
BTIME    NTR1  BASE=*,LABEL=*                                                   
         BRAS  RE,INITXSP                                                       
         L     R6,AIO                                                           
         MVI   ELCODE,X'70'                                                     
         BRAS  RE,GETEL                                                         
         BE    BTIM20                                                           
                                                                                
         XC    ELEM,ELEM                                                        
         USING REVTMEL,R6                                                       
         LA    R6,ELEM                                                          
         USING REVTMEL,R6                                                       
         MVI   REVTMEL,X'70'                                                    
         MVI   REVTMLN,REVTMEQ                                                  
         EDIT  (TIME,NOW),(8,WORK)                                              
         MVC   REVTIME(2),WORK                                                  
         MVC   REVTIME+2(2),WORK+3                                              
         MVC   REVTIME+4(2),WORK+6                                              
         FIXDT02                                                                
         GOTO1 DATCON,DMCB,(5,0),(2,REVDATE)                                    
         MVI   REVTPG,REVNINS                                                   
         OC    VOPTDATE,VOPTDATE                                                
         BZ    BTIM10                                                           
         MVC   REVDTOV,VOPTDATE                                                 
         MVC   REVDTOVR,REVDATE                                                 
                                                                                
BTIM10   GOTO1 ADDELEM                                                          
         B     BTIMXIT                                                          
                                                                                
BTIM20   DS    0H                                                               
         MVC   REVTIME2,REVTIME1                                                
         MVC   REVDATE2,REVDATE1                                                
         MVC   REVTPG2,REVTPG1                                                  
         MVC   REVTIME1,REVTIME                                                 
         MVC   REVDATE1,REVDATE                                                 
         MVC   REVTPG1,REVTPG                                                   
         EDIT  (TIME,NOW),(8,WORK)                                              
         MVC   REVTIME(2),WORK                                                  
         MVC   REVTIME+2(2),WORK+3                                              
         MVC   REVTIME+4(2),WORK+6                                              
         FIXDT02                                                                
         GOTO1 DATCON,DMCB,(5,0),(2,REVDATE)                                    
         MVI   REVTPG,REVNINS                                                   
         OC    VOPTDATE,VOPTDATE                                                
         BZ    BTIM30                                                           
         MVC   REVDTOV,VOPTDATE                                                 
         MVC   REVDTOVR,REVDATE                                                 
                                                                                
BTIM30   DS    0H                                                               
                                                                                
BTIMXIT  XIT1                                                                   
         EJECT                                                                  
*========================================================                       
* SUBROUTINE TO PRINT BOXES AROUND TEXT                                         
* AIO MUST HAVE RECORD ADDRESS                                                  
* ELCODE MUST CONTAIN COMMENT ELEM CODE                                         
* P1  (1) = MAXIMUM LEN OF EXPANDED COMMENT                                     
* P1+1(3) = EXPANDED COMMENT OUTPUT AREA                                        
*========================================================                       
                                                                                
BOXER    NTR1  BASE=*,LABEL=*                                                   
                                                                                
* FIRST - FIND LENGTH OF LONGEST COMMENT *                                      
                                                                                
         L     R7,0(R1)            GET OUTPUT AREA ADDRESS                      
         LLC   R4,0(R1)            GET OUTPUT RECORD SIZE                       
*                                                                               
         L     R6,AIO                                                           
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         SR    R5,R5                                                            
*                                                                               
BOX2     LLC   RE,1(R6)                                                         
         CLC   =C'BOX=',3(R6)                                                   
         BNE   *+8                                                              
         AHI   RE,-4                                                            
         CR    R5,RE                                                            
         BH    *+6                                                              
         LR    R5,RE                                                            
         BRAS  RE,NEXTEL                                                        
         BE    BOX2                                                             
*                                                                               
* LENGTH IN R5 INCLUDES 3 FOR ELCODE/LEN/SEQ - NOW ADJUST FOR                   
* '*/SP' AND 'SP/*' AT EITHER END                                               
*                                                                               
         LA    R5,1(R5)                                                         
*                                                                               
* CREATE ROW OF *'S THIS LENGTH                                                 
*                                                                               
         EX    R4,BOXSPC                                                        
         MVI   0(R7),C'*'                                                       
         BCTR  R5,0                ADJUST FOR FIRST *                           
         BCTR  R5,0                SET FOR EX                                   
         EX    R5,BOXR7                                                         
         AR    R7,R4               POINT TO NEXT OUTPUT LINE                    
         LA    R5,2(R5)            RESTORE LENGTH                               
*                                                                               
         L     R6,AIO                                                           
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         EJECT                                                                  
BOX4     EX    R4,BOXSPC                                                        
*                                                                               
         LLC   RE,1(R6)                                                         
         LA    RF,3(R6)                                                         
*                                                                               
         CLC   =C'BOX=',0(RF)                                                   
         BNE   *+12                                                             
         AHI   RE,-4                                                            
         LA    RF,4(RF)                                                         
*                                                                               
         MVI   0(R7),C'*'                                                       
         AHI   RE,-4               SET FOR EX                                   
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   2(0,R7),0(RF) *EXECUTED*                                         
*                                                                               
         LA    RE,0(R7,R5)         POINT TO END OF LINE                         
         BCTR  RE,0                BACK UP                                      
         MVI   0(RE),C'*'                                                       
         AR    R7,R4               POINT TO NEXT LINE                           
         BRAS  RE,NEXTEL                                                        
         BE    BOX4                                                             
*                                                                               
         EX    R4,BOXSPC                                                        
         MVI   0(R7),C'*'                                                       
         BCTR  R5,0                ADJUST FOR FIRST *                           
         BCTR  R5,0                SET FOR EX                                   
         EX    R5,BOXR7                                                         
         AR    R7,R4                                                            
         MVI   0(R7),0             SET END OF BUFFER FLAG                       
         J     EXIT                                                             
*                                                                               
BOXR7    MVC   1(0,R7),0(R7)  *EXECUTED*                                        
BOXSPC   MVC   0(0,R7),SPACES *EXECUTED*                                        
         EJECT                                                                  
* FIND END OF PRINT BUFFER                                                      
                                                                                
FNDBUFX  L     R2,APRTBUFF         FIND LAST PRINT LINE SO FAR                  
         CLC   0(132,R2),SPACES                                                 
         BER   RE                                                               
         LA    R2,132(R2)                                                       
         J     *-12                                                             
*                                                                               
CLRBUFF  NTR1                                                                   
         L     R0,APRTBUFF                                                      
         L     R1,APRTBUFX                                                      
         SR    R1,R0                                                            
         SR    RE,RE                                                            
         LA    RF,X'40'                                                         
         SLL   RF,24                                                            
         MVCL  R0,RE               FILL BUFFER WITH SPACES                      
         J     EXIT                                                             
                                                                                
*==========================================================                     
* COUNT NUMBER OF 132 CHAR PRINT LINES AT 0(R1)                                 
* AND PRINT THEM                                                                
*==========================================================                     
                                                                                
         USING SPOOLD,R8                                                        
PRTBUFF  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     R1,APRTBUFF         COUNT NUMBER OF PRINT LINES                  
         LR    R4,R1                                                            
         SR    R5,R5                                                            
*                                                                               
PRTBUFF2 CLI   0(R4),0             TEST FORCE PRINT                             
         BE    *+14                                                             
         CLC   0(132,R4),SPACES                                                 
         BNH   PRTBUFF4                                                         
         LA    R4,132(R4)                                                       
         BCT   R5,PRTBUFF2                                                      
*                                                                               
PRTBUFF4 LPR   R0,R5                                                            
         JZ    EXIT                                                             
*                                                                               
         MVC   SVSPCING,SPACING    SAVE SPACING VALUE                           
         MVI   SPACING,1                                                        
*                                                                               
PRTBUFF6 LA    R4,P                                                             
         LA    R5,4                                                             
         CR    R5,R0               TEST MORE THAN 4 LINES REMAIN                
         BL    PRTBUFF8                                                         
         LR    R5,R0               DO THE NUMBER THAT REMAIN                    
         MVC   SPACING,SVSPCING    AND RESTORE ORIGINAL SPACING                 
*                                                                               
PRTBUFF8 MVC   0(132,R4),0(R1)                                                  
         MVC   0(132,R1),SPACES    BLANK THE SOURCE NOW                         
         LA    R1,132(R1)                                                       
         LA    R4,132(R4)                                                       
         BCT   R5,PRTBUFF8                                                      
*                                                                               
         BRAS  RE,GOSPL            PRINT 4 LINES                                
         AHI   R0,-4                                                            
         BP    PRTBUFF6                                                         
         J     EXIT                                                             
         LTORG                                                                  
         EJECT                                                                  
GOSPL    NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     RE,APRTSAVE         SAVE THE PRINT LINES                         
         LA    RF,528                                                           
         LA    R0,P                                                             
         LA    R1,528                                                           
         MVCL  RE,R0                                                            
*                                                                               
         LLC   R0,SPACING                                                       
*                                                                               
GOSPL10  GOTO1 SPOOL,DMCB,(R8)     PRINT THE LINES                              
*                                                                               
         STC   R0,SPACING          RESTORE ORIGINAL SPACING                     
         L     R3,APRTSAVE         POINT TO SAVED PRINT LINES                   
         LA    R4,4                                                             
         BRAS  RE,GOTSR            PUT PRINT LINES TO TSAR                      
*                                                                               
GOSPLX   MVI   SPACING,1                                                        
*                                                                               
         LA    R1,P                                                             
         LA    R0,4                                                             
         MVC   0(132,R1),SPACES                                                 
         LA    R1,132(R1)                                                       
         BCT   R0,*-10                                                          
*                                                                               
         XIT1                                                                   
         LTORG                                                                  
         EJECT                                                                  
*=================================================================              
* SEND ALL PRINT LINES TO TSAR TO PRINT COPY LATER                              
* R3 POINTS TO FIRST PRINT LINE                                                 
* R4 HAS NUMBER OF PRINT LINES                                                  
*=================================================================              
                                                                                
GOTSR    NTR1 BASE=*,LABEL=*                                                    
         CLI   MFPRGSW,C'Y'        CHECK FOR MULTIPLE COPY                      
         BE    GOTSR10                                                          
         CLI   OFFLINE,C'Y'        OFFLINE                                      
         BNE   GOTSR02                                                          
         CLI   OPTICAGY,C'Y'       TEST OPTICA AGENCY COPY                      
         BE    GOTSR10                                                          
         CLI   SVTWPR06,C'2'       IS AGENCY COPY REQUIRED                      
         BNE   GOTSRX                                                           
         TM    SVOPTSW1,OPTHDCPY   TEST OPTION AGENCY COPY                      
         BO    GOTSRX                                                           
         TM    WHEN,X'20'          IF SOON, GET OUT                             
         BO    GOTSRX                                                           
         B     GOTSR10                                                          
*                                                                               
GOTSR02  CLI   SVTWPR06,C'2'       IS AGENCY COPY REQUIRED                      
         BNE   GOTSRX                                                           
         CLI   SVTWPR07,C'Y'       PRINT FAX COPY NOW                           
         BNE   GOTSRX                                                           
                                                                                
* TSAROFF OR TSAR WRITE TO HIGH STORAGE HERE                                    
                                                                                
GOTSR10  LA    R2,TSARBLK                                                       
         USING TSARD,R2                                                         
*                                                                               
         LA    R7,ELEM                                                          
         USING TSBUFD,R7                                                        
*                                                                               
         STC   R4,BYTE             SAVE NUMBER OF PRINT LINES                   
                                                                                
* FIND ADDRESS OF LAST LINE TO PRINT                                            
                                                                                
         LLC   R6,BYTE             GET NUMBER OF PRINT LINES                    
         BCTR  R6,0                                                             
         MHI   R6,132                                                           
         AR    R6,R3               POINT TO LAST PRINT LINE                     
*                                                                               
GOTSR20  CLC   0(132,R6),SPACES    TRAILING BLANK LINES DON'T PRINT             
         BNE   GOTSR30                                                          
         AHI   R6,-132                                                          
         BCT   R4,GOTSR20                                                       
*                                                                               
         LA    R4,1                IF ALL BLANK, SET FOR 1 LINE                 
*                                                                               
         LA    R0,1                IGNORE VERY FIRST LINE IF BLANK              
         CLM   R0,7,TSARCT                                                      
         BE    GOTSRX                                                           
*                                                                               
GOTSR30  XC    TSBUFD(TSBUFX-TSBUFD),TSBUFD  CLEAR TSAR RECORD                  
*                                                                               
         CLI   FORCEHED,C'Y'                                                    
         BNE   *+8                                                              
         MVI   TSBUFHED,C'Y'                                                    
*                                                                               
         CLI   HEADFLAG,C'H'       TEST PRINTING HEADLINES                      
         BNE   GOTSR32                                                          
         LA    R0,10               HEADS TAKE MORE THAN 10 LINES                
         CLM   R0,7,TSARCT         SKIP FORCEHED FOR VERY FIRST PAGE            
         BH    *+8                                                              
         MVI   TSBUFHED,C'Y'                                                    
         NI    HEADFLAG,X'FF'-X'40' DO THIS ONLY ONCE                           
*                                                                               
GOTSR32  LR    RF,R3                                                            
*                                                                               
         OC    0(132,RF),SPACES    MAKE COMPARE BELOW SIMPLER                   
         LA    RE,132              MAX PRINT POSITIONS                          
         LA    RF,131(R3)          POINT TO END OF PRINT LINE                   
*                                                                               
GOTSR34  CLI   0(RF),C' '          WORK OUT LINE LENGTH                         
         BH    GOTSR40                                                          
*                                                                               
         BCTR  RF,0                                                             
         BCT   RE,GOTSR34                                                       
*                                                                               
GOTSR40  LTR   RE,RE                                                            
         BZ    *+6                                                              
         BCTR  RE,0                                                             
         EX    RE,GOTSRMVC                                                      
*                                                                               
         LA    RE,7(RE)                                                         
         STCM  RE,3,TSBUFLEN       RECORD LENGTH                                
*                                                                               
         A     RE,TSARBYTE                                                      
         ST    RE,TSARBYTE         SAVE TOTAL BYTES USED                        
*                                                                               
         SR    R1,R1               COUNTER IS KEY                               
         ICM   R1,3,TSARCT                                                      
         LA    R1,1(R1)                                                         
         STCM  R1,3,TSARCT                                                      
         STCM  R1,3,TSBUFKEY                                                    
*                                                                               
         LA    R1,ELEM                                                          
         ST    R1,TSAREC                                                        
*                                                                               
         MVI   TSBUFSPC,0          SET NO SPACING OVERRIDE                      
         CLI   HEADFLAG,C'F'       TEST FOOTLINES PRINTING                      
         BE    GOTSR50                                                          
         CR    R3,R6               THIS LAST LINE TO PRINT                      
         BL    GOTSR50              NO                                          
         MVC   TSBUFSPC,SPACING    THEN PASS ORIGINAL SPACING VALUE             
         CLI   TSBUFSPC,1                                                       
         BNE   *+8                                                              
         MVI   TSBUFSPC,0                                                       
*                                                                               
GOTSR50  DS    0H                                                               
         CLI   OFFLINE,C'Y'        TEST OFFLINE                                 
         BE    GOTSR54                                                          
         MVI   TSACTN,TSAADD                                                    
         B     GOTSR56                                                          
*                                                                               
GOTSR54  DS   0H                                                                
         MVI   TSOFFACT,TSAADD      SET TSAROFF ADD                             
*                                                                               
GOTSR56  DS   0H                                                                
         GOTO1 VTSAR,TSARD                                                      
*&&TRC                                                                          
         CLI   OFFLINE,C'Y'                                                     
         BNE   GOTSR58                                                          
         L     R1,ATSARFIL                                                      
         LA    R0,ELEM                                                          
         PUT   (1),(0)                                                          
GOTSR58  EQU   *                                                                
*&&                                                                             
         CLI   TSERRS,0                                                         
         BE    GOTSR60                                                          
         DC    H'0'                                                             
*                                                                               
GOTSR60  LA    R3,132(R3)                                                       
         CR    R3,R6               TEST PRINTED ALL                             
         BH    GOTSRX              YES - EXIT                                   
         XC    TSBUFD(TSBUFX-TSBUFD),TSBUFD  CLEAR TSAR RECORD                  
         BCT   R4,GOTSR32                                                       
*                                                                               
GOTSRX   XIT1                                                                   
*                                                                               
GOTSRMVC MVC   ELEM+6(0),0(R3)                                                  
         DROP  R2,R7                                                            
         LTORG                                                                  
         EJECT                                                                  
*==============================================================                 
* HEADHOOK ROUTINE                                                              
*==============================================================                 
                                                                                
HDHK     NTR1  BASE=*,LABEL=*                                                   
         MVI   HEADFLAG,C'H'       SET FLAG FOR GOTSR                           
*                                                                               
         CLI   OFFLINE,C'Y'                                                     
         BNE   HDHK10                                                           
* OFFLINE                                                                       
         CLI   SVTWPR06,C'Y'       IF FAX ONLY RUN, NO SEQ # PRINTING           
         BE    HDHK10                                                           
*VEN     TM    SVOPTSW2,OPTOVFAX   TEST OPTION OVERNIGHT FAX                    
*VEN     BO    HDHK10               YES                                         
         TM    SVFLAG1,OVFAXSW     OVERNIGHT FAX                                
         BO    HDHK10               YES                                         
*                                                                               
         CLI   SVTWPR06,C'2'       THIS FAX AND COPY RUN                        
         BNE   HDHK08               NO, DO PRINT SEQ #                          
*                                                                               
         TM    WHEN,X'20'          IF SOON DO FAX NOW                           
         BO    HDHK10                                                           
*                                                                               
HDHK08   LH    RE,SEQNUM           PRINT SEQUENCE NUMBER                        
         CVD   RE,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  H1+104(4),DUB                                                    
         LA    RE,1(RE)                                                         
         STH   RE,SEQNUM                                                        
*                                                                               
HDHK10   CLI   SVTNPR6,C'Y'       BLANK AGENCY NAME & ADDRESS                   
         BE    HDHK12                                                           
         TM    SVOPTSW,OPTNAGY                                                  
         BZ    HDHK14                                                           
*                                                                               
HDHK12   MVC   H1+2(33),SPACES                                                  
         MVC   H2+2(33),SPACES                                                  
*                                                                               
         FIXDT02                                                                
HDHK14   GOTO1 DATCON,DMCB,(2,STDATEP),(5,H3+47)                                
         MVI   H3+55,C'-'                                                       
         FIXDT02                                                                
         GOTO1 (RF),(R1),(2,ENDATEP),(5,H3+56)                                  
*                                                                               
         LA    R1,H4                                                            
*                                                                               
         CLC   =C'OV',CONWHEN      OVERNIGHT                                    
         BNE   HDHK14C                                                          
*                                                                               
         CLI   SVTN2PRO+12,C'Y'    OV-FAX PROFILE IS SET ON                     
         BNE   HDHK14C                                                          
*                                                                               
         MVI   131(R1),X'70'       SPECIAL HEADING NEEDED (OV-FAX)              
*                                                                               
HDHK14C  CLI   SVPRGRVN,0          THIS ORIGINAL                                
         BE    HDHK15                                                           
         CLI   SVTN1PR5,C'C'       CHANGES ONLY OPTION                          
         BNE   HDHK15                                                           
         MVC   38(26,R1),=C'* C H A N G E S  O N L Y *'                         
         LA    R1,132(R1)                                                       
*                                                                               
HDHK15   TM    SVOPTSW1,OPTDPTSW   DAYPART SPECIFIC RUN?                        
         BZ    *+16                                                             
         MVC   42(8,R1),=C'DAYPART='                                            
         MVC   50(2,R1),QDPT2                                                   
*                                                                               
         TM    SVPRGFLG,PRGFAXCG   CHANGED SINCE FAX?                           
         BZ    HDHK18                                                           
         MVC   H4+105(06),=C'CHANGE'                                            
         CLC   SVPRGLFX,SVPRGRVN   LAST REVISION FAXED?                         
         BE    HDHK18               YES                                         
         MVC   H4+112(14),=C'LAST RVN FAXED'                                    
         EDIT  (B1,SVPRGLFX),(3,H4+127),ZERO=NOBLANK,ALIGN=LEFT                 
*                                                                               
HDHK18   TM    SVOPTSW,OPTTEST     TEST OPTION TEST                             
         BZ    *+10                                                             
         MVC   H5+85(16),=C'*** TEST RUN ***'                                   
*                                                                               
         TM    SVFLAG1,OVFAXSW     OVERNIGHT FAX                                
         BO    *+12                                                             
*VEN     TM    SVOPTSW2,OPTOVFAX   TEST OPTION OVERNIGHT FAX                    
*        BZ    HDHK20                                                           
*        MVC   H4+84(21),=C'*** OVERNIGHT FAX ***'                              
*                                                                               
*        TM    SVPRGFLG,PRGFAXCG   CHANGED SINCE FAX?                           
*        BZ    HDHK20                                                           
*        MVC   H4+105(08),=C'  CHANGE'                                          
*                                                                               
*        CLC   SVPRGLFX,SVPRGRVN   LAST REVISION FAXED?                         
*        BE    HDHK20               YES                                         
*        MVC   H4+114(14),=C'LAST RVN FAXED'                                    
*        EDIT  (B1,SVPRGLFX),(3,H4+130),ZERO=NOBLANK,ALIGN=LEFT                 
*VEN                                                                            
HDHK20   TM    UPDSW2,UNTCUTIN     PROCESSING CUTINS?                           
         BO    HDHK24                                                           
*                                                                               
HDHK22   CLC   PAGE,=H'1'                                                       
         BE    *+10                                                             
         MVC   H6+85(21),=C'***** CONTINUED *****'                              
*                                                                               
HDHK24   DS   0H                                                                
         MVC   H7+2(6),=C'CLIENT'                                               
         MVC   H7+13(3),QCLT                                                    
         MVC   H7+20(20),CLTNM                                                  
*                                                                               
         MVC   H7+50(11),=C'DATE ISSUED'                                        
         GOTO1 DATCON,DMCB,(5,0),(5,H7+69)                                      
*                                                                               
         MVC   H7+84(8),=CL8'ORIGINAL'                                          
         CLI   SVPRGRVN,0          THIS ORIGINAL                                
         BE    HDHK30                                                           
         MVC   H7+84(8),=C'REVISION'                                            
         EDIT  (B1,SVPRGRVN),(3,H7+94)                                          
*                                                                               
HDHK30   MVC   H8+2(7),=C'PRODUCT'                                              
         OC    VOPTPROD(5),VOPTPROD  TN2 BY PROD OR PGROUP?                     
         BNZ   *+14                                                             
         MVC   H8+20(7),=C'VARIOUS'                                             
         B     HDHK32                                                           
*                                                                               
         OC    VOPTPROD,VOPTPROD   TEST IF BY PRODUCT                           
         BZ    *+10                                                             
         MVC   H8+13(3),VOPTPROD                                                
         MVC   H8+20(20),VOPTPRNM                                               
*                                                                               
         OC    VOPTPRGR,VOPTPRGR   BY PRODUCT GROUP                             
         BZ    HDHK32               NO                                          
         MVC   H8+13(4),=C'PGR=   '                                             
         MVC   H8+17(1),SVTN2PRO+00                                             
         UNPK  DUB(5),VOPTPRGR(3)                                               
         LLC   RE,PGRLEN                                                        
         BCTR  RE,0                                                             
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   H8+18(0),DUB                                                     
         MVC   H8+22(24),SVPRGNAM                                               
*                                                                               
HDHK32   CLI   SVTNPR7,C'A'       BLANK AGENCY OF RECORD N & A                  
         BE    HDHK34                                                           
         MVC   H8+50(16),=C'AGENCY OF RECORD'                                   
         CLI   SVTNPR7,C'Y'       BLANK AGENCY OF RECORD N & A                  
         BE    HDHK34                                                           
         MVC   H8+69(33),USERNAME                                               
         CLC   USERNAME(33),SPACES   ANY USER NAME AND ADDRESS                  
         BH    *+10                                                             
         MVC   H8+69(33),SVUSER                                                 
*                                                                               
HDHK34    DS    0H                                                              
         MVC   H9+2(7),=C'PROGRAM'                                              
         MVC   H9+13(L'SVPRGNM),SVPRGNM                                         
         MVI   H9+30,C'('                                                       
         MVC   H9+31(6),SVPRG                                                   
         LA    R1,H9+36                                                         
         CLI   0(R1),C' '                                                       
         BH    *+8                                                              
         BCT   R1,*-8                                                           
         MVI   1(R1),C')'                                                       
*                                                                               
         MVC   H9+50(9),=C'ISSUED BY'                                           
         MVC   H9+69(30),SVISNAME                                               
*                                                                               
         CLI   SVTNPR16,C'Y'       SUPPRESS DAY/TIME                            
         BE    HDHK36              YES-NO DAY/TIME                              
         MVC   H10+2(8),=C'DAY/TIME'                                            
         GOTO1 UNDAY,DMCB,SVPRGDAY,H10+13                                       
         GOTO1 UNTIME,(R1),SVPRGTIM,H10+20                                      
*                                                                               
HDHK36 MVC     H10+69(40),SVISEMAL                                              
*                                                                               
         TM    UPDSW2,UNTCUTIN     PROCESSING CUTINS?                           
         BZ    HDHK38               NO                                          
*                                                                               
         MVC   H11+2(9),=C'MKT / STA'                                           
         MVC   H11+13(4),SVUNTMKT                                               
         MVI   H11+18,C'/'                                                      
*NOP     MVC   H11+20(4),NETWORK                                                
         MVC   H11+20(4),SVUNTPOS                                               
         B     HDHK40                                                           
*                                                                               
HDHK38   MVC   H11+2(7),=C'NETWORK'                                             
         MVC   H11+13(4),NETWORK                                                
         MVC   H11+18(30),SVNETADR                                              
         MVC   H12+13(L'SVMKTNM),SVMKTNM                                        
*                                                                               
HDHK40   CLI   SVTNPR9,C'M'        MEDIA ONLY                                   
         BE    HDHK60                                                           
         MVC   H11+51(3),=C'(S)'                                                
         CLI   SVTNPR9,C'S'        SKED ONLY                                    
         BE    HDHK60                                                           
         MVI   H11+52,C'B'                                                      
*                                                                               
HDHK60   MVC   H11+50(9),=C'TELEPHONE'                                          
         MVC   H11+69(24),SVISTEL                                               
*                                                                               
         LA    R1,H12                                                           
         OC    SVISFAX,SVISFAX     IS THERE A FAX NUMBER                        
         BZ    HDHK63                                                           
         MVC   50(11,R1),=C'CONTACT FAX'                                        
         MVC   69(L'SVISFAX,R1),SVISFAX                                         
         LA    R1,132(R1)                                                       
*                                                                               
HDHK63   TM    SVFLAG1,X'20'         TEST P/B                                   
         BZ    *+10                                                             
         MVC   H13+70(24),=C'***PIGGYBACKS PRESENT***'                          
*                                                                               
         TM    SVFLAG1,X'10'       TEST COPYSPLITS                              
         BZ    *+10                                                             
         MVC   H13+70(24),=C'***COPYSPLITS PRESENT***'                          
*                                                                               
         TM    SVFLAG1,X'30'       TEST COPYSPLITS AND P/B                      
         BNO   *+10                                                             
         MVC   H13+70(39),=C'***PIGGYBACKS AND COPYSPLITS PRESENT***'           
*                                                                               
*                                                                               
HDHK64   DS    0H                                                               
         TM    SVFLAG1,OVFAXSW     ARE WE DOING OV FAX NOW                      
         BO    HDHK66              IF YES - IT SHOULD PRINT *OV FAX*            
         TM    SVOPTSW1,OPTHDCPY   TEST OPTION AGENCY COPY                      
         BO    *+12                                                             
         CLI   SVTWPR06,C'2'       TEST 2 COPIES REQUIRED                       
         BNE   *+10                                                             
         MVC   H4+84(19),=C'*** AGENCY COPY ***'                                
*                                                                               
HDHK66   LA    R3,H1                                                            
         LA    R4,14                                                            
         BRAS  RE,GOTSR                                                         
*                                                                               
         CLI   OFFLINE,C'Y'        TEST OFFLINE                                 
         BE    HDHKX               YES                                          
         TM    SVOPTSW1,OPTHDCPY   TEST OPTION AGENCY COPY                      
         BO    HDHKX                                                            
* ONLINE DOES FAX FIRST, SO DON'T PRINT 'AGENCY COPY' NOW                       
         MVC   H4+84(19),SPACES                                                 
*                                                                               
HDHKX    LA    R3,SPACES           NEED A BLANK LINE AFTER HEADS                
         LA    R4,1                                                             
         BRAS  RE,GOTSR                                                         
         J     EXIT                                                             
         LTORG                                                                  
         EJECT                                                                  
*=========================================================                      
* MIDLINE  HOOK                                                                 
*=========================================================                      
                                                                                
MIDHK    NTR1  BASE=*,LABEL=*                                                   
         MVC   MID1,SPACES                                                      
         MVC   MID2,SPACES                                                      
         CLI   MIDFLAG,C'N'        TEST SUPPRESS MIDLINES                       
         BE    MIDHKX                                                           
*                                                                               
MIDHK2   CLI   MIDFLAG,C'A'        TEST PRINTING ADD'L DATA                     
         BE    MIDHK10                                                          
*                                                                               
         LA    RF,MIDLINEX-MIDLINE   SET LEN OF MIDLINE                         
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   MID1(0),MIDLINE                                                  
*                                                                               
         LA    RE,MIDLIN1                                                       
         LA    RF,MIDLIN1X-MIDLIN1                                              
         CLI   SVT3PROF+3,C'N'     TEST DO NOT PRINT POSN                       
         BNE   *+12                                                             
         LA    RE,MIDLIN2                                                       
         LA    RF,MIDLIN2X-MIDLIN2                                              
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   MID1+MIDLINEX-MIDLINE(0),0(RE)                                   
*                                                                               
         CLI   SVTN1PRF,C'Y'       SHOW PROD CODE                               
         BE    *+10                                                             
         MVC   MID1+16(4),SPACES                                                
         B     MIDHK20                                                          
*                                                                               
MIDHK10  MVC   MID1(33),=C'ADDITIONAL COMMERCIAL INFORMATION'                   
         MVC   MID2(33),=C'---------------------------------'                   
         CLI   CONTINUE,C'Y'                                                    
         BE    MIDHK12                                                          
         MVI   CONTINUE,C'Y'                                                    
         B     MIDHK20                                                          
*                                                                               
MIDHK12  MVC   MID1+33(10),=C' CONTINUED'                                       
         MVC   MID2+33(10),=C'----------'                                       
*                                                                               
MIDHK20  LA    R3,MID1                                                          
         LA    R4,2                                                             
         BRAS  RE,GOTSR                                                         
*                                                                               
         CLC   PAGE,=H'1'                                                       
         BNE   MIDHKX                                                           
         LA    R3,SPACES           NEED A BLANK LINE AFTER MIDS                 
         LA    R4,1                                                             
         BRAS  RE,GOTSR                                                         
*                                                                               
MIDHKX   XIT1                                                                   
*                                                                               
MIDLINE  DC    C'AIRDATE   LEN   PRD ---PRODUCT NAME--- -COMMERCIAL-'           
         DC    C'  ----COMMERCIAL TITLE-----'                                   
MIDLINEX EQU   *                                                                
MIDLIN1  DC    C' -POS- ---OTHER---'                                            
MIDLIN1X EQU   *                                                                
MIDLIN2  DC    C' ---OTHER---'                                                  
MIDLIN2X EQU   *                                                                
         LTORG                                                                  
         EJECT                                                                  
*=================================================================              
* FOOTLINE HOOK ROUTINE                                                         
* PUT FOOTLINE DATA IN P WHICH HAS BEEN SAVED BY SPOOL                          
* WHEN THIS ROUTINE RETURNS P=SPACES, IT WILL NOT BE CALLED AGAIN               
*=================================================================              
                                                                                
FTHK     NTR1  BASE=*,LABEL=*                                                   
         CLC   FOOTSW,FOOTLNS      TEST DONE ALL FOOTLINES YET                  
         BNL   FTHK20              YES - DONE                                   
         MVI   HEADFLAG,C'F'       TELL GOTSR FOOTLINES PRINTING                
*                                                                               
         LLC   RE,FOOTSW                                                        
         LA    RE,1(RE)                                                         
         STC   RE,FOOTSW                                                        
*                                                                               
         MVC   P,SPACES            FTHK DOES NOT CLEAR P                        
         MVI   P,0                 FORCE RETURN                                 
*                                                                               
         CLI   FOOTSW,1            TEST FIRST LINE                              
         BNE   FTHK10                                                           
         CLI   CONTINUE,C'N'       TEST TO SUPPRESS 'CONTINUED'                 
         BE    FTHK10              YES                                          
         MVC   P+2(40),=C'** INSTRUCTIONS CONTINUE ON NEXT PAGE **'             
         B     FTHKX                                                            
*                                                                               
FTHK10   LLC   R0,FOOTLNS          GET NUMBER OF FOOTLINES                      
         AHI   R0,-1                                                            
         BNP   FTHKX                                                            
         CLM   R0,1,FOOTSW         TEST REACHED NEXT TO LAST LINE               
         BL    FTHKX                                                            
*                                                                               
* CHECK FOR FOOTNOTE LINE *                                                     
*                                                                               
         CLI   CONTINUE,C'N'       TEST FINISHED                                
         BNE   FTHK20              NO - DON'T PRINT FOOTNOTE YET                
*                                                                               
         L     R2,ASVFTNT                                                       
         LLC   R0,FOOTSW                                                        
         AHI   R0,-2                                                            
         B     FTHK14                                                           
*                                                                               
FTHK12   CLI   0(R2),0             TEST MORE DATA                               
         BE    FTHK20                                                           
         LA    R2,60(R2)                                                        
*                                                                               
FTHK14   BCT   R0,FTHK12                                                        
*                                                                               
         CLI   0(R2),0             TEST ANYTHING ELSE TO PRINT                  
         BE    FTHK20                                                           
         MVC   P+2(60),0(R2)       MOVE IT IN                                   
         B     FTHKX               AND EXIT                                     
*                                                                               
FTHK20   MVI   FOOTSW,0                                                         
         MVC   P,SPACES                                                         
*                                                                               
FTHKX    LA    R3,P1                                                            
         LA    R4,1                                                             
         BRAS  RE,GOTSR                                                         
         XIT1                                                                   
         LTORG                                                                  
         EJECT                                                                  
*===========================================================                    
* PRINT OFFLINE ERROR REPORT *                                                  
*===========================================================                    
                                                                                
PER      NTR1  BASE=*,LABEL=*                                                   
         L     RC,SVADGEND                                                      
         USING GEND,RC                                                          
*                                                                               
         CLI   OFFLINE,C'Y'        IF NOT OFFLINE, BYPASS                       
         BNE   PER120                                                           
*                                                                               
         TM    WHEN,X'20'          THIS A SOON REQUEST                          
         BZ    PER01                                                            
*                                                                               
PERCC    CLI   SVTWPR06,C'2'       UNLESS REQUEST WITH COPY, BYPASS             
         BNE   PERCF                NO COPY                                     
*                                                                               
         MVI   BYTE,C'#'                                                        
         BAS   RE,AREQ             ADD AGY FOLLOW UP REQUEST                    
*                                                                               
PERCF    TM    SVOPTSW,OPTTEST     TEST OPTION TEST                             
         BO    PER00                                                            
*VEN     TM    SVOPTSW2,OPTOVFAX   DOING AN OV-FAX NOW ?                        
*VEN     BO    PER00                                                            
*                                                                               
* IF RUNNING FOR ALL PRODUCTS, UNLOCK ALL PRODS                                 
*                                                                               
         CLI   SVTN2PRO+00,C'0'                                                 
         BE    *+12                                                             
         CLI   SVTN2PRO+00,0                                                    
         BNE   ULOCK30             NOT AN ALL PRODUCT RUN                       
*                                                                               
         MVI   BYTE,0                                                           
         B     ULOCK100                                                         
*                                                                               
* IF RUNNING BY PRODUCT, UNLOCK THIS PRD                                        
*                                                                               
ULOCK30  CLI   SVTN2PRO+00,C'*'                                                 
         BNE   ULOCK50                                                          
*                                                                               
         MVC   BYTE,SVTN2PRO+00                                                 
         B     ULOCK100                                                         
*                                                                               
* IF RUNNING BY PGROUP, UNLOCK THIS PGROUP                                      
*                                                                               
ULOCK50  OC    VOPTPRGR,VOPTPRGR   PGOUP                                        
         BNZ   *+6                                                              
         DC    H'0'                BUG CATCHER                                  
         MVC   BYTE,SVTN2PRO+00                                                 
*                                                                               
ULOCK100 DS    0H                                                               
         OC    SVLOCK,SVLOCK       ANYTHING TO UNLOCK                           
         BZ    PER00                NO                                          
         MVC   DUB,SVLOCK          MOVE LOCK INFO                               
         MVC   SVCPROD,SVSVPROD                                                 
         MVI   DUB,C'U'                                                         
*                                                                               
         CLC   =C'GZ',AGENCY       GMMNY                                        
         BE    PER00                                                            
*                                                                               
         GOTO1 VALILOC,SVCPROD                                                  
*                                                                               
PER00    CLI   SVTWPR06,C'N'       IF NOT FAXING, PRINT ANY ERRORS              
         BNE   PER120                                                           
*                                                                               
PER01    DS    0H                                                               
         CLI   PQSW,1              PRINT QUE EVER OPENED                        
         BE    PER04                NO, SOME FUNNY ERRS FOR REPORT ONLY         
*                                                                               
         CLI   SVTWPR06,C'Y'       IF N OR 2, NO NEED TO SWITCH                 
         BNE   PER06                YES                                         
         TM    SVOPTSW1,OPTHDCPY   AGENCY COPY                                  
         BO    PER06                YES, NO SW                                  
                                                                                
* IF WE JUST DID FAX ONLY, NEED TO SWITCH BACK TO                               
* ORIGINAL SETTINGS FOR ANY ERROR REPORT AND LOGOS                              
                                                                                
PER01C   MVI   SPMODE,X'FF'                                                     
         GOTO1 SPOOL,DMCB,(R8)    FORCE CLOSE OF SPOOL                          
         MVI   PQSW,1                                                           
*                                                                               
         LA    R1,ELEM                                                          
         ST    R1,SPOOLQLK                                                      
         XC    ELEM(128),ELEM                                                   
         USING PQPLD,R1                                                         
         MVI   QLEXTRA,X'FF'       NEW PARM LIST                                
         OI    SPOOLIND,X'40'      USER VALUES PRESENT                          
*                                                                               
         ICM   RE,15,TWAMASTC                                                   
         BNZ   *+6                                                              
         DC    H'0'                                                             
         L     RF,MCVREMOT-MASTD(,RE)                                           
         USING REMOTED,RF                                                       
*                                                                               
* SEE IF ORIGINALLY PRINTING DDS SHOP                                           
*                                                                               
         OC    MCREMOTE-MASTD(,RE),MCREMOTE-MASTD(RE)                           
         BZ    PER02               YES                                          
         CLI   DIRPRTSW,C'Y'                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
         LA    R1,MCREMOTE-MASTD(,RE)                                           
         MVC   REMOTSYS,MCS2OSYS-MASTD(RE)                                      
         MVC   REMOTPRG,REMOTPRG-REMOTED(R1)                                    
         MVC   REMOTFRM,REMOTFRM-REMOTED(R1)                                    
         MVC   REMOTJID,REMOTJID-REMOTED(R1)                                    
         MVC   REMOTDST,REMOTDST-REMOTED(R1)                                    
         MVC   REMOTCLS,REMOTCLS-REMOTED(R1)                                    
         MVC   REMOTCPY,REMOTCPY-REMOTED(R1)                                    
*AR                                                                             
         TM    WHEN,X'10'                                                       
         BZ    PER04                                                            
         MVI   REMOTFLG,X'FA'                                                   
         MVC   REMOTSYS(3),=C'NTN'                                              
         MVC   REMOTSUB,SPACES                                                  
         MVI   REMOTCPY,1                                                       
         MVC   REMOTTY1,SVQLTYP1                                                
         MVC   REMOTARC,SVQLARC                                                 
         L     RE,TWAMASTC                                                      
         XC    MCARC-MASTD(L'MCARC,RE),MCARC-MASTD(RE)                          
*AR                                                                             
         B     PER04                                                            
*                                                                               
PER02    XC    REMOTKEY,REMOTKEY                                                
         DROP  RF                                                               
         MVC   QLDESC,SPACES                                                    
         MVC   QLDESC(4),RCPROG                                                 
         MVC   QLCLASS,PLCLASS                                                  
         MVC   REMUSER,=C'STB'                                                  
                                                                                
         ICM   RE,15,TWAMASTC                                                   
         BNZ   *+6                                                              
         DC    H'0'                                                             
         MVI   MCOUTPUT-MASTD(RE),C'P'                                          
         DROP  R1                                                               
*                                                                               
PER04    GOTO1 OPENPQ                                                           
*                                                                               
PER06    DS   0H                                                                
         BRAS  RE,INITSPT          SWITCH TO SPT                                
*                                                                               
PER06A   MVI   FRSTPGSW,C'Y'                                                    
*                                                                               
         CLI   ERRFILSW,0          IS ERROR FILE CLOSE                          
         BE    PER06D               YES                                         
*                                                                               
         L     R2,AERRFILE                                                      
         CLOSE ((R2),)                                                          
         FREEPOOL (R2)                                                          
         LLC   RE,ERRFILSW         BUG CATCHER                                  
         BCTR  RE,0                                                             
         LTR   RE,RE                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
         MVI   ERRFILSW,0                                                       
*                                                                               
PER06D   LARL  R2,ERREPT                                                        
*                                                                               
         TM    WHEN,X'20'          IF SOON                                      
         BZ    *+10                                                             
         MVC   40(8,R2),=CL8'TALWRK'                                            
*                                                                               
         OPEN  ((R2),INPUT)                                                     
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
         MVI   ERRFILSW,1          SET ERROR FILE OPEN                          
*                                                                               
         LA    RE,PEREOF                                                        
         STCM  RE,7,33(R2)                                                      
*                                                                               
         MVI   OPTICEOM,C'N'       RESET FLAG                                   
         LA    R2,ERREPT                                                        
         LA    R3,ELEMENT                                                       
         GET   (R2),(R3)           DO A GET TO SEE IF ANY DATA                  
*                                                                               
         CLI   TRAWRKR,C' '        TEST OPTICA PDF                              
         JNH   PER08                                                            
         BRAS  RE,SNDOPTIC         SEND OPTICA CONTROL CARDS                    
         MVI   OPTICEOM,C'Y'       SET FLAG                                     
*                                                                               
* CLEAR HEAD AND MIDLINES FROM INST *                                           
*                                                                               
PER08    LA    R0,14                                                            
         LA    R1,H1                                                            
         MVC   0(132,R1),SPACES                                                 
         LA    R1,132(R1)                                                       
         BCT   R0,*-10                                                          
*                                                                               
         MVC   MID1,SPACES                                                      
*                                                                               
         LA    RE,PHDG                                                          
         ST    RE,SPECS                                                         
         LA    RE,PHDHK                                                         
         ST    RE,HEADHOOK                                                      
         XC    FOOTHOOK,FOOTHOOK                                                
         MVI   FORCEHED,C'Y'                                                    
         MVC   PAGE,=H'1'                                                       
         J     PER10X                                                           
*                                                                               
PER10    LA    R2,ERREPT                                                        
         LA    R3,ELEMENT                                                       
         USING XRECD,R3                                                         
         GET   (R2),(R3)                                                        
*                                                                               
PER10X   LA    R7,P                                                             
         USING XPRINT,R7                                                        
*                                                                               
         MVC   P,SPACES                                                         
         MVC   XPPROG,XPROG                                                     
*                                                                               
* READ PROGRAM RECORD FOR STANDARD PROGRAM INFORMATION *                        
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING NPGKEY,R4                                                        
         MVC   NPGKTYP,=X'0D20'                                                 
         MVC   NPGKAM,XBAGYMD                                                   
         MVC   NPGKNET,XNETMKT                                                  
         MVC   NPGKPROG,XPROG                                                   
         MVC   NPGKEND,XPERND                                                   
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(11),KEYSAVE                                                  
         BE    PER12                                                            
         MVC   KEY,KEYSAVE                                                      
         MVC   NPGKEND,XPERST                                                   
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(11),KEYSAVE                                                  
         BE    PER12                                                            
         MVC   KEY,KEYSAVE                                                      
         XC    NPGKEND,NPGKEND                                                  
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(11),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
         DROP  R4                                                               
PER12    L     R6,AIO2                                                          
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
         AH    R6,DATADISP                                                      
PER14    CLI   0(R6),0                                                          
         BNE   *+6                                                              
         DC    H'0'                                                             
         CLI   0(R6),X'92'                                                      
         BE    PER16                                                            
         SR    RF,RF                                                            
         ICM   RF,1,1(R6)                                                       
         BNZ   *+6                                                              
         DC    H'0'                                                             
         AR    R6,RF                                                            
         B     PER14                                                            
         USING NPGEL92,R6                                                       
PER16    MVC   XPPROGNM,NPGNAME                                                 
*                                                                               
         MVC   BYTE,NPGDAY                                                      
         CLI   NPGROT,0            IF ROT FILLED IN, USE IT                     
         BE    *+10                                                             
         MVC   BYTE,NPGROT                                                      
*                                                                               
         GOTO1 UNDAY,DMCB,BYTE,XPPROGDA                                         
*                                                                               
         GOTO1 UNTIME,(R1),NPGTIME,XPPROGTM                                     
         FIXDT02                                                                
         GOTO1 DATCON,(R1),(2,XPERST),(5,XPPERIOD)                              
         MVI   XPPERIOD+8,C'-'                                                  
         FIXDT02                                                                
         GOTO1 (RF),(R1),(2,XPERND),(5,XPPERIOD+9)                              
         CLI   XTYPE,1             SOME UNASSIGNED UNITS                        
         BE    PER20                                                            
         CLI   XTYPE,2             UNALLOCATED UNITS                            
         BE    PER25                                                            
         CLI   XTYPE,3             NO ASSIGNED UNITS                            
         BE    PER36                                                            
         CLI   XTYPE,5             NO UNITS TO PRINT - TN1 PROFILE 5            
         BE    PER38                                                            
         CLI   XTYPE,7             OV FAX NOT FOUND ERROR                       
         BE    PER40                                                            
         CLI   XTYPE,4             EQUIV PROG CODE NOT COVERED                  
         BE    *+6                                                              
         DC    H'0'                                                             
         MVC   XPEXPLAN(30),=C'EQUIVALENT PROGRAM NOT COVERED'                  
         B     PER100                                                           
*                                                                               
PER20    EDIT  XUNAS,(4,XPEXPLAN),ALIGN=LEFT                                    
         LR    RF,R0                                                            
         LA    R1,XPEXPLAN+1(RF)                                                
         MVC   0(16,R1),=CL16'UNASSIGNED UNITS'                                 
         OC    XUNAL,XUNAL         ANY UNALLOCATED                              
         BZ    PER100                                                           
         LA    R7,132(,R7)                                                      
         EDIT  XUNAL,(4,XPEXPLAN),ALIGN=LEFT                                    
         LR    RF,R0                                                            
         LA    R1,XPEXPLAN+1(RF)                                                
         MVC   0(17,R1),=CL17'UNALLOCATED UNITS'                                
         B     PER100                                                           
*                                                                               
PER25    EDIT  XUNAL,(4,XPEXPLAN),ALIGN=LEFT                                    
         LR    RF,R0                                                            
         LA    R1,XPEXPLAN+1(RF)                                                
         MVC   0(17,R1),=CL17'UNALLOCATED UNITS'                                
         B     PER100                                                           
*                                                                               
PER36    MVC   XPEXPLAN(36),=C'NO COMMERCIALS ASSIGNED TO ANY UNITS'            
         B     PER100                                                           
*                                                                               
PER38    MVC   XPEXPLAN(25),=C'NO CHANGED UNITS TO PRINT'                       
         B     PER100                                                           
*                                                                               
PER40    MVC   XPEXPLAN(23),=C'OVERNIGHT FAX NOT FOUND'                         
*                                                                               
PER100   GOTO1 SPOOL,DMCB,(R8)                                                  
         MVI   FRSTPGSW,C'N'       SET PAGE PRINTED SW                          
         B     PER10                                                            
                                                                                
PEREOF   CLI   ERRFILSW,0          IS ERROR FILE CLOSE                          
         BE    PEREOF01             YES                                         
*                                                                               
         CLOSE ((R2),)                                                          
         FREEPOOL (R2)                                                          
*                                                                               
PEREOF01 CLI   SVTWPR06,C'Y'       REQUEST FOR FAX                              
         BE    PERFREE              YES                                         
         TM    WHEN,X'20'          IF SOON                                      
         BO    PER120               ALL DONE                                    
         CLI   SVTWPR06,C'2'       REQUEST FOR AGENCY COPY                      
         BNE   PER120               NO                                          
         TM    SVOPTSW1,OPTHDCPY   TEST OPTION AGENCY COPY                      
         BO    PER120               YES                                         
*                                                                               
         BRAS  RE,PRTSROF            PRINT PARTIAL FAX INFO                     
*                                                                               
* GIVE BACK TO MEMORY WE USED *                                                 
*                                                                               
PERFREE  ICM   R0,15,TSARBUFL                                                   
         BZ    PER120                                                           
         L     R1,TSARBUFF                                                      
         FREEMAIN RC,LV=(0),A=(1)                                               
         LTR   RF,RF                                                            
         JNZ   *+2                                                              
*                                                                               
PER120   CLI  TRAWRKR,C' '         TEST OPTICA PDF                              
         BNH   PERX                                                             
         CLI   OPTICEOM,C'Y'       TEST WE WROTE ANYTHING                       
         JNE   PERX                                                             
*                                                                               
         MVC   P1(26),=C'*** END OF DDS MESSAGE ***'                            
         MVI   LINE,2                                                           
         GOTO1 SPOOL,DMCB,(R8)                                                  
*                                                                               
PERX     XIT1                                                                   
         EJECT                                                                  
* GENERATE OFFLINE OV REQUEST FOR HARD COPY *                                   
* PUT OUT FOR SOON REQUESTS WITH COPY ONLY  *                                   
*                                                                               
         DS    0H                                                               
AREQ     NTR1                                                                   
*                                                                               
         CLC   =C'SOON',CONWHEN                                                 
         BE    AREQ04                                                           
         CLC   =C'NOW',CONWHEN                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
         MVC   CONWHEN(2),=C'OV'                                                
         MVC   CONWHEN+2(L'CONWHEN-3),CONWHEN+3                                 
         MVC   CONWHEN+L'CONWHEN-1(1),SPACES                                    
         B     AREQ06                                                           
*                                                                               
AREQ04   MVC   CONWHEN(2),=C'OV'                                                
         MVC   CONWHEN+2(L'CONWHEN-4),CONWHEN+4                                 
         MVC   CONWHEN+L'CONWHEN-2(2),SPACES                                    
*                                                                               
AREQ06   LLC   R2,TRAOPTH+5                                                     
         LA    R3,TRAOPT(R2)                                                    
         LR    R6,R3                                                            
         SR    R4,R4                                                            
*                                                                               
         LTR   R2,R2                                                            
         BZ    AREQ10                                                           
         MVI   0(R6),C','                                                       
         LA    R6,1(,R6)                                                        
         LA    R4,1                                                             
*                                                                               
AREQ10   MVC   0(1,R6),BYTE         '#' FOLLOW UP AGY COPY                      
*                                   '@' OVERNIGTH FAX                           
         LA    R4,1(,R4)                                                        
         LA    RF,0(R2,R4)                                                      
         STC   RF,TRAOPTH+5                                                     
*                                                                               
         XC    REQHDR,REQHDR                                                    
         MVC   REQUEST,SPACES                                                   
         MVI   REQHDR+15,X'01'     GENERATE LINKED REQUESTS                     
         MVC   REQUEST(2),=C'TN'                                                
         MVC   REQUEST+2(2),AGENCY                                              
*                                                                               
         ICM   RE,15,TWAMASTC                                                   
         BNZ   *+6                                                              
         DC    H'0'                                                             
         MVC   REQUEST+5(6),MCREQREC+5-MASTD(RE)                                
*                                                                               
         XC    REQSPOOK,REQSPOOK                                                
         GOTO1 REQTWA,DMCB,(0,ATWA),REQHDR,DATAMGR,RCCOMFAC,REQSPOOK            
*                                                                               
         MVC   WORK(L'CONWHEN-4),CONWHEN+2                                      
         MVC   CONWHEN+4(L'CONWHEN-4),WORK                                      
         MVC   CONWHEN(4),=C'SOON'                                              
         XC    CONHEAD,CONHEAD                                                  
*                                                                               
         EX    R4,NREQCLR                                                       
         STC   R2,TRAOPTH+5                                                     
         XIT1                                                                   
*                                                                               
NREQCLR  MVC   0(0,R3),SPACES                                                   
         DROP  R3,R6,R7,RB,RC                                                   
         LTORG                                                                  
         EJECT                                                                  
* PRINT FAX COPY OF INSTRUCTION FROM TSAROFF                                    
*                                                                               
PRTSROF  NTR1  BASE=*,LABEL=*                                                   
         L     RC,SVADGEND                                                      
         USING GEND,RC                                                          
*                                                                               
         L     R4,AIO1                                                          
*                                                                               
         L     R5,APRGTBLE                                                      
         USING PRGTABLED,R5                                                     
*                                                                               
         LHI   R2,TSARBLK-SYSD                                                  
         AR    R2,R9                                                            
*                                                                               
         USING TSARD,R2                                                         
*                                                                               
         XC    BLOCK(256),BLOCK                                                 
         LA    R0,BLOCK                                                         
         ST    R0,TSAREC           SET ADDRESS OR THE RECORD                    
*                                                                               
PRTEZ00  OC    PRGENT,PRGENT       END OF ENTRIES                               
         BZ    ENDEZPRT                                                         
         CLC   PRGTSRKF,PRGTSRKL   WAS THERE ANY OUTPUT                         
         BE    PRTEZ60                                                          
*                                                                               
         TM    PRGFLG,PRGXCLUD     EXCLUDE THIS PROGRAM?                        
         BO    PRTEZ60              YES GET NEXT PRG                            
*                                                                               
         TM    PRGFLG,PRGFLGEP     DID WE PRINT THIS ONE                        
         BO    PRTEZ60              YES GET NEXT PRG                            
         OI    PRGFLG,PRGFLGEP                                                  
*                                                                               
         SR    R1,R1                                                            
         ICM   R1,3,PRGTSRKF                                                    
         LA    R1,1(R1)                                                         
         STCM  R1,3,BLOCK+2        KEY                                          
         STH   R1,TSRKEYF                                                       
         MVC   TSRKEYL,PRGTSRKL                                                 
*                                                                               
         MVC   SVPRGFAX,PRGFAX                                                  
*                                                                               
         TM    SVFLAG,PQOPNSW      PRINTQUE OPEN FOR FAXING                     
         BO    PRTEZ40              YES                                         
*                                                                               
PRTEZ20  MVI   SPMODE,X'FF'                                                     
         MVI   PQSW,X'FF'                                                       
         GOTO1 SPOOL,DMCB,(R8)    CLOSE OLD QUE ENTRY                           
         MVI   PQSW,1                                                           
*                                                                               
* RE-OPEN OR OPEN DIRECT TO AGENCY PRINT QUE ENTRY *                            
*                                                                               
         LA    R1,ELEM                                                          
         XC    ELEM(128),ELEM                                                   
         ST    R1,SPOOLQLK                                                      
         USING PQPLD,R1                                                         
*                                                                               
         BRAS  RE,INITREM          INITIALIZE PRT QUEUE ENTRY                   
*                                                                               
         DROP  R1                                                               
*                                                                               
* FORCE TO 'G' FOR EASYLINK TRANMISSION AND NEW QUE ENTRY *                     
*                                                                               
         ICM   RE,15,TWAMASTC                                                   
         BNZ   *+6                                                              
         DC    H'0'                                                             
         L     RF,MCVREMOT-MASTD(,RE)                                           
         USING REMOTED,RF                                                       
*                                                                               
         MVC   REMOTSYS,MCS2OSYS-MASTD(RE)                                      
*                                                                               
         L     RE,TWADCONS                                                      
         L     RE,TSPFUSER-TWADCOND(,RE)                                        
         MVI   140(RE),C'Y'        SET EASYLINK STUFF PRINTED SW                
*                                                                               
*AR                                                                             
*NOTNOW  XC    REMOTFNO,REMOTFNO                                                
*AR                                                                             
         L     R1,136(,RE)         PAST SAVED DCB                               
         LA    R1,1(,R1)                                                        
         CVD   R1,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  REMOTFRM+1(3),DUB                                                
         ST    R1,136(,RE)                                                      
*                                                                               
         MVC   REMOTDSC(1),QMED                                                 
         MVC   REMOTDSC+2(3),QCLT                                               
         MVC   REMOTDSC+6(4),NETWORK                                            
*                                                                               
         MVC   REMOTJID,=C'NWX'                                                 
         MVC   REMOTDST,TWAORIG                                                 
         OC    TWADEST,TWADEST                                                  
         BZ    *+10                                                             
         MVC   REMOTDST,TWADEST                                                 
*                                                                               
         L     RE,TWADCONS                                                      
         L     RE,TSPFUSER-TWADCOND(RE)                                         
         SR    R1,R1                                                            
         ICM   R1,15,136(RE)                                                    
         LA    R1,1(,R1)                                                        
         STCM  R1,3,REMOTSUB       FORCE PRT QUE KEY CHANGE                     
         STCM  R1,15,136(RE)                                                    
         MVI   REMOTCLS,C'G'       SHOULD BE CLASS G                            
         MVI   REMOTCPY,1                                                       
*AR                                                                             
         MVI   REMOTFLG,X'FA'                                                   
         MVC   REMOTTY1,SVFAXARC                                                
         MVC   REMOTSYS(3),=C'NNI'                                              
         MVC   REMOTSUB,SPACES                                                  
         MVI   REMOTCPY,1                                                       
         MVC   REMOTARC,SVQLARC                                                 
         DROP  RF                                                               
*AR                                                                             
         GOTO1 OPENPQ             OPEN NEW QUE ENTRY                            
*AR                                                                             
         TM    WHEN,X'10'                                                       
         BZ    PRTEZ30                                                          
         L     RE,TWAMASTC                                                      
         XC    MCARC-MASTD(L'MCARC,RE),MCARC-MASTD(RE)                          
PRTEZ30  DS    0H                                                               
*AR                                                                             
*                                                                               
         OI    SVFLAG,PQOPNSW      PRINTQUE HAS BEEN OPEN FOR FAXING            
*                                                                               
* KILL HEADLINES, POSSIBLE FUTURE FOOTLINES, AND SPECS *                        
*                                                                               
PRTEZ40  DS    0H                                                               
         SR    R0,R0                                                            
         ST    R0,HEADHOOK         NO HEADHOOK                                  
         ST    R0,MIDHOOK          NO MIDHOOK                                   
         ST    R0,FOOTHOOK         OR FOOTHOOK                                  
         ST    R0,SPECS            OR SPECS                                     
*                                                                               
         MVC   SVPRG,PRGPRG        SAVE AS CURRENT PROGRAM CODE                 
         MVC   SVPRGRVN,PRGCREVN                                                
         B     PRTEZ54                                                          
*                                                                               
PRTEZ50  CLI   MFPRGSW,C'Y'                                                     
         BNE   PRTEZ60                                                          
*                                                                               
PRTEZ54  BRAS  RE,GTSPL                                                         
*                                                                               
         CLI   OFFLINE,C'Y'                                                     
         BNE   PRTEZ50                                                          
*                                                                               
         TM    SVFLAG,SVTSX1       1ST TIME AROUND                              
         BZ    *+12                 NO                                          
         NI    SVFLAG,X'FF'-SVTSX1                                              
         B     PRTEZ50                                                          
*                                                                               
         LA    RF,PRGNEXT-PRGENT(R5)                                            
*                                                                               
         TM    WHEN,X'20'          THIS A SOON RUN                              
         BO    *+12                                                             
         CLI   OFFLINE,C'Y'        OFFLINE                                      
         BE    PRTEZ50                                                          
*                                                                               
         MVI   OPTICEOM,C'N'                                                    
         GOTO1 SPOOL,DMCB,(R8)                                                  
         MVC   P1(26),=C'*** END OF DDS MESSAGE ***'                            
         MVI   LINE,2                                                           
         GOTO1 SPOOL,DMCB,(R8)                                                  
*                                                                               
         B     PRTEZ50                                                          
*                                                                               
PRTEZ60  LA    R5,PRGNEXT                                                       
         C     RF,APRGTBLX           AT END OF TABLE                            
         BL    PRTEZ00                                                          
*                                                                               
ENDEZPRT MVI   SPMODE,X'FF'                                                     
         MVI   PQSW,X'FF'                                                       
         GOTO1 SPOOL,DMCB,(R8)    CLOSE OLD QUE ENTRY                           
         MVI   PQSW,1                                                           
*                                                                               
         LA    R1,ELEM                                                          
         ST    R1,SPOOLQLK                                                      
         XC    ELEM(128),ELEM                                                   
         USING PQPLD,R1                                                         
*                                                                               
         BRAS  RE,INITREM          INITIALIZE PRT QUEUE ENTRY                   
*                                                                               
         DROP  R1                                                               
         OI    SPOOLIND,X'40'      USER VALUES PRESENT                          
*                                                                               
* SEE IF ORIGINALLY PRINTING DDS SHOP                                           
*                                                                               
         ICM   RE,15,TWAMASTC                                                   
         BNZ   *+6                                                              
         DC    H'0'                                                             
         L     RF,MCVREMOT-MASTD(,RE)                                           
         USING REMOTED,RF                                                       
*                                                                               
         OC    MCREMOTE-MASTD(,RE),MCREMOTE-MASTD(RE)                           
         BZ    ENDEZP10            YES                                          
         CLI   DIRPRTSW,C'Y'                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*        MVC   REMOTKEY,MCREMOTE-MASTD(RE) RESTORE ORIGINAL DIRECT              
         LA    R1,MCREMOTE-MASTD(,RE)                                           
         MVC   REMOTSYS,MCS2OSYS-MASTD(RE)                                      
         MVC   REMOTPRG,REMOTPRG-REMOTED(R1)                                    
         MVC   REMOTFRM,REMOTFRM-REMOTED(R1)                                    
         MVC   REMOTJID,REMOTJID-REMOTED(R1)                                    
         MVC   REMOTDST,REMOTDST-REMOTED(R1)                                    
         MVC   REMOTCLS,REMOTCLS-REMOTED(R1)                                    
         MVC   REMOTCPY,REMOTCPY-REMOTED(R1)                                    
         B     ENDEZP20                                                         
*                                                                               
ENDEZP10 XC    REMOTKEY,REMOTKEY                                                
*                                                                               
ENDEZP20 DS    0H                                                               
*AR                                                                             
         L     RE,TWAMASTC                                                      
         XC    MCARC-MASTD(L'MCARC,RE),MCARC-MASTD(RE)                          
         OC    REMOTKEY,REMOTKEY                                                
         BZ    ENDEZP30                                                         
         MVC   REMOTSYS(3),=C'NTN'                                              
         MVC   REMOTTY1,SVQLTYP1                                                
ENDEZP30 DS    0H                                                               
*AR                                                                             
         GOTO1 OPENPQ             OPEN FOR END LOGOS                            
         DROP  RF                                                               
*                                                                               
         XIT1                                                                   
PRTEZMVC MVC   0(0,R4),BLOCK+6                                                  
         LTORG                                                                  
         DROP  RB                                                               
         EJECT                                                                  
* HEAD HOOK ROUTINE                                                             
*                                                                               
*==============================================================                 
* OPEN A WORKER FILE USING T2168C AS A BUFFER                                   
* AND WRITE THE SELECTED ROWS TO IT                                             
*==============================================================                 
         EJECT                                                                  
PHDHK    NTR1  BASE=*,LABEL=*                                                   
         L     RC,SVADGEND                                                      
         USING GEND,RC                                                          
*                                                                               
         LH    RE,SEQNUM          PRINT SEQUENCE NUMBER                         
         CVD   RE,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  H1+104(4),DUB                                                    
         LA    RE,1(RE)                                                         
         STH   RE,SEQNUM                                                        
*                                                                               
         TM    SVOPTSW,OPTTEST     TEST OPTION TEST                             
         BZ    *+10                                                             
         MVC   H4+84(16),=C'*** TEST RUN ***'                                   
*                                                                               
         MVC   H3+10(3),QCLT                                                    
         MVC   H3+15(20),CLTNM                                                  
*                                                                               
         MVC   H4+10(3),NETWORK                                                 
*                                                                               
PHDHKX   XIT1                                                                   
         EJECT                                                                  
PHDG     SSPEC H1,3,AGYNAME                                                     
         SSPEC H2,3,AGYADD                                                      
         SSPEC H3,3,C'CLIENT'                                                   
         SSPEC H4,3,C'NETWORK'                                                  
         SSPEC H1,42,C'COMMERCIAL INSTRUCTIONS ERROR LISTING'                   
         SSPEC H2,42,C'-------------------------------------'                   
         SSPEC H1,85,REPORT                                                     
         SSPEC H2,85,RUN                                                        
         SSPEC H3,85,PAGE                                                       
         SSPEC H6,03,C'PROGRAM-NAME'                                            
         SSPEC H7,03,C'-------------'                                           
         SSPEC H6,32,C'DAY         TIME'                                        
         SSPEC H7,32,C'----        -----'                                       
         SSPEC H6,56,C'PERIOD              REASON'                              
         SSPEC H7,56,C'-----------------   ------------------'                  
         DC    X'00'                                                            
         LTORG                                                                  
*                                                                               
ERREPT   DCB   BLKSIZE=3200,                                           X        
               DDNAME=ERRFILE,                                         X        
               DSORG=PS,                                               X        
               EODAD=PEREOF,                                           X        
               LRECL=32,                                               X        
               MACRF=GM,                                               X        
               RECFM=FB                                                         
         EJECT                                                                  
ADDWRKR  NTR1  BASE=*,LABEL=*                                                   
                                                                                
         LA    R4,ELEM                                                          
         USING WLHDRD,R4                                                        
         XC    ELEM,ELEM                 CLEAR AN I/O AREA                      
*                                                                               
         MVC   ELEM(8),=C'*SOFSOF*'                                             
*                                                                               
         L     RE,ATWA                                                          
         MVC   WLUSRID,TWAORIG-T216FFD(RE)   MOVE USERID                        
*                                                                               
         MVC   WLDESC,=CL16'NINS GEN PDF'                                       
         MVC   WLSYSPRG,=C'NNI'          SET REPORT ID                          
         MVI   WLSUBPRG,C'N'             SET SUB PROGRAM NUMBER                 
         MVI   WLCLASS,C'T'              SET REPORT CLASS                       
*                                                                               
         GOTO1 DATCON,DMCB,(5,0),(1,DUB) GET PWOS DATE                          
         MVC   WLDAY,DUB+2                                                      
*                                                                               
         MVI   WLTYPE,0                                                         
         MVC   SVINDEX,WLKEY                                                    
                                                                                
         GOTO1 DATAMGR,DMCB,=C'DMPRINT ',=C'WRKFILE',SVINDEX,(R4),     X        
               AWKBUFF                                                          
         CLI   8(R1),0                                                          
         JNE   *+2                                                              
*                                                                               
         MVC   SVWRKFNO,WLREPRNO         SAVE REPORT SEQNUM                     
                                                                                
* GET RUN=ALL OPTION FROM GLOBALS                                               
                                                                                
         L     RF,ACOMFACS                                                      
         L     RF,CGLOBBER-COMFACSD(RF)                                         
         GOTO1 (RF),DMCB,=C'GETD',ELEM,24,GLVSPTRF                              
         LA    RE,ELEM                                                          
         USING GLVTRFD,RE                                                       
         MVC   SVRUNALL,TRFDOALL         SAVE RUN=ALL OPTION                    
         MVC   DUB,TRFSVKEY              SAVE SAVREC SEQ/DATE                   
         DROP  RE                                                               
                                                                                
* GET UNIQUE ID FROM GLOBALS                                                    
                                                                                
         LA    R4,ELEM                                                          
         XC    0(255,R4),0(R4)           MOVE UNIQUE ID                         
         LA    R0,L'SVUNIQID                                                    
         STH   R0,0(R4)                                                         
         GOTO1 (RF),DMCB,=C'GETD',4(R4),60,GLVBUY2                              
                                                                                
* PUT UNIQUE ID TO WRKFILE                                                      
                                                                                
         GOTO1 DATAMGR,DMCB,=C'DMPRINT ',=C'WRKFILE',SVINDEX,(R4),     X        
               AWKBUFF                                                          
         CLI   8(R1),0                                                          
         JNE   *+2                                                              
         DROP  R4                                                               
                                                                                
*==============================================================                 
* READ SELECT LIST FROM WSSVR BUFFER INTO TIA                                   
* AND MOVE THE ENTRIES TO WORKER FILE                                           
*==============================================================                 
                                                                                
         CLI   SVRUNALL,C'Y'                                                    
         JNE   ADDWRK2             IF RUN=ALL, NO SELECTED ENTRIES              
         MVC   ELEM(7),=C'RUN=ALL'                                              
         GOTO1 DATAMGR,DMCB,=C'DMPRINT ',=C'WRKFILE',SVINDEX,ELEM,     X        
               AWKBUFF                                                          
         CLI   8(R1),0                                                          
         JNE   *+2                                                              
         J     ADDWRK8                                                          
*                                                                               
*                                                                               
ADDWRK2  XC    ELEM,ELEM                                                        
         LA    R1,ELEM                                                          
         USING FAWSSVRD,R1                                                      
*                                                                               
         MVC   FAWSTOKN,=C'TR1F'   TOKEN                                        
         OI    FAWSACTN,FAWSURST                                                
         MVC   FAWSADR,ATIA                                                     
         L     RE,APRGTBLX                                                      
         S     RE,APRGTBLE                                                      
         STH   RE,FAWSLEN                                                       
*                                                                               
         L     RF,ACOMFACS                                                      
         L     RF,CWSSVR-COMFACSD(RF)                                           
         GOTOR (RF),(R1)                                                        
         CLI   FAWSRTN,FAWSROK                                                  
         JNE   *+2                                                              
         DROP   R1                                                              
                                                                                
         L     R7,ATIA                                                          
         XC    ELEM,ELEM           CLEAR RECORD AREA                            
*                                                                               
ADDWRK4  LA    R0,10               SET LENGTH OF ENTRY                          
         STCM  R0,3,ELEM                                                        
         MVC   ELEM+4(6),0(R7)     MOVE PROGRAM CODE                            
*                                                                               
         GOTO1 DATAMGR,DMCB,=C'DMPRINT ',=C'WRKFILE',SVINDEX,ELEM,     X        
               AWKBUFF                                                          
         CLI   8(R1),0                                                          
         JNE   *+2                                                              
*                                                                               
ADDWRK6  LA    R7,6(R7)                                                         
         OC    0(6,R7),0(R7)           TEST FOR MORE ENTRIES                    
         JNZ   ADDWRK4                                                          
*                                                                               
ADDWRK8  LA    R4,ELEM                                                          
         USING WLHDRD,R4                                                        
         XC    ELEM,ELEM                 CLEAR AN I/O AREA                      
         MVC   WLSOFLAB,=C'*EOFEOF*'                                            
*                                                                               
         GOTO1 DATAMGR,DMCB                                                     
                                                                                
*=====================================================================          
* SELECT FIELDS ARE PROTECTED, SO JUST PUT WRKR FILENUM IN TRAWRKR              
*=====================================================================          
                                                                                
* PUT WRKR FILENUM IN REQUEST                                                   
                                                                                
         XC    TRAWRKR,TRAWRKR     CLEAR ONSCREEN WORKER FILENUM                
         SR    R0,R0                                                            
         ICM   R0,3,SVWRKFNO                                                    
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  TRAWRKR(5),DUB                                                   
         MVI   TRAWRKRH+5,5        SET INPUT LENGTH                             
*                                                                               
         XC    CONWHEN,CONWHEN                                                  
         MVC   CONWHEN(8),=C'SOON,PDF'                                          
         MVI   CONWHENH+5,8        SET INPUT LENGTH                             
         MVI   TWAWHEN,TWW$SOON    SET UPDATIVE SOON REQUEST                    
*                                                                               
         MVC   CONREC(7),=C'NINSPDF'                                            
         MVI   CONRECH+5,7                                                      
                                                                                
*================================================================               
* BUILD A TRANSFER CONTROL ELEMENT TO RETURN TO NET/NAV                         
* BECAUSE BLDREQST DOES NOT RETURN!                                             
*================================================================               
                                                                                
         XC    ELEM,ELEM                                                        
         LA    R1,ELEM                                                          
         USING GLVXFRSY,R1                                                      
         MVC   GLVXTOSY,=C'NET'                                                 
         MVC   GLVXTOPR,=C'NNA'                                                 
         MVC   GLVXFRSY,=C'NET'                                                 
         MVC   GLVXFRPR,=C'TRA'                                                 
         MVI   GLVXFLG1,GLV1RETN+GLV1SIDR+GLV1SEPS+GLV1SIDE+GLV1SEPD            
         MVC   GLVXSESR(2),SVXFRSID                                             
         DROP  R1                                                               
*                                                                               
         L     RF,ACOMFACS                                                      
         L     RF,CGLOBBER-COMFACSD(RF)                                         
         GOTO1 (RF),DMCB,=C'PUTD',ELEM,GLVXLENQ,GLVXCTL                         
*                                                                               
         GOTO1 BLDREQST            ADD OFFLINE REQUEST                          
         XIT1                                                                   
         LTORG                                                                  
         EJECT                                                                  
SNDOPTIC NTR1  BASE=*,LABEL=*                                                   
         MVI   FORCEHED,C'N'                                                    
         MVI   LINE,2              SUPPRESS HEADLINES                           
         MVC   EDIORIG,AGYORIG                                                  
         MVC   EDIHDR,=CL5'*HDR*'                                               
         MVC   EDIEDICT(13),=C'EDICT=*OPTICA'                                   
         MVI   EDIWIDE,C'L'        SET FOR LANDSCAPE                            
         MVI   EDIPAGE,C'P'                                                     
         MVI   EDITTYPE,EDITPDFQ                                                
         MVI   ALLOWLIN,0                                                       
         MVI   SPACING,1                                                        
         GOTO1 SPOOL,DMCB,(R8)    SEND SPECIAL PRINT LINE                       
*                                                                               
         MVC   EDIDDSID(5),=C'++DDS'                                            
         MVC   EDIDDSID+11(3),=C'SUB'                                           
         MVC   EDIDDSID+15(3),=C'NNI'                                           
         GOTO1 SPOOL,DMCB,(R8)    SEND SPECIAL PRINT LINE                       
*                                                                               
         MVC   EDIDDSID(5),=C'++DDS'                                            
         MVC   EDIIDEN(3),=C'UID'                                               
         MVC   EDICOMN,SVUNIQID                                                 
         GOTO1 SPOOL,DMCB,(R8)    SEND SPECIAL PRINT LINE                       
*                                                                               
         MVI   OPTICEOM,C'Y'       SET OPTICA EOM REQ'D                         
         J     EXIT                                                             
         LTORG                                                                  
         EJECT                                                                  
*=================================================================              
* OPEN WORKER FILE WITH FILE NUMBER IN TRAWRKR                                  
* PASSED BY A PDF REQUEST FOR INSTRUCTIONS                                      
* IF NO SELECT RECORDS FOLLOW UNIQUE ID REC, THEN RUN ALL STATIONS              
*=================================================================              
                                                                                
OPENWRKF NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         OC    SVINDEX,SVINDEX     TEST ALREADY OPENED                          
         JZ    OPENWRK0                                                         
* DO INDEX CALL TO REPROCESS WKFILE                                             
         XC    ELEM,ELEM                                                        
         MVC   ELEM(10),SVINDEX                                                 
         GOTO1 DATAMGR,DMCB,=C'INDEX   ',=C'WRKFILE',ELEM,ELEM,        X        
               AWKBUFF                                                          
         CLI   8(R1),0                                                          
         JNE   *+2                                                              
         J     OPENWRK6                                                         
*                                                                               
OPENWRK0 LLC   RE,TRAWRKRH+5                                                    
         BCTR  RE,0                                                             
         EX    RE,*+8                                                           
         J     *+10                                                             
         PACK  DUB,TRAWRKR(0)                                                   
*                                                                               
         CVB   R0,DUB                                                           
         STH   R0,HALF             SAVE WKFILE NUMBER                           
*                                                                               
         LA    R4,ELEM             BUILD WKFILE KEY                             
         USING WLINDEX,R4                                                       
         XC    ELEM,ELEM                                                        
*                                                                               
         L     RE,ATWA                                                          
         MVC   WLUSRID,TWAORIG-T216FFD(RE)   MOVE USERID                        
*                                                                               
         MVC   WLSYSPRG,=C'NNI'          SET REPORT ID                          
         MVI   WLSUBPRG,C'N'             SET SUB PROGRAM NUMBER                 
         MVI   WLCLASS,C'T'              SET REPORT CLASS                       
         MVI   WLTYPE,0                                                         
*                                                                               
         GOTO1 DATCON,DMCB,(5,0),(1,DUB) GET PWOS DATE                          
         MVC   WLDAY,DUB+2                                                      
         MVC   WLFILENO,HALF             SET REPORT NUMBER                      
                                                                                
OPENWRK4 DS    0H                                                               
         GOTO1 DATAMGR,DMCB,=C'INDEX   ',=C'WRKFILE',ELEM,ELEM,        X        
               AWKBUFF                                                          
         CLI   8(R1),0                                                          
         JNE   *+2                                                              
*                                                                               
         CLC   HALF,WLFILENO       TEST RIGHT FILE                              
         JNE   OPENWRK4                                                         
*                                                                               
OPENWRK6 MVC   SVINDEX,ELEM        SAVE INDEX/FILENUM/WKFILE                    
                                                                                
* FIRST RECORD IS UNIQUE IDENTIFIER FOR PDF PROCESSING                          
                                                                                
         GOTO1 DATAMGR,DMCB,=C'READ    ',=C'WRKFILE ',SVINDEX,ELEM,    X        
               AWKBUFF                                                          
         CLI   8(R1),0                                                          
         JNE   *+2                                                              
         MVC   SVUNIQID,ELEM+4                                                  
                                                                                
* NOW READ FIRST SELECT ENTRY (IF ANY)                                          
                                                                                
         GOTO1 (RF),(R1),,,,SVWRKREC   READ FIRST SELECT ENTRY                  
         TM    8(R1),X'80'         TEST EOF                                     
         JO    OPENWRK8                                                         
         CLI   8(R1),0                                                          
         JNE   *+2                                                              
         CLC   SVWRKREC+4(7),=C'RUN=ALL'                                        
         JNE   OPENWRKX                                                         
*                                                                               
OPENWRK8 MVI   SVRUNALL,C'Y'       SET TO RUN ALL                               
*                                                                               
OPENWRKX XIT1                                                                   
         LTORG                                                                  
         EJECT                                                                  
*=================================================================              
* CHECK FOR XFRCTL FROM NET/NAV                                                 
* SINCE NET/NAV IS STATELESS, ALWAYS READ HEADLINE GLOBALS                      
*=================================================================              
                                                                                
GETGLOB  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     RF,SYSPARMS                                                      
         L     RF,16(RF)                                                        
         ST    RF,ACOMFACS                                                      
         ICM   RF,15,CGLOBBER-COMFACSD(RF)  EXIT IF OFFLINE                     
         JZ    GETGLOBX                                                         
*                                                                               
         GOTO1 (RF),DMCB,=C'GETD',ELEM,24,GLVXCTL                               
         CLI   8(R1),0                                                          
         BNE   GETGLOBX                                                         
*                                                                               
         GOTO1 (RF),(R1),=C'DELE'     DELETE ELEMENT                            
*                                                                               
         LA    RE,ELEM                                                          
         USING GLVXFRSY,RE                                                      
         CLC   =C'NETNNA',GLVXFRSY    TEST CALL FROM NET/NAV                    
         JNE   GETGLOBX                                                         
         DROP  RE                                                               
*                                                                               
         MVI   SVXFROV,X'40'       SET CALLING NET/NAV OVLY                     
         OI    GENSTAT7,GES7PDF    REQUEST RETURN HOOK ON ERROR FOR PDF         
                                                                                
*=================================================================              
* READ GLVSPTRF TO FIND OUT IF THIS IS BLD OR RUN MODE                          
* FORMAT OF GLOBAL IS C'BLD'/C'SUB',RETURN ACTEQU(3),FAX?,ALL PROGS?            
*================================================================               
                                                                                
         GOTO1 (RF),DMCB,=C'GETD',ELEM,24,GLVSPTRF                              
         CLI   DMCB+8,0                                                         
         JNE   *+2                                                              
*                                                                               
         LA    RE,ELEM                                                          
         USING GLVTRFD,RE                                                       
         MVC   SVXFRMOD,TRFACT     SAVE BLD/SUB MODE                            
         MVC   TRAFAX(1),TRFFAX                                                 
*                                                                               
         XC    TRAPRG,TRAPRG                                                    
         CLI   TRFDOALL,C'Y'                                                    
         JNE   GETGLB10                                                         
         MVC   TRAPRG,=CL7'ALL   '                                              
         MVI   TRAPRGH+5,3                                                      
         DROP  RE                                                               
                                                                                
* GLOBBER CALL FOR CLIENT ALREADY DONE IN SPTRA00                               
                                                                                
GETGLB10 LA    R2,TRAFAXH          FIELD MOVED ABOVE FROM GLVSPFMT              
         LA    R1,L'TRAFAX                                                      
         BAS   RE,SETIN                                                         
*                                                                               
         GOTO1 (RF),DMCB,=C'GETF',TRANETH,,GLVSPSTA                             
         LA    R2,TRANETH                                                       
         LA    R1,L'TRANET                                                      
         BAS   RE,SETIN                                                         
*                                                                               
         CLC   TRAPRG(6),=C'ALL   '                                             
         JE    GETGLB12                                                         
         GOTO1 (RF),DMCB,=C'GETF',TRAPRGH,6,GLVSPPRG                            
         LA    R2,TRAPRGH                                                       
         LA    R1,L'TRAPRG                                                      
         BAS   RE,SETIN                                                         
*                                                                               
GETGLB12 GOTO1 (RF),DMCB,=C'GETF',TRAPERH,,GLVSPPER                             
         LA    R2,TRAPERH                                                       
         LA    R1,L'TRAPER                                                      
         BAS   RE,SETIN                                                         
*                                                                               
         GOTO1 (RF),DMCB,=C'GETF',TRAOPTH,,GLVBUY1                              
         LA    R2,TRAOPTH                                                       
         LA    R1,L'TRAOPT                                                      
         BAS   RE,SETIN                                                         
                                                                                
* RELOCATE PRGTABLE TO TIA SO CANNOT GET FULL                                   
                                                                                
         L     RE,ATIA                                                          
         ST    RE,APRGTBLE                                                      
         AHI   RE,8192                                                          
         ST    RE,APRGTBLX                                                      
*                                                                               
GETGLOBX J     EXIT                                                             
*                                                                               
SETIN    LA    R4,8(R1,R2)         POINT BEYOND INPUT FIELD                     
         BCTR  R4,0                BACK UP TO LAST INPUT CHAR                   
*                                                                               
SETIN2   CLI   0(R4),C' '                                                       
         JH    SETIN4                                                           
         BCTR  R4,0                                                             
         JCT   R1,SETIN2                                                        
*                                                                               
SETIN4   STC   R1,5(R2)                                                         
         NI    4(R2),X'FF'-X'20'   UNSET PREV VALID                             
         BR    RE                                                               
         LTORG                                                                  
         PRINT OFF                                                              
         TITLE 'T2161F - NETWORK TRAFFIC INSTRUCTIONS - RECORD DSECTS'          
         EJECT                                                                  
       ++INCLUDE NEGENUNIT                                                      
         EJECT                                                                  
       ++INCLUDE SPTRNREV                                                       
         EJECT                                                                  
       ++INCLUDE SPTRNRCP                                                       
         EJECT                                                                  
       ++INCLUDE SPTRNFEED                                                      
         EJECT                                                                  
       ++INCLUDE DDACTIVD                                                       
         EJECT                                                                  
       ++INCLUDE SPTRNFAX                                                       
       ++INCLUDE SPTRPRH                                                        
         EJECT                                                                  
       ++INCLUDE SPTRCMLTXT                                                     
         EJECT                                                                  
CLTHDRD  DSECT                                                                  
       ++INCLUDE SPGENCLT                                                       
         EJECT                                                                  
       ++INCLUDE SPTRNCLT                                                       
         EJECT                                                                  
       ++INCLUDE SPTRNPGRP                                                      
         EJECT                                                                  
       ++INCLUDE SPTRNPRD                                                       
         EJECT                                                                  
       ++INCLUDE SPTRNPRG                                                       
         EJECT                                                                  
MKTRECD  DSECT                                                                  
       ++INCLUDE SPGENMKT                                                       
         EJECT                                                                  
STARECD  DSECT                                                                  
       ++INCLUDE SPGENSTA                                                       
         EJECT                                                                  
PRDHDRD  DSECT                                                                  
       ++INCLUDE SPGENPRD                                                       
         EJECT                                                                  
ESTHDRD  DSECT                                                                  
       ++INCLUDE SPGENEST                                                       
         EJECT                                                                  
       ++INCLUDE SPGENPROG                                                      
         EJECT                                                                  
       ++INCLUDE SPTRCMML                                                       
         EJECT                                                                  
       ++INCLUDE SPTRDTXT                                                       
       ++INCLUDE SPTRNCMT                                                       
         EJECT                                                                  
       ++INCLUDE SPTRNEQPRG                                                     
         TITLE 'T2161F - NETWORK TRAFFIC INSTRUCTIONS - WORK DSECTS'            
       ++INCLUDE DDSPOOLD                                                       
       ++INCLUDE DMPRTQL                                                        
       ++INCLUDE DDREPMASTD                                                     
       ++INCLUDE DDREMOTED                                                      
       ++INCLUDE DDCOMFACS                                                      
       ++INCLUDE FAFACTS                                                        
       ++INCLUDE DDTSARD                                                        
       ++INCLUDE FAGETTXTD                                                      
       ++INCLUDE FASSB                                                          
       ++INCLUDE SPSTAPACKD                                                     
         EJECT                                                                  
       ++INCLUDE DDSPLWORKD                                                     
       ++INCLUDE FASECRETD                                                      
         EJECT                                                                  
TWADCOND       DSECT                                                            
       ++INCLUDE DDTWADCONS                                                     
         EJECT                                                                  
NETBLKD DSECT                                                                   
       ++INCLUDE NETBLOCKN                                                      
       ++INCLUDE SPTRAFFD                                                       
         ORG   CONTAGH                                                          
         PRINT ON                                                               
         EJECT                                                                  
       ++INCLUDE SPTRABFD                                                       
         EJECT                                                                  
       ++INCLUDE DDGENTWA                                                       
         PRINT OFF                                                              
         EJECT                                                                  
       ++INCLUDE SPTRAWORKD                                                     
         PRINT ON                                                               
         EJECT                                                                  
NEXTLINE EQU   TRASEL2H-TRASEL1H                                                
*                                                                               
* SVPRDLST ENTRY IS 3 BYTE PRD CODE, THEN WHEN LIST PROCESSED,                  
* 4 BYTE DISK ADDR, 1 BYTE LEN OF COPY NAMES IN EACH REC                        
*                                                                               
SVPRDLEN EQU   480/5                                                            
SVPRDENT EQU   5                                                                
*                                                                               
SYSD     DSECT                                                                  
         ORG   SVSPAREX                                                         
QSORT    DS    V                   V(QSORT) (CORRES)                            
VTRPACK  DS    V                                                                
SPTR1FRR DS    A                                                                
VGTBROAD DS    A                                                                
VXSORT   DS    A                                                                
VBOXER   DS    A                                                                
ASVSTOR  DS    A                                                                
AUNTABLE DS    A                                                                
AUNTABLX DS    A                                                                
APRGTBLE DS    A                                                                
APRGTBLX DS    A                                                                
ANETIO   DS    A                                                                
AERRFILE DS    A                                                                
ASVFTNT  DS    A                                                                
ASVFTNTX DS    A                                                                
APRTSAVE DS    A                                                                
APRTBUFF DS    A                                                                
APRTBUFX DS    A                                                                
ATOPBUFF DS    A                                                                
ASVNEXT  DS    A                   1ST TABLE ENTRY ON NEXT SCREEN               
VTSAR    DS    A                   TSAR ADDRESS                                 
ANETBLK  DS    A                                                                
AADDTBL  DS    A                   ADDL CMMLM DATA TABLE                        
AADDTBLX DS    A                   END OF SAVE AREA                             
AWKBUFF  DS    A                                                                
*                                                                               
* CML TABLE FOR  OPTICA                                                         
ACMLTBL  DS    A                   ADDL CMMLM DATA TABLE                        
ACMLTBLX DS    A                   END OF SAVE AREA                             
NCOMMLT  EQU   500                 NUMBER OF RECORDS IN TABLE                   
*                                                                               
NEXTADDR DS    A                                                                
ASVCPYLS DS    A                                                                
*AR                                                                             
PQPROF   DS    A                                                                
PROFKEY  DS    CL5                 READ PROGRAM PROFILE RECORD                  
SVQLTYP1 DS    CL1                 STORE ARCHIVE SETTING                        
SVFAXARC DS    CL1                 ARCHIVE FOR FAX COPIES                       
SVQLARC  DS    CL1                 ARCHIVE CLASS                                
*AR                                                                             
*                                                                               
         DS    0D                                                               
TSARBLK  DS    CL(TSARDL2)                                                      
TSARBLKX EQU   *                                                                
TSARBUFL DS    A(L'ELEM*5000)      BUFFER LENGTH FOR 5000 RECORDS               
TSARBUFF DS    A                   ADDRESS OF GETMAIN BUFFER                    
*                                                                               
TSARBYTE DS    F                   CT OF TSAR BYTE SENT                         
TSARCT   DS    H                   CT OF PRINT LINES SAVED                      
SEQNUM   DS    H                                                                
*                                                                               
SVDUB    DS    D                   SAVED KEY FOR LOCK                           
SAVEKEY  DS    CL(L'KEY)                                                        
SVR5     DS    F                   SAVE R5 FROM BLDLIN FOR CUTINS               
SVMEDIA  DS    X                   SAVE TRAFFIC TYPE FROM STATION REC           
MYTN2PR6 DS    CL1                                                              
SVCMTTYP DS    CL1                                                              
OPTICEOM DS    CL1                 OPTICA END OF MESSAGE REQ'D                  
OPTICAGY DS    CL1                 Y = OPTICA AGENCY COPY                       
*                                                                               
*OPTICA                                                                         
SVUNTDAT DS   0XL6                                                              
SVUNTDTS DS    XL3                                                              
SVUNTDTE DS    XL3                                                              
*                                                                               
SVPDAY   DS    CL1                 SAVE PROGRAM DAY                             
SVPTIME  DS    CL4                  AND PROGRAM TIME                            
OPTICASW DS    C                                                                
*                                                                               
*OPTICA                                                                         
*                                                                               
SVUNTCOM DS    CL(L'UNTCOM)                                                     
SVUNTPOS DS    CL4                                                              
SVUNTMKT DS    CL4                                                              
SVISNMTE DS   0CL78                                                             
SVISNAME DS    CL30                                                             
SVISTEL  DS    CL24                                                             
SVISFAX  DS    CL24                                                             
*                                                                               
SVISEMAL DS    CL40                                                             
SVNETADR DS    CL30                                                             
SVEDESC  DS    CL20                                                             
*                                                                               
         DS    0D                                                               
SVCMLCOD DS    CL8                 PACKED ADID OR ISCI                          
SVCMLDTA DS    0XL(SVCMLDTX-SVCMLADI)                                           
SVCMLADI DS    CL12                                                             
SVCMLISC DS    CL8                 ISCI CODE TO READ CMLTXT RECORD              
SVCMLLEN DS    XL1                                                              
SVCMLOVR DS    XL2                 PRINT OVERRIDE                               
SVCMLDS  DS    CL24                COMMERCIAL DESC 1                            
SVCMLDS2 DS    CL24                COMMERCIAL EXT DESC 2                        
SVCMLDS3 DS    CL24                COMMERCIAL EXT DESC 3                        
SVCMLTYP DS    CL4                                                              
SVCMLCLT DS    CL20                CLIENT CMML                                  
SVCMLHD DS     CL12                HIDEF                                        
SVCMLCTR DS    CL12                CENTERCUT                                    
SVCMLPRT DS    CL12                PARENT CMML                                  
SVSWAP   DS    CL1                 SAVE SWAP FIELD                              
SVCMLSTM DS    XL2                 CMML START TIME                              
SVCMLETM DS    XL2                 CMML END TIME                                
SVCMLSDT DS    XL2                 CMML START DATE                              
SVCMLEDT DS    XL2                 CMML END DATE                                
SVCMLDDT DS    XL3                 CMML DESTROY DATE                            
SVCMLDTM DS    XL2                 CMML DESTROY TIME                            
SVCMLSTA DS    XL1                 CMML STATUS FLAG (X'40'=TEXT)                
SVCMLOPT DS    XL8                 PACKED ADID OR 8 CHAR ISCII                  
SVCMLDTX EQU   *                                                                
*                                                                               
         DS    0D                                                               
FLDH     DS    CL8                                                              
FLD      DS    CL40                                                             
*                                                                               
SVPRG    DS    CL6                                                              
SVMPRG   DS    CL1                 MULTI PROGRAM ENTRIES IN QUE ENTRY           
SVPRGFAX DS    XL1                                                              
SVPRGNM  DS    CL16                PROGRAM NAME                                 
SVSTDNM  DS    CL16                PROGRAM NAME                                 
SVEXNAM  DS    CL1                                                              
*                                  KEEP SVPRGRVN AND SVPRGRVD TOGETHER          
SVPRGRVN DS    XL1                                                              
SVPRGRVD DS    XL2                                                              
SVPRGLFX DS    XL1                 LAST REVN FAXED                              
SVPRGDAY DS    CL1                                                              
SVPRGTIM DS    CL4                                                              
SVPRGDEL DS    XL2                                                              
SVPRGFLG DS    XL1                                                              
SVPRGIDT DS    XL3                                                              
SVPRGNAM DS    CL24                PRODUCT GROUP NAME                           
*                                                                               
SVREMUSR DS    CL3                                                              
SVCSPROD DS    XL18                PRODUCTS FOR MULTI PROD COPY SPLITS          
HIREVNN  DS    XL1                 SAVE HIGHEST NET REV NUM                     
SVHIREVP DS    XL1                 SAVE HIGHEST PRG REV NUM                     
OREVNN   DS    XL1                 PROG REV NUM FOR OTHER RECS                  
OREVNUM  DS    XL1                 OTHER NET REV NUM                            
CPYPT    DS    CL1                 POINTER IN TRACPY FIELD                      
*                                                                               
SVSMKT   DS    CL4                 MARKET CODE                                  
SVMKTNM  DS    CL24                MARKET NAME FROM MARKET RECOR                
SVPRGNXT DS    CL6                 SAVE NEXT START AT PROG FOR BLPRG            
*                                                                               
SVLOCK   DS    CL8                 SAVE LOCK INFO  FOR ULOCK                    
SVSVPROD DS    CL3                 SAVE PROD LOCK INFO  FOR ULOCK               
SVCPROD  DS    CL3                 SAVE 3 CHAR PROD FOR LOCKING                 
SVPROD   DS    CL3                 SAVE 3 CHAR PROD                             
*                                                                               
SVFEED   DS    XL4                 SAVE FEED                                    
SVMYEAR  DS    XL1                 MAP YEAR                                     
SVMCODE  DS    CL8                 AND MAP CODE FOR SECTIONAL FEEDS             
SVMCODEP DS    XL1                 MAP CODE POINTER                             
SVDESC   DS    CL60                SAVE SECTIONAL FEED DESCRIPTION              
SVSPCING DS    XL1                                                              
*                                                                               
* PROGRAM SWITCHES                                                              
*                                                                               
FOOTSW   DS    C                                                                
FRSTPGSW DS    C                                                                
CONTINUE DS    C                                                                
ERRFILSW DS    C                   1 IF ERRFILE OPENED                          
DIRPRTSW DS    C                   DIRECT CARD FOR THESE REQUESTS               
SPACESW  DS    C                   PRINTED SPACES AFTER UNITS ON INST           
MIDFLAG  DS    C                                                                
*                                                                               
* FROM VPER RTN - PERIOD FIELD IN HEADING ON SCREEN                             
*                                                                               
STDATE   DS    CL6                                                              
ENDATE   DS    CL6                                                              
PSTDATE  DS    CL6                 PRINTABLE START                              
PENDATE  DS    CL6                 AND END DATES                                
STDATEP  DS    XL2                                                              
ENDATEP  DS    XL2                                                              
PERIOD   DS    XL3                                                              
         EJECT                                                                  
NETMKT   DS    H                                                                
NETWORK  DS    CL4                 KEEP NETWORK/PROGRAM TOGETHER                
PROGRAM  DS    CL6                     AND IN ORDER                             
BASEPRG  DS    CL6                                                              
BASEDTS  DS   0XL4                                                              
BASESTR  DS    XL2                                                              
BASEEND  DS    XL2                                                              
BASECT   DS    XL1                                                              
INSPRTSW DS    CL1                                                              
TABLESW  DS    XL1                                                              
*        EQU   X'10'              TABLE BUILD (FIRST 60 ENTRIES)                
*        EQU   X'20'                "     " 2ND-TIME AROUND                     
*        EQU   X'40'              TABLE IS FULL                                 
*        EQU   X'80'              DO A DISPLAY                                  
MAKEGDSW EQU   X'01'              THERE ARE MAKEGOODS IN THE REPORT             
DELETDSW EQU   X'02'              DELETED UNIT NOT PRINTED ON INSTR             
*                                                                               
SVTWPR01 DS    CL1                                                              
SVTWPR06 DS    CL1                 SAVED TW PROF6 FOR CABLE/NINS GEN            
SVTWPR07 DS    CL1                 SAVED TW PROF7 NINS GEN NOW COPY             
SVTWPR08 DS    CL1                 SENT EACH PROGRAM SEPARATELY (FAX)           
SVTWPR11 DS    CL1                 READ TRAFFIC RECS FOR FAX NUMBERS            
*                                                                               
UPDSW    DS    CL1               80 PRINTED ORG/REV # FOR CMTS                  
*                                40 END OF UNITS IN BLPRG                       
*                                20 PRINTING UNITS, PRT MIDLNS IN HDHK          
*                                10 INSTR PRINTED FOR PROGRAM SEND DIP          
*                                08 DO GETREC IN PCMT RTN                       
*                                04 NO BOXES ALLOWED IN PCMT RTN                
*                                02 ONLY SKED UNITS FOUND IN BLDUNT             
*                                   RTN - NO SORT OF UNITS                      
UNTFDDSW EQU   X'01'             01 FEED NO NATIONAL FOUND                      
*                                                                               
UPDSW2   DS    CL1                                                              
UNTCUTIN EQU   X'80'             80 - PROCESSING CUTINS                         
*                                40                                             
*                                20                                             
*                                10                                             
*                                08                                             
*                                04                                             
*                                02                                             
*                                                                               
*        EQU   X'01'             01                                             
*                                                                               
SVLSTFAX DS    XL1                                                              
SVNETFAX DS    CL12                                                             
SVFAXTBL DS    (MXPRGFAX)CL12                                                   
SVFAXEND EQU   *                                                                
MXPRGFAX EQU   30                                                               
SVDPC    DS    CL1                                                              
SVPRGPRG DS    CL6                                                              
*                                                                               
SVPGEND  DS    XL2                 PROGRAM END DATE (COMPRESSED)                
*                                                                               
BLDIFAX  DS   0CL16                USED TO BUILD INTERNATIONAL FAX #            
BLDPCFAX DS    CL12                USED TO BUILD FAX #                          
         DS    CL4                                                              
*                                                                               
SVDPCTBD DS   0CL(DPCTBLEN)                                                     
SVDPCLEN DS    CL1                 TOTAL TABLE LENGTH                           
SVDPCTBL DS    CL69              1 BYTE LEN + 12 BYTES NET FAX (UPTO 4)         
*                                + 16 BYTES INTERNATIONAL FAX +1 LEN            
DPCTBLEN EQU   *-SVDPCLEN                                                       
*                                                                               
SVSPLRPN DS    CL24                SAVE SPOOL REPORT NUMBERS (4 REPS)           
SVRPNPTR DS    CL1                   AND SAVE POINTER IN THAT LIST              
SVLSTLN  DS    F                                                                
*                                                                               
TSRKEYF  DS    H                   SAVE FIRST TSAR KEY NUMBER                   
TSRKEYL  DS    H                     AND LAST                                   
*                                                                               
FAXPTR   DS    F                   POINTER IN FAX TABLE                         
UNITCT   DS    H                   COUNT OF UNIT THIS PROGRAM                   
SVUNTCT  DS    X                   SAVE UNIT COUNT                              
*                                                                               
PRGFAXSW DS    X                   X'80' - MULTI FAX PROGRAM SWITCH             
MFPRGSW  DS    CL1                 MULTI-FAX-PROGRAM SWITCH                     
FAXLEN   DS    CL1                 FAX ENTRY LENGTH                             
*                                                                               
SVOPTDTA DS    0C                                                               
SVOPTLEN EQU   (SVOPTX-SVOPTDTA)                                                
*                                                                               
VOPTPROD DS    CL3                 KEEP VOPTPROD AND VOPTPRD TOGETHER           
VOPTPRGR DS    XL2                 THIS AND SVTN2PRO+00 ARE PROD GROUP          
VOPTPGRL EQU   L'VOPTPGRO/3        # OF PRODS                                   
VOPTDATE DS    XL2                 PARTIAL PERIOD DATE                          
VOPTPRNM DS    CL20                VOPTPROD NAME                                
*                                                                               
SVOPTSW  DS    XL1                                                              
*                                                                               
OPTTEST  EQU   X'80'              NO UPDATES TO DISK FILES                      
OPTSEED  EQU   X'40'              SEED ALLOW OV REQ IN SPITE OF ERRORS          
*                                 WAS RERUN=DATE                                
OPTREV   EQU   X'20'              RUN ANY REVISIONS NOT YET RUN                 
OPTNEW   EQU   X'10'              RUN ONLY ORIGINALS                            
OPTUNAS  EQU   X'08'              ALLOW FOR UNASSIGNED                          
OPTUNAL  EQU   X'04'              ALLOW FOR UNALLOCATED                         
OPTNAGY  EQU   X'02'              DON'T PRINT AGENCY NAME & ADDRESS             
OPTNOAOR EQU   X'01'              DON'T PRINT AGENCY OF RECORD N & A            
*                                                                               
SVOPTSW1 DS    XL1                                                              
*                                                                               
OPTNOBON EQU   X'80'               DON'T PRINT BONUS                            
OPTHDCPY EQU   X'40'                                                            
USEDEF   EQU   X'20'               PRINT A DEFAULT COMMENT                      
PRNTDCMT EQU   X'10'               COMMENTS HAVE BEEN PRINTED                   
OPTNOADU EQU   X'08'               DON'T PRINT ADU                              
OPTRACE  EQU   X'04'               SET TRACE FOR NETIO                          
OPTDPTSW EQU   X'02'               FILTER ON DAYPART                            
*        EQU   X'01'                                                            
*                                                                               
SVOPTSW2 DS    XL1                                                              
*                                                                               
OPTOVFAX EQU   X'80'               OVERNIGHT FAX                                
OPTPBRK  EQU   X'40'               PAGE BREAK ON PRODUCT                        
*MNV                                                                            
OPTDIGI  EQU   X'20'               OVERRIDE SUPPRESS DIGITAL                    
*MNV                                                                            
*                                                                               
SVOPTX   EQU   *                                                                
*    END OF SVOPTDTA                                                            
*                                                                               
SVFLAG   DS    XL1                                                              
*                                                                               
*        EQU   X'80'                                                            
*        EQU   X'40'                                                            
CONVSW   EQU   X'20'               CONVERTED RECORDS                            
*        EQU   X'10'                                                            
SVTSX1   EQU   X'08'               1ST FAX                                      
NOMATCH  EQU   X'04'               PROG DAYPART DOES NOT MATCH THE REQ          
SVMPRGFX EQU   X'02'               MULTI-PROGRAM FAX                            
PQOPNSW  EQU   X'01'               PRTQUE OPEN                                  
*                                                                               
SVFLAG1  DS    XL1                                                              
SVOVREC  EQU   X'80'               LOOK FOR RECORD W/OVERNIGHT FAX #            
OVFAXSW  EQU   X'40'               LAST FAX IN TALBE IS OV-FAX                  
*              X'20'               PRINT PIGGYBACK COMMENT                      
*              X'10'               PRINT COPYSPLIT COMMENT                      
SVCMLDEL EQU   X'08'               CML IS DELETED                               
*                                                                               
SVLGKEY  DS    CL(L'KEYSAVE)                                                    
*                                                                               
         DS    0A                                                               
BINPARS  DS    0XL24                                                            
BINPAR1  DS    A                   A(REC TO ADD)                                
BINPAR2  DS    A                   A(TABLE)                                     
BINPAR3  DS    A                   RECS IN TABLE                                
BINPAR4  DS    A                   REC LENGTH                                   
BINPAR5  DS    A                   KEY LENGTH                                   
BINPAR6  DS    A                   MAX RECS                                     
*                                                                               
BINPAR7  DS    6F                                                               
*                                                                               
         DS    D                                                                
PRGTABLE DS    XL(100*L'PRGENT)    PROGRAM TABLE                                
PRGTABLX EQU   *                                                                
*                                                                               
MCODETBL DS    CL(100*8)      100 MAP CODE ENTRIES FOR SECTIONAL FEEDS          
*                                                                               
* EQUIVALENT PROGRAM TABLE                                                      
*                                                                               
EQVPTBL  DS    CL(25*L'EQVENT)     ROOM FOR 25 18 BYTE ENTRIES                  
*                                                                               
VOPTPGRO DS    XL1500              HOLDS 500 PRODUCTS (3 CHAR EACH)             
ENDPGTBL EQU   *                                                                
*                                                                               
* UNIT TABLE                                                                    
*                                                                               
**********************************************************************          
******** MOVED UNIT TABLE PAST THE END OF TWA TO THE 16K SAVED AREA  *          
**********  TWAENDLQ+T216FFD IT IS DEFINED IN SPTRAWORKD             *          
*         DS    0D                                                   *          
*UNTABLE  DS    XL(95*L'UNTENT)     ROOM FOR 95 ENTRIES              *          
*ENDUNTBL EQU   *                                                    *          
**********************************************************************          
         DS    XL2                                                              
EDSVSYSD EQU   *                   END OF SAVED SYSD                            
ENDSYSD  EQU   *       IF THIS ADDRESS MORE THAN 2F08, PAST END OF SYSD         
*                                  LSYSD IS 2F08 (12040) WITH 24,000            
*                                  GRABBED BY T21600                            
         EJECT                                                                  
* DSECT FOR PROGRAM TABLE LIST ENTRIES *                                        
       ++INCLUDE SPPRGTAB                                                       
*                                                                               
* DSECT FOR EQUIVALENT PROGRAM CODE ENTRIES                                     
*                                                                               
EQVPTBLD DSECT                                                                  
EQVENT   DS   0CL18                                                             
EQVEPRG  DS    CL6                EQUIVALENT                                    
EQVBPRG  DS    CL6                BASE PROGRAM CODE                             
EQVDTS   DS   0XL4                                                              
EQVSDT   DS    XL2                START DATE                                    
EQVEDT   DS    XL2                END                                           
EQVUSED  DS    XL1                                                              
EQVCT    DS    XL1                ENTRY COUNTER                                 
EQVNEXT  EQU   *                                                                
         EJECT                                                                  
* DSECT FOR UNIT ACTIVITY LIST ENTRIES *                                        
*                                                                               
UNTABLED DSECT                                                                  
UNTENT   DS    0CL96                                                            
UNTCOM   DS    0CL26                                                            
UNTEXNAM DS    XL1                PTR - UNIT EXCEPTION NAME (0 IF SAME)         
UNTADTEP DS    XL2                AIR DATE                                      
UNTTIME  DS    CL4                TIME                                          
UNTSUB   DS    XL1                SUBLINE                                       
UNTPOS   DS    CL4                POSITION - IF 1ST CHAR FF, TBA                
UNTFEED  DS    CL4                FEED (ALSO USED FOR TAG (00FF(T1))            
UNTPROD  DS    CL3                PRODUCT                                       
UNTSLN   DS    XL1                UNIT LENGTH                                   
UNTPROD2 DS    CL3                PARTNER PRODUCT                               
UNTSLN2  DS    XL1                UNIT LENGTH                                   
UNTDAY   DS    XL1                DAY BITS (0=SPARE, 1=MON.. 7=SUN)             
UNTFLG   DS    XL1                80 - 80/40/20 ON IN NUCMLFLG                  
*                                 40 - DELETED UNIT                             
*                                 20 - INSTR RUN ON DELETED UNIT                
*                                 10 - TRAFFIC DELETED UNIT                     
*                                 08 - FEED TO NATIONAL UNIT                    
*                                 04 - BILLBOARD REQUIRED BY MEDIA              
*                                 02 - MISSED                                   
*                                 01 - MEDIA ORIGINATED FEED                    
UNTCML1  DS    CL8                ASSIGNED COMMERCIAL                           
UNTCML2  DS    CL8                ASSIGNED COMMERCIAL                           
UNTBBSL  DS    XL1                BILLBOARD LENGTH                              
UNTBBSN  DS    CL8                BILLBOARD SLIDE NUMBER                        
UNTBBCN  DS    CL8                BILLBOARD COPY NUMBER                         
UNTBBPOS DS    CL4                BILLBOARD POSITION                            
*** REUSE SOME BB FIELDS FOR TRI-BACK INFO                                      
         ORG   UNTBBCN                                                          
UNTCML3  DS    CL8                ASSIGNED COMMERCIAL 3 FOR TRI-BACKS           
UNTSLN3  DS    XL1                PRD3 LENGTH                                   
UNTADIFL DS    XL1                 FLAGS FOR ADID COMMLS                        
UNTADIF1 EQU   X'80'               FLAGS CML1                                   
UNTADIF2 EQU   X'40'               FLAGS CML2                                   
UNTADIF3 EQU   X'20'               FLAGS BBSL/CML3                              
UNTADIF4 EQU   X'10'               FLAGS BBCPY                                  
         DS    XL2                SPARE                                         
*                                                                               
UNTREVN  DS    XL1                                                              
UNTDSKAD DS    XL4                DISK ADDRESS                                  
*NTEQVCT DS    XL1                                                              
UNTFLG1  DS    XL1                                                              
UNTFLGBN EQU   X'80'               THIS UNIT IS A BONUS UNIT                    
UNTFLGNF EQU   X'40'               NATIONAL UNIT WITH FEEDS                     
UNTFLGAK EQU   X'20'               ERROR ACKNOWLEDGED                           
UNTFLGIN EQU   X'10'               UNIT PRINTED ON INSTRUCTIONS                 
UNTFLGAD EQU   X'08'               THIS UNIT IS AN ADU UNIT                     
UNTFLGPR EQU   X'04'               THIS UNIT NEEDS RE-PRINTING                  
UNTFLGNW EQU   X'02'               NEWLY ASGND CML                              
UNTFL3TB EQU   X'01'               TRI-BACK UNIT                                
UNTFLG2  DS    XL1                                                              
UNTFLSCA EQU   X'80'               SCATTER                                      
UNTFLUPF EQU   X'40'               UPFRONT                                      
UNTFLOPR EQU   X'20'               OPPORTUNISTIC                                
UNTFLMG  EQU   X'10'               MAKE GOOD                                    
UNTFLCUT EQU   X'08'               CUTIN                                        
UNTFLTS  EQU   X'04'               OUTSIDE TRAFFIC SUPPLIER                     
UNTFLNTS EQU   X'02'               NON-TRAFFIC SUPPLIER                         
UNITFDD  EQU   X'01'               FEED NO NATIONAL                             
UNTCSPRD DS    XL18                LIST OF PRODUCTS FOR TRI-BACK UNIT           
UNTACOST DS    XL4                 ACTUAL COST                                  
UNTEST   DS    XL1                 ESTIMATE NUMBER                              
UNTMYR   DS    XL1                 MAP YEAR                                     
UNTMCDP  DS    XL1                 MAP CODE POINTER                             
UNTPACK  DS    XL1                 UNIT PACKAGE                                 
***UNTNTI   DS    XL2                 NTI CODE                                  
*                                                                               
UNTNEXT  EQU   *                                                                
         EJECT                                                                  
* DSECT FOR NETWORK COMMERCIAL INSTRUCTIONS ERROR LIST *                        
*                                                                               
XPRINT   DSECT                                                                  
*                                                                               
         DS    CL2                                                              
XPPROG   DS    CL6                 PROGRAM                                      
         DS    CL2                                                              
XPPROGNM DS    CL16                PROGRAM NAME                                 
         DS    CL5                                                              
XPPROGDA DS    CL8                 PROGRAM DAY                                  
         DS    CL4                                                              
XPPROGTM DS    CL11                PROGRAM TIME                                 
         DS    CL1                                                              
XPPERIOD DS    CL17                PRINT PERIOD                                 
         DS    CL3                                                              
XPEXPLAN DS    CL1                 PRINT REASON                                 
*                                                                               
* DSECT FOR NETWORK COMMERCIAL INSTRUCTIONS ERROR LIST *                        
*                                                                               
XRECD    DSECT                                                                  
XREC     DS    0XL32                                                            
*                                                                               
XBAGYMD  DS    XL1                                                              
XCLT     DS    CL3                 CLIENT                                       
XNET     DS    CL4                 NETWORK                                      
XNETMKT  DS    XL2                 NETWORK MARKET                               
XPROG    DS    CL6                 PROGRAM                                      
XTUNT    DS    XL2                                                              
XUNAS    DS    XL2                 UNASSIGNED UNITS                             
XUNAL    DS    XL2                 UNALLOCATED UNITS                            
XPERST   DS    XL2                                                              
XPERND   DS    XL2                                                              
XTYPE    DS    CL1                 1=NO COMMERCIALS ASSIGNED                    
*                                  2=UNALLOCATED UNITS                          
*                                  3=UNASSIGNED UNITS                           
*                                  4=EQUIVALENT PROG CODE NOT COVERED           
*                                  5=TN1 PROFILE 5 ON, NO UNITS TO PRT          
*                                  6=                                           
*                                  7=NO OV FAX # FOR THIS                       
         DS    XL10                SPARE                                        
*                                                                               
ADDTBLD  DSECT                     *COMMERCIAL TABLE DSECT*                     
ADDTBCOD DS    XL8                 COMMERCIAL CODE                              
ADDTBADI DS    CL12                                                             
ADDTBDA  DS    CL4                 CMML REC DISK ADDRESS                        
ADDTBSTA DS    XL1                 TEXT FLAG                                    
ADDTBTYP DS    CL4                 TYPE                                         
ADDTBDDT DS    XL3                 DESTROY DATE                                 
ADDTBDTM DS    XL2                 DESTROY TIME                                 
ADDTBLLN EQU   *-ADDTBLD                                                        
*                                                                               
* COMMERCIAL TABLE FOR SHIPPING THROUGH OPTICA                                  
*                                                                               
CMLTBLD  DSECT                     *COMMERCIAL TABLE DSECT*                     
CMLKEYL  DS   0CL(CMLLTD-CMLSHCML) BINSRCH KEY LEN                              
CMLSHCML DS    XL8                 COMMERCIAL (ISCII OR PACKED ADID)            
CMLFTD   DS    CL3                 FTD                                          
CMLPRO1  DS    CL3                 PROD                                         
CMLPRO2  DS    CL3                 PROD 2                                       
CMLLTD   DS    XL3                 LTD                                          
CMLFLAG  DS    XL1                                                              
ADIDSW   EQU   X'01'               PACKED ADID                                  
***CMLNTI   DS    XL2                 NTI CODE                                  
CMLTBLLN EQU   *-CMLTBLD                                                        
*                                                                               
*                                                                               
GEND     DSECT                                                                  
         ORG   ELEM                                                             
REQHDR   DS    CL26                                                             
REQUEST  DS    CL80                                                             
REQUEST2 DS    CL80                                                             
REQSPOOK DS    CL64                                                             
         EJECT                                                                  
* ONLINE LIST                                                                   
*                                                                               
LSTLINE  DSECT                                                                  
         DS    CL8                 FIELD HEADER                                 
LPROG    DS    CL6                                                              
         DS    CL3                                                              
LCUREVDT DS    CL8                                                              
         DS    C                                                                
LCUREVNO DS    CL2                                                              
         DS    CL2                                                              
LPREVDT  DS    CL8                                                              
         DS    C                                                                
LPREVNO  DS    CL3                                                              
         DS    CL2                                                              
LUNITS   DS    CL4                                                              
         DS    CL1                                                              
LFEEDS   DS    CL3                                                              
         DS    CL2                                                              
LUNASUNT DS    CL4                                                              
         DS    CL1                                                              
LUNALUNT DS    CL4                                                              
         DS    CL1                                                              
LDELUNT  DS    CL3                                                              
         DS    CL1                                                              
LPRGFAX  DS    CL1                                                              
         DS    CL1                                                              
LPRTID   DS    CL13                                                             
*                                                                               
* DSECT FOR PRINT LINE DATA *                                                   
*                                                                               
PLINED   DSECT      DSPL                                                        
         DS    CL2                                                              
PLAIRDT  DS    CL7    2                                                         
         DS    CL1                                                              
PLSLN    DS    CL3   10                                                         
         DS    CL3                                                              
PLPRD    DS    CL3   16                                                         
         DS    CL1                                                              
PLPRDNM  DS    CL18  20                                                         
         DS    CL1                                                              
PLCML    DS    CL12  39                                                         
         DS    CL2                                                              
PLCMLTTL DS    CL24  53                                                         
         DS    CL2                                                              
PLPOS    DS    CL4   79                                                         
         DS    CL2                                                              
PLOTHER  DS    CL27  85                                                         
*                                                                               
PLROT    EQU   PLAIRDT+132                                                      
*                                                                               
PLBONUS  EQU   PLINED+264                                                       
*                                                                               
SPOOLD   DSECT                                                                  
*                                                                               
         ORG   P                                                                
       ++INCLUDE EDIDESTD                                                       
*                                                                               
         ORG   P                                                                
       ++INCLUDE EDIDDSHD                                                       
       ++INCLUDE EDILINKD                                                       
                                                                                
* DSECT FOR TSAR RECORDS                                                        
                                                                                
TSBUFD   DSECT                                                                  
TSBUFLEN DS    XL2                                                              
TSBUFKEY DS    XL2                                                              
TSBUFHED DS    XL1                                                              
TSBUFSPC DS    XL1                                                              
TSBUFLIN DS    CL132                                                            
TSBUFX   EQU   *                                                                
       ++INCLUDE DDGLOBEQUS                                                     
       ++INCLUDE DDGLVXCTLD                                                     
       ++INCLUDE DDGLVSPTRF                                                     
       ++INCLUDE DMWRKFL                                                        
       ++INCLUDE FAWSSVRD                                                       
       ++INCLUDE SPTROPSAV                                                      
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'208SPTRA1F   11/06/20'                                      
         END                                                                    
